cscope 15 $HOME/linux-kernel/linux -q 0000016438 0003142704
	@drivers/FPU-emu/control_w.h

10 #iâdeà
_CONTROLW_H_


11 
	#_CONTROLW_H_


	)

13 #ifdeà
__ASSEMBLER__


14 
	#_CÚ¡_
(
x
è
$
##
	)
x

16 
	#_CÚ¡_
(
x
è
	)
x

19 
	#CW_RC
 
	`_CÚ¡_
(0x0C00è

	)

20 
	#CW_PC
 
	`_CÚ¡_
(0x0300è

	)

22 
	#CW_P»cisiÚ
 
	`CÚ¡_
(0x0020è

	)

23 
	#CW_Und”æow
 
	`CÚ¡_
(0x0010è

	)

24 
	#CW_Ov”æow
 
	`CÚ¡_
(0x0008è

	)

25 
	#CW_Z”oDiv
 
	`CÚ¡_
(0x0004è

	)

26 
	#CW_D’Üm®
 
	`CÚ¡_
(0x0002è

	)

27 
	#CW_Inv®id
 
	`CÚ¡_
(0x0001è

	)

29 
	#CW_Exû±iÚs
 
	`_CÚ¡_
(0x003fè

	)

31 
	#RC_RND
 
	`_CÚ¡_
(0x0000)

	)

32 
	#RC_DOWN
 
	`_CÚ¡_
(0x0400)

	)

33 
	#RC_UP
 
	`_CÚ¡_
(0x0800)

	)

34 
	#RC_CHOP
 
	`_CÚ¡_
(0x0C00)

	)

38 
	#PR_24_BITS
 
	`_CÚ¡_
(0x000)

	)

39 
	#PR_53_BITS
 
	`_CÚ¡_
(0x200)

	)

40 
	#PR_64_BITS
 
	`_CÚ¡_
(0x300)

	)

41 
	#PR_RESERVED_BITS
 
	`_CÚ¡_
(0x100)

	)

43 
	#FULL_PRECISION
 (
PR_64_BITS
 | 
RC_RND
 | 0x3f)

	)

	@drivers/FPU-emu/errors.c

20 
	~<lšux/sigÇl.h
>

22 
	~<asm/£gm’t.h
>

24 
	~"åu_sy¡em.h
"

25 
	~"exû±iÚ.h
"

26 
	~"åu_emu.h
"

27 
	~"¡©us_w.h
"

28 
	~"cÚŒŞ_w.h
"

29 
	~"»g_cÚ¡ªt.h
"

30 
	~"v”siÚ.h
"

33 #undeà
PRINT_MESSAGES


37 
	$Un_im¶
()

39 
by‹1
, 
FPU_modrm
;

40 
add»ss
 = 
FPU_ORIG_EIP
;

42 
RE_ENTRANT_CHECK_OFF
;

44 
	`´štk
("Unim¶em’‹d FPU Opcod©ƒ=%°: ", (*è
add»ss
);

47 
by‹1
 = 
	`g‘_fs_by‹
((*è
add»ss
);

48 iàĞ(
by‹1
 & 0xf8) == 0xd8 ) ;

49 
	`´štk
("[%02x]", 
by‹1
);

50 
add»ss
++;

52 
	`´štk
("%02x ", 
by‹1
);

53 
FPU_modrm
 = 
	`g‘_fs_by‹
(1 + (*è
add»ss
);

55 ià(
FPU_modrm
 >= 0300)

56 
	`´štk
("%02x (%02x+%d)\n", 
FPU_modrm
, FPU_modrm & 0xf8, FPU_modrm & 7);

58 
	`´štk
("/%d\n", (
FPU_modrm
 >> 3) & 7);

59 
RE_ENTRANT_CHECK_ON
;

61 
	`EXCEPTION
(
EX_Inv®id
);

63 
	}
}

70 
	$FPU_Ëg®
()

72 
	`m©h_abÜt
(
FPU_šfo
,
SIGILL
);

73 
	}
}

77 
	$emu_´šÎ
()

79 
i
;

80 *
g_desc
[] = { "Valid", "Zero", "ERROR", "ERROR",

82 
by‹1
, 
FPU_modrm
;

83 
add»ss
 = 
FPU_ORIG_EIP
;

85 
RE_ENTRANT_CHECK_OFF
;

87 
	`´štk
("Aˆ%p:", (*è
add»ss
);

88 
	#MAX_PRINTED_BYTES
 20

	)

89  
i
 = 0; i < 
MAX_PRINTED_BYTES
; i++ )

91 
by‹1
 = 
	`g‘_fs_by‹
((*è
add»ss
);

92 iàĞ(
by‹1
 & 0xf8) == 0xd8 )

94 
	`´štk
(" %02x", 
by‹1
);

97 
	`´štk
(" [%02x]", 
by‹1
);

98 
add»ss
++;

100 iàĞ
i
 =ğ
MAX_PRINTED_BYTES
 )

101 
	`´štk
(" [more..]\n");

104 
FPU_modrm
 = 
	`g‘_fs_by‹
(1 + (*è
add»ss
);

106 ià(
FPU_modrm
 >= 0300)

107 
	`´štk
(" %02x (%02x+%d)\n", 
FPU_modrm
, FPU_modrm & 0xf8, FPU_modrm & 7);

109 
	`´štk
(" /%d, mod=%d„m=%d\n",

110 (
FPU_modrm
 >> 3) & 7, (FPU_modrm >> 6) & 3, FPU_modrm & 7);

113 
·¹Ÿl_¡©us
 = 
	`¡©us_wÜd
();

115 #ifdeà
DEBUGGING


116 iàĞ
·¹Ÿl_¡©us
 & 
SW_Backw¬d
 ) 
	`´štk
("SW: backward compatibility\n");

117 iàĞ
·¹Ÿl_¡©us
 & 
SW_C3
 ) 
	`´štk
("SW: condition bit 3\n");

118 iàĞ
·¹Ÿl_¡©us
 & 
SW_C2
 ) 
	`´štk
("SW: condition bit 2\n");

119 iàĞ
·¹Ÿl_¡©us
 & 
SW_C1
 ) 
	`´štk
("SW: condition bit 1\n");

120 iàĞ
·¹Ÿl_¡©us
 & 
SW_C0
 ) 
	`´štk
("SW: condition bit 0\n");

121 iàĞ
·¹Ÿl_¡©us
 & 
SW_Summ¬y
 ) 
	`´štk
("SW:ƒxception summary\n");

122 iàĞ
·¹Ÿl_¡©us
 & 
SW_Sck_FauÉ
 ) 
	`´štk
("SW: stack fault\n");

123 iàĞ
·¹Ÿl_¡©us
 & 
SW_P»cisiÚ
 ) 
	`´štk
("SW:†oss of…recision\n");

124 iàĞ
·¹Ÿl_¡©us
 & 
SW_Und”æow
 ) 
	`´štk
("SW: underflow\n");

125 iàĞ
·¹Ÿl_¡©us
 & 
SW_Ov”æow
 ) 
	`´štk
("SW: overflow\n");

126 iàĞ
·¹Ÿl_¡©us
 & 
SW_Z”o_Div
 ) 
	`´štk
("SW: divide by zero\n");

127 iàĞ
·¹Ÿl_¡©us
 & 
SW_D’Üm_Op
 ) 
	`´štk
("SW: denormalized operand\n");

128 iàĞ
·¹Ÿl_¡©us
 & 
SW_Inv®id
 ) 
	`´štk
("SW: invalid operation\n");

131 
	`´štk
(" SW: b=%d st=%ldƒs=%d sf=%d cc=%d%d%d%dƒf=%d%d%d%d%d%d\n",

132 
·¹Ÿl_¡©us
 & 0x8000 ? 1 : 0,

133 (
·¹Ÿl_¡©us
 & 0x3800) >> 11,

134 
·¹Ÿl_¡©us
 & 0x80 ? 1 : 0,

135 
·¹Ÿl_¡©us
 & 0x40 ? 1 : 0,

136 
·¹Ÿl_¡©us
 & 
SW_C3
?1:0,…¬tŸl_¡©u & 
SW_C2
?1:0,

137 
·¹Ÿl_¡©us
 & 
SW_C1
?1:0,…¬tŸl_¡©u & 
SW_C0
?1:0,

138 
·¹Ÿl_¡©us
 & 
SW_P»cisiÚ
?1:0,…¬tŸl_¡©u & 
SW_Und”æow
?1:0,

139 
·¹Ÿl_¡©us
 & 
SW_Ov”æow
?1:0,…¬tŸl_¡©u & 
SW_Z”o_Div
?1:0,

140 
·¹Ÿl_¡©us
 & 
SW_D’Üm_Op
?1:0,…¬tŸl_¡©u & 
SW_Inv®id
?1:0);

142 
	`´štk
(" CW: ic=%d„c=%ld%ld…c=%ld%ld iem=%dƒf=%d%d%d%d%d%d\n",

143 
cÚŒŞ_wÜd
 & 0x1000 ? 1 : 0,

144 (
cÚŒŞ_wÜd
 & 0x800) >> 11, (control_word & 0x400) >> 10,

145 (
cÚŒŞ_wÜd
 & 0x200) >> 9, (control_word & 0x100) >> 8,

146 
cÚŒŞ_wÜd
 & 0x80 ? 1 : 0,

147 
cÚŒŞ_wÜd
 & 
SW_P»cisiÚ
?1:0, cÚŒŞ_wÜd & 
SW_Und”æow
?1:0,

148 
cÚŒŞ_wÜd
 & 
SW_Ov”æow
?1:0, cÚŒŞ_wÜd & 
SW_Z”o_Div
?1:0,

149 
cÚŒŞ_wÜd
 & 
SW_D’Üm_Op
?1:0, cÚŒŞ_wÜd & 
SW_Inv®id
?1:0);

151  
i
 = 0; i < 8; i++ )

153 
FPU_REG
 *
r
 = &
	`¡
(
i
);

154 
r
->
g
)

156 
TW_Em±y
:

159 
TW_Z”o
:

161 
	`´štk
("st(%d) %c .0000 0000 0000 0000 ",

162 
i
, 
r
->
sign
 ? '-' : '+');

165 
TW_V®id
:

166 
TW_NaN
:

168 
TW_Infš™y
:

169 
	`´štk
("¡(%dè %ø.%04lx %04lx %04lx %04lxƒ%+-6ld ", 
i
,

170 
r
->
sign
 ? '-' : '+',

171 ()(
r
->
sigh
 >> 16),

172 ()(
r
->
sigh
 & 0xFFFF),

173 ()(
r
->
sigl
 >> 16),

174 ()(
r
->
sigl
 & 0xFFFF),

175 
r
->
exp
 - 
EXP_BIAS
 + 1);

178 
	`´štk
("Whoops! Error inƒrrors.c ");

181 
	`´štk
("%s\n", 
g_desc
[(è(è
r
->
g
]);

184 
	`´štk
("[data] %c .%04lx %04lx %04lx %04lxƒ%+-6ld ",

185 
FPU_lßded_d©a
.
sign
 ? '-' : '+',

186 ()(
FPU_lßded_d©a
.
sigh
 >> 16),

187 ()(
FPU_lßded_d©a
.
sigh
 & 0xFFFF),

188 ()(
FPU_lßded_d©a
.
sigl
 >> 16),

189 ()(
FPU_lßded_d©a
.
sigl
 & 0xFFFF),

190 
FPU_lßded_d©a
.
exp
 - 
EXP_BIAS
 + 1);

191 
	`´štk
("%s\n", 
g_desc
[(è(è
FPU_lßded_d©a
.
g
]);

192 
RE_ENTRANT_CHECK_ON
;

194 
	}
}

197 
	mty³
;

198 *
	mÇme
;

199 } 
	gexû±iÚ_Çmes
[] = {

200 { 
EX_SckOv”
, "stack overflow" },

201 { 
EX_SckUnd”
, "stack underflow" },

202 { 
EX_P»cisiÚ
, "loss of…recision" },

203 { 
EX_Und”æow
, "underflow" },

204 { 
EX_Ov”æow
, "overflow" },

205 { 
EX_Z”oDiv
, "divide by zero" },

206 { 
EX_D’Üm®
, "denormalized operand" },

207 { 
EX_Inv®id
, "invalid operation" },

208 { 
EX_INTERNAL
, "INTERNAL BUG iÀ"
FPU_VERSION
 },

209 { 0, 
NULL
 }

275 
	$exû±iÚ
(
n
)

277 
i
, 
št_ty³
;

279 
št_ty³
 = 0;

280 iàĞ
n
 & 
EX_INTERNAL
 )

282 
št_ty³
 = 
n
 - 
EX_INTERNAL
;

283 
n
 = 
EX_INTERNAL
;

285 
·¹Ÿl_¡©us
 |ğ(
SW_Exc_Mask
 | 
SW_Summ¬y
 | 
SW_Backw¬d
);

290 
n
 &ğ(
SW_Exc_Mask
);

292 
·¹Ÿl_¡©us
 |ğ
n
;

294 iàĞ
·¹Ÿl_¡©us
 & ~
cÚŒŞ_wÜd
 & 
CW_Exû±iÚs
 )

295 
·¹Ÿl_¡©us
 |ğ(
SW_Summ¬y
 | 
SW_Backw¬d
);

296 iàĞ
n
 & (
SW_Sck_FauÉ
 | 
EX_P»cisiÚ
) )

298 iàĞ!(
n
 & 
SW_C1
) )

301 
·¹Ÿl_¡©us
 &ğ~
SW_C1
;

305 
RE_ENTRANT_CHECK_OFF
;

306 iàĞ(~
cÚŒŞ_wÜd
 & 
n
 & 
CW_Exû±iÚs
è|| (À=ğ
EX_INTERNAL
) )

308 #ifdeà
PRINT_MESSAGES


310 
	`´štk
(
FPU_VERSION
" "
__DATE__
" (C) W. Metzenthen.\n");

314 
i
=0; 
exû±iÚ_Çmes
[i].
ty³
; i++)

315 iàĞ(
exû±iÚ_Çmes
[
i
].
ty³
 & 
n
) ==ƒxception_names[i].type )

318 ià(
exû±iÚ_Çmes
[
i
].
ty³
)

320 #ifdeà
PRINT_MESSAGES


321 
	`´štk
("FP Exû±iÚ: %s!\n", 
exû±iÚ_Çmes
[
i
].
Çme
);

325 
	`´štk
("FPUƒmuÏtÜ: UnknowÀExû±iÚ: 0x%04x!\n", 
n
);

327 iàĞ
n
 =ğ
EX_INTERNAL
 )

329 
	`´štk
("FPUƒmuÏtÜ: IÁ”ÇÈ”rÜy³ 0x%04x\n", 
št_ty³
);

330 
	`emu_´šÎ
();

332 #ifdeà
PRINT_MESSAGES


334 
	`emu_´šÎ
();

347 
RE_ENTRANT_CHECK_ON
;

349 #ifdeà
__DEBUG__


350 
	`m©h_abÜt
(
FPU_šfo
,
SIGFPE
);

353 
	}
}

358 
asmlškage
 
	$»®_2İ_NaN
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
, FPU_REG *
de¡
)

360 
FPU_REG
 cÚ¡ *
x
;

361 
sigÇÎšg
;

365 
x
 = 
a
;

366 ià(
a
->
g
 =ğ
TW_NaN
)

368 ià(
b
->
g
 =ğ
TW_NaN
)

370 
sigÇÎšg
 = !(
a
->
sigh
 & 
b
->sigh & 0x40000000);

372 iàĞ
	`signifiÿnd
(
a
è< signifiÿnd(
b
) )

373 
x
 = 
b
;

378 
sigÇÎšg
 = !(
a
->
sigh
 & 0x40000000);

382 #ifdeà
PARANOID


383 ià(
b
->
g
 =ğ
TW_NaN
)

386 
sigÇÎšg
 = !(
b
->
sigh
 & 0x40000000);

387 
x
 = 
b
;

389 #ifdeà
PARANOID


392 
sigÇÎšg
 = 0;

393 
	`EXCEPTION
(
EX_INTERNAL
|0x113);

394 
x
 = &
CONST_QNaN
;

398 iàĞ!
sigÇÎšg
 )

400 iàĞ!(
x
->
sigh
 & 0x80000000) )

401 
x
 = &
CONST_QNaN
;

402 
	`»g_move
(
x
, 
de¡
);

406 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

409 iàĞ!(
x
->
sigh
 & 0x80000000) )

410 
x
 = &
CONST_QNaN
;

411 
	`»g_move
(
x
, 
de¡
);

413 
de¡
->
sigh
 |= 0x40000000;

416 
	`EXCEPTION
(
EX_Inv®id
);

418  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

419 
	}
}

424 
asmlškage
 
	$¬™h_šv®id
(
FPU_REG
 *
de¡
)

427 
	`EXCEPTION
(
EX_Inv®id
);

429 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

432 
	`»g_move
(&
CONST_QNaN
, 
de¡
);

435  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

437 
	}
}

441 
asmlškage
 
	$divide_by_z”o
(
sign
, 
FPU_REG
 *
de¡
)

444 iàĞ
cÚŒŞ_wÜd
 & 
CW_Z”oDiv
 )

447 
	`»g_move
(&
CONST_INF
, 
de¡
);

448 
de¡
->
sign
 = ()sign;

451 
	`EXCEPTION
(
EX_Z”oDiv
);

453  !(
cÚŒŞ_wÜd
 & 
CW_Z”oDiv
);

455 
	}
}

459 
	$£t_´ecisiÚ_æag
(
æags
)

461 iàĞ
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
 )

463 
·¹Ÿl_¡©us
 &ğ~(
SW_C1
 & 
æags
);

464 
·¹Ÿl_¡©us
 |ğ
æags
;

469 
	`exû±iÚ
(
æags
);

472 
	}
}

476 
asmlškage
 
	$£t_´ecisiÚ_æag_up
()

478 iàĞ
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
 )

479 
·¹Ÿl_¡©us
 |ğ(
SW_P»cisiÚ
 | 
SW_C1
);

481 
	`exû±iÚ
(
EX_P»cisiÚ
 | 
SW_C1
);

483 
	}
}

487 
asmlškage
 
	$£t_´ecisiÚ_æag_down
()

489 iàĞ
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
 )

491 
·¹Ÿl_¡©us
 &ğ~
SW_C1
;

492 
·¹Ÿl_¡©us
 |ğ
SW_P»cisiÚ
;

495 
	`exû±iÚ
(
EX_P»cisiÚ
);

496 
	}
}

499 
asmlškage
 
	$d’Üm®_İ”ªd
()

501 iàĞ
cÚŒŞ_wÜd
 & 
CW_D’Üm®
 )

503 
·¹Ÿl_¡©us
 |ğ
SW_D’Üm_Op
;

508 
	`exû±iÚ
(
EX_D’Üm®
);

511 
	}
}

514 
asmlškage
 
	$¬™h_ov”æow
(
FPU_REG
 *
de¡
)

517 iàĞ
cÚŒŞ_wÜd
 & 
CW_Ov”æow
 )

519 
sign
;

522 
sign
 = 
de¡
->sign;

523 
	`»g_move
(&
CONST_INF
, 
de¡
);

524 
de¡
->
sign
 = sign;

529 
de¡
->
exp
 -= (3 * (1 << 13));

532 
	`EXCEPTION
(
EX_Ov”æow
);

533 iàĞ
cÚŒŞ_wÜd
 & 
CW_Ov”æow
 )

539 
	`EXCEPTION
(
EX_P»cisiÚ
 | 
SW_C1
);

540  !(
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
);

543  !(
cÚŒŞ_wÜd
 & 
CW_Ov”æow
);

545 
	}
}

548 
asmlškage
 
	$¬™h_und”æow
(
FPU_REG
 *
de¡
)

551 iàĞ
cÚŒŞ_wÜd
 & 
CW_Und”æow
 )

554 iàĞ
de¡
->
exp
 <ğ
EXP_UNDER
 - 63 )

556 
	`»g_move
(&
CONST_Z
, 
de¡
);

557 
·¹Ÿl_¡©us
 &ğ~
SW_C1
;

563 
de¡
->
exp
 += (3 * (1 << 13));

566 
	`EXCEPTION
(
EX_Und”æow
);

567 iàĞ
cÚŒŞ_wÜd
 & 
CW_Und”æow
 )

570 
	`EXCEPTION
(
EX_P»cisiÚ
);

571  !(
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
);

574  !(
cÚŒŞ_wÜd
 & 
CW_Und”æow
);

576 
	}
}

579 
	$¡ack_ov”æow
()

582 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

585 
tİ
--;

586 
	`»g_move
(&
CONST_QNaN
, 
FPU_¡0_±r
 = &
	`¡
(0));

589 
	`EXCEPTION
(
EX_SckOv”
);

593 
	}
}

596 
	$¡ack_und”æow
()

599 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

602 
	`»g_move
(&
CONST_QNaN
, 
FPU_¡0_±r
);

605 
	`EXCEPTION
(
EX_SckUnd”
);

609 
	}
}

612 
	$¡ack_und”æow_i
(
i
)

615 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

618 
	`»g_move
(&
CONST_QNaN
, &(
	`¡
(
i
)));

621 
	`EXCEPTION
(
EX_SckUnd”
);

625 
	}
}

628 
	$¡ack_und”æow_pİ
(
i
)

631 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

634 
	`»g_move
(&
CONST_QNaN
, &(
	`¡
(
i
)));

635 
	`pİ
();

638 
	`EXCEPTION
(
EX_SckUnd”
);

642 
	}
}

	@drivers/FPU-emu/exception.h

9 #iâdeà
_EXCEPTION_H_


10 
	#_EXCEPTION_H_


	)

13 #ifdeà
__ASSEMBLER__


14 
	#CÚ¡_
(
x
è
$
##
	)
x

16 
	#CÚ¡_
(
x
è
	)
x

19 #iâdeà
SW_C1


20 
	~"åu_emu.h
"

23 
	#FPU_BUSY
 
	`CÚ¡_
(0x8000è

	)

24 
	#EX_E¼ÜSumm¬y
 
	`CÚ¡_
(0x0080è

	)

26 
	#EX_INTERNAL
 
	`CÚ¡_
(0x8000è

	)

27 
	#EX_SckOv”
 
	`CÚ¡_
(0x0041|
SW_C1
è

	)

28 
	#EX_SckUnd”
 
	`CÚ¡_
(0x0041è

	)

30 
	#EX_P»cisiÚ
 
	`CÚ¡_
(0x0020è

	)

31 
	#EX_Und”æow
 
	`CÚ¡_
(0x0010è

	)

32 
	#EX_Ov”æow
 
	`CÚ¡_
(0x0008è

	)

33 
	#EX_Z”oDiv
 
	`CÚ¡_
(0x0004è

	)

34 
	#EX_D’Üm®
 
	`CÚ¡_
(0x0002è

	)

35 
	#EX_Inv®id
 
	`CÚ¡_
(0x0001è

	)

38 
	#PRECISION_LOST_UP
 
	`CÚ¡_
((
EX_P»cisiÚ
 | 
SW_C1
))

	)

39 
	#PRECISION_LOST_DOWN
 
	`CÚ¡_
(
EX_P»cisiÚ
)

	)

42 #iâdeà
__ASSEMBLER__


44 #ifdeà
DEBUG


45 
	#EXCEPTION
(
x
è{ 
	`´štk
("exception in %s‡t†ine %d\n", \

46 
__FILE__
, 
__LINE__
); 
	`exû±iÚ
(
x
); }

	)

48 
	#EXCEPTION
(
x
è
	`exû±iÚ
(x)

	)

	@drivers/FPU-emu/fpu_arith.c

13 
	~"åu_sy¡em.h
"

14 
	~"åu_emu.h
"

15 
	~"cÚŒŞ_w.h
"

16 
	~"¡©us_w.h
"

19 
	$çdd__
()

22 
	`ş—r_C1
();

23 
	`»g_add
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), FPU_¡0_±r, 
cÚŒŞ_wÜd
);

24 
	}
}

27 
	$fmul__
()

30 
	`ş—r_C1
();

31 
	`»g_mul
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), FPU_¡0_±r, 
cÚŒŞ_wÜd
);

32 
	}
}

36 
	$fsub__
()

39 
	`ş—r_C1
();

40 
	`»g_sub
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), FPU_¡0_±r, 
cÚŒŞ_wÜd
);

41 
	}
}

44 
	$fsubr_
()

47 
	`ş—r_C1
();

48 
	`»g_sub
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, FPU_¡0_±r, 
cÚŒŞ_wÜd
);

49 
	}
}

52 
	$fdiv__
()

55 
	`ş—r_C1
();

56 
	`»g_div
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), FPU_¡0_±r, 
cÚŒŞ_wÜd
);

57 
	}
}

60 
	$fdivr_
()

63 
	`ş—r_C1
();

64 
	`»g_div
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, FPU_¡0_±r, 
cÚŒŞ_wÜd
);

65 
	}
}

69 
	$çdd_i
()

72 
	`ş—r_C1
();

73 
	`»g_add
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
);

74 
	}
}

77 
	$fmul_i
()

80 
	`ş—r_C1
();

81 
	`»g_mul
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
);

82 
	}
}

85 
	$fsubri
()

90 
	`ş—r_C1
();

91 
	`»g_sub
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
);

92 
	}
}

95 
	$fsub_i
()

100 
	`ş—r_C1
();

101 
	`»g_sub
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, &¡(FPU_rm), 
cÚŒŞ_wÜd
);

102 
	}
}

105 
	$fdivri
()

108 
	`ş—r_C1
();

109 
	`»g_div
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
);

110 
	}
}

113 
	$fdiv_i
()

116 
	`ş—r_C1
();

117 
	`»g_div
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, &¡(FPU_rm), 
cÚŒŞ_wÜd
);

118 
	}
}

122 
	$çddp_
()

125 
	`ş—r_C1
();

126 iàĞ!
	`»g_add
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

127 
	`pİ
();

128 
	}
}

131 
	$fmuÍ_
()

134 
	`ş—r_C1
();

135 iàĞ!
	`»g_mul
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

136 
	`pİ
();

137 
	}
}

141 
	$fsub½
()

146 
	`ş—r_C1
();

147 iàĞ!
	`»g_sub
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

148 
	`pİ
();

149 
	}
}

152 
	$fsubp_
()

157 
	`ş—r_C1
();

158 iàĞ!
	`»g_sub
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

159 
	`pİ
();

160 
	}
}

163 
	$fdiv½
()

166 
	`ş—r_C1
();

167 iàĞ!
	`»g_div
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
), &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

168 
	`pİ
();

169 
	}
}

172 
	$fdivp_
()

175 
	`ş—r_C1
();

176 iàĞ!
	`»g_div
(&
	`¡
(
FPU_rm
), 
FPU_¡0_±r
, &¡(FPU_rm), 
cÚŒŞ_wÜd
) )

177 
	`pİ
();

178 
	}
}

	@drivers/FPU-emu/fpu_asm.h

9 #iâdeà
_FPU_ASM_H_


10 
	#_FPU_ASM_H_


	)

12 
	~"åu_emu.h
"

14 
	#EXCEPTION
 
_exû±iÚ


	)

17 
	#PARAM1
 8(%
ebp
)

	)

18 
	#PARAM2
 12(%
ebp
)

	)

19 
	#PARAM3
 16(%
ebp
)

	)

20 
	#PARAM4
 20(%
ebp
)

	)

22 
	#SIGL_OFFSET
 8

	)

23 
	#SIGN
(
x
è(x)

	)

24 
	#TAG
(
x
è1(x)

	)

25 
	#EXP
(
x
è4(x)

	)

26 
	#SIG
(
x
è
SIGL_OFFSET
##(x)

	)

27 
	#SIGL
(
x
è
SIGL_OFFSET
##(x)

	)

28 
	#SIGH
(
x
è12(x)

	)

	@drivers/FPU-emu/fpu_aux.c

13 
	~"åu_sy¡em.h
"

14 
	~"exû±iÚ.h
"

15 
	~"åu_emu.h
"

16 
	~"¡©us_w.h
"

17 
	~"cÚŒŞ_w.h
"

20 
	$âİ
()

22 
	}
}

24 
	$fşex
()

26 
·¹Ÿl_¡©us
 &ğ~(
SW_Backw¬d
|
SW_Summ¬y
|
SW_Sck_FauÉ
|
SW_P»cisiÚ
|

27 
SW_Und”æow
|
SW_Ov”æow
|
SW_Z”o_Div
|
SW_D’Üm_Op
|

28 
SW_Inv®id
);

29 
NO_NET_DATA_EFFECT
;

30 
FPU_’Œy_e
 = 
_off£t
;

31 
	}
}

34 
	$fš™
()

36 
r
;

37 
cÚŒŞ_wÜd
 = 0x037f;

38 
·¹Ÿl_¡©us
 = 0;

39 
tİ
 = 0;

40 
r
 = 0;„ < 8;„++)

42 
»gs
[
r
].
g
 = 
TW_Em±y
;

46 
d©a_İ”ªd_off£t
 = 0;

47 
İ”ªd_£ËùÜ
 = 0;

48 
NO_NET_DATA_EFFECT
;

49 
FPU_’Œy_İ_cs
 = 0;

50 
FPU_’Œy_e
 = 
_off£t
 = 0;

51 
	}
}

56 
	#ãni
 
âİ


	)

57 
	#fdisi
 
âİ


	)

58 
	#f£m
 
âİ


	)

60 
FUNC
 cÚ¡ 
	gfš™_bË
[] = {

61 
ãni
, 
fdisi
, 
fşex
, 
fš™
,

62 
f£m
, 
FPU_Ëg®
, FPU_illegal, FPU_illegal

65 
	$fš™_
()

67 (
fš™_bË
[
FPU_rm
])();

68 
	}
}

71 
	$f¡sw_ax
()

73 *(*è&
FPU_EAX
 = 
	`¡©us_wÜd
();

74 
NO_NET_INSTR_EFFECT
;

75 
	}
}

77 
FUNC
 cÚ¡ 
	gf¡sw_bË
[] = {

78 
f¡sw_ax
, 
FPU_Ëg®
, FPU_illegal, FPU_illegal,

79 
FPU_Ëg®
, FPU_illegal, FPU_illegal, FPU_illegal

82 
	$f¡sw_
()

84 (
f¡sw_bË
[
FPU_rm
])();

85 
	}
}

88 
FUNC
 cÚ¡ 
	gå_nİ_bË
[] = {

89 
âİ
, 
FPU_Ëg®
, FPU_illegal, FPU_illegal,

90 
FPU_Ëg®
, FPU_illegal, FPU_illegal, FPU_illegal

93 
	$å_nİ
()

95 (
å_nİ_bË
[
FPU_rm
])();

96 
	}
}

99 
	$æd_i_
()

101 
FPU_REG
 *
¡_Ãw_±r
;

103 iàĞ
STACK_OVERFLOW
 )

104 { 
	`¡ack_ov”æow
(); ; }

107 iàĞ
	`NOT_EMPTY
(
FPU_rm
) )

108 { 
	`»g_move
(&
	`¡
(
FPU_rm
), 
¡_Ãw_±r
); 
	`push
(); }

111 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

114 
	`push
();

115 
	`¡ack_und”æow
();

118 
	`EXCEPTION
(
EX_SckUnd”
);

121 
	}
}

124 
	$fxch_i
()

127 
FPU_REG
 
t
;

128 
FPU_REG
 *
¡i_±r
 = &
	`¡
(
FPU_rm
);

130 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

132 iàĞ
¡i_±r
->
g
 =ğ
TW_Em±y
 )

134 
	`¡ack_und”æow
();

135 
	`¡ack_und”æow_i
(
FPU_rm
);

138 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

139 
	`»g_move
(
¡i_±r
, 
FPU_¡0_±r
);

140 
	`¡ack_und”æow_i
(
FPU_rm
);

143 iàĞ
¡i_±r
->
g
 =ğ
TW_Em±y
 )

145 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

146 
	`»g_move
(
FPU_¡0_±r
, 
¡i_±r
);

147 
	`¡ack_und”æow
();

150 
	`ş—r_C1
();

151 
	`»g_move
(
FPU_¡0_±r
, &
t
);

152 
	`»g_move
(
¡i_±r
, 
FPU_¡0_±r
);

153 
	`»g_move
(&
t
, 
¡i_±r
);

154 
	}
}

157 
	$fä“_
()

160 
	`¡
(
FPU_rm
).
g
 = 
TW_Em±y
;

161 
	}
}

164 
	$fä“p
()

167 
	`¡
(
FPU_rm
).
g
 = 
TW_Em±y
;

168 
	`pİ
();

169 
	}
}

172 
	$f¡_i_
()

175 
	`»g_move
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
));

176 
	}
}

179 
	$f¡p_i
()

182 
	`»g_move
(
FPU_¡0_±r
, &
	`¡
(
FPU_rm
));

183 
	`pİ
();

184 
	}
}

	@drivers/FPU-emu/fpu_emu.h

11 #iâdeà
_FPU_EMU_H_


12 
	#_FPU_EMU_H_


	)

20 
	#DENORM_OPERAND


	)

29 
	#PECULIAR_486


	)

31 #ifdeà
__ASSEMBLER__


32 
	~"åu_asm.h
"

33 
	#CÚ¡
(
x
è
$
##
	)
x

35 
	#CÚ¡
(
x
è
	)
x

38 
	#EXP_BIAS
 
	`CÚ¡
(0)

	)

39 
	#EXP_OVER
 
	`CÚ¡
(0x4000è

	)

40 
	#EXP_UNDER
 
	`CÚ¡
(-0x3fffè

	)

41 
	#EXP_Infš™y
 
EXP_OVER


	)

42 
	#EXP_NaN
 
EXP_OVER


	)

44 
	#SIGN_POS
 
	`CÚ¡
(0)

	)

45 
	#SIGN_NEG
 
	`CÚ¡
(1)

	)

48 
	#TW_V®id
 
	`CÚ¡
(0è

	)

49 
	#TW_Z”o
 
	`CÚ¡
(1è

	)

52 
	#TW_Infš™y
 
	`CÚ¡
(5è

	)

53 
	#TW_NaN
 
	`CÚ¡
(6è

	)

55 
	#TW_Em±y
 
	`CÚ¡
(7è

	)

58 #iâdeà
__ASSEMBLER__


60 
	~<lšux/m©h_emu.h
>

61 
	~<lšux/lškage.h
>

63 #ifdeà
PARANOID


64 
emuÏtšg
;

65 
	#RE_ENTRANT_CHECK_OFF
 
emuÏtšg
 = 0

	)

66 
	#RE_ENTRANT_CHECK_ON
 
emuÏtšg
 = 1

	)

68 
	#RE_ENTRANT_CHECK_OFF


	)

69 
	#RE_ENTRANT_CHECK_ON


	)

72 
	#FWAIT_OPCODE
 0x9b

	)

73 
	#OP_SIZE_PREFIX
 0x66

	)

74 
	#ADDR_SIZE_PREFIX
 0x67

	)

75 
	#PREFIX_CS
 0x2e

	)

76 
	#PREFIX_DS
 0x3e

	)

77 
	#PREFIX_ES
 0x26

	)

78 
	#PREFIX_SS
 0x36

	)

79 
	#PREFIX_FS
 0x64

	)

80 
	#PREFIX_GS
 0x65

	)

81 
	#PREFIX_REPE
 0xf3

	)

82 
	#PREFIX_REPNE
 0xf2

	)

83 
	#PREFIX_LOCK
 0xf0

	)

84 
	#PREFIX_CS_
 1

	)

85 
	#PREFIX_DS_
 2

	)

86 
	#PREFIX_ES_
 3

	)

87 
	#PREFIX_FS_
 4

	)

88 
	#PREFIX_GS_
 5

	)

89 
	#PREFIX_SS_
 6

	)

93 
	#NO_NET_DATA_EFFECT
 \

94 { 
FPU_d©a_add»ss
 = (*)
d©a_İ”ªd_off£t
; \

95 
FPU_d©a_£ËùÜ
 = 
İ”ªd_£ËùÜ
; }

	)

96 
	#NO_NET_INSTR_EFFECT
 \

97 { 
FPU_’Œy_e
 = 
_off£t
; \

98 
FPU_’Œy_İ_cs
 = 
cs_£ËùÜ
; }

	)

101 (*
	tFUNC
)();

102 
åu_»g
 
	tFPU_REG
;

103 ¡ruù { 
add»ss_size
, 
İ”ªd_size
, 
£gm’t
; }

104 
	tov”rides
;

106 ¡ruù { 
ov”rides
 
ov”ride
;

107 
vm86
; } 
	tåu_addr_modes
;

109 
	#¡
(
x
èĞ
»gs
[((
tİ
+xè&7 )] )

	)

111 
	#STACK_OVERFLOW
 (
¡_Ãw_±r
 = &
	`¡
(-1), st_Ãw_±r->
g
 !ğ
TW_Em±y
)

	)

112 
	#NOT_EMPTY
(
i
è(
	`¡
(i).
g
 !ğ
TW_Em±y
)

	)

113 
	#NOT_EMPTY_0
 (
FPU_¡0_g
 ^ 
TW_Em±y
)

	)

115 
FPU_rm
;

117 
FPU_¡0_g
;

118 
FPU_REG
 *
FPU_¡0_±r
;

122 
FPU_d©a_£ËùÜ
;

123 
FPU_’Œy_İ_cs
;

125 
FPU_REG
 
FPU_lßded_d©a
;

127 
	#pİ
(è{ 
FPU_¡0_±r
->
g
 = 
TW_Em±y
; 
tİ
++; 
	}

	)
}

130 
	#push
(è{ 
tİ
--; 
FPU_¡0_±r
 = 
¡_Ãw_±r
; }

	)

133 
	#»g_move
(
x
, 
y
) { \

134 *(*)&((
y
)->
sign
èğ*(*)&((
x
)->sign); \

135 *(*)&((
y
)->
exp
èğ*(*)&((
x
)->exp); \

136 *(*)&((
y
)->
sigl
èğ*(*)&((
x
)->sigl); }

	)

138 
	#signifiÿnd
(
x
èĞ((*)&((x)->
sigl
))[0] )

	)

144 
asmlškage
 
mul64
(cÚ¡ *
a
, cÚ¡ *
b
,

145 *
»suÉ
);

146 
asmlškage
 
pŞy_div2
(*
x
);

147 
asmlškage
 
pŞy_div4
(*
x
);

148 
asmlškage
 
pŞy_div16
(*
x
);

149 
asmlškage
 
pŞynomŸl
(
accum
[], cÚ¡ 
x
[],

150 cÚ¡ 
‹rms
[][4], cÚ¡ 
n
);

151 
asmlškage
 
nÜm®ize
(
FPU_REG
 *
x
);

152 
asmlškage
 
nÜm®ize_nuo
(
FPU_REG
 *
x
);

153 
asmlškage
 
»g_div
(
FPU_REG
 cÚ¡ *
¬g1
, FPU_REG cÚ¡ *
¬g2
,

154 
FPU_REG
 *
ªsw
, 
cÚŒŞ_w
);

155 
asmlškage
 
»g_u_sub
(
FPU_REG
 cÚ¡ *
¬g1
, FPU_REG cÚ¡ *
¬g2
,

156 
FPU_REG
 *
ªsw
, 
cÚŒŞ_w
);

157 
asmlškage
 
»g_u_mul
(
FPU_REG
 cÚ¡ *
¬g1
, FPU_REG cÚ¡ *
¬g2
,

158 
FPU_REG
 *
ªsw
, 
cÚŒŞ_w
);

159 
asmlškage
 
»g_u_div
(
FPU_REG
 cÚ¡ *
¬g1
, FPU_REG cÚ¡ *
¬g2
,

160 
FPU_REG
 *
ªsw
, 
cÚŒŞ_w
);

161 
asmlškage
 
»g_u_add
(
FPU_REG
 cÚ¡ *
¬g1
, FPU_REG cÚ¡ *
¬g2
,

162 
FPU_REG
 *
ªsw
, 
cÚŒŞ_w
);

163 
asmlškage
 
wm_sq¹
(
FPU_REG
 *
n
, 
cÚŒŞ_w
);

164 
asmlškage
 
shrx
(*
l
, 
x
);

165 
asmlškage
 
shrxs
(*
v
, 
x
);

166 
asmlškage
 
div_sm®l
(*
x
, 
y
);

167 
asmlškage
 
round_»g
(
FPU_REG
 *
¬g
, 
ex‹Á
,

168 
cÚŒŞ_w
);

170 #iâdeà
MAKING_PROTO


171 
	~"åu_´Ùo.h
"

	@drivers/FPU-emu/fpu_entry.c

26 
	~<lšux/sigÇl.h
>

27 
	~<lšux/£gm’t.h
>

29 
	~"åu_sy¡em.h
"

30 
	~"åu_emu.h
"

31 
	~"exû±iÚ.h
"

32 
	~"cÚŒŞ_w.h
"

33 
	~"¡©us_w.h
"

35 
	~<asm/£gm’t.h
>

37 
	#__BAD__
 
FPU_Ëg®


	)

39 #iâdeà
NO_UNDOC_CODE


46 
	#_d9_d8_
 
f¡p_i


	)

47 
	#_dc_d0_
 
fcom_¡


	)

48 
	#_dc_d8_
 
fcomp¡


	)

49 
	#_dd_c8_
 
fxch_i


	)

50 
	#_de_d0_
 
fcomp¡


	)

51 
	#_df_c0_
 
fä“p


	)

52 
	#_df_c8_
 
fxch_i


	)

53 
	#_df_d0_
 
f¡p_i


	)

54 
	#_df_d8_
 
f¡p_i


	)

56 
FUNC
 cÚ¡ 
	g¡_š¡r_bË
[64] = {

57 
çdd__
, 
æd_i_
, 
__BAD__
, __BAD__, 
çdd_i
, 
fä“_
, 
çddp_
, 
_df_c0_
,

58 
fmul__
, 
fxch_i
, 
__BAD__
, __BAD__, 
fmul_i
, 
_dd_c8_
, 
fmuÍ_
, 
_df_c8_
,

59 
fcom_¡
, 
å_nİ
, 
__BAD__
, __BAD__, 
_dc_d0_
, 
f¡_i_
, 
_de_d0_
, 
_df_d0_
,

60 
fcomp¡
, 
_d9_d8_
, 
__BAD__
, __BAD__, 
_dc_d8_
, 
f¡p_i
, 
fcomµ
, 
_df_d8_
,

61 
fsub__
, 
å_‘c
, 
__BAD__
, 
fš™_
, 
fsubri
, 
fucom_
, 
fsub½
, 
f¡sw_
,

62 
fsubr_
, 
fcÚ¡
, 
fucomµ
, 
__BAD__
, 
fsub_i
, 
fucomp
, 
fsubp_
, __BAD__,

63 
fdiv__
, 
Œig_a
, 
__BAD__
, __BAD__, 
fdivri
, __BAD__, 
fdiv½
, __BAD__,

64 
fdivr_
, 
Œig_b
, 
__BAD__
, __BAD__, 
fdiv_i
, __BAD__, 
fdivp_
, __BAD__,

69 
FUNC
 cÚ¡ 
	g¡_š¡r_bË
[64] = {

70 
çdd__
, 
æd_i_
, 
__BAD__
, __BAD__, 
çdd_i
, 
fä“_
, 
çddp_
, __BAD__,

71 
fmul__
, 
fxch_i
, 
__BAD__
, __BAD__, 
fmul_i
, __BAD__, 
fmuÍ_
, __BAD__,

72 
fcom_¡
, 
å_nİ
, 
__BAD__
, __BAD__, __BAD__, 
f¡_i_
, __BAD__, __BAD__,

73 
fcomp¡
, 
__BAD__
, __BAD__, __BAD__, __BAD__, 
f¡p_i
, 
fcomµ
, __BAD__,

74 
fsub__
, 
å_‘c
, 
__BAD__
, 
fš™_
, 
fsubri
, 
fucom_
, 
fsub½
, 
f¡sw_
,

75 
fsubr_
, 
fcÚ¡
, 
fucomµ
, 
__BAD__
, 
fsub_i
, 
fucomp
, 
fsubp_
, __BAD__,

76 
fdiv__
, 
Œig_a
, 
__BAD__
, __BAD__, 
fdivri
, __BAD__, 
fdiv½
, __BAD__,

77 
fdivr_
, 
Œig_b
, 
__BAD__
, __BAD__, 
fdiv_i
, __BAD__, 
fdivp_
, __BAD__,

83 
	#_NONE_
 0

	)

84 
	#_REG0_
 1

	)

85 
	#_REGI_
 2

	)

86 
	#_REGi_
 0

	)

87 
	#_PUSH_
 3

	)

88 
	#_nuÎ_
 4

	)

89 
	#_REGIi
 5

	)

90 
	#_REGIp
 6

	)

91 
	#_REGIc
 0

	)

92 
	#_REGIn
 0

	)

94 #iâdeà
NO_UNDOC_CODE


98 cÚ¡ 
	gty³_bË
[64] = {

99 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, 
_REGi_
, 
_REGIp
, _REGi_,

100 
_REGI_
, 
_REGIn
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _REGI_, 
_REGIp
, _REGI_,

101 
_REGIc
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, _REGIc, 
_REG0_
, _REGIc, _REG0_,

102 
_REGIc
, 
_REG0_
, 
_nuÎ_
, _null_, _REGIc, _REG0_, _REGIc, _REG0_,

103 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _NONE_, 
_REGIi
, 
_REGIc
, 
_REGIp
, _NONE_,

104 
_REGI_
, 
_NONE_
, 
_REGIc
, 
_nuÎ_
, 
_REGIi
, _REGIc, 
_REGIp
, _null_,

105 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _nuÎ_, 
_REGIp
, _null_,

106 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _nuÎ_, 
_REGIp
, _null_

111 cÚ¡ 
	gty³_bË
[64] = {

112 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, 
_REGi_
, 
_REGIp
, _null_,

113 
_REGI_
, 
_REGIn
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _nuÎ_, 
_REGIp
, _null_,

114 
_REGIc
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, _nuÎ_, 
_REG0_
, _null_, _null_,

115 
_REGIc
, 
_nuÎ_
, _nuÎ_, _nuÎ_, _nuÎ_, 
_REG0_
, _REGIc, _null_,

116 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _NONE_, 
_REGIi
, 
_REGIc
, 
_REGIp
, _NONE_,

117 
_REGI_
, 
_NONE_
, 
_REGIc
, 
_nuÎ_
, 
_REGIi
, _REGIc, 
_REGIp
, _null_,

118 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _nuÎ_, 
_REGIp
, _null_,

119 
_REGI_
, 
_NONE_
, 
_nuÎ_
, _nuÎ_, 
_REGIi
, _nuÎ_, 
_REGIp
, _null_

127 
	gFPU_rm
;

128 
	gFPU_¡0_g
;

129 
FPU_REG
 *
	gFPU_¡0_±r
;

132 
	gFPU_’Œy_İ_cs
;

133 
	gFPU_d©a_£ËùÜ
;

136 #ifdeà
PARANOID


137 
	gemuÏtšg
=0;

140 
v®id_´efix
(*
By‹
, **
åu_e
,

141 
ov”rides
 *
ov”ride
);

144 
asmlškage
 
	$m©h_emuÏ‹
(
¬g
)

146 
FPU_modrm
, 
by‹1
;

147 
code
;

148 
åu_addr_modes
 
addr_modes
;

149 
unmasked
;

151 #ifdeà
PARANOID


152 iàĞ
emuÏtšg
 )

154 
	`´štk
("ERROR: wm-FPU-emu is‚ot RE-ENTRANT!\n");

156 
RE_ENTRANT_CHECK_ON
;

159 ià(!
cu¼’t
->
u£d_m©h
)

161 
i
;

162  
i
 = 0; i < 8; i++ )

166 
»gs
[
i
].
exp
 = 0;

167 
»gs
[
i
].
sigh
 = 0x80000000;

169 
	`fš™
();

170 
cu¼’t
->
u£d_m©h
 = 1;

173 
	`SETUP_DATA_AREA
(
¬g
);

175 
addr_modes
.
vm86
 = (
FPU_EFLAGS
 & 0x00020000) != 0;

177 iàĞ
addr_modes
.
vm86
 )

178 
FPU_EIP
 +ğ
FPU_CS
 << 4;

180 
FPU_ORIG_EIP
 = 
FPU_EIP
;

182 iàĞ!
addr_modes
.
vm86
 )

185 ià(
FPU_CS
 =ğ
KERNEL_CS
)

187 
	`´štk
("m©h_emuÏ‹: %04x:%08lx\n",
FPU_CS
,
FPU_EIP
);

188 
	`·nic
("Mathƒmulation‚eeded in kernel");

192 ià(
FPU_CS
 !ğ
USER_CS
 || 
FPU_DS
 !ğ
USER_DS
)

194 
	`m©h_abÜt
(
FPU_šfo
,
SIGILL
);

198 
FPU_lookah—d
 = 1;

199 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

200 
FPU_lookah—d
 = 0;

202 iàĞ!
	`v®id_´efix
(&
by‹1
, (**)&
FPU_EIP
,

203 &
addr_modes
.
ov”ride
) )

205 
RE_ENTRANT_CHECK_OFF
;

206 
	`´štk
("FPUƒmulator: Unknown…refix byte 0x%02x,…robably dueo\n"

208 
by‹1
);

209 
RE_ENTRANT_CHECK_ON
;

210 
	`EXCEPTION
(
EX_INTERNAL
|0x126);

211 
	`m©h_abÜt
(
FPU_šfo
,
SIGILL
);

214 
do_ªÙh”_FPU_š¡ruùiÚ
:

216 
FPU_EIP
++;

218 #ifdeà
PECULIAR_486


222 
FPU_d©a_£ËùÜ
 = 
FPU_DS
;

225 iàĞ(
by‹1
 & 0xf8) != 0xd8 )

227 iàĞ
by‹1
 =ğ
FWAIT_OPCODE
 )

229 ià(
·¹Ÿl_¡©us
 & 
SW_Summ¬y
)

230 
do_the_FPU_š‹¼u±
;

232 
FPU_fwa™_dÚe
;

234 #ifdeà
PARANOID


235 
	`EXCEPTION
(
EX_INTERNAL
|0x128);

236 
	`m©h_abÜt
(
FPU_šfo
,
SIGILL
);

240 
RE_ENTRANT_CHECK_OFF
;

241 
	`FPU_code_v”ify_¬—
(1);

242 
FPU_modrm
 = 
	`g‘_fs_by‹
((*è
FPU_EIP
);

243 
RE_ENTRANT_CHECK_ON
;

244 
FPU_EIP
++;

246 ià(
·¹Ÿl_¡©us
 & 
SW_Summ¬y
)

254 
code
 = (
FPU_modrm
 << 8è| 
by‹1
;

255 iàĞ! ( (((
code
 & 0xf803) == 0xe003) ||

256 (((
code
 & 0x3003) == 0x3001) &&

258 ((
code
 & 0xc000) != 0xc000))) ) )

268 
do_the_FPU_š‹¼u±
:

269 
cs_£ËùÜ
 &= 0xffff0000;

270 
cs_£ËùÜ
 |ğ
	`¡©us_wÜd
();

271 
İ”ªd_£ËùÜ
 = 
	`g_wÜd
();

272 
·¹Ÿl_¡©us
 = 0;

273 
tİ
 = 0;

275 
r
;

276 
r
 = 0;„ < 8;„++)

278 
»gs
[
r
].
g
 = 
TW_Em±y
;

282 
RE_ENTRANT_CHECK_OFF
;

283 
cu¼’t
->
tss
.
Œ­_no
 = 16;

284 
cu¼’t
->
tss
.
”rÜ_code
 = 0;

285 
	`£nd_sig
(
SIGFPE
, 
cu¼’t
, 1);

290 
FPU_’Œy_e
 = 
FPU_ORIG_EIP
;

292 
FPU_’Œy_İ_cs
 = (
by‹1
 << 24è| (
FPU_modrm
 << 16è| (
FPU_CS
 & 0xffff) ;

294 
FPU_rm
 = 
FPU_modrm
 & 7;

296 iàĞ
FPU_modrm
 < 0300 )

299 iàĞ
addr_modes
.
vm86


300 ^ (
addr_modes
.
ov”ride
.
add»ss_size
 =ğ
ADDR_SIZE_PREFIX
) )

301 
	`g‘_add»ss_16
(
FPU_modrm
, &
FPU_EIP
, 
addr_modes
);

303 
	`g‘_add»ss
(
FPU_modrm
, &
FPU_EIP
, 
addr_modes
);

304 iàĞ!(
by‹1
 & 1) )

306 
¡©us1
 = 
·¹Ÿl_¡©us
;

307 
FPU_¡0_±r
 = &
	`¡
(0);

308 
FPU_¡0_g
 = 
FPU_¡0_±r
->
g
;

311 iàĞ
NOT_EMPTY_0
 )

313 
unmasked
 = 0;

314  (
by‹1
 >> 1) & 3 )

317 
unmasked
 = 
	`»g_lßd_sšgË
();

320 
	`»g_lßd_št32
();

323 
unmasked
 = 
	`»g_lßd_doubË
();

326 
	`»g_lßd_št16
();

332 
FPU_¡0_±r
 = &
	`¡
(0);

333 
FPU_¡0_g
 = 
FPU_¡0_±r
->
g
;

338 iàĞ(
FPU_¡0_g
 =ğ
TW_NaN
) ||

339 (
FPU_lßded_d©a
.
g
 =ğ
TW_NaN
) )

343 
·¹Ÿl_¡©us
 = 
¡©us1
;

344 iàĞ(
FPU_modrm
 & 0x30) == 0x10 )

347 
	`EXCEPTION
(
EX_Inv®id
);

348 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

349 iàĞ(
FPU_modrm
 & 0x08è&& (
cÚŒŞ_wÜd
 & 
CW_Inv®id
) )

350 
	`pİ
();

354 #ifdeà
PECULIAR_486


357 iàĞ(
FPU_modrm
 & 0x28) == 0x20 )

359 
	`»®_2İ_NaN
(&
FPU_lßded_d©a
, 
FPU_¡0_±r
,

360 
FPU_¡0_±r
);

364 
	`»®_2İ_NaN
(
FPU_¡0_±r
, &
FPU_lßded_d©a
,

365 
FPU_¡0_±r
);

367 
»g_mem_š¡r_dÚe
;

370 iàĞ
unmasked
 && !((
FPU_modrm
 & 0x30) == 0x10) )

373 iàĞ(
FPU_modrm
 & 0x38) == 0x38 )

376 iàĞ(
FPU_¡0_g
 =ğ
TW_Z”o
) &&

377 (
FPU_lßded_d©a
.
g
 =ğ
TW_V®id
) )

379 iàĞ
	`divide_by_z”o
(
FPU_lßded_d©a
.
sign
,

380 
FPU_¡0_±r
) )

386 
·¹Ÿl_¡©us
 &ğ~
SW_D’Üm_Op
;

387 
·¹Ÿl_¡©us
 |ğ
¡©us1
 & 
SW_D’Üm_Op
;

391 
»g_mem_š¡r_dÚe
;

394  (
FPU_modrm
 >> 3) & 7 )

397 
	`ş—r_C1
();

398 
	`»g_add
(
FPU_¡0_±r
, &
FPU_lßded_d©a
, FPU_st0_ptr,

399 
cÚŒŞ_wÜd
);

402 
	`ş—r_C1
();

403 
	`»g_mul
(
FPU_¡0_±r
, &
FPU_lßded_d©a
, FPU_st0_ptr,

404 
cÚŒŞ_wÜd
);

407 
	`com·»_¡_d©a
();

410 iàĞ!
	`com·»_¡_d©a
(è&& !
unmasked
 )

411 
	`pİ
();

414 
	`ş—r_C1
();

415 
	`»g_sub
(
FPU_¡0_±r
, &
FPU_lßded_d©a
, FPU_st0_ptr,

416 
cÚŒŞ_wÜd
);

419 
	`ş—r_C1
();

420 
	`»g_sub
(&
FPU_lßded_d©a
, 
FPU_¡0_±r
, FPU_st0_ptr,

421 
cÚŒŞ_wÜd
);

424 
	`ş—r_C1
();

425 
	`»g_div
(
FPU_¡0_±r
, &
FPU_lßded_d©a
, FPU_st0_ptr,

426 
cÚŒŞ_wÜd
);

429 
	`ş—r_C1
();

430 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

431 
·¹Ÿl_¡©us
 = 
¡©us1
;

433 
	`»g_div
(&
FPU_lßded_d©a
, 
FPU_¡0_±r
, FPU_st0_ptr,

434 
cÚŒŞ_wÜd
);

440 iàĞ(
FPU_modrm
 & 0x30) == 0x10 )

443 
	`EXCEPTION
(
EX_SckUnd”
);

444 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

445 iàĞ(
FPU_modrm
 & 0x08è&& (
cÚŒŞ_wÜd
 & 
CW_Inv®id
) )

446 
	`pİ
();

449 
	`¡ack_und”æow
();

454 
	`lßd_¡Üe_š¡r
(((
FPU_modrm
 & 0x38è| (
by‹1
 & 6)) >> 1,

455 
addr_modes
);

458 
»g_mem_š¡r_dÚe
:

460 #iâdeà
PECULIAR_486


461 *(*)&
İ”ªd_£ËùÜ
 = 
FPU_d©a_£ËùÜ
;

468 
š¡r_šdex
 = (
FPU_modrm
 & 0x38è| (
by‹1
 & 7);

470 #ifdeà
PECULIAR_486


473 
FPU_d©a_add»ss
 = 0;

476 
FPU_¡0_±r
 = &
	`¡
(0);

477 
FPU_¡0_g
 = 
FPU_¡0_±r
->
g
;

478  
ty³_bË
[(è
š¡r_šdex
] )

480 
_NONE_
:

482 
_REG0_
:

483 iàĞ!
NOT_EMPTY_0
 )

485 
	`¡ack_und”æow
();

486 
FPU_š¡ruùiÚ_dÚe
;

489 
_REGIi
:

490 iàĞ!
NOT_EMPTY_0
 || !
	`NOT_EMPTY
(
FPU_rm
) )

492 
	`¡ack_und”æow_i
(
FPU_rm
);

493 
FPU_š¡ruùiÚ_dÚe
;

496 
_REGIp
:

497 iàĞ!
NOT_EMPTY_0
 || !
	`NOT_EMPTY
(
FPU_rm
) )

499 
	`¡ack_und”æow_pİ
(
FPU_rm
);

500 
FPU_š¡ruùiÚ_dÚe
;

503 
_REGI_
:

504 iàĞ!
NOT_EMPTY_0
 || !
	`NOT_EMPTY
(
FPU_rm
) )

506 
	`¡ack_und”æow
();

507 
FPU_š¡ruùiÚ_dÚe
;

510 
_PUSH_
:

512 
_nuÎ_
:

513 
	`FPU_Ëg®
();

514 
FPU_š¡ruùiÚ_dÚe
;

516 
	`EXCEPTION
(
EX_INTERNAL
|0x111);

517 
FPU_š¡ruùiÚ_dÚe
;

519 (*
¡_š¡r_bË
[(è
š¡r_šdex
])();

522 
FPU_š¡ruùiÚ_dÚe
:

524 
_off£t
 = 
FPU_’Œy_e
;

525 
cs_£ËùÜ
 = 
FPU_’Œy_İ_cs
;

526 
d©a_İ”ªd_off£t
 = ()
FPU_d©a_add»ss
;

527 #ifdeà
PECULIAR_486


528 *(*)&
İ”ªd_£ËùÜ
 = 
FPU_d©a_£ËùÜ
;

531 
FPU_fwa™_dÚe
:

533 #ifdeà
DEBUG


534 
RE_ENTRANT_CHECK_OFF
;

535 
	`emu_´šÎ
();

536 
RE_ENTRANT_CHECK_ON
;

539 ià(
FPU_lookah—d
 && !
Ãed_»sched
)

541 
FPU_ORIG_EIP
 = 
FPU_EIP
;

542 iàĞ
	`v®id_´efix
(&
by‹1
, (**)&
FPU_EIP
,

543 &
addr_modes
.
ov”ride
) )

544 
do_ªÙh”_FPU_š¡ruùiÚ
;

547 iàĞ
addr_modes
.
vm86
 )

548 
FPU_EIP
 -ğ
FPU_CS
 << 4;

550 
RE_ENTRANT_CHECK_OFF
;

551 
	}
}

558 
	$v®id_´efix
(*
By‹
, **
åu_e
,

559 
ov”rides
 *
ov”ride
)

561 
by‹
;

562 *

 = *
åu_e
;

564 *
ov”ride
 = (
ov”rides
è{ 0, 0, 
PREFIX_DS_
 };

566 
RE_ENTRANT_CHECK_OFF
;

567 
	`FPU_code_v”ify_¬—
(1);

568 
by‹
 = 
	`g‘_fs_by‹
(

);

569 
RE_ENTRANT_CHECK_ON
;

573  
by‹
 )

575 
ADDR_SIZE_PREFIX
:

576 
ov”ride
->
add»ss_size
 = 
ADDR_SIZE_PREFIX
;

577 
do_Ãxt_by‹
;

579 
OP_SIZE_PREFIX
:

580 
ov”ride
->
İ”ªd_size
 = 
OP_SIZE_PREFIX
;

581 
do_Ãxt_by‹
;

583 
PREFIX_CS
:

584 
ov”ride
->
£gm’t
 = 
PREFIX_CS_
;

585 
do_Ãxt_by‹
;

586 
PREFIX_ES
:

587 
ov”ride
->
£gm’t
 = 
PREFIX_ES_
;

588 
do_Ãxt_by‹
;

589 
PREFIX_SS
:

590 
ov”ride
->
£gm’t
 = 
PREFIX_SS_
;

591 
do_Ãxt_by‹
;

592 
PREFIX_FS
:

593 
ov”ride
->
£gm’t
 = 
PREFIX_FS_
;

594 
do_Ãxt_by‹
;

595 
PREFIX_GS
:

596 
ov”ride
->
£gm’t
 = 
PREFIX_GS_
;

597 
do_Ãxt_by‹
;

599 
PREFIX_DS
:

600 
ov”ride
->
£gm’t
 = 
PREFIX_DS_
;

607 
PREFIX_REPE
:

608 
PREFIX_REPNE
:

610 
do_Ãxt_by‹
:

611 

++;

612 
RE_ENTRANT_CHECK_OFF
;

613 
	`FPU_code_v”ify_¬—
(1);

614 
by‹
 = 
	`g‘_fs_by‹
(

);

615 
RE_ENTRANT_CHECK_ON
;

617 
FWAIT_OPCODE
:

618 *
By‹
 = 
by‹
;

621 iàĞ(
by‹
 & 0xf8) == 0xd8 )

623 *
By‹
 = 
by‹
;

624 *
åu_e
 = 

;

631 *
By‹
 = 
by‹
;

636 
	}
}

639 
	$m©h_abÜt
(
šfo
 * info, 
sigÇl
)

641 
FPU_EIP
 = 
FPU_ORIG_EIP
;

642 
cu¼’t
->
tss
.
Œ­_no
 = 16;

643 
cu¼’t
->
tss
.
”rÜ_code
 = 0;

644 
	`£nd_sig
(
sigÇl
,
cu¼’t
,1);

645 
RE_ENTRANT_CHECK_OFF
;

646 
	`__asm__
("movÈ%0,%%e¥ ;„‘": :"g" (((è
šfo
)-4));

647 #ifdeà
PARANOID


648 
	`´štk
("ERROR: wm-FPU-emu math_abort failed!\n");

650 
	}
}

	@drivers/FPU-emu/fpu_etc.c

13 
	~"åu_sy¡em.h
"

14 
	~"exû±iÚ.h
"

15 
	~"åu_emu.h
"

16 
	~"¡©us_w.h
"

17 
	~"»g_cÚ¡ªt.h
"

20 
	$fchs
()

22 iàĞ
NOT_EMPTY_0
 )

24 
FPU_¡0_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

25 
	`ş—r_C1
();

28 
	`¡ack_und”æow
();

29 
	}
}

31 
	$çbs
()

33 iàĞ
FPU_¡0_g
 ^ 
TW_Em±y
 )

35 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

36 
	`ş—r_C1
();

39 
	`¡ack_und”æow
();

40 
	}
}

43 
	$á¡_
()

45 
FPU_¡0_g
)

47 
TW_Z”o
:

48 
	`£tcc
(
SW_C3
);

50 
TW_V®id
:

51 ià(
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
)

52 
	`£tcc
(0);

54 
	`£tcc
(
SW_C0
);

56 #ifdeà
DENORM_OPERAND


57 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

59 #ifdeà
PECULIAR_486


61 ià(
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
)

62 
	`£tcc
(
SW_C3
);

69 
TW_NaN
:

70 
	`£tcc
(
SW_C0
|
SW_C2
|
SW_C3
);

71 
	`EXCEPTION
(
EX_Inv®id
);

73 
TW_Infš™y
:

74 ià(
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
)

75 
	`£tcc
(0);

77 
	`£tcc
(
SW_C0
);

79 
TW_Em±y
:

80 
	`£tcc
(
SW_C0
|
SW_C2
|
SW_C3
);

81 
	`EXCEPTION
(
EX_SckUnd”
);

84 
	`£tcc
(
SW_C0
|
SW_C2
|
SW_C3
);

85 
	`EXCEPTION
(
EX_INTERNAL
|0x14);

88 
	}
}

90 
	$fxam
()

92 
c
=0;

93 
FPU_¡0_g
)

95 
TW_Em±y
:

96 
c
 = 
SW_C3
|
SW_C0
;

98 
TW_Z”o
:

99 
c
 = 
SW_C3
;

101 
TW_V®id
:

103 iàĞ
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

104 
c
 = 
SW_C2
|
SW_C3
;

106 
c
 = 
SW_C2
;

108 
TW_NaN
:

109 
c
 = 
SW_C0
;

111 
TW_Infš™y
:

112 
c
 = 
SW_C2
|
SW_C0
;

115 ià(
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
)

116 
c
 |ğ
SW_C1
;

117 
	`£tcc
(
c
);

118 
	}
}

120 
FUNC
 cÚ¡ 
	gå_‘c_bË
[] = {

121 
fchs
, 
çbs
, 
FPU_Ëg®
, FPU_Ëg®, 
á¡_
, 
fxam
, FPU_illegal, FPU_illegal

124 
	$å_‘c
()

126 (
å_‘c_bË
[
FPU_rm
])();

127 
	}
}

	@drivers/FPU-emu/fpu_proto.h

2 
Un_im¶
();

3 
FPU_Ëg®
();

4 
emu_´šÎ
();

5 
¡ack_ov”æow
();

6 
¡ack_und”æow
();

7 
¡ack_und”æow_i
(
i
);

8 
¡ack_und”æow_pİ
(
i
);

9 
£t_´ecisiÚ_æag
(
æags
);

10 
asmlškage
 
exû±iÚ
(
n
);

11 
asmlškage
 
»®_2İ_NaN
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
, FPU_REG *
de¡
);

12 
asmlškage
 
¬™h_šv®id
(
FPU_REG
 *
de¡
);

13 
asmlškage
 
divide_by_z”o
(
sign
, 
FPU_REG
 *
de¡
);

14 
asmlškage
 
£t_´ecisiÚ_æag_up
();

15 
asmlškage
 
£t_´ecisiÚ_æag_down
();

16 
asmlškage
 
d’Üm®_İ”ªd
();

17 
asmlškage
 
¬™h_ov”æow
(
FPU_REG
 *
de¡
);

18 
asmlškage
 
¬™h_und”æow
(
FPU_REG
 *
de¡
);

21 
çdd__
();

22 
fmul__
();

23 
fsub__
();

24 
fsubr_
();

25 
fdiv__
();

26 
fdivr_
();

27 
çdd_i
();

28 
fmul_i
();

29 
fsubri
();

30 
fsub_i
();

31 
fdivri
();

32 
fdiv_i
();

33 
çddp_
();

34 
fmuÍ_
();

35 
fsub½
();

36 
fsubp_
();

37 
fdiv½
();

38 
fdivp_
();

41 
fşex
();

42 
fš™
();

43 
fš™_
();

44 
f¡sw_
();

45 
å_nİ
();

46 
æd_i_
();

47 
fxch_i
();

48 
fä“_
();

49 
fä“p
();

50 
f¡_i_
();

51 
f¡p_i
();

54 
asmlškage
 
m©h_emuÏ‹
(
¬g
);

55 
m©h_abÜt
(
šfo
 *šfo, 
sigÇl
);

58 
å_‘c
();

61 
cÚv”t_l2»g
(cÚ¡ *
¬g
, 
FPU_REG
 *
de¡
);

62 
Œig_a
();

63 
Œig_b
();

66 
g‘_add»ss
(
FPU_modrm
, *
åu_e
,

67 
åu_addr_modes
);

68 
g‘_add»ss_16
(
FPU_modrm
, *
åu_e
,

69 
åu_addr_modes
);

72 
lßd_¡Üe_š¡r
(
ty³
, 
åu_addr_modes
 
addr_modes
);

75 
pŞy_2xm1
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
);

78 
pŞy_©ª
(
FPU_REG
 *
¬g
);

79 
pŞy_add_1
(
FPU_REG
 *
¤c
);

82 
pŞy_l2
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
);

83 
pŞy_l2p1
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
);

86 
pŞy_sše
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
);

89 
pŞy_n
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
, 
šv”t
);

92 
»g_add
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
,

93 
FPU_REG
 *
de¡
, 
cÚŒŞ_w
);

94 
»g_sub
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
,

95 
FPU_REG
 *
de¡
, 
cÚŒŞ_w
);

98 
com·»
(
FPU_REG
 cÚ¡ *
b
);

99 
com·»_¡_d©a
();

100 
fcom_¡
();

101 
fcomp¡
();

102 
fcomµ
();

103 
fucom_
();

104 
fucomp
();

105 
fucomµ
();

108 
fcÚ¡
();

111 
»g_lßd_ex‹nded
();

112 
»g_lßd_doubË
();

113 
»g_lßd_sšgË
();

114 
»g_lßd_št64
();

115 
»g_lßd_št32
();

116 
»g_lßd_št16
();

117 
»g_lßd_bcd
();

118 
»g_¡Üe_ex‹nded
();

119 
»g_¡Üe_doubË
();

120 
»g_¡Üe_sšgË
();

121 
»g_¡Üe_št64
();

122 
»g_¡Üe_št32
();

123 
»g_¡Üe_št16
();

124 
»g_¡Üe_bcd
();

125 
round_to_št
(
FPU_REG
 *
r
);

126 *
æd’v
(
åu_addr_modes
 
addr_modes
);

127 
ä¡Ü
(
åu_addr_modes
 
addr_modes
);

128 
g_wÜd
();

129 *
f¡’v
(
åu_addr_modes
 
addr_modes
);

130 
f§ve
(
åu_addr_modes
 
addr_modes
);

133 
»g_mul
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
,

134 
FPU_REG
 *
de¡
, 
cÚŒŞ_w
);

	@drivers/FPU-emu/fpu_system.h

10 #iâdeà
_FPU_SYSTEM_H


11 
	#_FPU_SYSTEM_H


	)

15 
	~<lšux/sched.h
>

16 
	~<lšux/k”Ãl.h
>

20 
	#SETUP_DATA_AREA
(
¬g
è
FPU_šfo
 = (
šfo
 *è&
	)
arg

22 
	#I387
 (
cu¼’t
->
tss
.
i387
)

	)

23 
	#FPU_šfo
 (
I387
.
soá
.
šfo
)

	)

25 
	#FPU_CS
 (*(*è&(
FPU_šfo
->
___cs
))

	)

26 
	#FPU_SS
 (*(*è&(
FPU_šfo
->
___ss
))

	)

27 
	#FPU_DS
 (*(*è&(
FPU_šfo
->
___ds
))

	)

28 
	#FPU_EAX
 (
FPU_šfo
->
___—x
)

	)

29 
	#FPU_EFLAGS
 (
FPU_šfo
->
___eæags
)

	)

30 
	#FPU_EIP
 (
FPU_šfo
->
___e
)

	)

31 
	#FPU_ORIG_EIP
 (
FPU_šfo
->
___Üig_e
)

	)

33 
	#FPU_lookah—d
 (
I387
.
soá
.
lookah—d
)

	)

34 
	#FPU_’Œy_e
 (
I387
.
soá
.
’Œy_e
)

	)

36 
	#·¹Ÿl_¡©us
 (
I387
.
soá
.
swd
)

	)

37 
	#cÚŒŞ_wÜd
 (
I387
.
soá
.
cwd
)

	)

38 
	#»gs
 (
I387
.
soá
.
»gs
)

	)

39 
	#tİ
 (
I387
.
soá
.
tİ
)

	)

41 
	#_off£t
 (
I387
.
soá
.
f
)

	)

42 
	#cs_£ËùÜ
 (
I387
.
soá
.
fcs
)

	)

43 
	#d©a_İ”ªd_off£t
 (
I387
.
soá
.
foo
)

	)

44 
	#İ”ªd_£ËùÜ
 (
I387
.
soá
.
fos
)

	)

46 
	#FPU_v”ify_¬—
(
x
,
y
,
z
èiàĞ
	`v”ify_¬—
(x,y,z) ) \

47 
	`m©h_abÜt
(
FPU_šfo
,
SIGSEGV
)

	)

49 #undeà
FPU_IGNORE_CODE_SEGV


50 #ifdeà
FPU_IGNORE_CODE_SEGV


55 
	#FPU_code_v”ify_¬—
(
z
)

	)

60 
	#FPU_code_v”ify_¬—
(
z
è
	`FPU_v”ify_¬—
(
VERIFY_READ
,(*)
FPU_EIP
,z)

	)

64 
	#FPU_d©a_add»ss
 ((*)(
I387
.
soá
.
twd
))

	)

	@drivers/FPU-emu/fpu_trig.c

13 
	~"åu_sy¡em.h
"

14 
	~"exû±iÚ.h
"

15 
	~"åu_emu.h
"

16 
	~"¡©us_w.h
"

17 
	~"cÚŒŞ_w.h
"

18 
	~"»g_cÚ¡ªt.h
"

21 
»m_k”Ãl
(
¡0
, *
y
,

22 
¡1
,

23 
q
, 
n
);

25 
	#BETTER_THAN_486


	)

27 
	#FCOS
 4

	)

28 
	#FPTAN
 1

	)

37 
	$Œig_¬g
(
FPU_REG
 *
X
, 
ev’
)

39 
FPU_REG
 
tmp
;

40 
q
;

41 
Şd_cw
 = 
cÚŒŞ_wÜd
, 
§ved_¡©us
 = 
·¹Ÿl_¡©us
;

43 iàĞ
X
->
exp
 >ğ
EXP_BIAS
 + 63 )

45 
·¹Ÿl_¡©us
 |ğ
SW_C2
;

49 
cÚŒŞ_wÜd
 &ğ~
CW_RC
;

50 
cÚŒŞ_wÜd
 |ğ
RC_CHOP
;

52 
	`»g_div
(
X
, &
CONST_PI2
, &
tmp
, 
PR_64_BITS
 | 
RC_CHOP
 | 0x3f);

53 
	`round_to_št
(&
tmp
);

55 
q
 = 
	`signifiÿnd
(&
tmp
);

56 iàĞ
q
 )

58 
	`»m_k”Ãl
(
	`signifiÿnd
(
X
),

59 &
	`signifiÿnd
(&
tmp
),

60 
	`signifiÿnd
(&
CONST_PI2
),

61 
q
, 
X
->
exp
 - 
CONST_PI2
.exp);

62 
tmp
.
exp
 = 
CONST_PI2
.exp;

63 
	`nÜm®ize
(&
tmp
);

64 
	`»g_move
(&
tmp
, 
X
);

67 iàĞ
ev’
 =ğ
FPTAN
 )

69 iàĞ((
X
->
exp
 >ğ
EXP_BIAS
) ||

70 ((
X
->
exp
 =ğ
EXP_BIAS
-1)

71 && (
X
->
sigh
 >ğ0xc90fd¯2))è^ (
q
 & 1) )

72 
ev’
 = 
FCOS
;

74 
ev’
 = 0;

77 iàĞ(
ev’
 && !(
q
 & 1)) || (!even && (q & 1)) )

79 
	`»g_sub
(&
CONST_PI2
, 
X
, X, 
FULL_PRECISION
);

80 #ifdeà
BETTER_THAN_486


85 iàĞ(
X
->
exp
 <ğ
CONST_PI2exŒa
.ex°+ 64è|| (
q
 > 1) )

89 
	`signifiÿnd
(&
tmp
èğ
q
 + 1;

90 
tmp
.
exp
 = 
EXP_BIAS
 + 63;

91 
tmp
.
g
 = 
TW_V®id
;

92 
	`nÜm®ize
(&
tmp
);

93 
	`»g_mul
(&
CONST_PI2exŒa
, &
tmp
, &tmp, 
FULL_PRECISION
);

94 
	`»g_add
(
X
, &
tmp
, X, 
FULL_PRECISION
);

95 iàĞ
X
->
sign
 =ğ
SIGN_NEG
 )

101 
X
->
sign
 = 
SIGN_POS
;

102 
q
++;

107 #ifdeà
BETTER_THAN_486


114 iàĞ((
q
 > 0è&& (
X
->
exp
 <ğ
CONST_PI2exŒa
.exp + 64)) || (q > 1) )

118 
	`signifiÿnd
(&
tmp
èğ
q
;

119 
tmp
.
exp
 = 
EXP_BIAS
 + 63;

120 
tmp
.
g
 = 
TW_V®id
;

121 
	`nÜm®ize
(&
tmp
);

122 
	`»g_mul
(&
CONST_PI2exŒa
, &
tmp
, &tmp, 
FULL_PRECISION
);

123 
	`»g_sub
(
X
, &
tmp
, X, 
FULL_PRECISION
);

124 iàĞ(
X
->
exp
 =ğ
CONST_PI2
.exp) &&

125 ((
X
->
sigh
 > 
CONST_PI2
.sigh)

126 || ((
X
->
sigh
 =ğ
CONST_PI2
.sigh)

127 && (
X
->
sigl
 > 
CONST_PI2
.sigl))) )

134 
	`»g_sub
(&
CONST_PI
, 
X
, X, 
FULL_PRECISION
);

135 
q
++;

141 
cÚŒŞ_wÜd
 = 
Şd_cw
;

142 
·¹Ÿl_¡©us
 = 
§ved_¡©us
 & ~
SW_C2
;

144  (
q
 & 3è| 
ev’
;

145 
	}
}

149 
	$cÚv”t_l2»g
(cÚ¡ *
¬g
, 
FPU_REG
 *
de¡
)

151 
num
 = *
¬g
;

153 ià(
num
 == 0)

154 { 
	`»g_move
(&
CONST_Z
, 
de¡
); ; }

156 ià(
num
 > 0)

157 
de¡
->
sign
 = 
SIGN_POS
;

159 { 
num
 = -num; 
de¡
->
sign
 = 
SIGN_NEG
; }

161 
de¡
->
sigh
 = 
num
;

162 
de¡
->
sigl
 = 0;

163 
de¡
->
exp
 = 
EXP_BIAS
 + 31;

164 
de¡
->
g
 = 
TW_V®id
;

165 
	`nÜm®ize
(
de¡
);

166 
	}
}

169 
	$sšgË_¬g_”rÜ
()

171  
FPU_¡0_g
 )

173 
TW_NaN
:

174 iàĞ!(
FPU_¡0_±r
->
sigh
 & 0x40000000) )

176 
	`EXCEPTION
(
EX_Inv®id
);

177 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

178 
FPU_¡0_±r
->
sigh
 |= 0x40000000;

181 
TW_Em±y
:

182 
	`¡ack_und”æow
();

184 #ifdeà
PARANOID


186 
	`EXCEPTION
(
EX_INTERNAL
|0x0112);

189 
	}
}

192 
	$sšgË_¬g_2_”rÜ
()

194 
FPU_REG
 *
¡_Ãw_±r
;

196  
FPU_¡0_g
 )

198 
TW_NaN
:

199 iàĞ!(
FPU_¡0_±r
->
sigh
 & 0x40000000) )

201 
	`EXCEPTION
(
EX_Inv®id
);

202 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

206 
FPU_¡0_±r
->
sigh
 |= 0x40000000;

207 
¡_Ãw_±r
 = &
	`¡
(-1);

208 
	`push
();

209 
	`»g_move
(&
	`¡
(1), 
FPU_¡0_±r
);

215 
¡_Ãw_±r
 = &
	`¡
(-1);

216 
	`push
();

217 
	`»g_move
(&
	`¡
(1), 
FPU_¡0_±r
);

220 #ifdeà
PARANOID


222 
	`EXCEPTION
(
EX_INTERNAL
|0x0112);

225 
	}
}

230 
	$f2xm1
()

232 
	`ş—r_C1
();

233  
FPU_¡0_g
 )

235 
TW_V®id
:

237 
FPU_REG
 
rv
, 
tmp
;

239 iàĞ
FPU_¡0_±r
->
exp
 >= 0 )

243 iàĞ
FPU_¡0_±r
->
exp
 >= -64 )

245 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
 )

248 
	`pŞy_2xm1
(
FPU_¡0_±r
, &
rv
);

249 
	`»g_mul
(&
rv
, 
FPU_¡0_±r
, FPU_¡0_±r, 
FULL_PRECISION
);

256 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

257 
	`pŞy_2xm1
(
FPU_¡0_±r
, &
rv
);

258 
	`»g_mul
(&
rv
, 
FPU_¡0_±r
, &rv, 
FULL_PRECISION
);

259 
	`»g_add
(&
rv
, &
CONST_1
, &
tmp
, 
FULL_PRECISION
);

260 
	`»g_div
(&
rv
, &
tmp
, 
FPU_¡0_±r
, 
FULL_PRECISION
);

261 
FPU_¡0_±r
->
sign
 = 
SIGN_NEG
;

266 #ifdeà
DENORM_OPERAND


267 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

271 
	`»g_mul
(&
CONST_LN2
, 
FPU_¡0_±r
, FPU_¡0_±r, 
FULL_PRECISION
);

273 
	`£t_´ecisiÚ_æag_up
();

276 
TW_Z”o
:

278 
TW_Infš™y
:

279 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

282 
	`»g_move
(&
CONST_1
, 
FPU_¡0_±r
);

283 
FPU_¡0_±r
->
sign
 = 
SIGN_NEG
;

287 
	`sšgË_¬g_”rÜ
();

289 
	}
}

292 
	$ån
()

294 
FPU_REG
 *
¡_Ãw_±r
;

295 
q
;

296 
¬g_sign
 = 
FPU_¡0_±r
->
sign
;

299 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

301 
	`¡ack_und”æow
();

302 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

304 
¡_Ãw_±r
 = &
	`¡
(-1);

305 
	`push
();

306 
	`¡ack_und”æow
();

311 iàĞ
STACK_OVERFLOW
 )

312 { 
	`¡ack_ov”æow
(); ; }

314  
FPU_¡0_g
 )

316 
TW_V®id
:

318 iàĞ
FPU_¡0_±r
->
exp
 > 
EXP_BIAS
 - 40 )

320 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

321 iàĞ(
q
 = 
	`Œig_¬g
(
FPU_¡0_±r
, 
FPTAN
)) != -1 )

323 
	`»g_div
(
FPU_¡0_±r
, &
CONST_PI2
, FPU_st0_ptr,

324 
FULL_PRECISION
);

325 
	`pŞy_n
(
FPU_¡0_±r
, FPU_¡0_±r, 
q
 & 
FCOS
);

326 
FPU_¡0_±r
->
sign
 = (
q
 & 1è^ 
¬g_sign
;

331 
FPU_¡0_±r
->
sign
 = 
¬g_sign
;

340 iàĞ
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

342 #ifdeà
DENORM_OPERAND


343 iàĞ
	`d’Üm®_İ”ªd
() )

349 iàĞ
	`¬™h_und”æow
(
FPU_¡0_±r
) )

353 
	`£t_´ecisiÚ_æag_up
();

355 
	`push
();

356 
	`»g_move
(&
CONST_1
, 
FPU_¡0_±r
);

359 
TW_Infš™y
:

361 
	`¬™h_šv®id
(
FPU_¡0_±r
);

362 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

364 
¡_Ãw_±r
 = &
	`¡
(-1);

365 
	`push
();

366 
	`¬™h_šv®id
(
FPU_¡0_±r
);

369 
TW_Z”o
:

370 
	`push
();

371 
	`»g_move
(&
CONST_1
, 
FPU_¡0_±r
);

372 
	`£tcc
(0);

375 
	`sšgË_¬g_2_”rÜ
();

378 
	}
}

381 
	$fxŒaù
()

383 
FPU_REG
 *
¡_Ãw_±r
;

384 
FPU_REG
 *
¡1_±r
 = 
FPU_¡0_±r
;

386 iàĞ
STACK_OVERFLOW
 )

387 { 
	`¡ack_ov”æow
(); ; }

388 
	`ş—r_C1
();

389 iàĞ!(
FPU_¡0_g
 ^ 
TW_V®id
) )

391 
e
;

393 #ifdeà
DENORM_OPERAND


394 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

398 
	`push
();

399 
	`»g_move
(
¡1_±r
, 
FPU_¡0_±r
);

400 
FPU_¡0_±r
->
exp
 = 
EXP_BIAS
;

401 
e
 = 
¡1_±r
->
exp
 - 
EXP_BIAS
;

402 
	`cÚv”t_l2»g
(&
e
, 
¡1_±r
);

405 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

407 
sign
 = 
FPU_¡0_±r
->sign;

408 iàĞ
	`divide_by_z”o
(
SIGN_NEG
, 
FPU_¡0_±r
) )

410 
	`push
();

411 
	`»g_move
(&
CONST_Z
, 
FPU_¡0_±r
);

412 
FPU_¡0_±r
->
sign
 = sign;

415 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

417 
sign
 = 
FPU_¡0_±r
->sign;

418 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

419 
	`push
();

420 
	`»g_move
(&
CONST_INF
, 
FPU_¡0_±r
);

421 
FPU_¡0_±r
->
sign
 = sign;

424 iàĞ
FPU_¡0_g
 =ğ
TW_NaN
 )

426 iàĞ
	`»®_2İ_NaN
(
FPU_¡0_±r
, FPU_st0_ptr, FPU_st0_ptr) )

428 
	`push
();

429 
	`»g_move
(
¡1_±r
, 
FPU_¡0_±r
);

432 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

435 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

437 
	`¡ack_und”æow
();

438 
	`push
();

439 
	`¡ack_und”æow
();

442 
	`EXCEPTION
(
EX_SckUnd”
);

444 #ifdeà
PARANOID


446 
	`EXCEPTION
(
EX_INTERNAL
 | 0x119);

448 
	}
}

451 
	$fdec¡p
()

453 
	`ş—r_C1
();

454 
tİ
--;

455 
	}
}

457 
	$fšc¡p
()

459 
	`ş—r_C1
();

460 
tİ
++;

461 
	}
}

464 
	$fsq¹_
()

466 
	`ş—r_C1
();

467 iàĞ!(
FPU_¡0_g
 ^ 
TW_V®id
) )

469 
expÚ
;

471 ià(
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
)

473 
	`¬™h_šv®id
(
FPU_¡0_±r
);

477 #ifdeà
DENORM_OPERAND


478 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

482 
expÚ
 = 
FPU_¡0_±r
->
exp
 - 
EXP_BIAS
;

483 
FPU_¡0_±r
->
exp
 = 
EXP_BIAS
 + (
expÚ
 & 1);

485 
	`wm_sq¹
(
FPU_¡0_±r
, 
cÚŒŞ_wÜd
);

487 
FPU_¡0_±r
->
exp
 +ğ
expÚ
 >> 1;

488 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

490 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

492 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

494 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

495 
	`¬™h_šv®id
(
FPU_¡0_±r
);

499 { 
	`sšgË_¬g_”rÜ
(); ; }

501 
	}
}

504 
	$ändšt_
()

506 
æags
;

508 iàĞ!(
FPU_¡0_g
 ^ 
TW_V®id
) )

510 ià(
FPU_¡0_±r
->
exp
 > 
EXP_BIAS
+63)

513 #ifdeà
DENORM_OPERAND


514 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

519 iàĞ(
æags
 = 
	`round_to_št
(
FPU_¡0_±r
)) )

520 
	`£t_´ecisiÚ_æag
(
æags
);

522 
FPU_¡0_±r
->
exp
 = 
EXP_BIAS
 + 63;

523 
	`nÜm®ize
(
FPU_¡0_±r
);

526 iàĞ(
FPU_¡0_g
 =ğ
TW_Z”o
è|| (FPU_¡0_g =ğ
TW_Infš™y
) )

529 
	`sšgË_¬g_”rÜ
();

530 
	}
}

533 
	$fsš
()

535 
¬g_sign
 = 
FPU_¡0_±r
->
sign
;

537 iàĞ
FPU_¡0_g
 =ğ
TW_V®id
 )

539 
FPU_REG
 
rv
;

540 
q
;

542 iàĞ
FPU_¡0_±r
->
exp
 > 
EXP_BIAS
 - 40 )

544 
FPU_¡0_±r
->
sign
 = 
SIGN_POS
;

545 iàĞ(
q
 = 
	`Œig_¬g
(
FPU_¡0_±r
, 0)) != -1 )

547 
	`»g_div
(
FPU_¡0_±r
, &
CONST_PI2
, FPU_¡0_±r, 
FULL_PRECISION
);

549 
	`pŞy_sše
(
FPU_¡0_±r
, &
rv
);

551 ià(
q
 & 2)

552 
rv
.
sign
 ^ğ
SIGN_POS
 ^ 
SIGN_NEG
;

553 
rv
.
sign
 ^ğ
¬g_sign
;

554 
	`»g_move
(&
rv
, 
FPU_¡0_±r
);

557 
	`£t_´ecisiÚ_æag_up
();

563 
FPU_¡0_±r
->
sign
 = 
¬g_sign
;

572 iàĞ
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

574 #ifdeà
DENORM_OPERAND


575 iàĞ
	`d’Üm®_İ”ªd
() )

581 
	`¬™h_und”æow
(
FPU_¡0_±r
);

585 
	`£t_´ecisiÚ_æag_up
();

588 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

590 
	`£tcc
(0);

593 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

596 
	`¬™h_šv®id
(
FPU_¡0_±r
);

600 
	`sšgË_¬g_”rÜ
();

601 
	}
}

604 
	$f_cos
(
FPU_REG
 *
¬g
)

606 
¬g_sign
 = 
¬g
->
sign
;

608 iàĞ
¬g
->
g
 =ğ
TW_V®id
 )

610 
FPU_REG
 
rv
;

611 
q
;

613 iàĞ
¬g
->
exp
 > 
EXP_BIAS
 - 40 )

615 
¬g
->
sign
 = 
SIGN_POS
;

616 iàĞ(
q
 = 
	`Œig_¬g
(
¬g
, 
FCOS
)) != -1 )

618 
	`»g_div
(
¬g
, &
CONST_PI2
,‡rg, 
FULL_PRECISION
);

620 
	`pŞy_sše
(
¬g
, &
rv
);

622 ià((
q
+1) & 2)

623 
rv
.
sign
 ^ğ
SIGN_POS
 ^ 
SIGN_NEG
;

624 
	`»g_move
(&
rv
, 
¬g
);

627 
	`£t_´ecisiÚ_æag_down
();

634 
¬g
->
sign
 = 
¬g_sign
;

640 #ifdeà
DENORM_OPERAND


641 iàĞ(
¬g
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

645 
	`£tcc
(0);

646 
	`»g_move
(&
CONST_1
, 
¬g
);

647 #ifdeà
PECULIAR_486


648 
	`£t_´ecisiÚ_æag_down
();

650 
	`£t_´ecisiÚ_æag_up
();

655 iàĞ
¬g
->
g
 =ğ
TW_Z”o
 )

657 
	`»g_move
(&
CONST_1
, 
¬g
);

658 
	`£tcc
(0);

661 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

664 
	`¬™h_šv®id
(
FPU_¡0_±r
);

669 
	`sšgË_¬g_”rÜ
();

672 
	}
}

675 
	$fcos
()

677 
	`f_cos
(
FPU_¡0_±r
);

678 
	}
}

681 
	$fsšcos
()

683 
FPU_REG
 *
¡_Ãw_±r
;

684 
FPU_REG
 
¬g
;

687 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

689 
	`¡ack_und”æow
();

690 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

692 
¡_Ãw_±r
 = &
	`¡
(-1);

693 
	`push
();

694 
	`¡ack_und”æow
();

699 iàĞ
STACK_OVERFLOW
 )

700 { 
	`¡ack_ov”æow
(); ; }

702 iàĞ
FPU_¡0_g
 =ğ
TW_NaN
 )

704 
	`sšgË_¬g_2_”rÜ
();

707 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

710 iàĞ!
	`¬™h_šv®id
(
FPU_¡0_±r
) )

713 
	`push
();

714 
	`¬™h_šv®id
(
FPU_¡0_±r
);

719 
	`»g_move
(
FPU_¡0_±r
,&
¬g
);

720 iàĞ!
	`f_cos
(&
¬g
) )

722 
	`fsš
();

723 
	`push
();

724 
	`»g_move
(&
¬g
,
FPU_¡0_±r
);

727 
	}
}

739 
	$»m_k”Ãl
(
¡0
, *
y
,

740 
¡1
,

741 
q
, 
n
)

743 
x
;

745 
x
 = 
¡0
 << 
n
;

748 
asm
 volatile ("movl %2,%%eax; mull %4; subl %%eax,%0; sbbl %%edx,%1;

749 
movl
 %3,%%
—x
; 
muÎ
 %4; 
subl
 %%eax,%1;

750 
movl
 %2,%%
—x
; 
muÎ
 %5; 
subl
 %%eax,%1;"

751 :"=m" (
x
), "=m" (((*)&x)[1])

752 :"m" (
¡1
),"m" (((*)&st1)[1]),

753 "m" (
q
),"m" (((*)&q)[1])

756 *
y
 = 
x
;

757 
	}
}

763 
	$do_å»m
(
round
)

765 
FPU_REG
 *
¡1_±r
 = &
	`¡
(1);

766 
¡1_g
 = 
¡1_±r
->
g
;

767 
sign
 = 
FPU_¡0_±r
->sign;

769 iàĞ!((
FPU_¡0_g
 ^ 
TW_V®id
è| (
¡1_g
 ^ TW_Valid)) )

771 
FPU_REG
 
tmp
;

772 
Şd_cw
 = 
cÚŒŞ_wÜd
;

773 
expdif
 = 
FPU_¡0_±r
->
exp
 - 
¡1_±r
->exp;

774 
q
;

775 
§ved_¡©us
;

776 
cc
 = 0;

778 #ifdeà
DENORM_OPERAND


779 iàĞ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
) ||

780 (
¡1_±r
->
exp
 <ğ
EXP_UNDER
)è&& (
	`d’Üm®_İ”ªd
()) )

786 
§ved_¡©us
 = 
·¹Ÿl_¡©us
;

787 
cÚŒŞ_wÜd
 &ğ~
CW_RC
;

788 
cÚŒŞ_wÜd
 |ğ
RC_CHOP
;

790 ià(
expdif
 < 64)

794 iàĞ
expdif
 > -2 )

796 
	`»g_div
(
FPU_¡0_±r
, 
¡1_±r
, &
tmp
, 
PR_64_BITS
 | 
RC_CHOP
 | 0x3f);

798 iàĞ
tmp
.
exp
 >ğ
EXP_BIAS
 )

800 
	`round_to_št
(&
tmp
);

802 
q
 = 
	`signifiÿnd
(&
tmp
);

804 
	`»m_k”Ãl
(
	`signifiÿnd
(
FPU_¡0_±r
),

805 &
	`signifiÿnd
(&
tmp
),

806 
	`signifiÿnd
(
¡1_±r
),

807 
q
, 
expdif
);

809 
tmp
.
exp
 = 
¡1_±r
->exp;

813 
	`»g_move
(
FPU_¡0_±r
, &
tmp
);

814 
q
 = 0;

816 
tmp
.
sign
 = sign;

818 iàĞ(
round
 =ğ
RC_RND
è&& (
tmp
.
sigh
 & 0xc0000000) )

822 
x
;

823 
expdif
 = 
¡1_±r
->
exp
 - 
tmp
.exp;

824 iàĞ
expdif
 <= 1 )

826 iàĞ
expdif
 == 0 )

827 
x
 = 
	`signifiÿnd
(
¡1_±r
è- signifiÿnd(&
tmp
);

829 
x
 = (
	`signifiÿnd
(
¡1_±r
è<< 1è- signifiÿnd(&
tmp
);

830 iàĞ(
x
 < 
	`signifiÿnd
(&
tmp
)) ||

832 ((
x
 =ğ
	`signifiÿnd
(&
tmp
)è&& (
q
 & 1) ) )

834 
tmp
.
sign
 ^ğ(
SIGN_POS
^
SIGN_NEG
);

835 
	`signifiÿnd
(&
tmp
èğ
x
;

836 
q
++;

841 ià(
q
 & 4è
cc
 |ğ
SW_C0
;

842 ià(
q
 & 2è
cc
 |ğ
SW_C3
;

843 ià(
q
 & 1è
cc
 |ğ
SW_C1
;

847 
cÚŒŞ_wÜd
 = 
Şd_cw
;

848 
	`£tcc
(0);

857 
exp_1
;

861 
	`»g_move
(
FPU_¡0_±r
, &
tmp
);

862 
tmp
.
exp
 = 
EXP_BIAS
 + 56;

863 
exp_1
 = 
¡1_±r
->
exp
; st1_±r->ex°ğ
EXP_BIAS
;

864 
expdif
 -= 56;

866 
	`»g_div
(&
tmp
, 
¡1_±r
, &tmp, 
PR_64_BITS
 | 
RC_CHOP
 | 0x3f);

867 
¡1_±r
->
exp
 = 
exp_1
;

869 
	`round_to_št
(&
tmp
);

871 
	`»m_k”Ãl
(
	`signifiÿnd
(
FPU_¡0_±r
),

872 &
	`signifiÿnd
(&
tmp
),

873 
	`signifiÿnd
(
¡1_±r
),

874 
	`signifiÿnd
(&
tmp
),

875 
tmp
.
exp
 - 
EXP_BIAS


877 
tmp
.
exp
 = 
exp_1
 + 
expdif
;

878 
tmp
.
sign
 = sign;

885 iàĞ!(
tmp
.
sigh
 |mp.
sigl
) )

888 
cÚŒŞ_wÜd
 = 
Şd_cw
;

889 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

890 
	`»g_move
(&
CONST_Z
, 
FPU_¡0_±r
);

891 
FPU_¡0_±r
->
sign
 = sign;

892 #ifdeà
PECULIAR_486


893 
	`£tcc
(
SW_C2
);

895 
	`£tcc
(0);

899 
cc
 = 
SW_C2
;

902 
cÚŒŞ_wÜd
 = 
Şd_cw
;

903 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

904 
	`nÜm®ize_nuo
(&
tmp
);

905 
	`»g_move
(&
tmp
, 
FPU_¡0_±r
);

906 
	`£tcc
(
cc
);

910 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (FPU_¡0_±r->
g
 !ğ
TW_Z”o
)

911 && !(
cÚŒŞ_wÜd
 & 
CW_Und”æow
) )

912 
	`¬™h_und”æow
(
FPU_¡0_±r
);

916 iàĞ(
FPU_¡0_g
 =ğ
TW_Em±y
è| (
¡1_g
 == TW_Empty) )

918 
	`¡ack_und”æow
();

921 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

923 iàĞ
¡1_g
 =ğ
TW_V®id
 )

925 #ifdeà
DENORM_OPERAND


926 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

930 
	`£tcc
(0); ;

932 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

933 { 
	`¬™h_šv®id
(
FPU_¡0_±r
); ; }

934 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

935 { 
	`£tcc
(0); ; }

937 iàĞ
FPU_¡0_g
 =ğ
TW_V®id
 )

939 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

941 
	`¬™h_šv®id
(
FPU_¡0_±r
);

944 iàĞ
¡1_g
 !ğ
TW_NaN
 )

946 #ifdeà
DENORM_OPERAND


947 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

951 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

954 
	`£tcc
(0); ;

958 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

960 iàĞ
¡1_g
 !ğ
TW_NaN
 )

962 
	`¬™h_šv®id
(
FPU_¡0_±r
);

969 #ifdeà
PARANOID


970 iàĞ(
FPU_¡0_g
 !ğ
TW_NaN
è&& (
¡1_g
 != TW_NaN) )

971 
	`EXCEPTION
(
EX_INTERNAL
 | 0x118);

974 
	`»®_2İ_NaN
(
¡1_±r
, 
FPU_¡0_±r
, FPU_st0_ptr);

976 
	}
}

980 
	$fyl2x
()

982 
FPU_REG
 *
¡1_±r
 = &
	`¡
(1);

983 
¡1_g
 = 
¡1_±r
->
g
;

985 
	`ş—r_C1
();

986 iàĞ!((
FPU_¡0_g
 ^ 
TW_V®id
è| (
¡1_g
 ^ TW_Valid)) )

988 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
 )

990 
§ved_cÚŒŞ
, 
§ved_¡©us
;

992 #ifdeà
DENORM_OPERAND


993 iàĞ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
) ||

994 (
¡1_±r
->
exp
 <ğ
EXP_UNDER
)è&& (
	`d’Üm®_İ”ªd
()) )

1000 
§ved_¡©us
 = 
·¹Ÿl_¡©us
;

1001 
§ved_cÚŒŞ
 = 
cÚŒŞ_wÜd
;

1002 
cÚŒŞ_wÜd
 = 
FULL_PRECISION
;

1004 
	`pŞy_l2
(
FPU_¡0_±r
, FPU_st0_ptr);

1007 
cÚŒŞ_wÜd
 = 
§ved_cÚŒŞ
;

1008 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

1011 
	`»g_mul
(
FPU_¡0_±r
, 
¡1_±r
, st1_±r, 
FULL_PRECISION
);

1013 
	`pİ
(); 
FPU_¡0_±r
 = &
	`¡
(0);

1018 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1019 
	`pİ
();

1023 iàĞ(
FPU_¡0_g
 =ğ
TW_Em±y
è|| (
¡1_g
 == TW_Empty) )

1025 
	`¡ack_und”æow_pİ
(1);

1028 iàĞ(
FPU_¡0_g
 =ğ
TW_NaN
è|| (
¡1_g
 == TW_NaN) )

1030 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1031 
	`pİ
();

1034 iàĞ(
FPU_¡0_g
 <ğ
TW_Z”o
è&& (
¡1_g
 <= TW_Zero) )

1037 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

1039 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

1042 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1043 
	`pİ
();

1045 #ifdeà
PECULIAR_486


1049 iàĞ
FPU_¡0_±r
->
g
 =ğ
TW_Infš™y
 )

1051 
	`»g_move
(&
CONST_INF
, 
¡1_±r
);

1052 
	`pİ
();

1057 iàĞ!
	`divide_by_z”o
(
¡1_±r
->
sign
^
SIGN_NEG
^
SIGN_POS
, st1_ptr) )

1058 
	`pİ
();

1066 
sign
 = 
¡1_±r
->sign;

1068 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

1071 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1072 
	`pİ
();

1076 #ifdeà
DENORM_OPERAND


1077 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1081 iàĞ
FPU_¡0_±r
->
exp
 < 
EXP_BIAS
 ) 
sign
 ^ğ
SIGN_NEG
^
SIGN_POS
;

1082 
	`pİ
(); 
FPU_¡0_±r
 = &
	`¡
(0);

1083 
	`»g_move
(&
CONST_Z
, 
FPU_¡0_±r
);

1084 
FPU_¡0_±r
->
sign
 = sign;

1089 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

1091 iàĞ(
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
è|| (
¡1_g
 =ğ
TW_Z”o
) )

1094 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1095 
	`pİ
();

1100 
sign
 = 
¡1_±r
->sign;

1102 #ifdeà
DENORM_OPERAND


1103 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1107 
	`pİ
(); 
FPU_¡0_±r
 = &
	`¡
(0);

1108 
	`»g_move
(&
CONST_INF
, 
FPU_¡0_±r
);

1109 
FPU_¡0_±r
->
sign
 = sign;

1114 iàĞ(
FPU_¡0_g
 =ğ
TW_V®id
è&& (
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
) )

1116 iàĞ
FPU_¡0_±r
->
exp
 >ğ
EXP_BIAS
 )

1118 iàĞ(
FPU_¡0_±r
->
exp
 =ğ
EXP_BIAS
) &&

1119 (
FPU_¡0_±r
->
sigh
 == 0x80000000) &&

1120 (
FPU_¡0_±r
->
sigl
 == 0) )

1124 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1125 
	`pİ
();

1129 
	`pİ
();

1135 #ifdeà
DENORM_OPERAND


1136 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1140 
¡1_±r
->
sign
 ^ğ
SIGN_NEG
;

1141 
	`pİ
();

1148 iàĞ
FPU_¡0_±r
->
g
 =ğ
TW_Z”o
 )

1151 #iâdeà
PECULIAR_486


1152 iàĞ!
	`divide_by_z”o
(
¡1_±r
->
sign
, st1_ptr) )

1155 
¡1_±r
->
sign
 ^ğ
SIGN_NEG
^
SIGN_POS
;

1156 
	`pİ
();

1162 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1163 
	`pİ
();

1167 
	}
}

1170 
	$å©ª
()

1172 
FPU_REG
 *
¡1_±r
 = &
	`¡
(1);

1173 
¡1_g
 = 
¡1_±r
->
g
;

1174 
¡1_sign
 = 
¡1_±r
->
sign
, 
¡0_sign
 = 
FPU_¡0_±r
->sign;

1176 
	`ş—r_C1
();

1177 iàĞ!((
FPU_¡0_g
 ^ 
TW_V®id
è| (
¡1_g
 ^ TW_Valid)) )

1179 
§ved_cÚŒŞ
, 
§ved_¡©us
;

1180 
FPU_REG
 
sum
;

1181 
šv”‹d
;

1183 #ifdeà
DENORM_OPERAND


1184 iàĞ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
) ||

1185 (
¡1_±r
->
exp
 <ğ
EXP_UNDER
)è&& (
	`d’Üm®_İ”ªd
()) )

1190 
§ved_¡©us
 = 
·¹Ÿl_¡©us
;

1191 
§ved_cÚŒŞ
 = 
cÚŒŞ_wÜd
;

1192 
cÚŒŞ_wÜd
 = 
FULL_PRECISION
;

1194 
¡1_±r
->
sign
 = 
FPU_¡0_±r
->sigÀğ
SIGN_POS
;

1195 iàĞ(
	`com·»
(
¡1_±r
è& ~
COMP_D’Üm®
è=ğ
COMP_A_É_B
 )

1197 
šv”‹d
 = 1;

1198 
	`»g_div
(
FPU_¡0_±r
, 
¡1_±r
, &
sum
, 
FULL_PRECISION
);

1202 
šv”‹d
 = 0;

1203 iàĞ(
¡0_sign
 == 0) &&

1204 (
¡1_±r
->
exp
 - 
FPU_¡0_±r
->exp < -64) )

1206 
cÚŒŞ_wÜd
 = 
§ved_cÚŒŞ
;

1207 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

1208 
	`»g_div
(
¡1_±r
, 
FPU_¡0_±r
, st1_ptr,

1209 
cÚŒŞ_wÜd
 | 
PR_64_BITS
);

1210 
¡1_±r
->
sign
 = 
¡1_sign
;

1211 
	`pİ
();

1212 
	`£t_´ecisiÚ_æag_down
();

1215 
	`»g_div
(
¡1_±r
, 
FPU_¡0_±r
, &
sum
, 
FULL_PRECISION
);

1218 
	`pŞy_©ª
(&
sum
);

1220 iàĞ
šv”‹d
 )

1222 
	`»g_sub
(&
CONST_PI2
, &
sum
, &sum, 
FULL_PRECISION
);

1224 iàĞ
¡0_sign
 )

1226 
	`»g_sub
(&
CONST_PI
, &
sum
, &sum, 
FULL_PRECISION
);

1228 
sum
.
sign
 = 
¡1_sign
;

1231 
cÚŒŞ_wÜd
 = 
§ved_cÚŒŞ
;

1232 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

1234 
	`»g_move
(&
sum
, 
¡1_±r
);

1236 iàĞ(
FPU_¡0_g
 =ğ
TW_Em±y
è|| (
¡1_g
 == TW_Empty) )

1238 
	`¡ack_und”æow_pİ
(1);

1241 iàĞ(
FPU_¡0_g
 =ğ
TW_NaN
è|| (
¡1_g
 == TW_NaN) )

1243 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1244 
	`pİ
();

1247 iàĞ(
FPU_¡0_g
 =ğ
TW_Infš™y
è|| (
¡1_g
 == TW_Infinity) )

1249 
sign
 = 
¡1_±r
->sign;

1250 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

1252 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1254 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
 )

1255 { 
	`»g_move
(&
CONST_PI4
, 
¡1_±r
); }

1257 
	`»g_add
(&
CONST_PI4
, &
CONST_PI2
, 
¡1_±r
, 
FULL_PRECISION
);

1261 #ifdeà
DENORM_OPERAND


1262 iàĞ
¡1_g
 !ğ
TW_Z”o
 )

1264 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1269 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
 )

1271 
	`»g_move
(&
CONST_Z
, 
¡1_±r
);

1272 
¡1_±r
->
sign
 = sign;

1273 
	`pİ
();

1277 
	`»g_move
(&
CONST_PI
, 
¡1_±r
);

1283 #ifdeà
DENORM_OPERAND


1284 iàĞ
FPU_¡0_g
 !ğ
TW_Z”o
 )

1286 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1291 
	`»g_move
(&
CONST_PI2
, 
¡1_±r
);

1293 
¡1_±r
->
sign
 = sign;

1295 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

1298 
sign
 = 
¡1_±r
->sign;

1300 #ifdeà
DENORM_OPERAND


1301 iàĞ
FPU_¡0_g
 !ğ
TW_Z”o
 )

1303 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1308 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
 )

1309 { 
	`pİ
(); ; }

1311 
	`»g_move
(&
CONST_PI
, 
¡1_±r
);

1312 
¡1_±r
->
sign
 = sign;

1314 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

1317 
sign
 = 
¡1_±r
->sign;

1319 #ifdeà
DENORM_OPERAND


1320 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1324 
	`»g_move
(&
CONST_PI2
, 
¡1_±r
);

1325 
¡1_±r
->
sign
 = sign;

1327 #ifdeà
PARANOID


1329 
	`EXCEPTION
(
EX_INTERNAL
 | 0x125);

1332 
	`pİ
();

1333 
	`£t_´ecisiÚ_æag_up
();

1334 
	}
}

1337 
	$å»m
()

1339 
	`do_å»m
(
RC_CHOP
);

1340 
	}
}

1343 
	$å»m1
()

1345 
	`do_å»m
(
RC_RND
);

1346 
	}
}

1349 
	$fyl2xp1
()

1351 
FPU_REG
 *
¡1_±r
 = &
	`¡
(1);

1352 
¡1_g
 = 
¡1_±r
->
g
;

1354 
	`ş—r_C1
();

1355 iàĞ!((
FPU_¡0_g
 ^ 
TW_V®id
è| (
¡1_g
 ^ TW_Valid)) )

1357 
§ved_cÚŒŞ
, 
§ved_¡©us
;

1359 #ifdeà
DENORM_OPERAND


1360 iàĞ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
) ||

1361 (
¡1_±r
->
exp
 <ğ
EXP_UNDER
)è&& 
	`d’Üm®_İ”ªd
() )

1366 
§ved_¡©us
 = 
·¹Ÿl_¡©us
;

1367 
§ved_cÚŒŞ
 = 
cÚŒŞ_wÜd
;

1368 
cÚŒŞ_wÜd
 = 
FULL_PRECISION
;

1370 iàĞ
	`pŞy_l2p1
(
FPU_¡0_±r
, FPU_st0_ptr) )

1372 #ifdeà
PECULIAR_486


1373 
¡1_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

1374 
cÚŒŞ_wÜd
 = 
§ved_cÚŒŞ
;

1375 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

1376 
	`£t_´ecisiÚ_æag_down
();

1378 iàĞ
	`¬™h_šv®id
(
¡1_±r
) )

1381 
	`pİ
(); ;

1385 
cÚŒŞ_wÜd
 = 
§ved_cÚŒŞ
;

1386 
·¹Ÿl_¡©us
 = 
§ved_¡©us
;

1389 
	`»g_mul
(
FPU_¡0_±r
, 
¡1_±r
, st1_±r, 
FULL_PRECISION
);

1391 
	`pİ
();

1393 iàĞ(
FPU_¡0_g
 =ğ
TW_Em±y
è| (
¡1_g
 == TW_Empty) )

1395 
	`¡ack_und”æow_pİ
(1);

1398 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

1400 iàĞ
¡1_g
 <ğ
TW_Z”o
 )

1402 #ifdeà
DENORM_OPERAND


1403 iàĞ(
¡1_g
 =ğ
TW_V®id
è&& (
¡1_±r
->
exp
 <ğ
EXP_UNDER
) &&

1404 (
	`d’Üm®_İ”ªd
()) )

1408 
FPU_¡0_±r
->
sign
 ^ğ
¡1_±r
->sign;

1409 
	`»g_move
(
FPU_¡0_±r
, 
¡1_±r
);

1411 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1414 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1415 
	`pİ
();

1418 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1420 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1421 
	`pİ
();

1424 #ifdeà
PARANOID


1427 
	`EXCEPTION
(
EX_INTERNAL
 | 0x116);

1431 
	`pİ
(); ;

1433 iàĞ
FPU_¡0_g
 =ğ
TW_V®id
 )

1435 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

1437 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

1439 iàĞ
FPU_¡0_±r
->
exp
 >ğ
EXP_BIAS
 )

1442 #ifdeà
PECULIAR_486


1443 
¡1_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

1445 iàĞ
	`¬™h_šv®id
(
¡1_±r
) ) ;

1447 
	`pİ
(); ;

1449 #ifdeà
DENORM_OPERAND


1450 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1453 
¡1_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

1454 
	`pİ
(); ;

1456 #ifdeà
DENORM_OPERAND


1457 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1460 
	`pİ
(); ;

1462 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1464 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

1466 iàĞ(
FPU_¡0_±r
->
exp
 >ğ
EXP_BIAS
) &&

1467 !((
FPU_¡0_±r
->
sigh
 == 0x80000000) &&

1468 (
FPU_¡0_±r
->
sigl
 == 0)) )

1471 #ifdeà
PECULIAR_486


1472 
¡1_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

1474 iàĞ
	`¬™h_šv®id
(
¡1_±r
) ) ;

1476 
	`pİ
(); ;

1478 #ifdeà
DENORM_OPERAND


1479 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1482 
¡1_±r
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

1483 
	`pİ
(); ;

1485 #ifdeà
DENORM_OPERAND


1486 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1489 
	`pİ
(); ;

1491 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1493 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1494 
	`pİ
();

1498 iàĞ
FPU_¡0_g
 =ğ
TW_NaN
 )

1500 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1501 
	`pİ
();

1504 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

1506 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1508 iàĞ!
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, st1_ptr) )

1509 
	`pİ
();

1512 iàĞ
FPU_¡0_±r
->
sign
 =ğ
SIGN_NEG
 )

1514 
expÚ’t
 = 
¡1_±r
->
exp
;

1515 #iâdeà
PECULIAR_486


1517 iàĞ
	`¬™h_šv®id
(
¡1_±r
) )

1520 #ifdeà
DENORM_OPERAND


1521 iàĞ
¡1_g
 !ğ
TW_Z”o
 )

1523 iàĞ(
expÚ’t
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1527 #ifdeà
PECULIAR_486


1529 iàĞ
	`¬™h_šv®id
(
¡1_±r
) )

1532 
	`pİ
();

1535 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

1538 iàĞ!
	`¬™h_šv®id
(
¡1_±r
) )

1539 
	`pİ
();

1545 #ifdeà
DENORM_OPERAND


1546 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1552 { 
sign
 = 
¡1_±r
->sign;

1553 
	`»g_move
(&
CONST_INF
, 
¡1_±r
);

1554 
¡1_±r
->
sign
 = sign;

1556 
	`pİ
();

1559 #ifdeà
PARANOID


1562 
	`EXCEPTION
(
EX_INTERNAL
 | 0x117);

1565 
	}
}

1568 
	$fsÿË
()

1570 
FPU_REG
 *
¡1_±r
 = &
	`¡
(1);

1571 
¡1_g
 = 
¡1_±r
->
g
;

1572 
Şd_cw
 = 
cÚŒŞ_wÜd
;

1573 
sign
 = 
FPU_¡0_±r
->sign;

1575 
	`ş—r_C1
();

1576 iàĞ!((
FPU_¡0_g
 ^ 
TW_V®id
è| (
¡1_g
 ^ TW_Valid)) )

1578 
sÿË
;

1579 
FPU_REG
 
tmp
;

1581 #ifdeà
DENORM_OPERAND


1582 iàĞ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
) ||

1583 (
¡1_±r
->
exp
 <ğ
EXP_UNDER
)è&& (
	`d’Üm®_İ”ªd
()) )

1587 iàĞ
¡1_±r
->
exp
 > 
EXP_BIAS
 + 30 )

1590 
sign
;

1592 iàĞ
¡1_±r
->
sign
 =ğ
SIGN_POS
 )

1594 
	`EXCEPTION
(
EX_Ov”æow
);

1595 
sign
 = 
FPU_¡0_±r
->sign;

1596 
	`»g_move
(&
CONST_INF
, 
FPU_¡0_±r
);

1597 
FPU_¡0_±r
->
sign
 = sign;

1601 
	`EXCEPTION
(
EX_Und”æow
);

1602 
sign
 = 
FPU_¡0_±r
->sign;

1603 
	`»g_move
(&
CONST_Z
, 
FPU_¡0_±r
);

1604 
FPU_¡0_±r
->
sign
 = sign;

1609 
cÚŒŞ_wÜd
 &ğ~
CW_RC
;

1610 
cÚŒŞ_wÜd
 |ğ
RC_CHOP
;

1611 
	`»g_move
(
¡1_±r
, &
tmp
);

1612 
	`round_to_št
(&
tmp
);

1613 
cÚŒŞ_wÜd
 = 
Şd_cw
;

1614 
sÿË
 = 
¡1_±r
->
sign
 ? -
tmp
.
sigl
 :mp.sigl;

1615 
sÿË
 +ğ
FPU_¡0_±r
->
exp
;

1616 
FPU_¡0_±r
->
exp
 = 
sÿË
;

1619 
	`round_»g
(
FPU_¡0_±r
, 0, 
cÚŒŞ_wÜd
);

1623 iàĞ
FPU_¡0_g
 =ğ
TW_V®id
 )

1625 iàĞ
¡1_g
 =ğ
TW_Z”o
 )

1628 #ifdeà
DENORM_OPERAND


1629 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1635 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1637 #ifdeà
DENORM_OPERAND


1638 iàĞ(
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1642 iàĞ
¡1_±r
->
sign
 =ğ
SIGN_POS
 )

1643 { 
	`»g_move
(&
CONST_INF
, 
FPU_¡0_±r
); }

1645 
	`»g_move
(&
CONST_Z
, 
FPU_¡0_±r
);

1646 
FPU_¡0_±r
->
sign
 = sign;

1649 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1650 { 
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, FPU_st0_ptr); ; }

1652 iàĞ
FPU_¡0_g
 =ğ
TW_Z”o
 )

1654 iàĞ
¡1_g
 =ğ
TW_V®id
 )

1657 #ifdeà
DENORM_OPERAND


1658 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1664 iàĞ
¡1_g
 =ğ
TW_Z”o
 ) { ; }

1665 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1667 iàĞ
¡1_±r
->
sign
 =ğ
SIGN_NEG
 )

1671 
	`¬™h_šv®id
(
FPU_¡0_±r
);

1675 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1676 { 
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, FPU_st0_ptr); ; }

1678 iàĞ
FPU_¡0_g
 =ğ
TW_Infš™y
 )

1680 iàĞ
¡1_g
 =ğ
TW_V®id
 )

1683 #ifdeà
DENORM_OPERAND


1684 iàĞ(
¡1_±r
->
exp
 <ğ
EXP_UNDER
è&& (
	`d’Üm®_İ”ªd
()) )

1690 iàĞ((
¡1_g
 =ğ
TW_Infš™y
è&& (
¡1_±r
->
sign
 =ğ
SIGN_POS
))

1691 || (
¡1_g
 =ğ
TW_Z”o
) )

1693 iàĞ
¡1_g
 =ğ
TW_Infš™y
 )

1695 
	`¬™h_šv®id
(
FPU_¡0_±r
);

1698 iàĞ
¡1_g
 =ğ
TW_NaN
 )

1699 { 
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, FPU_st0_ptr); ; }

1701 iàĞ
FPU_¡0_g
 =ğ
TW_NaN
 )

1703 iàĞ
¡1_g
 !ğ
TW_Em±y
 )

1704 { 
	`»®_2İ_NaN
(
FPU_¡0_±r
, 
¡1_±r
, FPU_st0_ptr); ; }

1707 #ifdeà
PARANOID


1708 iàĞ!((
FPU_¡0_g
 =ğ
TW_Em±y
è|| (
¡1_g
 == TW_Empty)) )

1710 
	`EXCEPTION
(
EX_INTERNAL
 | 0x115);

1716 
	`¡ack_und”æow
();

1718 
	}
}

1723 
FUNC
 cÚ¡ 
	gŒig_bË_a
[] = {

1724 
f2xm1
, 
fyl2x
, 
ån
, 
å©ª
, 
fxŒaù
, 
å»m1
, 
fdec¡p
, 
fšc¡p


1727 
	$Œig_a
()

1729 (
Œig_bË_a
[
FPU_rm
])();

1730 
	}
}

1733 
FUNC
 cÚ¡ 
	gŒig_bË_b
[] =

1735 
å»m
, 
fyl2xp1
, 
fsq¹_
, 
fsšcos
, 
ändšt_
, 
fsÿË
, 
fsš
, 
fcos


1738 
	$Œig_b
()

1740 (
Œig_bË_b
[
FPU_rm
])();

1741 
	}
}

	@drivers/FPU-emu/get_address.c

21 
	~<lšux/¡ddef.h
>

23 
	~<asm/£gm’t.h
>

25 
	~"åu_sy¡em.h
"

26 
	~"exû±iÚ.h
"

27 
	~"åu_emu.h
"

29 
	g»g_off£t
[] = {

30 
off£tof
(
šfo
,
___—x
),

31 
off£tof
(
šfo
,
___ecx
),

32 
off£tof
(
šfo
,
___edx
),

33 
off£tof
(
šfo
,
___ebx
),

34 
off£tof
(
šfo
,
___e¥
),

35 
off£tof
(
šfo
,
___ebp
),

36 
off£tof
(
šfo
,
___esi
),

37 
off£tof
(
šfo
,
___edi
)

40 
	#REG_
(
x
è(*(*)(
»g_off£t
[(x)]+(*è
FPU_šfo
))

	)

42 
	g»g_off£t_vm86
[] = {

43 
off£tof
(
šfo
,
___cs
),

44 
off£tof
(
šfo
,
___vm86_ds
),

45 
off£tof
(
šfo
,
___vm86_es
),

46 
off£tof
(
šfo
,
___vm86_fs
),

47 
off£tof
(
šfo
,
___vm86_gs
),

48 
off£tof
(
šfo
,
___ss
)

51 
	#VM86_REG_
(
x
) (*(*) \

52 (
»g_off£t_vm86
[(()
x
)]+(*è
FPU_šfo
))

	)

56 *
	$sib
(
mod
, *
åu_e
)

58 
ss
,
šdex
,
ba£
;

59 
off£t
;

61 
RE_ENTRANT_CHECK_OFF
;

62 
	`FPU_code_v”ify_¬—
(1);

63 
ba£
 = 
	`g‘_fs_by‹
((*è(*
åu_e
));

64 
RE_ENTRANT_CHECK_ON
;

65 (*
åu_e
)++;

66 
ss
 = 
ba£
 >> 6;

67 
šdex
 = (
ba£
 >> 3) & 7;

68 
ba£
 &= 7;

70 ià((
mod
 =ğ0è&& (
ba£
 == 5))

71 
off£t
 = 0;

73 
off£t
 = 
	`REG_
(
ba£
);

75 ià(
šdex
 == 4)

79 iàĞ
ss
 )

80 
	`EXCEPTION
(
EX_Inv®id
);

84 
off£t
 +ğ(
	`REG_
(
šdex
)è<< 
ss
;

87 ià(
mod
 == 1)

90 
RE_ENTRANT_CHECK_OFF
;

91 
	`FPU_code_v”ify_¬—
(1);

92 
off£t
 +ğ(sigÃd è
	`g‘_fs_by‹
((*è(*
åu_e
));

93 
RE_ENTRANT_CHECK_ON
;

94 (*
åu_e
)++;

96 ià(
mod
 =ğ2 || 
ba£
 == 5)

99 
RE_ENTRANT_CHECK_OFF
;

100 
	`FPU_code_v”ify_¬—
(4);

101 
off£t
 +ğ(sigÃdè
	`g‘_fs_lÚg
((*è(*
åu_e
));

102 
RE_ENTRANT_CHECK_ON
;

103 (*
åu_e
) += 4;

106  (*è
off£t
;

107 
	}
}

110 
	$vm86_£gm’t
(
£gm’t
)

112 
£gm’t
--;

113 #ifdeà
PARANOID


114 iàĞ
£gm’t
 > 
PREFIX_SS_
 )

116 
	`EXCEPTION
(
EX_INTERNAL
|0x130);

117 
	`m©h_abÜt
(
FPU_šfo
,
SIGSEGV
);

120  ()
	`VM86_REG_
(
£gm’t
) << 4;

121 
	}
}

141 
	$g‘_add»ss
(
FPU_modrm
, *
åu_e
,

142 
åu_addr_modes
 
addr_modes
)

144 
mod
;

145 *
ıu_»g_±r
;

146 
off£t
 = 0;

148 #iâdeà
PECULIAR_486


150 
FPU_d©a_£ËùÜ
 = 
FPU_DS
;

155 
	#FPU_WRITE_BIT
 0x10

	)

156 iàĞ!
addr_modes
.
vm86
 && (
FPU_modrm
 & 
FPU_WRITE_BIT
)

157 && (
addr_modes
.
ov”ride
.
£gm’t
 =ğ
PREFIX_CS_
) )

159 
	`m©h_abÜt
(
FPU_šfo
,
SIGSEGV
);

162 
mod
 = (
FPU_modrm
 >> 6) & 3;

164 ià(
FPU_rm
 =ğ4 && 
mod
 != 3)

166 
FPU_d©a_add»ss
 = 
	`sib
(
mod
, 
åu_e
);

170 
ıu_»g_±r
 = & 
	`REG_
(
FPU_rm
);

171 
mod
)

174 ià(
FPU_rm
 == 5)

177 
RE_ENTRANT_CHECK_OFF
;

178 
	`FPU_code_v”ify_¬—
(4);

179 
off£t
 = 
	`g‘_fs_lÚg
((*è(*
åu_e
));

180 (*
åu_e
) += 4;

181 
RE_ENTRANT_CHECK_ON
;

182 
FPU_d©a_add»ss
 = (*è
off£t
;

187 
FPU_d©a_add»ss
 = (*)*
ıu_»g_±r
;

193 
RE_ENTRANT_CHECK_OFF
;

194 
	`FPU_code_v”ify_¬—
(1);

195 
off£t
 = (sigÃd è
	`g‘_fs_by‹
((*è(*
åu_e
));

196 
RE_ENTRANT_CHECK_ON
;

197 (*
åu_e
)++;

201 
RE_ENTRANT_CHECK_OFF
;

202 
	`FPU_code_v”ify_¬—
(4);

203 
off£t
 = (sigÃdè
	`g‘_fs_lÚg
((*è(*
åu_e
));

204 (*
åu_e
) += 4;

205 
RE_ENTRANT_CHECK_ON
;

209 
	`EXCEPTION
(
EX_Inv®id
);

212 iàĞ
addr_modes
.
vm86
 )

214 
off£t
 +ğ
	`vm86_£gm’t
(
addr_modes
.
ov”ride
.
£gm’t
);

217 
FPU_d©a_add»ss
 = 
off£t
 + (*)*
ıu_»g_±r
;

218 
	}
}

221 
	$g‘_add»ss_16
(
FPU_modrm
, *
åu_e
,

222 
åu_addr_modes
 
addr_modes
)

224 
mod
;

225 
off£t
 = 0;

227 #iâdeà
PECULIAR_486


229 
FPU_d©a_£ËùÜ
 = 
FPU_DS
;

234 
	#FPU_WRITE_BIT
 0x10

	)

235 iàĞ!
addr_modes
.
vm86
 && (
FPU_modrm
 & 
FPU_WRITE_BIT
)

236 && (
addr_modes
.
ov”ride
.
£gm’t
 =ğ
PREFIX_CS_
) )

238 
	`m©h_abÜt
(
FPU_šfo
,
SIGSEGV
);

241 
mod
 = (
FPU_modrm
 >> 6) & 3;

243 
mod
)

246 ià(
FPU_rm
 == 6)

249 
RE_ENTRANT_CHECK_OFF
;

250 
	`FPU_code_v”ify_¬—
(2);

251 
off£t
 = ()
	`g‘_fs_wÜd
((*è(*
åu_e
));

252 (*
åu_e
) += 2;

253 
RE_ENTRANT_CHECK_ON
;

254 
add_£gm’t
;

259 
RE_ENTRANT_CHECK_OFF
;

260 
	`FPU_code_v”ify_¬—
(1);

261 
off£t
 = (sigÃd è
	`g‘_fs_by‹
((sigÃd *è(*
åu_e
));

262 
RE_ENTRANT_CHECK_ON
;

263 (*
åu_e
)++;

267 
RE_ENTRANT_CHECK_OFF
;

268 
	`FPU_code_v”ify_¬—
(2);

269 
off£t
 = (è
	`g‘_fs_wÜd
((*è(*
åu_e
));

270 (*
åu_e
) += 2;

271 
RE_ENTRANT_CHECK_ON
;

275 
	`EXCEPTION
(
EX_Inv®id
);

278  
FPU_rm
 )

281 
off£t
 +ğ
FPU_šfo
->
___ebx
 + FPU_šfo->
___esi
;

284 
off£t
 +ğ
FPU_šfo
->
___ebx
 + FPU_šfo->
___edi
;

287 
off£t
 +ğ
FPU_šfo
->
___ebp
 + FPU_šfo->
___esi
;

290 
off£t
 +ğ
FPU_šfo
->
___ebp
 + FPU_šfo->
___edi
;

293 
off£t
 +ğ
FPU_šfo
->
___esi
;

296 
off£t
 +ğ
FPU_šfo
->
___edi
;

299 
off£t
 +ğ
FPU_šfo
->
___ebp
;

302 
off£t
 +ğ
FPU_šfo
->
___ebx
;

306 
add_£gm’t
:

307 
off£t
 &= 0xffff;

309 iàĞ
addr_modes
.
vm86
 )

311 
off£t
 +ğ
	`vm86_£gm’t
(
addr_modes
.
ov”ride
.
£gm’t
);

314 
FPU_d©a_add»ss
 = (*)
off£t
 ;

315 
	}
}

	@drivers/FPU-emu/load_store.c

21 
	~<asm/£gm’t.h
>

23 
	~"åu_sy¡em.h
"

24 
	~"exû±iÚ.h
"

25 
	~"åu_emu.h
"

26 
	~"¡©us_w.h
"

27 
	~"cÚŒŞ_w.h
"

30 
	#_NONE_
 0

	)

31 
	#_REG0_
 1

	)

32 
	#_PUSH_
 3

	)

33 
	#_nuÎ_
 4

	)

35 
	#pİ_0
(è{ 
pİ_±r
->
g
 = 
TW_Em±y
; 
tİ
++; }

	)

38 cÚ¡ 
	gty³_bË
[32] = {

39 
_PUSH_
, _PUSH_, _PUSH_, _PUSH_,

40 
_nuÎ_
, _null_, _null_, _null_,

41 
_REG0_
, _REG0_, _REG0_, _REG0_,

42 
_REG0_
, _REG0_, _REG0_, _REG0_,

43 
_NONE_
, 
_nuÎ_
, _NONE_, 
_PUSH_
,

44 
_NONE_
, 
_PUSH_
, 
_nuÎ_
, _PUSH_,

45 
_NONE_
, 
_nuÎ_
, _NONE_, 
_REG0_
,

46 
_NONE_
, 
_REG0_
, _NONE_, _REG0_

49 
	$lßd_¡Üe_š¡r
(
ty³
, 
åu_addr_modes
 
addr_modes
)

51 
FPU_REG
 *
pİ_±r
;

54 
pİ_±r
 = 
NULL
;

55  
ty³_bË
[(è(è
ty³
] )

57 
_NONE_
:

59 
_REG0_
:

60 
pİ_±r
 = &
	`¡
(0);

63 
FPU_¡0_±r
 = 
pİ_±r
;

64 
FPU_¡0_g
 = 
FPU_¡0_±r
->
g
;

66 
_PUSH_
:

68 
pİ_±r
 = &
	`¡
(-1);

69 iàĞ
pİ_±r
->
g
 !ğ
TW_Em±y
 )

70 { 
	`¡ack_ov”æow
(); ; }

71 
tİ
--;

74 
_nuÎ_
:

75 
	`FPU_Ëg®
();

77 #ifdeà
PARANOID


79 
	`EXCEPTION
(
EX_INTERNAL
);

84  
ty³
 )

87 
	`ş—r_C1
();

88 
	`»g_lßd_sšgË
();

89 iàĞ(
FPU_lßded_d©a
.
g
 =ğ
TW_NaN
) &&

90 
	`»®_2İ_NaN
(&
FPU_lßded_d©a
, &FPU_loaded_data, &FPU_loaded_data) )

92 
tİ
++;

95 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

98 
	`ş—r_C1
();

99 
	`»g_lßd_št32
();

100 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

103 
	`ş—r_C1
();

104 
	`»g_lßd_doubË
();

105 iàĞ(
FPU_lßded_d©a
.
g
 =ğ
TW_NaN
) &&

106 
	`»®_2İ_NaN
(&
FPU_lßded_d©a
, &FPU_loaded_data, &FPU_loaded_data) )

108 
tİ
++;

111 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

114 
	`ş—r_C1
();

115 
	`»g_lßd_št16
();

116 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

119 
	`ş—r_C1
();

120 
	`»g_¡Üe_sšgË
();

123 
	`ş—r_C1
();

124 
	`»g_¡Üe_št32
();

127 
	`ş—r_C1
();

128 
	`»g_¡Üe_doubË
();

131 
	`ş—r_C1
();

132 
	`»g_¡Üe_št16
();

135 
	`ş—r_C1
();

136 iàĞ
	`»g_¡Üe_sšgË
() )

137 
	`pİ_0
();

141 
	`ş—r_C1
();

142 iàĞ
	`»g_¡Üe_št32
() )

143 
	`pİ_0
();

147 
	`ş—r_C1
();

148 iàĞ
	`»g_¡Üe_doubË
() )

149 
	`pİ_0
();

153 
	`ş—r_C1
();

154 iàĞ
	`»g_¡Üe_št16
() )

155 
	`pİ_0
();

159 
	`æd’v
(
addr_modes
);

162 
	`ä¡Ü
(
addr_modes
);

165 
	`ş—r_C1
();

166 
	`»g_lßd_bcd
();

167 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

170 
RE_ENTRANT_CHECK_OFF
;

171 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
FPU_d©a_add»ss
, 2);

172 
cÚŒŞ_wÜd
 = 
	`g‘_fs_wÜd
((*è
FPU_d©a_add»ss
);

173 
RE_ENTRANT_CHECK_ON
;

174 iàĞ
·¹Ÿl_¡©us
 & ~
cÚŒŞ_wÜd
 & 
CW_Exû±iÚs
 )

175 
·¹Ÿl_¡©us
 |ğ(
SW_Summ¬y
 | 
SW_Backw¬d
);

177 
·¹Ÿl_¡©us
 &ğ~(
SW_Summ¬y
 | 
SW_Backw¬d
);

178 #ifdeà
PECULIAR_486


179 
cÚŒŞ_wÜd
 |= 0x40;

181 
NO_NET_DATA_EFFECT
;

182 
NO_NET_INSTR_EFFECT
;

185 
	`ş—r_C1
();

186 
	`»g_lßd_ex‹nded
();

187 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

190 
	`ş—r_C1
();

191 
	`»g_lßd_št64
();

192 
	`»g_move
(&
FPU_lßded_d©a
, 
pİ_±r
);

195 
	`f¡’v
(
addr_modes
);

196 
NO_NET_DATA_EFFECT
;

199 
	`f§ve
(
addr_modes
);

200 
NO_NET_DATA_EFFECT
;

203 
	`ş—r_C1
();

204 iàĞ
	`»g_¡Üe_bcd
() )

205 
	`pİ_0
();

209 
RE_ENTRANT_CHECK_OFF
;

210 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
FPU_d©a_add»ss
,2);

211 
	`put_fs_wÜd
(
cÚŒŞ_wÜd
, (*è
FPU_d©a_add»ss
);

212 
RE_ENTRANT_CHECK_ON
;

213 
NO_NET_DATA_EFFECT
;

214 
NO_NET_INSTR_EFFECT
;

217 
	`ş—r_C1
();

218 iàĞ
	`»g_¡Üe_ex‹nded
() )

219 
	`pİ_0
();

223 
RE_ENTRANT_CHECK_OFF
;

224 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
FPU_d©a_add»ss
,2);

225 
	`put_fs_wÜd
(
	`¡©us_wÜd
(),(*è
FPU_d©a_add»ss
);

226 
RE_ENTRANT_CHECK_ON
;

227 
NO_NET_DATA_EFFECT
;

228 
NO_NET_INSTR_EFFECT
;

231 
	`ş—r_C1
();

232 iàĞ
	`»g_¡Üe_št64
() )

233 
	`pİ_0
();

237 
	}
}

	@drivers/FPU-emu/poly_2xm1.c

13 
	~"exû±iÚ.h
"

14 
	~"»g_cÚ¡ªt.h
"

15 
	~"åu_emu.h
"

19 
	#HIPOWER
 13

	)

20 cÚ¡ 
	gÉ”ms
[
HIPOWER
][4] =

41 
	$pŞy_2xm1
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
)

43 
expÚ’t
;

44 
XÎ
;

45 
FPU_REG
 
accum
;

48 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

50 #ifdeà
PARANOID


51 iàĞ(
¬g
->
sign
 !ğ
SIGN_POS
)

52 || (
expÚ’t
 >= 0)

53 || (
¬g
->
g
 !ğ
TW_V®id
) )

56 
	`EXCEPTION
(
EX_INTERNAL
|0x127);

61 *(*)&
XÎ
 = 
¬g
->
sigl
;

62 *(((*)&
XÎ
)+1èğ
¬g
->
sigh
;

63 iàĞ
expÚ’t
 < -1 )

66 iàĞ
	`shrx
(&
XÎ
, -1-
expÚ’t
) >= 0x80000000U )

67 
XÎ
++;

70 *(*)&(
accum
.
sign
) = 0;

71 
accum
.
exp
 = 0;

74 
	`pŞynomŸl
((*)&
accum
.
sigl
, (*)&
XÎ
, 
É”ms
, 
HIPOWER
-1);

77 
accum
.
exp
 +ğ
EXP_BIAS
 - 1;

79 
	`»g_move
(&
accum
, 
»suÉ
);

81 
	`nÜm®ize
(
»suÉ
);

85 
	}
}

	@drivers/FPU-emu/poly_atan.c

13 
	~"exû±iÚ.h
"

14 
	~"»g_cÚ¡ªt.h
"

15 
	~"åu_emu.h
"

16 
	~"cÚŒŞ_w.h
"

19 
	#HIPOWERÚ
 6

	)

20 cÚ¡ 
	goddÃg‹rms
[
HIPOWERÚ
][2] =

30 
	#HIPOWERİ
 6

	)

31 cÚ¡ 
	godd¶‹rms
[
HIPOWERİ
][2] =

41 cÚ¡ 
	gd’om‹rm
 = 0xea2e6612fc4bd208LL;

47 
	$pŞy_©ª
(
FPU_REG
 *
¬g
)

49 
»cursiÚs
 = 0;

50 
expÚ’t
;

51 
FPU_REG
 
odd_pŞy
, 
ev’_pŞy
, 
pos_pŞy
, 
Ãg_pŞy
, 
¿tio
;

52 
FPU_REG
 
¬gSq
;

53 
¬g_signif
, 
¬gSqSq
;

56 #ifdeà
PARANOID


57 iàĞ
¬g
->
sign
 != 0 )

58 { 
	`¬™h_šv®id
(
¬g
); ; }

61 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

63 iàĞ
¬g
->
g
 =ğ
TW_Z”o
 )

66 
	`»g_move
(&
CONST_Z
, 
¬g
);

70 iàĞ
expÚ’t
 >= -2 )

73 iàĞ
expÚ’t
 >= 0 )

75 #ifdeà
PARANOID


76 iàĞ(
expÚ’t
 == 0) &&

77 (
¬g
->
sigl
 =ğ0è&& (¬g->
sigh
 == 0x80000000) )

80 
	`»g_move
(&
CONST_PI4
, 
¬g
);

83 #ifdeà
PARANOID


84 
	`EXCEPTION
(
EX_INTERNAL
|0x104);

91 iàĞ(
expÚ’t
 >ğ-1è|| (
¬g
->
sigh
 > 0xd413ccd0) )

93 
FPU_REG
 
num”©Ü
, 
d’om
;

95 
»cursiÚs
++;

97 
¬g_signif
 = 
	`signifiÿnd
(
¬g
);

98 iàĞ
expÚ’t
 < -1 )

100 iàĞ
	`shrx
(&
¬g_signif
, -1-
expÚ’t
) >= 0x80000000U )

101 
¬g_signif
++;

103 
	`signifiÿnd
(&
num”©Ü
èğ-
¬g_signif
;

104 
num”©Ü
.
exp
 = 
EXP_BIAS
 - 1;

105 
	`nÜm®ize
(&
num”©Ü
);

107 
¬g_signif
 = 
	`signifiÿnd
(
¬g
);

108 iàĞ
	`shrx
(&
¬g_signif
, -
expÚ’t
) >= 0x80000000U )

109 
¬g_signif
++;

110 
	`signifiÿnd
(&
d’om
èğ
¬g_signif
;

111 
d’om
.
sigh
 |= 0x80000000;

113 
¬g
->
exp
 = 
num”©Ü
.exp;

114 
	`»g_u_div
(&
num”©Ü
, &
d’om
, 
¬g
, 
FULL_PRECISION
);

116 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

120 
¬g_signif
 = 
	`signifiÿnd
(
¬g
);

122 #ifdeà
PARANOID


124 iàĞ
expÚ’t
 >= -1 )

126 
	`EXCEPTION
(
EX_INTERNAL
|0x120);

131 iàĞ
	`shrx
(&
¬g_signif
, -1-
expÚ’t
) >= 0x80000000U )

132 
¬g_signif
++;

136 
	`mul64
(&
¬g_signif
, &¬g_signif, &
	`signifiÿnd
(&
¬gSq
));

137 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
), &signifiÿnd(&¬gSq), &
¬gSqSq
);

140 *(*)&(
pos_pŞy
.
sign
) = 0;

141 
pos_pŞy
.
exp
 = 
EXP_BIAS
;

144 
	`pŞynomŸl
(&
pos_pŞy
.
sigl
, (*)&
¬gSqSq
,

145 ((*)[4])
odd¶‹rms
, 
HIPOWERİ
-1);

146 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
), &signifiÿnd(&
pos_pŞy
),

147 &
	`signifiÿnd
(&
pos_pŞy
));

150 *(*)&(
Ãg_pŞy
.
sign
) = 0;

151 
Ãg_pŞy
.
exp
 = 
EXP_BIAS
;

154 
	`pŞynomŸl
(&
Ãg_pŞy
.
sigl
, (*)&
¬gSqSq
,

155 ((*)[4])
oddÃg‹rms
, 
HIPOWERÚ
-1);

158 
	`signifiÿnd
(&
pos_pŞy
è-ğsignifiÿnd(&
Ãg_pŞy
);

160 
	`»g_move
(&
pos_pŞy
, &
odd_pŞy
);

161 
	`pŞy_add_1
(&
odd_pŞy
);

164 *(*)&(
ev’_pŞy
.
sign
) = 0;

166 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
), &
d’om‹rm
, &signifiÿnd(&
ev’_pŞy
));

168 
	`pŞy_add_1
(&
ev’_pŞy
);

170 
	`»g_div
(&
odd_pŞy
, &
ev’_pŞy
, &
¿tio
, 
FULL_PRECISION
);

172 
	`»g_u_mul
(&
¿tio
, 
¬g
,‡rg, 
FULL_PRECISION
);

174 iàĞ
»cursiÚs
 )

175 
	`»g_sub
(&
CONST_PI4
, 
¬g
,‡rg, 
FULL_PRECISION
);

177 
	}
}

184 
	$pŞy_add_1
(
FPU_REG
 *
¤c
)

190 #ifdeà
OBSOLETE


191 
round
 = (
¤c
->
sigl
 & 3) == 3;

194 
	`shrx
(&
¤c
->
sigl
, 1);

196 #ifdeà
OBSOLETE


197 iàĞ
round
 ) 
	`signifiÿnd
(
¤c
)++;

200 
¤c
->
sigh
 |= 0x80000000;

202 
¤c
->
exp
 = 
EXP_BIAS
;

204 
	}
}

	@drivers/FPU-emu/poly_l2.c

14 
	~"exû±iÚ.h
"

15 
	~"»g_cÚ¡ªt.h
"

16 
	~"åu_emu.h
"

17 
	~"cÚŒŞ_w.h
"

21 
	#HIPOWER
 9

	)

22 cÚ¡ 
	gÉ”ms
[
HIPOWER
][4] =

43 
	$pŞy_l2
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
)

45 
expÚ’t
;

46 
z”o
;

47 
b™s
, 
shiá
;

48 
Xsq
;

49 
FPU_REG
 
accum
, 
d’om
, 
num
, 
Xx
;

52 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

54 
accum
.
g
 = 
TW_V®id
;

56 iàĞ
¬g
->
sigh
 > ()0xb504f334 )

62 
expÚ’t
++;

63 
accum
.
sign
 = 1;

64 
num
.
exp
 = 
EXP_BIAS
;

65 
	`»g_u_div
(&
CONST_1
, 
¬g
, &
num
, 
FULL_PRECISION
);

69 
accum
.
sign
 = 0;

70 
num
.
sigl
 = 
¬g
->sigl;

71 
num
.
sigh
 = 
¬g
->sigh;

76 
num
.
sigh
 <<= 1;

77 iàĞ
num
.
sigl
 & 0x80000000 )‚um.
sigh
 |= 1;

78 
num
.
sigl
 <<= 1;

80 
d’om
.
sigl
 = 
num
.sigl;

81 
d’om
.
sigh
 = 
num
.sigh;

82 
	`pŞy_div4
(&
	`signifiÿnd
(&
d’om
));

83 
d’om
.
sigh
 += 0x80000000;

84 
Xx
.
exp
 = 
EXP_BIAS
;

85 
	`»g_u_div
(&
num
, &
d’om
, &
Xx
, 
FULL_PRECISION
);

87 
z”o
 = !(
Xx
.
sigh
 | Xx.
sigl
);

89 
	`mul64
(&
	`signifiÿnd
(&
Xx
), &signifiÿnd(&Xx), &
Xsq
);

90 
	`pŞy_div16
(&
Xsq
);

92 
accum
.
exp
 = -1;

95 
	`pŞynomŸl
((*)&
accum
.
sigl
, (*)&
Xsq
, 
É”ms
, 
HIPOWER
-1);

97 iàĞ!
expÚ’t
 )

102 
FPU_REG
 
lXx
;

103 
sign
;

105 
sign
 = 
accum
.sign;

106 
accum
.
sign
 = 0;

109 
accum
.
exp
 = 
EXP_BIAS
 +‡ccum.exp;

110 
	`nÜm®ize
(&
accum
);

112 iàĞ
z”o
 )

114 
	`»g_move
(&
CONST_Z
, 
»suÉ
);

119 
num
.
g
 = 
TW_V®id
;

120 
num
.
sign
 = 0;

121 
num
.
exp
 = 
EXP_BIAS
 - 1;

122 iàĞ
sign
 )

126 
	`signifiÿnd
(&
num
èğ- signifiÿnd(
¬g
);

127 
	`nÜm®ize
(&
num
);

128 
	`»g_div
(&
num
, 
¬g
, &num, 
FULL_PRECISION
);

132 
	`nÜm®ize
(&
num
);

135 
d’om
.
g
 = 
TW_V®id
;

136 
d’om
.
sign
 = 
SIGN_POS
;

137 
d’om
.
exp
 = 
EXP_BIAS
;

139 
	`»g_div
(&
num
, &
d’om
, &
lXx
, 
FULL_PRECISION
);

141 
	`»g_u_mul
(&
lXx
, &
accum
, &accum, 
FULL_PRECISION
);

143 
	`»g_u_add
(&
lXx
, &
accum
, 
»suÉ
, 
FULL_PRECISION
);

145 
	`nÜm®ize
(
»suÉ
);

148 
»suÉ
->
sign
 = sign;

152 
	`mul64
(&
	`signifiÿnd
(&
accum
),

153 &
	`signifiÿnd
(&
Xx
), &signifiÿnd(&
accum
));

155 
	`signifiÿnd
(&
accum
è+ğsignifiÿnd(&
Xx
);

157 iàĞ
Xx
.
sigh
 > 
accum
.sigh )

161 
	`pŞy_div2
(&
	`signifiÿnd
(&
accum
));

162 
accum
.
sigh
 |= 0x80000000;

163 
accum
.
exp
++;

169 iàĞ
expÚ’t
 && (ÓxpÚ’ˆ< 0è^ (
accum
.
sign
)) )

173 
accum
.
sign
 = !accum.sign;

176 iàĞ
accum
.
sigl
 |‡ccum.
sigh
 )

180 iàĞ
accum
.
exp
 < 0 )

182 
	`pŞy_div2
(&
	`signifiÿnd
(&
accum
));

183 
accum
.
exp
++;

186 
	`signifiÿnd
(&
accum
) = - significand(&accum);

187 iàĞ
expÚ’t
 < 0 )

188 
expÚ’t
++;

190 
expÚ’t
--;

194 
shiá
 = 
expÚ’t
 >= 0 ?ƒxponent : -exponent ;

195 
b™s
 = 0;

196 iàĞ
shiá
 )

198 iàĞ
accum
.
exp
 )

200 
accum
.
exp
++;

201 
	`pŞy_div2
(&
	`signifiÿnd
(&
accum
));

203  
shiá
 )

205 
	`pŞy_div2
(&
	`signifiÿnd
(&
accum
));

206 iàĞ
shiá
 & 1)

207 
accum
.
sigh
 |= 0x80000000;

208 
shiá
 >>= 1;

209 
b™s
++;

214 
accum
.
exp
 +ğ
b™s
 + 
EXP_BIAS
 - 1;

216 
	`»g_move
(&
accum
, 
»suÉ
);

217 
	`nÜm®ize
(
»suÉ
);

220 
	}
}

227 
	$pŞy_l2p1
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
)

229 
sign
 = 0;

230 
Xsq
;

231 
FPU_REG
 
¬g_¶1
, 
d’om
, 
accum
, 
loÿl_¬g
, 
pŞy_¬g
;

234 
sign
 = 
¬g
->sign;

236 
	`»g_add
(
¬g
, &
CONST_1
, &
¬g_¶1
, 
FULL_PRECISION
);

238 iàĞ(
¬g_¶1
.
sign
è| (¬g_¶1.
g
) )

243 
	`»g_add
(&
CONST_1
, &
¬g_¶1
, &
d’om
, 
FULL_PRECISION
);

244 
	`»g_div
(
¬g
, &
d’om
, &
loÿl_¬g
, 
FULL_PRECISION
);

245 
loÿl_¬g
.
sign
 = 0;

250 iàĞ
loÿl_¬g
.
exp
 >ğ
EXP_BIAS
 - 3 )

252 iàĞ(
loÿl_¬g
.
exp
 > 
EXP_BIAS
 - 3) ||

253 (
loÿl_¬g
.
sigh
 > ()0xafb0ccc0) )

256 
	`pŞy_l2
(&
¬g_¶1
, 
»suÉ
);  0;

261 
	`»g_move
(&
loÿl_¬g
, &
pŞy_¬g
);

264 
	`shrx
((*)&(
pŞy_¬g
.
sigl
), -ÕŞy_¬g.
exp
 - 
EXP_BIAS
 + 3));

266 
	`mul64
(&
	`signifiÿnd
(&
pŞy_¬g
), &signifiÿnd(&pŞy_¬g), &
Xsq
);

267 
	`pŞy_div16
(&
Xsq
);

270 
	`pŞynomŸl
(&(
accum
.
sigl
), (*)&
Xsq
, 
É”ms
, 
HIPOWER
-1);

272 
accum
.
g
 = 
TW_V®id
;

273 
accum
.
sign
 = 
SIGN_POS
;

276 
accum
.
exp
 = 
EXP_BIAS
 - 1;

277 
	`nÜm®ize
(&
accum
);

279 
	`»g_u_mul
(&
loÿl_¬g
, &
accum
, &accum, 
FULL_PRECISION
);

281 
	`»g_u_add
(&
loÿl_¬g
, &
accum
, 
»suÉ
, 
FULL_PRECISION
);

284 
»suÉ
->
exp
++;

286 
»suÉ
->
sign
 = sign;

289 
	}
}

	@drivers/FPU-emu/poly_sin.c

14 
	~"exû±iÚ.h
"

15 
	~"»g_cÚ¡ªt.h
"

16 
	~"åu_emu.h
"

17 
	~"cÚŒŞ_w.h
"

20 
	#HIPOWER
 5

	)

21 cÚ¡ 
	gÉ”ms
[
HIPOWER
][4] =

30 cÚ¡ 
	gÃg‹rms
[
HIPOWER
][4] =

43 
	$pŞy_sše
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
)

45 
expÚ’t
;

46 
FPU_REG
 
fixed_¬g
, 
¬g_sqrd
, 
¬g_to_4
, 
accum
, 
Ãgaccum
;

49 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

51 iàĞ
¬g
->
g
 =ğ
TW_Z”o
 )

54 
	`»g_move
(&
CONST_Z
, 
»suÉ
);

58 #ifdeà
PARANOID


59 iàĞ
¬g
->
sign
 != 0 )

61 
	`EXCEPTION
(
EX_Inv®id
);

62 
	`»g_move
(&
CONST_QNaN
, 
»suÉ
);

66 iàĞ
expÚ’t
 >= 0 )

68 iàĞ(
expÚ’t
 =ğ0è&& (
¬g
->
sigl
 =ğ0è&& (¬g->
sigh
 == 0x80000000) )

70 
	`»g_move
(&
CONST_1
, 
»suÉ
);

73 
	`EXCEPTION
(
EX_Inv®id
);

74 
	`»g_move
(&
CONST_QNaN
, 
»suÉ
);

79 
fixed_¬g
.
sigl
 = 
¬g
->sigl;

80 
fixed_¬g
.
sigh
 = 
¬g
->sigh;

81 iàĞ
expÚ’t
 < -1 )

84 iàĞ
	`shrx
(&(
fixed_¬g
.
sigl
), -1-
expÚ’t
) >= 0x80000000U )

85 
	`signifiÿnd
(&
fixed_¬g
)++;

88 
	`mul64
(&
	`signifiÿnd
(&
fixed_¬g
), &significand(&fixed_arg),

89 &
	`signifiÿnd
(&
¬g_sqrd
));

90 
	`mul64
(&
	`signifiÿnd
(&
¬g_sqrd
), &significand(&arg_sqrd),

91 &
	`signifiÿnd
(&
¬g_to_4
));

94 *(*)&(
accum
.
sign
) = 0;

95 
accum
.
exp
 = 0;

98 
	`pŞynomŸl
(&(
accum
.
sigl
), &(
¬g_to_4
.sigl), 
É”ms
, 
HIPOWER
-1);

101 *(*)&(
Ãgaccum
.
sign
) = 0;

102 
Ãgaccum
.
exp
 = 0;

105 
	`pŞynomŸl
(&(
Ãgaccum
.
sigl
), &(
¬g_to_4
.sigl), 
Ãg‹rms
, 
HIPOWER
-1);

106 
	`mul64
(&
	`signifiÿnd
(&
¬g_sqrd
), &signifiÿnd(&
Ãgaccum
),

107 &
	`signifiÿnd
(&
Ãgaccum
));

110 
	`signifiÿnd
(&
accum
è-ğsignifiÿnd(&
Ãgaccum
);

113 
accum
.
exp
 = 
EXP_BIAS
 - 1 +‡ccum.exp;

115 
	`»g_move
(&
accum
, 
»suÉ
);

117 
	`nÜm®ize
(
»suÉ
);

119 
	`»g_mul
(
»suÉ
, 
¬g
,„esuÉ, 
FULL_PRECISION
);

120 
	`»g_u_add
(
»suÉ
, 
¬g
,„esuÉ, 
FULL_PRECISION
);

122 iàĞ
»suÉ
->
exp
 >ğ
EXP_BIAS
 )

125 iàĞ(
»suÉ
->
exp
 > 
EXP_BIAS
)

126 || (
»suÉ
->
sigl
 > 1)

127 || (
»suÉ
->
sigh
 != 0x80000000)

130 #ifdeà
DEBUGGING


131 
RE_ENTRANT_CHECK_OFF
;

132 
	`´štk
("\nEXP=%d, MS=%08x, LS=%08x\n", 
»suÉ
->
exp
,

133 
»suÉ
->
sigh
,„esuÉ->
sigl
);

134 
RE_ENTRANT_CHECK_ON
;

136 
	`EXCEPTION
(
EX_INTERNAL
|0x103);

139 #ifdeà
DEBUGGING


140 
RE_ENTRANT_CHECK_OFF
;

141 
	`´štk
("\n***CORRECTING ILLEGAL RESULT*** in…oly_sin() computation\n");

142 
	`´štk
("EXP=%d, MS=%08x, LS=%08x\n", 
»suÉ
->
exp
,

143 
»suÉ
->
sigh
,„esuÉ->
sigl
);

144 
RE_ENTRANT_CHECK_ON
;

147 
»suÉ
->
sigl
 = 0;

150 
	}
}

	@drivers/FPU-emu/poly_tan.c

13 
	~"exû±iÚ.h
"

14 
	~"»g_cÚ¡ªt.h
"

15 
	~"åu_emu.h
"

16 
	~"cÚŒŞ_w.h
"

19 
	#HIPOWERİ
 3

	)

20 cÚ¡ 
	godd¶‹rms
[
HIPOWERİ
][4] =

27 
	#HIPOWERÚ
 2

	)

28 cÚ¡ 
	goddÃg‹rms
[
HIPOWERÚ
][4] =

34 
	#HIPOWER•
 2

	)

35 cÚ¡ 
	gev’¶‹rms
[
HIPOWER•
][4] =

41 
	#HIPOWER’
 2

	)

42 cÚ¡ 
	gev’Ãg‹rms
[
HIPOWER’
][4] =

52 
	$pŞy_n
(
FPU_REG
 cÚ¡ *
¬g
, FPU_REG *
»suÉ
, 
šv”t
)

54 
expÚ’t
;

55 
FPU_REG
 
odd_pŞy
, 
ev’_pŞy
, 
pos_pŞy
, 
Ãg_pŞy
;

56 
FPU_REG
 
¬gSq
;

57 
¬g_signif
, 
¬gSqSq
;

60 
expÚ’t
 = 
¬g
->
exp
 - 
EXP_BIAS
;

62 #ifdeà
PARANOID


63 iàĞ
¬g
->
sign
 != 0 )

64 { 
	`¬™h_šv®id
(
»suÉ
); ; }

67 
¬g_signif
 = 
	`signifiÿnd
(
¬g
);

68 iàĞ
expÚ’t
 < -1 )

71 iàĞ
	`shrx
(&
¬g_signif
, -1-
expÚ’t
) >= 0x80000000U )

72 
¬g_signif
++;

75 
	`mul64
(&
¬g_signif
, &¬g_signif, &
	`signifiÿnd
(&
¬gSq
));

76 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
), &signifiÿnd(&¬gSq), &
¬gSqSq
);

79 *(*)&(
pos_pŞy
.
sign
) = 0;

80 
pos_pŞy
.
exp
 = 
EXP_BIAS
;

83 
	`pŞynomŸl
(&
pos_pŞy
.
sigl
, (*)&
¬gSqSq
, 
odd¶‹rms
, 
HIPOWERİ
-1);

86 *(*)&(
Ãg_pŞy
.
sign
) = 0;

87 
Ãg_pŞy
.
exp
 = 
EXP_BIAS
;

90 
	`pŞynomŸl
(&
Ãg_pŞy
.
sigl
, (*)&
¬gSqSq
, 
oddÃg‹rms
, 
HIPOWERÚ
-1);

91 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
), &signifiÿnd(&
Ãg_pŞy
),

92 &
	`signifiÿnd
(&
Ãg_pŞy
));

95 
	`signifiÿnd
(&
pos_pŞy
è-ğsignifiÿnd(&
Ãg_pŞy
);

98 
pos_pŞy
.
exp
 -= 1;

100 
	`»g_move
(&
pos_pŞy
, &
odd_pŞy
);

101 
	`nÜm®ize
(&
odd_pŞy
);

103 
	`»g_mul
(&
odd_pŞy
, 
¬g
, &odd_pŞy, 
FULL_PRECISION
);

105 
	`»g_u_add
(&
odd_pŞy
, 
¬g
, &odd_pŞy, 
FULL_PRECISION
);

108 *(*)&(
pos_pŞy
.
sign
) = 0;

109 
pos_pŞy
.
exp
 = 
EXP_BIAS
;

112 
	`pŞynomŸl
(&
pos_pŞy
.
sigl
, (*)&
¬gSqSq
, 
ev’¶‹rms
, 
HIPOWER•
-1);

113 
	`mul64
(&
	`signifiÿnd
(&
¬gSq
),

114 &
	`signifiÿnd
(&
pos_pŞy
), &significand(&pos_poly));

117 *(*)&(
Ãg_pŞy
.
sign
) = 0;

118 
Ãg_pŞy
.
exp
 = 
EXP_BIAS
;

121 
	`pŞynomŸl
(&
Ãg_pŞy
.
sigl
, (*)&
¬gSqSq
, 
ev’Ãg‹rms
, 
HIPOWER’
-1);

124 
	`signifiÿnd
(&
Ãg_pŞy
è-ğsignifiÿnd(&
pos_pŞy
);

128 *(*)&(
¬gSq
.
sign
) = 0;

129 
¬gSq
.
exp
 = 
EXP_BIAS
 - 1;

130 
	`nÜm®ize
(&
¬gSq
);

133 
Ãg_pŞy
.
exp
 -= 1;

135 
	`»g_move
(&
Ãg_pŞy
, &
ev’_pŞy
);

136 
	`nÜm®ize
(&
ev’_pŞy
);

138 
	`»g_mul
(&
ev’_pŞy
, &
¬gSq
, &ev’_pŞy, 
FULL_PRECISION
);

139 
	`»g_add
(&
ev’_pŞy
, &
¬gSq
, &ev’_pŞy, 
FULL_PRECISION
);

141 
	`»g_sub
(&
CONST_1
, &
ev’_pŞy
, &ev’_pŞy, 
FULL_PRECISION
);

144 iàĞ
šv”t
 )

145 { 
	`»g_div
(&
ev’_pŞy
, &
odd_pŞy
, 
»suÉ
, 
FULL_PRECISION
); }

147 { 
	`»g_div
(&
odd_pŞy
, &
ev’_pŞy
, 
»suÉ
, 
FULL_PRECISION
); }

149 
	}
}

	@drivers/FPU-emu/reg_add_sub.c

18 
	~"exû±iÚ.h
"

19 
	~"»g_cÚ¡ªt.h
"

20 
	~"åu_emu.h
"

21 
	~"cÚŒŞ_w.h
"

22 
	~"åu_sy¡em.h
"

25 
	$»g_add
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
, FPU_REG *
de¡
, 
cÚŒŞ_w
)

27 
§ved_sign
 = 
de¡
->
sign
;

28 
diff
;

30 iàĞ!(
a
->
g
 | 
b
->tag) )

33 ià(!(
a
->
sign
 ^ 
b
->sign))

36 
de¡
->
sign
 = 
a
->sign;

37 iàĞ
	`»g_u_add
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

39 
de¡
->
sign
 = 
§ved_sign
;

46 
diff
 = 
a
->
exp
 - 
b
->exp;

47 ià(!
diff
)

49 
diff
 = 
a
->
sigh
 - 
b
->sigh;

50 ià(!
diff
)

52 
diff
 = 
a
->
sigl
 > 
b
->sigl;

53 ià(!
diff
)

54 
diff
 = -(
a
->
sigl
 < 
b
->sigl);

58 ià(
diff
 > 0)

60 
de¡
->
sign
 = 
a
->sign;

61 iàĞ
	`»g_u_sub
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

63 
de¡
->
sign
 = 
§ved_sign
;

67 iàĞ
diff
 == 0 )

69 #ifdeà
DENORM_OPERAND


70 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

71 
	`d’Üm®_İ”ªd
() )

74 
	`»g_move
(&
CONST_Z
, 
de¡
);

76 
de¡
->
sign
 = ((
cÚŒŞ_w
 & 
CW_RC
è!ğ
RC_DOWN
)

77 ? 
SIGN_POS
 : 
SIGN_NEG
;

81 
de¡
->
sign
 = 
b
->sign;

82 iàĞ
	`»g_u_sub
(
b
, 
a
, 
de¡
, 
cÚŒŞ_w
) )

84 
de¡
->
sign
 = 
§ved_sign
;

92 iàĞ(
a
->
g
 =ğ
TW_NaN
è|| (
b
->tag == TW_NaN) )

93 {  
	`»®_2İ_NaN
(
a
, 
b
, 
de¡
); }

94 ià(
a
->
g
 =ğ
TW_Z”o
)

96 ià(
b
->
g
 =ğ
TW_Z”o
)

98 
difã»Á_signs
 = 
a
->
sign
 ^ 
b
->sign;

100 
	`»g_move
(
a
, 
de¡
);

101 ià(
difã»Á_signs
)

105 
de¡
->
sign
 = ((
cÚŒŞ_w
 & 
CW_RC
è!ğ
RC_DOWN
)

106 ? 
SIGN_POS
 : 
SIGN_NEG
;

111 #ifdeà
DENORM_OPERAND


112 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

113 
	`d’Üm®_İ”ªd
() )

116 
	`»g_move
(
b
, 
de¡
);

120 ià(
b
->
g
 =ğ
TW_Z”o
)

122 #ifdeà
DENORM_OPERAND


123 iàĞ(
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
) &&

124 
	`d’Üm®_İ”ªd
() )

127 
	`»g_move
(
a
, 
de¡
);  0;

129 ià(
a
->
g
 =ğ
TW_Infš™y
)

131 ià(
b
->
g
 !ğ
TW_Infš™y
)

133 #ifdeà
DENORM_OPERAND


134 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

135 
	`d’Üm®_İ”ªd
() )

138 
	`»g_move
(
a
, 
de¡
);  0;

140 ià(
a
->
sign
 =ğ
b
->sign)

143 
	`»g_move
(
a
, 
de¡
);  0;

145  
	`¬™h_šv®id
(
de¡
);

147 ià(
b
->
g
 =ğ
TW_Infš™y
)

149 #ifdeà
DENORM_OPERAND


150 iàĞ(
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
) &&

151 
	`d’Üm®_İ”ªd
() )

154 
	`»g_move
(
b
, 
de¡
);  0;

157 #ifdeà
PARANOID


158 
	`EXCEPTION
(
EX_INTERNAL
|0x101);

161 
	}
}

165 
	$»g_sub
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
, FPU_REG *
de¡
, 
cÚŒŞ_w
)

167 
§ved_sign
 = 
de¡
->
sign
;

168 
diff
;

170 iàĞ!(
a
->
g
 | 
b
->tag) )

173 
diff
 = 
a
->
exp
 - 
b
->exp;

174 ià(!
diff
)

176 
diff
 = 
a
->
sigh
 - 
b
->sigh;

177 ià(!
diff
)

179 
diff
 = 
a
->
sigl
 > 
b
->sigl;

180 ià(!
diff
)

181 
diff
 = -(
a
->
sigl
 < 
b
->sigl);

185 
a
->
sign
*2 + 
b
->sign)

189 ià(
diff
 > 0)

192 
de¡
->
sign
 = 
a
->sign;

193 iàĞ
	`»g_u_sub
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

195 
de¡
->
sign
 = 
§ved_sign
;

200 iàĞ
diff
 == 0 )

202 #ifdeà
DENORM_OPERAND


203 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

204 
	`d’Üm®_İ”ªd
() )

207 
	`»g_move
(&
CONST_Z
, 
de¡
);

209 
de¡
->
sign
 = ((
cÚŒŞ_w
 & 
CW_RC
è!ğ
RC_DOWN
)

210 ? 
SIGN_POS
 : 
SIGN_NEG
;

214 
de¡
->
sign
 = 
a
->sigÀ^ 
SIGN_POS
^
SIGN_NEG
;

215 iàĞ
	`»g_u_sub
(
b
, 
a
, 
de¡
, 
cÚŒŞ_w
) )

217 
de¡
->
sign
 = 
§ved_sign
;

223 
de¡
->
sign
 = 
SIGN_POS
;

224 iàĞ
	`»g_u_add
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

226 
de¡
->
sign
 = 
§ved_sign
;

231 
de¡
->
sign
 = 
SIGN_NEG
;

232 iàĞ
	`»g_u_add
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

234 
de¡
->
sign
 = 
§ved_sign
;

243 iàĞ(
a
->
g
 =ğ
TW_NaN
è|| (
b
->tag == TW_NaN) )

244 {  
	`»®_2İ_NaN
(
b
, 
a
, 
de¡
); }

245 ià(
b
->
g
 =ğ
TW_Z”o
)

247 ià(
a
->
g
 =ğ
TW_Z”o
)

249 
§me_signs
 = !(
a
->
sign
 ^ 
b
->sign);

251 
	`»g_move
(
a
, 
de¡
);

252 ià(
§me_signs
)

255 
de¡
->
sign
 = ((
cÚŒŞ_w
 & 
CW_RC
è!ğ
RC_DOWN
)

256 ? 
SIGN_POS
 : 
SIGN_NEG
;

261 #ifdeà
DENORM_OPERAND


262 iàĞ(
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
) &&

263 
	`d’Üm®_İ”ªd
() )

266 
	`»g_move
(
a
, 
de¡
);

270 ià(
a
->
g
 =ğ
TW_Z”o
)

272 #ifdeà
DENORM_OPERAND


273 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

274 
	`d’Üm®_İ”ªd
() )

277 
	`»g_move
(
b
, 
de¡
);

278 
de¡
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

281 ià(
a
->
g
 =ğ
TW_Infš™y
)

283 ià(
b
->
g
 !ğ
TW_Infš™y
)

285 #ifdeà
DENORM_OPERAND


286 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

287 
	`d’Üm®_İ”ªd
() )

290 
	`»g_move
(
a
, 
de¡
);  0;

293 ià(
a
->
sign
 =ğ
b
->sign)

296  
	`¬™h_šv®id
(
de¡
);

298 
	`»g_move
(
a
, 
de¡
);

301 ià(
b
->
g
 =ğ
TW_Infš™y
)

303 #ifdeà
DENORM_OPERAND


304 iàĞ(
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
) &&

305 
	`d’Üm®_İ”ªd
() )

308 
	`»g_move
(
b
, 
de¡
);

309 
de¡
->
sign
 ^ğ
SIGN_POS
^
SIGN_NEG
;

313 #ifdeà
PARANOID


314 
	`EXCEPTION
(
EX_INTERNAL
|0x110);

317 
	}
}

	@drivers/FPU-emu/reg_compare.c

17 
	~"åu_sy¡em.h
"

18 
	~"exû±iÚ.h
"

19 
	~"åu_emu.h
"

20 
	~"cÚŒŞ_w.h
"

21 
	~"¡©us_w.h
"

24 
	$com·»
(
FPU_REG
 cÚ¡ *
b
)

26 
diff
;

28 iàĞ
FPU_¡0_±r
->
g
 | 
b
->tag )

30 iàĞ
FPU_¡0_±r
->
g
 =ğ
TW_Z”o
 )

32 iàĞ
b
->
g
 =ğ
TW_Z”o
 )  
COMP_A_eq_B
;

33 iàĞ
b
->
g
 =ğ
TW_V®id
 )

35  ((
b
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_É_B
 : 
COMP_A_gt_B
)

36 #ifdeà
DENORM_OPERAND


37 | ((
b
->
exp
 <ğ
EXP_UNDER
) ?

38 
COMP_D’Üm®
 : 0)

43 iàĞ
b
->
g
 =ğ
TW_Z”o
 )

45 iàĞ
FPU_¡0_±r
->
g
 =ğ
TW_V®id
 )

47  ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_gt_B


48 : 
COMP_A_É_B
)

49 #ifdeà
DENORM_OPERAND


50 | ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

51 ? 
COMP_D’Üm®
 : 0 )

57 iàĞ
FPU_¡0_±r
->
g
 =ğ
TW_Infš™y
 )

59 iàĞ(
b
->
g
 =ğ
TW_V®id
è|| (b->g =ğ
TW_Z”o
) )

61  ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_gt_B


62 : 
COMP_A_É_B
)

63 #ifdeà
DENORM_OPERAND


64 | (((
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
)) ?

65 
COMP_D’Üm®
 : 0 )

69 iàĞ
b
->
g
 =ğ
TW_Infš™y
 )

72  (
FPU_¡0_±r
->
sign
 =ğ
b
->signè? 
COMP_A_eq_B
 :

73 ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_gt_B
 : 
COMP_A_É_B
);

77 iàĞ
b
->
g
 =ğ
TW_Infš™y
 )

79 iàĞ(
FPU_¡0_±r
->
g
 =ğ
TW_V®id
è|| (FPU_¡0_±r->g =ğ
TW_Z”o
) )

81  ((
b
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_É_B
 : 
COMP_A_gt_B
)

82 #ifdeà
DENORM_OPERAND


83 | (((
FPU_¡0_±r
->
g
 =ğ
TW_V®id
)

84 && (
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
)) ?

85 
COMP_D’Üm®
 : 0)

94 iàĞ(
FPU_¡0_±r
->
g
 =ğ
TW_NaN
è|| (
b
->tag == TW_NaN) )

96 iàĞ((
FPU_¡0_±r
->
g
 =ğ
TW_NaN
è&& !(FPU_¡0_±r->
sigh
 & 0x40000000))

97 || ((
b
->
g
 =ğ
TW_NaN
è&& !(b->
sigh
 & 0x40000000)) )

99  
COMP_No_Comp
 | 
COMP_SNaN
 | 
COMP_NaN
;

102  
COMP_No_Comp
 | 
COMP_NaN
;

105 
	`EXCEPTION
(
EX_Inv®id
);

108 #ifdeà
PARANOID


109 ià(!(
FPU_¡0_±r
->
sigh
 & 0x80000000)è
	`EXCEPTION
(
EX_Inv®id
);

110 ià(!(
b
->
sigh
 & 0x80000000)è
	`EXCEPTION
(
EX_Inv®id
);

114 ià(
FPU_¡0_±r
->
sign
 !ğ
b
->sign)

116  ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_gt_B
 : 
COMP_A_É_B
)

117 #ifdeà
DENORM_OPERAND


119 Ğ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è|| (
b
->exp <= EXP_UNDER)) ?

120 
COMP_D’Üm®
 : 0)

125 
diff
 = 
FPU_¡0_±r
->
exp
 - 
b
->exp;

126 iàĞ
diff
 == 0 )

128 
diff
 = 
FPU_¡0_±r
->
sigh
 - 
b
->sigh;

130 iàĞ
diff
 == 0 )

132 
diff
 = 
FPU_¡0_±r
->
sigl
 > 
b
->sigl;

133 iàĞ
diff
 == 0 )

134 
diff
 = -(
FPU_¡0_±r
->
sigl
 < 
b
->sigl);

138 iàĞ
diff
 > 0 )

140  ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_gt_B
 : 
COMP_A_É_B
)

141 #ifdeà
DENORM_OPERAND


143 Ğ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è|| (
b
->exp <= EXP_UNDER)) ?

144 
COMP_D’Üm®
 : 0)

148 iàĞ
diff
 < 0 )

150  ((
FPU_¡0_±r
->
sign
 =ğ
SIGN_POS
è? 
COMP_A_É_B
 : 
COMP_A_gt_B
)

151 #ifdeà
DENORM_OPERAND


153 Ğ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è|| (
b
->exp <= EXP_UNDER)) ?

154 
COMP_D’Üm®
 : 0)

159  
COMP_A_eq_B


160 #ifdeà
DENORM_OPERAND


162 Ğ((
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
è|| (
b
->exp <= EXP_UNDER)) ?

163 
COMP_D’Üm®
 : 0)

167 
	}
}

171 
	$com·»_¡_d©a
()

173 
f
, 
c
;

175 
c
 = 
	`com·»
(&
FPU_lßded_d©a
);

177 ià(
c
 & 
COMP_NaN
)

179 
	`EXCEPTION
(
EX_Inv®id
);

180 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

183 
c
 & 7)

185 
COMP_A_É_B
:

186 
f
 = 
SW_C0
;

188 
COMP_A_eq_B
:

189 
f
 = 
SW_C3
;

191 
COMP_A_gt_B
:

192 
f
 = 0;

194 
COMP_No_Comp
:

195 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

197 #ifdeà
PARANOID


199 
	`EXCEPTION
(
EX_INTERNAL
|0x121);

200 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

204 
	`£tcc
(
f
);

205 ià(
c
 & 
COMP_D’Üm®
)

207  
	`d’Üm®_İ”ªd
();

210 
	}
}

213 
	$com·»_¡_¡
(
Ä
)

215 
f
, 
c
;

217 iàĞ!
NOT_EMPTY_0
 || !
	`NOT_EMPTY
(
Ä
) )

219 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

221 
	`EXCEPTION
(
EX_SckUnd”
);

222  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

225 
c
 = 
	`com·»
(&
	`¡
(
Ä
));

226 ià(
c
 & 
COMP_NaN
)

228 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

229 
	`EXCEPTION
(
EX_Inv®id
);

230  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

233 
c
 & 7)

235 
COMP_A_É_B
:

236 
f
 = 
SW_C0
;

238 
COMP_A_eq_B
:

239 
f
 = 
SW_C3
;

241 
COMP_A_gt_B
:

242 
f
 = 0;

244 
COMP_No_Comp
:

245 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

247 #ifdeà
PARANOID


249 
	`EXCEPTION
(
EX_INTERNAL
|0x122);

250 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

254 
	`£tcc
(
f
);

255 ià(
c
 & 
COMP_D’Üm®
)

257  
	`d’Üm®_İ”ªd
();

260 
	}
}

263 
	$com·»_u_¡_¡
(
Ä
)

265 
f
, 
c
;

267 iàĞ!
NOT_EMPTY_0
 || !
	`NOT_EMPTY
(
Ä
) )

269 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

271 
	`EXCEPTION
(
EX_SckUnd”
);

272  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

275 
c
 = 
	`com·»
(&
	`¡
(
Ä
));

276 ià(
c
 & 
COMP_NaN
)

278 
	`£tcc
(
SW_C3
 | 
SW_C2
 | 
SW_C0
);

279 ià(
c
 & 
COMP_SNaN
)

282 
	`EXCEPTION
(
EX_Inv®id
);

283  !(
cÚŒŞ_wÜd
 & 
CW_Inv®id
);

288 
c
 & 7)

290 
COMP_A_É_B
:

291 
f
 = 
SW_C0
;

293 
COMP_A_eq_B
:

294 
f
 = 
SW_C3
;

296 
COMP_A_gt_B
:

297 
f
 = 0;

299 
COMP_No_Comp
:

300 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

302 #ifdeà
PARANOID


304 
	`EXCEPTION
(
EX_INTERNAL
|0x123);

305 
f
 = 
SW_C3
 | 
SW_C2
 | 
SW_C0
;

309 
	`£tcc
(
f
);

310 ià(
c
 & 
COMP_D’Üm®
)

312  
	`d’Üm®_İ”ªd
();

315 
	}
}

319 
	$fcom_¡
()

322 
	`com·»_¡_¡
(
FPU_rm
);

323 
	}
}

326 
	$fcomp¡
()

329 iàĞ!
	`com·»_¡_¡
(
FPU_rm
) )

330 
	`pİ
();

331 
	}
}

334 
	$fcomµ
()

337 ià(
FPU_rm
 != 1)

339 
	`FPU_Ëg®
();

342 iàĞ!
	`com·»_¡_¡
(1) )

344 
	`pİ
(); 
FPU_¡0_±r
 = &
	`¡
(0);

345 
	`pİ
();

347 
	}
}

350 
	$fucom_
()

353 
	`com·»_u_¡_¡
(
FPU_rm
);

355 
	}
}

358 
	$fucomp
()

361 iàĞ!
	`com·»_u_¡_¡
(
FPU_rm
) )

362 
	`pİ
();

363 
	}
}

366 
	$fucomµ
()

369 ià(
FPU_rm
 == 1)

371 iàĞ!
	`com·»_u_¡_¡
(1) )

373 
	`pİ
(); 
FPU_¡0_±r
 = &
	`¡
(0);

374 
	`pİ
();

378 
	`FPU_Ëg®
();

379 
	}
}

	@drivers/FPU-emu/reg_constant.c

13 
	~"åu_sy¡em.h
"

14 
	~"åu_emu.h
"

15 
	~"¡©us_w.h
"

16 
	~"»g_cÚ¡ªt.h
"

19 
FPU_REG
 cÚ¡ 
	gCONST_1
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
,

21 
FPU_REG
 cÚ¡ 
	gCONST_2
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
+1,

23 
FPU_REG
 cÚ¡ 
	gCONST_HALF
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
-1,

25 
FPU_REG
 cÚ¡ 
	gCONST_L2T
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
+1,

27 
FPU_REG
 cÚ¡ 
	gCONST_L2E
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
,

29 
FPU_REG
 cÚ¡ 
	gCONST_PI
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
+1,

31 
FPU_REG
 cÚ¡ 
	gCONST_PI2
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
,

33 
FPU_REG
 cÚ¡ 
	gCONST_PI4
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
-1,

35 
FPU_REG
 cÚ¡ 
	gCONST_LG2
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
-2,

37 
FPU_REG
 cÚ¡ 
	gCONST_LN2
 = { 
SIGN_POS
, 
TW_V®id
, 
EXP_BIAS
-1,

41 
FPU_REG
 cÚ¡ 
	gCONST_PI2exŒa
 = { 
SIGN_NEG
, 
TW_V®id
, 
EXP_BIAS
-66,

45 
FPU_REG
 cÚ¡ 
	gCONST_Z
 = { 
SIGN_POS
, 
TW_Z”o
, 
EXP_UNDER
, 0x0, 0x0 };

52 
FPU_REG
 cÚ¡ 
	gCONST_QNaN
 = { 
SIGN_NEG
, 
TW_NaN
, 
EXP_OVER
, 0x00000000, 0xC0000000 };

55 
FPU_REG
 cÚ¡ 
	gCONST_INF
 = { 
SIGN_POS
, 
TW_Infš™y
, 
EXP_OVER
, 0x00000000, 0x80000000 };

59 
	$æd_cÚ¡
(
FPU_REG
 cÚ¡ *
c
)

61 
FPU_REG
 *
¡_Ãw_±r
;

63 iàĞ
STACK_OVERFLOW
 )

65 
	`¡ack_ov”æow
();

68 
	`push
();

69 
	`»g_move
(
c
, 
FPU_¡0_±r
);

70 
	`ş—r_C1
();

71 
	}
}

74 
	$æd1
()

76 
	`æd_cÚ¡
(&
CONST_1
);

77 
	}
}

79 
	$ædl2t
()

81 
	`æd_cÚ¡
(&
CONST_L2T
);

82 
	}
}

84 
	$ædl2e
()

86 
	`æd_cÚ¡
(&
CONST_L2E
);

87 
	}
}

89 
	$ædpi
()

91 
	`æd_cÚ¡
(&
CONST_PI
);

92 
	}
}

94 
	$ædlg2
()

96 
	`æd_cÚ¡
(&
CONST_LG2
);

97 
	}
}

99 
	$ædÊ2
()

101 
	`æd_cÚ¡
(&
CONST_LN2
);

102 
	}
}

104 
	$ædz
()

106 
	`æd_cÚ¡
(&
CONST_Z
);

107 
	}
}

109 
FUNC
 
	gcÚ¡ªts_bË
[] = {

110 
æd1
, 
ædl2t
, 
ædl2e
, 
ædpi
, 
ædlg2
, 
ædÊ2
, 
ædz
, 
FPU_Ëg®


113 
	$fcÚ¡
()

115 (
cÚ¡ªts_bË
[
FPU_rm
])();

116 
	}
}

	@drivers/FPU-emu/reg_constant.h

9 #iâdeà
_REG_CONSTANT_H_


10 
	#_REG_CONSTANT_H_


	)

12 
	~"åu_emu.h
"

14 
FPU_REG
 cÚ¡ 
CONST_1
;

15 
FPU_REG
 cÚ¡ 
CONST_2
;

16 
FPU_REG
 cÚ¡ 
CONST_HALF
;

17 
FPU_REG
 cÚ¡ 
CONST_L2T
;

18 
FPU_REG
 cÚ¡ 
CONST_L2E
;

19 
FPU_REG
 cÚ¡ 
CONST_PI
;

20 
FPU_REG
 cÚ¡ 
CONST_PI2
;

21 
FPU_REG
 cÚ¡ 
CONST_PI2exŒa
;

22 
FPU_REG
 cÚ¡ 
CONST_PI4
;

23 
FPU_REG
 cÚ¡ 
CONST_LG2
;

24 
FPU_REG
 cÚ¡ 
CONST_LN2
;

25 
FPU_REG
 cÚ¡ 
CONST_Z
;

26 
FPU_REG
 cÚ¡ 
CONST_PINF
;

27 
FPU_REG
 cÚ¡ 
CONST_INF
;

28 
FPU_REG
 cÚ¡ 
CONST_MINF
;

29 
FPU_REG
 cÚ¡ 
CONST_QNaN
;

	@drivers/FPU-emu/reg_ld_str.c

20 
	~<asm/£gm’t.h
>

22 
	~"åu_sy¡em.h
"

23 
	~"exû±iÚ.h
"

24 
	~"»g_cÚ¡ªt.h
"

25 
	~"åu_emu.h
"

26 
	~"cÚŒŞ_w.h
"

27 
	~"¡©us_w.h
"

30 
	#EXTENDED_EbŸs
 0x3fff

	)

31 
	#EXTENDED_Emš
 (-0x3fãè

	)

33 
	#DOUBLE_Emax
 1023

	)

34 
	#DOUBLE_EbŸs
 1023

	)

35 
	#DOUBLE_Emš
 (-1022è

	)

37 
	#SINGLE_Emax
 127

	)

38 
	#SINGLE_EbŸs
 127

	)

39 
	#SINGLE_Emš
 (-126è

	)

41 
wr™e_to_ex‹nded
(
FPU_REG
 *
½
, *
d
);

43 
FPU_REG
 
	gFPU_lßded_d©a
;

47 
	$»g_lßd_ex‹nded
()

49 *
s
 = (*)
FPU_d©a_add»ss
;

50 
sigl
, 
sigh
, 
exp
;

52 
RE_ENTRANT_CHECK_OFF
;

53 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
s
, 10);

56 
sigl
 = 
	`g‘_fs_lÚg
((*è
s
);

57 
sigh
 = 
	`g‘_fs_lÚg
(1 + (*è
s
);

58 
exp
 = 
	`g‘_fs_wÜd
(4 + (*è
s
);

59 
RE_ENTRANT_CHECK_ON
;

61 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

62 
FPU_lßded_d©a
.
sigl
 = sigl;

63 
FPU_lßded_d©a
.
sigh
 = sigh;

64 ià(
exp
 & 0x8000)

65 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

67 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

68 
exp
 &= 0x7fff;

69 
FPU_lßded_d©a
.
exp
 =ƒx°- 
EXTENDED_EbŸs
 + 
EXP_BIAS
;

74 iàĞ
exp
 == 0 )

76 iàĞ!(
sigh
 | 
sigl
) )

78 
FPU_lßded_d©a
.
g
 = 
TW_Z”o
;

82 ià(
sigh
 & 0x80000000)

88 
FPU_lßded_d©a
.
exp
++;

95 
FPU_lßded_d©a
.
exp
++;

96 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

100 iàĞ
exp
 == 0x7fff )

102 iàĞ!((
sigh
 ^ 0x80000000è| 
sigl
) )

105 
FPU_lßded_d©a
.
exp
 = 
EXP_Infš™y
;

106 
FPU_lßded_d©a
.
g
 = 
TW_Infš™y
;

110 
FPU_lßded_d©a
.
exp
 = 
EXP_NaN
;

111 
FPU_lßded_d©a
.
g
 = 
TW_NaN
;

112 iàĞ!(
sigh
 & 0x80000000) )

119 
FPU_lßded_d©a
.
sigh
 = 0x80000000;

120 
FPU_lßded_d©a
.
sigl
 = 0x00000001;

121 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

127 iàĞ!(
sigh
 & 0x80000000) )

136 
FPU_lßded_d©a
.
sigh
 = 0x80000000;

137 
FPU_lßded_d©a
.
sigl
 = 0x00000001;

138 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

139 
FPU_lßded_d©a
.
exp
 = 
EXP_NaN
;

140 
FPU_lßded_d©a
.
g
 = 
TW_NaN
;

144 
	}
}

148 
	$»g_lßd_doubË
()

150 *
dæßt
 = (*)
FPU_d©a_add»ss
;

151 
exp
;

152 
m64
, 
l64
;

154 
RE_ENTRANT_CHECK_OFF
;

155 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
dæßt
, 8);

156 
m64
 = 
	`g‘_fs_lÚg
(1 + (*è
dæßt
);

157 
l64
 = 
	`g‘_fs_lÚg
((*è
dæßt
);

158 
RE_ENTRANT_CHECK_ON
;

160 ià(
m64
 & 0x80000000)

161 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

163 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

164 
exp
 = ((
m64
 & 0x7ff00000è>> 20è- 
DOUBLE_EbŸs
;

165 
m64
 &= 0xfffff;

166 ià(
exp
 > 
DOUBLE_Emax
)

169 ià((
m64
 =ğ0è&& (
l64
 == 0))

172 
FPU_lßded_d©a
.
sigh
 = 0x80000000;

173 
FPU_lßded_d©a
.
sigl
 = 0x00000000;

174 
FPU_lßded_d©a
.
exp
 = 
EXP_Infš™y
;

175 
FPU_lßded_d©a
.
g
 = 
TW_Infš™y
;

181 
FPU_lßded_d©a
.
exp
 = 
EXP_NaN
;

182 
FPU_lßded_d©a
.
g
 = 
TW_NaN
;

183 
FPU_lßded_d©a
.
sigh
 = (
m64
 << 11) | 0x80000000;

184 
FPU_lßded_d©a
.
sigh
 |ğ
l64
 >> 21;

185 
FPU_lßded_d©a
.
sigl
 = 
l64
 << 11;

189 iàĞ
exp
 < 
DOUBLE_Emš
 )

192 ià((
m64
 =ğ0è&& (
l64
 == 0))

195 
c
 = 
FPU_lßded_d©a
.
sign
;

196 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
);

197 
FPU_lßded_d©a
.
sign
 = 
c
;

203 
FPU_lßded_d©a
.
exp
 = 
DOUBLE_Emš
 + 
EXP_BIAS
;

204 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

205 
FPU_lßded_d©a
.
sigh
 = 
m64
 << 11;

206 
FPU_lßded_d©a
.
sigh
 |ğ
l64
 >> 21;

207 
FPU_lßded_d©a
.
sigl
 = 
l64
 << 11;

208 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

209  
	`d’Üm®_İ”ªd
();

214 
FPU_lßded_d©a
.
exp
 =ƒx°+ 
EXP_BIAS
;

215 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

216 
FPU_lßded_d©a
.
sigh
 = (
m64
 << 11) | 0x80000000;

217 
FPU_lßded_d©a
.
sigh
 |ğ
l64
 >> 21;

218 
FPU_lßded_d©a
.
sigl
 = 
l64
 << 11;

222 
	}
}

226 
	$»g_lßd_sšgË
()

228 *
sšgË
 = (*)
FPU_d©a_add»ss
;

229 
m32
;

230 
exp
;

232 
RE_ENTRANT_CHECK_OFF
;

233 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
sšgË
, 4);

234 
m32
 = 
	`g‘_fs_lÚg
((*è
sšgË
);

235 
RE_ENTRANT_CHECK_ON
;

237 ià(
m32
 & 0x80000000)

238 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

240 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

241 ià(!(
m32
 & 0x7fffffff))

244 
c
 = 
FPU_lßded_d©a
.
sign
;

245 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
);

246 
FPU_lßded_d©a
.
sign
 = 
c
;

249 
exp
 = ((
m32
 & 0x7f800000è>> 23è- 
SINGLE_EbŸs
;

250 
m32
 = (m32 & 0x7fffff) << 8;

251 iàĞ
exp
 < 
SINGLE_Emš
 )

254 
FPU_lßded_d©a
.
exp
 = 
SINGLE_Emš
 + 
EXP_BIAS
;

255 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

256 
FPU_lßded_d©a
.
sigh
 = 
m32
;

257 
FPU_lßded_d©a
.
sigl
 = 0;

258 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

259  
	`d’Üm®_İ”ªd
();

261 iàĞ
exp
 > 
SINGLE_Emax
 )

264 iàĞ
m32
 == 0 )

267 
FPU_lßded_d©a
.
sigh
 = 0x80000000;

268 
FPU_lßded_d©a
.
sigl
 = 0x00000000;

269 
FPU_lßded_d©a
.
exp
 = 
EXP_Infš™y
;

270 
FPU_lßded_d©a
.
g
 = 
TW_Infš™y
;

276 
FPU_lßded_d©a
.
exp
 = 
EXP_NaN
;

277 
FPU_lßded_d©a
.
g
 = 
TW_NaN
;

278 
FPU_lßded_d©a
.
sigh
 = 
m32
 | 0x80000000;

279 
FPU_lßded_d©a
.
sigl
 = 0;

285 
FPU_lßded_d©a
.
exp
 =ƒx°+ 
EXP_BIAS
;

286 
FPU_lßded_d©a
.
sigh
 = 
m32
 | 0x80000000;

287 
FPU_lßded_d©a
.
sigl
 = 0;

288 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

291 
	}
}

295 
	$»g_lßd_št64
()

297 *
_s
 = (*)
FPU_d©a_add»ss
;

298 
e
;

299 
s
;

301 
RE_ENTRANT_CHECK_OFF
;

302 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
_s
, 8);

303 ((*)&
s
)[0] = 
	`g‘_fs_lÚg
((*è
_s
);

304 ((*)&
s
)[1] = 
	`g‘_fs_lÚg
(1 + (*è
_s
);

305 
RE_ENTRANT_CHECK_ON
;

307 ià(
s
 == 0)

308 { 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
); ; }

310 ià(
s
 > 0)

311 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

314 
s
 = -s;

315 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

318 
e
 = 
EXP_BIAS
 + 63;

319 
	`signifiÿnd
(&
FPU_lßded_d©a
èğ
s
;

320 
FPU_lßded_d©a
.
exp
 = 
e
;

321 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

322 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

323 
	}
}

327 
	$»g_lßd_št32
()

329 *
_s
 = (*)
FPU_d©a_add»ss
;

330 
s
;

331 
e
;

333 
RE_ENTRANT_CHECK_OFF
;

334 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
_s
, 4);

335 
s
 = ()
	`g‘_fs_lÚg
((*è
_s
);

336 
RE_ENTRANT_CHECK_ON
;

338 ià(
s
 == 0)

339 { 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
); ; }

341 ià(
s
 > 0)

342 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

345 
s
 = -s;

346 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

349 
e
 = 
EXP_BIAS
 + 31;

350 
FPU_lßded_d©a
.
sigh
 = 
s
;

351 
FPU_lßded_d©a
.
sigl
 = 0;

352 
FPU_lßded_d©a
.
exp
 = 
e
;

353 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

354 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

355 
	}
}

359 
	$»g_lßd_št16
()

361 *
_s
 = (*)
FPU_d©a_add»ss
;

362 
s
, 
e
;

364 
RE_ENTRANT_CHECK_OFF
;

365 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
_s
, 2);

367 
s
 = ()
	`g‘_fs_wÜd
((*è
_s
);

368 
RE_ENTRANT_CHECK_ON
;

370 ià(
s
 == 0)

371 { 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
); ; }

373 ià(
s
 > 0)

374 
FPU_lßded_d©a
.
sign
 = 
SIGN_POS
;

377 
s
 = -s;

378 
FPU_lßded_d©a
.
sign
 = 
SIGN_NEG
;

381 
e
 = 
EXP_BIAS
 + 15;

382 
FPU_lßded_d©a
.
sigh
 = 
s
 << 16;

384 
FPU_lßded_d©a
.
sigl
 = 0;

385 
FPU_lßded_d©a
.
exp
 = 
e
;

386 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

387 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

388 
	}
}

392 
	$»g_lßd_bcd
()

394 *
s
 = (*)
FPU_d©a_add»ss
;

395 
pos
;

396 
bcd
;

397 
l
=0;

399 
RE_ENTRANT_CHECK_OFF
;

400 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
s
, 10);

401 
RE_ENTRANT_CHECK_ON
;

402  
pos
 = 8;…os >= 0;…os--)

404 
l
 *= 10;

405 
RE_ENTRANT_CHECK_OFF
;

406 
bcd
 = ()
	`g‘_fs_by‹
((*è
s
+
pos
);

407 
RE_ENTRANT_CHECK_ON
;

408 
l
 +ğ
bcd
 >> 4;

409 
l
 *= 10;

410 
l
 +ğ
bcd
 & 0x0f;

415 
RE_ENTRANT_CHECK_OFF
;

416 
FPU_lßded_d©a
.
sign
 =

417 (()
	`g‘_fs_by‹
((*è
s
+9)) & 0x80 ?

418 
SIGN_NEG
 : 
SIGN_POS
;

419 
RE_ENTRANT_CHECK_ON
;

421 ià(
l
 == 0)

423 
sign
 = 
FPU_lßded_d©a
.sign;

424 
	`»g_move
(&
CONST_Z
, &
FPU_lßded_d©a
);

425 
FPU_lßded_d©a
.
sign
 = sign;

429 
	`signifiÿnd
(&
FPU_lßded_d©a
èğ
l
;

430 
FPU_lßded_d©a
.
exp
 = 
EXP_BIAS
 + 63;

431 
FPU_lßded_d©a
.
g
 = 
TW_V®id
;

432 
	`nÜm®ize_nuo
(&
FPU_lßded_d©a
);

434 
	}
}

439 
	$»g_¡Üe_ex‹nded
()

446 *
d
 = (*)
FPU_d©a_add»ss
;

448 iàĞ
FPU_¡0_g
 !ğ
TW_Em±y
 )

450 
RE_ENTRANT_CHECK_OFF
;

451 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
, 
d
, 10);

452 
RE_ENTRANT_CHECK_ON
;

453 
	`wr™e_to_ex‹nded
(
FPU_¡0_±r
, (*è
FPU_d©a_add»ss
);

458 
	`EXCEPTION
(
EX_SckUnd”
);

459 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

463 
RE_ENTRANT_CHECK_OFF
;

464 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,10);

465 
	`put_fs_lÚg
(0, (*è
d
);

466 
	`put_fs_lÚg
(0xc0000000, 1 + (*è
d
);

467 
	`put_fs_wÜd
(0xffff, 4 + (*è
d
);

468 
RE_ENTRANT_CHECK_ON
;

474 
	}
}

478 
	$»g_¡Üe_doubË
()

480 *
dæßt
 = (*)
FPU_d©a_add»ss
;

481 
l
[2];

482 
šüem’t
 = 0;

484 ià(
FPU_¡0_g
 =ğ
TW_V®id
)

486 
exp
;

487 
FPU_REG
 
tmp
;

489 
	`»g_move
(
FPU_¡0_±r
, &
tmp
);

490 
exp
 = 
tmp
.ex°- 
EXP_BIAS
;

492 iàĞ
exp
 < 
DOUBLE_Emš
 )

494 
´ecisiÚ_loss
;

497 #iâdeà
PECULIAR_486


500 iàĞ
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

503 iàĞ
cÚŒŞ_wÜd
 & 
CW_Und”æow
 )

504 
	`d’Üm®_İ”ªd
();

508 
tmp
.
exp
 +ğ-
DOUBLE_Emš
 + 52;

510 iàĞ(
´ecisiÚ_loss
 = 
	`round_to_št
(&
tmp
)) )

512 #ifdeà
PECULIAR_486


517 iàĞ!((
tmp
.
sigh
 =ğ0x00100000è&& (tmp.
sigl
 == 0) &&

518 (
FPU_¡0_±r
->
sigl
 & 0x000007ff)) )

521 
	`EXCEPTION
(
EX_Und”æow
);

524 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_Und”æow
) )

527 
	`EXCEPTION
(
´ecisiÚ_loss
);

528 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
) )

531 
l
[0] = 
tmp
.
sigl
;

532 
l
[1] = 
tmp
.
sigh
;

536 iàĞ
tmp
.
sigl
 & 0x000007ff )

538 
cÚŒŞ_wÜd
 & 
CW_RC
)

540 
RC_RND
:

542 
šüem’t
 = ((
tmp
.
sigl
 & 0x7ff) > 0x400) |

543 ((
tmp
.
sigl
 & 0xc00) == 0xc00);

545 
RC_DOWN
:

546 
šüem’t
 = (
tmp
.
sign
 =ğ
SIGN_POS
è? 0 :mp.
sigl
 & 0x7ff;

548 
RC_UP
:

549 
šüem’t
 = (
tmp
.
sign
 =ğ
SIGN_POS
è?mp.
sigl
 & 0x7ff : 0;

551 
RC_CHOP
:

552 
šüem’t
 = 0;

557 
tmp
.
sigl
 &= 0xfffff800;

559 iàĞ
šüem’t
 )

561 
	`£t_´ecisiÚ_æag_up
();

563 iàĞ
tmp
.
sigl
 >= 0xfffff800 )

566 iàĞ
tmp
.
sigh
 == 0xffffffff )

569 
tmp
.
sigh
 = 0x80000000;

570 
exp
++;

571 ià(
exp
 >ğ
EXP_OVER
)

572 
ov”æow
;

576 
tmp
.
sigh
 ++;

578 
tmp
.
sigl
 = 0x00000000;

583 
tmp
.
sigl
 += 0x00000800;

587 
	`£t_´ecisiÚ_æag_down
();

590 
l
[0] = (
tmp
.
sigl
 >> 11è| (tmp.
sigh
 << 21);

591 
l
[1] = ((
tmp
.
sigh
 >> 11) & 0xfffff);

593 iàĞ
exp
 > 
DOUBLE_Emax
 )

595 
ov”æow
:

596 
	`EXCEPTION
(
EX_Ov”æow
);

597 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_Ov”æow
) )

599 
	`£t_´ecisiÚ_æag_up
();

600 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
) )

605 
l
[0] = 0x00000000;

606 
l
[1] = 0x7ff00000;

611 
l
[1] |ğ(((
exp
+
DOUBLE_EbŸs
) & 0x7ff) << 20);

615 ià(
FPU_¡0_g
 =ğ
TW_Z”o
)

618 
l
[0] = 0;

619 
l
[1] = 0;

621 ià(
FPU_¡0_g
 =ğ
TW_Infš™y
)

623 
l
[0] = 0;

624 
l
[1] = 0x7ff00000;

626 ià(
FPU_¡0_g
 =ğ
TW_NaN
)

629 
l
[0] = (
FPU_¡0_±r
->
sigl
 >> 11è| (FPU_¡0_±r->
sigh
 << 21);

630 
l
[1] = ((
FPU_¡0_±r
->
sigh
 >> 11) & 0xfffff);

631 iàĞ!(
FPU_¡0_±r
->
sigh
 & 0x40000000) )

634 
	`EXCEPTION
(
EX_Inv®id
);

635 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_Inv®id
) )

637 
l
[1] |= (0x40000000 >> 11);

639 
l
[1] |= 0x7ff00000;

641 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

644 
	`EXCEPTION
(
EX_SckUnd”
);

645 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

649 
RE_ENTRANT_CHECK_OFF
;

650 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,(*)
dæßt
,8);

651 
	`put_fs_lÚg
(0, (*è
dæßt
);

652 
	`put_fs_lÚg
(0xfff80000, 1 + (*è
dæßt
);

653 
RE_ENTRANT_CHECK_ON
;

659 ià(
FPU_¡0_±r
->
sign
)

660 
l
[1] |= 0x80000000;

662 
RE_ENTRANT_CHECK_OFF
;

663 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,(*)
dæßt
,8);

664 
	`put_fs_lÚg
(
l
[0], (*)
dæßt
);

665 
	`put_fs_lÚg
(
l
[1], 1 + (*)
dæßt
);

666 
RE_ENTRANT_CHECK_ON
;

669 
	}
}

673 
	$»g_¡Üe_sšgË
()

675 *
sšgË
 = (*)
FPU_d©a_add»ss
;

676 
‹m¶
;

677 
šüem’t
 = 0;

679 ià(
FPU_¡0_g
 =ğ
TW_V®id
)

681 
exp
;

682 
FPU_REG
 
tmp
;

684 
	`»g_move
(
FPU_¡0_±r
, &
tmp
);

685 
exp
 = 
tmp
.ex°- 
EXP_BIAS
;

687 iàĞ
exp
 < 
SINGLE_Emš
 )

689 
´ecisiÚ_loss
;

692 #iâdeà
PECULIAR_486


695 iàĞ
FPU_¡0_±r
->
exp
 <ğ
EXP_UNDER
 )

698 iàĞ
cÚŒŞ_wÜd
 & 
CW_Und”æow
 )

699 
	`d’Üm®_İ”ªd
();

703 
tmp
.
exp
 +ğ-
SINGLE_Emš
 + 23;

705 iàĞ(
´ecisiÚ_loss
 = 
	`round_to_št
(&
tmp
)) )

707 #ifdeà
PECULIAR_486


712 iàĞ!((
tmp
.
sigl
 == 0x00800000) &&

713 ((
FPU_¡0_±r
->
sigh
 & 0x000000ffè|| FPU_¡0_±r->
sigl
)) )

716 
	`EXCEPTION
(
EX_Und”æow
);

719 iàĞ!(
cÚŒŞ_wÜd
 & 
EX_Und”æow
) )

722 
	`EXCEPTION
(
´ecisiÚ_loss
);

723 iàĞ!(
cÚŒŞ_wÜd
 & 
EX_P»cisiÚ
) )

726 
‹m¶
 = 
tmp
.
sigl
;

730 iàĞ
tmp
.
sigl
 | (tmp.
sigh
 & 0x000000ff) )

732 
sigh
 = 
tmp
.sigh;

733 
sigl
 = 
tmp
.sigl;

735 
cÚŒŞ_wÜd
 & 
CW_RC
)

737 
RC_RND
:

738 
šüem’t
 = ((
sigh
 & 0xff) > 0x80)

739 || (((
sigh
 & 0xffè=ğ0x80è&& 
sigl
)

740 || ((
sigh
 & 0x180) == 0x180);

742 
RC_DOWN
:

743 
šüem’t
 = (
tmp
.
sign
 =ğ
SIGN_POS
)

744 ? 0 : (
sigl
 | (
sigh
 & 0xff));

746 
RC_UP
:

747 
šüem’t
 = (
tmp
.
sign
 =ğ
SIGN_POS
)

748 ? (
sigl
 | (
sigh
 & 0xff)) : 0;

750 
RC_CHOP
:

751 
šüem’t
 = 0;

756 
tmp
.
sigl
 = 0;

758 ià(
šüem’t
)

760 
	`£t_´ecisiÚ_æag_up
();

762 iàĞ
sigh
 >= 0xffffff00 )

765 
tmp
.
sigh
 = 0x80000000;

766 
exp
++;

767 iàĞ
exp
 >ğ
EXP_OVER
 )

768 
ov”æow
;

772 
tmp
.
sigh
 &= 0xffffff00;

773 
tmp
.
sigh
 += 0x100;

778 
	`£t_´ecisiÚ_æag_down
();

779 
tmp
.
sigh
 &= 0xffffff00;

783 
‹m¶
 = (
tmp
.
sigh
 >> 8) & 0x007fffff;

785 iàĞ
exp
 > 
SINGLE_Emax
 )

787 
ov”æow
:

788 
	`EXCEPTION
(
EX_Ov”æow
);

789 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_Ov”æow
) )

791 
	`£t_´ecisiÚ_æag_up
();

792 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_P»cisiÚ
) )

797 
‹m¶
 = 0x7f800000;

800 
‹m¶
 |ğ((
exp
+
SINGLE_EbŸs
) & 0xff) << 23;

803 ià(
FPU_¡0_g
 =ğ
TW_Z”o
)

805 
‹m¶
 = 0;

807 ià(
FPU_¡0_g
 =ğ
TW_Infš™y
)

809 
‹m¶
 = 0x7f800000;

811 ià(
FPU_¡0_g
 =ğ
TW_NaN
)

814 
‹m¶
 = 
FPU_¡0_±r
->
sigh
 >> 8;

815 iàĞ!(
FPU_¡0_±r
->
sigh
 & 0x40000000) )

818 
	`EXCEPTION
(
EX_Inv®id
);

819 iàĞ!(
cÚŒŞ_wÜd
 & 
CW_Inv®id
) )

821 
‹m¶
 |= (0x40000000 >> 8);

823 
‹m¶
 |= 0x7f800000;

825 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

828 
	`EXCEPTION
(
EX_SckUnd”
);

829 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

833 
RE_ENTRANT_CHECK_OFF
;

834 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,(*)
sšgË
,4);

835 
	`put_fs_lÚg
(0xffc00000, (*è
sšgË
);

836 
RE_ENTRANT_CHECK_ON
;

842 #ifdeà
PARANOID


845 
	`EXCEPTION
(
EX_INTERNAL
|0x106);

849 ià(
FPU_¡0_±r
->
sign
)

850 
‹m¶
 |= 0x80000000;

852 
RE_ENTRANT_CHECK_OFF
;

853 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,(*)
sšgË
,4);

854 
	`put_fs_lÚg
(
‹m¶
,(*è
sšgË
);

855 
RE_ENTRANT_CHECK_ON
;

858 
	}
}

862 
	$»g_¡Üe_št64
()

864 *
d
 = (*)
FPU_d©a_add»ss
;

865 
FPU_REG
 
t
;

866 
l
;

867 
´ecisiÚ_loss
;

869 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

872 
	`EXCEPTION
(
EX_SckUnd”
);

873 
šv®id_İ”ªd
;

875 iàĞ(
FPU_¡0_g
 =ğ
TW_Infš™y
) ||

876 (
FPU_¡0_g
 =ğ
TW_NaN
) )

878 
	`EXCEPTION
(
EX_Inv®id
);

879 
šv®id_İ”ªd
;

882 
	`»g_move
(
FPU_¡0_±r
, &
t
);

883 
´ecisiÚ_loss
 = 
	`round_to_št
(&
t
);

884 ((*)&
l
)[0] = 
t
.
sigl
;

885 ((*)&
l
)[1] = 
t
.
sigh
;

886 iàĞ(
´ecisiÚ_loss
 == 1) ||

887 ((
t
.
sigh
 & 0x80000000) &&

888 !((
t
.
sigh
 =ğ0x80000000è&& (t.
sigl
 == 0) &&

889 (
t
.
sign
 =ğ
SIGN_NEG
))) )

891 
	`EXCEPTION
(
EX_Inv®id
);

893 
šv®id_İ”ªd
:

894 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

897 
l
 = 0x8000000000000000LL;

904 iàĞ
´ecisiÚ_loss
 )

905 
	`£t_´ecisiÚ_æag
(
´ecisiÚ_loss
);

906 iàĞ
t
.
sign
 )

907 
l
 = -ll;

910 
RE_ENTRANT_CHECK_OFF
;

911 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,(*)
d
,8);

912 
	`put_fs_lÚg
(((*)&
l
)[0],(*è
d
);

913 
	`put_fs_lÚg
(((*)&
l
)[1],1 + (*è
d
);

914 
RE_ENTRANT_CHECK_ON
;

917 
	}
}

921 
	$»g_¡Üe_št32
()

923 *
d
 = (*)
FPU_d©a_add»ss
;

924 
FPU_REG
 
t
;

925 
´ecisiÚ_loss
;

927 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

930 
	`EXCEPTION
(
EX_SckUnd”
);

931 
šv®id_İ”ªd
;

933 iàĞ(
FPU_¡0_g
 =ğ
TW_Infš™y
) ||

934 (
FPU_¡0_g
 =ğ
TW_NaN
) )

936 
	`EXCEPTION
(
EX_Inv®id
);

937 
šv®id_İ”ªd
;

940 
	`»g_move
(
FPU_¡0_±r
, &
t
);

941 
´ecisiÚ_loss
 = 
	`round_to_št
(&
t
);

942 ià(
t
.
sigh
 ||

943 ((
t
.
sigl
 & 0x80000000) &&

944 !((
t
.
sigl
 =ğ0x80000000è&& (t.
sign
 =ğ
SIGN_NEG
))) )

946 
	`EXCEPTION
(
EX_Inv®id
);

948 
šv®id_İ”ªd
:

949 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

952 
t
.
sigl
 = 0x80000000;

959 iàĞ
´ecisiÚ_loss
 )

960 
	`£t_´ecisiÚ_æag
(
´ecisiÚ_loss
);

961 iàĞ
t
.
sign
 )

962 
t
.
sigl
 = -()t.sigl;

965 
RE_ENTRANT_CHECK_OFF
;

966 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,4);

967 
	`put_fs_lÚg
(
t
.
sigl
, (*è
d
);

968 
RE_ENTRANT_CHECK_ON
;

971 
	}
}

975 
	$»g_¡Üe_št16
()

977 *
d
 = (*)
FPU_d©a_add»ss
;

978 
FPU_REG
 
t
;

979 
´ecisiÚ_loss
;

981 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

984 
	`EXCEPTION
(
EX_SckUnd”
);

985 
šv®id_İ”ªd
;

987 iàĞ(
FPU_¡0_g
 =ğ
TW_Infš™y
) ||

988 (
FPU_¡0_g
 =ğ
TW_NaN
) )

990 
	`EXCEPTION
(
EX_Inv®id
);

991 
šv®id_İ”ªd
;

994 
	`»g_move
(
FPU_¡0_±r
, &
t
);

995 
´ecisiÚ_loss
 = 
	`round_to_št
(&
t
);

996 ià(
t
.
sigh
 ||

997 ((
t
.
sigl
 & 0xffff8000) &&

998 !((
t
.
sigl
 =ğ0x8000è&& (t.
sign
 =ğ
SIGN_NEG
))) )

1000 
	`EXCEPTION
(
EX_Inv®id
);

1002 
šv®id_İ”ªd
:

1003 iàĞ
cÚŒŞ_wÜd
 & 
EX_Inv®id
 )

1006 
t
.
sigl
 = 0x8000;

1013 iàĞ
´ecisiÚ_loss
 )

1014 
	`£t_´ecisiÚ_æag
(
´ecisiÚ_loss
);

1015 iàĞ
t
.
sign
 )

1016 
t
.
sigl
 = -t.sigl;

1019 
RE_ENTRANT_CHECK_OFF
;

1020 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,2);

1021 
	`put_fs_wÜd
(()
t
.
sigl
,(*è
d
);

1022 
RE_ENTRANT_CHECK_ON
;

1025 
	}
}

1029 
	$»g_¡Üe_bcd
()

1031 *
d
 = (*)
FPU_d©a_add»ss
;

1032 
FPU_REG
 
t
;

1033 
Î
;

1034 
b
;

1035 
i
, 
´ecisiÚ_loss
;

1036 
sign
 = (
FPU_¡0_±r
->sigÀ=ğ
SIGN_NEG
) ? 0x80 : 0;

1038 iàĞ
FPU_¡0_g
 =ğ
TW_Em±y
 )

1041 
	`EXCEPTION
(
EX_SckUnd”
);

1042 
šv®id_İ”ªd
;

1045 
	`»g_move
(
FPU_¡0_±r
, &
t
);

1046 
´ecisiÚ_loss
 = 
	`round_to_št
(&
t
);

1047 
Î
 = 
	`signifiÿnd
(&
t
);

1050 iàĞ(
t
.
sigh
 > 0x0de0b6b3) ||

1051 ((
t
.
sigh
 =ğ0x0de0b6b3è&& (t.
sigl
 > 0xa763ffff)) )

1053 
	`EXCEPTION
(
EX_Inv®id
);

1055 
šv®id_İ”ªd
:

1056 iàĞ
cÚŒŞ_wÜd
 & 
CW_Inv®id
 )

1059 
RE_ENTRANT_CHECK_OFF
;

1060 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,10);

1061  
i
 = 0; i < 7; i++)

1062 
	`put_fs_by‹
(0, (*è
d
+
i
);

1063 
	`put_fs_by‹
(0xc0, (*è
d
+7);

1064 
	`put_fs_by‹
(0xff, (*è
d
+8);

1065 
	`put_fs_by‹
(0xff, (*è
d
+9);

1066 
RE_ENTRANT_CHECK_ON
;

1072 iàĞ
´ecisiÚ_loss
 )

1075 
	`£t_´ecisiÚ_æag
(
´ecisiÚ_loss
);

1078 
RE_ENTRANT_CHECK_OFF
;

1079 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,10);

1080 
RE_ENTRANT_CHECK_ON
;

1081  
i
 = 0; i < 9; i++)

1083 
b
 = 
	`div_sm®l
(&
Î
, 10);

1084 
b
 |ğ(
	`div_sm®l
(&
Î
, 10)) << 4;

1085 
RE_ENTRANT_CHECK_OFF
;

1086 
	`put_fs_by‹
(
b
,(*è
d
+
i
);

1087 
RE_ENTRANT_CHECK_ON
;

1089 
RE_ENTRANT_CHECK_OFF
;

1090 
	`put_fs_by‹
(
sign
,(*è
d
+9);

1091 
RE_ENTRANT_CHECK_ON
;

1094 
	}
}

1106 
	$round_to_št
(
FPU_REG
 *
r
)

1108 
v”y_big
;

1109 
—x
;

1111 ià(
r
->
g
 =ğ
TW_Z”o
)

1114 
	`signifiÿnd
(
r
) = 0;

1118 ià(
r
->
exp
 > 
EXP_BIAS
 + 63)

1120 
r
->
sigl
 =„->
sigh
 = ~0;

1124 
—x
 = 
	`shrxs
(&
r
->
sigl
, 
EXP_BIAS
 + 63 -„->
exp
);

1125 
v”y_big
 = !(~(
r
->
sigh
è| ~Ô->
sigl
));

1126 
	#h®f_Ü_mÜe
 (
—x
 & 0x80000000)

	)

1127 
	#äac_·¹
 (
—x
)

	)

1128 
	#mÜe_thª_h®f
 ((
—x
 & 0x80000001è=ğ0x80000001)

	)

1129 
cÚŒŞ_wÜd
 & 
CW_RC
)

1131 
RC_RND
:

1132 iàĞ
mÜe_thª_h®f


1133 || (
h®f_Ü_mÜe
 && (
r
->
sigl
 & 1)) )

1135 iàĞ
v”y_big
 )  1;

1136 
	`signifiÿnd
(
r
) ++;

1137  
PRECISION_LOST_UP
;

1140 
RC_DOWN
:

1141 ià(
äac_·¹
 && 
r
->
sign
)

1143 iàĞ
v”y_big
 )  1;

1144 
	`signifiÿnd
(
r
) ++;

1145  
PRECISION_LOST_UP
;

1148 
RC_UP
:

1149 ià(
äac_·¹
 && !
r
->
sign
)

1151 iàĞ
v”y_big
 )  1;

1152 
	`signifiÿnd
(
r
) ++;

1153  
PRECISION_LOST_UP
;

1156 
RC_CHOP
:

1160  
—x
 ? 
PRECISION_LOST_DOWN
 : 0;

1162 
	}
}

1166 *
	$æd’v
(
åu_addr_modes
 
addr_modes
)

1168 *
s
 = (*)
FPU_d©a_add»ss
;

1169 
g_wÜd
 = 0;

1170 
g
;

1171 
i
;

1173 iàĞ
addr_modes
.
vm86


1174 || (
addr_modes
.
ov”ride
.
İ”ªd_size
 =ğ
OP_SIZE_PREFIX
) )

1176 
RE_ENTRANT_CHECK_OFF
;

1177 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
s
, 0x0e);

1178 
cÚŒŞ_wÜd
 = 
	`g‘_fs_wÜd
((*è
s
);

1179 
·¹Ÿl_¡©us
 = 
	`g‘_fs_wÜd
((*è(
s
+2));

1180 
g_wÜd
 = 
	`g‘_fs_wÜd
((*è(
s
+4));

1181 
_off£t
 = 
	`g‘_fs_wÜd
((*è(
s
+6));

1182 
cs_£ËùÜ
 = 
	`g‘_fs_wÜd
((*è(
s
+8));

1183 
d©a_İ”ªd_off£t
 = 
	`g‘_fs_wÜd
((*è(
s
+0x0a));

1184 
İ”ªd_£ËùÜ
 = 
	`g‘_fs_wÜd
((*è(
s
+0x0c));

1185 
RE_ENTRANT_CHECK_ON
;

1186 
s
 += 0x0e;

1187 iàĞ
addr_modes
.
vm86
 )

1189 
_off£t
 +ğ(
cs_£ËùÜ
 & 0xf000) << 4;

1190 
d©a_İ”ªd_off£t
 +ğ(
İ”ªd_£ËùÜ
 & 0xf000) << 4;

1195 
RE_ENTRANT_CHECK_OFF
;

1196 
	`FPU_v”ify_¬—
(
VERIFY_READ
, 
s
, 0x1c);

1197 
cÚŒŞ_wÜd
 = 
	`g‘_fs_wÜd
((*è
s
);

1198 
·¹Ÿl_¡©us
 = 
	`g‘_fs_wÜd
((*è(
s
+4));

1199 
g_wÜd
 = 
	`g‘_fs_wÜd
((*è(
s
+8));

1200 
_off£t
 = 
	`g‘_fs_lÚg
((*è(
s
+0x0c));

1201 
cs_£ËùÜ
 = 
	`g‘_fs_lÚg
((*è(
s
+0x10));

1202 
d©a_İ”ªd_off£t
 = 
	`g‘_fs_lÚg
((*è(
s
+0x14));

1203 
İ”ªd_£ËùÜ
 = 
	`g‘_fs_lÚg
((*è(
s
+0x18));

1204 
RE_ENTRANT_CHECK_ON
;

1205 
s
 += 0x1c;

1208 #ifdeà
PECULIAR_486


1209 
cÚŒŞ_wÜd
 &= ~0xe080;

1212 
tİ
 = (
·¹Ÿl_¡©us
 >> 
SW_Tİ_Shiá
) & 7;

1214 iàĞ
·¹Ÿl_¡©us
 & ~
cÚŒŞ_wÜd
 & 
CW_Exû±iÚs
 )

1215 
·¹Ÿl_¡©us
 |ğ(
SW_Summ¬y
 | 
SW_Backw¬d
);

1217 
·¹Ÿl_¡©us
 &ğ~(
SW_Summ¬y
 | 
SW_Backw¬d
);

1219  
i
 = 0; i < 8; i++ )

1221 
g
 = 
g_wÜd
 & 3;

1222 
g_wÜd
 >>= 2;

1224 iàĞ
g
 == 3 )

1226 
»gs
[
i
].
g
 = 
TW_Em±y
;

1227 iàĞ
»gs
[
i
].
g
 =ğ
TW_Em±y
 )

1231 iàĞ
»gs
[
i
].
exp
 =ğ
EXP_BIAS
 - 
EXTENDED_EbŸs
 )

1233 iàĞ!(
»gs
[
i
].
sigl
 |„egs[i].
sigh
) )

1234 
»gs
[
i
].
g
 = 
TW_Z”o
;

1236 
»gs
[
i
].
g
 = 
TW_V®id
;

1238 iàĞ
»gs
[
i
].
exp
 =ğ0x7ffà+ 
EXP_BIAS
 - 
EXTENDED_EbŸs
 )

1240 iàĞ!((
»gs
[
i
].
sigh
 & ~0x80000000è|„egs[i].
sigl
) )

1241 
»gs
[
i
].
g
 = 
TW_Infš™y
;

1243 
»gs
[
i
].
g
 = 
TW_NaN
;

1246 
»gs
[
i
].
g
 = 
TW_V®id
;

1254 
NO_NET_DATA_EFFECT
;

1255 
NO_NET_INSTR_EFFECT
;

1257  
s
;

1258 
	}
}

1261 
	$ä¡Ü
(
åu_addr_modes
 
addr_modes
)

1263 
i
, 
¡Ä
;

1264 
g
;

1265 *
s
 = 
	`æd’v
(
addr_modes
);

1267  
i
 = 0; i < 8; i++ )

1270 
FPU_d©a_add»ss
 = (*)(
s
+
i
*10);

1271 
	`»g_lßd_ex‹nded
();

1272 
¡Ä
 = (
i
+
tİ
) & 7;

1273 
g
 = 
»gs
[
¡Ä
].tag;

1274 
	`»g_move
(&
FPU_lßded_d©a
, &
»gs
[
¡Ä
]);

1275 iàĞ
g
 =ğ
TW_Em±y
 )

1276 
»gs
[
¡Ä
].
g
 =ag;

1281 
NO_NET_DATA_EFFECT
;

1283 
	}
}

1286 
	$g_wÜd
()

1288 
wÜd
 = 0;

1289 
g
;

1290 
i
;

1292  
i
 = 7; i >= 0; i-- )

1294  
g
 = 
»gs
[
i
].tag )

1296 
TW_V®id
:

1297 iàĞ
»gs
[
i
].
exp
 <ğ(
EXP_BIAS
 - 
EXTENDED_EbŸs
) )

1298 
g
 = 2;

1300 
TW_Infš™y
:

1301 
TW_NaN
:

1302 
g
 = 2;

1304 
TW_Em±y
:

1305 
g
 = 3;

1309 
wÜd
 <<= 2;

1310 
wÜd
 |ğ
g
;

1312  
wÜd
;

1313 
	}
}

1316 *
	$f¡’v
(
åu_addr_modes
 
addr_modes
)

1318 *
d
 = (*)
FPU_d©a_add»ss
;

1320 iàĞ
addr_modes
.
vm86


1321 || (
addr_modes
.
ov”ride
.
İ”ªd_size
 =ğ
OP_SIZE_PREFIX
) )

1323 
RE_ENTRANT_CHECK_OFF
;

1324 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,14);

1325 #ifdeà
PECULIAR_486


1326 
	`put_fs_lÚg
(
cÚŒŞ_wÜd
 & ~0xe080, (*è
d
);

1328 
	`put_fs_wÜd
(
cÚŒŞ_wÜd
, (*è
d
);

1330 
	`put_fs_wÜd
(
	`¡©us_wÜd
(), (*è(
d
+2));

1331 
	`put_fs_wÜd
(
	`g_wÜd
(), (*è(
d
+4));

1332 
	`put_fs_wÜd
(
_off£t
, (*è(
d
+6));

1333 
	`put_fs_wÜd
(
d©a_İ”ªd_off£t
, (*è(
d
+0x0a));

1334 iàĞ
addr_modes
.
vm86
 )

1336 
	`put_fs_wÜd
((
_off£t
 & 0xf0000) >> 4,

1337 (*è(
d
+8));

1338 
	`put_fs_wÜd
((
d©a_İ”ªd_off£t
 & 0xf0000) >> 4,

1339 (*è(
d
+0x0c));

1343 
	`put_fs_wÜd
(
cs_£ËùÜ
, (*è(
d
+8));

1344 
	`put_fs_wÜd
(
İ”ªd_£ËùÜ
, (*è(
d
+0x0c));

1346 
RE_ENTRANT_CHECK_ON
;

1347 
d
 += 0x0e;

1351 
RE_ENTRANT_CHECK_OFF
;

1352 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,28);

1353 #ifdeà
PECULIAR_486


1355 
	`put_fs_lÚg
(0xffff0040 | (
cÚŒŞ_wÜd
 & ~0xe080), (*è
d
);

1356 
	`put_fs_lÚg
(0xffff0000 | 
	`¡©us_wÜd
(), (*è(
d
+4));

1357 
	`put_fs_lÚg
(0xffff0000 | 
	`g_wÜd
(), (*è(
d
+8));

1359 
	`put_fs_wÜd
(
cÚŒŞ_wÜd
, (*è
d
);

1360 
	`put_fs_wÜd
(
	`¡©us_wÜd
(), (*è(
d
+4));

1361 
	`put_fs_wÜd
(
	`g_wÜd
(), (*è(
d
+8));

1363 
	`put_fs_lÚg
(
_off£t
, (*è(
d
+0x0c));

1364 
	`put_fs_lÚg
(
cs_£ËùÜ
 & ~0xf8000000, (*è(
d
+0x10));

1365 
	`put_fs_lÚg
(
d©a_İ”ªd_off£t
, (*è(
d
+0x14));

1366 #ifdeà
PECULIAR_486


1368 
	`put_fs_lÚg
(0xffff0000 | 
İ”ªd_£ËùÜ
, (*è(
d
+0x18));

1370 
	`put_fs_lÚg
(
İ”ªd_£ËùÜ
, (*è(
d
+0x18));

1372 
RE_ENTRANT_CHECK_ON
;

1373 
d
 += 0x1c;

1376 
cÚŒŞ_wÜd
 |ğ
CW_Exû±iÚs
;

1377 
·¹Ÿl_¡©us
 &ğ~(
SW_Summ¬y
 | 
SW_Backw¬d
);

1379  
d
;

1380 
	}
}

1383 
	$f§ve
(
åu_addr_modes
 
addr_modes
)

1385 *
d
;

1386 
i
;

1388 
d
 = 
	`f¡’v
(
addr_modes
);

1389 
RE_ENTRANT_CHECK_OFF
;

1390 
	`FPU_v”ify_¬—
(
VERIFY_WRITE
,
d
,80);

1391 
RE_ENTRANT_CHECK_ON
;

1392  
i
 = 0; i < 8; i++ )

1393 
	`wr™e_to_ex‹nded
(&
»gs
[(
tİ
 + 
i
è& 7], 
d
 + 10 * i);

1395 
	`fš™
();

1397 
	}
}

1405 
	$wr™e_to_ex‹nded
(
FPU_REG
 *
½
, *
d
)

1407 
e
;

1408 
FPU_REG
 
tmp
;

1410 
e
 = 
½
->
exp
 - 
EXP_BIAS
 + 
EXTENDED_EbŸs
;

1412 #ifdeà
PARANOID


1413  
½
->
g
 )

1415 
TW_Z”o
:

1416 iàĞ
½
->
sigh
 |„p->
sigl
 | 
e
 )

1417 
	`EXCEPTION
(
EX_INTERNAL
 | 0x114);

1419 
TW_Infš™y
:

1420 
TW_NaN
:

1421 iàĞ(
e
 ^ 0x7fffè| !(
½
->
sigh
 & 0x80000000) )

1422 
	`EXCEPTION
(
EX_INTERNAL
 | 0x114);

1425 ià(
e
 > 0x7fff ||ƒ < -63)

1426 
	`EXCEPTION
(
EX_INTERNAL
 | 0x114);

1435 iàĞ
e
 > 0 )

1438 
RE_ENTRANT_CHECK_OFF
;

1439 
	`put_fs_lÚg
(
½
->
sigl
, (*è
d
);

1440 
	`put_fs_lÚg
(
½
->
sigh
, (*è(
d
 + 4));

1441 
RE_ENTRANT_CHECK_ON
;

1450 
	`»g_move
(
½
, &
tmp
);

1451 
tmp
.
exp
 +ğ-
EXTENDED_Emš
 + 63;

1452 
	`round_to_št
(&
tmp
);

1453 
e
 = 0;

1454 
RE_ENTRANT_CHECK_OFF
;

1455 
	`put_fs_lÚg
(
tmp
.
sigl
, (*è
d
);

1456 
	`put_fs_lÚg
(
tmp
.
sigh
, (*è(
d
 + 4));

1457 
RE_ENTRANT_CHECK_ON
;

1459 
e
 |ğ
½
->
sign
 =ğ
SIGN_POS
 ? 0 : 0x8000;

1460 
RE_ENTRANT_CHECK_OFF
;

1461 
	`put_fs_wÜd
(
e
, (*è(
d
 + 8));

1462 
RE_ENTRANT_CHECK_ON
;

1463 
	}
}

	@drivers/FPU-emu/reg_mul.c

17 
	~"exû±iÚ.h
"

18 
	~"»g_cÚ¡ªt.h
"

19 
	~"åu_emu.h
"

20 
	~"åu_sy¡em.h
"

24 
	$»g_mul
(
FPU_REG
 cÚ¡ *
a
, FPU_REG cÚ¡ *
b
,

25 
FPU_REG
 *
de¡
, 
cÚŒŞ_w
)

27 
§ved_sign
 = 
de¡
->
sign
;

28 
sign
 = (
a
->sigÀ^ 
b
->sign);

30 ià(!(
a
->
g
 | 
b
->tag))

33 
de¡
->
sign
 = sign;

34 iàĞ
	`»g_u_mul
(
a
, 
b
, 
de¡
, 
cÚŒŞ_w
) )

36 
de¡
->
sign
 = 
§ved_sign
;

41 ià((
a
->
g
 <ğ
TW_Z”o
è&& (
b
->tag <= TW_Zero))

43 #ifdeà
DENORM_OPERAND


44 iàĞ((
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
)) ||

45 ((
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
)) )

47 iàĞ
	`d’Üm®_İ”ªd
() )  1;

53 
	`»g_move
(&
CONST_Z
, 
de¡
);

57 
de¡
->
sign
 = sign;

63 iàĞ(
a
->
g
 =ğ
TW_NaN
è|| (
b
->tag == TW_NaN) )

64 {  
	`»®_2İ_NaN
(
a
, 
b
, 
de¡
); }

65 ià(
a
->
g
 =ğ
TW_Infš™y
)

67 ià(
b
->
g
 =ğ
TW_Z”o
)

68 {  
	`¬™h_šv®id
(
de¡
); }

71 #ifdeà
DENORM_OPERAND


72 iàĞ(
b
->
g
 =ğ
TW_V®id
è&& (b->
exp
 <ğ
EXP_UNDER
) &&

73 
	`d’Üm®_İ”ªd
() )

76 
	`»g_move
(
a
, 
de¡
);

77 
de¡
->
sign
 = sign;

81 ià(
b
->
g
 =ğ
TW_Infš™y
)

83 ià(
a
->
g
 =ğ
TW_Z”o
)

84 {  
	`¬™h_šv®id
(
de¡
); }

87 #ifdeà
DENORM_OPERAND


88 iàĞ(
a
->
g
 =ğ
TW_V®id
è&& (a->
exp
 <ğ
EXP_UNDER
) &&

89 
	`d’Üm®_İ”ªd
() )

92 
	`»g_move
(
b
, 
de¡
);

93 
de¡
->
sign
 = sign;

97 #ifdeà
PARANOID


100 
	`EXCEPTION
(
EX_INTERNAL
|0x102);

105 
	}
}

	@drivers/FPU-emu/status_w.h

10 #iâdeà
_STATUS_H_


11 
	#_STATUS_H_


	)

13 
	~"åu_emu.h
"

15 #ifdeà
__ASSEMBLER__


16 
	#CÚ¡__
(
x
è
$
##
	)
x

18 
	#CÚ¡__
(
x
è
	)
x

21 
	#SW_Backw¬d
 
	`CÚ¡__
(0x8000è

	)

22 
	#SW_C3
 
	`CÚ¡__
(0x4000è

	)

23 
	#SW_Tİ
 
	`CÚ¡__
(0x3800è

	)

24 
	#SW_Tİ_Shiá
 
	`CÚ¡__
(11è

	)

25 
	#SW_C2
 
	`CÚ¡__
(0x0400è

	)

26 
	#SW_C1
 
	`CÚ¡__
(0x0200è

	)

27 
	#SW_C0
 
	`CÚ¡__
(0x0100è

	)

28 
	#SW_Summ¬y
 
	`CÚ¡__
(0x0080è

	)

29 
	#SW_Sck_FauÉ
 
	`CÚ¡__
(0x0040è

	)

30 
	#SW_P»cisiÚ
 
	`CÚ¡__
(0x0020è

	)

31 
	#SW_Und”æow
 
	`CÚ¡__
(0x0010è

	)

32 
	#SW_Ov”æow
 
	`CÚ¡__
(0x0008è

	)

33 
	#SW_Z”o_Div
 
	`CÚ¡__
(0x0004è

	)

34 
	#SW_D’Üm_Op
 
	`CÚ¡__
(0x0002è

	)

35 
	#SW_Inv®id
 
	`CÚ¡__
(0x0001è

	)

37 
	#SW_Exc_Mask
 
	`CÚ¡__
(0x27fè

	)

39 #iâdeà
__ASSEMBLER__


41 
	#COMP_A_gt_B
 1

	)

42 
	#COMP_A_eq_B
 2

	)

43 
	#COMP_A_É_B
 3

	)

44 
	#COMP_No_Comp
 4

	)

45 
	#COMP_D’Üm®
 0x20

	)

46 
	#COMP_NaN
 0x40

	)

47 
	#COMP_SNaN
 0x80

	)

49 
	#¡©us_wÜd
() \

50 ((
·¹Ÿl_¡©us
 & ~
SW_Tİ
 & 0xffffè| ((
tİ
 << 
SW_Tİ_Shiá
è& SW_Tİ))

	)

51 
	#£tcc
(
cc
) ({ \

52 
·¹Ÿl_¡©us
 &ğ~(
SW_C0
|
SW_C1
|
SW_C2
|
SW_C3
); \

53 
·¹Ÿl_¡©us
 |ğ(
cc
è& (
SW_C0
|
SW_C1
|
SW_C2
|
SW_C3
); })

	)

55 #ifdeà
PECULIAR_486


58 
	#ş—r_C1
(è{ 
·¹Ÿl_¡©us
 &ğ~
SW_C1
; }

	)

60 
	#ş—r_C1
()

	)

	@drivers/FPU-emu/version.h

12 
	#FPU_VERSION
 "wm-FPU-emu v”siÚ B‘¨1.10"

	)

	@drivers/block/blk.h

1 #iâdeà
_BLK_H


2 
	#_BLK_H


	)

4 
	~<lšux/majÜ.h
>

5 
	~<lšux/sched.h
>

6 
	~<lšux/locks.h
>

7 
	~<lšux/g’hd.h
>

19 
	#NR_REQUEST
 64

	)

27 
	s»que¡
 {

28 
	mdev
;

29 
	mcmd
;

30 
	m”rÜs
;

31 
	m£ùÜ
;

32 
	mÄ_£ùÜs
;

33 
	mcu¼’t_Ä_£ùÜs
;

34 * 
	mbufãr
;

35 
sk_¡ruù
 * 
	mwa™šg
;

36 
bufãr_h—d
 * 
	mbh
;

37 
bufãr_h—d
 * 
	mbh
;

38 
»que¡
 * 
	mÃxt
;

46 
	#IN_ORDER
(
s1
,
s2
) \

47 ((
s1
)->
cmd
 < (
s2
)->cmd || ((s1)->cmd == (s2)->cmd && \

48 ((
s1
)->
dev
 < (
s2
)->dev || (((s1)->dev == (s2)->dev && \

49 (
s1
)->
£ùÜ
 < (
s2
)->£ùÜ)))))

	)

51 
	sblk_dev_¡ruù
 {

52 (*
	m»que¡_â
)();

53 
»que¡
 * 
	mcu¼’t_»que¡
;

57 
	s£c_size
 {

58 
	mblock_size
;

59 
	mblock_size_b™s
;

66 
	#SECTOR_MASK
 (
blksize_size
[
MAJOR_NR
] && \

67 
blksize_size
[
MAJOR_NR
][
	`MINOR
(
CURRENT
->
dev
)] ? \

68 ((
blksize_size
[
MAJOR_NR
][
	`MINOR
(
CURRENT
->
dev
)] >> 9) - 1) : \

69 ((
BLOCK_SIZE
 >> 9è- 1))

	)

71 
	#SUBSECTOR
(
block
è(
CURRENT
->
cu¼’t_Ä_£ùÜs
 > 0)

	)

73 
£c_size
 * 
blk_£c
[
MAX_BLKDEV
];

74 
blk_dev_¡ruù
 
blk_dev
[
MAX_BLKDEV
];

75 
wa™_queue
 * 
wa™_fÜ_»que¡
;

76 
»£tup_Úe_dev
(
g’disk
 *
dev
, 
drive
);

78 * 
blk_size
[
MAX_BLKDEV
];

80 * 
blksize_size
[
MAX_BLKDEV
];

82 
hd_š™
(
mem_¡¬t
, 
mem_’d
);

83 
cdu31a_š™
(
mem_¡¬t
, 
mem_’d
);

84 
mcd_š™
(
mem_¡¬t
, 
mem_’d
);

85 
is_»ad_Úly
(
dev
);

86 
£t_deviû_ro
(
dev
,
æag
);

88 
rd_lßd
();

89 
rd_š™
(
mem_¡¬t
, 
Ëngth
);

90 
¿mdisk_size
;

92 
xd_š™
(
mem_¡¬t
, 
mem_’d
);

94 
	#RO_IOCTLS
(
dev
,
wh”e
) \

95 
BLKROSET
: ià(!
	`su£r
()è -
EPERM
; \

96 
	`£t_deviû_ro
((
dev
),
	`g‘_fs_lÚg
((*è(
wh”e
)));  0; \

97 
BLKROGET
: { 
__”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è(
wh”e
), ()); \

98 ià(!
__”r
è
	`put_fs_lÚg
(
	`is_»ad_Úly
(
dev
),(*è(
wh”e
));  __”r; }

	)

100 #ifdeà
MAJOR_NR


107 #ià(
MAJOR_NR
 =ğ
MEM_MAJOR
)

110 
	#DEVICE_NAME
 "¿mdisk"

	)

111 
	#DEVICE_REQUEST
 
do_rd_»que¡


	)

112 
	#DEVICE_NR
(
deviû
è((deviûè& 7)

	)

113 
	#DEVICE_ON
(
deviû
)

	)

114 
	#DEVICE_OFF
(
deviû
)

	)

116 #–ià(
MAJOR_NR
 =ğ
FLOPPY_MAJOR
)

118 
æİpy_Ú
(
Ä
);

119 
æİpy_off
(
Ä
);

121 
	#DEVICE_NAME
 "æİpy"

	)

122 
	#DEVICE_INTR
 
do_æİpy


	)

123 
	#DEVICE_REQUEST
 
do_fd_»que¡


	)

124 
	#DEVICE_NR
(
deviû
è((deviûè& 3)

	)

125 
	#DEVICE_ON
(
deviû
è
	`æİpy_Ú
(
	`DEVICE_NR
(deviû))

	)

126 
	#DEVICE_OFF
(
deviû
è
	`æİpy_off
(
	`DEVICE_NR
(deviû))

	)

128 #–ià(
MAJOR_NR
 =ğ
HD_MAJOR
)

131 
	#DEVICE_NAME
 "h¬ddisk"

	)

132 
	#DEVICE_INTR
 
do_hd


	)

133 
	#DEVICE_TIMEOUT
 
HD_TIMER


	)

134 
	#TIMEOUT_VALUE
 600

	)

135 
	#DEVICE_REQUEST
 
do_hd_»que¡


	)

136 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû)>>6)

	)

137 
	#DEVICE_ON
(
deviû
)

	)

138 
	#DEVICE_OFF
(
deviû
)

	)

140 #–ià(
MAJOR_NR
 =ğ
SCSI_DISK_MAJOR
)

142 
	#DEVICE_NAME
 "scsidisk"

	)

143 
	#DEVICE_INTR
 
do_sd


	)

144 
	#TIMEOUT_VALUE
 200

	)

145 
	#DEVICE_REQUEST
 
do_sd_»que¡


	)

146 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviûè>> 4)

	)

147 
	#DEVICE_ON
(
deviû
)

	)

148 
	#DEVICE_OFF
(
deviû
)

	)

150 #–ià(
MAJOR_NR
 =ğ
SCSI_TAPE_MAJOR
)

152 
	#DEVICE_NAME
 "scs™­e"

	)

153 
	#DEVICE_INTR
 
do_¡


	)

154 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû))

	)

155 
	#DEVICE_ON
(
deviû
)

	)

156 
	#DEVICE_OFF
(
deviû
)

	)

158 #–ià(
MAJOR_NR
 =ğ
SCSI_CDROM_MAJOR
)

160 
	#DEVICE_NAME
 "CD-ROM"

	)

161 
	#DEVICE_INTR
 
do_¤


	)

162 
	#DEVICE_REQUEST
 
do_¤_»que¡


	)

163 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû))

	)

164 
	#DEVICE_ON
(
deviû
)

	)

165 
	#DEVICE_OFF
(
deviû
)

	)

167 #–ià(
MAJOR_NR
 =ğ
XT_DISK_MAJOR
)

169 
	#DEVICE_NAME
 "xˆdisk"

	)

170 
	#DEVICE_REQUEST
 
do_xd_»que¡


	)

171 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviûè>> 6)

	)

172 
	#DEVICE_ON
(
deviû
)

	)

173 
	#DEVICE_OFF
(
deviû
)

	)

175 #–ià(
MAJOR_NR
 =ğ
CDU31A_CDROM_MAJOR
)

177 
	#DEVICE_NAME
 "CDU31A"

	)

178 
	#DEVICE_REQUEST
 
do_cdu31a_»que¡


	)

179 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû))

	)

180 
	#DEVICE_ON
(
deviû
)

	)

181 
	#DEVICE_OFF
(
deviû
)

	)

183 #–ià(
MAJOR_NR
 =ğ
MITSUMI_CDROM_MAJOR
)

185 
	#DEVICE_NAME
 "M™sum˜CD-ROM"

	)

187 
	#DEVICE_REQUEST
 
do_mcd_»que¡


	)

188 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû))

	)

189 
	#DEVICE_ON
(
deviû
)

	)

190 
	#DEVICE_OFF
(
deviû
)

	)

192 #–ià(
MAJOR_NR
 =ğ
MATSUSHITA_CDROM_MAJOR
)

194 
	#DEVICE_NAME
 "M©sush™¨CD-ROM"

	)

195 
	#DEVICE_REQUEST
 
do_sbpcd_»que¡


	)

196 
	#DEVICE_NR
(
deviû
è(
	`MINOR
(deviû))

	)

197 
	#DEVICE_ON
(
deviû
)

	)

198 
	#DEVICE_OFF
(
deviû
)

	)

206 #ià(
MAJOR_NR
 !ğ
SCSI_TAPE_MAJOR
)

208 #iâdeà
CURRENT


209 
	#CURRENT
 (
blk_dev
[
MAJOR_NR
].
cu¼’t_»que¡
)

	)

212 
	#CURRENT_DEV
 
	`DEVICE_NR
(
CURRENT
->
dev
)

	)

214 #ifdeà
DEVICE_INTR


215 (*
DEVICE_INTR
)(èğ
NULL
;

217 #ifdeà
DEVICE_TIMEOUT


219 
	#SET_TIMER
 \

220 ((
tim”_bË
[
DEVICE_TIMEOUT
].
expœes
 = 
jiff›s
 + 
TIMEOUT_VALUE
), \

221 (
tim”_aùive
 |ğ1<<
DEVICE_TIMEOUT
))

	)

223 
	#CLEAR_TIMER
 \

224 
tim”_aùive
 &ğ~(1<<
DEVICE_TIMEOUT
)

	)

226 
	#SET_INTR
(
x
) \

227 ià((
DEVICE_INTR
 = (
x
)è!ğ
NULL
) \

228 
SET_TIMER
; \

230 
CLEAR_TIMER
;

	)

234 
	#SET_INTR
(
x
è(
DEVICE_INTR
 = (x))

	)

237 (
DEVICE_REQUEST
)();

241 #ià! 
	`SCSI_MAJOR
(
MAJOR_NR
)

243 
	$’d_»que¡
(
u±od©e
)

245 
»que¡
 * 
»q
;

246 
bufãr_h—d
 * 
bh
;

247 
sk_¡ruù
 * 
p
;

249 
»q
 = 
CURRENT
;

250 
»q
->
”rÜs
 = 0;

251 ià(!
u±od©e
) {

252 
	`´štk
(
DEVICE_NAME
 " I/Oƒrror\n");

253 
	`´štk
("dev %04lX, sector %lu\n",

254 ()
»q
->
dev
,„eq->
£ùÜ
);

255 
»q
->
Ä_£ùÜs
--;

256 
»q
->
Ä_£ùÜs
 &ğ~
SECTOR_MASK
;

257 
»q
->
£ùÜ
 +ğ(
BLOCK_SIZE
 / 512);

258 
»q
->
£ùÜ
 &ğ~
SECTOR_MASK
;

261 ià((
bh
 = 
»q
->bhè!ğ
NULL
) {

262 
»q
->
bh
 = bh->
b_»qÃxt
;

263 
bh
->
b_»qÃxt
 = 
NULL
;

264 
bh
->
b_u±od©e
 = 
u±od©e
;

265 
	`uÆock_bufãr
(
bh
);

266 ià((
bh
 = 
»q
->bhè!ğ
NULL
) {

267 
»q
->
cu¼’t_Ä_£ùÜs
 = 
bh
->
b_size
 >> 9;

268 ià(
»q
->
Ä_£ùÜs
 <„eq->
cu¼’t_Ä_£ùÜs
) {

269 
»q
->
Ä_£ùÜs
 =„eq->
cu¼’t_Ä_£ùÜs
;

270 
	`´štk
("end_request: buffer-list destroyed\n");

272 
»q
->
bufãr
 = 
bh
->
b_d©a
;

276 
	`DEVICE_OFF
(
»q
->
dev
);

277 
CURRENT
 = 
»q
->
Ãxt
;

278 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

279 
»q
->
wa™šg
 = 
NULL
;

280 
p
->
¡©e
 = 
TASK_RUNNING
;

281 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

282 
Ãed_»sched
 = 1;

284 
»q
->
dev
 = -1;

285 
	`wake_up
(&
wa™_fÜ_»que¡
);

286 
	}
}

289 #ifdeà
DEVICE_INTR


290 
	#CLEAR_INTR
 
	`SET_INTR
(
NULL
)

	)

292 
	#CLEAR_INTR


	)

295 
	#INIT_REQUEST
 \

296 ià(!
CURRENT
) {\

297 
CLEAR_INTR
; \

300 ià(
	`MAJOR
(
CURRENT
->
dev
è!ğ
MAJOR_NR
) \

301 
	`·nic
(
DEVICE_NAME
 ":„equest†ist destroyed"); \

302 ià(
CURRENT
->
bh
) { \

303 ià(!
CURRENT
->
bh
->
b_lock
) \

304 
	`·nic
(
DEVICE_NAME
 ": block‚ot†ocked"); \

305 }

	)

	@drivers/block/cdu31a.c

63 
	~<lšux/”ºo.h
>

64 
	~<lšux/sigÇl.h
>

65 
	~<lšux/sched.h
>

66 
	~<lšux/tim”.h
>

67 
	~<lšux/fs.h
>

68 
	~<lšux/k”Ãl.h
>

69 
	~<lšux/hd»g.h
>

70 
	~<lšux/g’hd.h
>

71 
	~<lšux/iİÜt.h
>

73 
	~<asm/sy¡em.h
>

74 
	~<asm/io.h
>

75 
	~<asm/£gm’t.h
>

77 
	~<lšux/cdrom.h
>

78 
	~<lšux/cdu31a.h
>

80 
	#MAJOR_NR
 
CDU31A_CDROM_MAJOR


	)

81 
	~"blk.h
"

83 
	#CDU31A_MAX_CONSECUTIVE_ATTENTIONS
 10

	)

85 
	gcdu31a_add»s£s
[] =

97 
hªdË_sÚy_cd_©‹ÁiÚ
();

98 
»ad_subcode
();

99 
sÚy_g‘_toc
();

100 
scd_İ’
(
šode
 *šode, 
fe
 *
fp
);

101 
do_sÚy_cd_cmd
(
cmd
,

102 *
·¿ms
,

103 
num_·¿ms
,

104 *
»suÉ_bufãr
,

105 *
»suÉ_size
);

106 
size_to_buf
(
size
,

107 *
buf
);

112 
	gsÚy_cd_ba£_io
 = 0;

118 vŞ©
	gsÚy_cd_cmd_»g
;

119 vŞ©
	gsÚy_cd_·¿m_»g
;

120 vŞ©
	gsÚy_cd_wr™e_»g
;

121 vŞ©
	gsÚy_cd_cÚŒŞ_»g
;

122 vŞ©
	gsÚy_cd_¡©us_»g
;

123 vŞ©
	gsÚy_cd_»suÉ_»g
;

124 vŞ©
	gsÚy_cd_»ad_»g
;

125 vŞ©
	gsÚy_cd_fifo¡_»g
;

128 
	gsÚy_disc_chªged
 = 1;

130 
	gsÚy_toc_»ad
 = 0;

132 
	gsÚy_¥un_up
 = 0;

133 
	gsÚy_bufãr_size
;

135 
	gsÚy_bufãr_£ùÜs
;

137 
	gsÚy_u§ge
 = 0;

140 vŞ©
	gsÚy_fœ¡_block
 = -1;

142 vŞ©
	gsÚy_Ï¡_block
 = -1;

145 
s_sÚy_toc
 *
	gsÚy_toc
;

147 
s_sÚy_subcode
 * vŞ©
	gÏ¡_sÚy_subcode
;

149 * vŞ©
	gsÚy_bufãr
;

152 vŞ©
	gsÚy_šu£
 = 0;

155 
wa™_queue
 * 
	gsÚy_wa™
 = 
NULL
;

157 
sk_¡ruù
 *
	ghas_cd_sk
 = 
NULL
;

164 vŞ©
	gsÚy_audio_¡©us
 = 
CDROM_AUDIO_NO_STATUS
;

173 vŞ©
	gcur_pos_msf
[3] = { 0, 0, 0 };

174 vŞ©
	gfš®_pos_msf
[3] = { 0, 0, 0 };

181 
	$check_cdu31a_medŸ_chªge
(
fuÎ_dev
, 
æag
)

183 
»tv®
, 
rg‘
;

186 
rg‘
 = 
	`MINOR
(
fuÎ_dev
);

188 ià(
rg‘
 > 0) {

189 
	`´štk
("Sony CD-ROM„equestƒrror: invalid device.\n");

193 
»tv®
 = 
sÚy_disc_chªged
;

194 ià(!
æag
)

196 
sÚy_disc_chªged
 = 0;

199  
»tv®
;

200 
	}
}

207 
šlše
 

208 
	$sÚy_¦“p
()

210 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

211 
cu¼’t
->
timeout
 = 
jiff›s
;

212 
	`scheduË
();

213 
	}
}

220 
šlše
 

221 
	$is_©‹ÁiÚ
()

223 ((
	`šb
(
sÚy_cd_¡©us_»g
è& 
SONY_ATTN_BIT
) != 0);

224 
	}
}

226 
šlše
 

227 
	$is_busy
()

229 ((
	`šb
(
sÚy_cd_¡©us_»g
è& 
SONY_BUSY_BIT
) != 0);

230 
	}
}

232 
šlše
 

233 
	$is_d©a_»ady
()

235 ((
	`šb
(
sÚy_cd_¡©us_»g
è& 
SONY_DATA_RDY_BIT
) != 0);

236 
	}
}

238 
šlše
 

239 
	$is_d©a_»que¡ed
()

241 ((
	`šb
(
sÚy_cd_¡©us_»g
è& 
SONY_DATA_REQUEST_BIT
) != 0);

242 
	}
}

244 
šlše
 

245 
	$is_»suÉ_»ady
()

247 ((
	`šb
(
sÚy_cd_¡©us_»g
è& 
SONY_RES_RDY_BIT
) != 0);

248 
	}
}

250 
šlše
 

251 
	$is_·¿m_wr™e_rdy
()

253 ((
	`šb
(
sÚy_cd_fifo¡_»g
è& 
SONY_PARAM_WRITE_RDY_BIT
) != 0);

254 
	}
}

256 
šlše
 

257 
	$»£t_drive
()

259 
	`outb
(
SONY_DRIVE_RESET_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

260 
	}
}

262 
šlše
 

263 
	$ş—r_©‹ÁiÚ
()

265 
	`outb
(
SONY_ATTN_CLR_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

266 
	}
}

268 
šlše
 

269 
	$ş—r_»suÉ_»ady
()

271 
	`outb
(
SONY_RES_RDY_CLR_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

272 
	}
}

274 
šlše
 

275 
	$ş—r_d©a_»ady
()

277 
	`outb
(
SONY_DATA_RDY_CLR_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

278 
	}
}

280 
šlše
 

281 
	$ş—r_·¿m_»g
()

283 
	`outb
(
SONY_PARAM_CLR_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

284 
	}
}

286 
šlše
 

287 
	$»ad_¡©us_»gi¡”
()

289 (
	`šb
(
sÚy_cd_¡©us_»g
));

290 
	}
}

292 
šlše
 

293 
	$»ad_»suÉ_»gi¡”
()

295 (
	`šb
(
sÚy_cd_»suÉ_»g
));

296 
	}
}

298 
šlše
 

299 
	$»ad_d©a_»gi¡”
()

301 (
	`šb
(
sÚy_cd_»ad_»g
));

302 
	}
}

304 
šlše
 

305 
	$wr™e_·¿m
(
·¿m
)

307 
	`outb
(
·¿m
, 
sÚy_cd_·¿m_»g
);

308 
	}
}

310 
šlše
 

311 
	$wr™e_cmd
(
cmd
)

313 
	`outb
(
cmd
, 
sÚy_cd_cmd_»g
);

314 
	`outb
(
SONY_RES_RDY_INT_EN_BIT
, 
sÚy_cd_cÚŒŞ_»g
);

315 
	}
}

322 
	$£t_drive_·¿ms
()

324 
»s_»g
[2];

325 
»s_size
;

326 
·¿ms
[3];

329 
·¿ms
[0] = 
SONY_SD_MECH_CONTROL
;

330 
·¿ms
[1] = 0x03;

331 
	`do_sÚy_cd_cmd
(
SONY_SET_DRIVE_PARAM_CMD
,

332 
·¿ms
,

334 
»s_»g
,

335 &
»s_size
);

336 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

338 
	`´štk
(" UÇbËØ£ˆmechªiÿÈ·¿m‘”s: 0x%2.2x\n", 
»s_»g
[1]);

340 
	}
}

346 
	$»¡¬t_Ú_”rÜ
()

348 
»s_»g
[2];

349 
»s_size
;

350 
»Œy_couÁ
;

353 
	`´štk
("cdu31a: Resetting drive onƒrror\n");

354 
	`»£t_drive
();

355 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_RESET_TIMEOUT
;

356 (
»Œy_couÁ
 > 
jiff›s
è&& (!
	`is_©‹ÁiÚ
()))

358 
	`sÚy_¦“p
();

360 
	`£t_drive_·¿ms
();

361 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

362 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

364 
	`´štk
("cdu31a: UÇbËØ¥š u°drive: 0x%2.2x\n", 
»s_»g
[1]);

367 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

368 
cu¼’t
->
timeout
 = 
jiff›s
 + 200;

369 
	`scheduË
();

371 
	`do_sÚy_cd_cmd
(
SONY_READ_TOC_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

372 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

374 
	`´štk
("cdu31a: UÇbËØ»ad TOC: 0x%2.2x\n", 
»s_»g
[1]);

376 
	`sÚy_g‘_toc
();

377 ià(!
sÚy_toc_»ad
)

379 
	`´štk
("cdu31a: Unableo get TOC data\n");

381 
	}
}

388 
	$wr™e_·¿ms
(*
·¿ms
,

389 
num_·¿ms
)

391 
»Œy_couÁ
;

394 
»Œy_couÁ
 = 
SONY_READY_RETRIES
;

395 (
»Œy_couÁ
 > 0è&& (!
	`is_·¿m_wr™e_rdy
()))

397 
»Œy_couÁ
--;

399 ià(!
	`is_·¿m_wr™e_rdy
())

401  -
EIO
;

404 
num_·¿ms
 > 0)

406 
	`wr™e_·¿m
(*
·¿ms
);

407 
·¿ms
++;

408 
num_·¿ms
--;

412 
	}
}

422 
	$g‘_»suÉ
(*
»suÉ_bufãr
,

423 *
»suÉ_size
)

425 
a
, 
b
;

426 
i
;

427 
»Œy_couÁ
;

430 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

433 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_JIFFIES_TIMEOUT
;

434 (
»Œy_couÁ
 > 
jiff›s
è&& (
	`is_busy
(è|| (!(
	`is_»suÉ_»ady
()))))

436 
	`sÚy_¦“p
();

438 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

441 ià(
	`is_busy
(è|| (!(
	`is_»suÉ_»ady
())))

443 
»suÉ_bufãr
[0] = 0x20;

444 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

445 *
»suÉ_size
 = 2;

453 
	`ş—r_»suÉ_»ady
();

454 
a
 = 
	`»ad_»suÉ_»gi¡”
();

455 *
»suÉ_bufãr
 = 
a
;

456 
»suÉ_bufãr
++;

457 
b
 = 
	`»ad_»suÉ_»gi¡”
();

458 *
»suÉ_bufãr
 = 
b
;

459 
»suÉ_bufãr
++;

460 *
»suÉ_size
 = 2;

470 ià((
a
 & 0xf0) != 0x20)

472 ià(
b
 > 8)

474 
i
=0; i<8; i++)

476 *
»suÉ_bufãr
 = 
	`»ad_»suÉ_»gi¡”
();

477 
»suÉ_bufãr
++;

478 (*
»suÉ_size
)++;

480 
b
 = b - 8;

482 
b
 > 10)

484 
»Œy_couÁ
 = 
SONY_READY_RETRIES
;

485 (
»Œy_couÁ
 > 0è&& (!
	`is_»suÉ_»ady
()))

487 
»Œy_couÁ
--;

489 ià(!
	`is_»suÉ_»ady
())

491 
»suÉ_bufãr
[0] = 0x20;

492 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

493 *
»suÉ_size
 = 2;

497 
	`ş—r_»suÉ_»ady
();

499 
i
=0; i<10; i++)

501 *
»suÉ_bufãr
 = 
	`»ad_»suÉ_»gi¡”
();

502 
»suÉ_bufãr
++;

503 (*
»suÉ_size
)++;

505 
b
 = b - 10;

508 ià(
b
 > 0)

510 
»Œy_couÁ
 = 
SONY_READY_RETRIES
;

511 (
»Œy_couÁ
 > 0è&& (!
	`is_»suÉ_»ady
()))

513 
»Œy_couÁ
--;

515 ià(!
	`is_»suÉ_»ady
())

517 
»suÉ_bufãr
[0] = 0x20;

518 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

519 *
»suÉ_size
 = 2;

525 
b
 > 0)

527 *
»suÉ_bufãr
 = 
	`»ad_»suÉ_»gi¡”
();

528 
»suÉ_bufãr
++;

529 (*
»suÉ_size
)++;

530 
b
--;

533 
	}
}

539 
	$»ad_d©a_block
(*
d©a
,

540 *
»suÉ_bufãr
,

541 *
»suÉ_size
)

543 
i
;

544 
»Œy_couÁ
;

546 
i
=0; i<2048; i++)

548 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_JIFFIES_TIMEOUT
;

549 (
»Œy_couÁ
 > 
jiff›s
è&& (!
	`is_d©a_»que¡ed
()))

551 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

554 
	`sÚy_¦“p
();

556 ià(!
	`is_d©a_»que¡ed
())

558 
»suÉ_bufãr
[0] = 0x20;

559 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

560 *
»suÉ_size
 = 2;

564 *
d©a
 = 
	`»ad_d©a_»gi¡”
();

565 
d©a
++;

567 
	}
}

583 
	$g‘_d©a
(*
Üig_d©a
,

584 *
·¿ms
,

586 
Üig_d©a_size
,

587 *
»suÉ_bufãr
,

588 *
»suÉ_size
)

590 
cur_off£t
;

591 
»Œy_couÁ
;

592 
»suÉ_»ad
;

593 
num_»Œ›s
;

594 
num_£ùÜs_»ad
 = 0;

595 *
d©a
 = 
Üig_d©a
;

596 
d©a_size
 = 
Üig_d©a_size
;

599 
	`şi
();

600 
sÚy_šu£
)

602 
	`š‹¼u±ibË_¦“p_Ú
(&
sÚy_wa™
);

603 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

605 
»suÉ_bufãr
[0] = 0x20;

606 
»suÉ_bufãr
[1] = 
SONY_SIGNAL_OP_ERR
;

607 *
»suÉ_size
 = 2;

611 
sÚy_šu£
 = 1;

612 
has_cd_sk
 = 
cu¼’t
;

613 
	`¡i
();

615 
num_»Œ›s
 = 0;

616 
»Œy_d©a_İ”©iÚ
:

617 
»suÉ_bufãr
[0] = 0;

618 
»suÉ_bufãr
[1] = 0;

624 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

627 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_JIFFIES_TIMEOUT
;

628 (
»Œy_couÁ
 > 
jiff›s
è&& (
	`is_busy
()))

630 
	`sÚy_¦“p
();

632 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

636 ià(
	`is_busy
())

638 
»suÉ_bufãr
[0] = 0x20;

639 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

640 *
»suÉ_size
 = 2;

645 
	`ş—r_»suÉ_»ady
();

646 
	`ş—r_·¿m_»g
();

648 
	`wr™e_·¿ms
(
·¿ms
, 6);

649 
	`wr™e_cmd
(
SONY_READ_CMD
);

656 
cur_off£t
 = 0;

657 
»suÉ_»ad
 = 0;

658 (
d©a_size
 > 0è&& (
»suÉ_bufãr
[0] == 0))

661 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_JIFFIES_TIMEOUT
;

662 (
»Œy_couÁ
 > 
jiff›s
è&& (!(
	`is_»suÉ_»ady
(è|| 
	`is_d©a_»ady
())))

664 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

667 
	`sÚy_¦“p
();

669 ià(!(
	`is_»suÉ_»ady
(è|| 
	`is_d©a_»ady
()))

671 
»suÉ_bufãr
[0] = 0x20;

672 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

673 *
»suÉ_size
 = 2;

677 ià(
	`is_»suÉ_»ady
())

679 
»suÉ_»ad
 = 1;

680 
	`g‘_»suÉ
(
»suÉ_bufãr
, 
»suÉ_size
);

688 
	`ş—r_d©a_»ady
();

689 
	`»ad_d©a_block
(
d©a
, 
»suÉ_bufãr
, 
»suÉ_size
);

690 
d©a
 += 2048;

691 
d©a_size
 -= 2048;

692 
cur_off£t
 = cur_offset + 2048;

693 
num_£ùÜs_»ad
++;

698 ià(!
»suÉ_»ad
)

700 
	`g‘_»suÉ
(
»suÉ_bufãr
, 
»suÉ_size
);

704 iàĞ((
»suÉ_bufãr
[0] & 0x20) == 0x20)

705 && (
»suÉ_bufãr
[1] !ğ
SONY_NOT_SPIN_ERR
)

706 && (
num_»Œ›s
 < 
MAX_CDU31A_RETRIES
))

715 
d©a_size
 = 2048;

716 
d©a
 = 
Üig_d©a
;

717 
num_£ùÜs_»ad
 = 0;

718 
	`size_to_buf
(1, &
·¿ms
[3]);

720 
num_»Œ›s
++;

722 ià(
num_»Œ›s
 == 2)

724 
	`»¡¬t_Ú_”rÜ
();

728 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

729 
cu¼’t
->
timeout
 = 
jiff›s
 + 10;

730 
	`scheduË
();

734 
»Œy_d©a_İ”©iÚ
;

737 
has_cd_sk
 = 
NULL
;

738 
sÚy_šu£
 = 0;

739 
	`wake_up_š‹¼u±ibË
(&
sÚy_wa™
);

741 (
num_£ùÜs_»ad
);

742 
	}
}

751 
	$do_sÚy_cd_cmd
(
cmd
,

752 *
·¿ms
,

753 
num_·¿ms
,

754 *
»suÉ_bufãr
,

755 *
»suÉ_size
)

757 
»Œy_couÁ
;

758 
num_»Œ›s
;

759 
»cursive_ÿÎ
;

762 
	`şi
();

763 ià(
cu¼’t
 !ğ
has_cd_sk
)

765 
sÚy_šu£
)

767 
	`š‹¼u±ibË_¦“p_Ú
(&
sÚy_wa™
);

768 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

770 
»suÉ_bufãr
[0] = 0x20;

771 
»suÉ_bufãr
[1] = 
SONY_SIGNAL_OP_ERR
;

772 *
»suÉ_size
 = 2;

776 
sÚy_šu£
 = 1;

777 
has_cd_sk
 = 
cu¼’t
;

778 
»cursive_ÿÎ
 = 0;

782 
»cursive_ÿÎ
 = 1;

784 
	`¡i
();

786 
num_»Œ›s
 = 0;

787 
»Œy_cd_İ”©iÚ
:

789 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

792 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_JIFFIES_TIMEOUT
;

793 (
»Œy_couÁ
 > 
jiff›s
è&& (
	`is_busy
()))

795 
	`sÚy_¦“p
();

797 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

800 ià(
	`is_busy
())

802 
»suÉ_bufãr
[0] = 0x20;

803 
»suÉ_bufãr
[1] = 
SONY_TIMEOUT_OP_ERR
;

804 *
»suÉ_size
 = 2;

808 
	`ş—r_»suÉ_»ady
();

809 
	`ş—r_·¿m_»g
();

811 
	`wr™e_·¿ms
(
·¿ms
, 
num_·¿ms
);

812 
	`wr™e_cmd
(
cmd
);

814 
	`g‘_»suÉ
(
»suÉ_bufãr
, 
»suÉ_size
);

817 iàĞ((
»suÉ_bufãr
[0] & 0x20) == 0x20)

818 && (
num_»Œ›s
 < 
MAX_CDU31A_RETRIES
))

820 
num_»Œ›s
++;

821 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

822 
cu¼’t
->
timeout
 = 
jiff›s
 + 10;

823 
	`scheduË
();

824 
»Œy_cd_İ”©iÚ
;

827 ià(!
»cursive_ÿÎ
)

829 
has_cd_sk
 = 
NULL
;

830 
sÚy_šu£
 = 0;

831 
	`wake_up_š‹¼u±ibË
(&
sÚy_wa™
);

833 
	}
}

846 
	$hªdË_sÚy_cd_©‹ÁiÚ
()

848 
©‹n_code
;

849 
num_cÚ£cutive_©‹ÁiÚs
 = 0;

852 ià(
	`is_©‹ÁiÚ
())

854 ià(
num_cÚ£cutive_©‹ÁiÚs
 > 
CDU31A_MAX_CONSECUTIVE_ATTENTIONS
)

856 
	`´štk
("cdu31a: Too many consecutive‡ttentions: %d\n",

857 
num_cÚ£cutive_©‹ÁiÚs
);

858 
num_cÚ£cutive_©‹ÁiÚs
 = 0;

862 
	`ş—r_©‹ÁiÚ
();

863 
©‹n_code
 = 
	`»ad_»suÉ_»gi¡”
();

865 
©‹n_code
)

868 
SONY_MECH_LOADED_ATTN
:

869 
sÚy_disc_chªged
 = 1;

870 
sÚy_toc_»ad
 = 0;

871 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_NO_STATUS
;

872 
sÚy_fœ¡_block
 = -1;

873 
sÚy_Ï¡_block
 = -1;

876 
SONY_AUDIO_PLAY_DONE_ATTN
:

877 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_COMPLETED
;

878 
	`»ad_subcode
();

881 
SONY_EJECT_PUSHED_ATTN
:

882 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_INVALID
;

885 
SONY_LEAD_IN_ERR_ATTN
:

886 
SONY_LEAD_OUT_ERR_ATTN
:

887 
SONY_DATA_TRACK_ERR_ATTN
:

888 
SONY_AUDIO_PLAYBACK_ERR_ATTN
:

889 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_ERROR
;

893 
num_cÚ£cutive_©‹ÁiÚs
++;

897 
num_cÚ£cutive_©‹ÁiÚs
 = 0;

899 
	}
}

903 
šlše
 

904 
	$št_to_bcd
(
v®
)

906 
»tv®
;

909 
»tv®
 = (
v®
 / 10) << 4;

910 
»tv®
 =„‘v® | 
v®
 % 10;

911 (
»tv®
);

912 
	}
}

917 
	$bcd_to_št
(
bcd
)

919 ((((
bcd
 >> 4) & 0x0f) * 10) + (bcd & 0x0f));

920 
	}
}

928 
	$log_to_msf
(
log
, *
msf
)

930 
log
 =†og + 
LOG_START_OFFSET
;

931 
msf
[0] = 
	`št_to_bcd
(
log
 / 4500);

932 
log
 =†og % 4500;

933 
msf
[1] = 
	`št_to_bcd
(
log
 / 75);

934 
msf
[2] = 
	`št_to_bcd
(
log
 % 75);

935 
	}
}

942 
	$msf_to_log
(*
msf
)

944 
log
;

947 
log
 = 
	`bcd_to_št
(
msf
[2]);

948 
log
 +ğ
	`bcd_to_št
(
msf
[1]) * 75;

949 
log
 +ğ
	`bcd_to_št
(
msf
[0]) * 4500;

950 
log
 =†og - 
LOG_START_OFFSET
;

952  
log
;

953 
	}
}

961 
	$size_to_buf
(
size
,

962 *
buf
)

964 
buf
[0] = 
size
 / 65536;

965 
size
 = size % 65536;

966 
buf
[1] = 
size
 / 256;

967 
buf
[2] = 
size
 % 256;

968 
	}
}

979 
	$do_cdu31a_»que¡
()

981 
block
;

982 
dev
;

983 
n£ù
;

984 
·¿ms
[10];

985 
»s_»g
[2];

986 
»s_size
;

987 
cİyoff
;

988 
¥š_up_»Œy
;

989 
»ad_size
;

992 ià(!
sÚy_¥un_up
)

994 
	`scd_İ’
 (
NULL
,NULL);

999 
cdu31a_»que¡_¡¬tov”
:

1004 ià(!(
CURRENT
è|| CURRENT->
dev
 < 0)

1009 
INIT_REQUEST
;

1010 
dev
 = 
	`MINOR
(
CURRENT
->dev);

1011 
block
 = 
CURRENT
->
£ùÜ
;

1012 
n£ù
 = 
CURRENT
->
Ä_£ùÜs
;

1013 ià(
dev
 != 0)

1015 
	`’d_»que¡
(0);

1016 
cdu31a_»que¡_¡¬tov”
;

1019 
CURRENT
->
cmd
)

1021 
READ
:

1026 ià((
block
 / 4è>ğ
sÚy_toc
->
Ëad_out_¡¬t_lba
)

1028 
	`’d_»que¡
(0);

1029 
cdu31a_»que¡_¡¬tov”
;

1031 ià(((
block
 + 
n£ù
è/ 4è>ğ
sÚy_toc
->
Ëad_out_¡¬t_lba
)

1033 
	`’d_»que¡
(0);

1034 
cdu31a_»que¡_¡¬tov”
;

1037 
n£ù
 > 0)

1043 ià((
block
 < 
sÚy_fœ¡_block
è|| (block > 
sÚy_Ï¡_block
))

1045 
sÚy_fœ¡_block
 = (
block
 / 4) * 4;

1046 
	`log_to_msf
(
block
/4, 
·¿ms
);

1052 ià(((
block
 / 4è+ 
sÚy_bufãr_£ùÜs
è>ğ
sÚy_toc
->
Ëad_out_¡¬t_lba
)

1054 
»ad_size
 = 
sÚy_toc
->
Ëad_out_¡¬t_lba
 - (
block
 / 4);

1058 
»ad_size
 = 
sÚy_bufãr_£ùÜs
;

1060 
	`size_to_buf
(
»ad_size
, &
·¿ms
[3]);

1066 
¥š_up_»Œy
 = 0;

1067 
Œy_»ad_agaš
:

1068 
sÚy_Ï¡_block
 = 
sÚy_fœ¡_block


1069 + (
	`g‘_d©a
(
sÚy_bufãr
,

1070 
·¿ms
,

1071 (
»ad_size
 * 2048),

1072 
»s_»g
,

1073 &
»s_size
) * 4) - 1;

1074 ià((
»s_size
 < 2è|| (
»s_»g
[0] != 0))

1076 ià((
»s_»g
[1] =ğ
SONY_NOT_SPIN_ERR
è&& (!
¥š_up_»Œy
))

1078 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1079 
¥š_up_»Œy
 = 1;

1080 
Œy_»ad_agaš
;

1083 
	`´štk
("SÚy CDROM R—dƒ¼Ü: 0x%2.2x\n", 
»s_»g
[1]);

1084 
sÚy_fœ¡_block
 = -1;

1085 
sÚy_Ï¡_block
 = -1;

1086 
	`’d_»que¡
(0);

1087 
cdu31a_»que¡_¡¬tov”
;

1095 
cİyoff
 = (
block
 - 
sÚy_fœ¡_block
) * 512;

1096 
	`memıy
(
CURRENT
->
bufãr
, 
sÚy_bufãr
+
cİyoff
, 512);

1098 
block
 += 1;

1099 
n£ù
 -= 1;

1100 
CURRENT
->
bufãr
 += 512;

1103 
	`’d_»que¡
(1);

1106 
WRITE
:

1107 
	`’d_»que¡
(0);

1111 
	`·nic
("Unkown SONY CD cmd");

1114 
	}
}

1122 
	$sÚy_g‘_toc
()

1124 
»s_size
;

1127 ià(!
sÚy_toc_»ad
)

1129 
	`do_sÚy_cd_cmd
(
SONY_REQ_TOC_DATA_CMD
,

1130 
NULL
,

1132 (*è
sÚy_toc
,

1133 &
»s_size
);

1134 ià((
»s_size
 < 2è|| ((
sÚy_toc
->
exec_¡©us
[0] & 0x20) == 0x20))

1138 
sÚy_toc
->
Ëad_out_¡¬t_lba
 = 
	`msf_to_log
(sÚy_toc->
Ëad_out_¡¬t_msf
);

1139 
sÚy_toc_»ad
 = 1;

1141 
	}
}

1148 
	$fšd_Œack
(
Œack
)

1150 
i
;

1151 
num_Œacks
;

1154 
num_Œacks
 = 
sÚy_toc
->
Ï¡_Œack_num
 + sÚy_toc->
fœ¡_Œack_num
 + 1;

1155 
i
 = 0; i < 
num_Œacks
; i++)

1157 ià(
sÚy_toc
->
Œacks
[
i
].
Œack
 ==rack)

1159  
i
;

1164 
	}
}

1171 
	$»ad_subcode
()

1173 
»s_size
;

1176 
	`do_sÚy_cd_cmd
(
SONY_REQ_SUBCODE_ADDRESS_CMD
,

1177 
NULL
,

1179 (*è
Ï¡_sÚy_subcode
,

1180 &
»s_size
);

1181 ià((
»s_size
 < 2è|| ((
Ï¡_sÚy_subcode
->
exec_¡©us
[0] & 0x20) == 0x20))

1183 
	`´štk
("Sony CDROMƒrror 0x%2.2x (read_subcode)\n",

1184 
Ï¡_sÚy_subcode
->
exec_¡©us
[1]);

1185  -
EIO
;

1189 
	}
}

1200 
	$sÚy_g‘_subchÆ_šfo
(
¬g
)

1202 
cdrom_subchÆ
 
schi
;

1206 
	`hªdË_sÚy_cd_©‹ÁiÚ
())

1209 
	`sÚy_g‘_toc
();

1210 ià(!
sÚy_toc_»ad
)

1212  -
EIO
;

1215 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
schi
));

1216 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, (
schi
));

1218 
	`memıy_äomfs
(&
schi
, (*è
¬g
, (schi));

1220 
sÚy_audio_¡©us
)

1222 
CDROM_AUDIO_PLAY
:

1223 ià(
	`»ad_subcode
() < 0)

1225  -
EIO
;

1229 
CDROM_AUDIO_PAUSED
:

1230 
CDROM_AUDIO_COMPLETED
:

1233 
CDROM_AUDIO_NO_STATUS
:

1234 
schi
.
cdsc_audio¡©us
 = 
sÚy_audio_¡©us
;

1235 
	`memıy_tofs
((*è
¬g
, &
schi
, (schi));

1239 
CDROM_AUDIO_INVALID
:

1240 
CDROM_AUDIO_ERROR
:

1242  -
EIO
;

1245 
schi
.
cdsc_audio¡©us
 = 
sÚy_audio_¡©us
;

1246 
schi
.
cdsc_adr
 = 
Ï¡_sÚy_subcode
->
add»ss
;

1247 
schi
.
cdsc_ù¾
 = 
Ï¡_sÚy_subcode
->
cÚŒŞ
;

1248 
schi
.
cdsc_Œk
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
Œack_num
);

1249 
schi
.
cdsc_šd
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
šdex_num
);

1250 ià(
schi
.
cdsc_fÜm©
 =ğ
CDROM_MSF
)

1252 
schi
.
cdsc_ab§ddr
.
msf
.
mšu‹
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
abs_msf
[0]);

1253 
schi
.
cdsc_ab§ddr
.
msf
.
£cÚd
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
abs_msf
[1]);

1254 
schi
.
cdsc_ab§ddr
.
msf
.
äame
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
abs_msf
[2]);

1256 
schi
.
cdsc_»Ïddr
.
msf
.
mšu‹
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
»l_msf
[0]);

1257 
schi
.
cdsc_»Ïddr
.
msf
.
£cÚd
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
»l_msf
[1]);

1258 
schi
.
cdsc_»Ïddr
.
msf
.
äame
 = 
	`bcd_to_št
(
Ï¡_sÚy_subcode
->
»l_msf
[2]);

1260 ià(
schi
.
cdsc_fÜm©
 =ğ
CDROM_LBA
)

1262 
schi
.
cdsc_ab§ddr
.
lba
 = 
	`msf_to_log
(
Ï¡_sÚy_subcode
->
abs_msf
);

1263 
schi
.
cdsc_»Ïddr
.
lba
 = 
	`msf_to_log
(
Ï¡_sÚy_subcode
->
»l_msf
);

1266 
	`memıy_tofs
((*è
¬g
, &
schi
, (schi));

1268 
	}
}

1275 
	$scd_ioùl
(
šode
 *inode,

1276 
fe
 *file,

1277 
cmd
,

1278 
¬g
)

1280 
dev
;

1281 
»s_»g
[2];

1282 
»s_size
;

1283 
·¿ms
[7];

1284 
i
;

1287 ià(!
šode
)

1289  -
EINVAL
;

1291 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) >> 6;

1292 ià(
dev
 != 0)

1294  -
EINVAL
;

1297 
cmd
)

1299 
CDROMSTART
:

1300 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1301 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1303 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMSTART)\n", 
»s_»g
[1]);

1304  -
EIO
;

1309 
CDROMSTOP
:

1310 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_STOP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1316 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_NO_STATUS
;

1317 
	`do_sÚy_cd_cmd
(
SONY_SPIN_DOWN_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1318 iàĞ((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1319 && (
»s_»g
[1] !ğ
SONY_NOT_SPIN_ERR
))

1321 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMSTOP)\n", 
»s_»g
[1]);

1322  -
EIO
;

1328 
CDROMPAUSE
:

1329 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_STOP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1330 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1332 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMPAUSE)\n", 
»s_»g
[1]);

1333  -
EIO
;

1337 ià(
	`»ad_subcode
() < 0)

1339  -
EIO
;

1341 
cur_pos_msf
[0] = 
Ï¡_sÚy_subcode
->
abs_msf
[0];

1342 
cur_pos_msf
[1] = 
Ï¡_sÚy_subcode
->
abs_msf
[1];

1343 
cur_pos_msf
[2] = 
Ï¡_sÚy_subcode
->
abs_msf
[2];

1344 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_PAUSED
;

1348 
CDROMRESUME
:

1349 ià(
sÚy_audio_¡©us
 !ğ
CDROM_AUDIO_PAUSED
)

1351  -
EINVAL
;

1354 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1357 
·¿ms
[1] = 
cur_pos_msf
[0];

1358 
·¿ms
[2] = 
cur_pos_msf
[1];

1359 
·¿ms
[3] = 
cur_pos_msf
[2];

1360 
·¿ms
[4] = 
fš®_pos_msf
[0];

1361 
·¿ms
[5] = 
fš®_pos_msf
[1];

1362 
·¿ms
[6] = 
fš®_pos_msf
[2];

1363 
·¿ms
[0] = 0x03;

1364 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_PLAYBACK_CMD
, 
·¿ms
, 7, 
»s_»g
, &
»s_size
);

1365 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1367 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMRESUME)\n", 
»s_»g
[1]);

1368  -
EIO
;

1370 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_PLAY
;

1374 
CDROMPLAYMSF
:

1375 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, 6);

1376 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1377 
	`memıy_äomfs
(&(
·¿ms
[1]), (*è
¬g
, 6);

1380 
i
=1; i<7; i++)

1382 
·¿ms
[
i
] = 
	`št_to_bcd
(params[i]);

1384 
·¿ms
[0] = 0x03;

1385 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_PLAYBACK_CMD
, 
·¿ms
, 7, 
»s_»g
, &
»s_size
);

1386 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1388 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMPLAYMSF)\n", 
»s_»g
[1]);

1389  -
EIO
;

1393 
fš®_pos_msf
[0] = 
·¿ms
[4];

1394 
fš®_pos_msf
[1] = 
·¿ms
[5];

1395 
fš®_pos_msf
[2] = 
·¿ms
[6];

1396 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_PLAY
;

1400 
CDROMREADTOCHDR
:

1402 
cdrom_tochdr
 *
hdr
;

1403 
cdrom_tochdr
 
loc_hdr
;

1405 
	`sÚy_g‘_toc
();

1406 ià(!
sÚy_toc_»ad
)

1408  -
EIO
;

1411 
hdr
 = (
cdrom_tochdr
 *è
¬g
;

1412 
	`v”ify_¬—
(
VERIFY_WRITE
, 
hdr
, (*hdr));

1413 
loc_hdr
.
cdth_Œk0
 = 
	`bcd_to_št
(
sÚy_toc
->
fœ¡_Œack_num
);

1414 
loc_hdr
.
cdth_Œk1
 = 
	`bcd_to_št
(
sÚy_toc
->
Ï¡_Œack_num
);

1415 
	`memıy_tofs
(
hdr
, &
loc_hdr
, (*hdr));

1420 
CDROMREADTOCENTRY
:

1422 
cdrom_toûÁry
 *
’Œy
;

1423 
cdrom_toûÁry
 
loc_’Œy
;

1424 
Œack_idx
;

1425 *
msf_v®
 = 
NULL
;

1427 
	`sÚy_g‘_toc
();

1428 ià(!
sÚy_toc_»ad
)

1430  -
EIO
;

1433 
’Œy
 = (
cdrom_toûÁry
 *è
¬g
;

1434 
	`v”ify_¬—
(
VERIFY_READ
, 
’Œy
, (*entry));

1435 
	`v”ify_¬—
(
VERIFY_WRITE
, 
’Œy
, (*entry));

1437 
	`memıy_äomfs
(&
loc_’Œy
, 
’Œy
, (loc_entry));

1440 ià(
loc_’Œy
.
cd‹_Œack
 =ğ
CDROM_LEADOUT
)

1442 
loc_’Œy
.
cd‹_adr
 = 
sÚy_toc
->
add»ss2
;

1443 
loc_’Œy
.
cd‹_ù¾
 = 
sÚy_toc
->
cÚŒŞ2
;

1444 
msf_v®
 = 
sÚy_toc
->
Ëad_out_¡¬t_msf
;

1448 
Œack_idx
 = 
	`fšd_Œack
(
	`št_to_bcd
(
loc_’Œy
.
cd‹_Œack
));

1449 ià(
Œack_idx
 < 0)

1451  -
EINVAL
;

1454 
loc_’Œy
.
cd‹_adr
 = 
sÚy_toc
->
Œacks
[
Œack_idx
].
add»ss
;

1455 
loc_’Œy
.
cd‹_ù¾
 = 
sÚy_toc
->
Œacks
[
Œack_idx
].
cÚŒŞ
;

1456 
msf_v®
 = 
sÚy_toc
->
Œacks
[
Œack_idx
].
Œack_¡¬t_msf
;

1460 ià(
loc_’Œy
.
cd‹_fÜm©
 =ğ
CDROM_LBA
)

1462 
loc_’Œy
.
cd‹_addr
.
lba
 = 
	`msf_to_log
(
msf_v®
);

1464 ià(
loc_’Œy
.
cd‹_fÜm©
 =ğ
CDROM_MSF
)

1466 
loc_’Œy
.
cd‹_addr
.
msf
.
mšu‹
 = 
	`bcd_to_št
(*
msf_v®
);

1467 
loc_’Œy
.
cd‹_addr
.
msf
.
£cÚd
 = 
	`bcd_to_št
(*(
msf_v®
+1));

1468 
loc_’Œy
.
cd‹_addr
.
msf
.
äame
 = 
	`bcd_to_št
(*(
msf_v®
+2));

1470 
	`memıy_tofs
(
’Œy
, &
loc_’Œy
, (*entry));

1475 
CDROMPLAYTRKIND
:

1477 
cdrom_ti
 
ti
;

1478 
Œack_idx
;

1480 
	`sÚy_g‘_toc
();

1481 ià(!
sÚy_toc_»ad
)

1483  -
EIO
;

1486 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
ti
));

1488 
	`memıy_äomfs
(&
ti
, (*è
¬g
, (ti));

1489 iàĞ(
ti
.
cdti_Œk0
 < 
sÚy_toc
->
fœ¡_Œack_num
)

1490 || (
ti
.
cdti_Œk0
 > 
sÚy_toc
->
Ï¡_Œack_num
)

1491 || (
ti
.
cdti_Œk1
 <i.
cdti_Œk0
))

1493  -
EINVAL
;

1496 
Œack_idx
 = 
	`fšd_Œack
(
	`št_to_bcd
(
ti
.
cdti_Œk0
));

1497 ià(
Œack_idx
 < 0)

1499  -
EINVAL
;

1501 
·¿ms
[1] = 
sÚy_toc
->
Œacks
[
Œack_idx
].
Œack_¡¬t_msf
[0];

1502 
·¿ms
[2] = 
sÚy_toc
->
Œacks
[
Œack_idx
].
Œack_¡¬t_msf
[1];

1503 
·¿ms
[3] = 
sÚy_toc
->
Œacks
[
Œack_idx
].
Œack_¡¬t_msf
[2];

1509 ià(
ti
.
cdti_Œk1
 >ğ
	`bcd_to_št
(
sÚy_toc
->
Ï¡_Œack_num
))

1511 
	`log_to_msf
(
	`msf_to_log
(
sÚy_toc
->
Ëad_out_¡¬t_msf
)-1,

1512 &(
·¿ms
[4]));

1516 
Œack_idx
 = 
	`fšd_Œack
(
	`št_to_bcd
(
ti
.
cdti_Œk1
+1));

1517 ià(
Œack_idx
 < 0)

1519  -
EINVAL
;

1521 
	`log_to_msf
(
	`msf_to_log
(
sÚy_toc
->
Œacks
[
Œack_idx
].
Œack_¡¬t_msf
)-1,

1522 &(
·¿ms
[4]));

1524 
·¿ms
[0] = 0x03;

1526 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1528 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_PLAYBACK_CMD
, 
·¿ms
, 7, 
»s_»g
, &
»s_size
);

1529 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1531 
	`´štk
("P¬ams: %x %x %x %x %x %x %x\n", 
·¿ms
[0],…arams[1],

1532 
·¿ms
[2],…arams[3],…arams[4],…arams[5],…arams[6]);

1533 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMPLAYTRKIND\n", 
»s_»g
[1]);

1534  -
EIO
;

1538 
fš®_pos_msf
[0] = 
·¿ms
[4];

1539 
fš®_pos_msf
[1] = 
·¿ms
[5];

1540 
fš®_pos_msf
[2] = 
·¿ms
[6];

1541 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_PLAY
;

1545 
CDROMSUBCHNL
:

1546  
	`sÚy_g‘_subchÆ_šfo
(
¬g
);

1548 
CDROMVOLCTRL
:

1550 
cdrom_vŞù¾
 
vŞù¾
;

1552 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
vŞù¾
));

1554 
	`memıy_äomfs
(&
vŞù¾
, (*è
¬g
, (volctrl));

1555 
·¿ms
[0] = 
SONY_SD_AUDIO_VOLUME
;

1556 
·¿ms
[1] = 
vŞù¾
.
chªÃl0
;

1557 
·¿ms
[2] = 
vŞù¾
.
chªÃl1
;

1558 
	`do_sÚy_cd_cmd
(
SONY_SET_DRIVE_PARAM_CMD
, 
·¿ms
, 3, 
»s_»g
, &
»s_size
);

1559 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1561 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMVOLCTRL)\n", 
»s_»g
[1]);

1562  -
EIO
;

1567 
CDROMEJECT
:

1568 
	`do_sÚy_cd_cmd
(
SONY_AUDIO_STOP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1569 
	`do_sÚy_cd_cmd
(
SONY_SPIN_DOWN_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1571 
sÚy_audio_¡©us
 = 
CDROM_AUDIO_INVALID
;

1572 
	`do_sÚy_cd_cmd
(
SONY_EJECT_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1573 ià((
»s_size
 < 2è|| ((
»s_»g
[0] & 0x20) == 0x20))

1575 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (CDROMEJECT)\n", 
»s_»g
[1]);

1576  -
EIO
;

1582  -
EINVAL
;

1584 
	}
}

1592 
	$scd_İ’
(
šode
 *inode,

1593 
fe
 *
fp
)

1595 
»s_»g
[2];

1596 
»s_size
;

1597 
num_¥š_ups
;

1600 ià(!
sÚy_¥un_up
)

1602 
num_¥š_ups
 = 0;

1604 
»¥šup_Ú_İ’
:

1605 
	`do_sÚy_cd_cmd
(
SONY_SPIN_UP_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1609 ià((
»s_size
 < 2è|| ((
»s_»g
[0] != 0) && (res_reg[1] != 0)))

1611 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (scd_İ’, spš up)\n", 
»s_»g
[1]);

1612  -
EIO
;

1615 
	`do_sÚy_cd_cmd
(
SONY_READ_TOC_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1619 ià((
»s_size
 < 2è|| ((
»s_»g
[0] != 0) && (res_reg[1] != 0)))

1622 ià((
»s_»g
[1] =ğ
SONY_AUDIO_PLAYING_ERR
) || (res_reg[1] == 0))

1624 
drive_¥šnšg
;

1629 iàĞ(
»s_»g
[1] =ğ
SONY_NOT_SPIN_ERR
)

1630 && (
num_¥š_ups
 < 
MAX_CDU31A_RETRIES
))

1632 
num_¥š_ups
++;

1633 
»¥šup_Ú_İ’
;

1636 
	`´štk
("SÚy CDROMƒ¼Ü 0x%2.2x (scd_İ’,„—doc)\n", 
»s_»g
[1]);

1637 
	`do_sÚy_cd_cmd
(
SONY_SPIN_DOWN_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1639  -
EIO
;

1642 
	`sÚy_g‘_toc
();

1643 ià(!
sÚy_toc_»ad
)

1645 
	`do_sÚy_cd_cmd
(
SONY_SPIN_DOWN_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1646  -
EIO
;

1649 
sÚy_¥un_up
 = 1;

1652 
drive_¥šnšg
:

1654 ià(
šode
)

1656 
	`check_disk_chªge
(
šode
->
i_rdev
);

1659 
sÚy_u§ge
++;

1662 
	}
}

1670 
	$scd_»Ëa£
(
šode
 *inode,

1671 
fe
 *
fp
)

1673 
»s_»g
[2];

1674 
»s_size
;

1677 ià(
sÚy_u§ge
 > 0)

1679 
sÚy_u§ge
--;

1681 ià(
sÚy_u§ge
 == 0)

1683 
	`sync_dev
(
šode
->
i_rdev
);

1684 
	`do_sÚy_cd_cmd
(
SONY_SPIN_DOWN_CMD
, 
NULL
, 0, 
»s_»g
, &
»s_size
);

1686 
sÚy_¥un_up
 = 0;

1688 
	}
}

1691 
fe_İ”©iÚs
 
	gscd_fİs
 = {

1692 
NULL
,

1693 
block_»ad
,

1694 
block_wr™e
,

1695 
NULL
,

1696 
NULL
,

1697 
scd_ioùl
,

1698 
NULL
,

1699 
scd_İ’
,

1700 
scd_»Ëa£
,

1701 
NULL


1706 *
	glßd_mech
[] = { "caddy", "tray", "pop-up", "unknown" };

1710 
	gmem_size
[] = { 16384, 16384, 16384, 2048 };

1713 
	$g‘_drive_cÚfigu¿tiÚ
(
ba£_io
,

1714 
»s_»g
[],

1715 *
»s_size
)

1717 
»Œy_couÁ
;

1721 
sÚy_cd_ba£_io
 = 
ba£_io
;

1724 
sÚy_cd_cmd_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_CMD_REG_OFFSET
;

1725 
sÚy_cd_·¿m_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_PARAM_REG_OFFSET
;

1726 
sÚy_cd_wr™e_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_WRITE_REG_OFFSET
;

1727 
sÚy_cd_cÚŒŞ_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_CONTROL_REG_OFFSET
;

1728 
sÚy_cd_¡©us_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_STATUS_REG_OFFSET
;

1729 
sÚy_cd_»suÉ_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_RESULT_REG_OFFSET
;

1730 
sÚy_cd_»ad_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_READ_REG_OFFSET
;

1731 
sÚy_cd_fifo¡_»g
 = 
sÚy_cd_ba£_io
 + 
SONY_FIFOST_REG_OFFSET
;

1738 ià(
	`»ad_¡©us_»gi¡”
() != 0xff)

1744 
	`»£t_drive
();

1745 
»Œy_couÁ
 = 
jiff›s
 + 
SONY_RESET_TIMEOUT
;

1746 (
»Œy_couÁ
 > 
jiff›s
è&& (!
	`is_©‹ÁiÚ
()))

1748 
	`sÚy_¦“p
();

1752 ià(!
	`is_©‹ÁiÚ
())

1754 
»s_»g
[0] = 0x20;

1761 
	`do_sÚy_cd_cmd
(
SONY_REQ_DRIVE_CONFIG_CMD
,

1762 
NULL
,

1764 (*è
»s_»g
,

1765 
»s_size
);

1770 
»s_»g
[0] = 0x20;

1771 
	}
}

1778 
	$cdu31a_š™
(
mem_¡¬t
, 
mem_’d
)

1780 
s_sÚy_drive_cÚfig
 
drive_cÚfig
;

1781 
»s_size
;

1782 
i
;

1783 
drive_found
;

1793 
	`outb
(0xbc, 0x9a01);

1794 
	`outb
(0xe2, 0x9a01);

1796 
i
 = 0;

1797 
drive_found
 = 0;

1798  (
cdu31a_add»s£s
[
i
] != 0)

1799 && (!
drive_found
))

1801 ià(
	`check_»giÚ
(
cdu31a_add»s£s
[
i
], 4)) {

1802 
i
++;

1805 
	`g‘_drive_cÚfigu¿tiÚ
(
cdu31a_add»s£s
[
i
],

1806 
drive_cÚfig
.
exec_¡©us
,

1807 &
»s_size
);

1808 ià((
»s_size
 > 2è&& ((
drive_cÚfig
.
exec_¡©us
[0] & 0x20) == 0x00))

1810 
drive_found
 = 1;

1811 
	`¢¬f_»giÚ
(
cdu31a_add»s£s
[
i
], 4);

1813 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"cdu31a",&
scd_fİs
))

1815 
	`´štk
("UÇbËØg‘ majÜ %d fÜ CDU-31a\n", 
MAJOR_NR
);

1816  
mem_¡¬t
;

1819 
sÚy_bufãr_size
 = 
mem_size
[
	`SONY_HWC_GET_BUF_MEM_SIZE
(
drive_cÚfig
)];

1820 
sÚy_bufãr_£ùÜs
 = 
sÚy_bufãr_size
 / 2048;

1822 
	`´štk
("Sony I/F CDROM : %8.8s %16.16s %8.8s with %s†oad mechanism\n",

1823 
drive_cÚfig
.
v’dÜ_id
,

1824 
drive_cÚfig
.
´oduù_id
,

1825 
drive_cÚfig
.
´oduù_»v_Ëv–
,

1826 
lßd_mech
[
	`SONY_HWC_GET_LOAD_MECH
(
drive_cÚfig
)]);

1827 
	`´štk
(" usšg %d by‹ bufãr", 
sÚy_bufãr_size
);

1828 ià(
	`SONY_HWC_AUDIO_PLAYBACK
(
drive_cÚfig
))

1830 
	`´štk
(", capable of‡udio…layback");

1832 
	`´štk
("\n");

1834 
	`£t_drive_·¿ms
();

1836 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

1837 
»ad_ah—d
[
MAJOR_NR
] = 8;

1839 
sÚy_toc
 = (
s_sÚy_toc
 *è
mem_¡¬t
;

1840 
mem_¡¬t
 +ğ(*
sÚy_toc
);

1841 
Ï¡_sÚy_subcode
 = (
s_sÚy_subcode
 *è
mem_¡¬t
;

1842 
mem_¡¬t
 +ğ(*
Ï¡_sÚy_subcode
);

1843 
sÚy_bufãr
 = (*è
mem_¡¬t
;

1844 
mem_¡¬t
 +ğ
sÚy_bufãr_size
;

1847 
i
++;

1850  
mem_¡¬t
;

1851 
	}
}

	@drivers/block/floppy.c

67 
	#REALLY_SLOW_IO


	)

68 
	#FLOPPY_IRQ
 6

	)

69 
	#FLOPPY_DMA
 2

	)

71 
	~<lšux/sched.h
>

72 
	~<lšux/fs.h
>

73 
	~<lšux/k”Ãl.h
>

74 
	~<lšux/tim”.h
>

75 
	~<lšux/fd»g.h
>

76 
	~<lšux/fd.h
>

77 
	~<lšux/”ºo.h
>

79 
	~<asm/dma.h
>

80 
	~<asm/sy¡em.h
>

81 
	~<asm/io.h
>

82 
	~<asm/£gm’t.h
>

84 
	#MAJOR_NR
 
FLOPPY_MAJOR


	)

85 
	~"blk.h
"

87 
	gchªged_æİp›s
 = 0, 
	gçke_chªge
 = 0;

89 
	gš™Ÿl_»£t_æag
 = 0;

90 
	gÃed_cÚfigu»
 = 1;

91 
	g»ÿlib¿‹
 = 0;

92 
	g»£t
 = 0;

93 
	g»cov”
 = 0;

94 
	g£ek
 = 0;

96 
	gcu¼’t_DOR
 = 0x0C;

97 
	gruÂšg
 = 0;

99 
	#TYPE
(
x
è((x)>>2)

	)

100 
	#DRIVE
(
x
è((x)&0x03)

	)

107 
	#MAX_ERRORS
 12

	)

113 
	#MAX_DISK_SIZE
 1440

	)

119 
	#MAX_BUFFER_SECTORS
 18

	)

129 
	#LAST_DMA_ADDR
 (0x100000 - 
BLOCK_SIZE
)

	)

134 
	#MAX_REPLIES
 7

	)

135 
	g»¶y_bufãr
[
MAX_REPLIES
];

136 
	#ST0
 (
»¶y_bufãr
[0])

	)

137 
	#ST1
 (
»¶y_bufãr
[1])

	)

138 
	#ST2
 (
»¶y_bufãr
[2])

	)

139 
	#ST3
 (
»¶y_bufãr
[3])

	)

148 
æİpy_¡ruù
 
	gæİpy_ty³
[] = {

149 { 0, 0,0, 0,0,0x00,0x00,0x00,0x00,
NULL
 },

150 { 720, 9,2,40,0,0x2A,0x02,0xDF,0x50,
NULL
 },

151 { 2400,15,2,80,0,0x1B,0x00,0xDF,0x54,
NULL
 },

152 { 720, 9,2,40,1,0x2A,0x02,0xDF,0x50,
NULL
 },

153 { 1440, 9,2,80,0,0x2A,0x02,0xDF,0x50,
NULL
 },

154 { 720, 9,2,40,1,0x23,0x01,0xDF,0x50,
NULL
 },

155 { 1440, 9,2,80,0,0x23,0x01,0xDF,0x50,
NULL
 },

156 { 2880,18,2,80,0,0x1B,0x00,0xCF,0x6C,
NULL
 },

164 
æİpy_¡ruù
 
	gæİpy_ty³s
[] = {

176 
æİpy_¡ruù
 *
	gcu¼’t_ty³
[4] = { 
NULL
, NULL, NULL, NULL };

179 
æİpy_¡ruù
 *
	gba£_ty³
[4];

185 
æİpy_¡ruù
 
	gu£r_·¿ms
[4];

187 
	gæİpy_sizes
[] ={

188 
MAX_DISK_SIZE
, MAX_DISK_SIZE, MAX_DISK_SIZE, MAX_DISK_SIZE,

203 
	g´obšg
 = 0;

210 
	gk“p_d©a
[4] = { 0,0,0,0 };

217 
	gád_msg
[4] = { 0,0,0,0 };

221 
	gfd_»f
[4] = { 0,0,0,0 };

222 
	gfd_deviû
[4] = { 0,0,0,0 };

225 vŞ©
	gfÜm©_¡©us
 = 
FORMAT_NONE
, 
	gfdc_busy
 = 0;

226 
wa™_queue
 *
	gfdc_wa™
 = 
NULL
, *
	gfÜm©_dÚe
 = NULL;

229 
	gfÜm©_”rÜs
;

232 
fÜm©_desü
 
	gfÜm©_»q
;

238 
	#CURRENT_DEVICE
 (
fÜm©_¡©us
 =ğ
FORMAT_BUSY
 ? 
fÜm©_»q
.
deviû
 : \

239 (
CURRENT
->
dev
))

	)

242 
	#CURRENT_ERRORS
 (
fÜm©_¡©us
 =ğ
FORMAT_BUSY
 ? 
fÜm©_”rÜs
 : \

243 (
CURRENT
->
”rÜs
))

	)

250 
	gmš_»pÜt_”rÜ_út
[4] = {2, 2, 2, 2};

268 
tmp_æİpy_¬—
[
BLOCK_SIZE
];

269 
æİpy_Œack_bufãr
[512*2*
MAX_BUFFER_SECTORS
];

271 
»do_fd_»que¡
();

278 
	#NO_TRACK
 255

	)

280 
	g»ad_Œack
 = 0;

281 
	gbufãr_Œack
 = -1;

282 
	gbufãr_drive
 = -1;

283 
	gcur_¥ec1
 = -1;

284 
	gcur_¿‹
 = -1;

285 
æİpy_¡ruù
 * 
	gæİpy
 = 
æİpy_ty³
;

286 
	gcu¼’t_drive
 = 255;

287 
	g£ùÜ
 = 0;

288 
	gh—d
 = 0;

289 
	gŒack
 = 0;

290 
	g£ek_Œack
 = 0;

291 
	gcu¼’t_Œack
 = 
NO_TRACK
;

292 
	gcommªd
 = 0;

293 
	gfdc_v”siÚ
 = 
FDC_TYPE_STD
;

295 
æİpy_»ady
();

297 
	$£Ëù_ÿÎback
(
unu£d
)

299 
	`æİpy_»ady
();

300 
	}
}

302 
	$æİpy_£Ëù
(
Ä
)

304 
tim”_li¡
 
£Ëù
 = { 
NULL
, NULL, 0, 0, 
£Ëù_ÿÎback
 };

306 ià(
cu¼’t_drive
 =ğ(
cu¼’t_DOR
 & 3)) {

307 
	`æİpy_»ady
();

310 
£ek
 = 1;

311 
cu¼’t_Œack
 = 
NO_TRACK
;

312 
cu¼’t_DOR
 &= 0xFC;

313 
cu¼’t_DOR
 |ğ
cu¼’t_drive
;

314 
	`outb
(
cu¼’t_DOR
,
FD_DOR
);

315 
	`d–_tim”
(&
£Ëù
);

316 
£Ëù
.
expœes
 = 2;

317 
	`add_tim”
(&
£Ëù
);

318 
	}
}

320 
	$mÙÜ_Ú_ÿÎback
(
Ä
)

322 
ruÂšg
 |ğ0x10 << 
Ä
;

323 
	`æİpy_£Ëù
(
Ä
);

324 
	}
}

326 
tim”_li¡
 
	gmÙÜ_Ú_tim”
[4] = {

327 { 
NULL
, NULL, 0, 0, 
mÙÜ_Ú_ÿÎback
 },

328 { 
NULL
, NULL, 0, 1, 
mÙÜ_Ú_ÿÎback
 },

329 { 
NULL
, NULL, 0, 2, 
mÙÜ_Ú_ÿÎback
 },

330 { 
NULL
, NULL, 0, 3, 
mÙÜ_Ú_ÿÎback
 }

333 
	$mÙÜ_off_ÿÎback
(
Ä
)

335 
mask
 = ~(0x10 << 
Ä
);

336 
	`şi
();

337 
ruÂšg
 &ğ
mask
;

338 
cu¼’t_DOR
 &ğ
mask
;

339 
	`outb
(
cu¼’t_DOR
,
FD_DOR
);

340 
	`¡i
();

341 
	}
}

343 
tim”_li¡
 
	gmÙÜ_off_tim”
[4] = {

344 { 
NULL
, NULL, 0, 0, 
mÙÜ_off_ÿÎback
 },

345 { 
NULL
, NULL, 0, 1, 
mÙÜ_off_ÿÎback
 },

346 { 
NULL
, NULL, 0, 2, 
mÙÜ_off_ÿÎback
 },

347 { 
NULL
, NULL, 0, 3, 
mÙÜ_off_ÿÎback
 }

350 
	$æİpy_Ú
(
Ä
)

352 
mask
 = 0x10 << 
Ä
;

354 
	`d–_tim”
(
mÙÜ_off_tim”
 + 
Ä
);

355 ià(
mask
 & 
ruÂšg
)

356 
	`æİpy_£Ëù
(
Ä
);

357 ià(!(
mask
 & 
cu¼’t_DOR
)) {

358 
	`d–_tim”
(
mÙÜ_Ú_tim”
 + 
Ä
);

359 
mÙÜ_Ú_tim”
[
Ä
].
expœes
 = 
HZ
;

360 
	`add_tim”
(
mÙÜ_Ú_tim”
 + 
Ä
);

362 
cu¼’t_DOR
 &= 0xFC;

363 
cu¼’t_DOR
 |ğ
mask
;

364 
cu¼’t_DOR
 |ğ
Ä
;

365 
	`outb
(
cu¼’t_DOR
,
FD_DOR
);

366 
	}
}

368 
	$æİpy_off
(
Ä
)

370 
	`d–_tim”
(
mÙÜ_off_tim”
+
Ä
);

371 
mÙÜ_off_tim”
[
Ä
].
expœes
 = 3*
HZ
;

372 
	`add_tim”
(
mÙÜ_off_tim”
+
Ä
);

373 
	}
}

375 
	$»que¡_dÚe
(
u±od©e
)

377 
tim”_aùive
 &ğ~(1 << 
FLOPPY_TIMER
);

378 ià(
fÜm©_¡©us
 !ğ
FORMAT_BUSY
)

379 
	`’d_»que¡
(
u±od©e
);

381 
fÜm©_¡©us
 = 
u±od©e
 ? 
FORMAT_OKAY
 : 
FORMAT_ERROR
;

382 
	`wake_up
(&
fÜm©_dÚe
);

384 
	}
}

392 
	$æİpy_chªge
(
bufãr_h—d
 * 
bh
)

394 
mask
 = 1 << (
bh
->
b_dev
 & 0x03);

396 ià(
	`MAJOR
(
bh
->
b_dev
è!ğ
MAJOR_NR
) {

397 
	`´štk
("floppy_changed:‚ot‡ floppy\n");

400 ià(
çke_chªge
 & 
mask
) {

401 
bufãr_Œack
 = -1;

402 
çke_chªge
 &ğ~
mask
;

404 
chªged_æİp›s
 &ğ~
mask
;

407 ià(
chªged_æİp›s
 & 
mask
) {

408 
bufãr_Œack
 = -1;

409 
chªged_æİp›s
 &ğ~
mask
;

410 
»ÿlib¿‹
 = 1;

413 ià(!
bh
)

415 ià(
bh
->
b_dœt
)

416 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

418 
bufãr_Œack
 = -1;

419 
bh
->
b_u±od©e
 = 0;

420 
	`Î_rw_block
(
READ
, 1, &
bh
);

422 
	`wa™_Ú_bufãr
(
bh
);

423 ià(
chªged_æİp›s
 & 
mask
) {

424 
chªged_æİp›s
 &ğ~
mask
;

425 
»ÿlib¿‹
 = 1;

429 
	}
}

431 
	#cİy_bufãr
(
äom
,
to
) \

432 
	`__asm__
("cld ;„ep ; movsl" \

434 :"c" (
BLOCK_SIZE
/4),"S" (()(
äom
)),"D" (()(
to
)) \

435 :"cx","di","si")

	)

437 
	$£tup_DMA
()

439 
addr
,
couÁ
;

440 
dma_code
;

442 
dma_code
 = 
DMA_WRITE
;

443 ià(
commªd
 =ğ
FD_READ
)

444 
dma_code
 = 
DMA_READ
;

445 ià(
commªd
 =ğ
FD_FORMAT
) {

446 
addr
 = (è
tmp_æİpy_¬—
;

447 
couÁ
 = 
æİpy
->
£ù
*4;

449 
addr
 = (è
CURRENT
->
bufãr
;

450 
couÁ
 = 1024;

452 ià(
»ad_Œack
) {

454 
bufãr_drive
 = 
bufãr_Œack
 = -1;

455 
couÁ
 = 
æİpy
->
£ù
*æİpy->
h—d
*512;

456 
addr
 = (è
æİpy_Œack_bufãr
;

457 } ià(
addr
 >ğ
LAST_DMA_ADDR
) {

458 
addr
 = (è
tmp_æİpy_¬—
;

459 ià(
commªd
 =ğ
FD_WRITE
)

460 
	`cİy_bufãr
(
CURRENT
->
bufãr
,
tmp_æİpy_¬—
);

462 
	`şi
();

463 
	`di§bË_dma
(
FLOPPY_DMA
);

464 
	`ş—r_dma_ff
(
FLOPPY_DMA
);

465 
	`£t_dma_mode
(
FLOPPY_DMA
, (
commªd
 =ğ
FD_READ
)? 
DMA_MODE_READ
 : 
DMA_MODE_WRITE
);

466 
	`£t_dma_addr
(
FLOPPY_DMA
, 
addr
);

467 
	`£t_dma_couÁ
(
FLOPPY_DMA
, 
couÁ
);

468 
	`’abË_dma
(
FLOPPY_DMA
);

469 
	`¡i
();

470 
	}
}

472 
	$ouut_by‹
(
by‹
)

474 
couÁ”
;

475 
¡©us
;

477 ià(
»£t
)

479 
couÁ”
 = 0 ; counter < 10000 ; counter++) {

480 
¡©us
 = 
	`šb_p
(
FD_STATUS
è& (
STATUS_READY
 | 
STATUS_DIR
);

481 ià(
¡©us
 =ğ
STATUS_READY
) {

482 
	`outb
(
by‹
,
FD_DATA
);

486 
cu¼’t_Œack
 = 
NO_TRACK
;

487 
»£t
 = 1;

488 
	`´štk
("Unableo send byteo FDC\n");

489 
	}
}

491 
	$»suÉ
()

493 
i
 = 0, 
couÁ”
, 
¡©us
;

495 ià(
»£t
)

497 
couÁ”
 = 0 ; counter < 10000 ; counter++) {

498 
¡©us
 = 
	`šb_p
(
FD_STATUS
)&(
STATUS_DIR
|
STATUS_READY
|
STATUS_BUSY
);

499 ià(
¡©us
 =ğ
STATUS_READY
) {

500  
i
;

502 ià(
¡©us
 =ğ(
STATUS_DIR
|
STATUS_READY
|
STATUS_BUSY
)) {

503 ià(
i
 >ğ
MAX_REPLIES
) {

504 
	`´štk
("floppy_stat„eply overrun\n");

507 
»¶y_bufãr
[
i
++] = 
	`šb_p
(
FD_DATA
);

510 
»£t
 = 1;

511 
cu¼’t_Œack
 = 
NO_TRACK
;

512 
	`´štk
("Getstatusimes out\n");

514 
	}
}

516 
	$bad_æp_šŒ
()

518 
”rÜs
;

520 
cu¼’t_Œack
 = 
NO_TRACK
;

521 ià(
fÜm©_¡©us
 =ğ
FORMAT_BUSY
)

522 
”rÜs
 = ++
fÜm©_”rÜs
;

523 ià(!
CURRENT
) {

524 
	`´štk
(
DEVICE_NAME
 ":‚o current„equest\n");

525 
»£t
 = 
»ÿlib¿‹
 = 1;

528 
”rÜs
 = ++
CURRENT
->errors;

529 ià(
”rÜs
 > 
MAX_ERRORS
) {

530 
	`»que¡_dÚe
(0);

532 ià(
”rÜs
 > 
MAX_ERRORS
/2)

533 
»£t
 = 1;

535 
»ÿlib¿‹
 = 1;

536 
	}
}

543 
šlše
 
	$³½’dicuÏr_mode
(
¿‹
)

545 ià(
fdc_v”siÚ
 =ğ
FDC_TYPE_82077
) {

546 
	`ouut_by‹
(
FD_PERPENDICULAR
);

547 ià(
¿‹
 & 0x40) {

548 
r
 = 
¿‹
 & 0x03;

549 ià(
r
 == 0)

550 
	`ouut_by‹
(2);

551 ià(
r
 == 3)

552 
	`ouut_by‹
(3);

554 
	`´štk
(
DEVICE_NAME
 ": Invalid data„ate for…erpendicular mode!\n");

555 
»£t
 = 1;

558 
	`ouut_by‹
(0);

560 ià(
¿‹
 & 0x40) {

561 
	`´štk
(
DEVICE_NAME
 ":…erpendicular mode‚ot supported byhis FDC.\n");

562 
»£t
 = 1;

565 
	}
}

574 
	$cÚfigu»_fdc_mode
()

576 ià(
Ãed_cÚfigu»
 && (
fdc_v”siÚ
 =ğ
FDC_TYPE_82077
)) {

578 
	`ouut_by‹
(
FD_CONFIGURE
);

579 
	`ouut_by‹
(0);

580 
	`ouut_by‹
(0x1A);

581 
	`ouut_by‹
(0);

582 
Ãed_cÚfigu»
 = 0;

583 
	`´štk
(
DEVICE_NAME
 ": FIFOƒnabled\n");

585 ià(
cur_¥ec1
 !ğ
æİpy
->
¥ec1
) {

586 
cur_¥ec1
 = 
æİpy
->
¥ec1
;

587 
	`ouut_by‹
(
FD_SPECIFY
);

588 
	`ouut_by‹
(
cur_¥ec1
);

589 
	`ouut_by‹
(6);

591 ià(
cur_¿‹
 !ğ
æİpy
->
¿‹
) {

593 
	`³½’dicuÏr_mode
(
æİpy
->
¿‹
);

594 
	`outb_p
((
cur_¿‹
 = (
æİpy
->
¿‹
)è& ~0x40, 
FD_DCR
);

596 
	}
}

599 
	$‹Î_£ùÜ
(
Ä
)

601 ià(
Ä
!=7) {

602 
	`´štk
(" -- FDC„eplyƒrrror");

603 
»£t
 = 1;

605 
	`´štk
(":¿ck %d, h—d %d, seùÜ %d", 
»¶y_bufãr
[3],

606 
»¶y_bufãr
[4],„eply_buffer[5]);

607 
	}
}

615 
	$rw_š‹¼u±
()

617 * 
bufãr_¬—
;

618 
Ä
;

619 
bad
;

621 
Ä
 = 
	`»suÉ
();

623 (
ST0
 & 
ST0_INTR
)>>6) {

625 
bad
 = 1;

626 ià(
ST1
 & 
ST1_WP
) {

627 
	`´štk
(
DEVICE_NAME
 ": Driv%d i wr™´Ùeùed\n", 
cu¼’t_drive
);

628 
	`»que¡_dÚe
(0);

629 
bad
 = 0;

630 } ià(
ST1
 & 
ST1_OR
) {

631 ià(
ád_msg
[
ST0
 & 
ST0_DS
])

632 
	`´štk
(
DEVICE_NAME
 ": Over/Underrun -„etrying\n");

634 
bad
 = 0;

635 } ià(
CURRENT_ERRORS
 > 
mš_»pÜt_”rÜ_út
[
ST0
 & 
ST0_DS
]) {

636 
	`´štk
(
DEVICE_NAME
 " %d: ", 
ST0
 & 
ST0_DS
);

637 ià(
ST0
 & 
ST0_ECE
) {

638 
	`´štk
("Recalibrate failed!");

639 } ià(
ST2
 & 
ST2_CRC
) {

640 
	`´štk
("data CRCƒrror");

641 
	`‹Î_£ùÜ
(
Ä
);

642 } ià(
ST1
 & 
ST1_CRC
) {

643 
	`´štk
("CRCƒrror");

644 
	`‹Î_£ùÜ
(
Ä
);

645 } ià((
ST1
 & (
ST1_MAM
|
ST1_ND
)è|| (
ST2
 & 
ST2_MAM
)) {

646 ià(!
´obšg
) {

647 
	`´štk
("sector‚ot found");

648 
	`‹Î_£ùÜ
(
Ä
);

650 
	`´štk
("probe failed...");

651 } ià(
ST2
 & 
ST2_WC
) {

652 
	`´štk
("wrong cylinder");

653 } ià(
ST2
 & 
ST2_BC
) {

654 
	`´štk
("bad cylinder");

656 
	`´štk
("unknowÀ”rÜ. ST[0..3]‡»: 0x%x 0x%x 0x%x 0x%x\n", 
ST0
, 
ST1
, 
ST2
, 
ST3
);

658 
	`´štk
("\n");

661 ià(
bad
)

662 
	`bad_æp_šŒ
();

663 
	`»do_fd_»que¡
();

666 
	`´štk
(
DEVICE_NAME
 ": Invalid FDC command given!\n");

667 
	`»que¡_dÚe
(0);

670 
	`´štk
(
DEVICE_NAME
 ": Abnormalermination caused by…olling\n");

671 
	`bad_æp_šŒ
();

672 
	`»do_fd_»que¡
();

678 ià(
´obšg
) {

679 
drive
 = 
	`MINOR
(
CURRENT
->
dev
);

681 ià(
ád_msg
[
drive
])

682 
	`´štk
("Auto-detected floppyype %s in fd%d\n",

683 
æİpy
->
Çme
,
drive
);

684 
cu¼’t_ty³
[
drive
] = 
æİpy
;

685 
æİpy_sizes
[
drive
] = 
æİpy
->
size
 >> 1;

686 
´obšg
 = 0;

688 ià(
»ad_Œack
) {

689 
bufãr_Œack
 = 
£ek_Œack
;

690 
bufãr_drive
 = 
cu¼’t_drive
;

691 
bufãr_¬—
 = 
æİpy_Œack_bufãr
 +

692 ((
£ùÜ
-1 + 
h—d
*
æİpy
->
£ù
)<<9);

693 
	`cİy_bufãr
(
bufãr_¬—
,
CURRENT
->
bufãr
);

694 } ià(
commªd
 =ğ
FD_READ
 &&

695 ()(
CURRENT
->
bufãr
è>ğ
LAST_DMA_ADDR
)

696 
	`cİy_bufãr
(
tmp_æİpy_¬—
,
CURRENT
->
bufãr
);

697 
	`»que¡_dÚe
(1);

698 
	`»do_fd_»que¡
();

699 
	}
}

708 
šlše
 
	$£tup_rw_æİpy
()

710 
	`£tup_DMA
();

711 
do_æİpy
 = 
rw_š‹¼u±
;

712 
	`ouut_by‹
(
commªd
);

713 ià(
commªd
 !ğ
FD_FORMAT
) {

714 ià(
»ad_Œack
) {

715 
	`ouut_by‹
(
cu¼’t_drive
);

716 
	`ouut_by‹
(
Œack
);

717 
	`ouut_by‹
(0);

718 
	`ouut_by‹
(1);

720 
	`ouut_by‹
(
h—d
<<2 | 
cu¼’t_drive
);

721 
	`ouut_by‹
(
Œack
);

722 
	`ouut_by‹
(
h—d
);

723 
	`ouut_by‹
(
£ùÜ
);

725 
	`ouut_by‹
(2);

726 
	`ouut_by‹
(
æİpy
->
£ù
);

727 
	`ouut_by‹
(
æİpy
->
g­
);

728 
	`ouut_by‹
(0xFF);

730 
	`ouut_by‹
(
h—d
<<2 | 
cu¼’t_drive
);

731 
	`ouut_by‹
(2);

732 
	`ouut_by‹
(
æİpy
->
£ù
);

733 
	`ouut_by‹
(
æİpy
->
fmt_g­
);

734 
	`ouut_by‹
(
FD_FILL_BYTE
);

736 ià(
»£t
)

737 
	`»do_fd_»que¡
();

738 
	}
}

745 
	$£ek_š‹¼u±
()

748 
	`ouut_by‹
(
FD_SENSEI
);

749 ià(
	`»suÉ
(è!ğ2 || (
ST0
 & 0xF8è!ğ0x20 || 
ST1
 !ğ
£ek_Œack
) {

750 
	`´štk
(
DEVICE_NAME
 ": seek failed\n");

751 
»ÿlib¿‹
 = 1;

752 
	`bad_æp_šŒ
();

753 
	`»do_fd_»que¡
();

756 
cu¼’t_Œack
 = 
ST1
;

757 
	`£tup_rw_æİpy
();

758 
	}
}

766 
	$Œªsãr
()

768 
»ad_Œack
 = (
commªd
 =ğ
FD_READ
è&& (
CURRENT_ERRORS
 < 4) &&

769 (
æİpy
->
£ù
 <ğ
MAX_BUFFER_SECTORS
);

771 
	`cÚfigu»_fdc_mode
();

773 ià(
»£t
) {

774 
	`»do_fd_»que¡
();

777 ià(!
£ek
) {

778 
	`£tup_rw_æİpy
();

782 
do_æİpy
 = 
£ek_š‹¼u±
;

783 
	`ouut_by‹
(
FD_SEEK
);

784 ià(
»ad_Œack
)

785 
	`ouut_by‹
(
cu¼’t_drive
);

787 
	`ouut_by‹
((
h—d
<<2è| 
cu¼’t_drive
);

788 
	`ouut_by‹
(
£ek_Œack
);

789 ià(
»£t
)

790 
	`»do_fd_»que¡
();

791 
	}
}

797 
»ÿlib¿‹_æİpy
();

799 
	$»ÿl_š‹¼u±
()

801 
	`ouut_by‹
(
FD_SENSEI
);

802 
cu¼’t_Œack
 = 
NO_TRACK
;

803 ià(
	`»suÉ
()!=2 || (
ST0
 & 0xE0) == 0x60)

804 
»£t
 = 1;

806 ià((
ST0
 & 0x10) == 0x10)

807 
	`»ÿlib¿‹_æİpy
();

809 
	`»do_fd_»que¡
();

810 
	}
}

812 
	$uÃx³ùed_æİpy_š‹¼u±
()

814 
cu¼’t_Œack
 = 
NO_TRACK
;

815 
	`ouut_by‹
(
FD_SENSEI
);

816 
	`´štk
(
DEVICE_NAME
 ": unexpected interrupt\n");

817 ià(
	`»suÉ
()!=2 || (
ST0
 & 0xE0) == 0x60)

818 
»£t
 = 1;

820 
»ÿlib¿‹
 = 1;

821 
	}
}

823 
	$»ÿlib¿‹_æİpy
()

825 
»ÿlib¿‹
 = 0;

826 
cu¼’t_Œack
 = 0;

827 
do_æİpy
 = 
»ÿl_š‹¼u±
;

828 
	`ouut_by‹
(
FD_RECALIBRATE
);

829 
	`ouut_by‹
(
h—d
<<2 | 
cu¼’t_drive
);

830 ià(
»£t
)

831 
	`»do_fd_»que¡
();

832 
	}
}

837 
	$»£t_š‹¼u±
()

839 
i
;

841 
i
=0; i<4; i++) {

842 
	`ouut_by‹
(
FD_SENSEI
);

843 (è
	`»suÉ
();

845 
	`ouut_by‹
(
FD_SPECIFY
);

846 
	`ouut_by‹
(
cur_¥ec1
);

847 
	`ouut_by‹
(6);

848 
	`cÚfigu»_fdc_mode
();

849 ià(
š™Ÿl_»£t_æag
) {

850 
š™Ÿl_»£t_æag
 = 0;

851 
»ÿlib¿‹
 = 1;

852 
»£t
 = 0;

855 ià(!
»cov”
)

856 
	`»do_fd_»que¡
();

858 
	`»ÿlib¿‹_æİpy
();

859 
»cov”
 = 0;

861 
	}
}

866 
	$»£t_æİpy
()

868 
i
;

870 
do_æİpy
 = 
»£t_š‹¼u±
;

871 
»£t
 = 0;

872 
cu¼’t_Œack
 = 
NO_TRACK
;

873 
cur_¥ec1
 = -1;

874 
cur_¿‹
 = -1;

875 
»ÿlib¿‹
 = 1;

876 
Ãed_cÚfigu»
 = 1;

877 ià(!
š™Ÿl_»£t_æag
)

878 
	`´štk
("Reset-floppy called\n");

879 
	`şi
();

880 
	`outb_p
(
cu¼’t_DOR
 & ~0x04, 
FD_DOR
);

881 
i
=0 ; i<1000 ; i++)

882 
	`__asm__
("nop");

883 
	`outb
(
cu¼’t_DOR
, 
FD_DOR
);

884 
	`¡i
();

885 
	}
}

887 
	$æİpy_shutdown
()

889 
	`şi
();

890 
do_æİpy
 = 
NULL
;

891 
	`»que¡_dÚe
(0);

892 
»cov”
 = 1;

893 
	`»£t_æİpy
();

894 
	`¡i
();

895 
	`»do_fd_»que¡
();

896 
	}
}

898 
	$shake_dÚe
()

900 
cu¼’t_Œack
 = 
NO_TRACK
;

901 ià(
	`šb
(
FD_DIR
) & 0x80)

902 
	`»que¡_dÚe
(0);

903 
	`»do_fd_»que¡
();

904 
	}
}

906 
»Œy_»ÿl
((*
´oc
)())

908 
	`ouut_by‹
(
FD_SENSEI
);

909 ià(
	`»suÉ
(è=ğ2 && (
ST0
 & 0x10) != 0x10)  0;

910 
do_æİpy
 = 
´oc
;

911 
	`ouut_by‹
(
FD_RECALIBRATE
);

912 
	`ouut_by‹
(
h—d
<<2 | 
cu¼’t_drive
);

914 
	}
}

916 
	$shake_z”o
()

918 ià(!
	`»Œy_»ÿl
(
shake_z”o
)è
	`shake_dÚe
();

919 
	}
}

921 
	$shake_Úe
()

923 ià(
	`»Œy_»ÿl
(
shake_Úe
)) ;

924 
do_æİpy
 = 
shake_dÚe
;

925 
	`ouut_by‹
(
FD_SEEK
);

926 
	`ouut_by‹
(
h—d
 << 2 | 
cu¼’t_drive
);

927 
	`ouut_by‹
(1);

928 
	}
}

930 
	$æİpy_»ady
()

932 ià(
	`šb
(
FD_DIR
) & 0x80) {

933 
chªged_æİp›s
 |ğ1<<
cu¼’t_drive
;

934 
bufãr_Œack
 = -1;

935 ià(
k“p_d©a
[
cu¼’t_drive
]) {

936 ià(
k“p_d©a
[
cu¼’t_drive
] > 0)

937 
k“p_d©a
[
cu¼’t_drive
]--;

939 ià(
ád_msg
[
cu¼’t_drive
] && 
cu¼’t_ty³
[cu¼’t_drive] !ğ
NULL
)

940 
	`´štk
("Diskype is undefined‡fter disk "

941 "chªgš fd%d\n",
cu¼’t_drive
);

942 
cu¼’t_ty³
[
cu¼’t_drive
] = 
NULL
;

943 
æİpy_sizes
[
cu¼’t_drive
] = 
MAX_DISK_SIZE
;

948 ià(!
»£t
 && !
»ÿlib¿‹
) {

949 ià(
cu¼’t_Œack
 && cu¼’t_Œack !ğ
NO_TRACK
)

950 
do_æİpy
 = 
shake_z”o
;

952 
do_æİpy
 = 
shake_Úe
;

953 
	`ouut_by‹
(
FD_RECALIBRATE
);

954 
	`ouut_by‹
(
h—d
<<2 | 
cu¼’t_drive
);

958 ià(
»£t
) {

959 
	`»£t_æİpy
();

962 ià(
»ÿlib¿‹
) {

963 
	`»ÿlib¿‹_æİpy
();

966 
	`Œªsãr
();

967 
	}
}

969 
	$£tup_fÜm©_·¿ms
()

971 *
h”e
 = (*è
tmp_æİpy_¬—
;

972 
couÁ
,
h—d_shiá
,
Œack_shiá
,
tÙ®_shiá
;

975 
h—d_shiá
 = 
æİpy
->
£ù
 / 6;

977 
Œack_shiá
 = 2 * 
h—d_shiá
 + 1;

979 
tÙ®_shiá
 = 
æİpy
->
£ù
 -

980 ((
Œack_shiá
 * 
Œack
 + 
h—d_shiá
 * 
h—d
è% 
æİpy
->
£ù
);

983 
couÁ
 = 0; couÁ < 
æİpy
->
£ù
; count++) {

984 *
h”e
++ = 
Œack
;

985 *
h”e
++ = 
h—d
;

986 *
h”e
++ = 1 + (Ğ
couÁ
 + 
tÙ®_shiá
 ) % 
æİpy
->
£ù
);

987 *
h”e
++ = 2;

989 
	}
}

991 
	$»do_fd_»que¡
()

993 
block
;

994 * 
bufãr_¬—
;

995 
deviû
;

997 ià(
CURRENT
 && CURRENT->
dev
 < 0) ;

999 
»³©
:

1000 ià(
fÜm©_¡©us
 =ğ
FORMAT_WAIT
)

1001 
fÜm©_¡©us
 = 
FORMAT_BUSY
;

1002 ià(
fÜm©_¡©us
 !ğ
FORMAT_BUSY
) {

1003 ià(!
CURRENT
) {

1004 ià(!
fdc_busy
)

1005 
	`´štk
("FDC‡ccess conflict!");

1006 
fdc_busy
 = 0;

1007 
	`wake_up
(&
fdc_wa™
);

1008 
CLEAR_INTR
;

1011 ià(
	`MAJOR
(
CURRENT
->
dev
è!ğ
MAJOR_NR
)

1012 
	`·nic
(
DEVICE_NAME
 ":„equest†ist destroyed"); \

1013 ià(
CURRENT
->
bh
) {

1014 ià(!
CURRENT
->
bh
->
b_lock
)

1015 
	`·nic
(
DEVICE_NAME
 ": block‚ot†ocked");

1018 
£ek
 = 0;

1019 
´obšg
 = 0;

1020 
deviû
 = 
	`MINOR
(
CURRENT_DEVICE
);

1021 ià(
deviû
 > 3)

1022 
æİpy
 = (
deviû
 >> 2è+ 
æİpy_ty³
;

1024 
æİpy
 = 
cu¼’t_ty³
[
deviû
 & 3];

1025 ià(!
æİpy
) {

1026 
´obšg
 = 1;

1027 
æİpy
 = 
ba£_ty³
[
deviû
 & 3];

1028 ià(!
æİpy
) {

1029 
	`»que¡_dÚe
(0);

1030 
»³©
;

1032 ià(
CURRENT_ERRORS
 & 1)

1033 
æİpy
++;

1036 ià(
fÜm©_¡©us
 !ğ
FORMAT_BUSY
) {

1037 ià(
cu¼’t_drive
 !ğ
CURRENT_DEV
) {

1038 
cu¼’t_Œack
 = 
NO_TRACK
;

1039 
cu¼’t_drive
 = 
CURRENT_DEV
;

1041 
block
 = 
CURRENT
->
£ùÜ
;

1042 ià(
block
+2 > 
æİpy
->
size
) {

1043 
	`»que¡_dÚe
(0);

1044 
»³©
;

1046 
£ùÜ
 = 
block
 % 
æİpy
->
£ù
;

1047 
block
 /ğ
æİpy
->
£ù
;

1048 
h—d
 = 
block
 % 
æİpy
->head;

1049 
Œack
 = 
block
 / 
æİpy
->
h—d
;

1050 
£ek_Œack
 = 
Œack
 << 
æİpy
->
¡»tch
;

1051 ià(
CURRENT
->
cmd
 =ğ
READ
)

1052 
commªd
 = 
FD_READ
;

1053 ià(
CURRENT
->
cmd
 =ğ
WRITE
)

1054 
commªd
 = 
FD_WRITE
;

1056 
	`´štk
("do_fd_request: unknown command\n");

1057 
	`»que¡_dÚe
(0);

1058 
»³©
;

1061 ià(
cu¼’t_drive
 !ğ(
fÜm©_»q
.
deviû
 & 3))

1062 
cu¼’t_Œack
 = 
NO_TRACK
;

1063 
cu¼’t_drive
 = 
fÜm©_»q
.
deviû
 & 3;

1064 ià(((è
fÜm©_»q
.
Œack
è>ğ
æİpy
->track ||

1065 (
fÜm©_»q
.
h—d
 & 0xffãè|| 
´obšg
) {

1066 
	`»que¡_dÚe
(0);

1067 
»³©
;

1069 
h—d
 = 
fÜm©_»q
.head;

1070 
Œack
 = 
fÜm©_»q
.track;

1071 
£ek_Œack
 = 
Œack
 << 
æİpy
->
¡»tch
;

1072 ià(
£ek_Œack
 =ğ
bufãr_Œack
) buffer_track = -1;

1073 
commªd
 = 
FD_FORMAT
;

1074 
	`£tup_fÜm©_·¿ms
();

1076 
tim”_bË
[
FLOPPY_TIMER
].
expœes
 = 
jiff›s
+10*
HZ
;

1077 
tim”_aùive
 |ğ1 << 
FLOPPY_TIMER
;

1078 ià((
£ek_Œack
 =ğ
bufãr_Œack
) &&

1079 (
cu¼’t_drive
 =ğ
bufãr_drive
)) {

1080 
bufãr_¬—
 = 
æİpy_Œack_bufãr
 +

1081 ((
£ùÜ
 + 
h—d
*
æİpy
->
£ù
)<<9);

1082 ià(
commªd
 =ğ
FD_READ
) {

1083 
	`cİy_bufãr
(
bufãr_¬—
,
CURRENT
->
bufãr
);

1084 
	`»que¡_dÚe
(1);

1085 
»³©
;

1086 } ià(
commªd
 =ğ
FD_WRITE
)

1087 
	`cİy_bufãr
(
CURRENT
->
bufãr
,
bufãr_¬—
);

1089 ià(
£ek_Œack
 !ğ
cu¼’t_Œack
)

1090 
£ek
 = 1;

1091 
£ùÜ
++;

1092 
	`d–_tim”
(
mÙÜ_off_tim”
 + 
cu¼’t_drive
);

1093 
	`æİpy_Ú
(
cu¼’t_drive
);

1094 
	}
}

1096 
	$do_fd_»que¡
()

1098 
	`şi
();

1099 
fdc_busy
è
	`¦“p_Ú
(&
fdc_wa™
);

1100 
fdc_busy
 = 1;

1101 
	`¡i
();

1102 
	`»do_fd_»que¡
();

1103 
	}
}

1105 
	$fd_ioùl
(
šode
 *šode, 
fe
 *
fp
, 
cmd
,

1106 
·¿m
)

1108 
i
,
drive
,
út
,
okay
;

1109 
æİpy_¡ruù
 *
this_æİpy
;

1111 
cmd
) {

1112 
	`RO_IOCTLS
(
šode
->
i_rdev
,
·¿m
);

1114 
drive
 = 
	`MINOR
(
šode
->
i_rdev
);

1115 
cmd
) {

1116 
FDFMTBEG
:

1117 ià(!
	`su£r
())

1118  -
EPERM
;

1120 
FDFMTEND
:

1121 ià(!
	`su£r
())

1122  -
EPERM
;

1123 
	`şi
();

1124 
çke_chªge
 |ğ1 << (
drive
 & 3);

1125 
	`¡i
();

1126 
drive
 &= 3;

1127 
cmd
 = 
FDCLRPRM
;

1129 
FDGETPRM
:

1130 ià(
drive
 > 3è
this_æİpy
 = &
æİpy_ty³
[drive >> 2];

1131 ià((
this_æİpy
 = 
cu¼’t_ty³
[
drive
 & 3]è=ğ
NULL
)

1132  -
ENODEV
;

1133 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
·¿m
,(
æİpy_¡ruù
));

1134 ià(
i
)

1135  
i
;

1136 
út
 = 0; cÁ < (
æİpy_¡ruù
); cnt++)

1137 
	`put_fs_by‹
(((*è
this_æİpy
)[
út
],

1138 (*è
·¿m
+
út
);

1140 
FDFMTTRK
:

1141 ià(!
	`su£r
())

1142  -
EPERM
;

1143 ià(
fd_»f
[
drive
 & 3] != 1)

1144  -
EBUSY
;

1145 
	`şi
();

1146 
fÜm©_¡©us
 !ğ
FORMAT_NONE
)

1147 
	`¦“p_Ú
(&
fÜm©_dÚe
);

1148 
út
 = 0; cÁ < (
fÜm©_desü
); cnt++)

1149 ((*è&
fÜm©_»q
)[
út
] = 
	`g‘_fs_by‹
(

1150 (*è
·¿m
+
út
);

1151 
fÜm©_»q
.
deviû
 = 
drive
;

1152 
fÜm©_¡©us
 = 
FORMAT_WAIT
;

1153 
fÜm©_”rÜs
 = 0;

1154 
fÜm©_¡©us
 !ğ
FORMAT_OKAY
 && format_status !=

1155 
FORMAT_ERROR
) {

1156 ià(
fdc_busy
è
	`¦“p_Ú
(&
fdc_wa™
);

1158 
fdc_busy
 = 1;

1159 
	`»do_fd_»que¡
();

1162 
fÜm©_¡©us
 !ğ
FORMAT_OKAY
 && format_status !=

1163 
FORMAT_ERROR
)

1164 
	`¦“p_Ú
(&
fÜm©_dÚe
);

1165 
	`¡i
();

1166 
okay
 = 
fÜm©_¡©us
 =ğ
FORMAT_OKAY
;

1167 
fÜm©_¡©us
 = 
FORMAT_NONE
;

1168 
	`æİpy_off
(
drive
 & 3);

1169 
	`wake_up
(&
fÜm©_dÚe
);

1170  
okay
 ? 0 : -
EIO
;

1171 
FDFLUSH
:

1172 ià(!
	`³rmissiÚ
(
šode
, 2))

1173  -
EPERM
;

1174 
	`şi
();

1175 
çke_chªge
 |ğ1 << (
drive
 & 3);

1176 
	`¡i
();

1177 
	`check_disk_chªge
(
šode
->
i_rdev
);

1180 ià(!
	`su£r
())

1181  -
EPERM
;

1182 ià(
drive
 < 0 || drive > 3)

1183  -
EINVAL
;

1184 
cmd
) {

1185 
FDCLRPRM
:

1186 
cu¼’t_ty³
[
drive
] = 
NULL
;

1187 
æİpy_sizes
[
drive
] = 
MAX_DISK_SIZE
;

1188 
k“p_d©a
[
drive
] = 0;

1190 
FDSETPRM
:

1191 
FDDEFPRM
:

1192 
	`memıy_äomfs
(
u£r_·¿ms
+
drive
,

1193 (*è
·¿m
,

1194 (
æİpy_¡ruù
));

1195 
cu¼’t_ty³
[
drive
] = &
u£r_·¿ms
[drive];

1196 
æİpy_sizes
[
drive
] = 
u£r_·¿ms
[drive].
size
 >> 1;

1197 ià(
cmd
 =ğ
FDDEFPRM
)

1198 
k“p_d©a
[
drive
] = -1;

1200 
	`şi
();

1201 
fdc_busy
è
	`¦“p_Ú
(&
fdc_wa™
);

1202 
fdc_busy
 = 1;

1203 
	`¡i
();

1204 
	`outb_p
((
cu¼’t_DOR
 & 0xfcè| 
drive
 |

1205 (0x10 << 
drive
),
FD_DOR
);

1206 
út
 = 0; cÁ < 1000; cÁ++è
	`__asm__
("nop");

1207 ià(
	`šb
(
FD_DIR
) & 0x80)

1208 
k“p_d©a
[
drive
] = 1;

1210 
k“p_d©a
[
drive
] = 0;

1211 
	`outb_p
(
cu¼’t_DOR
,
FD_DOR
);

1212 
fdc_busy
 = 0;

1213 
	`wake_up
(&
fdc_wa™
);

1216 
FDMSGON
:

1217 
ád_msg
[
drive
] = 1;

1219 
FDMSGOFF
:

1220 
ád_msg
[
drive
] = 0;

1222 
FDSETEMSGTRESH
:

1223 
mš_»pÜt_”rÜ_út
[
drive
] = (è(
·¿m
 & 0x0f);

1226  -
EINVAL
;

1229 
	}
}

1231 
	#CMOS_READ
(
addr
) ({ \

1232 
	`outb_p
(
addr
,0x70); \

1233 
	`šb_p
(0x71); \

1234 })

	)

1236 
æİpy_¡ruù
 *
	$fšd_ba£
(
drive
,
code
)

1238 
æİpy_¡ruù
 *
ba£
;

1240 ià(
code
 > 0 && code < 5) {

1241 
ba£
 = &
æİpy_ty³s
[(
code
-1)*2];

1242 
	`´štk
("fd%d i %s",
drive
,
ba£
->
Çme
);

1243  
ba£
;

1245 
	`´štk
("fd%d i unknowÀty³ %d",
drive
,
code
);

1246  
NULL
;

1247 
	}
}

1249 
	$cÚfig_ty³s
()

1251 
	`´štk
("Floppy drive(s): ");

1252 
ba£_ty³
[0] = 
	`fšd_ba£
(0,(
	`CMOS_READ
(0x10) >> 4) & 15);

1253 ià(((
	`CMOS_READ
(0x14) >> 6) & 1) == 0)

1254 
ba£_ty³
[1] = 
NULL
;

1256 
	`´štk
(", ");

1257 
ba£_ty³
[1] = 
	`fšd_ba£
(1,
	`CMOS_READ
(0x10) & 15);

1259 
ba£_ty³
[2] = ba£_ty³[3] = 
NULL
;

1260 
	`´štk
("\n");

1261 
	}
}

1268 
	$æİpy_İ’
(
šode
 * inode, 
fe
 * 
fp
)

1270 
drive
;

1271 
Şd_dev
;

1273 
drive
 = 
šode
->
i_rdev
 & 3;

1274 
Şd_dev
 = 
fd_deviû
[
drive
];

1275 ià(
fd_»f
[
drive
])

1276 ià(
Şd_dev
 !ğ
šode
->
i_rdev
)

1277  -
EBUSY
;

1278 
fd_»f
[
drive
]++;

1279 
fd_deviû
[
drive
] = 
šode
->
i_rdev
;

1280 
bufãr_drive
 = 
bufãr_Œack
 = -1;

1281 ià(
Şd_dev
 && old_dev !ğ
šode
->
i_rdev
)

1282 
	`šv®id©e_bufãrs
(
Şd_dev
);

1283 ià(
fp
 && fp->
f_mode
)

1284 
	`check_disk_chªge
(
šode
->
i_rdev
);

1286 
	}
}

1288 
	$æİpy_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

1290 
	`sync_dev
(
šode
->
i_rdev
);

1291 ià(!
fd_»f
[
šode
->
i_rdev
 & 3]--) {

1292 
	`´štk
("floppy_release with fd_ref == 0");

1293 
fd_»f
[
šode
->
i_rdev
 & 3] = 0;

1295 
	}
}

1297 
fe_İ”©iÚs
 
	gæİpy_fİs
 = {

1298 
NULL
,

1299 
block_»ad
,

1300 
block_wr™e
,

1301 
NULL
,

1302 
NULL
,

1303 
fd_ioùl
,

1304 
NULL
,

1305 
æİpy_İ’
,

1306 
æİpy_»Ëa£
,

1307 
block_fsync


1319 
	$ignÜe_š‹¼u±
()

1321 
	`´štk
(
DEVICE_NAME
 ": weœd iÁ”ru± ignÜed (%d)\n", 
	`»suÉ
());

1322 
»£t
 = 1;

1323 
CLEAR_INTR
;

1324 
	}
}

1327 
	$æİpy_š‹¼u±
(
unu£d
)

1329 (*
hªdËr
)(èğ
DEVICE_INTR
;

1331 
DEVICE_INTR
 = 
NULL
;

1332 ià(!
hªdËr
)

1333 
hªdËr
 = 
uÃx³ùed_æİpy_š‹¼u±
;

1334 
	`hªdËr
();

1335 
	}
}

1341 
sigaùiÚ
 
	gæİpy_sigaùiÚ
 = {

1342 
æİpy_š‹¼u±
,

1344 
SA_INTERRUPT
,

1345 
NULL


1348 
	$æİpy_š™
()

1350 
	`outb
(
cu¼’t_DOR
,
FD_DOR
);

1351 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"fd",&
æİpy_fİs
)) {

1352 
	`´štk
("UÇbËØg‘ majÜ %d fÜ flİpy\n",
MAJOR_NR
);

1355 
blk_size
[
MAJOR_NR
] = 
æİpy_sizes
;

1356 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

1357 
tim”_bË
[
FLOPPY_TIMER
].
â
 = 
æİpy_shutdown
;

1358 
tim”_aùive
 &ğ~(1 << 
FLOPPY_TIMER
);

1359 
	`cÚfig_ty³s
();

1360 ià(
	`œqaùiÚ
(
FLOPPY_IRQ
,&
æİpy_sigaùiÚ
))

1361 
	`´štk
("UÇbËØg¿b IRQ%d fÜhæİpy driv”\n", 
FLOPPY_IRQ
);

1362 ià(
	`»que¡_dma
(
FLOPPY_DMA
))

1363 
	`´štk
("UÇbËØg¿b DMA%d fÜhæİpy driv”\n", 
FLOPPY_DMA
);

1365 
DEVICE_INTR
 = 
ignÜe_š‹¼u±
;

1366 
	`ouut_by‹
(
FD_VERSION
);

1367 ià(
	`»suÉ
() != 1) {

1368 
	`´štk
(
DEVICE_NAME
 ": FDC failedo„eturn version byte\n");

1369 
fdc_v”siÚ
 = 
FDC_TYPE_STD
;

1371 
fdc_v”siÚ
 = 
»¶y_bufãr
[0];

1372 ià(
fdc_v”siÚ
 !ğ
FDC_TYPE_STD
)

1373 
	`´štk
(
DEVICE_NAME
 ": FDC v”siÚ 0x%x\n", 
fdc_v”siÚ
);

1374 #iâdeà
FDC_FIFO_UNTESTED


1375 
fdc_v”siÚ
 = 
FDC_TYPE_STD
;

1383 ià(
fdc_v”siÚ
 =ğ
FDC_TYPE_STD
) {

1384 
š™Ÿl_»£t_æag
 = 1;

1385 
	`»£t_æİpy
();

1387 
	}
}

	@drivers/block/genhd.c

13 
	~<lšux/cÚfig.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/g’hd.h
>

16 
	~<lšux/k”Ãl.h
>

18 
g’disk
 *
	gg’disk_h—d
 = 
NULL
;

20 
	gcu¼’t_mšÜ
 = 0;

21 *
blk_size
[];

22 
rd_lßd
();

23 
¿mdisk_size
;

36 
	$ex‹nded_·¹™iÚ
(
g’disk
 *
hd
, 
dev
)

38 
bufãr_h—d
 *
bh
;

39 
·¹™iÚ
 *
p
;

40 
fœ¡_£ùÜ
, 
this_£ùÜ
;

41 
mask
 = (1 << 
hd
->
mšÜ_shiá
) - 1;

43 
fœ¡_£ùÜ
 = 
hd
->
·¹
[
	`MINOR
(
dev
)].
¡¬t_£ù
;

44 
this_£ùÜ
 = 
fœ¡_£ùÜ
;

47 ià((
cu¼’t_mšÜ
 & 
mask
è>ğ(4 + 
hd
->
max_p
))

49 ià(!(
bh
 = 
	`b»ad
(
dev
,0,1024)))

55 
bh
->
b_dœt
=0;

56 
bh
->
b_u±od©e
=0;

57 ià(*(*è(
bh
->
b_d©a
+510) == 0xAA55) {

58 
p
 = (
·¹™iÚ
 *è(0x1BE + 
bh
->
b_d©a
);

63 ià(
p
->
sys_šd
 =ğ
EXTENDED_PARTITION
 ||

64 !(
hd
->
·¹
[
cu¼’t_mšÜ
].
Ä_£ùs
 = 
p
->nr_sects))

65 
dÚe
;

66 
hd
->
·¹
[
cu¼’t_mšÜ
].
¡¬t_£ù
 = 
this_£ùÜ
 + 
p
->start_sect;

67 
	`´štk
(" %s%c%d", 
hd
->
majÜ_Çme
,

68 'a'+(
cu¼’t_mšÜ
 >> 
hd
->
mšÜ_shiá
),

69 
mask
 & 
cu¼’t_mšÜ
);

70 
cu¼’t_mšÜ
++;

71 
p
++;

79 ià(
p
->
sys_šd
 !ğ
EXTENDED_PARTITION
 ||

80 !(
hd
->
·¹
[
cu¼’t_mšÜ
].
Ä_£ùs
 = 
p
->nr_sects))

81 
dÚe
;

82 
hd
->
·¹
[
cu¼’t_mšÜ
].
¡¬t_£ù
 = 
fœ¡_£ùÜ
 + 
p
->start_sect;

83 
this_£ùÜ
 = 
fœ¡_£ùÜ
 + 
p
->
¡¬t_£ù
;

84 
dev
 = ((
hd
->
majÜ
è<< 8è| 
cu¼’t_mšÜ
;

85 
	`b»l£
(
bh
);

87 
dÚe
;

89 
dÚe
:

90 
	`b»l£
(
bh
);

91 
	}
}

93 
	$check_·¹™iÚ
(
g’disk
 *
hd
, 
dev
)

95 
fœ¡_time
 = 1;

96 
i
, 
mšÜ
 = 
cu¼’t_mšÜ
;

97 
bufãr_h—d
 *
bh
;

98 
·¹™iÚ
 *
p
;

99 
fœ¡_£ùÜ
;

100 
mask
 = (1 << 
hd
->
mšÜ_shiá
) - 1;

102 ià(
fœ¡_time
)

103 
	`´štk
("Partition check:\n");

104 
fœ¡_time
 = 0;

105 
fœ¡_£ùÜ
 = 
hd
->
·¹
[
	`MINOR
(
dev
)].
¡¬t_£ù
;

106 ià(!(
bh
 = 
	`b»ad
(
dev
,0,1024))) {

107 
	`´štk
(" uÇbËØ»ad…¬t™iÚabË oàdeviû %04x\n",
dev
);

110 
	`´štk
(" %s%c:", 
hd
->
majÜ_Çme
, 'a'+(
mšÜ
 >> hd->
mšÜ_shiá
));

111 
cu¼’t_mšÜ
 += 4;

112 ià(*(*è(
bh
->
b_d©a
+510) == 0xAA55) {

113 
p
 = (
·¹™iÚ
 *è(0x1BE + 
bh
->
b_d©a
);

114 
i
=1 ; i<=4 ; 
mšÜ
++,i++,
p
++) {

115 ià(!(
hd
->
·¹
[
mšÜ
].
Ä_£ùs
 = 
p
->nr_sects))

117 
hd
->
·¹
[
mšÜ
].
¡¬t_£ù
 = 
fœ¡_£ùÜ
 + 
p
->start_sect;

118 
	`´štk
(" %s%c%d", 
hd
->
majÜ_Çme
,'a'+(
mšÜ
 >> hd->
mšÜ_shiá
), 
i
);

119 ià((
cu¼’t_mšÜ
 & 0x3f) >= 60)

121 ià(
p
->
sys_šd
 =ğ
EXTENDED_PARTITION
) {

122 
	`´štk
(" <");

123 
	`ex‹nded_·¹™iÚ
(
hd
, (hd->
majÜ
 << 8è| 
mšÜ
);

124 
	`´štk
(" >");

130 ià(*(*è(
bh
->
b_d©a
+0xfc) == 0x55AA) {

131 
p
 = (
·¹™iÚ
 *è(0x1BE + 
bh
->
b_d©a
);

132 
i
 = 4 ; i < 16 ; i++, 
cu¼’t_mšÜ
++) {

133 
p
--;

134 ià((
cu¼’t_mšÜ
 & 
mask
) >= mask-2)

136 ià(!(
p
->
¡¬t_£ù
 &&…->
Ä_£ùs
))

138 
hd
->
·¹
[
cu¼’t_mšÜ
].
¡¬t_£ù
 = 
p
->start_sect;

139 
hd
->
·¹
[
cu¼’t_mšÜ
].
Ä_£ùs
 = 
p
->nr_sects;

140 
	`´štk
(" %s%c%d", 
hd
->
majÜ_Çme
,

141 'a'+(
cu¼’t_mšÜ
 >> 
hd
->
mšÜ_shiá
),

142 
cu¼’t_mšÜ
 & 
mask
);

146 
	`´štk
(" bad…artitionable");

147 
	`´štk
("\n");

148 
	`b»l£
(
bh
);

149 
	}
}

160 
	$»£tup_Úe_dev
(
g’disk
 *
dev
, 
drive
)

162 
i
;

163 
¡¬t
 = 
drive
<<
dev
->
mšÜ_shiá
;

164 
j
 = 
¡¬t
 + 
dev
->
max_p
;

165 
majÜ
 = 
dev
->major << 8;

167 
cu¼’t_mšÜ
 = 1+(
drive
<<
dev
->
mšÜ_shiá
);

168 
	`check_·¹™iÚ
(
dev
, 
majÜ
+(
drive
<<dev->
mšÜ_shiá
));

170 
i
=
¡¬t
 ; i < 
j
 ; i++)

171 
dev
->
sizes
[
i
] = dev->
·¹
[i].
Ä_£ùs
 >> (
BLOCK_SIZE_BITS
 - 9);

172 
	}
}

174 
	$£tup_dev
(
g’disk
 *
dev
)

176 
i
;

177 
j
 = 
dev
->
max_Ä
 * dev->
max_p
;

178 
majÜ
 = 
dev
->major << 8;

179 
drive
;

182 
i
 = 0 ; i < 
j
; i++) {

183 
dev
->
·¹
[
i
].
¡¬t_£ù
 = 0;

184 
dev
->
·¹
[
i
].
Ä_£ùs
 = 0;

186 
dev
->
	`š™
();

187 
drive
=0 ; drive<
dev
->
Ä_»®
 ; drive++) {

188 
cu¼’t_mšÜ
 = 1+(
drive
<<
dev
->
mšÜ_shiá
);

189 
	`check_·¹™iÚ
(
dev
, 
majÜ
+(
drive
<<dev->
mšÜ_shiá
));

191 
i
=0 ; i < 
j
 ; i++)

192 
dev
->
sizes
[
i
] = dev->
·¹
[i].
Ä_£ùs
 >> (
BLOCK_SIZE_BITS
 - 9);

193 
blk_size
[
dev
->
majÜ
] = dev->
sizes
;

194 
	}
}

197 
asmlškage
 
	$sys_£tup
(* 
BIOS
)

199 
ÿÎabË
 = 1;

200 
g’disk
 *
p
;

201 
Ä
=0;

203 ià(!
ÿÎabË
)

205 
ÿÎabË
 = 0;

207 
p
 = 
g’disk_h—d
 ;… ;…õ->
Ãxt
) {

208 
	`£tup_dev
(
p
);

209 
Ä
 +ğ
p
->
Ä_»®
;

212 ià(
¿mdisk_size
)

213 
	`rd_lßd
();

214 
	`mouÁ_roÙ
();

216 
	}
}

	@drivers/block/hd.c

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/sigÇl.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/tim”.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/k”Ãl.h
>

26 
	~<lšux/hd»g.h
>

27 
	~<lšux/g’hd.h
>

28 
	~<lšux/cÚfig.h
>

30 
	#REALLY_SLOW_IO


	)

31 
	~<asm/sy¡em.h
>

32 
	~<asm/io.h
>

33 
	~<asm/£gm’t.h
>

35 
	#MAJOR_NR
 
HD_MAJOR


	)

36 
	~"blk.h
"

38 
	#HD_IRQ
 14

	)

40 
»v®id©e_hddisk
(, );

42 
šlše
 
	$CMOS_READ
(
addr
)

44 
	`outb_p
(
addr
,0x70);

45  
	`šb_p
(0x71);

46 
	}
}

48 
	#HD_DELAY
 0

	)

50 
	#MAX_ERRORS
 16

	)

51 
	#RESET_FREQ
 8

	)

52 
	#RECAL_FREQ
 4

	)

53 
	#MAX_HD
 2

	)

55 
»ÿl_šŒ
();

56 
bad_rw_šŒ
();

58 
	g»ÿlib¿‹
[ 
MAX_HD
 ] = { 0, };

59 
	gacûss_couÁ
[
MAX_HD
] = {0, };

60 
	gbusy
[
MAX_HD
] = {0, };

61 
wa™_queue
 * 
	gbusy_wa™
 = 
NULL
;

63 
	g»£t
 = 0;

64 
	ghd_”rÜ
 = 0;

66 #ià(
HD_DELAY
 > 0)

67 
	gÏ¡_»q
, 
»ad_tim”
();

73 
	shd_i_¡ruù
 {

74 
	mh—d
,
	m£ù
,
	mcyl
,
	mwpcom
,
	mlzÚe
,
	mùl
;

76 #ifdeà
HD_TYPE


77 
hd_i_¡ruù
 
	ghd_šfo
[] = { 
HD_TYPE
 };

78 
	gNR_HD
 = (( (
hd_šfo
))/( (
hd_i_¡ruù
)));

80 
hd_i_¡ruù
 
	ghd_šfo
[] = { {0,0,0,0,0,0},{0,0,0,0,0,0} };

81 
	gNR_HD
 = 0;

84 
hd_¡ruù
 
	ghd
[
MAX_HD
<<6]={{0,0},};

85 
	ghd_sizes
[
MAX_HD
<<6] = {0, };

86 
	ghd_blocksizes
[
MAX_HD
<<6] = {0, };

88 #ià(
HD_DELAY
 > 0)

89 
	$»ad_tim”
()

91 
t
;

92 
i
;

94 
	`şi
();

95 
t
 = 
jiff›s
 * 11932;

96 
	`outb_p
(0, 0x43);

97 
i
 = 
	`šb_p
(0x40);

98 
i
 |ğ
	`šb
(0x40) << 8;

99 
	`¡i
();

100 (
t
 - 
i
);

101 
	}
}

104 
	$hd_£tup
(*
¡r
, *
šts
)

106 
hdšd
 = 0;

108 ià(
šts
[0] != 3)

110 ià(
hd_šfo
[0].
h—d
 != 0)

111 
hdšd
=1;

112 
hd_šfo
[
hdšd
].
h—d
 = 
šts
[2];

113 
hd_šfo
[
hdšd
].
£ù
 = 
šts
[3];

114 
hd_šfo
[
hdšd
].
cyl
 = 
šts
[1];

115 
hd_šfo
[
hdšd
].
wpcom
 = 0;

116 
hd_šfo
[
hdšd
].
lzÚe
 = 
šts
[1];

117 
hd_šfo
[
hdšd
].
ùl
 = (
šts
[2] > 8 ? 8 : 0);

118 
NR_HD
 = 
hdšd
+1;

119 
	}
}

121 
	$wš_»suÉ
()

123 
i
=
	`šb_p
(
HD_STATUS
);

125 ià((
i
 & (
BUSY_STAT
 | 
READY_STAT
 | 
WRERR_STAT
 | 
SEEK_STAT
 | 
ERR_STAT
))

126 =ğ(
READY_STAT
 | 
SEEK_STAT
)) {

127 
hd_”rÜ
 = 0;

130 
	`´štk
("HD: wš_»suÉ: stu ğ0x%02x\n",
i
);

131 ià(
i
&1) {

132 
hd_”rÜ
 = 
	`šb
(
HD_ERROR
);

133 
	`´štk
("HD: wš_»suÉ:ƒ¼Ü = 0x%02x\n",
hd_”rÜ
);

136 
	}
}

138 
cÚŒŞËr_busy
();

139 
¡©us_ok
();

141 
	$cÚŒŞËr_»ady
(
drive
, 
h—d
)

143 
»Œy
 = 100;

146 ià(
	`cÚŒŞËr_busy
(è& 
BUSY_STAT
)

148 
	`outb_p
(0xA0 | (
drive
<<4è| 
h—d
, 
HD_CURRENT
);

149 ià(
	`¡©us_ok
())

151 } --
»Œy
);

153 
	}
}

155 
	$¡©us_ok
()

157 
¡©us
 = 
	`šb_p
(
HD_STATUS
);

159 ià(
¡©us
 & 
BUSY_STAT
)

161 ià(
¡©us
 & 
WRERR_STAT
)

163 ià(!(
¡©us
 & 
READY_STAT
))

165 ià(!(
¡©us
 & 
SEEK_STAT
))

168 
	}
}

170 
	$cÚŒŞËr_busy
()

172 
»Œ›s
 = 100000;

173 
¡©us
;

176 
¡©us
 = 
	`šb_p
(
HD_STATUS
);

177 } (
¡©us
 & 
BUSY_STAT
è&& --
»Œ›s
);

178  
¡©us
;

179 
	}
}

181 
hd_out
(
drive
,
n£ù
,
£ù
,

182 
h—d
,
cyl
,
cmd
,

183 (*
šŒ_addr
)())

185 
pÜt
;

187 ià(
drive
>1 || 
h—d
>15)

188 
	`·nic
("Tryingo write bad sector");

189 #ià(
HD_DELAY
 > 0)

190 
	`»ad_tim”
(è- 
Ï¡_»q
 < 
HD_DELAY
)

193 ià(
»£t
)

195 ià(!
	`cÚŒŞËr_»ady
(
drive
, 
h—d
)) {

196 
»£t
 = 1;

199 
	`SET_INTR
(
šŒ_addr
);

200 
	`outb_p
(
hd_šfo
[
drive
].
ùl
,
HD_CMD
);

201 
pÜt
=
HD_DATA
;

202 
	`outb_p
(
hd_šfo
[
drive
].
wpcom
>>2,++
pÜt
);

203 
	`outb_p
(
n£ù
,++
pÜt
);

204 
	`outb_p
(
£ù
,++
pÜt
);

205 
	`outb_p
(
cyl
,++
pÜt
);

206 
	`outb_p
(
cyl
>>8,++
pÜt
);

207 
	`outb_p
(0xA0|(
drive
<<4)|
h—d
,++
pÜt
);

208 
	`outb_p
(
cmd
,++
pÜt
);

209 
	}
}

211 
	$drive_busy
()

213 
i
;

214 
c
;

216 
i
 = 0; i < 500000 ; i++) {

217 
c
 = 
	`šb_p
(
HD_STATUS
);

218 
c
 &ğ(
BUSY_STAT
 | 
READY_STAT
 | 
SEEK_STAT
);

219 ià(
c
 =ğ(
READY_STAT
 | 
SEEK_STAT
))

222 
	`´štk
("HD cÚŒŞË¸time out, stu ğ0x%02x\n",
c
);

224 
	}
}

226 
	$»£t_cÚŒŞËr
()

228 
i
;

230 
	`´štk
(
KERN_DEBUG
 "HD-controller„eset\n");

231 
	`outb_p
(4,
HD_CMD
);

232 
i
 = 0; i < 1000; i++è
	`nİ
();

233 
	`outb
(
hd_šfo
[0].
ùl
 & 0x0à,
HD_CMD
);

234 ià(
	`drive_busy
())

235 
	`´štk
("HD-controller still busy\n");

236 ià((
hd_”rÜ
 = 
	`šb
(
HD_ERROR
)) != 1)

237 
	`´štk
("HD-cÚŒŞË¸»£ˆçed: %02x\n",
hd_”rÜ
);

238 
	}
}

240 
	$»£t_hd
()

242 
i
;

244 
»³©
:

245 ià(
»£t
) {

246 
»£t
 = 0;

247 
i
 = -1;

248 
	`»£t_cÚŒŞËr
();

249 } ià(
	`wš_»suÉ
()) {

250 
	`bad_rw_šŒ
();

251 ià(
»£t
)

252 
»³©
;

254 
i
++;

255 ià(
i
 < 
NR_HD
) {

256 
	`hd_out
(
i
,
hd_šfo
[i].
£ù
,hd_šfo[i].£ù,hd_šfo[i].
h—d
-1,

257 
hd_šfo
[
i
].
cyl
,
WIN_SPECIFY
,&
»£t_hd
);

258 ià(
»£t
)

259 
»³©
;

261 
	`do_hd_»que¡
();

262 
	}
}

269 
	$uÃx³ùed_hd_š‹¼u±
()

271 
	`¡i
();

272 
	`´štk
(
KERN_DEBUG
 "Unexpected HD interrupt\n");

273 
SET_TIMER
;

274 
	}
}

281 
	$bad_rw_šŒ
()

283 
dev
;

285 ià(!
CURRENT
)

287 
dev
 = 
	`MINOR
(
CURRENT
->dev) >> 6;

288 ià(++
CURRENT
->
”rÜs
 >ğ
MAX_ERRORS
 || (
hd_”rÜ
 & 
BBD_ERR
)) {

289 
	`’d_»que¡
(0);

290 
»ÿlib¿‹
[
dev
] = 1;

291 } ià(
CURRENT
->
”rÜs
 % 
RESET_FREQ
 == 0)

292 
»£t
 = 1;

293 ià((
hd_”rÜ
 & 
TRK0_ERR
è|| 
CURRENT
->
”rÜs
 % 
RECAL_FREQ
 == 0)

294 
»ÿlib¿‹
[
dev
] = 1;

296 
	}
}

298 
šlše
 
	$wa™_DRQ
()

300 
»Œ›s
 = 100000;

302 --
»Œ›s
 > 0)

303 ià(
	`šb_p
(
HD_STATUS
è& 
DRQ_STAT
)

306 
	}
}

308 
	#STAT_MASK
 (
BUSY_STAT
 | 
READY_STAT
 | 
WRERR_STAT
 | 
SEEK_STAT
 | 
ERR_STAT
)

	)

309 
	#STAT_OK
 (
READY_STAT
 | 
SEEK_STAT
)

	)

311 
	$»ad_šŒ
()

313 
i
;

314 
»Œ›s
 = 100000;

317 
i
 = (è
	`šb_p
(
HD_STATUS
);

318 ià(
i
 & 
BUSY_STAT
)

320 ià((
i
 & 
STAT_MASK
è!ğ
STAT_OK
)

322 ià(
i
 & 
DRQ_STAT
)

323 
ok_to_»ad
;

324 } --
»Œ›s
 > 0);

325 
	`¡i
();

326 
	`´štk
("HD:„—d_šŒ: stu ğ0x%02x\n",
i
);

327 ià(
i
 & 
ERR_STAT
) {

328 
hd_”rÜ
 = (è
	`šb
(
HD_ERROR
);

329 
	`´štk
("HD:„—d_šŒ:ƒ¼Ü = 0x%02x\n",
hd_”rÜ
);

331 
	`bad_rw_šŒ
();

332 
	`şi
();

333 
	`do_hd_»que¡
();

335 
ok_to_»ad
:

336 
	`šsw
(
HD_DATA
,
CURRENT
->
bufãr
,256);

337 
CURRENT
->
”rÜs
 = 0;

338 
CURRENT
->
bufãr
 += 512;

339 
CURRENT
->
£ùÜ
++;

340 
i
 = --
CURRENT
->
Ä_£ùÜs
;

341 --
CURRENT
->
cu¼’t_Ä_£ùÜs
;

342 #ifdeà
DEBUG


343 
	`´štk
("hd%d : sector = %d, %d„emainingo buffer = %08x\n",

344 
	`MINOR
(
CURRENT
->
dev
), CURRENT->
£ùÜ
, 
i
, CURRENT->

345 
bufãr
);

347 ià(!
i
 || (
CURRENT
->
bh
 && !
	`SUBSECTOR
(i)))

348 
	`’d_»que¡
(1);

349 ià(
i
 > 0) {

350 
	`SET_INTR
(&
»ad_šŒ
);

351 
	`¡i
();

354 (è
	`šb_p
(
HD_STATUS
);

355 #ià(
HD_DELAY
 > 0)

356 
Ï¡_»q
 = 
	`»ad_tim”
();

358 
	`do_hd_»que¡
();

360 
	}
}

362 
	$wr™e_šŒ
()

364 
i
;

365 
»Œ›s
 = 100000;

368 
i
 = (è
	`šb_p
(
HD_STATUS
);

369 ià(
i
 & 
BUSY_STAT
)

371 ià((
i
 & 
STAT_MASK
è!ğ
STAT_OK
)

373 ià((
CURRENT
->
Ä_£ùÜs
 <ğ1è|| (
i
 & 
DRQ_STAT
))

374 
ok_to_wr™e
;

375 } --
»Œ›s
 > 0);

376 
	`¡i
();

377 
	`´štk
("HD: wr™e_šŒ: stu ğ0x%02x\n",
i
);

378 ià(
i
 & 
ERR_STAT
) {

379 
hd_”rÜ
 = (è
	`šb
(
HD_ERROR
);

380 
	`´štk
("HD: wr™e_šŒ:ƒ¼Ü = 0x%02x\n",
hd_”rÜ
);

382 
	`bad_rw_šŒ
();

383 
	`şi
();

384 
	`do_hd_»que¡
();

386 
ok_to_wr™e
:

387 
CURRENT
->
£ùÜ
++;

388 
i
 = --
CURRENT
->
Ä_£ùÜs
;

389 --
CURRENT
->
cu¼’t_Ä_£ùÜs
;

390 
CURRENT
->
bufãr
 += 512;

391 ià(!
i
 || (
CURRENT
->
bh
 && !
	`SUBSECTOR
(i)))

392 
	`’d_»que¡
(1);

393 ià(
i
 > 0) {

394 
	`SET_INTR
(&
wr™e_šŒ
);

395 
	`outsw
(
HD_DATA
,
CURRENT
->
bufãr
,256);

396 
	`¡i
();

398 #ià(
HD_DELAY
 > 0)

399 
Ï¡_»q
 = 
	`»ad_tim”
();

401 
	`do_hd_»que¡
();

404 
	}
}

406 
	$»ÿl_šŒ
()

408 ià(
	`wš_»suÉ
())

409 
	`bad_rw_šŒ
();

410 
	`do_hd_»que¡
();

411 
	}
}

417 
	$hd_times_out
()

419 
DEVICE_INTR
 = 
NULL
;

420 
	`¡i
();

421 
»£t
 = 1;

422 ià(!
CURRENT
)

424 
	`´štk
(
KERN_DEBUG
 "HDimeout\n");

425 
	`şi
();

426 ià(++
CURRENT
->
”rÜs
 >ğ
MAX_ERRORS
) {

427 #ifdeà
DEBUG


428 
	`´štk
("hd :oo manyƒrrors.\n");

430 
	`’d_»que¡
(0);

433 
	`do_hd_»que¡
();

434 
	}
}

443 
	$do_hd_»que¡
()

445 
block
,
dev
;

446 
£c
,
h—d
,
cyl
,
Œack
;

447 
n£ù
;

449 ià(
CURRENT
 && CURRENT->
dev
 < 0) ;

451 ià(
DEVICE_INTR
)

453 
»³©
:

454 
tim”_aùive
 &ğ~(1<<
HD_TIMER
);

455 
	`¡i
();

456 
INIT_REQUEST
;

457 
dev
 = 
	`MINOR
(
CURRENT
->dev);

458 
block
 = 
CURRENT
->
£ùÜ
;

459 
n£ù
 = 
CURRENT
->
Ä_£ùÜs
;

460 ià(
dev
 >ğ(
NR_HD
<<6è|| 
block
 >ğ
hd
[dev].
Ä_£ùs
) {

461 #ifdeà
DEBUG


462 
	`´štk
("hd%d :‡ttempted„ead for sector %d…astƒnd of device‡t sector %d.\n",

463 
block
, 
hd
[
dev
].
Ä_£ùs
);

465 
	`’d_»que¡
(0);

466 
»³©
;

468 
block
 +ğ
hd
[
dev
].
¡¬t_£ù
;

469 
dev
 >>= 6;

470 
£c
 = 
block
 % 
hd_šfo
[
dev
].
£ù
 + 1;

471 
Œack
 = 
block
 / 
hd_šfo
[
dev
].
£ù
;

472 
h—d
 = 
Œack
 % 
hd_šfo
[
dev
].head;

473 
cyl
 = 
Œack
 / 
hd_šfo
[
dev
].
h—d
;

474 #ifdeà
DEBUG


475 
	`´štk
("hd%d : cyl = %d, head = %d, sector = %d, buffer = %08x\n",

476 
dev
, 
cyl
, 
h—d
, 
£c
, 
CURRENT
->
bufãr
);

478 
	`şi
();

479 ià(
»£t
) {

480 
i
;

482 
i
=0; i < 
NR_HD
; i++)

483 
»ÿlib¿‹
[
i
] = 1;

484 
	`»£t_hd
();

485 
	`¡i
();

488 ià(
»ÿlib¿‹
[
dev
]) {

489 
»ÿlib¿‹
[
dev
] = 0;

490 
	`hd_out
(
dev
,
hd_šfo
[dev].
£ù
,0,0,0,
WIN_RESTORE
,&
»ÿl_šŒ
);

491 ià(
»£t
)

492 
»³©
;

493 
	`¡i
();

496 ià(
CURRENT
->
cmd
 =ğ
WRITE
) {

497 
	`hd_out
(
dev
,
n£ù
,
£c
,
h—d
,
cyl
,
WIN_WRITE
,&
wr™e_šŒ
);

498 ià(
»£t
)

499 
»³©
;

500 ià(
	`wa™_DRQ
()) {

501 
	`´štk
("HD: do_hd_request:‚o DRQ\n");

502 
	`bad_rw_šŒ
();

503 
»³©
;

505 
	`outsw
(
HD_DATA
,
CURRENT
->
bufãr
,256);

506 
	`¡i
();

509 ià(
CURRENT
->
cmd
 =ğ
READ
) {

510 
	`hd_out
(
dev
,
n£ù
,
£c
,
h—d
,
cyl
,
WIN_READ
,&
»ad_šŒ
);

511 ià(
»£t
)

512 
»³©
;

513 
	`¡i
();

516 
	`·nic
("unknown hd-command");

517 
	}
}

519 
	$hd_ioùl
(
šode
 * inode, 
fe
 * file,

520 
cmd
, 
¬g
)

522 
hd_geom‘ry
 *
loc
 = (hd_geom‘ry *è
¬g
;

523 
dev
, 
”r
;

525 ià(!
šode
)

526  -
EINVAL
;

527 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) >> 6;

528 ià(
dev
 >ğ
NR_HD
)

529  -
EINVAL
;

530 
cmd
) {

531 
HDIO_GETGEO
:

532 ià(!
loc
è -
EINVAL
;

533 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
loc
, (*loc));

534 ià(
”r
)

535  
”r
;

536 
	`put_fs_by‹
(
hd_šfo
[
dev
].
h—d
,

537 (*è&
loc
->
h—ds
);

538 
	`put_fs_by‹
(
hd_šfo
[
dev
].
£ù
,

539 (*è&
loc
->
£ùÜs
);

540 
	`put_fs_wÜd
(
hd_šfo
[
dev
].
cyl
,

541 (*è&
loc
->
cylšd”s
);

542 
	`put_fs_lÚg
(
hd
[
	`MINOR
(
šode
->
i_rdev
)].
¡¬t_£ù
,

543 (*è&
loc
->
¡¬t
);

545 
BLKGETSIZE
:

546 ià(!
¬g
è -
EINVAL
;

547 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

548 ià(
”r
)

549  
”r
;

550 
	`put_fs_lÚg
(
hd
[
	`MINOR
(
šode
->
i_rdev
)].
Ä_£ùs
,

551 (*è
¬g
);

553 
BLKFLSBUF
:

554 if(!
	`su£r
()è -
EACCES
;

555 if(!
šode
->
i_rdev
è -
EINVAL
;

556 
	`fsync_dev
(
šode
->
i_rdev
);

557 
	`šv®id©e_bufãrs
(
šode
->
i_rdev
);

560 
BLKRRPART
:

561  
	`»v®id©e_hddisk
(
šode
->
i_rdev
, 1);

562 
	`RO_IOCTLS
(
šode
->
i_rdev
,
¬g
);

564  -
EINVAL
;

566 
	}
}

568 
	$hd_İ’
(
šode
 * inode, 
fe
 * 
fp
)

570 
rg‘
;

571 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

573 
busy
[
rg‘
])

574 
	`¦“p_Ú
(&
busy_wa™
);

575 
acûss_couÁ
[
rg‘
]++;

577 
	}
}

583 
	$hd_»Ëa£
(
šode
 * inode, 
fe
 * file)

585 
rg‘
;

586 
	`sync_dev
(
šode
->
i_rdev
);

588 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

589 
acûss_couÁ
[
rg‘
]--;

591 
	}
}

593 
hd_g’š™
();

595 
g’disk
 
	ghd_g’disk
 = {

596 
MAJOR_NR
,

600 
MAX_HD
,

601 
hd_g’š™
,

602 
hd
,

603 
hd_sizes
,

605 (*è
hd_šfo
,

606 
NULL


609 
	$hd_š‹¼u±
(
unu£d
)

611 (*
hªdËr
)(èğ
DEVICE_INTR
;

613 
DEVICE_INTR
 = 
NULL
;

614 
tim”_aùive
 &ğ~(1<<
HD_TIMER
);

615 ià(!
hªdËr
)

616 
hªdËr
 = 
uÃx³ùed_hd_š‹¼u±
;

617 
	`hªdËr
();

618 
	`¡i
();

619 
	}
}

630 
sigaùiÚ
 
	ghd_sigaùiÚ
 = {

631 
hd_š‹¼u±
,

633 
SA_INTERRUPT
,

634 
NULL


637 
	$hd_g’š™
()

639 
drive
, 
i
;

640 
drive_šfo
 drive_info;

641 *
BIOS
 = (*è&
drive_šfo
;

642 
cmos_disks
;

644 ià(!
NR_HD
) {

645 
drive
=0 ; drive<2 ; drive++) {

646 
hd_šfo
[
drive
].
cyl
 = *(*è
BIOS
;

647 
hd_šfo
[
drive
].
h—d
 = *(2+
BIOS
);

648 
hd_šfo
[
drive
].
wpcom
 = *(*è(5+
BIOS
);

649 
hd_šfo
[
drive
].
ùl
 = *(8+
BIOS
);

650 
hd_šfo
[
drive
].
lzÚe
 = *(*è(12+
BIOS
);

651 
hd_šfo
[
drive
].
£ù
 = *(14+
BIOS
);

652 
BIOS
 += 16;

677 ià((
cmos_disks
 = 
	`CMOS_READ
(0x12)) & 0xf0)

678 ià(
cmos_disks
 & 0x0f)

679 
NR_HD
 = 2;

681 
NR_HD
 = 1;

683 
i
 = 
NR_HD
;

684 
i
-- > 0) {

685 
hd
[
i
<<6].
Ä_£ùs
 = 0;

686 ià(
hd_šfo
[
i
].
h—d
 > 16) {

687 
	`´štk
("hd.c: ST-506 interface disk with morehan 16 heads detected,\n");

688 
	`´štk
("…robably dueo‚on-standard sectorranslation. Giving up.\n");

689 
	`´štk
(" (disk %d: cyl=%d, seù=%d, h—d=%d)\n", 
i
,

690 
hd_šfo
[
i
].
cyl
,

691 
hd_šfo
[
i
].
£ù
,

692 
hd_šfo
[
i
].
h—d
);

693 ià(
i
+1 =ğ
NR_HD
)

694 
NR_HD
--;

697 
hd
[
i
<<6].
Ä_£ùs
 = 
hd_šfo
[i].
h—d
*

698 
hd_šfo
[
i
].
£ù
*hd_šfo[i].
cyl
;

700 ià(
NR_HD
) {

701 ià(
	`œqaùiÚ
(
HD_IRQ
,&
hd_sigaùiÚ
)) {

702 
	`´štk
("hd.c: uÇbËØg‘ IRQ%d fÜhh¬ddisk driv”\n",
HD_IRQ
);

703 
NR_HD
 = 0;

706 
hd_g’disk
.
Ä_»®
 = 
NR_HD
;

708 
i
=0;i<(
MAX_HD
 << 6);i++è
hd_blocksizes
[i] = 1024;

709 
blksize_size
[
MAJOR_NR
] = 
hd_blocksizes
;

710 
	}
}

712 
fe_İ”©iÚs
 
	ghd_fİs
 = {

713 
NULL
,

714 
block_»ad
,

715 
block_wr™e
,

716 
NULL
,

717 
NULL
,

718 
hd_ioùl
,

719 
NULL
,

720 
hd_İ’
,

721 
hd_»Ëa£
,

722 
block_fsync


725 
	$hd_š™
(
mem_¡¬t
, 
mem_’d
)

727 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"hd",&
hd_fİs
)) {

728 
	`´štk
("UÇbËØg‘ majÜ %d fÜ h¬ddisk\n",
MAJOR_NR
);

729  
mem_¡¬t
;

731 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

732 
»ad_ah—d
[
MAJOR_NR
] = 8;

733 
hd_g’disk
.
Ãxt
 = 
g’disk_h—d
;

734 
g’disk_h—d
 = &
hd_g’disk
;

735 
tim”_bË
[
HD_TIMER
].
â
 = 
hd_times_out
;

736  
mem_¡¬t
;

737 
	}
}

739 
	#DEVICE_BUSY
 
busy
[
rg‘
]

	)

740 
	#USAGE
 
acûss_couÁ
[
rg‘
]

	)

741 
	#CAPACITY
 (
hd_šfo
[
rg‘
].
h—d
*hd_šfo[rg‘].
£ù
*hd_šfo[rg‘].
cyl
)

	)

744 #undeà
MAYBE_REINIT


745 
	#GENDISK_STRUCT
 
hd_g’disk


	)

755 
	$»v®id©e_hddisk
(
dev
, 
maxu§ge
)

757 
rg‘
, 
majÜ
;

758 
g’disk
 * 
gdev
;

759 
max_p
;

760 
¡¬t
;

761 
i
;

763 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
dev
));

764 
gdev
 = &
GENDISK_STRUCT
;

766 
	`şi
();

767 ià(
DEVICE_BUSY
 || 
USAGE
 > 
maxu§ge
) {

768 
	`¡i
();

769  -
EBUSY
;

771 
DEVICE_BUSY
 = 1;

772 
	`¡i
();

774 
max_p
 = 
gdev
->max_p;

775 
¡¬t
 = 
rg‘
 << 
gdev
->
mšÜ_shiá
;

776 
majÜ
 = 
MAJOR_NR
 << 8;

778 
i
=
max_p
 - 1; i >=0 ; i--) {

779 
	`sync_dev
(
majÜ
 | 
¡¬t
 | 
i
);

780 
	`šv®id©e_šodes
(
majÜ
 | 
¡¬t
 | 
i
);

781 
	`šv®id©e_bufãrs
(
majÜ
 | 
¡¬t
 | 
i
);

782 
gdev
->
·¹
[
¡¬t
+
i
].
¡¬t_£ù
 = 0;

783 
gdev
->
·¹
[
¡¬t
+
i
].
Ä_£ùs
 = 0;

786 #ifdeà
MAYBE_REINIT


787 
MAYBE_REINIT
;

790 
gdev
->
·¹
[
¡¬t
].
Ä_£ùs
 = 
CAPACITY
;

791 
	`»£tup_Úe_dev
(
gdev
, 
rg‘
);

793 
DEVICE_BUSY
 = 0;

794 
	`wake_up
(&
busy_wa™
);

796 
	}
}

	@drivers/block/ll_rw_blk.c

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/k”Ãl_¡©.h
>

13 
	~<lšux/”ºo.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/cÚfig.h
>

16 
	~<lšux/locks.h
>

18 
	~<asm/sy¡em.h
>

20 
	~"blk.h
"

22 #ifdeà
CONFIG_SBPCD


23 
u_lÚg
 
sbpcd_š™
(u_long, u_long);

30 
»que¡
 
	g®l_»que¡s
[
NR_REQUEST
];

35 
wa™_queue
 * 
	gwa™_fÜ_»que¡
 = 
NULL
;

39 
	g»ad_ah—d
[
MAX_BLKDEV
] = {0, };

45 
blk_dev_¡ruù
 
	gblk_dev
[
MAX_BLKDEV
] = {

46 { 
NULL
, NULL },

47 { 
NULL
, NULL },

48 { 
NULL
, NULL },

49 { 
NULL
, NULL },

50 { 
NULL
, NULL },

51 { 
NULL
, NULL },

52 { 
NULL
, NULL },

53 { 
NULL
, NULL },

54 { 
NULL
, NULL },

55 { 
NULL
, NULL }

66 * 
	gblk_size
[
MAX_BLKDEV
] = { 
NULL
, NULL, };

75 * 
	gblksize_size
[
MAX_BLKDEV
] = { 
NULL
, NULL, };

82 
šlše
 
»que¡
 * 
	$g‘_»que¡
(
n
, 
dev
)

84 
»que¡
 *
´ev_found
 = 
NULL
, *
´ev_lim™
 = NULL;

85 
»que¡
 *
»q
, *
lim™
;

87 ià(
n
 <= 0)

88 
	`·nic
("g‘_»que¡(%d): impossibË!\n", 
n
);

90 
lim™
 = 
®l_»que¡s
 + 
n
;

91 ià(
lim™
 !ğ
´ev_lim™
) {

92 
´ev_lim™
 = 
lim™
;

93 
´ev_found
 = 
®l_»que¡s
;

95 
»q
 = 
´ev_found
;

97 
»q
 = (Ôeq > 
®l_»que¡s
è?„eq : 
lim™
) - 1;

98 ià(
»q
->
dev
 < 0)

100 ià(
»q
 =ğ
´ev_found
)

101  
NULL
;

103 
´ev_found
 = 
»q
;

104 
»q
->
dev
 = dev;

105  
»q
;

106 
	}
}

113 
šlše
 
»que¡
 * 
	$g‘_»que¡_wa™
(
n
, 
dev
)

115 
»que¡
 *
»q
;

117 (
»q
 = 
	`g‘_»que¡
(
n
, 
dev
)è=ğ
NULL
)

118 
	`¦“p_Ú
(&
wa™_fÜ_»que¡
);

119  
»q
;

120 
	}
}

124 
	gro_b™s
[
MAX_BLKDEV
][8];

126 
	$is_»ad_Úly
(
dev
)

128 
mšÜ
,
majÜ
;

130 
majÜ
 = 
	`MAJOR
(
dev
);

131 
mšÜ
 = 
	`MINOR
(
dev
);

132 ià(
majÜ
 < 0 || majÜ >ğ
MAX_BLKDEV
)  0;

133  
ro_b™s
[
majÜ
][
mšÜ
 >> 5] & (1 << (minor & 31));

134 
	}
}

136 
	$£t_deviû_ro
(
dev
,
æag
)

138 
mšÜ
,
majÜ
;

140 
majÜ
 = 
	`MAJOR
(
dev
);

141 
mšÜ
 = 
	`MINOR
(
dev
);

142 ià(
majÜ
 < 0 || majÜ >ğ
MAX_BLKDEV
) ;

143 ià(
æag
è
ro_b™s
[
majÜ
][
mšÜ
 >> 5] |= 1 << (minor & 31);

144 
ro_b™s
[
majÜ
][
mšÜ
 >> 5] &= ~(1 << (minor & 31));

145 
	}
}

152 
	$add_»que¡
(
blk_dev_¡ruù
 * 
dev
, 
»que¡
 * 
»q
)

154 
»que¡
 * 
tmp
;

156 
»q
->
Ãxt
 = 
NULL
;

157 
	`şi
();

158 ià(
»q
->
bh
)

159 
»q
->
bh
->
b_dœt
 = 0;

160 ià(!(
tmp
 = 
dev
->
cu¼’t_»que¡
)) {

161 
dev
->
cu¼’t_»que¡
 = 
»q
;

162 (
dev
->
»que¡_â
)();

163 
	`¡i
();

166  ; 
tmp
->
Ãxt
 ;mp =mp->next) {

167 ià((
	`IN_ORDER
(
tmp
,
»q
) ||

168 !
	`IN_ORDER
(
tmp
,tmp->
Ãxt
)) &&

169 
	`IN_ORDER
(
»q
,
tmp
->
Ãxt
))

172 
»q
->
Ãxt
 = 
tmp
->next;

173 
tmp
->
Ãxt
 = 
»q
;

176 ià(
	`scsi_majÜ
(
	`MAJOR
(
»q
->
dev
)))

177 (
dev
->
»que¡_â
)();

179 
	`¡i
();

180 
	}
}

182 
	$make_»que¡
(
majÜ
,
rw
, 
bufãr_h—d
 * 
bh
)

184 
£ùÜ
, 
couÁ
;

185 
»que¡
 * 
»q
;

186 
rw_ah—d
, 
max_»q
;

190 
rw_ah—d
 = (
rw
 =ğ
READA
 ||„w =ğ
WRITEA
);

191 ià(
rw_ah—d
) {

192 ià(
bh
->
b_lock
)

194 ià(
rw
 =ğ
READA
)

195 
rw
 = 
READ
;

197 
rw
 = 
WRITE
;

199 ià(
rw
!=
READ
 &&„w!=
WRITE
) {

200 
	`´štk
("Bad block dev command, must be R/W/RA/WA\n");

203 
couÁ
 = 
bh
->
b_size
 >> 9;

204 
£ùÜ
 = 
bh
->
b_blockÄ
 * 
couÁ
;

205 ià(
blk_size
[
majÜ
])

206 ià(
blk_size
[
majÜ
][
	`MINOR
(
bh
->
b_dev
)] < (
£ùÜ
 + 
couÁ
)>>1) {

207 
bh
->
b_dœt
 = bh->
b_u±od©e
 = 0;

210 
	`lock_bufãr
(
bh
);

211 ià((
rw
 =ğ
WRITE
 && !
bh
->
b_dœt
è|| (rw =ğ
READ
 && bh->
b_u±od©e
)) {

212 
	`uÆock_bufãr
(
bh
);

220 
max_»q
 = (
rw
 =ğ
READ
è? 
NR_REQUEST
 : ((NR_REQUEST*2)/3);

224 
»³©
:

225 
	`şi
();

231 ià((
majÜ
 =ğ
HD_MAJOR


232 || 
majÜ
 =ğ
SCSI_DISK_MAJOR


233 || 
majÜ
 =ğ
SCSI_CDROM_MAJOR
)

234 && (
»q
 = 
blk_dev
[
majÜ
].
cu¼’t_»que¡
))

236 ià(
majÜ
 =ğ
HD_MAJOR
)

237 
»q
 =„eq->
Ãxt
;

238 
»q
) {

239 ià(
»q
->
dev
 =ğ
bh
->
b_dev
 &&

240 !
»q
->
wa™šg
 &&

241 
»q
->
cmd
 =ğ
rw
 &&

242 
»q
->
£ùÜ
 +„eq->
Ä_£ùÜs
 == sector &&

243 
»q
->
Ä_£ùÜs
 < 254)

245 
»q
->
bh
->
b_»qÃxt
 = 
bh
;

246 
»q
->
bh
 = 
bh
;

247 
»q
->
Ä_£ùÜs
 +ğ
couÁ
;

248 
bh
->
b_dœt
 = 0;

249 
	`¡i
();

253 ià(
»q
->
dev
 =ğ
bh
->
b_dev
 &&

254 !
»q
->
wa™šg
 &&

255 
»q
->
cmd
 =ğ
rw
 &&

256 
»q
->
£ùÜ
 - 
couÁ
 == sector &&

257 
»q
->
Ä_£ùÜs
 < 254)

259 
»q
->
Ä_£ùÜs
 +ğ
couÁ
;

260 
bh
->
b_»qÃxt
 = 
»q
->bh;

261 
»q
->
bufãr
 = 
bh
->
b_d©a
;

262 
»q
->
cu¼’t_Ä_£ùÜs
 = 
couÁ
;

263 
»q
->
£ùÜ
 = sector;

264 
bh
->
b_dœt
 = 0;

265 
»q
->
bh
 = bh;

266 
	`¡i
();

270 
»q
 =„eq->
Ãxt
;

275 
»q
 = 
	`g‘_»que¡
(
max_»q
, 
bh
->
b_dev
);

278 ià(! 
»q
) {

279 ià(
rw_ah—d
) {

280 
	`¡i
();

281 
	`uÆock_bufãr
(
bh
);

284 
	`¦“p_Ú
(&
wa™_fÜ_»que¡
);

285 
	`¡i
();

286 
»³©
;

290 
	`¡i
();

293 
»q
->
cmd
 = 
rw
;

294 
»q
->
”rÜs
 = 0;

295 
»q
->
£ùÜ
 = sector;

296 
»q
->
Ä_£ùÜs
 = 
couÁ
;

297 
»q
->
cu¼’t_Ä_£ùÜs
 = 
couÁ
;

298 
»q
->
bufãr
 = 
bh
->
b_d©a
;

299 
»q
->
wa™šg
 = 
NULL
;

300 
»q
->
bh
 = bh;

301 
»q
->
bh
 = 
bh
;

302 
»q
->
Ãxt
 = 
NULL
;

303 
	`add_»que¡
(
majÜ
+
blk_dev
,
»q
);

304 
	}
}

306 
	$Î_rw_·ge
(
rw
, 
dev
, 
·ge
, * 
bufãr
)

308 
»que¡
 * 
»q
;

309 
majÜ
 = 
	`MAJOR
(
dev
);

311 ià(
majÜ
 >ğ
MAX_BLKDEV
 || !(
blk_dev
[majÜ].
»que¡_â
)) {

312 
	`´štk
("TryšgØ»ad‚Úexi¡’ˆblock-deviû %04x (%d)\n",
dev
,
·ge
*8);

315 ià(
rw
!=
READ
 &&„w!=
WRITE
)

316 
	`·nic
("Bad block dev command, must be R/W");

317 ià(
rw
 =ğ
WRITE
 && 
	`is_»ad_Úly
(
dev
)) {

318 
	`´štk
("Cª'ˆ·gtØ»ad-Úly deviû 0x%X\n",
dev
);

321 
	`şi
();

322 
»q
 = 
	`g‘_»que¡_wa™
(
NR_REQUEST
, 
dev
);

323 
	`¡i
();

325 
»q
->
cmd
 = 
rw
;

326 
»q
->
”rÜs
 = 0;

327 
»q
->
£ùÜ
 = 
·ge
<<3;

328 
»q
->
Ä_£ùÜs
 = 8;

329 
»q
->
cu¼’t_Ä_£ùÜs
 = 8;

330 
»q
->
bufãr
 = buffer;

331 
»q
->
wa™šg
 = 
cu¼’t
;

332 
»q
->
bh
 = 
NULL
;

333 
»q
->
Ãxt
 = 
NULL
;

334 
cu¼’t
->
¡©e
 = 
TASK_SWAPPING
;

335 
	`add_»que¡
(
majÜ
+
blk_dev
,
»q
);

336 
	`scheduË
();

337 
	}
}

343 
	$Î_rw_block
(
rw
, 
Ä
, 
bufãr_h—d
 * 
bh
[])

345 
majÜ
;

346 
»que¡
 
¶ug
;

347 
¶ugged
;

348 
cÜ»ù_size
;

349 
blk_dev_¡ruù
 * 
dev
;

350 
i
;

353 !*
bh
) {

354 
bh
++;

355 ià(--
Ä
 <= 0)

359 
dev
 = 
NULL
;

360 ià((
majÜ
 = 
	`MAJOR
(
bh
[0]->
b_dev
)è< 
MAX_BLKDEV
)

361 
dev
 = 
blk_dev
 + 
majÜ
;

362 ià(!
dev
 || !dev->
»que¡_â
) {

363 
	`´štk
(

365 (è
bh
[0]->
b_dev
, bh[0]->
b_blockÄ
);

366 
sÜry
;

370 
cÜ»ù_size
 = 
BLOCK_SIZE
;

371 ià(
blksize_size
[
majÜ
]) {

372 
i
 = 
blksize_size
[
majÜ
][
	`MINOR
(
bh
[0]->
b_dev
)];

373 ià(
i
)

374 
cÜ»ù_size
 = 
i
;

378 
i
 = 0; i < 
Ä
; i++) {

379 ià(
bh
[
i
] && bh[i]->
b_size
 !ğ
cÜ»ù_size
) {

380 
	`´štk
(

382 
cÜ»ù_size
, 
bh
[
i
]->
b_size
);

383 
sÜry
;

387 ià((
rw
 =ğ
WRITE
 ||„w =ğ
WRITEA
è&& 
	`is_»ad_Úly
(
bh
[0]->
b_dev
)) {

388 
	`´štk
("Cª'ˆwr™tØ»ad-Úly deviû 0x%X\n",
bh
[0]->
b_dev
);

389 
sÜry
;

397 
¶ugged
 = 0;

398 
	`şi
();

399 ià(!
dev
->
cu¼’t_»que¡
 && 
Ä
 > 1) {

400 
dev
->
cu¼’t_»que¡
 = &
¶ug
;

401 
¶ug
.
dev
 = -1;

402 
¶ug
.
Ãxt
 = 
NULL
;

403 
¶ugged
 = 1;

405 
	`¡i
();

406 
i
 = 0; i < 
Ä
; i++) {

407 ià(
bh
[
i
]) {

408 
bh
[
i
]->
b_»q
 = 1;

409 
	`make_»que¡
(
majÜ
, 
rw
, 
bh
[
i
]);

410 ià(
rw
 =ğ
READ
 ||„w =ğ
READA
)

411 
k¡©
.
pgpgš
++;

413 
k¡©
.
pgpgout
++;

416 ià(
¶ugged
) {

417 
	`şi
();

418 
dev
->
cu¼’t_»que¡
 = 
¶ug
.
Ãxt
;

419 (
dev
->
»que¡_â
)();

420 
	`¡i
();

424 
sÜry
:

425 
i
 = 0; i < 
Ä
; i++) {

426 ià(
bh
[
i
])

427 
bh
[
i
]->
b_dœt
 = bh[i]->
b_u±od©e
 = 0;

430 
	}
}

432 
	$Î_rw_sw­_fe
(
rw
, 
dev
, *
b
, 
nb
, *
buf
)

434 
i
;

435 
bufãrsize
;

436 
»que¡
 * 
»q
;

437 
majÜ
 = 
	`MAJOR
(
dev
);

439 ià(
majÜ
 >ğ
MAX_BLKDEV
 || !(
blk_dev
[majÜ].
»que¡_â
)) {

440 
	`´štk
("ll_rw_swap_file:ryingo swap‚onexistent block-device\n");

444 ià(
rw
!=
READ
 &&„w!=
WRITE
) {

445 
	`´štk
("ll_rw_swap: bad block dev command, must be R/W");

448 ià(
rw
 =ğ
WRITE
 && 
	`is_»ad_Úly
(
dev
)) {

449 
	`´štk
("Cª'ˆsw­Ø»ad-Úly deviû 0x%X\n",
dev
);

453 
bufãrsize
 = 
PAGE_SIZE
 / 
nb
;

455 
i
=0; i<
nb
; i++, 
buf
 +ğ
bufãrsize
)

457 
	`şi
();

458 
»q
 = 
	`g‘_»que¡_wa™
(
NR_REQUEST
, 
dev
);

459 
	`¡i
();

460 
»q
->
cmd
 = 
rw
;

461 
»q
->
”rÜs
 = 0;

462 
»q
->
£ùÜ
 = (
b
[
i
] * 
bufãrsize
) >> 9;

463 
»q
->
Ä_£ùÜs
 = 
bufãrsize
 >> 9;

464 
»q
->
cu¼’t_Ä_£ùÜs
 = 
bufãrsize
 >> 9;

465 
»q
->
bufãr
 = 
buf
;

466 
»q
->
wa™šg
 = 
cu¼’t
;

467 
»q
->
bh
 = 
NULL
;

468 
»q
->
Ãxt
 = 
NULL
;

469 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

470 
	`add_»que¡
(
majÜ
+
blk_dev
,
»q
);

471 
	`scheduË
();

473 
	}
}

475 
	$blk_dev_š™
(
mem_¡¬t
, 
mem_’d
)

477 
»que¡
 * 
»q
;

479 
»q
 = 
®l_»que¡s
 + 
NR_REQUEST
;

480 --
»q
 >ğ
®l_»que¡s
) {

481 
»q
->
dev
 = -1;

482 
»q
->
Ãxt
 = 
NULL
;

484 
	`mem£t
(
ro_b™s
,0,(ro_bits));

485 #ifdeà
CONFIG_BLK_DEV_HD


486 
mem_¡¬t
 = 
	`hd_š™
(mem_¡¬t,
mem_’d
);

488 #ifdeà
CONFIG_BLK_DEV_XD


489 
mem_¡¬t
 = 
	`xd_š™
(mem_¡¬t,
mem_’d
);

491 #ifdeà
CONFIG_CDU31A


492 
mem_¡¬t
 = 
	`cdu31a_š™
(mem_¡¬t,
mem_’d
);

494 #ifdeà
CONFIG_MCD


495 
mem_¡¬t
 = 
	`mcd_š™
(mem_¡¬t,
mem_’d
);

497 #ifdeà
CONFIG_SBPCD


498 
mem_¡¬t
 = 
	`sbpcd_š™
(mem_¡¬t, 
mem_’d
);

500 ià(
¿mdisk_size
)

501 
mem_¡¬t
 +ğ
	`rd_š™
(mem_¡¬t, 
¿mdisk_size
*1024);

502  
mem_¡¬t
;

503 
	}
}

	@drivers/block/mcd.c

36 
	~<lšux/”ºo.h
>

37 
	~<lšux/sigÇl.h
>

38 
	~<lšux/sched.h
>

39 
	~<lšux/tim”.h
>

40 
	~<lšux/fs.h
>

41 
	~<lšux/k”Ãl.h
>

42 
	~<lšux/cdrom.h
>

43 
	~<lšux/iİÜt.h
>

46 
	~<asm/sy¡em.h
>

47 
	~<asm/io.h
>

48 
	~<asm/£gm’t.h
>

50 
	#MAJOR_NR
 
MITSUMI_CDROM_MAJOR


	)

51 
	~"blk.h
"

52 
	~<lšux/mcd.h
>

55 
	gmcd_sizes
[] = { 0 };

58 
	gmcdP»£Á
 = 0;

60 
	gmcd_buf
[2048];

61 
	gmcd_bn
 = -1;

62 
	gmcd_pÜt
 = 
MCD_BASE_ADDR
;

63 
	gmcd_œq
 = 
MCD_INTR_NR
;

65 
	gMcdTimeout
, 
	gMcdTr›s
;

66 
wa™_queue
 *
	gmcd_wa™q
 = 
NULL
;

68 
mcd_DiskInfo
 
	gDiskInfo
;

69 
mcd_Toc
 
	gToc
[
MAX_TRACKS
];

70 
mcd_PÏy_msf
 
	gmcd_PÏy
;

72 
	gaudioStus
;

73 
	gmcdDiskChªged
;

74 
	gtocUpToD©e
;

75 
	gmcdV”siÚ
;

77 
mcd_Œªsãr
();

78 
mcd_¡¬t
();

79 
mcd_¡©us
();

80 
mcd_»ad_cmd
();

81 
mcd_d©a
();

82 
do_mcd_»que¡
();

83 
hsg2msf
(
hsg
, 
msf
 *msf);

84 
bš2bcd
(*
p
);

85 
bcd2bš
(
bcd
);

86 
mcdStus
();

87 
£ndMcdCmd
(
cmd
, 
mcd_PÏy_msf
 *
·¿ms
);

88 
g‘McdStus
(
timeout
);

89 
G‘QChªÃlInfo
(
mcd_Toc
 *
qp
);

90 
upd©eToc
();

91 
G‘DiskInfo
();

92 
G‘Toc
();

93 
g‘V®ue
(*
»suÉ
);

96 
	$mcd_£tup
(*
¡r
, *
šts
)

98 ià(
šts
[0] > 0)

99 
mcd_pÜt
 = 
šts
[1];

100 ià(
šts
[0] > 1)

101 
mcd_œq
 = 
šts
[2];

102 
	}
}

106 
	$check_mcd_medŸ_chªge
(
fuÎ_dev
, 
æag
)

108 
»tv®
, 
rg‘
;

114 
rg‘
 = 
	`MINOR
(
fuÎ_dev
);

116 ià(
rg‘
 > 0) {

117 
	`´štk
("mcd: Mitsumi CD-ROM„equestƒrror: invalid device.\n");

121 
»tv®
 = 
mcdDiskChªged
;

122 ià(!
æag
)

124 
mcdDiskChªged
 = 0;

127  
»tv®
;

128 
	}
}

137 
	$¡©usCmd
()

139 
¡
, 
»Œy
;

141 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

144 
	`outb
(
MCMD_GET_STATUS
, 
	`MCDPORT
(0));

145 
¡
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

146 ià(
¡
 != -1)

150  
¡
;

151 
	}
}

159 
	$mcdPÏy
(
mcd_PÏy_msf
 *
¬g
)

161 
»Œy
, 
¡
;

163 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

165 
	`£ndMcdCmd
(
MCMD_PLAY_READ
, 
¬g
);

166 
¡
 = 
	`g‘McdStus
(2 * 
MCD_STATUS_DELAY
);

167 ià(
¡
 != -1)

171  
¡
;

172 
	}
}

176 
	$msf2hsg
(
msf
 *
mp
)

178  
	`bcd2bš
(
mp
 -> 
äame
)

179 + 
	`bcd2bš
(
mp
 -> 
£c
) * 75

180 + 
	`bcd2bš
(
mp
 -> 
mš
) * 4500

182 
	}
}

186 
	$mcd_ioùl
(
šode
 *

, 
fe
 *
å
, 
cmd
,

187 
¬g
)

189 
i
, 
¡
;

190 
mcd_Toc
 
qInfo
;

191 
cdrom_ti
 
ti
;

192 
cdrom_tochdr
 
tocHdr
;

193 
cdrom_msf
 
msf
;

194 
cdrom_toûÁry
 
’Œy
;

195 
mcd_Toc
 *
tocPŒ
;

196 
cdrom_subchÆ
 
subchÆ
;

198 
cdrom_vŞù¾
 
vŞù¾
;

201 ià(!

)

202  -
EINVAL
;

204 
¡
 = 
	`¡©usCmd
();

205 ià(
¡
 < 0)

206  -
EIO
;

208 ià(!
tocUpToD©e
)

210 
i
 = 
	`upd©eToc
();

211 ià(
i
 < 0)

212  
i
;

215 
cmd
)

217 
CDROMSTART
:

225 
CDROMSTOP
:

226 
	`outb
(
MCMD_STOP
, 
	`MCDPORT
(0));

227 
i
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

231 
audioStus
 = 
CDROM_AUDIO_NO_STATUS
;

234 
CDROMPAUSE
:

235 ià(
audioStus
 !ğ
CDROM_AUDIO_PLAY
)

236  -
EINVAL
;

238 
	`outb
(
MCMD_STOP
, 
	`MCDPORT
(0));

239 
i
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

241 ià(
	`G‘QChªÃlInfo
(&
qInfo
) < 0)

245 
audioStus
 = 
CDROM_AUDIO_NO_STATUS
;

249 
mcd_PÏy
.
¡¬t
 = 
qInfo
.
diskTime
;

251 
audioStus
 = 
CDROM_AUDIO_PAUSED
;

254 
CDROMRESUME
:

255 ià(
audioStus
 !ğ
CDROM_AUDIO_PAUSED
)

256  -
EINVAL
;

260 
i
 = 
	`mcdPÏy
(&
mcd_PÏy
);

261 ià(
i
 < 0)

263 
audioStus
 = 
CDROM_AUDIO_ERROR
;

264  -
EIO
;

267 
audioStus
 = 
CDROM_AUDIO_PLAY
;

270 
CDROMPLAYTRKIND
:

272 
¡
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
,  
ti
);

273 ià(
¡
)

274  
¡
;

276 
	`memıy_äomfs
(&
ti
, (*è
¬g
, i);

278 ià(
ti
.
cdti_Œk0
 < 
DiskInfo
.
fœ¡


279 || 
ti
.
cdti_Œk0
 > 
DiskInfo
.
Ï¡


280 || 
ti
.
cdti_Œk1
 <i.
cdti_Œk0
)

282  -
EINVAL
;

285 ià(
ti
.
cdti_Œk1
 > 
DiskInfo
.
Ï¡
)

286 
ti
. 
cdti_Œk1
 = 
DiskInfo
.
Ï¡
;

288 
mcd_PÏy
.
¡¬t
 = 
Toc
[
ti
.
cdti_Œk0
].
diskTime
;

289 
mcd_PÏy
.
’d
 = 
Toc
[
ti
.
cdti_Œk1
 + 1].
diskTime
;

291 #ifdeà
MCD_DEBUG


292 
	`´štk
("play: %02x:%02x.%02xo %02x:%02x.%02x\n",

293 
mcd_PÏy
.
¡¬t
.
mš
, mcd_PÏy.¡¬t.
£c
, mcd_PÏy.¡¬t.
äame
,

294 
mcd_PÏy
.
’d
.
mš
, mcd_PÏy.’d.
£c
, mcd_PÏy.’d.
äame
);

297 
i
 = 
	`mcdPÏy
(&
mcd_PÏy
);

298 ià(
i
 < 0)

300 
audioStus
 = 
CDROM_AUDIO_ERROR
;

301  -
EIO
;

304 
audioStus
 = 
CDROM_AUDIO_PLAY
;

307 
CDROMPLAYMSF
:

309 ià(
audioStus
 =ğ
CDROM_AUDIO_PLAY
) {

310 
	`outb
(
MCMD_STOP
, 
	`MCDPORT
(0));

311 
i
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

312 
audioStus
 = 
CDROM_AUDIO_NO_STATUS
;

315 
¡
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
,  
msf
);

316 ià(
¡
)

317  
¡
;

319 
	`memıy_äomfs
(&
msf
, (*è
¬g
,  msf);

323 
	`bš2bcd
(&
msf
.
cdmsf_mš0
);

324 
	`bš2bcd
(&
msf
.
cdmsf_£c0
);

325 
	`bš2bcd
(&
msf
.
cdmsf_äame0
);

326 
	`bš2bcd
(&
msf
.
cdmsf_mš1
);

327 
	`bš2bcd
(&
msf
.
cdmsf_£c1
);

328 
	`bš2bcd
(&
msf
.
cdmsf_äame1
);

330 
mcd_PÏy
.
¡¬t
.
mš
 = 
msf
.
cdmsf_mš0
;

331 
mcd_PÏy
.
¡¬t
.
£c
 = 
msf
.
cdmsf_£c0
;

332 
mcd_PÏy
.
¡¬t
.
äame
 = 
msf
.
cdmsf_äame0
;

333 
mcd_PÏy
.
’d
.
mš
 = 
msf
.
cdmsf_mš1
;

334 
mcd_PÏy
.
’d
.
£c
 = 
msf
.
cdmsf_£c1
;

335 
mcd_PÏy
.
’d
.
äame
 = 
msf
.
cdmsf_äame1
;

337 #ifdeà
MCD_DEBUG


338 
	`´štk
("play: %02x:%02x.%02xo %02x:%02x.%02x\n",

339 
mcd_PÏy
.
¡¬t
.
mš
, mcd_PÏy.¡¬t.
£c
, mcd_PÏy.¡¬t.
äame
,

340 
mcd_PÏy
.
’d
.
mš
, mcd_PÏy.’d.
£c
, mcd_PÏy.’d.
äame
);

343 
i
 = 
	`mcdPÏy
(&
mcd_PÏy
);

344 ià(
i
 < 0)

346 
audioStus
 = 
CDROM_AUDIO_ERROR
;

347  -
EIO
;

350 
audioStus
 = 
CDROM_AUDIO_PLAY
;

353 
CDROMREADTOCHDR
:

354 
¡
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,  
tocHdr
);

355 ià(
¡
)

356  
¡
;

358 
tocHdr
.
cdth_Œk0
 = 
DiskInfo
.
fœ¡
;

359 
tocHdr
.
cdth_Œk1
 = 
DiskInfo
.
Ï¡
;

360 
	`memıy_tofs
((*è
¬g
, &
tocHdr
, ocHdr);

363 
CDROMREADTOCENTRY
:

365 
¡
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,  
’Œy
);

366 ià(
¡
)

367  
¡
;

369 
	`memıy_äomfs
(&
’Œy
, (*è
¬g
, ƒntry);

370 ià(
’Œy
.
cd‹_Œack
 =ğ
CDROM_LEADOUT
)

372 
tocPŒ
 = &
Toc
[
DiskInfo
.
Ï¡
 + 1];

374 ià(
’Œy
.
cd‹_Œack
 > 
DiskInfo
.
Ï¡


375 || 
’Œy
.
cd‹_Œack
 < 
DiskInfo
.
fœ¡
)

376  -
EINVAL
;

379 
tocPŒ
 = &
Toc
[
’Œy
.
cd‹_Œack
];

381 
’Œy
.
cd‹_adr
 = 
tocPŒ
 -> 
ù¾_addr
;

382 
’Œy
.
cd‹_ù¾
 = 
tocPŒ
 -> 
ù¾_addr
 >> 4;

384 ià(
’Œy
.
cd‹_fÜm©
 =ğ
CDROM_LBA
)

385 
’Œy
.
cd‹_addr
.
lba
 = 
	`msf2hsg
(&
tocPŒ
 -> 
diskTime
);

387 ià(
’Œy
.
cd‹_fÜm©
 =ğ
CDROM_MSF
)

389 
’Œy
.
cd‹_addr
.
msf
.
mšu‹
 = 
	`bcd2bš
(
tocPŒ
 -> 
diskTime
.
mš
);

390 
’Œy
.
cd‹_addr
.
msf
.
£cÚd
 = 
	`bcd2bš
(
tocPŒ
 -> 
diskTime
.
£c
);

391 
’Œy
.
cd‹_addr
.
msf
.
äame
 = 
	`bcd2bš
(
tocPŒ
 -> 
diskTime
.frame);

395  -
EINVAL
;

397 
	`memıy_tofs
((*è
¬g
, &
’Œy
, ƒntry);

400 
CDROMSUBCHNL
:

402 
¡
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,  
subchÆ
);

403 ià(
¡
)

404  
¡
;

406 
	`memıy_äomfs
(&
subchÆ
, (*è
¬g
,  subchnl);

408 ià(
	`G‘QChªÃlInfo
(&
qInfo
) < 0)

409  -
EIO
;

411 
subchÆ
.
cdsc_audio¡©us
 = 
audioStus
;

412 
subchÆ
.
cdsc_adr
 = 
qInfo
.
ù¾_addr
;

413 
subchÆ
.
cdsc_ù¾
 = 
qInfo
.
ù¾_addr
 >> 4;

414 
subchÆ
.
cdsc_Œk
 = 
	`bcd2bš
(
qInfo
.
Œack
);

415 
subchÆ
.
cdsc_šd
 = 
	`bcd2bš
(
qInfo
.
poštIndex
);

417 ià(
subchÆ
.
cdsc_fÜm©
 =ğ
CDROM_LBA
)

419 
subchÆ
.
cdsc_ab§ddr
.
lba
 = 
	`msf2hsg
(&
qInfo
.
diskTime
);

420 
subchÆ
.
cdsc_»Ïddr
.
lba
 = 
	`msf2hsg
(&
qInfo
.
ŒackTime
);

423 ià(
subchÆ
.
cdsc_fÜm©
 =ğ
CDROM_MSF
)

425 
subchÆ
.
cdsc_ab§ddr
.
msf
.
mšu‹
 = 
	`bcd2bš
(
qInfo
.
diskTime
.
mš
);

426 
subchÆ
.
cdsc_ab§ddr
.
msf
.
£cÚd
 = 
	`bcd2bš
(
qInfo
.
diskTime
.
£c
);

427 
subchÆ
.
cdsc_ab§ddr
.
msf
.
äame
 = 
	`bcd2bš
(
qInfo
.
diskTime
.frame);

429 
subchÆ
.
cdsc_»Ïddr
.
msf
.
mšu‹
 = 
	`bcd2bš
(
qInfo
.
ŒackTime
.
mš
);

430 
subchÆ
.
cdsc_»Ïddr
.
msf
.
£cÚd
 = 
	`bcd2bš
(
qInfo
.
ŒackTime
.
£c
);

431 
subchÆ
.
cdsc_»Ïddr
.
msf
.
äame
 = 
	`bcd2bš
(
qInfo
.
ŒackTime
.frame);

435  -
EINVAL
;

437 
	`memıy_tofs
((*è
¬g
, &
subchÆ
,  subchnl);

440 
CDROMVOLCTRL
:

447 
¡
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
vŞù¾
));

448 ià(
¡
)

449  
¡
;

451 
	`memıy_äomfs
(&
vŞù¾
, (*è
¬g
, (volctrl));

452 
	`´štk
("VOL %d %d\n", 
vŞù¾
.
chªÃl0
 & 0xFF, vŞù¾.
chªÃl1
 & 0xFF);

453 
	`outb
(
MCMD_SET_VOLUME
, 
	`MCDPORT
(0));

454 
	`outb
(
vŞù¾
.
chªÃl0
, 
	`MCDPORT
(0));

455 
	`outb
(0, 
	`MCDPORT
(0));

456 
	`outb
(
vŞù¾
.
chªÃl1
, 
	`MCDPORT
(0));

457 
	`outb
(1, 
	`MCDPORT
(0));

459 
i
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

460 ià(
i
 < 0)

461  -
EIO
;

464 
a
, 
b
, 
c
, 
d
;

466 
	`g‘V®ue
(&
a
);

467 
	`g‘V®ue
(&
b
);

468 
	`g‘V®ue
(&
c
);

469 
	`g‘V®ue
(&
d
);

470 
	`´štk
("%02X %02X %02X %02X\n", 
a
, 
b
, 
c
, 
d
);

473 
	`outb
(0xF8, 
	`MCDPORT
(0));

474 
i
 = 
	`g‘McdStus
(
MCD_STATUS_DELAY
);

475 
	`´štk
("F8 -> %02X\n", 
i
 & 0xFF);

479 
CDROMEJECT
:

483  -
EINVAL
;

485 
	}
}

494 
	$mcd_Œªsãr
()

496 
offs
;

498 
CURRENT
 -> 
Ä_£ùÜs
 > 0 && 
mcd_bn
 =ğCURRENT -> 
£ùÜ
 / 4)

500 
offs
 = (
CURRENT
 -> 
£ùÜ
 & 3) * 512;

501 
	`memıy
(
CURRENT
 -> 
bufãr
, 
mcd_buf
 + 
offs
, 512);

502 
CURRENT
 -> 
Ä_£ùÜs
--;

503 
CURRENT
 -> 
£ùÜ
++;

504 
CURRENT
 -> 
bufãr
 += 512;

506 
	}
}

515 
	$mcd_š‹¼u±
(
unu£d
)

517 
¡
;

519 
¡
 = 
	`šb
(
	`MCDPORT
(1)) & 0xFF;

520 ià(
¡
 != 0xFF)

522 
¡
 = 
	`šb
(
	`MCDPORT
(0)) & 0xFF;

524 
	`´štk
("<št-%02X>", 
¡
);

527 
	}
}

535 
	$do_mcd_»que¡
()

537 
block
,
dev
;

538 
n£ù
;

540 
»³©
:

541 ià(!(
CURRENT
è|| CURRENT->
dev
 < 0) ;

542 
INIT_REQUEST
;

543 
dev
 = 
	`MINOR
(
CURRENT
->dev);

544 
block
 = 
CURRENT
->
£ùÜ
;

545 
n£ù
 = 
CURRENT
->
Ä_£ùÜs
;

547 ià(
CURRENT
 =ğ
NULL
 || CURRENT -> 
£ùÜ
 == -1)

550 ià(
CURRENT
 -> 
cmd
 !ğ
READ
)

552 
	`´štk
("mcd: bad cmd %d\n", 
CURRENT
 -> 
cmd
);

553 
	`’d_»que¡
(0);

554 
»³©
;

557 
	`mcd_Œªsãr
();

561 ià(
CURRENT
 -> 
Ä_£ùÜs
 == 0)

563 
	`’d_»que¡
(1);

564 
»³©
;

567 
McdTr›s
 = 
MCD_RETRY_ATTEMPTS
;

568 
	`mcd_¡¬t
();

569 
	}
}

577 
	$mcd_¡¬t
()

579 ià(
McdTr›s
 == 0)

581 
	`´štk
("mcd:„—d faed‡á” %dr›s\n", 
MCD_RETRY_ATTEMPTS
);

582 
	`’d_»que¡
(0);

583 
	`SET_TIMER
(
do_mcd_»que¡
, 1);

587 
McdTr›s
--;

588 
	`outb
(0x40, 
	`MCDPORT
(0));

589 
McdTimeout
 = 
MCD_STATUS_DELAY
;

590 
	`SET_TIMER
(
mcd_¡©us
, 1);

591 
	}
}

600 
	$mcd_¡©us
()

602 
¡
;

604 
McdTimeout
--;

605 
¡
 = 
	`mcdStus
();

606 ià(
¡
 == -1)

608 ià(
McdTimeout
 == 0)

610 
	`´štk
("mcd: statusimed out\n");

611 
	`SET_TIMER
(
mcd_¡¬t
, 1);

615 
	`SET_TIMER
(
mcd_¡©us
, 1);

619 ià(
¡
 & 
MST_DSK_CHG
)

621 
mcdDiskChªged
 = 1;

624 ià((
¡
 & 
MST_READY
) == 0)

626 
	`´štk
("mcd: disk„emoved\n");

627 
mcdDiskChªged
 = 1;

628 
	`’d_»que¡
(0);

629 
	`do_mcd_»que¡
();

633 
	`outb
(0x50, 
	`MCDPORT
(0));

634 
	`outb
(0x01, 
	`MCDPORT
(0));

635 
McdTimeout
 = 100;

636 
	`SET_TIMER
(
mcd_»ad_cmd
, 1);

637 
	}
}

646 
	$mcd_»ad_cmd
()

648 
¡
;

649 
block
;

650 
mcd_PÏy_msf
 
mcdcmd
;

652 
McdTimeout
--;

653 
¡
 = 
	`mcdStus
();

655 ià(
¡
 & 
MST_DSK_CHG
)

657 
mcdDiskChªged
 = 1;

660 ià(
¡
 == -1)

662 ià(
McdTimeout
 == 0)

664 
	`´štk
("mcd: set modeimed out\n");

665 
	`SET_TIMER
(
mcd_¡¬t
, 1);

669 
	`SET_TIMER
(
mcd_»ad_cmd
, 1);

673 
mcd_bn
 = -1;

674 
block
 = 
CURRENT
 -> 
£ùÜ
 / 4;

675 
	`hsg2msf
(
block
, &
mcdcmd
.
¡¬t
);

677 
mcdcmd
.
’d
.
mš
 = 0;

678 
mcdcmd
.
’d
.
£c
 = 0;

679 
mcdcmd
.
’d
.
äame
 = 1;

681 
	`£ndMcdCmd
(
MCMD_PLAY_READ
, &
mcdcmd
);

682 
McdTimeout
 = 200;

683 
	`SET_TIMER
(
mcd_d©a
, 1);

684 
	}
}

693 
	$mcd_d©a
()

695 
i
;

697 
McdTimeout
--;

698 
	`şi
();

699 
i
 =
	`šb
(
	`MCDPORT
(1)è& (
MFL_STATUS
 | 
MFL_DATA
);

700 ià(
i
 =ğ
MFL_DATA
)

702 
	`´štk
("mcd:„ead failed\n");

703 #ifdeà
MCD_DEBUG


704 
	`´štk
("gÙ 0xB %02X\n", 
	`šb
(
	`MCDPORT
(0)) & 0xFF);

706 
	`SET_TIMER
(
mcd_¡¬t
, 1);

707 
	`¡i
();

711 ià(
i
 =ğ(
MFL_STATUS
 | 
MFL_DATA
))

713 ià(
McdTimeout
 == 0)

715 
	`´štk
("mcd: dataimeout,„etrying\n");

716 
	`SET_TIMER
(
mcd_¡¬t
, 1);

720 
	`SET_TIMER
(
mcd_d©a
, 1);

722 
	`¡i
();

726 
CLEAR_TIMER
;

727 
	`READ_DATA
(
	`MCDPORT
(0), &
mcd_buf
[0], 2048);

728 
	`¡i
();

730 
mcd_bn
 = 
CURRENT
 -> 
£ùÜ
 / 4;

731 
	`mcd_Œªsãr
();

732 
	`’d_»que¡
(1);

733 
	`SET_TIMER
(
do_mcd_»que¡
, 1);

734 
	}
}

742 
	$mcd_İ’
(
šode
 *

, 
fe
 *
å
)

744 
¡
;

746 ià(
mcdP»£Á
 == 0)

747  -
ENXIO
;

749 
¡
 = 
	`¡©usCmd
();

750 ià(
¡
 == -1)

751  -
EIO
;

753 ià((
¡
 & 
MST_READY
) == 0)

755 
	`´štk
("mcd:‚o disk in drive\n");

756  -
EIO
;

759 ià(
	`upd©eToc
() < 0)

760  -
EIO
;

763 
	}
}

771 
	$mcd_»Ëa£
(
šode
 * inode, 
fe
 * file)

773 
mcd_bn
 = -1;

774 
	`sync_dev
(
šode
->
i_rdev
);

775 
	`šv®id©e_bufãrs
(
šode
 -> 
i_rdev
);

776 
	}
}

779 
fe_İ”©iÚs
 
	gmcd_fİs
 = {

780 
NULL
,

781 
block_»ad
,

782 
block_wr™e
,

783 
NULL
,

784 
NULL
,

785 
mcd_ioùl
,

786 
NULL
,

787 
mcd_İ’
,

788 
mcd_»Ëa£


796 
sigaùiÚ
 
	gmcd_sigaùiÚ
 = {

797 
mcd_š‹¼u±
,

799 
SA_INTERRUPT
,

800 
NULL


809 
	$mcd_š™
(
mem_¡¬t
, 
mem_’d
)

811 
couÁ
;

812 
»suÉ
[3];

814 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
, "mcd", &
mcd_fİs
) != 0)

816 
	`´štk
("mcd: Unableo get major %d for Mitsumi CD-ROM\n",

817 
MAJOR_NR
);

818  
mem_¡¬t
;

821 ià(
	`check_»giÚ
(
mcd_pÜt
, 4)) {

822 
	`´štk
("mcd: Init failed, I/O…ort (%X)‡lready in use\n",

823 
mcd_pÜt
);

824  
mem_¡¬t
;

827 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

828 
»ad_ah—d
[
MAJOR_NR
] = 4;

832 
	`outb
(0, 
	`MCDPORT
(1));

833 
couÁ
 = 0; count < 1000000; count++)

834 (è
	`šb
(
	`MCDPORT
(1));

836 
	`outb
(0x40, 
	`MCDPORT
(0));

837 
couÁ
 = 0; count < 1000000; count++)

838 ià(!(
	`šb
(
	`MCDPORT
(1)è& 
MFL_STATUS
))

841 ià(
couÁ
 >= 1000000) {

842 
	`´štk
("mcd: Init failed. No mcd device‡t 0x%x irq %d\n",

843 
mcd_pÜt
, 
mcd_œq
);

844  
mem_¡¬t
;

846 
couÁ
 = 
	`šb
(
	`MCDPORT
(0));

848 
	`outb
(
MCMD_GET_VERSION
,
	`MCDPORT
(0));

849 
couÁ
=0;count<3;count++)

850 if(
	`g‘V®ue
(
»suÉ
+
couÁ
)) {

851 
	`´štk
("mcd: mitsumi get version failed‡t 0x%d\n",

852 
mcd_pÜt
);

853  
mem_¡¬t
;

856 ià(
»suÉ
[0] ==„esult[1] &&„esult[1] ==„esult[2])

857  
mem_¡¬t
;

859 
	`´štk
("mcd: Mitsumi version : %02X %c %x\n",

860 
»suÉ
[0],result[1],result[2]);

863 
mcdV”siÚ
=
»suÉ
[2];

865 ià(
mcdV”siÚ
 >=4)

866 
	`outb
(4,
	`MCDPORT
(2));

870 ià(
	`œqaùiÚ
(
MCD_INTR_NR
, &
mcd_sigaùiÚ
))

872 
	`´štk
("mcd: UÇbËØg‘ IRQ%d fÜ M™sum˜CD-ROM\n", 
MCD_INTR_NR
);

873  
mem_¡¬t
;

875 
	`¢¬f_»giÚ
(
mcd_pÜt
, 4);

876 
mcdP»£Á
 = 1;

877 
	`´štk
("mcd: Mitsumi CD-ROM Drive…resent‡t‡ddr %x, irq %d\n",

878 
mcd_pÜt
, 
mcd_œq
);

879  
mem_¡¬t
;

880 
	}
}

884 
	$hsg2msf
(
hsg
, 
msf
 *msf)

886 
hsg
 += 150;

887 
msf
 -> 
mš
 = 
hsg
 / 4500;

888 
hsg
 %= 4500;

889 
msf
 -> 
£c
 = 
hsg
 / 75;

890 
msf
 -> 
äame
 = 
hsg
 % 75;

892 
	`bš2bcd
(&
msf
 -> 
mš
);

893 
	`bš2bcd
(&
msf
 -> 
£c
);

894 
	`bš2bcd
(&
msf
 -> 
äame
);

895 
	}
}

899 
	$bš2bcd
(*
p
)

901 
u
, 
t
;

903 
u
 = *
p
 % 10;

904 
t
 = *
p
 / 10;

905 *
p
 = 
u
 | (
t
 << 4);

906 
	}
}

909 
	$bcd2bš
(
bcd
)

911  (
bcd
 >> 4) * 10 + (bcd & 0xF);

912 
	}
}

921 
	$mcdStus
()

923 
i
;

924 
¡
;

926 
¡
 = 
	`šb
(
	`MCDPORT
(1)è& 
MFL_STATUS
;

927 ià(!
¡
)

929 
i
 = 
	`šb
(
	`MCDPORT
(0)) & 0xFF;

930  
i
;

934 
	}
}

942 
	$£ndMcdCmd
(
cmd
, 
mcd_PÏy_msf
 *
·¿ms
)

944 
	`outb
(
cmd
, 
	`MCDPORT
(0));

945 
	`outb
(
·¿ms
 -> 
¡¬t
.
mš
, 
	`MCDPORT
(0));

946 
	`outb
(
·¿ms
 -> 
¡¬t
.
£c
, 
	`MCDPORT
(0));

947 
	`outb
(
·¿ms
 -> 
¡¬t
.
äame
, 
	`MCDPORT
(0));

948 
	`outb
(
·¿ms
 -> 
’d
.
mš
, 
	`MCDPORT
(0));

949 
	`outb
(
·¿ms
 -> 
’d
.
£c
, 
	`MCDPORT
(0));

950 
	`outb
(
·¿ms
 -> 
’d
.
äame
, 
	`MCDPORT
(0));

951 
	}
}

960 
	$mcdStTim”
()

962 ià(!(
	`šb
(
	`MCDPORT
(1)è& 
MFL_STATUS
))

964 
	`wake_up
(&
mcd_wa™q
);

968 
McdTimeout
--;

969 ià(
McdTimeout
 <= 0)

971 
	`wake_up
(&
mcd_wa™q
);

975 
	`SET_TIMER
(
mcdStTim”
, 1);

976 
	}
}

986 
	$g‘McdStus
(
timeout
)

988 
¡
;

990 
McdTimeout
 = 
timeout
;

991 
	`SET_TIMER
(
mcdStTim”
, 1);

992 
	`¦“p_Ú
(&
mcd_wa™q
);

993 ià(
McdTimeout
 <= 0)

996 
¡
 = 
	`šb
(
	`MCDPORT
(0)) & 0xFF;

997 ià(
¡
 == 0xFF)

1000 ià((
¡
 & 
MST_BUSY
è=ğ0 && 
audioStus
 =ğ
CDROM_AUDIO_PLAY
)

1002 
audioStus
 = 
CDROM_AUDIO_COMPLETED
;

1004 ià(
¡
 & 
MST_DSK_CHG
)

1006 
mcdDiskChªged
 = 1;

1007 
tocUpToD©e
 = 0;

1008 
audioStus
 = 
CDROM_AUDIO_NO_STATUS
;

1011  
¡
;

1012 
	}
}

1021 
	$g‘V®ue
(*
»suÉ
)

1023 
couÁ
;

1024 
s
;

1026 
couÁ
 = 0; count < 2000; count++)

1027 ià(!(
	`šb
(
	`MCDPORT
(1)è& 
MFL_STATUS
))

1030 ià(
couÁ
 >= 2000)

1032 
	`´štk
("mcd: getValueimeout\n");

1036 
s
 = 
	`šb
(
	`MCDPORT
(0)) & 0xFF;

1037 *
»suÉ
 = (è
s
;

1039 
	}
}

1048 
	$G‘QChªÃlInfo
(
mcd_Toc
 *
qp
)

1050 
nÙU£d
;

1051 
»Œy
;

1053 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

1055 
	`outb
(
MCMD_GET_Q_CHANNEL
, 
	`MCDPORT
(0));

1056 ià(
	`g‘McdStus
(
MCD_STATUS_DELAY
) != -1)

1060 ià(
»Œy
 >ğ
MCD_RETRY_ATTEMPTS
)

1063 ià(
	`g‘V®ue
(&
qp
 -> 
ù¾_addr
) < 0)  -1;

1064 ià(
	`g‘V®ue
(&
qp
 -> 
Œack
) < 0)  -1;

1065 ià(
	`g‘V®ue
(&
qp
 -> 
poštIndex
) < 0)  -1;

1066 ià(
	`g‘V®ue
(&
qp
 -> 
ŒackTime
.
mš
) < 0)  -1;

1067 ià(
	`g‘V®ue
(&
qp
 -> 
ŒackTime
.
£c
) < 0)  -1;

1068 ià(
	`g‘V®ue
(&
qp
 -> 
ŒackTime
.
äame
) < 0)  -1;

1069 ià(
	`g‘V®ue
(&
nÙU£d
) < 0)  -1;

1070 ià(
	`g‘V®ue
(&
qp
 -> 
diskTime
.
mš
) < 0)  -1;

1071 ià(
	`g‘V®ue
(&
qp
 -> 
diskTime
.
£c
) < 0)  -1;

1072 ià(
	`g‘V®ue
(&
qp
 -> 
diskTime
.
äame
) < 0)  -1;

1075 
	}
}

1083 
	$upd©eToc
()

1085 ià(
tocUpToD©e
)

1088 ià(
	`G‘DiskInfo
() < 0)

1089  -
EIO
;

1091 ià(
	`G‘Toc
() < 0)

1092  -
EIO
;

1094 
tocUpToD©e
 = 1;

1096 
	}
}

1104 
	$G‘DiskInfo
()

1106 
»Œy
;

1108 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

1110 
	`outb
(
MCMD_GET_DISK_INFO
, 
	`MCDPORT
(0));

1111 ià(
	`g‘McdStus
(
MCD_STATUS_DELAY
) != -1)

1115 ià(
»Œy
 >ğ
MCD_RETRY_ATTEMPTS
)

1118 ià(
	`g‘V®ue
(&
DiskInfo
.
fœ¡
) < 0)  -1;

1119 ià(
	`g‘V®ue
(&
DiskInfo
.
Ï¡
) < 0)  -1;

1121 
DiskInfo
.
fœ¡
 = 
	`bcd2bš
(DiskInfo.first);

1122 
DiskInfo
.
Ï¡
 = 
	`bcd2bš
(DiskInfo.last);

1124 ià(
	`g‘V®ue
(&
DiskInfo
.
diskL’gth
.
mš
) < 0)  -1;

1125 ià(
	`g‘V®ue
(&
DiskInfo
.
diskL’gth
.
£c
) < 0)  -1;

1126 ià(
	`g‘V®ue
(&
DiskInfo
.
diskL’gth
.
äame
) < 0)  -1;

1127 ià(
	`g‘V®ue
(&
DiskInfo
.
fœ¡T¿ck
.
mš
) < 0)  -1;

1128 ià(
	`g‘V®ue
(&
DiskInfo
.
fœ¡T¿ck
.
£c
) < 0)  -1;

1129 ià(
	`g‘V®ue
(&
DiskInfo
.
fœ¡T¿ck
.
äame
) < 0)  -1;

1131 #ifdeà
MCD_DEBUG


1132 
	`´štk
("Disk Info: first %d†ast %d†ength %02x:%02x.%02x first %02x:%02x.%02x\n",

1133 
DiskInfo
.
fœ¡
,

1134 
DiskInfo
.
Ï¡
,

1135 
DiskInfo
.
diskL’gth
.
mš
,

1136 
DiskInfo
.
diskL’gth
.
£c
,

1137 
DiskInfo
.
diskL’gth
.
äame
,

1138 
DiskInfo
.
fœ¡T¿ck
.
mš
,

1139 
DiskInfo
.
fœ¡T¿ck
.
£c
,

1140 
DiskInfo
.
fœ¡T¿ck
.
äame
);

1144 
	}
}

1152 
	$G‘Toc
()

1154 
i
, 
px
;

1155 
lim™
;

1156 
»Œy
;

1157 
mcd_Toc
 
qInfo
;

1159 
i
 = 0; i < 
MAX_TRACKS
; i++)

1160 
Toc
[
i
].
poštIndex
 = 0;

1162 
i
 = 
DiskInfo
.
Ï¡
 + 3;

1164 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

1166 
	`outb
(
MCMD_STOP
, 
	`MCDPORT
(0));

1167 ià(
	`g‘McdStus
(
MCD_STATUS_DELAY
) != -1)

1171 ià(
»Œy
 >ğ
MCD_RETRY_ATTEMPTS
)

1174 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

1176 
	`outb
(
MCMD_SET_MODE
, 
	`MCDPORT
(0));

1177 
	`outb
(0x05, 
	`MCDPORT
(0));

1178 ià(
	`g‘McdStus
(
MCD_STATUS_DELAY
) != -1)

1182 ià(
»Œy
 >ğ
MCD_RETRY_ATTEMPTS
)

1185 
lim™
 = 300;†imit > 0;†imit--)

1187 ià(
	`G‘QChªÃlInfo
(&
qInfo
) < 0)

1190 
px
 = 
	`bcd2bš
(
qInfo
.
poštIndex
);

1191 ià(
px
 > 0 &&…x < 
MAX_TRACKS
 && 
qInfo
.
Œack
 == 0)

1192 ià(
Toc
[
px
].
poštIndex
 == 0)

1194 
Toc
[
px
] = 
qInfo
;

1195 
i
--;

1198 ià(
i
 <= 0)

1202 
Toc
[
DiskInfo
.
Ï¡
 + 1].
diskTime
 = DiskInfo.
diskL’gth
;

1204 
»Œy
 = 0;„‘ry < 
MCD_RETRY_ATTEMPTS
;„etry++)

1206 
	`outb
(
MCMD_SET_MODE
, 
	`MCDPORT
(0));

1207 
	`outb
(0x01, 
	`MCDPORT
(0));

1208 ià(
	`g‘McdStus
(
MCD_STATUS_DELAY
) != -1)

1212 #ifdeà
MCD_DEBUG


1213 
i
 = 1; i <ğ
DiskInfo
.
Ï¡
; i++)

1214 
	`´štk
("i = %2d ctl-adr = %02Xrack %2d…x %02X %02X:%02X.%02X %02X:%02X.%02X\n",

1215 
i
, 
Toc
[i].
ù¾_addr
, Toc[i].
Œack
, Toc[i].
poštIndex
,

1216 
Toc
[
i
].
ŒackTime
.
mš
, Toc[i].ŒackTime.
£c
, Toc[i].ŒackTime.
äame
,

1217 
Toc
[
i
].
diskTime
.
mš
, Toc[i].diskTime.
£c
, Toc[i].diskTime.
äame
);

1218 
i
 = 100; i < 103; i++)

1219 
	`´štk
("i = %2d ctl-adr = %02Xrack %2d…x %02X %02X:%02X.%02X %02X:%02X.%02X\n",

1220 
i
, 
Toc
[i].
ù¾_addr
, Toc[i].
Œack
, Toc[i].
poštIndex
,

1221 
Toc
[
i
].
ŒackTime
.
mš
, Toc[i].ŒackTime.
£c
, Toc[i].ŒackTime.
äame
,

1222 
Toc
[
i
].
diskTime
.
mš
, Toc[i].diskTime.
£c
, Toc[i].diskTime.
äame
);

1225  
lim™
 > 0 ? 0 : -1;

1226 
	}
}

	@drivers/block/ramdisk.c

11 
	~<lšux/cÚfig.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/mšix_fs.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<asm/sy¡em.h
>

18 
	~<asm/£gm’t.h
>

20 
	#MAJOR_NR
 
MEM_MAJOR


	)

21 
	~"blk.h
"

23 
	#RAMDISK_MINOR
 1

	)

26 *
	grd_¡¬t
;

27 
	grd_Ëngth
 = 0;

28 
	grd_blocksizes
[2] = {0, 0};

30 
	$do_rd_»que¡
()

32 
Ën
;

33 *
addr
;

35 
»³©
:

36 
INIT_REQUEST
;

37 
addr
 = 
rd_¡¬t
 + (
CURRENT
->
£ùÜ
 << 9);

38 
Ën
 = 
CURRENT
->
cu¼’t_Ä_£ùÜs
 << 9;

40 ià((
	`MINOR
(
CURRENT
->
dev
è!ğ
RAMDISK_MINOR
) ||

41 (
addr
+
Ën
 > 
rd_¡¬t
+
rd_Ëngth
)) {

42 
	`’d_»que¡
(0);

43 
»³©
;

45 ià(
CURRENT
-> 
cmd
 =ğ
WRITE
) {

46 (è
	`memıy
(
addr
,

47 
CURRENT
->
bufãr
,

48 
Ën
);

49 } ià(
CURRENT
->
cmd
 =ğ
READ
) {

50 (è
	`memıy
(
CURRENT
->
bufãr
,

51 
addr
,

52 
Ën
);

54 
	`·nic
("RAMDISK: unknown RAM disk command !\n");

55 
	`’d_»que¡
(1);

56 
»³©
;

57 
	}
}

59 
fe_İ”©iÚs
 
	grd_fİs
 = {

60 
NULL
,

61 
block_»ad
,

62 
block_wr™e
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
block_fsync


75 
	$rd_š™
(
mem_¡¬t
, 
Ëngth
)

77 
i
;

78 *
ı
;

80 ià(
	`»gi¡”_blkdev
(
MEM_MAJOR
,"rd",&
rd_fİs
)) {

81 
	`´štk
("RAMDISK: UÇbËØg‘ majÜ %d.\n", 
MEM_MAJOR
);

84 
blk_dev
[
MEM_MAJOR
].
»que¡_â
 = 
DEVICE_REQUEST
;

85 
rd_¡¬t
 = (*è
mem_¡¬t
;

86 
rd_Ëngth
 = 
Ëngth
;

87 
ı
 = 
rd_¡¬t
;

88 
i
=0; i < 
Ëngth
; i++)

89 *
ı
++ = '\0';

91 
i
=0;i<2;i++è
rd_blocksizes
[i] = 1024;

92 
blksize_size
[
MAJOR_NR
] = 
rd_blocksizes
;

94 (
Ëngth
);

95 
	}
}

102 
	$rd_lßd
()

104 
bufãr_h—d
 *
bh
;

105 
mšix_su³r_block
 
s
;

106 
block
, 
Œ›s
;

107 
i
 = 1;

108 
nblocks
;

109 *
ı
;

112 ià(!
rd_Ëngth
) ;

113 
	`´štk
("RAMDISK: %d bytes, starting‡t 0x%x\n",

114 
rd_Ëngth
, (è
rd_¡¬t
);

117 ià(
	`MAJOR
(
ROOT_DEV
è!ğ
FLOPPY_MAJOR
) ;

127 
Œ›s
 = 0;ries < 1000;ries += 512) {

128 
block
 = 
Œ›s
;

129 
bh
 = 
	`b»ada
(
ROOT_DEV
,
block
+1,block,block+2,-1);

130 ià(!
bh
) {

131 
	`´štk
("RAMDISK: I/Oƒrror while†ooking for super block!\n");

136 *((
mšix_su³r_block
 *è&
s
) =

137 *((
mšix_su³r_block
 *è
bh
->
b_d©a
);

138 
	`b»l£
(
bh
);

139 
nblocks
 = 
s
.
s_nzÚes
 << s.
s_log_zÚe_size
;

140 ià(
s
.
s_magic
 !ğ
MINIX_SUPER_MAGIC
 &&

141 
s
.
s_magic
 !ğ
MINIX_SUPER_MAGIC2
) {

142 
	`´štk
("RAMDISK:rying old-style RAM image.\n");

146 ià(
nblocks
 > (
rd_Ëngth
 >> 
BLOCK_SIZE_BITS
)) {

147 
	`´štk
("RAMDISK: imageoo big! (%d/%d blocks)\n",

148 
nblocks
, 
rd_Ëngth
 >> 
BLOCK_SIZE_BITS
);

151 
	`´štk
("RAMDISK: Lßdšg %d block štØRAM disk", 
nblocks
);

154 
ı
 = 
rd_¡¬t
;

155 
nblocks
) {

156 ià(
nblocks
 > 2)

157 
bh
 = 
	`b»ada
(
ROOT_DEV
, 
block
, block+1, block+2, -1);

159 
bh
 = 
	`b»ad
(
ROOT_DEV
, 
block
, 
BLOCK_SIZE
);

160 ià(!
bh
) {

161 
	`´štk
("RAMDISK: I/Oƒrror on block %d,‡borting!\n",

162 
block
);

165 (è
	`memıy
(
ı
, 
bh
->
b_d©a
, 
BLOCK_SIZE
);

166 
	`b»l£
(
bh
);

167 ià(!(
nblocks
-- & 15)è
	`´štk
(".");

168 
ı
 +ğ
BLOCK_SIZE
;

169 
block
++;

170 
i
++;

172 
	`´štk
("\ndone\n");

175 
ROOT_DEV
 = ((
MEM_MAJOR
 << 8è| 
RAMDISK_MINOR
);

178 
	}
}

	@drivers/block/sbpcd.c

97 
	~<lšux/cÚfig.h
>

98 
	~<lšux/”ºo.h
>

100 
	~<lšux/sched.h
>

101 
	~<lšux/tim”.h
>

102 
	~<lšux/fs.h
>

103 
	~<lšux/k”Ãl.h
>

104 
	~<lšux/cdrom.h
>

105 
	~<lšux/iİÜt.h
>

106 
	~<lšux/sbpcd.h
>

108 #ià
SBPCD_USE_IRQ


109 
	~<lšux/sigÇl.h
>

112 
	~<lšux/ddi.h
>

113 
	~<lšux/majÜ.h
>

115 
	~<asm/sy¡em.h
>

116 
	~<asm/io.h
>

117 
	~<asm/£gm’t.h
>

118 
	~<¡d¬g.h
>

120 
	#MAJOR_NR
 
MATSUSHITA_CDROM_MAJOR


	)

121 
	~"blk.h
"

123 
	#VERSION
 "1.3 Eb”h¬d MÛnkeb”g <emÛnke@gwdg.de>"

	)

125 
	#SBPCD_DEBUG


	)

127 #iâdeà
CONFIG_ISO9660_FS


134 
	#MANY_SESSION
 0

	)

135 
	#CDMKE


	)

136 #undeà
FUTURE


137 
	#WORKMAN
 1

	)

157 
	gautİrobe
[] =

159 
CDROM_PORT
, 
SBPRO
,

182 
	#NUM_AUTOPROBE
 ((
autİrobe
è/ ())

	)

189 
sbp_»ad_cmd
();

190 
sbp_d©a
();

220 
	gsbpcd_debug
 = (1<<
DBG_INF
è| (1<<
DBG_WRN
);

222 
	gsbpcd_debug
 = (1<<
DBG_INF
) |

223 (1<<
DBG_TOC
) |

224 (1<<
DBG_IOC
) |

225 (1<<
DBG_IOX
);

227 
	gsbpcd_ißddr
 = 
CDROM_PORT
;

228 
	gsb´o_ty³
 = 
SBPRO
;

229 
	gCDo_commªd
, 
	gCDo_»£t
;

230 
	gCDo_£l_d_i
, 
	gCDo_’abË
;

231 
	gCDi_šfo
, 
	gCDi_¡©us
, 
	gCDi_d©a
;

232 
	gMIXER_addr
, 
	gMIXER_d©a
;

233 
cdrom_msf
 
	gmsf
;

234 
cdrom_ti
 
	gti
;

235 
cdrom_tochdr
 
	gtochdr
;

236 
cdrom_toûÁry
 
	gtoûÁry
;

237 
cdrom_subchÆ
 
	gSC
;

238 
cdrom_vŞù¾
 
	gvŞù¾
;

239 *
	g¡r_sb
 = "SoundBlaster";

240 *
	g¡r_lm
 = "LaserMate";

241 *
	gty³
;

245 #ià
FUTURE


246 
wa™_queue
 *
	gsbp_wa™q
 = 
NULL
;

251 
	#SBP_BUFFER_FRAMES
 4

	)

255 
u_ch¬
 
	gdrive_çmy
[]="CR-5";

256 
u_ch¬
 
	gdrive_v’dÜ
[]="MATSHITA";

258 
u_št
 
	g»¥Ú£_couÁ
=0;

259 
u_št
 
	gæags_cmd_out
;

260 
u_ch¬
 
	gcmd_ty³
=0;

261 
u_ch¬
 
	gdrvcmd
[7];

262 
u_ch¬
 
	gšfobuf
[20];

264 
u_ch¬
 
	gtimed_out
=0;

265 
u_št
 
	gd©¬©e
= 1000000;

266 
u_št
 
	gmaxtim16
=16000000;

267 
u_št
 
	gmaxtim04
= 4000000;

268 
u_št
 
	gmaxtim02
= 2000000;

269 
u_št
 
	gmaxtim_8
= 30000;

270 #ià
MANY_SESSION


271 
u_št
 
	gmaxtim_d©a
= 9000;

273 
u_št
 
	gmaxtim_d©a
= 3000;

278 
	gndrives
=0;

279 
u_ch¬
 
	gdrv_·‰”n
[4]={ 0x80, 0x80, 0x80, 0x80 };

288 
	gd
=0;

291 
	mdrv_mšÜ
;

293 
	mdrive_mod–
[4];

294 
	mfœmw¬e_v”siÚ
[4];

295 
u_ch¬
 *
	msbp_buf
;

297 
	msbp_fœ¡_äame
;

298 
	msbp_Ï¡_äame
;

299 
	msbp_»ad_äames
;

300 
	msbp_cu¼’t
;

302 
u_ch¬
 
	mdrv_ty³
;

303 
u_ch¬
 
	mdrv_İtiÚs
;

304 
u_ch¬
 
	m¡©us_by‹
;

305 
u_ch¬
 
	mdisk¡©e_æags
;

306 
u_ch¬
 
	m£n£_by‹
;

308 
u_ch¬
 
	mCD_chªged
;

310 
u_ch¬
 
	m”rÜ_by‹
;

312 
u_ch¬
 
	mf_muÉi£ssiÚ
;

313 
u_št
 
	mlba_muÉi
;

315 
u_ch¬
 
	maudio_¡©e
;

316 
u_št
 
	mpos_audio_¡¬t
;

317 
u_št
 
	mpos_audio_’d
;

318 
	mvŞ_chª0
;

319 
u_ch¬
 
	mvŞ_ù¾0
;

320 
	mvŞ_chª1
;

321 
u_ch¬
 
	mvŞ_ù¾1
;

323 
	mvŞ_chª2
;

324 
u_ch¬
 
	mvŞ_ù¾2
;

325 
	mvŞ_chª3
;

326 
u_ch¬
 
	mvŞ_ù¾3
;

329 
u_ch¬
 
	mSubQ_audio
;

330 
u_ch¬
 
	mSubQ_ùl_adr
;

331 
u_ch¬
 
	mSubQ_Œk
;

332 
u_ch¬
 
	mSubQ_²t_idx
;

333 
u_št
 
	mSubQ_run_tÙ
;

334 
u_št
 
	mSubQ_run_Œk
;

335 
u_ch¬
 
	mSubQ_wh©i¡his
;

337 
u_ch¬
 
	mUPC_ùl_adr
;

338 
u_ch¬
 
	mUPC_buf
[7];

340 
	mCDsize_blk
;

341 
	mäame_size
;

342 
	mCDsize_äm
;

344 
u_ch¬
 
	mxa_by‹
;

345 
u_ch¬
 
	mn_fœ¡_Œack
;

346 
u_ch¬
 
	mn_Ï¡_Œack
;

347 
u_št
 
	msize_msf
;

348 
u_št
 
	msize_blk
;

350 
u_ch¬
 
	mTocEÁ_nixby‹
;

351 
u_ch¬
 
	mTocEÁ_ùl_adr
;

352 
u_ch¬
 
	mTocEÁ_numb”
;

353 
u_ch¬
 
	mTocEÁ_fÜm©
;

354 
u_št
 
	mTocEÁ_add»ss
;

355 
u_ch¬
 
	mÜed_ùl_adr
;

358 
u_ch¬
 
	mnixby‹
;

359 
u_ch¬
 
	mùl_adr
;

360 
u_ch¬
 
	mnumb”
;

361 
u_ch¬
 
	mfÜm©
;

362 
u_št
 
	madd»ss
;

363 } 
	mTocBufãr
[
MAX_TRACKS
+1];

365 
	mš_SpšUp
;

367 } 
	gDS
[4];

378 #ifdeà
SBPCD_DEBUG


379 
	#DPRINTF
(
x
è
sbpcd_d´štf
 
	)
x

381 
	$sbpcd_d´štf
(
Ëv–
, *
fmt
, ...)

383 
buff
[256];

384 
va_li¡
 
¬gs
;

385 
	`v¥rštf
(*
buf
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
);

387 ià(! (
sbpcd_debug
 & (1 << 
Ëv–
))) ;

389 
	`va_¡¬t
(
¬gs
, 
fmt
);

390 
	`v¥rštf
(
buff
, 
fmt
, 
¬gs
);

391 
	`va_’d
(
¬gs
);

392 
	`´štk
(
buff
);

393 
	}
}

396 
	#DPRINTF
(
x
è

	)

403 
	$sbpcd_dbg_ioùl
(
¬g
, 
Ëv–
)

405 
v®
;

407 
v®
 = 
	`g‘_fs_lÚg
((*è
¬g
);

408 
v®
)

411 
sbpcd_debug
 = 0;

415 ià(
v®
 >ğ128è
sbpcd_debug
 &= ~(1 << (val - 128));

416 
sbpcd_debug
 |ğ(1 << 
v®
);

419 
	}
}

428 
šlše
 
	$sbp_¦“p
(
u_št
 
jifs
)

430 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

431 
cu¼’t
->
timeout
 = 
jiff›s
 + 
jifs
;

432 
	`scheduË
();

433 
	}
}

440 
	$lba2msf
(
lba
, 
u_ch¬
 *
msf
)

442 
lba
 +ğ
CD_BLOCK_OFFSET
;

443 
msf
[0] = 
lba
 / (
CD_SECS
*
CD_FRAMES
);

444 
lba
 %ğ
CD_SECS
*
CD_FRAMES
;

445 
msf
[1] = 
lba
 / 
CD_FRAMES
;

446 
msf
[2] = 
lba
 % 
CD_FRAMES
;

447 
	}
}

453 
	$bš2bcdx
(
u_ch¬
 *
p
)

455 *
p
=((*p/10)<<4)|(*p%10);

456 
	}
}

458 
u_št
 
	$blk2msf
(
u_št
 
blk
)

460 
MSF
 
msf
;

461 
u_št
 
mm
;

463 
msf
.
c
[3] = 0;

464 
msf
.
c
[2] = (
blk
 + 
CD_BLOCK_OFFSET
è/ (
CD_SECS
 * 
CD_FRAMES
);

465 
mm
 = (
blk
 + 
CD_BLOCK_OFFSET
è% (
CD_SECS
 * 
CD_FRAMES
);

466 
msf
.
c
[1] = 
mm
 / 
CD_FRAMES
;

467 
msf
.
c
[0] = 
mm
 % 
CD_FRAMES
;

468  (
msf
.
n
);

469 
	}
}

471 
u_št
 
	$make16
(
u_ch¬
 
rh
, u_ch¬ 
¾
)

473  ((
rh
<<8)|
¾
);

474 
	}
}

476 
u_št
 
	$make32
(
u_št
 
rh
, u_šˆ
¾
)

478  ((
rh
<<16)|
¾
);

479 
	}
}

481 
u_ch¬
 
	$sw­_nibbËs
(
u_ch¬
 
i
)

483  ((
i
<<4)|(i>>4));

484 
	}
}

486 
u_ch¬
 
	$byt2bcd
(
u_ch¬
 
i
)

488  (((
i
/10)<<4)+i%10);

489 
	}
}

491 
u_ch¬
 
	$bcd2bš
(
u_ch¬
 
bcd
)

493  ((
bcd
>>4)*10+(bcd&0x0F));

494 
	}
}

496 
	$msf2blk
(
msfx
)

498 
MSF
 
msf
;

499 
i
;

501 
msf
.
n
=
msfx
;

502 
i
=(
msf
.
c
[2] * 
CD_SECS
 + msf.c[1]è* 
CD_FRAMES
 + msf.c[0] - 
CD_BLOCK_OFFSET
;

503 ià(
i
<0)  (0);

504  (
i
);

505 
	}
}

508 
	$¡a2”r
(
¡a
)

510 ià(
¡a
<=2)  (sta);

511 ià(
¡a
==0x05)  (-4);

512 ià(
¡a
==0x06)  (-6);

513 ià(
¡a
==0x0d)  (-6);

514 ià(
¡a
==0x0e)  (-3);

515 ià(
¡a
==0x14)  (-3);

516 ià(
¡a
==0x0c)  (-11);

517 ià(
¡a
==0x0f)  (-11);

518 ià(
¡a
==0x10)  (-11);

519 ià(
¡a
>=0x16)  (-12);

520 
DS
[
d
].
CD_chªged
=0xFF;

521 ià(
¡a
==0x11)  (-15);

523 
	}
}

525 
	$şr_cmdbuf
()

527 
i
;

529 
i
=0;i<7;i++è
drvcmd
[i]=0;

530 
cmd_ty³
=0;

531 
	}
}

533 
	$m¬k_timeout
()

535 
timed_out
=1;

536 
	`DPRINTF
((
DBG_TIM
,"SBPCD:imer stopped.\n"));

537 
	}
}

539 
	$æush_¡©us
()

541 #ifdeà
CDMKE


542 
i
;

544 ià(
cu¼’t
 =ğ
sk
[0])

545 
i
=
maxtim02
;i!=0;i--è
	`šb
(
CDi_¡©us
);

548 
	`sbp_¦“p
(150);

549 
i
=
maxtim_d©a
;i!=0;i--è
	`šb
(
CDi_¡©us
);

552 
timed_out
=0;

553 
	`SET_TIMER
(
m¬k_timeout
,150);

555 !
timed_out
);

556 
CLEAR_TIMER
;

557 
	`šb
(
CDi_¡©us
);

559 
	}
}

561 
	$CDi_¡©_loİ
()

563 
i
,
j
;

564 
u_lÚg
 
timeout
;

566 ià(
cu¼’t
 =ğ
sk
[0])

567 
i
=
maxtim16
;i!=0;i--)

569 
j
=
	`šb
(
CDi_¡©us
);

570 ià(!(
j
&
s_nÙ_d©a_»ady
))  (j);

571 ià(!(
j
&
s_nÙ_»suÉ_»ady
))  (j);

572 ià(!
Ãw_drive
èià(
j
&
s_©‹ÁiÚ
)  (j);

575 
timeout
 = 
jiff›s
 + 1000, 
i
=
maxtim_d©a
;imeout > jiffies; )

577  ;
i
!=0;i--)

579 
j
=
	`šb
(
CDi_¡©us
);

580 ià(!(
j
&
s_nÙ_d©a_»ady
))  (j);

581 ià(!(
j
&
s_nÙ_»suÉ_»ady
))  (j);

582 ià(!
Ãw_drive
èià(
j
&
s_©‹ÁiÚ
)  (j);

584 
	`sbp_¦“p
(1);

585 
i
 = 1;

588 
	}
}

590 
	$Re¥Ú£Info
()

592 
i
,
j
, 
¡
=0;

593 
u_lÚg
 
timeout
;

595 ià(
cu¼’t
 =ğ
sk
[0])

596 
i
=0;i<
»¥Ú£_couÁ
;i++)

598 
j
=
maxtim_8
;j!=0;j--)

600 
¡
=
	`šb
(
CDi_¡©us
);

601 ià(!(
¡
&
s_nÙ_»suÉ_»ady
)) ;

603 ià(
j
==0)  (-1);

604 
šfobuf
[
i
]=
	`šb
(
CDi_šfo
);

608 
i
=0, 
timeout
 = 
jiff›s
 + 100; i < 
»¥Ú£_couÁ
; i++)

610 
j
=
maxtim_d©a
; ; )

612  ;
j
!=0;j-- )

614 
¡
=
	`šb
(
CDi_¡©us
);

615 ià(!(
¡
&
s_nÙ_»suÉ_»ady
)) ;

617 ià(
j
 !ğ0 || 
timeout
 <ğ
jiff›s
) ;

618 
	`sbp_¦“p
(0);

619 
j
 = 1;

621 ià(
timeout
 <ğ
jiff›s
)  (-1);

622 
šfobuf
[
i
]=
	`šb
(
CDi_šfo
);

626 
	}
}

628 
	$Ev®u©eStus
(
¡
)

630 ià(!
Ãw_drive
)

632 
DS
[
d
].
¡©us_by‹
=0;

633 ià(
¡
&
p_ÿddš_Şd
è
DS
[
d
].
¡©us_by‹
 |ğ
p_doÜ_şo£d
|
p_ÿddy_š
;

634 ià(
¡
&
p_¥šnšg
è
DS
[
d
].
¡©us_by‹
 |=…_spinning;

635 ià(
¡
&
p_check
è
DS
[
d
].
¡©us_by‹
 |=…_check;

636 ià(
¡
&
p_busy_Şd
è
DS
[
d
].
¡©us_by‹
 |ğ
p_busy_Ãw
;

637 ià(
¡
&
p_disk_ok
è
DS
[
d
].
¡©us_by‹
 |=…_disk_ok;

639 { 
DS
[
d
].
¡©us_by‹
=
¡
;

640 
¡
=
p_sucûss_Şd
;

642  (
¡
);

643 
	}
}

645 
	$Re¥Ú£Stus
()

647 
i
,
j
;

648 
u_lÚg
 
timeout
;

650 
	`DPRINTF
((
DBG_STA
,"SBPCD: doing ResponseStatus...\n"));

652 ià(
cu¼’t
 =ğ
sk
[0])

654 ià(
æags_cmd_out
 & 
f_»¥o3
è
j
 = 
maxtim_8
;

655 ià(
æags_cmd_out
&
f_»¥o2
è
j
=
maxtim16
;

656 
j
=
maxtim04
;

657 ;
j
!=0;j--)

659 
i
=
	`šb
(
CDi_¡©us
);

660 ià(!(
i
&
s_nÙ_»suÉ_»ady
)) ;

665 ià(
æags_cmd_out
 & 
f_»¥o3
è
timeout
 = 
jiff›s
;

666 ià(
æags_cmd_out
 & 
f_»¥o2
è
timeout
 = 
jiff›s
 + 1600;

667 
timeout
 = 
jiff›s
 + 400;

668 
j
=
maxtim_8
;

671  ;
j
!=0;j--)

673 
i
=
	`šb
(
CDi_¡©us
);

674 ià(!(
i
&
s_nÙ_»suÉ_»ady
)) ;

676 ià(
j
 !ğ0 || 
timeout
 <ğ
jiff›s
) ;

677 
	`sbp_¦“p
(0);

678 
j
 = 1;

682 ià(
j
==0)

683 { ià((
æags_cmd_out
 & 
f_»¥o3
) == 0)

684 
	`DPRINTF
((
DBG_STA
,"SBPCD: ResponseStatus:imeout.\n"));

685 
	`Ev®u©eStus
(0);

688 
i
=
	`šb
(
CDi_šfo
);

689 
i
=
	`Ev®u©eStus
(i);

690  (
i
);

691 
	}
}

693 
	$xx_R—dStus
()

695 
i
;

697 
	`DPRINTF
((
DBG_STA
,"SBPCD: giving xx_ReadStatus command\n"));

699 ià(!
Ãw_drive
è
	`OUT
(
CDo_commªd
,0x81);

702 #ià
SBPCD_DIS_IRQ


703 
	`şi
();

705 
	`OUT
(
CDo_commªd
,0x05);

706 
i
=0;i<6;i++è
	`OUT
(
CDo_commªd
,0);

707 #ià
SBPCD_DIS_IRQ


708 
	`¡i
();

711 
	}
}

713 
	$xx_R—dE¼Ü
()

715 
	`cmd_out
();

716 
i
;

718 
	`şr_cmdbuf
();

719 
	`DPRINTF
((
DBG_ERR
,"SBPCD: giving xx_ReadError command.\n"));

720 ià(
Ãw_drive
)

722 
drvcmd
[0]=0x82;

723 
»¥Ú£_couÁ
=8;

724 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
;

728 
drvcmd
[0]=0x82;

729 
»¥Ú£_couÁ
=6;

730 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
;

732 
i
=
	`cmd_out
();

733 
DS
[
d
].
”rÜ_by‹
=0;

734 
	`DPRINTF
((
DBG_ERR
,"SBPCD: xx_R—dE¼Ü: cmd_out(82è»tuº %d (%02X)\n",
i
,i));

735 ià(
i
<0)  (i);

736 ià(
Ãw_drive
è
i
=2;

737 
i
=1;

738 
DS
[
d
].
”rÜ_by‹
=
šfobuf
[
i
];

739 
	`DPRINTF
((
DBG_ERR
,"SBPCD: xx_R—dE¼Ü: infobuf[%d] i %d (%02X)\n",
i
,
DS
[
d
].
”rÜ_by‹
,DS[d].error_byte));

740 
i
=
	`¡a2”r
(
šfobuf
[i]);

741  (
i
);

742 
	}
}

744 
	$cmd_out
()

746 
i
=0;

748 ià(
æags_cmd_out
&
f_putcmd
)

750 
	`DPRINTF
((
DBG_CMD
,"SBPCD: cmd_out:…ut"));

751 
i
=0;i<7;i++è
	`DPRINTF
((
DBG_CMD
," %02X",
drvcmd
[i]));

752 
	`DPRINTF
((
DBG_CMD
,"\n"));

754 #ià
SBPCD_DIS_IRQ


755 
	`şi
();

757 
i
=0;i<7;i++è
	`OUT
(
CDo_commªd
,
drvcmd
[i]);

758 #ià
SBPCD_DIS_IRQ


759 
	`¡i
();

762 ià(
»¥Ú£_couÁ
!=0)

764 ià(
cmd_ty³
!=0)

766 ià(
sb´o_ty³
è
	`OUT
(
CDo_£l_d_i
,0x01);

767 
	`DPRINTF
((
DBG_INF
,"SBPCD: misleadedory ResponseData.\n"));

768 ià(
sb´o_ty³
è
	`OUT
(
CDo_£l_d_i
,0x00);

770 
i
=
	`Re¥Ú£Info
();

771 ià(
i
<0)  (-9);

773 ià(
DS
[
d
].
š_SpšUp
 !ğ0è
	`DPRINTF
((
DBG_SPI
,"SBPCD:o CDi_stat_loop.\n"));

774 ià(
æags_cmd_out
&
f_lİ¡a
)

776 
i
=
	`CDi_¡©_loİ
();

777 ià((
i
<0)||!(i&
s_©‹ÁiÚ
))  (-9);

779 ià(!(
æags_cmd_out
&
f_g‘¡a
)è
LOC_229
;

781 
LOC_228
:

782 ià(
DS
[
d
].
š_SpšUp
 !ğ0è
	`DPRINTF
((
DBG_SPI
,"SBPCD:o xx_ReadStatus.\n"));

783 
	`xx_R—dStus
();

785 
LOC_229
:

786 ià(
æags_cmd_out
&
f_Re¥Ú£Stus
)

788 ià(
DS
[
d
].
š_SpšUp
 !ğ0è
	`DPRINTF
((
DBG_SPI
,"SBPCD:o ResponseStatus.\n"));

789 
i
=
	`Re¥Ú£Stus
();

791 ià(
i
<0)  (-9);

792 ià(
æags_cmd_out
&(
f_b™1
|
f_wa™_if_busy
))

794 ià(!
¡_check
)

796 ià(
æags_cmd_out
&
f_b™1
èià(
i
&
p_sucûss_Şd
è
LOC_232
;

797 ià(!(
æags_cmd_out
&
f_wa™_if_busy
)è
LOC_228
;

798 ià(!
¡_busy
è
LOC_228
;

802 
LOC_232
:

803 ià(!(
æags_cmd_out
&
f_obey_p_check
))  (0);

804 ià(!
¡_check
)  (0);

805 ià(
DS
[
d
].
š_SpšUp
 !ğ0è
	`DPRINTF
((
DBG_SPI
,"SBPCD:o xx_ReadError.\n"));

806 
i
=
	`xx_R—dE¼Ü
();

807 ià(
DS
[
d
].
š_SpšUp
 !ğ0è
	`DPRINTF
((
DBG_SPI
,"SBPCD:o cmd_out OK.\n"));

808  (
i
);

809 
	}
}

811 
	$xx_S“k
(
u_št
 
pos
, 
f_blk_msf
)

813 
i
;

815 
	`şr_cmdbuf
();

816 ià(
f_blk_msf
>1)  (-3);

817 ià(!
Ãw_drive
)

819 ià(
f_blk_msf
==1è
pos
=
	`msf2blk
(pos);

820 
drvcmd
[2]=(
pos
>>16)&0x00FF;

821 
drvcmd
[3]=(
pos
>>8)&0x00FF;

822 
drvcmd
[4]=
pos
&0x00FF;

823 
æags_cmd_out
 = 
f_putcmd
 | 
f_»¥o2
 | 
f_lİ¡a
 | 
f_g‘¡a
 |

824 
f_Re¥Ú£Stus
 | 
f_obey_p_check
 | 
f_b™1
;

828 ià(
f_blk_msf
==0è
pos
=
	`blk2msf
(pos);

829 
drvcmd
[1]=(
pos
>>16)&0x00FF;

830 
drvcmd
[2]=(
pos
>>8)&0x00FF;

831 
drvcmd
[3]=
pos
&0x00FF;

832 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

834 
drvcmd
[0]=0x01;

835 
»¥Ú£_couÁ
=0;

836 
i
=
	`cmd_out
();

837  (
i
);

838 
	}
}

840 
	$xx_SpšUp
()

842 
i
;

844 
	`DPRINTF
((
DBG_SPI
,"SBPCD: SpinUp.\n"));

845 
DS
[
d
].
š_SpšUp
 = 1;

846 
	`şr_cmdbuf
();

847 ià(!
Ãw_drive
)

849 
drvcmd
[0]=0x05;

850 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_lİ¡a
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
|
f_b™1
;

854 
drvcmd
[0]=0x02;

855 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

857 
»¥Ú£_couÁ
=0;

858 
i
=
	`cmd_out
();

859 
DS
[
d
].
š_SpšUp
 = 0;

860  (
i
);

861 
	}
}

863 
	$yy_SpšDown
()

865 
i
;

867 ià(!
Ãw_drive
)  (-3);

868 
	`şr_cmdbuf
();

869 
drvcmd
[0]=0x06;

870 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

871 
»¥Ú£_couÁ
=0;

872 
i
=
	`cmd_out
();

873  (
i
);

874 
	}
}

876 
	$yy_S‘S³ed
(
u_ch¬
 
¥“d
, u_ch¬ 
x1
, u_ch¬ 
x2
)

878 
i
;

880 ià(!
Ãw_drive
)  (-3);

881 
	`şr_cmdbuf
();

882 
drvcmd
[0]=0x09;

883 
drvcmd
[1]=0x03;

884 
drvcmd
[2]=
¥“d
;

885 
drvcmd
[3]=
x1
;

886 
drvcmd
[4]=
x2
;

887 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

888 
»¥Ú£_couÁ
=0;

889 
i
=
	`cmd_out
();

890  (
i
);

891 
	}
}

893 
	$xx_S‘VŞume
()

895 
i
;

896 
u_ch¬
 
chªÃl0
,
chªÃl1
,
vŞume0
,
vŞume1
;

897 
u_ch¬
 
cÚŒŞ0
,
v®ue0
,
cÚŒŞ1
,
v®ue1
;

899 
DS
[
d
].
disk¡©e_æags
 &ğ~
vŞume_b™
;

900 
	`şr_cmdbuf
();

901 
chªÃl0
=
DS
[
d
].
vŞ_chª0
;

902 
vŞume0
=
DS
[
d
].
vŞ_ù¾0
;

903 
chªÃl1
=
cÚŒŞ1
=
DS
[
d
].
vŞ_chª1
;

904 
vŞume1
=
v®ue1
=
DS
[
d
].
vŞ_ù¾1
;

905 
cÚŒŞ0
=
v®ue0
=0;

907 ià(((
DS
[
d
].
drv_İtiÚs
&
§x_a
)!=0)&&(DS[d].
drv_ty³
>=
drv_211
))

909 ià((
vŞume0
!=0)&&(
vŞume1
==0))

911 
vŞume1
=
vŞume0
;

912 
chªÃl1
=
chªÃl0
;

914 ià((
vŞume0
==0)&&(
vŞume1
!=0))

916 
vŞume0
=
vŞume1
;

917 
chªÃl0
=
chªÃl1
;

920 ià(
chªÃl0
>1)

922 
chªÃl0
=0;

923 
vŞume0
=0;

925 ià(
chªÃl1
>1)

927 
chªÃl1
=1;

928 
vŞume1
=0;

931 ià(
Ãw_drive
)

933 
cÚŒŞ0
=
chªÃl0
+1;

934 
cÚŒŞ1
=
chªÃl1
+1;

935 
v®ue0
=(
vŞume0
>
vŞume1
)?volume0:volume1;

936 
v®ue1
=
v®ue0
;

937 ià(
vŞume0
==0è
cÚŒŞ0
=0;

938 ià(
vŞume1
==0è
cÚŒŞ1
=0;

939 
drvcmd
[0]=0x09;

940 
drvcmd
[1]=0x05;

941 
drvcmd
[3]=
cÚŒŞ0
;

942 
drvcmd
[4]=
v®ue0
;

943 
drvcmd
[5]=
cÚŒŞ1
;

944 
drvcmd
[6]=
v®ue1
;

945 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

949 ià(
DS
[
d
].
drv_ty³
>=
drv_300
)

951 
cÚŒŞ0
=
vŞume0
&0xFC;

952 
v®ue0
=
vŞume1
&0xFC;

953 ià((
vŞume0
!=0)&&(vŞume0<4)è
cÚŒŞ0
 |= 0x04;

954 ià((
vŞume1
!=0)&&(vŞume1<4)è
v®ue0
 |= 0x04;

955 ià(
chªÃl0
!=0è
cÚŒŞ0
 |= 0x01;

956 ià(
chªÃl1
==1è
v®ue0
 |= 0x01;

960 
v®ue0
=(
vŞume0
>
vŞume1
)?volume0:volume1;

961 ià(
DS
[
d
].
drv_ty³
<
drv_211
)

963 ià(
chªÃl0
!=0)

965 
i
=
chªÃl1
;

966 
chªÃl1
=
chªÃl0
;

967 
chªÃl0
=
i
;

968 
i
=
vŞume1
;

969 
vŞume1
=
vŞume0
;

970 
vŞume0
=
i
;

972 ià(
chªÃl0
==
chªÃl1
)

974 ià(
chªÃl0
==0)

976 
chªÃl1
=1;

977 
vŞume1
=0;

978 
vŞume0
=
v®ue0
;

982 
chªÃl0
=0;

983 
vŞume0
=0;

984 
vŞume1
=
v®ue0
;

989 ià((
vŞume0
!=0)&&(
vŞume1
!=0))

991 ià(
vŞume0
==0xFFè
vŞume1
=0xFF;

992 ià(
vŞume1
==0xFFè
vŞume0
=0xFF;

994 ià(
DS
[
d
].
drv_ty³
<
drv_201
è
vŞume0
=
vŞume1
=
v®ue0
;

996 ià(
DS
[
d
].
drv_ty³
>=
drv_201
)

998 ià(
vŞume0
==0è
cÚŒŞ0
 |= 0x80;

999 ià(
vŞume1
==0è
cÚŒŞ0
 |= 0x40;

1001 ià(
DS
[
d
].
drv_ty³
>=
drv_211
)

1003 ià(
chªÃl0
!=0è
cÚŒŞ0
 |= 0x20;

1004 ià(
chªÃl1
!=1è
cÚŒŞ0
 |= 0x10;

1007 
drvcmd
[0]=0x84;

1008 
drvcmd
[1]=0x83;

1009 
drvcmd
[4]=
cÚŒŞ0
;

1010 
drvcmd
[5]=
v®ue0
;

1011 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1014 
»¥Ú£_couÁ
=0;

1015 
i
=
	`cmd_out
();

1016 ià(
i
>0)  (i);

1017 
DS
[
d
].
disk¡©e_æags
 |ğ
vŞume_b™
;

1019 
	}
}

1021 
	$G‘Stus
()

1023 
i
;

1025 
æags_cmd_out
=
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1026 
»¥Ú£_couÁ
=0;

1027 
cmd_ty³
=0;

1028 
i
=
	`cmd_out
();

1029  (
i
);

1030 
	}
}

1032 
	$xy_DriveRe£t
()

1034 
i
;

1036 
	`DPRINTF
((
DBG_RES
,"SBPCD: xy_DriveReset called.\n"));

1037 ià(!
Ãw_drive
è
	`OUT
(
CDo_»£t
,0x00);

1040 
	`şr_cmdbuf
();

1041 
drvcmd
[0]=0x0A;

1042 
æags_cmd_out
=
f_putcmd
;

1043 
»¥Ú£_couÁ
=0;

1044 
i
=
	`cmd_out
();

1046 
	`æush_¡©us
();

1047 
i
=
	`G‘Stus
();

1048 ià(
i
>=0)  -1;

1049 ià(
DS
[
d
].
”rÜ_by‹
!=
aud_12
)  -1;

1051 
	}
}

1053 
	$S‘S³ed
()

1055 
i
, 
¥“d
;

1057 ià(!(
DS
[
d
].
drv_İtiÚs
&(
¥“d_auto
|
¥“d_300
|
¥“d_150
)))  (0);

1058 
¥“d
=0x80;

1059 ià(!(
DS
[
d
].
drv_İtiÚs
&
¥“d_auto
))

1061 
¥“d
 |= 0x40;

1062 ià(!(
DS
[
d
].
drv_İtiÚs
&
¥“d_300
)è
¥“d
=0;

1064 
i
=
	`yy_S‘S³ed
(
¥“d
,0,0);

1065  (
i
);

1066 
	}
}

1068 
	$DriveRe£t
()

1070 
i
;

1072 
i
=
	`xy_DriveRe£t
();

1073 ià(
i
<0)  (-2);

1076 
i
=
	`G‘Stus
();

1077 ià((
i
<0)&&(i!=-15))  (-2);

1078 ià(!
¡_ÿddy_š
) ;

1080 !
¡_diskok
);

1081 
DS
[
d
].
CD_chªged
=1;

1082 
i
=
	`S‘S³ed
();

1083 ià(
i
<0)  (-2);

1085 
	}
}

1087 
	$xx_Pau£_Resume
(
·u_»s
)

1089 
i
;

1091 
	`şr_cmdbuf
();

1092 ià(
Ãw_drive
)

1094 
drvcmd
[0]=0x0D;

1095 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1099 
drvcmd
[0]=0x8D;

1100 
æags_cmd_out
=
f_putcmd
|
f_»¥o2
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1102 ià(
·u_»s
!=1è
drvcmd
[1]=0x80;

1103 
»¥Ú£_couÁ
=0;

1104 
i
=
	`cmd_out
();

1105  (
i
);

1106 
	}
}

1109 
	$yy_LockDoÜ
(
lock
)

1111 
i
;

1113 ià(!
Ãw_drive
)  (-3);

1114 
	`şr_cmdbuf
();

1115 
drvcmd
[0]=0x0C;

1116 ià(
lock
==1è
drvcmd
[1]=0x01;

1117 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1118 
»¥Ú£_couÁ
=0;

1119 
i
=
	`cmd_out
();

1120  (
i
);

1121 
	}
}

1124 
	$xx_R—dSubQ
()

1126 
i
,
j
;

1128 
DS
[
d
].
disk¡©e_æags
 &ğ~
subq_b™
;

1129 
	`şr_cmdbuf
();

1130 ià(
Ãw_drive
)

1132 
drvcmd
[0]=0x87;

1133 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1134 
»¥Ú£_couÁ
=11;

1138 
drvcmd
[0]=0x89;

1139 
drvcmd
[1]=0x02;

1140 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1141 
»¥Ú£_couÁ
=13;

1143 
j
=0;j<255;j++)

1145 
i
=
	`cmd_out
();

1146 ià(
i
<0)  (i);

1147 ià(
šfobuf
[0]!=0) ;

1148 ià(!
¡_¥šnšg
)

1150 
DS
[
d
].
SubQ_ùl_adr
=DS[d].
SubQ_Œk
=DS[d].
SubQ_²t_idx
=DS[d].
SubQ_wh©i¡his
=0;

1151 
DS
[
d
].
SubQ_run_tÙ
=DS[d].
SubQ_run_Œk
=0;

1155 
DS
[
d
].
SubQ_audio
=
šfobuf
[0];

1156 
DS
[
d
].
SubQ_ùl_adr
=
	`sw­_nibbËs
(
šfobuf
[1]);

1157 
DS
[
d
].
SubQ_Œk
=
	`byt2bcd
(
šfobuf
[2]);

1158 
DS
[
d
].
SubQ_²t_idx
=
	`byt2bcd
(
šfobuf
[3]);

1159 
i
=4;

1160 ià(!
Ãw_drive
è
i
=5;

1161 
DS
[
d
].
SubQ_run_tÙ
=
	`make32
(
	`make16
(0,
šfobuf
[
i
]),make16(infobuf[i+1],infobuf[i+2]));

1162 
i
=7;

1163 ià(!
Ãw_drive
è
i
=9;

1164 
DS
[
d
].
SubQ_run_Œk
=
	`make32
(
	`make16
(0,
šfobuf
[
i
]),make16(infobuf[i+1],infobuf[i+2]));

1165 
DS
[
d
].
SubQ_wh©i¡his
=
šfobuf
[
i
+3];

1166 
DS
[
d
].
disk¡©e_æags
 |ğ
subq_b™
;

1168 
	}
}

1170 
	$xx_ModeS’£
()

1172 
i
;

1174 
DS
[
d
].
disk¡©e_æags
 &ğ~
äame_size_b™
;

1175 
	`şr_cmdbuf
();

1176 ià(
Ãw_drive
)

1178 
drvcmd
[0]=0x84;

1179 
drvcmd
[1]=0x00;

1180 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1181 
»¥Ú£_couÁ
=5;

1185 
drvcmd
[0]=0x85;

1186 
drvcmd
[1]=0x00;

1187 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1188 
»¥Ú£_couÁ
=2;

1190 
i
=
	`cmd_out
();

1191 ià(
i
<0)  (i);

1192 
i
=0;

1193 ià(
Ãw_drive
è
DS
[
d
].
£n£_by‹
=
šfobuf
[
i
++];

1194 
DS
[
d
].
äame_size
=
	`make16
(
šfobuf
[
i
],infobuf[i+1]);

1195 
DS
[
d
].
disk¡©e_æags
 |ğ
äame_size_b™
;

1197 
	}
}

1200 
	$xx_T–lVŞume
()

1202 
i
;

1203 
u_ch¬
 
sw™ches
;

1204 
u_ch¬
 
chª0
,
vŞ0
,
chª1
,
vŞ1
;

1206 
DS
[
d
].
disk¡©e_æags
 &ğ~
vŞume_b™
;

1207 
	`şr_cmdbuf
();

1208 ià(
Ãw_drive
)

1210 
drvcmd
[0]=0x84;

1211 
drvcmd
[1]=0x05;

1212 
»¥Ú£_couÁ
=5;

1213 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1217 
drvcmd
[0]=0x85;

1218 
drvcmd
[1]=0x03;

1219 
»¥Ú£_couÁ
=2;

1220 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1222 
i
=
	`cmd_out
();

1223 ià(
i
<0)  (i);

1224 ià(
Ãw_drive
)

1226 
chª0
=
šfobuf
[1]&0x0F;

1227 
vŞ0
=
šfobuf
[2];

1228 
chª1
=
šfobuf
[3]&0x0F;

1229 
vŞ1
=
šfobuf
[4];

1230 ià(
chª0
==0)

1232 
chª0
=1;

1233 
vŞ0
=0;

1235 ià(
chª1
==0)

1237 
chª1
=2;

1238 
vŞ1
=0;

1240 
chª0
 >>= 1;

1241 
chª1
 >>= 1;

1245 
chª0
=0;

1246 
chª1
=1;

1247 
vŞ0
=
vŞ1
=
šfobuf
[1];

1248 ià(
DS
[
d
].
drv_ty³
>=
drv_201
)

1250 ià(
DS
[
d
].
drv_ty³
<
drv_300
)

1252 
sw™ches
=
šfobuf
[0];

1253 ià((
sw™ches
&0x80)!=0è
vŞ0
=0;

1254 ià((
sw™ches
&0x40)!=0è
vŞ1
=0;

1255 ià(
DS
[
d
].
drv_ty³
>=
drv_211
)

1257 ià((
sw™ches
&0x20)!=0è
chª0
=1;

1258 ià((
sw™ches
&0x10)!=0è
chª1
=0;

1263 
vŞ0
=
šfobuf
[0];

1264 ià((
vŞ0
&0x01)!=0è
chª0
=1;

1265 ià((
vŞ1
&0x01)==0è
chª1
=0;

1266 
vŞ0
 &= 0xFC;

1267 
vŞ1
 &= 0xFC;

1268 ià(
vŞ0
!=0) vol0 += 3;

1269 ià(
vŞ1
!=0) vol1 += 3;

1273 
DS
[
d
].
vŞ_chª0
=
chª0
;

1274 
DS
[
d
].
vŞ_ù¾0
=
vŞ0
;

1275 
DS
[
d
].
vŞ_chª1
=
chª1
;

1276 
DS
[
d
].
vŞ_ù¾1
=
vŞ1
;

1277 
DS
[
d
].
vŞ_chª2
=2;

1278 
DS
[
d
].
vŞ_ù¾2
=0xFF;

1279 
DS
[
d
].
vŞ_chª3
=3;

1280 
DS
[
d
].
vŞ_ù¾3
=0xFF;

1281 
DS
[
d
].
disk¡©e_æags
 |ğ
vŞume_b™
;

1283 
	}
}

1286 
	$xx_R—dC­ac™y
()

1288 
i
;

1290 
DS
[
d
].
disk¡©e_æags
 &ğ~
cd_size_b™
;

1291 
	`şr_cmdbuf
();

1292 ià(
Ãw_drive
)

1294 
drvcmd
[0]=0x85;

1295 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1299 
drvcmd
[0]=0x88;

1300 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1302 
»¥Ú£_couÁ
=5;

1303 
i
=
	`cmd_out
();

1304 ià(
i
<0)  (i);

1305 
DS
[
d
].
CDsize_blk
=
	`make32
(
	`make16
(0,
šfobuf
[0]),make16(infobuf[1],infobuf[2]));

1306 ià(
Ãw_drive
è
DS
[
d
].
CDsize_blk
=
	`msf2blk
(DS[d].CDsize_blk);

1307 
DS
[
d
].
CDsize_äm
 = (DS[d].
CDsize_blk
 * 
	`make16
(
šfobuf
[3],šfobuf[4])è/ 
CD_FRAMESIZE
;

1308 
DS
[
d
].
CDsize_blk
 += 151;

1309 
DS
[
d
].
disk¡©e_æags
 |ğ
cd_size_b™
;

1311 
	}
}

1313 
	$xx_R—dTocDesü
()

1315 
i
;

1317 
DS
[
d
].
disk¡©e_æags
 &ğ~
toc_b™
;

1318 
	`şr_cmdbuf
();

1319 ià(
Ãw_drive
)

1321 
drvcmd
[0]=0x8B;

1322 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1326 
drvcmd
[0]=0x8B;

1327 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1329 
»¥Ú£_couÁ
=6;

1330 
i
=
	`cmd_out
();

1331 ià(
i
<0)  (i);

1332 
DS
[
d
].
xa_by‹
=
šfobuf
[0];

1333 
DS
[
d
].
n_fœ¡_Œack
=
šfobuf
[1];

1334 
DS
[
d
].
n_Ï¡_Œack
=
šfobuf
[2];

1335 
DS
[
d
].
size_msf
=
	`make32
(
	`make16
(0,
šfobuf
[3]),make16(infobuf[4],infobuf[5]));

1336 
DS
[
d
].
size_blk
=
	`msf2blk
(DS[d].
size_msf
);

1337 
DS
[
d
].
disk¡©e_æags
 |ğ
toc_b™
;

1338 
	`DPRINTF
((
DBG_TOC
,"SBPCD: TocDesc: %02X %02X %02X %08X\n",

1339 
DS
[
d
].
xa_by‹
,DS[d].
n_fœ¡_Œack
,DS[d].
n_Ï¡_Œack
,DS[d].
size_msf
));

1341 
	}
}

1343 
	$xx_R—dTocEÁry
(
num
)

1345 
i
;

1347 
	`şr_cmdbuf
();

1348 ià(
Ãw_drive
)

1350 
drvcmd
[0]=0x8C;

1351 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1355 
drvcmd
[0]=0x8C;

1356 
drvcmd
[1]=0x02;

1357 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1359 
drvcmd
[2]=
num
;

1360 
»¥Ú£_couÁ
=8;

1361 
i
=
	`cmd_out
();

1362 ià(
i
<0)  (i);

1363 
DS
[
d
].
TocEÁ_nixby‹
=
šfobuf
[0];

1364 
DS
[
d
].
TocEÁ_ùl_adr
=
	`sw­_nibbËs
(
šfobuf
[1]);

1365 
DS
[
d
].
TocEÁ_numb”
=
šfobuf
[2];

1366 
DS
[
d
].
TocEÁ_fÜm©
=
šfobuf
[3];

1367 ià(
Ãw_drive
è
i
=4;

1368 
i
=5;

1369 
DS
[
d
].
TocEÁ_add»ss
=
	`make32
(
	`make16
(0,
šfobuf
[
i
]),make16(infobuf[i+1],infobuf[i+2]));

1370 
	`DPRINTF
((
DBG_TOC
,"SBPCD: TocEntry: %02X %02X %02X %02X %08X\n",

1371 
DS
[
d
].
TocEÁ_nixby‹
,DS[d].
TocEÁ_ùl_adr
,DS[d].
TocEÁ_numb”
,

1372 
DS
[
d
].
TocEÁ_fÜm©
,DS[d].
TocEÁ_add»ss
));

1374 
	}
}

1376 
	$xx_R—dPack‘
()

1378 
i
;

1380 
	`şr_cmdbuf
();

1381 
drvcmd
[0]=0x8E;

1382 
drvcmd
[1]=
»¥Ú£_couÁ
;

1383 
æags_cmd_out
=
f_putcmd
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1384 
i
=
	`cmd_out
();

1385  (
i
);

1386 
	}
}

1388 
	$cÚv”t_UPC
(
u_ch¬
 *
p
)

1390 
i
;

1392 
p
++;

1393 ià(!
Ãw_drive
è
p
[13]=0;

1394 
i
=0;i<7;i++)

1396 ià(
Ãw_drive
è
DS
[
d
].
UPC_buf
[
i
]=
	`sw­_nibbËs
(*
p
++);

1399 
DS
[
d
].
UPC_buf
[
i
]=((*
p
++)<<4)&0xFF;

1400 
DS
[
d
].
UPC_buf
[
i
] |ğ*
p
++;

1403 
DS
[
d
].
UPC_buf
[6] &= 0xF0;

1405 
	}
}

1407 
	$xx_R—dUPC
()

1409 
i
;

1411 
DS
[
d
].
disk¡©e_æags
 &ğ~
upc_b™
;

1412 
	`şr_cmdbuf
();

1413 ià(
Ãw_drive
)

1415 
drvcmd
[0]=0x88;

1416 
»¥Ú£_couÁ
=8;

1417 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1421 
drvcmd
[0]=0x08;

1422 
»¥Ú£_couÁ
=0;

1423 
æags_cmd_out
=
f_putcmd
|
f_lİ¡a
|
f_g‘¡a
|
f_Re¥Ú£Stus
|
f_obey_p_check
|
f_b™1
;

1425 
i
=
	`cmd_out
();

1426 ià(
i
<0)  (i);

1427 ià(!
Ãw_drive
)

1429 
»¥Ú£_couÁ
=16;

1430 
i
=
	`xx_R—dPack‘
();

1431 ià(
i
<0)  (i);

1433 
DS
[
d
].
UPC_ùl_adr
=0;

1434 ià(
Ãw_drive
è
i
=0;

1435 
i
=2;

1436 ià((
šfobuf
[
i
]&0x80)!=0)

1438 
	`cÚv”t_UPC
(&
šfobuf
[
i
]);

1439 
DS
[
d
].
UPC_ùl_adr
 &= 0xF0;

1440 
DS
[
d
].
UPC_ùl_adr
 |= 0x02;

1442 
DS
[
d
].
disk¡©e_æags
 |ğ
upc_b™
;

1444 
	}
}

1446 
	$yy_CheckMuÉiSessiÚ
()

1448 
i
;

1450 
DS
[
d
].
disk¡©e_æags
 &ğ~
muÉi£ssiÚ_b™
;

1451 
DS
[
d
].
f_muÉi£ssiÚ
=0;

1452 
	`şr_cmdbuf
();

1453 ià(
Ãw_drive
)

1455 
drvcmd
[0]=0x8D;

1456 
»¥Ú£_couÁ
=6;

1457 
æags_cmd_out
=
f_putcmd
|
f_Re¥Ú£Stus
|
f_obey_p_check
;

1458 
i
=
	`cmd_out
();

1459 ià(
i
<0)  (i);

1460 ià((
šfobuf
[0]&0x80)!=0)

1462 
	`DPRINTF
((
DBG_MUL
,"SBPCD: MultiSession CD detected: %02X %02X %02X %02X %02X %02X\n",

1463 
šfobuf
[0], infobuf[1], infobuf[2],

1464 
šfobuf
[3], infobuf[4], infobuf[5]));

1465 
DS
[
d
].
f_muÉi£ssiÚ
=1;

1466 
DS
[
d
].
lba_muÉi
=
	`msf2blk
(
	`make32
(
	`make16
(0,
šfobuf
[1]),

1467 
	`make16
(
šfobuf
[2],infobuf[3])));

1470 
DS
[
d
].
disk¡©e_æags
 |ğ
muÉi£ssiÚ_b™
;

1472 
	}
}

1474 
	$check_d©¬©e
()

1476 #ifdeà
CDMKE


1477 
i
=0;

1479 
timed_out
=0;

1480 
d©¬©e
=0;

1484 
	`DPRINTF
((
DBG_TIM
,"SBPCD:imer started (110).\n"));

1485 
	`¡i
();

1487 
	`SET_TIMER
(
m¬k_timeout
,110);

1490 
i
=
	`šb
(
CDi_¡©us
);

1491 
d©¬©e
++;

1494 ià(
d©¬©e
>0x0FFFFFFF) ;

1498 !
timed_out
);

1499 
CLEAR_TIMER
;

1500 
	`DPRINTF
((
DBG_TIM
,"SBPCD: d©¬©e: %d\n", 
d©¬©e
));

1501 ià(
d©¬©e
<65536) datarate=65536;

1503 
maxtim16
=
d©¬©e
*16;

1504 
maxtim04
=
d©¬©e
*4;

1505 
maxtim02
=
d©¬©e
*2;

1506 
maxtim_8
=
d©¬©e
/32;

1507 #ià
MANY_SESSION


1508 
maxtim_d©a
=
d©¬©e
/100;

1510 
maxtim_d©a
=
d©¬©e
/300;

1512 
	`DPRINTF
((
DBG_TIM
,"SBPCD: maxtim_8 %d, maxtim_data %d.\n",

1513 
maxtim_8
, 
maxtim_d©a
));

1515 
	}
}

1517 
	$check_v”siÚ
()

1519 
i
, 
j
;

1522 
	`şr_cmdbuf
();

1523 
drvcmd
[0]=0x82;

1524 
»¥Ú£_couÁ
=9;

1525 
æags_cmd_out
=
f_putcmd
;

1526 
	`cmd_out
();

1529 
	`şr_cmdbuf
();

1530 
i
=0;i<12;i++è
šfobuf
[i]=0;

1531 
drvcmd
[0]=0x83;

1532 
»¥Ú£_couÁ
=12;

1533 
æags_cmd_out
=
f_putcmd
;

1534 
i
=
	`cmd_out
();

1535 ià(
i
<0è
	`DPRINTF
((
DBG_INI
,"SBPCD: cmd_83„eturns %d\n",i));

1537 
	`DPRINTF
((
DBG_INI
,"SBPCD: infobuf = \""));

1538 
i
=0;i<12;i++è
	`DPRINTF
((
DBG_INI
,"%c",
šfobuf
[i]));

1539 
	`DPRINTF
((
DBG_INI
,"\"\n"));

1541 
i
=0;i<4;i++èià(
šfobuf
[i]!=
drive_çmy
[i]) ;

1542 ià(
i
==4)

1544 
DS
[
d
].
drive_mod–
[0]=
šfobuf
[
i
++];

1545 
DS
[
d
].
drive_mod–
[1]=
šfobuf
[
i
++];

1546 
DS
[
d
].
drive_mod–
[2]='-';

1547 
DS
[
d
].
drive_mod–
[3]='x';

1548 
DS
[
d
].
drv_ty³
=
drv_Ãw
;

1552 
i
=0;i<8;i++èià(
šfobuf
[i]!=
drive_v’dÜ
[i]) ;

1553 ià(
i
!=8)  (-1);

1554 
DS
[
d
].
drive_mod–
[0]='2';

1555 
DS
[
d
].
drive_mod–
[1]='x';

1556 
DS
[
d
].
drive_mod–
[2]='-';

1557 
DS
[
d
].
drive_mod–
[3]='x';

1558 
DS
[
d
].
drv_ty³
=
drv_Şd
;

1560 
j
=0;j<4;j++è
DS
[
d
].
fœmw¬e_v”siÚ
[j]=
šfobuf
[
i
+j];

1561 
j
 = (
DS
[
d
].
fœmw¬e_v”siÚ
[0] & 0x0F) * 100 +

1562 (
DS
[
d
].
fœmw¬e_v”siÚ
[2] & 0x0F) *10 +

1563 (
DS
[
d
].
fœmw¬e_v”siÚ
[3] & 0x0F);

1564 ià(
Ãw_drive
)

1566 ià(
j
<100è
DS
[
d
].
drv_ty³
=
drv_099
;

1567 
DS
[
d
].
drv_ty³
=
drv_100
;

1569 ià(
j
<200è
DS
[
d
].
drv_ty³
=
drv_199
;

1570 ià(
j
<201è
DS
[
d
].
drv_ty³
=
drv_200
;

1571 ià(
j
<210è
DS
[
d
].
drv_ty³
=
drv_201
;

1572 ià(
j
<211è
DS
[
d
].
drv_ty³
=
drv_210
;

1573 ià(
j
<300è
DS
[
d
].
drv_ty³
=
drv_211
;

1574 
DS
[
d
].
drv_ty³
=
drv_300
;

1576 
	}
}

1578 
	$sw™ch_drive
(
num
)

1580 
i
;

1582 
d
=
num
;

1584 
i
=
num
;

1585 ià(
sb´o_ty³
è
i
=(i&0x01)<<1|(i&0x02)>>1;

1586 
	`OUT
(
CDo_’abË
,
i
);

1587 
	`DPRINTF
((
DBG_DID
,"SBPCD: sw™ch_drive: driv%d‡ùiv©ed.\n",
DS
[
d
].
drv_mšÜ
));

1589 
	}
}

1594 
	$check_drives
()

1596 
i
, 
j
;

1597 *
´štk_h—d”
="";

1599 
	`DPRINTF
((
DBG_INI
,"SBPCD: check_drivesƒntered.\n"));

1601 
ndrives
=0;

1602 
j
=0;j<
NR_SBPCD
;j++)

1604 
DS
[
j
].
drv_mšÜ
=j;

1605 
	`sw™ch_drive
(
j
);

1606 
	`DPRINTF
((
DBG_ID
,"SBPCD: check_drives: driv%d‡ùiv©ed.\n",
j
));

1607 
i
=
	`check_v”siÚ
();

1608 
	`DPRINTF
((
DBG_ID
,"SBPCD: check_v”siÚ„‘uº %d.\n",
i
));

1609 ià(
i
>=0)

1611 
ndrives
++;

1612 
DS
[
d
].
drv_İtiÚs
=
drv_·‰”n
[
j
];

1613 ià(!
Ãw_drive
è
DS
[
d
].
drv_İtiÚs
&=~(
¥“d_auto
|
¥“d_300
|
¥“d_150
);

1614 
	`´štk
("%sDriv%d: %s%.4 (%.4s)\n", 
´štk_h—d”
,

1615 
DS
[
d
].
drv_mšÜ
,

1616 
drive_çmy
,

1617 
DS
[
d
].
drive_mod–
,

1618 
DS
[
d
].
fœmw¬e_v”siÚ
);

1619 
´štk_h—d”
=" - ";

1621 
DS
[
d
].
drv_mšÜ
=-1;

1623 ià(
ndrives
==0)  (-1);

1625 
	}
}

1628 
	$timewa™
()

1630 
i
;

1631 
i
=0; i<65500; i++);

1632 
	}
}

1635 #ià
FUTURE


1639 
	$obey_audio_¡©e
(
u_ch¬
 
audio_¡©e
, u_ch¬ 
func
,u_ch¬ 
subfunc
)

1641 
audio_¡©e
)

1643 
aud_11
:

1644 
audx11
:

1645 
func
)

1647 
cmd_07
:

1648 
cmd_0d
:

1649 
cmd_0e
:

1650 
cmd_0c
:

1652 
cmd_03
:

1653 
subfunc
)

1656 
cxi_00
:

1657 
cxi_06
:

1658 
cxi_09
:

1661  (
ERROR15
);

1665  (
ERROR15
);

1668 
aud_12
:

1669 
audx12
:

1674 
	}
}

1682 
	$check_®lowed1
(
u_ch¬
 
func1
, u_ch¬ 
func2
)

1685 ià(
func1
==
ioùl_o
)  (0);

1686 ià(
func1
==
»ad_lÚg
)  (-1);

1687 ià(
func1
==
»ad_lÚg_´eãtch
)  (-1);

1688 ià(
func1
==
£ek
)  (-1);

1689 ià(
func1
==
audio_¶ay
)  (-1);

1690 ià(
func1
==
audio_·u£
)  (-1);

1691 ià(
func1
==
audio_»sume
)  (-1);

1692 ià(
func1
!=
ioùl_i
)  (0);

1693 ià(
func2
==
‹Î_SubQ_run_tÙ
)  (-1);

1694 ià(
func2
==
‹Î_cdsize
)  (-1);

1695 ià(
func2
==
‹Î_TocDesü
)  (-1);

1696 ià(
func2
==
‹Î_TocEÁry
)  (-1);

1697 ià(
func2
==
‹Î_subQ_šfo
)  (-1);

1698 ià(
Ãw_drive
èià(
func2
==
‹Î_SubChªInfo
)  (-1);

1699 ià(
func2
==
‹Î_UPC
)  (-1);

1703 
	}
}

1705 
	$check_®lowed2
(
u_ch¬
 
func1
, u_ch¬ 
func2
)

1708 ià(
func1
==
»ad_lÚg
)  (-1);

1709 ià(
func1
==
»ad_lÚg_´eãtch
)  (-1);

1710 ià(
func1
==
£ek
)  (-1);

1711 ià(
func1
==
audio_¶ay
)  (-1);

1712 ià(
func1
!=
ioùl_o
)  (0);

1713 ià(
Ãw_drive
)

1715 ià(
func2
==
EjeùDisk
)  (-1);

1716 ià(
func2
==
Clo£T¿y
)  (-1);

1721 
	}
}

1723 
	$check_®lowed3
(
u_ch¬
 
func1
, u_ch¬ 
func2
)

1726 ià(
func1
==
ioùl_i
)

1728 ià(
func2
==
‹Î_add»ss
)  (0);

1729 ià(
func2
==
‹Î_ÿ·b™i
)  (0);

1730 ià(
func2
==
‹Î_CD_chªged
)  (0);

1731 ià(!
Ãw_drive
èià(
func2
==
‹Î_SubChªInfo
)  (0);

1734 ià(
func1
==
ioùl_o
)

1736 ià(
func2
==
DriveRe£t
)  (0);

1737 ià(!
Ãw_drive
)

1739 ià(
func2
==
EjeùDisk
)  (0);

1740 ià(
func2
==
LockDoÜ
)  (0);

1741 ià(
func2
==
Clo£T¿y
)  (0);

1745 ià(
func1
==
æush_šput
)  (-1);

1746 ià(
func1
==
»ad_lÚg
)  (-1);

1747 ià(
func1
==
»ad_lÚg_´eãtch
)  (-1);

1748 ià(
func1
==
£ek
)  (-1);

1749 ià(
func1
==
audio_¶ay
)  (-1);

1750 ià(
func1
==
audio_·u£
)  (-1);

1751 ià(
func1
==
audio_»sume
)  (-1);

1755 
	}
}

1757 
	$£ek_pos_audio_’d
()

1759 
i
;

1761 
i
=
	`msf2blk
(
DS
[
d
].
pos_audio_’d
)-1;

1762 ià(
i
<0)  (-1);

1763 
i
=
	`xx_S“k
(i,0);

1764  (
i
);

1765 
	}
}

1767 
	$R—dToC
()

1769 
i
, 
j
;

1770 
DS
[
d
].
disk¡©e_æags
 &ğ~
toc_b™
;

1771 
DS
[
d
].
Üed_ùl_adr
=0;

1772 
j
=
DS
[
d
].
n_fœ¡_Œack
;j<=DS[d].
n_Ï¡_Œack
;j++)

1774 
i
=
	`xx_R—dTocEÁry
(
j
);

1775 ià(
i
<0)  (i);

1776 
DS
[
d
].
TocBufãr
[
j
].
nixby‹
=DS[d].
TocEÁ_nixby‹
;

1777 
DS
[
d
].
TocBufãr
[
j
].
ùl_adr
=DS[d].
TocEÁ_ùl_adr
;

1778 
DS
[
d
].
TocBufãr
[
j
].
numb”
=DS[d].
TocEÁ_numb”
;

1779 
DS
[
d
].
TocBufãr
[
j
].
fÜm©
=DS[d].
TocEÁ_fÜm©
;

1780 
DS
[
d
].
TocBufãr
[
j
].
add»ss
=DS[d].
TocEÁ_add»ss
;

1781 
DS
[
d
].
Üed_ùl_adr
 |ğDS[d].
TocEÁ_ùl_adr
;

1784 
DS
[
d
].
TocBufãr
[
j
].
nixby‹
=0;

1785 
DS
[
d
].
TocBufãr
[
j
].
ùl_adr
=0;

1786 
DS
[
d
].
TocBufãr
[
j
].
numb”
=0;

1787 
DS
[
d
].
TocBufãr
[
j
].
fÜm©
=0;

1788 
DS
[
d
].
TocBufãr
[
j
].
add»ss
=DS[d].
size_msf
;

1790 
DS
[
d
].
disk¡©e_æags
 |ğ
toc_b™
;

1792 
	}
}

1794 
	$DiskInfo
()

1796 
i
;

1798 
i
=
	`S‘S³ed
();

1799 ià(
i
<0)

1801 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: fœ¡ S‘S³ed„‘uº %d\n", 
i
));

1802 
i
=
	`S‘S³ed
();

1803 ià(
i
<0)

1805 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: secÚd S‘S³ed„‘uº %d\n", 
i
));

1806  (
i
);

1809 
i
=
	`xx_ModeS’£
();

1810 ià(
i
<0)

1812 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: fœ¡ xx_ModeS’£„‘uº %d\n", 
i
));

1813 
i
=
	`xx_ModeS’£
();

1814 ià(
i
<0)

1816 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: secÚd xx_ModeS’£„‘uº %d\n", 
i
));

1817  (
i
);

1819  (
i
);

1821 
i
=
	`xx_R—dC­ac™y
();

1822 ià(
i
<0)

1824 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: fœ¡ R—dC­ac™y„‘uº %d\n", 
i
));

1825 
i
=
	`xx_R—dC­ac™y
();

1826 ià(
i
<0)

1828 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: secÚd R—dC­ac™y„‘uº %d\n", 
i
));

1829  (
i
);

1831  (
i
);

1833 
i
=
	`xx_R—dTocDesü
();

1834 ià(
i
<0)

1836 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: R—dTocDesü„‘uº %d\n", 
i
));

1837  (
i
);

1839 
i
=
	`R—dToC
();

1840 ià(
i
<0)

1842 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: R—dToC„‘uº %d\n", 
i
));

1843  (
i
);

1845 
i
=
	`yy_CheckMuÉiSessiÚ
();

1846 ià(
i
<0)

1848 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: yy_CheckMuÉiSessiÚ„‘uº %d\n", 
i
));

1849  (
i
);

1851 
i
=
	`xx_R—dTocEÁry
(
DS
[
d
].
n_fœ¡_Œack
);

1852 ià(
i
<0)

1854 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: xx_R—dTocEÁry(1è»tuº %d\n", 
i
));

1855  (
i
);

1857 
i
=
	`xx_R—dUPC
();

1858 ià(
i
<0)

1860 
	`DPRINTF
((
DBG_INF
,"SBPCD: DiskInfo: xx_R—dUPC„‘uº %d\n", 
i
));

1861  (
i
);

1864 
	}
}

1870 
	$´•¬e
(
u_ch¬
 
func
, u_ch¬ 
subfunc
)

1872 
i
;

1874 ià(!
Ãw_drive
)

1876 
i
=
	`šb
(
CDi_¡©us
);

1877 ià(
i
&
s_©‹ÁiÚ
è
	`G‘Stus
();

1879 
	`G‘Stus
();

1880 ià(
DS
[
d
].
CD_chªged
==0xFF)

1882 #ià
MANY_SESSION


1884 
DS
[
d
].
disk¡©e_æags
=0;

1886 
DS
[
d
].
audio_¡©e
=0;

1887 ià(!
¡_diskok
)

1889 
i
=
	`check_®lowed1
(
func
,
subfunc
);

1890 ià(
i
<0)  (-2);

1894 
i
=
	`check_®lowed3
(
func
,
subfunc
);

1895 ià(
i
<0)

1897 
DS
[
d
].
CD_chªged
=1;

1904 ià(!
¡_diskok
)

1906 #ià
MANY_SESSION


1908 
DS
[
d
].
disk¡©e_æags
=0;

1910 
DS
[
d
].
audio_¡©e
=0;

1911 
i
=
	`check_®lowed1
(
func
,
subfunc
);

1912 ià(
i
<0)  (-2);

1916 ià(
¡_busy
)

1918 ià(
DS
[
d
].
audio_¡©e
!=
audio_·usšg
)

1920 
i
=
	`check_®lowed2
(
func
,
subfunc
);

1921 ià(
i
<0)  (-2);

1926 ià(
DS
[
d
].
audio_¡©e
==
audio_¶ayšg
è
	`£ek_pos_audio_’d
();

1927 
DS
[
d
].
audio_¡©e
=0;

1929 ià(!
äame_size_v®id
)

1931 
i
=
	`DiskInfo
();

1932 ià(
i
<0)

1934 #ià
MANY_SESSION


1936 
DS
[
d
].
disk¡©e_æags
=0;

1938 
DS
[
d
].
audio_¡©e
=0;

1939 
i
=
	`check_®lowed1
(
func
,
subfunc
);

1940 ià(
i
<0)  (-2);

1946 
	}
}

1948 
	$xx_PÏyAudioMSF
(
pos_audio_¡¬t
,
pos_audio_’d
)

1950 
i
;

1952 ià(
DS
[
d
].
audio_¡©e
==
audio_¶ayšg
è (-
EINVAL
);

1953 
	`şr_cmdbuf
();

1954 ià(
Ãw_drive
)

1956 
drvcmd
[0]=0x0E;

1957 
æags_cmd_out
 = 
f_putcmd
 | 
f_»¥o2
 | 
f_Re¥Ú£Stus
 |

1958 
f_obey_p_check
 | 
f_wa™_if_busy
;

1962 
drvcmd
[0]=0x0B;

1963 
æags_cmd_out
 = 
f_putcmd
 | 
f_»¥o2
 | 
f_lİ¡a
 | 
f_g‘¡a
 |

1964 
f_Re¥Ú£Stus
 | 
f_obey_p_check
 | 
f_wa™_if_busy
;

1966 
drvcmd
[1]=(
pos_audio_¡¬t
>>16)&0x00FF;

1967 
drvcmd
[2]=(
pos_audio_¡¬t
>>8)&0x00FF;

1968 
drvcmd
[3]=
pos_audio_¡¬t
&0x00FF;

1969 
drvcmd
[4]=(
pos_audio_’d
>>16)&0x00FF;

1970 
drvcmd
[5]=(
pos_audio_’d
>>8)&0x00FF;

1971 
drvcmd
[6]=
pos_audio_’d
&0x00FF;

1972 
»¥Ú£_couÁ
=0;

1973 
i
=
	`cmd_out
();

1974  (
i
);

1975 
	}
}

1984 
	$sbpcd_ioùl
(
šode
 *šode,
fe
 *file,

1985 
u_št
 
cmd
, 
u_lÚg
 
¬g
)

1987 
i
, 
¡
;

1989 
	`DPRINTF
((
DBG_IO2
,"SBPCD: ioctl(%d, 0x%08lX, 0x%08lX)\n",

1990 
	`MINOR
(
šode
->
i_rdev
), 
cmd
, 
¬g
));

1991 ià(!
šode
è (-
EINVAL
);

1992 
i
=
	`MINOR
(
šode
->
i_rdev
);

1993 iàĞ(
i
<0è|| (i>=
NR_SBPCD
) )

1995 
	`´štk
("SBPCD: ioùl: bad deviû: %d\n", 
i
);

1996  (-
ENODEV
);

1998 
	`sw™ch_drive
(
i
);

2000 
¡
=
	`G‘Stus
();

2001 ià(
¡
<0è (-
EIO
);

2003 ià(!
toc_v®id
)

2005 
i
=
	`DiskInfo
();

2006 ià(
i
<0è (-
EIO
);

2009 
	`DPRINTF
((
DBG_IO2
,"SBPCD: ioùl: deviû %d,„eque¡ %04X\n",
i
,
cmd
));

2010 
cmd
)

2012 
DDIOCSDBG
:

2013 ià(! 
	`su£r
()è (-
EPERM
);

2014 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, ());

2015 ià(
i
>=0èi=
	`sbpcd_dbg_ioùl
(
¬g
,1);

2016  (
i
);

2018 
CDROMPAUSE
:

2019 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMPAUSEƒntered.\n"));

2024 
DS
[
d
].
audio_¡©e
)

2026 
audio_¶ayšg
:

2027 
i
=
	`xx_Pau£_Resume
(1);

2028 ià(
i
<0è (-
EIO
);

2029 
DS
[
d
].
audio_¡©e
=
audio_·usšg
;

2030 
i
=
	`xx_R—dSubQ
();

2031 ià(
i
<0è (-
EIO
);

2032 
DS
[
d
].
pos_audio_¡¬t
=DS[d].
SubQ_run_tÙ
;

2034 
audio_·usšg
:

2035 
i
=
	`xx_S“k
(
DS
[
d
].
pos_audio_¡¬t
,1);

2036 ià(
i
<0è (-
EIO
);

2039  (-
EINVAL
);

2042 
CDROMRESUME
:

2043 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMRESUMEƒntered.\n"));

2047 ià(
DS
[
d
].
audio_¡©e
!=
audio_·usšg
è -
EINVAL
;

2048 
i
=
	`xx_Pau£_Resume
(3);

2049 ià(
i
<0è (-
EIO
);

2050 
DS
[
d
].
audio_¡©e
=
audio_¶ayšg
;

2053 
CDROMPLAYMSF
:

2054 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMPLAYMSFƒntered.\n"));

2055 ià(
DS
[
d
].
audio_¡©e
==
audio_¶ayšg
)

2057 
i
=
	`xx_Pau£_Resume
(1);

2058 ià(
i
<0è (-
EIO
);

2059 
i
=
	`xx_R—dSubQ
();

2060 ià(
i
<0è (-
EIO
);

2061 
DS
[
d
].
pos_audio_¡¬t
=DS[d].
SubQ_run_tÙ
;

2062 
i
=
	`xx_S“k
(
DS
[
d
].
pos_audio_¡¬t
,1);

2064 
¡
=
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
cdrom_msf
));

2065 ià(
¡
)  (st);

2066 
	`memıy_äomfs
(&
msf
, (*è
¬g
, (
cdrom_msf
));

2068 
DS
[
d
].
pos_audio_¡¬t
 = (
msf
.
cdmsf_mš0
<<16) |

2069 (
msf
.
cdmsf_£c0
<<8) |

2070 
msf
.
cdmsf_äame0
;

2071 
DS
[
d
].
pos_audio_’d
 = (
msf
.
cdmsf_mš1
<<16) |

2072 (
msf
.
cdmsf_£c1
<<8) |

2073 
msf
.
cdmsf_äame1
;

2074 
	`DPRINTF
((
DBG_IOX
,"SBPCD: ioctl: CDROMPLAYMSF %08X %08X\n",

2075 
DS
[
d
].
pos_audio_¡¬t
,DS[d].
pos_audio_’d
));

2076 
i
=
	`xx_PÏyAudioMSF
(
DS
[
d
].
pos_audio_¡¬t
,DS[d].
pos_audio_’d
);

2077 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioùl: xx_PÏyAudioMSF„‘uº %d\n",
i
));

2079 ià(
i
<0è (-
EIO
);

2081 
DS
[
d
].
audio_¡©e
=
audio_¶ayšg
;

2084 
CDROMPLAYTRKIND
:

2085 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMPLAYTRKINDƒntered.\n"));

2086 ià(
DS
[
d
].
audio_¡©e
==
audio_¶ayšg
)

2088 
	`DPRINTF
((
DBG_IOX
,"SBPCD: CDROMPLAYTRKIND:‡lready‡udio_playing.\n"));

2090  (-
EINVAL
);

2092 
¡
=
	`v”ify_¬—
(
VERIFY_READ
,(*è
¬g
,(
cdrom_ti
));

2093 ià(
¡
<0)

2095 
	`DPRINTF
((
DBG_IOX
,"SBPCD: CDROMPLAYTRKIND: verify_areaƒrror.\n"));

2096  (
¡
);

2098 
	`memıy_äomfs
(&
ti
,(*è
¬g
,(
cdrom_ti
));

2099 
	`DPRINTF
((
DBG_IOX
,"SBPCD: ioctl:rk0: %d, ind0: %d,rk1:%d, ind1:%d\n",

2100 
ti
.
cdti_Œk0
,ti.
cdti_šd0
,ti.
cdti_Œk1
,ti.
cdti_šd1
));

2101 ià(
ti
.
cdti_Œk0
<
DS
[
d
].
n_fœ¡_Œack
è (-
EINVAL
);

2102 ià(
ti
.
cdti_Œk0
>
DS
[
d
].
n_Ï¡_Œack
è (-
EINVAL
);

2103 ià(
ti
.
cdti_Œk1
<ti.
cdti_Œk0
)i.cdti_trk1=ti.cdti_trk0;

2104 ià(
ti
.
cdti_Œk1
>
DS
[
d
].
n_Ï¡_Œack
)i.cdti_trk1=DS[d].n_last_track;

2105 
DS
[
d
].
pos_audio_¡¬t
=DS[d].
TocBufãr
[
ti
.
cdti_Œk0
].
add»ss
;

2106 
DS
[
d
].
pos_audio_’d
=DS[d].
TocBufãr
[
ti
.
cdti_Œk1
+1].
add»ss
;

2107 
i
=
	`xx_PÏyAudioMSF
(
DS
[
d
].
pos_audio_¡¬t
,DS[d].
pos_audio_’d
);

2109 ià(
i
<0è (-
EIO
);

2111 
DS
[
d
].
audio_¡©e
=
audio_¶ayšg
;

2114 
CDROMREADTOCHDR
:

2115 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMREADTOCHDRƒntered.\n"));

2116 
tochdr
.
cdth_Œk0
=
DS
[
d
].
n_fœ¡_Œack
;

2117 
tochdr
.
cdth_Œk1
=
DS
[
d
].
n_Ï¡_Œack
;

2118 
¡
=
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, (
cdrom_tochdr
));

2119 ià(
¡
)  (st);

2120 
	`memıy_tofs
((*è
¬g
, &
tochdr
, (
cdrom_tochdr
));

2123 
CDROMREADTOCENTRY
:

2124 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMREADTOCENTRYƒntered.\n"));

2125 
¡
=
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, (
cdrom_toûÁry
));

2126 ià(
¡
)  (st);

2127 
	`memıy_äomfs
(&
toûÁry
, (*è
¬g
, (
cdrom_toûÁry
));

2128 
i
=
toûÁry
.
cd‹_Œack
;

2129 ià(
i
==
CDROM_LEADOUT
èi=
DS
[
d
].
n_Ï¡_Œack
+1;

2130 ià(
i
<
DS
[
d
].
n_fœ¡_Œack
||i>DS[d].
n_Ï¡_Œack
è (-
EINVAL
);

2131 
toûÁry
.
cd‹_adr
=
DS
[
d
].
TocBufãr
[
i
].
ùl_adr
&0x0F;

2132 
toûÁry
.
cd‹_ù¾
=(
DS
[
d
].
TocBufãr
[
i
].
ùl_adr
>>4)&0x0F;

2133 
toûÁry
.
cd‹_d©amode
=
DS
[
d
].
TocBufãr
[
i
].
fÜm©
;

2134 ià(
toûÁry
.
cd‹_fÜm©
==
CDROM_MSF
)

2135 { 
toûÁry
.
cd‹_addr
.
msf
.
mšu‹
=(
DS
[
d
].
TocBufãr
[
i
].
add»ss
>>16)&0x00FF;

2136 
toûÁry
.
cd‹_addr
.
msf
.
£cÚd
=(
DS
[
d
].
TocBufãr
[
i
].
add»ss
>>8)&0x00FF;

2137 
toûÁry
.
cd‹_addr
.
msf
.
äame
=
DS
[
d
].
TocBufãr
[
i
].
add»ss
&0x00FF;

2139 ià(
toûÁry
.
cd‹_fÜm©
==
CDROM_LBA
)

2140 
toûÁry
.
cd‹_addr
.
lba
=
	`msf2blk
(
DS
[
d
].
TocBufãr
[
i
].
add»ss
);

2141  (-
EINVAL
);

2142 
¡
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
, (
cdrom_toûÁry
));

2143 ià(
¡
)  (st);

2144 
	`memıy_tofs
((*è
¬g
, &
toûÁry
, (
cdrom_toûÁry
));

2147 
CDROMSTOP
:

2148 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMSTOPƒntered.\n"));

2149 
i
=
	`DriveRe£t
();

2150 #ià
WORKMAN


2151 
DS
[
d
].
CD_chªged
=0xFF;

2152 
DS
[
d
].
disk¡©e_æags
=0;

2154 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioùl: DriveRe£ˆ»tuº %d\n",
i
));

2155 
DS
[
d
].
audio_¡©e
=0;

2156 
i
=
	`DiskInfo
();

2159 
CDROMSTART
:

2160 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMSTARTƒntered.\n"));

2161 
i
=
	`xx_SpšUp
();

2162 
DS
[
d
].
audio_¡©e
=0;

2165 
CDROMEJECT
:

2166 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMEJECTƒntered.\n"));

2167 ià(!
Ãw_drive
)  (0);

2168 #ià
WORKMAN


2169 
DS
[
d
].
CD_chªged
=0xFF;

2170 
DS
[
d
].
disk¡©e_æags
=0;

2172 
i
=
	`yy_SpšDown
();

2173 ià(
i
<0è (-
EIO
);

2174 
DS
[
d
].
audio_¡©e
=0;

2177 
CDROMVOLCTRL
:

2178 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMVOLCTRLƒntered.\n"));

2179 
¡
=
	`v”ify_¬—
(
VERIFY_READ
,(*è
¬g
,(
vŞù¾
));

2180 ià(
¡
)  (st);

2181 
	`memıy_äomfs
(&
vŞù¾
,(*è
¬g
,(volctrl));

2182 
DS
[
d
].
vŞ_chª0
=0;

2183 
DS
[
d
].
vŞ_ù¾0
=
vŞù¾
.
chªÃl0
;

2184 
DS
[
d
].
vŞ_chª1
=1;

2185 
DS
[
d
].
vŞ_ù¾1
=
vŞù¾
.
chªÃl1
;

2186 
i
=
	`xx_S‘VŞume
();

2189 
CDROMSUBCHNL
:

2190 
	`DPRINTF
((
DBG_IOS
,"SBPCD: ioctl: CDROMSUBCHNLƒntered.\n"));

2191 ià((
¡_¥šnšg
)||(!
subq_v®id
)è{ 
i
=
	`xx_R—dSubQ
();

2192 ià(
i
<0è (-
EIO
);

2194 
¡
=
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, (
cdrom_subchÆ
));

2195 ià(
¡
)  (st);

2196 
	`memıy_äomfs
(&
SC
, (*è
¬g
, (
cdrom_subchÆ
));

2198 ià(
DS
[
d
].
SubQ_audio
==0x80èDS[d].SubQ_audio=
CDROM_AUDIO_NO_STATUS
;

2200 
DS
[
d
].
audio_¡©e
)

2202 
audio_¶ayšg
:

2203 
SC
.
cdsc_audio¡©us
=
CDROM_AUDIO_PLAY
;

2205 
audio_·usšg
:

2206 
SC
.
cdsc_audio¡©us
=
CDROM_AUDIO_PAUSED
;

2209 
SC
.
cdsc_audio¡©us
=
CDROM_AUDIO_NO_STATUS
;

2212 
SC
.
cdsc_adr
=
DS
[
d
].
SubQ_ùl_adr
;

2213 
SC
.
cdsc_ù¾
=
DS
[
d
].
SubQ_ùl_adr
>>4;

2214 
SC
.
cdsc_Œk
=
	`bcd2bš
(
DS
[
d
].
SubQ_Œk
);

2215 
SC
.
cdsc_šd
=
	`bcd2bš
(
DS
[
d
].
SubQ_²t_idx
);

2216 ià(
SC
.
cdsc_fÜm©
==
CDROM_LBA
)

2218 
SC
.
cdsc_ab§ddr
.
lba
=
	`msf2blk
(
DS
[
d
].
SubQ_run_tÙ
);

2219 
SC
.
cdsc_»Ïddr
.
lba
=
	`msf2blk
(
DS
[
d
].
SubQ_run_Œk
);

2223 
SC
.
cdsc_ab§ddr
.
msf
.
mšu‹
=(
DS
[
d
].
SubQ_run_tÙ
>>16)&0x00FF;

2224 
SC
.
cdsc_ab§ddr
.
msf
.
£cÚd
=(
DS
[
d
].
SubQ_run_tÙ
>>8)&0x00FF;

2225 
SC
.
cdsc_ab§ddr
.
msf
.
äame
=
DS
[
d
].
SubQ_run_tÙ
&0x00FF;

2226 
SC
.
cdsc_»Ïddr
.
msf
.
mšu‹
=(
DS
[
d
].
SubQ_run_Œk
>>16)&0x00FF;

2227 
SC
.
cdsc_»Ïddr
.
msf
.
£cÚd
=(
DS
[
d
].
SubQ_run_Œk
>>8)&0x00FF;

2228 
SC
.
cdsc_»Ïddr
.
msf
.
äame
=
DS
[
d
].
SubQ_run_Œk
&0x00FF;

2230 
	`memıy_tofs
((*è
¬g
, &
SC
, (
cdrom_subchÆ
));

2231 
	`DPRINTF
((
DBG_IOS
,"SBPCD: CDROMSUBCHNL: %1X %02X %08X %08X %02X %02X %06X %06X\n",

2232 
SC
.
cdsc_fÜm©
,SC.
cdsc_audio¡©us
,

2233 
SC
.
cdsc_adr
,SC.
cdsc_ù¾
,

2234 
SC
.
cdsc_Œk
,SC.
cdsc_šd
,

2235 
SC
.
cdsc_ab§ddr
,SC.
cdsc_»Ïddr
));

2238 
CDROMREADMODE2
:

2239 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMREADMODE2„equested.\n"));

2240  (-
EINVAL
);

2242 
CDROMREADMODE1
:

2243 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioctl: CDROMREADMODE1„equested.\n"));

2244  (-
EINVAL
);

2247 
	`DPRINTF
((
DBG_IOC
,"SBPCD: ioùl: unknowÀfunùiÚ„eque¡ %04X\n", 
cmd
));

2248  (-
EINVAL
);

2250 
	}
}

2256 
	$sbp_Œªsãr
()

2258 
offs
;

2260  (
CURRENT
->
Ä_£ùÜs
 > 0) &&

2261 (
CURRENT
->
£ùÜ
/4 >ğ
DS
[
d
].
sbp_fœ¡_äame
) &&

2262 (
CURRENT
->
£ùÜ
/4 <ğ
DS
[
d
].
sbp_Ï¡_äame
) )

2264 
offs
 = (
CURRENT
->
£ùÜ
 - 
DS
[
d
].
sbp_fœ¡_äame
 * 4) * 512;

2265 
	`memıy
(
CURRENT
->
bufãr
, 
DS
[
d
].
sbp_buf
 + 
offs
, 512);

2266 
CURRENT
->
Ä_£ùÜs
--;

2267 
CURRENT
->
£ùÜ
++;

2268 
CURRENT
->
bufãr
 += 512;

2270 
	}
}

2275 #ià
SBPCD_USE_IRQ


2276 
	$sbpcd_š‹¼u±
(
unu£d
)

2278 
¡
;

2280 
¡
 = 
	`šb
(
CDi_¡©us
) & 0xFF;

2281 
	`DPRINTF
((
DBG_IRQ
,"SBPCD: INTERRUPT„eûived - CDi_¡©us=%02X\n", 
¡
));

2282 
	}
}

2288 
	$sbp_¡©us
()

2290 
¡
;

2292 
¡
=
	`Re¥Ú£Stus
();

2293 ià(
¡
<0)

2295 
	`DPRINTF
((
DBG_INF
,"SBPCD: sbp_status:imeout.\n"));

2299 ià(!
¡_¥šnšg
è
	`DPRINTF
((
DBG_SPI
,"SBPCD: motor got off - ignoring.\n"));

2301 ià(
¡_check
)

2303 
	`DPRINTF
((
DBG_INF
,"SBPCD: st_check detected -„etrying.\n"));

2306 ià(!
¡_doÜ_şo£d
)

2308 
	`DPRINTF
((
DBG_INF
,"SBPCD: door is open -„etrying.\n"));

2311 ià(!
¡_ÿddy_š
)

2313 
	`DPRINTF
((
DBG_INF
,"SBPCD: disk„emoved -„etrying.\n"));

2316 ià(!
¡_diskok
)

2318 
	`DPRINTF
((
DBG_INF
,"SBPCD: !st_diskok detected -„etrying.\n"));

2321 ià(
¡_busy
)

2323 
	`DPRINTF
((
DBG_INF
,"SBPCD: st_busy detected -„etrying.\n"));

2327 
	}
}

2332 
	$do_sbpcd_»que¡
()

2334 
u_št
 
block
;

2335 
dev
;

2336 
u_št
 
n£ù
;

2337 
i
, 
¡©us_Œ›s
, 
d©a_Œ›s
;

2339 
»que¡_loİ
:

2341 
	`¡i
();

2343 ià((
CURRENT
==
NULL
)||(CURRENT->
dev
<0)) ;

2344 ià(
CURRENT
 -> 
£ùÜ
 == -1) ;

2346 
dev
 = 
	`MINOR
(
CURRENT
->dev);

2347 iàĞ(
dev
<0è|| (dev>=
NR_SBPCD
) )

2349 
	`´štk
("SBPCD: do_»que¡: bad deviû: %d\n", 
dev
);

2352 
	`sw™ch_drive
(
dev
);

2354 
INIT_REQUEST
;

2355 
block
 = 
CURRENT
->
£ùÜ
;

2356 
n£ù
 = 
CURRENT
->
Ä_£ùÜs
;

2358 ià(
CURRENT
->
cmd
 !ğ
READ
)

2360 
	`´štk
("SBPCD: bad cmd %d\n", 
CURRENT
->
cmd
);

2361 
	`’d_»que¡
(0);

2362 
»que¡_loİ
;

2365 
	`DPRINTF
((
DBG_MUL
,"SBPCD:„—d LBA %d\n", 
block
/4));

2366 
	`sbp_Œªsãr
();

2370 ià(
CURRENT
->
Ä_£ùÜs
 == 0)

2372 
	`’d_»que¡
(1);

2373 
»que¡_loİ
;

2376 
i
=
	`´•¬e
(0,0);

2377 ià(
i
!=0è
	`DPRINTF
((
DBG_INF
,"SBPCD: \"prepare\"ellsƒrror %d -- ignored\n", i));

2379 ià(!
¡_¥šnšg
è
	`xx_SpšUp
();

2381 
d©a_Œ›s
=3; data_tries > 0; data_tries--)

2383 
¡©us_Œ›s
=3; status_tries > 0; status_tries--)

2385 
æags_cmd_out
 |ğ
f_»¥o3
;

2386 
	`xx_R—dStus
();

2387 ià(
	`sbp_¡©us
() != 0) ;

2388 
	`sbp_¦“p
(1);

2390 ià(
¡©us_Œ›s
 == 0)

2392 
	`DPRINTF
((
DBG_INF
,"SBPCD: sbp_status: failed‡fter 3ries\n"));

2396 
	`sbp_»ad_cmd
();

2397 
	`sbp_¦“p
(0);

2398 ià(
	`sbp_d©a
() != 0)

2400 
	`’d_»que¡
(1);

2401 
»que¡_loİ
;

2405 
	`’d_»que¡
(0);

2406 
	`sbp_¦“p
(10);

2407 
»que¡_loİ
;

2408 
	}
}

2414 
	$sbp_»ad_cmd
()

2416 
i
;

2417 
block
;

2419 
DS
[
d
].
sbp_fœ¡_äame
=DS[d].
sbp_Ï¡_äame
=-1;

2420 
block
=
CURRENT
->
£ùÜ
/4;

2422 ià(
Ãw_drive
)

2424 #ià
MANY_SESSION


2425 
	`DPRINTF
((
DBG_MUL
,"SBPCD:„—d MSF %08X\n", 
	`blk2msf
(
block
)));

2426 iàĞ(
DS
[
d
].
f_muÉi£ssiÚ
è&& (
muÉi£ssiÚ_v®id
) )

2428 
	`DPRINTF
((
DBG_MUL
,"SBPCD: MultiSession: use %08X for %08X (msf)\n",

2429 
	`blk2msf
(
DS
[
d
].
lba_muÉi
+
block
),

2430 
	`blk2msf
(
block
)));

2431 
block
=
DS
[
d
].
lba_muÉi
+block;

2434 iàĞ(
block
==166è&& (
DS
[
d
].
f_muÉi£ssiÚ
è&& (
muÉi£ssiÚ_v®id
) )

2436 
	`DPRINTF
((
DBG_MUL
,"SBPCD: MultiSession: use %08X for %08X (msf)\n",

2437 
	`blk2msf
(
DS
[
d
].
lba_muÉi
+16),

2438 
	`blk2msf
(
block
)));

2439 
block
=
DS
[
d
].
lba_muÉi
+16;

2444 ià(
block
+
SBP_BUFFER_FRAMES
 <ğ
DS
[
d
].
CDsize_äm
)

2445 
DS
[
d
].
sbp_»ad_äames
 = 
SBP_BUFFER_FRAMES
;

2448 
DS
[
d
].
sbp_»ad_äames
=DS[d].
CDsize_äm
-
block
;

2450 ià(
DS
[
d
].
sbp_»ad_äames
 < 1)

2452 
	`DPRINTF
((
DBG_INF
,"SBPCD:„equested frame %d, CD size %d ???\n",

2453 
block
, 
DS
[
d
].
CDsize_äm
));

2454 
DS
[
d
].
sbp_»ad_äames
=1;

2457 
DS
[
d
].
sbp_cu¼’t
 = 0;

2459 
æags_cmd_out
 = 
f_putcmd
 |

2460 
f_»¥o2
 |

2461 
f_Re¥Ú£Stus
 |

2462 
f_obey_p_check
;

2464 ià(!
Ãw_drive
)

2466 ià(
DS
[
d
].
drv_ty³
>=
drv_201
)

2468 
	`lba2msf
(
block
,&
drvcmd
[1]);

2469 
	`bš2bcdx
(&
drvcmd
[1]);

2470 
	`bš2bcdx
(&
drvcmd
[2]);

2471 
	`bš2bcdx
(&
drvcmd
[3]);

2475 
drvcmd
[1]=(
block
>>16)&0x000000ff;

2476 
drvcmd
[2]=(
block
>>8)&0x000000ff;

2477 
drvcmd
[3]=
block
&0x000000ff;

2479 
drvcmd
[4]=0;

2480 
drvcmd
[5]=
DS
[
d
].
sbp_»ad_äames
;

2481 
drvcmd
[6]=(
DS
[
d
].
drv_ty³
<
drv_201
)?0:2;

2482 
drvcmd
[0]=0x02;

2483 
æags_cmd_out
 |ğ
f_lİ¡a
|
f_g‘¡a
|
f_b™1
;

2487 
	`lba2msf
(
block
,&
drvcmd
[1]);

2488 
drvcmd
[4]=0;

2489 
drvcmd
[5]=0;

2490 
drvcmd
[6]=
DS
[
d
].
sbp_»ad_äames
;

2491 
drvcmd
[0]=0x10;

2493 #ià
SBPCD_DIS_IRQ


2494 
	`şi
();

2496 
i
=0;i<7;i++è
	`OUT
(
CDo_commªd
,
drvcmd
[i]);

2497 #ià
SBPCD_DIS_IRQ


2498 
	`¡i
();

2502 
	}
}

2508 
	$sbp_d©a
()

2510 
i
=0, 
j
=0, 
äame
;

2511 
u_št
 
Œy
=0;

2512 
u_lÚg
 
timeout
;

2513 
u_ch¬
 *
p
;

2514 
u_št
 
d©a_Œ›s
 = 0;

2515 
u_št
 
d©a_wa™s
 = 0;

2516 
u_št
 
d©a_»Œyšg
 = 0;

2517 
”rÜ_æag
;

2519 
”rÜ_æag
=0;

2521 
äame
=
DS
[
d
].
sbp_cu¼’t
;äame<DS[d].
sbp_»ad_äames
&&!
”rÜ_æag
; frame++)

2523 #ià
SBPCD_DIS_IRQ


2524 
	`şi
();

2526 
Œy
=
maxtim_d©a
;

2527 
timeout
=
jiff›s
+100; ; )

2529  ; 
Œy
!=0;try--)

2531 
j
=
	`šb
(
CDi_¡©us
);

2532 ià(!(
j
&
s_nÙ_d©a_»ady
)) ;

2533 ià(!(
j
&
s_nÙ_»suÉ_»ady
)) ;

2534 ià(!
Ãw_drive
èià(
j
&
s_©‹ÁiÚ
) ;

2536 ià(
Œy
 !ğ0 || 
timeout
 <ğ
jiff›s
) ;

2537 ià(
d©a_»Œyšg
 =ğ0è
d©a_wa™s
++;

2538 
d©a_»Œyšg
 = 1;

2539 
	`sbp_¦“p
(1);

2540 
Œy
 = 1;

2542 ià(
Œy
==0)

2544 
	`DPRINTF
((
DBG_INF
,"SBPCD: sbp_data: CDi_statusimeout.\n"));

2545 
”rÜ_æag
++;

2549 ià(
j
&
s_nÙ_d©a_»ady
)

2551 ià((
DS
[
d
].
Üed_ùl_adr
&0x40)==0)

2552 
	`´štk
("SBPCD: CD contains‚o dataracks.\n");

2553 
	`´štk
("SBPCD: sbp_data: DATA_READYimeout.\n");

2554 
”rÜ_æag
++;

2558 #ià
SBPCD_DIS_IRQ


2559 
	`¡i
();

2562 
CLEAR_TIMER
;

2563 
”rÜ_æag
=0;

2564 
p
 = 
DS
[
d
].
sbp_buf
 + 
äame
 * 
CD_FRAMESIZE
;

2566 ià(
sb´o_ty³
è
	`OUT
(
CDo_£l_d_i
,0x01);

2567 
	`READ_DATA
(
CDi_d©a
, 
p
, 
CD_FRAMESIZE
);

2568 ià(
sb´o_ty³
è
	`OUT
(
CDo_£l_d_i
,0x00);

2569 
DS
[
d
].
sbp_cu¼’t
++;

2571 
d©a_Œ›s
++;

2572 
d©a_»Œyšg
 = 0;

2573 ià(
d©a_Œ›s
 >= 1000)

2575 
	`DPRINTF
((
DBG_INF
,"SBPCD: info: %d waits in %d frames.\n",

2576 
d©a_wa™s
, 
d©a_Œ›s
));

2577 
d©a_wa™s
 = 
d©a_Œ›s
 = 0;

2580 #ià
SBPCD_DIS_IRQ


2581 
	`¡i
();

2584 ià(
”rÜ_æag
)

2586 
	`DPRINTF
((
DBG_INF
,"SBPCD:„ead‡borted by drive\n"));

2587 
i
=
	`DriveRe£t
();

2591 ià(!
Ãw_drive
)

2593 #ià
SBPCD_DIS_IRQ


2594 
	`şi
();

2596 
i
=
maxtim_d©a
;

2597 
timeout
=
jiff›s
+100;imeout > jiffies;imeout--)

2599  ;
i
!=0;i--)

2601 
j
=
	`šb
(
CDi_¡©us
);

2602 ià(!(
j
&
s_nÙ_d©a_»ady
)) ;

2603 ià(!(
j
&
s_nÙ_»suÉ_»ady
)) ;

2604 ià(
j
&
s_©‹ÁiÚ
) ;

2606 ià(
i
 !ğ0 || 
timeout
 <ğ
jiff›s
) ;

2607 
	`sbp_¦“p
(0);

2608 
i
 = 1;

2610 ià(
i
==0è{ 
	`DPRINTF
((
DBG_INF
,"SBPCD: STATUS TIMEOUT AFTER READ")); }

2611 ià(!(
j
&
s_©‹ÁiÚ
))

2613 
	`DPRINTF
((
DBG_INF
,"SBPCD: sbp_data:imeout waiting DRV_ATTN -„etrying\n"));

2614 
i
=
	`DriveRe£t
();

2615 #ià
SBPCD_DIS_IRQ


2616 
	`¡i
();

2620 #ià
SBPCD_DIS_IRQ


2621 
	`¡i
();

2627 ià(!
Ãw_drive
è
	`xx_R—dStus
();

2628 
i
=
	`Re¥Ú£Stus
();

2629 ià(
i
<0è{ 
	`DPRINTF
((
DBG_INF
,"SBPCD: xx_ReadStatusƒrror‡fter„ead: %02X\n",

2630 
DS
[
d
].
¡©us_by‹
));

2634 (!
Ãw_drive
)&&(!
¡_check
)&&(!(
i
&
p_sucûss_Şd
)));

2635 ià(
¡_check
)

2637 
i
=
	`xx_R—dE¼Ü
();

2638 
	`DPRINTF
((
DBG_INF
,"SBPCD: xx_R—dE¼Ü wa Ãûs§ry‡á”„—d: %02X\n",
i
));

2642 
DS
[
d
].
sbp_fœ¡_äame
 = 
CURRENT
 -> 
£ùÜ
 / 4;

2643 
DS
[
d
].
sbp_Ï¡_äame
 = DS[d].
sbp_fœ¡_äame
 + DS[d].
sbp_»ad_äames
 - 1;

2644 
	`sbp_Œªsãr
();

2646 
	}
}

2652 
	$sbpcd_İ’
(
šode
 *

, 
fe
 *
å
)

2654 
i
;

2656 ià(
ndrives
==0è (-
ENXIO
);

2658 
i
 = 
	`MINOR
(

->
i_rdev
);

2659 iàĞ(
i
<0è|| (i>=
NR_SBPCD
) )

2661 
	`´štk
("SBPCD: o³n: bad deviû: %d\n", 
i
);

2662  (-
ENODEV
);

2664 
	`sw™ch_drive
(
i
);

2666 ià(!
¡_¥šnšg
è
	`xx_SpšUp
();

2668 
æags_cmd_out
 |ğ
f_»¥o2
;

2669 
	`xx_R—dStus
();

2670 
i
=
	`Re¥Ú£Stus
();

2671 ià(
i
<0)

2673 
	`DPRINTF
((
DBG_INF
,"SBPCD: sbpcd_open: xx_ReadStatusimed out\n"));

2674  (-
EIO
);

2676 
	`DPRINTF
((
DBG_STA
,"SBPCD: sbpcd_İ’: stu %02X\n", 
DS
[
d
].
¡©us_by‹
));

2677 ià(!
¡_doÜ_şo£d
||!
¡_ÿddy_š
)

2679 
	`´štk
("SBPCD: sbpcd_open:‚o disk in drive\n");

2680  (-
EIO
);

2689 ià(!
¡_¥šnšg
è
	`xx_SpšUp
();

2691 
i
=
	`DiskInfo
();

2692 ià((
DS
[
d
].
Üed_ùl_adr
&0x40)==0)

2693 
	`DPRINTF
((
DBG_INF
,"SBPCD: CD contains‚o dataracks.\n"));

2695 
	}
}

2700 
	$sbpcd_»Ëa£
(
šode
 * 

, 
fe
 * file)

2702 
i
;

2709 
i
 = 
	`MINOR
(

->
i_rdev
);

2710 iàĞ(
i
<0è|| (i>=
NR_SBPCD
) )

2712 
	`´štk
("SBPCD:„–—£: bad deviû: %d\n", 
i
);

2715 
	`sw™ch_drive
(
i
);

2717 
DS
[
d
].
sbp_fœ¡_äame
=DS[d].
sbp_Ï¡_äame
=-1;

2718 
	`sync_dev
(

->
i_rdev
);

2719 
	`šv®id©e_bufãrs
(

->
i_rdev
);

2720 
DS
[
d
].
disk¡©e_æags
 &ğ~
cd_size_b™
;

2721 
	}
}

2726 
fe_İ”©iÚs
 
	gsbpcd_fİs
 =

2728 
NULL
,

2729 
block_»ad
,

2730 
block_wr™e
,

2731 
NULL
,

2732 
NULL
,

2733 
sbpcd_ioùl
,

2734 
NULL
,

2735 
sbpcd_İ’
,

2736 
sbpcd_»Ëa£


2742 #ià
SBPCD_USE_IRQ


2743 
sigaùiÚ
 
	gsbpcd_sigaùiÚ
 =

2745 
sbpcd_š‹¼u±
,

2747 
SA_INTERRUPT
,

2748 
NULL


2767 
	$sbpcd_£tup
(*
s
, *
p
)

2769 
	`DPRINTF
((
DBG_INI
,"SBPCD: sbpcd_£tu°ÿÎed w™h %04X,%s\n",
p
[1], 
s
));

2770 ià(!
	`¡rcmp
(
s
,
¡r_sb
)è
sb´o_ty³
=1;

2771 
sb´o_ty³
=0;

2772 ià(
p
[0]>0è
sbpcd_ißddr
=p[1];

2774 
CDo_commªd
=
sbpcd_ißddr
;

2775 
CDi_šfo
=
sbpcd_ißddr
;

2776 
CDi_¡©us
=
sbpcd_ißddr
+1;

2777 
CDo_»£t
=
sbpcd_ißddr
+2;

2778 
CDo_’abË
=
sbpcd_ißddr
+3;

2779 ià(
sb´o_ty³
==1)

2781 
MIXER_addr
=
sbpcd_ißddr
-0x10+0x04;

2782 
MIXER_d©a
=
sbpcd_ißddr
-0x10+0x05;

2783 
CDo_£l_d_i
=
sbpcd_ißddr
+1;

2784 
CDi_d©a
=
sbpcd_ißddr
;

2786 
CDi_d©a
=
sbpcd_ißddr
+2;

2787 
	}
}

2792 
u_lÚg
 
	$sbpcd_š™
(
u_lÚg
 
mem_¡¬t
, u_lÚg 
mem_’d
)

2794 
i
=0, 
j
=0;

2795 
addr
[2]={1, 
CDROM_PORT
};

2796 
pÜt_šdex
;

2798 
	`DPRINTF
((
DBG_INF
,"SBPCD v”siÚ %s\n", 
VERSION
));

2800 
	`DPRINTF
((
DBG_INF
,"SBPCD: Looking for‡ SoundBlaster/Matsushita CD-ROM drive\n"));

2801 
	`DPRINTF
((
DBG_WRN
,"SBPCD: \n"));

2802 
	`DPRINTF
((
DBG_WRN
,"SBPCD: = = = = = = = = = = W A R N I N G = = = = = = = = = =\n"));

2803 
	`DPRINTF
((
DBG_WRN
,"SBPCD: Auto-Probing can cause‡ hang (f.e.ouching‡nƒthernet card).\n"));

2804 
	`DPRINTF
((
DBG_WRN
,"SBPCD: Ifhat happens, you haveo„eboot‡nd usehe\n"));

2805 
	`DPRINTF
((
DBG_WRN
,"SBPCD: LILO (kernel) command†ine feature†ike:\n"));

2806 
	`DPRINTF
((
DBG_WRN
,"SBPCD: \n"));

2807 
	`DPRINTF
((
DBG_WRN
,"SBPCD: LILO boot:†inux sbpcd=0x230,SoundBlaster\n"));

2808 
	`DPRINTF
((
DBG_WRN
,"SBPCD: or†ike:\n"));

2809 
	`DPRINTF
((
DBG_WRN
,"SBPCD: LILO boot:†inux sbpcd=0x300,LaserMate\n"));

2810 
	`DPRINTF
((
DBG_WRN
,"SBPCD: \n"));

2811 
	`DPRINTF
((
DBG_WRN
,"SBPCD: with your REAL‡ddress.\n"));

2812 
	`DPRINTF
((
DBG_WRN
,"SBPCD: = = = = = = = = = = END of WARNING = = = = = = = = = =\n"));

2813 
	`DPRINTF
((
DBG_WRN
,"SBPCD: \n"));

2814 
	`¡i
();

2816 
autİrobe
[0]=
sbpcd_ißddr
;

2817 
autİrobe
[1]=
sb´o_ty³
;

2819 
pÜt_šdex
=0;pÜt_šdex<
NUM_AUTOPROBE
;port_index+=2)

2821 
addr
[1]=
autİrobe
[
pÜt_šdex
];

2822 ià(
	`check_»giÚ
(
addr
[1],4)) ;

2823 
	`DPRINTF
((
DBG_INI
,"SBPCD: check_region done.\n"));

2824 ià(
autİrobe
[
pÜt_šdex
+1]==0è
ty³
=
¡r_lm
;

2825 
ty³
=
¡r_sb
;

2826 
	`sbpcd_£tup
(
ty³
, 
addr
);

2827 
	`DPRINTF
((
DBG_INF
,"SBPCD: Tryingo detect‡ %s CD-ROM drive‡t 0x%X.\n",

2828 
ty³
, 
CDo_commªd
));

2830 
	`DPRINTF
((
DBG_INF
,"SBPCD: - "));

2831 
	`¡i
();

2832 
i
=
	`check_drives
();

2833 
	`DPRINTF
((
DBG_INI
,"SBPCD: check_drives done.\n"));

2834 
	`¡i
();

2835 ià(
i
>=0) ;

2836 
	`DPRINTF
((
DBG_INF
,"\n"));

2837 
	`¡i
();

2840 ià(
ndrives
==0)

2842 
	`´štk
("SBPCD: No drive found.\n");

2843 
	`¡i
();

2844  (
mem_¡¬t
);

2847 ià(
pÜt_šdex
>0)

2849 
	`´štk
("SBPCD: You should configure sbpcd.h for your hardware.\n");

2850 
	`¡i
();

2853 
	`´štk
("SBPCD: %d %s CD-ROM drive(s)‡t 0x%04X.\n",

2854 
ndrives
, 
ty³
, 
CDo_commªd
);

2855 
	`¡i
();

2856 
	`check_d©¬©e
();

2857 
	`DPRINTF
((
DBG_INI
,"SBPCD: check_datarate done.\n"));

2858 
	`¡i
();

2860 
j
=0;j<
NR_SBPCD
;j++)

2862 ià(
DS
[
j
].
drv_mšÜ
==-1) ;

2863 
	`sw™ch_drive
(
j
);

2864 
	`xy_DriveRe£t
();

2865 ià(!
¡_¥šnšg
è
	`xx_SpšUp
();

2866 
DS
[
d
].
sbp_fœ¡_äame
 = -1;

2867 
DS
[
d
].
sbp_Ï¡_äame
 = -1;

2868 
DS
[
d
].
sbp_»ad_äames
 = 0;

2869 
DS
[
d
].
sbp_cu¼’t
 = 0;

2870 
DS
[
d
].
CD_chªged
=1;

2871 
DS
[
d
].
äame_size
=
CD_FRAMESIZE
;

2873 
	`xx_R—dStus
();

2874 
i
=
	`Re¥Ú£Stus
();

2875 ià(
i
<0)

2876 
	`DPRINTF
((
DBG_INF
,"SBPCD: in™: Re¥Ú£Stu »tuº %02X\n",
i
));

2879 ià(
¡_check
)

2881 
i
=
	`xx_R—dE¼Ü
();

2882 
	`DPRINTF
((
DBG_INI
,"SBPCD: in™: xx_R—dE¼Ü„‘uº %d\n",
i
));

2883 
	`¡i
();

2886 
	`DPRINTF
((
DBG_INI
,"SBPCD: in™: fœ¡ G‘Stus: %d\n",
i
));

2887 
	`¡i
();

2888 ià(
DS
[
d
].
”rÜ_by‹
==
aud_12
)

2890 dØ{ 
i
=
	`G‘Stus
();

2891 
	`DPRINTF
((
DBG_INI
,"SBPCD: in™: secÚd G‘Stus: %02X\n",
i
));

2892 
	`¡i
();

2893 ià(
i
<0) ;

2894 ià(!
¡_ÿddy_š
) ;

2896 !
¡_diskok
);

2898 
i
=
	`S‘S³ed
();

2899 ià(
i
>=0è
DS
[
d
].
CD_chªged
=1;

2902 ià(
sb´o_ty³
)

2904 
	`OUT
(
MIXER_addr
,
MIXER_CD_VŞume
);

2905 
	`OUT
(
MIXER_d©a
,0xCC);

2908 ià(
	`»gi¡”_blkdev
(
MATSUSHITA_CDROM_MAJOR
, "sbpcd", &
sbpcd_fİs
) != 0)

2910 
	`´štk
("SBPCD: Can't get MAJOR %d for Matsushita CDROM\n",

2911 
MATSUSHITA_CDROM_MAJOR
);

2912 
	`¡i
();

2913  (
mem_¡¬t
);

2915 
blk_dev
[
MATSUSHITA_CDROM_MAJOR
].
»que¡_â
 = 
DEVICE_REQUEST
;

2916 
»ad_ah—d
[
MATSUSHITA_CDROM_MAJOR
] = 4;

2918 
	`¢¬f_»giÚ
(
CDo_commªd
,4);

2920 #ià
SBPCD_USE_IRQ


2921 ià(
	`œqaùiÚ
(
SBPCD_INTR_NR
, &
sbpcd_sigaùiÚ
))

2923 
	`´štk
("SBPCD: Cª'ˆg‘ IRQ%d fÜ sbpcd driv”\n", 
SBPCD_INTR_NR
);

2924 
	`¡i
();

2931 
j
=0;j<
NR_SBPCD
;j++)

2933 ià(
DS
[
j
].
drv_mšÜ
==-1) ;

2934 
DS
[
j
].
sbp_buf
=(
u_ch¬
 *)
mem_¡¬t
;

2935 
mem_¡¬t
 +ğ
SBP_BUFFER_FRAMES
*
CD_FRAMESIZE
;

2937 
	`DPRINTF
((
DBG_INF
,"SBPCD: init done.\n"));

2938 
	`¡i
();

2939  (
mem_¡¬t
);

2940 
	}
}

2949 
	$check_sbpcd_medŸ_chªge
(
fuÎ_dev
, 
unu£d_mšÜ
)

2951 
¡
;

2953 ià(
	`MAJOR
(
fuÎ_dev
è!ğ
MATSUSHITA_CDROM_MAJOR
)

2955 
	`´štk
("SBPCD: media_check: invalid device.\n");

2959 
	`xx_R—dStus
();

2960 
¡
=
	`Re¥Ú£Stus
();

2961 
	`DPRINTF
((
DBG_CHK
,"SBPCD: medŸ_check: %02X\n",
DS
[
d
].
¡©us_by‹
));

2962 ià(
¡
<0)

2964 
	`DPRINTF
((
DBG_INF
,"SBPCD: media_check: ResponseStatusƒrror.\n"));

2967 ià(
DS
[
d
].
CD_chªged
==0xFFè
	`DPRINTF
((
DBG_CHK
,"SBPCD: media_check: \"changed\"‡ssumed.\n"));

2968 ià(!
¡_¥šnšg
è
	`DPRINTF
((
DBG_CHK
,"SBPCD: media_check: motor off.\n"));

2969 ià(!
¡_doÜ_şo£d
)

2971 
	`DPRINTF
((
DBG_CHK
,"SBPCD: media_check: door open.\n"));

2972 
DS
[
d
].
CD_chªged
=0xFF;

2974 ià(!
¡_ÿddy_š
)

2976 
	`DPRINTF
((
DBG_CHK
,"SBPCD: media_check:‚o disk in drive.\n"));

2977 
DS
[
d
].
CD_chªged
=0xFF;

2979 ià(!
¡_diskok
è
	`DPRINTF
((
DBG_CHK
,"SBPCD: media_check: !st_diskok.\n"));

2982 ià(
DS
[
d
].
CD_chªged
==0xFF)

2984 
DS
[
d
].
CD_chªged
=1;

2989 ià(!
¡_diskok
)  (1);

2990 ià(!
¡_ÿddy_š
)  (1);

2991 ià(!
¡_doÜ_şo£d
)  (1);

2993 
	}
}

	@drivers/block/xd.c

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/g’hd.h
>

19 
	~<lšux/xd.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/io.h
>

23 
	~<asm/£gm’t.h
>

24 
	~<asm/dma.h
>

26 
	#MAJOR_NR
 
XT_DISK_MAJOR


	)

27 
	~"blk.h
"

29 
XD_INFO
 
	gxd_šfo
[
XD_MAXDRIVES
];

55 
XD_SIGNATURE
 
	gxd_sigs
[] = {

56 { 0x0000,"Ov”ridgeom‘ry hªdËr",
NULL
,
xd_ov”ride_š™_drive
,"n unknown" },

57 { 0x000B,"CXD23A NÙ‡ÀIBM ROM (C)CİyrighˆD©¨TechnŞogy CÜ°12/03/88",
xd_dtc_š™_cÚŒŞËr
,
xd_dtc_š™_drive
," DTC 5150X" },

58 { 0x0008,"07/15/86 (CèCİyrighˆ1986 We¡”ÀDig™® CÜp",
xd_wd_š™_cÚŒŞËr
,
xd_wd_š™_drive
," Western Digital 1002AWX1" },

59 { 0x0008,"06/24/88 (CèCİyrighˆ1988 We¡”ÀDig™® CÜp",
xd_wd_š™_cÚŒŞËr
,
xd_wd_š™_drive
," Western Digital 1004A27X" },

60 { 0x0008,"06/24/88(CèCİyrighˆ1988 We¡”ÀDig™® CÜp.",
xd_wd_š™_cÚŒŞËr
,
xd_wd_š™_drive
," Western Digital WDXT-GEN2" },

61 { 0x0015,"SEAGATE ST11 BIOS REVISION",
xd_£ag©e_š™_cÚŒŞËr
,
xd_£ag©e_š™_drive
," Seagate ST11M/R" },

62 { 0x0010,"ST11R BIOS",
xd_£ag©e_š™_cÚŒŞËr
,
xd_£ag©e_š™_drive
," Seagate ST11M/R" },

63 { 0x1000,"(c)Cİyrighˆ1987 SMS",
xd_omti_š™_cÚŒŞËr
,
xd_omti_š™_drive
,"n OMTI 5520" },

65 
u_ch¬
 *
	gxd_ba£s
[] =

67 (
u_ch¬
 *) 0xC8000,(u_char *) 0xCA000,(u_char *) 0xCC000,

68 (
u_ch¬
 *) 0xCE000,(u_char *) 0xD0000,(u_char *) 0xD8000,

69 (
u_ch¬
 *) 0xE0000

72 
hd_¡ruù
 
	gxd
[
XD_MAXDRIVES
 << 6];

73 
	gxd_sizes
[
XD_MAXDRIVES
 << 6],
	gxd_acûss
[XD_MAXDRIVES] = { 0,0 };

74 
	gxd_blocksizes
[
XD_MAXDRIVES
 << 6];

75 
g’disk
 
	gxd_g’disk
 = { 
MAJOR_NR
,"xd",6,1 << 6,
XD_MAXDRIVES
,
xd_g’š™
,
xd
,
xd_sizes
,0,(*è
xd_šfo
,
NULL
 };

76 
fe_İ”©iÚs
 
	gxd_fİs
 = { 
NULL
,
block_»ad
,
block_wr™e
,NULL,NULL,
xd_ioùl
,NULL,
xd_İ’
,
xd_»Ëa£
,
block_fsync
 };

78 
wa™_queue
 *
	gxd_wa™_št
 = 
NULL
,*
	gxd_wa™_İ’
 = NULL;

79 
u_ch¬
 
	gxd_v®id
[
XD_MAXDRIVES
] = { 0,0 };

80 
u_ch¬
 
	gxd_drives
 = 0,
	gxd_œq
 = 0,
	gxd_dma
 = 0,
	gxd_max£ùÜs
,
	gxd_ov”ride
 = 0,
	gxd_ty³
 = 0;

81 
u_shÜt
 
	gxd_ioba£
 = 0;

84 
u_lÚg
 
	$xd_š™
 (
u_lÚg
 
mem_¡¬t
,u_lÚg 
mem_’d
)

86 
u_ch¬
 
i
,
cÚŒŞËr
,*
add»ss
;

88 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"xd",&
xd_fİs
)) {

89 
	`´štk
("xd_š™: uÇbËØg‘ majÜ‚umb” %d\n",
MAJOR_NR
);

90  (
mem_¡¬t
);

92 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

93 
»ad_ah—d
[
MAJOR_NR
] = 8;

94 
xd_g’disk
.
Ãxt
 = 
g’disk_h—d
;

95 
g’disk_h—d
 = &
xd_g’disk
;

97 ià(
	`xd_d‘eù
(&
cÚŒŞËr
,&
add»ss
)) {

99 
	`´štk
("xd_š™: d‘eùed‡% cÚŒŞË¸Ñy³ %dè©‡dd»s %p\n",
xd_sigs
[
cÚŒŞËr
].
Çme
,cÚŒŞËr,
add»ss
);

100 ià(
cÚŒŞËr
)

101 
xd_sigs
[
cÚŒŞËr
].
	`š™_cÚŒŞËr
(
add»ss
);

102 
xd_drives
 = 
	`xd_š™drives
(
xd_sigs
[
cÚŒŞËr
].
š™_drive
);

104 
	`´štk
("xd_š™: d‘eùed %d h¬d drive% (usšg IRQ%d & DMA%d)\n",
xd_drives
,xd_drive =ğ1 ? "" : "s",
xd_œq
,
xd_dma
);

105 
i
 = 0; i < 
xd_drives
; i++)

106 
	`´štk
("xd_š™: driv%d geom‘ry - h—d ğ%d, cylšd” ğ%d, seùÜ ğ%d\n",
i
,
xd_šfo
[i].
h—ds
,xd_šfo[i].
cylšd”s
,xd_šfo[i].
£ùÜs
);

108 ià(!
	`»que¡_œq
(
xd_œq
,
xd_š‹¼u±_hªdËr
)) {

109 ià(
	`»que¡_dma
(
xd_dma
)) {

110 
	`´štk
("xd_š™: uÇbËØg‘ DMA%d\n",
xd_dma
);

111 
	`ä“_œq
(
xd_œq
);

115 
	`´štk
("xd_š™: uÇbËØg‘ IRQ%d\n",
xd_œq
);

117  
mem_¡¬t
;

118 
	}
}

121 
u_ch¬
 
	$xd_d‘eù
 (
u_ch¬
 *
cÚŒŞËr
,u_ch¬ **
add»ss
)

123 
u_ch¬
 
i
,
j
,
found
 = 0;

125 ià(
xd_ov”ride
)

127 *
cÚŒŞËr
 = 
xd_ty³
;

128 *
add»ss
 = 
NULL
;

132 
i
 = 0; i < ((
xd_ba£s
è/ (xd_ba£s[0])è&& !
found
; i++)

133 
j
 = 1; j < ((
xd_sigs
è/ (xd_sigs[0])è&& !
found
; j++)

134 ià(!
	`memcmp
(
xd_ba£s
[
i
] + 
xd_sigs
[
j
].
off£t
,xd_sigs[j].
¡ršg
,
	`¡¾’
(xd_sigs[j].string))) {

135 *
cÚŒŞËr
 = 
j
;

136 *
add»ss
 = 
xd_ba£s
[
i
];

137 
found
++;

139  (
found
);

140 
	}
}

143 
	$xd_g’š™
 ()

145 
u_ch¬
 
i
;

147 
i
 = 0; i < 
xd_drives
; i++) {

148 
xd
[
i
 << 6].
Ä_£ùs
 = 
xd_šfo
[i].
h—ds
 * xd_šfo[i].
cylšd”s
 * xd_šfo[i].
£ùÜs
;

149 
xd_v®id
[
i
] = 1;

152 
xd_g’disk
.
Ä_»®
 = 
xd_drives
;

154 
i
=0;i<(
XD_MAXDRIVES
 << 6);i++è
xd_blocksizes
[i] = 1024;

155 
blksize_size
[
MAJOR_NR
] = 
xd_blocksizes
;

156 
	}
}

159 
	$xd_İ’
 (
šode
 *šode,
fe
 *file)

161 
dev
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

163 ià(
dev
 < 
xd_drives
) {

164 !
xd_v®id
[
dev
])

165 
	`¦“p_Ú
(&
xd_wa™_İ’
);

167 
xd_acûss
[
dev
]++;

172  (-
ENODEV
);

173 
	}
}

176 
	$do_xd_»que¡
 ()

178 
u_št
 
block
,
couÁ
,
»Œy
;

179 
code
;

181 
	`¡i
();

182 
code
 = 0, 
CURRENT
) {

183 
INIT_REQUEST
;

185 ià(
CURRENT_DEV
 < 
xd_drives
 && 
CURRENT
->
£ùÜ
 + CURRENT->
Ä_£ùÜs
 <ğ
xd
[
	`MINOR
(CURRENT->
dev
)].
Ä_£ùs
) {

186 
block
 = 
CURRENT
->
£ùÜ
 + 
xd
[
	`MINOR
(CURRENT->
dev
)].
¡¬t_£ù
;

187 
couÁ
 = 
CURRENT
->
Ä_£ùÜs
;

189 
CURRENT
->
cmd
) {

190 
READ
:

191 
WRITE
: 
»Œy
 = 0; (»Œy < 
XD_RETRIES
è&& !
code
;„etry++)

192 
code
 = 
	`xd_»adwr™e
(
CURRENT
->
cmd
,
CURRENT_DEV
,CURRENT->
bufãr
,
block
,
couÁ
);

194 : 
	`´štk
("do_xd_request: unknown„equest\n"); ;

197 
	`’d_»que¡
(
code
);

199 
	}
}

202 
	$xd_ioùl
 (
šode
 *šode,
fe
 *fe,
u_št
 
cmd
,
u_lÚg
 
¬g
)

204 
XD_GEOMETRY
 *
geom‘ry
 = (XD_GEOMETRY *è
¬g
;

205 
dev
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
)),
”r
;

207 ià(
šode
 && (
dev
 < 
xd_drives
))

208 
cmd
) {

209 
HDIO_GETGEO
: ià(
¬g
) {

210 ià((
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
geom‘ry
,(*geometry))))

211  (
”r
);

212 
	`put_fs_by‹
(
xd_šfo
[
dev
].
h—ds
,(*è&
geom‘ry
->heads);

213 
	`put_fs_by‹
(
xd_šfo
[
dev
].
£ùÜs
,(*è&
geom‘ry
->sectors);

214 
	`put_fs_wÜd
(
xd_šfo
[
dev
].
cylšd”s
,(*è&
geom‘ry
->cylinders);

215 
	`put_fs_lÚg
(
xd
[
	`MINOR
(
šode
->
i_rdev
)].
¡¬t_£ù
,(*è&
geom‘ry
->
¡¬t
);

220 
BLKGETSIZE
: ià(
¬g
) {

221 ià((
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
,())))

222  (
”r
);

223 
	`put_fs_lÚg
(
xd
[
	`MINOR
(
šode
->
i_rdev
)].
Ä_£ùs
,(*è
¬g
);

228 
BLKFLSBUF
:

229 if(!
	`su£r
()è -
EACCES
;

230 if(!
šode
->
i_rdev
è -
EINVAL
;

231 
	`fsync_dev
(
šode
->
i_rdev
);

232 
	`šv®id©e_bufãrs
(
šode
->
i_rdev
);

235 
BLKRRPART
:  (
	`xd_»»ad_·¹™iÚs
(
šode
->
i_rdev
));

236 
	`RO_IOCTLS
(
šode
->
i_rdev
,
¬g
);

238  (-
EINVAL
);

239 
	}
}

242 
	$xd_»Ëa£
 (
šode
 *šode, 
fe
 *file)

244 
dev
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

246 ià(
dev
 < 
xd_drives
) {

247 
	`sync_dev
(
dev
);

248 
xd_acûss
[
dev
]--;

250 
	}
}

253 
	$xd_»»ad_·¹™iÚs
(
dev
)

255 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
dev
)),
¡¬t
 =¬g‘ << 
xd_g’disk
.
mšÜ_shiá
,
·¹™iÚ
;

257 
	`şi
(); 
xd_v®id
[
rg‘
] = (
xd_acûss
[rg‘] !ğ1); 
	`¡i
();

258 ià(
xd_v®id
[
rg‘
])

259  (-
EBUSY
);

261 
·¹™iÚ
 = 
xd_g’disk
.
max_p
 - 1;…artition >= 0;…artition--) {

262 
	`sync_dev
(
MAJOR_NR
 << 8 | 
¡¬t
 | 
·¹™iÚ
);

263 
	`šv®id©e_šodes
(
MAJOR_NR
 << 8 | 
¡¬t
 | 
·¹™iÚ
);

264 
	`šv®id©e_bufãrs
(
MAJOR_NR
 << 8 | 
¡¬t
 | 
·¹™iÚ
);

265 
xd_g’disk
.
·¹
[
¡¬t
 + 
·¹™iÚ
].
¡¬t_£ù
 = 0;

266 
xd_g’disk
.
·¹
[
¡¬t
 + 
·¹™iÚ
].
Ä_£ùs
 = 0;

269 
xd_g’disk
.
·¹
[
¡¬t
].
Ä_£ùs
 = 
xd_šfo
[
rg‘
].
h—ds
 * xd_šfo[rg‘].
cylšd”s
 * xd_šfo[rg‘].
£ùÜs
;

270 
	`»£tup_Úe_dev
(&
xd_g’disk
,
rg‘
);

272 
xd_v®id
[
rg‘
] = 1;

273 
	`wake_up
(&
xd_wa™_İ’
);

276 
	}
}

279 
	$xd_»adwr™e
 (
u_ch¬
 
İ”©iÚ
,u_ch¬ 
drive
,*
bufãr
,
u_št
 
block
,u_šˆ
couÁ
)

281 
u_ch¬
 
cmdblk
[6],
£n£
[4];

282 
u_shÜt
 
Œack
,
cylšd”
;

283 
u_ch¬
 
h—d
,
£ùÜ
,
cÚŒŞ
,
mode
,
‹mp
;

285 #ifdeà
DEBUG_READWRITE


286 
	`´štk
("xd_»adwr™e: o³¿tiÚ = %s, drivğ%d, bufã¸ğ0x%X, block = %d, couÁ = %d\n",
İ”©iÚ
 =ğ
READ
 ? "»ad" : "wr™e",
drive
,
bufãr
,
block
,
couÁ
);

289 
cÚŒŞ
 = 
xd_šfo
[
drive
].control;

290 
couÁ
) {

291 
‹mp
 = 
couÁ
 < 
xd_max£ùÜs
 ? count : xd_maxsectors;

293 
Œack
 = 
block
 / 
xd_šfo
[
drive
].
£ùÜs
;

294 
h—d
 = 
Œack
 % 
xd_šfo
[
drive
].
h—ds
;

295 
cylšd”
 = 
Œack
 / 
xd_šfo
[
drive
].
h—ds
;

296 
£ùÜ
 = 
block
 % 
xd_šfo
[
drive
].
£ùÜs
;

298 #ifdeà
DEBUG_READWRITE


299 
	`´štk
("xd_»adwr™e: drivğ%d, h—d = %d, cylšd” = %d, seùÜ = %d, couÁ = %d\n",
drive
,
h—d
,
cylšd”
,
£ùÜ
,
‹mp
);

302 
mode
 = 
	`xd_£tup_dma
(
İ”©iÚ
 =ğ
READ
 ? 
DMA_MODE_READ
 : 
DMA_MODE_WRITE
,(
u_ch¬
 *)
bufãr
,
‹mp
 * 0x200);

303 
	`xd_bud
(
cmdblk
,
İ”©iÚ
 =ğ
READ
 ? 
CMD_READ
 : 
CMD_WRITE
,
drive
,
h—d
,
cylšd”
,
£ùÜ
,
‹mp
 & 0xFF,
cÚŒŞ
);

305 
	`xd_commªd
(
cmdblk
,
mode
,(
u_ch¬
 *è
bufãr
,(u_ch¬ *èbufãr,
£n£
,
XD_TIMEOUT
)) {

306 1: 
	`´štk
("xd_»adwr™e:imeout,„eÿlib¿tšg drive\n"); 
	`xd_»ÿlib¿‹
(
drive
);  (0);

307 2: (
£n£
[0] & 0x30) >> 4) {

308 0: 
	`´štk
("xd_»adwr™e: driv”rÜ, codğ0x%X",
£n£
[0] & 0x0F); ;

309 1: 
	`´štk
("xd_»adwr™e: cÚŒŞË¸”rÜ, codğ0x%X",
£n£
[0] & 0x0F); ;

310 2: 
	`´štk
("xd_»adwr™e: commªdƒ¼Ü, codğ0x%X",
£n£
[0] & 0x0F); ;

311 3: 
	`´štk
("xd_»adwr™e: misûÎªeou ”rÜ, codğ0x%X",
£n£
[0] & 0x0F); ;

313 ià(
£n£
[0] & 0x80)

314 
	`´štk
(" - drivğ%d, h—d = %d, cylšd” = %d, seùÜ = %d\n",
£n£
[1] & 0xE0,sense[1] & 0x1F,((sense[2] & 0xC0) << 2) | sense[3],sense[2] & 0x3F);

316 
	`´štk
(" -‚o valid disk‡ddress\n");

319 
couÁ
 -ğ
‹mp
, 
bufãr
 +ğ‹m°* 0x200, 
block
 +=emp;

322 
	}
}

325 
	$xd_»ÿlib¿‹
 (
u_ch¬
 
drive
)

327 
u_ch¬
 
cmdblk
[6];

329 
	`xd_bud
(
cmdblk
,
CMD_RECALIBRATE
,
drive
,0,0,0,0,0);

330 ià(
	`xd_commªd
(
cmdblk
,
PIO_MODE
,0,0,0,
XD_TIMEOUT
 * 8))

331 
	`´štk
("xd_recalibrate: warning!ƒrror„ecalibrating, controller may be unstable\n");

332 
	}
}

335 
	$xd_š‹¼u±_hªdËr
 (
unu£d
)

337 ià(
	`šb
(
XD_STATUS
è& 
STAT_INTERRUPT
) {

338 #ifdeà
DEBUG_OTHER


339 
	`´štk
("xd_interrupt_handler: interrupt detected\n");

341 
	`outb
(0,
XD_CONTROL
);

342 
	`wake_up
(&
xd_wa™_št
);

345 
	`´štk
("xd_interrupt_handler: unexpected interrupt\n");

346 
	}
}

349 
u_ch¬
 
	$xd_£tup_dma
 (
u_ch¬
 
mode
,u_ch¬ *
bufãr
,
u_št
 
couÁ
)

351 ià(
bufãr
 < ((
u_ch¬
 *è0x1000000 - 
couÁ
)) {

352 ià(((
u_št
è
bufãr
 & 0xFFFF0000è!ğ((u_štèbufã¸+ 
couÁ
) & 0xFFFF0000) {

353 #ifdeà
DEBUG_OTHER


354 
	`´štk
("xd_setup_dma: using PIO,ransfer overlaps 64k boundary\n");

356  (
PIO_MODE
);

358 
	`di§bË_dma
(
xd_dma
);

359 
	`ş—r_dma_ff
(
xd_dma
);

360 
	`£t_dma_mode
(
xd_dma
,
mode
);

361 
	`£t_dma_addr
(
xd_dma
,(
u_št
è
bufãr
);

362 
	`£t_dma_couÁ
(
xd_dma
,
couÁ
);

364  (
DMA_MODE
);

366 #ifdeà
DEBUG_OTHER


367 
	`´štk
("xd_setup_dma: using PIO, cannot DMA‡bove 16 meg\n");

369  (
PIO_MODE
);

370 
	}
}

373 
u_ch¬
 *
	$xd_bud
 (
u_ch¬
 *
cmdblk
,u_ch¬ 
commªd
,u_ch¬ 
drive
,u_ch¬ 
h—d
,
u_shÜt
 
cylšd”
,u_ch¬ 
£ùÜ
,u_ch¬ 
couÁ
,u_ch¬ 
cÚŒŞ
)

375 
cmdblk
[0] = 
commªd
;

376 
cmdblk
[1] = ((
drive
 & 0x07è<< 5è| (
h—d
 & 0x1F);

377 
cmdblk
[2] = ((
cylšd”
 & 0x300è>> 2è| (
£ùÜ
 & 0x3F);

378 
cmdblk
[3] = 
cylšd”
 & 0xFF;

379 
cmdblk
[4] = 
couÁ
;

380 
cmdblk
[5] = 
cÚŒŞ
;

382  (
cmdblk
);

383 
	}
}

386 
šlše
 
u_ch¬
 
	$xd_wa™pÜt
 (
u_shÜt
 
pÜt
,
u_ch¬
 
æags
,u_ch¬ 
mask
,
u_lÚg
 
timeout
)

388 
u_lÚg
 
expœy
 = 
jiff›s
 + 
timeout
;

390 ((
	`šb
(
pÜt
è& 
mask
è!ğ
æags
è&& (
jiff›s
 < 
expœy
))

393  (
jiff›s
 >ğ
expœy
);

394 
	}
}

397 
u_št
 
	$xd_commªd
 (
u_ch¬
 *
commªd
,u_ch¬ 
mode
,u_ch¬ *
šd©a
,u_ch¬ *
outd©a
,u_ch¬ *
£n£
,
u_lÚg
 
timeout
)

399 
u_ch¬
 
cmdblk
[6],
csb
,
com¶‘e
 = 0;

401 #ifdeà
DEBUG_COMMAND


402 
	`´štk
("xd_commªd: commªd = 0x%X, modğ0x%X, ind©¨ğ0x%X, outd©¨ğ0x%X, s’£ = 0x%X\n",
commªd
,
mode
,
šd©a
,
outd©a
,
£n£
);

405 
	`outb
(0,
XD_SELECT
);

406 
	`outb
(
mode
,
XD_CONTROL
);

408 ià(
	`xd_wa™pÜt
(
XD_STATUS
,
STAT_SELECT
,STAT_SELECT,
timeout
))

411 !
com¶‘e
) {

412 ià(
	`xd_wa™pÜt
(
XD_STATUS
,
STAT_READY
,STAT_READY,
timeout
))

414 
	`šb
(
XD_STATUS
è& (
STAT_COMMAND
 | 
STAT_INPUT
)) {

415 0: ià(
mode
 =ğ
DMA_MODE
) {

416 
	`’abË_dma
(
xd_dma
);

417 
	`¦“p_Ú
(&
xd_wa™_št
);

418 
	`di§bË_dma
(
xd_dma
);

421 
	`outb
(
outd©a
 ? *outd©a++ : 0,
XD_DATA
);

423 
STAT_INPUT
: ià(
mode
 =ğ
DMA_MODE
) {

424 
	`’abË_dma
(
xd_dma
);

425 
	`¦“p_Ú
(&
xd_wa™_št
);

426 
	`di§bË_dma
(
xd_dma
);

429 ià(
šd©a
)

430 *
šd©a
++ = 
	`šb
(
XD_DATA
);

432 
	`šb
(
XD_DATA
);

434 
STAT_COMMAND
: 
	`outb
(
commªd
 ? *commªd++ : 0,
XD_DATA
); ;

435 
STAT_COMMAND


436 | 
STAT_INPUT
: 
com¶‘e
 = 1; ;

439 
csb
 = 
	`šb
(
XD_DATA
);

441 ià(
	`xd_wa™pÜt
(
XD_STATUS
,0,
STAT_SELECT
,
timeout
))

444 ià(
csb
 & 
CSB_ERROR
) {

445 
	`xd_bud
(
cmdblk
,
CMD_SENSE
,(
csb
 & 
CSB_LUN
) >> 5,0,0,0,0,0);

446 ià(
	`xd_commªd
(
cmdblk
,0,
£n£
,0,0,
XD_TIMEOUT
))

447 
	`´štk
("xd_command: warning! sense command failed!\n");

450 #ifdeà
DEBUG_COMMAND


451 
	`´štk
("xd_commªd: com¶‘ed w™h csb = 0x%X\n",
csb
);

454  (
csb
 & 
CSB_ERROR
);

455 
	}
}

457 
u_ch¬
 
xd_š™drives
 ((*
š™_drive
)(u_ch¬ 
drive
))

459 
u_ch¬
 
cmdblk
[6],
i
,
couÁ
 = 0;

461 
i
 = 0; i < 
XD_MAXDRIVES
; i++) {

462 
	`xd_bud
(
cmdblk
,
CMD_TESTREADY
,
i
,0,0,0,0,0);

463 ià(!
	`xd_commªd
(
cmdblk
,
PIO_MODE
,0,0,0,
XD_TIMEOUT
 * 2)) {

464 
	`š™_drive
(
couÁ
);

465 
couÁ
++;

468  (
couÁ
);

469 
	}
}

471 
	$xd_dtc_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
)

473 (
u_lÚg
è
add»ss
) {

474 0xC8000: 
xd_ioba£
 = 0x320; ;

475 0xCA000: 
xd_ioba£
 = 0x324; ;

476 : 
	`´štk
("xd_dtc_š™_cÚŒŞËr: unsuµÜ‹d BIOS‡dd»s %p\n",
add»ss
);

477 
xd_ioba£
 = 0x320; ;

479 
xd_œq
 = 5;

480 
xd_dma
 = 3;

481 
xd_max£ùÜs
 = 0x01;

483 
	`outb
(0,
XD_RESET
);

484 
	}
}

486 
	$xd_dtc_š™_drive
 (
u_ch¬
 
drive
)

488 
u_ch¬
 
cmdblk
[6],
buf
[64];

490 
	`xd_bud
(
cmdblk
,
CMD_DTCGETGEOM
,
drive
,0,0,0,0,0);

491 ià(!
	`xd_commªd
(
cmdblk
,
PIO_MODE
,
buf
,0,0,
XD_TIMEOUT
 * 2)) {

492 
xd_šfo
[
drive
].
h—ds
 = 
buf
[0x0A];

493 
xd_šfo
[
drive
].
cylšd”s
 = ((
u_shÜt
 *è(
buf
))[0x04];

494 
xd_šfo
[
drive
].
£ùÜs
 = 17;

496 
xd_šfo
[
drive
].
rwr™e
 = ((
u_shÜt
 *è(
buf
 + 1))[0x05];

497 
xd_šfo
[
drive
].
´ecomp
 = ((
u_shÜt
 *è(
buf
 + 1))[0x06];

498 
xd_šfo
[
drive
].
ecc
 = 
buf
[0x0F];

500 
xd_šfo
[
drive
].
cÚŒŞ
 = 0;

502 
	`xd_£¬am
(
CMD_DTCSETPARAM
,
drive
,
xd_šfo
[drive].
h—ds
,xd_šfo[drive].
cylšd”s
,((
u_shÜt
 *è(
buf
 + 1))[0x05],((u_short *) (buf + 1))[0x06],buf[0x0F]);

503 
	`xd_bud
(
cmdblk
,
CMD_DTCSETSTEP
,
drive
,0,0,0,0,7);

504 ià(
	`xd_commªd
(
cmdblk
,
PIO_MODE
,0,0,0,
XD_TIMEOUT
 * 2))

505 
	`´štk
("xd_dtc_š™_drive:ƒ¼Ü s‘tšg s‹°¿‹ fÜ driv%d\n",
drive
);

508 
	`´štk
("xd_dtc_š™_drive:ƒ¼Ü„—dšg geom‘ry fÜ driv%d\n",
drive
);

509 
	}
}

511 
	$xd_wd_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
)

513 (
u_lÚg
è
add»ss
) {

514 0xC8000: 
xd_ioba£
 = 0x320; ;

515 0xCA000: 
xd_ioba£
 = 0x324; ;

516 0xCC000: 
xd_ioba£
 = 0x328; ;

517 0xCE000: 
xd_ioba£
 = 0x32C; ;

518 0xD0000: 
xd_ioba£
 = 0x328; ;

519 0xD8000: 
xd_ioba£
 = 0x32C; ;

520 : 
	`´štk
("xd_wd_š™_cÚŒŞËr: unsuµÜ‹d BIOS‡dd»s %p\n",
add»ss
);

521 
xd_ioba£
 = 0x320; ;

523 
xd_œq
 = 5;

524 
xd_dma
 = 3;

525 
xd_max£ùÜs
 = 0x01;

528 
	}
}

530 
	$xd_wd_š™_drive
 (
u_ch¬
 
drive
)

532 
u_ch¬
 
cmdblk
[6],
buf
[0x200];

534 
	`xd_bud
(
cmdblk
,
CMD_READ
,
drive
,0,0,0,1,0);

535 ià(!
	`xd_commªd
(
cmdblk
,
PIO_MODE
,
buf
,0,0,
XD_TIMEOUT
 * 2)) {

536 
xd_šfo
[
drive
].
h—ds
 = 
buf
[0x1AF];

537 
xd_šfo
[
drive
].
cylšd”s
 = ((
u_shÜt
 *è(
buf
 + 1))[0xD6];

538 
xd_šfo
[
drive
].
£ùÜs
 = 17;

540 
xd_šfo
[
drive
].
rwr™e
 = ((
u_shÜt
 *è(
buf
))[0xD8];

541 
xd_šfo
[
drive
].
w´ecomp
 = ((
u_shÜt
 *è(
buf
))[0xDA];

542 
xd_šfo
[
drive
].
ecc
 = 
buf
[0x1B4];

544 
xd_šfo
[
drive
].
cÚŒŞ
 = 
buf
[0x1B5];

546 
	`xd_£¬am
(
CMD_WDSETPARAM
,
drive
,
xd_šfo
[drive].
h—ds
,xd_šfo[drive].
cylšd”s
,((
u_shÜt
 *è(
buf
))[0xD8],((u_short *) (buf))[0xDA],buf[0x1B4]);

549 
	`´štk
("xd_wd_š™_drive:ƒ¼Ü„—dšg geom‘ry fÜ driv%d\n",
drive
);

550 
	}
}

552 
	$xd_£ag©e_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
)

554 (
u_lÚg
è
add»ss
) {

555 0xC8000: 
xd_ioba£
 = 0x320; ;

556 0xD0000: 
xd_ioba£
 = 0x324; ;

557 0xD8000: 
xd_ioba£
 = 0x328; ;

558 0xE0000: 
xd_ioba£
 = 0x32C; ;

559 : 
	`´štk
("xd_£ag©e_š™_cÚŒŞËr: unsuµÜ‹d BIOS‡dd»s %p\n",
add»ss
);

560 
xd_ioba£
 = 0x320; ;

562 
xd_œq
 = 5;

563 
xd_dma
 = 3;

564 
xd_max£ùÜs
 = 0x40;

566 
	`outb
(0,
XD_RESET
);

567 
	}
}

569 
	$xd_£ag©e_š™_drive
 (
u_ch¬
 
drive
)

571 
u_ch¬
 
cmdblk
[6],
buf
[0x200];

573 
	`xd_bud
(
cmdblk
,
CMD_ST11GETGEOM
,
drive
,0,0,0,1,0);

574 ià(!
	`xd_commªd
(
cmdblk
,
PIO_MODE
,
buf
,0,0,
XD_TIMEOUT
 * 2)) {

575 
xd_šfo
[
drive
].
h—ds
 = 
buf
[0x04];

576 
xd_šfo
[
drive
].
cylšd”s
 = (
buf
[0x02] << 8) | buf[0x03];

577 
xd_šfo
[
drive
].
£ùÜs
 = 
buf
[0x05];

578 
xd_šfo
[
drive
].
cÚŒŞ
 = 0;

581 
	`´štk
("xd_£ag©e_š™_drive:ƒ¼Ü„—dšg geom‘ry from driv%d\n",
drive
);

582 
	}
}

585 
	$xd_omti_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
)

587 (
u_lÚg
è
add»ss
) {

588 0xC8000: 
xd_ioba£
 = 0x320; ;

589 0xD0000: 
xd_ioba£
 = 0x324; ;

590 0xD8000: 
xd_ioba£
 = 0x328; ;

591 0xE0000: 
xd_ioba£
 = 0x32C; ;

592 : 
	`´štk
("xd_omti_š™_cÚŒŞËr: unsuµÜ‹d BIOS‡dd»s %p\n",
add»ss
);

593 
xd_ioba£
 = 0x320; ;

596 
xd_œq
 = 5;

597 
xd_dma
 = 3;

598 
xd_max£ùÜs
 = 0x40;

600 
	`outb
(0,
XD_RESET
);

601 
	}
}

603 
	$xd_omti_š™_drive
 (
u_ch¬
 
drive
)

606 
	`xd_ov”ride_š™_drive
(
drive
);

609 
xd_šfo
[
drive
].
cÚŒŞ
 = 2;

610 
	}
}

614 
	$xd_ov”ride_š™_drive
 (
u_ch¬
 
drive
)

616 
u_shÜt
 
mš
[] = { 0,0,0 },
max
[] = { 16,1024,64 },
‹¡
[] = { 0,0,0 };

617 
u_ch¬
 
cmdblk
[6],
i
;

619 
i
 = 0; i < 3; i++) {

620 
mš
[
i
] !ğ
max
[i] - 1) {

621 
‹¡
[
i
] = (
mš
[i] + 
max
[i]) / 2;

622 
	`xd_bud
(
cmdblk
,
CMD_SEEK
,
drive
,(
u_ch¬
è
‹¡
[0],(
u_shÜt
)est[1],(u_char)est[2],0,0);

623 ià(!
	`xd_commªd
(
cmdblk
,
PIO_MODE
,0,0,0,
XD_TIMEOUT
 * 2))

624 
mš
[
i
] = 
‹¡
[i];

626 
max
[
i
] = 
‹¡
[i];

628 
‹¡
[
i
] = 
mš
[i];

630 
xd_šfo
[
drive
].
h—ds
 = (
u_ch¬
è
mš
[0] + 1;

631 
xd_šfo
[
drive
].
cylšd”s
 = (
u_shÜt
è
mš
[1] + 1;

632 
xd_šfo
[
drive
].
£ùÜs
 = (
u_ch¬
è
mš
[2] + 1;

633 
xd_šfo
[
drive
].
cÚŒŞ
 = 0;

634 
	}
}

637 
	$xd_£tup
 (*
commªd
,*
š‹g”s
)

639 
xd_ov”ride
 = 1;

641 
xd_ty³
 = 
š‹g”s
[1];

642 
xd_œq
 = 
š‹g”s
[2];

643 
xd_ioba£
 = 
š‹g”s
[3];

644 
xd_dma
 = 
š‹g”s
[4];

646 
xd_max£ùÜs
 = 0x01;

647 
	}
}

650 
	$xd_£¬am
 (
u_ch¬
 
commªd
,u_ch¬ 
drive
,u_ch¬ 
h—ds
,
u_shÜt
 
cylšd”s
,u_shÜˆ
rwr™e
,u_shÜˆ
w´ecomp
,u_ch¬ 
ecc
)

652 
u_ch¬
 
cmdblk
[14];

654 
	`xd_bud
(
cmdblk
,
commªd
,
drive
,0,0,0,0,0);

655 
cmdblk
[6] = (
u_ch¬
è(
cylšd”s
 >> 8) & 0x03;

656 
cmdblk
[7] = (
u_ch¬
è(
cylšd”s
 & 0xFF);

657 
cmdblk
[8] = 
h—ds
 & 0x1F;

658 
cmdblk
[9] = (
u_ch¬
è(
rwr™e
 >> 8) & 0x03;

659 
cmdblk
[10] = (
u_ch¬
è(
rwr™e
 & 0xFF);

660 
cmdblk
[11] = (
u_ch¬
è(
w´ecomp
 >> 8) & 0x03;

661 
cmdblk
[12] = (
u_ch¬
è(
w´ecomp
 & 0xFF);

662 
cmdblk
[13] = 
ecc
;

664 ià(
	`xd_commªd
(
cmdblk
,
PIO_MODE
,0,0,0,
XD_TIMEOUT
 * 2))

665 
	`´štk
("xd_£¬am:ƒ¼Ü s‘tšg ch¬aù”i¡ic fÜ driv%d\n",
drive
);

666 
	}
}

	@drivers/char/atixlmouse.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/sigÇl.h
>

15 
	~<lšux/”ºo.h
>

17 
	~<asm/io.h
>

18 
	~<asm/£gm’t.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/œq.h
>

22 
	#ATIXL_MOUSE_IRQ
 5

	)

23 
	#ATIXL_BUSMOUSE
 3

	)

27 
	#ATIXL_MSE_DATA_PORT
 0x23d

	)

28 
	#ATIXL_MSE_SIGNATURE_PORT
 0x23e

	)

29 
	#ATIXL_MSE_CONTROL_PORT
 0x23c

	)

31 
	#ATIXL_MSE_READ_BUTTONS
 0x00

	)

32 
	#ATIXL_MSE_READ_X
 0x01

	)

33 
	#ATIXL_MSE_READ_Y
 0x02

	)

38 
	#ATIXL_MSE_DISABLE_UPDATE
(è{ 
	`outb
Ğ0x07, 
ATIXL_MSE_CONTROL_PORT
 ); \

39 
	`outb
Ğ(0x20 | 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
 )), ATIXL_MSE_DATA_PORT ); }

	)

42 
	#ATIXL_MSE_ENABLE_UPDATE
(è{ 
	`outb
Ğ0x07, 
ATIXL_MSE_CONTROL_PORT
 ); \

43 
	`outb
Ğ(0xdà& 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
 )), ATIXL_MSE_DATA_PORT ); }

	)

46 
	#ATIXL_MSE_INT_OFF
(è{ 
	`outb
Ğ0x07, 
ATIXL_MSE_CONTROL_PORT
 ); \

47 
	`outb
Ğ(0xe7 & 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
 )), ATIXL_MSE_DATA_PORT ); }

	)

50 
	#ATIXL_MSE_INT_ON
(è{ 
	`outb
Ğ0x07, 
ATIXL_MSE_CONTROL_PORT
 ); \

51 
	`outb
Ğ(0x08 | 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
 )), ATIXL_MSE_DATA_PORT ); }

	)

55 
	smou£_¡©us
 {

56 
	mbu‰Ús
;

57 
	mÏtch_bu‰Ús
;

58 
	mdx
;

59 
	mdy
;

60 
	m´e£Á
;

61 
	m»ady
;

62 
	maùive
;

63 
wa™_queue
 *
	mwa™
;

64 } 
	gmou£
;

66 
	$mou£_š‹¼u±
(
unu£d
)

68 
dx
, 
dy
, 
bu‰Ús
;

70 
	`ATIXL_MSE_DISABLE_UPDATE
();

71 
	`outb
(
ATIXL_MSE_READ_X
, 
ATIXL_MSE_CONTROL_PORT
);

72 
dx
 = 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
);

73 
	`outb
(
ATIXL_MSE_READ_Y
, 
ATIXL_MSE_CONTROL_PORT
);

74 
dy
 = 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
);

75 
	`outb
(
ATIXL_MSE_READ_BUTTONS
, 
ATIXL_MSE_CONTROL_PORT
);

76 
bu‰Ús
 = 
	`šb
Ğ
ATIXL_MSE_DATA_PORT
);

77 ià(
dx
 !ğ0 || 
dy
 !ğ0 || 
bu‰Ús
 !ğ
mou£
.
Ïtch_bu‰Ús
) {

78 
mou£
.
Ïtch_bu‰Ús
 |ğ
bu‰Ús
;

79 
mou£
.
dx
 += dx;

80 
mou£
.
dy
 += dy;

81 
mou£
.
»ady
 = 1;

82 
	`wake_up_š‹¼u±ibË
(&
mou£
.
wa™
);

84 
	`ATIXL_MSE_ENABLE_UPDATE
();

85 
	}
}

87 
	$»Ëa£_mou£
(
šode
 * inode, 
fe
 * file)

89 
	`ATIXL_MSE_INT_OFF
();

90 
mou£
.
aùive
 = 0;

91 
mou£
.
»ady
 = 0;

92 
	`ä“_œq
(
ATIXL_MOUSE_IRQ
);

93 
	}
}

96 
	$İ’_mou£
(
šode
 * inode, 
fe
 * file)

98 ià(!
mou£
.
´e£Á
)

99  -
EINVAL
;

100 ià(
mou£
.
aùive
)

101  -
EBUSY
;

102 
mou£
.
aùive
 = 1;

103 
mou£
.
»ady
 = 0;

104 
mou£
.
dx
 = 0;

105 
mou£
.
dy
 = 0;

106 
mou£
.
bu‰Ús
 = mou£.
Ïtch_bu‰Ús
 = 0;

107 ià(
	`»que¡_œq
(
ATIXL_MOUSE_IRQ
, 
mou£_š‹¼u±
)) {

108 
mou£
.
aùive
 = 0;

109  -
EBUSY
;

111 
	`ATIXL_MSE_INT_ON
();

113 
	}
}

116 
	$wr™e_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

118  -
EINVAL
;

119 
	}
}

121 
	$»ad_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

123 
i
;

125 ià(
couÁ
 < 3)

126  -
EINVAL
;

127 ià(!
mou£
.
»ady
)

128  -
EAGAIN
;

129 
	`ATIXL_MSE_DISABLE_UPDATE
();

131 
	`put_fs_by‹
(()(~
mou£
.
Ïtch_bu‰Ús
&7è| 0x80 , 
bufãr
);

132 ià(
mou£
.
dx
 < -127)

133 
mou£
.
dx
 = -127;

134 ià(
mou£
.
dx
 > 127)

135 
mou£
.
dx
 = 127;

136 
	`put_fs_by‹
(()
mou£
.
dx
, 
bufãr
 + 1);

137 ià(
mou£
.
dy
 < -127)

138 
mou£
.
dy
 = -127;

139 ià(
mou£
.
dy
 > 127)

140 
mou£
.
dy
 = 127;

141 
	`put_fs_by‹
(()-
mou£
.
dy
, 
bufãr
 + 2);

142 
i
 = 3; i < 
couÁ
; i++)

143 
	`put_fs_by‹
(0x00, 
bufãr
 + 
i
);

144 
mou£
.
dx
 = 0;

145 
mou£
.
dy
 = 0;

146 
mou£
.
Ïtch_bu‰Ús
 = mou£.
bu‰Ús
;

147 
mou£
.
»ady
 = 0;

148 
	`ATIXL_MSE_ENABLE_UPDATE
();

149  
i
;

150 
	}
}

152 
	$mou£_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

154 ià(
£l_ty³
 !ğ
SEL_IN
)

156 ià(
mou£
.
»ady
)

158 
	`£Ëù_wa™
(&
mou£
.
wa™
,wait);

160 
	}
}

162 
fe_İ”©iÚs
 
	g©ixl_busmou£_fİs
 = {

163 
NULL
,

164 
»ad_mou£
,

165 
wr™e_mou£
,

166 
NULL
,

167 
mou£_£Ëù
,

168 
NULL
,

169 
NULL
,

170 
İ’_mou£
,

171 
»Ëa£_mou£
,

174 
	$©ixl_busmou£_š™
(
kmem_¡¬t
)

176 
a
,
b
,
c
;

178 
a
 = 
	`šb
Ğ
ATIXL_MSE_SIGNATURE_PORT
 );

179 
b
 = 
	`šb
Ğ
ATIXL_MSE_SIGNATURE_PORT
 );

180 
c
 = 
	`šb
Ğ
ATIXL_MSE_SIGNATURE_PORT
 );

181 ià(Ğ
a
 !ğ
b
 ) && (‡ =ğ
c
 ))

182 
	`´štk
("\nATI Inport ");

184 
mou£
.
´e£Á
 = 0;

185  
kmem_¡¬t
;

187 
	`outb
(0x80, 
ATIXL_MSE_CONTROL_PORT
);

188 
	`outb
(0x07, 
ATIXL_MSE_CONTROL_PORT
);

189 
	`outb
(0x0a, 
ATIXL_MSE_DATA_PORT
);

190 
mou£
.
´e£Á
 = 1;

191 
mou£
.
aùive
 = 0;

192 
mou£
.
»ady
 = 0;

193 
mou£
.
bu‰Ús
 = mou£.
Ïtch_bu‰Ús
 = 0;

194 
mou£
.
dx
 = mou£.
dy
 = 0;

195 
mou£
.
wa™
 = 
NULL
;

196 
	`´štk
("Bus mouse detected‡nd installed.\n");

197  
kmem_¡¬t
;

198 
	}
}

	@drivers/char/busmouse.c

26 
	~<lšux/k”Ãl.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/busmou£.h
>

29 
	~<lšux/sigÇl.h
>

30 
	~<lšux/”ºo.h
>

32 
	~<asm/io.h
>

33 
	~<asm/£gm’t.h
>

34 
	~<asm/sy¡em.h
>

35 
	~<asm/œq.h
>

37 
mou£_¡©us
 
	gmou£
;

38 
	gmou£_œq
 = 
MOUSE_IRQ
;

40 
	$bmou£_£tup
(*
¡r
, *
šts
)

42 ià(
šts
[0] > 0)

43 
mou£_œq
=
šts
[1];

44 
	}
}

46 
	$mou£_š‹¼u±
(
unu£d
)

48 
dx
, 
dy
;

49 
bu‰Ús
;

51 
	`MSE_INT_OFF
();

52 
	`outb
(
MSE_READ_X_LOW
, 
MSE_CONTROL_PORT
);

53 
dx
 = (
	`šb
(
MSE_DATA_PORT
) & 0xf);

54 
	`outb
(
MSE_READ_X_HIGH
, 
MSE_CONTROL_PORT
);

55 
dx
 |ğ(
	`šb
(
MSE_DATA_PORT
) & 0xf) << 4;

56 
	`outb
(
MSE_READ_Y_LOW
, 
MSE_CONTROL_PORT
 );

57 
dy
 = (
	`šb
(
MSE_DATA_PORT
) & 0xf);

58 
	`outb
(
MSE_READ_Y_HIGH
, 
MSE_CONTROL_PORT
);

59 
bu‰Ús
 = 
	`šb
(
MSE_DATA_PORT
);

60 
dy
 |ğ(
bu‰Ús
 & 0xf) << 4;

61 
bu‰Ús
 = ((buttons >> 5) & 0x07);

62 ià(
dx
 !ğ0 || 
dy
 !ğ0 || 
bu‰Ús
 !ğ
mou£
.buttons) {

63 
mou£
.
bu‰Ús
 = buttons;

64 
mou£
.
dx
 += dx;

65 
mou£
.
dy
 -= dy;

66 
mou£
.
»ady
 = 1;

67 
	`wake_up_š‹¼u±ibË
(&
mou£
.
wa™
);

74 ià(
mou£
.
dx
 < -2048)

75 
mou£
.
dx
 = -2048;

76 ià(
mou£
.
dx
 > 2048)

77 
mou£
.
dx
 = 2048;

79 ià(
mou£
.
dy
 < -2048)

80 
mou£
.
dy
 = -2048;

81 ià(
mou£
.
dy
 > 2048)

82 
mou£
.
dy
 = 2048;

84 
	`MSE_INT_ON
();

85 
	}
}

92 
	$şo£_mou£
(
šode
 * inode, 
fe
 * file)

94 ià(--
mou£
.
aùive
 == 0) {

95 
	`MSE_INT_OFF
();

96 
	`ä“_œq
(
mou£_œq
);

98 
	}
}

105 
	$İ’_mou£
(
šode
 * inode, 
fe
 * file)

107 ià(!
mou£
.
´e£Á
)

108  -
EINVAL
;

109 ià(
mou£
.
aùive
)

110  -
EBUSY
;

111 
mou£
.
»ady
 = 0;

112 
mou£
.
dx
 = 0;

113 
mou£
.
dy
 = 0;

114 
mou£
.
bu‰Ús
 = 0x87;

115 ià(
	`»que¡_œq
(
mou£_œq
, 
mou£_š‹¼u±
))

116  -
EBUSY
;

117 
mou£
.
aùive
 = 1;

118 
	`MSE_INT_ON
();

120 
	}
}

126 
	$wr™e_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

128  -
EINVAL
;

129 
	}
}

135 
	$»ad_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

137 
r
;

138 
dx
;

139 
dy
;

140 
bu‰Ús
;

142 ià(
couÁ
 < 3)

143  -
EINVAL
;

144 ià((
r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
bufãr
, 
couÁ
)))

145  
r
;

146 ià(!
mou£
.
»ady
)

147  -
EAGAIN
;

156 
	`MSE_INT_OFF
();

157 
dx
 = 
mou£
.dx;

158 
dy
 = 
mou£
.dy;

159 ià(
dx
 < -127)

160 
dx
 = -127;

161 ià(
dx
 > 127)

162 
dx
 = 127;

163 ià(
dy
 < -127)

164 
dy
 = -127;

165 ià(
dy
 > 127)

166 
dy
 = 127;

167 
bu‰Ús
 = 
mou£
.buttons;

168 
mou£
.
dx
 -= dx;

169 
mou£
.
dy
 -= dy;

170 
mou£
.
»ady
 = 0;

171 
	`MSE_INT_ON
();

173 
	`put_fs_by‹
(
bu‰Ús
 | 0x80, 
bufãr
);

174 
	`put_fs_by‹
(()
dx
, 
bufãr
 + 1);

175 
	`put_fs_by‹
(()
dy
, 
bufãr
 + 2);

176 
r
 = 3;„ < 
couÁ
;„++)

177 
	`put_fs_by‹
(0x00, 
bufãr
 + 
r
);

178  
r
;

179 
	}
}

188 
	$mou£_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

190 
r
 = 0;

192 ià(
£l_ty³
 =ğ
SEL_IN
) {

193 
	`MSE_INT_OFF
();

194 ià(
mou£
.
»ady
) {

195 
r
 = 1;

197 
	`£Ëù_wa™
(&
mou£
.
wa™
, wait);

199 
	`MSE_INT_ON
();

201 (
r
);

202 
	}
}

204 
fe_İ”©iÚs
 
	gbus_mou£_fİs
 = {

205 
NULL
,

206 
»ad_mou£
,

207 
wr™e_mou£
,

208 
NULL
,

209 
mou£_£Ëù
,

210 
NULL
,

211 
NULL
,

212 
İ’_mou£
,

213 
şo£_mou£
,

216 
	$bus_mou£_š™
(
kmem_¡¬t
)

218 
i
;

220 
	`outb
(
MSE_CONFIG_BYTE
, 
MSE_CONFIG_PORT
);

221 
	`outb
(
MSE_SIGNATURE_BYTE
, 
MSE_SIGNATURE_PORT
);

222 
i
 = 0; i < 100000; i++)

224 ià(
	`šb
(
MSE_SIGNATURE_PORT
è!ğ
MSE_SIGNATURE_BYTE
) {

225 
mou£
.
´e£Á
 = 0;

226  
kmem_¡¬t
;

228 
	`outb
(
MSE_DEFAULT_MODE
, 
MSE_CONFIG_PORT
);

229 
	`MSE_INT_OFF
();

230 
mou£
.
´e£Á
 = 1;

231 
mou£
.
aùive
 = 0;

232 
mou£
.
»ady
 = 0;

233 
mou£
.
bu‰Ús
 = 0x87;

234 
mou£
.
dx
 = 0;

235 
mou£
.
dy
 = 0;

236 
mou£
.
wa™
 = 
NULL
;

237 
	`´štk
("Logitech Bus mouse detected‡nd installed.\n");

238  
kmem_¡¬t
;

239 
	}
}

	@drivers/char/console.c

40 
	#CAN_LOAD_EGA_FONTS


	)

49 
	~<lšux/sched.h
>

50 
	~<lšux/tim”.h
>

51 
	~<lšux/‰y.h
>

52 
	~<lšux/cÚfig.h
>

53 
	~<lšux/k”Ãl.h
>

54 
	~<lšux/¡ršg.h
>

55 
	~<lšux/”ºo.h
>

56 
	~<lšux/kd.h
>

58 
	~<asm/io.h
>

59 
	~<asm/sy¡em.h
>

60 
	~<asm/£gm’t.h
>

62 
	~"kbd_k”n.h
"

63 
	~"vt_k”n.h
"

65 #ifdeà
CONFIG_SELECTION


66 
	~<lšux/ùy³.h
>

69 
£t_£ËùiÚ
(cÚ¡ 
¬g
);

70 
·¡e_£ËùiÚ
(
‰y_¡ruù
 *
‰y
);

71 
ş—r_£ËùiÚ
();

74 
	#SEL_BUFFER_SIZE
 
TTY_BUF_SIZE


	)

75 
	g£l_cÚs
;

76 
	g£l_¡¬t
 = -1;

77 
	g£l_’d
;

78 
	g£l_bufãr
[
SEL_BUFFER_SIZE
] = { '\0' };

81 
	#NPAR
 16

	)

83 
vt_š™
();

84 
»gi¡”_cÚsŞe
((*
´oc
)(const *));

85 
	`compu‹_shiá¡©e
();

87 
video_num_cŞumns
;

88 
video_num_lšes
;

90 
video_ty³
;

91 
video_mem_ba£
;

92 
video_mem_‹rm
;

93 
video_size_row
;

94 
video_·ge
;

95 
video_pÜt_»g
;

96 
video_pÜt_v®
;

97 
ÿn_do_cŞÜ
 = 0;

98 
´šbË
 = 0;

101 
vc_video_”a£_ch¬
;

102 
vc_©Œ
;

103 
vc_def_cŞÜ
;

104 
vc_cŞÜ
;

105 
vc_s_cŞÜ
;

106 
vc_ulcŞÜ
;

107 
vc_h®fcŞÜ
;

108 
vc_Üigš
;

109 
vc_sü_’d
;

110 
vc_pos
;

111 
vc_x
,
vc_y
;

112 
vc_tİ
,
vc_bÙtom
;

113 
vc_¡©e
;

114 
vc_Å¬
,
vc_·r
[
NPAR
];

115 
vc_video_mem_¡¬t
;

116 
vc_video_mem_’d
;

117 
vc_§ved_x
;

118 
vc_§ved_y
;

120 
vc_ch¬£t
 : 1;

121 
vc_s_ch¬£t
 : 1;

122 
vc_decsúm
 : 1;

123 
vc_decom
 : 1;

124 
vc_deÿwm
 : 1;

125 
vc_deccm
 : 1;

126 
vc_decim
 : 1;

128 
vc_š‹ns™y
 : 2;

129 
vc_und”lše
 : 1;

130 
vc_blšk
 : 1;

131 
vc_»v”£
 : 1;

132 
vc_s_š‹ns™y
 : 2;

133 
vc_s_und”lše
 : 1;

134 
vc_s_blšk
 : 1;

135 
vc_s_»v”£
 : 1;

137 
vc_ques
 : 1;

138 
vc_Ãed_w¿p
 : 1;

139 
vc_b_¡İ
[5];

140 * 
vc_Œª¦©e
;

141 * 
vc_G0_ch¬£t
;

142 * 
vc_G1_ch¬£t
;

143 * 
vc_§ved_G0
;

144 * 
vc_§ved_G1
;

146 } 
vc_cÚs
 [
NR_CONSOLES
];

148 *
vc_sübuf
[
NR_CONSOLES
];

149 * 
vc_sümembuf
;

150 
cÚsŞe_bÏnked
 = 0;

152 
	#Üigš
 (
vc_cÚs
[
cu¼cÚs
].
vc_Üigš
)

	)

153 
	#sü_’d
 (
vc_cÚs
[
cu¼cÚs
].
vc_sü_’d
)

	)

154 
	#pos
 (
vc_cÚs
[
cu¼cÚs
].
vc_pos
)

	)

155 
	#tİ
 (
vc_cÚs
[
cu¼cÚs
].
vc_tİ
)

	)

156 
	#bÙtom
 (
vc_cÚs
[
cu¼cÚs
].
vc_bÙtom
)

	)

157 
	#x
 (
vc_cÚs
[
cu¼cÚs
].
vc_x
)

	)

158 
	#y
 (
vc_cÚs
[
cu¼cÚs
].
vc_y
)

	)

159 
	#¡©e
 (
vc_cÚs
[
cu¼cÚs
].
vc_¡©e
)

	)

160 
	#Å¬
 (
vc_cÚs
[
cu¼cÚs
].
vc_Å¬
)

	)

161 
	#·r
 (
vc_cÚs
[
cu¼cÚs
].
vc_·r
)

	)

162 
	#ques
 (
vc_cÚs
[
cu¼cÚs
].
vc_ques
)

	)

163 
	#©Œ
 (
vc_cÚs
[
cu¼cÚs
].
vc_©Œ
)

	)

164 
	#§ved_x
 (
vc_cÚs
[
cu¼cÚs
].
vc_§ved_x
)

	)

165 
	#§ved_y
 (
vc_cÚs
[
cu¼cÚs
].
vc_§ved_y
)

	)

166 
	#Œª¦©e
 (
vc_cÚs
[
cu¼cÚs
].
vc_Œª¦©e
)

	)

167 
	#G0_ch¬£t
 (
vc_cÚs
[
cu¼cÚs
].
vc_G0_ch¬£t
)

	)

168 
	#G1_ch¬£t
 (
vc_cÚs
[
cu¼cÚs
].
vc_G1_ch¬£t
)

	)

169 
	#§ved_G0
 (
vc_cÚs
[
cu¼cÚs
].
vc_§ved_G0
)

	)

170 
	#§ved_G1
 (
vc_cÚs
[
cu¼cÚs
].
vc_§ved_G1
)

	)

171 
	#video_mem_¡¬t
 (
vc_cÚs
[
cu¼cÚs
].
vc_video_mem_¡¬t
)

	)

172 
	#video_mem_’d
 (
vc_cÚs
[
cu¼cÚs
].
vc_video_mem_’d
)

	)

173 
	#video_”a£_ch¬
 (
vc_cÚs
[
cu¼cÚs
].
vc_video_”a£_ch¬
)

	)

174 
	#decsúm
 (
vc_cÚs
[
cu¼cÚs
].
vc_decsúm
)

	)

175 
	#decom
 (
vc_cÚs
[
cu¼cÚs
].
vc_decom
)

	)

176 
	#deÿwm
 (
vc_cÚs
[
cu¼cÚs
].
vc_deÿwm
)

	)

177 
	#deccm
 (
vc_cÚs
[
cu¼cÚs
].
vc_deccm
)

	)

178 
	#decim
 (
vc_cÚs
[
cu¼cÚs
].
vc_decim
)

	)

179 
	#Ãed_w¿p
 (
vc_cÚs
[
cu¼cÚs
].
vc_Ãed_w¿p
)

	)

180 
	#cŞÜ
 (
vc_cÚs
[
cu¼cÚs
].
vc_cŞÜ
)

	)

181 
	#s_cŞÜ
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_cŞÜ
)

	)

182 
	#def_cŞÜ
 (
vc_cÚs
[
cu¼cÚs
].
vc_def_cŞÜ
)

	)

183 
	#fÜeground
 (
cŞÜ
 & 0x0f)

	)

184 
	#background
 (
cŞÜ
 & 0xf0)

	)

185 
	#ch¬£t
 (
vc_cÚs
[
cu¼cÚs
].
vc_ch¬£t
)

	)

186 
	#s_ch¬£t
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_ch¬£t
)

	)

187 
	#š‹ns™y
 (
vc_cÚs
[
cu¼cÚs
].
vc_š‹ns™y
)

	)

188 
	#und”lše
 (
vc_cÚs
[
cu¼cÚs
].
vc_und”lše
)

	)

189 
	#blšk
 (
vc_cÚs
[
cu¼cÚs
].
vc_blšk
)

	)

190 
	#»v”£
 (
vc_cÚs
[
cu¼cÚs
].
vc_»v”£
)

	)

191 
	#s_š‹ns™y
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_š‹ns™y
)

	)

192 
	#s_und”lše
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_und”lše
)

	)

193 
	#s_blšk
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_blšk
)

	)

194 
	#s_»v”£
 (
vc_cÚs
[
cu¼cÚs
].
vc_s_»v”£
)

	)

195 
	#ulcŞÜ
 (
vc_cÚs
[
cu¼cÚs
].
vc_ulcŞÜ
)

	)

196 
	#h®fcŞÜ
 (
vc_cÚs
[
cu¼cÚs
].
vc_h®fcŞÜ
)

	)

197 
	#b_¡İ
 (
vc_cÚs
[
cu¼cÚs
].
vc_b_¡İ
)

	)

198 
	#vcmode
 (
vt_cÚs
[
cu¼cÚs
].
vc_mode
)

	)

199 
	#vtmode
 (
vt_cÚs
[
cu¼cÚs
].
vt_mode
)

	)

200 
	#vid
 (
vt_cÚs
[
cu¼cÚs
].
vt_pid
)

	)

201 
	#vŠewvt
 (
vt_cÚs
[
cu¼cÚs
].
vt_Ãwvt
)

	)

203 
	#£t_kbd
(
x
è
	`£t_vc_kbd_mode
(
kbd_bË
+
cu¼cÚs
,x)

	)

204 
	#şr_kbd
(
x
è
	`şr_vc_kbd_mode
(
kbd_bË
+
cu¼cÚs
,x)

	)

205 
	#is_kbd
(
x
è
	`vc_kbd_mode
(
kbd_bË
+
cu¼cÚs
,x)

	)

207 
	#deÿrm
 
VC_REPEAT


	)

208 
	#decckm
 
VC_CKMODE


	)

209 
	#kbd­¶ic
 
VC_APPLIC


	)

210 
	#kbd¿w
 
VC_RAW


	)

211 
	#Êm
 
VC_CRLF


	)

213 
bÏnkš‹rv®
 = 10*60*
HZ
;

214 
sü“n_size
 = 0;

219 
	#VT100ID
 "\033[?1;2c"

	)

220 
	#VT102ID
 "\033[?6c"

	)

222 * 
Œª¦©iÚs
[] = {

290 
	}
};

292 
	#NORM_TRANS
 (
Œª¦©iÚs
[0])

	)

293 
	#GRAF_TRANS
 (
Œª¦©iÚs
[1])

	)

294 
	#NULL_TRANS
 (
Œª¦©iÚs
[2])

	)

295 
	#USER_TRANS
 (
Œª¦©iÚs
[3])

	)

297 
	gcŞÜ_bË
[] = { 0, 4, 2, 6, 1, 5, 3, 7,

305 
	$gÙoxy
(
cu¼cÚs
, 
Ãw_x
, 
Ãw_y
)

307 
max_y
;

309 ià(
Ãw_x
 < 0)

310 
x
 = 0;

312 ià(
Ãw_x
 >ğ
video_num_cŞumns
)

313 
x
 = 
video_num_cŞumns
 - 1;

315 
x
 = 
Ãw_x
;

316 ià(
decom
) {

317 
Ãw_y
 +ğ
tİ
;

318 
max_y
 = 
bÙtom
;

320 
max_y
 = 
video_num_lšes
;

321 ià(
Ãw_y
 < 0)

322 
y
 = 0;

324 ià(
Ãw_y
 >ğ
max_y
)

325 
y
 = 
max_y
 - 1;

327 
y
 = 
Ãw_y
;

328 
pos
 = 
Üigš
 + 
y
*
video_size_row
 + (
x
<<1);

329 
Ãed_w¿p
 = 0;

330 
	}
}

335 
	g__»®_Üigš
;

336 
	g__Üigš
;

338 
šlše
 
	$__£t_Üigš
(
off£t
)

340 
æags
;

341 #ifdeà
CONFIG_SELECTION


342 
	`ş—r_£ËùiÚ
();

344 
	`§ve_æags
(
æags
); 
	`şi
();

345 
__Üigš
 = 
off£t
;

346 
	`outb_p
(12, 
video_pÜt_»g
);

347 
	`outb_p
(
off£t
 >> 8, 
video_pÜt_v®
);

348 
	`outb_p
(13, 
video_pÜt_»g
);

349 
	`outb_p
(
off£t
, 
video_pÜt_v®
);

350 
	`»¡Üe_æags
(
æags
);

351 
	}
}

353 
	$süŞlback
(
lšes
)

355 ià(!
lšes
)

356 
lšes
 = 
video_num_lšes
/2;

357 
lšes
 *ğ
video_num_cŞumns
;

358 
lšes
 = 
__Üigš
 -†ines;

359 ià(
lšes
 < 0)

360 
lšes
 = 0;

361 
	`__£t_Üigš
(
lšes
);

362 
	}
}

364 
	$süŞläÚt
(
lšes
)

366 ià(!
lšes
)

367 
lšes
 = 
video_num_lšes
/2;

368 
lšes
 *ğ
video_num_cŞumns
;

369 
lšes
 = 
__Üigš
 +†ines;

370 ià(
lšes
 > 
__»®_Üigš
)

371 
lšes
 = 
__»®_Üigš
;

372 
	`__£t_Üigš
(
lšes
);

373 
	}
}

375 
	$£t_Üigš
(
cu¼cÚs
)

377 ià(
video_ty³
 !ğ
VIDEO_TYPE_EGAC
 && video_ty³ !ğ
VIDEO_TYPE_EGAM
)

379 ià(
cu¼cÚs
 !ğ
fg_cÚsŞe
 || 
cÚsŞe_bÏnked
 || 
vcmode
 =ğ
KD_GRAPHICS
)

381 
__»®_Üigš
 = (
Üigš
-
video_mem_ba£
) >> 1;

382 
	`__£t_Üigš
(
__»®_Üigš
);

383 
	}
}

388 
šlše
 
	$hide_cursÜ
()

393 
	`outb_p
(14, 
video_pÜt_»g
);

394 
	`outb_p
(0xff&((
video_mem_‹rm
-
video_mem_ba£
)>>9), 
video_pÜt_v®
);

395 
	`outb_p
(15, 
video_pÜt_»g
);

396 
	`outb_p
(0xff&((
video_mem_‹rm
-
video_mem_ba£
)>>1), 
video_pÜt_v®
);

397 
	}
}

399 
šlše
 
	$£t_cursÜ
(
cu¼cÚs
)

401 
æags
;

403 ià(
cu¼cÚs
 !ğ
fg_cÚsŞe
 || 
cÚsŞe_bÏnked
 || 
vcmode
 =ğ
KD_GRAPHICS
)

405 ià(
__»®_Üigš
 !ğ
__Üigš
)

406 
	`£t_Üigš
(
__»®_Üigš
);

407 
	`§ve_æags
(
æags
); 
	`şi
();

408 ià(
deccm
) {

409 
	`outb_p
(14, 
video_pÜt_»g
);

410 
	`outb_p
(0xff&((
pos
-
video_mem_ba£
)>>9), 
video_pÜt_v®
);

411 
	`outb_p
(15, 
video_pÜt_»g
);

412 
	`outb_p
(0xff&((
pos
-
video_mem_ba£
)>>1), 
video_pÜt_v®
);

414 
	`hide_cursÜ
();

415 
	`»¡Üe_æags
(
æags
);

416 
	}
}

418 
	$süup
(
cu¼cÚs
, 
t
, 
b
)

420 
h¬dsüŞl
 = 1;

422 ià(
b
 > 
video_num_lšes
 || 
t
 >= b)

424 ià(
video_ty³
 !ğ
VIDEO_TYPE_EGAC
 && video_ty³ !ğ
VIDEO_TYPE_EGAM
)

425 
h¬dsüŞl
 = 0;

426 ià(
t
 || 
b
 !ğ
video_num_lšes
)

427 
h¬dsüŞl
 = 0;

428 ià(
h¬dsüŞl
) {

429 
Üigš
 +ğ
video_size_row
;

430 
pos
 +ğ
video_size_row
;

431 
sü_’d
 +ğ
video_size_row
;

432 ià(
sü_’d
 > 
video_mem_’d
) {

433 
	`__asm__
("cld\n\t"

440 :"a" (
video_”a£_ch¬
),

441 "c" ((
video_num_lšes
-1)*
video_num_cŞumns
>>1),

442 "D" (
video_mem_¡¬t
),

443 "S" (
Üigš
)

445 
sü_’d
 -ğ
Üigš
-
video_mem_¡¬t
;

446 
pos
 -ğ
Üigš
-
video_mem_¡¬t
;

447 
Üigš
 = 
video_mem_¡¬t
;

449 
	`__asm__
("cld\n\t"

453 :"a" (
video_”a£_ch¬
),

454 "c" (
video_num_cŞumns
),

455 "D" (
sü_’d
-
video_size_row
)

458 
	`£t_Üigš
(
cu¼cÚs
);

460 
	`__asm__
("cld\n\t"

467 :"a" (
video_”a£_ch¬
),

468 "c" ((
b
-
t
-1)*
video_num_cŞumns
>>1),

469 "D" (
Üigš
+
video_size_row
*
t
),

470 "S" (
Üigš
+
video_size_row
*(
t
+1))

473 
	}
}

475 
	$südown
(
cu¼cÚs
, 
t
, 
b
)

477 ià(
b
 > 
video_num_lšes
 || 
t
 >= b)

479 
	`__asm__
("std\n\t"

488 :"a" (
video_”a£_ch¬
),

489 "c" ((
b
-
t
-1)*
video_num_cŞumns
>>1),

490 "D" (
Üigš
+
video_size_row
*
b
-4),

491 "S" (
Üigš
+
video_size_row
*(
b
-1)-4)

493 
	}
}

495 
	$lf
(
cu¼cÚs
)

497 ià(
y
+1<
bÙtom
) {

498 
y
++;

499 
pos
 +ğ
video_size_row
;

502 
	`süup
(
cu¼cÚs
,
tİ
,
bÙtom
);

503 
Ãed_w¿p
 = 0;

504 
	}
}

506 
	$ri
(
cu¼cÚs
)

508 ià(
y
>
tİ
) {

509 
y
--;

510 
pos
 -ğ
video_size_row
;

513 
	`südown
(
cu¼cÚs
,
tİ
,
bÙtom
);

514 
Ãed_w¿p
 = 0;

515 
	}
}

517 
šlše
 
	$ü
(
cu¼cÚs
)

519 
pos
 -ğ
x
<<1;

520 
Ãed_w¿p
 = 
x
 = 0;

521 
	}
}

523 
šlše
 
	$bs
(
cu¼cÚs
)

525 ià(
x
) {

526 
pos
 -= 2;

527 
x
--;

528 
Ãed_w¿p
 = 0;

530 
	}
}

532 
šlše
 
	$d–
(
cu¼cÚs
)

535 ià(
x
) {

536 ià(!
Ãed_w¿p
) {

537 
pos
 -= 2;

538 
x
--;

540 *(*)
pos
 = 
video_”a£_ch¬
;

541 
Ãed_w¿p
 = 0;

544 
	}
}

546 
	$csi_J
(
cu¼cÚs
, 
v·r
)

548 
couÁ
;

549 
¡¬t
;

551 
v·r
) {

553 
couÁ
 = (
sü_’d
-
pos
)>>1;

554 
¡¬t
 = 
pos
;

557 
couÁ
 = ((
pos
-
Üigš
)>>1)+1;

558 
¡¬t
 = 
Üigš
;

561 
couÁ
 = 
video_num_cŞumns
 * 
video_num_lšes
;

562 
¡¬t
 = 
Üigš
;

567 
	`__asm__
("cld\n\t"

571 :"c" (
couÁ
),

572 "D" (
¡¬t
),"a" (
video_”a£_ch¬
)

574 
Ãed_w¿p
 = 0;

575 
	}
}

577 
	$csi_K
(
cu¼cÚs
, 
v·r
)

579 
couÁ
;

580 
¡¬t
;

582 
v·r
) {

584 
couÁ
 = 
video_num_cŞumns
-
x
;

585 
¡¬t
 = 
pos
;

588 
¡¬t
 = 
pos
 - (
x
<<1);

589 
couÁ
 = 
x
+1;

592 
¡¬t
 = 
pos
 - (
x
<<1);

593 
couÁ
 = 
video_num_cŞumns
;

598 
	`__asm__
("cld\n\t"

602 :"c" (
couÁ
),

603 "D" (
¡¬t
),"a" (
video_”a£_ch¬
)

605 
Ãed_w¿p
 = 0;

606 
	}
}

611 
	$upd©e_©Œ
(
cu¼cÚs
)

613 
©Œ
 = 
cŞÜ
;

614 ià(
ÿn_do_cŞÜ
) {

615 ià(
und”lše
)

616 
©Œ
 = (©Œ & 0xf0è| 
ulcŞÜ
;

617 ià(
š‹ns™y
 == 0)

618 
©Œ
 = (©Œ & 0xf0è| 
h®fcŞÜ
;

620 ià(
»v”£
 ^ 
decsúm
)

621 
©Œ
 = (attr & 0x88) | (((attr >> 4) | (attr << 4)) & 0x77);

622 ià(
blšk
)

623 
©Œ
 ^= 0x80;

624 ià(
š‹ns™y
 == 2)

625 
©Œ
 ^= 0x08;

626 ià(!
ÿn_do_cŞÜ
) {

627 ià(
und”lše
)

628 
©Œ
 = (attr & 0xf8) | 0x01;

629 ià(
š‹ns™y
 == 0)

630 
©Œ
 = (attr & 0xf0) | 0x08;

632 ià(
decsúm
)

633 
video_”a£_ch¬
 = (((
cŞÜ
 & 0x88) | (((color >> 4) | (color << 4)) & 0x77)) << 8) | ' ';

635 
video_”a£_ch¬
 = (
cŞÜ
 << 8) | ' ';

636 
	}
}

638 
	$deçuÉ_©Œ
(
cu¼cÚs
)

640 
š‹ns™y
 = 1;

641 
und”lše
 = 0;

642 
»v”£
 = 0;

643 
blšk
 = 0;

644 
cŞÜ
 = 
def_cŞÜ
;

645 
	}
}

647 
	$csi_m
(
cu¼cÚs
)

649 
i
;

651 
i
=0;i<=
Å¬
;i++)

652 
·r
[
i
]) {

654 
	`deçuÉ_©Œ
(
cu¼cÚs
);

657 
š‹ns™y
 = 2;

660 
š‹ns™y
 = 0;

663 
und”lše
 = 1;

666 
blšk
 = 1;

669 
»v”£
 = 1;

673 
š‹ns™y
 = 1;

676 
und”lše
 = 0;

679 
blšk
 = 0;

682 
»v”£
 = 0;

685 
cŞÜ
 = (
def_cŞÜ
 & 0x0fè| 
background
;

688 
cŞÜ
 = (
def_cŞÜ
 & 0xf0è| 
fÜeground
;

691 ià(
·r
[
i
] >= 30 &&…ar[i] <= 37)

692 
cŞÜ
 = 
cŞÜ_bË
[
·r
[
i
]-30]

693 | 
background
;

694 ià(
·r
[
i
] >= 40 &&…ar[i] <= 47)

695 
cŞÜ
 = (
cŞÜ_bË
[
·r
[
i
]-40]<<4)

696 | 
fÜeground
;

699 
	`upd©e_©Œ
(
cu¼cÚs
);

700 
	}
}

702 
	$»¥Úd_¡ršg
(* 
p
, 
cu¼cÚs
, 
‰y_¡ruù
 * 
‰y
)

704 *
p
) {

705 
	`put_‰y_queue
(*
p
, &
‰y
->
»ad_q
);

706 
p
++;

708 
	`TTY_READ_FLUSH
(
‰y
);

709 
	}
}

711 
	$»¥Úd_num
(
n
, 
cu¼cÚs
, 
‰y_¡ruù
 * 
‰y
)

713 
buff
[3];

714 
i
 = 0;

717 
buff
[
i
++] = (
n
%10)+'0';

718 
n
 /= 10;

719 } 
n
 && 
i
 < 3);

720 
i
--) {

721 
	`put_‰y_queue
(
buff
[
i
], &
‰y
->
»ad_q
);

724 
	}
}

726 
	$cursÜ_»pÜt
(
cu¼cÚs
, 
‰y_¡ruù
 * 
‰y
)

728 
	`put_‰y_queue
('\033', &
‰y
->
»ad_q
);

729 
	`put_‰y_queue
('[', &
‰y
->
»ad_q
);

730 
	`»¥Úd_num
(
y
 + (
decom
 ? 
tİ
+1 : 1), 
cu¼cÚs
, 
‰y
);

731 
	`put_‰y_queue
(';', &
‰y
->
»ad_q
);

732 
	`»¥Úd_num
(
x
+1, 
cu¼cÚs
, 
‰y
);

733 
	`put_‰y_queue
('R', &
‰y
->
»ad_q
);

734 
	`TTY_READ_FLUSH
(
‰y
);

735 
	}
}

737 
šlše
 
	$¡©us_»pÜt
(
cu¼cÚs
, 
‰y_¡ruù
 * 
‰y
)

739 
	`»¥Úd_¡ršg
("\033[0n", 
cu¼cÚs
, 
‰y
);

740 
	}
}

742 
šlše
 
	$»¥Úd_ID
(
cu¼cÚs
, 
‰y_¡ruù
 * 
‰y
)

744 
	`»¥Úd_¡ršg
(
VT102ID
, 
cu¼cÚs
, 
‰y
);

745 
	}
}

747 
	$šv”t_sü“n
(
cu¼cÚs
) {

748 *
p
;

750 ià(
ÿn_do_cŞÜ
)

751 
p
 = (*)
Üigš
+1;… < (*)
sü_’d
;…+=2)

752 *
p
 = (*p & 0x88) | (((*p >> 4) | (*p << 4)) & 0x77);

754 
p
 = (*)
Üigš
+1;… < (*)
sü_’d
;…+=2)

755 *
p
 ^= *p & 0x07 == 1 ? 0x70 : 0x77;

756 
	}
}

758 
	$£t_mode
(
cu¼cÚs
, 
Ú_off
)

760 
i
;

762 
i
=0; i<=
Å¬
; i++)

763 ià(
ques
è
·r
[
i
]) {

765 ià(
Ú_off
)

766 
	`£t_kbd
(
decckm
);

768 
	`şr_kbd
(
decckm
);

771 
	`csi_J
(
cu¼cÚs
,2);

772 
	`gÙoxy
(
cu¼cÚs
,0,0);

775 ià(
decsúm
 !ğ
Ú_off
) {

776 
decsúm
 = 
Ú_off
;

777 
	`šv”t_sü“n
(
cu¼cÚs
);

778 
	`upd©e_©Œ
(
cu¼cÚs
);

782 
decom
 = 
Ú_off
;

783 
	`gÙoxy
(
cu¼cÚs
,0,0);

786 
deÿwm
 = 
Ú_off
;

789 ià(
Ú_off
)

790 
	`£t_kbd
(
deÿrm
);

792 
	`şr_kbd
(
deÿrm
);

795 
deccm
 = 
Ú_off
;

796 
	`£t_cursÜ
(
cu¼cÚs
);

798 } 
·r
[
i
]) {

800 
decim
 = 
Ú_off
;

803 ià(
Ú_off
)

804 
	`£t_kbd
(
Êm
);

806 
	`şr_kbd
(
Êm
);

809 
	}
}

811 
	$£‰”m_commªd
(
cu¼cÚs
)

813 
·r
[0]) {

815 ià(
ÿn_do_cŞÜ
 && 
·r
[1] < 16) {

816 
ulcŞÜ
 = 
cŞÜ_bË
[
·r
[1]];

817 ià(
und”lše
)

818 
	`upd©e_©Œ
(
cu¼cÚs
);

822 ià(
ÿn_do_cŞÜ
 && 
·r
[1] < 16) {

823 
h®fcŞÜ
 = 
cŞÜ_bË
[
·r
[1]];

824 ià(
š‹ns™y
 == 0)

825 
	`upd©e_©Œ
(
cu¼cÚs
);

829 
def_cŞÜ
 = 
©Œ
;

830 
	`deçuÉ_©Œ
(
cu¼cÚs
);

831 
	`upd©e_©Œ
(
cu¼cÚs
);

834 
bÏnkš‹rv®
 = ((
·r
[1] < 60è?…¬[1] : 60è* 60 * 
HZ
;

837 
	}
}

839 
	$š£¹_ch¬
(
cu¼cÚs
)

841 
i
 = 
x
;

842 
tmp
, 
Şd
 = 
video_”a£_ch¬
;

843 * 
p
 = (*è
pos
;

845 
i
++ < 
video_num_cŞumns
) {

846 
tmp
 = *
p
;

847 *
p
 = 
Şd
;

848 
Şd
 = 
tmp
;

849 
p
++;

851 
Ãed_w¿p
 = 0;

852 
	}
}

854 
	$š£¹_lše
(
cu¼cÚs
)

856 
	`südown
(
cu¼cÚs
,
y
,
bÙtom
);

857 
Ãed_w¿p
 = 0;

858 
	}
}

860 
	$d–‘e_ch¬
(
cu¼cÚs
)

862 
i
 = 
x
;

863 * 
p
 = (*è
pos
;

865 ++
i
 < 
video_num_cŞumns
) {

866 *
p
 = *(p+1);

867 
p
++;

869 *
p
 = 
video_”a£_ch¬
;

870 
Ãed_w¿p
 = 0;

871 
	}
}

873 
	$d–‘e_lše
(
cu¼cÚs
)

875 
	`süup
(
cu¼cÚs
,
y
,
bÙtom
);

876 
Ãed_w¿p
 = 0;

877 
	}
}

879 
	$csi_©
(
cu¼cÚs
, 
Ä
)

881 ià(
Ä
 > 
video_num_cŞumns
)

882 
Ä
 = 
video_num_cŞumns
;

883 ià(!
Ä
)

884 
Ä
 = 1;

885 
Ä
--)

886 
	`š£¹_ch¬
(
cu¼cÚs
);

887 
	}
}

889 
	$csi_L
(
cu¼cÚs
, 
Ä
)

891 ià(
Ä
 > 
video_num_lšes
)

892 
Ä
 = 
video_num_lšes
;

893 ià(!
Ä
)

894 
Ä
 = 1;

895 
Ä
--)

896 
	`š£¹_lše
(
cu¼cÚs
);

897 
	}
}

899 
	$csi_P
(
cu¼cÚs
, 
Ä
)

901 ià(
Ä
 > 
video_num_cŞumns
)

902 
Ä
 = 
video_num_cŞumns
;

903 ià(!
Ä
)

904 
Ä
 = 1;

905 
Ä
--)

906 
	`d–‘e_ch¬
(
cu¼cÚs
);

907 
	}
}

909 
	$csi_M
(
cu¼cÚs
, 
Ä
)

911 ià(
Ä
 > 
video_num_lšes
)

912 
Ä
 = 
video_num_lšes
;

913 ià(!
Ä
)

914 
Ä
=1;

915 
Ä
--)

916 
	`d–‘e_lše
(
cu¼cÚs
);

917 
	}
}

919 
	$§ve_cur
(
cu¼cÚs
)

921 
§ved_x
 = 
x
;

922 
§ved_y
 = 
y
;

923 
s_š‹ns™y
 = 
š‹ns™y
;

924 
s_und”lše
 = 
und”lše
;

925 
s_blšk
 = 
blšk
;

926 
s_»v”£
 = 
»v”£
;

927 
s_ch¬£t
 = 
ch¬£t
;

928 
s_cŞÜ
 = 
cŞÜ
;

929 
§ved_G0
 = 
G0_ch¬£t
;

930 
§ved_G1
 = 
G1_ch¬£t
;

931 
	}
}

933 
	$»¡Üe_cur
(
cu¼cÚs
)

935 
	`gÙoxy
(
cu¼cÚs
,
§ved_x
,
§ved_y
);

936 
š‹ns™y
 = 
s_š‹ns™y
;

937 
und”lše
 = 
s_und”lše
;

938 
blšk
 = 
s_blšk
;

939 
»v”£
 = 
s_»v”£
;

940 
ch¬£t
 = 
s_ch¬£t
;

941 
cŞÜ
 = 
s_cŞÜ
;

942 
G0_ch¬£t
 = 
§ved_G0
;

943 
G1_ch¬£t
 = 
§ved_G1
;

944 
Œª¦©e
 = 
ch¬£t
 ? 
G1_ch¬£t
 : 
G0_ch¬£t
;

945 
	`upd©e_©Œ
(
cu¼cÚs
);

946 
Ãed_w¿p
 = 0;

947 
	}
}

949 ’um { 
	mESnÜm®
, 
	mESesc
, 
	mESsqu¬e
, 
	mESg‘·rs
, 
	mESgÙ·rs
, 
	mESfunckey
,

950 
	mEShash
, 
	mES£tG0
, 
	mES£tG1
, 
	mESignÜe
 };

952 
	$»£t_‹rmš®
(
cu¼cÚs
, 
do_ş—r
)

954 
tİ
 = 0;

955 
bÙtom
 = 
video_num_lšes
;

956 
¡©e
 = 
ESnÜm®
;

957 
ques
 = 0;

958 
Œª¦©e
 = 
NORM_TRANS
;

959 
G0_ch¬£t
 = 
NORM_TRANS
;

960 
G1_ch¬£t
 = 
GRAF_TRANS
;

961 
ch¬£t
 = 0;

962 
Ãed_w¿p
 = 0;

964 
decsúm
 = 0;

965 
decom
 = 0;

966 
deÿwm
 = 1;

967 
deccm
 = 1;

968 
decim
 = 0;

970 
	`£t_kbd
(
deÿrm
);

971 
	`şr_kbd
(
decckm
);

972 
	`şr_kbd
(
kbd­¶ic
);

973 
	`şr_kbd
(
Êm
);

974 
kbd_bË
[
cu¼cÚs
].
lock¡©e
 = 0;

975 
kbd_bË
[
cu¼cÚs
].
Ëd¡©e
 = kbd_bË[cu¼cÚs].
deçuÉ_Ëd¡©e
;

976 
	`£t_Ëds
();

978 
	`deçuÉ_©Œ
(
cu¼cÚs
);

979 
	`upd©e_©Œ
(
cu¼cÚs
);

981 
b_¡İ
[0] = 0x01010100;

982 
b_¡İ
[1] =

983 
b_¡İ
[2] =

984 
b_¡İ
[3] =

985 
b_¡İ
[4] = 0x01010101;

987 ià(
do_ş—r
) {

988 
	`gÙoxy
(
cu¼cÚs
,0,0);

989 
	`csi_J
(
cu¼cÚs
,2);

990 
	`§ve_cur
(
cu¼cÚs
);

992 
	}
}

994 
	$cÚ_wr™e
(
‰y_¡ruù
 * 
‰y
)

996 
c
;

997 
cu¼cÚs
;

999 
cu¼cÚs
 = 
‰y
->
lše
 - 1;

1000 ià(
cu¼cÚs
 >ğ
NR_CONSOLES
) {

1001 
	`´štk
("cÚ_wr™e: iÎeg®ty (%d)\n", 
cu¼cÚs
);

1004 #ifdeà
CONFIG_SELECTION


1007 ià(!
	`EMPTY
(&
‰y
->
wr™e_q
è&& 
cu¼cÚs
 =ğ
£l_cÚs
)

1008 
	`ş—r_£ËùiÚ
();

1010 
	`di§bË_bh
(
KEYBOARD_BH
);

1011 !
‰y
->
¡İ³d
 && (
c
 = 
	`g‘_‰y_queue
(&‰y->
wr™e_q
)) >= 0) {

1012 ià(
¡©e
 =ğ
ESnÜm®
 && 
Œª¦©e
[
c
]) {

1013 ià(
Ãed_w¿p
) {

1014 
	`ü
(
cu¼cÚs
);

1015 
	`lf
(
cu¼cÚs
);

1017 ià(
decim
)

1018 
	`š£¹_ch¬
(
cu¼cÚs
);

1019 
c
 = 
Œª¦©e
[c];

1020 *(*è
pos
 = (
©Œ
 << 8è+ 
c
;

1021 ià(
x
 =ğ
video_num_cŞumns
 - 1)

1022 
Ãed_w¿p
 = 
deÿwm
;

1024 
x
++;

1025 
pos
+=2;

1034 
c
) {

1036 
	`kd_mksound
(0x637, 
HZ
/8);

1039 
	`bs
(
cu¼cÚs
);

1042 
pos
 -ğ(
x
 << 1);

1043 
x
 < 
video_num_cŞumns
 - 1) {

1044 
x
++;

1045 ià(
b_¡İ
[
x
 >> 5] & (1 << (x & 31)))

1048 
pos
 +ğ(
x
 << 1);

1051 
	`lf
(
cu¼cÚs
);

1052 ià(!
	`is_kbd
(
Êm
))

1055 
	`ü
(
cu¼cÚs
);

1058 
ch¬£t
 = 1;

1059 
Œª¦©e
 = 
G1_ch¬£t
;

1062 
ch¬£t
 = 0;

1063 
Œª¦©e
 = 
G0_ch¬£t
;

1066 
¡©e
 = 
ESnÜm®
;

1069 
¡©e
 = 
ESesc
;

1072 
	`d–
(
cu¼cÚs
);

1075 
¡©e
 = 
ESsqu¬e
;

1078 
¡©e
) {

1079 
ESesc
:

1080 
¡©e
 = 
ESnÜm®
;

1081 
c
) {

1083 
¡©e
 = 
ESsqu¬e
;

1086 
	`ü
(
cu¼cÚs
);

1087 
	`lf
(
cu¼cÚs
);

1090 
	`ri
(
cu¼cÚs
);

1093 
	`lf
(
cu¼cÚs
);

1096 
b_¡İ
[
x
 >> 5] |= (1 << (x & 31));

1099 
	`»¥Úd_ID
(
cu¼cÚs
,
‰y
);

1102 
	`§ve_cur
(
cu¼cÚs
);

1105 
	`»¡Üe_cur
(
cu¼cÚs
);

1108 
¡©e
 = 
ES£tG0
;

1111 
¡©e
 = 
ES£tG1
;

1114 
¡©e
 = 
EShash
;

1117 
	`»£t_‹rmš®
(
cu¼cÚs
,1);

1120 
	`şr_kbd
(
kbd­¶ic
);

1123 
	`£t_kbd
(
kbd­¶ic
);

1127 
ESsqu¬e
:

1128 
Å¬
 = 0 ;‚·¸< 
NPAR
 ;‚par++)

1129 
·r
[
Å¬
] = 0;

1130 
Å¬
 = 0;

1131 
¡©e
 = 
ESg‘·rs
;

1132 ià(
c
 == '[') {

1133 
¡©e
=
ESfunckey
;

1136 
ques
 = (
c
=='?');

1137 ià(
ques
)

1139 
ESg‘·rs
:

1140 ià(
c
==';' && 
Å¬
<
NPAR
-1) {

1141 
Å¬
++;

1143 } ià(
c
>='0' && c<='9') {

1144 
·r
[
Å¬
] *= 10;

1145 
·r
[
Å¬
] +ğ
c
-'0';

1147 } 
¡©e
=
ESgÙ·rs
;

1148 
ESgÙ·rs
:

1149 
¡©e
 = 
ESnÜm®
;

1150 
c
) {

1152 
	`£t_mode
(
cu¼cÚs
,1);

1155 
	`£t_mode
(
cu¼cÚs
,0);

1158 ià(!
ques
)

1159 ià(
·r
[0] == 5)

1160 
	`¡©us_»pÜt
(
cu¼cÚs
,
‰y
);

1161 ià(
·r
[0] == 6)

1162 
	`cursÜ_»pÜt
(
cu¼cÚs
,
‰y
);

1165 ià(
ques
) {

1166 
ques
 = 0;

1169 
c
) {

1171 ià(
·r
[0])…ar[0]--;

1172 
	`gÙoxy
(
cu¼cÚs
,
·r
[0],
y
);

1175 ià(!
·r
[0])…ar[0]++;

1176 
	`gÙoxy
(
cu¼cÚs
,
x
,
y
-
·r
[0]);

1179 ià(!
·r
[0])…ar[0]++;

1180 
	`gÙoxy
(
cu¼cÚs
,
x
,
y
+
·r
[0]);

1183 ià(!
·r
[0])…ar[0]++;

1184 
	`gÙoxy
(
cu¼cÚs
,
x
+
·r
[0],
y
);

1187 ià(!
·r
[0])…ar[0]++;

1188 
	`gÙoxy
(
cu¼cÚs
,
x
-
·r
[0],
y
);

1191 ià(!
·r
[0])…ar[0]++;

1192 
	`gÙoxy
(
cu¼cÚs
,0,
y
+
·r
[0]);

1195 ià(!
·r
[0])…ar[0]++;

1196 
	`gÙoxy
(
cu¼cÚs
,0,
y
-
·r
[0]);

1199 ià(
·r
[0])…ar[0]--;

1200 
	`gÙoxy
(
cu¼cÚs
,
x
,
·r
[0]);

1203 ià(
·r
[0])…ar[0]--;

1204 ià(
·r
[1])…ar[1]--;

1205 
	`gÙoxy
(
cu¼cÚs
,
·r
[1],par[0]);

1208 
	`csi_J
(
cu¼cÚs
,
·r
[0]);

1211 
	`csi_K
(
cu¼cÚs
,
·r
[0]);

1214 
	`csi_L
(
cu¼cÚs
,
·r
[0]);

1217 
	`csi_M
(
cu¼cÚs
,
·r
[0]);

1220 
	`csi_P
(
cu¼cÚs
,
·r
[0]);

1223 ià(!
·r
[0])

1224 
	`»¥Úd_ID
(
cu¼cÚs
,
‰y
);

1227 ià(!
·r
[0])

1228 
b_¡İ
[
x
 >> 5] &= ~(1 << (x & 31));

1229 ià(
·r
[0] == 3) {

1230 
b_¡İ
[0] =

1231 
b_¡İ
[1] =

1232 
b_¡İ
[2] =

1233 
b_¡İ
[3] =

1234 
b_¡İ
[4] = 0;

1238 
	`csi_m
(
cu¼cÚs
);

1241 ià(!
·r
[0])

1242 
·r
[0]++;

1243 ià(!
·r
[1])

1244 
·r
[1] = 
video_num_lšes
;

1246 ià(
·r
[0] <…ar[1] &&

1247 
·r
[1] <ğ
video_num_lšes
) {

1248 
tİ
=
·r
[0]-1;

1249 
bÙtom
=
·r
[1];

1250 
	`gÙoxy
(
cu¼cÚs
,0,0);

1254 
	`§ve_cur
(
cu¼cÚs
);

1257 
	`»¡Üe_cur
(
cu¼cÚs
);

1260 
	`csi_©
(
cu¼cÚs
,
·r
[0]);

1263 
	`£‰”m_commªd
(
cu¼cÚs
);

1267 
ESfunckey
:

1268 
¡©e
 = 
ESnÜm®
;

1270 
EShash
:

1271 
¡©e
 = 
ESnÜm®
;

1272 ià(
c
 == '8') {

1274 
video_”a£_ch¬
 =

1275 (
video_”a£_ch¬
 & 0xff00) | 'E';

1276 
	`csi_J
(
cu¼cÚs
, 2);

1277 
video_”a£_ch¬
 =

1278 (
video_”a£_ch¬
 & 0xff00) | ' ';

1281 
ES£tG0
:

1282 ià(
c
 == '0')

1283 
G0_ch¬£t
 = 
GRAF_TRANS
;

1284 ià(
c
 == 'B')

1285 
G0_ch¬£t
 = 
NORM_TRANS
;

1286 ià(
c
 == 'U')

1287 
G0_ch¬£t
 = 
NULL_TRANS
;

1288 ià(
c
 == 'K')

1289 
G0_ch¬£t
 = 
USER_TRANS
;

1290 ià(
ch¬£t
 == 0)

1291 
Œª¦©e
 = 
G0_ch¬£t
;

1292 
¡©e
 = 
ESnÜm®
;

1294 
ES£tG1
:

1295 ià(
c
 == '0')

1296 
G1_ch¬£t
 = 
GRAF_TRANS
;

1297 ià(
c
 == 'B')

1298 
G1_ch¬£t
 = 
NORM_TRANS
;

1299 ià(
c
 == 'U')

1300 
G1_ch¬£t
 = 
NULL_TRANS
;

1301 ià(
c
 == 'K')

1302 
G1_ch¬£t
 = 
USER_TRANS
;

1303 ià(
ch¬£t
 == 1)

1304 
Œª¦©e
 = 
G1_ch¬£t
;

1305 
¡©e
 = 
ESnÜm®
;

1308 
¡©e
 = 
ESnÜm®
;

1311 ià(
vcmode
 !ğ
KD_GRAPHICS
)

1312 
	`£t_cursÜ
(
cu¼cÚs
);

1313 
	`’abË_bh
(
KEYBOARD_BH
);

1314 ià(
	`LEFT
(&
‰y
->
wr™e_q
è> 
WAKEUP_CHARS
)

1315 
	`wake_up_š‹¼u±ibË
(&
‰y
->
wr™e_q
.
´oc_li¡
);

1316 
	}
}

1318 
	$do_keybßrd_š‹¼u±
()

1320 
	`TTY_READ_FLUSH
(
	`TTY_TABLE
(0));

1321 
tim”_aùive
 &ğ~(1<<
BLANK_TIMER
);

1322 ià(
vt_cÚs
[
fg_cÚsŞe
].
vc_mode
 =ğ
KD_GRAPHICS
)

1324 ià(
cÚsŞe_bÏnked
) {

1325 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 0;

1326 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1327 } ià(
bÏnkš‹rv®
) {

1328 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 
jiff›s
 + 
bÏnkš‹rv®
;

1329 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1331 
	}
}

1333 * 
	$mem£tw
(* 
s
,
c
,
couÁ
)

1335 
	`__asm__
("cld\n\t"

1339 :"a" (
c
),"D" (
s
),"c" (
couÁ
)

1341  
s
;

1342 
	}
}

1344 
	$cÚsŞe_´št
(cÚ¡ * 
b
)

1346 
cu¼cÚs
 = 
fg_cÚsŞe
;

1347 
c
;

1349 ià(!
´šbË
 || 
cu¼cÚs
<0 || cu¼cÚs>=
NR_CONSOLES
)

1351 (
c
 = *(
b
++)) != 0) {

1352 ià(
c
 =ğ10 || c =ğ13 || 
Ãed_w¿p
) {

1353 ià(
c
 != 13)

1354 
	`lf
(
cu¼cÚs
);

1355 
	`ü
(
cu¼cÚs
);

1356 ià(
c
 == 10 || c == 13)

1359 *(*è
pos
 = (
©Œ
 << 8è+ 
c
;

1360 ià(
x
 =ğ
video_num_cŞumns
 - 1) {

1361 
Ãed_w¿p
 = 1;

1364 
x
++;

1365 
pos
+=2;

1367 
	`£t_cursÜ
(
cu¼cÚs
);

1368 ià(
vt_cÚs
[
fg_cÚsŞe
].
vc_mode
 =ğ
KD_GRAPHICS
)

1370 
tim”_aùive
 &ğ~(1<<
BLANK_TIMER
);

1371 ià(
cÚsŞe_bÏnked
) {

1372 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 0;

1373 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1374 } ià(
bÏnkš‹rv®
) {

1375 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 
jiff›s
 + 
bÏnkš‹rv®
;

1376 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1378 
	}
}

1390 
	$cÚ_š™
(
kmem_¡¬t
)

1392 *
di¥Ïy_desc
 = "????";

1393 
cu¼cÚs
 = 0;

1394 
ba£
;

1395 
Üig_x
 = 
ORIG_X
;

1396 
Üig_y
 = 
ORIG_Y
;

1398 
vc_sümembuf
 = (*è
kmem_¡¬t
;

1399 
video_num_cŞumns
 = 
ORIG_VIDEO_COLS
;

1400 
video_size_row
 = 
video_num_cŞumns
 * 2;

1401 
video_num_lšes
 = 
ORIG_VIDEO_LINES
;

1402 
video_·ge
 = 
ORIG_VIDEO_PAGE
;

1403 
sü“n_size
 = (
video_num_lšes
 * 
video_size_row
);

1404 
kmem_¡¬t
 +ğ
NR_CONSOLES
 * 
sü“n_size
;

1405 
tim”_bË
[
BLANK_TIMER
].
â
 = 
bÏnk_sü“n
;

1406 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 0;

1407 ià(
bÏnkš‹rv®
) {

1408 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 
jiff›s
+
bÏnkš‹rv®
;

1409 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1412 ià(
ORIG_VIDEO_MODE
 == 7)

1414 
video_mem_ba£
 = 0xb0000;

1415 
video_pÜt_»g
 = 0x3b4;

1416 
video_pÜt_v®
 = 0x3b5;

1417 ià((
ORIG_VIDEO_EGA_BX
 & 0xff) != 0x10)

1419 
video_ty³
 = 
VIDEO_TYPE_EGAM
;

1420 
video_mem_‹rm
 = 0xb8000;

1421 
di¥Ïy_desc
 = "EGA+";

1425 
video_ty³
 = 
VIDEO_TYPE_MDA
;

1426 
video_mem_‹rm
 = 0xb2000;

1427 
di¥Ïy_desc
 = "*MDA";

1432 
ÿn_do_cŞÜ
 = 1;

1433 
video_mem_ba£
 = 0xb8000;

1434 
video_pÜt_»g
 = 0x3d4;

1435 
video_pÜt_v®
 = 0x3d5;

1436 ià((
ORIG_VIDEO_EGA_BX
 & 0xff) != 0x10)

1438 
video_ty³
 = 
VIDEO_TYPE_EGAC
;

1439 
video_mem_‹rm
 = 0xc0000;

1440 
di¥Ïy_desc
 = "EGA+";

1444 
video_ty³
 = 
VIDEO_TYPE_CGA
;

1445 
video_mem_‹rm
 = 0xba000;

1446 
di¥Ïy_desc
 = "*CGA";

1452 
ba£
 = ()
vc_sümembuf
;

1453 
cu¼cÚs
 = 0; cu¼cÚs<
NR_CONSOLES
; currcons++) {

1454 
pos
 = 
Üigš
 = 
video_mem_¡¬t
 = 
ba£
;

1455 
sü_’d
 = 
video_mem_’d
 = (
ba£
 +ğ
sü“n_size
);

1456 
vc_sübuf
[
cu¼cÚs
] = (*è
Üigš
;

1457 
vcmode
 = 
KD_TEXT
;

1458 
vtmode
.
mode
 = 
VT_AUTO
;

1459 
vtmode
.
wa™v
 = 0;

1460 
vtmode
.
»lsig
 = 0;

1461 
vtmode
.
acqsig
 = 0;

1462 
vtmode
.
äsig
 = 0;

1463 
vid
 = -1;

1464 
vŠewvt
 = -1;

1465 
	`şr_kbd
(
kbd¿w
);

1466 
def_cŞÜ
 = 0x07;

1467 
ulcŞÜ
 = 0x0f;

1468 
h®fcŞÜ
 = 0x08;

1469 
	`»£t_‹rmš®
(
cu¼cÚs
, currcons);

1471 
cu¼cÚs
 = 
fg_cÚsŞe
 = 0;

1473 
video_mem_¡¬t
 = 
video_mem_ba£
;

1474 
video_mem_’d
 = 
video_mem_‹rm
;

1475 
Üigš
 = 
video_mem_¡¬t
;

1476 
sü_’d
 = 
video_mem_¡¬t
 + 
video_num_lšes
 * 
video_size_row
;

1477 
	`gÙoxy
(
cu¼cÚs
,0,0);

1478 
	`§ve_cur
(
cu¼cÚs
);

1479 
	`gÙoxy
(
cu¼cÚs
,
Üig_x
,
Üig_y
);

1480 
	`upd©e_sü“n
(
fg_cÚsŞe
);

1481 
´šbË
 = 1;

1482 
	`´štk
("Console: %s %s %ldx%ld, %d virtual consoles\n",

1483 
ÿn_do_cŞÜ
?"colour":"mono",

1484 
di¥Ïy_desc
,

1485 
video_num_cŞumns
,
video_num_lšes
,

1486 
NR_CONSOLES
);

1487 
	`»gi¡”_cÚsŞe
(
cÚsŞe_´št
);

1488  
kmem_¡¬t
;

1489 
	}
}

1495 
	$kbd§ve
(
Ãw_cÚsŞe
)

1497 
	}
}

1499 
	$g‘_sümem
(
cu¼cÚs
)

1501 
	`memıy
((*)
vc_sübuf
[
cu¼cÚs
],(*)
Üigš
, 
sü“n_size
);

1502 
video_mem_¡¬t
 = ()
vc_sübuf
[
cu¼cÚs
];

1503 
Üigš
 = 
video_mem_¡¬t
;

1504 
sü_’d
 = 
video_mem_’d
 = 
video_mem_¡¬t
+
sü“n_size
;

1505 
pos
 = 
Üigš
 + 
y
*
video_size_row
 + (
x
<<1);

1506 
	}
}

1508 
	$£t_sümem
(
cu¼cÚs
)

1510 #ifdeà
CONFIG_HGA


1518 ià(
video_ty³
 =ğ
VIDEO_TYPE_MDA
)

1520 ià(
vcmode
 =ğ
KD_TEXT
)

1523 
i
;

1524 
h”c_txt_tbl
[12] = {

1526 
	`outb_p
(0, 0x3bf);

1527 
	`outb_p
(0, 0x3b8);

1528  
i
 = 0 ; i < 12 ; i++ )

1530 
	`outb_p
(
i
, 0x3b4);

1531 
	`outb_p
(
h”c_txt_tbl
[
i
], 0x3b5);

1534 
	#HGA_BLINKER_ON
 0x20

	)

1535 
	#HGA_SCREEN_ON
 8

	)

1537 
	`outb_p
(
HGA_BLINKER_ON
 | 
HGA_SCREEN_ON
, 0x3b8);

1541 
video_mem_¡¬t
 = 
video_mem_ba£
;

1542 
video_mem_’d
 = 
video_mem_‹rm
;

1543 
Üigš
 = 
video_mem_¡¬t
;

1544 
sü_’d
 = 
video_mem_¡¬t
 + 
sü“n_size
;

1545 
pos
 = 
Üigš
 + 
y
*
video_size_row
 + (
x
<<1);

1546 
	`memıy
((*)
video_mem_ba£
, (*)
vc_sübuf
[
fg_cÚsŞe
], 
sü“n_size
);

1547 
	}
}

1549 
	$bÏnk_sü“n
()

1551 ià(
cÚsŞe_bÏnked
)

1553 
tim”_bË
[
BLANK_TIMER
].
â
 = 
unbÏnk_sü“n
;

1554 
	`g‘_sümem
(
fg_cÚsŞe
);

1555 
	`hide_cursÜ
();

1556 
cÚsŞe_bÏnked
 = 1;

1557 
	`mem£tw
((*)
video_mem_ba£
, 0x0020, 
video_mem_‹rm
-video_mem_base );

1558 
	}
}

1560 
	$unbÏnk_sü“n
()

1562 ià(!
cÚsŞe_bÏnked
)

1564 
tim”_bË
[
BLANK_TIMER
].
â
 = 
bÏnk_sü“n
;

1565 ià(
bÏnkš‹rv®
) {

1566 
tim”_bË
[
BLANK_TIMER
].
expœes
 = 
jiff›s
 + 
bÏnkš‹rv®
;

1567 
tim”_aùive
 |ğ1<<
BLANK_TIMER
;

1569 
cÚsŞe_bÏnked
 = 0;

1570 
	`£t_sümem
(
fg_cÚsŞe
);

1571 
	`£t_Üigš
(
fg_cÚsŞe
);

1572 
	`£t_cursÜ
(
fg_cÚsŞe
);

1573 
	}
}

1575 
	$upd©e_sü“n
(
Ãw_cÚsŞe
)

1577 
lock
 = 0;

1579 ià(
Ãw_cÚsŞe
 =ğ
fg_cÚsŞe
 || 
lock
)

1581 
lock
 = 1;

1582 
	`kbd§ve
(
Ãw_cÚsŞe
);

1583 
	`g‘_sümem
(
fg_cÚsŞe
);

1584 
fg_cÚsŞe
 = 
Ãw_cÚsŞe
;

1585 
	`£t_sümem
(
fg_cÚsŞe
);

1586 
	`£t_Üigš
(
fg_cÚsŞe
);

1587 
	`£t_cursÜ
(
Ãw_cÚsŞe
);

1588 
	`£t_Ëds
();

1589 
	`compu‹_shiá¡©e
();

1590 
lock
 = 0;

1591 
	}
}

1593 
	$do_sü“ndump
(
¬g
)

1595 *
¥Œ
, *
buf
 = (*)
¬g
;

1596 
cu¼cÚs
, 
l
;

1598 ià(!
	`su£r
())

1599  -
EPERM
;

1600 
l
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
buf
,2+
video_num_cŞumns
*
video_num_lšes
);

1601 ià(
l
)

1602  
l
;

1603 
cu¼cÚs
 = 
	`g‘_fs_by‹
(
buf
+1);

1604 ià((
cu¼cÚs
<0è|| (cu¼cÚs>
NR_CONSOLES
))

1605  -
EIO
;

1606 
	`put_fs_by‹
(()(
video_num_lšes
),
buf
++);

1607 
	`put_fs_by‹
(()(
video_num_cŞumns
),
buf
++);

1608 
cu¼cÚs
 = (cu¼cÚ ? cu¼cÚs-1 : 
fg_cÚsŞe
);

1609 
¥Œ
 = (*è
Üigš
;

1610 
l
=
video_num_lšes
*
video_num_cŞumns
;†>0 ;†--, 
¥Œ
++)

1611 
	`put_fs_by‹
(*
¥Œ
++,
buf
++);

1613 
	}
}

1619 
	$cÚ_İ’
(
‰y_¡ruù
 *
‰y
, 
fe
 * 
fp
)

1621 
‰y
->
wr™e
 = 
cÚ_wr™e
;

1622 
‰y
->
ioùl
 = 
vt_ioùl
;

1623 ià(
‰y
->
lše
 > 
NR_CONSOLES
)

1624  -
ENODEV
;

1626 
	}
}

1628 #ifdeà
CONFIG_SELECTION


1630 
	#hwsüŞl_off£t
 (
cu¼cÚs
 =ğ
fg_cÚsŞe
 ? ((
__»®_Üigš
 - 
__Üigš
è<< 1è: 0)

	)

1633 
	$highlight
(cÚ¡ 
cu¼cÚs
, cÚ¡ 
s
, cÚ¡ 
e
)

1635 *
p
, *
p1
, *
p2
;

1637 
p1
 = (*)
Üigš
 - 
hwsüŞl_off£t
 + 
s
 + 1;

1638 
p2
 = (*)
Üigš
 - 
hwsüŞl_off£t
 + 
e
 + 1;

1639 ià(
p1
 > 
p2
)

1641 
p
 = 
p1
;

1642 
p1
 = 
p2
;

1643 
p2
 = 
p
;

1645 
p
 = 
p1
;… <ğ
p2
;… += 2)

1646 *
p
 = (*p & 0x88) | ((*p << 4) & 0x70) | ((*p >> 4) & 0x07);

1647 
	}
}

1650 
šlše
 
	$šwÜd
(cÚ¡ 
c
è{  (
	`i§Êum
(cè|| c =ğ'_'); 
	}
}

1653 
šlše
 
	$©edge
(cÚ¡ 
p
)

1655  (!(
p
 % 
video_size_row
) || !((p + 2) % video_size_row));

1656 
	}
}

1659 
šlše
 
	$lim™
(cÚ¡ 
v
, cÚ¡ 
l
, cÚ¡ 
u
)

1661  (
v
 < 
l
è?† : ((v > 
u
) ? u : v);

1662 
	}
}

1665 
	$£t_£ËùiÚ
(cÚ¡ 
¬g
)

1667 *
¬gs
, 
xs
, 
ys
, 
xe
, 
ye
;

1668 
cu¼cÚs
 = 
fg_cÚsŞe
;

1669 
£l_mode
, 
Ãw_£l_¡¬t
, 
Ãw_£l_’d
, 
¥c
;

1670 *
bp
, *
obp
, *
¥os
;

1671 
i
, 
ps
, 
³
;

1672 *
off
 = (*)
Üigš
 - 
hwsüŞl_off£t
;

1674 
	`unbÏnk_sü“n
();

1675 
¬gs
 = (*)(
¬g
 + 1);

1676 
xs
 = 
	`g‘_fs_wÜd
(
¬gs
++) - 1;

1677 
ys
 = 
	`g‘_fs_wÜd
(
¬gs
++) - 1;

1678 
xe
 = 
	`g‘_fs_wÜd
(
¬gs
++) - 1;

1679 
ye
 = 
	`g‘_fs_wÜd
(
¬gs
++) - 1;

1680 
£l_mode
 = 
	`g‘_fs_wÜd
(
¬gs
);

1682 
xs
 = 
	`lim™
(xs, 0, 
video_num_cŞumns
 - 1);

1683 
ys
 = 
	`lim™
(ys, 0, 
video_num_lšes
 - 1);

1684 
xe
 = 
	`lim™
(xe, 0, 
video_num_cŞumns
 - 1);

1685 
ye
 = 
	`lim™
(ye, 0, 
video_num_lšes
 - 1);

1686 
ps
 = 
ys
 * 
video_size_row
 + (
xs
 << 1);

1687 
³
 = 
ye
 * 
video_size_row
 + (
xe
 << 1);

1689 ià(
ps
 > 
³
)

1691 
tmp
 = 
ps
;

1692 
ps
 = 
³
;

1693 
³
 = 
tmp
;

1696 
£l_mode
)

1700 
Ãw_£l_¡¬t
 = 
ps
;

1701 
Ãw_£l_’d
 = 
³
;

1704 
¥c
 = 
	`is¥aû
(*(
off
 + 
ps
));

1705 
Ãw_£l_¡¬t
 = 
ps
; ;…s -= 2)

1707 ià((
¥c
 && !
	`is¥aû
(*(
off
 + 
ps
))) ||

1708 (!
¥c
 && !
	`šwÜd
(*(
off
 + 
ps
))))

1710 
Ãw_£l_¡¬t
 = 
ps
;

1711 ià(!(
ps
 % 
video_size_row
))

1714 
¥c
 = 
	`is¥aû
(*(
off
 + 
³
));

1715 
Ãw_£l_’d
 = 
³
; ;…e += 2)

1717 ià((
¥c
 && !
	`is¥aû
(*(
off
 + 
³
))) ||

1718 (!
¥c
 && !
	`šwÜd
(*(
off
 + 
³
))))

1720 
Ãw_£l_’d
 = 
³
;

1721 ià(!((
³
 + 2è% 
video_size_row
))

1726 
Ãw_£l_¡¬t
 = 
ps
 -… % 
video_size_row
;

1727 
Ãw_£l_’d
 = 
³
 + 
video_size_row


1728 - 
³
 % 
video_size_row
 - 2;

1732 ià(
Ãw_£l_’d
 > 
Ãw_£l_¡¬t
 &&

1733 !
	`©edge
(
Ãw_£l_’d
è&& 
	`is¥aû
(*(
off
 +‚ew_sel_end)))

1735 
³
 = 
Ãw_£l_’d
 + 2; ;…e += 2)

1737 ià(!
	`is¥aû
(*(
off
 + 
³
)è|| 
	`©edge
(pe))

1740 ià(
	`is¥aû
(*(
off
 + 
³
)))

1741 
Ãw_£l_’d
 = 
³
;

1743 ià(
£l_cÚs
 !ğ
cu¼cÚs
)

1745 
	`ş—r_£ËùiÚ
();

1746 
£l_cÚs
 = 
cu¼cÚs
;

1748 ià(
£l_¡¬t
 == -1)

1749 
	`highlight
(
£l_cÚs
, 
Ãw_£l_¡¬t
, 
Ãw_£l_’d
);

1750 ià(
Ãw_£l_¡¬t
 =ğ
£l_¡¬t
)

1752 ià(
Ãw_£l_’d
 =ğ
£l_’d
)

1754 ià(
Ãw_£l_’d
 > 
£l_’d
)

1755 
	`highlight
(
£l_cÚs
, 
£l_’d
 + 2, 
Ãw_£l_’d
);

1757 
	`highlight
(
£l_cÚs
, 
Ãw_£l_’d
 + 2, 
£l_’d
);

1759 ià(
Ãw_£l_’d
 =ğ
£l_’d
)

1761 ià(
Ãw_£l_¡¬t
 < 
£l_¡¬t
)

1762 
	`highlight
(
£l_cÚs
, 
Ãw_£l_¡¬t
, 
£l_¡¬t
 - 2);

1764 
	`highlight
(
£l_cÚs
, 
£l_¡¬t
, 
Ãw_£l_¡¬t
 - 2);

1768 
	`ş—r_£ËùiÚ
();

1769 
	`highlight
(
£l_cÚs
, 
Ãw_£l_¡¬t
, 
Ãw_£l_’d
);

1771 
£l_¡¬t
 = 
Ãw_£l_¡¬t
;

1772 
£l_’d
 = 
Ãw_£l_’d
;

1773 
obp
 = 
bp
 = 
£l_bufãr
;

1774 
i
 = 
£l_¡¬t
; i <ğ
£l_’d
; i += 2)

1776 
¥os
 = (*)
off
 + 
i
;

1777 *
bp
++ = *
¥os
;

1778 ià(!
	`is¥aû
(*
¥os
))

1779 
obp
 = 
bp
;

1780 ià(! ((
i
 + 2è% 
video_size_row
))

1784 ià(
obp
 !ğ
bp
)

1786 
bp
 = 
obp
;

1787 *
bp
++ = '\r';

1789 
obp
 = 
bp
;

1793 ià(
bp
 - 
£l_bufãr
 > 
SEL_BUFFER_SIZE
 - 3)

1796 *
bp
 = '\0';

1798 
	}
}

1802 
	$·¡e_£ËùiÚ
(
‰y_¡ruù
 *
‰y
)

1804 *
bp
 = 
£l_bufãr
;

1806 ià(! *
bp
)

1808 
	`unbÏnk_sü“n
();

1809 *
bp
) {

1810 
	`put_‰y_queue
(*
bp
, &
‰y
->
»ad_q
);

1811 
bp
++;

1812 
	`TTY_READ_FLUSH
(
‰y
);

1815 
	}
}

1819 
	$ş—r_£ËùiÚ
()

1821 ià(
£l_¡¬t
 != -1)

1823 
	`highlight
(
£l_cÚs
, 
£l_¡¬t
, 
£l_’d
);

1824 
£l_¡¬t
 = -1;

1826 
	}
}

1841 
	#cŞourm­
 ((*)0xa0000)

	)

1842 
	#bÏckwm­
 ((*)0xb0000)

	)

1843 
	#cm­sz
 8192

	)

1844 
	#£q_pÜt_»g
 (0x3c4)

	)

1845 
	#£q_pÜt_v®
 (0x3c5)

	)

1846 
	#gr_pÜt_»g
 (0x3û)

	)

1847 
	#gr_pÜt_v®
 (0x3cf)

	)

1849 
	$£t_g‘_fÚt
(* 
¬g
, 
£t
)

1851 #ifdeà
CAN_LOAD_EGA_FONTS


1852 
i
;

1853 *
ch¬m­
;

1854 
beg
;

1858 ià(
video_ty³
 =ğ
VIDEO_TYPE_EGAC
) {

1859 
ch¬m­
 = 
cŞourm­
;

1860 
beg
 = 0x0e;

1861 } ià(
video_ty³
 =ğ
VIDEO_TYPE_EGAM
) {

1862 
ch¬m­
 = 
bÏckwm­
;

1863 
beg
 = 0x0a;

1865  -
EINVAL
;

1867 
i
 = 
	`v”ify_¬—
(
£t
 ? 
VERIFY_READ
 : 
VERIFY_WRITE
, (*)
¬g
, 
cm­sz
);

1868 ià(
i
)

1869  
i
;

1871 
	`şi
();

1872 
	`outb_p
Ğ0x00, 
£q_pÜt_»g
 );

1873 
	`outb_p
Ğ0x01, 
£q_pÜt_v®
 );

1874 
	`outb_p
Ğ0x02, 
£q_pÜt_»g
 );

1875 
	`outb_p
Ğ0x04, 
£q_pÜt_v®
 );

1876 
	`outb_p
Ğ0x04, 
£q_pÜt_»g
 );

1877 
	`outb_p
Ğ0x07, 
£q_pÜt_v®
 );

1878 
	`outb_p
Ğ0x00, 
£q_pÜt_»g
 );

1879 
	`outb_p
Ğ0x03, 
£q_pÜt_v®
 );

1881 
	`outb_p
Ğ0x04, 
gr_pÜt_»g
 );

1882 
	`outb_p
Ğ0x02, 
gr_pÜt_v®
 );

1883 
	`outb_p
Ğ0x05, 
gr_pÜt_»g
 );

1884 
	`outb_p
Ğ0x00, 
gr_pÜt_v®
 );

1885 
	`outb_p
Ğ0x06, 
gr_pÜt_»g
 );

1886 
	`outb_p
Ğ0x00, 
gr_pÜt_v®
 );

1887 
	`¡i
();

1889 ià(
£t
)

1890 
i
=0; i<
cm­sz
 ; i++)

1891 *(
ch¬m­
+
i
èğ
	`g‘_fs_by‹
(
¬g
+i);

1893 
i
=0; i<
cm­sz
 ; i++)

1894 
	`put_fs_by‹
(*(
ch¬m­
+
i
), 
¬g
+i);

1896 
	`şi
();

1897 
	`outb_p
Ğ0x00, 
£q_pÜt_»g
 );

1898 
	`outb_p
Ğ0x01, 
£q_pÜt_v®
 );

1899 
	`outb_p
Ğ0x02, 
£q_pÜt_»g
 );

1900 
	`outb_p
Ğ0x03, 
£q_pÜt_v®
 );

1901 
	`outb_p
Ğ0x04, 
£q_pÜt_»g
 );

1902 
	`outb_p
Ğ0x03, 
£q_pÜt_v®
 );

1903 
	`outb_p
Ğ0x00, 
£q_pÜt_»g
 );

1904 
	`outb_p
Ğ0x03, 
£q_pÜt_v®
 );

1906 
	`outb_p
Ğ0x04, 
gr_pÜt_»g
 );

1907 
	`outb_p
Ğ0x00, 
gr_pÜt_v®
 );

1908 
	`outb_p
Ğ0x05, 
gr_pÜt_»g
 );

1909 
	`outb_p
Ğ0x10, 
gr_pÜt_v®
 );

1910 
	`outb_p
Ğ0x06, 
gr_pÜt_»g
 );

1911 
	`outb_p
Ğ
beg
, 
gr_pÜt_v®
 );

1912 
	`¡i
();

1916  -
EINVAL
;

1918 
	}
}

1926 
	$cÚ_£t_fÚt
 (*
¬g
)

1928  
	`£t_g‘_fÚt
 (
¬g
,1);

1929 
	}
}

1931 
	$cÚ_g‘_fÚt
 (*
¬g
)

1933  
	`£t_g‘_fÚt
 (
¬g
,0);

1934 
	}
}

1941 
	$cÚ_£t_Œªs
(* 
¬g
)

1943 
i
;

1945 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*)
¬g
, 
E_TABSZ
);

1946 ià(
i
)

1947  
i
;

1949 
i
=0; i<
E_TABSZ
 ; i++è
USER_TRANS
[i] = 
	`g‘_fs_by‹
(
¬g
+i);

1950 
USER_TRANS
[012]=0;

1951 
USER_TRANS
[014]=0;

1952 
USER_TRANS
[015]=0;

1953 
USER_TRANS
[033]=0;

1955 
	}
}

1957 
	$cÚ_g‘_Œªs
(* 
¬g
)

1959 
i
;

1961 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, 
E_TABSZ
);

1962 ià(
i
)

1963  
i
;

1965 
i
=0; i<
E_TABSZ
 ; i++è
	`put_fs_by‹
(
USER_TRANS
[i],
¬g
+i);

1967 
	}
}

	@drivers/char/defkeymap.c

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/keybßrd.h
>

6 
	~<lšux/kd.h
>

8 
u_shÜt
 
	gkey_m­
[
NR_KEYMAPS
][
NR_KEYS
] = {

284 
	gfunc_buf
[
FUNC_BUFSIZE
] = {

323 *
	gfunc_bË
[
NR_FUNC
] = {

324 
func_buf
 + 0,

325 
func_buf
 + 5,

326 
func_buf
 + 10,

327 
func_buf
 + 15,

328 
func_buf
 + 20,

329 
func_buf
 + 25,

330 
func_buf
 + 31,

331 
func_buf
 + 37,

332 
func_buf
 + 43,

333 
func_buf
 + 49,

334 
func_buf
 + 55,

335 
func_buf
 + 61,

336 
func_buf
 + 67,

337 
func_buf
 + 73,

338 
func_buf
 + 79,

339 
func_buf
 + 85,

340 
func_buf
 + 91,

341 
func_buf
 + 97,

342 
func_buf
 + 103,

343 
func_buf
 + 109,

344 
func_buf
 + 115,

345 
func_buf
 + 120,

346 
func_buf
 + 125,

347 
func_buf
 + 130,

348 
func_buf
 + 135,

349 
func_buf
 + 140,

350 
func_buf
 + 145,

351 
func_buf
 + 149,

352 
func_buf
 + 150,

353 
func_buf
 + 151,

354 
func_buf
 + 155,

355 
func_buf
 + 156,

356 
func_buf
 + 157,

357 
func_buf
 + 158,

358 
func_buf
 + 159,

359 
func_buf
 + 160,

362 
kbdŸü
 
	gacûÁ_bË
[
MAX_DIACR
] = {

399 
	gacûÁ_bË_size
 = 68;

	@drivers/char/diacr.h

1 #iâdeà
_DIACR_H


2 
	#_DIACR_H


	)

3 
	~<lšux/kd.h
>

5 
kbdŸü
 
acûÁ_bË
[];

6 
acûÁ_bË_size
;

	@drivers/char/kbd_kern.h

1 #iâdeà
_KBD_KERN_H


2 
	#_KBD_KERN_H


	)

4 
	~<lšux/š‹¼u±.h
>

5 
	#£t_Ëds
(è
	`m¬k_bh
(
KEYBOARD_BH
)

	)

7 
	~<lšux/keybßrd.h
>

18 
	skbd_¡ruù
 {

19 
	mËd¡©e
;

20 
	mdeçuÉ_Ëd¡©e
;

21 
	#VC_SCROLLOCK
 0

	)

22 
	#VC_NUMLOCK
 1

	)

23 
	#VC_CAPSLOCK
 2

	)

25 
	mlock¡©e
;

26 
	#VC_SHIFTLOCK
 
KG_SHIFT


	)

27 
	#VC_ALTGRLOCK
 
KG_ALTGR


	)

28 
	#VC_CTRLLOCK
 
KG_CTRL


	)

29 
	#VC_ALTLOCK
 
KG_ALT


	)

31 
	mmodeæags
;

32 
	#VC_APPLIC
 0

	)

33 
	#VC_CKMODE
 1

	)

34 
	#VC_REPEAT
 2

	)

35 
	#VC_CRLF
 3

	)

36 
	#VC_META
 4

	)

37 
	#VC_PAUSE
 5

	)

38 
	#VC_RAW
 6

	)

39 
	#VC_MEDIUMRAW
 7

	)

42 
kbd_¡ruù
 
kbd_bË
[];

45 
kbd_š™
();

47 
šlše
 
	$vc_kbd_Ëd
(
kbd_¡ruù
 * 
kbd
, 
æag
)

49  ((
kbd
->
Ëd¡©e
 >> 
æag
) & 1);

50 
	}
}

52 
šlše
 
	$vc_kbd_lock
(
kbd_¡ruù
 * 
kbd
, 
æag
)

54  ((
kbd
->
lock¡©e
 >> 
æag
) & 1);

55 
	}
}

57 
šlše
 
	$vc_kbd_mode
(
kbd_¡ruù
 * 
kbd
, 
æag
)

59  ((
kbd
->
modeæags
 >> 
æag
) & 1);

60 
	}
}

62 
šlše
 
	$£t_vc_kbd_Ëd
(
kbd_¡ruù
 * 
kbd
, 
æag
)

64 
kbd
->
Ëd¡©e
 |ğ1 << 
æag
;

65 
	}
}

67 
šlše
 
	$£t_vc_kbd_lock
(
kbd_¡ruù
 * 
kbd
, 
æag
)

69 
kbd
->
lock¡©e
 |ğ1 << 
æag
;

70 
	}
}

72 
šlše
 
	$£t_vc_kbd_mode
(
kbd_¡ruù
 * 
kbd
, 
æag
)

74 
kbd
->
modeæags
 |ğ1 << 
æag
;

75 
	}
}

77 
šlše
 
	$şr_vc_kbd_Ëd
(
kbd_¡ruù
 * 
kbd
, 
æag
)

79 
kbd
->
Ëd¡©e
 &ğ~(1 << 
æag
);

80 
	}
}

82 
šlše
 
	$şr_vc_kbd_lock
(
kbd_¡ruù
 * 
kbd
, 
æag
)

84 
kbd
->
lock¡©e
 &ğ~(1 << 
æag
);

85 
	}
}

87 
šlše
 
	$şr_vc_kbd_mode
(
kbd_¡ruù
 * 
kbd
, 
æag
)

89 
kbd
->
modeæags
 &ğ~(1 << 
æag
);

90 
	}
}

92 
šlše
 
	$chg_vc_kbd_Ëd
(
kbd_¡ruù
 * 
kbd
, 
æag
)

94 
kbd
->
Ëd¡©e
 ^ğ1 << 
æag
;

95 
	}
}

97 
šlše
 
	$chg_vc_kbd_lock
(
kbd_¡ruù
 * 
kbd
, 
æag
)

99 
kbd
->
lock¡©e
 ^ğ1 << 
æag
;

100 
	}
}

102 
šlše
 
	$chg_vc_kbd_mode
(
kbd_¡ruù
 * 
kbd
, 
æag
)

104 
kbd
->
modeæags
 ^ğ1 << 
æag
;

105 
	}
}

	@drivers/char/keyboard.c

14 
	#KEYBOARD_IRQ
 1

	)

16 
	~<lšux/sched.h
>

17 
	~<lšux/‰y.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/±¿û.h
>

20 
	~<lšux/š‹¼u±.h
>

21 
	~<lšux/cÚfig.h
>

22 
	~<lšux/sigÇl.h
>

23 
	~<lšux/¡ršg.h
>

25 
	~<asm/b™İs.h
>

27 
	~"kbd_k”n.h
"

28 
	~"dŸü.h
"

30 
	#SIZE
(
x
è((x)/((x)[0]))

	)

32 
	#KBD_REPORT_ERR


	)

33 
	#KBD_REPORT_UNKN


	)

35 #iâdeà
KBD_DEFMODE


36 
	#KBD_DEFMODE
 ((1 << 
VC_REPEAT
è| (1 << 
VC_META
))

	)

39 #iâdeà
KBD_DEFLEDS


44 
	#KBD_DEFLEDS
 0

	)

47 #iâdeà
KBD_DEFLOCK


48 
	#KBD_DEFLOCK
 0

	)

57 
	#REALLY_SLOW_IO


	)

58 
	#SLOW_IO_BY_JUMPING


	)

59 
	~<asm/io.h
>

60 
	~<asm/sy¡em.h
>

62 
do_keybßrd_š‹¼u±
();

63 
ù¾_®t_d–
();

64 
chªge_cÚsŞe
(
Ãw_cÚsŞe
);

65 
süŞlback
();

66 
süŞläÚt
();

68 
	#çke_keybßrd_š‹¼u±
() \

69 
__asm__
 
	`__vŞ©e__
("šˆ$0x21")

	)

71 
	gkbd_»ad_mask
 = 0x01;

80 
	gk_down
[
NR_SHIFT
] = {0, };

82 
	gkey_down
[8] = { 0, };

84 
	gwªt_cÚsŞe
 = -1;

85 
	gÏ¡_cÚsŞe
 = 0;

86 
	gd—d_key_Ãxt
 = 0;

87 
	gshiá_¡©e
 = 0;

88 
	gÅadch
 = -1;

89 
	gdŸü
 = 0;

90 
	g»p
 = 0;

91 
kbd_¡ruù
 
	gkbd_bË
[
NR_CONSOLES
];

92 
kbd_¡ruù
 * 
	gkbd
 = 
kbd_bË
;

93 
‰y_¡ruù
 * 
	g‰y
 = 
NULL
;

96 vŞ©
	gacknowËdge
 = 0;

97 vŞ©
	g»£nd
 = 0;

99 (*
	tk_hªd
)(
	tv®ue
, 
	tup_æag
);

100 (
	tk_hªdâ
)(
	tv®ue
, 
	tup_æag
);

102 
k_hªdâ


103 
do_£lf
, 
do_â
, 
do_¥ec
, 
do_·d
, 
do_d—d
, 
do_cÚs
, 
do_cur
, 
do_shiá
,

104 
do_m‘a
, 
do_ascii
, 
do_lock
, 
do_low”ÿ£
;

106 
k_hªd
 
key_hªdËr
[] = {

107 
do_£lf
, 
do_â
, 
do_¥ec
, 
do_·d
, 
do_d—d
, 
do_cÚs
, 
do_cur
, 
do_shiá
,

108 
do_m‘a
, 
do_ascii
, 
do_lock
, 
do_low”ÿ£


109 
	}
};

112 cÚ¡ 
	gmax_v®s
[] = {

113 255, 
NR_FUNC
 - 1, 14, 17, 4, 255, 3, 
NR_SHIFT
,

117 cÚ¡ 
	gNR_TYPES
 = 
SIZE
(
max_v®s
);

119 
put_queue
();

120 
hªdË_dŸü
();

123 
±_»gs
 * 
	g±_»gs
;

125 
	ggÙ_b»ak
 = 0;

127 
šlše
 
	$kb_wa™
()

129 
i
;

131 
i
=0; i<0x10000; i++)

132 ià((
	`šb_p
(0x64) & 0x02) == 0)

134 
	}
}

136 
šlše
 
	$£nd_cmd
(
c
)

138 
	`kb_wa™
();

139 
	`outb
(
c
,0x64);

140 
	}
}

146 
	#E0_BASE
 96

	)

148 
	#E0_KPENTER
 (
E0_BASE
+0)

	)

149 
	#E0_RCTRL
 (
E0_BASE
+1)

	)

150 
	#E0_KPSLASH
 (
E0_BASE
+2)

	)

151 
	#E0_PRSCR
 (
E0_BASE
+3)

	)

152 
	#E0_RALT
 (
E0_BASE
+4)

	)

153 
	#E0_BREAK
 (
E0_BASE
+5è

	)

154 
	#E0_HOME
 (
E0_BASE
+6)

	)

155 
	#E0_UP
 (
E0_BASE
+7)

	)

156 
	#E0_PGUP
 (
E0_BASE
+8)

	)

157 
	#E0_LEFT
 (
E0_BASE
+9)

	)

158 
	#E0_RIGHT
 (
E0_BASE
+10)

	)

159 
	#E0_END
 (
E0_BASE
+11)

	)

160 
	#E0_DOWN
 (
E0_BASE
+12)

	)

161 
	#E0_PGDN
 (
E0_BASE
+13)

	)

162 
	#E0_INS
 (
E0_BASE
+14)

	)

163 
	#E0_DEL
 (
E0_BASE
+15)

	)

165 
	#E0_MACRO
 (
E0_BASE
+16)

	)

167 
	#E0_F13
 (
E0_BASE
+17)

	)

168 
	#E0_F14
 (
E0_BASE
+18)

	)

169 
	#E0_HELP
 (
E0_BASE
+19)

	)

170 
	#E0_DO
 (
E0_BASE
+20)

	)

171 
	#E0_F17
 (
E0_BASE
+21)

	)

172 
	#E0_KPMINPLUS
 (
E0_BASE
+22)

	)

174 
	#E1_PAUSE
 (
E0_BASE
+23)

	)

176 
	ge0_keys
[128] = {

180 0, 0, 0, 0, 
E0_KPENTER
, 
E0_RCTRL
, 0, 0,

183 0, 0, 0, 0, 0, 
E0_KPSLASH
, 0, 
E0_PRSCR
,

184 
E0_RALT
, 0, 0, 0, 0, 
E0_F13
, 
E0_F14
, 
E0_HELP
,

185 
E0_DO
, 
E0_F17
, 0, 0, 0, 0, 
E0_BREAK
, 
E0_HOME
,

186 
E0_UP
, 
E0_PGUP
, 0, 
E0_LEFT
, 0, 
E0_RIGHT
, 
E0_KPMINPLUS
, 
E0_END
,

187 
E0_DOWN
, 
E0_PGDN
, 
E0_INS
, 
E0_DEL
, 0, 0, 0, 0,

190 0, 0, 0, 0, 0, 0, 0, 
E0_MACRO
,

195 
	$keybßrd_š‹¼u±
(
št_±_»gs
)

197 
sÿncode
;

198 
´ev_sÿncode
 = 0;

199 
up_æag
;

200 
¿w_mode
;

202 
±_»gs
 = (±_»g *è
št_±_»gs
;

203 
	`£nd_cmd
(0xAD);

204 
	`kb_wa™
();

205 ià((
	`šb_p
(0x64è& 
kbd_»ad_mask
) != 0x01)

206 
’d_kbd_šŒ
;

207 
sÿncode
 = 
	`šb
(0x60);

208 
	`m¬k_bh
(
KEYBOARD_BH
);

209 ià(
sÿncode
 == 0xfa) {

210 
acknowËdge
 = 1;

211 
’d_kbd_šŒ
;

212 } ià(
sÿncode
 == 0xfe) {

213 
»£nd
 = 1;

214 
’d_kbd_šŒ
;

215 } ià(
sÿncode
 == 0) {

216 #ifdeà
KBD_REPORT_ERR


217 
	`´štk
("keyboard buffer overflow\n");

219 
’d_kbd_šŒ
;

220 } ià(
sÿncode
 == 0xff) {

221 #ifdeà
KBD_REPORT_ERR


222 
	`´štk
("keyboardƒrror\n");

224 
´ev_sÿncode
 = 0;

225 
’d_kbd_šŒ
;

227 
‰y
 = 
	`TTY_TABLE
(0);

228 
kbd
 = 
kbd_bË
 + 
fg_cÚsŞe
;

229 ià((
¿w_mode
 = 
	`vc_kbd_mode
(
kbd
,
VC_RAW
))) {

230 
	`put_queue
(
sÿncode
);

235 ià(
sÿncode
 == 0xe0 || scancode == 0xe1) {

236 
´ev_sÿncode
 = 
sÿncode
;

237 
’d_kbd_šŒ
;

243 
up_æag
 = (
sÿncode
 & 0200);

244 
sÿncode
 &= 0x7f;

246 ià(
´ev_sÿncode
) {

251 ià(
´ev_sÿncode
 != 0xe0) {

252 ià(
´ev_sÿncode
 =ğ0xe1 && 
sÿncode
 == 0x1d) {

253 
´ev_sÿncode
 = 0x100;

254 
’d_kbd_šŒ
;

255 } ià(
´ev_sÿncode
 =ğ0x100 && 
sÿncode
 == 0x45) {

256 
sÿncode
 = 
E1_PAUSE
;

257 
´ev_sÿncode
 = 0;

259 
	`´štk
("keyboard: unknownƒ1ƒscape sequence\n");

260 
´ev_sÿncode
 = 0;

261 
’d_kbd_šŒ
;

264 
´ev_sÿncode
 = 0;

278 ià(
sÿncode
 == 0x2a || scancode == 0x36)

279 
’d_kbd_šŒ
;

281 ià(
e0_keys
[
sÿncode
])

282 
sÿncode
 = 
e0_keys
[scancode];

283 ià(!
¿w_mode
) {

284 #ifdeà
KBD_REPORT_UNKN


285 
	`´štk
("keybßrd: unknowÀsÿncode0 %02x\n", 
sÿncode
);

287 
’d_kbd_šŒ
;

290 } ià(
sÿncode
 >ğ
E0_BASE
 && !
¿w_mode
) {

291 #ifdeà
KBD_REPORT_UNKN


292 
	`´štk
("keyboard: scancode (%02x)‚ot in„ange 00 - %2x\n",

293 
sÿncode
, 
E0_BASE
 - 1);

295 
’d_kbd_šŒ
;

306 ià(
up_æag
) {

307 
	`ş—r_b™
(
sÿncode
, 
key_down
);

308 
»p
 = 0;

310 
»p
 = 
	`£t_b™
(
sÿncode
, 
key_down
);

312 ià(
¿w_mode
)

313 
’d_kbd_šŒ
;

315 ià(
	`vc_kbd_mode
(
kbd
, 
VC_MEDIUMRAW
)) {

316 
	`put_queue
(
sÿncode
 + 
up_æag
);

317 
’d_kbd_šŒ
;

333 ià(!
»p
 ||

334 (
	`vc_kbd_mode
(
kbd
,
VC_REPEAT
è&& 
‰y
 &&

335 (
	`L_ECHO
(
‰y
è|| (
	`EMPTY
(&‰y->
£cÚd¬y
è&& EMPTY(&‰y->
»ad_q
)))))

337 
u_shÜt
 
key_code
;

338 
u_ch¬
 
ty³
;

341 
shiá_fš®
 = 
shiá_¡©e
 ^ 
kbd
->
lock¡©e
;

343 
key_code
 = 
key_m­
[
shiá_fš®
][
sÿncode
];

344 
ty³
 = 
	`KTYP
(
key_code
);

346 ià(
ty³
 =ğ
KT_LETTER
) {

347 
ty³
 = 
KT_LATIN
;

348 ià(
	`vc_kbd_Ëd
(
kbd
,
VC_CAPSLOCK
))

349 
key_code
 = 
key_m­
[
shiá_fš®
 ^ (1<<
KG_SHIFT
)][
sÿncode
];

351 (*
key_hªdËr
[
ty³
])(
key_code
 & 0xff, 
up_æag
);

354 
’d_kbd_šŒ
:

355 
	`£nd_cmd
(0xAE);

356 
	}
}

358 
	$put_queue
(
ch
)

360 
‰y_queue
 *
qp
;

362 
	`wake_up
(&
key´ess_wa™
);

363 ià(!
‰y
)

365 
qp
 = &
‰y
->
»ad_q
;

367 ià(
	`LEFT
(
qp
)) {

368 
qp
->
buf
[qp->
h—d
] = 
ch
;

369 
	`INC
(
qp
->
h—d
);

371 
	}
}

373 
	$puts_queue
(*
ı
)

375 
‰y_queue
 *
qp
;

376 
ch
;

379 
	`wake_up_š‹¼u±ibË
(&
key´ess_wa™
);

380 ià(!
‰y
)

382 
qp
 = &
‰y
->
»ad_q
;

384 (
ch
 = *(
ı
++)) != 0) {

385 ià(
	`LEFT
(
qp
)) {

386 
qp
->
buf
[qp->
h—d
] = 
ch
;

387 
	`INC
(
qp
->
h—d
);

390 
	}
}

392 
	$­¶key
(
key
, 
mode
)

394 
buf
[] = { 0x1b, 'O', 0x00, 0x00 };

396 
buf
[1] = (
mode
 ? 'O' : '[');

397 
buf
[2] = 
key
;

398 
	`puts_queue
(
buf
);

399 
	}
}

401 
	$’‹r
()

403 
	`put_queue
(13);

404 ià(
	`vc_kbd_mode
(
kbd
,
VC_CRLF
))

405 
	`put_queue
(10);

406 
	}
}

408 
	$ÿps_toggË
()

410 ià(
»p
)

412 
	`chg_vc_kbd_Ëd
(
kbd
,
VC_CAPSLOCK
);

413 
	}
}

415 
	$ÿps_Ú
()

417 ià(
»p
)

419 
	`£t_vc_kbd_Ëd
(
kbd
,
VC_CAPSLOCK
);

420 
	}
}

422 
	$show_±»gs
()

424 ià(!
±_»gs
)

426 
	`´štk
("\n");

427 
	`´štk
("EIP: %04x:%08lx",0xfffà& 
±_»gs
->
cs
,±_»gs->
e
);

428 ià(
±_»gs
->
cs
 & 3)

429 
	`´štk
(" ESP: %04x:%08lx",0xfffà& 
±_»gs
->
ss
,±_»gs->
e¥
);

430 
	`´štk
(" EFLAGS: %08lx\n",
±_»gs
->
eæags
);

431 
	`´štk
("EAX: %08lx EBX: %08lx ECX: %08lx EDX: %08lx\n",

432 
±_»gs
->
Üig_—x
,±_»gs->
ebx
,±_»gs->
ecx
,±_»gs->
edx
);

433 
	`´štk
("ESI: %08lx EDI: %08lx EBP: %08lx",

434 
±_»gs
->
esi
,…t_»gs->
edi
,…t_»gs->
ebp
);

435 
	`´štk
(" DS: %04x ES: %04x FS: %04x GS: %04x\n",

436 0xfffà& 
±_»gs
->
ds
,0xfffà&…t_»gs->
es
,

437 0xfffà& 
±_»gs
->
fs
,0xfffà&…t_»gs->
gs
);

438 
	}
}

440 
	$hŞd
()

442 ià(
»p
 || !
‰y
)

450 ià(
‰y
->
¡İ³d
)

451 
	`¡¬t_‰y
(
‰y
);

453 
	`¡İ_‰y
(
‰y
);

454 
	}
}

458 
	$·u£
()

460 
	`chg_vc_kbd_mode
(
kbd
,
VC_PAUSE
);

461 
	}
}

464 
	$num
()

466 ià(
	`vc_kbd_mode
(
kbd
,
VC_APPLIC
)) {

467 
	`­¶key
('P', 1);

470 ià(!
»p
)

471 
	`chg_vc_kbd_Ëd
(
kbd
,
VC_NUMLOCK
);

472 
	}
}

474 
	$Ï¡cÚs
()

477 
wªt_cÚsŞe
 = 
Ï¡_cÚsŞe
;

478 
	}
}

480 
	$£nd_šŒ
()

482 
gÙ_b»ak
 = 1;

483 
	}
}

485 
	$süÎ_fÜw
()

487 
	`süŞläÚt
(0);

488 
	}
}

490 
	$süÎ_back
()

492 
	`süŞlback
(0);

493 
	}
}

495 
	$boÙ_™
()

497 
	`ù¾_®t_d–
();

498 
	}
}

500 
	$compo£
()

502 
d—d_key_Ãxt
 = 1;

503 
	}
}

505 
	$do_¥ec
(
v®ue
, 
up_æag
)

507 (*
	tâp
)();

508 
âp
 
â_bË
[] = {

509 
NULL
, 
’‹r
, 
show_±»gs
, 
show_mem
,

510 
show_¡©e
, 
£nd_šŒ
, 
Ï¡cÚs
, 
ÿps_toggË
,

511 
num
, 
hŞd
, 
süÎ_fÜw
, 
süÎ_back
,

512 
boÙ_™
, 
ÿps_Ú
, 
compo£


515 ià(
up_æag
)

517 ià(
v®ue
 >ğ
	`SIZE
(
â_bË
))

519 ià(!
â_bË
[
v®ue
])

521 
â_bË
[
v®ue
]();

522 
	}
}

524 
	$do_low”ÿ£
(
v®ue
, 
up_æag
)

526 
	`´štk
("keyboard.c: do_lowercase was called - impossible\n");

527 
	}
}

529 
	$do_£lf
(
v®ue
, 
up_æag
)

531 ià(
up_æag
)

534 ià(
dŸü
)

535 
v®ue
 = 
	`hªdË_dŸü
(value);

537 ià(
d—d_key_Ãxt
) {

538 
d—d_key_Ãxt
 = 0;

539 
dŸü
 = 
v®ue
;

543 
	`put_queue
(
v®ue
);

544 
	}
}

546 
	#A_GRAVE
 '`'

	)

547 
	#A_ACUTE
 '\''

	)

548 
	#A_CFLEX
 '^'

	)

549 
	#A_TILDE
 '~'

	)

550 
	#A_DIAER
 '"'

	)

551 
	g»t_dŸü
[] =

552 {
A_GRAVE
, 
A_ACUTE
, 
A_CFLEX
, 
A_TILDE
, 
A_DIAER
 };

557 
	$do_d—d
(
v®ue
, 
up_æag
)

559 ià(
up_æag
)

562 
v®ue
 = 
»t_dŸü
[value];

563 ià(
dŸü
 =ğ
v®ue
) {

564 
dŸü
 = 0;

565 
	`put_queue
(
v®ue
);

568 
dŸü
 = 
v®ue
;

569 
	}
}

575 
	$hªdË_dŸü
(
ch
)

577 
d
 = 
dŸü
;

578 
i
;

580 
dŸü
 = 0;

581 ià(
ch
 == ' ')

582  
d
;

584 
i
 = 0; i < 
acûÁ_bË_size
; i++)

585 if(
acûÁ_bË
[
i
].
dŸü
 =ğ
d
 &&‡cûÁ_bË[i].
ba£
 =ğ
ch
)

586  
acûÁ_bË
[
i
].
»suÉ
;

588 
	`put_queue
(
d
);

589  
ch
;

590 
	}
}

592 
	$do_cÚs
(
v®ue
, 
up_æag
)

594 ià(
up_æag
)

596 
wªt_cÚsŞe
 = 
v®ue
;

597 
	}
}

599 
	$do_â
(
v®ue
, 
up_æag
)

601 ià(
up_æag
)

603 ià(
v®ue
 < 
	`SIZE
(
func_bË
))

604 
	`puts_queue
(
func_bË
[
v®ue
]);

606 
	`´štk
("do_â c®Ëd w™h v®ue=%d\n", 
v®ue
);

607 
	}
}

609 
	$do_·d
(
v®ue
, 
up_æag
)

611 *
·d_ch¬s
 = "0123456789+-*/\015,.?";

612 *
­p_m­
 = "pqrstuvwxylSRQMnn?";

614 ià(
up_æag
)

618 ià(
	`vc_kbd_mode
(
kbd
,
VC_APPLIC
è&& !
k_down
[
KG_SHIFT
]) {

619 
	`­¶key
(
­p_m­
[
v®ue
], 1);

623 ià(!
	`vc_kbd_Ëd
(
kbd
,
VC_NUMLOCK
))

624 
v®ue
) {

625 
	`KVAL
(
K_PCOMMA
):

626 
	`KVAL
(
K_PDOT
):

627 
	`do_â
(
	`KVAL
(
K_REMOVE
), 0);

629 
	`KVAL
(
K_P0
):

630 
	`do_â
(
	`KVAL
(
K_INSERT
), 0);

632 
	`KVAL
(
K_P1
):

633 
	`do_â
(
	`KVAL
(
K_SELECT
), 0);

635 
	`KVAL
(
K_P2
):

636 
	`do_cur
(
	`KVAL
(
K_DOWN
), 0);

638 
	`KVAL
(
K_P3
):

639 
	`do_â
(
	`KVAL
(
K_PGDN
), 0);

641 
	`KVAL
(
K_P4
):

642 
	`do_cur
(
	`KVAL
(
K_LEFT
), 0);

644 
	`KVAL
(
K_P6
):

645 
	`do_cur
(
	`KVAL
(
K_RIGHT
), 0);

647 
	`KVAL
(
K_P7
):

648 
	`do_â
(
	`KVAL
(
K_FIND
), 0);

650 
	`KVAL
(
K_P8
):

651 
	`do_cur
(
	`KVAL
(
K_UP
), 0);

653 
	`KVAL
(
K_P9
):

654 
	`do_â
(
	`KVAL
(
K_PGUP
), 0);

656 
	`KVAL
(
K_P5
):

657 
	`­¶key
('G', 
	`vc_kbd_mode
(
kbd
, 
VC_APPLIC
));

661 
	`put_queue
(
·d_ch¬s
[
v®ue
]);

662 ià(
v®ue
 =ğ
	`KVAL
(
K_PENTER
è&& 
	`vc_kbd_mode
(
kbd
, 
VC_CRLF
))

663 
	`put_queue
(10);

664 
	}
}

666 
	$do_cur
(
v®ue
, 
up_æag
)

668 *
cur_ch¬s
 = "BDCA";

669 ià(
up_æag
)

672 
	`­¶key
(
cur_ch¬s
[
v®ue
], 
	`vc_kbd_mode
(
kbd
,
VC_CKMODE
));

673 
	}
}

675 
	$do_shiá
(
v®ue
, 
up_æag
)

677 
Şd_¡©e
 = 
shiá_¡©e
;

679 ià(
»p
)

683 ià(
v®ue
 =ğ
	`KVAL
(
K_CAPSSHIFT
)) {

684 
v®ue
 = 
	`KVAL
(
K_SHIFT
);

685 
	`şr_vc_kbd_Ëd
(
kbd
, 
VC_CAPSLOCK
);

688 ià(
up_æag
) {

691 ià(
k_down
[
v®ue
])

692 
k_down
[
v®ue
]--;

694 
k_down
[
v®ue
]++;

696 ià(
k_down
[
v®ue
])

697 
shiá_¡©e
 |ğ(1 << 
v®ue
);

699 
shiá_¡©e
 &ğ~ (1 << 
v®ue
);

702 ià(
up_æag
 && 
shiá_¡©e
 !ğ
Şd_¡©e
 && 
Åadch
 != -1) {

703 
	`put_queue
(
Åadch
);

704 
Åadch
 = -1;

706 
	}
}

710 
	$compu‹_shiá¡©e
()

712 
i
, 
j
, 
k
, 
sym
, 
v®
;

714 
shiá_¡©e
 = 0;

715 
i
=0; i < 
	`SIZE
(
k_down
); i++)

716 
k_down
[
i
] = 0;

718 
i
=0; i < 
	`SIZE
(
key_down
); i++)

719 if(
key_down
[
i
]) {

720 
k
 = (
i
<<5);

721 
j
=0; j<32; j++,
k
++)

722 if(
	`‹¡_b™
(
k
, 
key_down
)) {

723 
sym
 = 
key_m­
[0][
k
];

724 if(
	`KTYP
(
sym
è=ğ
KT_SHIFT
) {

725 
v®
 = 
	`KVAL
(
sym
);

726 
k_down
[
v®
]++;

727 
shiá_¡©e
 |ğ(1<<
v®
);

731 
	}
}

733 
	$do_m‘a
(
v®ue
, 
up_æag
)

735 ià(
up_æag
)

738 ià(
	`vc_kbd_mode
(
kbd
, 
VC_META
)) {

739 
	`put_queue
('\033');

740 
	`put_queue
(
v®ue
);

742 
	`put_queue
(
v®ue
 | 0x80);

743 
	}
}

745 
	$do_ascii
(
v®ue
, 
up_æag
)

747 ià(
up_æag
)

750 ià(
Åadch
 == -1)

751 
Åadch
 = 
v®ue
;

753 
Åadch
 = (Åadch * 10 + 
v®ue
) % 1000;

754 
	}
}

756 
	$do_lock
(
v®ue
, 
up_æag
)

758 ià(
up_æag
 || 
»p
)

760 
	`chg_vc_kbd_lock
(
kbd
, 
v®ue
);

761 
	}
}

768 
	$£nd_d©a
(
d©a
)

770 
»Œ›s
 = 3;

771 
i
;

774 
	`kb_wa™
();

775 
acknowËdge
 = 0;

776 
»£nd
 = 0;

777 
	`outb_p
(
d©a
, 0x60);

778 
i
=0; i<0x20000; i++) {

779 
	`šb_p
(0x64);

780 ià(
acknowËdge
)

782 ià(
»£nd
)

785 ià(!
»£nd
)

787 } 
»Œ›s
-- > 0);

789 
	}
}

804 
	$kbd_bh
(* 
unu£d
)

806 
Şd_Ëds
 = 0xff;

807 
Ëds
 = 
kbd_bË
[
fg_cÚsŞe
].
Ëd¡©e
;

809 ià(
Ëds
 !ğ
Şd_Ëds
) {

810 
Şd_Ëds
 = 
Ëds
;

811 ià(!
	`£nd_d©a
(0xedè|| !£nd_d©a(
Ëds
))

812 
	`£nd_d©a
(0xf4);

814 ià(
wªt_cÚsŞe
 >= 0) {

815 ià(
wªt_cÚsŞe
 !ğ
fg_cÚsŞe
) {

816 
Ï¡_cÚsŞe
 = 
fg_cÚsŞe
;

817 
	`chªge_cÚsŞe
(
wªt_cÚsŞe
);

819 
wªt_cÚsŞe
 = -1;

821 ià(
gÙ_b»ak
) {

822 ià(
‰y
 && !
	`I_IGNBRK
(tty)) {

823 ià(
	`I_BRKINT
(
‰y
)) {

824 
	`æush_šput
(
‰y
);

825 
	`æush_ouut
(
‰y
);

826 ià(
‰y
->
pg½
 > 0)

827 
	`kl_pg
(
‰y
->
pg½
, 
SIGINT
, 1);

829 
	`şi
();

830 ià(
	`LEFT
(&
‰y
->
»ad_q
) >= 2) {

831 
	`£t_b™
(
‰y
->
»ad_q
.
h—d
,

832 &
‰y
->
»adq_æags
);

833 
	`put_queue
(
TTY_BREAK
);

834 
	`put_queue
(0);

836 
	`¡i
();

839 
gÙ_b»ak
 = 0;

841 
	`do_keybßrd_š‹¼u±
();

842 
	`şi
();

843 ià((
	`šb_p
(0x64è& 
kbd_»ad_mask
) == 0x01)

844 
	`çke_keybßrd_š‹¼u±
();

845 
	`¡i
();

846 
	}
}

848 
	gno_idt
[2] = {0, 0};

855 
	$h¬d_»£t_now
()

857 
i
, 
j
;

858 
pg0
[1024];

860 
	`¡i
();

862 
pg0
[0] = 7;

865 
i
=0; i<100; i++) {

866 
	`kb_wa™
();

867 
j
 = 0; j < 100000 ; j++)

869 
	`outb
(0xfe,0x64);

871 
	`__asm__
("\tlidt _no_idt");

873 
	}
}

875 
	$kbd_š™
(
kmem_¡¬t
)

877 
i
;

878 
kbd_¡ruù
 * 
kbd
;

880 
kbd
 = 
kbd_bË
 + 0;

881 
i
 = 0 ; i < 
NR_CONSOLES
 ; i++,
kbd
++) {

882 
kbd
->
Ëd¡©e
 = 
KBD_DEFLEDS
;

883 
kbd
->
deçuÉ_Ëd¡©e
 = 
KBD_DEFLEDS
;

884 
kbd
->
lock¡©e
 = 
KBD_DEFLOCK
;

885 
kbd
->
modeæags
 = 
KBD_DEFMODE
;

888 
bh_ba£
[
KEYBOARD_BH
].
routše
 = 
kbd_bh
;

889 
	`»que¡_œq
(
KEYBOARD_IRQ
,
keybßrd_š‹¼u±
);

890 
	`m¬k_bh
(
KEYBOARD_BH
);

891  
kmem_¡¬t
;

892 
	}
}

	@drivers/char/lp.c

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/majÜ.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/Í.h
>

14 
	~<lšux/m®loc.h
>

16 
	~<asm/io.h
>

17 
	~<asm/£gm’t.h
>

18 
	~<asm/sy¡em.h
>

25 #undeà
LP_DEBUG


27 
	$Í_»£t
(
mšÜ
)

29 
‹¡v®ue
;

30 
commªd
;

32 
commªd
 = 
LP_PSELECP
 | 
LP_PINITP
;

35 
	`outb_p
(0, 
	`LP_C
(
mšÜ
));

36 
‹¡v®ue
 = 0 ;e¡v®u< 
LP_DELAY
 ;estvalue++)

38 
	`outb_p
(
commªd
, 
	`LP_C
(
mšÜ
));

39  
	`LP_S
(
mšÜ
);

40 
	}
}

42 #ifdeà
LP_DEBUG


43 
	gÍ_max_couÁ
 = 1;

46 
	$Í_ch¬_pŞËd
(
Ích¬
, 
mšÜ
)

48 
¡©us
 = 0, 
wa™
 = 0;

49 
couÁ
 = 0;

52 
¡©us
 = 
	`LP_S
(
mšÜ
);

53 
couÁ
 ++;

54 if(
Ãed_»sched
)

55 
	`scheduË
();

56 } !(
¡©us
 & 
LP_PBUSY
è&& 
couÁ
 < 
	`LP_CHAR
(
mšÜ
));

58 ià(
couÁ
 =ğ
	`LP_CHAR
(
mšÜ
)) {

62 #ifdeà
LP_DEBUG


63 ià(
couÁ
 > 
Í_max_couÁ
) {

64 
	`´štk
("Í sucûs aá” %d couÁs.\n",
couÁ
);

65 
Í_max_couÁ
=
couÁ
;

68 
	`outb_p
(
Ích¬
, 
	`LP_B
(
mšÜ
));

71 
wa™
 !ğ
	`LP_WAIT
(
mšÜ
)) wait++;

73 
	`outb_p
(Ğ
LP_PSELECP
 | 
LP_PINITP
 | 
LP_PSTROBE
 ), ( 
	`LP_C
Ğ
mšÜ
 )));

74 
wa™
) wait--;

76 
	`outb_p
(Ğ
LP_PSELECP
 | 
LP_PINITP
 ), ( 
	`LP_C
Ğ
mšÜ
 )));

79 
	}
}

81 
	$Í_ch¬_š‹¼u±
(
Ích¬
, 
mšÜ
)

83 
wa™
 = 0;

84 
¡©us
;

87 ià(!((
¡©us
 = 
	`LP_S
(
mšÜ
)è& 
LP_PACK
è|| (¡©u & 
LP_PBUSY
)

88 || !((
¡©us
 = 
	`LP_S
(
mšÜ
)è& 
LP_PACK
è|| (¡©u & 
LP_PBUSY
)

89 || !((
¡©us
 = 
	`LP_S
(
mšÜ
)è& 
LP_PACK
è|| (¡©u & 
LP_PBUSY
)) {

91 
	`outb_p
(
Ích¬
, 
	`LP_B
(
mšÜ
));

94 
wa™
 !ğ
	`LP_WAIT
(
mšÜ
)) wait++;

96 
	`outb_p
(Ğ
LP_PSELECP
 | 
LP_PINITP
 | 
LP_PSTROBE
 ), ( 
	`LP_C
Ğ
mšÜ
 )));

97 
wa™
) wait--;

99 
	`outb_p
(Ğ
LP_PSELECP
 | 
LP_PINITP
 ), ( 
	`LP_C
Ğ
mšÜ
 )));

104 
	}
}

106 #ifdeà
LP_DEBUG


107 
	gÍ_tÙ®_ch¬s
 = 0;

108 
	gÍ_Ï¡_ÿÎ
 = 0;

111 
	$Í_š‹¼u±
(
œq
)

113 
Í_¡ruù
 *
Í
 = &
Í_bË
[0];

114 
Í_¡ruù
 *
Í_’d
 = &
Í_bË
[
LP_NO
];

116 
œq
 !ğ
Í
->irq) {

117 ià(++
Í
 >ğ
Í_’d
)

121 
	`wake_up
(&
Í
->
Í_wa™_q
);

122 
	}
}

124 
	$Í_wr™e_š‹¼u±
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

126 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

127 
cİy_size
;

128 
tÙ®_by‹s_wr™‹n
 = 0;

129 
by‹s_wr™‹n
;

130 
Í_¡ruù
 *
Í
 = &
Í_bË
[
mšÜ
];

131 
¡©us
;

134 
by‹s_wr™‹n
 = 0;

135 
cİy_size
 = (
couÁ
 <ğ
LP_BUFFER_SIZE
 ? count : LP_BUFFER_SIZE);

136 
	`memıy_äomfs
(
Í
->
Í_bufãr
, 
buf
, 
cİy_size
);

138 
cİy_size
) {

139 ià(
	`Í_ch¬_š‹¼u±
(
Í
->
Í_bufãr
[
by‹s_wr™‹n
], 
mšÜ
)) {

140 --
cİy_size
;

141 ++
by‹s_wr™‹n
;

143 ià(!((
¡©us
 = 
	`LP_S
(
mšÜ
)è& 
LP_PERRORP
)) {

144 
rc
 = 
tÙ®_by‹s_wr™‹n
 + 
by‹s_wr™‹n
;

146 ià((
¡©us
 & 
LP_POUTPA
)) {

147 
	`´štk
("Í%d ouˆoà·³r\n", 
mšÜ
);

148 ià(!
rc
)

149 
rc
 = -
ENOSPC
;

150 } ià(!(
¡©us
 & 
LP_PSELECD
)) {

151 
	`´štk
("Í%d off-lše\n", 
mšÜ
);

152 ià(!
rc
)

153 
rc
 = -
EIO
;

155 
	`´štk
("Í%d…rš‹¸”rÜ\n", 
mšÜ
);

156 ià(!
rc
)

157 
rc
 = -
EIO
;

159 if(
	`LP_F
(
mšÜ
è& 
LP_ABORT
)

160  
rc
;

162 
	`şi
();

163 
	`outb_p
((
LP_PSELECP
|
LP_PINITP
|
LP_PINTEN
), (
	`LP_C
(
mšÜ
)));

164 
¡©us
 = 
	`LP_S
(
mšÜ
);

165 ià(!(
¡©us
 & 
LP_PACK
è|| (¡©u & 
LP_PBUSY
)) {

166 
	`outb_p
((
LP_PSELECP
|
LP_PINITP
), (
	`LP_C
(
mšÜ
)));

167 
	`¡i
();

170 
cu¼’t
->
timeout
 = 
jiff›s
 + 
LP_TIMEOUT_INTERRUPT
;

171 
	`š‹¼u±ibË_¦“p_Ú
(&
Í
->
Í_wa™_q
);

172 
	`outb_p
((
LP_PSELECP
|
LP_PINITP
), (
	`LP_C
(
mšÜ
)));

173 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

174 ià(
tÙ®_by‹s_wr™‹n
 + 
by‹s_wr™‹n
)

175  
tÙ®_by‹s_wr™‹n
 + 
by‹s_wr™‹n
;

177  -
EINTR
;

182 
tÙ®_by‹s_wr™‹n
 +ğ
by‹s_wr™‹n
;

183 
buf
 +ğ
by‹s_wr™‹n
;

184 
couÁ
 -ğ
by‹s_wr™‹n
;

186 } 
couÁ
 > 0);

188  
tÙ®_by‹s_wr™‹n
;

189 
	}
}

191 
	$Í_wr™e_pŞËd
(
šode
 * inode, 
fe
 * file,

192 * 
buf
, 
couÁ
)

194 
»tv®
;

195 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

196 
c
, *
‹mp
 = 
buf
;

198 #ifdeà
LP_DEBUG


199 ià(
jiff›s
-
Í_Ï¡_ÿÎ
 > 
	`LP_TIME
(
mšÜ
)) {

200 
Í_tÙ®_ch¬s
 = 0;

201 
Í_max_couÁ
 = 1;

203 
Í_Ï¡_ÿÎ
 = 
jiff›s
;

206 
‹mp
 = 
buf
;

207 
couÁ
 > 0) {

208 
c
 = 
	`g‘_fs_by‹
(
‹mp
);

209 
»tv®
 = 
	`Í_ch¬_pŞËd
(
c
, 
mšÜ
);

211 ià(
»tv®
è{ 
couÁ
--; 
‹mp
++;

212 #ifdeà
LP_DEBUG


213 
Í_tÙ®_ch¬s
++;

216 ià(!
»tv®
) {

217 
¡©us
 = 
	`LP_S
(
mšÜ
);

219 ià(
¡©us
 & 
LP_POUTPA
) {

220 
	`´štk
("Í%d ouˆoà·³r\n", 
mšÜ
);

221 if(
	`LP_F
(
mšÜ
è& 
LP_ABORT
)

222  
‹mp
-
buf
?‹mp-buf:-
ENOSPC
;

223 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

224 
cu¼’t
->
timeout
 = 
jiff›s
 + 
LP_TIMEOUT_POLLED
;

225 
	`scheduË
();

227 ià(!(
¡©us
 & 
LP_PSELECD
)) {

228 
	`´štk
("Í%d off-lše\n", 
mšÜ
);

229 if(
	`LP_F
(
mšÜ
è& 
LP_ABORT
)

230  
‹mp
-
buf
?‹mp-buf:-
EIO
;

231 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

232 
cu¼’t
->
timeout
 = 
jiff›s
 + 
LP_TIMEOUT_POLLED
;

233 
	`scheduË
();

236 ià(!(
¡©us
 & 
LP_PERRORP
)) {

237 
	`´štk
("Í%d oÀfœe\n", 
mšÜ
);

238 if(
	`LP_F
(
mšÜ
è& 
LP_ABORT
)

239  
‹mp
-
buf
?‹mp-buf:-
EFAULT
;

240 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

241 
cu¼’t
->
timeout
 = 
jiff›s
 + 
LP_TIMEOUT_POLLED
;

242 
	`scheduË
();

246 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

247 ià(
‹mp
 !ğ
buf
)

248  
‹mp
-
buf
;

250  -
EINTR
;

252 #ifdeà
LP_DEBUG


253 
	`´štk
("lp sleeping‡t %d characters for %d jiffies\n",

254 
Í_tÙ®_ch¬s
, 
	`LP_TIME
(
mšÜ
));

255 
Í_tÙ®_ch¬s
=0;

257 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

258 
cu¼’t
->
timeout
 = 
jiff›s
 + 
	`LP_TIME
(
mšÜ
);

259 
	`scheduË
();

262  
‹mp
-
buf
;

263 
	}
}

265 
	$Í_wr™e
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

267 ià(
	`LP_IRQ
(
	`MINOR
(
šode
->
i_rdev
)))

268  
	`Í_wr™e_š‹¼u±
(
šode
, 
fe
, 
buf
, 
couÁ
);

270  
	`Í_wr™e_pŞËd
(
šode
, 
fe
, 
buf
, 
couÁ
);

271 
	}
}

273 
	$Í_l£ek
(
šode
 * inode, 
fe
 * file,

274 
off_t
 
off£t
, 
Üigš
)

276  -
ESPIPE
;

277 
	}
}

279 
	$Í_İ’
(
šode
 * inode, 
fe
 * file)

281 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

282 
»t
;

283 
œq
;

284 
sigaùiÚ
 
§
;

286 ià(
mšÜ
 >ğ
LP_NO
)

287  -
ENODEV
;

288 ià((
	`LP_F
(
mšÜ
è& 
LP_EXIST
) == 0)

289  -
ENODEV
;

290 ià(
	`LP_F
(
mšÜ
è& 
LP_BUSY
)

291  -
EBUSY
;

293 ià((
œq
 = 
	`LP_IRQ
(
mšÜ
))) {

294 
Í_bË
[
mšÜ
].
Í_bufãr
 = (*è
	`km®loc
(
LP_BUFFER_SIZE
, 
GFP_KERNEL
);

295 ià(!
Í_bË
[
mšÜ
].
Í_bufãr
)

296  -
ENOMEM
;

298 
§
.
§_hªdËr
 = 
Í_š‹¼u±
;

299 
§
.
§_æags
 = 
SA_INTERRUPT
;

300 
§
.
§_mask
 = 0;

301 
§
.
§_»¡Ü”
 = 
NULL
;

302 
»t
 = 
	`œqaùiÚ
(
œq
, &
§
);

303 ià(
»t
) {

304 
	`kä“_s
(
Í_bË
[
mšÜ
].
Í_bufãr
, 
LP_BUFFER_SIZE
);

305 
Í_bË
[
mšÜ
].
Í_bufãr
 = 
NULL
;

306 
	`´štk
("Í%d uÇbËØu£ iÁ”ru± %d,ƒ¼Ü %d\n", 
mšÜ
, 
œq
, 
»t
);

307  
»t
;

311 
	`LP_F
(
mšÜ
è|ğ
LP_BUSY
;

314 
	}
}

316 
	$Í_»Ëa£
(
šode
 * inode, 
fe
 * file)

318 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

319 
œq
;

321 ià((
œq
 = 
	`LP_IRQ
(
mšÜ
))) {

322 
	`ä“_œq
(
œq
);

323 
	`kä“_s
(
Í_bË
[
mšÜ
].
Í_bufãr
, 
LP_BUFFER_SIZE
);

324 
Í_bË
[
mšÜ
].
Í_bufãr
 = 
NULL
;

327 
	`LP_F
(
mšÜ
è&ğ~
LP_BUSY
;

328 
	}
}

331 
	$Í_ioùl
(
šode
 *šode, 
fe
 *file,

332 
cmd
, 
¬g
)

334 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

335 
»tv®
 = 0;

337 #ifdeà
LP_DEBUG


338 
	`´štk
("Í%d ioùl, cmd: 0x%x,‡rg: 0x%x\n", 
mšÜ
, 
cmd
, 
¬g
);

340 ià(
mšÜ
 >ğ
LP_NO
)

341  -
ENODEV
;

342 ià((
	`LP_F
(
mšÜ
è& 
LP_EXIST
) == 0)

343  -
ENODEV
;

344  
cmd
 ) {

345 
LPTIME
:

346 
	`LP_TIME
(
mšÜ
èğ
¬g
;

348 
LPCHAR
:

349 
	`LP_CHAR
(
mšÜ
èğ
¬g
;

351 
LPABORT
:

352 ià(
¬g
)

353 
	`LP_F
(
mšÜ
è|ğ
LP_ABORT
;

355 
	`LP_F
(
mšÜ
è&ğ~
LP_ABORT
;

357 
LPWAIT
:

358 
	`LP_WAIT
(
mšÜ
èğ
¬g
;

360 
LPSETIRQ
: {

361 
Şdœq
;

362 
Ãwœq
 = 
¬g
;

363 
Í_¡ruù
 *
Í
 = &
Í_bË
[
mšÜ
];

364 
sigaùiÚ
 
§
;

366 ià(!
	`su£r
())

367  -
EPERM
;

369 
Şdœq
 = 
	`LP_IRQ
(
mšÜ
);

372 ià(!
Şdœq
 && 
Ãwœq
) {

373 
Í
->
Í_bufãr
 = (*è
	`km®loc
(
LP_BUFFER_SIZE
, 
GFP_KERNEL
);

374 ià(!
Í
->
Í_bufãr
)

375  -
ENOMEM
;

378 ià(
Şdœq
) {

379 
	`ä“_œq
(
Şdœq
);

381 ià(
Ãwœq
) {

383 
§
.
§_hªdËr
 = 
Í_š‹¼u±
;

384 
§
.
§_æags
 = 
SA_INTERRUPT
;

385 
§
.
§_mask
 = 0;

386 
§
.
§_»¡Ü”
 = 
NULL
;

387 ià((
»tv®
 = 
	`œqaùiÚ
(
Ãwœq
, &
§
))) {

388 ià(
Şdœq
) {

390 
	`œqaùiÚ
(
Şdœq
, &
§
);

393 
	`kä“_s
(
Í
->
Í_bufãr
, 
LP_BUFFER_SIZE
);

394 
Í
->
Í_bufãr
 = 
NULL
;

396  
»tv®
;

399 ià(
Şdœq
 && !
Ãwœq
) {

401 
	`kä“_s
(
Í
->
Í_bufãr
, 
LP_BUFFER_SIZE
);

402 
Í
->
Í_bufãr
 = 
NULL
;

404 
	`LP_IRQ
(
mšÜ
èğ
Ãwœq
;

405 
	`Í_»£t
(
mšÜ
);

408 
LPGETIRQ
:

409 
»tv®
 = 
	`LP_IRQ
(
mšÜ
);

412 
»tv®
 = -
EINVAL
;

414  
»tv®
;

415 
	}
}

418 
fe_İ”©iÚs
 
	gÍ_fİs
 = {

419 
Í_l£ek
,

420 
NULL
,

421 
Í_wr™e
,

422 
NULL
,

423 
NULL
,

424 
Í_ioùl
,

425 
NULL
,

426 
Í_İ’
,

427 
Í_»Ëa£


430 
	$Í_š™
(
kmem_¡¬t
)

432 
off£t
 = 0;

433 
‹¡v®ue
 = 0;

434 
couÁ
 = 0;

436 ià(
	`»gi¡”_chrdev
(
LP_MAJOR
,"Í",&
Í_fİs
)) {

437 
	`´štk
("uÇbËØg‘ majÜ %d fÜ†š´š‹r\n", 
LP_MAJOR
);

438  
kmem_¡¬t
;

441 
off£t
 = 0; off£ˆ< 
LP_NO
; offset++) {

443 
	`outb_p
Ğ
LP_DUMMY
, 
	`LP_B
(
off£t
));

444 
‹¡v®ue
 = 0 ;e¡v®u< 
LP_DELAY
 ;estvalue++)

446 
‹¡v®ue
 = 
	`šb_p
(
	`LP_B
(
off£t
));

447 ià(
‹¡v®ue
 != 255) {

448 
	`LP_F
(
off£t
è|ğ
LP_EXIST
;

449 
	`Í_»£t
(
off£t
);

450 
	`´štk
("Í_š™:†p%dƒxi¡ (%d), ", 
off£t
, 
‹¡v®ue
);

451 ià(
	`LP_IRQ
(
off£t
))

452 
	`´štk
("usšg IRQ%d\n", 
	`LP_IRQ
(
off£t
));

454 
	`´štk
("using…olling driver\n");

455 
couÁ
++;

458 ià(
couÁ
 == 0)

459 
	`´štk
("lp_init:‚o†p devices found\n");

460  
kmem_¡¬t
;

461 
	}
}

	@drivers/char/mem.c

7 
	~<lšux/cÚfig.h
>

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/majÜ.h
>

13 
	~<lšux/‰y.h
>

14 
	~<lšux/mou£.h
>

15 
	~<lšux/qic02.h
>

16 
	~<lšux/m®loc.h
>

17 
	~<lšux/mmª.h
>

19 
	~<asm/£gm’t.h
>

20 
	~<asm/io.h
>

22 #ifdeà
CONFIG_SOUND


23 
soundÿrd_š™
(
mem_¡¬t
);

26 
	$»ad_¿m
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

28  -
EIO
;

29 
	}
}

31 
	$wr™e_¿m
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

33  -
EIO
;

34 
	}
}

36 
	$»ad_mem
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

38 
p
 = 
fe
->
f_pos
;

39 
»ad
;

41 ià(
couÁ
 < 0)

42  -
EINVAL
;

43 ià(
p
 >ğ
high_memÜy
)

45 ià(
couÁ
 > 
high_memÜy
 - 
p
)

46 
couÁ
 = 
high_memÜy
 - 
p
;

47 
»ad
 = 0;

48 
p
 < 
PAGE_SIZE
 && 
couÁ
 > 0) {

49 
	`put_fs_by‹
(0,
buf
);

50 
buf
++;

51 
p
++;

52 
couÁ
--;

53 
»ad
++;

55 
	`memıy_tofs
(
buf
,(*è
p
,
couÁ
);

56 
»ad
 +ğ
couÁ
;

57 
fe
->
f_pos
 +ğ
»ad
;

58  
»ad
;

59 
	}
}

61 
	$wr™e_mem
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

63 
p
 = 
fe
->
f_pos
;

64 
wr™‹n
;

66 ià(
couÁ
 < 0)

67  -
EINVAL
;

68 ià(
p
 >ğ
high_memÜy
)

70 ià(
couÁ
 > 
high_memÜy
 - 
p
)

71 
couÁ
 = 
high_memÜy
 - 
p
;

72 
wr™‹n
 = 0;

73 
p
 < 
PAGE_SIZE
 && 
couÁ
 > 0) {

75 
buf
++;

76 
p
++;

77 
couÁ
--;

78 
wr™‹n
++;

80 
	`memıy_äomfs
((*è
p
,
buf
,
couÁ
);

81 
wr™‹n
 +ğ
couÁ
;

82 
fe
->
f_pos
 +ğ
wr™‹n
;

83  
couÁ
;

84 
	}
}

86 
	$mm­_mem
(
šode
 * inode, 
fe
 * file,

87 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
)

89 
vm_¬—_¡ruù
 * 
m²t
;

91 ià(
off
 & 0xffà|| ofà+ 
Ën
 < off)

92  -
ENXIO
;

93 ià(
x86
 > 3 && 
off
 >ğ
high_memÜy
)

94 
´Ù
 |ğ
PAGE_PCD
;

95 ià(
	`»m­_·ge_¿nge
(
addr
, 
off
, 
Ën
, 
´Ù
))

96  -
EAGAIN
;

98 
m²t
 = (
vm_¬—_¡ruù
 * ) 
	`km®loc
((vm_¬—_¡ruù), 
GFP_KERNEL
);

99 ià(!
m²t
)

102 
m²t
->
vm_sk
 = 
cu¼’t
;

103 
m²t
->
vm_¡¬t
 = 
addr
;

104 
m²t
->
vm_’d
 = 
addr
 + 
Ën
;

105 
m²t
->
vm_·ge_´Ù
 = 
´Ù
;

106 
m²t
->
vm_sh¬e
 = 
NULL
;

107 
m²t
->
vm_šode
 = 
šode
;

108 
šode
->
i_couÁ
++;

109 
m²t
->
vm_off£t
 = 
off
;

110 
m²t
->
vm_İs
 = 
NULL
;

111 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

112 
	`m”ge_£gm’ts
(
cu¼’t
->
mm­
, 
NULL
, NULL);

114 
	}
}

116 
	$»ad_kmem
(
šode
 *šode, 
fe
 *fe, *
buf
, 
couÁ
)

118 
»ad1
, 
»ad2
;

120 
»ad1
 = 
	`»ad_mem
(
šode
, 
fe
, 
buf
, 
couÁ
);

121 ià(
»ad1
 < 0)

122  
»ad1
;

123 
»ad2
 = 
	`v»ad
(
buf
 + 
»ad1
, (*è
fe
->
f_pos
, 
couÁ
 -„ead1);

124 ià(
»ad2
 < 0)

125  
»ad2
;

126 
fe
->
f_pos
 +ğ
»ad2
;

127  
»ad1
 + 
»ad2
;

128 
	}
}

130 
	$»ad_pÜt
(
šode
 * inode,
fe
 * fe,* 
buf
, 
couÁ
)

132 
i
 = 
fe
->
f_pos
;

133 * 
tmp
 = 
buf
;

135 
couÁ
-- > 0 && 
i
 < 65536) {

136 
	`put_fs_by‹
(
	`šb
(
i
),
tmp
);

137 
i
++;

138 
tmp
++;

140 
fe
->
f_pos
 = 
i
;

141  
tmp
-
buf
;

142 
	}
}

144 
	$wr™e_pÜt
(
šode
 * inode,
fe
 * fe,* 
buf
, 
couÁ
)

146 
i
 = 
fe
->
f_pos
;

147 * 
tmp
 = 
buf
;

149 
couÁ
-- > 0 && 
i
 < 65536) {

150 
	`outb
(
	`g‘_fs_by‹
(
tmp
),
i
);

151 
i
++;

152 
tmp
++;

154 
fe
->
f_pos
 = 
i
;

155  
tmp
-
buf
;

156 
	}
}

158 
	$»ad_nuÎ
(
šode
 * 
node
,
fe
 * fe,* 
buf
,
couÁ
)

161 
	}
}

163 
	$wr™e_nuÎ
(
šode
 * inode,
fe
 * fe,* 
buf
, 
couÁ
)

165  
couÁ
;

166 
	}
}

168 
	$»ad_z”o
(
šode
 * 
node
,
fe
 * fe,* 
buf
,
couÁ
)

170 
Ëá
;

172 
Ëá
 = 
couÁ
;†eft > 0;†eft--) {

173 
	`put_fs_by‹
(0,
buf
);

174 
buf
++;

176  
couÁ
;

177 
	}
}

179 
	$mm­_z”o
(
šode
 * inode, 
fe
 * file,

180 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
)

182 
vm_¬—_¡ruù
 *
m²t
;

184 ià(
´Ù
 & 
PAGE_RW
)

185  -
EINVAL
;

186 ià(
	`z”om­_·ge_¿nge
(
addr
, 
Ën
, 
´Ù
))

187  -
EAGAIN
;

192 
m²t
 = (
vm_¬—_¡ruù
 *)
	`km®loc
((*m²t), 
GFP_KERNEL
);

193 ià(!
m²t
)

196 
m²t
->
vm_sk
 = 
cu¼’t
;

197 
m²t
->
vm_¡¬t
 = 
addr
;

198 
m²t
->
vm_’d
 = 
addr
 + 
Ën
;

199 
m²t
->
vm_·ge_´Ù
 = 
´Ù
;

200 
m²t
->
vm_sh¬e
 = 
NULL
;

201 
m²t
->
vm_šode
 = 
NULL
;

202 
m²t
->
vm_off£t
 = 
off
;

203 
m²t
->
vm_İs
 = 
NULL
;

204 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

205 
	`m”ge_£gm’ts
(
cu¼’t
->
mm­
, 
ignoff_m”g•
, 
šode
);

207 
	}
}

209 
	$»ad_fuÎ
(
šode
 * 
node
,
fe
 * fe,* 
buf
,
couÁ
)

211  
couÁ
;

212 
	}
}

214 
	$wr™e_fuÎ
(
šode
 * inode,
fe
 * fe,* 
buf
, 
couÁ
)

216  -
ENOSPC
;

217 
	}
}

224 
	$nuÎ_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üig
)

226  
fe
->
f_pos
=0;

227 
	}
}

236 
	$memÜy_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üig
)

238 
Üig
) {

240 
fe
->
f_pos
 = 
off£t
;

241  
fe
->
f_pos
;

243 
fe
->
f_pos
 +ğ
off£t
;

244  
fe
->
f_pos
;

246  -
EINVAL
;

248 ià(
fe
->
f_pos
 < 0)

250  
fe
->
f_pos
;

251 
	}
}

253 
	#wr™e_kmem
 
wr™e_mem


	)

254 
	#mm­_kmem
 
mm­_mem


	)

255 
	#z”o_l£ek
 
nuÎ_l£ek


	)

256 
	#wr™e_z”o
 
wr™e_nuÎ


	)

258 
fe_İ”©iÚs
 
	g¿m_fİs
 = {

259 
memÜy_l£ek
,

260 
»ad_¿m
,

261 
wr™e_¿m
,

262 
NULL
,

263 
NULL
,

264 
NULL
,

265 
NULL
,

266 
NULL
,

267 
NULL
,

268 
NULL


271 
fe_İ”©iÚs
 
	gmem_fİs
 = {

272 
memÜy_l£ek
,

273 
»ad_mem
,

274 
wr™e_mem
,

275 
NULL
,

276 
NULL
,

277 
NULL
,

278 
mm­_mem
,

279 
NULL
,

280 
NULL
,

281 
NULL


284 
fe_İ”©iÚs
 
	gkmem_fİs
 = {

285 
memÜy_l£ek
,

286 
»ad_kmem
,

287 
wr™e_kmem
,

288 
NULL
,

289 
NULL
,

290 
NULL
,

291 
mm­_kmem
,

292 
NULL
,

293 
NULL
,

294 
NULL


297 
fe_İ”©iÚs
 
	gnuÎ_fİs
 = {

298 
nuÎ_l£ek
,

299 
»ad_nuÎ
,

300 
wr™e_nuÎ
,

301 
NULL
,

302 
NULL
,

303 
NULL
,

304 
NULL
,

305 
NULL
,

306 
NULL
,

307 
NULL


310 
fe_İ”©iÚs
 
	gpÜt_fİs
 = {

311 
memÜy_l£ek
,

312 
»ad_pÜt
,

313 
wr™e_pÜt
,

314 
NULL
,

315 
NULL
,

316 
NULL
,

317 
NULL
,

318 
NULL
,

319 
NULL
,

320 
NULL


323 
fe_İ”©iÚs
 
	gz”o_fİs
 = {

324 
z”o_l£ek
,

325 
»ad_z”o
,

326 
wr™e_z”o
,

327 
NULL
,

328 
NULL
,

329 
NULL
,

330 
mm­_z”o
,

331 
NULL
,

332 
NULL


335 
fe_İ”©iÚs
 
	gfuÎ_fİs
 = {

336 
memÜy_l£ek
,

337 
»ad_fuÎ
,

338 
wr™e_fuÎ
,

339 
NULL
,

340 
NULL
,

341 
NULL
,

342 
NULL
,

343 
NULL
,

344 
NULL


347 
	$memÜy_İ’
(
šode
 * inode, 
fe
 * 
fp
)

349 
	`MINOR
(
šode
->
i_rdev
)) {

351 
fp
->
f_İ
 = &
¿m_fİs
;

354 
fp
->
f_İ
 = &
mem_fİs
;

357 
fp
->
f_İ
 = &
kmem_fİs
;

360 
fp
->
f_İ
 = &
nuÎ_fİs
;

363 
fp
->
f_İ
 = &
pÜt_fİs
;

366 
fp
->
f_İ
 = &
z”o_fİs
;

369 
fp
->
f_İ
 = &
fuÎ_fİs
;

372  -
ENODEV
;

374 ià(
fp
->
f_İ
 && fp->f_İ->
İ’
)

375  
fp
->
f_İ
->
	`İ’
(
šode
,filp);

377 
	}
}

379 
fe_İ”©iÚs
 
	gmemÜy_fİs
 = {

380 
NULL
,

381 
NULL
,

382 
NULL
,

383 
NULL
,

384 
NULL
,

385 
NULL
,

386 
NULL
,

387 
memÜy_İ’
,

388 
NULL
,

389 
NULL


392 #ifdeà
CONFIG_FTAPE


393 * 
	gá­e_big_bufãr
;

396 
	$chr_dev_š™
(
mem_¡¬t
, 
mem_’d
)

398 ià(
	`»gi¡”_chrdev
(
MEM_MAJOR
,"mem",&
memÜy_fİs
))

399 
	`´štk
("uÇbËØg‘ majÜ %d fÜ memÜy devs\n", 
MEM_MAJOR
);

400 
mem_¡¬t
 = 
	`‰y_š™
(mem_start);

401 #ifdeà
CONFIG_PRINTER


402 
mem_¡¬t
 = 
	`Í_š™
(mem_start);

404 #ià
	`defšed
 (
CONFIG_BUSMOUSE
è|| defšed (
CONFIG_82C710_MOUSE
) || \

405 
	`defšed
 (
CONFIG_PSMOUSE
è|| defšed (
CONFIG_MS_BUSMOUSE
) || \

406 
	`defšed
 (
CONFIG_ATIXL_BUSMOUSE
)

407 
mem_¡¬t
 = 
	`mou£_š™
(mem_start);

409 #ifdeà
CONFIG_SOUND


410 
mem_¡¬t
 = 
	`soundÿrd_š™
(mem_start);

412 #ià
CONFIG_TAPE_QIC02


413 
mem_¡¬t
 = 
	`³_qic02_š™
(mem_start);

418 #ifdeà
CONFIG_FTAPE


420 
á­e_big_bufãr
ğ(*è((
mem_¡¬t
 + 0x7fff) & ~0x7fff);

421 
	`´štk
( "ftape:‡llocated %d buffers‡lligned‡t: %p\n",

422 
NR_FTAPE_BUFFERS
, 
á­e_big_bufãr
);

423 
mem_¡¬t
 = (è
á­e_big_bufãr
 + 
NR_FTAPE_BUFFERS
 * 0x8000;

425  
mem_¡¬t
;

426 
	}
}

	@drivers/char/mouse.c

17 
	~<lšux/fs.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/mou£.h
>

20 
	~<lšux/cÚfig.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/majÜ.h
>

28 
fe_İ”©iÚs
 
bus_mou£_fİs
;

29 
fe_İ”©iÚs
 
p§ux_fİs
;

30 
fe_İ”©iÚs
 
ms_bus_mou£_fİs
;

31 
fe_İ”©iÚs
 
©ixl_busmou£_fİs
;

33 
bus_mou£_š™
();

34 
p§ux_š™
();

35 
ms_bus_mou£_š™
();

36 
©ixl_busmou£_š™
();

38 
	$mou£_İ’
(
šode
 * inode, 
fe
 * file)

40 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

42 
mšÜ
) {

43 #ifdeà
CONFIG_BUSMOUSE


44 
BUSMOUSE_MINOR
:

45 
fe
->
f_İ
 = &
bus_mou£_fİs
;

48 #ià
defšed
 
CONFIG_PSMOUSE
 || defšed 
CONFIG_82C710_MOUSE


49 
PSMOUSE_MINOR
:

50 
fe
->
f_İ
 = &
p§ux_fİs
;

53 #ifdeà
CONFIG_MS_BUSMOUSE


54 
MS_BUSMOUSE_MINOR
:

55 
fe
->
f_İ
 = &
ms_bus_mou£_fİs
;

58 #ifdeà
CONFIG_ATIXL_BUSMOUSE


59 
ATIXL_BUSMOUSE_MINOR
:

60 
fe
->
f_İ
 = &
©ixl_busmou£_fİs
;

64  -
ENODEV
;

66  
fe
->
f_İ
->
	`İ’
(
šode
,file);

67 
	}
}

69 
fe_İ”©iÚs
 
	gmou£_fİs
 = {

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
mou£_İ’
,

78 
NULL


81 
	$mou£_š™
(
kmem_¡¬t
)

83 #ifdeà
CONFIG_BUSMOUSE


84 
kmem_¡¬t
 = 
	`bus_mou£_š™
(kmem_start);

86 #ià
defšed
 
CONFIG_PSMOUSE
 || defšed 
CONFIG_82C710_MOUSE


87 
kmem_¡¬t
 = 
	`p§ux_š™
(kmem_start);

89 #ifdeà
CONFIG_MS_BUSMOUSE


90 
kmem_¡¬t
 = 
	`ms_bus_mou£_š™
(kmem_start);

92 #ifdeà
CONFIG_ATIXL_BUSMOUSE


93 
kmem_¡¬t
 = 
	`©ixl_busmou£_š™
(kmem_start);

95 ià(
	`»gi¡”_chrdev
(
MOUSE_MAJOR
,"mou£",&
mou£_fİs
))

96 
	`´štk
("unableo get major %d for mouse devices\n",

97 
MOUSE_MAJOR
);

98  
kmem_¡¬t
;

99 
	}
}

	@drivers/char/msbusmouse.c

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/sched.h
>

33 
	~<lšux/busmou£.h
>

34 
	~<lšux/sigÇl.h
>

35 
	~<lšux/”ºo.h
>

37 
	~<asm/io.h
>

38 
	~<asm/£gm’t.h
>

39 
	~<asm/sy¡em.h
>

40 
	~<asm/œq.h
>

42 
mou£_¡©us
 
	gmou£
;

44 
	$ms_mou£_š‹¼u±
(
unu£d
)

46 
dx
, 
dy
;

47 
bu‰Ús
;

49 
	`outb
(
MS_MSE_COMMAND_MODE
, 
MS_MSE_CONTROL_PORT
);

50 
	`outb
((
	`šb
(
MS_MSE_DATA_PORT
) | 0x20), MS_MSE_DATA_PORT);

52 
	`outb
(
MS_MSE_READ_X
, 
MS_MSE_CONTROL_PORT
);

53 
dx
 = 
	`šb
(
MS_MSE_DATA_PORT
);

55 
	`outb
(
MS_MSE_READ_Y
, 
MS_MSE_CONTROL_PORT
);

56 
dy
 = 
	`šb
(
MS_MSE_DATA_PORT
);

58 
	`outb
(
MS_MSE_READ_BUTTONS
, 
MS_MSE_CONTROL_PORT
);

59 
bu‰Ús
 = ~(
	`šb
(
MS_MSE_DATA_PORT
)) & 0x07;

61 
	`outb
(
MS_MSE_COMMAND_MODE
, 
MS_MSE_CONTROL_PORT
);

62 
	`outb
((
	`šb
(
MS_MSE_DATA_PORT
) & 0xdf), MS_MSE_DATA_PORT);

64 ià(
dx
 !ğ0 || 
dy
 !ğ0 || 
bu‰Ús
 !ğ
mou£
.buttons || ((~buttons) & 0x07)) {

65 
mou£
.
bu‰Ús
 = buttons;

66 
mou£
.
dx
 += dx;

67 
mou£
.
dy
 += dy;

68 
mou£
.
»ady
 = 1;

69 
	`wake_up_š‹¼u±ibË
(&
mou£
.
wa™
);

71 
	}
}

73 
	$»Ëa£_mou£
(
šode
 * inode, 
fe
 * file)

75 
	`MS_MSE_INT_OFF
();

76 
mou£
.
aùive
 = mou£.
»ady
 = 0;

77 
	`ä“_œq
(
MOUSE_IRQ
);

78 
	}
}

80 
	$İ’_mou£
(
šode
 * inode, 
fe
 * file)

82 ià(!
mou£
.
´e£Á
)

83  -
EINVAL
;

84 ià(
mou£
.
aùive
)

85  -
EBUSY
;

86 
mou£
.
aùive
 = 1;

87 
mou£
.
»ady
 = mou£.
dx
 = mou£.
dy
 = 0;

88 
mou£
.
bu‰Ús
 = 0x80;

89 ià(
	`»que¡_œq
(
MOUSE_IRQ
, 
ms_mou£_š‹¼u±
)) {

90 
mou£
.
aùive
 = 0;

91  -
EBUSY
;

93 
	`outb
(
MS_MSE_START
, 
MS_MSE_CONTROL_PORT
);

94 
	`MS_MSE_INT_ON
();

96 
	}
}

99 
	$wr™e_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

101  -
EINVAL
;

102 
	}
}

104 
	$»ad_mou£
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

106 
i
, 
dx
, 
dy
;

108 ià(
couÁ
 < 3)

109  -
EINVAL
;

110 ià(!
mou£
.
»ady
)

111  -
EAGAIN
;

112 
	`put_fs_by‹
(
mou£
.
bu‰Ús
 | 0x80, 
bufãr
);

113 
dx
 = 
mou£
.dx < -127 ? -127 : mouse.dx > 127 ? 127 : mouse.dx;

114 
dy
 = 
mou£
.dy < -127 ? 127 : mouse.dy > 127 ? -127 : -mouse.dy;

115 
	`put_fs_by‹
(()
dx
, 
bufãr
 + 1);

116 
	`put_fs_by‹
(()
dy
, 
bufãr
 + 2);

117 
i
 = 3; i < 
couÁ
; i++)

118 
	`put_fs_by‹
(0x00, 
bufãr
 + 
i
);

119 
mou£
.
dx
 -= dx;

120 
mou£
.
dy
 += dy;

121 
mou£
.
»ady
 = 0;

122  
i
;

123 
	}
}

125 
	$mou£_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

127 ià(
£l_ty³
 !ğ
SEL_IN
)

129 ià(
mou£
.
»ady
)

131 
	`£Ëù_wa™
(&
mou£
.
wa™
,wait);

133 
	}
}

135 
fe_İ”©iÚs
 
	gms_bus_mou£_fİs
 = {

136 
NULL
,

137 
»ad_mou£
,

138 
wr™e_mou£
,

139 
NULL
,

140 
mou£_£Ëù
,

141 
NULL
,

142 
NULL
,

143 
İ’_mou£
,

144 
»Ëa£_mou£
,

147 
	$ms_bus_mou£_š™
(
kmem_¡¬t
)

149 
m£_by‹
, 
i
;

151 
mou£
.
´e£Á
 = mou£.
aùive
 = mou£.
»ady
 = 0;

152 
mou£
.
bu‰Ús
 = 0x80;

153 
mou£
.
dx
 = mou£.
dy
 = 0;

154 
mou£
.
wa™
 = 
NULL
;

155 ià(
	`šb_p
(
MS_MSE_SIGNATURE_PORT
) == 0xde) {

157 
m£_by‹
 = 
	`šb_p
(
MS_MSE_SIGNATURE_PORT
);

159 
i
 = 0; i < 4; i++) {

160 ià(
	`šb_p
(
MS_MSE_SIGNATURE_PORT
) == 0xde) {

161 ià(
	`šb_p
(
MS_MSE_SIGNATURE_PORT
è=ğ
m£_by‹
)

162 
mou£
.
´e£Á
 = 1;

164 
mou£
.
´e£Á
 = 0;

166 
mou£
.
´e£Á
 = 0;

169 ià(
mou£
.
´e£Á
 == 0) {

170  
kmem_¡¬t
;

172 
	`MS_MSE_INT_OFF
();

173 
	`´štk
("Microsoft BusMouse detected‡nd installed.\n");

174  
kmem_¡¬t
;

175 
	}
}

	@drivers/char/psaux.c

28 
	~<lšux/tim”.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/k”Ãl.h
>

31 
	~<lšux/fú.h
>

32 
	~<lšux/”ºo.h
>

34 
	~<asm/io.h
>

35 
	~<asm/£gm’t.h
>

36 
	~<asm/sy¡em.h
>

38 
	~<lšux/cÚfig.h
>

41 
	#AUX_INPUT_PORT
 0x60

	)

42 
	#AUX_OUTPUT_PORT
 0x60

	)

43 
	#AUX_COMMAND
 0x64

	)

44 
	#AUX_STATUS
 0x64

	)

47 
	#AUX_OBUF_FULL
 0x21

	)

48 
	#AUX_IBUF_FULL
 0x02

	)

51 
	#AUX_CMD_WRITE
 0x60

	)

52 
	#AUX_MAGIC_WRITE
 0xd4

	)

54 
	#AUX_INTS_ON
 0x47

	)

55 
	#AUX_INTS_OFF
 0x65

	)

57 
	#AUX_DISABLE
 0xa7

	)

58 
	#AUX_ENABLE
 0xa8

	)

61 
	#AUX_SET_RES
 0xe8

	)

62 
	#AUX_SET_SCALE11
 0xe6

	)

63 
	#AUX_SET_SCALE21
 0xe7

	)

64 
	#AUX_GET_SCALE
 0xe9

	)

65 
	#AUX_SET_STREAM
 0x—

	)

66 
	#AUX_SET_SAMPLE
 0xf3

	)

67 
	#AUX_ENABLE_DEV
 0xf4

	)

68 
	#AUX_DISABLE_DEV
 0xf5

	)

69 
	#AUX_RESET
 0xfà

	)

71 
	#MAX_RETRIES
 60

	)

72 
	#AUX_IRQ
 12

	)

73 
	#AUX_BUF_SIZE
 2048

	)

77 
	#QP_DATA
 0x310

	)

78 
	#QP_STATUS
 0x311

	)

80 
	#QP_DEV_IDLE
 0x01

	)

81 
	#QP_RX_FULL
 0x02

	)

82 
	#QP_TX_IDLE
 0x04

	)

83 
	#QP_RESET
 0x08

	)

84 
	#QP_INTS_ON
 0x10

	)

85 
	#QP_ERROR_FLAG
 0x20

	)

86 
	#QP_CLEAR
 0x40

	)

87 
	#QP_ENABLE
 0x80

	)

89 
	#QP_IRQ
 12

	)

91 
aux_deviû_´e£Á
;

92 
kbd_»ad_mask
;

94 
	saux_queue
 {

95 
	mh—d
;

96 
	m
;

97 
wa™_queue
 *
	m´oc_li¡
;

98 
	mbuf
[
AUX_BUF_SIZE
];

101 
aux_queue
 *
	gqueue
;

102 
	gaux_»ady
 = 0;

103 
	gaux_busy
 = 0;

104 
	gaux_´e£Á
 = 0;

105 
pŞl_aux_¡©us
();

107 #ifdeà
CONFIG_82C710_MOUSE


108 
	gqp_´e£Á
 = 0;

109 
	gqp_busy
 = 0;

110 
	gqp_d©a
 = 
QP_DATA
;

111 
	gqp_¡©us
 = 
QP_STATUS
;

113 
pŞl_qp_¡©us
();

114 
´obe_qp
();

122 
	$aux_wr™e_dev
(
v®
)

124 
	`pŞl_aux_¡©us
();

125 
	`outb_p
(
AUX_MAGIC_WRITE
,
AUX_COMMAND
);

126 
	`pŞl_aux_¡©us
();

127 
	`outb_p
(
v®
,
AUX_OUTPUT_PORT
);

128 
	}
}

134 #ià
defšed
 
INITIALIZE_DEVICE


135 
	$aux_wr™e_ack
(
v®
)

137 
»Œ›s
 = 0;

139 
	`aux_wr™e_dev
(
v®
);

140 (
	`šb
(
AUX_STATUS
è& 
AUX_OBUF_FULL
) != AUX_OBUF_FULL

141 && 
»Œ›s
 < 
MAX_RETRIES
) {

142 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

143 
cu¼’t
->
timeout
 = 
jiff›s
 + 5;

144 
	`scheduË
();

145 
»Œ›s
++;

148 ià((
	`šb
(
AUX_STATUS
è& 
AUX_OBUF_FULL
) == AUX_OBUF_FULL)

150  (
	`šb
(
AUX_INPUT_PORT
));

153 
	}
}

160 
	$aux_wr™e_cmd
(
v®
)

162 
	`pŞl_aux_¡©us
();

163 
	`outb_p
(
AUX_CMD_WRITE
,
AUX_COMMAND
);

164 
	`pŞl_aux_¡©us
();

165 
	`outb_p
(
v®
,
AUX_OUTPUT_PORT
);

166 
	}
}

169 
	$g‘_äom_queue
()

171 
»suÉ
;

172 
æags
;

174 
	`§ve_æags
(
æags
);

175 
	`şi
();

176 
»suÉ
 = 
queue
->
buf
[queue->

];

177 
queue
->

 = (queue-> + 1è& (
AUX_BUF_SIZE
-1);

178 
	`»¡Üe_æags
(
æags
);

179  
»suÉ
;

180 
	}
}

183 
šlše
 
	$queue_em±y
()

185  
queue
->
h—d
 =ğqueue->

;

186 
	}
}

195 
	$aux_š‹¼u±
(
ıl
)

197 
h—d
 = 
queue
->head;

198 
maxh—d
 = (
queue
->

-1è& (
AUX_BUF_SIZE
-1);

200 
queue
->
buf
[
h—d
] = 
	`šb
(
AUX_INPUT_PORT
);

201 ià(
h—d
 !ğ
maxh—d
) {

202 
h—d
++;

203 
h—d
 &ğ
AUX_BUF_SIZE
-1;

205 
queue
->
h—d
 = head;

206 
aux_»ady
 = 1;

207 
	`wake_up_š‹¼u±ibË
(&
queue
->
´oc_li¡
);

208 
	}
}

215 #ifdeà
CONFIG_82C710_MOUSE


216 
	$qp_š‹¼u±
(
ıl
)

218 
h—d
 = 
queue
->head;

219 
maxh—d
 = (
queue
->

-1è& (
AUX_BUF_SIZE
-1);

221 
queue
->
buf
[
h—d
] = 
	`šb
(
qp_d©a
);

222 ià(
h—d
 !ğ
maxh—d
) {

223 
h—d
++;

224 
h—d
 &ğ
AUX_BUF_SIZE
-1;

226 
queue
->
h—d
 = head;

227 
aux_»ady
 = 1;

228 
	`wake_up_š‹¼u±ibË
(&
queue
->
´oc_li¡
);

229 
	}
}

233 
	$»Ëa£_aux
(
šode
 * inode, 
fe
 * file)

235 
	`aux_wr™e_dev
(
AUX_DISABLE_DEV
);

236 
	`aux_wr™e_cmd
(
AUX_INTS_OFF
);

237 
	`pŞl_aux_¡©us
();

238 
	`outb_p
(
AUX_DISABLE
,
AUX_COMMAND
);

239 
	`pŞl_aux_¡©us
();

240 
	`ä“_œq
(
AUX_IRQ
);

241 
aux_busy
 = 0;

242 
	}
}

244 #ifdeà
CONFIG_82C710_MOUSE


245 
	$»Ëa£_qp
(
šode
 * inode, 
fe
 * file)

247 
¡©us
;

249 ià(!
	`pŞl_qp_¡©us
())

250 
	`´štk
("Warning: Mouse device busy in„elease_qp()\n");

251 
¡©us
 = 
	`šb_p
(
qp_¡©us
);

252 
	`outb_p
(
¡©us
 & ~(
QP_ENABLE
|
QP_INTS_ON
), 
qp_¡©us
);

253 ià(!
	`pŞl_qp_¡©us
())

254 
	`´štk
("Warning: Mouse device busy in„elease_qp()\n");

255 
	`ä“_œq
(
QP_IRQ
);

256 
qp_busy
 = 0;

257 
	}
}

265 
	$İ’_aux
(
šode
 * inode, 
fe
 * file)

267 ià(!
aux_´e£Á
)

268  -
EINVAL
;

269 ià(
aux_busy
)

270  -
EBUSY
;

271 ià(!
	`pŞl_aux_¡©us
())

272  -
EBUSY
;

273 
aux_busy
 = 1;

274 
queue
->
h—d
 = queue->

 = 0;

275 ià(
	`»que¡_œq
(
AUX_IRQ
, 
aux_š‹¼u±
)) {

276 
aux_busy
 = 0;

277  -
EBUSY
;

279 
	`pŞl_aux_¡©us
();

280 
	`outb_p
(
AUX_ENABLE
,
AUX_COMMAND
);

281 
	`aux_wr™e_dev
(
AUX_ENABLE_DEV
);

282 
	`aux_wr™e_cmd
(
AUX_INTS_ON
);

283 
	`pŞl_aux_¡©us
();

284 
aux_»ady
 = 0;

286 
	}
}

288 #ifdeà
CONFIG_82C710_MOUSE


295 
	$İ’_qp
(
šode
 * inode, 
fe
 * file)

297 
¡©us
;

299 ià(!
qp_´e£Á
)

300  -
EINVAL
;

302 ià(
qp_busy
)

303  -
EBUSY
;

305 ià(
	`»que¡_œq
(
QP_IRQ
, 
qp_š‹¼u±
))

306  -
EBUSY
;

308 
qp_busy
 = 1;

310 
¡©us
 = 
	`šb_p
(
qp_¡©us
);

311 
¡©us
 |ğ(
QP_ENABLE
|
QP_RESET
);

312 
	`outb_p
(
¡©us
, 
qp_¡©us
);

313 
¡©us
 &ğ~(
QP_RESET
);

314 
	`outb_p
(
¡©us
, 
qp_¡©us
);

316 
queue
->
h—d
 = queue->

 = 0;

317 
¡©us
 |ğ
QP_INTS_ON
;

318 
	`outb_p
(
¡©us
, 
qp_¡©us
);

320 !
	`pŞl_qp_¡©us
()) {

321 
	`´štk
("Error: Mouse device busy in open_qp()\n");

322  -
EBUSY
;

325 
	`outb_p
(
AUX_ENABLE_DEV
, 
qp_d©a
);

328 
	}
}

335 
	$wr™e_aux
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

337 
i
 = 
couÁ
;

339 
i
--) {

340 ià(!
	`pŞl_aux_¡©us
())

341  -
EIO
;

342 
	`outb_p
(
AUX_MAGIC_WRITE
,
AUX_COMMAND
);

343 ià(!
	`pŞl_aux_¡©us
())

344  -
EIO
;

345 
	`outb_p
(
	`g‘_fs_by‹
(
bufãr
++),
AUX_OUTPUT_PORT
);

347 
šode
->
i_mtime
 = 
CURRENT_TIME
;

348  
couÁ
;

349 
	}
}

352 #ifdeà
CONFIG_82C710_MOUSE


357 
	$wr™e_qp
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

359 
i
 = 
couÁ
;

361 
i
--) {

362 ià(!
	`pŞl_qp_¡©us
())

363  -
EIO
;

364 
	`outb_p
(
	`g‘_fs_by‹
(
bufãr
++), 
qp_d©a
);

366 
šode
->
i_mtime
 = 
CURRENT_TIME
;

367  
couÁ
;

368 
	}
}

376 
	$»ad_aux
(
šode
 * inode, 
fe
 * fe, * 
bufãr
, 
couÁ
)

378 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

379 
i
 = 
couÁ
;

380 
c
;

382 ià(
	`queue_em±y
()) {

383 ià(
fe
->
f_æags
 & 
O_NONBLOCK
)

384  -
EAGAIN
;

385 
	`add_wa™_queue
(&
queue
->
´oc_li¡
, &
wa™
);

386 
»³©
:

387 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

388 ià(
	`queue_em±y
(è&& !(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)) {

389 
	`scheduË
();

390 
»³©
;

392 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

393 
	`»move_wa™_queue
(&
queue
->
´oc_li¡
, &
wa™
);

395 
i
 > 0 && !
	`queue_em±y
()) {

396 
c
 = 
	`g‘_äom_queue
();

397 
	`put_fs_by‹
(
c
, 
bufãr
++);

398 
i
--;

400 
aux_»ady
 = !
	`queue_em±y
();

401 ià(
couÁ
-
i
) {

402 
šode
->
i_©ime
 = 
CURRENT_TIME
;

403  
couÁ
-
i
;

405 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

406  -
ERESTARTSYS
;

408 
	}
}

411 
	$aux_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

413 ià(
£l_ty³
 !ğ
SEL_IN
)

415 ià(
aux_»ady
)

417 
	`£Ëù_wa™
(&
queue
->
´oc_li¡
, 
wa™
);

419 
	}
}

422 
fe_İ”©iÚs
 
	gp§ux_fİs
 = {

423 
NULL
,

424 
»ad_aux
,

425 
wr™e_aux
,

426 
NULL
,

427 
aux_£Ëù
,

428 
NULL
,

429 
NULL
,

430 
İ’_aux
,

431 
»Ëa£_aux
,

440 
	$p§ux_š™
(
kmem_¡¬t
)

442 
qp_found
 = 0;

444 #ifdeà
CONFIG_82C710_MOUSE


445 ià((
qp_found
 = 
	`´obe_qp
())) {

446 
	`´štk
("82C710ype…ointing device detected -- driver installed.\n");

448 
qp_´e£Á
 = 1;

449 
p§ux_fİs
.
wr™e
 = 
wr™e_qp
;

450 
p§ux_fİs
.
İ’
 = 
İ’_qp
;

451 
p§ux_fİs
.
»Ëa£
 = 
»Ëa£_qp
;

452 
	`pŞl_qp_¡©us
();

455 ià(
aux_deviû_´e£Á
 == 0xaa) {

456 
	`´štk
("PS/2‡uxiliary…ointing device detected -- driver installed.\n");

457 
aux_´e£Á
 = 1;

458 
kbd_»ad_mask
 = 
AUX_OBUF_FULL
;

459 
	`pŞl_aux_¡©us
();

461  
kmem_¡¬t
;

463 
queue
 = (
aux_queue
 *è
kmem_¡¬t
;

464 
kmem_¡¬t
 +ğ (
aux_queue
);

465 
queue
->
h—d
 = queue->

 = 0;

466 
queue
->
´oc_li¡
 = 
NULL
;

467 ià(!
qp_found
) {

468 #ià
defšed
 
INITIALIZE_DEVICE


469 
	`outb_p
(
AUX_ENABLE
,
AUX_COMMAND
);

470 
	`aux_wr™e_ack
(
AUX_SET_SAMPLE
);

471 
	`aux_wr™e_ack
(100);

472 
	`aux_wr™e_ack
(
AUX_SET_RES
);

473 
	`aux_wr™e_ack
(3);

474 
	`aux_wr™e_ack
(
AUX_SET_SCALE21
);

475 
	`pŞl_aux_¡©us
();

477 
	`outb_p
(
AUX_DISABLE
,
AUX_COMMAND
);

478 
	`aux_wr™e_cmd
(
AUX_INTS_OFF
);

479 
	`pŞl_aux_¡©us
();

481  
kmem_¡¬t
;

482 
	}
}

484 
	$pŞl_aux_¡©us
()

486 
»Œ›s
=0;

488 (
	`šb
(
AUX_STATUS
)&0x03è&& 
»Œ›s
 < 
MAX_RETRIES
) {

489 ià(
	`šb_p
(
AUX_STATUS
è& 
AUX_OBUF_FULL
 == AUX_OBUF_FULL)

490 
	`šb_p
(
AUX_INPUT_PORT
);

491 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

492 
cu¼’t
->
timeout
 = 
jiff›s
 + 5;

493 
	`scheduË
();

494 
»Œ›s
++;

496  !(
»Œ›s
==
MAX_RETRIES
);

497 
	}
}

499 #ifdeà
CONFIG_82C710_MOUSE


504 
	$pŞl_qp_¡©us
()

506 
»Œ›s
=0;

508 (
	`šb
(
qp_¡©us
)&(
QP_RX_FULL
|
QP_TX_IDLE
|
QP_DEV_IDLE
))

509 !ğ(
QP_DEV_IDLE
|
QP_TX_IDLE
)

510 && 
»Œ›s
 < 
MAX_RETRIES
) {

512 ià(
	`šb_p
(
qp_¡©us
)&(
QP_RX_FULL
))

513 
	`šb_p
(
qp_d©a
);

514 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

515 
cu¼’t
->
timeout
 = 
jiff›s
 + 5;

516 
	`scheduË
();

517 
»Œ›s
++;

519  !(
»Œ›s
==
MAX_RETRIES
);

520 
	}
}

526 
šlše
 
	$»ad_710
(
šdex
)

528 
	`outb_p
(
šdex
, 0x390);

529  
	`šb_p
(0x391);

530 
	}
}

536 
	$´obe_qp
()

538 
	`outb_p
(0x55, 0x2fa);

539 
	`outb_p
(0xaa, 0x3fa);

540 
	`outb_p
(0x36, 0x3fa);

541 
	`outb_p
(0xe4, 0x3fa);

542 
	`outb_p
(0x1b, 0x2fa);

543 ià(
	`»ad_710
(0x0f) != 0xe4)

545 
qp_d©a
 = 
	`»ad_710
(0x0d)*4;

546 
qp_¡©us
 = 
qp_d©a
+1;

547 
	`outb_p
(0x0f, 0x390);

548 
	`outb_p
(0x0f, 0x391);

550 
	}
}

	@drivers/char/pty.c

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/sched.h
>

17 
	~<lšux/‰y.h
>

18 
	~<lšux/fú.h
>

19 
	~<lšux/š‹¼u±.h
>

20 
	~<lšux/¡ršg.h
>

22 
	~<asm/sy¡em.h
>

23 
	~<asm/b™İs.h
>

25 
	#MIN
(
a
,
b
è(×è< (bè? (aè: (b))

	)

27 
	$±y_şo£
(
‰y_¡ruù
 * 
‰y
, 
fe
 * 
fp
)

29 ià(!
‰y
)

31 ià(
	`IS_A_PTY_MASTER
(
‰y
->
lše
)) {

32 ià(
‰y
->
couÁ
 > 1)

33 
	`´štk
("ma¡”…ty_şo£: couÁ = %d!!\n", 
‰y
->
couÁ
);

35 ià(
‰y
->
couÁ
 > 2)

38 
	`wake_up_š‹¼u±ibË
(&
‰y
->
£cÚd¬y
.
´oc_li¡
);

39 
	`wake_up_š‹¼u±ibË
(&
‰y
->
»ad_q
.
´oc_li¡
);

40 
	`wake_up_š‹¼u±ibË
(&
‰y
->
wr™e_q
.
´oc_li¡
);

41 ià(!
‰y
->
lšk
)

43 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

44 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
»ad_q
.
´oc_li¡
);

45 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
wr™e_q
.
´oc_li¡
);

46 ià(
	`IS_A_PTY_MASTER
(
‰y
->
lše
))

47 
	`‰y_hªgup
(
‰y
->
lšk
);

49 
	`¡¬t_‰y
(
‰y
);

50 
	`£t_b™
(
TTY_SLAVE_CLOSED
, &
‰y
->
lšk
->
æags
);

52 
	}
}

54 
šlše
 
	$±y_cİy
(
‰y_¡ruù
 * 
äom
, ‰y_¡ruù * 
to
)

56 
couÁ
, 
n
;

57 
‰y_queue
 *
fq
, *
tq
;

59 ià(
äom
->
¡İ³d
 || 
	`EMPTY
(&äom->
wr™e_q
))

61 
fq
 = &
äom
->
wr™e_q
;

62 
tq
 = &
to
->
»ad_q
;

63 
couÁ
 = 
	`MIN
(
	`CHARS
(
fq
), 
	`LEFT
(
tq
));

64 
couÁ
) {

65 
n
 = 
	`MIN
(MIN(
TTY_BUF_SIZE
 - 
fq
->

, TTY_BUF_SIZE - 
tq
->
h—d
),

66 
couÁ
);

67 
	`memıy
(&
tq
->
buf
[tq->
h—d
], &
fq
->buf[fq->

], 
n
);

68 
couÁ
 -ğ
n
;

69 
fq
->

 = (fq-> + 
n
è& (
TTY_BUF_SIZE
 - 1);

70 
tq
->
h—d
 = (tq->h—d + 
n
è& (
TTY_BUF_SIZE
 - 1);

72 
	`TTY_READ_FLUSH
(
to
);

73 ià(
	`LEFT
(
fq
è> 
WAKEUP_CHARS
)

74 
	`wake_up_š‹¼u±ibË
(&
fq
->
´oc_li¡
);

75 ià(
äom
->
wr™e_d©a_út
) {

76 
	`£t_b™
(
äom
->
lše
, &
‰y_check_wr™e
);

77 
	`m¬k_bh
(
TTY_BH
);

79 
	}
}

86 
	$±y_wr™e
(
‰y_¡ruù
 * 
‰y
)

88 ià(
‰y
->
lšk
)

89 
	`±y_cİy
(
‰y
,‰y->
lšk
);

90 
	}
}

92 
	$±y_İ’
(
‰y_¡ruù
 *
‰y
, 
fe
 * 
fp
)

94 ià(!
‰y
 || !‰y->
lšk
)

95  -
ENODEV
;

96 ià(
	`IS_A_PTY_SLAVE
(
‰y
->
lše
))

97 
	`ş—r_b™
(
TTY_SLAVE_CLOSED
, &
‰y
->
lšk
->
æags
);

98 
‰y
->
wr™e
 =ty->
lšk
->wr™ğ
±y_wr™e
;

99 
‰y
->
şo£
 =ty->
lšk
->şo£ = 
±y_şo£
;

100 
	`wake_up_š‹¼u±ibË
(&
‰y
->
»ad_q
.
´oc_li¡
);

101 ià(
fp
->
f_æags
 & 
O_NDELAY
)

103 !
‰y
->
lšk
->
couÁ
 && !(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
))

104 
	`š‹¼u±ibË_¦“p_Ú
(&
‰y
->
lšk
->
»ad_q
.
´oc_li¡
);

105 ià(!
‰y
->
lšk
->
couÁ
)

106  -
ERESTARTSYS
;

108 
	}
}

	@drivers/char/serial.c

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/sigÇl.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/tim”.h
>

24 
	~<lšux/‰y.h
>

25 
	~<lšux/£rŸl.h
>

26 
	~<lšux/š‹¼u±.h
>

27 
	~<lšux/cÚfig.h
>

28 
	~<lšux/majÜ.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/fú.h
>

31 
	~<lšux/±¿û.h
>

33 
	~<asm/sy¡em.h
>

34 
	~<asm/io.h
>

35 
	~<asm/£gm’t.h
>

36 
	~<asm/b™İs.h
>

59 #undeà
ISR_HACK


72 
	grs_ev’t
[2];

74 
async_¡ruù
 *
	gIRQ_pÜts
[16];

75 
	gIRQ_aùive
;

76 
	gIRQ_tim”
[16];

77 
	gIRQ_timeout
[16];

78 vŞ©
	grs_œq_Œigg”ed
;

79 vŞ©
	grs_Œigg”ed
;

80 
	grs_wd_št_mask
;

82 
autocÚfig
(
async_¡ruù
 * 
šfo
);

83 
chªge_¥“d
(
lše
);

92 
	#BASE_BAUD
 ( 1843200 / 16 )

	)

94 #ifdeà
CONFIG_AUTO_IRQ


95 
	#AUTO_IRQ_FLAG
 
ASYNC_AUTO_IRQ


	)

97 
	#AUTO_IRQ_FLAG
 0

	)

101 
	#STD_COM_FLAGS
 (
ASYNC_BOOT_AUTOCONF
 | 
ASYNC_SKIP_TEST
 | 
AUTO_IRQ_FLAG
)

	)

102 
	#STD_COM4_FLAGS
 (
ASYNC_BOOT_AUTOCONF
 | 
AUTO_IRQ_FLAG
)

	)

104 #ifdeà
CONFIG_AST_FOURPORT


105 
	#FOURPORT_FLAGS
 (
ASYNC_BOOT_AUTOCONF
 | 
ASYNC_FOURPORT
 | 
AUTO_IRQ_FLAG
)

	)

107 
	#FOURPORT_FLAGS
 (
ASYNC_FOURPORT
 | 
AUTO_IRQ_FLAG
)

	)

110 #ifdeà
CONFIG_ACCENT_ASYNC


111 
	#ACCENT_FLAGS
 (
ASYNC_BOOT_AUTOCONF
 | 
AUTO_IRQ_FLAG
)

	)

113 
	#ACCENT_FLAGS
 
AUTO_IRQ_FLAG


	)

116 #ifdeà
CONFIG_BOCA


117 
	#BOCA_FLAGS
 (
ASYNC_BOOT_AUTOCONF
 | 
AUTO_IRQ_FLAG
)

	)

119 
	#BOCA_FLAGS
 
AUTO_IRQ_FLAG


	)

122 #ifdeà
CONFIG_HUB6


123 
	#HUB6_FLAGS
 (
ASYNC_BOOT_AUTOCONF
)

	)

125 
	#HUB6_FLAGS
 0

	)

142 
	#C_P
(
ÿrd
,
pÜt
è(((ÿrd)<<6|ÕÜt)<<3è+ 1)

	)

144 
async_¡ruù
 
	grs_bË
[] = {

146 { 
BASE_BAUD
, 0x3F8, 4, 
STD_COM_FLAGS
 },

147 { 
BASE_BAUD
, 0x2F8, 3, 
STD_COM_FLAGS
 },

148 { 
BASE_BAUD
, 0x3E8, 4, 
STD_COM_FLAGS
 },

149 { 
BASE_BAUD
, 0x2E8, 3, 
STD_COM4_FLAGS
 },

151 { 
BASE_BAUD
, 0x1A0, 9, 
FOURPORT_FLAGS
 },

152 { 
BASE_BAUD
, 0x1A8, 9, 
FOURPORT_FLAGS
 },

153 { 
BASE_BAUD
, 0x1B0, 9, 
FOURPORT_FLAGS
 },

154 { 
BASE_BAUD
, 0x1B8, 9, 
FOURPORT_FLAGS
 },

156 { 
BASE_BAUD
, 0x2A0, 5, 
FOURPORT_FLAGS
 },

157 { 
BASE_BAUD
, 0x2A8, 5, 
FOURPORT_FLAGS
 },

158 { 
BASE_BAUD
, 0x2B0, 5, 
FOURPORT_FLAGS
 },

159 { 
BASE_BAUD
, 0x2B8, 5, 
FOURPORT_FLAGS
 },

161 { 
BASE_BAUD
, 0x330, 4, 
ACCENT_FLAGS
 },

162 { 
BASE_BAUD
, 0x338, 4, 
ACCENT_FLAGS
 },

163 { 
BASE_BAUD
, 0x000, 0, 0 },

164 { 
BASE_BAUD
, 0x000, 0, 0 },

166 { 
BASE_BAUD
, 0x100, 12, 
BOCA_FLAGS
 },

167 { 
BASE_BAUD
, 0x108, 12, 
BOCA_FLAGS
 },

168 { 
BASE_BAUD
, 0x110, 12, 
BOCA_FLAGS
 },

169 { 
BASE_BAUD
, 0x118, 12, 
BOCA_FLAGS
 },

170 { 
BASE_BAUD
, 0x120, 12, 
BOCA_FLAGS
 },

171 { 
BASE_BAUD
, 0x128, 12, 
BOCA_FLAGS
 },

172 { 
BASE_BAUD
, 0x130, 12, 
BOCA_FLAGS
 },

173 { 
BASE_BAUD
, 0x138, 12, 
BOCA_FLAGS
 },

174 { 
BASE_BAUD
, 0x140, 12, 
BOCA_FLAGS
 },

175 { 
BASE_BAUD
, 0x148, 12, 
BOCA_FLAGS
 },

176 { 
BASE_BAUD
, 0x150, 12, 
BOCA_FLAGS
 },

177 { 
BASE_BAUD
, 0x158, 12, 
BOCA_FLAGS
 },

178 { 
BASE_BAUD
, 0x160, 12, 
BOCA_FLAGS
 },

179 { 
BASE_BAUD
, 0x168, 12, 
BOCA_FLAGS
 },

180 { 
BASE_BAUD
, 0x170, 12, 
BOCA_FLAGS
 },

181 { 
BASE_BAUD
, 0x178, 12, 
BOCA_FLAGS
 },

186 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,0) },

187 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,1) },

188 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,2) },

189 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,3) },

190 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,4) },

191 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(0,5) },

192 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,0) },

193 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,1) },

194 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,2) },

195 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,3) },

196 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,4) },

197 { 
BASE_BAUD
, 0x302, 3, 
HUB6_FLAGS
, 
C_P
(1,5) },

200 
	#NR_PORTS
 ((
rs_bË
)/(
async_¡ruù
))

	)

205 
	gbaud_bË
[] = {

209 
rs_thrÙe
(
‰y_¡ruù
 * 
‰y
, 
¡©us
);

211 
šlše
 
	$£rŸl_š
(
async_¡ruù
 *
šfo
, 
off£t
)

213 ià(
šfo
->
hub6
) {

214 
	`outb
(
šfo
->
hub6
 - 1 + 
off£t
, info->
pÜt
);

215  
	`šb
(
šfo
->
pÜt
+1);

217  
	`šb
(
šfo
->
pÜt
 + 
off£t
);

218 
	}
}

220 
šlše
 
	$£rŸl_šp
(
async_¡ruù
 *
šfo
, 
off£t
)

222 ià(
šfo
->
hub6
) {

223 
	`outb
(
šfo
->
hub6
 - 1 + 
off£t
, info->
pÜt
);

224  
	`šb_p
(
šfo
->
pÜt
+1);

226  
	`šb_p
(
šfo
->
pÜt
 + 
off£t
);

227 
	}
}

229 
šlše
 
	$£rŸl_out
(
async_¡ruù
 *
šfo
, 
off£t
, 
v®ue
)

231 ià(
šfo
->
hub6
) {

232 
	`outb
(
šfo
->
hub6
 - 1 + 
off£t
, info->
pÜt
);

233 
	`outb
(
v®ue
, 
šfo
->
pÜt
+1);

235 
	`outb
(
v®ue
, 
šfo
->
pÜt
+
off£t
);

236 
	}
}

238 
šlše
 
	$£rŸl_ou
(
async_¡ruù
 *
šfo
, 
off£t
,

239 
v®ue
)

241 ià(
šfo
->
hub6
) {

242 
	`outb
(
šfo
->
hub6
 - 1 + 
off£t
, info->
pÜt
);

243 
	`outb_p
(
v®ue
, 
šfo
->
pÜt
+1);

245 
	`outb_p
(
v®ue
, 
šfo
->
pÜt
+
off£t
);

246 
	}
}

256 
	$rs_¡İ
(
‰y_¡ruù
 *
‰y
)

258 
async_¡ruù
 *
šfo
;

260 
šfo
 = 
rs_bË
 + 
	`DEV_TO_SL
(
‰y
->
lše
);

262 ià(
šfo
->
æags
 & 
ASYNC_CLOSING
) {

263 
‰y
->
¡İ³d
 = 0;

264 
‰y
->
hw_¡İ³d
 = 0;

268 
šfo
->
IER
 = 
UART_IER_MSI
 | 
UART_IER_RLSI
 | 
UART_IER_RDI
;

269 #ifdeà
ISR_HACK


270 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

272 
	}
}

274 
	$rs_¡¬t
(
‰y_¡ruù
 *
‰y
)

276 
async_¡ruù
 *
šfo
;

278 
šfo
 = 
rs_bË
 + 
	`DEV_TO_SL
(
‰y
->
lše
);

280 
šfo
->
IER
 = (
UART_IER_MSI
 | 
UART_IER_RLSI
 |

281 
UART_IER_THRI
 | 
UART_IER_RDI
);

282 #ifdeà
ISR_HACK


283 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

285 
	}
}

312 
	$rs_´obe
(
œq
)

314 
rs_œq_Œigg”ed
 = 
œq
;

315 
rs_Œigg”ed
 |ğ1 << 
œq
;

317 
	}
}

323 
šlše
 
	$rs_sched_ev’t
(
async_¡ruù
 *
šfo
,

324 
ev’t
)

326 
šfo
->
ev’t
 |= 1 <<ƒvent;

327 
	`£t_b™
(
šfo
->
lše
, 
rs_ev’t
);

328 
	`m¬k_bh
(
SERIAL_BH
);

329 
	}
}

331 
šlše
 
	$»ûive_ch¬s
(
async_¡ruù
 *
šfo
,

332 *
¡©us
)

334 
‰y_queue
 * 
queue
;

335 
h—d
, 

, 
ch
;

341 
	#VLEFT
 ((

-
h—d
-1)&(
TTY_BUF_SIZE
-1))

	)

343 
queue
 = &
šfo
->
‰y
->
»ad_q
;

344 
h—d
 = 
queue
->head;

345 

 = 
queue
->tail;

347 
ch
 = 
	`£rŸl_šp
(
šfo
, 
UART_RX
);

352 ià(
VLEFT
 < 2)

354 ià(*
¡©us
 & 
šfo
->
»ad_¡©us_mask
) {

355 
	`£t_b™
(
h—d
, &
šfo
->
‰y
->
»adq_æags
);

356 ià(*
¡©us
 & (
UART_LSR_BI
)) {

357 
queue
->
buf
[
h—d
++]ğ
TTY_BREAK
;

358 
	`rs_sched_ev’t
(
šfo
, 
RS_EVENT_BREAK
);

359 } ià(*
¡©us
 & 
UART_LSR_PE
)

360 
queue
->
buf
[
h—d
++]ğ
TTY_PARITY
;

361 ià(*
¡©us
 & 
UART_LSR_FE
)

362 
queue
->
buf
[
h—d
++]ğ
TTY_FRAME
;

363 ià(*
¡©us
 & 
UART_LSR_OE
)

364 
queue
->
buf
[
h—d
++]ğ
TTY_OVERRUN
;

365 
h—d
 &ğ
TTY_BUF_SIZE
-1;

367 
queue
->
buf
[
h—d
++] = 
ch
;

368 
h—d
 &ğ
TTY_BUF_SIZE
-1;

369 } (*
¡©us
 = 
	`£rŸl_šp
(
šfo
, 
UART_LSR
)è& 
UART_LSR_DR
);

370 
queue
->
h—d
 = head;

371 ià((
VLEFT
 < 
RQ_THRESHOLD_LW
è&& !
	`£t_b™
(
TTY_RQ_THROTTLED
,

372 &
šfo
->
‰y
->
æags
))

373 
	`rs_thrÙe
(
šfo
->
‰y
, 
TTY_THROTTLE_RQ_FULL
);

374 
	`rs_sched_ev’t
(
šfo
, 
RS_EVENT_READ_PROCESS
);

375 #ifdeà
SERIAL_DEBUG_INTR


376 
	`´štk
("DR...");

378 
	}
}

380 
šlše
 
	$Œªsm™_ch¬s
(
async_¡ruù
 *
šfo
, *
dÚe_wÜk
)

382 
‰y_queue
 * 
queue
;

383 
h—d
, 

, 
couÁ
;

385 
queue
 = &
šfo
->
‰y
->
wr™e_q
;

386 
h—d
 = 
queue
->head;

387 

 = 
queue
->tail;

388 ià(
h—d
==

 && !
šfo
->
x_ch¬
) {

389 
šfo
->
IER
 = 
UART_IER_MSI
 | 
UART_IER_RLSI
 | 
UART_IER_RDI
;

390 #ifdeà
ISR_HACK


391 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

395 
couÁ
 = 
šfo
->
xm™_fifo_size
;

396 ià(
šfo
->
x_ch¬
) {

397 
	`£rŸl_ou
(
šfo
, 
UART_TX
, info->
x_ch¬
);

398 
šfo
->
x_ch¬
 = 0;

399 
couÁ
--;

401 
couÁ
-- && (

 !ğ
h—d
)) {

402 
	`£rŸl_ou
(
šfo
, 
UART_TX
, 
queue
->
buf
[

++]);

403 

 &ğ
TTY_BUF_SIZE
-1;

405 
queue
->

 =ail;

406 ià(
VLEFT
 > 
WAKEUP_CHARS
) {

407 
	`rs_sched_ev’t
(
šfo
, 
RS_EVENT_WRITE_WAKEUP
);

408 ià(
šfo
->
‰y
->
wr™e_d©a_út
) {

409 
	`£t_b™
(
šfo
->
‰y
->
lše
, &
‰y_check_wr™e
);

410 
	`m¬k_bh
(
TTY_BH
);

413 #ifdeà
SERIAL_DEBUG_INTR


414 
	`´štk
("THRE...");

416 (*
dÚe_wÜk
)++;

417 
	}
}

419 
šlše
 
	$check_modem_¡©us
(
async_¡ruù
 *
šfo
)

421 
¡©us
;

423 
¡©us
 = 
	`£rŸl_š
(
šfo
, 
UART_MSR
);

425 ià((
¡©us
 & 
UART_MSR_DDCD
è&& !
	`C_CLOCAL
(
šfo
->
‰y
)) {

426 #ià(
	`defšed
(
SERIAL_DEBUG_OPEN
è|| defšed(
SERIAL_DEBUG_INTR
))

427 
	`´štk
("‰ys%d CD‚ow %s...", 
šfo
->
lše
,

428 (
¡©us
 & 
UART_MSR_DCD
) ? "on" : "off");

430 ià(
¡©us
 & 
UART_MSR_DCD
)

431 
	`rs_sched_ev’t
(
šfo
, 
RS_EVENT_OPEN_WAKEUP
);

432 ià(!((
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
) &&

433 (
šfo
->
æags
 & 
ASYNC_CALLOUT_NOHUP
))) {

434 #ifdeà
SERIAL_DEBUG_OPEN


435 
	`´štk
("scheduling hangup...");

437 
	`rs_sched_ev’t
(
šfo
, 
RS_EVENT_HANGUP
);

440 ià(
	`C_CRTSCTS
(
šfo
->
‰y
è&& !(šfo->
æags
 & 
ASYNC_CLOSING
)) {

441 ià(
šfo
->
‰y
->
hw_¡İ³d
) {

442 ià(
¡©us
 & 
UART_MSR_CTS
) {

443 #ifdeà
SERIAL_DEBUG_INTR


444 
	`´štk
("CTSx start...");

446 
šfo
->
‰y
->
hw_¡İ³d
 = 0;

447 
	`rs_¡¬t
(
šfo
->
‰y
);

451 ià(!(
¡©us
 & 
UART_MSR_CTS
)) {

452 #ifdeà
SERIAL_DEBUG_INTR


453 
	`´štk
("CTSx stop...");

455 
šfo
->
‰y
->
hw_¡İ³d
 = 1;

456 
	`rs_¡İ
(
šfo
->
‰y
);

461 
	}
}

463 
šlše
 
	$figu»_RS_tim”
()

465 
timeout
 = 
jiff›s
 + 60*
HZ
;

466 
i
, 
mask
;

468 ià(!
IRQ_aùive
)

470 
i
=0, 
mask
 = 1; mask <ğ
IRQ_aùive
; i++, mask <<= 1) {

471 ià(!(
mask
 & 
IRQ_aùive
))

473 ià(
IRQ_tim”
[
i
] < 
timeout
)

474 
timeout
 = 
IRQ_tim”
[
i
];

476 
tim”_bË
[
RS_TIMER
].
expœes
 = 
timeout
;

477 
tim”_aùive
 |ğ1 << 
RS_TIMER
;

478 
	}
}

484 
	$rs_š‹¼u±
(
œq
)

486 
¡©us
;

487 
async_¡ruù
 * 
šfo
;

488 
dÚe
, 
dÚe_wÜk
, 
·ss_numb”
, 
»check_couÁ
;

490 
rs_œq_Œigg”ed
 = 
œq
;

491 
rs_Œigg”ed
 |ğ1 << 
œq
;

493 
šfo
 = 
IRQ_pÜts
[
œq
];

494 
dÚe
 = 1;

495 
dÚe_wÜk
 = 0;

496 
·ss_numb”
 = 0;

497 
šfo
) {

498 ià(
šfo
->
‰y
 &&

499 
šfo
->
‰y
->
‹rmios
 &&

500 (!
·ss_numb”
 ||

501 !(
	`£rŸl_šp
(
šfo
, 
UART_IIR
è& 
UART_IIR_NO_INT
))) {

502 
dÚe
 = 0;

503 
¡©us
 = 
	`£rŸl_šp
(
šfo
, 
UART_LSR
);

504 ià(
¡©us
 & 
UART_LSR_DR
) {

505 
	`»ûive_ch¬s
(
šfo
, &
¡©us
);

506 
dÚe_wÜk
++;

508 
»check_couÁ
 = 0;

509 
»check_wr™e
:

510 ià(
¡©us
 & 
UART_LSR_THRE
) {

511 
	`wake_up_š‹¼u±ibË
(&
šfo
->
xm™_wa™
);

512 ià(!
šfo
->
‰y
->
¡İ³d
 &&

513 !
šfo
->
‰y
->
hw_¡İ³d
)

514 
	`Œªsm™_ch¬s
(
šfo
, &
dÚe_wÜk
);

516 ià(
	`check_modem_¡©us
(
šfo
) &&

517 (
»check_couÁ
++ <= 64))

518 
»check_wr™e
;

519 #ifdeà
SERIAL_DEBUG_INTR


520 ià(
»check_couÁ
 > 16)

521 
	`´štk
("»check_couÁ = %d\n", 
»check_couÁ
);

524 #ifdeà
ISR_HACK


525 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0);

526 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

529 
šfo
 = info->
Ãxt_pÜt
;

530 ià(!
šfo
 && !
dÚe
) {

531 
šfo
 = 
IRQ_pÜts
[
œq
];

532 
dÚe
 = 1;

533 ià(
·ss_numb”
++ > 64)

537 ià((
šfo
 = 
IRQ_pÜts
[
œq
]è!ğ
NULL
) {

540 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0);

541 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

542 
šfo
 = info->
Ãxt_pÜt
;

543 } 
šfo
);

545 ià(
œq
 && !
dÚe_wÜk
)

546 
IRQ_tim”
[
œq
] = 
jiff›s
 + 1500;

548 
IRQ_tim”
[
œq
] = 
jiff›s
 + 
IRQ_timeout
[irq];

549 
IRQ_aùive
 |ğ1 << 
œq
;

551 
	`figu»_RS_tim”
();

552 
	}
}

564 
šlše
 
	$hªdË_rs_b»ak
(
async_¡ruù
 *
šfo
)

566 ià(
šfo
->
æags
 & 
ASYNC_SAK
)

567 
	`do_SAK
(
šfo
->
‰y
);

569 ià(!
	`I_IGNBRK
(
šfo
->
‰y
è&& 
	`I_BRKINT
(info->tty)) {

570 
	`æush_šput
(
šfo
->
‰y
);

571 
	`æush_ouut
(
šfo
->
‰y
);

572 ià(
šfo
->
‰y
->
pg½
 > 0)

573 
	`kl_pg
(
šfo
->
‰y
->
pg½
, 
SIGINT
,1);

575 
	}
}

586 
	$do_soášt
(*
unu£d
)

588 
i
;

589 
async_¡ruù
 *
šfo
;

591 
i
 = 0, 
šfo
 = 
rs_bË
; i < 
NR_PORTS
; i++,info++) {

592 ià(
	`ş—r_b™
(
i
, 
rs_ev’t
)) {

593 ià(!
šfo
->
‰y
)

595 ià(
	`ş—r_b™
(
RS_EVENT_READ_PROCESS
, &
šfo
->
ev’t
)) {

596 
	`TTY_READ_FLUSH
(
šfo
->
‰y
);

598 ià(
	`ş—r_b™
(
RS_EVENT_WRITE_WAKEUP
, &
šfo
->
ev’t
)) {

599 
	`wake_up_š‹¼u±ibË
(&
šfo
->
‰y
->
wr™e_q
.
´oc_li¡
);

601 ià(
	`ş—r_b™
(
RS_EVENT_HANGUP
, &
šfo
->
ev’t
)) {

602 
	`‰y_hªgup
(
šfo
->
‰y
);

603 
	`wake_up_š‹¼u±ibË
(&
šfo
->
İ’_wa™
);

604 
šfo
->
æags
 &ğ~(
ASYNC_NORMAL_ACTIVE
|

605 
ASYNC_CALLOUT_ACTIVE
);

607 ià(
	`ş—r_b™
(
RS_EVENT_BREAK
, &
šfo
->
ev’t
))

608 
	`hªdË_rs_b»ak
(
šfo
);

609 ià(
	`ş—r_b™
(
RS_EVENT_OPEN_WAKEUP
, &
šfo
->
ev’t
)) {

610 
	`wake_up_š‹¼u±ibË
(&
šfo
->
İ’_wa™
);

614 
	}
}

623 
	$rs_tim”
()

625 
i
, 
mask
;

626 
timeout
 = 0;

628 
i
 = 0, 
mask
 = 1; mask <ğ
IRQ_aùive
; i++, mask <<= 1) {

629 ià((
mask
 & 
IRQ_aùive
è&& (
IRQ_tim”
[
i
] <ğ
jiff›s
)) {

630 
IRQ_aùive
 &ğ~
mask
;

631 
	`şi
();

632 #ifdeà
SERIAL_DEBUG_TIMER


633 
	`´štk
("rs_tim”:„s_š‹¼u±(%d)...", 
i
);

635 
	`rs_š‹¼u±
(
i
);

636 
	`¡i
();

638 ià(
mask
 & 
IRQ_aùive
) {

639 ià(!
timeout
 || (
IRQ_tim”
[
i
] <imeout))

640 
timeout
 = 
IRQ_tim”
[
i
];

643 ià(
timeout
) {

644 
tim”_bË
[
RS_TIMER
].
expœes
 = 
timeout
;

645 
tim”_aùive
 |ğ1 << 
RS_TIMER
;

647 
	}
}

664 
	$g¿b_®l_š‹¼u±s
(
dÚtg¿b
)

666 
œq_lšes
 = 0;

667 
i
, 
mask
;

668 
sigaùiÚ
 
§
;

670 
§
.
§_hªdËr
 = 
rs_´obe
;

671 
§
.
§_æags
 = (
SA_INTERRUPT
);

672 
§
.
§_mask
 = 0;

673 
§
.
§_»¡Ü”
 = 
NULL
;

675 
i
 = 0, 
mask
 = 1; i < 16; i++, mask <<= 1) {

676 ià(!(
mask
 & 
dÚtg¿b
è&& !
	`œqaùiÚ
(
i
, &
§
)) {

677 
œq_lšes
 |ğ
mask
;

680  
œq_lšes
;

681 
	}
}

686 
	$ä“_®l_š‹¼u±s
(
œq_lšes
)

688 
i
;

690 
i
 = 0; i < 16; i++) {

691 ià(
œq_lšes
 & (1 << 
i
))

692 
	`ä“_œq
(
i
);

694 
	}
}

701 
	$figu»_IRQ_timeout
(
œq
)

703 
async_¡ruù
 *
šfo
;

704 
timeout
 = 6000;

706 
šfo
 = 
IRQ_pÜts
[
œq
];

707 ià(!
šfo
) {

708 
IRQ_timeout
[
œq
] = 6000;

711 
šfo
) {

712 ià(
šfo
->
timeout
 <imeout)

713 
timeout
 = 
šfo
->timeout;

714 
šfo
 = info->
Ãxt_pÜt
;

716 ià(!
œq
)

717 
timeout
 =imeout / 2;

718 
IRQ_timeout
[
œq
] = 
timeout
 ?imeout : 1;

719 
	}
}

721 
	$¡¬tup
(
async_¡ruù
 * 
šfo
, 
g‘_œq
)

723 
ICP
;

724 
æags
;

725 
sigaùiÚ
 
§
;

726 
»tv®
;

728 ià(
šfo
->
æags
 & 
ASYNC_INITIALIZED
)

731 ià(!
šfo
->
pÜt
 || !šfo->
ty³
) {

732 ià(
šfo
->
‰y
)

733 
	`£t_b™
(
TTY_IO_ERROR
, &
šfo
->
‰y
->
æags
);

737 
	`§ve_æags
(
æags
); 
	`şi
();

739 #ifdeà
SERIAL_DEBUG_OPEN


740 
	`´štk
("¡¬tšg u°‰ys%d (œq %d)...", 
šfo
->
lše
, info->
œq
);

746 ià(
g‘_œq
 && 
šfo
->
œq
 && !
IRQ_pÜts
[info->irq]) {

747 
§
.
§_hªdËr
 = 
rs_š‹¼u±
;

748 
§
.
§_æags
 = (
SA_INTERRUPT
);

749 
§
.
§_mask
 = 0;

750 
§
.
§_»¡Ü”
 = 
NULL
;

751 
»tv®
 = 
	`œqaùiÚ
(
šfo
->
œq
,&
§
);

752 ià(
»tv®
) {

753 
	`»¡Üe_æags
(
æags
);

754  
»tv®
;

762 ià(
šfo
->
ty³
 =ğ
PORT_16550A
) {

763 
	`£rŸl_ou
(
šfo
, 
UART_FCR
, (
UART_FCR_CLEAR_RCVR
 |

764 
UART_FCR_CLEAR_XMIT
));

765 
šfo
->
xm™_fifo_size
 = 16;

767 
šfo
->
xm™_fifo_size
 = 1;

772 ()
	`£rŸl_šp
(
šfo
, 
UART_LSR
);

773 ()
	`£rŸl_šp
(
šfo
, 
UART_RX
);

774 ()
	`£rŸl_šp
(
šfo
, 
UART_IIR
);

775 ()
	`£rŸl_šp
(
šfo
, 
UART_MSR
);

780 
	`£rŸl_ou
(
šfo
, 
UART_LCR
, 
UART_LCR_WLEN8
);

781 ià(
šfo
->
æags
 & 
ASYNC_FOURPORT
)

782 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
UART_MCR_DTR
 | 
UART_MCR_RTS
);

784 
	`£rŸl_ou
(
šfo
, 
UART_MCR
,

785 
UART_MCR_DTR
 | 
UART_MCR_RTS
 | 
UART_MCR_OUT2
);

790 #ifdeà
ISR_HACK


791 
šfo
->
IER
 = 
UART_IER_MSI
 | 
UART_IER_RLSI
 | 
UART_IER_RDI
;

792 
	`£rŸl_ou
(
šfo
, 
UART_IER
, info->
IER
);

794 
šfo
->
IER
 = (
UART_IER_MSI
 | 
UART_IER_RLSI
 |

795 
UART_IER_THRI
 | 
UART_IER_RDI
);

796 
	`£rŸl_ou
(
šfo
, 
UART_IER
, info->
IER
);

798 ià(
šfo
->
æags
 & 
ASYNC_FOURPORT
) {

800 
ICP
 = (
šfo
->
pÜt
 & 0xFE0) | 0x01F;

801 
	`outb_p
(0x80, 
ICP
);

802 (è
	`šb_p
(
ICP
);

808 ()
	`£rŸl_šp
(
šfo
, 
UART_LSR
);

809 ()
	`£rŸl_šp
(
šfo
, 
UART_RX
);

810 ()
	`£rŸl_šp
(
šfo
, 
UART_IIR
);

811 ()
	`£rŸl_šp
(
šfo
, 
UART_MSR
);

813 ià(
šfo
->
‰y
)

814 
	`ş—r_b™
(
TTY_IO_ERROR
, &
šfo
->
‰y
->
æags
);

818 ià(
šfo
->
‰y
 && info->‰y->
‹rmios
 && 
	`I_INPCK
(info->tty))

819 
šfo
->
»ad_¡©us_mask
 = (
UART_LSR_OE
 | 
UART_LSR_BI
 |

820 
UART_LSR_FE
 | 
UART_LSR_PE
);

822 
šfo
->
»ad_¡©us_mask
 = (
UART_LSR_OE
 | 
UART_LSR_BI
 |

823 
UART_LSR_FE
);

828 
šfo
->
´ev_pÜt
 = 0;

829 
šfo
->
Ãxt_pÜt
 = 
IRQ_pÜts
[šfo->
œq
];

830 ià(
šfo
->
Ãxt_pÜt
)

831 
šfo
->
Ãxt_pÜt
->
´ev_pÜt
 = info;

832 
IRQ_pÜts
[
šfo
->
œq
] = info;

833 
	`figu»_IRQ_timeout
(
šfo
->
œq
);

838 
IRQ_aùive
 |ğ1 << 
šfo
->
œq
;

839 
	`figu»_RS_tim”
();

844 
	`chªge_¥“d
(
šfo
->
lše
);

846 
šfo
->
æags
 |ğ
ASYNC_INITIALIZED
;

847 
	`»¡Üe_æags
(
æags
);

849 
	}
}

855 
	$shutdown
(
async_¡ruù
 * 
šfo
, 
do_ä“_œq
)

857 
æags
;

859 ià(!(
šfo
->
æags
 & 
ASYNC_INITIALIZED
))

862 #ifdeà
SERIAL_DEBUG_OPEN


863 
	`´štk
("Shu‰šg dowÀ£rŸÈpÜˆ%d (œq %d)....", 
šfo
->
lše
,

864 
šfo
->
œq
);

867 
	`§ve_æags
(
æags
); 
	`şi
();

872 ià(
šfo
->
Ãxt_pÜt
)

873 
šfo
->
Ãxt_pÜt
->
´ev_pÜt
 = info->prev_port;

874 ià(
šfo
->
´ev_pÜt
)

875 
šfo
->
´ev_pÜt
->
Ãxt_pÜt
 = info->next_port;

877 
IRQ_pÜts
[
šfo
->
œq
] = info->
Ãxt_pÜt
;

878 
	`figu»_IRQ_timeout
(
šfo
->
œq
);

883 ià(
do_ä“_œq
 && 
šfo
->
œq
 && !
IRQ_pÜts
[info->irq])

884 
	`ä“_œq
(
šfo
->
œq
);

886 
šfo
->
IER
 = 0;

887 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0x00);

888 ià(
šfo
->
æags
 & 
ASYNC_FOURPORT
) {

890 (è
	`šb
((
šfo
->
pÜt
 & 0xFE0) | 0x01F);

892 ià(
šfo
->
‰y
 && !(šfo->‰y->
‹rmios
->
c_cæag
 & 
HUPCL
))

893 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
UART_MCR_DTR
);

896 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 0x00);

899 
	`£rŸl_ou
(
šfo
, 
UART_FCR
, (
UART_FCR_CLEAR_RCVR
 |

900 
UART_FCR_CLEAR_XMIT
));

901 ()
	`£rŸl_š
(
šfo
, 
UART_RX
);

903 ià(
šfo
->
‰y
)

904 
	`£t_b™
(
TTY_IO_ERROR
, &
šfo
->
‰y
->
æags
);

906 
šfo
->
æags
 &ğ~
ASYNC_INITIALIZED
;

907 
	`»¡Üe_æags
(
æags
);

908 
	}
}

914 
	$chªge_¥“d
(
lše
)

916 
async_¡ruù
 * 
šfo
;

917 
pÜt
;

918 
quÙ
 = 0;

919 
cæag
,
cv®
,
mü
,
fü
;

920 
i
;

922 ià(
lše
 >ğ
NR_PORTS
)

924 
šfo
 = 
rs_bË
 + 
lše
;

925 ià(!
šfo
->
‰y
 || !šfo->‰y->
‹rmios
)

927 
cæag
 = 
šfo
->
‰y
->
‹rmios
->
c_cæag
;

928 ià(!(
pÜt
 = 
šfo
->port))

930 
i
 = 
cæag
 & 
CBAUD
;

931 ià(
i
 == 15) {

932 ià((
šfo
->
æags
 & 
ASYNC_SPD_MASK
è=ğ
ASYNC_SPD_HI
)

933 
i
 += 1;

934 ià((
šfo
->
æags
 & 
ASYNC_SPD_MASK
è=ğ
ASYNC_SPD_VHI
)

935 
i
 += 2;

936 ià((
šfo
->
æags
 & 
ASYNC_SPD_MASK
è=ğ
ASYNC_SPD_CUST
)

937 
quÙ
 = 
šfo
->
cu¡om_divisÜ
;

939 ià(
quÙ
) {

940 
šfo
->
timeout
 = ((šfo->
xm™_fifo_size
*
HZ
*15*
quÙ
) /

941 
šfo
->
baud_ba£
) + 2;

942 } ià(
baud_bË
[
i
] == 134) {

943 
quÙ
 = (2*
šfo
->
baud_ba£
 / 269);

944 
šfo
->
timeout
 = (šfo->
xm™_fifo_size
*
HZ
*30/269) + 2;

945 } ià(
baud_bË
[
i
]) {

946 
quÙ
 = 
šfo
->
baud_ba£
 / 
baud_bË
[
i
];

947 
šfo
->
timeout
 = (šfo->
xm™_fifo_size
*
HZ
*15/
baud_bË
[
i
]) + 2;

949 
quÙ
 = 0;

950 
šfo
->
timeout
 = 0;

952 
	`şi
();

953 
mü
 = 
	`£rŸl_š
(
šfo
, 
UART_MCR
);

954 ià(
quÙ
) {

955 
	`£rŸl_out
(
šfo
, 
UART_MCR
, 
mü
 | 
UART_MCR_DTR
);

957 
	`£rŸl_out
(
šfo
, 
UART_MCR
, 
mü
 & ~
UART_MCR_DTR
);

958 
	`¡i
();

961 
	`¡i
();

963 
cv®
 = 
cæag
 & (
CSIZE
 | 
CSTOPB
);

964 
cv®
 >>= 4;

965 ià(
cæag
 & 
PARENB
)

966 
cv®
 |ğ
UART_LCR_PARITY
;

967 ià(!(
cæag
 & 
PARODD
))

968 
cv®
 |ğ
UART_LCR_EPAR
;

969 ià(
šfo
->
ty³
 =ğ
PORT_16550A
) {

970 ià((
šfo
->
baud_ba£
 / 
quÙ
) < 2400)

971 
fü
 = 
UART_FCR_ENABLE_FIFO
 | 
UART_FCR_TRIGGER_1
;

973 
fü
 = 
UART_FCR_ENABLE_FIFO
 | 
UART_FCR_TRIGGER_8
;

975 
fü
 = 0;

977 
	`şi
();

978 
	`£rŸl_ou
(
šfo
, 
UART_LCR
, 
cv®
 | 
UART_LCR_DLAB
);

979 
	`£rŸl_ou
(
šfo
, 
UART_DLL
, 
quÙ
 & 0xff);

980 
	`£rŸl_ou
(
šfo
, 
UART_DLM
, 
quÙ
 >> 8);

981 
	`£rŸl_ou
(
šfo
, 
UART_LCR
, 
cv®
);

982 
	`£rŸl_ou
(
šfo
, 
UART_FCR
, 
fü
);

983 
	`¡i
();

984 
	}
}

999 
šlše
 
	$»¡¬t_pÜt
(
async_¡ruù
 *
šfo
)

1001 
‰y_queue
 * 
queue
;

1002 
h—d
, 

, 
couÁ
;

1004 ià(!
šfo
)

1007 ià(
	`£rŸl_šp
(
šfo
, 
UART_LSR
è& 
UART_LSR_THRE
) {

1008 ià(
šfo
->
x_ch¬
) {

1009 
	`£rŸl_ou
(
šfo
, 
UART_TX
, info->
x_ch¬
);

1010 
šfo
->
x_ch¬
 = 0;

1012 
queue
 = &
šfo
->
‰y
->
wr™e_q
;

1013 
h—d
 = 
queue
->head;

1014 

 = 
queue
->tail;

1015 
couÁ
 = 
šfo
->
xm™_fifo_size
;

1016 
couÁ
--) {

1017 ià(

 =ğ
h—d
)

1019 
	`£rŸl_ou
(
šfo
, 
UART_TX
, 
queue
->
buf
[

++]);

1020 

 &ğ
TTY_BUF_SIZE
-1;

1022 
queue
->

 =ail;

1025 
	}
}

1031 
	$rs_wr™e
(
‰y_¡ruù
 * 
‰y
)

1033 
async_¡ruù
 *
šfo
;

1035 ià(!
‰y
 ||ty->
¡İ³d
 ||ty->
hw_¡İ³d
)

1037 
šfo
 = 
rs_bË
 + 
	`DEV_TO_SL
(
‰y
->
lše
);

1038 
	`şi
();

1039 ià(!
šfo
 || !šfo->
‰y
 || !(šfo->
æags
 & 
ASYNC_INITIALIZED
)) {

1040 
	`¡i
();

1043 
	`»¡¬t_pÜt
(
šfo
);

1044 
šfo
->
IER
 = (
UART_IER_MSI
 | 
UART_IER_RLSI
 |

1045 
UART_IER_THRI
 | 
UART_IER_RDI
);

1046 #ifdeà
ISR_HACK


1047 
	`£rŸl_out
(
šfo
, 
UART_IER
, info->
IER
);

1049 
	`¡i
();

1050 
	}
}

1061 
	$rs_thrÙe
(
‰y_¡ruù
 * 
‰y
, 
¡©us
)

1063 
async_¡ruù
 *
šfo
;

1064 
mü
;

1065 
æags
;

1067 
	`§ve_æags
(
æags
); 
	`şi
();

1068 #ià
SERIAL_DEBUG_THROTTLE


1069 
	`´štk
("thrÙ‰y%d: %d (%d, %d)....\n", 
	`DEV_TO_SL
(
‰y
->
lše
),

1070 
¡©us
, 
	`LEFT
(&
‰y
->
»ad_q
), LEFT(&‰y->
£cÚd¬y
));

1072 
¡©us
) {

1073 
TTY_THROTTLE_RQ_FULL
:

1074 
šfo
 = 
rs_bË
 + 
	`DEV_TO_SL
(
‰y
->
lše
);

1075 ià(
	`I_IXOFF
(
‰y
)) {

1076 
šfo
->
x_ch¬
 = 
	`STOP_CHAR
(
‰y
);

1078 
mü
 = 
	`£rŸl_šp
(
šfo
, 
UART_MCR
);

1079 
mü
 &ğ~
UART_MCR_RTS
;

1080 
	`£rŸl_out
(
šfo
, 
UART_MCR
, 
mü
);

1083 
TTY_THROTTLE_RQ_AVAIL
:

1084 
šfo
 = 
rs_bË
 + 
	`DEV_TO_SL
(
‰y
->
lše
);

1085 ià(
	`I_IXOFF
(
‰y
)) {

1086 ià(
šfo
->
x_ch¬
)

1087 
šfo
->
x_ch¬
 = 0;

1089 
šfo
->
x_ch¬
 = 
	`START_CHAR
(
‰y
);

1091 
mü
 = 
	`£rŸl_š
(
šfo
, 
UART_MCR
);

1092 
mü
 |ğ
UART_MCR_RTS
;

1093 
	`£rŸl_out
(
šfo
, 
UART_MCR
, 
mü
);

1097 
	`»¡Üe_æags
(
æags
);

1098 
	}
}

1106 
	$g‘_£rŸl_šfo
(
async_¡ruù
 * 
šfo
,

1107 
£rŸl_¡ruù
 * 
»tšfo
)

1109 
£rŸl_¡ruù
 
tmp
;

1111 ià(!
»tšfo
)

1112  -
EFAULT
;

1113 
	`mem£t
(&
tmp
, 0, (tmp));

1114 
tmp
.
ty³
 = 
šfo
->type;

1115 
tmp
.
lše
 = 
šfo
->line;

1116 
tmp
.
pÜt
 = 
šfo
->port;

1117 
tmp
.
œq
 = 
šfo
->irq;

1118 
tmp
.
æags
 = 
šfo
->flags;

1119 
tmp
.
baud_ba£
 = 
šfo
->baud_base;

1120 
tmp
.
şo£_d–ay
 = 
šfo
->close_delay;

1121 
tmp
.
cu¡om_divisÜ
 = 
šfo
->custom_divisor;

1122 
tmp
.
hub6
 = 
šfo
->hub6;

1123 
	`memıy_tofs
(
»tšfo
,&
tmp
,(*retinfo));

1125 
	}
}

1127 
	$£t_£rŸl_šfo
(
async_¡ruù
 * 
šfo
,

1128 
£rŸl_¡ruù
 * 
Ãw_šfo
)

1130 
£rŸl_¡ruù
 
Ãw_£rŸl
;

1131 
async_¡ruù
 
Şd_šfo
;

1132 
i
,
chªge_œq
,
chªge_pÜt
;

1133 
»tv®
;

1134 
sigaùiÚ
 
§
;

1136 ià(!
Ãw_šfo
)

1137  -
EFAULT
;

1138 
	`memıy_äomfs
(&
Ãw_£rŸl
,
Ãw_šfo
,(new_serial));

1139 
Şd_šfo
 = *
šfo
;

1141 
chªge_œq
 = 
Ãw_£rŸl
.
œq
 !ğ
šfo
->irq;

1142 
chªge_pÜt
 = (
Ãw_£rŸl
.
pÜt
 !ğ
šfo
->pÜtè|| (Ãw_£rŸl.
hub6
 != info->hub6);

1144 ià(!
	`su£r
()) {

1145 ià(
chªge_œq
 || 
chªge_pÜt
 ||

1146 (
Ãw_£rŸl
.
baud_ba£
 !ğ
šfo
->baud_base) ||

1147 (
Ãw_£rŸl
.
ty³
 !ğ
šfo
->type) ||

1148 (
Ãw_£rŸl
.
şo£_d–ay
 !ğ
šfo
->close_delay) ||

1149 ((
Ãw_£rŸl
.
æags
 & ~
ASYNC_USR_MASK
) !=

1150 (
šfo
->
æags
 & ~
ASYNC_USR_MASK
)))

1151  -
EPERM
;

1152 
šfo
->
æags
 = ((šfo->æag & ~
ASYNC_USR_MASK
) |

1153 (
Ãw_£rŸl
.
æags
 & 
ASYNC_USR_MASK
));

1154 
šfo
->
cu¡om_divisÜ
 = 
Ãw_£rŸl
.custom_divisor;

1155 
check_ªd_ex™
;

1158 ià(
Ãw_£rŸl
.
œq
 == 2)

1159 
Ãw_£rŸl
.
œq
 = 9;

1161 ià((
Ãw_£rŸl
.
œq
 > 15è|| (Ãw_£rŸl.
pÜt
 > 0xffff) ||

1162 (
Ãw_£rŸl
.
ty³
 < 
PORT_UNKNOWN
è|| (Ãw_£rŸl.ty³ > 
PORT_MAX
)) {

1163  -
EINVAL
;

1167 
i
 = 0 ; i < 
NR_PORTS
; i++)

1168 ià((
šfo
 !ğ&
rs_bË
[
i
]) &&

1169 (
rs_bË
[
i
].
pÜt
 =ğ
Ãw_£rŸl
.pÜtè&&„s_bË[i].
ty³
)

1170  -
EADDRINUSE
;

1177 ià(
Ãw_£rŸl
.
pÜt
 &&‚ew_£rŸl.
ty³
 &&‚ew_£rŸl.
œq
 &&

1178 (
chªge_œq
 || !(
šfo
->
æags
 & 
ASYNC_INITIALIZED
))) {

1179 ià(!
IRQ_pÜts
[
Ãw_£rŸl
.
œq
]) {

1180 
§
.
§_hªdËr
 = 
rs_š‹¼u±
;

1181 
§
.
§_æags
 = (
SA_INTERRUPT
);

1182 
§
.
§_mask
 = 0;

1183 
§
.
§_»¡Ü”
 = 
NULL
;

1184 
»tv®
 = 
	`œqaùiÚ
(
Ãw_£rŸl
.
œq
,&
§
);

1185 ià(
»tv®
)

1186  
»tv®
;

1190 ià((
chªge_pÜt
 || 
chªge_œq
è&& (
šfo
->
couÁ
 > 1))

1191  -
EBUSY
;

1198 
šfo
->
baud_ba£
 = 
Ãw_£rŸl
.baud_base;

1199 
šfo
->
æags
 = ((šfo->æag & ~
ASYNC_FLAGS
) |

1200 (
Ãw_£rŸl
.
æags
 & 
ASYNC_FLAGS
));

1201 
šfo
->
cu¡om_divisÜ
 = 
Ãw_£rŸl
.custom_divisor;

1202 
šfo
->
ty³
 = 
Ãw_£rŸl
.type;

1203 
šfo
->
şo£_d–ay
 = 
Ãw_£rŸl
.close_delay;

1205 ià(
chªge_pÜt
 || 
chªge_œq
) {

1210 
	`shutdown
(
šfo
, 
chªge_œq
);

1211 
šfo
->
œq
 = 
Ãw_£rŸl
.irq;

1212 
šfo
->
pÜt
 = 
Ãw_£rŸl
.port;

1213 
šfo
->
hub6
 = 
Ãw_£rŸl
.hub6;

1216 
check_ªd_ex™
:

1217 ià(!
šfo
->
pÜt
 || !šfo->
ty³
)

1219 ià(
šfo
->
æags
 & 
ASYNC_INITIALIZED
) {

1220 ià(((
Şd_šfo
.
æags
 & 
ASYNC_SPD_MASK
) !=

1221 (
šfo
->
æags
 & 
ASYNC_SPD_MASK
)) ||

1222 (
Şd_šfo
.
cu¡om_divisÜ
 !ğ
šfo
->custom_divisor))

1223 
	`chªge_¥“d
(
šfo
->
lše
);

1225 (è
	`¡¬tup
(
šfo
, 0);

1227 
	}
}

1229 
	$g‘_modem_šfo
(
async_¡ruù
 * 
šfo
, *
v®ue
)

1231 
cÚŒŞ
, 
¡©us
;

1232 
»suÉ
;

1234 
	`şi
();

1235 
cÚŒŞ
 = 
	`£rŸl_š
(
šfo
, 
UART_MCR
);

1236 
¡©us
 = 
	`£rŸl_š
(
šfo
, 
UART_MSR
);

1237 
	`¡i
();

1238 
»suÉ
 = ((
cÚŒŞ
 & 
UART_MCR_RTS
è? 
TIOCM_RTS
 : 0)

1239 | ((
cÚŒŞ
 & 
UART_MCR_DTR
è? 
TIOCM_DTR
 : 0)

1240 | ((
¡©us
 & 
UART_MSR_DCD
è? 
TIOCM_CAR
 : 0)

1241 | ((
¡©us
 & 
UART_MSR_RI
è? 
TIOCM_RNG
 : 0)

1242 | ((
¡©us
 & 
UART_MSR_DSR
è? 
TIOCM_DSR
 : 0)

1243 | ((
¡©us
 & 
UART_MSR_CTS
è? 
TIOCM_CTS
 : 0);

1244 
	`put_fs_lÚg
(
»suÉ
,(*è
v®ue
);

1246 
	}
}

1248 
	$£t_modem_šfo
(
async_¡ruù
 * 
šfo
, 
cmd
,

1249 *
v®ue
)

1251 
cÚŒŞ
;

1252 
¬g
 = 
	`g‘_fs_lÚg
((*è
v®ue
);

1254 
	`şi
();

1255 
cÚŒŞ
 = 
	`£rŸl_š
(
šfo
, 
UART_MCR
);

1256 
	`¡i
();

1258 
cmd
) {

1259 
TIOCMBIS
:

1260 ià(
¬g
 & 
TIOCM_RTS
)

1261 
cÚŒŞ
 |ğ
UART_MCR_RTS
;

1262 ià(
¬g
 & 
TIOCM_DTR
)

1263 
cÚŒŞ
 |ğ
UART_MCR_DTR
;

1265 
TIOCMBIC
:

1266 ià(
¬g
 & 
TIOCM_RTS
)

1267 
cÚŒŞ
 &ğ~
UART_MCR_RTS
;

1268 ià(
¬g
 & 
TIOCM_DTR
)

1269 
cÚŒŞ
 &ğ~
UART_MCR_DTR
;

1271 
TIOCMSET
:

1272 
cÚŒŞ
 = (cÚŒŞ & ~(
UART_MCR_RTS
 | 
UART_MCR_DTR
))

1273 | ((
¬g
 & 
TIOCM_RTS
è? 
UART_MCR_RTS
 : 0)

1274 | ((
¬g
 & 
TIOCM_DTR
è? 
UART_MCR_DTR
 : 0);

1277  -
EINVAL
;

1279 
	`şi
();

1280 
	`£rŸl_out
(
šfo
, 
UART_MCR
, 
cÚŒŞ
);

1281 
	`¡i
();

1283 
	}
}

1285 
	$do_autocÚfig
(
async_¡ruù
 * 
šfo
)

1287 
»tv®
;

1289 ià(!
	`su£r
())

1290  -
EPERM
;

1292 ià(
šfo
->
couÁ
 > 1)

1293  -
EBUSY
;

1295 
	`shutdown
(
šfo
, 1);

1297 
	`şi
();

1298 
	`autocÚfig
(
šfo
);

1299 
	`¡i
();

1301 
»tv®
 = 
	`¡¬tup
(
šfo
, 1);

1302 ià(
»tv®
)

1303  
»tv®
;

1305 
	}
}

1311 
	$£nd_b»ak
Ğ
async_¡ruù
 * 
šfo
, 
du¿tiÚ
)

1313 ià(!
šfo
->
pÜt
)

1315 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1316 
cu¼’t
->
timeout
 = 
jiff›s
 + 
du¿tiÚ
;

1317 
	`şi
();

1318 
	`£rŸl_out
(
šfo
, 
UART_LCR
, 
	`£rŸl_šp
(šfo, UART_LCRè| 
UART_LCR_SBC
);

1319 
	`scheduË
();

1320 
	`£rŸl_out
(
šfo
, 
UART_LCR
, 
	`£rŸl_šp
(šfo, UART_LCRè& ~
UART_LCR_SBC
);

1321 
	`¡i
();

1322 
	}
}

1328 
	$check_wd_š‹¼u±s
(
dİršt
)

1330 
i
, 
mask
;

1331 
wd_š‹¼u±s
 = 0;

1332 
œq_lšes
;

1333 
timeout
;

1334 
æags
;

1337 
	`§ve_æags
(
æags
); 
	`¡i
();

1339 
œq_lšes
 = 
	`g¿b_®l_š‹¼u±s
(0);

1345 
timeout
 = 
jiff›s
+10;

1346 
timeout
 >ğ
jiff›s
)

1349 
rs_Œigg”ed
 = 0;

1351 
timeout
 = 
jiff›s
+10;

1352 
timeout
 >ğ
jiff›s
)

1355 
i
 = 0, 
mask
 = 1; i < 16; i++, mask <<= 1) {

1356 ià((
rs_Œigg”ed
 & (1 << 
i
)) &&

1357 (
œq_lšes
 & (1 << 
i
))) {

1358 
wd_š‹¼u±s
 |ğ
mask
;

1359 ià(
dİršt
)

1360 
	`´štk
("Wd iÁ”ru±? (IRQ %d)\n", 
i
);

1363 
	`ä“_®l_š‹¼u±s
(
œq_lšes
);

1364 
	`»¡Üe_æags
(
æags
);

1365  
wd_š‹¼u±s
;

1366 
	}
}

1368 
	$rs_ioùl
(
‰y_¡ruù
 *
‰y
, 
fe
 * file,

1369 
cmd
, 
¬g
)

1371 
”rÜ
, 
lše
;

1372 
async_¡ruù
 * 
šfo
;

1374 
lše
 = 
	`DEV_TO_SL
(
‰y
->line);

1375 ià(
lše
 < 0 ||†š>ğ
NR_PORTS
)

1376  -
ENODEV
;

1377 
šfo
 = 
rs_bË
 + 
lše
;

1379 
cmd
) {

1380 
TCSBRK
:

1381 ià(!
¬g
)

1382 
	`£nd_b»ak
(
šfo
, 
HZ
/4);

1384 
TCSBRKP
:

1385 
	`£nd_b»ak
(
šfo
, 
¬g
 ?‡rg*(
HZ
/10) : HZ/4);

1387 
TIOCGSOFTCAR
:

1388 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,());

1389 ià(
”rÜ
)

1390  
”rÜ
;

1391 
	`put_fs_lÚg
(
	`C_CLOCAL
(
‰y
) ? 1 : 0,

1392 (*è
¬g
);

1394 
TIOCSSOFTCAR
:

1395 
¬g
 = 
	`g‘_fs_lÚg
((*)‡rg);

1396 
‰y
->
‹rmios
->
c_cæag
 =

1397 ((
‰y
->
‹rmios
->
c_cæag
 & ~
CLOCAL
) |

1398 (
¬g
 ? 
CLOCAL
 : 0));

1400 
TIOCMGET
:

1401 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

1403 ià(
”rÜ
)

1404  
”rÜ
;

1405  
	`g‘_modem_šfo
(
šfo
, (*è
¬g
);

1406 
TIOCMBIS
:

1407 
TIOCMBIC
:

1408 
TIOCMSET
:

1409  
	`£t_modem_šfo
(
šfo
, 
cmd
, (*è
¬g
);

1410 
TIOCGSERIAL
:

1411 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

1412 (
£rŸl_¡ruù
));

1413 ià(
”rÜ
)

1414  
”rÜ
;

1415  
	`g‘_£rŸl_šfo
(
šfo
,

1416 (
£rŸl_¡ruù
 *è
¬g
);

1417 
TIOCSSERIAL
:

1418  
	`£t_£rŸl_šfo
(
šfo
,

1419 (
£rŸl_¡ruù
 *è
¬g
);

1420 
TIOCSERCONFIG
:

1421  
	`do_autocÚfig
(
šfo
);

1423 
TIOCSERGWILD
:

1424 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

1426 ià(
”rÜ
)

1427  
”rÜ
;

1428 
	`put_fs_lÚg
(
rs_wd_št_mask
, (*è
¬g
);

1431 
TIOCSERSWILD
:

1432 ià(!
	`su£r
())

1433  -
EPERM
;

1434 
rs_wd_št_mask
 = 
	`g‘_fs_lÚg
((*è
¬g
);

1435 ià(
rs_wd_št_mask
 < 0)

1436 
rs_wd_št_mask
 = 
	`check_wd_š‹¼u±s
(0);

1440  -
EINVAL
;

1443 
	}
}

1445 
	$rs_£t_‹rmios
(
‰y_¡ruù
 *
‰y
, 
‹rmios
 *
Şd_‹rmios
)

1447 
async_¡ruù
 *
šfo
;

1449 ià(
‰y
->
‹rmios
->
c_cæag
 =ğ
Şd_‹rmios
->c_cflag)

1452 
šfo
 = &
rs_bË
[
	`DEV_TO_SL
(
‰y
->
lše
)];

1454 
	`chªge_¥“d
(
	`DEV_TO_SL
(
‰y
->
lše
));

1456 ià((
Şd_‹rmios
->
c_cæag
 & 
CRTSCTS
) &&

1457 !(
‰y
->
‹rmios
->
c_cæag
 & 
CRTSCTS
)) {

1458 
‰y
->
hw_¡İ³d
 = 0;

1459 
	`rs_wr™e
(
‰y
);

1462 ià(!(
Şd_‹rmios
->
c_cæag
 & 
CLOCAL
) &&

1463 (
‰y
->
‹rmios
->
c_cæag
 & 
CLOCAL
))

1464 
	`wake_up_š‹¼u±ibË
(&
šfo
->
İ’_wa™
);

1466 ià(
	`I_INPCK
(
‰y
))

1467 
šfo
->
»ad_¡©us_mask
 = (
UART_LSR_OE
 | 
UART_LSR_BI
 |

1468 
UART_LSR_FE
 | 
UART_LSR_PE
);

1470 
šfo
->
»ad_¡©us_mask
 = (
UART_LSR_OE
 | 
UART_LSR_BI
 |

1471 
UART_LSR_FE
);

1472 
	}
}

1484 
	$rs_şo£
(
‰y_¡ruù
 *
‰y
, 
fe
 * 
fp
)

1486 
async_¡ruù
 * 
šfo
;

1487 
lše
;

1489 ià(
	`‰y_hung_up_p
(
fp
))

1492 
lše
 = 
	`DEV_TO_SL
(
‰y
->line);

1493 ià((
lše
 < 0è|| (lš>ğ
NR_PORTS
))

1495 
šfo
 = 
rs_bË
 + 
lše
;

1496 #ifdeà
SERIAL_DEBUG_OPEN


1497 
	`´štk
("rs_şo£tys%d, couÁ = %d\n", 
šfo
->
lše
, info->
couÁ
);

1499 ià((
‰y
->
couÁ
 =ğ1è&& (
šfo
->count != 1)) {

1507 
	`´štk
("rs_close: bad serial…ort count;ty->count is 1, "

1508 "šfo->couÁ i %d\n", 
šfo
->
couÁ
);

1509 
šfo
->
couÁ
 = 1;

1511 ià(--
šfo
->
couÁ
 < 0) {

1512 
	`´štk
("rs_close: bad serial…ort count fortys%d: %d\n",

1513 
šfo
->
lše
, info->
couÁ
);

1514 
šfo
->
couÁ
 = 0;

1516 ià(
šfo
->
couÁ
)

1518 
šfo
->
æags
 |ğ
ASYNC_CLOSING
;

1523 ià(
šfo
->
æags
 & 
ASYNC_NORMAL_ACTIVE
)

1524 
šfo
->
nÜm®_‹rmios
 = *
‰y
->
‹rmios
;

1525 ià(
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
)

1526 
šfo
->
ÿÎout_‹rmios
 = *
‰y
->
‹rmios
;

1527 
‰y
->
¡İ³d
 = 0;

1528 
‰y
->
hw_¡İ³d
 = 0;

1529 ià(
šfo
->
æags
 & 
ASYNC_INITIALIZED
) {

1530 
	`rs_¡¬t
(
‰y
);

1531 
	`wa™_uÁ_£Á
(
‰y
, 6000);

1533 
	`æush_ouut
(
‰y
);

1534 
	`æush_šput
(
‰y
);

1535 
	`şi
();

1540 ià(!(
	`£rŸl_šp
(
šfo
, 
UART_LSR
è& 
UART_LSR_THRE
)) {

1541 
	`rs_¡¬t
(
‰y
);

1542 
	`š‹¼u±ibË_¦“p_Ú
(&
šfo
->
xm™_wa™
);

1544 
	`¡i
();

1545 
	`shutdown
(
šfo
, 1);

1546 
	`ş—r_b™
(
lše
, 
rs_ev’t
);

1547 
šfo
->
ev’t
 = 0;

1548 
šfo
->
‰y
 = 0;

1549 ià(
šfo
->
blocked_İ’
) {

1550 ià(
šfo
->
şo£_d–ay
) {

1551 
‰y
->
couÁ
++;

1552 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1553 
cu¼’t
->
timeout
 = 
jiff›s
 + 
šfo
->
şo£_d–ay
;

1554 
	`scheduË
();

1555 
‰y
->
couÁ
--;

1557 
	`wake_up_š‹¼u±ibË
(&
šfo
->
İ’_wa™
);

1559 
šfo
->
æags
 &ğ~(
ASYNC_NORMAL_ACTIVE
|
ASYNC_CALLOUT_ACTIVE
|

1560 
ASYNC_CLOSING
);

1561 
	`wake_up_š‹¼u±ibË
(&
šfo
->
şo£_wa™
);

1562 
	}
}

1567 
	$rs_hªgup
(
‰y_¡ruù
 *
‰y
)

1569 
async_¡ruù
 * 
šfo
;

1570 
lše
;

1572 
lše
 = 
	`DEV_TO_SL
(
‰y
->line);

1573 ià((
lše
 < 0è|| (lš>ğ
NR_PORTS
))

1575 
šfo
 = 
rs_bË
 + 
lše
;

1577 
	`shutdown
(
šfo
, 1);

1578 
	`ş—r_b™
(
lše
, 
rs_ev’t
);

1579 
šfo
->
ev’t
 = 0;

1580 
šfo
->
couÁ
 = 0;

1581 
šfo
->
æags
 &ğ~(
ASYNC_NORMAL_ACTIVE
|
ASYNC_CALLOUT_ACTIVE
);

1582 
šfo
->
‰y
 = 0;

1583 
	`wake_up_š‹¼u±ibË
(&
šfo
->
İ’_wa™
);

1584 
	}
}

1591 
	$block_t_»ady
(
‰y_¡ruù
 *
‰y
, 
fe
 * 
fp
,

1592 
async_¡ruù
 *
šfo
)

1594 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

1595 
»tv®
;

1596 
do_şoÿl
 = 
	`C_CLOCAL
(
‰y
);

1602 ià(
šfo
->
æags
 & 
ASYNC_CLOSING
) {

1603 
	`š‹¼u±ibË_¦“p_Ú
(&
šfo
->
şo£_wa™
);

1604 #ifdeà
SERIAL_DO_RESTART


1605 ià(
šfo
->
æags
 & 
ASYNC_HUP_NOTIFY
)

1606  -
EAGAIN
;

1608  -
ERESTARTSYS
;

1610  -
EAGAIN
;

1618 ià(
	`MAJOR
(
fp
->
f_rdev
è=ğ
TTYAUX_MAJOR
) {

1619 ià(
šfo
->
æags
 & 
ASYNC_NORMAL_ACTIVE
)

1620  -
EBUSY
;

1621 ià((
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
) &&

1622 (
šfo
->
æags
 & 
ASYNC_SESSION_LOCKOUT
) &&

1623 (
šfo
->
£ssiÚ
 !ğ
cu¼’t
->session))

1624  -
EBUSY
;

1625 ià((
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
) &&

1626 (
šfo
->
æags
 & 
ASYNC_PGRP_LOCKOUT
) &&

1627 (
šfo
->
pg½
 !ğ
cu¼’t
->pgrp))

1628  -
EBUSY
;

1629 
šfo
->
æags
 |ğ
ASYNC_CALLOUT_ACTIVE
;

1637 ià(
fp
->
f_æags
 & 
O_NONBLOCK
) {

1638 ià(
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
)

1639  -
EBUSY
;

1640 
šfo
->
æags
 |ğ
ASYNC_NORMAL_ACTIVE
;

1651 
»tv®
 = 0;

1652 
	`add_wa™_queue
(&
šfo
->
İ’_wa™
, &
wa™
);

1653 #ifdeà
SERIAL_DEBUG_OPEN


1654 
	`´štk
("block_til_ready before block:tys%d, count = %d\n",

1655 
šfo
->
lše
, info->
couÁ
);

1657 
šfo
->
couÁ
--;

1658 
šfo
->
blocked_İ’
++;

1660 
	`şi
();

1661 ià(!(
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
))

1662 
	`£rŸl_out
(
šfo
, 
UART_MCR
,

1663 
	`£rŸl_šp
(
šfo
, 
UART_MCR
) |

1664 (
UART_MCR_DTR
 | 
UART_MCR_RTS
));

1665 
	`¡i
();

1666 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1667 ià(
	`‰y_hung_up_p
(
fp
) ||

1668 !(
šfo
->
æags
 & 
ASYNC_INITIALIZED
)) {

1669 #ifdeà
SERIAL_DO_RESTART


1670 ià(
šfo
->
æags
 & 
ASYNC_HUP_NOTIFY
)

1671 
»tv®
 = -
EAGAIN
;

1673 
»tv®
 = -
ERESTARTSYS
;

1675 
»tv®
 = -
EAGAIN
;

1679 ià(!(
šfo
->
æags
 & 
ASYNC_CALLOUT_ACTIVE
) &&

1680 !(
šfo
->
æags
 & 
ASYNC_CLOSING
) &&

1681 (
do_şoÿl
 || (
	`£rŸl_š
(
šfo
, 
UART_MSR
) &

1682 
UART_MSR_DCD
)))

1684 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1685 
»tv®
 = -
ERESTARTSYS
;

1688 #ifdeà
SERIAL_DEBUG_OPEN


1689 
	`´štk
("block_til_ready blocking:tys%d, count = %d\n",

1690 
šfo
->
lše
, info->
couÁ
);

1692 
	`scheduË
();

1694 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1695 
	`»move_wa™_queue
(&
šfo
->
İ’_wa™
, &
wa™
);

1696 ià(!
	`‰y_hung_up_p
(
fp
))

1697 
šfo
->
couÁ
++;

1698 
šfo
->
blocked_İ’
--;

1699 #ifdeà
SERIAL_DEBUG_OPEN


1700 
	`´štk
("block_til_ready‡fter blocking:tys%d, count = %d\n",

1701 
šfo
->
lše
, info->
couÁ
);

1703 ià(
»tv®
)

1704  
»tv®
;

1705 
šfo
->
æags
 |ğ
ASYNC_NORMAL_ACTIVE
;

1707 
	}
}

1715 
	$rs_İ’
(
‰y_¡ruù
 *
‰y
, 
fe
 * 
fp
)

1717 
async_¡ruù
 *
šfo
;

1718 
»tv®
, 
lše
;

1720 
lše
 = 
	`DEV_TO_SL
(
‰y
->line);

1721 ià((
lše
 < 0è|| (lš>ğ
NR_PORTS
))

1722  -
ENODEV
;

1723 
šfo
 = 
rs_bË
 + 
lše
;

1724 #ifdeà
SERIAL_DEBUG_OPEN


1725 
	`´štk
("rs_İ’tys%d, couÁ = %d\n", 
šfo
->
lše
, info->
couÁ
);

1727 
šfo
->
couÁ
++;

1728 
šfo
->
‰y
 =ty;

1730 
‰y
->
wr™e
 = 
rs_wr™e
;

1731 
‰y
->
şo£
 = 
rs_şo£
;

1732 
‰y
->
ioùl
 = 
rs_ioùl
;

1733 
‰y
->
thrÙe
 = 
rs_thrÙe
;

1734 
‰y
->
£t_‹rmios
 = 
rs_£t_‹rmios
;

1735 
‰y
->
¡İ
 = 
rs_¡İ
;

1736 
‰y
->
¡¬t
 = 
rs_¡¬t
;

1737 
‰y
->
hªgup
 = 
rs_hªgup
;

1738 ià((
šfo
->
couÁ
 =ğ1è&& (šfo->
æags
 & 
ASYNC_SPLIT_TERMIOS
)) {

1739 ià(
	`MAJOR
(
fp
->
f_rdev
è=ğ
TTY_MAJOR
)

1740 *
‰y
->
‹rmios
 = 
šfo
->
nÜm®_‹rmios
;

1742 *
‰y
->
‹rmios
 = 
šfo
->
ÿÎout_‹rmios
;

1747 
»tv®
 = 
	`¡¬tup
(
šfo
, 1);

1748 ià(
»tv®
)

1749  
»tv®
;

1751 
»tv®
 = 
	`block_t_»ady
(
‰y
, 
fp
, 
šfo
);

1752 ià(
»tv®
) {

1753 #ifdeà
SERIAL_DEBUG_OPEN


1754 
	`´štk
("rs_open„eturning‡fter block_til_ready with %d\n",

1755 
»tv®
);

1757  
»tv®
;

1760 
šfo
->
£ssiÚ
 = 
cu¼’t
->session;

1761 
šfo
->
pg½
 = 
cu¼’t
->pgrp;

1763 #ifdeà
SERIAL_DEBUG_OPEN


1764 
	`´štk
("rs_İ’tys%d sucûssful...", 
šfo
->
lše
);

1767 
	}
}

1782 
	$show_£rŸl_v”siÚ
()

1784 
	`´štk
("Serial driver version 3.99a with");

1785 #ifdeà
CONFIG_AST_FOURPORT


1786 
	`´štk
(" AST_FOURPORT");

1787 
	#SERIAL_OPT


	)

1789 #ifdeà
CONFIG_ACCENT_ASYNC


1790 
	`´štk
(" ACCENT_ASYNC");

1791 
	#SERIAL_OPT


	)

1793 #ifdeà
CONFIG_HUB6


1794 
	`´štk
(" HUB-6");

1795 
	#SERIAL_OPT


	)

1797 #ifdeà
CONFIG_AUTO_IRQ


1798 
	`´štk
 (" AUTO_IRQ");

1799 
	#SERIAL_OPT


	)

1801 #ifdeà
SERIAL_OPT


1802 
	`´štk
("ƒnabled\n");

1804 
	`´štk
("‚o serial optionsƒnabled\n");

1806 #undeà
SERIAL_OPT


1807 
	}
}

1814 
	$g‘_auto_œq
(
async_¡ruù
 *
šfo
)

1816 
§ve_MCR
, 
§ve_IER
, 
§ve_ICP
=0;

1817 
ICP
=0, 
pÜt
 = 
šfo
->port;

1818 
timeout
;

1823 
rs_œq_Œigg”ed
 = 0;

1824 
	`şi
();

1825 
§ve_IER
 = 
	`£rŸl_šp
(
šfo
, 
UART_IER
);

1826 
§ve_MCR
 = 
	`£rŸl_šp
(
šfo
, 
UART_MCR
);

1827 ià(
šfo
->
æags
 & 
ASYNC_FOURPORT
) {

1828 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
UART_MCR_DTR
 | 
UART_MCR_RTS
);

1829 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0x0f);

1830 
ICP
 = (
pÜt
 & 0xFE0) | 0x01F;

1831 
§ve_ICP
 = 
	`šb_p
(
ICP
);

1832 
	`outb_p
(0x80, 
ICP
);

1833 (è
	`šb_p
(
ICP
);

1835 
	`£rŸl_ou
(
šfo
, 
UART_MCR
,

1836 
UART_MCR_DTR
 | 
UART_MCR_RTS
 | 
UART_MCR_OUT2
);

1837 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0x0f);

1839 
	`¡i
();

1843 ()
	`£rŸl_šp
(
šfo
, 
UART_LSR
);

1844 ()
	`£rŸl_šp
(
šfo
, 
UART_RX
);

1845 ()
	`£rŸl_šp
(
šfo
, 
UART_IIR
);

1846 ()
	`£rŸl_šp
(
šfo
, 
UART_MSR
);

1848 
timeout
 = 
jiff›s
+2;

1849 
timeout
 >ğ
jiff›s
) {

1850 ià(
rs_œq_Œigg”ed
)

1856 
	`şi
();

1857 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 
§ve_IER
);

1858 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
§ve_MCR
);

1859 ià(
šfo
->
æags
 & 
ASYNC_FOURPORT
)

1860 
	`outb_p
(
§ve_ICP
, 
ICP
);

1861 
	`¡i
();

1862 (
rs_œq_Œigg”ed
);

1863 
	}
}

1869 
	$do_auto_œq
(
async_¡ruù
 * 
šfo
)

1871 
pÜt
 = 
šfo
->port;

1872 
œq_lšes
 = 0;

1873 
œq_Œy_1
 = 0, 
œq_Œy_2
 = 0;

1874 
»Œ›s
;

1875 
æags
;

1877 ià(!
pÜt
)

1881 
	`§ve_æags
(
æags
); 
	`¡i
();

1883 
œq_lšes
 = 
	`g¿b_®l_š‹¼u±s
(
rs_wd_št_mask
);

1885 
»Œ›s
 = 0;„etries < 5;„etries++) {

1886 ià(!
œq_Œy_1
)

1887 
œq_Œy_1
 = 
	`g‘_auto_œq
(
šfo
);

1888 ià(!
œq_Œy_2
)

1889 
œq_Œy_2
 = 
	`g‘_auto_œq
(
šfo
);

1890 ià(
œq_Œy_1
 && 
œq_Œy_2
) {

1891 ià(
œq_Œy_1
 =ğ
œq_Œy_2
)

1893 
œq_Œy_1
 = 
œq_Œy_2
 = 0;

1896 
	`»¡Üe_æags
(
æags
);

1897 
	`ä“_®l_š‹¼u±s
(
œq_lšes
);

1898  (
œq_Œy_1
 =ğ
œq_Œy_2
) ? irq_try_1 : 0;

1899 
	}
}

1908 
	$autocÚfig
(
async_¡ruù
 * 
šfo
)

1910 
¡©us1
, 
¡©us2
, 
sü©ch
, 
sü©ch2
;

1911 
pÜt
 = 
šfo
->port;

1912 
æags
;

1914 
šfo
->
ty³
 = 
PORT_UNKNOWN
;

1916 ià(!
pÜt
)

1919 
	`§ve_æags
(
æags
); 
	`şi
();

1925 
sü©ch
 = 
	`£rŸl_šp
(
šfo
, 
UART_IER
);

1926 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 0);

1927 
sü©ch2
 = 
	`£rŸl_šp
(
šfo
, 
UART_IER
);

1928 
	`£rŸl_ou
(
šfo
, 
UART_IER
, 
sü©ch
);

1929 ià(
sü©ch2
) {

1930 
	`»¡Üe_æags
(
æags
);

1943 ià(!(
šfo
->
æags
 & 
ASYNC_SKIP_TEST
)) {

1944 
sü©ch
 = 
	`£rŸl_šp
(
šfo
, 
UART_MCR
);

1945 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
UART_MCR_LOOP
 | 
sü©ch
);

1946 
sü©ch2
 = 
	`£rŸl_šp
(
šfo
, 
UART_MSR
);

1947 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
UART_MCR_LOOP
 | 0x0A);

1948 
¡©us1
 = 
	`£rŸl_šp
(
šfo
, 
UART_MSR
) & 0xF0;

1949 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 
sü©ch
);

1950 
	`£rŸl_ou
(
šfo
, 
UART_MSR
, 
sü©ch2
);

1951 ià(
¡©us1
 != 0x90) {

1952 
	`»¡Üe_æags
(
æags
);

1961 ià(
šfo
->
æags
 & 
ASYNC_AUTO_IRQ
)

1962 
šfo
->
œq
 = 
	`do_auto_œq
(info);

1964 
	`£rŸl_ou
(
šfo
, 
UART_FCR
, 
UART_FCR_ENABLE_FIFO
);

1965 
sü©ch
 = 
	`£rŸl_š
(
šfo
, 
UART_IIR
) >> 6;

1966 
šfo
->
xm™_fifo_size
 = 1;

1967 
sü©ch
) {

1969 
šfo
->
ty³
 = 
PORT_16450
;

1972 
šfo
->
ty³
 = 
PORT_UNKNOWN
;

1975 
šfo
->
ty³
 = 
PORT_16550
;

1978 
šfo
->
ty³
 = 
PORT_16550A
;

1979 
šfo
->
xm™_fifo_size
 = 16;

1982 ià(
šfo
->
ty³
 =ğ
PORT_16450
) {

1983 
sü©ch
 = 
	`£rŸl_š
(
šfo
, 
UART_SCR
);

1984 
	`£rŸl_ou
(
šfo
, 
UART_SCR
, 0xa5);

1985 
¡©us1
 = 
	`£rŸl_š
(
šfo
, 
UART_SCR
);

1986 
	`£rŸl_ou
(
šfo
, 
UART_SCR
, 0x5a);

1987 
¡©us2
 = 
	`£rŸl_š
(
šfo
, 
UART_SCR
);

1988 
	`£rŸl_ou
(
šfo
, 
UART_SCR
, 
sü©ch
);

1990 ià((
¡©us1
 !ğ0xa5è|| (
¡©us2
 != 0x5a))

1991 
šfo
->
ty³
 = 
PORT_8250
;

1997 
	`£rŸl_ou
(
šfo
, 
UART_MCR
, 0x00);

1998 
	`£rŸl_ou
(
šfo
, 
UART_FCR
, (
UART_FCR_CLEAR_RCVR
 |

1999 
UART_FCR_CLEAR_XMIT
));

2000 ()
	`£rŸl_š
(
šfo
, 
UART_RX
);

2002 
	`»¡Üe_æags
(
æags
);

2003 
	}
}

2008 
	$rs_š™
(
kmem_¡¬t
)

2010 
i
;

2011 
async_¡ruù
 * 
šfo
;

2013 
	`mem£t
(&
rs_ev’t
, 0, (rs_event));

2014 
bh_ba£
[
SERIAL_BH
].
routše
 = 
do_soášt
;

2015 
tim”_bË
[
RS_TIMER
].
â
 = 
rs_tim”
;

2016 
tim”_bË
[
RS_TIMER
].
expœes
 = 0;

2017 
IRQ_aùive
 = 0;

2018 #ifdeà
CONFIG_AUTO_IRQ


2019 
rs_wd_št_mask
 = 
	`check_wd_š‹¼u±s
(1);

2022 
i
 = 0; i < 16; i++) {

2023 
IRQ_pÜts
[
i
] = 0;

2024 
IRQ_timeout
[
i
] = 0;

2027 
	`show_£rŸl_v”siÚ
();

2028 
i
 = 0, 
šfo
 = 
rs_bË
; i < 
NR_PORTS
; i++,info++) {

2029 
šfo
->
lše
 = 
i
;

2030 
šfo
->
‰y
 = 0;

2031 
šfo
->
ty³
 = 
PORT_UNKNOWN
;

2032 
šfo
->
cu¡om_divisÜ
 = 0;

2033 
šfo
->
şo£_d–ay
 = 50;

2034 
šfo
->
x_ch¬
 = 0;

2035 
šfo
->
ev’t
 = 0;

2036 
šfo
->
couÁ
 = 0;

2037 
šfo
->
blocked_İ’
 = 0;

2038 
	`mem£t
(&
šfo
->
ÿÎout_‹rmios
, 0, (
‹rmios
));

2039 
	`mem£t
(&
šfo
->
nÜm®_‹rmios
, 0, (
‹rmios
));

2040 
šfo
->
İ’_wa™
 = 0;

2041 
šfo
->
xm™_wa™
 = 0;

2042 
šfo
->
şo£_wa™
 = 0;

2043 
šfo
->
Ãxt_pÜt
 = 0;

2044 
šfo
->
´ev_pÜt
 = 0;

2045 ià(
šfo
->
œq
 == 2)

2046 
šfo
->
œq
 = 9;

2047 ià(!(
šfo
->
æags
 & 
ASYNC_BOOT_AUTOCONF
))

2049 
	`autocÚfig
(
šfo
);

2050 ià(
šfo
->
ty³
 =ğ
PORT_UNKNOWN
)

2052 
	`´štk
("‰y%02d% © 0x%04x (œq = %d)", 
šfo
->
lše
,

2053 (
šfo
->
æags
 & 
ASYNC_FOURPORT
) ? " FourPort" : "",

2054 
šfo
->
pÜt
, info->
œq
);

2055 
šfo
->
ty³
) {

2056 
PORT_8250
:

2057 
	`´štk
(" is‡ 8250\n");

2059 
PORT_16450
:

2060 
	`´štk
(" is‡ 16450\n");

2062 
PORT_16550
:

2063 
	`´štk
(" is‡ 16550\n");

2065 
PORT_16550A
:

2066 
	`´štk
(" is‡ 16550A\n");

2069 
	`´štk
("\n");

2073  
kmem_¡¬t
;

2074 
	}
}

	@drivers/char/tpqic02.c

146 
	~<lšux/cÚfig.h
>

149 #ià
CONFIG_TAPE_QIC02


155 
	#REALLY_SLOW_IO


	)

157 
	~<lšux/sched.h
>

158 
	~<lšux/tim”.h
>

159 
	~<lšux/fs.h
>

160 
	~<lšux/k”Ãl.h
>

161 
	~<lšux/majÜ.h
>

162 
	~<lšux/”ºo.h
>

163 
	~<lšux/mtio.h
>

164 
	~<lšux/fú.h
>

165 
	~<lšux/d–ay.h
>

166 
	~<lšux/qic02.h
>

168 
	~<asm/dma.h
>

169 
	~<asm/sy¡em.h
>

170 
	~<asm/io.h
>

171 
	~<asm/£gm’t.h
>

174 #ià!
defšed
(
TAPE_QIC02_PORT
) || \

175 !
defšed
(
TAPE_QIC02_IRQ
) || \

176 !
	$defšed
(
TAPE_QIC02_DMA
)

177 #”rÜ 
³_qic02
 
cÚfigu¿tiÚ
 
”rÜ


181 
	#TPQIC_NAME
 "qic02"

	)

187 vŞ©
ùlb™s
 = 0;

189 
wa™_queue
 *
³_qic02_Œªsãr
 = 
NULL
;

191 vŞ©
mtg‘
 
ioùl_¡©us
;

193 vŞ©
¡©us
 
”rÜ
;

195 
rcs_»visiÚ
[] = "$Revision: 0.2.1.21 $";

196 
rcs_d©e
[] = "$Date: 1993/06/18 19:04:33 $";

203 vŞ©
æag
 
¡©us_d—d
 = 
YES
;

204 
æag
 
¡©us_İ’
 = 
NO
;

206 vŞ©
æag
 
¡©us_by‹s_wr
 = 
NO
;

207 vŞ©
æag
 
¡©us_by‹s_rd
 = 
NO
;

209 vŞ©
¡©us_cmd_³ndšg
 = 0;

210 vŞ©
æag
 
¡©us_ex³ù_št
 = 
NO
;

211 vŞ©
æag
 
¡©us_tim”_Ú
 = 
NO
;

212 vŞ©
¡©us_”rÜ
 = 0;

213 vŞ©
æag
 
¡©us_eof_d‘eùed
 = 
NO
;

214 vŞ©
æag
 
¡©us_eom_d‘eùed
 = 
NO
;

215 vŞ©
æag
 
¡©us_eÙ_d‘eùed
 = 
NO
;

216 vŞ©
æag
 
došg_»ad
 = 
NO
;

217 vŞ©
æag
 
došg_wr™e
 = 
NO
;

219 vŞ©
dma_by‹s_todo
;

220 vŞ©
dma_by‹s_dÚe
;

221 vŞ©
dma_mode
 = 0;

222 
æag
 
Ãed_»wšd
 = 
YES
;

224 
dev_t
 
cu¼’t_³_dev
 = 
QIC02_TAPE_MAJOR
 << 8;

225 
exŒa_blocks_Ëá
 = 
BLOCKS_BEYOND_EW
;

240 
æag
 
»tuº_»ad_eof
 = 
NO
;

241 
æag
 
»tuº_wr™e_eof
 = 
NO
;

242 
æag
 
»pÜ‹d_»ad_eof
 = 
NO
;

243 
æag
 
»pÜ‹d_wr™e_eof
 = 
NO
;

246 #ifdeà
TP_HAVE_SEEK


248 
£ek_addr_buf
[
SEEK_BUF_SIZE
];

257 
mode_acûss
;

271 vŞ©
³_qic02_buf
[
TPQBUF_SIZE
+
TAPE_BLKSIZE
];

274 
bufçddr
;

278 *
fÜm©_Çmes
[] = {

286 
	}
};

304 
	sexû±iÚ_li¡_ty³
 {

305 
	mmask
, 
	mcode
;

306 *
	mmsg
;

307 } 
	gexû±iÚ_li¡
[] = {

310 {~(
TP_WRP
|
TP_USL
), 
TP_ST0
|
TP_CNI
,

316 {-1, 
TP_ST0
|
TP_CNI
|
TP_USL
|
TP_WRP
,

318 {~(
TP_ST1
|
TP_BOM
), 
TP_ST0
|
TP_WRP
,

320 {~(
TP_ST1
|
TP_EOR
), 
TP_ST0
|
TP_EOM
,

322 {~
TP_WRP
, 
TP_ST0
|
TP_UDA
| 
TP_ST1
|
TP_BOM
,

324 {~
TP_WRP
, 
TP_ST0
|
TP_UDA
,

326 {~
TP_WRP
, 
TP_ST0
|
TP_UDA
|
TP_BNL
,

328 {~
TP_WRP
, 
TP_ST0
|
TP_UDA
|
TP_BNL
 |
TP_ST1
|
TP_NDT
,

330 {~
TP_WRP
, 
TP_ST0
|
TP_EOM
|
TP_UDA
|
TP_BNL
 |
TP_ST1
|
TP_NDT
,

332 {~(
TP_WRP
|
TP_MBD
|
TP_PAR
|
TP_EOR
), 
TP_ST0
|
TP_UDA
|
TP_BNL
 |
TP_ST1
|
TP_NDT
|
TP_BOM
,

334 {~(
TP_WRP
|
TP_EOM
), 
TP_ST0
|
TP_FIL
,

340 {~(
TP_ST0
|
TP_CNI
|
TP_USL
|
TP_WRP
|
TP_BOM
), 
TP_ST1
|
TP_ILL
,

342 {~(
TP_ST0
|
TP_CNI
|
TP_USL
|
TP_WRP
|
TP_BOM
), 
TP_ST1
|
TP_POR
,

344 {~
TP_WRP
, 
TP_ST0
|
TP_FIL
|
TP_MBD
,

346 {~(
TP_ST0
|
TP_WRP
|
TP_EOM
|
TP_UDA
|
TP_BNL
|
TP_FIL
 |
TP_NDT
), 
TP_ST1
|
TP_EOR
,

350 {~(
TP_WRP
|
TP_ST0
), 
TP_ST1
|
TP_BOM
,

352 #ifdeà
CYPHER_BUG


358 ,{-1, 
TP_ST1
,

362 
	#NR_OF_EXC
 ((
exû±iÚ_li¡
)/(
exû±iÚ_li¡_ty³
))

	)

366 
	$qputs
(*
s
)

368 
	`´štk
(
TPQIC_NAME
 ": %s\n", 
s
);

369 
	}
}

377 
šlše
 
	$by‹_sw­_w
(vŞ©* 
w
)

379 
t
 = *
w
;

381 *
w
 = (
t
>>8) | ((t & 0xff)<<8);

382 
	}
}

391 
	$ifc_š™
()

393 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


394 
ùlb™s
 = 
WT_CTL_ONLINE
;

395 
	`outb_p
(
ùlb™s
, 
QIC_CTL_PORT
);

397 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


398 
ùlb™s
 = 0;

399 
	`outb_p
(
ùlb™s
, 
QIC_CTL_PORT
);

400 
	`outb_p
(0, 
AR_RESET_DMA_PORT
);

402 #”rÜ 
No
 
v®id
 
š‹rçû
 
ÿrd
 
¥ecif›d


404 
	}
}

407 
	$»pÜt_exû±iÚ
(
n
)

409 ià(
n
 >ğ
NR_OF_EXC
è{ 
	`qputs
("Oops --„eport_exception");‚ = 0; }

410 
	`´štk
(
TPQIC_NAME
 ": s’£: %s\n", 
exû±iÚ_li¡
[
n
].
msg
);

411 
	}
}

419 
	$decode_exû±iÚ_Ä
(
s
)

421 
i
;

423 
i
=1; i<
NR_OF_EXC
; i++) {

424 ià((
s
 & 
exû±iÚ_li¡
[
i
].
mask
)=óxû±iÚ_li¡[i].
code
)

425  
i
;

427 
	`qputs
("decode_exception_nr:ƒxception‚ot„ecognized");

429 
	}
}

432 #ifdeà
OBSOLETE


440 
	$»pÜt_”rÜ
(
s
)

442 
n
 = -1;

444 ià(
s
 & 
TP_ST1
) {

445 ià(
s
 & 
TP_ILL
)

446 
n
 = 12;

447 ià(
s
 & 
TP_POR
)

448 
n
 = 13;

450 ià(
s
 & 
TP_ST0
) {

451 ià(
s
 & 
TP_EOR
) {

452 
n
 = 15;

455 ià(
s
 & 
TP_EOM
)

456 
n
 = 4;

457 ià(
s
 & 
TP_USL
)

458 
n
 = 2;

459 ià(
s
 & 
TP_CNI
) {

460 
n
 = 1;

461 
Ãed_»wšd
 = 
YES
;

462 
¡©us_eof_d‘eùed
 = 
NO
;

463 
¡©us_eom_d‘eùed
 = 
NO
;

465 ià(
s
 & 
TP_UDA
) {

466 ià(
s
 & 
TP_BNL
) {

467 ià(
s
 & 
TP_NDT
) {

468 ià(
s
 & 
TP_BOM
)

469 
n
 = 9;

470 ià(
s
 & 
TP_EOM
)

471 
n
 = 10;

473 
n
 = 8;

475 
	`qputs
("[Bad block -- filler dataransferred.]");

476 
n
 = 7;

480 ià(
s
 & 
TP_EOM
)

481 
n
 = 5;

487 
	`qputs
("[CRC failed!]");

488 
n
 = 6;

492 ià(
s
 & 
TP_FIL
) {

493 ià(
s
 & 
TP_MBD
) {

494 
	`qputs
("[Marginal block]");

495 
n
 = 14;

497 
n
 = 11;

499 ià(
s
 & 
TP_WRP
)

500 
n
 = 3;

502 ià(
n
 >= 0)

503 
	`£n£msg
(
n
);

504 
	}
}

509 
	$hªdË_exû±iÚ
(
exÄ
, 
exb™s
)

511 ià(
exÄ
==
EXC_NCART
) {

517 
Ãed_»wšd
 = 
YES
;

518 
¡©us_eof_d‘eùed
 = 
NO
;

519 
¡©us_eom_d‘eùed
 = 
NO
;

521 ià(
exÄ
==
EXC_XFILLER
)

522 
	`qputs
("[Bad block -- filler dataransferred.]");

523 ià(
exÄ
==
EXC_XBAD
)

524 
	`qputs
("[CRC failed!]");

525 ià(
exÄ
==
EXC_MARGINAL
) {

529 
	`qputs
("[Marginal block]");

530 
došg_»ad
 = 
NO
;

531 } ià(
exÄ
==
EXC_FM
)

532 
došg_»ad
 = 
NO
;

533 
	}
}

536 
šlše
 
	$is_exû±iÚ
()

538  (
	`šb
(
QIC_STAT_PORT
è& 
QIC_STAT_EXCEPTION
) == 0;

539 
	}
}

546 
	$³_»£t
(
v”bo£
)

548 
	`ifc_š™
();

550 
	`outb_p
(
ùlb™s
 | 
QIC_CTL_RESET
, 
QIC_CTL_PORT
);

553 
	`ud–ay
(30);

556 
¡©us_eof_d‘eùed
 = 
NO
;

557 
¡©us_eom_d‘eùed
 = 
NO
;

558 
¡©us_cmd_³ndšg
 = 0;

559 
Ãed_»wšd
 = 
YES
;

560 
došg_»ad
 = 
došg_wr™e
 = 
NO
;

561 
ioùl_¡©us
.
mt_f’o
 = ioùl_¡©us.
mt_blkno
 = 0;

563 
	`outb_p
(
ùlb™s
 & ~
QIC_CTL_RESET
, 
QIC_CTL_PORT
);

565 { 
¡©
 = 
	`šb_p
(
QIC_STAT_PORT
);

566 
¡©us_d—d
 = ((
¡©
 & 
QIC_STAT_RESETMASK
è!ğ
QIC_STAT_RESETVAL
); }

568 ià(
¡©us_d—d
)

569 
	`´štk
(
TPQIC_NAME
 ":„eset failed!\n");

570 ià(
v”bo£
)

571 
	`´štk
(
TPQIC_NAME
 ":„eset successful\n");

573  (
¡©us_d—d
)? 
TE_DEAD
 : 
TE_OK
;

574 
	}
}

587 
	$nÙify_cmd
(
cmd
, 
ignÜe_ex
)

589 
i
;

591 
	`outb_p
(
cmd
, 
QIC_CMD_PORT
);

594 
	`ud–ay
(1);

596 ià((!
ignÜe_ex
è&& 
	`is_exû±iÚ
()) {

597 
	`qputs
("***ƒxception detected in‚otify_cmd");

599 ià(
	`³_»£t
(1)==
TE_DEAD
)

600  
TE_DEAD
;

601 ià(
	`is_exû±iÚ
()) {

602 
	`qputs
("exception…ersists‡fter„eset.");

603 
	`qputs
(" ^ƒxception ignored.");

607 
	`outb_p
(
ùlb™s
 | 
QIC_CTL_REQUEST
, 
QIC_CTL_PORT
);

608 
i
 = 
TAPE_NOTIFY_TIMEOUT
;

613 (
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_READY
è&& (--
i
>0))

615 ià(
i
==0) {

616 
	`qputs
("timed out waiting for„eady in‚otify_cmd");

617 
¡©us_d—d
 = 
YES
;

618  
TE_TIM
;

621 
	`outb_p
(
ùlb™s
 & ~
QIC_CTL_REQUEST
, 
QIC_CTL_PORT
);

622 
i
 = 
TAPE_NOTIFY_TIMEOUT
;

624 ((
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_READY
è=ğ0è&& (--
i
>0))

626 ià(
i
==0) {

627 
	`qputs
("timed out waiting for !ready in‚otify_cmd");

628 
¡©us_d—d
 = 
YES
;

629  
TE_TIM
;

632  
TE_OK
;

633 
	}
}

638 
	$wa™_fÜ_»ady
(
time_t
 
timeout
)

640 
¡©
;

641 
time_t
 
¥š_t
;

649 
¥š_t
 = 50;

650 ((
¡©
 = 
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
è=ğQIC_STAT_MASKè&& (--
¥š_t
>0))

652 ià((
¡©
 & 
QIC_STAT_READY
) == 0)

653  
TE_OK
;

656 
¥š_t
 = 3;

657 ià(
¥š_t
 > 
timeout
)

658 
¥š_t
 = 
timeout
;

659 
timeout
 -ğ
¥š_t
;

660 
¥š_t
 +ğ
jiff›s
;

662 ((
¡©
 = 
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
è=ğQIC_STAT_MASKè&& (
jiff›s
<
¥š_t
))

663 
	`scheduË
();

664 ià((
¡©
 & 
QIC_STAT_READY
) == 0)

665  
TE_OK
;

673 
¥š_t
 +ğ
timeout
;

674 
	`TPQDEB
({
	`´štk
("wa™_fÜ_»ady:‡dd™iÚ®imeout: %d\n", 
¥š_t
);})

677 ((
¡©
 = 
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
è=ğQIC_STAT_MASKè&& (
jiff›s
<
¥š_t
)) {

679 
cu¼’t
->
timeout
 = 
jiff›s
 + 30;

680 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

681 
	`scheduË
();

685 ià((
¡©
 & 
QIC_STAT_MASK
) == QIC_STAT_MASK) {

686 
	`qputs
("wait_for_ready()imed out");

687  
TE_TIM
;

690 ià((
¡©
 & 
QIC_STAT_EXCEPTION
) == 0) {

691 
	`qputs
("exception detected‡fter waiting_for_ready");

692  
TE_EX
;

694  
TE_OK
;

696 
	}
}

700 
	$£nd_qic02_d©a
(
sb
[], 
size
, 
ignÜe_ex
)

702 
i
, 
¡©
;

704 
i
=0; i<
size
; i++) {

706 
¡©
 = 
	`wa™_fÜ_»ady
(
TIM_S
);

707 ià(
¡©
 !ğ
TE_OK
)

708  
¡©
;

710 
¡©
 = 
	`nÙify_cmd
(
sb
[
i
], 
ignÜe_ex
);

711 ià(
¡©
 !ğ
TE_OK
)

712  
¡©
;

714  
TE_OK
;

716 
	}
}

726 
	$£nd_qic02_cmd
(
cmd
, 
time_t
 
timeout
, 
ignÜe_ex
)

728 
¡©
;

730 
¡©
 = 
	`šb_p
(
QIC_STAT_PORT
);

731 ià((
¡©
 & 
QIC_STAT_EXCEPTION
) == 0) {

732 
	`qputs
("send_qic02_cmd: Exception!");

733  
TE_EX
;

735 ià(
¡©
 & 
QIC_STAT_READY
) {

736 
	`qputs
("send_qic02_cmd:‚ot Ready!");

737  
TE_ERR
;

745 
¡©us_cmd_³ndšg
 = 
cmd
;

747 
¡©
 = 
	`nÙify_cmd
(
cmd
, 
ignÜe_ex
);

749 ià(
cmd
 =ğ
QCMDV_SEEK_BLK
) {

751 
¡©
 = 
	`£nd_qic02_d©a
(
£ek_addr_buf
, (£ek_addr_buf), 
ignÜe_ex
);

753 ià(
¡©
 !ğ
TE_OK
) {

754 
	`qputs
("send_qic02_cmd failed");

756  
¡©
;

757 
	}
}

765 
	$rd¡©us
(*
¡p
, 
size
, 
qcmd
)

767 
s
, 
n
;

768 *
q
 = 
¡p
;

777 
n
 = 1000;

778 (
n
>0è&& ((
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
) == QIC_STAT_MASK))

779 
n
--;

780 ià(
n
==0) {

785 
	`qputs
("waiting†ooong in„dstatus() -- drive dead?");

786 (
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
) == QIC_STAT_MASK)

787 
	`scheduË
();

788 
	`qputs
("finished waiting in„dstatus()");

791 (è
	`nÙify_cmd
(
qcmd
, 1);

796 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

797 
	`´štk
(
TPQIC_NAME
 ":„eading status bytes: ");

799 
q
=
¡p
; q<¡p+
size
; q++)

801 dØ
s
 = 
	`šb_p
(
QIC_STAT_PORT
);

802 (
s
 & 
QIC_STAT_MASK
) == QIC_STAT_MASK);

804 ià((
s
 & 
QIC_STAT_EXCEPTION
) == 0) {

805 
	`qputs
("rdstatus:ƒxceptionƒrror");

806 
ioùl_¡©us
.
mt_”»g
 = 0;

807  
TE_NS
;

810 *
q
 = 
	`šb_p
(
QIC_DATA_PORT
);

812 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

813 
	`´štk
("[%1d]=0x%x ", 
q
-
¡p
, () (*q) & 0xff);

815 
	`outb_p
(
ùlb™s
 | 
QIC_CTL_REQUEST
, 
QIC_CTL_PORT
);

817 (
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_READY
) == 0);

819 
	`ud–ay
(22);

821 
	`outb_p
(
ùlb™s
 & ~
QIC_CTL_REQUEST
, 
QIC_CTL_PORT
);

828 
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_READY
)

831 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

832 
	`´štk
("\n");

834  
TE_OK
;

835 
	}
}

843 
	$g‘_¡©us
(*
¡p
)

845 
¡©
 = 
	`rd¡©us
(
¡p
, 
TPSTATSIZE
, 
QCMD_RD_STAT
);

846 #ià
	`defšed
(
i386
è|| defšed(
i486
)

847 
	`by‹_sw­_w
(&
”rÜ
.
dec
);

848 
	`by‹_sw­_w
(&
”rÜ
.
urc
);

852  
¡©
;

853 
	}
}

864 
	$g‘_ext_¡©us3
()

866 
vus
[64];

867 
¡©
, 
i
;

869 
	`qputs
("Attemptingo„ead Extended Status 3...");

870 
¡©
 = 
	`rd¡©us
(
vus
, (vus), 
QCMD_RD_STAT_X3
);

871 ià(
¡©
 !ğ
TE_OK
)

872  
¡©
;

874 
	`qputs
("Returned status bytes:");

875 
i
=0; i<(
vus
); i++) {

876 iàĞ
i
 % 8 == 0 )

877 
	`´štk
("\n" 
TPQIC_NAME
 ": %2d:");

878 
	`´štk
(" %2x", 
vus
[
i
] & 0xff);

880 
	`´štk
("\n");

882  
TE_OK
;

883 
	}
}

890 
	$_£n£
(
ignÜe
)

892 
”r
 = 0, 
exÄ
 = 0, 
gs
 = 0;

893 
	`fšish_rw
(
cmd
);

895 
	`´štk
(
TPQIC_NAME
 ":p_£n£(ignÜe=0x%xè’‹r\n", 
ignÜe
);

898 ià(
došg_wr™e
 =ğ
YES
)

899 
	`qputs
("Warning: File Mark inserted because of sense()„equest");

901 ià((
došg_»ad
!=
NO
è|| (
došg_wr™e
!=NO))

902 
	`fšish_rw
(
QCMD_RD_STAT
);

904 ià(
	`g‘_¡©us
((*è&
”rÜ
è!ğ
TE_OK
) {

905 
	`qputs
("tp_sense: could‚ot„eadape drive status");

906  
TE_ERR
;

909 
”r
 = 
”rÜ
.
exs
;

910 ià(
”r
 & (
TP_ST0
|
TP_ST1
))

911 
	`´štk
(
TPQIC_NAME
 ":p_sense: status: %x,ƒrror count: %d, underruns: %d\n",

912 
”rÜ
.
exs
,³¼Ü.
dec
,³¼Ü.
urc
);

914 
	`´štk
(
TPQIC_NAME
 ":p_sense:‚oƒrrors‡t‡ll, softƒrror count: %d, underruns: %d\n",

915 
”rÜ
.
dec
,³¼Ü.
urc
);

921 ià(
”r
 & 
TP_ST0
) {

922 ià(
”r
 & 
TP_CNI
)

923 
gs
 |ğ
	`GMT_DR_OPEN
(-1);

924 ià(
¡©us_d—d
 =ğ
NO
)

925 
gs
 |ğ
	`GMT_ONLINE
(-1);

926 ià(
”r
 & 
TP_USL
)

927 
gs
 &ğ~
	`GMT_ONLINE
(-1);

928 ià(
”r
 & 
TP_WRP
)

929 
gs
 |ğ
	`GMT_WR_PROT
(-1);

930 ià(
”r
 & 
TP_EOM
) {

931 
gs
 |ğ
	`GMT_EOT
(-1);

932 
¡©us_eom_d‘eùed
 = 
YES
;

934 
¡©us_eof_d‘eùed
 = 
YES
;

938 ià(
”r
 & 
TP_FIL
) {

939 
gs
 |ğ
	`GMT_EOF
(-1);

940 
¡©us_eof_d‘eùed
 = 
YES
;

943 ià(
”r
 & 
TP_ST1
) {

947 ià(
”r
 & 
TP_BOM
)

948 
gs
 |ğ
	`GMT_BOT
(-1);

950 
ioùl_¡©us
.
mt_g¡©
 = 
gs
;

951 
ioùl_¡©us
.
mt_d¤eg
 = 
”rÜ
.
exs
;

952 
ioùl_¡©us
.
mt_”»g
 = 
”rÜ
.
dec
;

954 ià(
”r
!=0) {

955 
exÄ
 = 
	`decode_exû±iÚ_Ä
(
”r
);

956 
	`hªdË_exû±iÚ
(
exÄ
, 
”r
);

957 
	`»pÜt_exû±iÚ
(
exÄ
);

959 
”r
 &ğ~
ignÜe
;

960 ià(((
”r
 & 
TP_ST0
è&& (”¸& 
REPORT_ERR0
)) ||

961 ((
”r
 & 
TP_ST1
è&& (”¸& 
REPORT_ERR1
)))

962  
TE_ERR
;

963  
TE_OK
;

964 
	}
}

971 
	$wa™_fÜ_»wšd
(
time_t
 
timeout
)

973 
¡©
;

975 
¡©
 = 
	`šb
(
QIC_STAT_PORT
è& 
QIC_STAT_MASK
;

976 
	`´štk
(
TPQIC_NAME
 ": Wa™šg fÜ (»-)wšdØfšish: st=0x%x\n", 
¡©
);

978 
¡©
 = 
	`wa™_fÜ_»ady
(
timeout
);

980 ià(
¡©
 !ğ
TE_OK
) {

981 
	`qputs
("(re-) winding failed\n");

983  
¡©
;

984 
	}
}

994 
	$Î_do_qic_cmd
(
cmd
, 
time_t
 
timeout
)

996 
¡©
;

998 ià(
¡©us_d—d
) {

999 
	`qputs
("Drive is dead. Do‡ `mt„eset`.");

1000  -
ENXIO
;

1003 
¡©
 = 
	`wa™_fÜ_»ady
(
timeout
);

1004 ià(
¡©
 =ğ
TE_EX
) {

1005 ià(
	`_£n£
(
TP_WRP
|
TP_BOM
|
TP_EOM
|
TP_FIL
)!=
TE_OK
)

1006  -
EIO
;

1008 
¡©
 = 
TE_OK
;

1010 ià(
¡©
 !ğ
TE_OK
) {

1011 
	`´štk
(
TPQIC_NAME
 ":†l_do_qic_cmd(%x, %dèçed\n", 
cmd
, 
timeout
);

1012  -
EIO
;

1016 #ià
OBSOLETE


1018 (
	`šb_p
(
QIC_STAT_PORT
è& 
QIC_STAT_READY
) != 0);

1021 
¡©
 = 
	`£nd_qic02_cmd
(
cmd
, 
timeout
, 0);

1023 ià(
cmd
==
QCMD_RD_FM
) {

1024 
¡©us_eof_d‘eùed
 = 
NO
;

1025 
ioùl_¡©us
.
mt_f’o
++;

1029 } ià(
cmd
==
QCMD_WRT_FM
) {

1030 
¡©us_eof_d‘eùed
 = 
NO
;

1031 
ioùl_¡©us
.
mt_f’o
++;

1032 } ià((
cmd
==
QCMD_REWIND
è|| (cmd==
QCMD_ERASE
è|| (cmd==
QCMD_RETEN
)) {

1033 
¡©us_eof_d‘eùed
 = 
NO
;

1034 
¡©us_eom_d‘eùed
 = 
NO
;

1035 
¡©us_eÙ_d‘eùed
 = 
NO
;

1036 
Ãed_»wšd
 = 
NO
;

1037 
ioùl_¡©us
.
mt_f’o
 = ioùl_¡©us.
mt_blkno
 = 0;

1038 
exŒa_blocks_Ëá
 = 
BLOCKS_BEYOND_EW
;

1039 
»tuº_wr™e_eof
 = 
NO
;

1040 
»tuº_»ad_eof
 = 
NO
;

1041 
»pÜ‹d_»ad_eof
 = 
NO
;

1042 
»pÜ‹d_wr™e_eof
 = 
NO
;

1045 ià(
¡©
==
TE_EX
) {

1046 ià(
	`_£n£
(
TP_WRP
|
TP_BOM
|
TP_EOM
|
TP_FIL
)!=
TE_OK
) {

1047 
	`´štk
(
TPQIC_NAME
 ": Exû±iÚ…”si¡ iÀÎ_do_qic_cmd[1](%x, %d)", 
cmd
, 
timeout
);

1048 
¡©us_d—d
 = 
YES
;

1049  -
ENXIO
;

1053 ià(
¡©
!=
TE_OK
) {

1054 
	`´štk
(
TPQIC_NAME
 ":†l_do_qic_cmd: s’d_qic02_cmd faed, sˆğ0x%x\n", 
¡©
);

1055  -
EIO
;

1059 ià(
timeout
 =ğ
TIM_R
)

1060 
¡©
 = 
	`wa™_fÜ_»wšd
(
timeout
);

1062 
¡©
 = 
	`wa™_fÜ_»ady
(
timeout
);

1064 ià(
¡©
==
TE_EX
) {

1065 ià(
	`_£n£
((
cmd
==
QCMD_SEEK_EOD
 ?

1066 
TP_EOR
|
TP_NDT
|
TP_UDA
|
TP_BNL
|
TP_WRP
|
TP_BOM
|
TP_EOM
|
TP_FIL
 :

1067 
TP_WRP
|
TP_BOM
|
TP_EOM
|
TP_FIL
))!=
TE_OK
) {

1068 
	`´štk
(
TPQIC_NAME
 ": Exû±iÚ…”si¡ iÀÎ_do_qic_cmd[2](%x, %d)\n", 
cmd
, 
timeout
);

1069 ià(
cmd
!=
QCMD_RD_FM
)

1070 
¡©us_d—d
 = 
YES
;

1071  -
ENXIO
;

1075 ià(
¡©
!=
TE_OK
) {

1076 
	`´štk
(
TPQIC_NAME
 ":†l_do_qic_cmd %x: wa™ faed, sˆ=ğ0x%x\n", 
cmd
, 
¡©
);

1077  -
EIO
;

1080 
	}
}

1108 
	$‹rmš©e_»ad
(
cmd
)

1110 ià(
došg_»ad
 =ğ
YES
) {

1111 
došg_»ad
 = 
NO
;

1112 ià(
cmd
 !ğ
QCMD_RD_FM
) {

1116 
	`qputs
("terminating…ending„ead-cycle");

1117 ià(
	`_£n£
(
TP_FIL
|
TP_EOM
|
TP_WRP
è!ğ
TE_OK
) {

1118 
	`qputs
("finish_rw[read1]: ignorehe 2†ines‡bove");

1119 ià(
	`is_exû±iÚ
()) {

1120 ià(
	`_£n£
(
TP_ILL
|
TP_FIL
|
TP_EOM
|
TP_WRP
è!ğ
TE_OK
)

1121 
	`qputs
("finish_rw[read2]:„ead cycleƒrror");

1126 
	}
}

1129 
	$‹rmš©e_wr™e
(
cmd
)

1131 
¡©
;

1133 ià(
došg_wr™e
 =ğ
YES
) {

1134 
došg_wr™e
 = 
NO
;

1136 ià(
cmd
 !ğ
QCMD_WRT_FM
) {

1138 
¡©
 = 
	`Î_do_qic_cmd
(
QCMD_WRT_FM
, 
TIM_M
);

1139 ià(
¡©
 !ğ
TE_OK
)

1140 
	`qputs
("Couldn't finish write cycle…roperly");

1141 (è
	`_£n£
(0);

1147 
»pÜ‹d_wr™e_eof
=
YES
;

1149 
	}
}

1153 
	$fšish_rw
(
cmd
)

1155 ià(
	`wa™_fÜ_»ady
(
TIM_S
è!ğ
TE_OK
) {

1156 
	`qputs
("error: drive‚ot„eady in finish_rw() !");

1159 
	`‹rmš©e_»ad
(
cmd
);

1160 
	`‹rmš©e_wr™e
(
cmd
);

1161 
	}
}

1168 
	$do_qic_cmd
(
cmd
, 
time_t
 
timeout
)

1170 
¡©
;

1173 
	`fšish_rw
(
cmd
);

1175 ià(
Ãed_»wšd
) {

1176 
	`qputs
("Rewindingape...");

1177 
¡©
 = 
	`Î_do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

1178 ià(
¡©
 != 0) {

1179 
	`´štk
(
TPQIC_NAME
 ":„ewšd faed iÀdo_qic_cmd(). st=0x%2x", 
¡©
);

1180  
¡©
;

1182 
Ãed_»wšd
 = 
NO
;

1183 ià(
cmd
==
QCMD_REWIND
)

1187  
	`Î_do_qic_cmd
(
cmd
, 
timeout
);

1188 
	}
}

1195 
	$do_ioùl_cmd
(
cmd
)

1197 
¡©
;

1205 
cmd
) {

1206 
MTRESET
:

1208  (
	`³_»£t
(1)==
TE_OK
)? 0 : -
EIO
;

1210 
MTFSF
:

1211 
	`qputs
("MTFSF forward searching filemark");

1212 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1213  -
EACCES
;

1214  
	`do_qic_cmd
(
QCMD_RD_FM
, 
TIM_F
);

1216 
MTBSF
:

1217 #ifdeà
TP_HAVE_BSF


1218 
	`qputs
("MTBSF backward searching filemark -- optional command");

1219 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1220  -
EACCES
;

1221 
¡©
 = 
	`do_qic_cmd
(
QCMD_RD_FM_BCK
, 
TIM_F
);

1223 
	`qputs
("MTBSF‚ot supported");

1224 
¡©
 = -
ENXIO
;

1226 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1227  
¡©
;

1229 
MTFSR
:

1230 #ifdeà
TP_HAVE_FSR


1231 
	`qputs
("MTFSR forward space„ecord");

1232 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1233  -
EACCES
;

1234 
¡©
 = 
	`do_qic_cmd
(
QCMD_SPACE_FWD
, 
TIM_F
);

1237 
	`qputs
("MTFSR‚ot supported");

1238 
¡©
 = -
ENXIO
;

1240  
¡©
;

1242 
MTBSR
:

1243 #ifdeà
TP_HAVE_BSR


1245 
	`qputs
("MTFSR backward space„ecord");

1246 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1247  -
EACCES
;

1248 
¡©
 = 
	`do_qic_cmd
(
QCMD_SPACE_BCK
, 
TIM_F
);

1250 
	`qputs
("MTBSR‚ot supported");

1251 
¡©
 = -
ENXIO
;

1253 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1254  
¡©
;

1256 
MTWEOF
:

1257 
	`qputs
("MTWEOF writeƒof mark");

1259 ià(
mode_acûss
==
READ
)

1260  -
EACCES
;

1263 
¡©us_by‹s_rd
 = 
¡©us_by‹s_wr
;

1264 
¡©us_by‹s_wr
 = 
NO
;

1265  
	`do_qic_cmd
(
QCMD_WRT_FM
, 
TIM_M
);

1268 
MTREW
:

1269 
	`qputs
("MTREW„ewindingape");

1270 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1271  -
EACCES
;

1272 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1273  
	`do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

1275 
MTOFFL
:

1276 
	`qputs
("MTOFFL„ewinding & going offline");

1282 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1283  -
EACCES
;

1284 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1286 
¡©
 = 
	`do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

1287  
¡©
;

1289 
MTNOP
:

1290 
	`qputs
("MTNOP setting status only");

1292  (
	`_£n£
(-1)==
TE_OK
)? 0 : -
EIO
;

1294 
MTRETEN
:

1295 
	`qputs
("MTRETEN„etensionape");

1296 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1297  -
EACCES
;

1298 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1299  
	`do_qic_cmd
(
QCMD_RETEN
, 
TIM_R
);

1301 
MTBSFM
:

1306 
	`qputs
("MTBSFM‚ot supported");

1307 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1308  -
EACCES
;

1309  -
ENXIO
;

1311 
MTFSFM
:

1319 
	`qputs
("MTFSFM‚ot supported");

1320 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1321  -
EACCES
;

1322  -
ENXIO
;

1324 
MTEOM
:

1329 
	`qputs
("MTEOM search for End Of„ecorded Media");

1330 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1331  -
EACCES
;

1332 #ifdeà
TP_HAVE_EOD


1336 #ià
TAPE_QIC02_DRIVE
 =ğ
MT_ISWT5150


1342 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1344 
¡©
 = 
	`do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

1345 ià(
¡©
)

1346  
¡©
;

1349 
¡©
 = 
	`do_qic_cmd
(
QCMD_SEEK_EOD
, 
TIM_F
);

1353 
¡©
 = 0;

1354 (
¡©
==0è&& (!
¡©us_eom_d‘eùed
)) {

1355 
¡©
 = 
	`do_qic_cmd
(
QCMD_RD_FM
, 
TIM_F
);

1357 ià(
”rÜ
.
exs
 & 
TP_NDT
)

1360  
¡©
;

1362 
MTERASE
:

1363 
	`qputs
("MTERASE -- ERASE TAPE !");

1364 ià((
”rÜ
.
exs
 & 
TP_ST0
è&& (”rÜ.ex & 
TP_WRP
)) {

1365 
	`qputs
("Cartridge is write-protected.");

1366  -
EACCES
;

1368 
time_t
 
t
 = 
jiff›s
;

1370 
jiff›s
 - 
t
 < 3*
HZ
)

1371 
	`scheduË
();

1375 ià(
mode_acûss
==
READ
)

1376  -
EACCES
;

1379 
¡©us_eom_d‘eùed
 = 
¡©us_eof_d‘eùed
 = 
NO
;

1380  
	`do_qic_cmd
(
QCMD_ERASE
, 
TIM_R
);

1383 
MTRAS1
:

1384 #ifdeà
TP_HAVE_RAS1


1385 
	`qputs
("MTRAS1:‚on-destructive selfest");

1386 
¡©
 = 
	`do_qic_cmd
(
QCMD_SELF_TST1
, 
TIM_R
);

1387 ià(
¡©
 != 0) {

1388 
	`qputs
("RAS1 failed");

1389  
¡©
;

1391  (
	`_£n£
(0)==
TE_OK
)? 0 : -
EIO
;

1393 
	`qputs
("RAS1‚ot supported");

1394  -
ENXIO
;

1397 
MTRAS2
:

1398 #ifdeà
TP_HAVE_RAS2


1399 
	`qputs
("MTRAS2: destructive selfest");

1400 
¡©
 = 
	`do_qic_cmd
(
QCMD_SELF_TST2
, 
TIM_R
);

1401 ià(
¡©
 != 0) {

1402 
	`qputs
("RAS2 failed");

1403  
¡©
;

1405  (
	`_£n£
(0)==
TE_OK
)? 0 : -
EIO
;

1407 
	`qputs
("RAS2‚ot supported");

1408  -
ENXIO
;

1411 #ifdeà
TP_HAVE_SEEK


1412 
MTSEEK
:

1413 
	`qputs
("MTSEEK seeking block");

1414 ià((
mode_acûss
==
WRITE
è&& 
¡©us_by‹s_wr
)

1415  -
EACCES
;

1417  
	`do_qic_cmd
(
QCMDV_SEEK_BLK
, 
TIM_F
);

1421  -
ENOTTY
;

1423 
	}
}

1444 
šlše
 
	$dma_Œªsãr
()

1447 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


1448 
	`outb_p
(
WT_CTL_ONLINE
, 
QIC_CTL_PORT
);

1449 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


1450 
	`outb_p
(0, 
AR_RESET_DMA_PORT
);

1453 
	`ş—r_dma_ff
(
TAPE_QIC02_DMA
);

1454 
	`£t_dma_mode
(
TAPE_QIC02_DMA
, 
dma_mode
);

1455 
	`£t_dma_addr
(
TAPE_QIC02_DMA
, 
bufçddr
+
dma_by‹s_dÚe
);

1456 
	`£t_dma_couÁ
(
TAPE_QIC02_DMA
, 
TAPE_BLKSIZE
);

1459 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


1460 
	`outb_p
(
WT_CTL_DMA
 | 
WT_CTL_ONLINE
, 
QIC_CTL_PORT
);

1461 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


1462 
	`outb_p
(
AR_CTL_IEN
 | 
AR_CTL_DNIEN
, 
QIC_CTL_PORT
);

1463 
	`outb_p
(0, 
AR_START_DMA_PORT
);

1468 
	`’abË_dma
(
TAPE_QIC02_DMA
);

1472 
	}
}

1482 
	$¡¬t_dma
(
mode
, 
by‹s_todo
)

1485 
¡©
;

1487 
	`TPQPUTS
("start_dma()ƒnter");

1488 
	`TPQDEB
({
	`´štk
(
TPQIC_NAME
 ": došg_»ad==%d, došg_wr™e==%d\n", 
došg_»ad
, 
došg_wr™e
);})

1490 
dma_by‹s_dÚe
 = 0;

1491 
dma_by‹s_todo
 = 
by‹s_todo
;

1492 
¡©us_”rÜ
 = 
NO
;

1494 
dma_mode
 = (
mode
 =ğ
WRITE
)? 
DMA_MODE_WRITE
 : 
DMA_MODE_READ
;

1502 ià((
došg_»ad
 =ğ
NO
è&& (
došg_wr™e
 == NO)) {

1511 
	`g‘_¡©us
((*è&
”rÜ
);

1516 
¡©
 = 
	`_£n£
(((
mode
 =ğ
WRITE
)? 0 : 
TP_WRP
è| 
TP_BOM
 | 
TP_FIL
);

1517 ià(
¡©
 !ğ
TE_OK
)

1518  
¡©
;

1520 #ià
OBSOLETE


1522 ià(
	`wa™_fÜ_»ady
(
TIM_S
è!ğ
TE_OK
) {

1523 
	`qputs
("wait_for_ready failed in start_dma");

1524  -
EIO
;

1531 
¡©
 = 
	`£nd_qic02_cmd
((
mode
 =ğ
WRITE
)? 
QCMD_WRT_DATA
 : 
QCMD_RD_DATA
, 
TIM_M
, 0);

1532 ià(
¡©
!=
TE_OK
) {

1533 
	`´štk
(
TPQIC_NAME
 ": start_dma: init %s failed\n",

1534 (
mode
 =ğ
WRITE
)? "write" : "read");

1535 (è
	`_£n£
(0);

1536  
¡©
;

1542 ià(
	`wa™_fÜ_»ady
(
TIM_M
è!ğ
TE_OK
)

1543  -
EIO
;

1544 
mode
) {

1545 
READ
:

1546 
došg_»ad
 = 
YES
;

1548 
WRITE
:

1549 
došg_wr™e
 = 
YES
;

1552 
	`´štk
(
TPQIC_NAME
 ":„eque¡ed unknowÀmod%d\n", 
mode
);

1553 
	`·nic
(
TPQIC_NAME
 ": invalid mode in start_dma()");

1556 } ià(
	`is_exû±iÚ
()) {

1562 
	`qputs
("detectedƒxception in start_dma() whileransfer in…rogress");

1563 
¡©us_”rÜ
 = 
YES
;

1564  
TE_END
;

1568 
¡©us_ex³ù_št
 = 
YES
;

1573 
	`TIMERON
(
TIM_M
*2);

1577 
	`şi
();

1578 
	`dma_Œªsãr
();

1579 
	`¡i
();

1581 
	`TPQPUTS
("start_dma()ƒnd");

1582  
TE_OK
;

1583 
	}
}

1592 
	$’d_dma
(* 
by‹s_dÚe
)

1594 
¡©
 = 
TE_OK
;

1596 
TIMEROFF
;

1598 
	`TPQPUTS
("end_dma()ƒnter");

1600 
	`di§bË_dma
(
TAPE_QIC02_DMA
);

1601 
	`ş—r_dma_ff
(
TAPE_QIC02_DMA
);

1603 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


1604 
	`outb_p
(
WT_CTL_ONLINE
, 
QIC_CTL_PORT
);

1605 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


1606 
	`outb_p
(0, 
AR_RESET_DMA_PORT
);

1609 
¡©
 = 
	`wa™_fÜ_»ady
(
TIM_M
);

1610 ià(
¡©us_”rÜ
 || (
¡©
!=
TE_OK
)) {

1611 
	`qputs
("DMAransferƒxception");

1612 
¡©
 = 
	`_£n£
((
dma_mode
==
READ
)? 
TP_WRP
 : 0);

1620 
dma_mode
 = 0;

1627 *
by‹s_dÚe
 = 
dma_by‹s_dÚe
;

1628 
¡©us_ex³ù_št
 = 
NO
;

1629 
ioùl_¡©us
.
mt_blkno
 +ğ(
dma_by‹s_dÚe
 / 
TAPE_BLKSIZE
);

1631 
	`TPQPUTS
("end_dma()ƒxit");

1633 
	}
}

1644 
	$³_qic02_times_out
()

1646 
	`´štk
("time-ouˆš % driv”\n", 
TPQIC_NAME
);

1647 ià((
¡©us_cmd_³ndšg
>0è|| 
dma_mode
) {

1649 
¡©us_d—d
 = 
YES
;

1650 
¡©us_cmd_³ndšg
 = 0;

1651 
¡©us_tim”_Ú
 = 
NO
;

1652 
¡©us_ex³ù_št
 = 
NO
;

1653 
¡©us_”rÜ
 = 
YES
;

1654 ià(
dma_mode
) {

1655 
dma_mode
 = 0;

1656 
	`wake_up
(&
³_qic02_Œªsãr
);

1659 
	}
}

1692 
	$³_qic02_š‹¼u±
(
unu£d
)

1694 
¡©
, 
r
, 
i
;

1696 
TIMEROFF
;

1698 ià(
¡©us_ex³ù_št
) {

1699 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

1700 
	`´štk
("@");

1702 
¡©
 = 
	`šb
(
QIC_STAT_PORT
);

1703 #ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


1704 ià(((
¡©
 & (
AR_STAT_DMADONE
)) == 0) &&

1705 ((
¡©
 & (
QIC_STAT_EXCEPTION
)) != 0)) {

1706 
TIMERCONT
;

1710 ià((
¡©
 & 
QIC_STAT_EXCEPTION
) == 0) {

1717 
	`qputs
("isr:ƒxception onape controller");

1718 
	`´štk
(" stu %02x\n", 
¡©
);

1719 
¡©us_”rÜ
 = 
TE_EX
;

1721 
dma_by‹s_dÚe
 +ğ
TAPE_BLKSIZE
;

1723 
dma_mode
 = 0;

1724 
¡©us_ex³ù_št
 = 
NO
;

1725 
	`wake_up
(&
³_qic02_Œªsãr
);

1731 
r
 = 0;

1735 #ià
TAPE_QIC02_IFC
 !ğ
ARCHIVE


1736 ià(
¡©
 & 
QIC_STAT_READY
) {

1737 
	`qputs
("isr: ? Tape controller‚ot„eady");

1738 
r
 = 1;

1742 iàĞ(
i
 = 
	`g‘_dma_»sidue
(
TAPE_QIC02_DMA
)) != 0 ) {

1743 
	`´štk
(
TPQIC_NAME
 ": dma_»sidu=ğ%x !!!\n", 
i
);

1744 
r
 = 1;

1747 ià(
r
)

1753 
dma_by‹s_dÚe
 +ğ
TAPE_BLKSIZE
;

1754 ià(
dma_by‹s_dÚe
 >ğ
dma_by‹s_todo
) {

1756 
dma_mode
 = 0;

1757 
¡©us_ex³ù_št
 = 
NO
;

1758 
	`TPQPUTS
("isr: dma_bytes_done");

1759 
	`wake_up
(&
³_qic02_Œªsãr
);

1762 
tim”_bË
[
TAPE_QIC02_TIMER
].
expœes
 = 
jiff›s
 + 6*
HZ
;

1763 
	`dma_Œªsãr
();

1766 
	`´štk
(
TPQIC_NAME
 ": Unexpected interrupt, stat == %x\n",

1767 
	`šb
(
QIC_STAT_PORT
));

1769 
	}
}

1772 
	$³_qic02_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üigš
)

1774  -
EINVAL
;

1775 
	}
}

1810 
	$³_qic02_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

1812 
”rÜ
;

1813 
dev_t
 
dev
 = 
šode
->
i_rdev
;

1814 
æags
 = 
fp
->
f_æags
;

1815 
by‹s_todo
, 
by‹s_dÚe
, 
tÙ®_by‹s_dÚe
 = 0;

1816 
¡©
;

1818 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

1819 
	`´štk
(
TPQIC_NAME
 ":„equest READ, minor=%x, buf=%p, count=%x,…os=%x, flags=%x\n",

1820 
	`MINOR
(
dev
), 
buf
, 
couÁ
, 
fp
->
f_pos
, 
æags
);

1822 ià(
couÁ
 % 
TAPE_BLKSIZE
) {

1823 
	`qputs
("Wrong block size");

1824  -
EINVAL
;

1829 ià(
¡©us_by‹s_wr
)

1830  -
EACCES
;

1834 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
buf
, 
couÁ
);

1835 ià(
”rÜ
) {

1836 
	`´štk
(
TPQIC_NAME
 ":„—d: v”ify_¬—(WRITE, %p, %xèçed\n", 
buf
, 
couÁ
);

1837  
”rÜ
;

1843 
couÁ
>=0) {

1844 
by‹s_dÚe
 = 0;

1846 
by‹s_todo
 = 
TPQBUF_SIZE
;

1847 ià(
by‹s_todo
>
couÁ
)

1848 
by‹s_todo
 = 
couÁ
;

1851 ià(
»tuº_»ad_eof
==
YES
) {

1852 
	`´štk
("»ad:„‘uº_»ad_eof==%d,„•Ü‹d_»ad_eof==%d,Ù®_by‹s_dÚe==%d\n", 
»tuº_»ad_eof
, 
»pÜ‹d_»ad_eof
, 
tÙ®_by‹s_dÚe
);

1854 ià(
»pÜ‹d_»ad_eof
==
NO
) {

1856 ià(
tÙ®_by‹s_dÚe
>0) {

1857  
tÙ®_by‹s_dÚe
;

1859 
»pÜ‹d_»ad_eof
 = 
YES
;

1871 ià(
¡©us_eom_d‘eùed
)

1879 
»tuº_»ad_eof
 = 
NO
;

1880 
»pÜ‹d_»ad_eof
 = 
NO
;

1881 
¡©us_eof_d‘eùed
 = 
NO
;

1888 ià(
by‹s_todo
==0)

1889  
tÙ®_by‹s_dÚe
;

1891 ià(
by‹s_todo
>0) {

1893 ià(
	`is_exû±iÚ
())

1894 
	`qputs
("is_exception() before start_dma()!");

1901 
¡©
 = 
	`¡¬t_dma
(
READ
, 
by‹s_todo
);

1902 ià(
¡©
 =ğ
TE_OK
) {

1904 
dma_mode
 != 0) {

1905 
	`¦“p_Ú
(&
³_qic02_Œªsãr
);

1907 ià(
¡©us_”rÜ
)

1908 
»tuº_»ad_eof
 = 
YES
;

1909 } ià(
¡©
 !ğ
TE_END
) {

1912  -
ENXIO
;

1914 
	`´štk
("TroubË: st==%02x\n", 
¡©
);

1915 
»tuº_»ad_eof
 = 
YES
;

1919 
	`’d_dma
(&
by‹s_dÚe
);

1920 ià(
by‹s_dÚe
>
by‹s_todo
) {

1921 
	`qputs
("read: Oops,„ead more byteshan„equested");

1922  -
EIO
;

1925 ià(
by‹s_dÚe
>0)

1926 
	`memıy_tofs
Ğ(*è
buf
, (*è
bufçddr
, 
by‹s_dÚe
);

1929 ià((
»tuº_»ad_eof
 =ğ
NO
è&& (
¡©us_eof_d‘eùed
 =ğ
YES
)) {

1930 
	`´štk
(
TPQIC_NAME
 ":„—d():„‘uº_»ad_eof=%d, stus_eof_d‘eùed=YES.„‘uº_»ad_eof:=YES\n", 
»tuº_»ad_eof
);

1933 ià((
by‹s_todo
 !ğ
by‹s_dÚe
è|| (
¡©us_eof_d‘eùed
 =ğ
YES
))

1935 
»tuº_»ad_eof
 = 
YES
;

1938 ià(
by‹s_dÚe
>0) {

1939 
¡©us_by‹s_rd
 = 
YES
;

1940 
buf
 +ğ
by‹s_dÚe
;

1941 
fp
->
f_pos
 +ğ
by‹s_dÚe
;

1942 
tÙ®_by‹s_dÚe
 +ğ
by‹s_dÚe
;

1943 
couÁ
 -ğ
by‹s_dÚe
;

1946 
	`qputs
("read„equest for <0 bytes");

1947  -
EINVAL
;

1948 
	}
}

1980 
	$³_qic02_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

1982 
”rÜ
;

1983 
dev_t
 
dev
 = 
šode
->
i_rdev
;

1984 
æags
 = 
fp
->
f_æags
;

1985 
by‹s_todo
, 
by‹s_dÚe
, 
tÙ®_by‹s_dÚe
 = 0;

1987 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

1988 
	`´štk
(
TPQIC_NAME
 ":„equest WRITE, minor=%x, buf=%p, count=%x,…os=%x, flags=%x\n",

1989 
	`MINOR
(
dev
), 
buf
, 
couÁ
, 
fp
->
f_pos
, 
æags
);

1991 ià(
couÁ
 % 
TAPE_BLKSIZE
) {

1992 
	`qputs
("Wrong block size");

1993  -
EINVAL
;

1996 ià(
mode_acûss
==
READ
) {

1997 
	`qputs
("Not in write mode");

1998  -
EACCES
;

2005 ià((
”rÜ
.
exs
 & 
TP_ST0
è&& (”rÜ.ex & 
TP_WRP
)) {

2006 
	`qputs
("Cartridge is write-protected.");

2007  -
EACCES
;

2011 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
buf
, 
couÁ
);

2012 ià(
”rÜ
) {

2013 
	`´štk
(
TPQIC_NAME
 ": wr™e: v”ify_¬—(READ, %p, %xèçed\n", 
buf
, 
couÁ
);

2014  
”rÜ
;

2017 ià(
došg_»ad
 =ğ
YES
)

2018 
	`‹rmš©e_»ad
(0);

2020 
couÁ
>=0) {

2022 
by‹s_dÚe
 = 0;

2023 
by‹s_todo
 = 
TPQBUF_SIZE
;

2024 ià(
by‹s_todo
>
couÁ
)

2025 
by‹s_todo
 = 
couÁ
;

2027 ià(
»tuº_wr™e_eof
 =ğ
YES
) {

2030 ià(
»pÜ‹d_wr™e_eof
==
NO
) {

2031 ià(
by‹s_todo
>0) {

2032 
	`qputs
("partial write");

2035 
»pÜ‹d_wr™e_eof
 = 
YES
;

2036  
tÙ®_by‹s_dÚe
;

2038  -
ENOSPC
;

2043 ià(
by‹s_todo
==0)

2044  
tÙ®_by‹s_dÚe
;

2048 ià(
by‹s_todo
>0) {

2049 
	`memıy_äomfs
Ğ(*è
bufçddr
, (*è
buf
, 
by‹s_todo
);

2057 ià(
	`¡¬t_dma
(
WRITE
, 
by‹s_todo
è!ğ
TE_OK
) {

2058 
	`qputs
("write: start_dma() failed");

2060  -
ENXIO
;

2064 (
¡©us_”rÜ
 =ğ0è&& (
dma_mode
 != 0)) {

2065 
	`¦“p_Ú
(&
³_qic02_Œªsãr
);

2068 
	`’d_dma
(&
by‹s_dÚe
);

2069 ià(
by‹s_dÚe
>
by‹s_todo
) {

2070 
	`qputs
("write: Oops, wrote more byteshan„equested");

2071  -
EIO
;

2085 ià(
¡©us_”rÜ
) {

2086 ià(
¡©us_eom_d‘eùed
 =ğ
YES
) {

2087 
	`qputs
("write: EW detected");

2088 
»tuº_wr™e_eof
 = 
YES
;

2091 
	`qputs
("write: dma:ƒrror in writing");

2092  -
EIO
;

2095 ià(
by‹s_todo
 !ğ
by‹s_dÚe
)

2097 
»tuº_wr™e_eof
 = 
YES
;

2101 ià(
by‹s_dÚe
>0) {

2102 
¡©us_by‹s_wr
 = 
YES
;

2103 
buf
 +ğ
by‹s_dÚe
;

2104 
fp
->
f_pos
 +ğ
by‹s_dÚe
;

2105 
tÙ®_by‹s_dÚe
 +ğ
by‹s_dÚe
;

2106 
couÁ
 -ğ
by‹s_dÚe
;

2109 
	`qputs
("write„equest for <0 bytes");

2110 
	`´štk
(
TPQIC_NAME
 ": stus_by‹s_w¸%x, buà%p,Ù®_by‹s_dÚ%x, couÁ %x\n", 
¡©us_by‹s_wr
, 
buf
, 
tÙ®_by‹s_dÚe
, 
couÁ
);

2111  -
EINVAL
;

2112 
	}
}

2127 
	$³_qic02_İ’
(
šode
 * inode, 
fe
 * 
fp
)

2129 
dev_t
 
dev
 = 
šode
->
i_rdev
;

2130 
æags
 = 
fp
->
f_æags
;

2131 
d’s
;

2132 
s
;

2134 
¡©us_İ’
 = 
NO
;

2136 ià(
	`TP_DIAGS
(
dev
)) {

2137 
	`´štk
("³_qic02_İ’: dev=%x, fÏgs=%x ", 
dev
, 
æags
);

2140 ià(
	`MINOR
(
dev
)==255)

2141 ià(
	`su£r
())

2142  (
	`³_»£t
(1)==
TE_OK
è? -
EAGAIN
 : -
ENXIO
;

2144  -
EPERM
;

2146 ià(
¡©us_İ’
==
YES
) {

2147  -
EBUSY
;

2149 
¡©us_İ’
 = 
YES
;

2151 
¡©us_by‹s_rd
 = 
NO
;

2152 
¡©us_by‹s_wr
 = 
NO
;

2154 
»tuº_»ad_eof
 = 
NO
;

2155 
»tuº_wr™e_eof
 = (
¡©us_eÙ_d‘eùed
)? 
YES
 : 
NO
;

2158 
¡©us_eof_d‘eùed
 = 
NO
;

2160 
»pÜ‹d_»ad_eof
 = 
NO
;

2161 
»pÜ‹d_wr™e_eof
 = 
NO
;

2164 
æags
 & 
O_ACCMODE
) {

2165 
O_RDONLY
:

2166 
mode_acûss
 = 
READ
;

2168 
O_WRONLY
:

2169 
O_RDWR
:

2170 
mode_acûss
 = 
WRITE
;

2176 ià(
	`is_exû±iÚ
()) {

2177 
s
 = 
	`_£n£
(
TP_WRP
|
TP_EOM
|
TP_BOM
|
TP_CNI
|
TP_EOR
);

2178 ià(
s
 !ğ
TE_OK
) {

2179 
¡©us_İ’
 = 
NO
;

2180 
	`qputs
("open: sense() failed‡fterƒxception was detected");

2181  -
EIO
;

2187 ià((
	`TP_DENS
(
dev
)!=0è&& (TP_DENS(
cu¼’t_³_dev
) != TP_DENS(dev))) {

2192 
	`qputs
("Density minor bits have changed. Forcing„ewind.");

2193 
Ãed_»wšd
 = 
YES
;

2198 
cu¼’t_³_dev
 = 
dev
;

2201 ià(
Ãed_»wšd
 =ğ
YES
) {

2202 
s
 = 
	`do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

2203 ià(
s
 != 0) {

2204 
	`qputs
("open:„ewind failed");

2205 
¡©us_İ’
 = 
NO
;

2206  -
EIO
;

2214 ià(
¡©us_d—d
) {

2215 
	`qputs
("open:ape dead,‡ttempting„eset");

2216 ià(
	`³_»£t
(1)!=
TE_OK
) {

2217 
¡©us_İ’
 = 
NO
;

2218  -
ENXIO
;

2220 
¡©us_d—d
 = 
NO
;

2221 ià(
	`_£n£
(~(
TP_ST1
|
TP_ILL
)è!ğ
TE_OK
) {

2222 
	`qputs
("open:p_sense() failed\n");

2223 
¡©us_d—d
 = 
YES
;

2224 
¡©us_İ’
 = 
NO
;

2225  -
EIO
;

2237 ià(
	`TP_DENS
(
cu¼’t_³_dev
è=ğTP_DENS(
dev
) )

2240 
cu¼’t_³_dev
 = 
dev
;

2241 
Ãed_»wšd
 = 
NO
;

2242 
d’s
 = 
	`TP_DENS
(
dev
);

2243 ià(
d’s
 < (
fÜm©_Çmes
)/(*))

2244 
	`´štk
(
TPQIC_NAME
 ": fÜm©: %s%s\n", (
d’s
!=0)? "QIC-" : "", 
fÜm©_Çmes
[dens]);

2246 
	`qputs
("Wait for„etensioning...");

2248 
	`TP_DENS
(
dev
)) {

2250 
s
 = 0;

2253 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_11
, 
TIM_S
);

2256 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_24
, 
TIM_S
);

2259 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_120
, 
TIM_S
);

2262 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_150
, 
TIM_S
);

2265 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_300
, 
TIM_S
);

2268 
s
 = 
	`do_qic_cmd
(
QCMD_DENS_600
, 
TIM_S
);

2271 
s
 = 
	`do_qic_cmd
(
QCMD_RETEN
, 
TIM_R
);

2273 ià(
s
 != 0) {

2274 
¡©us_İ’
 = 
NO
;

2275 
¡©us_d—d
 = 
YES
;

2276 
cu¼’t_³_dev
 = 0xff80;

2277  -
EIO
;

2281 
	}
}

2284 
	$³_qic02_»addœ
(
šode
 * inode, 
fe
 * 
fp
, 
dœ’t
 * 
dp
, 
couÁ
)

2286  -
ENOTDIR
;

2287 
	}
}

2290 
	$³_qic02_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

2292 
dev_t
 
dev
 = 
šode
->
i_rdev
;

2294 ià(
	`TP_DIAGS
(
dev
))

2295 
	`´štk
("³_qic02_»Ëa£: dev=%x\n", 
dev
);

2300 
	`‹rmš©e_wr™e
(-1);

2302 ià(
¡©us_d—d
==
YES
)

2303 
	`qputs
("release: device dead!?");

2305 ià(
¡©us_İ’
==
NO
) {

2306 
	`qputs
("release: device‚ot open");

2312 ià((
	`TP_REWCLOSE
(
dev
)è&& (
¡©us_by‹s_rd
 | 
¡©us_by‹s_wr
)) {

2313 
	`qputs
("release: Doing„ewind...");

2314 (è
	`do_qic_cmd
(
QCMD_REWIND
, 
TIM_R
);

2317 
¡©us_İ’
 = 
NO
;

2319 
	}
}

2324 
	$³_qic02_ioùl
(
šode
 * inode, 
fe
 * 
fp
,

2325 
iocmd
, 
ißrg
)

2327 
”rÜ
;

2328 
i
;

2329 
dev_maj
 = 
	`MAJOR
(
šode
->
i_rdev
);

2330 
c
;

2331 
mtİ
 
İ”©iÚ
;

2332 *
¡p
, *
¬gp
;

2334 #ifdeà
TP_HAVE_TELL


2335 
blk_addr
[6];

2336 
mos
 
ioùl_‹Î
;

2339 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

2340 
	`´štk
(
TPQIC_NAME
 ": ioùl(%4x, %4x, %4x)\n", 
dev_maj
, 
iocmd
, 
ißrg
);

2342 ià(!
šode
 || !
ißrg
)

2343  -
EINVAL
;

2347 ià(
dev_maj
 !ğ
QIC02_TAPE_MAJOR
) {

2348 
	`´štk
(
TPQIC_NAME
 ": Oops! Wrong device?\n");

2350  -
ENODEV
;

2353 
c
 = 
iocmd
 & 
IOCCMD_MASK
;

2354 ià(
c
 =ğ(
MTIOCTOP
 & 
IOCCMD_MASK
)) {

2359 ià(((
iocmd
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mtİ
)) {

2360 
	`qputs
("sizeof(struct mtop) does‚ot match!");

2361  -
EFAULT
;

2363 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
ißrg
, (
İ”©iÚ
));

2364 ià(
”rÜ
)

2365  
”rÜ
;

2368 
¡p
 = (*è&
İ”©iÚ
;

2369 
¬gp
 = (*è
ißrg
;

2370 
i
=0; i<(
İ”©iÚ
); i++)

2371 *
¡p
++ = 
	`g‘_fs_by‹
(
¬gp
++);

2381 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

2382 
	`´štk
("OP op=%4x, couÁ=%4x\n", 
İ”©iÚ
.
mt_İ
, o³¿tiÚ.
mt_couÁ
);

2384 ià(
İ”©iÚ
.
mt_couÁ
 < 0)

2385 
	`qputs
("Warning:‚egative mt_count ignored");

2387 
ioùl_¡©us
.
mt_»sid
 = 
İ”©iÚ
.
mt_couÁ
;

2388 ià(
İ”©iÚ
.
mt_İ
 =ğ
MTSEEK
) {

2389 
£ek_addr_buf
[0] = (
İ”©iÚ
.
mt_couÁ
>>16)&0xff;

2390 
£ek_addr_buf
[1] = (
İ”©iÚ
.
mt_couÁ
>>8)&0xff;

2391 
£ek_addr_buf
[2] = (
İ”©iÚ
.
mt_couÁ
)&0xff;

2392 ià(
İ”©iÚ
.
mt_couÁ
>>24)

2393  -
EINVAL
;

2395 ià((
”rÜ
 = 
	`do_ioùl_cmd
(
İ”©iÚ
.
mt_İ
)) != 0)

2396  
”rÜ
;

2397 
ioùl_¡©us
.
mt_»sid
 = 0;

2399 
İ”©iÚ
.
mt_couÁ
 > 0) {

2400 
İ”©iÚ
.
mt_couÁ
--;

2401 ià((
”rÜ
 = 
	`do_ioùl_cmd
(
İ”©iÚ
.
mt_İ
)) != 0)

2402  
”rÜ
;

2403 
ioùl_¡©us
.
mt_»sid
 = 
İ”©iÚ
.
mt_couÁ
;

2408 } ià(
c
 =ğ(
MTIOCGET
 & 
IOCCMD_MASK
)) {

2409 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

2410 
	`´štk
("GET ");

2413 ià(((
iocmd
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mtg‘
)) {

2414 
	`qputs
("sizeof(struct mtget) does‚ot match!");

2415  -
EFAULT
;

2419 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
ißrg
, (
ioùl_¡©us
));

2420 ià(
”rÜ
)

2421  
”rÜ
;

2429 
¡p
 = (*è&
ioùl_¡©us
;

2430 
¬gp
 = (*è
ißrg
;

2431 
i
=0; i<(
ioùl_¡©us
); i++)

2432 
	`put_fs_by‹
(*
¡p
++, 
¬gp
++);

2435 #ifdeà
TP_HAVE_TELL


2436 } ià(
c
 =ğ(
MTIOCPOS
 & 
IOCCMD_MASK
)) {

2437 ià(
	`TP_DIAGS
(
cu¼’t_³_dev
))

2438 
	`´štk
("POS ");

2441 ià(((
iocmd
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mos
)) {

2442 
	`qputs
("sizeof(struct mtpos) does‚ot match!");

2443  -
EFAULT
;

2447 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
ißrg
, (
ioùl_‹Î
));

2448 ià(
”rÜ
)

2449  
”rÜ
;

2451 
	`qputs
("MTTELL„eading block‡ddress");

2452 ià((
došg_»ad
==
YES
è|| (
došg_wr™e
==YES))

2453 
	`fšish_rw
(
QCMDV_TELL_BLK
);

2455 
c
 = 
	`rd¡©us
((*è
blk_addr
, (blk_addr), 
QCMDV_TELL_BLK
);

2456 ià(
c
!=
TE_OK
)

2457  -
EIO
;

2459 
ioùl_‹Î
.
mt_blkno
 = (
blk_addr
[3] << 16) | (blk_addr[4] << 8) | blk_addr[5];

2462 
¡p
 = (*è&
ioùl_‹Î
;

2463 
¬gp
 = (*è
ißrg
;

2464 
i
=0; i<(
ioùl_‹Î
); i++)

2465 
	`put_fs_by‹
(*
¡p
++, 
¬gp
++);

2469  -
ENOTTY
;

2470 
	}
}

2475 
fe_İ”©iÚs
 
	g³_qic02_fİs
 = {

2476 
³_qic02_l£ek
,

2477 
³_qic02_»ad
,

2478 
³_qic02_wr™e
,

2479 
³_qic02_»addœ
,

2480 
NULL
,

2481 
³_qic02_ioùl
,

2482 
NULL
,

2483 
³_qic02_İ’
,

2484 
³_qic02_»Ëa£
,

2485 
NULL


2494 
sigaùiÚ
 
	g³_qic02_sigaùiÚ
 = {

2495 
³_qic02_š‹¼u±
,

2497 
SA_INTERRUPT
,

2498 
NULL


2503 
šlše
 cÚ¡ 
	$®ign_bufãr
(
a
, 
size
)

2505 ià(
a
 & (
size
-1))

2506  (
a
 | (
size
-1)) + 1;

2508  
a
;

2509 
	}
}

2513 
	$³_qic02_š™
(
kmem_¡¬t
)

2517 
	`´štk
(
TPQIC_NAME
 ": IRQ %d, DMA %d, IO %xh, IFC %s, %s, %s\n",

2518 
TAPE_QIC02_IRQ
, 
TAPE_QIC02_DMA
, 
TAPE_QIC02_PORT
,

2519 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


2521 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


2526 
rcs_»visiÚ
, 
rcs_d©e
);

2548 ià(
	`œqaùiÚ
(
TAPE_QIC02_IRQ
, &
³_qic02_sigaùiÚ
)) {

2549 
	`´štk
(
TPQIC_NAME
 ": can't‡llocate IRQ%d for QIC-02ape\n",

2550 
TAPE_QIC02_IRQ
);

2551  
kmem_¡¬t
;

2555 ià(
	`»que¡_dma
(
TAPE_QIC02_DMA
)) {

2556 
	`´štk
(
TPQIC_NAME
 ": can't‡llocate DMA%d for QIC-02ape\n",

2557 
TAPE_QIC02_DMA
);

2558 
	`ä“_œq
(
TAPE_QIC02_IRQ
);

2559  
kmem_¡¬t
;

2562 ià(
TPSTATSIZE
 != 6) {

2563 
	`´štk
(
TPQIC_NAME
 ": internalƒrror:pstatus struct incorrect!\n");

2564  
kmem_¡¬t
;

2566 ià((
TPQBUF_SIZE
<512) || (TPQBUF_SIZE>=0x10000)) {

2567 
	`´štk
(
TPQIC_NAME
 ": internalƒrror: DMA buffer size out of„ange\n");

2568  
kmem_¡¬t
;

2571 
	`´štk
(
TPQIC_NAME
 ": DMA bufãrs: %u blocks", 
NR_BLK_BUF
);

2577 
bufçddr
 = 
	`®ign_bufãr
((è&
³_qic02_buf
, 
TAPE_BLKSIZE
);

2578 
	`´štk
(",‡ˆadd»s 0x%lx (0x%lx)\n", 
bufçddr
, (è&
³_qic02_buf
);

2580 #iâdeà
CONFIG_MAX_16M


2581 ià(
bufçddr
+
TPQBUF_SIZE
>=0x1000000) {

2582 
	`´štk
(
TPQIC_NAME
 ": DMA buffer *must* be in†ower 16MB\n");

2583  
kmem_¡¬t
;

2588 ià(
	`»gi¡”_chrdev
(
QIC02_TAPE_MAJOR
, 
TPQIC_NAME
, &
³_qic02_fİs
)) {

2589 
	`´štk
(
TPQIC_NAME
 ": Unableo get chrdev major %d\n",

2590 
QIC02_TAPE_MAJOR
);

2591  
kmem_¡¬t
;

2595 
TIMEROFF
;

2596 
tim”_bË
[
TAPE_QIC02_TIMER
].
expœes
 = 0;

2597 
tim”_bË
[
TAPE_QIC02_TIMER
].
â
 = 
³_qic02_times_out
;

2599 ià(
	`³_»£t
(0)!=
TE_OK
 || 
	`_£n£
(
TP_WRP
|
TP_POR
|
TP_CNI
)!=TE_OK) {

2600 
¡©us_d—d
 = 
YES
;

2602 ià(
	`is_exû±iÚ
()) {

2603 
	`qputs
("exception detected\n");

2604 (è
	`_£n£
(
TP_WRP
|
TP_POR
|
TP_CNI
);

2610 
ioùl_¡©us
.
mt_ty³
 = 
TAPE_QIC02_DRIVE
;

2612 
ioùl_¡©us
.
mt_»sid
 = 0;

2613 
ioùl_¡©us
.
mt_g¡©
 = 0;

2614 
ioùl_¡©us
.
mt_”»g
 = 0;

2615 
ioùl_¡©us
.
mt_f’o
 = 0;

2616 
ioùl_¡©us
.
mt_blkno
 = 0;

2618  
kmem_¡¬t
;

2619 
	}
}

	@drivers/char/tty_io.c

40 
	~<lšux/ty³s.h
>

41 
	~<lšux/majÜ.h
>

42 
	~<lšux/”ºo.h
>

43 
	~<lšux/sigÇl.h
>

44 
	~<lšux/fú.h
>

45 
	~<lšux/sched.h
>

46 
	~<lšux/‰y.h
>

47 
	~<lšux/tim”.h
>

48 
	~<lšux/ùy³.h
>

49 
	~<lšux/kd.h
>

50 
	~<lšux/mm.h
>

51 
	~<lšux/¡ršg.h
>

52 
	~<lšux/m®loc.h
>

54 
	~<asm/£gm’t.h
>

55 
	~<asm/sy¡em.h
>

56 
	~<asm/b™İs.h
>

58 
	~"kbd_k”n.h
"

59 
	~"vt_k”n.h
"

61 
	#CONSOLE_DEV
 
	`MKDEV
(
TTY_MAJOR
,0)

	)

63 
	#MAX_TTYS
 256

	)

65 
‰y_¡ruù
 *
	g‰y_bË
[
MAX_TTYS
];

66 
‹rmios
 *
	g‰y_‹rmios
[
MAX_TTYS
];

68 
‹rmios
 *
	g‹rmios_locked
[
MAX_TTYS
];

69 
‰y_ldisc
 
	gldiscs
[
NR_LDISCS
];

70 
	g‰y_check_wr™e
[
MAX_TTYS
/32];

77 
	gfg_cÚsŞe
 = 0;

78 
‰y_¡ruù
 * 
	g»dœeù
 = 
NULL
;

79 
wa™_queue
 * 
	gkey´ess_wa™
 = 
NULL
;

81 
š™Ÿlize_‰y_¡ruù
(
lše
, 
‰y_¡ruù
 *
‰y
);

82 
š™Ÿlize_‹rmios
(
lše
, 
‹rmios
 *

);

84 
‰y_»ad
(
šode
 *, 
fe
 *, *, );

85 
‰y_wr™e
(
šode
 *, 
fe
 *, *, );

86 
‰y_£Ëù
(
šode
 *, 
fe
 *, , 
£Ëù_bË
 *);

87 
‰y_İ’
(
šode
 *, 
fe
 *);

88 
‰y_»Ëa£
(
šode
 *, 
fe
 *);

90 
	$‰y_»gi¡”_ldisc
(
disc
, 
‰y_ldisc
 *
Ãw_ldisc
)

92 ià(
disc
 < 
N_TTY
 || disø>ğ
NR_LDISCS
)

93  -
EINVAL
;

95 ià(
Ãw_ldisc
) {

96 
ldiscs
[
disc
] = *
Ãw_ldisc
;

97 
ldiscs
[
disc
].
æags
 |ğ
LDISC_FLAG_DEFINED
;

99 
	`mem£t
(&
ldiscs
[
disc
], 0, (
‰y_ldisc
));

102 
	}
}

104 
	$put_‰y_queue
(
c
, 
‰y_queue
 * 
queue
)

106 
h—d
;

107 
æags
;

109 
	`§ve_æags
(
æags
);

110 
	`şi
();

111 
h—d
 = (
queue
->h—d + 1è& (
TTY_BUF_SIZE
-1);

112 ià(
h—d
 !ğ
queue
->

) {

113 
queue
->
buf
[queue->
h—d
] = 
c
;

114 
queue
->
h—d
 = head;

116 
	`»¡Üe_æags
(
æags
);

117 
	}
}

119 
	$g‘_‰y_queue
(
‰y_queue
 * 
queue
)

121 
»suÉ
 = -1;

122 
æags
;

124 
	`§ve_æags
(
æags
);

125 
	`şi
();

126 ià(
queue
->

 !ğqueue->
h—d
) {

127 
»suÉ
 = 
queue
->
buf
[queue->

];

128 
	`INC
(
queue
->

);

130 
	`»¡Üe_æags
(
æags
);

131  
»suÉ
;

132 
	}
}

142 
	$‰y_»ad_¿w_d©a
(
‰y_¡ruù
 *
‰y
, *
buå
, 
buæ’
)

144 
»suÉ
 = 0;

145 *
p
 = 
buå
;

146 
æags
;

147 
h—d
, 

;

148 
ok
 = 1;

150 
	`§ve_æags
(
æags
);

151 
	`şi
();

152 

 = 
‰y
->
»ad_q
.tail;

153 
h—d
 = 
‰y
->
»ad_q
.head;

154 (
»suÉ
 < 
buæ’
è&& (

!=
h—d
è&& 
ok
) {

155 
ok
 = !
	`ş—r_b™
 (

, &
‰y
->
»adq_æags
);

156 *
p
++ = 
‰y
->
»ad_q
.
buf
[

++];

157 

 &ğ
TTY_BUF_SIZE
-1;

158 
»suÉ
++;

160 
‰y
->
»ad_q
.

 =ail;

161 
	`»¡Üe_æags
(
æags
);

162  (
ok
è? 
»suÉ
 : -result;

163 
	}
}

166 
	$‰y_wr™e_æush
(
‰y_¡ruù
 * 
‰y
)

168 ià(!
‰y
->
wr™e
 || 
	`EMPTY
(&‰y->
wr™e_q
))

170 ià(
	`£t_b™
(
TTY_WRITE_BUSY
,&
‰y
->
æags
))

172 
‰y
->
	`wr™e
(tty);

173 ià(!
	`ş—r_b™
(
TTY_WRITE_BUSY
,&
‰y
->
æags
))

174 
	`´štk
("tty_write_flush: bit‡lready cleared\n");

175 
	}
}

177 
	$‰y_»ad_æush
(
‰y_¡ruù
 * 
‰y
)

179 ià(!
‰y
 || 
	`EMPTY
(&‰y->
»ad_q
))

181 ià(
	`£t_b™
(
TTY_READ_BUSY
, &
‰y
->
æags
))

183 
ldiscs
[
‰y
->
disc
].
	`hªdËr
(tty);

184 ià(!
	`ş—r_b™
(
TTY_READ_BUSY
, &
‰y
->
æags
))

185 
	`´štk
("tty_read_flush: bit‡lready cleared\n");

186 
	}
}

188 
	$hung_up_‰y_»ad
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

191 
	}
}

193 
	$hung_up_‰y_wr™e
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

195  -
EIO
;

196 
	}
}

198 
	$hung_up_‰y_£Ëù
(
šode
 * inode, 
fe
 * 
fp
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

201 
	}
}

203 
	$hung_up_‰y_ioùl
(
šode
 * inode, 
fe
 * file,

204 
cmd
, 
¬g
)

206  -
EIO
;

207 
	}
}

209 
	$‰y_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üig
)

211  -
ESPIPE
;

212 
	}
}

214 
fe_İ”©iÚs
 
	g‰y_fİs
 = {

215 
‰y_l£ek
,

216 
‰y_»ad
,

217 
‰y_wr™e
,

218 
NULL
,

219 
‰y_£Ëù
,

220 
‰y_ioùl
,

221 
NULL
,

222 
‰y_İ’
,

223 
‰y_»Ëa£


226 
fe_İ”©iÚs
 
	ghung_up_‰y_fİs
 = {

227 
‰y_l£ek
,

228 
hung_up_‰y_»ad
,

229 
hung_up_‰y_wr™e
,

230 
NULL
,

231 
hung_up_‰y_£Ëù
,

232 
hung_up_‰y_ioùl
,

233 
NULL
,

234 
NULL
,

235 
‰y_»Ëa£


238 
	$do_‰y_hªgup
(
‰y_¡ruù
 * 
‰y
, 
fe_İ”©iÚs
 *
fİs
)

240 
i
;

241 
fe
 * 
fp
;

242 
sk_¡ruù
 *
p
;

243 
dev
;

245 ià(!
‰y
)

247 
dev
 = 
	`MKDEV
(
TTY_MAJOR
,
‰y
->
lše
);

248 
fp
 = 
fœ¡_fe
, 
i
=0; i<
Ä_fes
; i++, f°ğfp->
f_Ãxt
) {

249 ià(!
fp
->
f_couÁ
)

251 ià(
fp
->
f_rdev
 !ğ
dev
)

253 ià(
fp
->
f_šode
 && fp->f_šode->
i_rdev
 =ğ
CONSOLE_DEV
)

255 ià(
fp
->
f_İ
 !ğ&
‰y_fİs
)

257 
fp
->
f_İ
 = 
fİs
;

259 
	`æush_šput
(
‰y
);

260 
	`æush_ouut
(
‰y
);

261 
	`wake_up_š‹¼u±ibË
(&
‰y
->
£cÚd¬y
.
´oc_li¡
);

262 ià(
‰y
->
£ssiÚ
 > 0) {

263 
	`kl_¦
(
‰y
->
£ssiÚ
,
SIGHUP
,1);

264 
	`kl_¦
(
‰y
->
£ssiÚ
,
SIGCONT
,1);

266 
‰y
->
£ssiÚ
 = 0;

267 
‰y
->
pg½
 = -1;

268 
	`fÜ_—ch_sk
(
p
) {

269 ià(
p
->
‰y
 =ğ‰y->
lše
)

270 
p
->
‰y
 = -1;

272 ià(
‰y
->
hªgup
)

273 (
‰y
->
hªgup
)(tty);

274 
	}
}

276 
	$‰y_hªgup
(
‰y_¡ruù
 * 
‰y
)

278 #ifdeà
TTY_DEBUG_HANGUP


279 
	`´štk
("‰y%d hªgup...\n", 
‰y
->
lše
);

281 
	`do_‰y_hªgup
(
‰y
, &
hung_up_‰y_fİs
);

282 
	}
}

284 
	$‰y_vhªgup
(
‰y_¡ruù
 * 
‰y
)

286 #ifdeà
TTY_DEBUG_HANGUP


287 
	`´štk
("‰y%d vhªgup...\n", 
‰y
->
lše
);

289 
	`do_‰y_hªgup
(
‰y
, &
hung_up_‰y_fİs
);

290 
	}
}

292 
	$‰y_hung_up_p
(
fe
 * 
fp
)

294  (
fp
->
f_İ
 =ğ&
hung_up_‰y_fİs
);

295 
	}
}

307 
	$di§ssocŸ‹_ùty
(
´iv
)

309 
‰y_¡ruù
 *
‰y
;

310 
sk_¡ruù
 *
p
;

312 ià(
cu¼’t
->
‰y
 >= 0) {

313 
‰y
 = 
‰y_bË
[
cu¼’t
->tty];

314 ià(
‰y
) {

315 ià(
‰y
->
pg½
 > 0) {

316 
	`kl_pg
(
‰y
->
pg½
, 
SIGHUP
, 
´iv
);

317 
	`kl_pg
(
‰y
->
pg½
, 
SIGCONT
, 
´iv
);

319 
‰y
->
£ssiÚ
 = 0;

320 
‰y
->
pg½
 = -1;

322 
	`´štk
("disassociate_ctty: ctty is NULL?!?");

325 
	`fÜ_—ch_sk
(
p
)

326 ià(
p
->
£ssiÚ
 =ğ
cu¼’t
->session)

327 
p
->
‰y
 = -1;

328 
	}
}

337 
wa™_queue
 *
	gvt_aùiv©e_queue
 = 
NULL
;

343 
	$vt_wa™aùive
()

345 
	`š‹¼u±ibË_¦“p_Ú
(&
vt_aùiv©e_queue
);

346  (
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) ? -1 : 0;

347 
	}
}

349 
	#vt_wake_wa™aùive
(è
	`wake_up
(&
vt_aùiv©e_queue
)

	)

351 
kl_´oc
(
pid
, 
sig
, 
´iv
);

356 
	$com¶‘e_chªge_cÚsŞe
(
Ãw_cÚsŞe
)

358 
Şd_vc_mode
;

360 ià(
Ãw_cÚsŞe
 =ğ
fg_cÚsŞe
 ||‚ew_cÚsŞ>ğ
NR_CONSOLES
)

368 
Şd_vc_mode
 = 
vt_cÚs
[
fg_cÚsŞe
].
vc_mode
;

369 
	`upd©e_sü“n
(
Ãw_cÚsŞe
);

376 ià(
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
mode
 =ğ
VT_PROCESS
)

383 ià(
	`kl_´oc
(
vt_cÚs
[
Ãw_cÚsŞe
].
vt_pid
,

384 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
acqsig
,

396 
vt_cÚs
[
Ãw_cÚsŞe
].
vc_mode
 = 
KD_TEXT
;

397 
	`şr_vc_kbd_mode
(
kbd_bË
 + 
Ãw_cÚsŞe
, 
VC_RAW
);

398 
	`şr_vc_kbd_mode
(
kbd_bË
 + 
Ãw_cÚsŞe
, 
VC_MEDIUMRAW
);

399 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
mode
 = 
VT_AUTO
;

400 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
wa™v
 = 0;

401 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
»lsig
 = 0;

402 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
acqsig
 = 0;

403 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_mode
.
äsig
 = 0;

404 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_pid
 = -1;

405 
vt_cÚs
[
Ãw_cÚsŞe
].
vt_Ãwvt
 = -1;

413 ià(
Şd_vc_mode
 !ğ
vt_cÚs
[
Ãw_cÚsŞe
].
vc_mode
)

415 ià(
vt_cÚs
[
Ãw_cÚsŞe
].
vc_mode
 =ğ
KD_TEXT
)

416 
	`unbÏnk_sü“n
();

418 
tim”_aùive
 &ğ~(1<<
BLANK_TIMER
);

419 
	`bÏnk_sü“n
();

426 
	`vt_wake_wa™aùive
();

428 
	}
}

433 
	$chªge_cÚsŞe
(
Ãw_cÚsŞe
)

435 ià(
Ãw_cÚsŞe
 =ğ
fg_cÚsŞe
 ||‚ew_cÚsŞ>ğ
NR_CONSOLES
)

453 ià(
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
mode
 =ğ
VT_PROCESS
)

460 ià(
	`kl_´oc
(
vt_cÚs
[
fg_cÚsŞe
].
vt_pid
,

461 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
»lsig
,

469 
vt_cÚs
[
fg_cÚsŞe
].
vt_Ãwvt
 = 
Ãw_cÚsŞe
;

482 
vt_cÚs
[
fg_cÚsŞe
].
vc_mode
 = 
KD_TEXT
;

483 
	`şr_vc_kbd_mode
(
kbd_bË
 + 
fg_cÚsŞe
, 
VC_RAW
);

484 
	`şr_vc_kbd_mode
(
kbd_bË
 + 
fg_cÚsŞe
, 
VC_MEDIUMRAW
);

485 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
mode
 = 
VT_AUTO
;

486 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
wa™v
 = 0;

487 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
»lsig
 = 0;

488 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
acqsig
 = 0;

489 
vt_cÚs
[
fg_cÚsŞe
].
vt_mode
.
äsig
 = 0;

490 
vt_cÚs
[
fg_cÚsŞe
].
vt_pid
 = -1;

491 
vt_cÚs
[
fg_cÚsŞe
].
vt_Ãwvt
 = -1;

500 ià(
vt_cÚs
[
fg_cÚsŞe
].
vc_mode
 =ğ
KD_GRAPHICS
)

503 
	`com¶‘e_chªge_cÚsŞe
(
Ãw_cÚsŞe
);

504 
	}
}

506 
	$wa™_fÜ_key´ess
()

508 
	`¦“p_Ú
(&
key´ess_wa™
);

509 
	}
}

511 
	$¡İ_‰y
(
‰y_¡ruù
 *
‰y
)

513 ià(
‰y
->
¡İ³d
)

515 
‰y
->
¡İ³d
 = 1;

516 ià(
‰y
->
lšk
 &&ty->lšk->
·ck‘
) {

517 
‰y
->
ù¾_¡©us
 &ğ~
TIOCPKT_START
;

518 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_STOP
;

519 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

521 ià(
‰y
->
¡İ
)

522 (
‰y
->
¡İ
)(tty);

523 ià(
	`IS_A_CONSOLE
(
‰y
->
lše
)) {

524 
	`£t_vc_kbd_Ëd
(
kbd_bË
 + 
fg_cÚsŞe
, 
VC_SCROLLOCK
);

525 
	`£t_Ëds
();

527 
	}
}

529 
	$¡¬t_‰y
(
‰y_¡ruù
 *
‰y
)

531 ià(!
‰y
->
¡İ³d
)

533 
‰y
->
¡İ³d
 = 0;

534 ià(
‰y
->
lšk
 &&ty->lšk->
·ck‘
) {

535 
‰y
->
ù¾_¡©us
 &ğ~
TIOCPKT_STOP
;

536 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_START
;

537 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

539 ià(
‰y
->
¡¬t
)

540 (
‰y
->
¡¬t
)(tty);

541 
	`TTY_WRITE_FLUSH
(
‰y
);

542 ià(
	`IS_A_CONSOLE
(
‰y
->
lše
)) {

543 
	`şr_vc_kbd_Ëd
(
kbd_bË
 + 
fg_cÚsŞe
, 
VC_SCROLLOCK
);

544 
	`£t_Ëds
();

546 
	}
}

551 
	$İo¡
(
c
, 
‰y_¡ruù
 *
‰y
)

553 ià(
	`FULL
(&
‰y
->
wr™e_q
))

555 ià(
	`O_OPOST
(
‰y
)) {

556 
c
) {

558 ià(
	`O_ONLRET
(
‰y
))

559 
‰y
->
cŞumn
 = 0;

560 ià(
	`O_ONLCR
(
‰y
)) {

561 ià(
	`LEFT
(&
‰y
->
wr™e_q
) < 2)

563 
	`put_‰y_queue
('\r', &
‰y
->
wr™e_q
);

564 
‰y
->
cŞumn
 = 0;

566 
‰y
->
ÿnÚ_cŞumn
 =ty->
cŞumn
;

569 ià(
	`O_ONOCR
(
‰y
è&&ty->
cŞumn
 == 0)

571 ià(
	`O_OCRNL
(
‰y
)) {

572 
c
 = '\n';

573 ià(
	`O_ONLRET
(
‰y
))

574 
‰y
->
ÿnÚ_cŞumn
 =ty->
cŞumn
 = 0;

577 
‰y
->
ÿnÚ_cŞumn
 =ty->
cŞumn
 = 0;

580 ià(
	`O_TABDLY
(
‰y
è=ğ
XTABS
) {

581 ià(
	`LEFT
(&
‰y
->
wr™e_q
) < 8)

584 
	`put_‰y_queue
(' ', &
‰y
->
wr™e_q
);

585 ++
‰y
->
cŞumn
 % 8);

588 
‰y
->
cŞumn
 = (tty->column | 7) + 1;

591 ià(
‰y
->
cŞumn
 > 0)

592 
‰y
->
cŞumn
--;

595 ià(
	`O_OLCUC
(
‰y
))

596 
c
 = 
	`touµ”
(c);

597 ià(!
	`isúŒl
(
c
))

598 
‰y
->
cŞumn
++;

602 
	`put_‰y_queue
(
c
, &
‰y
->
wr™e_q
);

604 
	}
}

608 
	$echo_ch¬
(
c
, 
‰y_¡ruù
 *
‰y
)

610 ià(
	`L_ECHOCTL
(
‰y
è&& 
	`isúŒl
(
c
) && c != '\t') {

611 
	`İo¡
('^', 
‰y
);

612 
	`İo¡
(
c
 ^ 0100, 
‰y
);

614 
	`İo¡
(
c
, 
‰y
);

615 
	}
}

617 
	$”a£r
(
c
, 
‰y_¡ruù
 *
‰y
)

619 ’um { 
ERASE
, 
WERASE
, 
KILL
 } 
kl_ty³
;

620 
£’_®nums
;

622 ià(
‰y
->
£cÚd¬y
.
h—d
 =ğ‰y->
ÿnÚ_h—d
) {

626 ià(
c
 =ğ
	`ERASE_CHAR
(
‰y
))

627 
kl_ty³
 = 
ERASE
;

628 ià(
c
 =ğ
	`WERASE_CHAR
(
‰y
))

629 
kl_ty³
 = 
WERASE
;

631 ià(!
	`L_ECHO
(
‰y
)) {

632 
‰y
->
£cÚd¬y
.
h—d
 =ty->
ÿnÚ_h—d
;

635 ià(!
	`L_ECHOK
(
‰y
è|| !
	`L_ECHOKE
(tty)) {

636 
‰y
->
£cÚd¬y
.
h—d
 =ty->
ÿnÚ_h—d
;

637 ià(
‰y
->
”asšg
) {

638 
	`İo¡
('/', 
‰y
);

639 
‰y
->
”asšg
 = 0;

641 
	`echo_ch¬
(
	`KILL_CHAR
(
‰y
),ty);

643 ià(
	`L_ECHOK
(
‰y
))

644 
	`İo¡
('\n', 
‰y
);

647 
kl_ty³
 = 
KILL
;

650 
£’_®nums
 = 0;

651 
‰y
->
£cÚd¬y
.
h—d
 !ğ‰y->
ÿnÚ_h—d
) {

652 
c
 = 
	`LAST
(&
‰y
->
£cÚd¬y
);

653 ià(
kl_ty³
 =ğ
WERASE
) {

655 ià(
	`i§Êum
(
c
) || c == '_')

656 
£’_®nums
++;

657 ià(
£’_®nums
)

660 
	`DEC
(
‰y
->
£cÚd¬y
.
h—d
);

661 ià(
	`L_ECHO
(
‰y
)) {

662 ià(
	`L_ECHOPRT
(
‰y
)) {

663 ià(!
‰y
->
”asšg
) {

664 
	`İo¡
('\\', 
‰y
);

665 
‰y
->
”asšg
 = 1;

667 
	`echo_ch¬
(
c
, 
‰y
);

668 } ià(!
	`L_ECHOE
(
‰y
)) {

669 
	`echo_ch¬
(
	`ERASE_CHAR
(
‰y
),ty);

670 } ià(
c
 == '\t') {

671 
cŞ
 = 
‰y
->
ÿnÚ_cŞumn
;

672 

 = 
‰y
->
ÿnÚ_h—d
;

675 

 !ğ
‰y
->
£cÚd¬y
.
h—d
) {

676 
c
 = 
‰y
->
£cÚd¬y
.
buf
[

];

677 ià(
c
 == '\t')

678 
cŞ
 = (col | 7) + 1;

679 ià(
	`isúŒl
(
c
)) {

680 ià(
	`L_ECHOCTL
(
‰y
))

681 
cŞ
 += 2;

683 
cŞ
++;

684 
	`INC
(

);

688 
‰y
->
cŞumn
 > 
cŞ
) {

690 
	`put_‰y_queue
('\b', &
‰y
->
wr™e_q
);

691 
‰y
->
cŞumn
--;

694 ià(
	`isúŒl
(
c
è&& 
	`L_ECHOCTL
(
‰y
)) {

695 
	`İo¡
('\b', 
‰y
);

696 
	`İo¡
(' ', 
‰y
);

697 
	`İo¡
('\b', 
‰y
);

699 ià(!
	`isúŒl
(
c
è|| 
	`L_ECHOCTL
(
‰y
)) {

700 
	`İo¡
('\b', 
‰y
);

701 
	`İo¡
(' ', 
‰y
);

702 
	`İo¡
('\b', 
‰y
);

706 ià(
kl_ty³
 =ğ
ERASE
)

709 ià(
‰y
->
”asšg
 &&ty->
£cÚd¬y
.
h—d
 =ğ‰y->
ÿnÚ_h—d
) {

710 
	`İo¡
('/', 
‰y
);

711 
‰y
->
”asšg
 = 0;

713 
	}
}

715 
	$isig
(
sig
, 
‰y_¡ruù
 *
‰y
)

717 
	`kl_pg
(
‰y
->
pg½
, 
sig
, 1);

718 ià(!
	`L_NOFLSH
(
‰y
)) {

719 
	`æush_šput
(
‰y
);

720 
	`æush_ouut
(
‰y
);

722 
	}
}

724 
	$cİy_to_cooked
(
‰y_¡ruù
 * 
‰y
)

726 
c
, 
¥ecŸl_æag
;

727 
æags
;

729 ià(!
‰y
) {

730 
	`´štk
("copy_to_cooked: called with NULLty\n");

733 ià(!
‰y
->
wr™e
) {

734 
	`´štk
("copy_to_cooked:ty %d has‚ull write„outine\n",

735 
‰y
->
lše
);

743 
c
 = 
	`LEFT
(&
‰y
->
£cÚd¬y
);

744 ià(
‰y
->
thrÙe
 && (
c
 < 
SQ_THRESHOLD_LW
)

745 && !
	`£t_b™
(
TTY_SQ_THROTTLED
, &
‰y
->
æags
))

746 
‰y
->
	`thrÙe
Ñty, 
TTY_THROTTLE_SQ_FULL
);

747 ià(
c
 == 0)

749 
	`§ve_æags
(
æags
); 
	`şi
();

750 ià(!
	`EMPTY
(&
‰y
->
»ad_q
)) {

751 
c
 = 
‰y
->
»ad_q
.
buf
[‰y->»ad_q.

];

752 
¥ecŸl_æag
 = 
	`ş—r_b™
(
‰y
->
»ad_q
.

,

753 &
‰y
->
»adq_æags
);

754 
	`INC
(
‰y
->
»ad_q
.

);

755 
	`»¡Üe_æags
(
æags
);

757 
	`»¡Üe_æags
(
æags
);

760 ià(
¥ecŸl_æag
) {

761 
‰y
->
ch¬_”rÜ
 = 
c
;

764 ià(
‰y
->
ch¬_”rÜ
) {

765 ià(
‰y
->
ch¬_”rÜ
 =ğ
TTY_BREAK
) {

766 
‰y
->
ch¬_”rÜ
 = 0;

767 ià(
	`I_IGNBRK
(
‰y
))

770 ià(
	`I_BRKINT
(
‰y
))

772 ià(
	`I_PARMRK
(
‰y
)) {

773 
	`put_‰y_queue
('\377', &
‰y
->
£cÚd¬y
);

774 
	`put_‰y_queue
('\0', &
‰y
->
£cÚd¬y
);

776 
	`put_‰y_queue
('\0', &
‰y
->
£cÚd¬y
);

779 ià(
‰y
->
ch¬_”rÜ
 =ğ
TTY_OVERRUN
) {

780 
‰y
->
ch¬_”rÜ
 = 0;

781 
	`´štk
("‰y%d: iÅuˆov”run\n", 
‰y
->
lše
);

785 
‰y
->
ch¬_”rÜ
 = 0;

786 ià(
	`I_IGNPAR
(
‰y
)) {

789 ià(
	`I_PARMRK
(
‰y
)) {

790 
	`put_‰y_queue
('\377', &
‰y
->
£cÚd¬y
);

791 
	`put_‰y_queue
('\0', &
‰y
->
£cÚd¬y
);

792 
	`put_‰y_queue
(
c
, &
‰y
->
£cÚd¬y
);

794 
	`put_‰y_queue
('\0', &
‰y
->
£cÚd¬y
);

797 ià(
	`I_ISTRIP
(
‰y
))

798 
c
 &= 0x7f;

799 ià(!
‰y
->
Êext
) {

800 ià(
c
 == '\r') {

801 ià(
	`I_IGNCR
(
‰y
))

803 ià(
	`I_ICRNL
(
‰y
))

804 
c
 = '\n';

805 } ià(
c
 =ğ'\n' && 
	`I_INLCR
(
‰y
))

806 
c
 = '\r';

808 ià(
	`I_IUCLC
(
‰y
è&& 
	`L_IEXTEN
(tty))

809 
c
=
	`tŞow”
(c);

810 ià(
c
 =ğ
__DISABLED_CHAR
)

811 
‰y
->
Êext
 = 1;

812 ià(
	`L_ICANON
(
‰y
è&& !‰y->
Êext
) {

813 ià(
c
 =ğ
	`ERASE_CHAR
(
‰y
è|| c =ğ
	`KILL_CHAR
(tty) ||

814 (
c
 =ğ
	`WERASE_CHAR
(
‰y
è&& 
	`L_IEXTEN
(tty))) {

815 
	`”a£r
(
c
, 
‰y
);

818 ià(
c
 =ğ
	`LNEXT_CHAR
(
‰y
è&& 
	`L_IEXTEN
(tty)) {

819 
‰y
->
Êext
 = 1;

820 ià(
	`L_ECHO
(
‰y
)) {

821 ià(
‰y
->
”asšg
) {

822 
	`İo¡
('/', 
‰y
);

823 
‰y
->
”asšg
 = 0;

825 ià(
	`L_ECHOCTL
(
‰y
)) {

826 
	`İo¡
('^', 
‰y
);

827 
	`İo¡
('\b', 
‰y
);

832 ià(
c
 =ğ
	`REPRINT_CHAR
(
‰y
è&& 
	`L_ECHO
(tty) &&

833 
	`L_IEXTEN
(
‰y
)) {

834 

 = 
‰y
->
ÿnÚ_h—d
;

836 ià(
‰y
->
”asšg
) {

837 
	`İo¡
('/', 
‰y
);

838 
‰y
->
”asšg
 = 0;

840 
	`echo_ch¬
(
c
, 
‰y
);

841 
	`İo¡
('\n', 
‰y
);

842 

 !ğ
‰y
->
£cÚd¬y
.
h—d
) {

843 
	`echo_ch¬
(
‰y
->
£cÚd¬y
.
buf
[

],

844 
‰y
);

845 
	`INC
(

);

850 ià(
	`I_IXON
(
‰y
è&& !‰y->
Êext
) {

851 ià((
‰y
->
¡İ³d
 && 
	`I_IXANY
Ñtyè&& 
	`L_IEXTEN
(tty)) ||

852 
c
 =ğ
	`START_CHAR
(
‰y
)) {

853 
	`¡¬t_‰y
(
‰y
);

856 ià(
c
 =ğ
	`STOP_CHAR
(
‰y
)) {

857 
	`¡İ_‰y
(
‰y
);

861 ià(
	`L_ISIG
(
‰y
è&& !‰y->
Êext
) {

862 ià(
c
 =ğ
	`INTR_CHAR
(
‰y
)) {

863 
	`isig
(
SIGINT
, 
‰y
);

866 ià(
c
 =ğ
	`QUIT_CHAR
(
‰y
)) {

867 
	`isig
(
SIGQUIT
, 
‰y
);

870 ià(
c
 =ğ
	`SUSP_CHAR
(
‰y
)) {

871 ià(!
	`is_Üphªed_pg½
(
‰y
->
pg½
))

872 
	`isig
(
SIGTSTP
, 
‰y
);

877 ià(
‰y
->
”asšg
) {

878 
	`İo¡
('/', 
‰y
);

879 
‰y
->
”asšg
 = 0;

881 ià(
c
 =ğ'\n' && !
‰y
->
Êext
) {

882 ià(
	`L_ECHO
(
‰y
è|| (
	`L_ICANON
Ñtyè&& 
	`L_ECHONL
(tty)))

883 
	`İo¡
('\n', 
‰y
);

884 } ià(
	`L_ECHO
(
‰y
)) {

888 ià(
c
 !ğ
	`EOF_CHAR
(
‰y
è|| !
	`L_ICANON
(tty) ||

889 
‰y
->
Êext
) {

891 ià(
‰y
->
ÿnÚ_h—d
 =ğ‰y->
£cÚd¬y
.
h—d
)

892 
‰y
->
ÿnÚ_cŞumn
 =ty->
cŞumn
;

893 
	`echo_ch¬
(
c
, 
‰y
);

897 ià(
	`I_PARMRK
(
‰y
è&& 
c
 == () '\377' &&

898 (
c
 !ğ
	`EOF_CHAR
(
‰y
è|| !
	`L_ICANON
Ñtyè||ty->
Êext
))

899 
	`put_‰y_queue
(
c
, &
‰y
->
£cÚd¬y
);

901 ià(
	`L_ICANON
(
‰y
è&& !‰y->
Êext
 &&

902 (
c
 =ğ'\n' || c =ğ
	`EOF_CHAR
(
‰y
è|| c =ğ
	`EOL_CHAR
(tty) ||

903 (
c
 =ğ
	`EOL2_CHAR
(
‰y
è&& 
	`L_IEXTEN
(tty)))) {

904 ià(
c
 =ğ
	`EOF_CHAR
(
‰y
))

905 
c
 = 
__DISABLED_CHAR
;

906 
	`£t_b™
(
‰y
->
£cÚd¬y
.
h—d
, &‰y->
£cÚd¬y_æags
);

907 
	`put_‰y_queue
(
c
, &
‰y
->
£cÚd¬y
);

908 
‰y
->
ÿnÚ_h—d
 =ty->
£cÚd¬y
.
h—d
;

909 
‰y
->
ÿnÚ_d©a
++;

911 
	`put_‰y_queue
(
c
, &
‰y
->
£cÚd¬y
);

912 
‰y
->
Êext
 = 0;

914 ià(!
	`EMPTY
(&
‰y
->
wr™e_q
))

915 
	`TTY_WRITE_FLUSH
(
‰y
);

916 ià(
	`L_ICANON
(
‰y
è?ty->
ÿnÚ_d©a
 : !
	`EMPTY
(&‰y->
£cÚd¬y
))

917 
	`wake_up_š‹¼u±ibË
(&
‰y
->
£cÚd¬y
.
´oc_li¡
);

919 ià(
‰y
->
thrÙe
 && (
	`LEFT
(&‰y->
»ad_q
è>ğ
RQ_THRESHOLD_HW
)

920 && 
	`ş—r_b™
(
TTY_RQ_THROTTLED
, &
‰y
->
æags
))

921 
‰y
->
	`thrÙe
Ñty, 
TTY_THROTTLE_RQ_AVAIL
);

922 
	}
}

924 
	$is_ignÜed
(
sig
)

926  ((
cu¼’t
->
blocked
 & (1<<(
sig
-1))) ||

927 (
cu¼’t
->
sigaùiÚ
[
sig
-1].
§_hªdËr
 =ğ
SIG_IGN
));

928 
	}
}

930 
šlše
 
	$šput_avaabË_p
(
‰y_¡ruù
 *
‰y
)

933 ià(
	`L_ICANON
(
‰y
è?ty->
ÿnÚ_d©a
 : !
	`EMPTY
(&‰y->
£cÚd¬y
))

937 
	`TTY_READ_FLUSH
(
‰y
);

938 ià(
‰y
->
lšk
)

939 
	`TTY_WRITE_FLUSH
(
‰y
->
lšk
);

941 ià(
	`L_ICANON
(
‰y
è?ty->
ÿnÚ_d©a
 : !
	`EMPTY
(&‰y->
£cÚd¬y
))

944 
	}
}

946 
	$»ad_chª
(
‰y_¡ruù
 *
‰y
, 
fe
 *file,

947 *
buf
, 
Ä
)

949 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

950 
c
;

951 *
b
 = 
buf
;

952 
mšimum
, 
time
;

953 
»tv®
 = 0;

960 ià(
fe
->
f_šode
->
i_rdev
 !ğ
CONSOLE_DEV
 &&

961 
cu¼’t
->
‰y
 =ğ‰y->
lše
) {

962 ià(
‰y
->
pg½
 <= 0)

963 
	`´štk
("read_chan:ty->pgrp <= 0!\n");

964 ià(
cu¼’t
->
pg½
 !ğ
‰y
->pgrp) {

965 ià(
	`is_ignÜed
(
SIGTTIN
) ||

966 
	`is_Üphªed_pg½
(
cu¼’t
->
pg½
))

967  -
EIO
;

968 
	`kl_pg
(
cu¼’t
->
pg½
, 
SIGTTIN
, 1);

969  -
ERESTARTSYS
;

973 ià(
	`L_ICANON
(
‰y
)) {

974 
mšimum
 = 
time
 = 0;

975 
cu¼’t
->
timeout
 = () -1;

977 
time
 = (
HZ
 / 10è* 
	`TIME_CHAR
(
‰y
);

978 
mšimum
 = 
	`MIN_CHAR
(
‰y
);

979 ià(
mšimum
)

980 
cu¼’t
->
timeout
 = () -1;

982 ià(
time
) {

983 
cu¼’t
->
timeout
 = 
time
 + 
jiff›s
;

984 
time
 = 0;

986 
cu¼’t
->
timeout
 = 0;

987 
mšimum
 = 1;

991 
	`add_wa™_queue
(&
‰y
->
£cÚd¬y
.
´oc_li¡
, &
wa™
);

994 ià(
‰y
->
·ck‘
 &&ty->
lšk
->
ù¾_¡©us
) {

995 ià(
b
 !ğ
buf
)

997 
	`put_fs_by‹
(
‰y
->
lšk
->
ù¾_¡©us
, 
b
++);

998 
‰y
->
lšk
->
ù¾_¡©us
 = 0;

1004 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1005 ià(!
	`šput_avaabË_p
(
‰y
)) {

1006 ià(
‰y
->
æags
 & (1 << 
TTY_SLAVE_CLOSED
)) {

1007 
»tv®
 = -
EIO
;

1010 ià(
	`‰y_hung_up_p
(
fe
))

1012 ià(!
cu¼’t
->
timeout
)

1014 ià(
fe
->
f_æags
 & 
O_NONBLOCK
) {

1015 
»tv®
 = -
EAGAIN
;

1018 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1019 
»tv®
 = -
ERESTARTSYS
;

1022 
	`scheduË
();

1025 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1028 ià(
‰y
->
·ck‘
 && 
b
 =ğ
buf
) {

1029 
	`put_fs_by‹
(
TIOCPKT_DATA
, 
b
++);

1030 
Ä
--;

1034 
eŞ
;

1036 
	`şi
();

1037 ià(
	`EMPTY
(&
‰y
->
£cÚd¬y
)) {

1038 
	`¡i
();

1041 
eŞ
 = 
	`ş—r_b™
(
‰y
->
£cÚd¬y
.

,

1042 &
‰y
->
£cÚd¬y_æags
);

1043 
c
 = 
‰y
->
£cÚd¬y
.
buf
[‰y->£cÚd¬y.

];

1044 ià(!
Ä
) {

1050 ià(
eŞ
) {

1051 ià(
c
 =ğ
__DISABLED_CHAR
) {

1052 
‰y
->
ÿnÚ_d©a
--;

1053 
	`INC
(
‰y
->
£cÚd¬y
.

);

1055 
	`£t_b™
(
‰y
->
£cÚd¬y
.

,

1056 &
‰y
->
£cÚd¬y_æags
);

1059 
	`¡i
();

1062 
	`INC
(
‰y
->
£cÚd¬y
.

);

1063 
	`¡i
();

1064 ià(
eŞ
) {

1065 ià(--
‰y
->
ÿnÚ_d©a
 < 0) {

1066 
	`´štk
("read_chan: canon_data < 0!\n");

1067 
‰y
->
ÿnÚ_d©a
 = 0;

1069 ià(
c
 =ğ
__DISABLED_CHAR
)

1071 
	`put_fs_by‹
(
c
, 
b
++);

1072 
Ä
--;

1075 
	`put_fs_by‹
(
c
, 
b
++);

1076 
Ä
--;

1081 ià(
‰y
->
thrÙe
 && (
	`LEFT
(&‰y->
£cÚd¬y
è>ğ
SQ_THRESHOLD_HW
)

1082 && 
	`ş—r_b™
(
TTY_SQ_THROTTLED
, &
‰y
->
æags
))

1083 
‰y
->
	`thrÙe
Ñty, 
TTY_THROTTLE_SQ_AVAIL
);

1085 ià(
b
 - 
buf
 >ğ
mšimum
 || !
Ä
)

1087 ià(
time
)

1088 
cu¼’t
->
timeout
 = 
time
 + 
jiff›s
;

1090 
	`»move_wa™_queue
(&
‰y
->
£cÚd¬y
.
´oc_li¡
, &
wa™
);

1091 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1092 
cu¼’t
->
timeout
 = 0;

1093  (
b
 - 
buf
è? b - buà: 
»tv®
;

1094 
	}
}

1096 
	$wr™e_chª
(
‰y_¡ruù
 * 
‰y
, 
fe
 * file,

1097 * 
buf
, 
Ä
)

1099 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

1100 
c
;

1101 *
b
 = 
buf
;

1102 
»tv®
 = 0;

1105 ià(
	`L_TOSTOP
(
‰y
è&& 
fe
->
f_šode
->
i_rdev
 !ğ
CONSOLE_DEV
) {

1106 
»tv®
 = 
	`check_chªge
(
‰y
,ty->
lše
);

1107 ià(
»tv®
)

1108  
»tv®
;

1111 
	`add_wa™_queue
(&
‰y
->
wr™e_q
.
´oc_li¡
, &
wa™
);

1113 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1114 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1115 
»tv®
 = -
ERESTARTSYS
;

1118 ià(
	`‰y_hung_up_p
(
fe
è|| (
‰y
->
lšk
 && !‰y->lšk->
couÁ
)) {

1119 
»tv®
 = -
EIO
;

1122 
Ä
 > 0) {

1123 
c
 = 
	`g‘_fs_by‹
(
b
);

1126 ià(
	`İo¡
(
c
, 
‰y
) < 0)

1128 
b
++; 
Ä
--;

1130 
	`TTY_WRITE_FLUSH
(
‰y
);

1131 ià(!
Ä
)

1133 ià(
	`EMPTY
(&
‰y
->
wr™e_q
è&& !
Ãed_»sched
)

1135 ià(
fe
->
f_æags
 & 
O_NONBLOCK
) {

1136 
»tv®
 = -
EAGAIN
;

1139 
	`scheduË
();

1141 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1142 
	`»move_wa™_queue
(&
‰y
->
wr™e_q
.
´oc_li¡
, &
wa™
);

1143  (
b
 - 
buf
è? b - buà: 
»tv®
;

1144 
	}
}

1146 
	$‰y_»ad
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

1148 
i
, 
dev
;

1149 
‰y_¡ruù
 * 
‰y
;

1151 
dev
 = 
fe
->
f_rdev
;

1152 ià(
	`MAJOR
(
dev
è!ğ
TTY_MAJOR
) {

1153 
	`´štk
("‰y_»ad: bad…£udo-majÜ‚¸#%d\n", 
	`MAJOR
(
dev
));

1154  -
EINVAL
;

1156 
dev
 = 
	`MINOR
(dev);

1157 
‰y
 = 
	`TTY_TABLE
(
dev
);

1158 ià(!
‰y
 || (‰y->
æags
 & (1 << 
TTY_IO_ERROR
)))

1159  -
EIO
;

1166 ià((
šode
->
i_rdev
 !ğ
CONSOLE_DEV
) &&

1167 (
‰y
->
pg½
 > 0) &&

1168 (
cu¼’t
->
‰y
 =ğ
dev
) &&

1169 (
‰y
->
pg½
 !ğ
cu¼’t
->pgrp))

1170 ià(
	`is_ignÜed
(
SIGTTIN
è|| 
	`is_Üphªed_pg½
(
cu¼’t
->
pg½
))

1171  -
EIO
;

1173 (è
	`kl_pg
(
cu¼’t
->
pg½
, 
SIGTTIN
, 1);

1174  -
ERESTARTSYS
;

1177 ià(
ldiscs
[
‰y
->
disc
].
»ad
)

1179 
i
 = (
ldiscs
[
‰y
->
disc
].
»ad
)Ñty,
fe
,(*)
buf
,()
couÁ
);

1181 
i
 = -
EIO
;

1182 ià(
i
 > 0)

1183 
šode
->
i_©ime
 = 
CURRENT_TIME
;

1184  
i
;

1185 
	}
}

1187 
	$‰y_wr™e
(
šode
 * inode, 
fe
 * fe, * 
buf
, 
couÁ
)

1189 
dev
, 
i
, 
is_cÚsŞe
;

1190 
‰y_¡ruù
 * 
‰y
;

1192 
dev
 = 
fe
->
f_rdev
;

1193 
is_cÚsŞe
 = (
šode
->
i_rdev
 =ğ
CONSOLE_DEV
);

1194 ià(
	`MAJOR
(
dev
è!ğ
TTY_MAJOR
) {

1195 
	`´štk
("tty_write:…seudo-major != TTY_MAJOR\n");

1196  -
EINVAL
;

1198 
dev
 = 
	`MINOR
(dev);

1199 ià(
is_cÚsŞe
 && 
»dœeù
)

1200 
‰y
 = 
»dœeù
;

1202 
‰y
 = 
	`TTY_TABLE
(
dev
);

1203 ià(!
‰y
 || !‰y->
wr™e
 || (‰y->
æags
 & (1 << 
TTY_IO_ERROR
)))

1204  -
EIO
;

1206 ià(!
is_cÚsŞe
 && 
	`L_TOSTOP
(
‰y
è&& (‰y->
pg½
 > 0) &&

1207 (
cu¼’t
->
‰y
 =ğ
dev
è&& (‰y->
pg½
 != current->pgrp)) {

1208 ià(
	`is_Üphªed_pg½
(
cu¼’t
->
pg½
))

1209  -
EIO
;

1210 ià(!
	`is_ignÜed
(
SIGTTOU
)) {

1211 (è
	`kl_pg
(
cu¼’t
->
pg½
, 
SIGTTOU
, 1);

1212  -
ERESTARTSYS
;

1216 ià(
ldiscs
[
‰y
->
disc
].
wr™e
)

1218 
i
 = (
ldiscs
[
‰y
->
disc
].
wr™e
)Ñty,
fe
,(*)
buf
,()
couÁ
);

1220 
i
 = -
EIO
;

1221 ià(
i
 > 0)

1222 
šode
->
i_mtime
 = 
CURRENT_TIME
;

1223  
i
;

1224 
	}
}

1231 
	$š™_dev
(
dev
)

1233 
‰y_¡ruù
 *
‰y
, *
o_‰y
;

1234 
‹rmios
 *

, *
o_
, *
Ép
, *
o_Ép
;

1235 
»tv®
;

1236 
o_dev
;

1238 
o_dev
 = 
	`PTY_OTHER
(
dev
);

1239 
‰y
 = 
o_‰y
 = 
NULL
;

1240 

 = 
o_
 = 
NULL
;

1241 
Ép
 = 
o_Ép
 = 
NULL
;

1242 
»³©
:

1243 
»tv®
 = -
EAGAIN
;

1244 ià(
	`IS_A_PTY_MASTER
(
dev
è&& 
‰y_bË
[dev] &&ty_bË[dev]->
couÁ
)

1245 
’d_š™
;

1246 
»tv®
 = -
ENOMEM
;

1247 ià(!
‰y_bË
[
dev
] && !
‰y
) {

1248 ià(!(
‰y
 = (
‰y_¡ruù
*è
	`g‘_ä“_·ge
(
GFP_KERNEL
)))

1249 
’d_š™
;

1250 
	`š™Ÿlize_‰y_¡ruù
(
dev
, 
‰y
);

1251 
»³©
;

1253 ià(!
‰y_‹rmios
[
dev
] && !

) {

1254 

 = (
‹rmios
 *è
	`km®loc
((termios),

1255 
GFP_KERNEL
);

1256 ià(!

)

1257 
’d_š™
;

1258 
	`š™Ÿlize_‹rmios
(
dev
, 

);

1259 
»³©
;

1261 ià(!
‹rmios_locked
[
dev
] && !
Ép
) {

1262 
Ép
 = (
‹rmios
 *è
	`km®loc
((termios),

1263 
GFP_KERNEL
);

1264 ià(!
Ép
)

1265 
’d_š™
;

1266 
	`mem£t
(
Ép
, 0, (
‹rmios
));

1267 
»³©
;

1269 ià(
	`IS_A_PTY
(
dev
)) {

1270 ià(!
‰y_bË
[
o_dev
] && !
o_‰y
) {

1271 
o_‰y
 = (
‰y_¡ruù
 *)

1272 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

1273 ià(!
o_‰y
)

1274 
’d_š™
;

1275 
	`š™Ÿlize_‰y_¡ruù
(
o_dev
, 
o_‰y
);

1276 
»³©
;

1278 ià(!
‰y_‹rmios
[
o_dev
] && !
o_
) {

1279 
o_
 = (
‹rmios
 *)

1280 
	`km®loc
((
‹rmios
), 
GFP_KERNEL
);

1281 ià(!
o_
)

1282 
’d_š™
;

1283 
	`š™Ÿlize_‹rmios
(
o_dev
, 
o_
);

1284 
»³©
;

1286 ià(!
‹rmios_locked
[
o_dev
] && !
o_Ép
) {

1287 
o_Ép
 = (
‹rmios
 *)

1288 
	`km®loc
((
‹rmios
), 
GFP_KERNEL
);

1289 ià(!
o_Ép
)

1290 
’d_š™
;

1291 
	`mem£t
(
o_Ép
, 0, (
‹rmios
));

1292 
»³©
;

1297 ià(!
‰y_‹rmios
[
dev
]) {

1298 
‰y_‹rmios
[
dev
] = 

;

1299 

 = 
NULL
;

1301 ià(!
‰y_bË
[
dev
]) {

1302 
‰y
->
‹rmios
 = 
‰y_‹rmios
[
dev
];

1303 
‰y_bË
[
dev
] = 
‰y
;

1304 
‰y
 = 
NULL
;

1306 ià(!
‹rmios_locked
[
dev
]) {

1307 
‹rmios_locked
[
dev
] = 
Ép
;

1308 
Ép
 = 
NULL
;

1310 ià(
	`IS_A_PTY
(
dev
)) {

1311 ià(!
‰y_‹rmios
[
o_dev
]) {

1312 
‰y_‹rmios
[
o_dev
] = 
o_
;

1313 
o_
 = 
NULL
;

1315 ià(!
‹rmios_locked
[
o_dev
]) {

1316 
‹rmios_locked
[
o_dev
] = 
o_Ép
;

1317 
o_Ép
 = 
NULL
;

1319 ià(!
‰y_bË
[
o_dev
]) {

1320 
o_‰y
->
‹rmios
 = 
‰y_‹rmios
[
o_dev
];

1321 
‰y_bË
[
o_dev
] = 
o_‰y
;

1322 
o_‰y
 = 
NULL
;

1324 
‰y_bË
[
dev
]->
lšk
 =ty_bË[
o_dev
];

1325 
‰y_bË
[
o_dev
]->
lšk
 =ty_bË[
dev
];

1327 
‰y_bË
[
dev
]->
couÁ
++;

1328 ià(
	`IS_A_PTY_MASTER
(
dev
))

1329 
‰y_bË
[
o_dev
]->
couÁ
++;

1330 
»tv®
 = 0;

1331 
’d_š™
:

1332 ià(
‰y
)

1333 
	`ä“_·ge
((è
‰y
);

1334 ià(
o_‰y
)

1335 
	`ä“_·ge
((è
o_‰y
);

1336 ià(

)

1337 
	`kä“_s
(

, (
‹rmios
));

1338 ià(
o_
)

1339 
	`kä“_s
(
o_
, (
‹rmios
));

1340 ià(
Ép
)

1341 
	`kä“_s
(
Ép
, (
‹rmios
));

1342 ià(
o_Ép
)

1343 
	`kä“_s
(
o_Ép
, (
‹rmios
));

1344  
»tv®
;

1345 
	}
}

1352 
	$»Ëa£_dev
(
dev
, 
fe
 * 
fp
)

1354 
‰y_¡ruù
 *
‰y
, *
o_‰y
;

1355 
‹rmios
 *

, *
o_
;

1356 
sk_¡ruù
 **
p
;

1358 
‰y
 = 
‰y_bË
[
dev
];

1359 

 = 
‰y_‹rmios
[
dev
];

1360 
o_‰y
 = 
NULL
;

1361 
o_
 = 
NULL
;

1362 ià(!
‰y
) {

1363 
	`´štk
("»Ëa£_dev:ty_bË[%d] wa NULL\n", 
dev
);

1366 ià(!

) {

1367 
	`´štk
("»Ëa£_dev:ty_‹rmios[%d] wa NULL\n", 
dev
);

1370 #ifdeà
TTY_DEBUG_HANGUP


1371 
	`´štk
("»Ëa£_dev oà‰y%d (‰y couÁ=%d)...", 
dev
, 
‰y
->
couÁ
);

1373 ià(
	`IS_A_PTY
(
dev
)) {

1374 
o_‰y
 = 
‰y_bË
[
	`PTY_OTHER
(
dev
)];

1375 
o_
 = 
‰y_‹rmios
[
	`PTY_OTHER
(
dev
)];

1376 ià(!
o_‰y
) {

1377 
	`´štk
("»Ëa£_dev:…ty…aœ(%dèwa NULL\n", 
dev
);

1380 ià(!
o_
) {

1381 
	`´štk
("»Ëa£_dev:…ty…aœ(%dè‹rmio wa NULL\n", 
dev
);

1384 ià(
‰y
->
lšk
 !ğ
o_‰y
 || o_tty->link !=ty) {

1385 
	`´štk
("release_dev: bad…ty…ointers\n");

1389 
‰y
->
wr™e_d©a_út
 = 0;

1390 ià(
‰y
->
şo£
)

1391 
‰y
->
	`şo£
Ñty, 
fp
);

1392 ià(
	`IS_A_PTY_MASTER
(
dev
)) {

1393 ià(--
‰y
->
lšk
->
couÁ
 < 0) {

1394 
	`´štk
("release_dev: badty slave count (dev = %d): %d\n",

1395 
dev
, 
‰y
->
couÁ
);

1396 
‰y
->
lšk
->
couÁ
 = 0;

1399 ià(--
‰y
->
couÁ
 < 0) {

1400 
	`´štk
("release_dev: badty_table[%d]->count: %d\n",

1401 
dev
, 
‰y
->
couÁ
);

1402 
‰y
->
couÁ
 = 0;

1404 ià(
‰y
->
couÁ
)

1407 #ifdeà
TTY_DEBUG_HANGUP


1408 
	`´štk
("freeingty structure...");

1415 
p
 = &
LAST_TASK
 ;… > &
FIRST_TASK
 ; --p) {

1416 ià((*
p
è&& (*p)->
‰y
 =ğ‰y->
lše
)

1417 (*
p
)->
‰y
 = -1;

1424 ià(
ldiscs
[
‰y
->
disc
].
şo£
 !ğ
NULL
)

1425 
ldiscs
[
‰y
->
disc
].
	`şo£
(tty);

1426 
‰y
->
disc
 = 
N_TTY
;

1427 
‰y
->
‹rmios
->
c_lše
 = 
N_TTY
;

1429 ià(
o_‰y
) {

1430 ià(
o_‰y
->
couÁ
)

1433 
‰y_bË
[
	`PTY_OTHER
(
dev
)] = 
NULL
;

1434 
‰y_‹rmios
[
	`PTY_OTHER
(
dev
)] = 
NULL
;

1437 
‰y_bË
[
dev
] = 
NULL
;

1438 ià(
	`IS_A_PTY
(
dev
)) {

1439 
‰y_‹rmios
[
dev
] = 
NULL
;

1440 
	`kä“_s
(

, (
‹rmios
));

1442 ià(
‰y
 =ğ
»dœeù
 || 
o_‰y
 ==„edirect)

1443 
»dœeù
 = 
NULL
;

1444 
	`ä“_·ge
((è
‰y
);

1445 ià(
o_‰y
)

1446 
	`ä“_·ge
((è
o_‰y
);

1447 ià(
o_
)

1448 
	`kä“_s
(
o_
, (
‹rmios
));

1449 
	}
}

1463 
	$‰y_İ’
(
šode
 * inode, 
fe
 * 
fp
)

1465 
‰y_¡ruù
 *
‰y
;

1466 
majÜ
, 
mšÜ
;

1467 
noùty
, 
»tv®
;

1469 
»Œy_İ’
:

1470 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

1471 
majÜ
 = 
	`MAJOR
(
šode
->
i_rdev
);

1472 
noùty
 = 
fp
->
f_æags
 & 
O_NOCTTY
;

1473 ià(
majÜ
 =ğ
TTYAUX_MAJOR
) {

1474 ià(!
mšÜ
) {

1475 
majÜ
 = 
TTY_MAJOR
;

1476 
mšÜ
 = 
cu¼’t
->
‰y
;

1479 } ià(
majÜ
 =ğ
TTY_MAJOR
) {

1480 ià(!
mšÜ
) {

1481 
mšÜ
 = 
fg_cÚsŞe
 + 1;

1482 
noùty
 = 1;

1485 
	`´štk
("Bad majÜ #%d iÀ‰y_İ’\n", 
	`MAJOR
(
šode
->
i_rdev
));

1486  -
ENODEV
;

1488 ià(
mšÜ
 <= 0)

1489  -
ENXIO
;

1490 ià(
	`IS_A_PTY_MASTER
(
mšÜ
))

1491 
noùty
 = 1;

1492 
fp
->
f_rdev
 = (
majÜ
 << 8è| 
mšÜ
;

1493 
»tv®
 = 
	`š™_dev
(
mšÜ
);

1494 ià(
»tv®
)

1495  
»tv®
;

1496 
‰y
 = 
‰y_bË
[
mšÜ
];

1497 #ifdeà
TTY_DEBUG_HANGUP


1498 
	`´štk
("İ’šgty%d...", 
‰y
->
lše
);

1500 ià(
	`‹¡_b™
(
TTY_EXCLUSIVE
, &
‰y
->
æags
è&& !
	`su£r
())

1501  -
EBUSY
;

1516 
‰y
->
ù¾_¡©us
 = 0;

1517 
‰y
->
·ck‘
 = 0;

1520 ià(
‰y
->
İ’
) {

1521 
»tv®
 = 
‰y
->
	`İ’
Ñty, 
fp
);

1523 
»tv®
 = -
ENODEV
;

1525 ià(
»tv®
) {

1526 #ifdeà
TTY_DEBUG_HANGUP


1527 
	`´štk
("”rÜ %d iÀİ’šgty%d...", 
»tv®
, 
‰y
->
lše
);

1530 
	`»Ëa£_dev
(
mšÜ
, 
fp
);

1531 ià(
»tv®
 !ğ-
ERESTARTSYS
)

1532  
»tv®
;

1533 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

1534  
»tv®
;

1535 
	`scheduË
();

1536 
»Œy_İ’
;

1538 ià(!
noùty
 &&

1539 
cu¼’t
->
Ëad”
 &&

1540 
cu¼’t
->
‰y
<0 &&

1541 
‰y
->
£ssiÚ
==0) {

1542 
cu¼’t
->
‰y
 = 
mšÜ
;

1543 
‰y
->
£ssiÚ
 = 
cu¼’t
->session;

1544 
‰y
->
pg½
 = 
cu¼’t
->pgrp;

1546 
fp
->
f_rdev
 = 
	`MKDEV
(
TTY_MAJOR
,
mšÜ
);

1548 
	}
}

1555 
	$‰y_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

1557 
dev
;

1559 
dev
 = 
fp
->
f_rdev
;

1560 ià(
	`MAJOR
(
dev
è!ğ
TTY_MAJOR
) {

1561 
	`´štk
("tty_release:ty…seudo-major != TTY_MAJOR\n");

1564 
dev
 = 
	`MINOR
(
fp
->
f_rdev
);

1565 ià(!
dev
) {

1566 
	`´štk
("tty_release: bad f_rdev\n");

1569 
	`»Ëa£_dev
(
dev
, 
fp
);

1570 
	}
}

1572 
	$‰y_£Ëù
(
šode
 * inode, 
fe
 * 
fp
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

1574 
dev
;

1575 
‰y_¡ruù
 * 
‰y
;

1577 
dev
 = 
fp
->
f_rdev
;

1578 ià(
	`MAJOR
(
dev
è!ğ
TTY_MAJOR
) {

1579 
	`´štk
("tty_select:ty…seudo-major != TTY_MAJOR\n");

1582 
dev
 = 
	`MINOR
(
fp
->
f_rdev
);

1583 
‰y
 = 
	`TTY_TABLE
(
dev
);

1584 ià(!
‰y
) {

1585 
	`´štk
("‰y_£Ëù:ty sŒuù fÜ dev %d wa NULL\n", 
dev
);

1588 ià(
ldiscs
[
‰y
->
disc
].
£Ëù
)

1589  (
ldiscs
[
‰y
->
disc
].
£Ëù
)Ñty, 
šode
, 
fp
,

1590 
£l_ty³
, 
wa™
);

1592 
	}
}

1594 
	$nÜm®_£Ëù
(
‰y_¡ruù
 * 
‰y
, 
šode
 * inode,

1595 
fe
 * fe, 
£l_ty³
, 
£Ëù_bË
 *
wa™
)

1597 
£l_ty³
) {

1598 
SEL_IN
:

1599 ià(
	`šput_avaabË_p
(
‰y
))

1602 
SEL_EX
:

1603 ià(
‰y
->
·ck‘
 &&ty->
lšk
->
ù¾_¡©us
)

1605 ià(
‰y
->
æags
 & (1 << 
TTY_SLAVE_CLOSED
))

1607 ià(
	`‰y_hung_up_p
(
fe
))

1609 
	`£Ëù_wa™
(&
‰y
->
£cÚd¬y
.
´oc_li¡
, 
wa™
);

1611 
SEL_OUT
:

1612 ià(
	`LEFT
(&
‰y
->
wr™e_q
è> 
WAKEUP_CHARS
)

1614 
	`£Ëù_wa™
(&
‰y
->
wr™e_q
.
´oc_li¡
, 
wa™
);

1618 
	}
}

1632 
	$do_SAK
Ğ
‰y_¡ruù
 *
‰y
)

1634 #ifdeà
TTY_SOFT_SAK


1635 
	`‰y_hªgup
(
‰y
);

1637 
sk_¡ruù
 **
p
;

1638 
lše
 = 
‰y
->line;

1639 
£ssiÚ
 = 
‰y
->session;

1640 
i
;

1641 
fe
 *
fp
;

1643 
	`æush_šput
(
‰y
);

1644 
	`æush_ouut
(
‰y
);

1645 
p
 = &
LAST_TASK
 ;… > &
FIRST_TASK
 ; --p) {

1646 ià(!(*
p
))

1648 ià(((*
p
)->
‰y
 =ğ
lše
) ||

1649 ((
£ssiÚ
 > 0è&& ((*
p
)->session == session)))

1650 
	`£nd_sig
(
SIGKILL
, *
p
, 1);

1652 
i
=0; i < 
NR_OPEN
; i++) {

1653 
fp
 = (*
p
)->fp[
i
];

1654 ià(
fp
 && (fp->
f_İ
 =ğ&
‰y_fİs
) &&

1655 (
	`MINOR
(
fp
->
f_rdev
è=ğ
lše
)) {

1656 
	`£nd_sig
(
SIGKILL
, *
p
, 1);

1663 
	}
}

1680 
‰y_wr™e_d©a
(
‰y_¡ruù
 *
‰y
, *
buå
, 
buæ’
,

1681 (*
ÿÎback
)(* 
d©a
), * 
ÿÎ¬g
)

1683 
h—d
, 

, 
couÁ
;

1684 
æags
;

1685 *
p
;

1687 
	#VLEFT
 ((

-
h—d
-1)&(
TTY_BUF_SIZE
-1))

	)

1689 
	`§ve_æags
(
æags
);

1690 
	`şi
();

1691 ià(
‰y
->
wr™e_d©a_út
) {

1692 
	`»¡Üe_æags
(
æags
);

1693  -
EBUSY
;

1696 
h—d
 = 
‰y
->
wr™e_q
.head;

1697 

 = 
‰y
->
wr™e_q
.tail;

1698 
couÁ
 = 
buæ’
;

1699 
p
 = 
buå
;

1701 
couÁ
 && 
VLEFT
 > 0) {

1702 
‰y
->
wr™e_q
.
buf
[
h—d
++] = *
p
++;

1703 
h—d
 &ğ
TTY_BUF_SIZE
-1;

1704 
couÁ
--;

1706 
‰y
->
wr™e_q
.
h—d
 = head;

1707 ià(
couÁ
) {

1708 
‰y
->
wr™e_d©a_út
 = 
couÁ
;

1709 
‰y
->
wr™e_d©a_±r
 = (*è
p
;

1710 
‰y
->
wr™e_d©a_ÿÎback
 = 
ÿÎback
;

1711 
‰y
->
wr™e_d©a_¬g
 = 
ÿÎ¬g
;

1713 
	`»¡Üe_æags
(
æags
);

1714 
‰y
->
	`wr™e
(tty);

1715  
couÁ
;

1716 
	}
}

1726 
	$‰y_bh_routše
(* 
unu£d
)

1728 
i
, 
j
, 
lše
, 
mask
;

1729 
h—d
, 

, 
couÁ
;

1730 * 
p
;

1731 
‰y_¡ruù
 * 
‰y
;

1733 
i
 = 0, 
lše
 = 0; i < 
MAX_TTYS
 / 32; i++) {

1734 ià(!
‰y_check_wr™e
[
i
]) {

1735 
lše
 += 32;

1738 
j
=0, 
mask
=0; j < 32; j++, 
lše
++, mask <<= 1) {

1739 ià(
	`ş—r_b™
(
j
, &
‰y_check_wr™e
[
i
])) {

1740 
‰y
 = 
‰y_bË
[
lše
];

1741 ià(!
‰y
 || !‰y->
wr™e_d©a_út
)

1743 
	`şi
();

1744 
h—d
 = 
‰y
->
wr™e_q
.head;

1745 

 = 
‰y
->
wr™e_q
.tail;

1746 
couÁ
 = 
‰y
->
wr™e_d©a_út
;

1747 
p
 = 
‰y
->
wr™e_d©a_±r
;

1749 
couÁ
 && 
VLEFT
 > 0) {

1750 
‰y
->
wr™e_q
.
buf
[
h—d
++] = *
p
++;

1751 
h—d
 &ğ
TTY_BUF_SIZE
-1;

1752 
couÁ
--;

1754 
‰y
->
wr™e_q
.
h—d
 = head;

1755 
‰y
->
wr™e_d©a_±r
 = 
p
;

1756 
‰y
->
wr™e_d©a_út
 = 
couÁ
;

1757 
	`¡i
();

1758 ià(!
couÁ
)

1759 (
‰y
->
wr™e_d©a_ÿÎback
)

1760 (
‰y
->
wr™e_d©a_¬g
);

1765 
	}
}

1771 
	$š™Ÿlize_‰y_¡ruù
(
lše
, 
‰y_¡ruù
 *
‰y
)

1773 
	`mem£t
(
‰y
, 0, (
‰y_¡ruù
));

1774 
‰y
->
lše
 =†ine;

1775 
‰y
->
disc
 = 
N_TTY
;

1776 
‰y
->
pg½
 = -1;

1777 ià(
	`IS_A_CONSOLE
(
lše
)) {

1778 
‰y
->
İ’
 = 
cÚ_İ’
;

1779 
‰y
->
wšsize
.
ws_row
 = 
video_num_lšes
;

1780 
‰y
->
wšsize
.
ws_cŞ
 = 
video_num_cŞumns
;

1781 } 
	`IS_A_SERIAL
(
lše
) {

1782 
‰y
->
İ’
 = 
rs_İ’
;

1783 } 
	`IS_A_PTY
(
lše
) {

1784 
‰y
->
İ’
 = 
±y_İ’
;

1786 
	}
}

1788 
	$š™Ÿlize_‹rmios
(
lše
, 
‹rmios
 * 

)

1790 
	`mem£t
(

, 0, (
‹rmios
));

1791 
	`memıy
(

->
c_cc
, 
INIT_C_CC
, 
NCCS
);

1792 ià(
	`IS_A_CONSOLE
(
lše
è|| 
	`IS_A_PTY_SLAVE
(line)) {

1793 

->
c_iæag
 = 
ICRNL
 | 
IXON
;

1794 

->
c_oæag
 = 
OPOST
 | 
ONLCR
;

1795 

->
c_cæag
 = 
B38400
 | 
CS8
 | 
CREAD
;

1796 

->
c_læag
 = 
ISIG
 | 
ICANON
 | 
ECHO
 | 
ECHOE
 | 
ECHOK
 |

1797 
ECHOCTL
 | 
ECHOKE
 | 
IEXTEN
;

1798 } ià(
	`IS_A_SERIAL
(
lše
)) {

1799 

->
c_iæag
 = 
ICRNL
 | 
IXON
;

1800 

->
c_oæag
 = 
OPOST
 | 
ONLCR
 | 
XTABS
;

1801 

->
c_cæag
 = 
B9600
 | 
CS8
 | 
CREAD
 | 
HUPCL
 | 
CLOCAL
;

1802 

->
c_læag
 = 
ISIG
 | 
ICANON
 | 
ECHO
 | 
ECHOE
 | 
ECHOK
 |

1803 
ECHOCTL
 | 
ECHOKE
 | 
IEXTEN
;

1804 } ià(
	`IS_A_PTY_MASTER
(
lše
))

1805 

->
c_cæag
 = 
B9600
 | 
CS8
 | 
CREAD
;

1806 
	}
}

1808 
‰y_ldisc
 
	g‰y_ldisc_N_TTY
 = {

1810 
NULL
,

1811 
NULL
,

1812 
»ad_chª
,

1813 
wr™e_chª
,

1814 
NULL
,

1815 
nÜm®_£Ëù
,

1816 
cİy_to_cooked


1820 
	$‰y_š™
(
kmem_¡¬t
)

1822 
i
;

1824 ià((
‰y_¡ruù
è> 
PAGE_SIZE
)

1825 
	`·nic
("size ofty structure > PAGE_SIZE!");

1826 ià(
	`»gi¡”_chrdev
(
TTY_MAJOR
,"‰y",&
‰y_fİs
))

1827 
	`·nic
("uÇbËØg‘ majÜ %d fÜty deviû", 
TTY_MAJOR
);

1828 ià(
	`»gi¡”_chrdev
(
TTYAUX_MAJOR
,"‰y",&
‰y_fİs
))

1829 
	`·nic
("uÇbËØg‘ majÜ %d fÜty deviû", 
TTYAUX_MAJOR
);

1830 
i
=0 ; i< 
MAX_TTYS
 ; i++) {

1831 
‰y_bË
[
i
] = 0;

1832 
‰y_‹rmios
[
i
] = 0;

1834 
	`mem£t
(
‰y_check_wr™e
, 0, (tty_check_write));

1835 
bh_ba£
[
TTY_BH
].
routše
 = 
‰y_bh_routše
;

1838 
	`mem£t
(
ldiscs
, 0, (ldiscs));

1839 (è
	`‰y_»gi¡”_ldisc
(
N_TTY
, &
‰y_ldisc_N_TTY
);

1841 
kmem_¡¬t
 = 
	`kbd_š™
(kmem_start);

1842 
kmem_¡¬t
 = 
	`cÚ_š™
(kmem_start);

1843 
kmem_¡¬t
 = 
	`rs_š™
(kmem_start);

1844  
kmem_¡¬t
;

1845 
	}
}

	@drivers/char/tty_ioctl.c

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/‹rmios.h
>

13 
	~<lšux/”ºo.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/cÚfig.h
>

16 
	~<lšux/k”Ãl.h
>

17 
	~<lšux/majÜ.h
>

18 
	~<lšux/‰y.h
>

19 
	~<lšux/fú.h
>

20 
	~<lšux/¡ršg.h
>

22 
	~<asm/io.h
>

23 
	~<asm/b™İs.h
>

24 
	~<asm/£gm’t.h
>

25 
	~<asm/sy¡em.h
>

27 #undeà
DEBUG


28 #ifdeà
DEBUG


29 
	#PRINTK
(
x
è
	`´štk
 (x)

	)

31 
	#PRINTK
(
x
è

	)

34 
£ssiÚ_of_pg½
(
pg½
);

35 
do_sü“ndump
(
¬g
);

36 
kl_pg
(
pg½
, 
sig
, 
´iv
);

38 #ifdeà
CONFIG_SELECTION


39 
£t_£ËùiÚ
(cÚ¡ 
¬g
);

40 
·¡e_£ËùiÚ
(
‰y_¡ruù
 *
‰y
);

43 
‰y_£t_ldisc
(
‰y_¡ruù
 *
‰y
, 
ldisc
);

45 
	$æush_šput
(
‰y_¡ruù
 * 
‰y
)

47 
	`şi
();

48 
‰y
->
»ad_q
.
h—d
 =ty->»ad_q.

 = 0;

49 
‰y
->
£cÚd¬y
.
h—d
 =ty->£cÚd¬y.

 = 0;

50 
‰y
->
ÿnÚ_h—d
 =ty->
ÿnÚ_d©a
 =ty->
”asšg
 = 0;

51 
	`mem£t
(&
‰y
->
»adq_æags
, 0, ty->readq_flags);

52 
	`mem£t
(&
‰y
->
£cÚd¬y_æags
, 0, ty->secondary_flags);

53 
	`¡i
();

54 ià(!
‰y
->
lšk
)

57 
‰y
->
lšk
->
wr™e_q
.
h—d
 =ty->lšk->wr™e_q.

 = 0;

58 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
wr™e_q
.
´oc_li¡
);

59 ià(
‰y
->
lšk
->
·ck‘
) {

60 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_FLUSHREAD
;

61 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

63 
	}
}

65 
	$æush_ouut
(
‰y_¡ruù
 * 
‰y
)

67 
	`şi
();

68 
‰y
->
wr™e_q
.
h—d
 =ty->wr™e_q.

 = 0;

69 
	`¡i
();

70 
	`wake_up_š‹¼u±ibË
(&
‰y
->
wr™e_q
.
´oc_li¡
);

71 ià(!
‰y
->
lšk
)

74 
‰y
->
lšk
->
»ad_q
.
h—d
 =ty->lšk->»ad_q.

 = 0;

75 
‰y
->
lšk
->
£cÚd¬y
.
h—d
 =ty->lšk->£cÚd¬y.

 = 0;

76 
‰y
->
lšk
->
ÿnÚ_h—d
 =ty->lšk->
ÿnÚ_d©a
 =ty->lšk->
”asšg
 = 0;

77 
	`mem£t
(&
‰y
->
lšk
->
»adq_æags
, 0, ty->readq_flags);

78 
	`mem£t
(&
‰y
->
lšk
->
£cÚd¬y_æags
, 0, ty->secondary_flags);

79 ià(
‰y
->
lšk
->
·ck‘
) {

80 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_FLUSHWRITE
;

81 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

83 
	}
}

85 
	$wa™_uÁ_£Á
(
‰y_¡ruù
 * 
‰y
, 
timeout
)

87 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

89 
	`TTY_WRITE_FLUSH
(
‰y
);

90 ià(
	`EMPTY
(&
‰y
->
wr™e_q
))

92 
	`add_wa™_queue
(&
‰y
->
wr™e_q
.
´oc_li¡
, &
wa™
);

93 
cu¼’t
->
couÁ”
 = 0;

94 ià(
timeout
)

95 
cu¼’t
->
timeout
 =imeouˆ+ 
jiff›s
;

97 
cu¼’t
->
timeout
 = () -1;

99 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

100 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

102 
	`TTY_WRITE_FLUSH
(
‰y
);

103 ià(
	`EMPTY
(&
‰y
->
wr™e_q
))

105 
	`scheduË
();

106 } 
cu¼’t
->
timeout
);

107 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

108 
	`»move_wa™_queue
(&
‰y
->
wr™e_q
.
´oc_li¡
, &
wa™
);

109 
	}
}

111 
	$do_g‘_ps_šfo
(
¬g
)

113 
	st¡ruù
 {

114 
æag
;

115 
´e£Á
[
NR_TASKS
];

116 
sk_¡ruù
 
sks
[
NR_TASKS
];

118 
t¡ruù
 *
ts
 = (t¡ruù *)
¬g
;

119 
sk_¡ruù
 **
p
;

120 *
c
, *
d
;

121 
i
, 
n
 = 0;

123 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, (
t¡ruù
));

124 ià(
i
)

125  
i
;

126 
p
 = &
FIRST_TASK
 ;… <ğ&
LAST_TASK
 ;…++, 
n
++)

127 ià(*
p
)

129 
c
 = (*)(*
p
);

130 
d
 = (*)(
ts
->
sks
+
n
);

131 
i
=0 ; i<(
sk_¡ruù
) ; i++)

132 
	`put_fs_by‹
(*
c
++, 
d
++);

133 
	`put_fs_lÚg
(1, (*)(
ts
->
´e£Á
+
n
));

136 
	`put_fs_lÚg
(0, (*)(
ts
->
´e£Á
+
n
));

138 
	}
}

140 
	$un£t_locked_‹rmios
(
‹rmios
 *termios,

141 
‹rmios
 *
Şd
,

142 
‹rmios
 *
locked
)

144 
i
;

146 
	#NOSET_MASK
(
x
,
y
,
z
è(x = ((xè& ~(z)è| ((yè& (z)))

	)

148 ià(!
locked
) {

149 
	`´štk
("Warning?!?ermios_locked is NULL.\n");

153 
	`NOSET_MASK
(
‹rmios
->
c_iæag
, 
Şd
->c_iæag, 
locked
->c_iflag);

154 
	`NOSET_MASK
(
‹rmios
->
c_oæag
, 
Şd
->c_oæag, 
locked
->c_oflag);

155 
	`NOSET_MASK
(
‹rmios
->
c_cæag
, 
Şd
->c_cæag, 
locked
->c_cflag);

156 
	`NOSET_MASK
(
‹rmios
->
c_læag
, 
Şd
->c_læag, 
locked
->c_lflag);

157 
‹rmios
->
c_lše
 = 
locked
->c_lš? 
Şd
->c_line :ermios->c_line;

158 
i
=0; i < 
NCCS
; i++)

159 
‹rmios
->
c_cc
[
i
] = 
locked
->c_cc[i] ?

160 
Şd
->
c_cc
[
i
] : 
‹rmios
->c_cc[i];

161 
	}
}

163 
	$check_chªge
(
‰y_¡ruù
 * 
‰y
, 
chªÃl
)

168 ià(
cu¼’t
->
‰y
 !ğ
chªÃl
)

170 ià(
‰y
->
pg½
 <= 0) {

171 
	`´štk
("check_change:ty->pgrp <= 0!\n");

174 ià(
cu¼’t
->
pg½
 =ğ
‰y
->pgrp)

176 ià(
	`is_ignÜed
(
SIGTTOU
))

178 ià(
	`is_Üphªed_pg½
(
cu¼’t
->
pg½
))

179  -
EIO
;

180 (è
	`kl_pg
(
cu¼’t
->
pg½
,
SIGTTOU
,1);

181  -
ERESTARTSYS
;

182 
	}
}

184 
	$£t_‹rmios_2
(
‰y_¡ruù
 * 
‰y
, 
‹rmios
 *ermios)

186 
‹rmios
 
Şd_‹rmios
 = *
‰y
->termios;

187 
ÿnÚ_chªge
;

189 
ÿnÚ_chªge
 = (
Şd_‹rmios
.
c_læag
 ^ 
‹rmios
->c_læagè& 
ICANON
;

190 
	`şi
();

191 *
‰y
->
‹rmios
 = *termios;

192 ià(
ÿnÚ_chªge
) {

193 
	`mem£t
(&
‰y
->
£cÚd¬y_æags
, 0, ty->secondary_flags);

194 
‰y
->
ÿnÚ_h—d
 =ty->
£cÚd¬y
.

;

195 
‰y
->
ÿnÚ_d©a
 = 0;

196 
‰y
->
”asšg
 = 0;

198 
	`¡i
();

199 ià(
ÿnÚ_chªge
 && !
	`L_ICANON
(
‰y
è&& !
	`EMPTY
(&‰y->
£cÚd¬y
))

201 
	`wake_up_š‹¼u±ibË
(&
‰y
->
£cÚd¬y
.
´oc_li¡
);

205 ià(
‰y
->
lšk
 &&ty->lšk->
·ck‘
) {

206 
Şd_æow
 = ((
Şd_‹rmios
.
c_iæag
 & 
IXON
) &&

207 (
Şd_‹rmios
.
c_cc
[
VSTOP
] == '\023') &&

208 (
Şd_‹rmios
.
c_cc
[
VSTART
] == '\021'));

209 
Ãw_æow
 = (
	`I_IXON
(
‰y
) &&

210 
	`STOP_CHAR
(
‰y
) == '\023' &&

211 
	`START_CHAR
(
‰y
) == '\021');

212 ià(
Şd_æow
 !ğ
Ãw_æow
) {

213 
‰y
->
ù¾_¡©us
 &ğ~(
TIOCPKT_DOSTOP
 | 
TIOCPKT_NOSTOP
);

214 ià(
Ãw_æow
)

215 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_DOSTOP
;

217 
‰y
->
ù¾_¡©us
 |ğ
TIOCPKT_NOSTOP
;

218 
	`wake_up_š‹¼u±ibË
(&
‰y
->
lšk
->
£cÚd¬y
.
´oc_li¡
);

222 
	`un£t_locked_‹rmios
(
‰y
->
‹rmios
, &
Şd_‹rmios
,

223 
‹rmios_locked
[
‰y
->
lše
]);

225 ià(
‰y
->
£t_‹rmios
)

226 (*
‰y
->
£t_‹rmios
)Ñty, &
Şd_‹rmios
);

229 
	}
}

231 
	$£t_‹rmios
(
‰y_¡ruù
 * 
‰y
, 
‹rmios
 *ermios,

232 
chªÃl
)

234 
‹rmios
 
tmp_‹rmios
;

236 
	`memıy_äomfs
(&
tmp_‹rmios
, 
‹rmios
,  (termios));

237  
	`£t_‹rmios_2
(
‰y
, &
tmp_‹rmios
);

238 
	}
}

240 
	$g‘_‹rmio
(
‰y_¡ruù
 * 
‰y
, 
‹rmio
 *ermio)

242 
i
;

243 
‹rmio
 
tmp_‹rmio
;

245 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
‹rmio
,  (termio));

246 ià(
i
)

247  
i
;

248 
tmp_‹rmio
.
c_iæag
 = 
‰y
->
‹rmios
->c_iflag;

249 
tmp_‹rmio
.
c_oæag
 = 
‰y
->
‹rmios
->c_oflag;

250 
tmp_‹rmio
.
c_cæag
 = 
‰y
->
‹rmios
->c_cflag;

251 
tmp_‹rmio
.
c_læag
 = 
‰y
->
‹rmios
->c_lflag;

252 
tmp_‹rmio
.
c_lše
 = 
‰y
->
‹rmios
->c_line;

253 
i
=0 ; i < 
NCC
 ; i++)

254 
tmp_‹rmio
.
c_cc
[
i
] = 
‰y
->
‹rmios
->c_cc[i];

255 
	`memıy_tofs
(
‹rmio
, &
tmp_‹rmio
,  (termio));

257 
	}
}

259 
	$£t_‹rmio
(
‰y_¡ruù
 * 
‰y
, 
‹rmio
 *ermio,

260 
chªÃl
)

262 
‹rmio
 
tmp_‹rmio
;

263 
‹rmios
 
tmp_‹rmios
;

265 
tmp_‹rmios
 = *
‰y
->
‹rmios
;

266 
	`memıy_äomfs
(&
tmp_‹rmio
, 
‹rmio
,  (termio));

268 
	#SET_LOW_BITS
(
x
,
y
è((xèğ(0xffff0000 & (x)è| (y))

	)

270 
	`SET_LOW_BITS
(
tmp_‹rmios
.
c_iæag
, 
tmp_‹rmio
.c_iflag);

271 
	`SET_LOW_BITS
(
tmp_‹rmios
.
c_oæag
, 
tmp_‹rmio
.c_oflag);

272 
	`SET_LOW_BITS
(
tmp_‹rmios
.
c_cæag
, 
tmp_‹rmio
.c_cflag);

273 
	`SET_LOW_BITS
(
tmp_‹rmios
.
c_læag
, 
tmp_‹rmio
.c_lflag);

274 
	`memıy
(&
tmp_‹rmios
.
c_cc
, &
tmp_‹rmio
.c_cc, 
NCC
);

276 #undeà
SET_LOW_BITS


278  
	`£t_‹rmios_2
(
‰y
, &
tmp_‹rmios
);

279 
	}
}

281 
	$£t_wšdow_size
(
‰y_¡ruù
 * 
‰y
, 
wšsize
 * 
ws
)

283 
wšsize
 
tmp_ws
;

285 
	`memıy_äomfs
(&
tmp_ws
, 
ws
,  (
wšsize
));

286 ià(
	`memcmp
(&
tmp_ws
, &
‰y
->
wšsize
,  (winsize)) &&

287 
‰y
->
pg½
 > 0)

288 
	`kl_pg
(
‰y
->
pg½
, 
SIGWINCH
, 1);

289 
‰y
->
wšsize
 = 
tmp_ws
;

291 
	}
}

294 
	$‰y_£t_ldisc
(
‰y_¡ruù
 *
‰y
, 
ldisc
)

296 ià((
ldisc
 < 
N_TTY
è|| (ldisø>ğ
NR_LDISCS
) ||

297 !(
ldiscs
[
ldisc
].
æags
 & 
LDISC_FLAG_DEFINED
))

298  -
EINVAL
;

300 ià(
‰y
->
disc
 =ğ
ldisc
)

304 
	`wa™_uÁ_£Á
(
‰y
, 0);

305 
	`æush_šput
(
‰y
);

306 ià(
ldiscs
[
‰y
->
disc
].
şo£
)

307 
ldiscs
[
‰y
->
disc
].
	`şo£
(tty);

310 
‰y
->
disc
 = 
ldisc
;

311 
‰y
->
‹rmios
->
c_lše
 = 
ldisc
;

312 ià(
ldiscs
[
‰y
->
disc
].
İ’
)

313 (
ldiscs
[
‰y
->
disc
].
	`İ’
(tty));

316 
	}
}

318 
	$šq_ÿnÚ
(
‰y_¡ruù
 * 
‰y
)

320 
Ä
, 
h—d
, 

;

322 ià(!
‰y
->
ÿnÚ_d©a
)

324 
h—d
 = 
‰y
->
ÿnÚ_h—d
;

325 

 = 
‰y
->
£cÚd¬y
.tail;

326 
Ä
 = (
h—d
 - 

è& (
TTY_BUF_SIZE
-1);

328 
h—d
 !ğ

) {

329 ià(
	`‹¡_b™
(

, &
‰y
->
£cÚd¬y_æags
) &&

330 
‰y
->
£cÚd¬y
.
buf
[

] =ğ
__DISABLED_CHAR
)

331 
Ä
--;

332 
	`INC
(

);

334  
Ä
;

335 
	}
}

337 
	$‰y_ioùl
(
šode
 * inode, 
fe
 * file,

338 
cmd
, 
¬g
)

340 
‰y_¡ruù
 * 
‰y
;

341 
‰y_¡ruù
 * 
Ùh”_‰y
;

342 
‰y_¡ruù
 * 
‹rmios_‰y
;

343 
pid_t
 
pg½
;

344 
dev
;

345 
‹rmios_dev
;

346 
»tv®
;

348 ià(
	`MAJOR
(
fe
->
f_rdev
è!ğ
TTY_MAJOR
) {

349 
	`´štk
("tty_ioctl:ty…seudo-major != TTY_MAJOR\n");

350  -
EINVAL
;

352 
dev
 = 
	`MINOR
(
fe
->
f_rdev
);

353 
‰y
 = 
	`TTY_TABLE
(
dev
);

354 ià(!
‰y
)

355  -
EINVAL
;

356 ià(
	`IS_A_PTY
(
dev
))

357 
Ùh”_‰y
 = 
‰y_bË
[
	`PTY_OTHER
(
dev
)];

359 
Ùh”_‰y
 = 
NULL
;

360 ià(
	`IS_A_PTY_MASTER
(
dev
)) {

361 
‹rmios_‰y
 = 
Ùh”_‰y
;

362 
‹rmios_dev
 = 
	`PTY_OTHER
(
dev
);

364 
‹rmios_‰y
 = 
‰y
;

365 
‹rmios_dev
 = 
dev
;

367 
cmd
) {

368 
TCGETS
:

369 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

370  (
‹rmios
));

371 ià(
»tv®
)

372  
»tv®
;

373 
	`memıy_tofs
((
‹rmios
 *è
¬g
,

374 
‹rmios_‰y
->
‹rmios
,

375  (
‹rmios
));

377 
TCSETSF
:

378 
TCSETSW
:

379 
TCSETS
:

380 
»tv®
 = 
	`check_chªge
(
‹rmios_‰y
, 
‹rmios_dev
);

381 ià(
»tv®
)

382  
»tv®
;

383 ià(
cmd
 =ğ
TCSETSF
 || cmd =ğ
TCSETSW
) {

384 ià(
cmd
 =ğ
TCSETSF
)

385 
	`æush_šput
(
‹rmios_‰y
);

386 
	`wa™_uÁ_£Á
(
‹rmios_‰y
, 0);

388  
	`£t_‹rmios
(
‹rmios_‰y
, (
‹rmios
 *è
¬g
,

389 
‹rmios_dev
);

390 
TCGETA
:

391  
	`g‘_‹rmio
(
‹rmios_‰y
,(
‹rmio
 *è
¬g
);

392 
TCSETAF
:

393 
TCSETAW
:

394 
TCSETA
:

395 
»tv®
 = 
	`check_chªge
(
‹rmios_‰y
, 
‹rmios_dev
);

396 ià(
»tv®
)

397  
»tv®
;

398 ià(
cmd
 =ğ
TCSETAF
 || cmd =ğ
TCSETAW
) {

399 ià(
cmd
 =ğ
TCSETAF
)

400 
	`æush_šput
(
‹rmios_‰y
);

401 
	`wa™_uÁ_£Á
(
‹rmios_‰y
, 0);

403  
	`£t_‹rmio
(
‹rmios_‰y
, (
‹rmio
 *è
¬g
,

404 
‹rmios_dev
);

405 
TCXONC
:

406 
»tv®
 = 
	`check_chªge
(
‰y
, 
dev
);

407 ià(
»tv®
)

408  
»tv®
;

409 
¬g
) {

410 
TCOOFF
:

411 
	`¡İ_‰y
(
‰y
);

413 
TCOON
:

414 
	`¡¬t_‰y
(
‰y
);

416 
TCIOFF
:

417 ià(
	`STOP_CHAR
(
‰y
è!ğ
__DISABLED_CHAR
)

418 
	`put_‰y_queue
(
	`STOP_CHAR
(
‰y
),

419 &
‰y
->
wr™e_q
);

421 
TCION
:

422 ià(
	`START_CHAR
(
‰y
è!ğ
__DISABLED_CHAR
)

423 
	`put_‰y_queue
(
	`START_CHAR
(
‰y
),

424 &
‰y
->
wr™e_q
);

427  -
EINVAL
;

430 
TCFLSH
:

431 
»tv®
 = 
	`check_chªge
(
‰y
, 
dev
);

432 ià(
»tv®
)

433  
»tv®
;

434 
¬g
) {

435 
TCIFLUSH
:

436 
	`æush_šput
(
‰y
);

438 
TCIOFLUSH
:

439 
	`æush_šput
(
‰y
);

441 
TCOFLUSH
:

442 
	`æush_ouut
(
‰y
);

445  -
EINVAL
;

448 
TIOCEXCL
:

449 
	`£t_b™
(
TTY_EXCLUSIVE
, &
‰y
->
æags
);

451 
TIOCNXCL
:

452 
	`ş—r_b™
(
TTY_EXCLUSIVE
, &
‰y
->
æags
);

454 
TIOCSCTTY
:

455 ià(
cu¼’t
->
Ëad”
 &&

456 (
cu¼’t
->
£ssiÚ
 =ğ
‰y
->session))

462 ià(!
cu¼’t
->
Ëad”
 || (cu¼’t->
‰y
 >= 0))

463  -
EPERM
;

464 ià(
‰y
->
£ssiÚ
 > 0) {

469 ià((
¬g
 =ğ1è&& 
	`su£r
()) {

473 
sk_¡ruù
 *
p
;

475 
	`fÜ_—ch_sk
(
p
)

476 ià(
p
->
‰y
 =ğ
dev
)

477 
p
->
‰y
 = -1;

479  -
EPERM
;

481 
cu¼’t
->
‰y
 = 
dev
;

482 
‰y
->
£ssiÚ
 = 
cu¼’t
->session;

483 
‰y
->
pg½
 = 
cu¼’t
->pgrp;

485 
TIOCGPGRP
:

486 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

487  (
pid_t
));

488 ià(
»tv®
)

489  
»tv®
;

490 ià(
cu¼’t
->
‰y
 !ğ
‹rmios_dev
)

491  -
ENOTTY
;

492 
	`put_fs_lÚg
(
‹rmios_‰y
->
pg½
, (
pid_t
 *è
¬g
);

494 
TIOCSPGRP
:

495 
»tv®
 = 
	`check_chªge
(
‹rmios_‰y
, 
‹rmios_dev
);

496 ià(
»tv®
)

497  
»tv®
;

498 ià((
cu¼’t
->
‰y
 < 0) ||

499 (
cu¼’t
->
‰y
 !ğ
‹rmios_dev
) ||

500 (
‹rmios_‰y
->
£ssiÚ
 !ğ
cu¼’t
->session))

501  -
ENOTTY
;

502 
pg½
 = 
	`g‘_fs_lÚg
((
pid_t
 *è
¬g
);

503 ià(
pg½
 < 0)

504  -
EINVAL
;

505 ià(
	`£ssiÚ_of_pg½
(
pg½
è!ğ
cu¼’t
->
£ssiÚ
)

506  -
EPERM
;

507 
‹rmios_‰y
->
pg½
 =…grp;

509 
TIOCOUTQ
:

510 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

512 ià(
»tv®
)

513  
»tv®
;

514 
	`put_fs_lÚg
(
	`CHARS
(&
‰y
->
wr™e_q
),

515 (*è
¬g
);

517 
TIOCINQ
:

518 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

520 ià(
»tv®
)

521  
»tv®
;

522 ià(
	`L_ICANON
(
‰y
))

523 
	`put_fs_lÚg
(
	`šq_ÿnÚ
(
‰y
),

524 (*è
¬g
);

526 
	`put_fs_lÚg
(
	`CHARS
(&
‰y
->
£cÚd¬y
),

527 (*è
¬g
);

529 
TIOCSTI
:

530 ià((
cu¼’t
->
‰y
 !ğ
dev
è&& !
	`su£r
())

531  -
EPERM
;

532 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
, 1);

533 ià(
»tv®
)

534  
»tv®
;

535 
	`put_‰y_queue
(
	`g‘_fs_by‹
((*è
¬g
), &
‰y
->
»ad_q
);

536 
	`TTY_READ_FLUSH
(
‰y
);

538 
TIOCGWINSZ
:

539 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

540  (
wšsize
));

541 ià(
»tv®
)

542  
»tv®
;

543 
	`memıy_tofs
((
wšsize
 *è
¬g
, &
‰y
->winsize,

544  (
wšsize
));

546 
TIOCSWINSZ
:

547 ià(
	`IS_A_PTY_MASTER
(
dev
))

548 
	`£t_wšdow_size
(
Ùh”_‰y
,(
wšsize
 *è
¬g
);

549  
	`£t_wšdow_size
(
‰y
,(
wšsize
 *è
¬g
);

550 
TIOCLINUX
:

551 
	`g‘_fs_by‹
((*)
¬g
))

554  
	`do_sü“ndump
(
¬g
);

556  
	`do_g‘_ps_šfo
(
¬g
);

557 #ifdeà
CONFIG_SELECTION


559  
	`£t_£ËùiÚ
(
¬g
);

561  
	`·¡e_£ËùiÚ
(
‰y
);

563 
	`unbÏnk_sü“n
();

567  -
EINVAL
;

569 
TIOCCONS
:

570 ià(
	`IS_A_CONSOLE
(
dev
)) {

571 ià(!
	`su£r
())

572  -
EPERM
;

573 
»dœeù
 = 
NULL
;

576 ià(
»dœeù
)

577  -
EBUSY
;

578 ià(!
	`su£r
())

579  -
EPERM
;

580 ià(
	`IS_A_PTY_MASTER
(
dev
))

581 
»dœeù
 = 
Ùh”_‰y
;

582 ià(
	`IS_A_PTY_SLAVE
(
dev
))

583 
»dœeù
 = 
‰y
;

585  -
ENOTTY
;

587 
FIONBIO
:

588 
¬g
 = 
	`g‘_fs_lÚg
((*)‡rg);

589 ià(
¬g
)

590 
fe
->
f_æags
 |ğ
O_NONBLOCK
;

592 
fe
->
f_æags
 &ğ~
O_NONBLOCK
;

594 
TIOCNOTTY
:

595 ià(
cu¼’t
->
‰y
 !ğ
dev
)

596  -
ENOTTY
;

597 ià(
cu¼’t
->
Ëad”
)

598 
	`di§ssocŸ‹_ùty
(0);

599 
cu¼’t
->
‰y
 = -1;

601 
TIOCGETD
:

602 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

604 ià(
»tv®
)

605  
»tv®
;

606 
	`put_fs_lÚg
(
‰y
->
disc
, (*è
¬g
);

608 
TIOCSETD
:

609 
»tv®
 = 
	`check_chªge
(
‰y
, 
dev
);

610 ià(
»tv®
)

611  
»tv®
;

612 
¬g
 = 
	`g‘_fs_lÚg
((*)‡rg);

613  
	`‰y_£t_ldisc
(
‰y
, 
¬g
);

614 
TIOCGLCKTRMIOS
:

615 
¬g
 = 
	`g‘_fs_lÚg
((*)‡rg);

616 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,

617  (
‹rmios
));

618 ià(
»tv®
)

619  
»tv®
;

620 
	`memıy_tofs
((
‹rmios
 *è
¬g
,

621 &
‹rmios_locked
[
‹rmios_dev
],

622  (
‹rmios
));

624 
TIOCSLCKTRMIOS
:

625 ià(!
	`su£r
())

626  -
EPERM
;

627 
¬g
 = 
	`g‘_fs_lÚg
((*)‡rg);

628 
	`memıy_äomfs
(&
‹rmios_locked
[
‹rmios_dev
],

629 (
‹rmios
 *è
¬g
,

630  (
‹rmios
));

632 
TIOCPKT
:

633 ià(!
	`IS_A_PTY_MASTER
(
dev
))

634  -
ENOTTY
;

635 
»tv®
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
¬g
,

637 ià(
»tv®
)

638  
»tv®
;

639 ià(
	`g‘_fs_lÚg
(
¬g
)) {

640 ià(!
‰y
->
·ck‘
) {

641 
‰y
->
·ck‘
 = 1;

642 
‰y
->
lšk
->
ù¾_¡©us
 = 0;

645 
‰y
->
·ck‘
 = 0;

647 
TCSBRK
: 
TCSBRKP
:

648 
»tv®
 = 
	`check_chªge
(
‰y
, 
dev
);

649 ià(
»tv®
)

650  
»tv®
;

651 
	`wa™_uÁ_£Á
(
‰y
, 0);

652 ià(!
‰y
->
ioùl
)

654 
‰y
->
	`ioùl
Ñty, 
fe
, 
cmd
, 
¬g
);

657 ià(
‰y
->
ioùl
) {

658 
»tv®
 = (
‰y
->
ioùl
)Ñty, 
fe
, 
cmd
, 
¬g
);

659 ià(
»tv®
 !ğ-
EINVAL
)

660  
»tv®
;

662 ià(
ldiscs
[
‰y
->
disc
].
ioùl
) {

663 
»tv®
 = (
ldiscs
[
‰y
->
disc
].
ioùl
)

664 (
‰y
, 
fe
, 
cmd
, 
¬g
);

665  
»tv®
;

667  -
EINVAL
;

669 
	}
}

	@drivers/char/vt.c

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/‰y.h
>

12 
	~<lšux/tim”.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/kd.h
>

15 
	~<lšux/vt.h
>

16 
	~<lšux/¡ršg.h
>

18 
	~<asm/io.h
>

19 
	~<asm/£gm’t.h
>

21 
	~"kbd_k”n.h
"

22 
	~"vt_k”n.h
"

23 
	~"dŸü.h
"

38 
vt_¡ruù
 
	gvt_cÚs
[
NR_CONSOLES
];

40 
asmlškage
 
sys_iİ”m
(
äom
, 
num
, 
Ú
);

42 
compu‹_shiá¡©e
();

43 
chªge_cÚsŞe
(
Ãw_cÚsŞe
);

44 
com¶‘e_chªge_cÚsŞe
(
Ãw_cÚsŞe
);

45 
vt_wa™aùive
();

50 
cÚ_£t_Œªs
(* 
bË
);

51 
cÚ_g‘_Œªs
(* 
bË
);

52 
cÚ_£t_fÚt
(* 
fÚtm­
);

53 
cÚ_g‘_fÚt
(* 
fÚtm­
);

59 
	#GPFIRST
 0x3b4

	)

60 
	#GPLAST
 0x3df

	)

61 
	#GPNUM
 (
GPLAST
 - 
GPFIRST
 + 1)

	)

79 
	$kd_nosound
(
ignÜed
)

82 
	`outb
(
	`šb_p
(0x61)&0xFC, 0x61);

84 
	}
}

87 
	$kd_mksound
(
couÁ
, 
ticks
)

89 
tim”_li¡
 
sound_tim”
 = { 
NULL
, NULL, 0, 0, 
kd_nosound
 };

91 
	`şi
();

92 
	`d–_tim”
(&
sound_tim”
);

93 ià(
couÁ
) {

95 
	`outb_p
(
	`šb_p
(0x61)|3, 0x61);

97 
	`outb_p
(0xB6, 0x43);

99 
	`outb_p
(
couÁ
 & 0xff, 0x42);

100 
	`outb
((
couÁ
 >> 8) & 0xff, 0x42);

102 ià(
ticks
) {

103 
sound_tim”
.
expœes
 = 
ticks
;

104 
	`add_tim”
(&
sound_tim”
);

107 
	`kd_nosound
(0);

108 
	`¡i
();

110 
	}
}

116 
	$vt_ioùl
(
‰y_¡ruù
 *
‰y
, 
fe
 * file,

117 
cmd
, 
¬g
)

119 
cÚsŞe
, 
i
;

120 
ucv®
;

121 
kbd_¡ruù
 * 
kbd
;

123 
cÚsŞe
 = 
‰y
->
lše
 - 1;

125 ià(
cÚsŞe
 < 0 || cÚsŞ>ğ
NR_CONSOLES
)

126  -
EINVAL
;

128 
kbd
 = 
kbd_bË
 + 
cÚsŞe
;

129 
cmd
) {

130 
KIOCSOUND
:

131 
	`kd_mksound
(()
¬g
, 0);

134 
KDMKTONE
:

136 
ticks
 = 
HZ
 * ((
¬g
 >> 16) & 0xffff) / 1000;

142 
	`kd_mksound
(
¬g
 & 0xffff, 
ticks
);

143 ià(
ticks
 == 0)

144 
	`kd_nosound
(0);

148 
KDGKBTYPE
:

152 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

153 ià(!
i
)

154 
	`put_fs_by‹
(
KB_101
, (*è
¬g
);

155  
i
;

157 
KDADDIO
:

158 
KDDELIO
:

163 ià(
¬g
 < 
GPFIRST
 ||‡rg > 
GPLAST
)

164  -
EINVAL
;

165  
	`sys_iİ”m
(
¬g
, 1, (
cmd
 =ğ
KDADDIO
)è? -
ENXIO
 : 0;

167 
KDENABIO
:

168 
KDDISABIO
:

169  
	`sys_iİ”m
(
GPFIRST
, 
GPNUM
,

170 (
cmd
 =ğ
KDENABIO
)è? -
ENXIO
 : 0;

172 
KDSETMODE
:

178 
¬g
) {

179 
KD_GRAPHICS
:

181 
KD_TEXT0
:

182 
KD_TEXT1
:

183 
¬g
 = 
KD_TEXT
;

184 
KD_TEXT
:

187  -
EINVAL
;

189 ià(
vt_cÚs
[
cÚsŞe
].
vc_mode
 =ğ(è
¬g
)

191 
vt_cÚs
[
cÚsŞe
].
vc_mode
 = (è
¬g
;

192 ià(
cÚsŞe
 !ğ
fg_cÚsŞe
)

197 ià(
¬g
 =ğ
KD_TEXT
)

198 
	`unbÏnk_sü“n
();

200 
tim”_aùive
 &ğ~(1<<
BLANK_TIMER
);

201 
	`bÏnk_sü“n
();

205 
KDGETMODE
:

206 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

207 ià(!
i
)

208 
	`put_fs_lÚg
(
vt_cÚs
[
cÚsŞe
].
vc_mode
, (*è
¬g
);

209  
i
;

211 
KDMAPDISP
:

212 
KDUNMAPDISP
:

217  -
EINVAL
;

219 
KDSKBMODE
:

220 
¬g
) {

221 
K_RAW
:

222 
	`£t_vc_kbd_mode
(
kbd
, 
VC_RAW
);

223 
	`şr_vc_kbd_mode
(
kbd
, 
VC_MEDIUMRAW
);

225 
K_MEDIUMRAW
:

226 
	`şr_vc_kbd_mode
(
kbd
, 
VC_RAW
);

227 
	`£t_vc_kbd_mode
(
kbd
, 
VC_MEDIUMRAW
);

229 
K_XLATE
:

230 
	`şr_vc_kbd_mode
(
kbd
, 
VC_RAW
);

231 
	`şr_vc_kbd_mode
(
kbd
, 
VC_MEDIUMRAW
);

232 
	`compu‹_shiá¡©e
();

235  -
EINVAL
;

237 
	`æush_šput
(
‰y
);

240 
KDGKBMODE
:

241 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

242 ià(!
i
) {

243 
ucv®
 = (
	`vc_kbd_mode
(
kbd
, 
VC_RAW
è? 
K_RAW
 :

244 
	`vc_kbd_mode
(
kbd
, 
VC_MEDIUMRAW
è? 
K_MEDIUMRAW
 :

245 
K_XLATE
);

246 
	`put_fs_lÚg
(
ucv®
, (*è
¬g
);

248  
i
;

252 
KDSKBMETA
:

253 
¬g
) {

254 
K_METABIT
:

255 
	`şr_vc_kbd_mode
(
kbd
, 
VC_META
);

257 
K_ESCPREFIX
:

258 
	`£t_vc_kbd_mode
(
kbd
, 
VC_META
);

261  -
EINVAL
;

265 
KDGKBMETA
:

266 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

267 ià(!
i
) {

268 
ucv®
 = (
	`vc_kbd_mode
(
kbd
, 
VC_META
è? 
K_ESCPREFIX
 :

269 
K_METABIT
);

270 
	`put_fs_lÚg
(
ucv®
, (*è
¬g
);

272  
i
;

274 
KDGKBENT
:

276 
kb’Œy
 * cÚ¡ 
a
 = (kb’Œy *)
¬g
;

277 
u_ch¬
 
s
;

279 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
a
, (
kb’Œy
));

280 ià(
i
)

281  
i
;

282 ià((
i
 = 
	`g‘_fs_by‹
((*è&
a
->
kb_šdex
)è>ğ
NR_KEYS
)

283  -
EINVAL
;

284 ià((
s
 = 
	`g‘_fs_by‹
((*è&
a
->
kb_bË
)è>ğ
NR_KEYMAPS
)

285  -
EINVAL
;

286 
	`put_fs_wÜd
(
key_m­
[
s
][
i
], (*è&
a
->
kb_v®ue
);

290 
KDSKBENT
:

292 cÚ¡ 
kb’Œy
 * 
a
 = (kb’Œy *)
¬g
;

293 
u_ch¬
 
s
;

294 
u_shÜt
 
v
;

296 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*)
a
, (
kb’Œy
));

297 ià(
i
)

298  
i
;

299 ià((
i
 = 
	`g‘_fs_by‹
((*è&
a
->
kb_šdex
)è>ğ
NR_KEYS
)

300  -
EINVAL
;

301 ià((
s
 = 
	`g‘_fs_by‹
((*è&
a
->
kb_bË
)è>ğ
NR_KEYMAPS
)

302  -
EINVAL
;

303 ià(
	`KTYP
(
v
 = 
	`g‘_fs_wÜd
(&
a
->
kb_v®ue
)è>ğ
NR_TYPES
)

304  -
EINVAL
;

305 ià(
	`KVAL
(
v
è> 
max_v®s
[
	`KTYP
(v)])

306  -
EINVAL
;

307 
key_m­
[
s
][
i
] = 
v
;

311 
KDGKBSENT
:

313 
kb£Áry
 *
a
 = (kb£Áry *)
¬g
;

314 *
p
;

315 
u_ch¬
 *
q
;

317 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
a
, (
kb£Áry
));

318 ià(
i
)

319  
i
;

320 ià((
i
 = 
	`g‘_fs_by‹
(&
a
->
kb_func
)è>ğ
NR_FUNC
 || i < 0)

321  -
EINVAL
;

322 
q
 = 
a
->
kb_¡ršg
;

323 
p
 = 
func_bË
[
i
];

324 if(!
p
) {

326 
	`´štk
("KDGKBSENTƒrror: func_table[%d] is‚il.\n",

327 
i
);

328  -
EINVAL
;

330  ; *
p
;…++)

331 
	`put_fs_by‹
(*
p
, 
q
++);

332 
	`put_fs_by‹
(0, 
q
);

336 
KDSKBSENT
:

338 
kb£Áry
 * cÚ¡ 
a
 = (kb£Áry *)
¬g
;

339 
d–
;

340 *
fœ¡_ä“
;

341 
k
;

342 
u_ch¬
 *
p
;

343 *
q
;

345 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*)
a
, (
kb£Áry
));

346 ià(
i
)

347  
i
;

348 ià((
i
 = 
	`g‘_fs_by‹
(&
a
->
kb_func
)è>ğ
NR_FUNC
)

349  -
EINVAL
;

350 
q
 = 
func_bË
[
i
];

351 ià(!
q
) {

353 
	`´štk
("KDSKBSENTƒrror: func_table[%d] is‚il.\n",

354 
i
);

355  -
EINVAL
;

357 
d–
 = -
	`¡¾’
(
q
);

358 
p
 = 
a
->
kb_¡ršg
; 
	`g‘_fs_by‹
(p);…++)

359 
d–
++;

360 
fœ¡_ä“
 = 
func_bË
[
NR_FUNC
 - 1] +

361 
	`¡¾’
(
func_bË
[
NR_FUNC
 - 1]) + 1;

363 
d–
 > 0 &&

364 
fœ¡_ä“
 + 
d–
 > 
func_buf
 + 
FUNC_BUFSIZE


366  -
EINVAL
;

367 ià(
i
 < 
NR_FUNC
 - 1) {

368 
	`memmove
(

369 
func_bË
[
i
 + 1] + 
d–
,

370 
func_bË
[
i
 + 1],

371 
fœ¡_ä“
 - 
func_bË
[
i
 + 1]);

372 
k
 = 
i
 + 1; k < 
NR_FUNC
; k++)

373 ià(
func_bË
[
k
])

374 
func_bË
[
k
] +ğ
d–
;

376 
p
 = 
a
->
kb_¡ršg
, 
q
 = 
func_bË
[
i
]; ;…++, q++)

377 ià(!(*
q
 = 
	`g‘_fs_by‹
(
p
)))

382 
KDGKBDIACR
:

384 
kbdŸüs
 *
a
 = (kbdŸü *)
¬g
;

386 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
a
, (
kbdŸüs
));

387 ià(
i
)

388  
i
;

389 
	`put_fs_lÚg
(
acûÁ_bË_size
, &
a
->
kb_út
);

390 
	`memıy_tofs
(
a
->
kbdŸü
, 
acûÁ_bË
,

391 
acûÁ_bË_size
*(
kbdŸü
));

395 
KDSKBDIACR
:

397 
kbdŸüs
 *
a
 = (kbdŸü *)
¬g
;

398 
ù
;

400 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, (*è
a
, (
kbdŸüs
));

401 ià(
i
)

402  
i
;

403 
ù
 = 
	`g‘_fs_lÚg
(&
a
->
kb_út
);

404 ià(
ù
 >ğ
MAX_DIACR
)

405  -
EINVAL
;

406 
acûÁ_bË_size
 = 
ù
;

407 
	`memıy_äomfs
(
acûÁ_bË
, 
a
->
kbdŸü
, 
ù
*(kbdiacr));

411 
KDGETLED
:

412 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

413 ià(
i
)

414  
i
;

415 
	`put_fs_by‹
(
kbd
->
Ëd¡©e
, (*è
¬g
);

418 
KDSETLED
:

419 ià(
¬g
 & ~7)

420  -
EINVAL
;

421 
kbd
->
Ëd¡©e
 = 
¬g
;

422 
	`£t_Ëds
();

425 
VT_SETMODE
:

427 
vt_mode
 *
vtmode
 = (vt_mod*)
¬g
;

428 
mode
;

430 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
vtmode
, (
vt_mode
));

431 ià(
i
)

432  
i
;

433 
mode
 = 
	`g‘_fs_by‹
(&
vtmode
->mode);

434 ià(
mode
 !ğ
VT_AUTO
 && mod!ğ
VT_PROCESS
)

435  -
EINVAL
;

436 
vt_cÚs
[
cÚsŞe
].
vt_mode
.
mode
 = mode;

437 
vt_cÚs
[
cÚsŞe
].
vt_mode
.
wa™v
 = 
	`g‘_fs_by‹
(&
vtmode
->waitv);

438 
vt_cÚs
[
cÚsŞe
].
vt_mode
.
»lsig
 = 
	`g‘_fs_wÜd
(&
vtmode
->relsig);

439 
vt_cÚs
[
cÚsŞe
].
vt_mode
.
acqsig
 = 
	`g‘_fs_wÜd
(&
vtmode
->acqsig);

441 
vt_cÚs
[
cÚsŞe
].
vt_mode
.
äsig
 = 0;

442 
vt_cÚs
[
cÚsŞe
].
vt_pid
 = 
cu¼’t
->
pid
;

443 
vt_cÚs
[
cÚsŞe
].
vt_Ãwvt
 = 0;

447 
VT_GETMODE
:

449 
vt_mode
 *
vtmode
 = (vt_mod*)
¬g
;

451 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, (
vt_mode
));

452 ià(
i
)

453  
i
;

454 
	`put_fs_by‹
(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
mode
, &
vtmode
->mode);

455 
	`put_fs_by‹
(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
wa™v
, &
vtmode
->waitv);

456 
	`put_fs_wÜd
(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
»lsig
, &
vtmode
->relsig);

457 
	`put_fs_wÜd
(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
acqsig
, &
vtmode
->acqsig);

458 
	`put_fs_wÜd
(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
äsig
, &
vtmode
->frsig);

466 
VT_GETSTATE
:

468 
vt_¡©
 *
vt¡©
 = (vt_¡© *)
¬g
;

469 
¡©e
, 
mask
;

471 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
vt¡©
, (
vt_¡©
));

472 ià(
i
)

473  
i
;

474 
	`put_fs_wÜd
(
fg_cÚsŞe
 + 1, &
vt¡©
->
v_aùive
);

475 
¡©e
 = 1;

476 
i
 = 1, 
mask
 = 2; i <ğ
NR_CONSOLES
; ++i, mask <<= 1)

477 ià(
‰y_bË
[
i
] &&ty_bË[i]->
couÁ
 > 0)

478 
¡©e
 |ğ
mask
;

479 
	`put_fs_wÜd
(
¡©e
, &
vt¡©
->
v_¡©e
);

486 
VT_OPENQRY
:

487 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

488 ià(
i
)

489  
i
;

490 
i
 = 1; i <ğ
NR_CONSOLES
; ++i)

491 ià(!
‰y_bË
[
i
] ||ty_bË[i]->
couÁ
 == 0)

493 
	`put_fs_lÚg
(
i
 <ğ
NR_CONSOLES
 ? i : -1, (*)
¬g
);

501 
VT_ACTIVATE
:

502 ià(
¬g
 =ğ0 ||‡rg > 
NR_CONSOLES
)

503  -
ENXIO
;

504 
	`chªge_cÚsŞe
(
¬g
 - 1);

510 
VT_WAITACTIVE
:

511 ià(
¬g
 =ğ0 ||‡rg > 
NR_CONSOLES
)

512  -
ENXIO
;

513 
fg_cÚsŞe
 !ğ
¬g
 - 1)

515 ià(
	`vt_wa™aùive
() < 0)

516  -
EINTR
;

530 
VT_RELDISP
:

531 ià(
vt_cÚs
[
cÚsŞe
].
vt_mode
.
mode
 !ğ
VT_PROCESS
)

532  -
EINVAL
;

537 ià(
vt_cÚs
[
cÚsŞe
].
vt_Ãwvt
 >= 0)

539 ià(
¬g
 == 0)

544 
vt_cÚs
[
cÚsŞe
].
vt_Ãwvt
 = -1;

552 
Ãwvt
 = 
vt_cÚs
[
cÚsŞe
].
vt_Ãwvt
;

553 
vt_cÚs
[
cÚsŞe
].
vt_Ãwvt
 = -1;

554 
	`com¶‘e_chªge_cÚsŞe
(
Ãwvt
);

566 ià(
¬g
 !ğ
VT_ACKACQ
)

567  -
EINVAL
;

572 
PIO_FONT
:

573  
	`cÚ_£t_fÚt
((*)
¬g
);

576 
GIO_FONT
:

577  
	`cÚ_g‘_fÚt
((*)
¬g
);

580 
PIO_SCRNMAP
:

581  
	`cÚ_£t_Œªs
((*)
¬g
);

584 
GIO_SCRNMAP
:

585  
	`cÚ_g‘_Œªs
((*)
¬g
);

589  -
EINVAL
;

591 
	}
}

	@drivers/char/vt_kern.h

1 #iâdeà
_VT_KERN_H


2 
	#_VT_KERN_H


	)

9 
	~<lšux/vt.h
>

11 
	svt_¡ruù
 {

12 
vc_mode
;

13 
vc_kbd¿w
;

14 
vc_kbde0
;

15 
vc_kbdËds
;

16 
vt_mode
 vt_mode;

17 
vt_pid
;

18 
vt_Ãwvt
;

19 } 
vt_cÚs
[
NR_CONSOLES
];

21 
kd_mksound
(
couÁ
, 
ticks
);

	@drivers/net/3c501.c

19 *
	gv”siÚ
 =

27 
	~<lšux/cÚfig.h
>

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/±¿û.h
>

31 
	~<lšux/fú.h
>

32 
	~<lšux/iİÜt.h
>

33 
	~<lšux/š‹¼u±.h
>

34 
	~<lšux/m®loc.h
>

35 
	~<lšux/iİÜt.h
>

36 
	~<asm/b™İs.h
>

37 
	~<asm/io.h
>

38 
	~<”ºo.h
>

40 
	~"dev.h
"

41 
	~"‘h.h
"

42 
	~"skbuff.h
"

43 
	~"¬p.h
"

45 #iâdeà
HAVE_AUTOIRQ


47 
autoœq_£tup
(
wa™time
);

48 
autoœq_»pÜt
(
wa™time
);

49 
deviû
 *
œq2dev_m­
[16];

52 #iâdeà
HAVE_ALLOC_SKB


53 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

54 
	#kä“_skbmem
(
addr
, 
size
è
	`kä“_s
×ddr,size);

	)

59 
–1_´obe
(
deviû
 *
dev
);

60 
–_İ’
(
deviû
 *
dev
);

61 
–_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

62 
–_š‹¼u±
(
»g_±r
);

63 
–_»ûive
(
deviû
 *
dev
);

64 
–_»£t
(
deviû
 *
dev
);

65 
–1_şo£
(
deviû
 *
dev
);

66 
’‘_¡©i¡ics
 *
–1_g‘_¡©s
(
deviû
 *
dev
);

67 #ifdeà
HAVE_MULTICAST


68 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

71 
	#EL_NAME
 "Eth”Lšk 3c501"

	)

73 #iâdeà
EL_DEBUG


74 
	#EL_DEBUG
 2

	)

76 
	g–_debug
 = 
EL_DEBUG
;

77 
	g–_ba£
;

78 
deviû
 *
	g–dev
;

83 
’‘_¡©i¡ics
 
	m¡©s
;

84 
	mtx_pkt_¡¬t
;

85 
	mcŞlisiÚs
;

86 } 
	g–_¡©us
;

89 
	#RX_STATUS
 (
–_ba£
 + 0x06)

	)

90 
	#RX_CMD
 
RX_STATUS


	)

91 
	#TX_STATUS
 (
–_ba£
 + 0x07)

	)

92 
	#TX_CMD
 
TX_STATUS


	)

93 
	#GP_LOW
 (
–_ba£
 + 0x08)

	)

94 
	#GP_HIGH
 (
–_ba£
 + 0x09)

	)

95 
	#RX_BUF_CLR
 (
–_ba£
 + 0x0A)

	)

96 
	#RX_LOW
 (
–_ba£
 + 0x0A)

	)

97 
	#RX_HIGH
 (
–_ba£
 + 0x0B)

	)

98 
	#SAPROM
 (
–_ba£
 + 0x0C)

	)

99 
	#AX_STATUS
 (
–_ba£
 + 0x0E)

	)

100 
	#AX_CMD
 
AX_STATUS


	)

101 
	#DATAPORT
 (
–_ba£
 + 0x0F)

	)

102 
	#TX_RDY
 0x08

	)

104 
	#EL1_DATAPTR
 0x08

	)

105 
	#EL1_RXPTR
 0x0A

	)

106 
	#EL1_SAPROM
 0x0C

	)

107 
	#EL1_DATAPORT
 0x0f

	)

110 
	#AX_OFF
 0x00

	)

111 
	#AX_SYS
 0x40

	)

112 
	#AX_XMIT
 0x44

	)

113 
	#AX_RX
 0x48

	)

114 
	#AX_LOOP
 0x0C

	)

115 
	#AX_RESET
 0x80

	)

119 
	#RX_NORM
 0xA8

	)

120 
	#RX_PROM
 0x68

	)

121 
	#RX_MULT
 0xE8

	)

122 
	#TX_NORM
 0x0A

	)

125 
	#TX_COLLISION
 0x02

	)

126 
	#TX_16COLLISIONS
 0x04

	)

127 
	#TX_READY
 0x08

	)

129 
	#RX_RUNT
 0x08

	)

130 
	#RX_MISSED
 0x01

	)

131 
	#RX_GOOD
 0x30

	)

135 
	$–1_´obe
(
deviû
 *
dev
)

137 
i
;

138 
ißddr
;

139 
¡©iÚ_addr
[6];

140 
autoœq
 = 0;

142 
–dev
 = 
dev
;

143 
–_ba£
 = 
dev
->
ba£_addr
;

145 ià(
–_ba£
 < 0x40)

146 
–_ba£
 = 0x280;

148 
ißddr
 = 
–_ba£
;

151 
i
 = 0; i < 6; i++) {

152 
	`outw
(
i
, 
ißddr
 + 
EL1_DATAPTR
);

153 
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + 
EL1_SAPROM
);

156 ià(
¡©iÚ_addr
[0] != 0x02 || station_addr[1] != 0x60

157 || 
¡©iÚ_addr
[2] != 0x8c) {

158  
ENODEV
;

161 #ifdeà
HAVE_PORTRESERVE


163 
	`¢¬f_»giÚ
(
ißddr
, 16);

168 ià(
dev
->
œq
 < 2) {

170 
	`autoœq_£tup
(2);

172 
	`šb
(
RX_STATUS
);

173 
	`šb
(
TX_STATUS
);

174 
	`outb
(
AX_LOOP
 + 1, 
AX_CMD
);

176 
	`outb
(0x00, 
AX_CMD
);

178 
autoœq
 = 
	`autoœq_»pÜt
(1);

180 ià(
autoœq
 == 0) {

181 
	`´štk
("%s: 3c501…robçedØd‘eù IRQ†še.\n", 
dev
->
Çme
);

182  
EAGAIN
;

184 
dev
->
œq
 = 
autoœq
;

187 
	`outb
(
AX_RESET
+
AX_LOOP
, 
AX_CMD
);

189 
dev
->
ba£_addr
 = 
–_ba£
;

190 
	`memıy
(
dev
->
dev_addr
, 
¡©iÚ_addr
, 
ETH_ALEN
);

191 ià(
dev
->
mem_¡¬t
 & 0xf)

192 
–_debug
 = 
dev
->
mem_¡¬t
 & 0x7;

194 
	`´štk
("%s: 3c501 EtherLink‡t %#x, using %sIRQ %d, meltingƒthernet.\n",

195 
dev
->
Çme
, dev->
ba£_addr
, 
autoœq
 ? "auto":"assigÃd ", dev->
œq
);

197 ià(
–_debug
)

198 
	`´štk
("%s", 
v”siÚ
);

201 
dev
->
İ’
 = &
–_İ’
;

202 
dev
->
h¬d_¡¬t_xm™
 = &
–_¡¬t_xm™
;

203 
dev
->
¡İ
 = &
–1_şo£
;

204 
dev
->
g‘_¡©s
 = &
–1_g‘_¡©s
;

205 #ifdeà
HAVE_MULTICAST


206 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

210 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

211 
dev
->
buffs
[
i
] = 
NULL
;

213 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

214 
dev
->
add_¬p
 = 
‘h_add_¬p
;

215 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

216 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

217 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

219 
dev
->
ty³
 = 
ARPHRD_ETHER
;

220 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

221 
dev
->
mtu
 = 1500;

222 
dev
->
addr_Ën
 = 
ETH_ALEN
;

223 
i
 = 0; i < 
ETH_ALEN
; i++) {

224 
dev
->
brßdÿ¡
[
i
]=0xff;

228 
dev
->
æags
 = 
IFF_BROADCAST
;

229 
dev
->
çmy
 = 
AF_INET
;

230 
dev
->
·_addr
 = 0;

231 
dev
->
·_brdaddr
 = 0;

232 
dev
->
·_mask
 = 0;

233 
dev
->
·_®’
 = ();

236 
	}
}

240 
	$–_İ’
(
deviû
 *
dev
)

243 ià(
–_debug
 > 2)

244 
	`´štk
("%s: Došgƒl_İ’()...", 
dev
->
Çme
);

246 ià(
	`»que¡_œq
(
dev
->
œq
, &
–_š‹¼u±
)) {

247 ià(
–_debug
 > 2)

248 
	`´štk
("interrupt busy,ƒxitingƒl_open().\n");

249  -
EAGAIN
;

251 
œq2dev_m­
[
dev
->
œq
] = dev;

253 
	`–_»£t
(
dev
);

255 
dev
->
¡¬t
 = 1;

257 
	`outb
(
AX_RX
, 
AX_CMD
);

258 ià(
–_debug
 > 2)

259 
	`´štk
("finishedƒl_open().\n");

261 
	}
}

264 
	$–_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

267 ià(
dev
->
tbusy
) {

268 ià(
jiff›s
 - 
dev
->
Œªs_¡¬t
 < 20) {

269 ià(
–_debug
 > 2)

270 
	`´štk
("ransmitter busy, deferred.\n");

273 ià(
–_debug
)

274 
	`´štk
 ("%s:ransmitimed out,xsr %#2x‡xsr=%02x„xsr=%02x.\n",

275 
dev
->
Çme
, 
	`šb
(
TX_STATUS
), inb(
AX_STATUS
), inb(
RX_STATUS
));

276 
–_¡©us
.
¡©s
.
tx_”rÜs
++;

277 #ifdeà
Şdway


278 
	`–_»£t
(
dev
);

280 
	`outb
(
TX_NORM
, 
TX_CMD
);

281 
	`outb
(
RX_NORM
, 
RX_CMD
);

282 
	`outb
(
AX_OFF
, 
AX_CMD
);

284 
	`outb
(
AX_RX
, 
AX_CMD
);

285 
dev
->
tbusy
 = 0;

286 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

289 ià(
skb
 =ğ
NULL
) {

290 
	`dev_tšt
(
dev
);

295 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

296 
skb
->
dev
 = dev;

297 
	`¬p_queue
 (
skb
);

300 
skb
->
¬p
=1;

302 ià(
skb
->
Ën
 <= 0)

306 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

307 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

309 
gp_¡¬t
 = 0x800 - (
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN);

310 *
buf
 = 
skb
->
d©a
;

312 
–_¡©us
.
tx_pkt_¡¬t
 = 
gp_¡¬t
;

313 
–_¡©us
.
cŞlisiÚs
 = 0;

315 
	`outb
(
AX_SYS
, 
AX_CMD
);

316 
	`šb
(
RX_STATUS
);

317 
	`šb
(
TX_STATUS
);

318 
	`outb
(0x00, 
RX_BUF_CLR
);

319 
	`outw
(
gp_¡¬t
, 
GP_LOW
);

320 
	`outsb
(
DATAPORT
,
buf
,
skb
->
Ën
);

321 
	`outw
(
gp_¡¬t
, 
GP_LOW
);

322 
	`outb
(
AX_XMIT
, 
AX_CMD
);

323 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

326 ià(
–_debug
 > 2)

327 
	`´štk
(" queued xmit.\n");

328 ià(
skb
->
ä“
)

329 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

331 
	}
}

337 
	$–_š‹¼u±
(
»g_±r
)

339 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

341 
deviû
 *
dev
 = 
–dev
;

342 
ax¤
;

343 
ißddr
;

345 ià(
–dev
->
œq
 != irq) {

346 
	`´štk
 (
EL_NAME
 ": irq %d fÜ unknowÀdeviû\n", 
œq
);

350 
ißddr
 = 
dev
->
ba£_addr
;

352 
ax¤
 = 
	`šb
(
AX_STATUS
);

354 ià(
–_debug
 > 3)

355 
	`´štk
("%s:ƒl_š‹¼u±(èaux=%#02x", 
dev
->
Çme
, 
ax¤
);

356 ià(
dev
->
š‹¼u±
)

357 
	`´štk
("%s: R“Á”šghš‹¼u± driv”!\n", 
dev
->
Çme
);

358 
dev
->
š‹¼u±
 = 1;

360 ià(
dev
->
tbusy
) {

361 
tx¤
 = 
	`šb
(
TX_STATUS
);

363 ià(
–_debug
 > 6)

364 
	`´štk
("x¤=%02x gp=%04x„p=%04x", 
tx¤
, 
	`šw
(
GP_LOW
),

365 
	`šw
(
RX_LOW
));

367 ià((
ax¤
 & 0x80è&& (
tx¤
 & 
TX_READY
) == 0) {

368 
	`´štk
("%s: Unusual interrupt during Tx,xsr=%02x‡xsr=%02x"

369 " gp=%03x„p=%03x.\n", 
dev
->
Çme
, 
tx¤
, 
ax¤
,

370 
	`šw
(
ißddr
 + 
EL1_DATAPTR
), inw(ißdd¸+ 
EL1_RXPTR
));

371 
dev
->
tbusy
 = 0;

372 
	`m¬k_bh
(
INET_BH
);

373 } ià(
tx¤
 & 
TX_16COLLISIONS
) {

374 ià(
–_debug
)

375 
	`´štk
("%s: Transmit failed 16imes,ƒthernet jammed?\n",

376 
dev
->
Çme
);

377 
	`outb
(
AX_SYS
, 
AX_CMD
);

378 
–_¡©us
.
¡©s
.
tx_abÜ‹d_”rÜs
++;

379 } ià(
tx¤
 & 
TX_COLLISION
) {

380 ià(
–_debug
 > 6)

381 
	`´štk
("„etransmitting‡fter‡ collision.\n");

382 
	`outb
(
AX_SYS
, 
AX_CMD
);

383 
	`outw
(
–_¡©us
.
tx_pkt_¡¬t
, 
GP_LOW
);

384 
	`outb
(
AX_XMIT
, 
AX_CMD
);

385 
–_¡©us
.
¡©s
.
cŞlisiÚs
++;

386 
dev
->
š‹¼u±
 = 0;

389 
–_¡©us
.
¡©s
.
tx_·ck‘s
++;

390 ià(
–_debug
 > 6)

391 
	`´štk
(" Tx succeeded %s\n",

392 (
tx¤
 & 
TX_RDY
) ? "." : "butx is busy!");

393 
dev
->
tbusy
 = 0;

394 
	`m¬k_bh
(
INET_BH
);

397 
rx¤
 = 
	`šb
(
RX_STATUS
);

398 ià(
–_debug
 > 5)

399 
	`´štk
("„x¤=%02xx¤=%02x„p=%04x", 
rx¤
, 
	`šb
(
TX_STATUS
),

400 
	`šw
(
RX_LOW
));

403 ià(
rx¤
 & 
RX_MISSED
)

404 
–_¡©us
.
¡©s
.
rx_mis£d_”rÜs
++;

405 ià(
rx¤
 & 
RX_RUNT
) {

406 
–_¡©us
.
¡©s
.
rx_Ëngth_”rÜs
++;

407 ià(
–_debug
 > 5è
	`´štk
("„unt.\n");

408 } ià(
rx¤
 & 
RX_GOOD
) {

409 
	`–_»ûive
(
–dev
);

411 ià(
–_debug
 > 2)

412 
	`´štk
("%s: No…acket seen,„xsr=%02x **resetting 3c501***\n",

413 
dev
->
Çme
, 
rx¤
);

414 
	`–_»£t
(
–dev
);

416 ià(
–_debug
 > 3)

417 
	`´štk
(".\n");

420 
	`outb
(
AX_RX
, 
AX_CMD
);

421 
	`outb
(0x00, 
RX_BUF_CLR
);

422 
	`šb
(
RX_STATUS
);

423 
	`šb
(
TX_STATUS
);

424 
dev
->
š‹¼u±
 = 0;

426 
	}
}

432 
	$–_»ûive
(
deviû
 *
dev
)

434 
sksize
, 
pkt_Ën
;

435 
sk_buff
 *
skb
;

437 
pkt_Ën
 = 
	`šw
(
RX_LOW
);

439 ià(
–_debug
 > 4)

440 
	`´štk
("ƒl_»ûiv%d.\n", 
pkt_Ën
);

442 ià((
pkt_Ën
 < 60) || (pkt_len > 1536)) {

443 ià(
–_debug
)

444 
	`´štk
("%s: bogu ·ck‘,†’gth=%d\n", 
dev
->
Çme
, 
pkt_Ën
);

445 
–_¡©us
.
¡©s
.
rx_ov”_”rÜs
++;

448 
	`outb
(
AX_SYS
, 
AX_CMD
);

450 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

451 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

452 
	`outw
(0x00, 
GP_LOW
);

453 ià(
skb
 =ğ
NULL
) {

454 
	`´štk
("%s: MemÜy squ“ze, drİpšg…ack‘.\n", 
dev
->
Çme
);

455 
–_¡©us
.
¡©s
.
rx_drİ³d
++;

458 
skb
->
mem_Ën
 = 
sksize
;

459 
skb
->
mem_addr
 = skb;

460 
skb
->
Ën
 = 
pkt_Ën
;

461 
skb
->
dev
 = dev;

463 
	`šsb
(
DATAPORT
, 
skb
->
d©a
, 
pkt_Ën
);

465 #ifdeà
HAVE_NETIF_RX


466 
	`Ãtif_rx
(
skb
);

468 
skb
->
lock
 = 0;

469 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

470 
	`kä“_skbmem
(
skb
, 
sksize
);

471 
Í
->
¡©s
.
rx_drİ³d
++;

475 
–_¡©us
.
¡©s
.
rx_·ck‘s
++;

478 
	}
}

481 
	$–_»£t
(
deviû
 *
dev
)

483 ià(
–_debug
> 2)

484 
	`´štk
("3c501„eset...");

485 
	`outb
(
AX_RESET
, 
AX_CMD
);

486 
	`outb
(
AX_LOOP
, 
AX_CMD
);

488 
i
;

489 
i
 = 0; i < 6; i++)

490 
	`outb
(
dev
->
dev_addr
[
i
], 
–_ba£
 + i);

493 
	`outb
(0, 
RX_BUF_CLR
);

494 
	`şi
();

495 
	`outb
(
TX_NORM
, 
TX_CMD
);

496 
	`outb
(
RX_NORM
, 
RX_CMD
);

497 
	`šb
(
RX_STATUS
);

498 
	`šb
(
TX_STATUS
);

499 
dev
->
š‹¼u±
 = 0;

500 
dev
->
tbusy
 = 0;

501 
	`¡i
();

502 
	}
}

505 
	$–1_şo£
(
deviû
 *
dev
)

507 
ißddr
 = 
dev
->
ba£_addr
;

509 ià(
–_debug
 > 2)

510 
	`´štk
("%s: Shu‰šg dowÀ‘h”ÿrd‡ˆ%#x.\n", 
dev
->
Çme
, 
ißddr
);

512 
dev
->
tbusy
 = 1;

513 
dev
->
¡¬t
 = 0;

516 
	`ä“_œq
(
dev
->
œq
);

517 
	`outb
(
AX_RESET
, 
AX_CMD
);

518 
œq2dev_m­
[
dev
->
œq
] = 0;

521 
	}
}

523 
’‘_¡©i¡ics
 *

524 
	$–1_g‘_¡©s
(
deviû
 *
dev
)

526  &
–_¡©us
.
¡©s
;

527 
	}
}

529 #ifdeà
HAVE_MULTICAST


537 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

539 ià(
num_addrs
 > 0) {

540 
	`outb
(
RX_MULT
, 
RX_CMD
);

541 
	`šb
(
RX_STATUS
);

542 } ià(
num_addrs
 < 0) {

543 
	`outb
(
RX_PROM
, 
RX_CMD
);

544 
	`šb
(
RX_STATUS
);

546 
	`outb
(
RX_NORM
, 
RX_CMD
);

547 
	`šb
(
RX_STATUS
);

549 
	}
}

	@drivers/net/3c503.c

18 *
	gv”siÚ
 =

21 
	~<lšux/cÚfig.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<asm/io.h
>

26 
	~<asm/sy¡em.h
>

28 
	~"dev.h
"

30 
	~"8390.h
"

31 
	~"3c503.h
"

33 
–2_´obe
(
deviû
 *
dev
);

34 
–2_pio_autİrobe
(
deviû
 *
dev
);

35 
–2´obe1
(
ißddr
, 
deviû
 *
dev
);

37 
–2_İ’
(
deviû
 *
dev
);

38 
–2_şo£
(
deviû
 *
dev
);

39 
–2_»£t_8390
(
deviû
 *
dev
);

40 
–2_š™_ÿrd
(
deviû
 *
dev
);

41 
–2_block_ouut
(
deviû
 *
dev
, 
couÁ
,

42 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
);

43 
–2_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
,

44 
ršg_off£t
);

55 
	gpÜts
[] = {0x300,0x310,0x330,0x350,0x250,0x280,0x2a0,0x2e0,0};

58 
	$–2_´obe
(
deviû
 *
dev
)

60 *
addr
, 
addrs
[] = { 0xddffe, 0xd9ffe, 0xcdffe, 0xc9ffe, 0};

61 
ißddr
 = 
dev
->
ba£_addr
;

63 ià(
ißddr
 < 0)

64  
ENXIO
;

65 ià(
ißddr
 > 0)

66  ! 
	`–2´obe1
(
ißddr
, 
dev
);

68 
addr
 = 
addrs
; *addr;‡ddr++) {

69 
i
;

70 
ba£_b™s
 = *(*)*
addr
;

72 
i
 = 7; i >ğ0; i--, 
ba£_b™s
 >>= 1)

73 ià(
ba£_b™s
 & 0x1)

75 ià(
ba£_b™s
 != 1)

77 #ifdeà
HAVE_PORTRESERVE


78 ià(
	`check_»giÚ
(
pÜts
[
i
], 16))

81 ià(
	`–2´obe1
(
pÜts
[
i
], 
dev
))

84 #iâdeà
no_´obe_nÚsh¬ed_memÜy


85  
	`–2_pio_autİrobe
(
dev
);

87  
ENODEV
;

89 
	}
}

94 
	$–2_pio_autİrobe
(
deviû
 *
dev
)

96 
i
;

97 
i
 = 0; i < 8; i++) {

98 #ifdeà
HAVE_PORTRESERVE


99 ià(
	`check_»giÚ
(
pÜts
[
i
], 16))

103 ià(
	`šb_p
(
pÜts
[
i
] + 0x408) == 0xff)

105 ià(
	`šb
(
pÜts
[
i
] + 0x403) == (0x80 >> i)

106 && 
	`–2´obe1
(
pÜts
[
i
], 
dev
))

109  
ENODEV
;

110 
	}
}

116 
	$–2´obe1
(
ißddr
, 
deviû
 *
dev
)

118 
i
, 
ioba£_»g
, 
memba£_»g
, 
§ved_406
;

119 *
¡©iÚ_addr
 = 
dev
->
dev_addr
;

123 
	`´štk
("3c503…rob© %#3x:", 
ißddr
);

124 
ioba£_»g
 = 
	`šb
(
ißddr
+0x403);

125 
memba£_»g
 = 
	`šb
(
ißddr
+0x404);

127 iàĞ(
ioba£_»g
 & (iobase_reg - 1))

128 || (
memba£_»g
 & (membase_reg - 1))) {

129 
	`´štk
("‚ot found.\n");

132 
§ved_406
 = 
	`šb_p
(
ißddr
 + 0x406);

133 
	`outb_p
(
ECNTRL_RESET
|
ECNTRL_THIN
, 
ißddr
 + 0x406);

134 
	`outb_p
(
ECNTRL_THIN
, 
ißddr
 + 0x406);

136 
	`outb
(
ECNTRL_SAPROM
|
ECNTRL_THIN
, 
ißddr
 + 0x406);

137 
i
 = 0; i < 
ETHER_ADDR_LEN
; i++) {

138 
	`´štk
(" %2.2X", (
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + i)));

140 iàĞ
¡©iÚ_addr
[0] != 0x02

141 || 
¡©iÚ_addr
[1] != 0x60

142 || 
¡©iÚ_addr
[2] != 0x8c) {

143 
	`´štk
(" 3C503‚ot found.\n");

145 
	`outb
(
§ved_406
, 
ißddr
 + 0x406);

149 #ifdeà
HAVE_PORTRESERVE


150 
	`¢¬f_»giÚ
(
ißddr
, 16);

152 
	`‘hdev_š™
(
dev
);

155 
	`outb
(
ECNTRL_THIN
, 
ißddr
 + 0x406);

156 
dev
->
ba£_addr
 = 
ißddr
;

158 ià(
ei_debug
 > 2è
	`´štk
(" memÜy jum³r %2.2x ", 
memba£_»g
);

159 
	`outb
(
EGACFR_NORM
, 
ißddr
 + 0x405);

165 #ià
	`defšed
(
EI8390_THICK
è|| defšed(
EL2_AUI
)

166 
ei_¡©us
.
š‹rçû_num
 = 1;

168 
ei_¡©us
.
š‹rçû_num
 = 
dev
->
mem_’d
 & 0xf;

171 ià((
memba£_»g
 & 0xf0) == 0) {

172 
dev
->
mem_¡¬t
 = 0;

174 
dev
->
mem_¡¬t
 = ((
memba£_»g
 & 0xc0) ? 0xD8000 : 0xC8000) +

175 ((
memba£_»g
 & 0xA0) ? 0x4000 : 0);

177 
	#EL2_MEMSIZE
 (
EL2SM_STOP_PG
 - 
EL2SM_START_PG
)*256

	)

178 #ifdeà
EL2MEMTEST


181 *
mem_ba£
 = (*)
dev
->
mem_¡¬t
;

182 
mem‹¡_v®ue
 = 0xbbadf00d;

183 
mem_ba£
[0] = 0xba5eba5e;

184 
i
 = 1; i < 
EL2_MEMSIZE
/(
mem_ba£
[0]); i++) {

185 
mem_ba£
[
i
] = 
mem‹¡_v®ue
;

186 ià(
mem_ba£
[0] != 0xba5eba5e

187 || 
mem_ba£
[
i
] !ğ
mem‹¡_v®ue
) {

188 
	`´štk
(" memory failure or memory‡ddress conflict.\n");

189 
dev
->
mem_¡¬t
 = 0;

192 
mem‹¡_v®ue
 += 0x55555555;

193 
mem_ba£
[
i
] = 0;

200 
dev
->
mem_’d
 = dev->
rmem_’d
 = dev->
mem_¡¬t
 + 
EL2_MEMSIZE
;

201 
dev
->
rmem_¡¬t
 = 
TX_PAGES
*256 + dev->
mem_¡¬t
;

205 
ei_¡©us
.
Çme
 = "3C503";

206 
ei_¡©us
.
tx_¡¬t_·ge
 = 
EL2SM_START_PG
;

207 
ei_¡©us
.
rx_¡¬t_·ge
 = 
EL2SM_START_PG
 + 
TX_PAGES
;

208 
ei_¡©us
.
¡İ_·ge
 = 
EL2SM_STOP_PG
;

209 
ei_¡©us
.
»£t_8390
 = &
–2_»£t_8390
;

210 
ei_¡©us
.
block_šput
 = &
–2_block_šput
;

211 
ei_¡©us
.
block_ouut
 = &
–2_block_ouut
;

213 ià(
dev
->
œq
 == 2)

214 
dev
->
œq
 = 9;

215 ià(
dev
->
œq
 > 5 && dev->irq != 9) {

216 
	`´štk
("\n3c503: configured interrupt %d invalid, using‡utoIRQ.\n",

217 
dev
->
œq
);

218 
dev
->
œq
 = 0;

221 
ei_¡©us
.
§ved_œq
 = 
dev
->
œq
;

223 
dev
->
¡¬t
 = 0;

224 
dev
->
İ’
 = &
–2_İ’
;

225 
dev
->
¡İ
 = &
–2_şo£
;

227 ià(
dev
->
mem_¡¬t
)

228 
	`´štk
("\n%s: %s with shared memory‡t %#6lx-%#6lx,\n",

229 
dev
->
Çme
, 
ei_¡©us
.Çme, dev->
mem_¡¬t
, dev->
mem_’d
-1);

231 
	`´štk
("\n%s: %s using…rogrammed I/O (REJUMPER for SHARED MEMORY).\n",

232 
dev
->
Çme
, 
ei_¡©us
.name);

233 ià(
ei_debug
 > 1)

234 
	`´štk
(
v”siÚ
);

236  
ißddr
;

237 
	}
}

240 
	$–2_İ’
(
deviû
 *
dev
)

243 ià(
dev
->
œq
 < 2) {

244 
œqli¡
[] = {5, 9, 3, 4, 0};

245 *
œqp
 = 
œqli¡
;

247 
	`outb
(
EGACFR_NORM
, 
E33G_GACFR
);

249 ià(
	`»que¡_œq
 (*
œqp
, 
NULL
è!ğ-
EBUSY
) {

251 
	`autoœq_£tup
(0);

252 
	`outb_p
(0x04 << ((*
œqp
 =ğ9è? 2 : *œqp), 
E33G_IDCFR
);

253 
	`outb_p
(0x00, 
E33G_IDCFR
);

254 ià(*
œqp
 =ğ
	`autoœq_»pÜt
(0)

255 && 
	`»que¡_œq
 (
dev
->
œq
 = *
œqp
, &
ei_š‹¼u±
) == 0)

258 } *++
œqp
);

259 ià(*
œqp
 == 0) {

260 
	`outb
(
EGACFR_IRQOFF
, 
E33G_GACFR
);

261  -
EAGAIN
;

264 ià(
	`»que¡_œq
(
dev
->
œq
, &
ei_š‹¼u±
)) {

265  -
EAGAIN
;

268 
	`–2_š™_ÿrd
(
dev
);

269  
	`ei_İ’
(
dev
);

270 
	}
}

273 
	$–2_şo£
(
deviû
 *
dev
)

275 
	`ä“_œq
(
dev
->
œq
);

276 
dev
->
œq
 = 
ei_¡©us
.
§ved_œq
;

277 
œq2dev_m­
[
dev
->
œq
] = 
NULL
;

278 
	`outb
(
EGACFR_IRQOFF
, 
E33G_GACFR
);

280 
	`NS8390_š™
(
dev
, 0);

283 
	}
}

290 
	$–2_»£t_8390
(
deviû
 *
dev
)

292 ià(
ei_debug
 > 1) {

293 
	`´štk
("%s: Re£‰šgh3c503 bßrd...", 
dev
->
Çme
);

294 
	`´štk
("%#x=%#02x %#x=%#02x %#x=%#02x...", 
E33G_IDCFR
, 
	`šb
(E33G_IDCFR),

295 
E33G_CNTRL
, 
	`šb
(E33G_CNTRL), 
E33G_GACFR
, inb(E33G_GACFR));

297 
	`outb_p
(
ECNTRL_RESET
|
ECNTRL_THIN
, 
E33G_CNTRL
);

298 
ei_¡©us
.
txšg
 = 0;

299 
	`outb_p
(
ei_¡©us
.
š‹rçû_num
==0 ? 
ECNTRL_THIN
 : 
ECNTRL_AUI
, 
E33G_CNTRL
);

300 
	`–2_š™_ÿrd
(
dev
);

301 ià(
ei_debug
 > 1è
	`´štk
("done\n");

302 
	}
}

306 
	$–2_š™_ÿrd
(
deviû
 *
dev
)

309 
	`outb_p
(
ei_¡©us
.
š‹rçû_num
==0 ? 
ECNTRL_THIN
 : 
ECNTRL_AUI
, 
E33G_CNTRL
);

313 
	`outb
(
ei_¡©us
.
rx_¡¬t_·ge
, 
E33G_STARTPG
);

314 
	`outb
(
ei_¡©us
.
¡İ_·ge
, 
E33G_STOPPG
);

317 
	`outb
(0xff, 
E33G_VP2
);

318 
	`outb
(0xff, 
E33G_VP1
);

319 
	`outb
(0x00, 
E33G_VP0
);

321 
	`outb_p
(0x00, 
dev
->
ba£_addr
 + 
EN0_IMR
);

323 
	`outb
(
EGACFR_NORM
, 
E33G_GACFR
);

326 
	`outb_p
((0x04 << (
dev
->
œq
 =ğ9 ? 2 : dev->œq)), 
E33G_IDCFR
);

327 
	`outb_p
(8, 
E33G_DRQCNT
);

328 
	`outb_p
(0x20, 
E33G_DMAAH
);

329 
	`outb_p
(0x00, 
E33G_DMAAL
);

331 
	}
}

336 
	$–2_block_ouut
(
deviû
 *
dev
, 
couÁ
,

337 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
)

339 
i
;

340 
boguscouÁ
 = 0;

343 
	`outb
(
EGACFR_NORM
, 
E33G_GACFR
);

345 ià(
dev
->
mem_¡¬t
) {

346 *
de¡_addr
 = (*)(
dev
->
mem_¡¬t
 +

347 ((
¡¬t_·ge
 - 
ei_¡©us
.
tx_¡¬t_·ge
) << 8));

348 
	`memıy
(
de¡_addr
, 
buf
, 
couÁ
);

349 ià(
ei_debug
 > 2 && 
	`memcmp
(
de¡_addr
, 
buf
, 
couÁ
))

350 
	`´štk
("%s: 3c503 send_packet() bad memory copy @ %#5x.\n",

351 
dev
->
Çme
, (è
de¡_addr
);

356 
	`outb
(0x00, 
E33G_DMAAL
);

357 
	`outb_p
(
¡¬t_·ge
, 
E33G_DMAAH
);

358 
	`outb_p
((
ei_¡©us
.
š‹rçû_num
 ? 
ECNTRL_AUI
 : 
ECNTRL_THIN
 ) | 
ECNTRL_OUTPUT


359 | 
ECNTRL_START
, 
E33G_CNTRL
);

364 
i
 = 0; i < 
couÁ
; i++) {

365 ià(
i
 % 8 == 0)

366 (
	`šb
(
E33G_STATUS
è& 
ESTAT_DPRDY
) == 0)

367 ià(++
boguscouÁ
 > (
i
<<3) + 32) {

368 
	`´štk
("%s: FIFO blocked inƒl2_block_output (at %d of %d, bc=%d).\n",

369 
dev
->
Çme
, 
i
, 
couÁ
, 
boguscouÁ
);

372 
	`outb
(
buf
[
i
], 
E33G_FIFOH
);

374 
	`outb_p
(
ei_¡©us
.
š‹rçû_num
==0 ? 
ECNTRL_THIN
 : 
ECNTRL_AUI
, 
E33G_CNTRL
);

376 
	}
}

380 
	$–2_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
, 
ršg_off£t
)

382 
boguscouÁ
 = 0;

383 
’d_of_ršg
 = 
dev
->
rmem_’d
;

384 
i
;

387 ià(
dev
->
mem_¡¬t
) {

388 
ršg_off£t
 -ğ(
EL2SM_START_PG
<<8);

389 ià(
dev
->
mem_¡¬t
 + 
ršg_off£t
 + 
couÁ
 > 
’d_of_ršg
) {

391 
£mi_couÁ
 = 
’d_of_ršg
 - (
dev
->
mem_¡¬t
 + 
ršg_off£t
);

392 
	`memıy
(
buf
, (*)
dev
->
mem_¡¬t
 + 
ršg_off£t
, 
£mi_couÁ
);

393 
couÁ
 -ğ
£mi_couÁ
;

394 
	`memıy
(
buf
 + 
£mi_couÁ
, (*)
dev
->
rmem_¡¬t
, 
couÁ
);

395  
dev
->
rmem_¡¬t
 + 
couÁ
;

397 
	`memıy
(
buf
, (*)
dev
->
mem_¡¬t
 + 
ršg_off£t
, 
couÁ
);

398  
ršg_off£t
 + 
couÁ
;

401 
	`outb
(
ršg_off£t
 & 0xff, 
E33G_DMAAL
);

402 
	`outb_p
((
ršg_off£t
 >> 8è& 0xff, 
E33G_DMAAH
);

403 
	`outb_p
((
ei_¡©us
.
š‹rçû_num
 =ğ0 ? 
ECNTRL_THIN
 : 
ECNTRL_AUI
è| 
ECNTRL_INPUT


404 | 
ECNTRL_START
, 
E33G_CNTRL
);

408 
i
 = 0; i < 
couÁ
; i++) {

409 ià(
i
 % 8 == 0)

410 (
	`šb
(
E33G_STATUS
è& 
ESTAT_DPRDY
) == 0)

411 ià(++
boguscouÁ
 > (
i
<<3) + 32) {

412 
	`´štk
("%s: FIFO blocked inƒl2_block_input() (at %d of %d, bc=%d).\n",

413 
dev
->
Çme
, 
i
, 
couÁ
, 
boguscouÁ
);

414 
boguscouÁ
 = 0;

417 
buf
[
i
] = 
	`šb_p
(
E33G_FIFOH
);

419 
	`outb_p
(
ei_¡©us
.
š‹rçû_num
 =ğ0 ? 
ECNTRL_THIN
 : 
ECNTRL_AUI
, 
E33G_CNTRL
);

421 
	}
}

	@drivers/net/3c503.h

6 
	#EL2H
 (
dev
->
ba£_addr
 + 0x400)

	)

7 
	#EL2L
 (
dev
->
ba£_addr
)

	)

11 
	#EL2SM_START_PG
 (0x20è

	)

12 
	#EL2SM_STOP_PG
 (0x40è

	)

15 
	#E33G_STARTPG
 (
EL2H
+0è

	)

16 
	#E33G_STOPPG
 (
EL2H
+1è

	)

17 
	#E33G_DRQCNT
 (
EL2H
+2è

	)

18 
	#E33G_IOBASE
 (
EL2H
+3è

	)

20 
	#E33G_ROMBASE
 (
EL2H
+4è

	)

21 
	#E33G_GACFR
 (
EL2H
+5è

	)

22 
	#E33G_CNTRL
 (
EL2H
+6è

	)

23 
	#E33G_STATUS
 (
EL2H
+7è

	)

24 
	#E33G_IDCFR
 (
EL2H
+8è

	)

26 
	#E33G_DMAAH
 (
EL2H
+9è

	)

27 
	#E33G_DMAAL
 (
EL2H
+10è

	)

30 
	#E33G_VP2
 (
EL2H
+11)

	)

31 
	#E33G_VP1
 (
EL2H
+12)

	)

32 
	#E33G_VP0
 (
EL2H
+13)

	)

33 
	#E33G_FIFOH
 (
EL2H
+14è

	)

34 
	#E33G_FIFOL
 (
EL2H
+15è

	)

38 
	#ECNTRL_RESET
 (0x01è

	)

39 
	#ECNTRL_THIN
 (0x02è

	)

40 
	#ECNTRL_AUI
 (0x00è

	)

41 
	#ECNTRL_SAPROM
 (0x04è

	)

42 
	#ECNTRL_DBLBFR
 (0x20è

	)

43 
	#ECNTRL_OUTPUT
 (0x40è

	)

44 
	#ECNTRL_INPUT
 (0x00è

	)

45 
	#ECNTRL_START
 (0x80è

	)

49 
	#ESTAT_DPRDY
 (0x80è

	)

50 
	#ESTAT_UFLW
 (0x40è

	)

51 
	#ESTAT_OFLW
 (0x20è

	)

52 
	#ESTAT_DTC
 (0x10è

	)

53 
	#ESTAT_DIP
 (0x08è

	)

57 
	#EGACFR_NORM
 (0x49è

	)

58 
	#EGACFR_IRQOFF
 (0xc9è

	)

	@drivers/net/3c507.c

23 *
	gv”siÚ
 =

26 
	~<lšux/cÚfig.h
>

39 
	~<lšux/k”Ãl.h
>

40 
	~<lšux/sched.h
>

41 
	~<lšux/ty³s.h
>

42 
	~<lšux/fú.h
>

43 
	~<lšux/š‹¼u±.h
>

44 
	~<lšux/±¿û.h
>

45 
	~<lšux/iİÜt.h
>

46 
	~<lšux/š.h
>

47 
	~<asm/sy¡em.h
>

48 
	~<asm/b™İs.h
>

49 
	~<asm/io.h
>

50 
	~<asm/dma.h
>

51 
	~<”ºo.h
>

52 
	~<memÜy.h
>

54 
	~"dev.h
"

55 
	~"‘h.h
"

56 
	~"skbuff.h
"

57 
	~"¬p.h
"

59 #iâdeà
HAVE_ALLOC_SKB


60 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

61 
	#kä“_skbmem
(
addr
, 
size
è
	`kä“_s
×ddr,size);

	)

63 
	~<lšux/m®loc.h
>

67 #iâdeà
NET_DEBUG


68 
	#NET_DEBUG
 1

	)

70 
	gÃt_debug
 = 
NET_DEBUG
;

87 
	#CUC_START
 0x0100

	)

88 
	#CUC_RESUME
 0x0200

	)

89 
	#CUC_SUSPEND
 0x0300

	)

90 
	#RX_START
 0x0010

	)

91 
	#RX_RESUME
 0x0020

	)

92 
	#RX_SUSPEND
 0x0030

	)

106 
	#CMD_EOL
 0x8000

	)

107 
	#CMD_SUSP
 0x4000

	)

108 
	#CMD_INTR
 0x2000

	)

110 
	ecommªds
 {

111 
	mCmdNOp
 = 0, 
	mCmdSAS‘up
 = 1, 
	mCmdCÚfigu»
 = 2, 
	mCmdMuÉiÿ¡Li¡
 = 3,

112 
	mCmdTx
 = 4, 
	mCmdTDR
 = 5, 
	mCmdDump
 = 6, 
	mCmdDŸgno£
 = 7};

115 
	sÃt_loÿl
 {

116 
’‘_¡©i¡ics
 
	m¡©s
;

117 
	mÏ¡_»¡¬t
;

118 
ushÜt
 
	mrx_h—d
;

119 
ushÜt
 
	mrx_
;

120 
ushÜt
 
	mtx_h—d
;

121 
ushÜt
 
	mtx_cmd_lšk
;

122 
ushÜt
 
	mtx_»­
;

133 
	#SA_DATA
 0

	)

134 
	#MISC_CTRL
 6

	)

135 
	#RESET_IRQ
 10

	)

136 
	#SIGNAL_CA
 11

	)

137 
	#ROM_CONFIG
 13

	)

138 
	#MEM_CONFIG
 14

	)

139 
	#IRQ_CONFIG
 15

	)

142 
	#ID_PORT
 0x100

	)

145 
	#iSCB_STATUS
 0x8

	)

146 
	#iSCB_CMD
 0xA

	)

147 
	#iSCB_CBL
 0xC

	)

148 
	#iSCB_RFA
 0xE

	)

159 
	#SCB_BASE
 (()64*1024 - (
dev
->
mem_’d
 - dev->
mem_¡¬t
))

	)

177 
	#CONFIG_CMD
 0x0018

	)

178 
	#SET_SA_CMD
 0x0024

	)

179 
	#SA_OFFSET
 0x002A

	)

180 
	#IDLELOOP
 0x30

	)

181 
	#TDR_CMD
 0x38

	)

182 
	#TDR_TIME
 0x3C

	)

183 
	#DUMP_CMD
 0x40

	)

184 
	#DIAG_CMD
 0x48

	)

185 
	#SET_MC_CMD
 0x4E

	)

186 
	#DUMP_DATA
 0x56

	)

188 
	#TX_BUF_START
 0x0100

	)

189 
	#NUM_TX_BUFS
 4

	)

190 
	#TX_BUF_SIZE
 (1518+14+20+16è

	)

192 
	#RX_BUF_START
 0x2000

	)

193 
	#RX_BUF_SIZE
 (1518+14+18è

	)

194 
	#RX_BUF_END
 (
dev
->
mem_’d
 - dev->
mem_¡¬t
)

	)

229 
	gš™_wÜds
[] = {

240 0,0xf000|
RX_START
|
CUC_START
,

241 
CONFIG_CMD
,

242 
RX_BUF_START
,

246 0, 
CmdCÚfigu»
,

247 
SET_SA_CMD
,

253 0, 
CmdSAS‘up
,

254 
SET_MC_CMD
,

258 0, 
CmdNOp
, 
IDLELOOP
, 0 ,

261 0, 
CmdTDR
, 
IDLELOOP
, 0,

264 0, 
CmdDump
, 
IDLELOOP
, 
DUMP_DATA
,

267 0, 
CmdDŸgno£
, 
IDLELOOP
,

270 0, 
CmdMuÉiÿ¡Li¡
, 
IDLELOOP
, 0,

275 
–16_´obe
(
deviû
 *
dev
);

277 
–16_´obe1
(
deviû
 *
dev
, 
ißddr
);

278 
–16_İ’
(
deviû
 *
dev
);

279 
–16_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

280 
–16_š‹¼u±
(
»g_±r
);

281 
–16_rx
(
deviû
 *
dev
);

282 
–16_şo£
(
deviû
 *
dev
);

283 
’‘_¡©i¡ics
 *
–16_g‘_¡©s
(
deviû
 *
dev
);

285 
h¬dw¬e_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
);

286 
š™_82586_mem
(
deviû
 *
dev
);

296 
	$–16_´obe
(
deviû
 *
dev
)

299 *
pÜt
, 
pÜts
[] = {0x300, 0x320, 0x340, 0x280, 0};

300 
ba£_addr
 = 
dev
->base_addr;

301 
ushÜt
 
Ìs_¡©e
 = 0xff, 
i
;

303 ià(
ba£_addr
 > 0x1ff)

304  
	`–16_´obe1
(
dev
, 
ba£_addr
);

305 ià(
ba£_addr
 > 0)

306  
ENXIO
;

309 
	`outb
(0x00, 
ID_PORT
);

310 
i
 = 0; i < 255; i++) {

311 
	`outb
(
Ìs_¡©e
, 
ID_PORT
);

312 
Ìs_¡©e
 <<= 1;

313 ià(
Ìs_¡©e
 & 0x100)

314 
Ìs_¡©e
 ^= 0xe7;

316 
	`outb
(0x00, 
ID_PORT
);

318 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

319 
ißddr
 = *
pÜt
;

322 ià(
	`šb
(
ißddr
) == '*' && inb(ioaddr+1) == '3'

323 && 
	`šb
(
ißddr
+2) == 'C' && inb(ioaddr+3) == 'O'

324 && 
	`–16_´obe1
(
dev
, *
pÜt
) == 0)

329 
»s
[5];

330 
»s
[0] = 
	`šb
(
ißddr
);„es[1] = inb(ioaddr+1);

331 
»s
[2] = 
	`šb
(
ißddr
+2);„es[3] = inb(ioaddr+3);

332 
»s
[4] = 0;

333 ià(
»s
[0] == '*' &&„es[1] == '3'

334 && 
»s
[2] == 'C' &&„es[3] == 'O'

335 && 
	`–16_´obe1
(
dev
, *
pÜt
) == 0)

340  
ENODEV
;

341 
	}
}

343 
	$–16_´obe1
(
deviû
 *
dev
, 
ißddr
)

345 
i
, 
œq
, 
œqv®
;

347 
	`´štk
("%s: 3c507‡ˆ%#x,", 
dev
->
Çme
, 
ißddr
);

352 
œq
 = 
	`šb
(
ißddr
 + 
IRQ_CONFIG
) & 0x0f;

354 
œqv®
 = 
	`»que¡_œq
(
œq
, &
–16_š‹¼u±
);

355 ià(
œqv®
) {

356 
	`´štk
 ("uÇbËØg‘ IRQ %d (œqv®=%d).\n", 
œq
, 
œqv®
);

357  
EAGAIN
;

361 
	`¢¬f_»giÚ
(
ißddr
, 16);

362 
dev
->
ba£_addr
 = 
ißddr
;

364 
	`outb
(0x01, 
ißddr
 + 
MISC_CTRL
);

365 
i
 = 0; i < 6; i++) {

366 
dev
->
dev_addr
[
i
] = 
	`šb
(
ißddr
 + i);

367 
	`´štk
(" %02x", 
dev
->
dev_addr
[
i
]);

370 ià((
dev
->
mem_¡¬t
 & 0xf) > 0)

371 
Ãt_debug
 = 
dev
->
mem_¡¬t
 & 7;

373 #ifdeà
MEM_BASE


374 
dev
->
mem_¡¬t
 = 
MEM_BASE
;

375 
dev
->
mem_’d
 = dev->
mem_¡¬t
 + 0x10000;

378 
ba£
;

379 
size
;

380 
mem_cÚfig
 = 
	`šb
(
ißddr
 + 
MEM_CONFIG
);

381 ià(
mem_cÚfig
 & 0x20) {

382 
size
 = 64*1024;

383 
ba£
 = 0xf00000 + (
mem_cÚfig
 & 0x08 ? 0x080000

384 : ((
mem_cÚfig
 & 3) << 17));

386 
size
 = ((
mem_cÚfig
 & 3) + 1) << 14;

387 
ba£
 = 0x0c0000 + ( (
mem_cÚfig
 & 0x18) << 12);

389 
dev
->
mem_¡¬t
 = 
ba£
;

390 
dev
->
mem_’d
 = 
ba£
 + 
size
;

394 
dev
->
if_pÜt
 = (
	`šb
(
ißddr
 + 
ROM_CONFIG
) & 0x80) ? 1 : 0;

395 
dev
->
œq
 = 
	`šb
(
ißddr
 + 
IRQ_CONFIG
) & 0x0f;

397 
	`´štk
(", IRQ %d, %¡”ÇÈxcvr, memÜy %#lx-%#lx.\n", 
dev
->
œq
,

398 
dev
->
if_pÜt
 ? "ex" : "š", dev->
mem_¡¬t
, dev->
mem_’d
-1);

400 ià(
Ãt_debug
)

401 
	`´štk
(
v”siÚ
);

404 
dev
->
´iv
 = 
	`km®loc
((
Ãt_loÿl
), 
GFP_KERNEL
);

405 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt_loÿl
));

407 
dev
->
İ’
 = 
–16_İ’
;

408 
dev
->
¡İ
 = 
–16_şo£
;

409 
dev
->
h¬d_¡¬t_xm™
 = 
–16_£nd_·ck‘
;

410 
dev
->
g‘_¡©s
 = 
–16_g‘_¡©s
;

414 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

415 
dev
->
buffs
[
i
] = 
NULL
;

417 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

418 
dev
->
add_¬p
 = 
‘h_add_¬p
;

419 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

420 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

421 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

423 
dev
->
ty³
 = 
ARPHRD_ETHER
;

424 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

425 
dev
->
mtu
 = 1500;

426 
dev
->
addr_Ën
 = 
ETH_ALEN
;

427 
i
 = 0; i < 
ETH_ALEN
; i++) {

428 
dev
->
brßdÿ¡
[
i
]=0xff;

432 
dev
->
æags
 = 
IFF_BROADCAST
;

433 
dev
->
çmy
 = 
AF_INET
;

434 
dev
->
·_addr
 = 0;

435 
dev
->
·_brdaddr
 = 0;

436 
dev
->
·_mask
 = 0;

437 
dev
->
·_®’
 = ();

440 
	}
}

445 
	$–16_İ’
(
deviû
 *
dev
)

447 
œq2dev_m­
[
dev
->
œq
] = dev;

450 
	`š™_82586_mem
(
dev
);

452 
dev
->
tbusy
 = 0;

453 
dev
->
š‹¼u±
 = 0;

454 
dev
->
¡¬t
 = 1;

456 
	}
}

459 
	$–16_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

461 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

462 
ißddr
 = 
dev
->
ba£_addr
;

463 *
shmem
 = (*)
dev
->
mem_¡¬t
;

465 ià(
dev
->
tbusy
) {

468 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

469 ià(
tickssoçr
 < 5)

471 ià(
Ãt_debug
 > 1)

472 
	`´štk
("%s:¿nsm™imed out, %s? ", 
dev
->
Çme
,

473 
shmem
[
iSCB_STATUS
>>1] & 0x8000 ? "IRQ conflict" :

476 ià(
Í
->
Ï¡_»¡¬t
 =ğÍ->
¡©s
.
tx_·ck‘s
) {

477 ià(
Ãt_debug
 > 1è
	`´štk
("Resetting board.\n");

479 
	`š™_82586_mem
(
dev
);

482 ià(
Ãt_debug
 > 1è
	`´štk
("Kicking board.\n");

483 
shmem
[
iSCB_CMD
>>1] = 0xf000|
CUC_START
|
RX_START
;

484 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

485 
Í
->
Ï¡_»¡¬t
 =†p->
¡©s
.
tx_·ck‘s
;

487 
dev
->
tbusy
=0;

488 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

494 ià(
skb
 =ğ
NULL
) {

495 
	`dev_tšt
(
dev
);

501 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

502 
skb
->
dev
 = dev;

503 
	`¬p_queue
 (
skb
);

506 
skb
->
¬p
=1;

509 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

510 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

512 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

513 *
buf
 = 
skb
->
d©a
;

516 
	`outb
(0x80, 
ißddr
 + 
MISC_CTRL
);

517 
	`h¬dw¬e_£nd_·ck‘
(
dev
, 
buf
, 
Ëngth
);

518 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

520 
	`outb
(0x84, 
ißddr
 + 
MISC_CTRL
);

523 ià(
skb
->
ä“
)

524 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

529 
	}
}

534 
	$–16_š‹¼u±
(
»g_±r
)

536 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

537 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

538 
Ãt_loÿl
 *
Í
;

539 
ißddr
, 
¡©us
, 
boguscouÁ
 = 0;

540 
ushÜt
 
ack_cmd
 = 0;

541 
ushÜt
 *
shmem
;

543 ià(
dev
 =ğ
NULL
) {

544 
	`´štk
 ("Ãt_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

547 
dev
->
š‹¼u±
 = 1;

549 
ißddr
 = 
dev
->
ba£_addr
;

550 
Í
 = (
Ãt_loÿl
 *)
dev
->
´iv
;

551 
shmem
 = ((
ushÜt
*)
dev
->
mem_¡¬t
);

553 
¡©us
 = 
shmem
[
iSCB_STATUS
>>1];

555 ià(
Ãt_debug
 > 4) {

556 
	`´štk
("%s: 3c507 iÁ”ru±, stu %4.4x.\n", 
dev
->
Çme
, 
¡©us
);

560 
	`outb
(0x80, 
ißddr
 + 
MISC_CTRL
);

563 
Í
->
tx_»­
 !ğÍ->
tx_h—d
) {

564 
tx_¡©us
 = 
shmem
[
Í
->
tx_»­
>>1];

566 ià(
tx_¡©us
 == 0) {

567 ià(
Ãt_debug
 > 5è
	`´štk
("Couldn'ˆ»­ %#x.\n", 
Í
->
tx_»­
);

570 ià(
tx_¡©us
 & 0x2000) {

571 
Í
->
¡©s
.
tx_·ck‘s
++;

572 
Í
->
¡©s
.
cŞlisiÚs
 +ğ
tx_¡©us
 & 0xf;

573 
dev
->
tbusy
 = 0;

574 
	`m¬k_bh
(
INET_BH
);

576 
Í
->
¡©s
.
tx_”rÜs
++;

577 ià(
tx_¡©us
 & 0x0600è
Í
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

578 ià(
tx_¡©us
 & 0x0100è
Í
->
¡©s
.
tx_fifo_”rÜs
++;

579 ià(!(
tx_¡©us
 & 0x0040)è
Í
->
¡©s
.
tx_h—¹b—t_”rÜs
++;

580 ià(
tx_¡©us
 & 0x0020è
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

582 ià(
Ãt_debug
 > 5)

583 
	`´štk
("R—³d %x, Tx stu %04x.\n" , 
Í
->
tx_»­
, 
tx_¡©us
);

584 
Í
->
tx_»­
 +ğ
TX_BUF_SIZE
;

585 ià(
Í
->
tx_»­
 > 
RX_BUF_START
 - 
TX_BUF_SIZE
)

586 
Í
->
tx_»­
 = 
TX_BUF_START
;

587 ià(++
boguscouÁ
 > 4)

591 ià(
¡©us
 & 0x4000) {

592 ià(
Ãt_debug
 > 5)

593 
	`´štk
("Reûived…ack‘,„x_h—d %04x.\n", 
Í
->
rx_h—d
);

594 
	`–16_rx
(
dev
);

598 
ack_cmd
 = 
¡©us
 & 0xf000;

600 ià((
¡©us
 & 0x0700è!ğ0x0200 && 
dev
->
¡¬t
) {

601 ià(
Ãt_debug
)

602 
	`´štk
("%s: Command unit stopped, status %04x,„estarting.\n",

603 
dev
->
Çme
, 
¡©us
);

607 
ack_cmd
 |ğ
CUC_RESUME
;

610 ià((
¡©us
 & 0x0070è!ğ0x0040 && 
dev
->
¡¬t
) {

611 
	`š™_rx_bufs
(
deviû
 *);

614 ià(
Ãt_debug
)

615 
	`´štk
("%s: Rx unit stopped, status %04x,„estarting.\n",

616 
dev
->
Çme
, 
¡©us
);

617 
	`š™_rx_bufs
(
dev
);

618 
shmem
[
iSCB_RFA
 >> 1] = 
RX_BUF_START
;

619 
ack_cmd
 |ğ
RX_START
;

622 
shmem
[
iSCB_CMD
>>1] = 
ack_cmd
;

623 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

626 
	`outb
(0, 
ißddr
 + 
RESET_IRQ
);

629 
	`outb
(0x84, 
ißddr
 + 
MISC_CTRL
);

632 
	}
}

635 
	$–16_şo£
(
deviû
 *
dev
)

637 
ißddr
 = 
dev
->
ba£_addr
;

638 
ushÜt
 *
shmem
 = (*)
dev
->
mem_¡¬t
;

640 
dev
->
tbusy
 = 1;

641 
dev
->
¡¬t
 = 0;

644 
shmem
[
iSCB_CMD
 >> 1] = 
RX_SUSPEND
 | 
CUC_SUSPEND
;

645 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

648 
	`outb
(0x80, 
ißddr
 + 
MISC_CTRL
);

653 
œq2dev_m­
[
dev
->
œq
] = 0;

658 
	}
}

662 
’‘_¡©i¡ics
 *

663 
	$–16_g‘_¡©s
(
deviû
 *
dev
)

665 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

669  &
Í
->
¡©s
;

670 
	}
}

674 
	$š™_rx_bufs
(
deviû
 *
dev
)

676 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

677 *
wr™e_±r
;

678 
SCB_ba£
 = 
SCB_BASE
;

680 
cur_rxbuf
 = 
Í
->
rx_h—d
 = 
RX_BUF_START
;

685 
wr™e_±r
 = (*)(
dev
->
mem_¡¬t
 + 
cur_rxbuf
);

687 *
wr™e_±r
++ = 0x0000;

688 *
wr™e_±r
++ = 0x0000;

689 *
wr™e_±r
++ = 
cur_rxbuf
 + 
RX_BUF_SIZE
;

690 *
wr™e_±r
++ = 
cur_rxbuf
 + 22;

691 *
wr™e_±r
++ = 0x0000;

692 *
wr™e_±r
++ = 0x0000;

693 *
wr™e_±r
++ = 0x0000;

694 *
wr™e_±r
++ = 0x0000;

695 *
wr™e_±r
++ = 0x0000;

696 *
wr™e_±r
++ = 0x0000;

697 *
wr™e_±r
++ = 0x0000;

699 *
wr™e_±r
++ = 0x0000;

700 *
wr™e_±r
++ = -1;

701 *
wr™e_±r
++ = 
cur_rxbuf
 + 0x20 + 
SCB_ba£
;

702 *
wr™e_±r
++ = 0x0000;

704 *
wr™e_±r
++ = 0x8000 + 
RX_BUF_SIZE
-0x20;

706 
Í
->
rx_
 = 
cur_rxbuf
;

707 
cur_rxbuf
 +ğ
RX_BUF_SIZE
;

708 } 
cur_rxbuf
 <ğ
RX_BUF_END
 - 
RX_BUF_SIZE
);

712 
wr™e_±r
 = (*)

713 (
dev
->
mem_¡¬t
 + 
Í
->
rx_
 + 2);

714 *
wr™e_±r
++ = 0xC000;

715 *
wr™e_±r
++ = 
Í
->
rx_h—d
;

717 
	}
}

720 
	$š™_82586_mem
(
deviû
 *
dev
)

722 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

723 
ißddr
 = 
dev
->
ba£_addr
;

724 
ushÜt
 *
shmem
 = (*)
dev
->
mem_¡¬t
;

728 
	`outb
(0x20, 
ißddr
 + 
MISC_CTRL
);

731 
š™_wÜds
[3] = 
SCB_BASE
;

732 
š™_wÜds
[7] = 
SCB_BASE
;

735 
	`memıy
((*)
dev
->
mem_’d
-10, 
š™_wÜds
, 10);

738 
	`memıy
((*)
dev
->
mem_¡¬t
, 
š™_wÜds
 + 5, (init_words) - 10);

741 
	`memıy
((*)
dev
->
mem_¡¬t
+
SA_OFFSET
, dev->
dev_addr
,

742 (
dev
->
dev_addr
));

745 
Í
->
tx_cmd_lšk
 = 
IDLELOOP
 + 4;

746 
Í
->
tx_h—d
 =†p->
tx_»­
 = 
TX_BUF_START
;

748 
	`š™_rx_bufs
(
dev
);

751 
	`outb
(0xA0, 
ißddr
 + 
MISC_CTRL
);

755 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

758 
bogusút
 = 50;

759 
shmem
[
iSCB_STATUS
>>1] == 0)

760 ià(--
bogusút
 == 0) {

761 
	`´štk
("%s: i82586 initializationimed out with status %04x,"

762 "cmd %04x.\n", 
dev
->
Çme
,

763 
shmem
[
iSCB_STATUS
>>1], shmem[
iSCB_CMD
>>1]);

767 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

771 
	`outb
(0x84, 
ißddr
 + 
MISC_CTRL
);

772 ià(
Ãt_debug
 > 4)

773 
	`´štk
("%s: In™Ÿlized 82586, stu %04x.\n", 
dev
->
Çme
,

774 
shmem
[
iSCB_STATUS
>>1]);

776 
	}
}

779 
	$h¬dw¬e_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
)

781 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

782 
ißddr
 = 
dev
->
ba£_addr
;

783 
ushÜt
 
tx_block
 = 
Í
->
tx_h—d
;

784 
ushÜt
 *
wr™e_±r
 = (ushÜˆ*)(
dev
->
mem_¡¬t
 + 
tx_block
);

787 *
wr™e_±r
++ = 0x0000;

788 *
wr™e_±r
++ = 
CMD_INTR
|
CmdTx
;

789 *
wr™e_±r
++ = 
tx_block
+16;

790 *
wr™e_±r
++ = 
tx_block
+8;

793 *
wr™e_±r
++ = 
Ëngth
 | 0x8000;

794 *
wr™e_±r
++ = -1;

795 *
wr™e_±r
++ = 
tx_block
+22+
SCB_BASE
;

796 *
wr™e_±r
++ = 0x0000;

799 *
wr™e_±r
++ = 0x0000;

800 *
wr™e_±r
++ = 
CmdNOp
;

801 *
wr™e_±r
++ = 
tx_block
+16;

804 
	`memıy
(
wr™e_±r
, 
buf
, 
Ëngth
);

807 *(
ushÜt
*)(
dev
->
mem_¡¬t
 + 
Í
->
tx_cmd_lšk
èğ
tx_block
;

808 
Í
->
tx_cmd_lšk
 = 
tx_block
 + 20;

811 
Í
->
tx_h—d
 = 
tx_block
 + 
TX_BUF_SIZE
;

812 ià(
Í
->
tx_h—d
 > 
RX_BUF_START
 - 
TX_BUF_SIZE
)

813 
Í
->
tx_h—d
 = 
TX_BUF_START
;

815 ià(
Ãt_debug
 > 4) {

816 
	`´štk
("%s: 3c507 @%x send†ength = %d,x_block %3x,‚ext %3x.\n",

817 
dev
->
Çme
, 
ißddr
, 
Ëngth
, 
tx_block
, 
Í
->
tx_h—d
);

820 ià(
Í
->
tx_h—d
 !ğÍ->
tx_»­
)

821 
dev
->
tbusy
 = 0;

822 
	}
}

825 
	$–16_rx
(
deviû
 *
dev
)

827 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

828 *
shmem
 = (*)
dev
->
mem_¡¬t
;

829 
ushÜt
 
rx_h—d
 = 
Í
->rx_head;

830 
ushÜt
 
rx_
 = 
Í
->rx_tail;

831 
ushÜt
 
boguscouÁ
 = 10;

832 
äame_¡©us
;

834 (
äame_¡©us
 = 
shmem
[
rx_h—d
>>1]) < 0) {

835 
ushÜt
 *
»ad_äame
 = (*)(
dev
->
mem_¡¬t
 + 
rx_h—d
);

836 
ushÜt
 
rfd_cmd
 = 
»ad_äame
[1];

837 
ushÜt
 
Ãxt_rx_äame
 = 
»ad_äame
[2];

838 
ushÜt
 
d©a_bufãr_addr
 = 
»ad_äame
[3];

839 
ushÜt
 *
d©a_äame
 = (*)(
dev
->
mem_¡¬t
 + 
d©a_bufãr_addr
);

840 
ushÜt
 
pkt_Ën
 = 
d©a_äame
[0];

842 ià(
rfd_cmd
 !ğ0 || 
d©a_bufãr_addr
 !ğ
rx_h—d
 + 22

843 || 
pkt_Ën
 & 0xC000 != 0xC000) {

844 
	`´štk
("%s: Rx frame‡t %#x corrupted, status %04x cmd %04x"

845 "Ãxˆ%04x d©a-buà@%04x %04x.\n", 
dev
->
Çme
, 
rx_h—d
,

846 
äame_¡©us
, 
rfd_cmd
, 
Ãxt_rx_äame
, 
d©a_bufãr_addr
,

847 
pkt_Ën
);

848 } ià((
äame_¡©us
 & 0x2000) == 0) {

850 
Í
->
¡©s
.
rx_”rÜs
++;

851 ià(
äame_¡©us
 & 0x0800è
Í
->
¡©s
.
rx_üc_”rÜs
++;

852 ià(
äame_¡©us
 & 0x0400è
Í
->
¡©s
.
rx_äame_”rÜs
++;

853 ià(
äame_¡©us
 & 0x0200è
Í
->
¡©s
.
rx_fifo_”rÜs
++;

854 ià(
äame_¡©us
 & 0x0100è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

855 ià(
äame_¡©us
 & 0x0080è
Í
->
¡©s
.
rx_Ëngth_”rÜs
++;

858 
sksize
;

859 
sk_buff
 *
skb
;

861 
pkt_Ën
 &= 0x3fff;

862 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

863 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

864 ià(
skb
 =ğ
NULL
) {

865 
	`´štk
("%s: MemÜy squ“ze, drİpšg…ack‘.\n", 
dev
->
Çme
);

866 
Í
->
¡©s
.
rx_drİ³d
++;

869 
skb
->
mem_Ën
 = 
sksize
;

870 
skb
->
mem_addr
 = skb;

871 
skb
->
Ën
 = 
pkt_Ën
;

872 
skb
->
dev
 = dev;

875 
	`memıy
(
skb
->
d©a
, 
d©a_äame
 + 5, 
pkt_Ën
);

877 #ifdeà
HAVE_NETIF_RX


878 
	`Ãtif_rx
(
skb
);

880 
skb
->
lock
 = 0;

881 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

882 
	`kä“_skbmem
(
skb
, 
sksize
);

883 
Í
->
¡©s
.
rx_drİ³d
++;

887 
Í
->
¡©s
.
rx_·ck‘s
++;

891 
»ad_äame
[0] = 0;

892 
»ad_äame
[1] = 0xC000;

894 *(*)(
dev
->
mem_¡¬t
 + 
rx_
 + 2) = 0x0000;

896 
rx_
 = 
rx_h—d
;

897 
rx_h—d
 = 
Ãxt_rx_äame
;

898 ià(--
boguscouÁ
 == 0)

902 
Í
->
rx_h—d
 =„x_head;

903 
Í
->
rx_
 =„x_tail;

904 
	}
}

	@drivers/net/3c509.c

16 *
	gv”siÚ
 = "3c509.c:pl15k 3/5/94 becker@super.org\n";

18 
	~<lšux/cÚfig.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/sched.h
>

21 
	~<lšux/¡ršg.h
>

22 
	~<lšux/š‹¼u±.h
>

23 
	~<lšux/±¿û.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/š.h
>

26 
	~<lšux/m®loc.h
>

27 
	~<lšux/iİÜt.h
>

28 
	~<asm/b™İs.h
>

29 
	~<asm/io.h
>

31 
	~"dev.h
"

32 
	~"‘h.h
"

33 
	~"skbuff.h
"

34 
	~"¬p.h
"

36 #iâdeà
HAVE_ALLOC_SKB


37 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

41 #ifdeà
EL3_DEBUG


42 
	g–3_debug
 = 
EL3_DEBUG
;

44 
	g–3_debug
 = 2;

51 
	#EL3_DATA
 0x00

	)

52 
	#EL3_CMD
 0x0e

	)

53 
	#EL3_STATUS
 0x0e

	)

54 
	#ID_PORT
 0x100

	)

55 
	#EEPROM_READ
 0x80

	)

57 
	#EL3WINDOW
(
wš_num
è
	`outw
(0x0800+(wš_num), 
ißddr
 + 
EL3_CMD
)

	)

60 
	#TX_FIFO
 0x00

	)

61 
	#RX_FIFO
 0x00

	)

62 
	#RX_STATUS
 0x08

	)

63 
	#TX_STATUS
 0x0B

	)

64 
	#TX_FREE
 0x0C

	)

66 
	#WN4_MEDIA
 0x0A

	)

67 
	#MEDIA_TP
 0x00C0

	)

69 
	s–3_´iv©e
 {

70 
’‘_¡©i¡ics
 
	m¡©s
;

73 
ushÜt
 
id_»ad_“´om
(
šdex
);

74 
ushÜt
 
»ad_“´om
(
ißddr
, 
šdex
);

75 
–3_İ’
(
deviû
 *
dev
);

76 
–3_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

77 
–3_š‹¼u±
(
»g_±r
);

78 
upd©e_¡©s
(
addr
, 
deviû
 *
dev
);

79 
’‘_¡©i¡ics
 *
–3_g‘_¡©s
(
deviû
 *
dev
);

80 
–3_rx
(
deviû
 *
dev
);

81 
–3_şo£
(
deviû
 *
dev
);

82 #ifdeà
HAVE_MULTICAST


83 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

88 
	$–3_´obe
(
deviû
 *
dev
)

90 
Ìs_¡©e
 = 0xff, 
i
;

91 
ushÜt
 
ißddr
, 
œq
, 
if_pÜt
;

92 *
phys_addr
 = (*)
dev
->
dev_addr
;

93 
cu¼’t_g
 = 0;

96 ià(
EISA_bus
) {

97 
ißddr
 = 0x1000; ioaddr < 0x9000; ioaddr += 0x1000) {

98 ià(
	`šw
(
ißddr
) != 0x6d50)

101 
œq
 = 
	`šw
(
ißddr
 + 8) >> 12;

102 
if_pÜt
 = 
	`šw
(
ißddr
 + 6)>>14;

103 
i
 = 0; i < 3; i++)

104 
phys_addr
[
i
] = 
	`htÚs
(
	`»ad_“´om
(
ißddr
, i));

108 
	`»ad_“´om
(
ißddr
, 7);

111 
found
;

115 #ifdeà
CONFIG_MCA


116 ià(
MCA_bus
) {

117 
	`mÿ_ad­tÜ_£Ëù_mode
(1);

118 
i
 = 0; i < 8; i++)

119 ià((
	`mÿ_ad­tÜ_id
(
i
) | 1) == 0x627c) {

120 
ißddr
 = 
	`mÿ_pos_ba£_addr
(
i
);

121 
œq
 = 
	`šw
(
ißddr
 + 8) >> 12;

122 
if_pÜt
 = 
	`šw
(
ißddr
 + 6)>>14;

123 
i
 = 0; i < 3; i++)

124 
phys_addr
[
i
] = 
	`htÚs
(
	`»ad_“´om
(
ißddr
, i));

126 
	`mÿ_ad­tÜ_£Ëù_mode
(0);

127 
found
;

129 
	`mÿ_ad­tÜ_£Ëù_mode
(0);

135 
	`outb
(0x00, 
ID_PORT
);

136 
	`outb
(0x00, 
ID_PORT
);

137 
i
 = 0; i < 255; i++) {

138 
	`outb
(
Ìs_¡©e
, 
ID_PORT
);

139 
Ìs_¡©e
 <<= 1;

140 
Ìs_¡©e
 =†rs_state & 0x100 ?†rs_state ^ 0xcf :†rs_state;

144 ià(
cu¼’t_g
 == 0)

145 
	`outb
(0xd0, 
ID_PORT
);

147 
	`outb
(0xd8, 
ID_PORT
);

149 ià(
	`id_»ad_“´om
(7) != 0x6d50) {

150  -
ENODEV
;

156 
i
 = 0; i < 3; i++) {

157 
phys_addr
[
i
] = 
	`htÚs
(
	`id_»ad_“´om
(i));

161 
ioba£
 = 
	`id_»ad_“´om
(8);

162 
if_pÜt
 = 
ioba£
 >> 14;

163 
ißddr
 = 0x200 + ((
ioba£
 & 0x1f) << 4);

165 
œq
 = 
	`id_»ad_“´om
(9) >> 12;

170 ià(
dev
->
ba£_addr
 != 0

171 && 
dev
->
ba£_addr
 !ğ()
ißddr
) {

172  -
ENODEV
;

176 
	`outb
(0xd0 + ++
cu¼’t_g
, 
ID_PORT
);

179 
	`outb
(0xff, 
ID_PORT
);

181 
	`EL3WINDOW
(0);

182 ià(
	`šw
(
ißddr
) != 0x6d50)

183  -
ENODEV
;

185 
found
:

186 
dev
->
ba£_addr
 = 
ißddr
;

187 
dev
->
œq
 = irq;

188 
dev
->
if_pÜt
 = if_port;

189 
	`¢¬f_»giÚ
(
dev
->
ba£_addr
, 16);

192 *
if_Çmes
[] = {"10baseT", "AUI", "undefined", "BNC"};

193 
	`´štk
("%s: 3c509‡t %#3.3xag %d, %s…ort,‡ddress ",

194 
dev
->
Çme
, dev->
ba£_addr
, 
cu¼’t_g
, 
if_Çmes
[dev->
if_pÜt
]);

198 
i
 = 0; i < 6; i++)

199 
	`´štk
(" %2.2x", 
dev
->
dev_addr
[
i
]);

200 
	`´štk
(", IRQ %d.\n", 
dev
->
œq
);

203 
dev
->
´iv
 = 
	`km®loc
((
–3_´iv©e
), 
GFP_KERNEL
);

204 
	`mem£t
(
dev
->
´iv
, 0, (
–3_´iv©e
));

206 ià(
–3_debug
 > 0)

207 
	`´štk
(
v”siÚ
);

210 
dev
->
İ’
 = &
–3_İ’
;

211 
dev
->
h¬d_¡¬t_xm™
 = &
–3_¡¬t_xm™
;

212 
dev
->
¡İ
 = &
–3_şo£
;

213 
dev
->
g‘_¡©s
 = &
–3_g‘_¡©s
;

214 #ifdeà
HAVE_MULTICAST


215 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

219 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

220 
dev
->
buffs
[
i
] = 
NULL
;

222 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

223 
dev
->
add_¬p
 = 
‘h_add_¬p
;

224 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

225 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

226 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

228 
dev
->
ty³
 = 
ARPHRD_ETHER
;

229 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

230 
dev
->
mtu
 = 1500;

231 
dev
->
addr_Ën
 = 
ETH_ALEN
;

232 
i
 = 0; i < 
ETH_ALEN
; i++) {

233 
dev
->
brßdÿ¡
[
i
]=0xff;

237 
dev
->
æags
 = 
IFF_BROADCAST
;

238 
dev
->
çmy
 = 
AF_INET
;

239 
dev
->
·_addr
 = 0;

240 
dev
->
·_brdaddr
 = 0;

241 
dev
->
·_mask
 = 0;

242 
dev
->
·_®’
 = ();

245 
	}
}

250 
ushÜt
 
	$»ad_“´om
(
ißddr
, 
šdex
)

252 
tim”
;

254 
	`outw
(
EEPROM_READ
 + 
šdex
, 
ißddr
 + 10);

256 
tim”
 = 0;imer < 162*4 + 400;imer++)

257 
SLOW_DOWN_IO
;

258  
	`šw
(
ißddr
 + 12);

259 
	}
}

262 
ushÜt
 
	$id_»ad_“´om
(
šdex
)

264 
tim”
, 
b™
, 
wÜd
 = 0;

268 
	`outb
(
EEPROM_READ
 + 
šdex
, 
ID_PORT
);

271 
tim”
 = 0;imer < 162*4 + 400;imer++)

272 
SLOW_DOWN_IO
;

274 
b™
 = 15; bit >= 0; bit--)

275 
wÜd
 = (wÜd << 1è+ (
	`šb
(
ID_PORT
) & 0x01);

277 ià(
–3_debug
 > 3)

278 
	`´štk
(" 3c509 EEPROM wÜd %d %#4.4x.\n", 
šdex
, 
wÜd
);

280  
wÜd
;

281 
	}
}

286 
	$–3_İ’
(
deviû
 *
dev
)

288 
ißddr
 = 
dev
->
ba£_addr
;

289 
i
;

291 ià(
	`»que¡_œq
(
dev
->
œq
, &
–3_š‹¼u±
)) {

292  -
EAGAIN
;

295 
	`EL3WINDOW
(0);

296 ià(
–3_debug
 > 3)

297 
	`´štk
("%s: O³nšg, IRQ %d stus@%x %4.4x.\n", 
dev
->
Çme
,

298 
dev
->
œq
, 
ißddr
 + 
EL3_STATUS
, 
	`šw
(ioaddr + EL3_STATUS));

301 
	`outw
(0x0001, 
ißddr
 + 4);

303 
œq2dev_m­
[
dev
->
œq
] = dev;

306 
	`outw
((
dev
->
œq
 << 12è| 0x0f00, 
ißddr
 + 8);

309 
	`EL3WINDOW
(2);

311 
i
 = 0; i < 6; i++)

312 
	`outb
(
dev
->
dev_addr
[
i
], 
ißddr
 + i);

314 ià(
dev
->
if_pÜt
 == 3)

316 
	`outw
(0x1000, 
ißddr
 + 
EL3_CMD
);

317 ià(
dev
->
if_pÜt
 == 0) {

319 
	`EL3WINDOW
(4);

320 
	`outw
(
	`šw
(
ißddr
 + 
WN4_MEDIA
è| 
MEDIA_TP
, ioaddr + WN4_MEDIA);

324 
	`EL3WINDOW
(1);

326 
	`outw
(0x8005, 
ißddr
 + 
EL3_CMD
);

327 
	`outw
(0xA800, 
ißddr
 + 
EL3_CMD
);

328 
	`outw
(0x2000, 
ißddr
 + 
EL3_CMD
);

329 
	`outw
(0x4800, 
ißddr
 + 
EL3_CMD
);

330 
	`outw
(0x78ff, 
ißddr
 + 
EL3_CMD
);

331 
dev
->
š‹¼u±
 = 0;

332 
dev
->
tbusy
 = 0;

333 
dev
->
¡¬t
 = 1;

334 
	`outw
(0x7098, 
ißddr
 + 
EL3_CMD
);

336 ià(
–3_debug
 > 3)

337 
	`´štk
("%s: Opened 3c509 IRQ %d status %4.4x.\n",

338 
dev
->
Çme
, dev->
œq
, 
	`šw
(
ißddr
 + 
EL3_STATUS
));

341 
	}
}

344 
	$–3_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

346 
–3_´iv©e
 *
Í
 = (–3_´iv©*)
dev
->
´iv
;

347 
ißddr
 = 
dev
->
ba£_addr
;

350 ià(
dev
->
tbusy
) {

351 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

352 ià(
tickssoçr
 < 10)

354 
	`´štk
("%s:ransmitimed out,x_status %2.2x status %4.4x.\n",

355 
dev
->
Çme
, 
	`šb
(
ißddr
 + 
TX_STATUS
), 
	`šw
(ißdd¸+ 
EL3_STATUS
));

356 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

358 
	`outw
(0x5800, 
ißddr
 + 
EL3_CMD
);

359 
	`outw
(0x4800, 
ißddr
 + 
EL3_CMD
);

360 
dev
->
tbusy
 = 0;

363 ià(
skb
 =ğ
NULL
) {

364 
	`dev_tšt
(
dev
);

369 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

370 
skb
->
dev
 = dev;

371 
	`¬p_queue
 (
skb
);

374 
skb
->
¬p
=1;

376 ià(
skb
->
Ën
 <= 0)

379 ià(
–3_debug
 > 4) {

380 
	`´štk
("%s:ƒl3_start_xmit(lenght = %ld) called, status %4.4x.\n",

381 
dev
->
Çme
, 
skb
->
Ën
, 
	`šw
(
ißddr
 + 
EL3_STATUS
));

383 #iâdeà
fš®_v”siÚ


385 
ushÜt
 
¡©us
 = 
	`šw
(
ißddr
 + 
EL3_STATUS
);

386 ià(
¡©us
 & 0x0001

387 && 
	`šw
(
ißddr
 + 
EL3_STATUS
) & 1) {

388 
	`´štk
("%s: Missed interrupt, statushen %04x‚ow %04x"

389 " Tx %2.2x Rx %4.4x.\n", 
dev
->
Çme
, 
¡©us
,

390 
	`šw
(
ißddr
 + 
EL3_STATUS
), 
	`šb
(ißdd¸+ 
TX_STATUS
),

391 
	`šw
(
ißddr
 + 
RX_STATUS
));

392 
	`outw
(0x7800, 
ißddr
 + 
EL3_CMD
);

393 
	`outw
(0x6899, 
ißddr
 + 
EL3_CMD
);

394 
	`outw
(0x78ff, 
ißddr
 + 
EL3_CMD
);

400 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

401 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

404 
	`outw
(
skb
->
Ën
, 
ißddr
 + 
TX_FIFO
);

405 
	`outw
(0x00, 
ißddr
 + 
TX_FIFO
);

407 
	`out¦
(
ißddr
 + 
TX_FIFO
, 
skb
->
d©a
, (skb->
Ën
 + 3) >> 2);

409 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

410 ià(
	`šw
(
ißddr
 + 
TX_FREE
) > 1536) {

411 
dev
->
tbusy
=0;

414 
	`outw
(0x9000 + 1536, 
ißddr
 + 
EL3_CMD
);

417 ià(
skb
->
ä“
)

418 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

422 
tx_¡©us
;

423 
i
 = 4;

425 --
i
 > 0 && (
tx_¡©us
 = 
	`šb
(
ißddr
 + 
TX_STATUS
)) > 0) {

426 ià(
–3_debug
 > 5)

427 
	`´štk
(" Tx stu %4.4x.\n", 
tx_¡©us
);

428 ià(
tx_¡©us
 & 0x38è
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

429 ià(
tx_¡©us
 & 0x30è
	`outw
(0x5800, 
ißddr
 + 
EL3_CMD
);

430 ià(
tx_¡©us
 & 0x3Cè
	`outw
(0x4800, 
ißddr
 + 
EL3_CMD
);

431 
	`outb
(0x00, 
ißddr
 + 
TX_STATUS
);

435 
	}
}

439 
	$–3_š‹¼u±
(
»g_±r
)

441 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

442 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

443 
ißddr
, 
¡©us
;

444 
i
 = 0;

446 ià(
dev
 =ğ
NULL
) {

447 
	`´štk
 ("–3_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

451 ià(
dev
->
š‹¼u±
)

452 
	`´štk
("%s: Re-’‹ršghš‹¼u± hªdËr.\n", 
dev
->
Çme
);

453 
dev
->
š‹¼u±
 = 1;

455 
ißddr
 = 
dev
->
ba£_addr
;

456 
¡©us
 = 
	`šw
(
ißddr
 + 
EL3_STATUS
);

458 ià(
–3_debug
 > 4)

459 
	`´štk
("%s: iÁ”ru±, stu %4.4x.\n", 
dev
->
Çme
, 
¡©us
);

461 (
¡©us
 = 
	`šw
(
ißddr
 + 
EL3_STATUS
)) & 0x01) {

463 ià(
¡©us
 & 0x10)

464 
	`–3_rx
(
dev
);

466 ià(
¡©us
 & 0x08) {

467 ià(
–3_debug
 > 5)

468 
	`´štk
(" TX„oom bit was handled.\n");

470 
	`outw
(0x6808, 
ißddr
 + 
EL3_CMD
);

471 
dev
->
tbusy
 = 0;

472 
	`m¬k_bh
(
INET_BH
);

474 ià(
¡©us
 & 0x80)

475 
	`upd©e_¡©s
(
ißddr
, 
dev
);

477 ià(++
i
 > 10) {

478 
	`´štk
("%s: Infinite†oop in interrupt, status %4.4x.\n",

479 
dev
->
Çme
, 
¡©us
);

481 
	`outw
(0x68FF, 
ißddr
 + 
EL3_CMD
);

485 
	`outw
(0x6891, 
ißddr
 + 
EL3_CMD
);

488 ià(
–3_debug
 > 4) {

489 
	`´štk
("%s:ƒx™šg iÁ”ru±, stu %4.4x.\n", 
dev
->
Çme
,

490 
	`šw
(
ißddr
 + 
EL3_STATUS
));

493 
dev
->
š‹¼u±
 = 0;

495 
	}
}

498 
’‘_¡©i¡ics
 *

499 
	$–3_g‘_¡©s
(
deviû
 *
dev
)

501 
–3_´iv©e
 *
Í
 = (–3_´iv©*)
dev
->
´iv
;

503 
	`¡i
();

504 
	`upd©e_¡©s
(
dev
->
ba£_addr
, dev);

505 
	`şi
();

506  &
Í
->
¡©s
;

507 
	}
}

514 
	$upd©e_¡©s
(
ißddr
, 
deviû
 *
dev
)

516 
–3_´iv©e
 *
Í
 = (–3_´iv©*)
dev
->
´iv
;

518 ià(
–3_debug
 > 5)

519 
	`´štk
(" Updatinghe statistics.\n");

521 
	`outw
(0xB000, 
ißddr
 + 
EL3_CMD
);

523 
	`EL3WINDOW
(6);

524 
Í
->
¡©s
.
tx_ÿ¼›r_”rÜs
 +ğ
	`šb
(
ißddr
 + 0);

525 
Í
->
¡©s
.
tx_h—¹b—t_”rÜs
 +ğ
	`šb
(
ißddr
 + 1);

526  
	`šb
(
ißddr
 + 2);

527 
Í
->
¡©s
.
cŞlisiÚs
 +ğ
	`šb
(
ißddr
 + 3);

528 
Í
->
¡©s
.
tx_wšdow_”rÜs
 +ğ
	`šb
(
ißddr
 + 4);

529 
Í
->
¡©s
.
rx_fifo_”rÜs
 +ğ
	`šb
(
ißddr
 + 5);

530 
Í
->
¡©s
.
tx_·ck‘s
 +ğ
	`šb
(
ißddr
 + 6);

531 
Í
->
¡©s
.
rx_·ck‘s
 +ğ
	`šb
(
ißddr
 + 7);

532  
	`šb
(
ißddr
 + 8);

533 
	`šw
(
ißddr
 + 10);

534 
	`šw
(
ißddr
 + 12);

537 
	`EL3WINDOW
(1);

538 
	`outw
(0xA800, 
ißddr
 + 
EL3_CMD
);

540 
	}
}

543 
	$–3_rx
(
deviû
 *
dev
)

545 
–3_´iv©e
 *
Í
 = (–3_´iv©*)
dev
->
´iv
;

546 
ißddr
 = 
dev
->
ba£_addr
;

547 
rx_¡©us
;

549 ià(
–3_debug
 > 5)

550 
	`´štk
(" In„x_packet(), status %4.4x,„x_status %4.4x.\n",

551 
	`šw
(
ißddr
+
EL3_STATUS
), inw(ißddr+
RX_STATUS
));

552 (
rx_¡©us
 = 
	`šw
(
ißddr
 + 
RX_STATUS
)) > 0) {

553 ià(
rx_¡©us
 & 0x4000) {

554 
”rÜ
 = 
rx_¡©us
 & 0x3800;

555 
Í
->
¡©s
.
rx_”rÜs
++;

556 
”rÜ
) {

557 0x0000: 
Í
->
¡©s
.
rx_ov”_”rÜs
++; ;

558 0x0800: 
Í
->
¡©s
.
rx_Ëngth_”rÜs
++; ;

559 0x1000: 
Í
->
¡©s
.
rx_äame_”rÜs
++; ;

560 0x1800: 
Í
->
¡©s
.
rx_Ëngth_”rÜs
++; ;

561 0x2000: 
Í
->
¡©s
.
rx_äame_”rÜs
++; ;

562 0x2800: 
Í
->
¡©s
.
rx_üc_”rÜs
++; ;

565 iàĞ(! (
rx_¡©us
 & 0x4000))

566 || ! (
rx_¡©us
 & 0x1000)) {

567 
pkt_Ën
 = 
rx_¡©us
 & 0x7ff;

568 
sksize
 = (
sk_buff
è+ 
pkt_Ën
 + 3;

569 
sk_buff
 *
skb
;

571 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

572 ià(
–3_debug
 > 4)

573 
	`´štk
(" Receiving…acket size %d status %4.4x.\n",

574 
pkt_Ën
, 
rx_¡©us
);

575 ià(
skb
 !ğ
NULL
) {

576 
skb
->
mem_Ën
 = 
sksize
;

577 
skb
->
mem_addr
 = skb;

578 
skb
->
Ën
 = 
pkt_Ën
;

579 
skb
->
dev
 = dev;

582 
	`š¦
(
ißddr
+
RX_FIFO
, 
skb
->
d©a
,

583 (
pkt_Ën
 + 3) >> 2);

585 #ifdeà
HAVE_NETIF_RX


586 
	`Ãtif_rx
(
skb
);

587 
	`outw
(0x4000, 
ißddr
 + 
EL3_CMD
);

590 
skb
->
lock
 = 0;

591 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
,

592 
IN_SKBUFF
,
dev
)== 0){

593 ià(
–3_debug
 > 6)

594 
	`´štk
(" dev_rint() happy, status %4.4x.\n",

595 
	`šb
(
ißddr
 + 
EL3_STATUS
));

596 
	`outw
(0x4000, 
ißddr
 + 
EL3_CMD
);

597 
	`šw
(
ißddr
 + 
EL3_STATUS
) & 0x1000)

598 
	`´štk
(" Waiting for 3c509o discard…acket, status %x.\n",

599 
	`šw
(
ißddr
 + 
EL3_STATUS
) );

600 ià(
–3_debug
 > 6)

601 
	`´štk
(" discarded…acket, status %4.4x.\n",

602 
	`šb
(
ißddr
 + 
EL3_STATUS
));

605 
	`´štk
("%s:„eûivbufãr fuÎ.\n", 
dev
->
Çme
);

606 
	`kä“_s
(
skb
, 
sksize
);

609 } ià(
–3_debug
)

610 
	`´štk
("%s: Couldn't‡llocate‡ sk_buff of size %d.\n",

611 
dev
->
Çme
, 
sksize
);

613 
Í
->
¡©s
.
rx_drİ³d
++;

614 
	`outw
(0x4000, 
ißddr
 + 
EL3_CMD
);

615 
	`šw
(
ißddr
 + 
EL3_STATUS
) & 0x1000)

616 
	`´štk
(" Waiting for 3c509o discard…acket, status %x.\n",

617 
	`šw
(
ißddr
 + 
EL3_STATUS
) );

620 ià(
–3_debug
 > 5)

621 
	`´štk
(" Exiting„x_packet(), status %4.4x,„x_status %4.4x.\n",

622 
	`šw
(
ißddr
+
EL3_STATUS
), inw(ioaddr+8));

625 
	}
}

627 #ifdeà
HAVE_MULTICAST


635 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

637 
ißddr
 = 
dev
->
ba£_addr
;

638 ià(
num_addrs
 > 0) {

639 
	`outw
(0x8007, 
ißddr
 + 
EL3_CMD
);

640 } ià(
num_addrs
 < 0) {

641 
	`outw
(0x8008, 
ißddr
 + 
EL3_CMD
);

643 
	`outw
(0x8005, 
ißddr
 + 
EL3_CMD
);

644 
	}
}

648 
	$–3_şo£
(
deviû
 *
dev
)

650 
ißddr
 = 
dev
->
ba£_addr
;

652 ià(
–3_debug
 > 2)

653 
	`´štk
("%s: Shu‰šg dowÀ‘h”ÿrd.\n", 
dev
->
Çme
);

655 
dev
->
tbusy
 = 1;

656 
dev
->
¡¬t
 = 0;

659 
	`outw
(0xB000, 
ißddr
 + 
EL3_CMD
);

662 
	`outw
(0x1800, 
ißddr
 + 
EL3_CMD
);

663 
	`outw
(0x5000, 
ißddr
 + 
EL3_CMD
);

665 ià(
dev
->
if_pÜt
 == 3)

667 
	`outw
(0xb800, 
ißddr
 + 
EL3_CMD
);

668 ià(
dev
->
if_pÜt
 == 0) {

670 
	`EL3WINDOW
(4);

671 
	`outw
(
	`šw
(
ißddr
 + 
WN4_MEDIA
è& ~
MEDIA_TP
, ioaddr + WN4_MEDIA);

674 
	`ä“_œq
(
dev
->
œq
);

676 
	`EL3WINDOW
(0);

678 
	`outw
(0x0f00, 
ißddr
 + 8);

681 
œq2dev_m­
[
dev
->
œq
] = 0;

683 
	`upd©e_¡©s
(
ißddr
, 
dev
);

685 
	}
}

	@drivers/net/8390.c

18 *
	gv”siÚ
 =

20 
	~<lšux/cÚfig.h
>

34 
	~<lšux/cÚfig.h
>

35 
	~<lšux/k”Ãl.h
>

36 
	~<lšux/sched.h
>

37 
	~<lšux/fs.h
>

38 
	~<lšux/ty³s.h
>

39 
	~<lšux/±¿û.h
>

40 
	~<lšux/¡ršg.h
>

41 
	~<asm/sy¡em.h
>

42 
	~<asm/£gm’t.h
>

43 
	~<asm/b™İs.h
>

44 
	~<asm/io.h
>

45 
	~<”ºo.h
>

46 
	~<lšux/fú.h
>

47 
	~<lšux/š.h
>

48 
	~<lšux/š‹¼u±.h
>

50 
	~"dev.h
"

51 
	~"‘h.h
"

52 
	~".h
"

53 
	~"´ÙocŞ.h
"

54 
	~"tı.h
"

55 
	~"skbuff.h
"

56 
	~"sock.h
"

57 
	~"¬p.h
"

59 
	~"8390.h
"

77 
	#ei_»£t_8390
 (
ei_loÿl
->
»£t_8390
)

	)

78 
	#ei_block_ouut
 (
ei_loÿl
->
block_ouut
)

	)

79 
	#ei_block_šput
 (
ei_loÿl
->
block_šput
)

	)

82 #ifdeà
EI_DEBUG


83 
	gei_debug
 = 
EI_DEBUG
;

85 
	gei_debug
 = 1;

90 
	ghigh_w©”_m¬k
 = 0;

93 
ei_İ’
(
deviû
 *
dev
);

94 
ei_š‹¼u±
(
»g_±r
);

96 
ei_tx_šŒ
(
deviû
 *
dev
);

97 
ei_»ûive
(
deviû
 *
dev
);

98 
ei_rx_ov”run
(
deviû
 *
dev
);

101 
NS8390_š™
(
deviû
 *
dev
, 
¡¬
);

102 
NS8390_Œigg”_£nd
(
deviû
 *
dev
, 
Ëngth
,

103 
¡¬t_·ge
);

104 #ifdeà
HAVE_MULTICAST


105 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

108 
sigaùiÚ
 
	gei_sigaùiÚ
 = { 
ei_š‹¼u±
, 0, 0, 
NULL
, };

114 
	$ei_İ’
(
deviû
 *
dev
)

116 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

118 iàĞ! 
ei_loÿl
) {

119 
	`´štk
("%s: O³nšg‡‚Ú-exi¡’ˆphysiÿÈdeviû\n", 
dev
->
Çme
);

120  
ENXIO
;

123 
œq2dev_m­
[
dev
->
œq
] = dev;

124 
	`NS8390_š™
(
dev
, 1);

125 
dev
->
¡¬t
 = 1;

126 
ei_loÿl
->
œqlock
 = 0;

128 
	}
}

130 
	$ei_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

132 
e8390_ba£
 = 
dev
->
ba£_addr
;

133 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

134 
Ëngth
, 
£nd_Ëngth
;

141 ià(
dev
->
tbusy
) {

142 
tx¤
 = 
	`šb
(
e8390_ba£
+
EN0_TSR
), 
i¤
;

143 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

144 ià(
tickssoçr
 < 10 || (tickssoç¸< 15 && ! (
tx¤
 & 
ENTSR_PTX
))) {

147 
i¤
 = 
	`šb
(
e8390_ba£
+
EN0_ISR
);

148 
	`´štk
("%s:ransmitimed out, TX status %#2x, ISR %#2x.\n",

149 
dev
->
Çme
, 
tx¤
, 
i¤
);

151 ià(
i¤
)

152 
	`´štk
("%s: PossibË IRQ cÚæiù oÀIRQ%d?\n", 
dev
->
Çme
, dev->
œq
);

155 
	`´štk
("%s: PossibË‚‘wÜk cabË…robËm?\n", 
dev
->
Çme
);

156 
ei_loÿl
->
š‹rçû_num
 ^= 1;

159 
	`ei_»£t_8390
(
dev
);

160 
	`NS8390_š™
(
dev
, 1);

161 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

167 ià(
skb
 =ğ
NULL
) {

168 
	`dev_tšt
(
dev
);

172 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

173 
skb
->
dev
 = dev;

174 
	`¬p_queue
 (
skb
);

177 
skb
->
¬p
=1;

179 
Ëngth
 = 
skb
->
Ën
;

180 ià(
skb
->
Ën
 <= 0)

184 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0) {

185 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

190 
	`outb
(0x00, 
e8390_ba£
 + 
EN0_IMR
);

191 
ei_loÿl
->
œqlock
 = 1;

193 
£nd_Ëngth
 = 
ETH_ZLEN
 < 
Ëngth
 ?†ength : ETH_ZLEN;

195 ià(
ei_loÿl
->
pšgpÚg
) {

196 
ouut_·ge
;

197 ià(
ei_loÿl
->
tx1
 == 0) {

198 
ouut_·ge
 = 
ei_loÿl
->
tx_¡¬t_·ge
;

199 
ei_loÿl
->
tx1
 = 
£nd_Ëngth
;

200 ià(
ei_debug
 && 
ei_loÿl
->
tx2
 > 0)

201 
	`´štk
("%s: idleransmitterx2=%d,†asttx=%d,xing=%d.\n",

202 
dev
->
Çme
, 
ei_loÿl
->
tx2
,ƒi_loÿl->
Ï¡tx
,

203 
ei_loÿl
->
txšg
);

204 } ià(
ei_loÿl
->
tx2
 == 0) {

205 
ouut_·ge
 = 
ei_loÿl
->
tx_¡¬t_·ge
 + 6;

206 
ei_loÿl
->
tx2
 = 
£nd_Ëngth
;

207 ià(
ei_debug
 && 
ei_loÿl
->
tx1
 > 0)

208 
	`´štk
("%s: idleransmitter,x1=%d,†asttx=%d,xing=%d.\n",

209 
dev
->
Çme
, 
ei_loÿl
->
tx1
,ƒi_loÿl->
Ï¡tx
,

210 
ei_loÿl
->
txšg
);

212 ià(
ei_debug
)

213 
	`´štk
("%s: No…acket buffer space for…ing-pong use.\n",

214 
dev
->
Çme
);

215 
ei_loÿl
->
œqlock
 = 0;

216 
dev
->
tbusy
 = 1;

217 
	`outb_p
(
ENISR_ALL
, 
e8390_ba£
 + 
EN0_IMR
);

220 
	`ei_block_ouut
(
dev
, 
Ëngth
, 
skb
->
d©a
, 
ouut_·ge
);

221 ià(! 
ei_loÿl
->
txšg
) {

222 
	`NS8390_Œigg”_£nd
(
dev
, 
£nd_Ëngth
, 
ouut_·ge
);

223 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

224 ià(
ouut_·ge
 =ğ
ei_loÿl
->
tx_¡¬t_·ge
)

225 
ei_loÿl
->
tx1
 = -1,ƒi_loÿl->
Ï¡tx
 = -1;

227 
ei_loÿl
->
tx2
 = -1,ƒi_loÿl->
Ï¡tx
 = -2;

228 
ei_loÿl
->
txšg
 = 1;

230 
ei_loÿl
->
txqueue
++;

232 
dev
->
tbusy
 = (
ei_loÿl
->
tx1
 &&ƒi_loÿl->
tx2
);

234 
	`ei_block_ouut
(
dev
, 
Ëngth
, 
skb
->
d©a
, 
ei_loÿl
->
tx_¡¬t_·ge
);

235 
	`NS8390_Œigg”_£nd
(
dev
, 
£nd_Ëngth
, 
ei_loÿl
->
tx_¡¬t_·ge
);

236 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

237 
dev
->
tbusy
 = 1;

241 
ei_loÿl
->
œqlock
 = 0;

242 
	`outb_p
(
ENISR_ALL
, 
e8390_ba£
 + 
EN0_IMR
);

244 ià(
skb
->
ä“
)

245 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

248 
	}
}

252 
	$ei_š‹¼u±
(
»g_±r
)

254 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

255 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

256 
e8390_ba£
;

257 
š‹¼u±s
, 
boguscouÁ
 = 0;

258 
ei_deviû
 *
ei_loÿl
;

260 ià(
dev
 =ğ
NULL
) {

261 
	`´štk
 ("Ãt_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

264 
e8390_ba£
 = 
dev
->
ba£_addr
;

265 
ei_loÿl
 = (
ei_deviû
 *è
dev
->
´iv
;

266 ià(
dev
->
š‹¼u±
 || 
ei_loÿl
->
œqlock
) {

268 
	`¡i
();

269 
	`´štk
(
ei_loÿl
->
œqlock


272 
dev
->
Çme
, 
	`šb_p
(
e8390_ba£
 + 
EN0_ISR
),

273 
	`šb_p
(
e8390_ba£
 + 
EN0_IMR
));

277 
dev
->
š‹¼u±
 = 1;

278 
	`¡i
();

281 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
, 
e8390_ba£
 + 
E8390_CMD
);

282 ià(
ei_debug
 > 3)

283 
	`´štk
("%s: iÁ”ru±(i¤=%#2.2x).\n", 
dev
->
Çme
,

284 
	`šb_p
(
e8390_ba£
 + 
EN0_ISR
));

287 (
š‹¼u±s
 = 
	`šb_p
(
e8390_ba£
 + 
EN0_ISR
)) != 0

288 && ++
boguscouÁ
 < 5) {

289 ià(
š‹¼u±s
 & 
ENISR_RDC
) {

291 
	`outb_p
(
ENISR_RDC
, 
e8390_ba£
 + 
EN0_ISR
);

293 ià(
š‹¼u±s
 & 
ENISR_OVER
) {

294 
	`ei_rx_ov”run
(
dev
);

295 } ià(
š‹¼u±s
 & (
ENISR_RX
+
ENISR_RX_ERR
)) {

297 
	`ei_»ûive
(
dev
);

300 ià(
š‹¼u±s
 & 
ENISR_TX
) {

301 
	`ei_tx_šŒ
(
dev
);

302 } ià(
š‹¼u±s
 & 
ENISR_COUNTERS
) {

303 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

304 
ei_loÿl
->
¡©
.
rx_äame_”rÜs
 +ğ
	`šb_p
(
e8390_ba£
 + 
EN0_COUNTER0
);

305 
ei_loÿl
->
¡©
.
rx_üc_”rÜs
 +ğ
	`šb_p
(
e8390_ba£
 + 
EN0_COUNTER1
);

306 
ei_loÿl
->
¡©
.
rx_mis£d_”rÜs
+ğ
	`šb_p
(
e8390_ba£
 + 
EN0_COUNTER2
);

307 
	`outb_p
(
ENISR_COUNTERS
, 
e8390_ba£
 + 
EN0_ISR
);

311 ià(
š‹¼u±s
 & 
ENISR_TX_ERR
) {

312 
	`outb_p
(
ENISR_TX_ERR
, 
e8390_ba£
 + 
EN0_ISR
);

314 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_START
, 
e8390_ba£
 + 
E8390_CMD
);

317 ià(
š‹¼u±s
 && 
ei_debug
) {

318 
	`´štk
("%s: unknowÀš‹¼u± %#2x\n", 
dev
->
Çme
, 
š‹¼u±s
);

319 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_START
, 
e8390_ba£
 + 
E8390_CMD
);

320 
	`outb_p
(0xff, 
e8390_ba£
 + 
EN0_ISR
);

322 
dev
->
š‹¼u±
 = 0;

324 
	}
}

328 
	$ei_tx_šŒ
(
deviû
 *
dev
)

330 
e8390_ba£
 = 
dev
->
ba£_addr
;

331 
¡©us
 = 
	`šb
(
e8390_ba£
 + 
EN0_TSR
);

332 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

334 
	`outb_p
(
ENISR_TX
, 
e8390_ba£
 + 
EN0_ISR
);

336 ià(
ei_loÿl
->
pšgpÚg
) {

337 
ei_loÿl
->
txqueue
--;

338 ià(
ei_loÿl
->
tx1
 < 0) {

339 ià(
ei_loÿl
->
Ï¡tx
 != 1 &&ƒi_local->lasttx != -1)

340 
	`´štk
("%s: bogus†ast_tx_buffer %d,x1=%d.\n",

341 
ei_loÿl
->
Çme
,ƒi_loÿl->
Ï¡tx
,ƒi_loÿl->
tx1
);

342 
ei_loÿl
->
tx1
 = 0;

343 
dev
->
tbusy
 = 0;

344 ià(
ei_loÿl
->
tx2
 > 0) {

345 
	`NS8390_Œigg”_£nd
(
dev
, 
ei_loÿl
->
tx2
,ƒi_loÿl->
tx_¡¬t_·ge
 + 6);

346 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

347 
ei_loÿl
->
txšg
 = 1;

348 
ei_loÿl
->
tx2
 = -1,

349 
ei_loÿl
->
Ï¡tx
 = 2;

351 
ei_loÿl
->
Ï¡tx
 = 20,ƒi_loÿl->
txšg
 = 0;

352 } ià(
ei_loÿl
->
tx2
 < 0) {

353 ià(
ei_loÿl
->
Ï¡tx
 != 2 &&ƒi_local->lasttx != -2)

354 
	`´štk
("%s: bogus†ast_tx_buffer %d,x2=%d.\n",

355 
ei_loÿl
->
Çme
,ƒi_loÿl->
Ï¡tx
,ƒi_loÿl->
tx2
);

356 
ei_loÿl
->
tx2
 = 0;

357 
dev
->
tbusy
 = 0;

358 ià(
ei_loÿl
->
tx1
 > 0) {

359 
	`NS8390_Œigg”_£nd
(
dev
, 
ei_loÿl
->
tx1
,ƒi_loÿl->
tx_¡¬t_·ge
);

360 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

361 
ei_loÿl
->
txšg
 = 1;

362 
ei_loÿl
->
tx1
 = -1;

363 
ei_loÿl
->
Ï¡tx
 = 1;

365 
ei_loÿl
->
Ï¡tx
 = 10,ƒi_loÿl->
txšg
 = 0;

367 
	`´štk
("%s: unexpected TX-done interrupt,†asttx=%d.\n",

368 
dev
->
Çme
, 
ei_loÿl
->
Ï¡tx
);

370 
ei_loÿl
->
txšg
 = 0;

371 
dev
->
tbusy
 = 0;

375 ià(
¡©us
 & 
ENTSR_COL
è
ei_loÿl
->
¡©
.
cŞlisiÚs
++;

376 ià(
¡©us
 & 
ENTSR_PTX
)

377 
ei_loÿl
->
¡©
.
tx_·ck‘s
++;

379 
ei_loÿl
->
¡©
.
tx_”rÜs
++;

380 ià(
¡©us
 & 
ENTSR_ABT
è
ei_loÿl
->
¡©
.
tx_abÜ‹d_”rÜs
++;

381 ià(
¡©us
 & 
ENTSR_CRS
è
ei_loÿl
->
¡©
.
tx_ÿ¼›r_”rÜs
++;

382 ià(
¡©us
 & 
ENTSR_FU
è
ei_loÿl
->
¡©
.
tx_fifo_”rÜs
++;

383 ià(
¡©us
 & 
ENTSR_CDH
è
ei_loÿl
->
¡©
.
tx_h—¹b—t_”rÜs
++;

384 ià(
¡©us
 & 
ENTSR_OWC
è
ei_loÿl
->
¡©
.
tx_wšdow_”rÜs
++;

387 
	`m¬k_bh
 (
INET_BH
);

388 
	}
}

392 
	$ei_»ûive
(
deviû
 *
dev
)

394 
e8390_ba£
 = 
dev
->
ba£_addr
;

395 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

396 
rxšg_·ge
, 
this_äame
, 
Ãxt_äame
, 
cu¼’t_off£t
;

397 
rx_pkt_couÁ
 = 0;

398 
e8390_pkt_hdr
 
rx_äame
;

399 
num_rx_·ges
 = 
ei_loÿl
->
¡İ_·ge
-ei_loÿl->
rx_¡¬t_·ge
;

401 ++
rx_pkt_couÁ
 < 10) {

402 
pkt_Ën
;

405 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE1
, 
e8390_ba£
 + 
E8390_CMD
);

406 
rxšg_·ge
 = 
	`šb_p
(
e8390_ba£
 + 
EN1_CURPAG
);

407 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
, 
e8390_ba£
 + 
E8390_CMD
);

410 
this_äame
 = 
	`šb_p
(
e8390_ba£
 + 
EN0_BOUNDARY
) + 1;

411 ià(
this_äame
 >ğ
ei_loÿl
->
¡İ_·ge
)

412 
this_äame
 = 
ei_loÿl
->
rx_¡¬t_·ge
;

416 ià(
ei_debug
 > 0 && 
this_äame
 !ğ
ei_loÿl
->
cu¼’t_·ge
)

417 
	`´štk
("%s: mismatched„ead…age…ointers %2x vs %2x.\n",

418 
dev
->
Çme
, 
this_äame
, 
ei_loÿl
->
cu¼’t_·ge
);

420 ià(
this_äame
 =ğ
rxšg_·ge
)

423 
cu¼’t_off£t
 = 
this_äame
 << 8;

424 
	`ei_block_šput
(
dev
, (
rx_äame
), (*)&rx_frame,

425 
cu¼’t_off£t
);

427 
pkt_Ën
 = 
rx_äame
.
couÁ
 - (rx_frame);

429 
Ãxt_äame
 = 
this_äame
 + 1 + ((
pkt_Ën
+4)>>8);

434 ià(
rx_äame
.
Ãxt
 !ğ
Ãxt_äame


435 && 
rx_äame
.
Ãxt
 !ğ
Ãxt_äame
 + 1

436 && 
rx_äame
.
Ãxt
 !ğ
Ãxt_äame
 - 
num_rx_·ges


437 && 
rx_äame
.
Ãxt
 !ğ
Ãxt_äame
 + 1 - 
num_rx_·ges
) {

438 
ei_loÿl
->
cu¼’t_·ge
 = 
rxšg_·ge
;

439 
	`outb
(
ei_loÿl
->
cu¼’t_·ge
-1, 
e8390_ba£
+
EN0_BOUNDARY
);

440 
ei_loÿl
->
¡©
.
rx_”rÜs
++;

444 ià(
pkt_Ën
 < 60 ||…kt_len > 1518) {

445 ià(
ei_debug
)

446 
	`´štk
("%s: bogus…acket size: %d, status=%#2x‚xpg=%#2x.\n",

447 
dev
->
Çme
, 
rx_äame
.
couÁ
,„x_äame.
¡©us
,

448 
rx_äame
.
Ãxt
);

449 
ei_loÿl
->
¡©
.
rx_”rÜs
++;

450 } ià((
rx_äame
.
¡©us
 & 0x0Fè=ğ
ENRSR_RXOK
) {

451 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

452 
sk_buff
 *
skb
;

454 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

455 ià(
skb
 =ğ
NULL
) {

456 ià(
ei_debug
)

457 
	`´štk
("%s: Couldn't‡llocate‡ sk_buff of size %d.\n",

458 
dev
->
Çme
, 
sksize
);

459 
ei_loÿl
->
¡©
.
rx_drİ³d
++;

462 
skb
->
mem_Ën
 = 
sksize
;

463 
skb
->
mem_addr
 = skb;

464 
skb
->
Ën
 = 
pkt_Ën
;

465 
skb
->
dev
 = dev;

467 
	`ei_block_šput
(
dev
, 
pkt_Ën
, (*è
skb
->
d©a
,

468 
cu¼’t_off£t
 + (
rx_äame
));

469 
	`Ãtif_rx
(
skb
);

470 
ei_loÿl
->
¡©
.
rx_·ck‘s
++;

473 
”rs
 = 
rx_äame
.
¡©us
;

474 ià(
ei_debug
)

475 
	`´štk
("%s: bogus…acket: status=%#2x‚xpg=%#2x size=%d\n",

476 
dev
->
Çme
, 
rx_äame
.
¡©us
,„x_äame.
Ãxt
,

477 
rx_äame
.
couÁ
);

478 ià(
”rs
 & 
ENRSR_FO
)

479 
ei_loÿl
->
¡©
.
rx_fifo_”rÜs
++;

481 
Ãxt_äame
 = 
rx_äame
.
Ãxt
;

484 ià(
Ãxt_äame
 >ğ
ei_loÿl
->
¡İ_·ge
) {

485 
	`´štk
("%s:‚exˆäamšcÚsi¡’cy, %#2x..", 
dev
->
Çme
,

486 
Ãxt_äame
);

487 
Ãxt_äame
 = 
ei_loÿl
->
rx_¡¬t_·ge
;

489 
ei_loÿl
->
cu¼’t_·ge
 = 
Ãxt_äame
;

490 
	`outb
(
Ãxt_äame
-1, 
e8390_ba£
+
EN0_BOUNDARY
);

497 ià(
rx_pkt_couÁ
 > 
high_w©”_m¬k
)

498 
high_w©”_m¬k
 = 
rx_pkt_couÁ
;

501 
	`outb_p
(
ENISR_RX
+
ENISR_RX_ERR
+
ENISR_OVER
, 
e8390_ba£
+
EN0_ISR
);

503 
	}
}

507 
	$ei_rx_ov”run
(
deviû
 *
dev
)

509 
e8390_ba£
 = 
dev
->
ba£_addr
;

510 
»£t_¡¬t_time
 = 
jiff›s
;

511 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

514 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_STOP
, 
e8390_ba£
+
E8390_CMD
);

516 ià(
ei_debug
)

517 
	`´štk
("%s: Reûiv” ov”run.\n", 
dev
->
Çme
);

518 
ei_loÿl
->
¡©
.
rx_ov”_”rÜs
++;

527 (
	`šb_p
(
e8390_ba£
+
EN0_ISR
è& 
ENISR_RESET
) == 0)

528 ià(
jiff›s
 - 
»£t_¡¬t_time
 > 1) {

529 
	`´štk
("%s:„eset did‚ot complete‡tƒi_rx_overrun.\n",

530 
dev
->
Çme
);

531 
	`NS8390_š™
(
dev
, 1);

536 
	`ei_»ûive
(
dev
);

538 
	`outb_p
(0xff, 
e8390_ba£
+
EN0_ISR
);

540 
	`outb_p
(
E8390_NODMA
 + 
E8390_PAGE0
 + 
E8390_START
, 
e8390_ba£
 + 
E8390_CMD
);

541 
	`outb_p
(
E8390_TXCONFIG
, 
e8390_ba£
 + 
EN0_TXCR
);

542 
	}
}

544 
’‘_¡©i¡ics
 *
	$g‘_¡©s
(
deviû
 *
dev
)

546 
ißddr
 = 
dev
->
ba£_addr
;

547 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

550 
ei_loÿl
->
¡©
.
rx_äame_”rÜs
 +ğ
	`šb_p
(
ißddr
 + 
EN0_COUNTER0
);

551 
ei_loÿl
->
¡©
.
rx_üc_”rÜs
 +ğ
	`šb_p
(
ißddr
 + 
EN0_COUNTER1
);

552 
ei_loÿl
->
¡©
.
rx_mis£d_”rÜs
+ğ
	`šb_p
(
ißddr
 + 
EN0_COUNTER2
);

554  &
ei_loÿl
->
¡©
;

555 
	}
}

557 #ifdeà
HAVE_MULTICAST


564 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

566 
ißddr
 = 
dev
->
ba£_addr
;

568 ià(
num_addrs
 > 0) {

571 
	`outb_p
(
E8390_RXCONFIG
 | 0x08, 
ißddr
 + 
EN0_RXCR
);

572 } ià(
num_addrs
 < 0)

573 
	`outb_p
(
E8390_RXCONFIG
 | 0x10, 
ißddr
 + 
EN0_RXCR
);

575 
	`outb_p
(
E8390_RXCONFIG
, 
ißddr
 + 
EN0_RXCR
);

576 
	}
}

580 
	$‘hdev_š™
(
deviû
 *
dev
)

582 
i
;

584 ià(
ei_debug
 > 1)

585 
	`´štk
(
v”siÚ
);

587 ià(
dev
->
´iv
 =ğ
NULL
) {

588 
ei_deviû
 *
ei_loÿl
;

590 
dev
->
´iv
 = 
	`km®loc
((
ei_deviû
), 
GFP_KERNEL
);

591 
	`mem£t
(
dev
->
´iv
, 0, (
ei_deviû
));

592 
ei_loÿl
 = (
ei_deviû
 *)
dev
->
´iv
;

593 #iâdeà
NO_PINGPONG


594 
ei_loÿl
->
pšgpÚg
 = 1;

599 ià(
dev
->
İ’
 =ğ
NULL
)

600 
dev
->
İ’
 = &
ei_İ’
;

602 
dev
->
h¬d_¡¬t_xm™
 = &
ei_¡¬t_xm™
;

603 
dev
->
g‘_¡©s
 = get_stats;

604 #ifdeà
HAVE_MULTICAST


605 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

608 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

609 
dev
->
buffs
[
i
] = 
NULL
;

611 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

612 
dev
->
add_¬p
 = 
‘h_add_¬p
;

613 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

614 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

615 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

617 
dev
->
ty³
 = 
ARPHRD_ETHER
;

618 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

619 
dev
->
mtu
 = 1500;

620 
dev
->
addr_Ën
 = 
ETH_ALEN
;

621 
i
 = 0; i < 
ETH_ALEN
; i++) {

622 
dev
->
brßdÿ¡
[
i
]=0xff;

626 
dev
->
æags
 = 
IFF_BROADCAST
;

627 
dev
->
çmy
 = 
AF_INET
;

628 
dev
->
·_addr
 = 0;

629 
dev
->
·_brdaddr
 = 0;

630 
dev
->
·_mask
 = 0;

631 
dev
->
·_®’
 = ();

634 
	}
}

639 
	$NS8390_š™
(
deviû
 *
dev
, 
¡¬
)

641 
e8390_ba£
 = 
dev
->
ba£_addr
;

642 
ei_deviû
 *
ei_loÿl
 = (ei_deviû *è
dev
->
´iv
;

643 
i
;

644 
’dcfg
 = 
ei_loÿl
->
wÜd16
 ? (0x48 | 
ENDCFG_WTS
) : 0x48;

647 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_STOP
, 
e8390_ba£
);

648 
	`outb_p
(
’dcfg
, 
e8390_ba£
 + 
EN0_DCFG
);

650 
	`outb_p
(0x00, 
e8390_ba£
 + 
EN0_RCNTLO
);

651 
	`outb_p
(0x00, 
e8390_ba£
 + 
EN0_RCNTHI
);

653 
	`outb_p
(
E8390_RXOFF
, 
e8390_ba£
 + 
EN0_RXCR
);

654 
	`outb_p
(
E8390_TXOFF
, 
e8390_ba£
 + 
EN0_TXCR
);

656 
	`outb_p
(
ei_loÿl
->
tx_¡¬t_·ge
, 
e8390_ba£
 + 
EN0_TPSR
);

657 
ei_loÿl
->
tx1
 =ƒi_loÿl->
tx2
 = 0;

658 
	`outb_p
(
ei_loÿl
->
rx_¡¬t_·ge
, 
e8390_ba£
 + 
EN0_STARTPG
);

659 
	`outb_p
(
ei_loÿl
->
¡İ_·ge
-1, 
e8390_ba£
 + 
EN0_BOUNDARY
);

660 
ei_loÿl
->
cu¼’t_·ge
 =ƒi_loÿl->
rx_¡¬t_·ge
;

661 
	`outb_p
(
ei_loÿl
->
¡İ_·ge
, 
e8390_ba£
 + 
EN0_STOPPG
);

663 
	`outb_p
(0xFF, 
e8390_ba£
 + 
EN0_ISR
);

664 
	`outb_p
(0x00, 
e8390_ba£
 + 
EN0_IMR
);

668 
	`şi
();

669 
	`outb_p
(
E8390_NODMA
 + 
E8390_PAGE1
 + 
E8390_STOP
, 
e8390_ba£
);

670 
i
 = 0; i < 6; i++) {

671 
	`outb_p
(
dev
->
dev_addr
[
i
], 
e8390_ba£
 + 
EN1_PHYS
 + i);

675 
i
 = 0; i < 8; i++)

676 
	`outb_p
(0xff, 
e8390_ba£
 + 
EN1_MULT
 + 
i
);

678 
	`outb_p
(
ei_loÿl
->
rx_¡¬t_·ge
, 
e8390_ba£
 + 
EN1_CURPAG
);

679 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_STOP
, 
e8390_ba£
);

680 
	`¡i
();

681 
dev
->
tbusy
 = 0;

682 
dev
->
š‹¼u±
 = 0;

683 
ei_loÿl
->
tx1
 =ƒi_loÿl->
tx2
 = 0;

684 
ei_loÿl
->
txšg
 = 0;

685 ià(
¡¬
) {

686 
	`outb_p
(0xff, 
e8390_ba£
 + 
EN0_ISR
);

687 
	`outb_p
(
ENISR_ALL
, 
e8390_ba£
 + 
EN0_IMR
);

688 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_START
, 
e8390_ba£
);

689 
	`outb_p
(
E8390_TXCONFIG
, 
e8390_ba£
 + 
EN0_TXCR
);

691 
	`outb_p
(
E8390_RXCONFIG
, 
e8390_ba£
 + 
EN0_RXCR
);

694 
	}
}

697 
	$NS8390_Œigg”_£nd
(
deviû
 *
dev
, 
Ëngth
,

698 
¡¬t_·ge
)

700 
e8390_ba£
 = 
dev
->
ba£_addr
;

702 
ei_¡©us
.
txšg
 = 1;

703 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
, 
e8390_ba£
);

705 ià(
	`šb_p
(
e8390_ba£
è& 
E8390_TRANS
) {

706 
	`´štk
("%s:rigger_send() called withheransmitter busy.\n",

707 
dev
->
Çme
);

710 
	`outb_p
(
Ëngth
 & 0xff, 
e8390_ba£
 + 
EN0_TCNTLO
);

711 
	`outb_p
(
Ëngth
 >> 8, 
e8390_ba£
 + 
EN0_TCNTHI
);

712 
	`outb_p
(
¡¬t_·ge
, 
e8390_ba£
 + 
EN0_TPSR
);

713 
	`outb_p
(
E8390_NODMA
+
E8390_TRANS
+
E8390_START
, 
e8390_ba£
);

715 
	}
}

	@drivers/net/8390.h

7 #iâdeà
_8390_h


8 
	#_8390_h


	)

10 
	~<lšux/if_‘h”.h
>

11 
	~<lšux/iİÜt.h
>

13 
	#TX_2X_PAGES
 12

	)

14 
	#TX_1X_PAGES
 6

	)

15 
	#TX_PAGES
 (
ei_¡©us
.
pšgpÚg
 ? 
TX_2X_PAGES
 : 
TX_1X_PAGES
)

	)

17 
	#ETHER_ADDR_LEN
 6

	)

20 
ei_debug
;

21 
sigaùiÚ
 
ei_sigaùiÚ
;

23 
‘hif_š™
(
deviû
 *
dev
);

24 
‘hdev_š™
(
deviû
 *
dev
);

25 
NS8390_š™
(
deviû
 *
dev
, 
¡¬
);

26 
ei_İ’
(
deviû
 *
dev
);

27 
ei_š‹¼u±
(
»g_±r
);

29 #iâdeà
HAVE_AUTOIRQ


31 
deviû
 *
œq2dev_m­
[16];

32 
autoœq_£tup
(
wa™time
);

33 
autoœq_»pÜt
(
wa™time
);

39 
	sei_deviû
 {

40 *
	mÇme
;

41 (*
	m»£t_8390
)(
	mdeviû
 *);

42 (*
	mblock_ouut
)(
	mdeviû
 *, , const *, );

43 (*
	mblock_šput
)(
	mdeviû
 *, , *, );

44 
	mİ’
:1;

45 
	mwÜd16
:1;

46 
	mtxšg
:1;

47 
	mdmašg
:2;

48 
	mœqlock
:1;

49 
	mpšgpÚg
:1;

50 
	mtx_¡¬t_·ge
, 
	mrx_¡¬t_·ge
, 
	m¡İ_·ge
;

51 
	mcu¼’t_·ge
;

52 
	mš‹rçû_num
;

53 
	mtxqueue
;

54 
	mš_š‹¼u±
;

55 
	mtx1
, 
	mtx2
;

56 
	mÏ¡tx
;

57 
	m»g0
;

58 
	m»g5
;

59 
	m§ved_œq
;

61 
’‘_¡©i¡ics
 
	m¡©
;

64 
	#ei_¡©us
 (*(
ei_deviû
 *)(
dev
->
´iv
))

	)

67 
	#E8390_TX_IRQ_MASK
 0x¨

	)

68 
	#E8390_RX_IRQ_MASK
 0x5

	)

69 
	#E8390_RXCONFIG
 0x4

	)

70 
	#E8390_RXOFF
 0x20

	)

71 
	#E8390_TXCONFIG
 0x00

	)

72 
	#E8390_TXOFF
 0x02

	)

75 
	#E8390_STOP
 0x01

	)

76 
	#E8390_START
 0x02

	)

77 
	#E8390_TRANS
 0x04

	)

78 
	#E8390_RREAD
 0x08

	)

79 
	#E8390_RWRITE
 0x10

	)

80 
	#E8390_NODMA
 0x20

	)

81 
	#E8390_PAGE0
 0x00

	)

82 
	#E8390_PAGE1
 0x40

	)

83 
	#E8390_PAGE2
 0x80

	)

85 
	#E8390_CMD
 0x00

	)

87 
	#EN0_CLDALO
 0x01

	)

88 
	#EN0_STARTPG
 0x01

	)

89 
	#EN0_CLDAHI
 0x02

	)

90 
	#EN0_STOPPG
 0x02

	)

91 
	#EN0_BOUNDARY
 0x03

	)

92 
	#EN0_TSR
 0x04

	)

93 
	#EN0_TPSR
 0x04

	)

94 
	#EN0_NCR
 0x05

	)

95 
	#EN0_TCNTLO
 0x05

	)

96 
	#EN0_FIFO
 0x06

	)

97 
	#EN0_TCNTHI
 0x06

	)

98 
	#EN0_ISR
 0x07

	)

99 
	#EN0_CRDALO
 0x08

	)

100 
	#EN0_RSARLO
 0x08

	)

101 
	#EN0_CRDAHI
 0x09

	)

102 
	#EN0_RSARHI
 0x09

	)

103 
	#EN0_RCNTLO
 0x0¨

	)

104 
	#EN0_RCNTHI
 0x0b

	)

105 
	#EN0_RSR
 0x0ø

	)

106 
	#EN0_RXCR
 0x0ø

	)

107 
	#EN0_TXCR
 0x0d

	)

108 
	#EN0_COUNTER0
 0x0d

	)

109 
	#EN0_DCFG
 0x0

	)

110 
	#EN0_COUNTER1
 0x0

	)

111 
	#EN0_IMR
 0x0à

	)

112 
	#EN0_COUNTER2
 0x0à

	)

115 
	#ENISR_RX
 0x01

	)

116 
	#ENISR_TX
 0x02

	)

117 
	#ENISR_RX_ERR
 0x04

	)

118 
	#ENISR_TX_ERR
 0x08

	)

119 
	#ENISR_OVER
 0x10

	)

120 
	#ENISR_COUNTERS
 0x20

	)

121 
	#ENISR_RDC
 0x40

	)

122 
	#ENISR_RESET
 0x80

	)

123 
	#ENISR_ALL
 0x3à

	)

126 
	#ENDCFG_WTS
 0x01

	)

129 
	#EN1_PHYS
 0x01

	)

130 
	#EN1_CURPAG
 0x07

	)

131 
	#EN1_MULT
 0x08

	)

134 
	#ENRSR_RXOK
 0x01

	)

135 
	#ENRSR_CRC
 0x02

	)

136 
	#ENRSR_FAE
 0x04

	)

137 
	#ENRSR_FO
 0x08

	)

138 
	#ENRSR_MPA
 0x10

	)

139 
	#ENRSR_PHY
 0x20

	)

140 
	#ENRSR_DIS
 0x40

	)

141 
	#ENRSR_DEF
 0x80

	)

144 
	#ENTSR_PTX
 0x01

	)

145 
	#ENTSR_ND
 0x02

	)

146 
	#ENTSR_COL
 0x04

	)

147 
	#ENTSR_ABT
 0x08

	)

148 
	#ENTSR_CRS
 0x10

	)

149 
	#ENTSR_FU
 0x20

	)

150 
	#ENTSR_CDH
 0x40

	)

151 
	#ENTSR_OWC
 0x80

	)

154 
	se8390_pkt_hdr
 {

155 
	m¡©us
;

156 
	mÃxt
;

157 
	mcouÁ
;

	@drivers/net/Space.c

27 
	~<lšux/cÚfig.h
>

28 
	~<lšux/ddi.h
>

29 
	~"dev.h
"

31 
	#LOOPBACK


	)

33 
	#NEXT_DEV
 
NULL


	)

40 
uÉ¿_´obe
(
deviû
 *
dev
);

41 
wd_´obe
(
deviû
 *
dev
);

42 
–2_´obe
(
deviû
 *
dev
);

43 
Ã_´obe
(
deviû
 *
dev
);

44 
hp_´obe
(
deviû
 *
dev
);

45 
zÃt_´obe
(
deviû
 *);

46 
ex´ess_´obe
(
deviû
 *);

47 
–3_´obe
(
deviû
 *);

48 
©1500_´obe
(
deviû
 *);

49 
©1700_´obe
(
deviû
 *);

50 
d•ÿ_´obe
(
deviû
 *);

51 
–1_´obe
(
deviû
 *);

52 
–16_´obe
(
deviû
 *);

53 
–¶us_´obe
(
deviû
 *);

54 
ac3200_´obe
(
deviû
 *);

55 
e2100_´obe
(
deviû
 *);

58 
©p_š™
(
deviû
 *);

59 
d_lšk_š™
(
deviû
 *);

62 
	$‘hif_´obe
(
deviû
 *
dev
)

64 
ba£_addr
 = 
dev
->base_addr;

66 ià(
ba£_addr
 < 0 || base_addr == 1)

70 #ià
	`defšed
(
CONFIG_ULTRA
)

71 && 
	`uÉ¿_´obe
(
dev
)

73 #ià
	`defšed
(
CONFIG_WD80x3
è|| defšed(
WD80x3
)

74 && 
	`wd_´obe
(
dev
)

76 #ià
	`defšed
(
CONFIG_EL2
è|| defšed(
EL2
)

77 && 
	`–2_´obe
(
dev
)

79 #ià
	`defšed
(
CONFIG_NE2000
è|| defšed(
NE2000
)

80 && 
	`Ã_´obe
(
dev
)

82 #ià
	`defšed
(
CONFIG_HPLAN
è|| defšed(
HPLAN
)

83 && 
	`hp_´obe
(
dev
)

85 #ifdeà
CONFIG_AT1500


86 && 
	`©1500_´obe
(
dev
)

88 #ifdeà
CONFIG_AT1700


89 && 
	`©1700_´obe
(
dev
)

91 #ifdeà
CONFIG_EL3


92 && 
	`–3_´obe
(
dev
)

94 #ifdeà
CONFIG_ZNET


95 && 
	`zÃt_´obe
(
dev
)

97 #ifdeà
CONFIG_EEXPRESS


98 && 
	`ex´ess_´obe
(
dev
)

100 #ifdeà
CONFIG_DEPCA


101 && 
	`d•ÿ_´obe
(
dev
)

103 #ifdeà
CONFIG_EL1


104 && 
	`–1_´obe
(
dev
)

106 #ifdeà
CONFIG_EL16


107 && 
	`–16_´obe
(
dev
)

109 #ifdeà
CONFIG_ELPLUS


110 && 
	`–¶us_´obe
(
dev
)

112 #ifdeà
CONFIG_AC3200


113 && 
	`ac3200_´obe
(
dev
)

115 #ifdeà
CONFIG_E2100


116 && 
	`e2100_´obe
(
dev
)

122 
	}
}

126 #ià
defšed
(
D_LINK
è|| defšed(
CONFIG_DE600
)

127 
deviû
 
	gd_lšk_dev
 = {

128 "dl0", 0, 0, 0, 0, 
D_LINK_IO
, 
D_LINK_IRQ
, 0, 0, 0, 
NEXT_DEV
, 
d_lšk_š™
 };

129 #undeà
NEXT_DEV


130 
	#NEXT_DEV
 (&
d_lšk_dev
)

	)

134 #ifdeà
CONFIG_ATP


135 
deviû
 
	g©p_dev
 = {

136 "©p0", 0, 0, 0, 0, 0, 0, 0, 0, 0, 
NEXT_DEV
, 
©p_š™
, };

137 #undeà
NEXT_DEV


138 
	#NEXT_DEV
 (&
©p_dev
)

	)

142 #iâdeà
ETH0_ADDR


143 
	#ETH0_ADDR
 0

	)

145 #iâdeà
ETH0_IRQ


146 
	#ETH0_IRQ
 0

	)

152 
deviû
 
	g‘h3_dev
 = {

153 "‘h3", 0,0,0,0,0xfã0 , 0,0,0,0, 
NEXT_DEV
, 
‘hif_´obe
 };

154 
deviû
 
	g‘h2_dev
 = {

155 "‘h2", 0,0,0,0,0xfã0 , 0,0,0,0, &
‘h3_dev
, 
‘hif_´obe
 };

156 
deviû
 
	g‘h1_dev
 = {

157 "‘h1", 0,0,0,0,0xfã0 , 0,0,0,0, &
‘h2_dev
, 
‘hif_´obe
 };

159 
deviû
 
	g‘h0_dev
 = {

160 "‘h0", 0, 0, 0, 0, 
ETH0_ADDR
, 
ETH0_IRQ
, 0, 0, 0, &
‘h1_dev
, 
‘hif_´obe
 };

162 #undeà
NEXT_DEV


163 
	#NEXT_DEV
 (&
‘h0_dev
)

	)

165 #ià
defšed
(
PLIP
è|| defšed(
CONFIG_PLIP
)

166 
¶_š™
(
deviû
 *);

167 
deviû
 
	g¶2_dev
 = {

168 "¶2", 0, 0, 0, 0, 0x278, 2, 0, 0, 0, 
NEXT_DEV
, 
¶_š™
, };

169 
deviû
 
	g¶1_dev
 = {

170 "¶1", 0, 0, 0, 0, 0x378, 7, 0, 0, 0, &
¶2_dev
, 
¶_š™
, };

171 
deviû
 
	g¶0_dev
 = {

172 "¶0", 0, 0, 0, 0, 0x3BC, 5, 0, 0, 0, &
¶1_dev
, 
¶_š™
, };

173 #undeà
NEXT_DEV


174 
	#NEXT_DEV
 (&
¶0_dev
)

	)

177 #ià
defšed
(
SLIP
è|| defšed(
CONFIG_SLIP
)

178 
¦_š™
(
deviû
 *);

179 
deviû
 
	g¦3_dev
 = {

188 
NEXT_DEV
,

189 
¦_š™


191 
deviû
 
	g¦2_dev
 = {

200 &
¦3_dev
,

201 
¦_š™


203 
deviû
 
	g¦1_dev
 = {

212 &
¦2_dev
,

213 
¦_š™


215 
deviû
 
	g¦0_dev
 = {

224 &
¦1_dev
,

225 
¦_š™


227 #undeà
NEXT_DEV


228 
	#NEXT_DEV
 (&
¦0_dev
)

	)

231 #ià
defšed
(
CONFIG_PPP
)

232 
µp_š™
(
deviû
 *);

233 
deviû
 
	gµp3_dev
 = {

234 "µp3", 0x0, 0x0, 0x0, 0x0, 3, 0, 0, 0, 0, 
NEXT_DEV
, 
µp_š™
, };

235 
deviû
 
	gµp2_dev
 = {

236 "µp2", 0x0, 0x0, 0x0, 0x0, 2, 0, 0, 0, 0, &
µp3_dev
, 
µp_š™
, };

237 
deviû
 
	gµp1_dev
 = {

238 "µp1", 0x0, 0x0, 0x0, 0x0, 1, 0, 0, 0, 0, &
µp2_dev
, 
µp_š™
, };

239 
deviû
 
	gµp0_dev
 = {

240 "µp0", 0x0, 0x0, 0x0, 0x0, 0, 0, 0, 0, 0, &
µp1_dev
, 
µp_š™
, };

241 #undeà
NEXT_DEV


242 
	#NEXT_DEV
 (&
µp0_dev
)

	)

245 #ifdeà
LOOPBACK


246 
loİback_š™
(
deviû
 *
dev
);

247 
deviû
 
	gloİback_dev
 = {

256 
NEXT_DEV
,

257 
loİback_š™


259 #undeà
NEXT_DEV


260 
	#NEXT_DEV
 (&
loİback_dev
)

	)

264 
deviû
 *
	gdev_ba£
 = 
NEXT_DEV
;

	@drivers/net/at1700.c

14 *
	gv”siÚ
 =

17 
	~<lšux/cÚfig.h
>

27 
	~<lšux/k”Ãl.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/ty³s.h
>

30 
	~<lšux/fú.h
>

31 
	~<lšux/š‹¼u±.h
>

32 
	~<lšux/±¿û.h
>

33 
	~<lšux/iİÜt.h
>

34 
	~<lšux/š.h
>

35 
	~<lšux/m®loc.h
>

36 
	~<lšux/¡ršg.h
>

37 
	~<asm/sy¡em.h
>

38 
	~<asm/b™İs.h
>

39 
	~<asm/io.h
>

40 
	~<asm/dma.h
>

41 
	~<”ºo.h
>

43 
	~"dev.h
"

44 
	~"‘h.h
"

45 
	~"skbuff.h
"

46 
	~"¬p.h
"

48 #iâdeà
HAVE_AUTOIRQ


50 
autoœq_£tup
(
wa™time
);

51 
autoœq_»pÜt
(
wa™time
);

54 
deviû
 *
œq2dev_m­
[16];

57 #iâdeà
HAVE_ALLOC_SKB


58 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

59 
	#kä“_skbmem
(
addr
, 
size
è
	`kä“_s
×ddr,size);

	)

63 #iâdeà
NET_DEBUG


64 
	#NET_DEBUG
 2

	)

66 
	gÃt_debug
 = 
NET_DEBUG
;

68 
	tuch¬
;

71 
	sÃt_loÿl
 {

72 
’‘_¡©i¡ics
 
	m¡©s
;

73 
	mİ’_time
;

74 
ušt
 
	mtx_¡¬‹d
:1;

75 
uch¬
 
	mtx_queue
;

76 
ushÜt
 
	mtx_queue_Ën
;

81 
	#STATUS
 0

	)

82 
	#TX_STATUS
 0

	)

83 
	#RX_STATUS
 1

	)

84 
	#TX_INTR
 2

	)

85 
	#RX_INTR
 3

	)

86 
	#TX_MODE
 4

	)

87 
	#RX_MODE
 5

	)

88 
	#CONFIG_0
 6

	)

89 
	#CONFIG_1
 7

	)

91 
	#DATAPORT
 8

	)

92 
	#TX_START
 10

	)

93 
	#MODE13
 13

	)

94 
	#EEPROM_CŒl
 16

	)

95 
	#EEPROM_D©a
 17

	)

98 
	#EE_SHIFT_CLK
 0x40

	)

99 
	#EE_CS
 0x20

	)

100 
	#EE_DATA_WRITE
 0x80

	)

101 
	#EE_DATA_READ
 0x80

	)

104 
	#“´om_d–ay
(èdØ{ 
_i
 = 40; --_˜> 0è{ 
__SLOW_DOWN_IO
; }} 0)

	)

107 
	#EE_WRITE_CMD
 (5 << 6)

	)

108 
	#EE_READ_CMD
 (6 << 6)

	)

109 
	#EE_ERASE_CMD
 (7 << 6)

	)

114 
©1700_´obe
(
deviû
 *
dev
);

116 
©1700_´obe1
(
deviû
 *
dev
, 
ißddr
);

117 
»ad_“´om
(
ißddr
, 
loÿtiÚ
);

118 
Ãt_İ’
(
deviû
 *
dev
);

119 
Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

120 
Ãt_š‹¼u±
(
»g_±r
);

121 
Ãt_rx
(
deviû
 *
dev
);

122 
Ãt_şo£
(
deviû
 *
dev
);

123 
’‘_¡©i¡ics
 *
Ãt_g‘_¡©s
(
deviû
 *
dev
);

124 #ifdeà
HAVE_MULTICAST


125 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

136 
	$©1700_´obe
(
deviû
 *
dev
)

138 
pÜts
[] = {0x300, 0x280, 0x380, 0x320, 0x340, 0x260, 0x2a0, 0x240, 0};

139 *
pÜt
, 
ba£_addr
 = 
dev
->base_addr;

141 ià(
ba£_addr
 > 0x1ff)

142  
	`©1700_´obe1
(
dev
, 
ba£_addr
);

143 ià(
ba£_addr
 > 0)

144  
ENXIO
;

146 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

147 
ißddr
 = *
pÜt
;

148 ià(
	`check_»giÚ
(
ißddr
, 32))

150 ià(
	`©1700_´obe1
(
dev
, 
ißddr
) == 0)

154  
ENODEV
;

155 
	}
}

165 
	$©1700_´obe1
(
deviû
 *
dev
, 
ißddr
)

167 
sigÇtu»
[4] = {0xffff, 0xffff, 0x7ff7, 0xff5f};

168 
sigÇtu»_šv®id
[4] = {0xffff, 0xffff, 0x7ff7, 0xdf0f};

169 
œqm­
[8] = {3, 4, 5, 9, 10, 11, 14, 15};

170 *
¡©iÚ_add»ss
 = (*)
dev
->
dev_addr
;

171 
i
, 
œq
;

176 
i
 = 0; i < 4; i++)

177 ià((
	`šw
(
ißddr
 + 2*
i
è| 
sigÇtu»_šv®id
[i]è!ğ
sigÇtu»
[i]) {

178 ià(
Ãt_debug
 > 2)

179 
	`´štk
("AT1700 signature match failed‡t %d (%04x vs. %04x)\n",

180 
i
, 
	`šw
(
ißddr
 + 2*i), 
sigÇtu»
[i]);

181  -
ENODEV
;

183 ià(
	`»ad_“´om
(
ißddr
, 4) != 0x0000

184 || 
	`»ad_“´om
(
ißddr
, 5) & 0x00ff != 0x00F4)

185  -
ENODEV
;

189 
	`¢¬f_»giÚ
(
ißddr
, 32);

191 
œq
 = 
œqm­
[(
	`»ad_“´om
(
ißddr
, 12)&0x04)

192 | (
	`»ad_“´om
(
ißddr
, 0)>>14)];

195 ià(
	`»que¡_œq
(
œq
, &
Ãt_š‹¼u±
)) {

196 
	`´štk
 ("AT1700 found‡t %#3x, but it's unusable dueo‡ conflict on"

197 "IRQ %d.\n", 
ißddr
, 
œq
);

198  
EAGAIN
;

201 
	`´štk
("%s: AT1700 found‡ˆ%#3x, IRQ %d,‡dd»s ", 
dev
->
Çme
,

202 
ißddr
, 
œq
);

204 
dev
->
ba£_addr
 = 
ißddr
;

205 
dev
->
œq
 = irq;

206 
œq2dev_m­
[
œq
] = 
dev
;

208 
i
 = 0; i < 3; i++) {

209 
“´om_v®
 = 
	`»ad_“´om
(
ißddr
, 4+
i
);

210 
	`´štk
("%04x", 
“´om_v®
);

211 
¡©iÚ_add»ss
[
i
] = 
	`Áohs
(
“´om_v®
);

221 *
pÜ‰y³
[] = {"auto-sense", "10baseT", "auto-sense", "10base2"};

222 
ushÜt
 
£tup_v®ue
 = 
	`»ad_“´om
(
ißddr
, 12);

224 
dev
->
if_pÜt
 = 
£tup_v®ue
 >> 8;

225 
	`´štk
(" % š‹rçû (%04x).\n", 
pÜ‰y³
[(
dev
->
if_pÜt
>>3) & 3],

226 
£tup_v®ue
);

230 
	`outb
(0xe0, 
ißddr
 + 7);

231 
i
 = 0; i < 6; i++)

232 
	`outb
(
dev
->
dev_addr
[
i
], 
ißddr
 + 8 + i);

235 
	`outb
(0xe4, 
ißddr
 + 7);

236 
i
 = 0; i < 8; i++)

237 
	`outb
(0x00, 
ißddr
 + 8 + 
i
);

241 
	`outb
(0xda, 
ißddr
 + 
CONFIG_0
);

244 
	`outb
(0xe8, 
ißddr
 + 7);

245 
	`outb
(
dev
->
if_pÜt
, 
MODE13
);

248 
	`outb
(0x00, 
ißddr
 + 
CONFIG_1
);

250 ià(
Ãt_debug
)

251 
	`´štk
(
v”siÚ
);

254 
dev
->
´iv
 = 
	`km®loc
((
Ãt_loÿl
), 
GFP_KERNEL
);

255 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt_loÿl
));

257 
dev
->
İ’
 = 
Ãt_İ’
;

258 
dev
->
¡İ
 = 
Ãt_şo£
;

259 
dev
->
h¬d_¡¬t_xm™
 = 
Ãt_£nd_·ck‘
;

260 
dev
->
g‘_¡©s
 = 
Ãt_g‘_¡©s
;

261 #ifdeà
HAVE_MULTICAST


262 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

267 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

268 
dev
->
buffs
[
i
] = 
NULL
;

270 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

271 
dev
->
add_¬p
 = 
‘h_add_¬p
;

272 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

273 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

274 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

276 
dev
->
ty³
 = 
ARPHRD_ETHER
;

277 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

278 
dev
->
mtu
 = 1500;

279 
dev
->
addr_Ën
 = 
ETH_ALEN
;

280 
i
 = 0; i < 
ETH_ALEN
; i++) {

281 
dev
->
brßdÿ¡
[
i
]=0xff;

285 
dev
->
æags
 = 
IFF_BROADCAST
;

286 
dev
->
çmy
 = 
AF_INET
;

287 
dev
->
·_addr
 = 0;

288 
dev
->
·_brdaddr
 = 0;

289 
dev
->
·_mask
 = 0;

290 
dev
->
·_®’
 = ();

293 
	}
}

295 
	$»ad_“´om
(
ißddr
, 
loÿtiÚ
)

297 
i
;

298 
»tv®
 = 0;

299 
“_addr
 = 
ißddr
 + 
EEPROM_CŒl
;

300 
“_daddr
 = 
ißddr
 + 
EEPROM_D©a
;

301 
»ad_cmd
 = 
loÿtiÚ
 | 
EE_READ_CMD
;

302 
ù¾_v®
 = 
EE_CS
;

304 
	`outb
(
ù¾_v®
, 
“_addr
);

307 
i
 = 9; i >= 0; i--) {

308 
d©av®
 = (
»ad_cmd
 & (1 << 
i
)è? 
EE_DATA_WRITE
 : 0;

309 
	`outb
(
d©av®
, 
“_daddr
);

310 
	`outb
(
EE_CS
 | 
EE_SHIFT_CLK
, 
“_addr
);

311 
	`“´om_d–ay
();

312 
	`outb
(
EE_CS
, 
“_addr
);

313 
	`“´om_d–ay
();

315 
	`outb
(
EE_CS
, 
“_addr
);

317 
i
 = 16; i > 0; i--) {

318 
	`outb
(
EE_CS
 | 
EE_SHIFT_CLK
, 
“_addr
);

319 
	`“´om_d–ay
();

320 
»tv®
 = (»tv® << 1è| ((
	`šb
(
“_daddr
è& 
EE_DATA_READ
) ? 1 : 0);

321 
	`outb
(
EE_CS
, 
“_addr
);

322 
	`“´om_d–ay
();

326 
ù¾_v®
 &ğ~
EE_CS
;

327 
	`outb
(
ù¾_v®
 | 
EE_SHIFT_CLK
, 
“_addr
);

328 
	`“´om_d–ay
();

329 
	`outb
(
ù¾_v®
, 
“_addr
);

330 
	`“´om_d–ay
();

331  
»tv®
;

332 
	}
}

336 
	$Ãt_İ’
(
deviû
 *
dev
)

338 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

339 
ißddr
 = 
dev
->
ba£_addr
;

340 
i
;

343 
	`outb
(0xe0, 
ißddr
 + 
CONFIG_1
);

346 
i
 = 0; i < 6; i++)

347 
	`outb
(
dev
->
dev_addr
[
i
], 
ißddr
 + 8 + i);

350 
	`outb
(0xe4, 
ißddr
 + 7);

351 
i
 = 0; i < 8; i++)

352 
	`outb
(0x00, 
ißddr
 + 8 + 
i
);

356 
	`outb
(0xda, 
ißddr
 + 
CONFIG_0
);

359 
	`outb
(0x5a, 
ißddr
 + 
CONFIG_0
);

361 
	`outb
(0xe8, 
ißddr
 + 
CONFIG_1
);

364 
	`outb
(0x00, 
ißddr
 + 
TX_INTR
);

365 
	`outb
(0x81, 
ißddr
 + 
RX_INTR
);

367 
Í
->
İ’_time
 = 
jiff›s
;

369 
dev
->
tbusy
 = 0;

370 
dev
->
š‹¼u±
 = 0;

371 
dev
->
¡¬t
 = 1;

374 
	}
}

377 
	$Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

379 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

380 
ißddr
 = 
dev
->
ba£_addr
;

382 ià(
dev
->
tbusy
) {

385 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

386 ià(
tickssoçr
 < 10)

388 
	`´štk
("%s:¿nsm™imed ouˆw™h stu %04x, %s?\n", 
dev
->
Çme
,

389 
	`šw
(
ißddr
 + 
STATUS
), 
	`šb
(ißdd¸+ 
TX_STATUS
) & 0x80

391 
	`´štk
("%s:imeout„egisters: %04x %04x %04x %04x %04x %04x %04x %04x.\n",

392 
dev
->
Çme
, 
	`šw
(
ißddr
 + 0), inw(ioaddr + 2), inw(ioaddr + 4),

393 
	`šw
(
ißddr
 + 6), inw(ioaddr + 8), inw(ioaddr + 10),

394 
	`šw
(
ißddr
 + 12), inw(ioaddr + 14));

395 
Í
->
¡©s
.
tx_”rÜs
++;

397 
	`outw
(0xffff, 
ißddr
 + 24);

398 
	`outw
(0xffff, 
ißddr
 + 
TX_STATUS
);

399 
	`outw
(0xe85a, 
ißddr
 + 
CONFIG_0
);

400 
	`outw
(0x8100, 
ißddr
 + 
TX_INTR
);

401 
dev
->
tbusy
=0;

402 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

408 ià(
skb
 =ğ
NULL
) {

409 
	`dev_tšt
(
dev
);

415 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

416 
skb
->
dev
 = dev;

417 
	`¬p_queue
 (
skb
);

420 
skb
->
¬p
=1;

424 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

425 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

427 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

428 *
buf
 = 
skb
->
d©a
;

431 
	`outb
(0x00, 
ißddr
 + 
TX_INTR
);

433 
	`outw
(
Ëngth
, 
ißddr
 + 
DATAPORT
);

434 
	`outsw
(
ißddr
 + 
DATAPORT
, 
buf
, (
Ëngth
 + 1) >> 1);

436 
Í
->
tx_queue
++;

437 
Í
->
tx_queue_Ën
 +ğ
Ëngth
 + 2;

439 ià(
Í
->
tx_¡¬‹d
 == 0) {

441 
	`outb
(0x80 | 
Í
->
tx_queue
, 
ißddr
 + 
TX_START
);

442 
Í
->
tx_queue
 = 0;

443 
Í
->
tx_queue_Ën
 = 0;

444 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

445 
Í
->
tx_¡¬‹d
 = 1;

446 } ià(
Í
->
tx_queue_Ën
 < 4096 - 1502)

447 
dev
->
tbusy
 = 0;

450 
	`outb
(0x82, 
ißddr
 + 
TX_INTR
);

452 ià(
skb
->
ä“
)

453 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

456 
	}
}

461 
	$Ãt_š‹¼u±
(
»g_±r
)

463 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

464 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

465 
Ãt_loÿl
 *
Í
;

466 
ißddr
, 
¡©us
;

468 ià(
dev
 =ğ
NULL
) {

469 
	`´štk
 ("©1700_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

472 
dev
->
š‹¼u±
 = 1;

474 
ißddr
 = 
dev
->
ba£_addr
;

475 
Í
 = (
Ãt_loÿl
 *)
dev
->
´iv
;

476 
¡©us
 = 
	`šw
(
ißddr
 + 
TX_STATUS
);

477 
	`outw
(
¡©us
, 
ißddr
 + 
TX_STATUS
);

479 ià(
Ãt_debug
 > 4)

480 
	`´štk
("%s: IÁ”ru± w™h stu %04x.\n", 
dev
->
Çme
, 
¡©us
);

481 ià(
¡©us
 & 0xff00

482 || (
	`šb
(
ißddr
 + 
RX_MODE
) & 0x40) == 0) {

483 
	`Ãt_rx
(
dev
);

485 ià(
¡©us
 & 0x00ff) {

486 ià(
¡©us
 & 0x80) {

487 
Í
->
¡©s
.
tx_·ck‘s
++;

488 ià(
Í
->
tx_queue
) {

489 
	`outb
(0x80 | 
Í
->
tx_queue
, 
ißddr
 + 
TX_START
);

490 
Í
->
tx_queue
 = 0;

491 
Í
->
tx_queue_Ën
 = 0;

492 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

493 
dev
->
tbusy
 = 0;

494 
	`m¬k_bh
(
INET_BH
);

496 
Í
->
tx_¡¬‹d
 = 0;

498 
	`outb
(0x00, 
ißddr
 + 
TX_INTR
);

499 
dev
->
tbusy
 = 0;

505 
	}
}

509 
	$Ãt_rx
(
deviû
 *
dev
)

511 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

512 
ißddr
 = 
dev
->
ba£_addr
;

513 
boguscouÁ
 = 5;

515 (
	`šb
(
ißddr
 + 
RX_MODE
) & 0x40) == 0) {

516 
ushÜt
 
¡©us
 = 
	`šw
(
ißddr
 + 
DATAPORT
);

518 ià(
Ãt_debug
 > 4)

519 
	`´štk
("%s: Rxing…acket mode %02x status %04x.\n",

520 
dev
->
Çme
, 
	`šb
(
ißddr
 + 
RX_MODE
), 
¡©us
);

521 #iâdeà
fš®_v”siÚ


522 ià(
¡©us
 == 0) {

523 
	`outb
(0x05, 
ißddr
 + 14);

528 ià((
¡©us
 & 0xF0) != 0x20) {

529 
Í
->
¡©s
.
rx_”rÜs
++;

530 ià(
¡©us
 & 0x08è
Í
->
¡©s
.
rx_Ëngth_”rÜs
++;

531 ià(
¡©us
 & 0x04è
Í
->
¡©s
.
rx_äame_”rÜs
++;

532 ià(
¡©us
 & 0x02è
Í
->
¡©s
.
rx_üc_”rÜs
++;

533 ià(
¡©us
 & 0x01è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

535 
ushÜt
 
pkt_Ën
 = 
	`šw
(
ißddr
 + 
DATAPORT
);

537 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

538 
sk_buff
 *
skb
;

540 ià(
pkt_Ën
 > 1550) {

541 
	`´štk
("%s: The AT1700 claimed‡ very†arge…acket, size %d.\n",

542 
dev
->
Çme
, 
pkt_Ën
);

543 
	`outb
(0x05, 
ißddr
 + 14);

544 
Í
->
¡©s
.
rx_”rÜs
++;

547 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

548 ià(
skb
 =ğ
NULL
) {

549 
	`´štk
("%s: Memory squeeze, dropping…acket (len %d).\n",

550 
dev
->
Çme
, 
pkt_Ën
);

551 
	`outb
(0x05, 
ißddr
 + 14);

552 
Í
->
¡©s
.
rx_drİ³d
++;

555 
skb
->
mem_Ën
 = 
sksize
;

556 
skb
->
mem_addr
 = skb;

557 
skb
->
Ën
 = 
pkt_Ën
;

558 
skb
->
dev
 = dev;

560 
	`šsw
(
ißddr
 + 
DATAPORT
, 
skb
->
d©a
, (
pkt_Ën
 + 1) >> 1);

562 ià(
Ãt_debug
 > 5) {

563 
i
;

564 
	`´štk
("%s: Rxed…ack‘ oàËngth %d: ", 
dev
->
Çme
, 
pkt_Ën
);

565 
i
 = 0; i < 14; i++)

566 
	`´štk
(" %02x", 
skb
->
d©a
[
i
]);

567 
	`´štk
(".\n");

570 #ifdeà
HAVE_NETIF_RX


571 
	`Ãtif_rx
(
skb
);

573 
skb
->
lock
 = 0;

574 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

575 
	`kä“_s
(
skb
, 
sksize
);

576 
Í
->
¡©s
.
rx_drİ³d
++;

580 
Í
->
¡©s
.
rx_·ck‘s
++;

582 ià(--
boguscouÁ
 <= 0)

590 
i
;

591 
i
 = 0; i < 20; i++) {

592 ià((
	`šb
(
ißddr
 + 
RX_MODE
) & 0x40) == 0x40)

594 
	`outb
(0x05, 
ißddr
 + 14);

597 ià(
Ãt_debug
 > 5)

598 
	`´štk
("%s: Exint Rx…acket with mode %02x‡fter %dicks.\n",

599 
dev
->
Çme
, 
	`šb
(
ißddr
 + 
RX_MODE
), 
i
);

602 
	}
}

605 
	$Ãt_şo£
(
deviû
 *
dev
)

607 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

608 
ißddr
 = 
dev
->
ba£_addr
;

610 
Í
->
İ’_time
 = 0;

612 
dev
->
tbusy
 = 1;

613 
dev
->
¡¬t
 = 0;

616 
	`outb
(0xda, 
ißddr
 + 
CONFIG_0
);

621 
	`outb
(0x00, 
ißddr
 + 
CONFIG_1
);

624 
	}
}

628 
’‘_¡©i¡ics
 *

629 
	$Ãt_g‘_¡©s
(
deviû
 *
dev
)

631 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

633 
	`şi
();

635 
	`¡i
();

637  &
Í
->
¡©s
;

638 
	}
}

640 #ifdeà
HAVE_MULTICAST


648 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

650 
ißddr
 = 
dev
->
ba£_addr
;

651 ià(
num_addrs
) {

652 
	`outw
(3, 
ißddr
 + 
RX_MODE
);

654 
	`outw
(2, 
ißddr
 + 
RX_MODE
);

655 
	}
}

	@drivers/net/atp.c

14 *
	gv”siÚ
 =

77 
	~<lšux/cÚfig.h
>

78 
	~<lšux/k”Ãl.h
>

79 
	~<lšux/sched.h
>

80 
	~<lšux/ty³s.h
>

81 
	~<lšux/fú.h
>

82 
	~<lšux/š‹¼u±.h
>

83 
	~<lšux/±¿û.h
>

84 
	~<lšux/iİÜt.h
>

85 
	~<lšux/š.h
>

86 
	~<lšux/m®loc.h
>

87 
	~<lšux/¡ršg.h
>

88 
	~<asm/sy¡em.h
>

89 
	~<asm/b™İs.h
>

90 
	~<asm/io.h
>

91 
	~<asm/dma.h
>

92 
	~<”ºo.h
>

94 
	~"dev.h
"

95 
	~"‘h.h
"

96 
	~"skbuff.h
"

97 
	~"¬p.h
"

99 
	~"©p.h
"

102 #iâdeà
HAVE_AUTOIRQ


104 
autoœq_£tup
(
wa™time
);

105 
autoœq_»pÜt
(
wa™time
);

108 
deviû
 *
œq2dev_m­
[16];

111 #iâdeà
HAVE_ALLOC_SKB


112 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

113 
	#kä“_skbmem
(
addr
, 
size
è
	`kä“_s
×ddr,size);

	)

116 #iâdeà
HAVE_PORTRESERVE


117 
	#check_»giÚ
(
ißddr
, 
size
è0

	)

118 
	#¢¬f_»giÚ
(
ißddr
, 
size
); dØ; 0)

	)

122 #iâdeà
NET_DEBUG


123 
	#NET_DEBUG
 4

	)

125 
	gÃt_debug
 = 
NET_DEBUG
;

128 
	#ETHERCARD_TOTAL_SIZE
 3

	)

132 
©p_´obe
(
deviû
 *
dev
);

134 
©p_´obe1
(
deviû
 *
dev
, 
ißddr
);

135 
š™_dev
(
deviû
 *
dev
);

136 
g‘_node_ID
(
deviû
 *
dev
);

137 
“´om_İ
(
ißddr
, 
cmd
);

138 
Ãt_İ’
(
deviû
 *
dev
);

139 
h¬dw¬e_š™
(
deviû
 *
dev
);

140 
wr™e_·ck‘
(
ißddr
, 
Ëngth
, *
·ck‘
, 
mode
);

141 
Œigg”_£nd
(
ißddr
, 
Ëngth
);

142 
Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

143 
Ãt_š‹¼u±
(
»g_±r
);

144 
Ãt_rx
(
deviû
 *
dev
);

145 
»ad_block
(
ißddr
, 
Ëngth
, *
bufãr
, 
d©a_mode
);

146 
Ãt_şo£
(
deviû
 *
dev
);

147 
’‘_¡©i¡ics
 *
Ãt_g‘_¡©s
(
deviû
 *
dev
);

148 #ifdeà
HAVE_MULTICAST


149 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

160 
	$©p_š™
(
deviû
 *
dev
)

162 *
pÜt
, 
pÜts
[] = {0x378, 0x278, 0x3bc, 0};

163 
ba£_addr
 = 
dev
->base_addr;

165 ià(
ba£_addr
 > 0x1ff)

166  
	`©p_´obe1
(
dev
, 
ba£_addr
);

167 ià(
ba£_addr
 == 1)

168  
ENXIO
;

170 
pÜt
 = 
pÜts
; *port;…ort++) {

171 
ißddr
 = *
pÜt
;

172 
	`outb
(0x57, 
ißddr
 + 
PAR_DATA
);

173 ià(
	`šb
(
ißddr
 + 
PAR_DATA
) != 0x57)

175 ià(
	`©p_´obe1
(
dev
, 
ißddr
) == 0)

179  
ENODEV
;

180 
	}
}

182 
	$©p_´obe1
(
deviû
 *
dev
, 
ißddr
)

184 
§ved_ù¾_»g
, 
¡©us
;

186 
	`outb
(0xff, 
ißddr
 + 
PAR_DATA
);

189 
§ved_ù¾_»g
 = 
	`šb
(
ißddr
 + 
PAR_CONTROL
);

191 
	`outb
(0x04, 
ißddr
 + 
PAR_CONTROL
);

192 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

193 
	`“´om_d–ay
(2048);

194 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR1
);

196 ià((
¡©us
 & 0x78) != 0x08) {

198 
	`outb
(
§ved_ù¾_»g
, 
ißddr
 + 
PAR_CONTROL
);

201 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR2_h
);

202 ià((
¡©us
 & 0x78) != 0x10) {

203 
	`outb
(
§ved_ù¾_»g
, 
ißddr
 + 
PAR_CONTROL
);

207 
	`wr™e_»g_by‹
(
ißddr
, 
CMR2
, 0x01);

208 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RxENABLE
 | 
CMR1h_TxENABLE
);

211 ià(
ißddr
 == 0x378)

212 
dev
->
œq
 = 7;

214 
dev
->
œq
 = 5;

215 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_TxRxOFF
);

216 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

218 
dev
->
ba£_addr
 = 
ißddr
;

221 
	`g‘_node_ID
(
dev
);

223 
	`´štk
("%s: Pocket‡daptor found‡t %#3x, IRQ %d, SAPROM "

224 "%02X:%02X:%02X:%02X:%02X:%02X.\n", 
dev
->
Çme
, dev->
ba£_addr
,

225 
dev
->
œq
, dev->
dev_addr
[0], dev->dev_addr[1], dev->dev_addr[2],

226 
dev
->
dev_addr
[3], dev->dev_addr[4], dev->dev_addr[5]);

229 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

231 ià(
Ãt_debug
)

232 
	`´štk
(
v”siÚ
);

235 
	`š™_dev
(
dev
);

236 
dev
->
´iv
 = 
	`km®loc
((
Ãt_loÿl
), 
GFP_KERNEL
);

237 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt_loÿl
));

241 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

242 
Í
->
addr_mode
 = 
CMR2h_NÜm®
;

246 
dev
->
if_pÜt
 = (dev->
mem_¡¬t
 & 0xf) ? dev->mem_start & 0x7 : 4;

247 ià(
dev
->
mem_’d
 & 0xf)

248 
Ãt_debug
 = 
dev
->
mem_’d
 & 7;

250 
dev
->
İ’
 = 
Ãt_İ’
;

251 
dev
->
¡İ
 = 
Ãt_şo£
;

252 
dev
->
h¬d_¡¬t_xm™
 = 
Ãt_£nd_·ck‘
;

253 
dev
->
g‘_¡©s
 = 
Ãt_g‘_¡©s
;

254 #ifdeà
HAVE_MULTICAST


255 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

259 
	}
}

263 
	$š™_dev
(
deviû
 *
dev
)

265 
i
;

267 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

268 
dev
->
buffs
[
i
] = 
NULL
;

270 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

271 
dev
->
add_¬p
 = 
‘h_add_¬p
;

272 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

273 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

274 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

276 
dev
->
ty³
 = 
ARPHRD_ETHER
;

277 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

278 
dev
->
mtu
 = 1500;

279 
dev
->
addr_Ën
 = 
ETH_ALEN
;

280 
i
 = 0; i < 
ETH_ALEN
; i++) {

281 
dev
->
brßdÿ¡
[
i
]=0xff;

285 
dev
->
æags
 = 
IFF_BROADCAST
;

286 
dev
->
çmy
 = 
AF_INET
;

287 
dev
->
·_addr
 = 0;

288 
dev
->
·_brdaddr
 = 0;

289 
dev
->
·_mask
 = 0;

290 
dev
->
·_®’
 = ();

291 
	}
}

294 
	$g‘_node_ID
(
deviû
 *
dev
)

296 
ißddr
 = 
dev
->
ba£_addr
;

297 
§_off£t
 = 0;

298 
i
;

300 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_EEPROM
);

304 ià(
	`“´om_İ
(
ißddr
, 
	`EE_READ
(0)) == 0xffff)

305 
§_off£t
 = 15;

307 
i
 = 0; i < 3; i++)

308 ((*)
dev
->
dev_addr
)[
i
] =

309 
	`Áohs
(
	`“´om_İ
(
ißddr
, 
	`EE_READ
(
§_off£t
 + 
i
)));

311 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

312 
	}
}

326 
	$“´om_İ
(
ißddr
, 
cmd
)

328 
“d©a_out
 = 0;

329 
num_b™s
 = 
EE_CMD_SIZE
;

331 --
num_b™s
 >= 0) {

332 
outv®
 = 
	`‹¡_b™
(
num_b™s
, &
cmd
è? 
EE_DATA_WRITE
 : 0;

333 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
outv®
 | 
EE_CLK_LOW
);

334 
	`“´om_d–ay
(5);

335 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
outv®
 | 
EE_CLK_HIGH
);

336 
“d©a_out
 <<= 1;

337 ià(
	`»ad_nibbË
(
ißddr
, 
PROM_DATA
è& 
EE_DATA_READ
)

338 
“d©a_out
++;

339 
	`“´om_d–ay
(5);

341 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
EE_CLK_LOW
 & ~
EE_CS
);

342  
“d©a_out
;

343 
	}
}

356 
	$Ãt_İ’
(
deviû
 *
dev
)

362 ià(
œq2dev_m­
[
dev
->
œq
] != 0

363 || (
œq2dev_m­
[
dev
->
œq
] = dev) == 0

364 || 
	`»que¡_œq
(
dev
->
œq
, &
Ãt_š‹¼u±
)) {

365  -
EAGAIN
;

368 
	`h¬dw¬e_š™
(
dev
);

369 
dev
->
¡¬t
 = 1;

371 
	}
}

375 
	$h¬dw¬e_š™
(
deviû
 *
dev
)

377 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

378 
ißddr
 = 
dev
->
ba£_addr
;

379 
i
;

381 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

383 
i
 = 0; i < 6; i++)

384 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
dev
->
dev_addr
[i]);

386 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

388 ià(
Ãt_debug
 > 2) {

389 
	`´štk
("%s: Re£t: cu¼’ˆRx mod%d.\n", 
dev
->
Çme
,

390 (
	`»ad_nibbË
(
ißddr
, 
CMR2_h
) >> 3) & 0x0f);

393 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_IRQOUT
);

394 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RxENABLE
 | 
CMR1h_TxENABLE
);

397 
	`outb
(
CŒl_S–D©a
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

400 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

401 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

403 
Í
->
tx_un™_busy
 = 0;

404 
Í
->
·c_út_š_tx_buf
 = 0;

405 
Í
->
§ved_tx_size
 = 0;

407 
dev
->
tbusy
 = 0;

408 
dev
->
š‹¼u±
 = 0;

409 
	}
}

411 
	$Œigg”_£nd
(
ißddr
, 
Ëngth
)

413 
	`wr™e_»g_by‹
(
ißddr
, 
TxCNT0
, 
Ëngth
 & 0xff);

414 
	`wr™e_»g
(
ißddr
, 
TxCNT1
, 
Ëngth
 >> 8);

415 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_Xm™
);

416 
	}
}

418 
	$wr™e_·ck‘
(
ißddr
, 
Ëngth
, *
·ck‘
, 
d©a_mode
)

420 
Ëngth
 = (length + 1) & ~1;

421 
	`outb
(
EOC
+
MAR
, 
ißddr
 + 
PAR_DATA
);

422 ià((
d©a_mode
 & 1) == 0) {

424 
	`outb
(
WrAddr
+
MAR
, 
ißddr
 + 
PAR_DATA
);

426 
	`wr™e_by‹_mode0
(
ißddr
, *
·ck‘
++);

427 } --
Ëngth
 > 0) ;

430 
outby‹
 = *
·ck‘
++;

432 
	`outb
(
CŒl_LNibWr™e
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

433 
	`outb
(
WrAddr
+
MAR
, 
ißddr
 + 
PAR_DATA
);

435 
	`outb
((
outby‹
 & 0x0f)|0x40, 
ißddr
 + 
PAR_DATA
);

436 
	`outb
(
outby‹
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

437 
outby‹
 >>= 4;

438 
	`outb
(
outby‹
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

439 
	`outb
(
CŒl_HNibWr™e
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

440 --
Ëngth
 > 0)

441 
	`wr™e_by‹_mode1
(
ißddr
, *
·ck‘
++);

444 
	`outb
(0xff, 
ißddr
 + 
PAR_DATA
);

445 
	`outb
(
CŒl_HNibWr™e
 | 
CŒl_S–D©a
 | 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

446 
	}
}

449 
	$Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

451 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

452 
ißddr
 = 
dev
->
ba£_addr
;

454 ià(
dev
->
tbusy
) {

457 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

458 ià(
tickssoçr
 < 5)

460 
	`´štk
("%s:¿nsm™imed out, %s?\n", 
dev
->
Çme
,

461 
	`šb
(
ißddr
 + 
PAR_CONTROL
) & 0x10 ? "network cable…roblem"

463 
Í
->
¡©s
.
tx_”rÜs
++;

465 
	`h¬dw¬e_š™
(
dev
);

466 
dev
->
tbusy
=0;

467 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

473 ià(
skb
 =ğ
NULL
) {

474 
	`dev_tšt
(
dev
);

480 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

481 
skb
->
dev
 = dev;

482 
	`¬p_queue
 (
skb
);

485 
skb
->
¬p
=1;

489 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

490 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

492 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

493 *
buf
 = 
skb
->
d©a
;

494 
æags
;

498 
	`§ve_æags
(
æags
);

499 
	`şi
();

500 
	`wr™e_»g
(
ißddr
, 
IMR
, 0);

501 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 0);

502 
	`»¡Üe_æags
(
æags
);

504 
	`wr™e_·ck‘
(
ißddr
, 
Ëngth
, 
buf
, 
dev
->
if_pÜt
);

506 
Í
->
·c_út_š_tx_buf
++;

507 ià(
Í
->
tx_un™_busy
 == 0) {

508 
	`Œigg”_£nd
(
ißddr
, 
Ëngth
);

509 
Í
->
§ved_tx_size
 = 0;

510 
Í
->
»_tx
 = 0;

511 
Í
->
tx_un™_busy
 = 1;

513 
Í
->
§ved_tx_size
 = 
Ëngth
;

515 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

517 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

518 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

521 ià(
skb
->
ä“
)

522 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

525 
	}
}

530 
	$Ãt_š‹¼u±
(
»g_±r
)

532 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

533 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

534 
Ãt_loÿl
 *
Í
;

535 
ißddr
, 
¡©us
, 
boguscouÁ
 = 20;

536 
num_tx_sšû_rx
 = 0;

538 ià(
dev
 =ğ
NULL
) {

539 
	`´štk
 ("ATP_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

542 
dev
->
š‹¼u±
 = 1;

544 
ißddr
 = 
dev
->
ba£_addr
;

545 
Í
 = (
Ãt_loÿl
 *)
dev
->
´iv
;

548 
	`outb
(
CŒl_S–D©a
, 
ißddr
 + 
PAR_CONTROL
);

551 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

552 
	`wr™e_»g
(
ißddr
, 
IMR
, 0);

554 ià(
Ãt_debug
 > 5è
	`´štk
("%s: IÀš‹¼u± ", 
dev
->
Çme
);

555 --
boguscouÁ
 > 0) {

556 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
ISR
);

557 ià(
Ãt_debug
 > 5è
	`´štk
("loİ stu %02x..", 
¡©us
);

559 ià(
¡©us
 & (
ISR_RxOK
<<3)) {

560 
	`wr™e_»g
(
ißddr
, 
ISR
, 
ISR_RxOK
);

562 
»ad_¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR1
);

563 ià(
Ãt_debug
 > 6)

564 
	`´štk
("hªdlšg Rx…ack‘ %02x..", 
»ad_¡©us
);

567 ià(
»ad_¡©us
 & (
CMR1_IRQ
 << 3)) {

568 
Í
->
¡©s
.
rx_ov”_”rÜs
++;

570 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
CMR2h_OFF
);

571 
	`Ãt_rx
(
dev
);

573 
	`wr™e_»g_high
(
ißddr
, 
ISR
, 
ISRh_RxE¼
);

574 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

575 } ià((
»ad_¡©us
 & (
CMR1_BufEnb
 << 3)) == 0) {

576 
	`Ãt_rx
(
dev
);

577 
dev
->
Ï¡_rx
 = 
jiff›s
;

578 
num_tx_sšû_rx
 = 0;

581 } --
boguscouÁ
 > 0);

582 } ià(
¡©us
 & ((
ISR_TxE¼
 + 
ISR_TxOK
)<<3)) {

583 ià(
Ãt_debug
 > 6è
	`´štk
("handling Tx done..");

586 
	`wr™e_»g
(
ißddr
, 
ISR
, 
ISR_TxE¼
 + 
ISR_TxOK
);

587 ià(
¡©us
 & (
ISR_TxE¼
<<3)) {

588 
Í
->
¡©s
.
cŞlisiÚs
++;

589 ià(++
Í
->
»_tx
 > 15) {

590 
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

591 
	`h¬dw¬e_š™
(
dev
);

595 ià(
Ãt_debug
 > 6è
	`´štk
("attemptingo ReTx");

596 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_ReXm™
 + 
CMR1_Xm™
);

599 
Í
->
¡©s
.
tx_·ck‘s
++;

600 
Í
->
·c_út_š_tx_buf
--;

601 iàĞ
Í
->
§ved_tx_size
) {

602 
	`Œigg”_£nd
(
ißddr
, 
Í
->
§ved_tx_size
);

603 
Í
->
§ved_tx_size
 = 0;

604 
Í
->
»_tx
 = 0;

606 
Í
->
tx_un™_busy
 = 0;

607 
dev
->
tbusy
 = 0;

608 
	`m¬k_bh
(
INET_BH
);

610 
num_tx_sšû_rx
++;

611 } ià(
num_tx_sšû_rx
 > 8

612 && 
jiff›s
 > 
dev
->
Ï¡_rx
 + 100) {

613 ià(
Ãt_debug
 > 2)

614 
	`´štk
("%s: Missed…acket? No Rx‡fter %d Tx‡nd %ld jiffies"

615 " stu %02x CMR1 %02x.\n", 
dev
->
Çme
,

616 
num_tx_sšû_rx
, 
jiff›s
 - 
dev
->
Ï¡_rx
, 
¡©us
,

617 (
	`»ad_nibbË
(
ißddr
, 
CMR1
) >> 3) & 15);

618 
Í
->
¡©s
.
rx_mis£d_”rÜs
++;

619 
	`h¬dw¬e_š™
(
dev
);

620 
num_tx_sšû_rx
 = 0;

629 
i
;

630 
i
 = 0; i < 6; i++)

631 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
dev
->
dev_addr
[i]);

635 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_IRQOUT
);

637 
	`outb
(
CŒl_S–D©a
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

639 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

640 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

642 ià(
Ãt_debug
 > 5è
	`´štk
("exiting interrupt.\n");

644 
dev
->
š‹¼u±
 = 0;

647 
	}
}

650 
	$Ãt_rx
(
deviû
 *
dev
)

652 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

653 
ißddr
 = 
dev
->
ba£_addr
;

654 #ifdeà
nÙdef


655 
ushÜt
 
h—d”
[4];

657 
rx_h—d”
 
rx_h—d
;

661 
	`outb
(
EOC
+
MAR
, 
ißddr
 + 
PAR_DATA
);

662 
	`»ad_block
(
ißddr
, 8, (*)&
rx_h—d
, 
dev
->
if_pÜt
);

663 ià(
Ãt_debug
 > 5)

664 
	`´štk
("„x_couÁ %04x %04x %04x %04x..", 
rx_h—d
.
·d
,

665 
rx_h—d
.
rx_couÁ
,„x_h—d.
rx_¡©us
,„x_h—d.
cur_addr
);

666 ià((
rx_h—d
.
rx_¡©us
 & 0x77) != 0x01) {

667 
Í
->
¡©s
.
rx_”rÜs
++;

670 ià(
Ãt_debug
 > 3è
	`´štk
("%s: Unknown ATP Rxƒrror %04x.\n",

671 
dev
->
Çme
, 
rx_h—d
.
rx_¡©us
);

672 
	`h¬dw¬e_š™
(
dev
);

676 
pkt_Ën
 = (
rx_h—d
.
rx_couÁ
 & 0x7ff) - 4;

677 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

678 
sk_buff
 *
skb
;

680 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

681 ià(
skb
 =ğ
NULL
) {

682 
	`´štk
("%s: MemÜy squ“ze, drİpšg…ack‘.\n", 
dev
->
Çme
);

683 
Í
->
¡©s
.
rx_drİ³d
++;

684 
dÚe
;

686 
skb
->
mem_Ën
 = 
sksize
;

687 
skb
->
mem_addr
 = skb;

688 
skb
->
Ën
 = 
pkt_Ën
;

689 
skb
->
dev
 = dev;

691 
	`»ad_block
(
ißddr
, 
pkt_Ën
, 
skb
->
d©a
, 
dev
->
if_pÜt
);

693 ià(
Ãt_debug
 > 6) {

694 *
d©a
 = 
skb
->data;

695 
	`´štk
(" data %02x%02x%02x %02x%02x%02x %02x%02x%02x"

697 
d©a
[0], data[1], data[2], data[3], data[4], data[5],

698 
d©a
[6], data[7], data[8], data[9], data[10], data[11],

699 
d©a
[12], data[13]);

702 #ifdeà
HAVE_NETIF_RX


703 
	`Ãtif_rx
(
skb
);

705 
skb
->
lock
 = 0;

706 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

707 
	`kä“_s
(
skb
, 
sksize
);

708 
Í
->
¡©s
.
rx_drİ³d
++;

712 
Í
->
¡©s
.
rx_·ck‘s
++;

714 
dÚe
:

715 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_NextPkt
);

717 
	}
}

719 
	$»ad_block
(
ißddr
, 
Ëngth
, *
p
, 
d©a_mode
)

722 ià(
d©a_mode
 <= 3) {

723 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

724 
	`outb
(
Ëngth
 =ğ8 ? 
RdAddr
 | 
HNib
 | 
MAR
 : RdAddr | MAR,

725 
ißddr
 + 
PAR_DATA
);

726 ià(
d©a_mode
 <= 1) {

727 dØ*
p
++ = 
	`»ad_by‹_mode0
(
ißddr
); --
Ëngth
 > 0);

729 dØ*
p
++ = 
	`»ad_by‹_mode2
(
ißddr
); --
Ëngth
 > 0);

730 } ià(
d©a_mode
 <= 5)

731 dØ*
p
++ = 
	`»ad_by‹_mode4
(
ißddr
); --
Ëngth
 > 0);

733 dØ*
p
++ = 
	`»ad_by‹_mode6
(
ißddr
); --
Ëngth
 > 0);

735 
	`outb
(
EOC
+
HNib
+
MAR
, 
ißddr
 + 
PAR_DATA
);

736 
	`outb
(
CŒl_S–D©a
, 
ißddr
 + 
PAR_CONTROL
);

737 
	}
}

741 
	$Ãt_şo£
(
deviû
 *
dev
)

743 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

744 
ißddr
 = 
dev
->
ba£_addr
;

746 
dev
->
tbusy
 = 1;

747 
dev
->
¡¬t
 = 0;

750 
Í
->
addr_mode
 = 
CMR2h_OFF
;

751 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
CMR2h_OFF
);

754 
	`outb
(0x00, 
ißddr
 + 
PAR_CONTROL
);

755 
	`ä“_œq
(
dev
->
œq
);

756 
œq2dev_m­
[
dev
->
œq
] = 0;

759 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

762 
	}
}

766 
’‘_¡©i¡ics
 *

767 
	$Ãt_g‘_¡©s
(
deviû
 *
dev
)

769 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

770  &
Í
->
¡©s
;

771 
	}
}

773 #ifdeà
HAVE_MULTICAST


781 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

783 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

784 
ißddr
 = 
dev
->
ba£_addr
;

785 
Í
->
addr_mode
 = 
num_addrs
 ? 
CMR2h_PROMISC
 : 
CMR2h_NÜm®
;

786 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

787 
	}
}

	@drivers/net/atp.h

1 
	~<lšux/if_‘h”.h
>

2 
	~<lšux/ty³s.h
>

3 
	~<asm/io.h
>

5 
	sÃt_loÿl
 {

6 #ifdeà
__KERNEL__


7 
’‘_¡©i¡ics
 
	m¡©s
;

9 
ushÜt
 
	m§ved_tx_size
;

11 
	m»_tx
,

12 
	mtx_un™_busy
,

13 
	maddr_mode
,

14 
	m·c_út_š_tx_buf
;

17 
	srx_h—d”
 {

18 
ushÜt
 
	m·d
;

19 
ushÜt
 
	mrx_couÁ
;

20 
ushÜt
 
	mrx_¡©us
;

21 
ushÜt
 
	mcur_addr
;

24 
	#PAR_DATA
 0

	)

25 
	#PAR_STATUS
 1

	)

26 
	#PAR_CONTROL
 2

	)

28 
	#CŒl_LNibR—d
 0x08

	)

29 
	#CŒl_HNibR—d
 0

	)

30 
	#CŒl_LNibWr™e
 0x08

	)

31 
	#CŒl_HNibWr™e
 0

	)

32 
	#CŒl_S–D©a
 0x04

	)

33 
	#CŒl_IRQEN
 0x10

	)

35 
	#EOW
 0xE0

	)

36 
	#EOC
 0xE0

	)

37 
	#WrAddr
 0x40

	)

38 
	#RdAddr
 0xC0

	)

39 
	#HNib
 0x10

	)

41 
	e·ge0_»gs


44 
	mPAR0
 = 0, 
	mPAR1
 = 1, 
	mPAR2
 = 2, 
	mPAR3
 = 3, 
	mPAR4
 = 4, 
	mPAR5
 = 5,

45 
	mTxCNT0
 = 6, 
	mTxCNT1
 = 7,

46 
	mTxSTAT
 = 8, 
	mRxSTAT
 = 9,

47 
	mISR
 = 10, 
	mIMR
 = 11,

48 
	mCMR1
 = 12,

49 
	mCMR2
 = 13,

50 
	mMAR
 = 14,

51 
	mCMR2_h
 = 0x1d, };

53 
	e“·ge_»gs


54 { 
	mPROM_CMD
 = 6, 
	mPROM_DATA
 = 7 };

57 
	#ISR_TxOK
 0x01

	)

58 
	#ISR_RxOK
 0x04

	)

59 
	#ISR_TxE¼
 0x02

	)

60 
	#ISRh_RxE¼
 0x11

	)

62 
	#CMR1h_RESET
 0x04

	)

63 
	#CMR1h_RxENABLE
 0x02

	)

64 
	#CMR1h_TxENABLE
 0x01

	)

65 
	#CMR1h_TxRxOFF
 0x00

	)

66 
	#CMR1_ReXm™
 0x08

	)

67 
	#CMR1_Xm™
 0x04

	)

68 
	#CMR1_IRQ
 0x02

	)

69 
	#CMR1_BufEnb
 0x01

	)

70 
	#CMR1_NextPkt
 0x01

	)

72 
	#CMR2_NULL
 8

	)

73 
	#CMR2_IRQOUT
 9

	)

74 
	#CMR2_RAMTEST
 10

	)

75 
	#CMR2_EEPROM
 12

	)

77 
	#CMR2h_OFF
 0

	)

78 
	#CMR2h_Physiÿl
 1

	)

79 
	#CMR2h_NÜm®
 2

	)

80 
	#CMR2h_PROMISC
 3

	)

84 
šlše
 
	$šby‹
(
pÜt
)

86 
_v
;

87 
__asm__
 
	`__vŞ©e__
 ("šb %w1,%b0" :"÷" (
_v
):"d" (
pÜt
));

88  
_v
;

89 
	}
}

93 
šlše
 
	$»ad_nibbË
(
pÜt
, 
off£t
)

95 
»tv®
;

96 
	`outb
(
EOC
+
off£t
, 
pÜt
 + 
PAR_DATA
);

97 
	`outb
(
RdAddr
+
off£t
, 
pÜt
 + 
PAR_DATA
);

98 
	`šby‹
(
pÜt
 + 
PAR_STATUS
);

99 
»tv®
 = 
	`šby‹
(
pÜt
 + 
PAR_STATUS
);

100 
	`outb
(
EOC
+
off£t
, 
pÜt
 + 
PAR_DATA
);

102  
»tv®
;

103 
	}
}

107 
šlše
 
	$»ad_by‹_mode0
(
ißddr
)

109 
low_nib
;

111 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

112 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

113 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

114 
	`outb
(
CŒl_HNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

115 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

116 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

117  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

118 
	}
}

121 
šlše
 
	$»ad_by‹_mode2
(
ißddr
)

123 
low_nib
;

125 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

126 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

127 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

128 
	`outb
(
CŒl_HNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

129 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

130  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

131 
	}
}

134 
šlše
 
	$»ad_by‹_mode4
(
ißddr
)

136 
low_nib
;

138 
	`outb
(
RdAddr
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

139 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

140 
	`outb
(
RdAddr
 | 
HNib
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

141  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

142 
	}
}

145 
šlše
 
	$»ad_by‹_mode6
(
ißddr
)

147 
low_nib
;

149 
	`outb
(
RdAddr
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

150 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

151 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

152 
	`outb
(
RdAddr
 | 
HNib
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

153 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

154  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

155 
	}
}

157 
šlše
 

158 
	$wr™e_»g
(
pÜt
, 
»g
, 
v®ue
)

160 
outv®
;

161 
	`outb
(
EOC
 | 
»g
, 
pÜt
 + 
PAR_DATA
);

162 
outv®
 = 
WrAddr
 | 
»g
;

163 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

164 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

166 
outv®
 &= 0xf0;

167 
outv®
 |ğ
v®ue
;

168 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

169 
outv®
 &= 0x1f;

170 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

171 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

173 
	`outb
(
EOC
 | 
outv®
, 
pÜt
 + 
PAR_DATA
);

174 
	}
}

176 
šlše
 

177 
	$wr™e_»g_high
(
pÜt
, 
»g
, 
v®ue
)

179 
outv®
 = 
EOC
 | 
HNib
 | 
»g
;

181 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

182 
outv®
 &ğ
WrAddr
 | 
HNib
 | 0x0f;

183 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

184 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

186 
outv®
 = 
WrAddr
 | 
HNib
 | 
v®ue
;

187 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

188 
outv®
 &ğ
HNib
 | 0x0f;

189 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

190 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

192 
	`outb
(
EOC
 | 
HNib
 | 
outv®
, 
pÜt
 + 
PAR_DATA
);

193 
	}
}

196 
šlše
 

197 
	$wr™e_»g_by‹
(
pÜt
, 
»g
, 
v®ue
)

199 
outv®
;

200 
	`outb
(
EOC
 | 
»g
, 
pÜt
 + 
PAR_DATA
);

201 
outv®
 = 
WrAddr
 | 
»g
;

202 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

203 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

205 
	`outb
((
outv®
 & 0xf0è| (
v®ue
 & 0x0f), 
pÜt
 + 
PAR_DATA
);

206 
	`outb
(
v®ue
 & 0x0f, 
pÜt
 + 
PAR_DATA
);

207 
v®ue
 >>= 4;

208 
	`outb
(
v®ue
, 
pÜt
 + 
PAR_DATA
);

209 
	`outb
(0x10 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

210 
	`outb
(0x10 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

212 
	`outb
(
EOC
 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

213 
	}
}

222 
šlše
 
	$wr™e_by‹_mode0
(
ißddr
, 
v®ue
)

224 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

225 
	`outb
((
v®ue
>>4è| 0x10, 
ißddr
 + 
PAR_DATA
);

226 
	}
}

228 
šlše
 
	$wr™e_by‹_mode1
(
ißddr
, 
v®ue
)

230 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

231 
	`outb
(
CŒl_IRQEN
 | 
CŒl_LNibWr™e
, 
ißddr
 + 
PAR_CONTROL
);

232 
	`outb
((
v®ue
>>4è| 0x10, 
ißddr
 + 
PAR_DATA
);

233 
	`outb
(
CŒl_IRQEN
 | 
CŒl_HNibWr™e
, 
ißddr
 + 
PAR_CONTROL
);

234 
	}
}

237 
šlše
 
	$wr™e_wÜd_mode0
(
ißddr
, 
v®ue
)

239 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

240 
v®ue
 >>= 4;

241 
	`outb
((
v®ue
 & 0x0fè| 0x10, 
ißddr
 + 
PAR_DATA
);

242 
v®ue
 >>= 4;

243 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

244 
v®ue
 >>= 4;

245 
	`outb
((
v®ue
 & 0x0fè| 0x10, 
ißddr
 + 
PAR_DATA
);

246 
	}
}

249 
	#EE_SHIFT_CLK
 0x04

	)

250 
	#EE_CS
 0x02

	)

251 
	#EE_CLK_HIGH
 0x12

	)

252 
	#EE_CLK_LOW
 0x16

	)

253 
	#EE_DATA_WRITE
 0x01

	)

254 
	#EE_DATA_READ
 0x08

	)

257 
	#“´om_d–ay
(
ticks
) \

258 dØ{ 
_i
 = 40; --_˜> 0è{ 
__SLOW_DOWN_IO
; }} 0)

	)

261 
	#EE_WRITE_CMD
(
off£t
è(((5 << 6è+ (off£t)è<< 17)

	)

262 
	#EE_READ
(
off£t
è(((6 << 6è+ (off£t)è<< 17)

	)

263 
	#EE_ERASE
(
off£t
è(((7 << 6è+ (off£t)è<< 17)

	)

264 
	#EE_CMD_SIZE
 27

	)

	@drivers/net/auto_irq.c

29 #ifdeà
v”siÚ


30 *
	gv”siÚ
="auto_irq.c:v0.02 1993 Donald Becker (becker@super.org)";

35 
	~<lšux/sched.h
>

36 
	~<asm/b™İs.h
>

37 
	~<asm/io.h
>

38 
	~"dev.h
"

41 
deviû
 *
	gœq2dev_m­
[16] = {0, 0, };

43 
	gœqs_busy
 = 0x01;

44 
	gœqs_u£d
 = 0x01;

45 
	gœqs_»£rved
 = 0x00;

46 
	gœqs_sh¬ed
 = 0x00;

48 vŞ©
	gœq_numb”
;

49 vŞ©
	gœq_b™m­
;

50 
	gœq_hªdËd
;

52 
	$autoœq_´obe
(
œq
)

54 
œq_numb”
 = 
œq
;

55 
	`£t_b™
(
œq
, (*)&
œq_b™m­
);

57 
	}
}

58 
sigaùiÚ
 
	gautoœq_sigaùiÚ
 = { 
autoœq_´obe
, 0, 
SA_INTERRUPT
, 
NULL
};

60 
	$autoœq_£tup
(
wa™time
)

62 
i
, 
mask
;

63 
timeout
 = 
jiff›s
+
wa™time
;

65 
œq_numb”
 = 0;

66 
œq_b™m­
 = 0;

67 
œq_hªdËd
 = 0;

68 
i
 = 0; i < 16; i++) {

69 ià(!
	`œqaùiÚ
(
i
, &
autoœq_sigaùiÚ
))

70 
	`£t_b™
(
i
, (*)&
œq_hªdËd
);

73 
œqs_u£d
 |ğ~
œq_hªdËd
;

76 
timeout
 > 
jiff›s
)

79 
i
 = 0, 
mask
 = 0x01; i < 16; i++, mask <<= 1) {

80 ià(
œq_b™m­
 & 
œq_hªdËd
 & 
mask
) {

81 
œq_hªdËd
 &ğ~
mask
;

82 #ifdeà
nÙdef


83 
	`´štk
(" Spuriou š‹¼u± oÀIRQ %d\n", 
i
);

85 
	`ä“_œq
(
i
);

88  
œq_hªdËd
;

89 
	}
}

91 
	$autoœq_»pÜt
(
wa™time
)

93 
i
;

94 
timeout
 = 
jiff›s
+
wa™time
;

97 
timeout
 > 
jiff›s
)

98 ià(
œq_numb”
)

102 
i
 = 0; i < 16; i++) {

103 ià(
	`‹¡_b™
(
i
, (*)&
œq_hªdËd
))

104 
	`ä“_œq
(
i
);

106  
œq_numb”
;

107 
	}
}

	@drivers/net/d_link.c

1 *
	gv”siÚ
 =

43 
	#D_LINK_SLOW_DOWN
 
SLOW_DOWN_IO
; SLOW_DOWN_IO; 
	)
SLOW_DOWN_IO

50 
	#SLOW_IO_BY_JUMPING


	)

58 #ifdeà
D_LINK_DEBUG


59 
	#PRINTK
(
x
èià(
d_lšk_debug
 >ğ2è
´štk
 
	)
x

61 
	#D_LINK_DEBUG
 0

	)

62 
	#PRINTK
(
x
è

	)

64 
	gd_lšk_debug
 = 
D_LINK_DEBUG
;

66 
	~<lšux/cÚfig.h
>

67 
	~<lšux/k”Ãl.h
>

68 
	~<lšux/sched.h
>

69 
	~<lšux/ty³s.h
>

70 
	~<lšux/fú.h
>

71 
	~<lšux/¡ršg.h
>

72 
	~<lšux/š‹¼u±.h
>

73 
	~<asm/io.h
>

74 
	~<Ãtš‘/š.h
>

75 
	~<lšux/±¿û.h
>

76 
	~<asm/sy¡em.h
>

77 
	~<”ºo.h
>

79 
	~"š‘.h
"

80 
	~"dev.h
"

81 
	~"‘h.h
"

82 
	~".h
"

83 
	~"rou‹.h
"

84 
	~"´ÙocŞ.h
"

85 
	~"tı.h
"

86 
	~"skbuff.h
"

87 
	~"sock.h
"

88 
	~"¬p.h
"

90 
	#Ãt¡©s
 
’‘_¡©i¡ics


	)

92 #iâdeà
HAVE_ALLOC_SKB


93 
	#®loc_skb
(
size
,
´i
è(
sk_buff
 *)
	`km®loc
(size,´i)

	)

113 #iâdeà
D_LINK_IO


114 
	#D_LINK_IO
 0x378

	)

117 
	#DATA_PORT
 (
D_LINK_IO
)

	)

118 
	#STATUS_PORT
 (
D_LINK_IO
 + 1)

	)

119 
	#COMMAND_PORT
 (
D_LINK_IO
 + 2)

	)

121 #iâdeà
D_LINK_IRQ


122 
	#D_LINK_IRQ
 7

	)

136 
	#SELECT_NIC
 0x04

	)

137 
	#SELECT_PRN
 0x1ø

	)

138 
	#NML_PRN
 0xeø

	)

139 
	#IRQEN
 0x10

	)

144 
	#RX_BUSY
 0x80

	)

145 
	#RX_GOOD
 0x40

	)

146 
	#TX_FAILED16
 0x10

	)

147 
	#TX_BUSY
 0x08

	)

155 
	#WRITE_DATA
 0x00

	)

156 
	#READ_DATA
 0x01

	)

157 
	#STATUS
 0x02

	)

158 
	#COMMAND
 0x03

	)

159 
	#NULL_COMMAND
 0x04

	)

160 
	#RX_LEN
 0x05

	)

161 
	#TX_ADDR
 0x06

	)

162 
	#RW_ADDR
 0x07

	)

163 
	#HI_NIBBLE
 0x08

	)

169 
	#RX_ALL
 0x01

	)

170 
	#RX_BP
 0x02

	)

171 
	#RX_MBP
 0x03

	)

173 
	#TX_ENABLE
 0x04

	)

174 
	#RX_ENABLE
 0x08

	)

176 
	#RESET
 0x80

	)

177 
	#STOP_RESET
 0x00

	)

183 
	#RX_PAGE2_SELECT
 0x10

	)

184 
	#RX_BASE_PAGE
 0x20

	)

185 
	#FLIP_IRQ
 0x40

	)

198 
	#MEM_2K
 0x0800

	)

199 
	#MEM_4K
 0x1000

	)

200 
	#MEM_6K
 0x1800

	)

201 
	#NODE_ADDRESS
 0x2000

	)

203 
	#RUNT
 60

	)

216 
d_lšk_r¥aû
(
sock
 *
sk
);

219 
d_lšk_»ad_¡©us
(
deviû
 *
dev
);

220 
d_lšk_»ad_by‹
(
ty³
, 
deviû
 *
dev
);

223 
d_lšk_İ’
(
deviû
 *
dev
);

224 
d_lšk_şo£
(
deviû
 *
dev
);

225 
Ãt¡©s
 *
g‘_¡©s
(
deviû
 *
dev
);

226 
d_lšk_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

229 
d_lšk_š‹¼u±
(
»g_±r
);

230 
d_lšk_tx_šŒ
(
deviû
 *
dev
, 
œq_¡©us
);

231 
d_lšk_rx_šŒ
(
deviû
 *
dev
);

234 
Œigg”_š‹¼u±
(
deviû
 *
dev
);

235 
d_lšk_š™
(
deviû
 *
dev
);

236 
ad­‹r_š™
(
deviû
 *
dev
);

241 
deviû
 *
œq2dev_m­
[16];

242 vŞ©
	grx_·ge
 = 0;

244 
	#TX_PAGES
 2

	)

245 vŞ©
	gtx_fifo
[
TX_PAGES
];

246 vŞ©
	gtx_fifo_š
 = 0;

247 vŞ©
	gtx_fifo_out
 = 0;

248 vŞ©
	gä“_tx_·ges
 = 
TX_PAGES
;

254 
	#£Ëù_´n
(è
	`outb_p
(
SELECT_PRN
, 
COMMAND_PORT
); 
D_LINK_SLOW_DOWN


	)

255 
	#£Ëù_nic
(è
	`outb_p
(
SELECT_NIC
, 
COMMAND_PORT
); 
D_LINK_SLOW_DOWN


	)

258 
	#d_lšk_put_by‹
(
d©a
) ( \

259 
	`outb_p
(((
d©a
è<< 4è| 
WRITE_DATA
 , 
DATA_PORT
), \

260 
	`outb_p
(((
d©a
è& 0xf0è| 
WRITE_DATA
 | 
HI_NIBBLE
, 
DATA_PORT
))

	)

266 
	#d_lšk_put_commªd
(
cmd
) ( \

267 
	`outb_p
(Ğ
rx_·ge
 << 4è| 
COMMAND
 , 
DATA_PORT
), \

268 
	`outb_p
(Ğ
rx_·ge
 & 0xf0è| 
COMMAND
 | 
HI_NIBBLE
, 
DATA_PORT
), \

269 
	`outb_p
(((
rx_·ge
 | 
cmd
è<< 4è| 
COMMAND
 , 
DATA_PORT
), \

270 
	`outb_p
(((
rx_·ge
 | 
cmd
è& 0xf0è| 
COMMAND
 | 
HI_NIBBLE
, 
DATA_PORT
))

	)

272 
	#d_lšk_£tup_add»ss
(
addr
,
ty³
) ( \

273 
	`outb_p
((((
addr
è<< 4è& 0xf0è| 
ty³
 , 
DATA_PORT
), \

274 
	`outb_p
(Ğ(
addr
è& 0xf0è| 
ty³
 | 
HI_NIBBLE
, 
DATA_PORT
), \

275 
	`outb_p
((((
addr
è>> 4è& 0xf0è| 
ty³
 , 
DATA_PORT
), \

276 
	`outb_p
((((
addr
è>> 8è& 0xf0è| 
ty³
 | 
HI_NIBBLE
, 
DATA_PORT
))

	)

278 
	#rx_·ge_adr
(è((
rx_·ge
 & 
RX_PAGE2_SELECT
)?(
MEM_6K
):(
MEM_4K
))

	)

281 
	#Ãxt_rx_·ge
(è(
rx_·ge
 ^ğ
RX_PAGE2_SELECT
)

	)

283 
	#tx_·ge_adr
(
a
è((×è+ 1è* 
MEM_2K
)

	)

285 
šlše
 

286 
	$d_lšk_»ad_¡©us
(
deviû
 *
dev
)

288 
¡©us
;

290 
	`outb_p
(
STATUS
, 
DATA_PORT
);

291 
¡©us
 = 
	`šb
(
STATUS_PORT
);

292 
	`outb_p
(
NULL_COMMAND
 | 
HI_NIBBLE
, 
DATA_PORT
);

294  
¡©us
;

295 
	}
}

297 
šlše
 

298 
	$d_lšk_»ad_by‹
(
ty³
, 
deviû
 *
dev
) {

299 
lo
;

301 ()
	`outb_p
((
ty³
), 
DATA_PORT
);

302 
lo
 = (()
	`šb
(
STATUS_PORT
)) >> 4;

303 ()
	`outb_p
((
ty³
è| 
HI_NIBBLE
, 
DATA_PORT
);

304  (()
	`šb
(
STATUS_PORT
è& ()0xf0è| 
lo
;

305 
	}
}

316 
	$d_lšk_İ’
(
deviû
 *
dev
)

318 
´Ùo
 
tı_´Ù
;

320 ià(
	`»que¡_œq
(
D_LINK_IRQ
, 
d_lšk_š‹¼u±
)) {

321 
	`´štk
 ("%s: uÇbËØg‘ IRQ %d\n", 
dev
->
Çme
, 
D_LINK_IRQ
);

324 
œq2dev_m­
[
D_LINK_IRQ
] = 
dev
;

326 
	`ad­‹r_š™
(
dev
);

337 
tı_´Ù
.
r¥aû
 = 
d_lšk_r¥aû
;

340 
	}
}

346 
	$d_lšk_şo£
(
deviû
 *
dev
)

348 
	`£Ëù_nic
();

349 
rx_·ge
 = 0;

350 
	`d_lšk_put_commªd
(
RESET
);

351 
	`d_lšk_put_commªd
(
STOP_RESET
);

352 
	`d_lšk_put_commªd
(0);

353 
	`£Ëù_´n
();

355 
	`ä“_œq
(
D_LINK_IRQ
);

356 
œq2dev_m­
[
D_LINK_IRQ
] = 
NULL
;

357 
dev
->
¡¬t
 = 0;

358 
tı_´Ù
.
r¥aû
 = 
sock_r¥aû
;

361 
	}
}

363 
Ãt¡©s
 *

364 
	$g‘_¡©s
(
deviû
 *
dev
)

366  (
Ãt¡©s
 *)(
dev
->
´iv
);

367 
	}
}

369 
šlše
 

370 
	$Œigg”_š‹¼u±
(
deviû
 *
dev
)

372 
	`d_lšk_put_commªd
(
FLIP_IRQ
);

373 
	`£Ëù_´n
();

374 
D_LINK_SLOW_DOWN
;

375 
	`£Ëù_nic
();

376 
	`d_lšk_put_commªd
(0);

377 
	}
}

384 
	$d_lšk_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

386 
Œªsm™_äom
;

387 
Ën
;

388 
tickssoçr
;

389 *
bufãr
 = 
skb
->
d©a
;

397 ià(
skb
 =ğ
NULL
) {

398 
	`dev_tšt
(
dev
);

403 ià(!
skb
->
¬p
)

404 if(
dev
->
	`»bud_h—d”
(
skb
->
d©a
, dev)) {

405 
skb
->
dev
 = dev;

406 
	`¬p_queue
 (
skb
);

409 
skb
->
¬p
 = 1;

411 ià(
ä“_tx_·ges
 <= 0) {

412 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

414 ià(
tickssoçr
 < 5)

418 
	`´štk
("%s:ransmitimed out (%d), %s?\n",

419 
dev
->
Çme
,

420 
tickssoçr
,

424 
	`ad­‹r_š™
(
dev
);

428 
	`PRINTK
(("d_lšk_¡¬t_xm™:Ën=%d,…ag%d/%d\n", 
skb
->
Ën
, 
tx_fifo_š
, 
ä“_tx_·ges
));

430 ià((
Ën
 = 
skb
->Ënè< 
RUNT
)

431 
Ën
 = 
RUNT
;

433 
	`şi
();

434 
	`£Ëù_nic
();

436 
tx_fifo
[
tx_fifo_š
] = 
Œªsm™_äom
 = 
	`tx_·ge_adr
Ñx_fifo_šè- 
Ën
;

437 
tx_fifo_š
 = (tx_fifo_š + 1è% 
TX_PAGES
;

439 
	`d_lšk_£tup_add»ss
(
Œªsm™_äom
, 
RW_ADDR
);

440  ; 
Ën
 > 0; --Ën, ++
bufãr
)

441 
	`d_lšk_put_by‹
(*
bufãr
);

443 ià(
ä“_tx_·ges
-- =ğ
TX_PAGES
) {

444 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

445 
dev
->
tbusy
 = 0;

447 
	`d_lšk_£tup_add»ss
(
Œªsm™_äom
, 
TX_ADDR
);

448 
	`d_lšk_put_commªd
(
TX_ENABLE
);

451 
dev
->
tbusy
 = !
ä“_tx_·ges
;

452 
	`£Ëù_´n
();

455 
	`¡i
();

457 ià(
skb
->
ä“
)

458 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

461 
	}
}

468 
	$d_lšk_š‹¼u±
(
»g_±r
)

470 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

471 
deviû
 *
dev
 = 
œq2dev_m­
[
œq
];

472 
œq_¡©us
;

473 
»Œig
 = 0;

474 
boguscouÁ
 = 0;

477 ià((
dev
 =ğ
NULL
è|| (dev->
¡¬t
 =ğ0è|| (
D_LINK_IRQ
 !ğ
œq
)) {

478 
	`´štk
("%s: bogu š‹¼u± %d\n", 
dev
?dev->
Çme
:"DE-600", 
œq
);

482 
dev
->
š‹¼u±
 = 1;

483 
	`£Ëù_nic
();

484 
œq_¡©us
 = 
	`d_lšk_»ad_¡©us
(
dev
);

487 
	`PRINTK
(("d_lšk_š‹¼u± (%2.2X)\n", 
œq_¡©us
));

489 ià(
œq_¡©us
 & 
RX_GOOD
)

490 
	`d_lšk_rx_šŒ
(
dev
);

491 ià(!(
œq_¡©us
 & 
RX_BUSY
))

492 
	`d_lšk_put_commªd
(
RX_ENABLE
);

495 ià(
ä“_tx_·ges
 < 
TX_PAGES
)

496 
»Œig
 = 
	`d_lšk_tx_šŒ
(
dev
, 
œq_¡©us
);

498 
»Œig
 = 0;

500 
œq_¡©us
 = 
	`d_lšk_»ad_¡©us
(
dev
);

501 }  (
œq_¡©us
 & 
RX_GOOD
è|| ((++
boguscouÁ
 < 10è&& 
»Œig
) );

509 
dev
->
š‹¼u±
 = 0;

510 
	`£Ëù_´n
();

512 ià(
»Œig
)

513 
	`Œigg”_š‹¼u±
(
dev
);

515 
	`¡i
();

517 
	}
}

520 
	$d_lšk_tx_šŒ
(
deviû
 *
dev
, 
œq_¡©us
)

526 
	`m¬k_bh
(
INET_BH
);

528 ià(
œq_¡©us
 & 
TX_BUSY
)

533 ià(!(
œq_¡©us
 & 
TX_FAILED16
)) {

534 
tx_fifo_out
 = (tx_fifo_ouˆ+ 1è% 
TX_PAGES
;

535 ++
ä“_tx_·ges
;

536 ((
Ãt¡©s
 *)(
dev
->
´iv
))->
tx_·ck‘s
++;

537 
dev
->
tbusy
 = 0;

541 ià((
ä“_tx_·ges
 < 
TX_PAGES
è|| (
œq_¡©us
 & 
TX_FAILED16
)) {

542 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

543 
	`d_lšk_£tup_add»ss
(
tx_fifo
[
tx_fifo_out
], 
TX_ADDR
);

544 
	`d_lšk_put_commªd
(
TX_ENABLE
);

550 
	}
}

556 
	$d_lšk_rx_šŒ
(
deviû
 *
dev
)

558 
sk_buff
 *
skb
;

559 
i
;

560 
»ad_äom
;

561 
size
;

562 
sksize
;

563 *
bufãr
;

565 
	`şi
();

567 
size
 = 
	`d_lšk_»ad_by‹
(
RX_LEN
, 
dev
);

568 
size
 +ğ(
	`d_lšk_»ad_by‹
(
RX_LEN
, 
dev
) << 8);

569 
size
 -= 4;

572 
»ad_äom
 = 
	`rx_·ge_adr
();

573 
	`Ãxt_rx_·ge
();

574 
	`d_lšk_put_commªd
(
RX_ENABLE
);

575 
	`¡i
();

577 ià((
size
 < 32) || (size > 1535))

578 
	`´štk
("%s: Bogu ·ck‘ siz%d.\n", 
dev
->
Çme
, 
size
);

580 
sksize
 = (
sk_buff
è+ 
size
;

581 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

582 
	`¡i
();

583 ià(
skb
 =ğ
NULL
) {

584 
	`´štk
("%s: Couldn't‡llocate‡ sk_buff of size %d.\n",

585 
dev
->
Çme
, 
sksize
);

590 
skb
->
lock
 = 0;

591 
skb
->
mem_Ën
 = 
sksize
;

592 
skb
->
mem_addr
 = skb;

594 
bufãr
 = 
skb
->
d©a
;

597 
	`d_lšk_£tup_add»ss
(
»ad_äom
, 
RW_ADDR
);

598 
i
 = 
size
; i > 0; --i, ++
bufãr
)

599 *
bufãr
 = 
	`d_lšk_»ad_by‹
(
READ_DATA
, 
dev
);

601 ((
Ãt¡©s
 *)(
dev
->
´iv
))->
rx_·ck‘s
++;

603 ià(
	`dev_ršt
((*)
skb
, 
size
, 
IN_SKBUFF
, 
dev
))

604 
	`´štk
("%s:„eûivbufãr fuÎ.\n", 
dev
->
Çme
);

610 
	}
}

613 
	$d_lšk_š™
(
deviû
 *
dev
)

615 
i
;

617 
	`´štk
("%s: D-Lšk DE-600…ock‘‡d­‹r", 
dev
->
Çme
);

619 ià(
d_lšk_debug
 > 1)

620 
	`´štk
(
v”siÚ
);

623 
rx_·ge
 = 0;

624 
	`£Ëù_nic
();

625 ()
	`d_lšk_»ad_¡©us
(
dev
);

626 
	`d_lšk_put_commªd
(
RESET
);

627 
	`d_lšk_put_commªd
(
STOP_RESET
);

628 ià(
	`d_lšk_»ad_¡©us
(
dev
) & 0xf0) {

629 
	`´štk
(":‚Ù‡ˆI/O %#3x.\n", 
DATA_PORT
);

630  
ENODEV
;

639 
	`d_lšk_£tup_add»ss
(
NODE_ADDRESS
, 
RW_ADDR
);

640 
i
 = 0; i < 
ETH_ALEN
; i++) {

641 
dev
->
dev_addr
[
i
] = 
	`d_lšk_»ad_by‹
(
READ_DATA
, dev);

642 
dev
->
brßdÿ¡
[
i
] = 0xff;

646 ià((
dev
->
dev_addr
[1] == 0xde) && (dev->dev_addr[2] == 0x15)) {

648 
dev
->
dev_addr
[0] = 0x00;

649 
dev
->
dev_addr
[1] = 0x80;

650 
dev
->
dev_addr
[2] = 0xc8;

651 
dev
->
dev_addr
[3] &= 0x0f;

652 
dev
->
dev_addr
[3] |= 0x70;

654 
	`´štk
("‚ot identified inhe…rinter…ort\n");

655  
ENODEV
;

658 
	`´štk
(", Eth”ÃˆAdd»ss: %2.2X", 
dev
->
dev_addr
[0]);

659 
i
 = 1; i < 
ETH_ALEN
; i++)

660 
	`´štk
(":%2.2X",
dev
->
dev_addr
[
i
]);

661 
	`´štk
("\n");

664 
dev
->
´iv
 = 
	`km®loc
((
Ãt¡©s
), 
GFP_KERNEL
);

665 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt¡©s
));

667 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

668 
dev
->
buffs
[
i
] = 
NULL
;

670 
dev
->
g‘_¡©s
 = get_stats;

671 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

672 
dev
->
add_¬p
 = 
‘h_add_¬p
;

673 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

674 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

675 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

677 
dev
->
İ’
 = 
d_lšk_İ’
;

678 
dev
->
¡İ
 = 
d_lšk_şo£
;

679 
dev
->
h¬d_¡¬t_xm™
 = &
d_lšk_¡¬t_xm™
;

682 
dev
->
ty³
 = 
ARPHRD_ETHER
;

683 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

684 
dev
->
mtu
 = 1500;

685 
dev
->
addr_Ën
 = 
ETH_ALEN
;

688 
dev
->
æags
 = 
IFF_BROADCAST
;

689 
dev
->
çmy
 = 
AF_INET
;

690 
dev
->
·_addr
 = 0;

691 
dev
->
·_brdaddr
 = 0;

692 
dev
->
·_mask
 = 0;

693 
dev
->
·_®’
 = ();

695 
	`£Ëù_´n
();

697 
	}
}

700 
	$ad­‹r_š™
(
deviû
 *
dev
)

702 
i
;

704 
	`şi
();

705 
dev
->
tbusy
 = 0;

706 
dev
->
š‹¼u±
 = 0;

707 
dev
->
¡¬t
 = 1;

709 
	`£Ëù_nic
();

710 
rx_·ge
 = 0;

711 
	`d_lšk_put_commªd
(
RESET
);

712 
	`d_lšk_put_commªd
(
STOP_RESET
);

714 
tx_fifo_š
 = 0;

715 
tx_fifo_out
 = 0;

716 
ä“_tx_·ges
 = 
TX_PAGES
;

719 
	`d_lšk_£tup_add»ss
(
NODE_ADDRESS
, 
RW_ADDR
);

720 
i
 = 0; i < 
ETH_ALEN
; i++)

721 
	`d_lšk_put_by‹
(
dev
->
dev_addr
[
i
]);

724 
rx_·ge
 = 
RX_BP
 | 
RX_BASE_PAGE
;

725 
	`d_lšk_£tup_add»ss
(
MEM_4K
, 
RW_ADDR
);

727 
	`d_lšk_put_commªd
(
RX_ENABLE
);

728 
	`£Ëù_´n
();

729 
	`¡i
();

730 
	}
}

732 
	#D_LINK_MIN_WINDOW
 1024

	)

733 
	#D_LINK_MAX_WINDOW
 2048

	)

734 
	#D_LINK_TCP_WINDOW_DIFF
 1024

	)

747 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

749 
	$d_lšk_r¥aû
(
sock
 *
sk
)

751 
amt
;

753 ià(
sk
 !ğ
NULL
) {

758 
sk
->
max_uÇcked
 = 
D_LINK_MAX_WINDOW
 - 
D_LINK_TCP_WINDOW_DIFF
;

760 ià(
sk
->
rmem_®loc
 >ğ
SK_RMEM_MAX
-2*
D_LINK_MIN_WINDOW
) (0);

761 
amt
 = 
	`mš
((
SK_RMEM_MAX
-
sk
->
rmem_®loc
)/2-
D_LINK_MIN_WINDOW
, 
D_LINK_MAX_WINDOW
);

762 ià(
amt
 < 0) (0);

763 (
amt
);

766 
	}
}

	@drivers/net/depca.c

115 *
	gv”siÚ
 = "depca.c:v0.32 2/19/94 davies@wanton.enet.dec.com\n";

117 
	~<¡d¬g.h
>

118 
	~<lšux/cÚfig.h
>

119 
	~<lšux/k”Ãl.h
>

120 
	~<lšux/sched.h
>

121 
	~<lšux/¡ršg.h
>

122 
	~<lšux/±¿û.h
>

123 
	~<lšux/”ºo.h
>

124 
	~<lšux/iİÜt.h
>

125 
	~<lšux/m®loc.h
>

126 
	~<lšux/š‹¼u±.h
>

127 
	~<asm/b™İs.h
>

128 
	~<asm/io.h
>

129 
	~<asm/dma.h
>

131 
	~"dev.h
"

132 
	~"iow.h
"

133 
	~"‘h.h
"

134 
	~"skbuff.h
"

135 
	~"¬p.h
"

136 
	~"d•ÿ.h
"

138 #ifdeà
DEPCA_DEBUG


139 
	gd•ÿ_debug
 = 
DEPCA_DEBUG
;

141 
	gd•ÿ_debug
 = 1;

144 #iâdeà
DEPCA_IRQ


146 
	#DEPCA_IRQ
 5

	)

149 #iâdeà
PROBE_LENGTH


150 
	#PROBE_LENGTH
 32

	)

153 #iâdeà
PROBE_SEQUENCE


154 
	#PROBE_SEQUENCE
 "FF0055AAFF0055AA"

	)

157 #iâdeà
DEPCA_SIGNATURE


158 
	#DEPCA_SIGNATURE
 {"DEPCA","DE100","DE200","DE202","DE210",""}

	)

159 
	#DEPCA_NAME_LENGTH
 8

	)

162 #iâdeà
DEPCA_RAM_BASE_ADDRESSES


163 
	#DEPCA_RAM_BASE_ADDRESSES
 {0xc0000,0xd0000,0xe0000,0x00000}

	)

165 
	gmem_chkd
 = 0;

168 #iâdeà
DEPCA_IO_PORTS


169 
	#DEPCA_IO_PORTS
 {0x300, 0x200, 0}

	)

172 #iâdeà
DEPCA_TOTAL_SIZE


173 
	#DEPCA_TOTAL_SIZE
 0x10

	)

176 #iâdeà
MAX_NUM_DEPCAS


177 
	#MAX_NUM_DEPCAS
 2

	)

183 #iâdeà
DEPCA_BUFFER_LOG_SZ


184 
	#RING_SIZE
 16

	)

186 
	#RING_SIZE
 (1 << (
DEPCA_BUFFERS_LOG_SZ
))

	)

189 
	#PKT_BUF_SZ
 1544

	)

190 
	#PKT_SZ
 1514

	)

191 
	#DAT_SZ
 1500

	)

192 
	#PKT_HDR_LEN
 14

	)

194 #ifdeà
HAVE_MULTICAST


195 #iâdeà
CRC_POLYNOMIAL


196 
	#CRC_POLYNOMIAL
 0x04c11db7

	)

200 #iâdeà
HAVE_ALLOC_SKB


201 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

202 
	#kä“_skbmem
(
buff
, 
size
è
	`kä“_s
(buff,size)

	)

208 
	sd•ÿ_rx_h—d
 {

209 
	mba£
;

210 
	mbuf_Ëngth
;

211 
	mmsg_Ëngth
;

214 
	sd•ÿ_tx_h—d
 {

215 
	mba£
;

216 
	mËngth
;

217 
	mmisc
;

220 
	sd•ÿ_ršg_šfo
 {

226 
	sd•ÿ_š™
 {

227 
	mmode
;

228 
	mphys_addr
[
ETH_ALEN
];

229 
	mf‹r
[4];

230 
	mrx_ršg
;

231 
	mtx_ršg
;

234 
	sd•ÿ_´iv©e
 {

235 
	mdevÇme
[8];

236 
d•ÿ_rx_h—d
 *
	mrx_ršg
;

237 
d•ÿ_tx_h—d
 *
	mtx_ršg
;

238 
d•ÿ_š™
 
	mš™_block
;

239 
	mdma_buffs
;

240 
	mcur_rx
, 
	mcur_tx
;

241 
	mdœty_rx
, 
	mdœty_tx
;

242 
	mdma
;

243 
’‘_¡©i¡ics
 
	m¡©s
;

244 
	mŞd_d•ÿ
;

245 
	mršgSize
;

246 
	mrmask
;

247 
	m¾’
;

253 
d•ÿ_İ’
(
deviû
 *
dev
);

254 
d•ÿ_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

255 
d•ÿ_š‹¼u±
(
»g_±r
);

256 
d•ÿ_şo£
(
deviû
 *
dev
);

257 
’‘_¡©i¡ics
 *
d•ÿ_g‘_¡©s
(
deviû
 *
dev
);

258 #ifdeà
HAVE_MULTICAST


259 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

265 
d•ÿ_´obe1
(
deviû
 *
dev
, 
ißddr
);

266 
d•ÿ_š™_ršg
(
deviû
 *
dev
);

267 
d•ÿ_rx
(
deviû
 *
dev
);

268 
d•ÿ_tx
(
deviû
 *
dev
);

270 
LßdCSRs
(
deviû
 *
dev
);

271 
In™Re¡¬tD•ÿ
(
deviû
 *
dev
);

272 *
D•ÿSigÇtu»
(
mem_addr
);

273 
DeviûP»£Á
(
ißddr
);

274 #ifdeà
HAVE_MULTICAST


275 
S‘MuÉiÿ¡F‹r
(
num_addrs
, *
addrs
, *
muÉiÿ¡_bË
);

278 
	gnum_d•ÿs
 = 0, 
	gnum_‘h
 = 0;;

283 
	#STOP_DEPCA
 \

284 
	`outw
(
CSR0
, 
DEPCA_ADDR
);\

285 
	`outw
(
STOP
, 
DEPCA_DATA
)

	)

289 
	$d•ÿ_´obe
(
deviû
 *
dev
)

291 *
pÜt
, 
pÜts
[] = 
DEPCA_IO_PORTS
;

292 
ba£_addr
 = 
dev
->base_addr;

293 
¡©us
;

294 
deviû
 *
‘h0
 = (deviû *è
NULL
;

296 ià(
ba£_addr
 > 0x1ff) {

297 
¡©us
 = 
	`d•ÿ_´obe1
(
dev
, 
ba£_addr
);

298 } ià(
ba£_addr
 > 0) {

299 
¡©us
 = -
ENXIO
;

303 
¡©us
 = -
ENODEV
, 
pÜt
 = &
pÜts
[0];

304 *
pÜt
 && (
num_d•ÿs
 < 
MAX_NUM_DEPCAS
);…ort++) {

305 
ißddr
 = *
pÜt
;

307 #ifdeà
HAVE_PORTRESERVE


308 ià(
	`check_»giÚ
(
ißddr
, 
DEPCA_TOTAL_SIZE
))

311 ià(
	`DeviûP»£Á
(
DEPCA_PROM
) == 0) {

312 ià(
num_d•ÿs
 > 0) {

317 
dev
->
Ãxt
 !ğ(
deviû
 *)
NULL
) {

318 ià(
dev
->
Ãxt
->
ba£_addr
 == 0xffe0) ;

319 
dev
 = dev->
Ãxt
;

320 
num_‘h
++;

328 ià(
dev
->
Ãxt
 =ğ(
deviû
 *)
NULL
) {

329 
dev
->
Ãxt
 = (
deviû
 *)
	`km®loc
((device) + 8,

330 
GFP_KERNEL
);

332 
	`´štk
("eth%d: Device‚ot initialised, insufficient memory\n",

333 
num_‘h
);

341 ià((
dev
->
Ãxt
 !ğ(
deviû
 *)
NULL
) &&

342 (
num_‘h
 > 0) && (num_eth < 9999)) {

343 
dev
 = dev->
Ãxt
;

344 
dev
->
Çme
 = (*)(dev + (
deviû
));

345 
	`¥rštf
(
dev
->
Çme
,"‘h%d", 
num_‘h
);

346 
dev
->
ba£_addr
 = 
ißddr
;

347 
dev
->
Ãxt
 = (
deviû
 *)
NULL
;

348 
dev
->
š™
 = &
d•ÿ_´obe
;

351 
‘h0
 = 
dev
;

352 
¡©us
 = 
	`d•ÿ_´obe1
(
dev
, 
ißddr
);

354 
num_d•ÿs
++;

355 
num_‘h
++;

358 ià(
‘h0
è
dev
 =ƒth0;

361 ià(
¡©us
è
dev
->
ba£_addr
 = base_addr;

363  
¡©us
;

364 
	}
}

367 
	$d•ÿ_´obe1
(
deviû
 *
dev
, 
ißddr
)

369 
d•ÿ_´iv©e
 *
Í
;

370 
i
,
j
, 
¡©us
=0;

371 
mem_¡¬t
, 
mem_ba£
[] = 
DEPCA_RAM_BASE_ADDRESSES
;

372 *
Çme
=(*)
NULL
;

373 
nic¤
, 
off£t
;

379 
STOP_DEPCA
;

381 
nic¤
 = 
	`šw
(
DEPCA_NICSR
);

382 
nic¤
 = (Òic¤ & ~
SHE
 & ~
RBE
 & ~
IEN
è| 
IM
);

383 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

385 ià(
	`šw
(
DEPCA_DATA
è=ğ
STOP
) {

394 
j
 = 0, 
i
 = 0; 
mem_ba£
[i] && (j == 0);) {

395 ià(((
mem_chkd
 >> 
i
) & 0x01) == 0) {

396 
Çme
 = 
	`D•ÿSigÇtu»
(
mem_ba£
[
i
]);

397 
mem_chkd
 |ğ(0x01 << 
i
);

398 ià(*
Çme
 !ğ()
NULL
) {

399 
j
 = 1;

401 
i
++;

406 ià(*
Çme
 !ğ()
NULL
) {

407 
mem_¡¬t
 = 
mem_ba£
[
i
];

408 
dev
->
ba£_addr
 = 
ißddr
;

410 
	`´štk
("%s: DEPCA‡ˆ%#3x i ¨%s, ", 
dev
->
Çme
, 
ißddr
,‚ame);

421 ià(
	`¡r¡r
(
Çme
,"DE100")!=(*)
NULL
) {

422 
j
 = 1;

424 
j
 = 0;

427 
	`´štk
("ethernet‡ddress ");

428 
i
 = 0; i < 
ETH_ALEN
 - 1; i++) {

429 
	`´štk
("%2.2x:", 
dev
->
dev_addr
[
i
] = 
	`šb
(
DEPCA_PROM
 + 
j
));

431 
	`´štk
("%2.2x", 
dev
->
dev_addr
[
i
] = 
	`šb
(
DEPCA_PROM
 + 
j
));

433 ;
i
<32;i++) {

434 
j
=
	`šb
(
DEPCA_PROM
);

437 #ifdeà
HAVE_PORTRESERVE


438 
	`¢¬f_»giÚ
(
ißddr
, 
DEPCA_TOTAL_SIZE
);

446 ià(
nic¤
 & 
BUF
) {

447 
off£t
 = 0x8000;

448 
nic¤
 &ğ~
BS
;

449 
	`´štk
(",\n with 32kB RAM");

451 
off£t
 = 0x0000;

452 
	`´štk
(",\n with 64kB RAM");

455 
mem_¡¬t
 +ğ
off£t
;

456 
	`´štk
(" s¹šg‡ˆ0x%.5lx", 
mem_¡¬t
);

461 
nic¤
 |ğ
SHE
;

462 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

472 
j
 = ((0x10000 - 
off£t
è/ 
PKT_BUF_SZ
) >> 1;

473 
i
=0;
j
>1;i++) {

474 
j
 >>= 1;

481 
j
 = 1 << 
i
;

496 
dev
->
´iv
 = (*)((
mem_¡¬t
 + 0x07) & ~0x07);

497 
Í
 = (
d•ÿ_´iv©e
 *)
dev
->
´iv
;

498 
	`mem£t
(
dev
->
´iv
, 0, (
d•ÿ_´iv©e
));

501 
mem_¡¬t
 = (((()
dev
->
´iv
 +

502 (
d•ÿ_´iv©e
)) +

504 
Í
->
rx_ršg
 = (
d•ÿ_rx_h—d
 *)
mem_¡¬t
;

506 
mem_¡¬t
 +ğ((
d•ÿ_rx_h—d
è* 
j
);

507 
Í
->
tx_ršg
 = (
d•ÿ_tx_h—d
 *)
mem_¡¬t
;

509 
mem_¡¬t
 +ğ((
d•ÿ_tx_h—d
è* 
j
);

510 
Í
->
dma_buffs
 = 
mem_¡¬t
 & 0x00ffffff;

512 
mem_¡¬t
 +ğ(
PKT_BUF_SZ
 * 
j
);

516 
	`mem£t
(
Í
->
rx_ršg
, 0, (
d•ÿ_rx_h—d
)*
j
);

517 
	`mem£t
(
Í
->
tx_ršg
, 0, (
d•ÿ_tx_h—d
)*
j
);

520 ià(()(
Í
->
rx_ršg
) & 0x07) {

521 
	`´štk
("\n **ERROR** DEPCA Rx‡nd Tx descriptor„ings‚ot on‡ quadword boundary.\n");

522  -
ENXIO
;

528 
Í
->
ršgSize
 = 
j
;

529 ià(
Í
->
ršgSize
 > 
RING_SIZE
)†p->ringSize = RING_SIZE;

530 
Í
->
rmask
 =†p->
ršgSize
 - 1;

536 
i
=0, 
j
 = 
Í
->
ršgSize
; j>1; i++) {

537 
j
 >>= 1;

539 
Í
->
¾’
 = ()(
i
 << 29);

544 
	`d•ÿ_š™_ršg
(
dev
);

549 
	`LßdCSRs
(
dev
);

554 
nic¤
 = (Òic¤ & ~
IM
)|
IEN
);

555 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

558 
dev
->
dma
 = 0;

562 ià(
dev
->
œq
 < 2) {

563 
	`autoœq_£tup
(0);

566 
	`outw
(
INEA
 | 
INIT
, 
DEPCA_DATA
);

568 
dev
->
œq
 = 
	`autoœq_»pÜt
(1);

569 ià(
dev
->
œq
) {

570 
	`´štk
("‡nd…robed IRQ%d.\n", 
dev
->
œq
);

572 
	`´štk
(". Failedo detect IRQ†ine.\n");

573 
¡©us
 = -
EAGAIN
;

576 
	`´štk
(". AssigÃd IRQ%d.\n", 
dev
->
œq
);

579 
¡©us
 = -
ENXIO
;

581 ià(!
¡©us
) {

582 ià(
d•ÿ_debug
 > 0) {

583 
	`´štk
(
v”siÚ
);

587 
dev
->
İ’
 = &
d•ÿ_İ’
;

588 
dev
->
h¬d_¡¬t_xm™
 = &
d•ÿ_¡¬t_xm™
;

589 
dev
->
¡İ
 = &
d•ÿ_şo£
;

590 
dev
->
g‘_¡©s
 = &
d•ÿ_g‘_¡©s
;

591 #ifdeà
HAVE_MULTICAST


592 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

595 
dev
->
mem_¡¬t
 = 0;

598 
i
 = 0; i < 
DEV_NUMBUFFS
; i++) {

599 
dev
->
buffs
[
i
] = 
NULL
;

602 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

603 
dev
->
add_¬p
 = 
‘h_add_¬p
;

604 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

605 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

606 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

608 
dev
->
ty³
 = 
ARPHRD_ETHER
;

609 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

610 
dev
->
mtu
 = 1500;

611 
dev
->
addr_Ën
 = 
ETH_ALEN
;

613 
i
 = 0; i < 
dev
->
addr_Ën
; i++) {

614 
dev
->
brßdÿ¡
[
i
]=0xff;

618 
dev
->
æags
 = 
IFF_BROADCAST
;

619 
dev
->
çmy
 = 
AF_INET
;

620 
dev
->
·_addr
 = 0;

621 
dev
->
·_brdaddr
 = 0;

622 
dev
->
·_mask
 = 0;

623 
dev
->
·_®’
 = ();

626 
¡©us
 = -
ENXIO
;

629  
¡©us
;

630 
	}
}

634 
	$d•ÿ_İ’
(
deviû
 *
dev
)

636 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

637 
i
,
nic¤
,
ißddr
 = 
dev
->
ba£_addr
;

639 ià(
	`»que¡_œq
(
dev
->
œq
, &
d•ÿ_š‹¼u±
)) {

640 
	`´štk
("d•ÿ_İ’(): Reque¡ed IRQ%d i busy\n",
dev
->
œq
);

641  -
EAGAIN
;

644 
œq2dev_m­
[
dev
->
œq
] = dev;

649 
STOP_DEPCA
;

650 
nic¤
 = 
	`šw
(
DEPCA_NICSR
);

655 
	`d•ÿ_š™_ršg
(
dev
);

656 
	`LßdCSRs
(
dev
);

658 ià(
d•ÿ_debug
 > 1){

659 
	`´štk
("%s: d•ÿ o³Àw™h irq %d\n",
dev
->
Çme
,dev->
œq
);

660 
	`´štk
("Descriptor head‡ddresses:\n");

661 
	`´štk
("\t0x%8.8lx 0x%8.8lx\n",()
Í
->
rx_ršg
,(îp->
tx_ršg
);

662 
	`´štk
("Descriptor‡ddresses:\n");

663 
i
=0;i<
Í
->
ršgSize
;i++){

664 
	`´štk
("\t0x%8.8lx 0x%8.8lx\n",()&
Í
->
rx_ršg
[
i
].
ba£
,

665 ()&
Í
->
tx_ršg
[
i
].
ba£
);

667 
	`´štk
("Buffer‡ddresses:\n");

668 
i
=0;i<
Í
->
ršgSize
;i++){

669 
	`´štk
("\t0x%8.8lx 0x%8.8lx\n",()
Í
->
rx_ršg
[
i
].
ba£
,

670 ()
Í
->
tx_ršg
[
i
].
ba£
);

672 
	`´štk
("In™Ÿli§tiÚ block‡ˆ0x%8.8lx\n",()&
Í
->
š™_block
);

673 
	`´štk
("\tmode: 0x%4.4x\n",
Í
->
š™_block
.
mode
);

674 
	`´štk
("\tphysical‡ddress: ");

675 
i
=0;i<6;i++){

676 
	`´štk
("%2.2x:",()
Í
->
š™_block
.
phys_addr
[
i
]);

678 
	`´štk
("\n\tlogical‡ddress filter: 0x");

679 
i
=0;i<4;i++){

680 
	`´štk
("%2.2x",()
Í
->
š™_block
.
f‹r
[
i
]);

682 
	`´štk
("\n\Œx_ršg‡t: 0x%8.8lx\n",()
Í
->
š™_block
.
rx_ršg
);

683 
	`´štk
("\‰x_ršg‡t: 0x%8.8lx\n",()
Í
->
š™_block
.
tx_ršg
);

684 
	`´štk
("dma_buffs: 0x%8.8lx\n",()
Í
->
dma_buffs
);

685 
	`´štk
("Ring size: %d\nMask: 0x%2.2x\nLog2(ringSize): 0x%8.8lx\n",

686 ()
Í
->
ršgSize
,

687 ()
Í
->
rmask
,

688 ()
Í
->
¾’
);

689 
	`outw
(
CSR2
,
DEPCA_ADDR
);

690 
	`´štk
("CSR2&1: 0x%4.4x",
	`šw
(
DEPCA_DATA
));

691 
	`outw
(
CSR1
,
DEPCA_ADDR
);

692 
	`´štk
("%4.4x\n",
	`šw
(
DEPCA_DATA
));

693 
	`outw
(
CSR3
,
DEPCA_ADDR
);

694 
	`´štk
("CSR3: 0x%4.4x\n",
	`šw
(
DEPCA_DATA
));

700 
nic¤
 = (Òic¤ & ~
IM
 & ~
LED
)|
SHE
|
IEN
);

701 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

702 
	`outw
(
CSR0
,
DEPCA_ADDR
);

704 
dev
->
tbusy
 = 0;

705 
dev
->
š‹¼u±
 = 0;

706 
dev
->
¡¬t
 = 1;

708 
	`In™Re¡¬tD•ÿ
(
dev
);

710 ià(
d•ÿ_debug
 > 1){

711 
	`´štk
("CSR0: 0x%4.4x\n",
	`šw
(
DEPCA_DATA
));

712 
	`´štk
("nic¤: 0x%4.4x\n",
	`šw
(
DEPCA_NICSR
));

716 
	}
}

720 
	$d•ÿ_š™_ršg
(
deviû
 *
dev
)

722 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

723 
i
;

725 
Í
->
š™_block
.
mode
 = 
DTX
 | 
DRX
;

726 
Í
->
cur_rx
 =†p->
cur_tx
 = 0;

727 
Í
->
dœty_rx
 =†p->
dœty_tx
 = 0;

730 
i
 = 0; i < 
Í
->
ršgSize
; i++) {

731 
Í
->
rx_ršg
[
i
].
ba£
 = (Í->
dma_buffs
 + i*
PKT_BUF_SZ
è| 
R_OWN
;

732 
Í
->
rx_ršg
[
i
].
buf_Ëngth
 = -
PKT_BUF_SZ
;

733 
Í
->
tx_ršg
[
i
].
ba£
 = (Í->
dma_buffs
 + (i+Í->
ršgSize
è* 
PKT_BUF_SZ
) &

738 
i
 = 0; i < 
ETH_ALEN
; i++) {

739 
Í
->
š™_block
.
phys_addr
[
i
] = 
dev
->
dev_addr
[i];

741 
i
 = 0; i < 4; i++) {

742 
Í
->
š™_block
.
f‹r
[
i
] = 0x0000;

744 
Í
->
š™_block
.
rx_ršg
 = (îp->rx_ršg |†p->
¾’
;

745 
Í
->
š™_block
.
tx_ršg
 = (îp->tx_ršg |†p->
¾’
;

747 
Í
->
š™_block
.
mode
 = 0x0000;

748 
	}
}

754 
	$d•ÿ_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

756 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

757 
ißddr
 = 
dev
->
ba£_addr
;

758 
¡©us
 = 0;

761 ià(
dev
->
tbusy
) {

762 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

763 ià(
tickssoçr
 < 5) {

764 
¡©us
 = -1;

766 
STOP_DEPCA
;

767 
	`´štk
("%s:ransmitimed out, status %4.4x,„esetting.\n",

768 
dev
->
Çme
, 
	`šw
(
DEPCA_DATA
));

770 
	`d•ÿ_š™_ršg
(
dev
);

771 
	`LßdCSRs
(
dev
);

772 
	`In™Re¡¬tD•ÿ
(
dev
);

773 
dev
->
tbusy
=0;

774 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

776  
¡©us
;

779 ià(
skb
 =ğ
NULL
) {

780 
	`dev_tšt
(
dev
);

785 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

786 
skb
->
dev
 = dev;

787 
	`¬p_queue
 (
skb
);

790 
skb
->
¬p
=1;

792 ià(
skb
->
Ën
 <= 0) {

796 ià(
d•ÿ_debug
 > 3) {

797 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

798 
	`´štk
("%s: d•ÿ_¡¬t_xm™(èÿÎed, c¤0 %4.4x.\n", 
dev
->
Çme
,

799 
	`šw
(
DEPCA_DATA
));

804 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

805 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

813 *
buf
;

814 
’Œy
 = 
Í
->
cur_tx
++;

815 
Ën
;

816 
skbL
 = 
skb
->
Ën
;

817 *
p
 = (*è
skb
->
d©a
;

819 
’Œy
 &ğ
Í
->
rmask
;

820 
buf
 = (*)(
Í
->
tx_ršg
[
’Œy
].
ba£
 & 0x00ffffff);

823 
Í
->
tx_ršg
[
’Œy
].
ba£
 < 0);

829 
Ën
 = ((
skbL
 > 
PKT_SZ
) ? PKT_SZ : skbL);

830 ià(
Ën
 < 
ETH_ZLEN
)†en = ETH_ZLEN;

831 
skbL
 -ğ
Ën
;

832 
Í
->
tx_ršg
[
’Œy
].
Ëngth
 = -
Ën
;

835 
Í
->
tx_ršg
[
’Œy
].
misc
 = 0x0000;

838 
	`memıy
((*)(
buf
), 
skb
->
d©a
, 
Ën
);

841 ià(
skbL
 <ğ0è
Í
->
tx_ršg
[
’Œy
].
ba£
 |ğ(
T_ENP
);

842 
Í
->
tx_ršg
[
’Œy
].
ba£
 |ğ(
T_OWN
|
T_STP
);

845 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

846 
	`outw
(
INEA
 | 
TDMD
, 
DEPCA_DATA
);

848 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

850 
p
 +ğ
Ën
; 
skbL
 > 0;… +=†en) {

853 
’Œy
 = 
Í
->
cur_tx
++;

854 
’Œy
 &ğ
Í
->
rmask
;

855 
buf
 = (*)(
Í
->
tx_ršg
[
’Œy
].
ba£
 & 0x00ffffff);

858 
Í
->
tx_ršg
[
’Œy
].
ba£
 < 0);

859 
dev
->
tbusy
=0;

862 
	`memıy
((*)
buf
, 
skb
->
d©a
, 
PKT_HDR_LEN
);

865 
Ën
 = ((
skbL
 > 
DAT_SZ
) ? DAT_SZ : skbL);

866 ià(
Ën
 < 
ETH_ZLEN
)†en = ETH_ZLEN;

867 
skbL
 -ğ
Ën
;

868 
Í
->
tx_ršg
[
’Œy
].
Ëngth
 = -
Ën
;

871 
Í
->
tx_ršg
[
’Œy
].
misc
 = 0x0000;

874 
	`memıy
((*)(
buf
 + 
PKT_HDR_LEN
), (*)
p
, 
Ën
);

877 ià(
skbL
 <ğ0è
Í
->
tx_ršg
[
’Œy
].
ba£
 |ğ
T_ENP
;

878 
Í
->
tx_ršg
[
’Œy
].
ba£
 |ğ
T_OWN
;

881 ià(
d•ÿ_debug
 > 4) {

882 *
pkt
 =

883 (*)(
Í
->
tx_ršg
[
’Œy
].
ba£
 & 0x00ffffff);

885 
	`´štk
("%s:x„ing[%d], %#lx, sk_buf %#lx†en %d.\n",

886 
dev
->
Çme
, 
’Œy
, (è&
Í
->
tx_ršg
[entry],

887 
Í
->
tx_ršg
[
’Œy
].
ba£
, -Í->tx_ršg[’Œy].
Ëngth
);

888 
	`´štk
("%s: Tx %2.2x %2.2x %2.2x ... %2.2x %2.2x %2.2x %2.2x...%2.2x†en %2.2x %2.2x %2.2x %2.2x.\n",

889 
dev
->
Çme
, 
pkt
[0],…kt[1],…kt[2],…kt[5],…kt[6],

890 
pkt
[7],…kt[8],…kt[11],…kt[12],…kt[13],

891 
pkt
[14],…kt[15]);

895 ià(
Í
->
tx_ršg
[(
’Œy
+1è&†p->
rmask
].
ba£
 >= 0) {

896 
dev
->
tbusy
=0;

899 ià(
skb
->
ä“
) {

900 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

905 
	}
}

911 
	$d•ÿ_š‹¼u±
(
»g_±r
)

913 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

914 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

915 
d•ÿ_´iv©e
 *
Í
;

916 
c¤0
, 
ißddr
, 
nic¤
;

918 ià(
dev
 =ğ
NULL
) {

919 
	`´štk
 ("d•ÿ_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

922 
Í
 = (
d•ÿ_´iv©e
 *)
dev
->
´iv
;

923 
ißddr
 = 
dev
->
ba£_addr
;

926 ià(
dev
->
š‹¼u±
)

927 
	`´štk
("%s: Re-’‹ršghš‹¼u± hªdËr.\n", 
dev
->
Çme
);

929 
dev
->
š‹¼u±
 = 
MASK_INTERRUPTS
;

932 
nic¤
 = 
	`šw
(
DEPCA_NICSR
);

933 
nic¤
 |ğ(
IM
|
LED
);

934 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

936 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

937 
c¤0
 = 
	`šw
(
DEPCA_DATA
);

940 
	`outw
(
c¤0
 & ~(
INEA
|
TDMD
|
STOP
|
STRT
|
INIT
), 
DEPCA_DATA
);

942 ià(
d•ÿ_debug
 > 5)

943 
	`´štk
("%s: interrupt csr0=%#2.2x‚ew csr=%#2.2x.\n",

944 
dev
->
Çme
, 
c¤0
, 
	`šw
(
DEPCA_DATA
));

946 ià(
c¤0
 & 
RINT
)

947 
	`d•ÿ_rx
(
dev
);

949 ià(
c¤0
 & 
TINT
)

950 
	`d•ÿ_tx
(
dev
);

953 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

954 
	`outw
(
BABL
|
CERR
|
MISS
|
MERR
|
RINT
|
TINT
|
IDON
|
INEA
, 
DEPCA_DATA
);

956 ià(
d•ÿ_debug
 > 4) {

957 
	`´štk
("%s:ƒxiting interrupt, csr%d=%#4.4x.\n",

958 
dev
->
Çme
, 
	`šw
(
DEPCA_ADDR
),

959 
	`šw
(
DEPCA_DATA
));

963 
nic¤
 = (nic¤ & ~
IM
 & ~
LED
);

964 
	`outw
(
nic¤
, 
DEPCA_NICSR
);

966 
dev
->
š‹¼u±
 = 
UNMASK_INTERRUPTS
;

968 
	}
}

971 
	$d•ÿ_rx
(
deviû
 *
dev
)

973 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

974 
’Œy
 = 
Í
->
cur_rx
 &†p->
rmask
;

977 ; 
Í
->
rx_ršg
[
’Œy
].
ba£
 >ğ0;ƒÁry = (++Í->
cur_rx
è&†p->
rmask
) {

978 
¡©us
 = 
Í
->
rx_ršg
[
’Œy
].
ba£
 >> 16 ;

980 ià(
¡©us
 & 
R_ERR
) {

981 
Í
->
¡©s
.
rx_”rÜs
++;

982 ià(
¡©us
 & 
R_FRAM
è
Í
->
¡©s
.
rx_äame_”rÜs
++;

983 ià(
¡©us
 & 
R_OFLO
è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

984 ià(
¡©us
 & 
R_CRC
è
Í
->
¡©s
.
rx_üc_”rÜs
++;

985 ià(
¡©us
 & 
R_BUFF
è
Í
->
¡©s
.
rx_fifo_”rÜs
++;

987 
pkt_Ën
 = 
Í
->
rx_ršg
[
’Œy
].
msg_Ëngth
;

988 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

989 
sk_buff
 *
skb
;

991 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

992 ià(
skb
 =ğ
NULL
) {

993 
	`´štk
("%s: MemÜy squ“ze, deã¼šg…ack‘.\n", 
dev
->
Çme
);

994 
Í
->
¡©s
.
rx_drİ³d
++;

997 
skb
->
mem_Ën
 = 
sksize
;

998 
skb
->
mem_addr
 = skb;

999 
skb
->
Ën
 = 
pkt_Ën
;

1000 
skb
->
dev
 = dev;

1001 
	`memıy
(
skb
->
d©a
,

1002 (*)(
Í
->
rx_ršg
[
’Œy
].
ba£
 & 0x00ffffff),

1003 
pkt_Ën
);

1008 #ifdeà
HAVE_NETIF_RX


1009 
	`Ãtif_rx
(
skb
);

1011 
skb
->
lock
 = 0;

1012 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

1013 
	`kä“_skbmem
(
skb
, 
sksize
);

1014 
Í
->
¡©s
.
rx_drİ³d
++;

1018 
Í
->
¡©s
.
rx_·ck‘s
++;

1022 
Í
->
rx_ršg
[
’Œy
].
ba£
 |ğ
R_OWN
;

1031 
	}
}

1037 
	$d•ÿ_tx
(
deviû
 *
dev
)

1039 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

1040 
dœty_tx
 = 
Í
->dœty_tx &†p->
rmask
;

1042 ià(
d•ÿ_debug
 > 5)

1043 
	`´štk
("%s: Cleaningx„ing, dirty %d clean %d.\n",

1044 
dev
->
Çme
, 
dœty_tx
, (
Í
->
cur_tx
 &†p->
rmask
));

1050 ; 
dœty_tx
!=(
Í
->
cur_tx
 &†p->
rmask
è&&†p->
tx_ršg
[dœty_tx].
ba£
>0;

1051 
dœty_tx
 = ++
Í
->dœty_tx &†p->
rmask
) {

1052 *
tmdp
 = (*)(&
Í
->
tx_ršg
[
dœty_tx
]);

1053 
¡©us
 = 
Í
->
tx_ršg
[
dœty_tx
].
ba£
 >> 16;

1055 ià(
¡©us
 < 0) {

1056 
	`´štk
("interrupt for…acket‚ot yet sent!\n");

1059 ià(
¡©us
 & 
T_ERR
) {

1060 
”r_¡©us
 = 
Í
->
tx_ršg
[
dœty_tx
].
misc
;

1062 
Í
->
¡©s
.
tx_”rÜs
++;

1063 ià(
”r_¡©us
 & 
TMD3_RTRY
è
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

1064 ià(
”r_¡©us
 & 
TMD3_LCAR
è
Í
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

1065 ià(
”r_¡©us
 & 
TMD3_LCOL
è
Í
->
¡©s
.
tx_wšdow_”rÜs
++;

1066 ià(
”r_¡©us
 & 
TMD3_UFLO
è
Í
->
¡©s
.
tx_fifo_”rÜs
++;

1068 } ià(
¡©us
 & (
T_MORE
 | 
T_ONE
)) {

1069 
Í
->
¡©s
.
cŞlisiÚs
++;

1071 
Í
->
¡©s
.
tx_·ck‘s
++;

1074 ià(
d•ÿ_debug
 > 5)

1075 
	`´štk
("%s: Tx doneƒntry %d, %4.4lx %4.4lx %4.4lx %4.4lx.\n",

1076 
dev
->
Çme
, 
dœty_tx
,

1077 
tmdp
[0],mdp[1],mdp[2],mdp[3]);

1081 
	}
}

1084 
	$d•ÿ_şo£
(
deviû
 *
dev
)

1086 
ißddr
 = 
dev
->
ba£_addr
;

1088 
dev
->
¡¬t
 = 0;

1089 
dev
->
tbusy
 = 1;

1091 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

1093 ià(
d•ÿ_debug
 > 1) {

1094 
	`´štk
("%s: Shutting downƒthercard, status was %2.2x.\n",

1095 
dev
->
Çme
, 
	`šw
(
DEPCA_DATA
));

1102 
	`outw
(
STOP
, 
DEPCA_DATA
);

1104 
	`ä“_œq
(
dev
->
œq
);

1106 
œq2dev_m­
[
dev
->
œq
] = 0;

1109 
	}
}

1111 
	$LßdCSRs
(
deviû
 *
dev
)

1113 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

1114 
ißddr
 = 
dev
->
ba£_addr
;

1116 
	`outw
(
CSR1
, 
DEPCA_ADDR
);

1117 
	`outw
(()()&
Í
->
š™_block
, 
DEPCA_DATA
);

1118 
	`outw
(
CSR2
, 
DEPCA_ADDR
);

1119 
	`outw
(()(()&
Í
->
š™_block
 >> 16), 
DEPCA_DATA
);

1120 
	`outw
(
CSR3
, 
DEPCA_ADDR
);

1121 
	`outw
(
ACON
, 
DEPCA_DATA
);

1122 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

1123 
	}
}

1125 
	$In™Re¡¬tD•ÿ
(
deviû
 *
dev
)

1127 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

1128 
ißddr
 = 
dev
->
ba£_addr
;

1129 
i
, 
¡©us
=0;

1131 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

1132 
	`outw
(
INIT
, 
DEPCA_DATA
);

1135 
i
=0;(i<100è&& !(
	`šw
(
DEPCA_DATA
è& 
IDON
); i++);

1137 ià(
i
!=100) {

1139 
	`outw
(
IDON
 | 
INEA
 | 
STRT
, 
DEPCA_DATA
);

1140 ià(
d•ÿ_debug
 > 2) {

1141 
	`´štk
("%s: DEPCA open‡fter %dicks, init block %#lx csr0 %4.4x.\n",

1142 
dev
->
Çme
, 
i
, (è&
Í
->
š™_block
, 
	`šw
(
DEPCA_DATA
));

1145 
¡©us
 = -1;

1146 
	`´štk
("%s: DEPCA unopened‡fter %dicks, init block %#lx csr0 %4.4x.\n",

1147 
dev
->
Çme
, 
i
, (è&
Í
->
š™_block
, 
	`šw
(
DEPCA_DATA
));

1150  
¡©us
;

1151 
	}
}

1153 
’‘_¡©i¡ics
 *

1154 
	$d•ÿ_g‘_¡©s
(
deviû
 *
dev
)

1156 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

1160  &
Í
->
¡©s
;

1161 
	}
}

1163 #ifdeà
HAVE_MULTICAST


1172 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

1174 
ißddr
 = 
dev
->
ba£_addr
;

1175 
d•ÿ_´iv©e
 *
Í
 = (d•ÿ_´iv©*)
dev
->
´iv
;

1178 
STOP_DEPCA
;

1180 
Í
->
š™_block
.
mode
 = 
PROM
;

1181 ià(
num_addrs
 >= 0) {

1182 
muÉiÿ¡_bË
[4];

1183 
i
;

1185 
	`S‘MuÉiÿ¡F‹r
(
num_addrs
, (*)
addrs
, (*)
muÉiÿ¡_bË
);

1188 
	`mem£t
(
muÉiÿ¡_bË
, (
num_addrs
==0) ? 0 : -1, (multicast_table));

1190 
i
 = 0; i < 4; i++) {

1191 
Í
->
š™_block
.
f‹r
[
i
] = 
muÉiÿ¡_bË
[i];

1193 
Í
->
š™_block
.
mode
 &ğ~
PROM
;

1195 
Í
->
š™_block
.
mode
 |ğ
PROM
;

1198 
	`outw
(
CSR0
, 
DEPCA_ADDR
);

1199 
	`outw
(
IDON
|
INEA
|
STRT
, 
DEPCA_DATA
);

1200 
	}
}

1209 
	$S‘MuÉiÿ¡F‹r
(
num_addrs
, *
addrs
, *
muÉiÿ¡_bË
)

1211 
j
, 
ù¾
, 
b™
, 
où‘
, 
hashcode
;

1212 
i
;

1213 
CRC
, 
pŞy
 = (è
CRC_POLYNOMIAL
;

1215 
i
=0;i<
num_addrs
;i++) {

1216 ià(((è*(
addrs
+
ETH_ALEN
*
i
) & 0x01) == 1) {

1217 
CRC
 = () 0xffffffff;

1218 
où‘
=0;où‘<
ETH_ALEN
;octet++) {

1219 
j
=0;j<8;j++) {

1220 
b™
 = ((()* (
addrs
+
ETH_ALEN
*
i
+
où‘
)è>> 
j
) & 0x01;

1221 
ù¾
 = ((
CRC
 < 0) ? 1 : 0);

1222 
CRC
 <<= 1;

1223 ià(
b™
 ^ 
ù¾
) {

1224 
CRC
 ^ğ
pŞy
;

1228 
hashcode
 = (
CRC
 & 0x00000001);

1229 
j
=0;j<5;j++) {

1230 
hashcode
 <<= 1;

1231 
CRC
 >>= 1;

1232 
hashcode
 |ğ(
CRC
 & 0x00000001);

1234 
où‘
 = 
hashcode
 >> 3;

1236 
muÉiÿ¡_bË
[
où‘
] |ğ(1 << (
hashcode
 & 0x07));

1240 
	}
}

1249 *
	$D•ÿSigÇtu»
(
mem_addr
)

1251 
i
,
j
,
k
;

1252 
sigÇtu»s
[][
DEPCA_NAME_LENGTH
] = 
DEPCA_SIGNATURE
;

1253 
thisName
[
DEPCA_NAME_LENGTH
];

1254 
tmp¡r
[17];

1256 
i
=0;i<16;i++) {

1257 
tmp¡r
[
i
] = *(*)(
mem_addr
+0xc000+i);

1259 
tmp¡r
[
i
]=()
NULL
;

1261 
	`¡rıy
(
thisName
,"");

1262 
i
=0;*
sigÇtu»s
[i]!=()
NULL
 && *
thisName
==()NULL;i++) {

1263 
j
=0,
k
=0;j<16 && k<
	`¡¾’
(
sigÇtu»s
[
i
]);j++) {

1264 ià(
sigÇtu»s
[
i
][
k
] =ğ
tmp¡r
[
j
]) {

1265 
k
++;

1267 
k
=0;

1270 ià(
k
 =ğ
	`¡¾’
(
sigÇtu»s
[
i
])) {

1271 
	`¡rıy
(
thisName
,
sigÇtu»s
[
i
]);

1275  
thisName
;

1276 
	}
}

1283 
	$DeviûP»£Á
(
ißddr
)

1285 
å
=1,
sigL’gth
=0;

1286 
devSig
[] = 
PROBE_SEQUENCE
;

1287 
d©a
;

1288 
i
, 
j
, 
¡©us
 = 0;

1289 
	`asc2hex
(
v®ue
);

1294 ià(
å
) {

1295 
i
=0,
j
=0;
devSig
[i]!=()
NULL
 && !
¡©us
;i+=2,j++) {

1296 ià((
devSig
[
i
]=
	`asc2hex
(devSig[i]))>=0) {

1297 
devSig
[
i
]<<=4;

1298 if((
devSig
[
i
+1]=
	`asc2hex
(devSig[i+1]))>=0){

1299 
devSig
[
j
]=devSig[
i
]+devSig[i+1];

1301 
¡©us
= -1;

1304 
¡©us
= -1;

1307 
sigL’gth
=
j
;

1308 
å
 = 0;

1319 ià(!
¡©us
) {

1320 
i
=0,
j
=0;j<
sigL’gth
 && i<
PROBE_LENGTH
+sigLength-1;i++) {

1321 
d©a
 = 
	`šb
(
ißddr
);

1322 ià(
devSig
[
j
] =ğ
d©a
) {

1323 
j
++;

1325 
j
=0;

1329 ià(
j
!=
sigL’gth
) {

1330 
¡©us
 = -
ENODEV
;

1334  
¡©us
;

1335 
	}
}

1337 
	$asc2hex
(
v®ue
)

1339 
v®ue
 -= 0x30;

1340 ià(
v®ue
 >= 0) {

1341 ià(
v®ue
 > 9) {

1342 
v®ue
 &= 0x1f;

1343 
v®ue
 -= 0x07;

1344 ià((
v®ue
 < 0x0a) || (value > 0x0f)) {

1345 
v®ue
 = -1;

1349 
v®ue
 = -1;

1351  
v®ue
;

1352 
	}
}

	@drivers/net/depca.h

13 
	#DEPCA_NICSR
 
ißddr
+0x00

	)

14 
	#DEPCA_RBI
 
ißddr
+0x02

	)

15 
	#DEPCA_DATA
 
ißddr
+0x04

	)

16 
	#DEPCA_ADDR
 
ißddr
+0x06

	)

17 
	#DEPCA_PROM
 
ißddr
+0x0ø

	)

18 
	#DEPCA_RBSA
 
ißddr
+0x0

	)

23 
	#CSR0
 0

	)

24 
	#CSR1
 1

	)

25 
	#CSR2
 2

	)

26 
	#CSR3
 3

	)

32 
	#TO
 0x0100

	)

33 
	#SHE
 0x0080

	)

34 
	#BS
 0x0040

	)

35 
	#BUF
 0x0020

	)

36 
	#RBE
 0x0010

	)

37 
	#AAC
 0x0008

	)

38 
	#IM
 0x0004

	)

39 
	#IEN
 0x0002

	)

40 
	#LED
 0x0001

	)

46 
	#ERR
 0x8000

	)

47 
	#BABL
 0x4000

	)

48 
	#CERR
 0x2000

	)

49 
	#MISS
 0x1000

	)

50 
	#MERR
 0x0800

	)

51 
	#RINT
 0x0400

	)

52 
	#TINT
 0x0200

	)

53 
	#IDON
 0x0100

	)

54 
	#INTR
 0x0080

	)

55 
	#INEA
 0x0040

	)

56 
	#RXON
 0x0020

	)

57 
	#TXON
 0x0010

	)

58 
	#TDMD
 0x0008

	)

59 
	#STOP
 0x0004

	)

60 
	#STRT
 0x0002

	)

61 
	#INIT
 0x0001

	)

67 
	#BSWP
 0x0004

	)

68 
	#ACON
 0x0002

	)

69 
	#BCON
 0x0001

	)

75 
	#PROM
 0x8000

	)

76 
	#EMBA
 0x0080

	)

77 
	#INTL
 0x0040

	)

78 
	#DRTY
 0x0020

	)

79 
	#COLL
 0x0010

	)

80 
	#DTCR
 0x0008

	)

81 
	#LOOP
 0x0004

	)

82 
	#DTX
 0x0002

	)

83 
	#DRX
 0x0001

	)

89 
	#R_OWN
 0x80000000

	)

90 
	#R_ERR
 0x4000

	)

91 
	#R_FRAM
 0x2000

	)

92 
	#R_OFLO
 0x1000

	)

93 
	#R_CRC
 0x0800

	)

94 
	#R_BUFF
 0x0400

	)

95 
	#R_STP
 0x0200

	)

96 
	#R_ENP
 0x0100

	)

102 
	#T_OWN
 0x80000000

	)

103 
	#T_ERR
 0x4000

	)

104 
	#T_ADD_FCS
 0x2000

	)

105 
	#T_MORE
 0x1000

	)

106 
	#T_ONE
 0x0800

	)

107 
	#T_DEF
 0x0400

	)

108 
	#T_STP
 0x02000000

	)

109 
	#T_ENP
 0x01000000

	)

115 
	#TMD3_BUFF
 0x8000

	)

116 
	#TMD3_UFLO
 0x4000

	)

117 
	#TMD3_RES
 0x2000

	)

118 
	#TMD3_LCOL
 0x1000

	)

119 
	#TMD3_LCAR
 0x0800

	)

120 
	#TMD3_RTRY
 0x0400

	)

126 
	#MASK_INTERRUPTS
 1

	)

127 
	#UNMASK_INTERRUPTS
 0

	)

	@drivers/net/eexpress.c

21 *
	gv”siÚ
 =

24 
	~<lšux/cÚfig.h
>

37 
	~<lšux/k”Ãl.h
>

38 
	~<lšux/sched.h
>

39 
	~<lšux/ty³s.h
>

40 
	~<lšux/fú.h
>

41 
	~<lšux/š‹¼u±.h
>

42 
	~<lšux/±¿û.h
>

43 
	~<lšux/iİÜt.h
>

44 
	~<lšux/š.h
>

45 
	~<asm/sy¡em.h
>

46 
	~<asm/b™İs.h
>

47 
	~<asm/io.h
>

48 
	~<asm/dma.h
>

49 
	~<”ºo.h
>

50 
	~<memÜy.h
>

52 
	~"dev.h
"

53 
	~"‘h.h
"

54 
	~"skbuff.h
"

55 
	~"¬p.h
"

57 #iâdeà
HAVE_ALLOC_SKB


58 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

61 
	~<lšux/m®loc.h
>

65 #iâdeà
NET_DEBUG


66 
	#NET_DEBUG
 2

	)

68 
	gÃt_debug
 = 
NET_DEBUG
;

88 
	#CMD_EOL
 0x8000

	)

89 
	#CMD_SUSP
 0x4000

	)

90 
	#CMD_INTR
 0x2000

	)

92 
	ecommªds
 {

93 
	mCmdNOp
 = 0, 
	mCmdSAS‘up
 = 1, 
	mCmdCÚfigu»
 = 2, 
	mCmdMuÉiÿ¡Li¡
 = 3,

94 
	mCmdTx
 = 4, 
	mCmdTDR
 = 5, 
	mCmdDump
 = 6, 
	mCmdDŸgno£
 = 7};

97 
	sÃt_loÿl
 {

98 
’‘_¡©i¡ics
 
	m¡©s
;

99 
	mÏ¡_»¡¬t
;

100 
	mrx_h—d
;

101 
	mrx_
;

102 
	mtx_h—d
;

103 
	mtx_cmd_lšk
;

104 
	mtx_»­
;

135 
	#DATAPORT
 0

	)

136 
	#WRITE_PTR
 2

	)

137 
	#READ_PTR
 4

	)

138 
	#SIGNAL_CA
 6

	)

139 
	#SET_IRQ
 7

	)

140 
	#SHADOW_PTR
 8

	)

141 
	#MEM_CŒl
 11

	)

142 
	#MEM_Page_CŒl
 12

	)

143 
	#CÚfig
 13

	)

144 
	#EEPROM_CŒl
 14

	)

145 
	#ID_PORT
 15

	)

149 
	#EE_SHIFT_CLK
 0x01

	)

150 
	#EE_CS
 0x02

	)

151 
	#EE_DATA_WRITE
 0x04

	)

152 
	#EE_DATA_READ
 0x08

	)

153 
	#EE_CTRL_BITS
 (
EE_SHIFT_CLK
 | 
EE_CS
 | 
EE_DATA_WRITE
 | 
EE_DATA_READ
)

	)

154 
	#ASIC_RESET
 0x40

	)

155 
	#_586_RESET
 0x80

	)

158 
	#SCB_STATUS
 0xc008

	)

159 
	#SCB_CMD
 0xc00A

	)

160 
	#CUC_START
 0x0100

	)

161 
	#CUC_RESUME
 0x0200

	)

162 
	#CUC_SUSPEND
 0x0300

	)

163 
	#RX_START
 0x0010

	)

164 
	#RX_RESUME
 0x0020

	)

165 
	#RX_SUSPEND
 0x0030

	)

166 
	#SCB_CBL
 0xc00C

	)

167 
	#SCB_RFA
 0xc00E

	)

184 
	#CONFIG_CMD
 0x0018

	)

185 
	#SET_SA_CMD
 0x0024

	)

186 
	#SA_OFFSET
 0x002A

	)

187 
	#IDLELOOP
 0x30

	)

188 
	#TDR_CMD
 0x38

	)

189 
	#TDR_TIME
 0x3C

	)

190 
	#DUMP_CMD
 0x40

	)

191 
	#DIAG_CMD
 0x48

	)

192 
	#SET_MC_CMD
 0x4E

	)

193 
	#DUMP_DATA
 0x56

	)

195 
	#TX_BUF_START
 0x0100

	)

196 
	#NUM_TX_BUFS
 4

	)

197 
	#TX_BUF_SIZE
 0x0680

	)

198 
	#TX_BUF_END
 0x2000

	)

200 
	#RX_BUF_START
 0x2000

	)

201 
	#RX_BUF_SIZE
 (0x640è

	)

202 
	#RX_BUF_END
 0x4000

	)

237 
	gš™_wÜds
[] = {

244 0,0xf000|
RX_START
|
CUC_START
,

245 
CONFIG_CMD
,

246 
RX_BUF_START
,

250 0, 
CmdCÚfigu»
,

251 
SET_SA_CMD
,

257 0, 
CmdSAS‘up
,

258 
SET_MC_CMD
,

262 0, 
CmdNOp
, 
IDLELOOP
, 0 ,

265 0, 
CmdTDR
, 
IDLELOOP
, 0,

268 0, 
CmdDump
, 
IDLELOOP
, 
DUMP_DATA
,

271 0, 
CmdDŸgno£
, 
IDLELOOP
,

274 #ifdeà
š™Ÿl_‹xt_tx


275 0, 
CmdMuÉiÿ¡Li¡
, 
DUMP_DATA
, 0,

277 0, 
CmdMuÉiÿ¡Li¡
, 
IDLELOOP
, 0,

281 0, 
CmdTx
, 
DUMP_DATA
, DUMP_DATA+8, 0x83ff, -1, DUMP_DATA, 0,

286 
ex´ess_´obe
(
deviû
 *
dev
);

288 
“xp_´obe1
(
deviû
 *
dev
, 
ißddr
);

289 
“xp_İ’
(
deviû
 *
dev
);

290 
“xp_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

291 
“xp_š‹¼u±
(
»g_±r
);

292 
“xp_rx
(
deviû
 *
dev
);

293 
“xp_şo£
(
deviû
 *
dev
);

294 
’‘_¡©i¡ics
 *
“xp_g‘_¡©s
(
deviû
 *
dev
);

295 #ifdeà
HAVE_MULTICAST


296 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

299 
»ad_“´om
(
ißddr
, 
loÿtiÚ
);

300 
h¬dw¬e_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
);

301 
š™_82586_mem
(
deviû
 *
dev
);

302 
š™_rx_bufs
(
deviû
 *
dev
);

312 
	$ex´ess_´obe
(
deviû
 *
dev
)

315 *
pÜt
, 
pÜts
[] = {0x300, 0x270, 0x320, 0x340, 0};

316 
ba£_addr
 = 
dev
->base_addr;

318 ià(
ba£_addr
 > 0x1ff)

319  
	`“xp_´obe1
(
dev
, 
ba£_addr
);

320 ià(
ba£_addr
 > 0)

321  
ENXIO
;

323 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

324 
id_addr
 = *
pÜt
 + 
ID_PORT
;

325 
sum
 = 0;

326 
i
;

327 #ifdeà
nÙdef


328 
i
 = 16; i > 0; i--)

329 
sum
 +ğ
	`šb
(
id_addr
);

330 
	`´štk
("Eth”Ex´es ID checksum i %04x.\n", 
sum
);

332 
i
 = 4; i > 0; i--) {

333 
id_v®
 = 
	`šb
(
id_addr
);

334 
sum
 |ğ(
id_v®
 >> 4) << ((id_val & 3) << 2);

337 ià(
sum
 == 0xbaba

338 && 
	`“xp_´obe1
(
dev
, *
pÜt
) == 0)

342  
ENODEV
;

343 
	}
}

345 
	$“xp_´obe1
(
deviû
 *
dev
, 
ißddr
)

347 
¡©iÚ_addr
[3];

348 
i
;

350 
	`´štk
("%s: Eth”Ex´es © %#x,", 
dev
->
Çme
, 
ißddr
);

354 
¡©iÚ_addr
[0] = 
	`»ad_“´om
(
ißddr
, 2);

355 
¡©iÚ_addr
[1] = 
	`»ad_“´om
(
ißddr
, 3);

356 
¡©iÚ_addr
[2] = 
	`»ad_“´om
(
ißddr
, 4);

359 ià(
¡©iÚ_addr
[2] != 0x00aa || (station_addr[1] & 0xff00) != 0x0000) {

360 
	`´štk
("„ejected (invalid‡ddress %04x%04x%04x).\n",

361 
¡©iÚ_addr
[2], station_addr[1], station_addr[0]);

362  
ENODEV
;

366 
	`¢¬f_»giÚ
(
ißddr
, 16);

367 
dev
->
ba£_addr
 = 
ißddr
;

369 
i
 = 0; i < 6; i++) {

370 
dev
->
dev_addr
[
i
] = ((*)
¡©iÚ_addr
)[5-i];

371 
	`´štk
(" %02x", 
dev
->
dev_addr
[
i
]);

377 
œqm­
[] = {0, 9, 3, 4, 5, 10, 11, 0};

378 *
ifm­
[] = {"AUI", "BNC", "10baseT"};

379 
	eiáy³
 {
AUI
=0, 
BNC
=1, 
TP
=2};

380 
£tupv®
 = 
	`»ad_“´om
(
ißddr
, 0);

382 
dev
->
œq
 = 
œqm­
[
£tupv®
 >> 13];

383 
dev
->
if_pÜt
 = (
£tupv®
 & 0x1000è=ğ0 ? 
AUI
 :

384 
	`»ad_“´om
(
ißddr
, 5è& 0x1 ? 
TP
 : 
BNC
;

385 
	`´štk
(", IRQ %d, IÁ”çû %s.\n", 
dev
->
œq
, 
ifm­
[dev->
if_pÜt
]);

388 
	`outb
(0x00, 
ißddr
 + 
SET_IRQ
);

392 
	`outb
(
ASIC_RESET
, 
ißddr
 + 
EEPROM_CŒl
);

394 ià((
dev
->
mem_¡¬t
 & 0xf) > 0)

395 
Ãt_debug
 = 
dev
->
mem_¡¬t
 & 7;

397 ià(
Ãt_debug
)

398 
	`´štk
(
v”siÚ
);

401 
dev
->
´iv
 = 
	`km®loc
((
Ãt_loÿl
), 
GFP_KERNEL
);

402 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt_loÿl
));

404 
dev
->
İ’
 = 
“xp_İ’
;

405 
dev
->
¡İ
 = 
“xp_şo£
;

406 
dev
->
h¬d_¡¬t_xm™
 = 
“xp_£nd_·ck‘
;

407 
dev
->
g‘_¡©s
 = 
“xp_g‘_¡©s
;

408 #ifdeà
HAVE_MULTICAST


409 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

414 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

415 
dev
->
buffs
[
i
] = 
NULL
;

417 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

418 
dev
->
add_¬p
 = 
‘h_add_¬p
;

419 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

420 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

421 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

423 
dev
->
ty³
 = 
ARPHRD_ETHER
;

424 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

425 
dev
->
mtu
 = 1500;

426 
dev
->
addr_Ën
 = 
ETH_ALEN
;

427 
i
 = 0; i < 
ETH_ALEN
; i++) {

428 
dev
->
brßdÿ¡
[
i
]=0xff;

432 
dev
->
æags
 = 
IFF_BROADCAST
;

433 
dev
->
çmy
 = 
AF_INET
;

434 
dev
->
·_addr
 = 0;

435 
dev
->
·_brdaddr
 = 0;

436 
dev
->
·_mask
 = 0;

437 
dev
->
·_®’
 = ();

440 
	}
}

444 
	gœqrm­
[]={0,0,1,2,3,4,0,0,0,1,5,6,0,0,0,0};

447 
	$“xp_İ’
(
deviû
 *
dev
)

449 
ißddr
 = 
dev
->
ba£_addr
;

451 ià(
dev
->
œq
 =ğ0 || 
œqrm­
[dev->irq] == 0)

452  -
ENXIO
;

454 ià(
œq2dev_m­
[
dev
->
œq
] != 0

456 || (
œq2dev_m­
[
dev
->
œq
] = dev) == 0

457 || 
	`»que¡_œq
(
dev
->
œq
, &
“xp_š‹¼u±
)) {

458  -
EAGAIN
;

462 
	`š™_82586_mem
(
dev
);

465 
	`outb
(
œqrm­
[
dev
->
œq
] | 0x08, 
ißddr
 + 
SET_IRQ
);

467 
dev
->
tbusy
 = 0;

468 
dev
->
š‹¼u±
 = 0;

469 
dev
->
¡¬t
 = 1;

471 
	}
}

474 
	$“xp_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

476 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

477 
ißddr
 = 
dev
->
ba£_addr
;

479 ià(
dev
->
tbusy
) {

482 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

483 ià(
tickssoçr
 < 5)

485 ià(
Ãt_debug
 > 1)

486 
	`´štk
("%s:¿nsm™imed out, %s? ", 
dev
->
Çme
,

487 
	`šw
(
ißddr
+
SCB_STATUS
) & 0x8000 ? "IRQ conflict" :

489 
Í
->
¡©s
.
tx_”rÜs
++;

491 ià(
Í
->
Ï¡_»¡¬t
 =ğÍ->
¡©s
.
tx_·ck‘s
) {

492 ià(
Ãt_debug
 > 1è
	`´štk
("Resetting board.\n");

494 
	`š™_82586_mem
(
dev
);

497 ià(
Ãt_debug
 > 1è
	`´štk
("Kicking board.\n");

498 
	`outw
(0xf000|
CUC_START
|
RX_START
, 
ißddr
 + 
SCB_CMD
);

499 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

500 
Í
->
Ï¡_»¡¬t
 =†p->
¡©s
.
tx_·ck‘s
;

502 
dev
->
tbusy
=0;

503 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

509 ià(
skb
 =ğ
NULL
) {

510 
	`dev_tšt
(
dev
);

516 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

517 
skb
->
dev
 = dev;

518 
	`¬p_queue
 (
skb
);

521 
skb
->
¬p
=1;

524 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

525 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

527 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

528 *
buf
 = 
skb
->
d©a
;

531 
	`outb
(
œqrm­
[
dev
->
œq
], 
ißddr
 + 
SET_IRQ
);

532 
	`h¬dw¬e_£nd_·ck‘
(
dev
, 
buf
, 
Ëngth
);

533 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

535 
	`outb
(0x08 | 
œqrm­
[
dev
->
œq
], 
ißddr
 + 
SET_IRQ
);

538 ià(
skb
->
ä“
)

539 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

542 
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

545 
	}
}

550 
	$“xp_š‹¼u±
(
»g_±r
)

552 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

553 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

554 
Ãt_loÿl
 *
Í
;

555 
ißddr
, 
¡©us
, 
boguscouÁ
 = 0;

556 
ack_cmd
;

558 ià(
dev
 =ğ
NULL
) {

559 
	`´štk
 ("Ãt_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

562 
dev
->
š‹¼u±
 = 1;

564 
ißddr
 = 
dev
->
ba£_addr
;

565 
Í
 = (
Ãt_loÿl
 *)
dev
->
´iv
;

567 
¡©us
 = 
	`šw
(
ißddr
 + 
SCB_STATUS
);

569 ià(
Ãt_debug
 > 4) {

570 
	`´štk
("%s: EEx°š‹¼u±, stu %4.4x.\n", 
dev
->
Çme
, 
¡©us
);

574 
	`outb
(
œqrm­
[
dev
->
œq
], 
ißddr
 + 
SET_IRQ
);

577 
Í
->
tx_»­
 !ğÍ->
tx_h—d
) {

578 
tx_¡©us
;

579 
	`outw
(
Í
->
tx_»­
, 
ißddr
 + 
READ_PTR
);

580 
tx_¡©us
 = 
	`šw
(
ißddr
);

581 ià(
tx_¡©us
 == 0) {

582 ià(
Ãt_debug
 > 5è
	`´štk
("Couldn'ˆ»­ %#x.\n", 
Í
->
tx_»­
);

585 ià(
tx_¡©us
 & 0x2000) {

586 
Í
->
¡©s
.
tx_·ck‘s
++;

587 
Í
->
¡©s
.
cŞlisiÚs
 +ğ
tx_¡©us
 & 0xf;

588 
dev
->
tbusy
 = 0;

589 
	`m¬k_bh
(
INET_BH
);

591 
Í
->
¡©s
.
tx_”rÜs
++;

592 ià(
tx_¡©us
 & 0x0600è
Í
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

593 ià(
tx_¡©us
 & 0x0100è
Í
->
¡©s
.
tx_fifo_”rÜs
++;

594 ià(!(
tx_¡©us
 & 0x0040)è
Í
->
¡©s
.
tx_h—¹b—t_”rÜs
++;

595 ià(
tx_¡©us
 & 0x0020è
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

597 ià(
Ãt_debug
 > 5)

598 
	`´štk
("R—³d %x, Tx stu %04x.\n" , 
Í
->
tx_»­
, 
tx_¡©us
);

599 
Í
->
tx_»­
 +ğ
TX_BUF_SIZE
;

600 ià(
Í
->
tx_»­
 > 
TX_BUF_END
 - 
TX_BUF_SIZE
)

601 
Í
->
tx_»­
 = 
TX_BUF_START
;

602 ià(++
boguscouÁ
 > 4)

606 ià(
¡©us
 & 0x4000) {

607 ià(
Ãt_debug
 > 5)

608 
	`´štk
("Reûived…ack‘,„x_h—d %04x.\n", 
Í
->
rx_h—d
);

609 
	`“xp_rx
(
dev
);

613 
ack_cmd
 = 
¡©us
 & 0xf000;

615 ià((
¡©us
 & 0x0700è!ğ0x0200 && 
dev
->
¡¬t
) {

616 
§ved_wr™e_±r
 = 
	`šw
(
ißddr
 + 
WRITE_PTR
);

617 ià(
Ãt_debug
 > 1)

618 
	`´štk
("%s: Command unit stopped, status %04x,„estarting.\n",

619 
dev
->
Çme
, 
¡©us
);

622 
	`outw
(
IDLELOOP
, 
ißddr
 + 
WRITE_PTR
);

623 
	`outw
(0, 
ißddr
);

624 
	`outw
(
CmdNOp
, 
ißddr
);

625 
	`outw
(
IDLELOOP
, 
ißddr
);

626 
	`outw
(
IDLELOOP
, 
SCB_CBL
);

627 
Í
->
tx_cmd_lšk
 = 
IDLELOOP
 + 4;

628 
Í
->
tx_h—d
 =†p->
tx_»­
 = 
TX_BUF_START
;

630 
	`outw
(
§ved_wr™e_±r
, 
ißddr
 + 
WRITE_PTR
);

631 
ack_cmd
 |ğ
CUC_START
;

634 ià((
¡©us
 & 0x0070è!ğ0x0040 && 
dev
->
¡¬t
) {

635 
§ved_wr™e_±r
 = 
	`šw
(
ißddr
 + 
WRITE_PTR
);

638 
Í
->
¡©s
.
rx_”rÜs
++;

639 ià(
Ãt_debug
 > 1) {

640 
cur_rxbuf
 = 
RX_BUF_START
;

641 
	`´štk
("%s: Rx unit stopped status %04x„x head %04xail %04x.\n",

642 
dev
->
Çme
, 
¡©us
, 
Í
->
rx_h—d
,†p->
rx_
);

643 
cur_rxbuf
 <ğ
RX_BUF_END
 - 
RX_BUF_SIZE
) {

644 
i
;

645 
	`´štk
(" Rx buà© %04x:", 
cur_rxbuf
);

646 
	`outw
(
cur_rxbuf
, 
ißddr
 + 
READ_PTR
);

647 
i
 = 0; i < 0x20; i += 2)

648 
	`´štk
(" %04x", 
	`šw
(
ißddr
));

649 
	`´štk
(".\n");

650 
cur_rxbuf
 +ğ
RX_BUF_SIZE
;

653 
	`š™_rx_bufs
(
dev
);

654 
	`outw
(
RX_BUF_START
, 
SCB_RFA
);

655 
	`outw
(
§ved_wr™e_±r
, 
ißddr
 + 
WRITE_PTR
);

656 
ack_cmd
 |ğ
RX_START
;

659 
	`outw
(
ack_cmd
, 
ißddr
 + 
SCB_CMD
);

660 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

662 ià(
Ãt_debug
 > 5) {

663 
	`´štk
("%s: EEx°ex™šg iÁ”ru±, stu %4.4x.\n", 
dev
->
Çme
,

664 
	`šw
(
ißddr
 + 
SCB_CMD
));

667 
	`outb
(
œqrm­
[
dev
->
œq
] | 0x08, 
ißddr
 + 
SET_IRQ
);

669 
	}
}

672 
	$“xp_şo£
(
deviû
 *
dev
)

674 
ißddr
 = 
dev
->
ba£_addr
;

676 
dev
->
tbusy
 = 1;

677 
dev
->
¡¬t
 = 0;

680 
	`outw
(
RX_SUSPEND
 | 
CUC_SUSPEND
, 
ißddr
 + 
SCB_CMD
);

681 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

684 
	`outb
(0, 
ißddr
 + 
SET_IRQ
);

686 
	`ä“_œq
(
dev
->
œq
);

688 
œq2dev_m­
[
dev
->
œq
] = 0;

693 
	}
}

697 
’‘_¡©i¡ics
 *

698 
	$“xp_g‘_¡©s
(
deviû
 *
dev
)

700 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

704  &
Í
->
¡©s
;

705 
	}
}

707 #ifdeà
HAVE_MULTICAST


715 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

717 
ißddr
 = 
dev
->
ba£_addr
;

718 ià(
num_addrs
 < 0) {

721 } ià(
num_addrs
 > 0) {

724 
	`outw
(
SET_MC_CMD
 + 6, 
ißddr
 + 
WRITE_PTR
);

725 
	`outw
(
num_addrs
 * 6, 
ißddr
);

726 
	`outsw
(
ißddr
, 
addrs
, 
num_addrs
*3);

731 
	`outw
(99, 
ißddr
);

733 
	}
}

739 
	#“´om_d–ay
(è{ 
_i
 = 40; --_˜> 0è{ 
__SLOW_DOWN_IO
; }}

	)

740 
	#EE_READ_CMD
 (6 << 6)

	)

743 
	$»ad_“´om
(
ißddr
, 
loÿtiÚ
)

745 
i
;

746 
»tv®
 = 0;

747 
“_addr
 = 
ißddr
 + 
EEPROM_CŒl
;

748 
»ad_cmd
 = 
loÿtiÚ
 | 
EE_READ_CMD
;

749 
ù¾_v®
 = 
EE_CS
 | 
_586_RESET
;

751 
	`outb
(
ù¾_v®
, 
“_addr
);

754 
i
 = 8; i >= 0; i--) {

755 
outv®
 = (
»ad_cmd
 & (1 << 
i
)è? 
ù¾_v®
 | 
EE_DATA_WRITE


756 : 
ù¾_v®
;

757 
	`outb
(
outv®
, 
“_addr
);

758 
	`outb
(
outv®
 | 
EE_SHIFT_CLK
, 
“_addr
);

759 
	`“´om_d–ay
();

760 
	`outb
(
outv®
, 
“_addr
);

761 
	`“´om_d–ay
();

763 
	`outb
(
ù¾_v®
, 
“_addr
);

765 
i
 = 16; i > 0; i--) {

766 
	`outb
(
ù¾_v®
 | 
EE_SHIFT_CLK
, 
“_addr
); 
	`“´om_d–ay
();

767 
»tv®
 = (»tv® << 1è| ((
	`šb
(
“_addr
è& 
EE_DATA_READ
) ? 1 : 0);

768 
	`outb
(
ù¾_v®
, 
“_addr
); 
	`“´om_d–ay
();

772 
ù¾_v®
 &ğ~
EE_CS
;

773 
	`outb
(
ù¾_v®
 | 
EE_SHIFT_CLK
, 
“_addr
);

774 
	`“´om_d–ay
();

775 
	`outb
(
ù¾_v®
, 
“_addr
);

776 
	`“´om_d–ay
();

777  
»tv®
;

778 
	}
}

781 
	$š™_82586_mem
(
deviû
 *
dev
)

783 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

784 
ißddr
 = 
dev
->
ba£_addr
;

788 
	`outb
(
	`šb
(
ißddr
 + 
CÚfig
) | 0x02, ioaddr + Config);

791 
	`outb
(
_586_RESET
, 
ißddr
 + 
EEPROM_CŒl
);

794 
	`outw
(0xfff6, 
ißddr
 + 
WRITE_PTR
);

795 
	`outsw
(
ißddr
, 
š™_wÜds
, (init_words)>>1);

798 
	`outw
(
SA_OFFSET
, 
ißddr
 + 
WRITE_PTR
);

799 
	`outsw
(
ißddr
, 
dev
->
dev_addr
, 3);

802 #ifdeà
š™Ÿl_‹xt_tx


803 
Í
->
tx_cmd_lšk
 = 
DUMP_DATA
 + 4;

805 
Í
->
tx_cmd_lšk
 = 
IDLELOOP
 + 4;

807 
Í
->
tx_h—d
 =†p->
tx_»­
 = 
TX_BUF_START
;

809 
	`š™_rx_bufs
(
dev
);

812 
	`outb
(0x00, 
ißddr
 + 
EEPROM_CŒl
);

816 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

819 
bogusút
 = 50;

820 
	`šw
(
ißddr
 + 
SCB_STATUS
) == 0)

821 ià(--
bogusút
 == 0) {

822 
	`´štk
("%s: i82586 initializationimed out with status %04x, cmd %04x.\n",

823 
dev
->
Çme
, 
	`šw
(
ißddr
 + 
SCB_STATUS
), inw(ißdd¸+ 
SCB_CMD
));

827 
	`outb
(0, 
ißddr
 + 
SIGNAL_CA
);

831 
	`outb
(
	`šb
(
ißddr
 + 
CÚfig
) & ~0x02, ioaddr + Config);

832 ià(
Ãt_debug
 > 4)

833 
	`´štk
("%s: In™Ÿlized 82586, stu %04x.\n", 
dev
->
Çme
,

834 
	`šw
(
ißddr
 + 
SCB_STATUS
));

836 
	}
}

839 
	$š™_rx_bufs
(
deviû
 *
dev
)

841 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

842 
ißddr
 = 
dev
->
ba£_addr
;

844 
cur_rxbuf
 = 
Í
->
rx_h—d
 = 
RX_BUF_START
;

848 
	`outw
(
cur_rxbuf
, 
ißddr
 + 
WRITE_PTR
);

849 
	`outw
(0x0000, 
ißddr
);

850 
	`outw
(0x0000, 
ißddr
);

851 
	`outw
(
cur_rxbuf
 + 
RX_BUF_SIZE
, 
ißddr
);

852 
	`outw
(
cur_rxbuf
 + 22, 
ißddr
);

853 
	`outw
(0xF“d, 
ißddr
);

854 
	`outw
(0xF00d, 
ißddr
);

855 
	`outw
(0xF001, 
ißddr
);

856 
	`outw
(0x0505, 
ißddr
);

857 
	`outw
(0x2424, 
ißddr
);

858 
	`outw
(0x6565, 
ißddr
);

859 
	`outw
(0xd—f, 
ißddr
);

861 
	`outw
(0x0000, 
ißddr
);

862 
	`outw
(-1, 
ißddr
);

863 
	`outw
(
cur_rxbuf
 + 0x20, 
ißddr
);

864 
	`outw
(0x0000, 
ißddr
);

866 
	`outw
(0x8000 + 
RX_BUF_SIZE
-0x20, 
ißddr
);

868 
Í
->
rx_
 = 
cur_rxbuf
;

869 
cur_rxbuf
 +ğ
RX_BUF_SIZE
;

870 } 
cur_rxbuf
 <ğ
RX_BUF_END
 - 
RX_BUF_SIZE
);

874 
	`outw
(
Í
->
rx_
 + 2, 
ißddr
 + 
WRITE_PTR
);

875 
	`outw
(0xC000, 
ißddr
);

876 
	`outw
(
Í
->
rx_h—d
, 
ißddr
);

877 
	}
}

880 
	$h¬dw¬e_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
)

882 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

883 
ißddr
 = 
dev
->
ba£_addr
;

884 
tx_block
 = 
Í
->
tx_h—d
;

887 
	`outw
(
tx_block
, 
ißddr
 + 
WRITE_PTR
);

888 
	`outw
(0x0000, 
ißddr
);

889 
	`outw
(
CMD_INTR
|
CmdTx
, 
ißddr
);

890 
	`outw
(
tx_block
+16, 
ißddr
);

891 
	`outw
(
tx_block
+8, 
ißddr
);

894 
	`outw
(
Ëngth
 | 0x8000, 
ißddr
);

895 
	`outw
(-1, 
ißddr
);

896 
	`outw
(
tx_block
+22, 
ißddr
);

897 
	`outw
(0x0000, 
ißddr
);

900 
	`outw
(0x0000, 
ißddr
);

901 
	`outw
(
CmdNOp
, 
ißddr
);

902 
	`outw
(
tx_block
+16, 
ißddr
);

906 
	`outsw
(
ißddr
 + 
DATAPORT
, 
buf
, (
Ëngth
 + 1) >> 1);

909 
	`outw
(
Í
->
tx_cmd_lšk
, 
ißddr
 + 
WRITE_PTR
);

910 
	`outw
(
tx_block
, 
ißddr
);

911 
Í
->
tx_cmd_lšk
 = 
tx_block
 + 20;

914 
Í
->
tx_h—d
 = 
tx_block
 + 
TX_BUF_SIZE
;

915 ià(
Í
->
tx_h—d
 > 
TX_BUF_END
 - 
TX_BUF_SIZE
)

916 
Í
->
tx_h—d
 = 
TX_BUF_START
;

918 ià(
Ãt_debug
 > 4) {

919 
	`´štk
("%s: EExp @%x send†ength = %d,x_block %3x,‚ext %3x, "

920 "»­ %4x stu %4.4x.\n", 
dev
->
Çme
, 
ißddr
, 
Ëngth
,

921 
tx_block
, 
Í
->
tx_h—d
,†p->
tx_»­
, 
	`šw
(
ißddr
 + 
SCB_STATUS
));

924 ià(
Í
->
tx_h—d
 !ğÍ->
tx_»­
)

925 
dev
->
tbusy
 = 0;

926 
	}
}

929 
	$“xp_rx
(
deviû
 *
dev
)

931 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

932 
ißddr
 = 
dev
->
ba£_addr
;

933 
§ved_wr™e_±r
 = 
	`šw
(
ißddr
 + 
WRITE_PTR
);

934 
rx_h—d
 = 
Í
->rx_head;

935 
rx_
 = 
Í
->rx_tail;

936 
boguscouÁ
 = 10;

937 
äame_¡©us
;

940 
	`outw
(
rx_h—d
, 
ißddr
 + 
READ_PTR
);

941 (
äame_¡©us
 = 
	`šw
(
ißddr
)) < 0) {

942 
rfd_cmd
 = 
	`šw
(
ißddr
);

943 
Ãxt_rx_äame
 = 
	`šw
(
ißddr
);

944 
d©a_bufãr_addr
 = 
	`šw
(
ißddr
);

945 
pkt_Ën
;

948 
	`outw
(
d©a_bufãr_addr
, 
ißddr
 + 
READ_PTR
);

949 
pkt_Ën
 = 
	`šw
(
ißddr
);

951 ià(
rfd_cmd
 !ğ0 || 
d©a_bufãr_addr
 !ğ
rx_h—d
 + 22

952 || 
pkt_Ën
 & 0xC000 != 0xC000) {

953 
	`´štk
("%s: Rx frame‡t %#x corrupted, status %04x cmd %04x"

954 "Ãxˆ%04x d©a-buà@%04x %04x.\n", 
dev
->
Çme
, 
rx_h—d
,

955 
äame_¡©us
, 
rfd_cmd
, 
Ãxt_rx_äame
, 
d©a_bufãr_addr
,

956 
pkt_Ën
);

957 } ià((
äame_¡©us
 & 0x2000) == 0) {

959 
Í
->
¡©s
.
rx_”rÜs
++;

960 ià(
äame_¡©us
 & 0x0800è
Í
->
¡©s
.
rx_üc_”rÜs
++;

961 ià(
äame_¡©us
 & 0x0400è
Í
->
¡©s
.
rx_äame_”rÜs
++;

962 ià(
äame_¡©us
 & 0x0200è
Í
->
¡©s
.
rx_fifo_”rÜs
++;

963 ià(
äame_¡©us
 & 0x0100è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

964 ià(
äame_¡©us
 & 0x0080è
Í
->
¡©s
.
rx_Ëngth_”rÜs
++;

967 
sksize
;

968 
sk_buff
 *
skb
;

970 
pkt_Ën
 &= 0x3fff;

971 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

972 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

973 ià(
skb
 =ğ
NULL
) {

974 
	`´štk
("%s: MemÜy squ“ze, drİpšg…ack‘.\n", 
dev
->
Çme
);

975 
Í
->
¡©s
.
rx_drİ³d
++;

978 
skb
->
mem_Ën
 = 
sksize
;

979 
skb
->
mem_addr
 = skb;

980 
skb
->
Ën
 = 
pkt_Ën
;

981 
skb
->
dev
 = dev;

983 
	`outw
(
d©a_bufãr_addr
 + 10, 
ißddr
 + 
READ_PTR
);

985 
	`šsw
(
ißddr
, 
skb
->
d©a
, (
pkt_Ën
 + 1) >> 1);

987 #ifdeà
HAVE_NETIF_RX


988 
	`Ãtif_rx
(
skb
);

990 
skb
->
lock
 = 0;

991 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

992 
	`kä“_s
(
skb
, 
sksize
);

993 
Í
->
¡©s
.
rx_drİ³d
++;

997 
Í
->
¡©s
.
rx_·ck‘s
++;

1001 
	`outw
(
rx_h—d
, 
ißddr
 + 
WRITE_PTR
);

1002 
	`outw
(0x0000, 
ißddr
);

1003 
	`outw
(0xC000, 
ißddr
);

1004 #iâdeà
fš®_v”siÚ


1005 ià(
Ãxt_rx_äame
 !ğ
rx_h—d
 + 
RX_BUF_SIZE


1006 && 
Ãxt_rx_äame
 !ğ
RX_BUF_START
) {

1007 
	`´štk
("%s: Rx‚exˆäam© %#x i %#x in¡—d oà%#x.\n", 
dev
->
Çme
,

1008 
rx_h—d
, 
Ãxt_rx_äame
,„x_h—d + 
RX_BUF_SIZE
);

1009 
Ãxt_rx_äame
 = 
rx_h—d
 + 
RX_BUF_SIZE
;

1010 ià(
Ãxt_rx_äame
 >ğ
RX_BUF_END
 - 
RX_BUF_SIZE
)

1011 
Ãxt_rx_äame
 = 
RX_BUF_START
;

1014 
	`outw
(
rx_
+2, 
ißddr
 + 
WRITE_PTR
);

1015 
	`outw
(0x0000, 
ißddr
);

1017 #iâdeà
fš®_v”siÚ


1018 
	`outw
(
rx_
+4, 
ißddr
 + 
READ_PTR
);

1019 ià(
	`šw
(
ißddr
è!ğ
rx_h—d
) {

1020 
	`´štk
("%s: Rx buf†ink mismatch,‡t %04x†ink %04x instead of %04x.\n",

1021 
dev
->
Çme
, 
rx_
, (
	`outw
Ôx_+4, 
ißddr
 + 
READ_PTR
),
	`šw
(ioaddr)),

1022 
rx_h—d
);

1023 
	`outw
(
rx_h—d
, 
ißddr
);

1027 
rx_
 = 
rx_h—d
;

1028 
rx_h—d
 = 
Ãxt_rx_äame
;

1029 ià(--
boguscouÁ
 == 0)

1031 
	`outw
(
rx_h—d
, 
ißddr
 + 
READ_PTR
);

1034 
Í
->
rx_h—d
 =„x_head;

1035 
Í
->
rx_
 =„x_tail;

1038 
	`outw
(
§ved_wr™e_±r
, 
ißddr
 + 
WRITE_PTR
);

1039 
	}
}

	@drivers/net/hp.c

15 *
	gv”siÚ
 =

18 
	~<lšux/cÚfig.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/sched.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/iİÜt.h
>

23 
	~<asm/sy¡em.h
>

24 
	~<asm/io.h
>

26 
	~"dev.h
"

27 
	~"8390.h
"

29 #iâdeà
HAVE_PORTRESERVE


30 
	#check_»giÚ
(
ißddr
, 
size
è0

	)

31 
	#¢¬f_»giÚ
(
ißddr
, 
size
); dØ; 0)

	)

34 
	#HP_IO_EXTENT
 32

	)

36 
	#HP_DATAPORT
 0x0ø

	)

37 
	#HP_ID
 0x07

	)

38 
	#HP_CONFIGURE
 0x08

	)

39 
	#HP_RUN
 0x01

	)

40 
	#HP_IRQ
 0x0E

	)

41 
	#HP_DATAON
 0x10

	)

42 
	#NIC_OFFSET
 0x10

	)

44 
	#HP_START_PG
 0x00

	)

45 
	#HP_8BSTOP_PG
 0x80

	)

46 
	#HP_16BSTOP_PG
 0xFF

	)

48 
hp_´obe
(
deviû
 *
dev
);

49 
hµrobe1
(
deviû
 *
dev
, 
ißddr
);

51 
hp_»£t_8390
(
deviû
 *
dev
);

52 
hp_block_šput
(
deviû
 *
dev
, 
couÁ
,

53 *
buf
, 
ršg_off£t
);

54 
hp_block_ouut
(
deviû
 *
dev
, 
couÁ
,

55 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
);

56 
hp_š™_ÿrd
(
deviû
 *
dev
);

60 
	gœqm­
[16] = { 0, 0, 4, 6, 8,10, 0,14, 0, 4, 2,12,0,0,0,0};

67 
	$hp_´obe
(
deviû
 *
dev
)

69 *
pÜt
, 
pÜts
[] = {0x300, 0x320, 0x340, 0x280, 0x2C0, 0x200, 0x240, 0};

70 
ißddr
 = 
dev
->
ba£_addr
;

72 ià(
ißddr
 > 0x1ff)

73  
	`hµrobe1
(
dev
, 
ißddr
);

74 ià(
ißddr
 > 0)

75  
ENXIO
;

77 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

78 ià(
	`check_»giÚ
(*
pÜt
, 
HP_IO_EXTENT
))

80 ià(
	`hµrobe1
(
dev
, *
pÜt
) == 0) {

84  
ENODEV
;

85 
	}
}

87 
	$hµrobe1
(
deviû
 *
dev
, 
ißddr
)

89 
i
, 
bßrd_id
, 
wÜdmode
;

90 *
Çme
;

91 *
¡©iÚ_addr
 = 
dev
->
dev_addr
;

96 ià(
	`šb
(
ißddr
) != 0x08

97 || 
	`šb
(
ißddr
+1) != 0x00

98 || 
	`šb
(
ißddr
+2) != 0x09

99 || 
	`šb
(
ißddr
+14) == 0x57)

100  
ENODEV
;

104 ià((
bßrd_id
 = 
	`šb
(
ißddr
 + 
HP_ID
)) & 0x80) {

105 
Çme
 = "HP27247";

106 
wÜdmode
 = 1;

108 
Çme
 = "HP27250";

109 
wÜdmode
 = 0;

113 
	`¢¬f_»giÚ
(
ißddr
, 
HP_IO_EXTENT
);

115 
	`´štk
("%s: % (ID %02xè© %#3x,", 
dev
->
Çme
,‚ame, 
bßrd_id
, 
ißddr
);

117 
i
 = 0; i < 
ETHER_ADDR_LEN
; i++)

118 
	`´štk
(" %2.2x", 
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + i));

121 ià(
dev
->
œq
 < 2) {

122 
œq_16li¡
[] = { 11, 10, 5, 3, 4, 7, 9, 0};

123 
œq_8li¡
[] = { 7, 5, 3, 4, 9, 0};

124 *
œqp
 = 
wÜdmode
 ? 
œq_16li¡
 : 
œq_8li¡
;

126 
œq
 = *
œqp
;

127 ià(
	`»que¡_œq
 (
œq
, 
NULL
è!ğ-
EBUSY
) {

128 
	`autoœq_£tup
(0);

130 
	`outb_p
(
œqm­
[
œq
] | 
HP_RUN
, 
ißddr
 + 
HP_CONFIGURE
);

131 
	`outb_p
Ğ0x00 | 
HP_RUN
, 
ißddr
 + 
HP_CONFIGURE
);

132 ià(
œq
 =ğ
	`autoœq_»pÜt
(0)

133 && 
	`»que¡_œq
 (
œq
, &
ei_š‹¼u±
) == 0) {

134 
	`´štk
(" s–eùšg IRQ %d.\n", 
œq
);

135 
dev
->
œq
 = *
œqp
;

139 } *++
œqp
);

140 ià(*
œqp
 == 0) {

141 
	`´štk
("‚o free IRQ†ines.\n");

142  
EBUSY
;

145 ià(
dev
->
œq
 == 2)

146 
dev
->
œq
 = 9;

147 ià(
	`œqaùiÚ
(
dev
->
œq
, &
ei_sigaùiÚ
)) {

148 
	`´štk
 (" uÇbËØg‘ IRQ %d.\n", 
dev
->
œq
);

149  
EBUSY
;

153 ià(
ei_debug
 > 1)

154 
	`´štk
(
v”siÚ
);

157 
dev
->
ba£_addr
 = 
ißddr
 + 
NIC_OFFSET
;

159 
	`‘hdev_š™
(
dev
);

161 
ei_¡©us
.
Çme
 =‚ame;

162 
ei_¡©us
.
wÜd16
 = 
wÜdmode
;

163 
ei_¡©us
.
tx_¡¬t_·ge
 = 
HP_START_PG
;

164 
ei_¡©us
.
rx_¡¬t_·ge
 = 
HP_START_PG
 + 
TX_PAGES
;

165 
ei_¡©us
.
¡İ_·ge
 = 
wÜdmode
 ? 
HP_16BSTOP_PG
 : 
HP_8BSTOP_PG
;

167 
ei_¡©us
.
»£t_8390
 = &
hp_»£t_8390
;

168 
ei_¡©us
.
block_šput
 = &
hp_block_šput
;

169 
ei_¡©us
.
block_ouut
 = &
hp_block_ouut
;

170 
	`hp_š™_ÿrd
(
dev
);

173 
	}
}

176 
	$hp_»£t_8390
(
deviû
 *
dev
)

178 
hp_ba£
 = 
dev
->
ba£_addr
 - 
NIC_OFFSET
;

179 
§ved_cÚfig
 = 
	`šb_p
(
hp_ba£
 + 
HP_CONFIGURE
);

181 ià(
ei_debug
 > 1è
	`´štk
("»£‰šgh8390ime=%ld...", 
jiff›s
);

182 
	`outb_p
(0x00, 
hp_ba£
 + 
HP_CONFIGURE
);

183 
ei_¡©us
.
txšg
 = 0;

185 
SLOW_DOWN_IO
;

186 
SLOW_DOWN_IO
;

188 
	`outb_p
(
§ved_cÚfig
, 
hp_ba£
 + 
HP_CONFIGURE
);

189 
SLOW_DOWN_IO
; SLOW_DOWN_IO;

191 ià((
	`šb_p
(
hp_ba£
+
NIC_OFFSET
+
EN0_ISR
è& 
ENISR_RESET
) == 0)

192 
	`´štk
("%s: hp_»£t_8390(èdid‚Ù com¶‘e.\n", 
dev
->
Çme
);

194 ià(
ei_debug
 > 1è
	`´štk
("8390„e£ˆdÚ(%ld).", 
jiff›s
);

196 
	}
}

204 
	$hp_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
, 
ršg_off£t
)

206 
nic_ba£
 = 
dev
->
ba£_addr
;

207 
§ved_cÚfig
 = 
	`šb_p
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

208 
xãr_couÁ
 = 
couÁ
;

210 
	`outb_p
(
§ved_cÚfig
 | 
HP_DATAON
, 
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

211 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_START
, 
nic_ba£
);

212 
	`outb_p
(
couÁ
 & 0xff, 
nic_ba£
 + 
EN0_RCNTLO
);

213 
	`outb_p
(
couÁ
 >> 8, 
nic_ba£
 + 
EN0_RCNTHI
);

214 
	`outb_p
(
ršg_off£t
 & 0xff, 
nic_ba£
 + 
EN0_RSARLO
);

215 
	`outb_p
(
ršg_off£t
 >> 8, 
nic_ba£
 + 
EN0_RSARHI
);

216 
	`outb_p
(
E8390_RREAD
+
E8390_START
, 
nic_ba£
);

217 ià(
ei_¡©us
.
wÜd16
) {

218 
	`šsw
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_DATAPORT
,
buf
,
couÁ
>>1);

219 ià(
couÁ
 & 0x01)

220 
buf
[
couÁ
-1] = 
	`šb
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_DATAPORT
), 
xãr_couÁ
++;

222 
	`šsb
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_DATAPORT
, 
buf
, 
couÁ
);

225 ià(
ei_debug
 > 0) {

226 
high
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARHI
);

227 
low
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARLO
);

228 
addr
 = (
high
 << 8è+ 
low
;

230 ià(((
ršg_off£t
 + 
xãr_couÁ
è& 0xffè!ğ(
addr
 & 0xff))

231 
	`´štk
("%s: RXransfer‡ddress mismatch, %#4.4x vs. %#4.4x (actual).\n",

232 
dev
->
Çme
, 
ršg_off£t
 + 
xãr_couÁ
, 
addr
);

234 
	`outb_p
(
§ved_cÚfig
 & (~
HP_DATAON
), 
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

235  
ršg_off£t
 + 
couÁ
;

236 
	}
}

239 
	$hp_block_ouut
(
deviû
 *
dev
, 
couÁ
,

240 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
)

242 
nic_ba£
 = 
dev
->
ba£_addr
;

243 
§ved_cÚfig
 = 
	`šb_p
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

245 
	`outb_p
(
§ved_cÚfig
 | 
HP_DATAON
, 
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

249 ià(
ei_¡©us
.
wÜd16
 && (
couÁ
 & 0x01))

250 
couÁ
++;

252 
	`outb_p
(
E8390_PAGE0
+
E8390_START
+
E8390_NODMA
, 
nic_ba£
);

254 #ifdeà
ei8390_bug


257 
	`outb_p
(0x42, 
nic_ba£
 + 
EN0_RCNTLO
);

258 
	`outb_p
(0, 
nic_ba£
 + 
EN0_RCNTHI
);

259 
	`outb_p
(0xff, 
nic_ba£
 + 
EN0_RSARLO
);

260 
	`outb_p
(0x00, 
nic_ba£
 + 
EN0_RSARHI
);

261 
	`outb_p
(
E8390_RREAD
+
E8390_START
, 
EN_CMD
);

263 
	`šb_p
(0x61);

264 
	`šb_p
(0x61);

267 
	`outb_p
(
couÁ
 & 0xff, 
nic_ba£
 + 
EN0_RCNTLO
);

268 
	`outb_p
(
couÁ
 >> 8, 
nic_ba£
 + 
EN0_RCNTHI
);

269 
	`outb_p
(0x00, 
nic_ba£
 + 
EN0_RSARLO
);

270 
	`outb_p
(
¡¬t_·ge
, 
nic_ba£
 + 
EN0_RSARHI
);

272 
	`outb_p
(
E8390_RWRITE
+
E8390_START
, 
nic_ba£
);

273 ià(
ei_¡©us
.
wÜd16
) {

275 
	`outsw
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_DATAPORT
, 
buf
, 
couÁ
>>1);

277 
	`outsb
(
nic_ba£
 - 
NIC_OFFSET
 + 
HP_DATAPORT
, 
buf
, 
couÁ
);

283 ià(
ei_debug
 > 0) {

284 
high
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARHI
);

285 
low
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARLO
);

286 
addr
 = (
high
 << 8è+ 
low
;

287 ià((
¡¬t_·ge
 << 8è+ 
couÁ
 !ğ
addr
)

288 
	`´štk
("%s: TX Transfer‡ddress mismatch, %#4.4x vs. %#4.4x.\n",

289 
dev
->
Çme
, (
¡¬t_·ge
 << 8è+ 
couÁ
, 
addr
);

291 
	`outb_p
(
§ved_cÚfig
 & (~
HP_DATAON
), 
nic_ba£
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

293 
	}
}

297 
	$hp_š™_ÿrd
(
deviû
 *
dev
)

299 
œq
 = 
dev
->irq;

300 
	`NS8390_š™
(
dev
, 0);

301 
	`outb_p
(
œqm­
[
œq
&0x0f] | 
HP_RUN
,

302 
dev
->
ba£_addr
 - 
NIC_OFFSET
 + 
HP_CONFIGURE
);

304 
	}
}

	@drivers/net/iow.h

1 #iâdeà
_ASM_IOW_H


2 
	#_ASM_IOW_H


	)

	@drivers/net/lance.c

17 *
	gv”siÚ
 = "lance.c:v0.14g 12/21/93 becker@super.org\n";

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/¡ršg.h
>

23 
	~<lšux/±¿û.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/iİÜt.h
>

26 
	~<lšux/m®loc.h
>

27 
	~<lšux/š‹¼u±.h
>

28 
	~<asm/b™İs.h
>

29 
	~<asm/io.h
>

30 
	~<asm/dma.h
>

32 
	~"dev.h
"

33 
	~"‘h.h
"

34 
	~"skbuff.h
"

35 
	~"¬p.h
"

37 #iâdeà
HAVE_PORTRESERVE


38 
	#check_»giÚ
(
addr
, 
size
è0

	)

39 
	#¢¬f_»giÚ
(
addr
, 
size
èdØ; 0)

	)

42 #iâdeà
HAVE_ALLOC_SKB


43 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

44 
	#kä“_skbmem
(
buff
, 
size
è
	`kä“_s
(buff,size)

	)

47 
deviû
 *
š™_‘h”dev
(deviû *
dev
, 
sizeof_´iv©e
,

48 *
mem_¡¬
);

50 #ifdeà
LANCE_DEBUG


51 
	gÏnû_debug
 = 
LANCE_DEBUG
;

53 
	gÏnû_debug
 = 1;

56 #iâdeà
LANCE_DMA


57 
	#LANCE_DMA
 5

	)

146 #iâdeà
LANCE_LOG_TX_BUFFERS


147 
	#LANCE_LOG_TX_BUFFERS
 4

	)

148 
	#LANCE_LOG_RX_BUFFERS
 4

	)

151 
	#TX_RING_SIZE
 (1 << (
LANCE_LOG_TX_BUFFERS
))

	)

152 
	#TX_RING_MOD_MASK
 (
TX_RING_SIZE
 - 1)

	)

153 
	#TX_RING_LEN_BITS
 ((
LANCE_LOG_TX_BUFFERS
è<< 29)

	)

155 
	#RX_RING_SIZE
 (1 << (
LANCE_LOG_RX_BUFFERS
))

	)

156 
	#RX_RING_MOD_MASK
 (
RX_RING_SIZE
 - 1)

	)

157 
	#RX_RING_LEN_BITS
 ((
LANCE_LOG_RX_BUFFERS
è<< 29)

	)

159 
	#PKT_BUF_SZ
 1544

	)

162 
	#LANCE_DATA
 0x10

	)

163 
	#LANCE_ADDR
 0x12

	)

164 
	#LANCE_RESET
 0x14

	)

165 
	#LANCE_BUS_IF
 0x16

	)

166 
	#LANCE_TOTAL_SIZE
 0x18

	)

169 
	sÏnû_rx_h—d
 {

170 
	mba£
;

171 
	mbuf_Ëngth
;

172 
	mmsg_Ëngth
;

175 
	sÏnû_tx_h—d
 {

176 
	mba£
;

177 
	mËngth
;

178 
	mmisc
;

182 
	sÏnû_š™_block
 {

183 
	mmode
;

184 
	mphys_addr
[6];

185 
	mf‹r
[2];

187 
	mrx_ršg
;

188 
	mtx_ršg
;

191 
	sÏnû_´iv©e
 {

192 
	mdevÇme
[8];

194 
Ïnû_rx_h—d
 
	mrx_ršg
[
RX_RING_SIZE
];

195 
Ïnû_tx_h—d
 
	mtx_ršg
[
TX_RING_SIZE
];

196 
Ïnû_š™_block
 
	mš™_block
;

197 
	mrx_buffs
;

199 (*
	mtx_bounû_buffs
)[
PKT_BUF_SZ
];

200 
	mcur_rx
, 
	mcur_tx
;

201 
	mdœty_rx
, 
	mdœty_tx
;

202 
	mdma
;

203 
’‘_¡©i¡ics
 
	m¡©s
;

204 
	mŞd_Ïnû
;

205 
	m·d0
, 
	m·d1
;

208 
Ïnû_´obe1
(
ißddr
, 
mem_¡¬t
);

209 
Ïnû_İ’
(
deviû
 *
dev
);

210 
Ïnû_š™_ršg
(
deviû
 *
dev
);

211 
Ïnû_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

212 
Ïnû_rx
(
deviû
 *
dev
);

213 
Ïnû_š‹¼u±
(
»g_±r
);

214 
Ïnû_şo£
(
deviû
 *
dev
);

215 
’‘_¡©i¡ics
 *
Ïnû_g‘_¡©s
(
deviû
 *
dev
);

216 #ifdeà
HAVE_MULTICAST


217 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

222 
	$Ïnû_š™
(
mem_¡¬t
, 
mem_’d
)

224 *
pÜt
, 
pÜts
[] = {0x300, 0x320, 0x340, 0x360, 0};

226 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

227 
ißddr
 = *
pÜt
;

229 iàĞ
	`check_»giÚ
(
ißddr
, 
LANCE_TOTAL_SIZE
) == 0

230 && 
	`šb
(
ißddr
 + 14) == 0x57

231 && 
	`šb
(
ißddr
 + 15) == 0x57) {

232 
mem_¡¬t
 = 
	`Ïnû_´obe1
(
ißddr
, mem_start);

236  
mem_¡¬t
;

237 
	}
}

239 
	$Ïnû_´obe1
(
ißddr
, 
mem_¡¬t
)

241 
deviû
 *
dev
;

242 
Ïnû_´iv©e
 *
Í
;

243 
hpJ2405A
 = 0;

244 
i
, 
»£t_v®
;

246 
hpJ2405A
 = (
	`šb
(
ißddr
) == 0x08 && inb(ioaddr+1) == 0x00

247 && 
	`šb
(
ißddr
+2) == 0x09);

250 
»£t_v®
 = 
	`šw
(
ißddr
+
LANCE_RESET
);

254 ià(!
hpJ2405A
)

255 
	`outw
(
»£t_v®
, 
ißddr
+
LANCE_RESET
);

257 
	`outw
(0x0000, 
ißddr
+
LANCE_ADDR
);

258 ià(
	`šw
(
ißddr
+
LANCE_DATA
) != 0x0004)

259  
mem_¡¬t
;

261 
dev
 = 
	`š™_‘h”dev
(0, (
Ïnû_´iv©e
)

262 + 
PKT_BUF_SZ
*(
RX_RING_SIZE
 + 
TX_RING_SIZE
),

263 &
mem_¡¬t
);

265 
	`´štk
("%s: LANCE‡ˆ%#3x,", 
dev
->
Çme
, 
ißddr
);

269 
i
 = 0; i < 6; i++)

270 
	`´štk
(" %2.2x", 
dev
->
dev_addr
[
i
] = 
	`šb
(
ißddr
 + i));

272 
dev
->
ba£_addr
 = 
ißddr
;

273 
	`¢¬f_»giÚ
(
ißddr
, 
LANCE_TOTAL_SIZE
);

276 
dev
->
´iv
 = (*)((()dev->priv + 7) & ~7);

277 
Í
 = (
Ïnû_´iv©e
 *)
dev
->
´iv
;

278 
Í
->
rx_buffs
 = ()
dev
->
´iv
 + (
Ïnû_´iv©e
);

279 
Í
->
tx_bounû_buffs
 = ((*)[
PKT_BUF_SZ
])

280 (
Í
->
rx_buffs
 + 
PKT_BUF_SZ
*
RX_RING_SIZE
);

282 #iâdeà
fš®_v”siÚ


284 ià(()(
Í
->
rx_ršg
) & 0x07) {

285 
	`´štk
(" **ERROR** LANCE Rx‡nd Tx„ings‚ot onƒven boundary.\n");

286  
mem_¡¬t
;

290 
	`outw
(88, 
ißddr
+
LANCE_ADDR
);

291 
Í
->
Şd_Ïnû
 = (
	`šw
(
ißddr
+
LANCE_DATA
) != 0x3003);

293 #ià
	`defšed
(
nÙdef
)

294 
	`´štk
(
Í
->
Şd_Ïnû
 ? " original LANCE (%04x)" : " PCnet-ISA LANCE (%04x)",

295 
	`šw
(
ißddr
+
LANCE_DATA
));

298 
Í
->
š™_block
.
mode
 = 0x0003;

299 
i
 = 0; i < 6; i++)

300 
Í
->
š™_block
.
phys_addr
[
i
] = 
dev
->
dev_addr
[i];

301 
Í
->
š™_block
.
f‹r
[0] = 0x00000000;

302 
Í
->
š™_block
.
f‹r
[1] = 0x00000000;

303 
Í
->
š™_block
.
rx_ršg
 = (îp->rx_ršg | 
RX_RING_LEN_BITS
;

304 
Í
->
š™_block
.
tx_ršg
 = (îp->tx_ršg | 
TX_RING_LEN_BITS
;

306 
	`outw
(0x0001, 
ißddr
+
LANCE_ADDR
);

307 
	`outw
((è(è&
Í
->
š™_block
, 
ißddr
+
LANCE_DATA
);

308 
	`outw
(0x0002, 
ißddr
+
LANCE_ADDR
);

309 
	`outw
((()&
Í
->
š™_block
è>> 16, 
ißddr
+
LANCE_DATA
);

310 
	`outw
(0x0000, 
ißddr
+
LANCE_ADDR
);

312 ià(
hpJ2405A
) {

313 
dma_tbl
[4] = {3, 5, 6, 7};

314 
œq_tbl
[8] = {3, 4, 5, 9, 10, 11, 12, 15};

315 
»£t_v®
 = 
	`šw
(
ißddr
+
LANCE_RESET
);

316 
dev
->
dma
 = 
dma_tbl
[(
»£t_v®
 >> 2) & 3];

317 
dev
->
œq
 = 
œq_tbl
[(
»£t_v®
 >> 4) & 7];

318 
	`´štk
(" HP J2405A IRQ %d DMA %d.\n", 
dev
->
œq
, dev->
dma
);

321 ià(
dev
->
mem_¡¬t
 & 0x07)

322 
dev
->
dma
 = dev->
mem_¡¬t
 & 0x07;

323 ià(
dev
->
dma
 == 0)

324 
dev
->
dma
 = 
LANCE_DMA
;

328 ià(
dev
->
œq
 < 2) {

330 
	`autoœq_£tup
(0);

333 
	`outw
(0x0041, 
ißddr
+
LANCE_DATA
);

335 
dev
->
œq
 = 
	`autoœq_»pÜt
(1);

336 ià(
dev
->
œq
)

337 
	`´štk
(",…robed IRQ %d, fixed‡t DMA %d.\n",

338 
dev
->
œq
, dev->
dma
);

340 
	`´štk
(", failedo detect IRQ†ine.\n");

341  
mem_¡¬t
;

344 
	`´štk
("‡ssigÃd IRQ %d DMA %d.\n", 
dev
->
œq
, dev->
dma
);

347 ià(! 
Í
->
Şd_Ïnû
) {

350 
	`outw
(0x0002, 
ißddr
+
LANCE_ADDR
);

351 
	`outw
(0x0002, 
ißddr
+
LANCE_BUS_IF
);

354 ià(
Ïnû_debug
 > 0)

355 
	`´štk
(
v”siÚ
);

358 
dev
->
İ’
 = &
Ïnû_İ’
;

359 
dev
->
h¬d_¡¬t_xm™
 = &
Ïnû_¡¬t_xm™
;

360 
dev
->
¡İ
 = &
Ïnû_şo£
;

361 
dev
->
g‘_¡©s
 = &
Ïnû_g‘_¡©s
;

362 #ifdeà
HAVE_MULTICAST


363 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

366  
mem_¡¬t
;

367 
	}
}

371 
	$Ïnû_İ’
(
deviû
 *
dev
)

373 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

374 
ißddr
 = 
dev
->
ba£_addr
;

375 
i
;

377 ià(
	`»que¡_œq
(
dev
->
œq
, &
Ïnû_š‹¼u±
)) {

378  -
EAGAIN
;

381 ià(
	`»que¡_dma
(
dev
->
dma
)) {

382 
	`ä“_œq
(
dev
->
œq
);

383  -
EAGAIN
;

385 
œq2dev_m­
[
dev
->
œq
] = dev;

388 
	`šw
(
ißddr
+
LANCE_RESET
);

391 
	`’abË_dma
(
dev
->
dma
);

392 
	`£t_dma_mode
(
dev
->
dma
, 
DMA_MODE_CASCADE
);

395 ià(
Í
->
Şd_Ïnû
)

396 
	`outw
(0, 
ißddr
+
LANCE_RESET
);

398 ià(! 
Í
->
Şd_Ïnû
) {

400 
	`outw
(0x0002, 
ißddr
+
LANCE_ADDR
);

401 
	`outw
(0x0002, 
ißddr
+
LANCE_BUS_IF
);

404 ià(
Ïnû_debug
 > 1)

405 
	`´štk
("%s:†ance_open() irq %d dma %dx/rx„ings %#x/%#x init %#x.\n",

406 
dev
->
Çme
, dev->
œq
, dev->
dma
, (è
Í
->
tx_ršg
, (èÍ->
rx_ršg
,

407 (è&
Í
->
š™_block
);

409 
	`Ïnû_š™_ršg
(
dev
);

411 
	`outw
(0x0001, 
ißddr
+
LANCE_ADDR
);

412 
	`outw
((è(è&
Í
->
š™_block
, 
ißddr
+
LANCE_DATA
);

413 
	`outw
(0x0002, 
ißddr
+
LANCE_ADDR
);

414 
	`outw
((()&
Í
->
š™_block
è>> 16, 
ißddr
+
LANCE_DATA
);

416 
	`outw
(0x0004, 
ißddr
+
LANCE_ADDR
);

417 
	`outw
(0x0d15, 
ißddr
+
LANCE_DATA
);

419 
	`outw
(0x0000, 
ißddr
+
LANCE_ADDR
);

420 
	`outw
(0x0001, 
ißddr
+
LANCE_DATA
);

422 
dev
->
tbusy
 = 0;

423 
dev
->
š‹¼u±
 = 0;

424 
dev
->
¡¬t
 = 1;

425 
i
 = 0;

426 
i
++ < 100)

427 ià(
	`šw
(
ißddr
+
LANCE_DATA
) & 0x0100)

429 
	`outw
(0x0142, 
ißddr
+
LANCE_DATA
);

431 ià(
Ïnû_debug
 > 2)

432 
	`´štk
("%s: LANCE open‡fter %dicks, init block %#x csr0 %4.4x.\n",

433 
dev
->
Çme
, 
i
, (è&
Í
->
š™_block
, 
	`šw
(
ißddr
+
LANCE_DATA
));

436 
	}
}

440 
	$Ïnû_š™_ršg
(
deviû
 *
dev
)

442 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

443 
i
;

445 
Í
->
cur_rx
 =†p->
cur_tx
 = 0;

446 
Í
->
dœty_rx
 =†p->
dœty_tx
 = 0;

448 
i
 = 0; i < 
RX_RING_SIZE
; i++) {

449 
Í
->
rx_ršg
[
i
].
ba£
 = (Í->
rx_buffs
 + i*
PKT_BUF_SZ
) | 0x80000000;

450 
Í
->
rx_ršg
[
i
].
buf_Ëngth
 = -
PKT_BUF_SZ
;

454 
i
 = 0; i < 
TX_RING_SIZE
; i++) {

455 
Í
->
tx_ršg
[
i
].
ba£
 = 0;

458 
Í
->
š™_block
.
mode
 = 0x0000;

459 
i
 = 0; i < 6; i++)

460 
Í
->
š™_block
.
phys_addr
[
i
] = 
dev
->
dev_addr
[i];

461 
Í
->
š™_block
.
f‹r
[0] = 0x00000000;

462 
Í
->
š™_block
.
f‹r
[1] = 0x00000000;

463 
Í
->
š™_block
.
rx_ršg
 = (îp->rx_ršg | 
RX_RING_LEN_BITS
;

464 
Í
->
š™_block
.
tx_ršg
 = (îp->tx_ršg | 
TX_RING_LEN_BITS
;

465 
	}
}

468 
	$Ïnû_¡¬t_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

470 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

471 
ißddr
 = 
dev
->
ba£_addr
;

472 
’Œy
;

475 ià(
dev
->
tbusy
) {

476 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

477 ià(
tickssoçr
 < 10)

479 
	`outw
(0, 
ißddr
+
LANCE_ADDR
);

480 
	`´štk
("%s:ransmitimed out, status %4.4x,„esetting.\n",

481 
dev
->
Çme
, 
	`šw
(
ißddr
+
LANCE_DATA
));

482 
	`outw
(0x0001, 
ißddr
+
LANCE_DATA
);

483 
Í
->
¡©s
.
tx_”rÜs
++;

484 #iâdeà
fš®_v”siÚ


486 
i
;

487 
	`´štk
(" Ring data dump: dirty_tx %d cur_tx %d cur_rx %d.",

488 
Í
->
dœty_tx
,†p->
cur_tx
,†p->
cur_rx
);

489 
i
 = 0 ; i < 
RX_RING_SIZE
; i++)

490 
	`´štk
("% %08x %04x %04x", 
i
 & 0x3 ? "" : "\n ",

491 
Í
->
rx_ršg
[
i
].
ba£
, -Í->rx_ršg[i].
buf_Ëngth
,

492 
Í
->
rx_ršg
[
i
].
msg_Ëngth
);

493 
i
 = 0 ; i < 
TX_RING_SIZE
; i++)

494 
	`´štk
(" %s%08x %04x %04x", 
i
 & 0x3 ? "" : "\n ",

495 
Í
->
tx_ršg
[
i
].
ba£
, -Í->tx_ršg[i].
Ëngth
,

496 
Í
->
tx_ršg
[
i
].
misc
);

497 
	`´štk
("\n");

500 
	`Ïnû_š™_ršg
(
dev
);

501 
	`outw
(0x0043, 
ißddr
+
LANCE_DATA
);

503 
dev
->
tbusy
=0;

504 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

509 ià(
skb
 =ğ
NULL
) {

510 
	`dev_tšt
(
dev
);

515 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

516 
skb
->
dev
 = dev;

517 
	`¬p_queue
 (
skb
);

520 
skb
->
¬p
=1;

522 ià(
skb
->
Ën
 <= 0)

525 ià(
Ïnû_debug
 > 3) {

526 
	`outw
(0x0000, 
ißddr
+
LANCE_ADDR
);

527 
	`´štk
("%s:†ªû_¡¬t_xm™(èÿÎed, c¤0 %4.4x.\n", 
dev
->
Çme
,

528 
	`šw
(
ißddr
+
LANCE_DATA
));

529 
	`outw
(0x0000, 
ißddr
+
LANCE_DATA
);

534 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

535 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

540 
’Œy
 = 
Í
->
cur_tx
 & 
TX_RING_MOD_MASK
;

546 ià(
Í
->
Şd_Ïnû
) {

547 
Í
->
tx_ršg
[
’Œy
].
Ëngth
 =

548 -(
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN);

550 
Í
->
tx_ršg
[
’Œy
].
Ëngth
 = -
skb
->
Ën
;

552 
Í
->
tx_ršg
[
’Œy
].
misc
 = 0x0000;

556 ià(()(
skb
->
d©a
è+ skb->
Ën
 > 0x01000000) {

557 ià(
Ïnû_debug
 > 5)

558 
	`´štk
("%s: bouncing‡ high-memory…acket (%#x).\n",

559 
dev
->
Çme
, ()(
skb
->
d©a
));

560 
	`memıy
(&
Í
->
tx_bounû_buffs
[
’Œy
], 
skb
->
d©a
, skb->
Ën
);

561 
Í
->
tx_ršg
[
’Œy
].
ba£
 =

562 ()(
Í
->
tx_bounû_buffs
 + 
’Œy
) | 0x83000000;

563 ià(
skb
->
ä“
)

564 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

568 if(
skb
->
ä“
==0)

569 
	`skb_k•t_by_deviû
(
skb
);

570 
Í
->
tx_ršg
[
’Œy
].
ba£
 = ()(
skb
->
d©a
) | 0x83000000;

572 
Í
->
cur_tx
++;

575 
	`outw
(0x0000, 
ißddr
+
LANCE_ADDR
);

576 
	`outw
(0x0048, 
ißddr
+
LANCE_DATA
);

578 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

580 ià(
Í
->
tx_ršg
[(
’Œy
+1è& 
TX_RING_MOD_MASK
].
ba£
 == 0)

581 
dev
->
tbusy
=0;

584 
	}
}

588 
	$Ïnû_š‹¼u±
(
»g_±r
)

590 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

591 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

592 
Ïnû_´iv©e
 *
Í
;

593 
c¤0
, 
ißddr
;

595 ià(
dev
 =ğ
NULL
) {

596 
	`´štk
 ("Ïnû_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

600 
ißddr
 = 
dev
->
ba£_addr
;

601 
Í
 = (
Ïnû_´iv©e
 *)
dev
->
´iv
;

602 ià(
dev
->
š‹¼u±
)

603 
	`´štk
("%s: Re-’‹ršghš‹¼u± hªdËr.\n", 
dev
->
Çme
);

605 
dev
->
š‹¼u±
 = 1;

607 
	`outw
(0x00, 
dev
->
ba£_addr
 + 
LANCE_ADDR
);

608 
c¤0
 = 
	`šw
(
dev
->
ba£_addr
 + 
LANCE_DATA
);

611 
	`outw
(
c¤0
 & ~0x004f, 
dev
->
ba£_addr
 + 
LANCE_DATA
);

613 ià(
Ïnû_debug
 > 5)

614 
	`´štk
("%s: interrupt csr0=%#2.2x‚ew csr=%#2.2x.\n",

615 
dev
->
Çme
, 
c¤0
, 
	`šw
(dev->
ba£_addr
 + 
LANCE_DATA
));

617 ià(
c¤0
 & 0x0400)

618 
	`Ïnû_rx
(
dev
);

620 ià(
c¤0
 & 0x0200) {

621 
dœty_tx
 = 
Í
->dirty_tx;

623 
dœty_tx
 < 
Í
->
cur_tx
) {

624 
’Œy
 = 
dœty_tx
 & 
TX_RING_MOD_MASK
;

625 
¡©us
 = 
Í
->
tx_ršg
[
’Œy
].
ba£
;

626 *
d©abuff
;

628 ià(
¡©us
 < 0)

631 
Í
->
tx_ršg
[
’Œy
].
ba£
 = 0;

632 
d©abuff
 = (*)(
¡©us
 & 0x00ffffff);

634 ià(
¡©us
 & 0x40000000) {

635 
”r_¡©us
 = 
Í
->
tx_ršg
[
’Œy
].
misc
;

636 
Í
->
¡©s
.
tx_”rÜs
++;

637 ià(
”r_¡©us
 & 0x0400è
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

638 ià(
”r_¡©us
 & 0x0800è
Í
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

639 ià(
”r_¡©us
 & 0x1000è
Í
->
¡©s
.
tx_wšdow_”rÜs
++;

640 ià(
”r_¡©us
 & 0x4000è
Í
->
¡©s
.
tx_fifo_”rÜs
++;

643 ià(
¡©us
 & 0x18000000)

644 
Í
->
¡©s
.
cŞlisiÚs
++;

645 
Í
->
¡©s
.
tx_·ck‘s
++;

651 ià(
d©abuff
 >ğ(*)(&
Í
->
tx_bounû_buffs
[
TX_RING_SIZE
])

652 || 
d©abuff
 < (*)(
Í
->
tx_bounû_buffs
)) {

653 
sk_buff
 *
skb
 = ((sk_bufà*)
d©abuff
) - 1;

654 ià(
skb
->
ä“
)

655 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

657 
	`skb_deviû_»Ëa£
(
skb
,
FREE_WRITE
);

661 
dœty_tx
++;

664 #iâdeà
fš®_v”siÚ


665 ià(
Í
->
cur_tx
 - 
dœty_tx
 >ğ
TX_RING_SIZE
) {

666 
	`´štk
("out-of-sync dirty…ointer, %d vs. %d.\n",

667 
dœty_tx
, 
Í
->
cur_tx
);

668 
dœty_tx
 +ğ
TX_RING_SIZE
;

672 ià(
dev
->
tbusy
 && 
dœty_tx
 > 
Í
->
cur_tx
 - 
TX_RING_SIZE
 + 2) {

674 
dev
->
tbusy
 = 0;

675 
	`m¬k_bh
(
INET_BH
);

678 
Í
->
dœty_tx
 = dirty_tx;

681 ià(
c¤0
 & 0x8000) {

682 ià(
c¤0
 & 0x4000è
Í
->
¡©s
.
tx_”rÜs
++;

683 ià(
c¤0
 & 0x1000è
Í
->
¡©s
.
rx_”rÜs
++;

687 
	`outw
(0x0000, 
dev
->
ba£_addr
 + 
LANCE_ADDR
);

688 
	`outw
(0x7f40, 
dev
->
ba£_addr
 + 
LANCE_DATA
);

690 ià(
Ïnû_debug
 > 4)

691 
	`´štk
("%s:ƒxiting interrupt, csr%d=%#4.4x.\n",

692 
dev
->
Çme
, 
	`šw
(
ißddr
 + 
LANCE_ADDR
),

693 
	`šw
(
dev
->
ba£_addr
 + 
LANCE_DATA
));

695 
dev
->
š‹¼u±
 = 0;

697 
	}
}

700 
	$Ïnû_rx
(
deviû
 *
dev
)

702 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

703 
’Œy
 = 
Í
->
cur_rx
 & 
RX_RING_MOD_MASK
;

706 
Í
->
rx_ršg
[
’Œy
].
ba£
 >= 0) {

707 
¡©us
 = 
Í
->
rx_ršg
[
’Œy
].
ba£
 >> 24;

709 ià(
¡©us
 != 0x03) {

714 ià(
¡©us
 & 0x01)

715 
Í
->
¡©s
.
rx_”rÜs
++;

716 ià(
¡©us
 & 0x20è
Í
->
¡©s
.
rx_äame_”rÜs
++;

717 ià(
¡©us
 & 0x10è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

718 ià(
¡©us
 & 0x08è
Í
->
¡©s
.
rx_üc_”rÜs
++;

719 ià(
¡©us
 & 0x04è
Í
->
¡©s
.
rx_fifo_”rÜs
++;

722 
pkt_Ën
 = 
Í
->
rx_ršg
[
’Œy
].
msg_Ëngth
;

723 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

724 
sk_buff
 *
skb
;

726 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

727 ià(
skb
 =ğ
NULL
) {

728 
	`´štk
("%s: MemÜy squ“ze, deã¼šg…ack‘.\n", 
dev
->
Çme
);

729 
Í
->
¡©s
.
rx_drİ³d
++;

732 
skb
->
mem_Ën
 = 
sksize
;

733 
skb
->
mem_addr
 = skb;

734 
skb
->
Ën
 = 
pkt_Ën
;

735 
skb
->
dev
 = dev;

736 
	`memıy
(
skb
->
d©a
,

737 (*)(
Í
->
rx_ršg
[
’Œy
].
ba£
 & 0x00ffffff),

738 
pkt_Ën
);

739 #ifdeà
HAVE_NETIF_RX


740 
	`Ãtif_rx
(
skb
);

742 
skb
->
lock
 = 0;

743 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

744 
	`kä“_skbmem
(
skb
, 
sksize
);

745 
Í
->
¡©s
.
rx_drİ³d
++;

749 
Í
->
¡©s
.
rx_·ck‘s
++;

752 
Í
->
rx_ršg
[
’Œy
].
ba£
 |= 0x80000000;

753 
’Œy
 = (++
Í
->
cur_rx
è& 
RX_RING_MOD_MASK
;

760 
	}
}

763 
	$Ïnû_şo£
(
deviû
 *
dev
)

765 
ißddr
 = 
dev
->
ba£_addr
;

766 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

768 
dev
->
¡¬t
 = 0;

769 
dev
->
tbusy
 = 1;

771 
	`outw
(112, 
ißddr
+
LANCE_ADDR
);

772 
Í
->
¡©s
.
rx_mis£d_”rÜs
 = 
	`šw
(
ißddr
+
LANCE_DATA
);

774 
	`outw
(0, 
ißddr
+
LANCE_ADDR
);

776 ià(
Ïnû_debug
 > 1)

777 
	`´štk
("%s: Shutting downƒthercard, status was %2.2x.\n",

778 
dev
->
Çme
, 
	`šw
(
ißddr
+
LANCE_DATA
));

782 
	`outw
(0x0004, 
ißddr
+
LANCE_DATA
);

784 
	`di§bË_dma
(
dev
->
dma
);

786 
	`ä“_œq
(
dev
->
œq
);

787 
	`ä“_dma
(
dev
->
dma
);

789 
œq2dev_m­
[
dev
->
œq
] = 0;

792 
	}
}

794 
’‘_¡©i¡ics
 *

795 
	$Ïnû_g‘_¡©s
(
deviû
 *
dev
)

797 
Ïnû_´iv©e
 *
Í
 = (Ïnû_´iv©*)
dev
->
´iv
;

798 
ißddr
 = 
dev
->
ba£_addr
;

799 
§ved_addr
;

801 
	`şi
();

802 
§ved_addr
 = 
	`šw
(
ißddr
+
LANCE_ADDR
);

803 
	`outw
(112, 
ißddr
+
LANCE_ADDR
);

804 
Í
->
¡©s
.
rx_mis£d_”rÜs
 = 
	`šw
(
ißddr
+
LANCE_DATA
);

805 
	`outw
(
§ved_addr
, 
ißddr
+
LANCE_ADDR
);

806 
	`¡i
();

808  &
Í
->
¡©s
;

809 
	}
}

811 #ifdeà
HAVE_MULTICAST


819 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

821 
ißddr
 = 
dev
->
ba£_addr
;

824 
	`outw
(0, 
ißddr
+
LANCE_ADDR
);

825 
	`outw
(0x0004, 
ißddr
+
LANCE_DATA
);

827 
	`outw
(15, 
ißddr
+
LANCE_ADDR
);

828 ià(
num_addrs
 >= 0) {

829 
muÉiÿ¡_bË
[4];

830 
i
;

832 
	`mem£t
(
muÉiÿ¡_bË
, (
num_addrs
 == 0) ? 0 : -1, (multicast_table));

833 
i
 = 0; i < 4; i++) {

834 
	`outw
(8 + 
i
, 
ißddr
+
LANCE_ADDR
);

835 
	`outw
(
muÉiÿ¡_bË
[
i
], 
ißddr
+
LANCE_DATA
);

837 
	`outw
(0x0000, 
ißddr
+
LANCE_DATA
);

839 
	`outw
(0x8000, 
ißddr
+
LANCE_DATA
);

842 
	`outw
(0, 
ißddr
+
LANCE_ADDR
);

843 
	`outw
(0x0142, 
ißddr
+
LANCE_DATA
);

844 
	}
}

847 #ifdeà
HAVE_DEVLIST


848 
	gÏnû_pÜi¡
[] = {0x300, 0x320, 0x340, 0x360, 0};

849 
Ãtdev_’Œy
 
	gÏnû_drv
 =

850 {"Ïnû", 
Ïnû_´obe1
, 
LANCE_TOTAL_SIZE
, 
Ïnû_pÜi¡
};

	@drivers/net/ne.c

19 *
	gv”siÚ
 =

22 
	~<lšux/cÚfig.h
>

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<asm/sy¡em.h
>

27 
	~<asm/io.h
>

29 
	~"dev.h
"

30 
	~"8390.h
"

32 
	#NE_BASE
 (
dev
->
ba£_addr
)

	)

33 
	#NE_CMD
 0x00

	)

34 
	#NE_DATAPORT
 0x10

	)

35 
	#NE_RESET
 0x1à

	)

37 
	#NE1SM_START_PG
 0x20

	)

38 
	#NE1SM_STOP_PG
 0x40

	)

39 
	#NESM_START_PG
 0x40

	)

40 
	#NESM_STOP_PG
 0x80

	)

42 
Ã_´obe
(
deviû
 *
dev
);

43 
Ã´obe1
(
ißddr
, 
deviû
 *
dev
, 
v”bo£
);

45 
Ã_»£t_8390
(
deviû
 *
dev
);

46 
Ã_block_šput
(
deviû
 *
dev
, 
couÁ
,

47 *
buf
, 
ršg_off£t
);

48 
Ã_block_ouut
(
deviû
 *
dev
, cÚ¡ 
couÁ
,

49 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
);

73 
	$Ã_´obe
(
deviû
 *
dev
)

75 *
pÜt
, 
pÜts
[] = {0x300, 0x280, 0x320, 0x340, 0x360, 0};

76 
ißddr
 = 
dev
->
ba£_addr
;

78 ià(
ißddr
 < 0)

79  
ENXIO
;

80 ià(
ißddr
 > 0x100)

81  ! 
	`Ã´obe1
(
ißddr
, 
dev
, 1);

83 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

84 #ifdeà
HAVE_PORTRESERVE


85 ià(
	`check_»giÚ
(*
pÜt
, 32))

88 ià(
	`šb_p
(*
pÜt
è!ğ0xfà&& 
	`Ã´obe1
(*pÜt, 
dev
, 0)) {

89 
dev
->
ba£_addr
 = *
pÜt
;

93 
dev
->
ba£_addr
 = 
ißddr
;

94  
ENODEV
;

95 
	}
}

97 
	$Ã´obe1
(
ißddr
, 
deviû
 *
dev
, 
v”bo£
)

99 
i
;

100 
SA_´om
[32];

101 
wÜdËngth
 = 2;

102 *
Çme
;

103 
¡¬t_·ge
, 
¡İ_·ge
;

104 
ÃX000
, 
ùrÚ
, 
dlšk
, 
dfi
;

105 
»g0
 = 
	`šb
(
ißddr
);

107 iàĞ
»g0
 == 0xFF)

111 { 
»gd
;

112 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE1
+
E8390_STOP
, 
ißddr
 + 
E8390_CMD
);

113 
»gd
 = 
	`šb_p
(
ißddr
 + 0x0d);

114 
	`outb_p
(0xff, 
ißddr
 + 0x0d);

115 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
, 
ißddr
 + 
E8390_CMD
);

116 
	`šb_p
(
ißddr
 + 
EN0_COUNTER0
);

117 ià(
	`šb_p
(
ißddr
 + 
EN0_COUNTER0
) != 0) {

118 
	`outb_p
(
»g0
, 
ißddr
);

119 
	`outb
(
»gd
, 
ißddr
 + 0x0d);

124 
	`´štk
("NE*000ƒth”ÿrd…rob© %#3x:", 
ißddr
);

132 ¡ruù {
v®ue
, 
off£t
; } 
´og¿m_£q
[] = {

133 {
E8390_NODMA
+
E8390_PAGE0
+
E8390_STOP
, 
E8390_CMD
},

134 {0x48, 
EN0_DCFG
},

135 {0x00, 
EN0_RCNTLO
},

136 {0x00, 
EN0_RCNTHI
},

137 {0x00, 
EN0_IMR
},

138 {0xFF, 
EN0_ISR
},

139 {
E8390_RXOFF
, 
EN0_RXCR
},

140 {
E8390_TXOFF
, 
EN0_TXCR
},

141 {32, 
EN0_RCNTLO
},

142 {0x00, 
EN0_RCNTHI
},

143 {0x00, 
EN0_RSARLO
},

144 {0x00, 
EN0_RSARHI
},

145 {
E8390_RREAD
+
E8390_START
, 
E8390_CMD
},

147 
i
 = 0; i < (
´og¿m_£q
)/(program_seq[0]); i++)

148 
	`outb_p
(
´og¿m_£q
[
i
].
v®ue
, 
ißddr
 +…rog¿m_£q[i].
off£t
);

150 
i
 = 0; i < 32 ; i+=2) {

151 
SA_´om
[
i
] = 
	`šb
(
ißddr
 + 
NE_DATAPORT
);

152 
SA_´om
[
i
+1] = 
	`šb
(
ißddr
 + 
NE_DATAPORT
);

153 ià(
SA_´om
[
i
] != SA_prom[i+1])

154 
wÜdËngth
 = 1;

157 ià(
wÜdËngth
 == 2) {

159 
	`outb_p
(0x49, 
ißddr
 + 
EN0_DCFG
);

163 
i
 = 0; i < 16; i++)

164 
SA_´om
[
i
] = SA_prom[i+i];

167 #ià
	`defšed
(
show_®l_SAPROM
)

169 
i
 = 0; i < (
SA_´om
); i++)

170 
	`´štk
(" %2.2x", 
SA_´om
[
i
]);

172 
i
 = 0; i < 
ETHER_ADDR_LEN
; i++) {

173 
dev
->
dev_addr
[
i
] = 
SA_´om
[i];

174 
	`´štk
(" %2.2x", 
SA_´om
[
i
]);

178 
ÃX000
 = (
SA_´om
[14] == 0x57 && SA_prom[15] == 0x57);

179 
ùrÚ
 = (
SA_´om
[0] == 0x00 && SA_prom[1] == 0x00 && SA_prom[2] == 0x1d);

180 
dlšk
 = (
SA_´om
[0] == 0x00 && SA_prom[1] == 0xDE && SA_prom[2] == 0x01);

181 
dfi
 = (
SA_´om
[0] == 'D' && SA_prom[1] == 'F' && SA_prom[2] == 'I');

184 ià(
ÃX000
 || 
dlšk
 || 
dfi
) {

185 ià(
wÜdËngth
 == 2) {

186 
Çme
 = 
dlšk
 ? "DE200" : "NE2000";

187 
¡¬t_·ge
 = 
NESM_START_PG
;

188 
¡İ_·ge
 = 
NESM_STOP_PG
;

190 
Çme
 = 
dlšk
 ? "DE100" : "NE1000";

191 
¡¬t_·ge
 = 
NE1SM_START_PG
;

192 
¡İ_·ge
 = 
NE1SM_STOP_PG
;

194 } ià(
ùrÚ
) {

195 
Çme
 = "Cabletron";

196 
¡¬t_·ge
 = 0x01;

197 
¡İ_·ge
 = (
wÜdËngth
 == 2) ? 0x40 : 0x20;

199 
	`´štk
("‚ot found.\n");

203 ià(
dev
->
œq
 < 2) {

204 
	`autoœq_£tup
(0);

205 
	`outb_p
(0x50, 
ißddr
 + 
EN0_IMR
);

206 
	`outb_p
(0x00, 
ißddr
 + 
EN0_RCNTLO
);

207 
	`outb_p
(0x00, 
ißddr
 + 
EN0_RCNTHI
);

208 
	`outb_p
(
E8390_RREAD
+
E8390_START
, 
ißddr
);

209 
	`outb_p
(0x00, 
ißddr
 + 
EN0_IMR
);

210 
dev
->
œq
 = 
	`autoœq_»pÜt
(0);

211 ià(
ei_debug
 > 2)

212 
	`´štk
("‡utoœq i %d", 
dev
->
œq
);

213 } ià(
dev
->
œq
 == 2)

216 
dev
->
œq
 = 9;

221 
œqv®
 = 
	`œqaùiÚ
 (
dev
->
œq
, &
ei_sigaùiÚ
);

222 ià(
œqv®
) {

223 
	`´štk
 (" uÇbËØg‘ IRQ %d (œqv®=%d).\n", 
dev
->
œq
, 
œqv®
);

228 
dev
->
ba£_addr
 = 
ißddr
;

230 #ifdeà
HAVE_PORTRESERVE


231 
	`¢¬f_»giÚ
(
ißddr
, 32);

234 
	`‘hdev_š™
(
dev
);

235 
	`´štk
("\n%s: %s found‡t %#x, using IRQ %d.\n",

236 
dev
->
Çme
,‚ame, 
ißddr
, dev->
œq
);

238 ià(
ei_debug
 > 0)

239 
	`´štk
(
v”siÚ
);

241 
ei_¡©us
.
Çme
 =‚ame;

242 
ei_¡©us
.
tx_¡¬t_·ge
 = 
¡¬t_·ge
;

243 
ei_¡©us
.
¡İ_·ge
 = stop_page;

244 
ei_¡©us
.
wÜd16
 = (
wÜdËngth
 == 2);

246 
ei_¡©us
.
rx_¡¬t_·ge
 = 
¡¬t_·ge
 + 
TX_PAGES
;

247 #ifdeà
PACKETBUF_MEMSIZE


249 
ei_¡©us
.
¡İ_·ge
 =ƒi_¡©us.
tx_¡¬t_·ge
 + 
PACKETBUF_MEMSIZE
;

252 
ei_¡©us
.
»£t_8390
 = &
Ã_»£t_8390
;

253 
ei_¡©us
.
block_šput
 = &
Ã_block_šput
;

254 
ei_¡©us
.
block_ouut
 = &
Ã_block_ouut
;

255 
	`NS8390_š™
(
dev
, 0);

256  
dev
->
ba£_addr
;

257 
	}
}

262 
	$Ã_»£t_8390
(
deviû
 *
dev
)

264 
tmp
 = 
	`šb_p
(
NE_BASE
 + 
NE_RESET
);

265 
»£t_¡¬t_time
 = 
jiff›s
;

267 ià(
ei_debug
 > 1è
	`´štk
("»£‰šgh8390=%ld...", 
jiff›s
);

268 
ei_¡©us
.
txšg
 = 0;

270 
	`outb_p
(
tmp
, 
NE_BASE
 + 
NE_RESET
);

272 (
	`šb_p
(
NE_BASE
+
EN0_ISR
è& 
ENISR_RESET
) == 0)

273 ià(
jiff›s
 - 
»£t_¡¬t_time
 > 2) {

274 
	`´štk
("%s:‚e_»£t_8390(èdid‚Ù com¶‘e.\n", 
dev
->
Çme
);

277 
	}
}

285 
	$Ã_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
, 
ršg_off£t
)

287 
xãr_couÁ
 = 
couÁ
;

288 
nic_ba£
 = 
dev
->
ba£_addr
;

290 ià(
ei_¡©us
.
dmašg
) {

291 ià(
ei_debug
 > 0)

292 
	`´štk
("%s: DMAing conflict in‚e_block_input."

294 
dev
->
Çme
, 
ei_¡©us
.
dmašg
,ƒi_¡©us.
œqlock
);

297 
ei_¡©us
.
dmašg
 |= 0x01;

298 
	`outb_p
(
E8390_NODMA
+
E8390_PAGE0
+
E8390_START
, 
nic_ba£
+ 
NE_CMD
);

299 
	`outb_p
(
couÁ
 & 0xff, 
nic_ba£
 + 
EN0_RCNTLO
);

300 
	`outb_p
(
couÁ
 >> 8, 
nic_ba£
 + 
EN0_RCNTHI
);

301 
	`outb_p
(
ršg_off£t
 & 0xff, 
nic_ba£
 + 
EN0_RSARLO
);

302 
	`outb_p
(
ršg_off£t
 >> 8, 
nic_ba£
 + 
EN0_RSARHI
);

303 
	`outb_p
(
E8390_RREAD
+
E8390_START
, 
nic_ba£
 + 
NE_CMD
);

304 ià(
ei_¡©us
.
wÜd16
) {

305 
	`šsw
(
NE_BASE
 + 
NE_DATAPORT
,
buf
,
couÁ
>>1);

306 ià(
couÁ
 & 0x01)

307 
buf
[
couÁ
-1] = 
	`šb
(
NE_BASE
 + 
NE_DATAPORT
), 
xãr_couÁ
++;

309 
	`šsb
(
NE_BASE
 + 
NE_DATAPORT
, 
buf
, 
couÁ
);

316 ià(
ei_debug
 > 1) {

317 
addr
, 
Œ›s
 = 20;

321 
high
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARHI
);

322 
low
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARLO
);

323 
addr
 = (
high
 << 8è+ 
low
;

324 ià(((
ršg_off£t
 + 
xãr_couÁ
è& 0xffè=ğ
low
)

326 } --
Œ›s
 > 0);

327 ià(
Œ›s
 <= 0)

328 
	`´štk
("%s: RXransfer‡ddress mismatch,"

330 
dev
->
Çme
, 
ršg_off£t
 + 
xãr_couÁ
, 
addr
);

332 
ei_¡©us
.
dmašg
 &= ~0x01;

333  
ršg_off£t
 + 
couÁ
;

334 
	}
}

337 
	$Ã_block_ouut
(
deviû
 *
dev
, 
couÁ
,

338 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
)

340 
»Œ›s
 = 0;

341 
nic_ba£
 = 
NE_BASE
;

346 ià(
ei_¡©us
.
wÜd16
 && (
couÁ
 & 0x01))

347 
couÁ
++;

348 ià(
ei_¡©us
.
dmašg
) {

349 ià(
ei_debug
 > 0)

350 
	`´štk
("%s: DMAing conflict in‚e_block_output."

352 
dev
->
Çme
, 
ei_¡©us
.
dmašg
,ƒi_¡©us.
œqlock
);

355 
ei_¡©us
.
dmašg
 |= 0x02;

357 
	`outb_p
(
E8390_PAGE0
+
E8390_START
+
E8390_NODMA
, 
nic_ba£
 + 
NE_CMD
);

359 
»Œy
:

360 #ià
	`defšed
(
rw_bugfix
)

365 
	`outb_p
(0x42, 
nic_ba£
 + 
EN0_RCNTLO
);

366 
	`outb_p
(0x00, 
nic_ba£
 + 
EN0_RCNTHI
);

367 
	`outb_p
(0x42, 
nic_ba£
 + 
EN0_RSARLO
);

368 
	`outb_p
(0x00, 
nic_ba£
 + 
EN0_RSARHI
);

369 
	`outb_p
(
E8390_RREAD
+
E8390_START
, 
nic_ba£
 + 
NE_CMD
);

371 
SLOW_DOWN_IO
;

372 
SLOW_DOWN_IO
;

373 
SLOW_DOWN_IO
;

377 
	`outb_p
(
couÁ
 & 0xff, 
nic_ba£
 + 
EN0_RCNTLO
);

378 
	`outb_p
(
couÁ
 >> 8, 
nic_ba£
 + 
EN0_RCNTHI
);

379 
	`outb_p
(0x00, 
nic_ba£
 + 
EN0_RSARLO
);

380 
	`outb_p
(
¡¬t_·ge
, 
nic_ba£
 + 
EN0_RSARHI
);

382 
	`outb_p
(
E8390_RWRITE
+
E8390_START
, 
nic_ba£
 + 
NE_CMD
);

383 ià(
ei_¡©us
.
wÜd16
) {

384 
	`outsw
(
NE_BASE
 + 
NE_DATAPORT
, 
buf
, 
couÁ
>>1);

386 
	`outsb
(
NE_BASE
 + 
NE_DATAPORT
, 
buf
, 
couÁ
);

391 ià(
ei_debug
 > 1) {

392 
addr
, 
Œ›s
 = 20;

396 
high
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARHI
);

397 
low
 = 
	`šb_p
(
nic_ba£
 + 
EN0_RSARLO
);

398 
addr
 = (
high
 << 8è+ 
low
;

399 ià((
¡¬t_·ge
 << 8è+ 
couÁ
 =ğ
addr
)

401 } --
Œ›s
 > 0);

402 ià(
Œ›s
 <= 0) {

403 
	`´štk
("%s: Tx…acketransfer‡ddress mismatch,"

405 
dev
->
Çme
, (
¡¬t_·ge
 << 8è+ 
couÁ
, 
addr
);

406 ià(
»Œ›s
++ == 0)

407 
»Œy
;

410 
ei_¡©us
.
dmašg
 &= ~0x02;

412 
	}
}

	@drivers/net/net_init.c

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/m®loc.h
>

25 
	~<lšux/if_‘h”.h
>

26 
	~<memÜy.h
>

27 
	~"dev.h
"

28 
	~"‘h.h
"

44 
	gÃxt_‘hdev_numb”
 = 0;

46 #ifdeà
NET_MAJOR_NUM


47 
fe_İ”©iÚs
 
	gÃtÿrd_fİs
 = {

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
NULL
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NULL


61 
Ïnû_š™
(
mem_¡¬t
, 
mem_’d
);

69 
	$Ãt_dev_š™
 (
mem_¡¬t
, 
mem_’d
)

72 #ifdeà
NET_MAJOR_NUM


73 ià(
	`»gi¡”_chrdev
(
NET_MAJOR_NUM
, "ÃtwÜk",&
Ãtÿrd_fİs
))

74 
	`´štk
("WARNING: Unableo get major %d forhe‚etwork devices.\n",

75 
NET_MAJOR_NUM
);

78 #ià
	`defšed
(
CONFIG_LANCE
)

79 
mem_¡¬t
 = 
	`Ïnû_š™
(mem_¡¬t, 
mem_’d
);

82  
mem_¡¬t
;

83 
	}
}

95 
deviû
 *
	$š™_‘h”dev
(
deviû
 *
dev
, 
sizeof_´iv©e
,

96 *
mem_¡¬
)

98 
i
;

99 
Ãw_deviû
 = 0;

101 ià(
dev
 =ğ
NULL
) {

102 
®loc_size
 = (
deviû
) + ("eth%d ")

103 + 
sizeof_´iv©e
;

104 ià(
mem_¡¬
 && *mem_startp ) {

105 
dev
 = (
deviû
 *)*
mem_¡¬
;

106 *
mem_¡¬
 +ğ
®loc_size
;

108 
dev
 = (
deviû
 *)
	`km®loc
(
®loc_size
, 
GFP_KERNEL
);

109 
	`mem£t
(
dev
, 0, (
®loc_size
));

110 
dev
->
Çme
 = (*)(dev + 1);

111 ià(
sizeof_´iv©e
)

112 
dev
->
´iv
 = dev->
Çme
 + ("eth%d ");

113 
Ãw_deviû
 = 1;

116 ià(
dev
->
Çme
 && dev->name[0] == '\0')

117 
	`¥rštf
(
dev
->
Çme
, "‘h%d", 
Ãxt_‘hdev_numb”
++);

119 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

120 
dev
->
buffs
[
i
] = 
NULL
;

122 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

123 
dev
->
add_¬p
 = 
‘h_add_¬p
;

124 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

125 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

126 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

128 
dev
->
ty³
 = 
ARPHRD_ETHER
;

129 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

130 
dev
->
mtu
 = 1500;

131 
dev
->
addr_Ën
 = 
ETH_ALEN
;

132 
i
 = 0; i < 
ETH_ALEN
; i++) {

133 
dev
->
brßdÿ¡
[
i
]=0xff;

137 
dev
->
æags
 = 
IFF_BROADCAST
;

138 
dev
->
çmy
 = 
AF_INET
;

139 
dev
->
·_addr
 = 0;

140 
dev
->
·_brdaddr
 = 0;

141 
dev
->
·_mask
 = 0;

142 
dev
->
·_®’
 = ();

144 ià(
Ãw_deviû
) {

146 
deviû
 **
Şd_devp
 = &
dev_ba£
;

147 (*
Şd_devp
)->
Ãxt
)

148 
Şd_devp
 = & (*Şd_devp)->
Ãxt
;

149 (*
Şd_devp
)->
Ãxt
 = 
dev
;

150 
dev
->
Ãxt
 = 0;

152  
dev
;

153 
	}
}

	@drivers/net/plip.c

41 *
	gv”siÚ
 =

44 
	~<lšux/cÚfig.h
>

77 
	~<lšux/k”Ãl.h
>

78 
	~<lšux/sched.h
>

79 
	~<lšux/ty³s.h
>

80 
	~<lšux/fú.h
>

81 
	~<lšux/š‹¼u±.h
>

82 
	~<lšux/¡ršg.h
>

83 
	~<lšux/±¿û.h
>

84 
	~<lšux/if_‘h”.h
>

85 
	~<asm/sy¡em.h
>

86 
	~<asm/io.h
>

87 
	~<Ãtš‘/š.h
>

88 
	~<”ºo.h
>

90 
	~"dev.h
"

91 
	~"‘h.h
"

92 
	~".h
"

93 
	~"´ÙocŞ.h
"

94 
	~"tı.h
"

95 
	~"skbuff.h
"

96 
	~"sock.h
"

97 
	~"¬p.h
"

99 #ifdeà
PRINTK


100 #undeà
PRINTK


102 #ifdeà
PRINTK2


103 #undeà
PRINTK2


106 
	#PLIP_DEBUG


	)

107 #undeà
PLIP_DEBUG2


109 #ifdeà
PLIP_DEBUG


110 
	#PRINTK
(
x
è
´štk
 
	)
x

112 
	#PRINTK
(
x
è

	)

114 #ifdeà
PLIP_DEBUG2


115 
	#PRINTK2
(
x
è
´štk
 
	)
x

117 
	#PRINTK2
(
x
è

	)

122 
deviû
 *
œq2dev_m­
[16];

125 
	#Ãt¡©s
 
’‘_¡©i¡ics


	)

128 
	#PAR_DATA
 0

	)

129 
	#PAR_STATUS
 1

	)

130 
	#PAR_CONTROL
 2

	)

131 
	#PLIP_MTU
 1600

	)

132 
	#PLIP_HEADER_TYPE1
 0xfd

	)

133 
	#PLIP_HEADER_TYPE2
 0xfc

	)

136 
¶_´obe
(
ißddr
, 
deviû
 *
dev
);

137 
¶_İ’
(
deviû
 *
dev
);

138 
¶_şo£
(
deviû
 *
dev
);

139 
¶_tx_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

140 
¶_h—d”
 (*
buff
, 
deviû
 *
dev
,

141 
ty³
, 
h_de¡
,

142 
h_sourû
, 
Ën
);

145 
	#INITIALTIMEOUTFACTOR
 4

	)

146 
	#MAXTIMEOUTFACTOR
 20

	)

147 
	gtimeoutçùÜ
 = 
INITIALTIMEOUTFACTOR
;

150 
¶_deviû_ş—r
(
deviû
 *
dev
);

151 
¶_»ûiv”_”rÜ
(
deviû
 *
dev
);

152 
¶_£t_physiÿÏddr
(
deviû
 *
dev
, 
addr
);

153 
¶_addrcmp
(
‘hhdr
 *
‘h
);

154 
¶_£nd_’‘hdr
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
);

155 
¶_»bud_’‘hdr
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
,

156 
h_de¡
, 
h_sourû
,

157 
ty³
);

158 
cŞd_¦“p
(
tics
);

159 
¶_š‹¼u±
(
»g_±r
);

160 
¶_»ûive_·ck‘
(
deviû
 *
dev
);

161 
¶_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
);

162 
¶_£nd_¡¬t
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
);

163 
doubË_timeoutçùÜ
();

164 
’‘_¡©i¡ics
 *
¶_g‘_¡©s
(
deviû
 *
dev
);

167 
	$¶_š™
(
deviû
 *
dev
)

169 
pÜt_ba£
 = 
dev
->
ba£_addr
;

170 
i
;

173 
	`outb
(0x00, 
pÜt_ba£
 + 
PAR_CONTROL
);

174 
	`outb
(0x55, 
pÜt_ba£
 + 
PAR_DATA
);

175 ià(
	`šb
(
pÜt_ba£
 + 
PAR_DATA
) != 0x55)

176  -
ENODEV
;

179 #ifdeà
PLIP_DEBUG


181 
v”siÚ_shown
 = 0;

182 ià(! 
v”siÚ_shown
)

183 
	`´štk
(
v”siÚ
), 
v”siÚ_shown
++;

188 
dev
->
´iv
 = 
	`km®loc
((
Ãt¡©s
), 
GFP_KERNEL
);

189 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt¡©s
));

191 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

192 
dev
->
buffs
[
i
] = 
NULL
;

193 
dev
->
h¬d_h—d”
 = &
¶_h—d”
;

194 
dev
->
add_¬p
 = 
‘h_add_¬p
;

195 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

196 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

197 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

199 
dev
->
İ’
 = &
¶_İ’
;

200 
dev
->
¡İ
 = &
¶_şo£
;

201 
dev
->
h¬d_¡¬t_xm™
 = &
¶_tx_·ck‘
;

202 
dev
->
g‘_¡©s
 = &
¶_g‘_¡©s
;

205 
dev
->
ty³
 = 
ARPHRD_ETHER
;

206 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

207 
dev
->
mtu
 = 
PLIP_MTU
;

208 
dev
->
addr_Ën
 = 
ETH_ALEN
;

209 
i
 = 0; i < 
dev
->
addr_Ën
; i++) {

210 
dev
->
brßdÿ¡
[
i
]=0xff;

211 
dev
->
dev_addr
[
i
] = 0;

213 
	`´štk
("%s: configured for…arallel…ort‡t %#3x, IRQ %d.\n",

214 
dev
->
Çme
, dev->
ba£_addr
, dev->
œq
);

217 
timeoutçùÜ
 = 
INITIALTIMEOUTFACTOR
;

219 
	}
}

229 
	$¶_İ’
(
deviû
 *
dev
)

231 ià(
dev
->
œq
 == 0)

232 
dev
->
œq
 = 7;

233 
	`şi
();

234 ià(
	`»que¡_œq
(
dev
->
œq
 , &
¶_š‹¼u±
) != 0) {

235 
	`¡i
();

236 
	`PRINTK
(("%s: couldn'ˆg‘ IRQ %d.\n", 
dev
->
Çme
, dev->
œq
));

237  -
EAGAIN
;

240 
œq2dev_m­
[
dev
->
œq
] = dev;

241 
	`¡i
();

242 
	`¶_deviû_ş—r
(
dev
);

243 
dev
->
tbusy
 = 0;

244 
dev
->
š‹¼u±
 = 0;

245 
dev
->
¡¬t
 = 1;

247 
	}
}

251 
	$¶_şo£
(
deviû
 *
dev
)

253 
dev
->
tbusy
 = 1;

254 
dev
->
¡¬t
 = 0;

255 
	`şi
();

256 
	`ä“_œq
(
dev
->
œq
);

257 
œq2dev_m­
[
dev
->
œq
] = 
NULL
;

258 
	`¡i
();

259 
	`outb
(0x00, 
dev
->
ba£_addr
);

261 
	}
}

264 
	$¶_tx_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

266 
»t_v®
;

268 ià(
dev
->
tbusy
 || dev->
š‹¼u±
) {

269 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

270 ià(
tickssoçr
 < 50)

272 
	`´štk
("%s:¿nsm™imed out\n", 
dev
->
Çme
);

274 
	`¶_deviû_ş—r
(
dev
);

281 ià(
skb
 =ğ
NULL
) {

282 
	`dev_tšt
(
dev
);

288 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

289 
skb
->
dev
 = dev;

290 
	`¬p_queue
 (
skb
);

293 
skb
->
¬p
=1;

295 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

296 
»t_v®
 = 
	`¶_£nd_·ck‘
(
dev
, 
skb
->
d©a
, skb->
Ën
);

297 ià(
skb
->
ä“
)

298 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

299 
dev
->
tbusy
 = 0;

300 
	`m¬k_bh
 (
INET_BH
);

302 
	}
}

305 
	$¶_h—d”
 (*
buff
, 
deviû
 *
dev
,

306 
ty³
, 
h_de¡
,

307 
h_sourû
, 
Ën
)

309 ià(
dev
->
dev_addr
[0] == 0) {

311 
	`¶_£t_physiÿÏddr
(
dev
, 
h_sourû
);

313  
	`‘h_h—d”
(
buff
, 
dev
, 
ty³
, 
h_de¡
, 
h_sourû
, 
Ën
);

314 
	}
}

317 
	$¶_deviû_ş—r
(
deviû
 *
dev
)

319 
dev
->
š‹¼u±
 = 0;

320 
dev
->
tbusy
 = 0;

321 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_DATA
);

322 
	`outb
(0x10, 
dev
->
ba£_addr
 + 
PAR_CONTROL
);

323 
	}
}

326 
	$¶_»ûiv”_”rÜ
(
deviû
 *
dev
)

328 
dev
->
š‹¼u±
 = 0;

329 
dev
->
tbusy
 = 0;

330 
	`outb
(0x02, 
dev
->
ba£_addr
 + 
PAR_DATA
);

331 
	`outb
(0x10, 
dev
->
ba£_addr
 + 
PAR_CONTROL
);

332 
	}
}

335 
	$g‘_by‹
(
deviû
 *
dev
)

337 
v®
, 
Şdv®
;

338 
low_nibbË
;

339 
timeout
;

340 
”rÜ
 = 0;

341 
v®
 = 
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
);

342 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
 * 2;

344 
Şdv®
 = 
v®
;

345 
v®
 = 
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
);

346 iàĞ
Şdv®
 !ğ
v®
 ) ;

347 iàĞ
timeout
 < 
jiff›s
 ) {

348 
”rÜ
++;

351 }  (
v®
 & 0x80) );

352 
v®
 = 
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
);

353 
low_nibbË
 = (
v®
 >> 3) & 0x0f;

354 
	`outb
(0x11, 
dev
->
ba£_addr
 + 
PAR_DATA
);

355 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
 * 2;

357 
Şdv®
 = 
v®
;

358 
v®
 = 
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
);

359 ià(
Şdv®
 !ğ
v®
) ;

360 iàĞ
timeout
 < 
jiff›s
 ) {

361 
”rÜ
++;

364 }  !(
v®
 & 0x80) );

365 
v®
 = 
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
);

366 
	`PRINTK2
(("%02x % ", 
low_nibbË
 | ((
v®
 << 1) & 0xf0),

367 
”rÜ
 ? "t":""));

368 
	`outb
(0x01, 
dev
->
ba£_addr
 + 
PAR_DATA
);

369 ià(
”rÜ
) {

371 
	`doubË_timeoutçùÜ
();

374  
low_nibbË
 | ((
v®
 << 1) & 0xf0);

375 
	}
}

380 
	$¶_š‹¼u±
(
»g_±r
)

382 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

383 
deviû
 *
dev
 = 
œq2dev_m­
[
œq
];

384 
Ãt¡©s
 *
loÿl¡©s
;

386 ià(
dev
 =ğ
NULL
) {

387 
	`PRINTK
(("¶_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
));

390 
loÿl¡©s
 = (
Ãt¡©s
*è
dev
->
´iv
;

391 ià(
dev
->
tbusy
 || dev->
š‹¼u±
) ;

392 
dev
->
š‹¼u±
 = 1;

393 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_CONTROL
);

394 
	`¡i
();

395 
	`PRINTK2
(("%s: iÁ”ru±. ", 
dev
->
Çme
));

399 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
;

400 (
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
) & 0xf8) != 0xc0) {

401 iàĞ
timeout
 < 
jiff›s
 ) {

402 
	`PRINTK2
(("%s: No interrupt (status=%#02x)!\n",

403 
dev
->
Çme
, 
	`šb
(dev->
ba£_addr
 + 
PAR_STATUS
)));

404 
	`¶_deviû_ş—r
(
dev
);

409 ià(
	`¶_»ûive_·ck‘
(
dev
)) {

411 
loÿl¡©s
->
rx_”rÜs
++;

412 
	`¶_»ûiv”_”rÜ
(
dev
);

414 
	`¶_deviû_ş—r
(
dev
);

416 
	}
}

419 
	$¶_»ûive_·ck‘
(
deviû
 *
dev
)

421 
¶_ty³
;

422 
Ëngth
;

423 
checksum
 = 0;

424 
sk_buff
 *
skb
;

425 
Ãt¡©s
 *
loÿl¡©s
;

426 
‘hhdr
 
‘h
;

428 
loÿl¡©s
 = (
Ãt¡©s
*è
dev
->
´iv
;

430 
	`outb
(1, 
dev
->
ba£_addr
 + 
PAR_DATA
);

434 
¶_ty³
 = 
	`g‘_by‹
(
dev
);

435 ià(
¶_ty³
 < 0)  1;

436 
Ëngth
 = 
	`g‘_by‹
(
dev
) << 8;

437 
Ëngth
 |ğ
	`g‘_by‹
(
dev
);

438  
¶_ty³
 ) {

439 
PLIP_HEADER_TYPE1
:

441 
i
;

442 *
‘h_p
 = (*)&
‘h
;

443  
i
 = 0; i < (
‘h
); i++, 
‘h_p
++) {

444 *
‘h_p
 = 
	`g‘_by‹
(
dev
);

448 
PLIP_HEADER_TYPE2
:

450 
h_de¡
, 
h_sourû
;

451 
ty³
;

452 
h_de¡
 = 
	`g‘_by‹
(
dev
);

453 
h_sourû
 = 
	`g‘_by‹
(
dev
);

454 
ty³
 = 
	`g‘_by‹
(
dev
) << 8;

455 
ty³
 |ğ
	`g‘_by‹
(
dev
);

456 
	`¶_»bud_’‘hdr
(
dev
, &
‘h
, 
h_de¡
, 
h_sourû
, 
ty³
);

460 
	`PRINTK
(("%s: wrÚg h—d” où‘\n", 
dev
->
Çme
));

462 
	`PRINTK2
(("Ëngth = %d\n", 
Ëngth
));

463 ià(
Ëngth
 > 
dev
->
mtu
 ||†ength < 8) {

464 
	`PRINTK2
(("%s: bogu ·ck‘ siz%d.\n", 
dev
->
Çme
, 
Ëngth
));

472 
sksize
;

473 
sksize
 = (
sk_buff
è+ 
Ëngth
;

474 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

475 ià(
skb
 =ğ
NULL
) {

476 
	`PRINTK
(("%s: Couldn't‡llocate‡ sk_buff of size %d.\n",

477 
dev
->
Çme
, 
sksize
));

480 
skb
->
lock
 = 0;

481 
skb
->
mem_Ën
 = 
sksize
;

482 
skb
->
mem_addr
 = skb;

487 *
buf
 = 
skb
->
d©a
;

488 *
‘h_p
 = (*)&
‘h
;

489 
i
;

490  
i
 = 0; i < (
‘h
); i++) {

491 
checksum
 +ğ*
‘h_p
;

492 *
buf
++ = *
‘h_p
++;

494  
i
 = 0; i < 
Ëngth
 - (
‘h
); i++) {

495 
Ãw_by‹
 = 
	`g‘_by‹
(
dev
);

496 
checksum
 +ğ
Ãw_by‹
;

497 *
buf
++ = 
Ãw_by‹
;

499 
checksum
 &= 0xff;

500 ià(
checksum
 !ğ
	`g‘_by‹
(
dev
)) {

501 
loÿl¡©s
->
rx_üc_”rÜs
++;

502 
	`PRINTK
(("checksumƒrror\n"));

504 } if(
	`dev_ršt
((*)
skb
, 
Ëngth
, 
IN_SKBUFF
, 
dev
)) {

505 
	`´štk
("%s:„cv bufàfuÎ.\n", 
dev
->
Çme
);

506 
loÿl¡©s
->
rx_drİ³d
++;

512 
timeout
;

514 
timeout
 = 
jiff›s
 + 
Ëngth
 * 
timeoutçùÜ
 / 16;

515 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_DATA
);

517  (
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
) & 0xf8) != 0x80 ) {

518 ià(
timeout
 < 
jiff›s
 ) {

519 
	`doubË_timeoutçùÜ
();

520 
	`PRINTK
(("Remote has‚ot„eset.\n"));

525 
loÿl¡©s
->
rx_·ck‘s
++;

527 
	}
}

530 
	$£nd_by‹
(
deviû
 *
dev
, 
v®
)

532 
timeout
;

533 
”rÜ
 = 0;

534 ià(!(
	`šb
(
dev
->
ba£_addr
+
PAR_STATUS
) & 0x08)) {

535 
	`PRINTK
(("remoteƒnd become unready while sending\n"));

538 
	`PRINTK2
((" S%02x", 
v®
));

539 
	`outb
(
v®
, 
dev
->
ba£_addr
);

540 
	`outb
(0x10 | 
v®
, 
dev
->
ba£_addr
);

541 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
;

542  
	`šb
(
dev
->
ba£_addr
+
PAR_STATUS
) & 0x80 )

543 iàĞ
timeout
 < 
jiff›s
 ) {

544 
”rÜ
++;

547 
	`outb
(0x10 | (
v®
 >> 4), 
dev
->
ba£_addr
);

548 
	`outb
(
v®
 >> 4, 
dev
->
ba£_addr
);

549 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
;

550  (
	`šb
(
dev
->
ba£_addr
+
PAR_STATUS
) & 0x80) == 0 )

551 iàĞ
timeout
 < 
jiff›s
 ) {

552 
”rÜ
++;

555 ià(
”rÜ
) {

557 
	`doubË_timeoutçùÜ
();

558 
	`PRINTK2
(("t"));

562 
	}
}

572 
	$¶_£nd_¡¬t
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
)

574 
timeout
;

575 
¡©us
;

576 
Ï¡Œigg”
;

577 
Ãt¡©s
 *
loÿl¡©s
 = (Ãt¡©s*è
dev
->
´iv
;

580 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
 * 16;

581 
Ï¡Œigg”
 = 
jiff›s
;

582  ((
¡©us
 = 
	`šb
(
dev
->
ba£_addr
+
PAR_STATUS
)) & 0x08) == 0 ) {

583 
dev
->
tbusy
 = 1;

584 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_CONTROL
);

585 
	`outb
(0x08, 
dev
->
ba£_addr
 + 
PAR_DATA
);

586 ià(
¡©us
 & 0x40) {

592 iàĞ
	`¶_addrcmp
(
‘h
) > 0 ) {

593 
loÿl¡©s
->
cŞlisiÚs
++;

594 
	`PRINTK2
(("bothƒnds‡reryingo send‡…acket.\n"));

595 ià(
	`¶_»ûive_·ck‘
(
dev
)) {

597 
loÿl¡©s
->
rx_”rÜs
++;

598 
	`outb
(0x02, 
dev
->
ba£_addr
 + 
PAR_DATA
);

600 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_DATA
);

602 
	`cŞd_¦“p
(2);

606 ià(
Ï¡Œigg”
 !ğ
jiff›s
) {

608 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_DATA
);

609 
	`cŞd_¦“p
(1);

610 
Ï¡Œigg”
 = 
jiff›s
;

612 ià(
timeout
 < 
jiff›s
) {

613 
	`doubË_timeoutçùÜ
();

614 
	`¶_deviû_ş—r
(
dev
);

615 
loÿl¡©s
->
tx_”rÜs
++;

616 
	`PRINTK
(("%s: Connect failed in send_packet().\n",

617 
dev
->
Çme
));

624 
	}
}

626 
	$¶_£nd_·ck‘
(
deviû
 *
dev
, *
buf
, 
Ëngth
)

628 
”rÜ
 = 0;

629 
¶_ty³
;

630 
Ãt¡©s
 *
loÿl¡©s
;

632 
	`PRINTK2
(("%s:…lip_send_packet(%d) %02x %02x %02x %02x %02x...",

633 
dev
->
Çme
, 
Ëngth
, 
buf
[0], buf[1], buf[2], buf[3], buf[4]));

634 ià(
Ëngth
 > 
dev
->
mtu
) {

635 
	`´štk
("%s:…ack‘oØbig, %d.\n", 
dev
->
Çme
, 
Ëngth
);

638 
loÿl¡©s
 = (
Ãt¡©s
*è
dev
->
´iv
;

642 
i
;

643 
timeout
 = 
jiff›s
 + 
timeoutçùÜ
 * 8;

644  (
i
 = (
	`šb
(
dev
->
ba£_addr
+
PAR_STATUS
) & 0xe8)) != 0x80 ) {

645 ià(
i
 == 0x78) {

653 ià(
timeout
 < 
jiff›s
) {

655 
	`doubË_timeoutçùÜ
();

656 
loÿl¡©s
->
tx_”rÜs
++;

657 
	`PRINTK
(("remoteƒnd is‚ot„eady.\n"));

663 ià(
	`¶_£nd_¡¬t
(
dev
, (
‘hhdr
 *)
buf
) < 0)

671 
i
;

672 
‘hhdr
 *
‘h
 = (‘hhd¸*)
buf
;

674 
¶_ty³
 = 
PLIP_HEADER_TYPE2
;

675  
i
 = 0; i < 
ETH_ALEN
 - 1; i++)

676 ià(
‘h
->
h_de¡
[
i
] !ğ‘h->
h_sourû
[i])

677 
¶_ty³
 = 
PLIP_HEADER_TYPE1
;

680 
	`£nd_by‹
(
dev
, 
¶_ty³
);

690 
	`£nd_by‹
(
dev
, 
Ëngth
 >> 8); send_byte(dev,†ength);

694 
i
;

695 
checksum
 = 0;

697 ià(
¶_ty³
 =ğ
PLIP_HEADER_TYPE2
) {

698 
	`¶_£nd_’‘hdr
(
dev
, (
‘hhdr
*)
buf
);

700  
i
 = 0; i < (
‘hhdr
); i++ ) {

701 ià(
¶_ty³
 =ğ
PLIP_HEADER_TYPE1
) {

702 
	`£nd_by‹
(
dev
, *
buf
);

704 
checksum
 +ğ*
buf
++;

707 
i
 = 0; i < 
Ëngth
 - (
‘hhdr
); i++) {

708 
checksum
 +ğ
buf
[
i
];

709 ià(
	`£nd_by‹
(
dev
, 
buf
[
i
]) < 0) {

710 
”rÜ
++;

714 
	`£nd_by‹
(
dev
, 
checksum
 & 0xff);

718 
timeout
;

720 
	`outb
(0x00, 
dev
->
ba£_addr
 + 
PAR_DATA
);

722 
timeout
 = 
jiff›s
 + ((
Ëngth
 * 
timeoutçùÜ
) >> 4);

723 (
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
) & 0xe8) != 0x80) {

724 ià(
timeout
 < 
jiff›s
 ) {

725 
	`doubË_timeoutçùÜ
();

726 
	`PRINTK
(("Remoteƒnd has‚ot„eset.\n"));

727 
”rÜ
++;

731 ià(
	`šb
(
dev
->
ba£_addr
 + 
PAR_STATUS
) & 0x10) {

733 
”rÜ
++;

736 
	`¶_deviû_ş—r
(
dev
);

737 
loÿl¡©s
->
tx_·ck‘s
++;

738 
	`PRINTK2
(("¶_£nd_·ck‘(%dèdÚe.\n", 
Ëngth
));

739  
”rÜ
?1:0;

740 
	}
}

746 
	$¶_£t_physiÿÏddr
(
deviû
 *
dev
, 
addr
)

753 *
addr
 = 
dev
->
dev_addr
;

754 
i
;

756 ià((
addr
 >> 24) == 0 || (ipaddr >> 24) == 0xff) ;

757 
	`PRINTK2
(("%s: s‘…hysiÿÈadd»s tØ%08x\n", 
dev
->
Çme
, 
addr
));

758 
i
=0; i < 
ETH_ALEN
 - (); i++) {

759 
addr
[
i
] = 0xfd;

761 
	`memıy
(&(
addr
[
i
]), &
addr
, ());

762 
	}
}

765 
	$¶_addrcmp
(
‘hhdr
 *
‘h
)

767 
i
;

768  
i
 = 
ETH_ALEN
 - 1; i >= 0; i-- ) {

769 ià(
‘h
->
h_de¡
[
i
] >ƒth->
h_sourû
[i])  -1;

770 ià(
‘h
->
h_de¡
[
i
] <ƒth->
h_sourû
[i])  1;

772 
	`PRINTK2
(("h_dest = %08x%04x h_source = %08x%04x\n",

773 *(*)&
‘h
->
h_de¡
[2],*(*)&eth->h_dest[0],

774 *(*)&
‘h
->
h_sourû
[2],*(*)&eth->h_source[0]));

776 
	}
}

779 
	$¶_£nd_’‘hdr
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
)

781 
	`£nd_by‹
(
dev
, 
‘h
->
h_de¡
[
ETH_ALEN
-1]);

782 
	`£nd_by‹
(
dev
, 
‘h
->
h_sourû
[
ETH_ALEN
-1]);

783 
	`£nd_by‹
(
dev
, 
‘h
->
h_´Ùo
 >> 8);

784 
	`£nd_by‹
(
dev
, 
‘h
->
h_´Ùo
);

786 
	}
}

789 
	$¶_»bud_’‘hdr
(
deviû
 *
dev
, 
‘hhdr
 *
‘h
,

790 
de¡
, 
sourû
,

791 
ty³
)

793 
‘h
->
h_´Ùo
 = 
ty³
;

794 
	`memıy
(
‘h
->
h_de¡
, 
dev
->
dev_addr
, 
ETH_ALEN
-1);

795 
‘h
->
h_de¡
[
ETH_ALEN
-1] = 
de¡
;

796 
	`memıy
(
‘h
->
h_sourû
, 
dev
->
dev_addr
, 
ETH_ALEN
-1);

797 
‘h
->
h_sourû
[
ETH_ALEN
-1] = 
sourû
;

799 
	}
}

804 
	$cŞd_¦“p
(
tics
)

806 
¡¬t
 = 
jiff›s
;

807 
jiff›s
 < 
¡¬t
 + 
tics
)

810 
	}
}

813 
	$doubË_timeoutçùÜ
()

815 
timeoutçùÜ
 *= 2;

816 ià(
timeoutçùÜ
 >ğ
MAXTIMEOUTFACTOR
) {

817 
timeoutçùÜ
 = 
MAXTIMEOUTFACTOR
;

820 
	}
}

822 
’‘_¡©i¡ics
 *

823 
	$¶_g‘_¡©s
(
deviû
 *
dev
)

825 
Ãt¡©s
 *
loÿl¡©s
 = (Ãt¡©s*è
dev
->
´iv
;

826  
loÿl¡©s
;

827 
	}
}

	@drivers/net/skeleton.c

21 *
	gv”siÚ
 =

26 
	~<lšux/cÚfig.h
>

43 
	~<lšux/k”Ãl.h
>

44 
	~<lšux/sched.h
>

45 
	~<lšux/ty³s.h
>

46 
	~<lšux/fú.h
>

47 
	~<lšux/š‹¼u±.h
>

48 
	~<lšux/±¿û.h
>

49 
	~<lšux/iİÜt.h
>

50 
	~<lšux/š.h
>

51 
	~<lšux/m®loc.h
>

52 
	~<lšux/¡ršg.h
>

53 
	~<asm/sy¡em.h
>

54 
	~<asm/b™İs.h
>

55 
	~<asm/io.h
>

56 
	~<asm/dma.h
>

57 
	~<”ºo.h
>

59 
	~"dev.h
"

60 
	~"‘h.h
"

61 
	~"skbuff.h
"

62 
	~"¬p.h
"

64 #iâdeà
HAVE_AUTOIRQ


66 
autoœq_£tup
(
wa™time
);

67 
autoœq_»pÜt
(
wa™time
);

70 
deviû
 *
œq2dev_m­
[16];

73 #iâdeà
HAVE_ALLOC_SKB


74 
	#®loc_skb
(
size
, 
´iÜ™y
è(
sk_buff
 *è
	`km®loc
(size,´iÜ™y)

	)

75 
	#kä“_skbmem
(
addr
, 
size
è
	`kä“_s
×ddr,size);

	)

78 #iâdeà
HAVE_PORTRESERVE


79 
	#check_»giÚ
(
ißddr
, 
size
è0

	)

80 
	#¢¬f_»giÚ
(
ißddr
, 
size
); dØ; 0)

	)

84 #iâdeà
NET_DEBUG


85 
	#NET_DEBUG
 2

	)

87 
	gÃt_debug
 = 
NET_DEBUG
;

90 
	sÃt_loÿl
 {

91 
’‘_¡©i¡ics
 
	m¡©s
;

92 
	mİ’_time
;

96 
	#ETHERCARD_TOTAL_SIZE
 16

	)

99 
	#SA_ADDR0
 0x00

	)

100 
	#SA_ADDR1
 0x42

	)

101 
	#SA_ADDR2
 0x65

	)

105 
Ãtÿrd_´obe
(
deviû
 *
dev
);

107 
Ãtÿrd_´obe1
(
deviû
 *
dev
, 
ißddr
);

108 
Ãt_İ’
(
deviû
 *
dev
);

109 
Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

110 
Ãt_š‹¼u±
(
»g_±r
);

111 
Ãt_rx
(
deviû
 *
dev
);

112 
Ãt_şo£
(
deviû
 *
dev
);

113 
’‘_¡©i¡ics
 *
Ãt_g‘_¡©s
(
deviû
 *
dev
);

114 #ifdeà
HAVE_MULTICAST


115 
£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
);

119 
	#tx_dÚe
(
dev
è1

	)

120 
h¬dw¬e_£nd_·ck‘
(
ißddr
, *
buf
, 
Ëngth
);

121 
ch£t_š™
(
deviû
 *
dev
, 
¡¬
);

131 
	$Ãtÿrd_´obe
(
deviû
 *
dev
)

133 *
pÜt
, 
pÜts
[] = {0x300, 0x280, 0};

134 
ba£_addr
 = 
dev
->base_addr;

136 ià(
ba£_addr
 > 0x1ff)

137  
	`Ãtÿrd_´obe1
(
dev
, 
ba£_addr
);

138 ià(
ba£_addr
 > 0)

139  
ENXIO
;

141 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

142 
ißddr
 = *
pÜt
;

143 ià(
	`check_»giÚ
(
ißddr
, 
ETHERCARD_TOTAL_SIZE
))

145 ià(
	`šb
(
ißddr
) != 0x57)

147 
dev
->
ba£_addr
 = 
ißddr
;

148 ià(
	`Ãtÿrd_´obe1
(
dev
, 
ißddr
) == 0)

152 
dev
->
ba£_addr
 = base_addr;

153  
ENODEV
;

154 
	}
}

156 
	$Ãtÿrd_´obe1
(
deviû
 *
dev
, 
ißddr
)

158 
¡©iÚ_addr
[6];

159 
i
;

162 
i
 = 0; i < 6; i++) {

163 
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + i);

166 ià(
¡©iÚ_addr
[0] !ğ
SA_ADDR0


167 || 
¡©iÚ_addr
[1] !ğ
SA_ADDR1
 || stiÚ_addr[2] !ğ
SA_ADDR2
) {

168  
ENODEV
;

171 
	`´štk
("%s: % found‡ˆ%#3x, IRQ %d.\n", 
dev
->
Çme
,

172 "ÃtwÜk c¬d", 
dev
->
ba£_addr
, dev->
œq
);

174 #ifdeà
jum³»d_š‹¼u±s


179 ià(
dev
->
œq
 == -1)

181 ià(
dev
->
œq
 < 2) {

182 
	`autoœq_£tup
(0);

185 
dev
->
œq
 = 
	`autoœq_»pÜt
(0);

186 ià(
Ãt_debug
 >= 2)

187 
	`´štk
("‡utoœq i %d", 
dev
->
œq
);

188 } ià(
dev
->
œq
 == 2)

191 
dev
->
œq
 = 9;

193 { 
œqv®
 = 
	`»que¡_œq
(
dev
->
œq
, &
Ãt_š‹¼u±
);

194 ià(
œqv®
) {

195 
	`´štk
 ("%s: uÇbËØg‘ IRQ %d (œqv®=%d).\n", 
dev
->
Çme
,

196 
dev
->
œq
, 
œqv®
);

197  
EAGAIN
;

203 
	`¢¬f_»giÚ
(
ißddr
, 
ETHERCARD_TOTAL_SIZE
);

205 ià(
Ãt_debug
)

206 
	`´štk
(
v”siÚ
);

209 
dev
->
´iv
 = 
	`km®loc
((
Ãt_loÿl
), 
GFP_KERNEL
);

210 
	`mem£t
(
dev
->
´iv
, 0, (
Ãt_loÿl
));

212 
dev
->
İ’
 = 
Ãt_İ’
;

213 
dev
->
¡İ
 = 
Ãt_şo£
;

214 
dev
->
h¬d_¡¬t_xm™
 = 
Ãt_£nd_·ck‘
;

215 
dev
->
g‘_¡©s
 = 
Ãt_g‘_¡©s
;

216 #ifdeà
HAVE_MULTICAST


217 
dev
->
£t_muÉiÿ¡_li¡
 = &set_multicast_list;

222 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

223 
dev
->
buffs
[
i
] = 
NULL
;

225 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

226 
dev
->
add_¬p
 = 
‘h_add_¬p
;

227 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

228 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

229 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

231 
dev
->
ty³
 = 
ARPHRD_ETHER
;

232 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

233 
dev
->
mtu
 = 1500;

234 
dev
->
addr_Ën
 = 
ETH_ALEN
;

235 
i
 = 0; i < 
ETH_ALEN
; i++) {

236 
dev
->
brßdÿ¡
[
i
]=0xff;

240 
dev
->
æags
 = 
IFF_BROADCAST
;

241 
dev
->
çmy
 = 
AF_INET
;

242 
dev
->
·_addr
 = 0;

243 
dev
->
·_brdaddr
 = 0;

244 
dev
->
·_mask
 = 0;

245 
dev
->
·_®’
 = ();

248 
	}
}

259 
	$Ãt_İ’
(
deviû
 *
dev
)

261 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

262 
ißddr
 = 
dev
->
ba£_addr
;

266 ià(
	`»que¡_œq
(
dev
->
œq
, &
Ãt_š‹¼u±
)) {

267  -
EAGAIN
;

272 ià(
	`»que¡_dma
(
dev
->
dma
)) {

273 
	`ä“_œq
(
dev
->
œq
);

274  -
EAGAIN
;

276 
œq2dev_m­
[
dev
->
œq
] = dev;

280 
	`outb
(0x00, 
ißddr
);

281 
Í
->
İ’_time
 = 
jiff›s
;

283 
dev
->
tbusy
 = 0;

284 
dev
->
š‹¼u±
 = 0;

285 
dev
->
¡¬t
 = 1;

287 
	}
}

290 
	$Ãt_£nd_·ck‘
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

292 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

293 
ißddr
 = 
dev
->
ba£_addr
;

295 ià(
dev
->
tbusy
) {

298 
tickssoçr
 = 
jiff›s
 - 
dev
->
Œªs_¡¬t
;

299 ià(
tickssoçr
 < 5)

301 
	`´štk
("%s:¿nsm™imed out, %s?\n", 
dev
->
Çme
,

302 
	`tx_dÚe
(
dev
) ? "IRQ conflict" : "network cable…roblem");

304 
	`ch£t_š™
(
dev
, 1);

305 
dev
->
tbusy
=0;

306 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

312 ià(
skb
 =ğ
NULL
) {

313 
	`dev_tšt
(
dev
);

319 ià(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
, dev)) {

320 
skb
->
dev
 = dev;

321 
	`¬p_queue
 (
skb
);

324 
skb
->
¬p
=1;

328 ià(
	`£t_b™
(0, (*)&
dev
->
tbusy
) != 0)

329 
	`´štk
("%s: T¿nsm™‹¸acûs cÚæiù.\n", 
dev
->
Çme
);

331 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

332 *
buf
 = 
skb
->
d©a
;

334 
	`h¬dw¬e_£nd_·ck‘
(
ißddr
, 
buf
, 
Ëngth
);

335 
dev
->
Œªs_¡¬t
 = 
jiff›s
;

337 ià(
skb
->
ä“
)

338 
	`kä“_skb
 (
skb
, 
FREE_WRITE
);

341 ià(
	`šw
(
ißddr
) == 81)

342 
Í
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

345 
	}
}

350 
	$Ãt_š‹¼u±
(
»g_±r
)

352 
œq
 = -(((
±_»gs
 *)
»g_±r
)->
Üig_—x
+2);

353 
deviû
 *
dev
 = (deviû *)(
œq2dev_m­
[
œq
]);

354 
Ãt_loÿl
 *
Í
;

355 
ißddr
, 
¡©us
, 
boguscouÁ
 = 0;

357 ià(
dev
 =ğ
NULL
) {

358 
	`´štk
 ("Ãt_š‹¼u±(): irq %d fÜ unknowÀdeviû.\n", 
œq
);

361 
dev
->
š‹¼u±
 = 1;

363 
ißddr
 = 
dev
->
ba£_addr
;

364 
Í
 = (
Ãt_loÿl
 *)
dev
->
´iv
;

365 
¡©us
 = 
	`šw
(
ißddr
 + 0);

368 ià(
¡©us
 ) {

370 
	`Ãt_rx
(
dev
);

372 ià(
¡©us
 ) {

373 
Í
->
¡©s
.
tx_·ck‘s
++;

374 
dev
->
tbusy
 = 0;

375 
	`m¬k_bh
(
INET_BH
);

377 ià(
¡©us
 ) {

379 
Í
->
¡©s
.
tx_wšdow_”rÜs
++;

381 } ++
boguscouÁ
 < 20) ;

384 
	}
}

388 
	$Ãt_rx
(
deviû
 *
dev
)

390 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

391 
ißddr
 = 
dev
->
ba£_addr
;

392 
boguscouÁ
 = 10;

395 
¡©us
 = 
	`šw
(
ißddr
);

396 
pkt_Ën
 = 
	`šw
(
ißddr
);

398 ià(
pkt_Ën
 == 0)

401 ià(
¡©us
 & 0x40) {

402 
Í
->
¡©s
.
rx_”rÜs
++;

403 ià(
¡©us
 & 0x20è
Í
->
¡©s
.
rx_äame_”rÜs
++;

404 ià(
¡©us
 & 0x10è
Í
->
¡©s
.
rx_ov”_”rÜs
++;

405 ià(
¡©us
 & 0x08è
Í
->
¡©s
.
rx_üc_”rÜs
++;

406 ià(
¡©us
 & 0x04è
Í
->
¡©s
.
rx_fifo_”rÜs
++;

409 
sksize
 = (
sk_buff
è+ 
pkt_Ën
;

410 
sk_buff
 *
skb
;

412 
skb
 = 
	`®loc_skb
(
sksize
, 
GFP_ATOMIC
);

413 ià(
skb
 =ğ
NULL
) {

414 
	`´štk
("%s: MemÜy squ“ze, drİpšg…ack‘.\n", 
dev
->
Çme
);

415 
Í
->
¡©s
.
rx_drİ³d
++;

418 
skb
->
mem_Ën
 = 
sksize
;

419 
skb
->
mem_addr
 = skb;

420 
skb
->
Ën
 = 
pkt_Ën
;

421 
skb
->
dev
 = dev;

424 
	`memıy
(
skb
->
d©a
, (*)
dev
->
rmem_¡¬t
,

425 
pkt_Ën
);

427 
	`šsw
(
ißddr
, 
skb
->
d©a
, (
pkt_Ën
 + 1) >> 1);

429 #ifdeà
HAVE_NETIF_RX


430 
	`Ãtif_rx
(
skb
);

432 
skb
->
lock
 = 0;

433 ià(
	`dev_ršt
((*)
skb
, 
pkt_Ën
, 
IN_SKBUFF
, 
dev
) != 0) {

434 
	`kä“_s
(
skb
, 
sksize
);

435 
Í
->
¡©s
.
rx_drİ³d
++;

439 
Í
->
¡©s
.
rx_·ck‘s
++;

441 } --
boguscouÁ
);

447 
	}
}

451 
	$Ãt_şo£
(
deviû
 *
dev
)

453 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

454 
ißddr
 = 
dev
->
ba£_addr
;

456 
Í
->
İ’_time
 = 0;

458 
dev
->
tbusy
 = 1;

459 
dev
->
¡¬t
 = 0;

463 
	`di§bË_dma
(
dev
->
dma
);

466 
	`outw
(0x00, 
ißddr
+0);

468 
	`ä“_œq
(
dev
->
œq
);

469 
	`ä“_dma
(
dev
->
dma
);

471 
œq2dev_m­
[
dev
->
œq
] = 0;

477 
	}
}

481 
’‘_¡©i¡ics
 *

482 
	$Ãt_g‘_¡©s
(
deviû
 *
dev
)

484 
Ãt_loÿl
 *
Í
 = (Ãt_loÿÈ*)
dev
->
´iv
;

485 
ißddr
 = 
dev
->
ba£_addr
;

487 
	`şi
();

489 
Í
->
¡©s
.
rx_mis£d_”rÜs
 = 
	`šw
(
ißddr
+1);

490 
	`¡i
();

492  &
Í
->
¡©s
;

493 
	}
}

495 #ifdeà
HAVE_MULTICAST


503 
	$£t_muÉiÿ¡_li¡
(
deviû
 *
dev
, 
num_addrs
, *
addrs
)

505 
ißddr
 = 
dev
->
ba£_addr
;

506 ià(
num_addrs
) {

507 
	`outw
(69, 
ißddr
);

509 
	`outw
(99, 
ißddr
);

510 
	}
}

	@drivers/net/slhc.c

41 
	~<lšux/ty³s.h
>

42 
	~<lšux/sched.h
>

43 
	~<lšux/mm.h
>

44 
	~<lšux/¡ršg.h
>

45 
	~<lšux/sock‘.h
>

46 
	~<lšux/sockios.h
>

47 
	~<lšux/‹rmios.h
>

48 
	~<lšux/š.h
>

49 
	~<lšux/fú.h
>

50 
	~"š‘.h
"

51 
	~"dev.h
"

52 
	~".h
"

53 
	~"´ÙocŞ.h
"

54 
	~"icmp.h
"

55 
	~"tı.h
"

56 
	~"skbuff.h
"

57 
	~"sock.h
"

58 
	~"¬p.h
"

59 
	~<lšux/”ºo.h
>

60 
	~<lšux/tim”.h
>

61 
	~<asm/sy¡em.h
>

62 
	~<asm/£gm’t.h
>

63 
	~<lšux/mm.h
>

64 
	~"¦hc.h
"

66 
	#DPRINT
(
x
)

	)

68 
	gÏ¡_»Œª
;

70 *
’code
(*
ı
,
n
);

71 
decode
(**
ıp
);

72 * 
put16
(*
ı
, 
x
);

73 
puÎ16
(**
ıp
);

75 
_csum
(
hdr
 *
h
);

81 
¦com´ess
 *

82 
	$¦hc_š™
(
r¦Ùs
, 
t¦Ùs
)

84 
i
;

85 
c¡©e
 *
ts
;

86 
¦com´ess
 *
comp
;

88 
comp
 = (
¦com´ess
 *)
	`km®loc
((slcompress),

89 
GFP_KERNEL
);

90 ià(! 
comp
)

91  
NULL
;

93 
	`mem£t
(
comp
, 0, (
¦com´ess
));

95 iàĞ
r¦Ùs
 > 0 &&„slots < 256 ) {

96 
comp
->
r¡©e
 =

97 (
c¡©e
 *)
	`km®loc
(
r¦Ùs
 * (cstate),

98 
GFP_KERNEL
);

99 ià(! 
comp
->
r¡©e
)

100  
NULL
;

101 
	`mem£t
(
comp
->
r¡©e
, 0, 
r¦Ùs
 * (
c¡©e
));

102 
comp
->
r¦Ù_lim™
 = 
r¦Ùs
 - 1;

105 iàĞ
t¦Ùs
 > 0 &&slots < 256 ) {

106 
comp
->
t¡©e
 =

107 (
c¡©e
 *)
	`km®loc
(
t¦Ùs
 * (cstate),

108 
GFP_KERNEL
);

109 ià(! 
comp
->
t¡©e
)

110  
NULL
;

111 
	`mem£t
(
comp
->
t¡©e
, 0, 
r¦Ùs
 * (
c¡©e
));

112 
comp
->
t¦Ù_lim™
 = 
t¦Ùs
 - 1;

115 
comp
->
xm™_Şde¡
 = 0;

116 
comp
->
xm™_cu¼’t
 = 255;

117 
comp
->
»cv_cu¼’t
 = 255;

124 
comp
->
æags
 |ğ
SLF_TOSS
;

126 iàĞ
t¦Ùs
 > 0 ) {

127 
ts
 = 
comp
->
t¡©e
;

128 
i
 = 
comp
->
t¦Ù_lim™
; i > 0; --i){

129 
ts
[
i
].
cs_this
 = i;

130 
ts
[
i
].
Ãxt
 = &(ts[i - 1]);

132 
ts
[0].
Ãxt
 = &Ñs[
comp
->
t¦Ù_lim™
]);

133 
ts
[0].
cs_this
 = 0;

135  
comp
;

136 
	}
}

141 
	$¦hc_ä“
(
¦com´ess
 *
comp
)

143 iàĞ
comp
 =ğ
NULLSLCOMPR
 )

146 iàĞ
comp
->
r¡©e
 !ğ
NULLSLSTATE
 )

147 
	`kä“
Ğ
comp
->
r¡©e
 );

149 iàĞ
comp
->
t¡©e
 !ğ
NULLSLSTATE
 )

150 
	`kä“
Ğ
comp
->
t¡©e
 );

152 
	`kä“
Ğ
comp
 );

153 
	}
}

158 
	$put16
(*
ı
, 
x
)

160 *
ı
++ = 
x
 >> 8;

161 *
ı
++ = 
x
;

163  
ı
;

164 
	}
}

169 
	$’code
(*
ı
, 
n
)

171 if(
n
 >= 256 ||‚ == 0){

172 *
ı
++ = 0;

173 
ı
 = 
	`put16
(ı,
n
);

175 *
ı
++ = 
n
;

177  
ı
;

178 
	}
}

182 
	$puÎ16
(**
ıp
)

184 
rv®
;

186 
rv®
 = *(*
ıp
)++;

187 
rv®
 <<= 8;

188 
rv®
 |ğ*(*
ıp
)++;

189  
rv®
;

190 
	}
}

194 
	$decode
(**
ıp
)

196 
x
;

198 
x
 = *(*
ıp
)++;

199 if(
x
 == 0){

200  
	`puÎ16
(
ıp
) & 0xffff;

202  
x
 & 0xff;

204 
	}
}

214 
	$¦hc_com´ess
(
¦com´ess
 *
comp
, *
iı
, 
isize
,

215 *
oı
, **
ıp
, 
com´ess_cid
)

217 
c¡©e
 *
ocs
 = &(
comp
->
t¡©e
[comp->
xm™_Şde¡
]);

218 
c¡©e
 *
lcs
 = 
ocs
;

219 
c¡©e
 *
cs
 = 
lcs
->
Ãxt
;

220 
d–S
, 
d–A
;

221 
chªges
 = 0;

222 
hËn
;

223 
Ãw_£q
[16];

224 *
ı
 = 
Ãw_£q
;

225 
hdr
 *

;

226 
tıhdr
 *
th
, *
Ùh
;

228 

 = (
hdr
 *è
iı
;

231 if(

->
´ÙocŞ
 !ğ
IPPROTO_TCP
 || (
	`Áohs
(->
äag_off
) & 0x1fff) ||

232 (

->
äag_off
 & 32)){

233 
	`DPRINT
(("comp:‚Úcom°1 %d %d %d\n", 

->
´ÙocŞ
,

234 
	`Áohs
(

->
äag_off
), ip->frag_off));

236 if(

->
´ÙocŞ
 !ğ
IPPROTO_TCP
)

237 
comp
->
¦s_o_nÚtı
++;

239 
comp
->
¦s_o_tı
++;

240  
isize
;

244 
th
 = (
tıhdr
 *)(((*)

è+ ip->
ihl
*4);

245 
hËn
 = 

->
ihl
*4 + 
th
->
doff
*4;

250 if(
th
->
syn
 ||h->
fš
 ||h->
r¡
 ||

251 ! (
th
->
ack
)){

252 
	`DPRINT
(("comp:‚Úcom°2 %x %x %d %d %d %d\n", 

, 
th
,

253 
th
->
syn
,h->
fš
,h->
r¡
,h->
ack
));

255 
comp
->
¦s_o_tı
++;

256  
isize
;

273 ifĞ

->
§ddr
 =ğ
cs
->
cs_
.saddr

274 && 

->
daddr
 =ğ
cs
->
cs_
.daddr

275 && 
th
->
sourû
 =ğ
cs
->
cs_tı
.source

276 && 
th
->
de¡
 =ğ
cs
->
cs_tı
.dest)

277 
found
;

280 iàĞ
cs
 =ğ
ocs
 )

282 
lcs
 = 
cs
;

283 
cs
 = cs->
Ãxt
;

284 
comp
->
¦s_o_£¬ches
++;

295 
comp
->
¦s_o_mis£s
++;

296 
comp
->
xm™_Şde¡
 = 
lcs
->
cs_this
;

297 
	`DPRINT
(("comp:‚ot found\n"));

298 
uncom´es£d
;

300 
found
:

304 if(
lcs
 =ğ
ocs
) {

306 } ià(
cs
 =ğ
ocs
) {

308 
comp
->
xm™_Şde¡
 = 
lcs
->
cs_this
;

311 
lcs
->
Ãxt
 = 
cs
->next;

312 
cs
->
Ãxt
 = 
ocs
->next;

313 
ocs
->
Ãxt
 = 
cs
;

328 
Ùh
 = &
cs
->
cs_tı
;

330 if(
Ï¡_»Œª


331 || 

->
v”siÚ
 !ğ
cs
->
cs_
.v”siÚ || ip->
ihl
 != cs->cs_ip.ihl

332 || 

->
tos
 !ğ
cs
->
cs_
.tos

333 || (

->
äag_off
 & 64è!ğ(
cs
->
cs_
.frag_off & 64)

334 || 

->
‰l
 !ğ
cs
->
cs_
.ttl

335 || 
th
->
doff
 !ğ
cs
->
cs_tı
.doff

336 || (

->
ihl
 > 5 && 
	`memcmp
(+1,
cs
->
cs_İt
,((ip->ihl)-5)*4) != 0)

337 || (
th
->
doff
 > 5 && 
	`memcmp
Ñh+1,
cs
->
cs_tıİt
,((th->doff)-5)*4 != 0))){

338 
	`DPRINT
(("comp: incompat\n"));

339 
uncom´es£d
;

348 if(
th
->
urg
){

349 
d–S
 = 
	`Áohs
(
th
->
urg_±r
);

350 
ı
 = 
	`’code
(ı,
d–S
);

351 
chªges
 |ğ
NEW_U
;

352 } if(
th
->
urg_±r
 !ğ
Ùh
->urg_ptr){

357 
	`DPRINT
(("comp: urg incompat\n"));

358 
uncom´es£d
;

360 if((
d–S
 = 
	`Áohs
(
th
->
wšdow
è-‚tohs(
Ùh
->window)) != 0){

361 
ı
 = 
	`’code
(ı,
d–S
);

362 
chªges
 |ğ
NEW_W
;

364 if((
d–A
 = 
	`Áohl
(
th
->
ack_£q
è-‚tohl(
Ùh
->ack_seq)) != 0L){

365 if(
d–A
 > 0x0000ffff)

366 
uncom´es£d
;

367 
ı
 = 
	`’code
(ı,
d–A
);

368 
chªges
 |ğ
NEW_A
;

370 if((
d–S
 = 
	`Áohl
(
th
->
£q
è-‚tohl(
Ùh
->seq)) != 0L){

371 if(
d–S
 > 0x0000ffff)

372 
uncom´es£d
;

373 
ı
 = 
	`’code
(ı,
d–S
);

374 
chªges
 |ğ
NEW_S
;

377 
chªges
){

385 if(

->
tÙ_Ën
 !ğ
cs
->
cs_
.tot_len &&

386 
	`Áohs
(
cs
->
cs_
.
tÙ_Ën
è=ğ
hËn
)

388 
	`DPRINT
(("comp:„etrans\n"));

389 
uncom´es£d
;

391 
SPECIAL_I
:

392 
SPECIAL_D
:

396 
	`DPRINT
(("comp: special\n"));

397 
uncom´es£d
;

398 
NEW_S
|
NEW_A
:

399 if(
d–S
 =ğ
d–A
 &&

400 
d–S
 =ğ
	`Áohs
(
cs
->
cs_
.
tÙ_Ën
è- 
hËn
){

402 
chªges
 = 
SPECIAL_I
;

403 
ı
 = 
Ãw_£q
;

406 
NEW_S
:

407 if(
d–S
 =ğ
	`Áohs
(
cs
->
cs_
.
tÙ_Ën
è- 
hËn
){

409 
chªges
 = 
SPECIAL_D
;

410 
ı
 = 
Ãw_£q
;

414 
d–S
 = 
	`Áohs
(

->
id
è-‚tohs(
cs
->
cs_
.id);

415 if(
d–S
 != 1){

416 
ı
 = 
	`’code
(ı,
d–S
);

417 
chªges
 |ğ
NEW_I
;

419 if(
th
->
psh
)

420 
chªges
 |ğ
TCP_PUSH_BIT
;

424 
d–A
 = 
	`Áohs
(
th
->
check
);

425 
	`memıy
(&
cs
->
cs_
,

,20);

426 
	`memıy
(&
cs
->
cs_tı
,
th
,20);

433 
d–S
 = 
ı
 - 
Ãw_£q
;

434 if(
com´ess_cid
 =ğ0 || 
comp
->
xm™_cu¼’t
 !ğ
cs
->
cs_this
){

435 
ı
 = 
oı
;

436 *
ıp
 = 
oı
;

437 *
ı
++ = 
chªges
 | 
NEW_C
;

438 *
ı
++ = 
cs
->
cs_this
;

439 
comp
->
xm™_cu¼’t
 = 
cs
->
cs_this
;

441 
ı
 = 
oı
;

442 *
ıp
 = 
oı
;

443 *
ı
++ = 
chªges
;

445 
ı
 = 
	`put16
(ı,()
d–A
);

447 
	`DPRINT
(("comp: %x %x %x %d %d\n", 
iı
, 
ı
, 
Ãw_£q
, 
hËn
, 
d–S
));

448 
	`memıy
(
ı
,
Ãw_£q
,
d–S
);

449 
	`memıy
(
ı
+
d–S
,
iı
+
hËn
,
isize
-hlen);

450 
comp
->
¦s_o_com´es£d
++;

451 
oı
[0] |ğ
SL_TYPE_COMPRESSED_TCP
;

452  
isize
 - 
hËn
 + 
d–S
 + (
ı
 - 
oı
);

458 
uncom´es£d
:

459 
	`memıy
(&
cs
->
cs_
,

,20);

460 
	`memıy
(&
cs
->
cs_tı
,
th
,20);

461 ià(

->
ihl
 > 5)

462 
	`memıy
(
cs
->
cs_İt
, 

+1, ((->
ihl
) - 5) * 4);

463 ià(
th
->
doff
 > 5)

464 
	`memıy
(
cs
->
cs_tıİt
, 
th
+1, (Ñh->
doff
) - 5) * 4);

465 
comp
->
xm™_cu¼’t
 = 
cs
->
cs_this
;

466 
comp
->
¦s_o_uncom´es£d
++;

467 
	`memıy
(
oı
, 
iı
, 
isize
);

468 *
ıp
 = 
oı
;

469 
oı
[9] = 
cs
->
cs_this
;

470 
oı
[0] |ğ
SL_TYPE_UNCOMPRESSED_TCP
;

471  
isize
;

472 
	}
}

476 
	$¦hc_uncom´ess
(
¦com´ess
 *
comp
, *
iı
, 
isize
)

478 
chªges
;

479 
x
;

480 
tıhdr
 *
thp
;

481 
hdr
 *

;

482 
c¡©e
 *
cs
;

483 
Ën
, 
hd¾’
;

484 *
ı
 = 
iı
;

487 
comp
->
¦s_i_com´es£d
++;

488 if(
isize
 < 3){

489 
comp
->
¦s_i_”rÜ
++;

490 
	`DPRINT
(("uncomp:„unt\n"));

493 
chªges
 = *
ı
++;

494 if(
chªges
 & 
NEW_C
){

498 
x
 = *
ı
++;

499 if(
x
 < 0 || x > 
comp
->
r¦Ù_lim™
)

500 
bad
;

502 
comp
->
æags
 &=~ 
SLF_TOSS
;

503 
comp
->
»cv_cu¼’t
 = 
x
;

508 if(
comp
->
æags
 & 
SLF_TOSS
){

509 
comp
->
¦s_i_tos£d
++;

510 
	`DPRINT
(("uncomp:oss\n"));

514 
cs
 = &
comp
->
r¡©e
[comp->
»cv_cu¼’t
];

515 
thp
 = &
cs
->
cs_tı
;

516 

 = &
cs
->
cs_
;

518 if((
x
 = 
	`puÎ16
(&
ı
)) == -1) {

519 
	`DPRINT
(("uncomp: badcp chk\n"));

520 
bad
;

522 
thp
->
check
 = 
	`htÚs
(
x
);

524 
thp
->
psh
 = (
chªges
 & 
TCP_PUSH_BIT
) ? 1 : 0;

531 
hd¾’
 = 

->
ihl
 * 4 + 
thp
->
doff
 * 4;

533 
chªges
 & 
SPECIALS_MASK
){

534 
SPECIAL_I
:

536 
i
;

537 
i
 = 
	`Áohs
(

->
tÙ_Ën
è- 
hd¾’
;

538 
thp
->
ack_£q
 = 
	`htÚl
Ğ
	`Áohl
Ñhp->ack_£qè+ 
i
);

539 
thp
->
£q
 = 
	`htÚl
Ğ
	`Áohl
Ñhp->£qè+ 
i
);

543 
SPECIAL_D
:

544 
thp
->
£q
 = 
	`htÚl
Ğ
	`Áohl
(thp->seq) +

545 
	`Áohs
(

->
tÙ_Ën
è- 
hd¾’
);

549 if(
chªges
 & 
NEW_U
){

550 
thp
->
urg
 = 1;

551 if((
x
 = 
	`decode
(&
ı
)) == -1) {

552 
	`DPRINT
(("uncomp: bad U\n"));

553 
bad
;

555 
thp
->
urg_±r
 = 
	`htÚs
(
x
);

557 
thp
->
urg
 = 0;

558 if(
chªges
 & 
NEW_W
){

559 if((
x
 = 
	`decode
(&
ı
)) == -1) {

560 
	`DPRINT
(("uncomp: bad W\n"));

561 
bad
;

563 
thp
->
wšdow
 = 
	`htÚs
Ğ
	`Áohs
Ñhp->wšdowè+ 
x
);

565 if(
chªges
 & 
NEW_A
){

566 if((
x
 = 
	`decode
(&
ı
)) == -1) {

567 
	`DPRINT
(("uncomp: bad A\n"));

568 
bad
;

570 
thp
->
ack_£q
 = 
	`htÚl
Ğ
	`Áohl
Ñhp->ack_£qè+ 
x
);

572 if(
chªges
 & 
NEW_S
){

573 if((
x
 = 
	`decode
(&
ı
)) == -1) {

574 
	`DPRINT
(("uncomp: bad S\n"));

575 
bad
;

577 
thp
->
£q
 = 
	`htÚl
Ğ
	`Áohl
Ñhp->£qè+ 
x
);

581 if(
chªges
 & 
NEW_I
){

582 if((
x
 = 
	`decode
(&
ı
)) == -1) {

583 
	`DPRINT
(("uncomp: bad I\n"));

584 
bad
;

586 

->
id
 = 
	`htÚs
 (
	`Áohs
 (->idè+ 
x
);

588 

->
id
 = 
	`htÚs
 (
	`Áohs
 (ip->id) + 1);

596 
Ën
 = 
isize
 - (
ı
 - 
iı
);

597 ià(
Ën
 < 0)

598 
bad
;

599 
Ën
 +ğ
hd¾’
;

600 

->
tÙ_Ën
 = 
	`htÚs
(
Ën
);

601 

->
check
 = 0;

603 
	`DPRINT
(("uncomp: %d %d %d %d\n", 
ı
 - 
iı
, 
hd¾’
, 
isize
, 
Ën
));

605 
	`memmove
(
iı
 + 
hd¾’
, 
ı
, 
Ën
 - hdrlen);

607 
ı
 = 
iı
;

608 
	`memıy
(
ı
, 

, 20);

609 
ı
 += 20;

611 ià(

->
ihl
 > 5) {

612 
	`memıy
(
ı
, 
cs
->
cs_İt
, ((

->
ihl
) - 5) * 4);

613 
ı
 +ğ((

->
ihl
) - 5) * 4;

616 ((
hdr
 *)
iı
)->
check
 = 
	`_csum
((iphdr*)icp);

618 
	`memıy
(
ı
, 
thp
, 20);

619 
ı
 += 20;

621 ià(
thp
->
doff
 > 5) {

622 
	`memıy
(
ı
, 
cs
->
cs_tıİt
, ((
thp
->
doff
) - 5) * 4);

623 
ı
 +ğ((
thp
->
doff
) - 5) * 4;

626 ià(
š‘_debug
 =ğ
DBG_SLIP
è
	`´štk
("\runcomp: chªg%x†’ %d\n", 
chªges
, 
Ën
);

627  
Ën
;

628 
bad
:

629 
comp
->
¦s_i_”rÜ
++;

630  
	`¦hc_toss
Ğ
comp
 );

631 
	}
}

635 
	$¦hc_»memb”
(
¦com´ess
 *
comp
, *
iı
, 
isize
)

637 
c¡©e
 *
cs
;

638 
_Ën
;

639 
hdr
 *

;

640 
tıhdr
 *
thp
;

642 
šdex
;

644 if(
isize
 < 20) {

646 
comp
->
¦s_i_ruÁ
++;

647  
	`¦hc_toss
Ğ
comp
 );

650 
_Ën
 = (
iı
[0] & 0xf) << 2;

651 if(
_Ën
 < 20){

653 
comp
->
¦s_i_ruÁ
++;

654  
	`¦hc_toss
Ğ
comp
 );

656 
šdex
 = 
iı
[9];

657 
iı
[9] = 
IPPROTO_TCP
;

658 

 = (
hdr
 *è
iı
;

660 ià(
	`_csum
(

)) {

662 
comp
->
¦s_i_badcheck
++;

663  
	`¦hc_toss
Ğ
comp
 );

665 
thp
 = (
tıhdr
 *)(((*)

è+ ip->
ihl
*4);

666 if(
šdex
 > 
comp
->
r¦Ù_lim™
) {

667 
comp
->
¦s_i_”rÜ
++;

668  
	`¦hc_toss
(
comp
);

672 
cs
 = &
comp
->
r¡©e
[comp->
»cv_cu¼’t
 = 
šdex
];

673 
comp
->
æags
 &=~ 
SLF_TOSS
;

674 
	`memıy
(&
cs
->
cs_
,

,20);

675 
	`memıy
(&
cs
->
cs_tı
,
thp
,20);

676 ià(

->
ihl
 > 5)

677 
	`memıy
(
cs
->
cs_İt
, 

+1, ((->
ihl
) - 5) * 4);

678 ià(
thp
->
doff
 > 5)

679 
	`memıy
(
cs
->
cs_tıİt
, 
thp
+1, (Ñhp->
doff
) - 5) * 4);

680 
cs
->
cs_hsize
 = 

->
ihl
*2 + 
thp
->
doff
*2;

684 
comp
->
¦s_i_uncom´es£d
++;

685  
isize
;

686 
	}
}

690 
	$¦hc_toss
(
¦com´ess
 *
comp
)

692 iàĞ
comp
 =ğ
NULLSLCOMPR
 )

695 
comp
->
æags
 |ğ
SLF_TOSS
;

697 
	}
}

700 
	$¦hc_i_¡©us
(
¦com´ess
 *
comp
)

702 ià(
comp
 !ğ
NULLSLCOMPR
) {

703 
	`´štk
("\t%ld Cmp, %ld Uncmp, %ld Bad, %ld Tossed\n",

704 
comp
->
¦s_i_com´es£d
,

705 
comp
->
¦s_i_uncom´es£d
,

706 
comp
->
¦s_i_”rÜ
,

707 
comp
->
¦s_i_tos£d
);

709 
	}
}

712 
	$¦hc_o_¡©us
(
¦com´ess
 *
comp
)

714 ià(
comp
 !ğ
NULLSLCOMPR
) {

715 
	`´štk
("\t%ld Cmp, %ld Uncmp, %ld AsIs, %ld NotTCP\n",

716 
comp
->
¦s_o_com´es£d
,

717 
comp
->
¦s_o_uncom´es£d
,

718 
comp
->
¦s_o_tı
,

719 
comp
->
¦s_o_nÚtı
);

720 
	`´štk
("\t%10ld Searches, %10ld Misses\n",

721 
comp
->
¦s_o_£¬ches
,

722 
comp
->
¦s_o_mis£s
);

724 
	}
}

	@drivers/net/slhc.h

1 #iâdeà
_SLHC_H


2 
	#_SLHC_H


	)

84 
	#SL_TYPE_IP
 0x40

	)

85 
	#SL_TYPE_UNCOMPRESSED_TCP
 0x70

	)

86 
	#SL_TYPE_COMPRESSED_TCP
 0x80

	)

87 
	#SL_TYPE_ERROR
 0x00

	)

90 
	#NEW_C
 0x40

	)

91 
	#NEW_I
 0x20

	)

92 
	#NEW_S
 0x08

	)

93 
	#NEW_A
 0x04

	)

94 
	#NEW_W
 0x02

	)

95 
	#NEW_U
 0x01

	)

98 
	#SPECIAL_I
 (
NEW_S
|
NEW_W
|
NEW_U
è

	)

99 
	#SPECIAL_D
 (
NEW_S
|
NEW_A
|
NEW_W
|
NEW_U
è

	)

100 
	#SPECIALS_MASK
 (
NEW_S
|
NEW_A
|
NEW_W
|
NEW_U
)

	)

102 
	#TCP_PUSH_BIT
 0x10

	)

115 
	tby‹_t
;

116 
	tšt32
;

124 
	sc¡©e
 {

125 
by‹_t
 
	mcs_this
;

126 
c¡©e
 *
	mÃxt
;

127 
hdr
 
	mcs_
;

128 
tıhdr
 
	mcs_tı
;

129 
	mcs_İt
[64];

130 
	mcs_tıİt
[64];

131 
	mcs_hsize
;

133 
	#NULLSLSTATE
 (
c¡©e
 *)0

	)

138 
	s¦com´ess
 {

139 
c¡©e
 *
	mt¡©e
;

140 
c¡©e
 *
	mr¡©e
;

142 
by‹_t
 
	mt¦Ù_lim™
;

143 
by‹_t
 
	mr¦Ù_lim™
;

145 
by‹_t
 
	mxm™_Şde¡
;

146 
by‹_t
 
	mxm™_cu¼’t
;

147 
by‹_t
 
	m»cv_cu¼’t
;

149 
by‹_t
 
	mæags
;

150 
	#SLF_TOSS
 0x01

	)

152 
št32
 
	m¦s_o_nÚtı
;

153 
št32
 
	m¦s_o_tı
;

154 
št32
 
	m¦s_o_uncom´es£d
;

155 
št32
 
	m¦s_o_com´es£d
;

156 
št32
 
	m¦s_o_£¬ches
;

157 
št32
 
	m¦s_o_mis£s
;

159 
št32
 
	m¦s_i_uncom´es£d
;

160 
št32
 
	m¦s_i_com´es£d
;

161 
št32
 
	m¦s_i_”rÜ
;

162 
št32
 
	m¦s_i_tos£d
;

164 
št32
 
	m¦s_i_ruÁ
;

165 
št32
 
	m¦s_i_badcheck
;

167 
	#NULLSLCOMPR
 (
¦com´ess
 *)0

	)

169 
	#__ARGS
(
x
è
	)
x

172 
¦com´ess
 *
¦hc_š™
 
__ARGS
((
r¦Ùs
, 
t¦Ùs
));

173 
¦hc_ä“
 
__ARGS
((
¦com´ess
 *
comp
));

175 
¦hc_com´ess
 
__ARGS
((
¦com´ess
 *
comp
, *
iı
,

176 
isize
, *
oı
, **
ıp
,

177 
com´ess_cid
));

178 
¦hc_uncom´ess
 
__ARGS
((
¦com´ess
 *
comp
, *
iı
,

179 
isize
));

180 
¦hc_»memb”
 
__ARGS
((
¦com´ess
 *
comp
, *
iı
,

181 
isize
));

182 
¦hc_toss
 
__ARGS
((
¦com´ess
 *
comp
));

184 
¦hc_i_¡©us
 
__ARGS
((
¦com´ess
 *
comp
));

185 
¦hc_o_¡©us
 
__ARGS
((
¦com´ess
 *
comp
));

	@drivers/net/slip.c

26 
	~<asm/£gm’t.h
>

27 
	~<asm/sy¡em.h
>

29 
	~<lšux/cÚfig.h
>

30 
	~<lšux/ty³s.h
>

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/sched.h
>

33 
	~<lšux/¡ršg.h
>

34 
	~<lšux/mm.h
>

35 
	~<lšux/sock‘.h
>

36 
	~<lšux/sockios.h
>

37 
	~<lšux/š‹¼u±.h
>

38 
	~<lšux/‰y.h
>

39 
	~<lšux/”ºo.h
>

40 
	~<lšux/¡©.h
>

41 
	~<lšux/š.h
>

42 
	~"š‘.h
"

43 
	~"dev.h
"

44 #ifdeà
CONFIG_AX25


45 
	~"ax25.h
"

47 
	~"‘h.h
"

48 
	~".h
"

49 
	~"rou‹.h
"

50 
	~"´ÙocŞ.h
"

51 
	~"tı.h
"

52 
	~"skbuff.h
"

53 
	~"sock.h
"

54 
	~"¬p.h
"

55 
	~"¦.h
"

56 
	~"¦hc.h
"

58 
	#SLIP_VERSION
 "0.7.5"

	)

61 #ifdeà
SL_DUMP


62 
	#IP_VERSION
 4

	)

63 
	#IPF_F_OFFSET
 0x1ffà

	)

64 
	#IPF_DF
 0x4000

	)

65 
	#IPF_MF
 0x2000

	)

66 
	#IP_OF_COPIED
 0x80

	)

67 
	#IP_OF_CLASS
 0x60

	)

68 
	#IP_OF_NUMBER
 0x1à

	)

72 
¦
 
	g¦_ù¾
[
SL_NRUNIT
];

73 
‰y_ldisc
 
	g¦_ldisc
;

74 
	g®»ady
 = 0;

79 
	$_dump
(*
±r
, 
Ën
)

81 #ifdeà
SL_DUMP


82 
hdr
 *

;

83 
tıhdr
 *
th
;

84 
dËn
, 
doff
;

86 ià(
š‘_debug
 !ğ
DBG_SLIP
) ;

88 

 = (
hdr
 *è
±r
;

89 
th
 = (
tıhdr
 *è(
±r
 + 

->
ihl
 * 4);

90 
	`´štk
("\r%s -> %s seq %lx‡ck %lx†en %d\n",

91 
	`š_Áß
(

->
§ddr
), in_Áß(->
daddr
),

92 
	`Áohl
(
th
->
£q
),‚tohlÑh->
ack_£q
), 
	`Áohs
(

->
tÙ_Ën
));

95 
	`´štk
("\r*****\n");

96 
	`´štk
("%°%d\n", 
±r
, 
Ën
);

97 

 = (
hdr
 *è
±r
;

98 
dËn
 = 
	`Áohs
(

->
tÙ_Ën
);

99 
doff
 = ((
	`Áohs
(

->
äag_off
è& 
IPF_F_OFFSET
) << 3);

102 
	`´štk
("SLIP: %s->", 
	`š_Áß
(

->
§ddr
));

103 
	`´štk
("%s\n", 
	`š_Áß
(

->
daddr
));

104 
	`´štk
("†en %u ihl %u ver %utl %u…rot %u",

105 
dËn
, 

->
ihl
, ip->
v”siÚ
, ip->
‰l
, ip->
´ÙocŞ
);

107 ià(

->
tos
 !ğ0è
	`´štk
("os %u", ip->tos);

108 ià(
doff
 !ğ0 || (
	`Áohs
(

->
äag_off
è& 
IPF_MF
))

109 
	`´štk
(" id %u off %u", 
	`Áohs
(

->
id
), 
doff
);

111 ià(
	`Áohs
(

->
äag_off
è& 
IPF_DF
è
	`´štk
(" DF");

112 ià(
	`Áohs
(

->
äag_off
è& 
IPF_MF
è
	`´štk
(" MF");

113 
	`´štk
("\n*****\n");

115 
	}
}

118 
	$şh_dump
(*
ı
, 
Ën
)

120 ià(
Ën
 > 60)

121 
Ën
 = 60;

122 
	`´štk
("%d:", 
Ën
);

123 
Ën
 > 0) {

124 
	`´štk
(" %x", *
ı
++);

125 
Ën
--;

127 
	`´štk
("\n\n");

128 
	}
}

133 
	$¦_š™Ÿlize
(
¦
 *
¦
, 
deviû
 *
dev
)

135 
¦
->
šu£
 = 0;

136 
¦
->
£ndšg
 = 0;

137 
¦
->
esÿ³
 = 0;

138 
¦
->
æags
 = 0;

139 #ifdeà
SL_ADAPTIVE


140 
¦
->
mode
 = 
SL_MODE_ADAPTIVE
;

142 #ifdeà
SL_COMPRESSED


143 
¦
->
mode
 = 
SL_MODE_CSLIP
 | 
SL_MODE_ADAPTIVE
;

145 
¦
->
mode
 = 
SL_MODE_SLIP
;

149 
¦
->
lše
 = 
dev
->
ba£_addr
;

150 
¦
->
‰y
 = 
NULL
;

151 
¦
->
dev
 = dev;

152 
¦
->
¦comp
 = 
NULL
;

155 
¦
->
rbuff
 = 
NULL
;

156 
¦
->
xbuff
 = 
NULL
;

157 
¦
->
cbuff
 = 
NULL
;

159 
¦
->
rh—d
 = 
NULL
;

160 
¦
->
»nd
 = 
NULL
;

161 
dev
->
rmem_’d
 = (è
NULL
;

162 
dev
->
rmem_¡¬t
 = (è
NULL
;

163 
dev
->
mem_’d
 = (è
NULL
;

164 
dev
->
mem_¡¬t
 = (è
NULL
;

165 
	}
}

169 
¦
 *

170 
	$¦_fšd
(
‰y_¡ruù
 *
‰y
)

172 
¦
 *
¦
;

173 
i
;

175 ià(
‰y
 =ğ
NULL
) (NULL);

176 
i
 = 0; i < 
SL_NRUNIT
; i++) {

177 
¦
 = &
¦_ù¾
[
i
];

178 ià(
¦
->
‰y
 ==ty) (sl);

180 (
NULL
);

181 
	}
}

185 
šlše
 
¦
 *

186 
	$¦_®loc
()

188 
æags
;

189 
¦
 *
¦
;

190 
i
;

192 
	`§ve_æags
 (
æags
);

193 
	`şi
();

194 
i
 = 0; i < 
SL_NRUNIT
; i++) {

195 
¦
 = &
¦_ù¾
[
i
];

196 ià(
¦
->
šu£
 == 0) {

197 
¦
->
šu£
 = 1;

198 
¦
->
‰y
 = 
NULL
;

199 
	`»¡Üe_æags
(
æags
);

200 (
¦
);

203 
	`»¡Üe_æags
(
æags
);

204 (
NULL
);

205 
	}
}

209 
šlše
 

210 
	$¦_ä“
(
¦
 *
¦
)

212 
æags
;

214 ià(
¦
->
šu£
) {

215 
	`§ve_æags
(
æags
);

216 
	`şi
();

217 
¦
->
šu£
 = 0;

218 
¦
->
‰y
 = 
NULL
;

219 
	`»¡Üe_æags
(
æags
);

221 
	}
}

227 
	$¦_chªgedmtu
(
¦
 *
¦
)

229 
deviû
 *
dev
=
¦
->dev;

230 *
tb
,*
rb
,*
cb
,*
tf
,*
rf
,*
cf
;

231 
l
;

232 
omtu
=
¦
->
mtu
;

234 
¦
->
mtu
=
dev
->mtu;

235 
l
=(
dev
->
mtu
 *2);

241 ià(
l
 < (576 * 2))

242 
l
 = 576 * 2;

244 
	`DPRINTF
((
DBG_SLIP
,"SLIP: mtu changed!\n"));

246 
tb
ğ(*è
	`km®loc
(
l
 + 4, 
GFP_ATOMIC
);

247 
rb
ğ(*è
	`km®loc
(
l
 + 4, 
GFP_ATOMIC
);

248 
cb
ğ(*è
	`km®loc
(
l
 + 4, 
GFP_ATOMIC
);

250 if(
tb
==
NULL
 || 
rb
==NULL || 
cb
==NULL)

252 
	`´štk
("Unableo grow slip buffers. MTU change cancelled.\n");

253 
¦
->
mtu
=
omtu
;

254 
dev
->
mtu
=
omtu
;

255 if(
tb
!=
NULL
)

256 
	`kä“
(
tb
);

257 if(
rb
!=
NULL
)

258 
	`kä“
(
rb
);

259 if(
cb
!=
NULL
)

260 
	`kä“
(
cb
);

264 
	`şi
();

266 
tf
=(*)
¦
->
dev
->
mem_¡¬t
;

267 
¦
->
dev
->
mem_¡¬t
=()
tb
;

268 
¦
->
dev
->
mem_’d
=(è(¦->dev->
mem_¡¬t
 + 
l
);

269 
rf
=(*)
¦
->
dev
->
rmem_¡¬t
;

270 
¦
->
dev
->
rmem_¡¬t
=()
rb
;

271 
¦
->
dev
->
rmem_’d
=(è(¦->dev->
rmem_¡¬t
 + 
l
);

273 
¦
->
xbuff
 = (*è¦->
dev
->
mem_¡¬t
;

274 
¦
->
rbuff
 = (*è¦->
dev
->
rmem_¡¬t
;

275 
¦
->
»nd
 = (*è¦->
dev
->
rmem_’d
;

276 
¦
->
rh—d
 = sl->
rbuff
;

278 
cf
=
¦
->
cbuff
;

279 
¦
->
cbuff
=
cb
;

281 
¦
->
esÿ³
=0;

282 
¦
->
£ndšg
=0;

283 
¦
->
rcouÁ
=0;

285 
	`¡i
();

287 if(
rf
!=
NULL
)

288 
	`kä“
(
rf
);

289 if(
tf
!=
NULL
)

290 
	`kä“
(
tf
);

291 if(
cf
!=
NULL
)

292 
	`kä“
(
cf
);

293 
	}
}

297 
šlše
 

298 
	$¦_’queue
(
¦
 *
¦
, 
c
)

300 
æags
;

302 
	`§ve_æags
(
æags
);

303 
	`şi
();

304 ià(
¦
->
rh—d
 < sl->
»nd
) {

305 *
¦
->
rh—d
 = 
c
;

306 
¦
->
rh—d
++;

307 
¦
->
rcouÁ
++;

308 } 
¦
->
rov”run
++;

309 
	`»¡Üe_æags
(
æags
);

310 
	}
}

313 
šlše
 

314 
	$¦_dequeue
(
¦
 *
¦
, 
i
)

316 
æags
;

318 
	`§ve_æags
(
æags
);

319 
	`şi
();

320 ià(
¦
->
rh—d
 > sl->
rbuff
) {

321 
¦
->
rh—d
 -ğ
i
;

322 
¦
->
rcouÁ
 -ğ
i
;

324 
	`»¡Üe_æags
(
æags
);

325 
	}
}

329 
šlše
 

330 
	$¦_lock
(
¦
 *
¦
)

332 
æags
;

334 
	`§ve_æags
(
æags
);

335 
	`şi
();

336 
¦
->
£ndšg
 = 1;

337 
¦
->
dev
->
tbusy
 = 1;

338 
	`»¡Üe_æags
(
æags
);

339 
	}
}

343 
šlše
 

344 
	$¦_uÆock
(
¦
 *
¦
)

346 
æags
;

348 
	`§ve_æags
(
æags
);

349 
	`şi
();

350 
¦
->
£ndšg
 = 0;

351 
¦
->
dev
->
tbusy
 = 0;

352 
	`»¡Üe_æags
(
æags
);

353 
	}
}

358 
	$¦_bump
(
¦
 *
¦
)

360 
dÚe
;

361 
c
;

362 
æags
;

363 
couÁ
;

365 
couÁ
 = 
¦
->
rcouÁ
;

366 ià(
¦
->
mode
 & (
SL_MODE_ADAPTIVE
 | 
SL_MODE_CSLIP
)) {

367 ià((
c
 = 
¦
->
rbuff
[0]è& 
SL_TYPE_COMPRESSED_TCP
) {

370 ià(!(
¦
->
mode
 & 
SL_MODE_CSLIP
)) {

371 
	`´štk
("SLIP: compressed…acket ignored\n");

376 
	`§ve_æags
(
æags
);

377 
	`şi
();

378 ià((
¦
->
rh—d
 + 80è< sl->
»nd
) {

379 
¦
->
rh—d
 += 80;

380 
¦
->
rcouÁ
 += 80;

381 
dÚe
 = 1;

383 
¦
->
rov”run
++;

384 
dÚe
 = 0;

386 
	`»¡Üe_æags
(
æags
);

387 ià(! 
dÚe
)

390 
couÁ
 = 
	`¦hc_uncom´ess
(
¦
->
¦comp
, sl->
rbuff
, count);

391 ià(
couÁ
 <= 0) {

392 
¦
->
”rÜs
++;

395 } ià(
c
 >ğ
SL_TYPE_UNCOMPRESSED_TCP
) {

396 ià(!(
¦
->
mode
 & 
SL_MODE_CSLIP
)) {

398 
¦
->
mode
 |ğ
SL_MODE_CSLIP
;

399 
	`´štk
("SLIP: header compressionurned on\n");

401 
¦
->
rbuff
[0] &= 0x4f;

402 ià(
	`¦hc_»memb”
(
¦
->
¦comp
, sl->
rbuff
, 
couÁ
) <= 0) {

403 
¦
->
”rÜs
++;

409 
	`DPRINTF
((
DBG_SLIP
, "<< \"%s\"„ecv:\r\n", 
¦
->
dev
->
Çme
));

410 
	`_dump
(
¦
->
rbuff
, sl->
rcouÁ
);

414 
	`DPRINTF
((
DBG_SLIP
, "SLIP:…acket is %d‡t 0x%X\n",

415 
¦
->
rcouÁ
, sl->
rbuff
));

417 
dÚe
 = 
	`dev_ršt
(
¦
->
rbuff
, 
couÁ
, 0, sl->
dev
);

418 ià(
dÚe
 == 0 || done == 1) ;

421 
¦
->
½ack‘
++;

422 
	}
}

427 
	$¦_Ãxt
(
¦
 *
¦
)

429 
	`DPRINTF
((
DBG_SLIP
, "SLIP: sl_Ãxt(0x%XèÿÎed!\n", 
¦
));

430 
	`¦_uÆock
(
¦
);

431 
	`dev_tšt
(
¦
->
dev
);

432 
	}
}

437 
	$¦_’ÿps
(
¦
 *
¦
, *
iı
, 
Ën
)

439 *
bp
, *
p
;

440 
couÁ
;

442 
	`DPRINTF
((
DBG_SLIP
, "SLIP: sl_’ÿps(0x%X, %dèÿÎed\n", 
iı
, 
Ën
));

443 
	`DPRINTF
((
DBG_SLIP
, ">> \"%s\" s’t:\r\n", 
¦
->
dev
->
Çme
));

445 
	`_dump
(
iı
, 
Ën
);

447 if(
¦
->
mtu
 !ğ¦->
dev
->mtu)

448 
	`¦_chªgedmtu
(
¦
);

450 if(
Ën
>
¦
->
mtu
)

452 
Ën
=
¦
->
mtu
;

453 
	`´štk
("slip:runcating oversizedransmit…acket!\n");

456 
p
 = 
iı
;

457 if(
¦
->
mode
 & 
SL_MODE_CSLIP
)

458 
Ën
 = 
	`¦hc_com´ess
(
¦
->
¦comp
, 
p
,†’, sl->
cbuff
, &p, 1);

460 #ifdeà
OLD


466 
bp
 = 
¦
->
xbuff
;

467 *
bp
++ = 
END
;

468 
couÁ
 = 1;

474 
Ën
-- > 0) {

475 
c
 = *
p
++;

476 
c
) {

477 
END
:

478 *
bp
++ = 
ESC
;

479 *
bp
++ = 
ESC_END
;

480 
couÁ
 += 2;

482 
ESC
:

483 *
bp
++ = 
ESC
;

484 *
bp
++ = 
ESC_ESC
;

485 
couÁ
 += 2;

488 *
bp
++ = 
c
;

489 
couÁ
++;

492 *
bp
++ = 
END
;

493 
couÁ
++;

495 if(
¦
->
mode
 & 
SL_MODE_SLIP6
)

496 
couÁ
=
	`¦_esc6
(
p
, (*)
¦
->
xbuff
,
Ën
);

498 
couÁ
=
	`¦_esc
(
p
, (*)
¦
->
xbuff
,
Ën
);

500 
¦
->
¥ack‘
++;

501 
bp
 = 
¦
->
xbuff
;

504 
	`DPRINTF
((
DBG_SLIP
, "SLIP: kickšg TTY fÜ %d by‹ © 0x%X\n", 
couÁ
, 
bp
));

505 ià(
	`‰y_wr™e_d©a
(
¦
->
‰y
, (*è
bp
, 
couÁ
,

506 ((*)(*))
¦_Ãxt
, (*è
¦
) == 0) {

507 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY‡Ì—dy dÚw™h %d by‹s!\n", 
couÁ
));

508 
	`¦_Ãxt
(
¦
);

510 
	}
}

530 
	$¦_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

532 
‰y_¡ruù
 *
‰y
;

533 
¦
 *
¦
;

534 
size
;

537 
¦
 = &
¦_ù¾
[
dev
->
ba£_addr
];

538 
‰y
 = 
¦
->tty;

539 
	`DPRINTF
((
DBG_SLIP
, "SLIP: sl_xmit(\"%s\") skb=0x%X busy=%d\n",

540 
dev
->
Çme
, 
skb
, 
¦
->
£ndšg
));

547 ià(
¦
->
£ndšg
) {

548 
	`DPRINTF
((
DBG_SLIP
, "SLIP: sl_xmit: BUSY\r\n"));

549 
¦
->
sbusy
++;

554 ià(
skb
 !ğ
NULL
) {

555 #ifdeà
CONFIG_AX25


556 if(
¦
->
mode
 & 
SL_MODE_AX25
)

558 if(!
skb
->
¬p
 && 
dev
->
	`»bud_h—d”
(skb->
d©a
,dev))

560 
skb
->
dev
=dev;

561 
	`¬p_queue
(
skb
);

564 
skb
->
¬p
=1;

567 
	`¦_lock
(
¦
);

568 
size
 = 
skb
->
Ën
;

569 ià(!(
¦
->
mode
 & 
SL_MODE_AX25
)) {

570 ià(
size
 < (
hdr
)) {

571 
	`´štk
("Runt IP frame fedo slip!\n");

573 
size
 = ((
hdr
 *)(
skb
->
d©a
))->
tÙ_Ën
;

574 
size
 = 
	`Áohs
(size);

578 
	`¦_’ÿps
(
¦
, 
skb
->
d©a
, 
size
);

579 ià(
skb
->
ä“
)

580 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

583 
	}
}

587 
	$¦_ty³_Œªs
 (
sk_buff
 *
skb
, 
deviû
 *
dev
)

589 #ifdeà
CONFIG_AX25


590 
¦
 *
¦
=&
¦_ù¾
[
dev
->
ba£_addr
];

591 if(
¦
->
mode
&
SL_MODE_AX25
)

592 (
	`NET16
(
ETH_P_AX25
));

594 (
	`NET16
(
ETH_P_IP
));

595 
	}
}

600 
	$¦_h—d”
(*
buff
, 
deviû
 *
dev
, 
ty³
,

601 
daddr
, 
§ddr
, 
Ën
)

603 #ifdeà
CONFIG_AX25


604 
¦
 *
¦
=&
¦_ù¾
[
dev
->
ba£_addr
];

605 if((
¦
->
mode
&
SL_MODE_AX25
è&& 
ty³
!=
	`NET16
(
ETH_P_AX25
))

606  
	`ax25_’ÿpsuÏ‹_
(
buff
,
dev
,
ty³
,
daddr
,
§ddr
,
Ën
);

610 
	}
}

615 
	$¦_add_¬p
(
addr
, 
sk_buff
 *
skb
, 
deviû
 *
dev
)

617 #ifdeà
CONFIG_AX25


618 
¦
 *
¦
=&
¦_ù¾
[
dev
->
ba£_addr
];

620 if(
¦
->
mode
&
SL_MODE_AX25
)

621 
	`¬p_add
(
addr
,((*è
skb
->
d©a
)+8,
dev
);

623 
	}
}

628 
	$¦_»bud_h—d”
(*
buff
, 
deviû
 *
dev
)

630 #ifdeà
CONFIG_AX25


631 
¦
 *
¦
=&
¦_ù¾
[
dev
->
ba£_addr
];

633 if(
¦
->
mode
&
SL_MODE_AX25
)

634  
	`ax25_»bud_h—d”
(
buff
,
dev
);

637 
	}
}

642 
	$¦_İ’
(
deviû
 *
dev
)

644 
¦
 *
¦
;

645 *
p
;

646 
l
;

648 
¦
 = &
¦_ù¾
[
dev
->
ba£_addr
];

649 ià(
¦
->
‰y
 =ğ
NULL
) {

650 
	`DPRINTF
((
DBG_SLIP
, "SLIP: chªÃÈ%d‚Ù cÚÃùed!\n", 
¦
->
lše
));

651 (-
ENXIO
);

653 
¦
->
dev
 = dev;

663 
l
 = (
dev
->
mtu
 * 2);

669 ià(
l
 < (576 * 2))

670 
l
 = 576 * 2;

672 
p
 = (*è
	`km®loc
(
l
 + 4, 
GFP_KERNEL
);

673 ià(
p
 =ğ
NULL
) {

674 
	`DPRINTF
((
DBG_SLIP
, "SLIP:‚o memory for SLIP XMIT buffer!\n"));

675 (-
ENOMEM
);

678 
¦
->
mtu
 = 
dev
->mtu;

679 
¦
->
dev
->
mem_¡¬t
 = (è
p
;

680 
¦
->
dev
->
mem_’d
 = (è(¦->dev->
mem_¡¬t
 + 
l
);

682 
p
 = (*è
	`km®loc
(
l
 + 4, 
GFP_KERNEL
);

683 ià(
p
 =ğ
NULL
) {

684 
	`DPRINTF
((
DBG_SLIP
, "SLIP:‚o memory for SLIP RECV buffer!\n"));

685 (-
ENOMEM
);

687 
¦
->
dev
->
rmem_¡¬t
 = (è
p
;

688 
¦
->
dev
->
rmem_’d
 = (è(¦->dev->
rmem_¡¬t
 + 
l
);

690 
¦
->
xbuff
 = (*è¦->
dev
->
mem_¡¬t
;

691 
¦
->
rbuff
 = (*è¦->
dev
->
rmem_¡¬t
;

692 
¦
->
»nd
 = (*è¦->
dev
->
rmem_’d
;

693 
¦
->
rh—d
 = sl->
rbuff
;

695 
¦
->
esÿ³
 = 0;

696 
¦
->
£ndšg
 = 0;

697 
¦
->
rcouÁ
 = 0;

699 
p
 = (*è
	`km®loc
(
l
 + 4, 
GFP_KERNEL
);

700 ià(
p
 =ğ
NULL
) {

701 
	`kä“
((*)
¦
->
dev
->
mem_¡¬t
);

702 
	`DPRINTF
((
DBG_SLIP
, "SLIP:‚o memory for SLIP COMPRESS buffer!\n"));

703 (-
ENOMEM
);

705 
¦
->
cbuff
 = 
p
;

707 
¦
->
¦comp
 = 
	`¦hc_š™
(16, 16);

708 ià(
¦
->
¦comp
 =ğ
NULL
) {

709 
	`kä“
((*)
¦
->
dev
->
mem_¡¬t
);

710 
	`kä“
((*)
¦
->
dev
->
rmem_¡¬t
);

711 
	`kä“
(
¦
->
cbuff
);

712 
	`DPRINTF
((
DBG_SLIP
, "SLIP:‚o memory for SLCOMP!\n"));

713 (-
ENOMEM
);

716 
dev
->
æags
|=
IFF_UP
;

718 if(
dev
->
·_addr
==0)

719 
dev
->
·_addr
=
	`Áohl
(0xC0000001);

720 
	`DPRINTF
((
DBG_SLIP
, "SLIP: chªÃÈ%d o³Ãd.\n", 
¦
->
lše
));

722 
	}
}

727 
	$¦_şo£
(
deviû
 *
dev
)

729 
¦
 *
¦
;

731 
¦
 = &
¦_ù¾
[
dev
->
ba£_addr
];

732 ià(
¦
->
‰y
 =ğ
NULL
) {

733 
	`DPRINTF
((
DBG_SLIP
, "SLIP: chªÃÈ%d‚Ù cÚÃùed!\n", 
¦
->
lše
));

734 (-
EBUSY
);

736 
	`¦_ä“
(
¦
);

739 
	`kä“
(
¦
->
rbuff
);

740 
	`kä“
(
¦
->
xbuff
);

741 
	`kä“
(
¦
->
cbuff
);

742 
	`¦hc_ä“
(
¦
->
¦comp
);

744 
	`¦_š™Ÿlize
(
¦
, 
dev
);

746 
	`DPRINTF
((
DBG_SLIP
, "SLIP: chªÃÈ%d clo£d.\n", 
¦
->
lše
));

748 
	}
}

758 
	$¦_»cv
(
‰y_¡ruù
 *
‰y
)

760 
buff
[128];

761 *
p
;

762 
¦
 *
¦
;

763 
couÁ
, 
”rÜ
=0;

765 
	`DPRINTF
((
DBG_SLIP
, "SLIP: sl_»cv(%dèÿÎed\n", 
‰y
->
lše
));

766 ià((
¦
 = 
	`¦_fšd
(
‰y
)è=ğ
NULL
) ;

768 if(
¦
->
mtu
!=¦->
dev
->mtu)

769 
	`¦_chªgedmtu
(
¦
);

773 
couÁ
 = 
	`‰y_»ad_¿w_d©a
(
‰y
, 
buff
, 128);

774 ià(
couÁ
 <= 0)

776 
couÁ
= - count;

777 if(
couÁ
)

778 
”rÜ
=1;

781 
p
 = 
buff
;

782 #ifdeà
OLD


783 
couÁ
--) {

784 
c
 = *
p
++;

785 ià(
¦
->
esÿ³
) {

786 ià(
c
 =ğ
ESC_ESC
)

787 
	`¦_’queue
(
¦
, 
ESC
);

788 ià(
c
 =ğ
ESC_END
)

789 
	`¦_’queue
(
¦
, 
END
);

791 
	`´štk
 ("SLIP:„eceived wrong character\n");

792 
¦
->
esÿ³
 = 0;

794 ià(
c
 =ğ
ESC
)

795 
¦
->
esÿ³
 = 1;

796 ià(
c
 =ğ
END
) {

797 ià(
¦
->
rcouÁ
 > 2è
	`¦_bump
(sl);

798 
	`¦_dequeue
(
¦
, sl->
rcouÁ
);

799 
¦
->
rcouÁ
 = 0;

800 } 
	`¦_’queue
(
¦
, 
c
);

804 if(
¦
->
mode
 & 
SL_MODE_SLIP6
)

805 
	`¦_uÃsc6
(
¦
,
buff
,
couÁ
,
”rÜ
);

807 
	`¦_uÃsc
(
¦
,
buff
,
couÁ
,
”rÜ
);

811 
	}
}

822 
	$¦_İ’
(
‰y_¡ruù
 *
‰y
)

824 
¦
 *
¦
;

827 ià((
¦
 = 
	`¦_fšd
(
‰y
)è!ğ
NULL
) {

828 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY %d‡lready connectedo %s !\n",

829 
‰y
->
lše
, 
¦
->
dev
->
Çme
));

830 (-
EEXIST
);

834 ià((
¦
 = 
	`¦_®loc
()è=ğ
NULL
) {

835 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY %d‚ot connected:‡ll channels in use!\n",

836 
‰y
->
lše
));

837 (-
ENFILE
);

839 
¦
->
‰y
 =ty;

840 
	`‰y_»ad_æush
(
‰y
);

841 
	`‰y_wr™e_æush
(
‰y
);

844 (è
	`¦_İ’
(
¦
->
dev
);

845 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY %d connectedo %s.\n",

846 
‰y
->
lše
, 
¦
->
dev
->
Çme
));

849 (
¦
->
lše
);

850 
	}
}

853 
’‘_¡©i¡ics
 *

854 
	$¦_g‘_¡©s
(
deviû
 *
dev
)

856 
’‘_¡©i¡ics
 
¡©s
;

857 
¦
 *
¦
;

858 
¦com´ess
 *
comp
;

861 
¦
 = &
¦_ù¾
[
dev
->
ba£_addr
];

862 ià(! 
¦
)

863  
NULL
;

865 
	`mem£t
(&
¡©s
, 0, (
’‘_¡©i¡ics
));

867 
¡©s
.
rx_·ck‘s
 = 
¦
->
½ack‘
;

868 
¡©s
.
rx_ov”_”rÜs
 = 
¦
->
rov”run
;

869 
¡©s
.
tx_·ck‘s
 = 
¦
->
¥ack‘
;

870 
¡©s
.
tx_drİ³d
 = 
¦
->
sbusy
;

871 
¡©s
.
rx_”rÜs
 = 
¦
->
”rÜs
;

873 
comp
 = 
¦
->
¦comp
;

874 ià(
comp
) {

875 
¡©s
.
rx_fifo_”rÜs
 = 
comp
->
¦s_i_com´es£d
;

876 
¡©s
.
rx_drİ³d
 = 
comp
->
¦s_i_tos£d
;

877 
¡©s
.
tx_fifo_”rÜs
 = 
comp
->
¦s_o_com´es£d
;

878 
¡©s
.
cŞlisiÚs
 = 
comp
->
¦s_o_mis£s
;

881  (&
¡©s
);

882 
	}
}

891 
	$¦_şo£
(
‰y_¡ruù
 *
‰y
)

893 
¦
 *
¦
;

896 ià((
¦
 = 
	`¦_fšd
(
‰y
)è=ğ
NULL
) {

897 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY %d‚Ù cÚÃùed !\n", 
‰y
->
lše
));

901 (è
	`dev_şo£
(
¦
->
dev
);

902 
	`DPRINTF
((
DBG_SLIP
, "SLIP: TTY %d disconnected from %s.\n",

903 
‰y
->
lše
, 
¦
->
dev
->
Çme
));

904 
	}
}

914 
	$¦_esc
(*
s
, *
d
, 
Ën
)

916 
couÁ
 = 0;

924 
d
[
couÁ
++] = 
END
;

931 
Ën
-- > 0) {

932 *
s
) {

933 
END
:

934 
d
[
couÁ
++] = 
ESC
;

935 
d
[
couÁ
++] = 
ESC_END
;

937 
ESC
:

938 
d
[
couÁ
++] = 
ESC
;

939 
d
[
couÁ
++] = 
ESC_ESC
;

942 
d
[
couÁ
++] = *
s
;

944 ++
s
;

946 
d
[
couÁ
++] = 
END
;

947 (
couÁ
);

948 
	}
}

951 
	$¦_uÃsc
(
¦
 *
¦
, *
s
, 
couÁ
, 
”rÜ
)

953 
i
;

955 
i
 = 0; i < 
couÁ
; ++i, ++
s
) {

956 *
s
) {

957 
ESC
:

958 
¦
->
æags
 |ğ
SLF_ESCAPE
;

960 
ESC_ESC
:

961 ià(
¦
->
æags
 & 
SLF_ESCAPE
)

962 
	`¦_’queue
(
¦
, 
ESC
);

964 
	`¦_’queue
(
¦
, *
s
);

965 
¦
->
æags
 &ğ~
SLF_ESCAPE
;

967 
ESC_END
:

968 ià(
¦
->
æags
 & 
SLF_ESCAPE
)

969 
	`¦_’queue
(
¦
, 
END
);

971 
	`¦_’queue
(
¦
, *
s
);

972 
¦
->
æags
 &ğ~
SLF_ESCAPE
;

974 
END
:

975 ià(
¦
->
rcouÁ
 > 2)

976 
	`¦_bump
(
¦
);

977 
	`¦_dequeue
(
¦
, sl->
rcouÁ
);

978 
¦
->
rcouÁ
 = 0;

979 
¦
->
æags
 &ğ~(
SLF_ESCAPE
 | 
SLF_ERROR
);

982 
	`¦_’queue
(
¦
, *
s
);

983 
¦
->
æags
 &ğ~
SLF_ESCAPE
;

986 ià(
”rÜ
)

987 
¦
->
æags
 |ğ
SLF_ERROR
;

988 
	}
}

997 
	$¦_esc6
(*
s
, *
d
, 
Ën
)

999 
couÁ
 = 0;

1000 
i
;

1001 
v
 = 0;

1002 
b™s
 = 0;

1010 
d
[
couÁ
++] = 0x70;

1016 
i
 = 0; i < 
Ën
; ++i) {

1017 
v
 = (v << 8è| 
s
[
i
];

1018 
b™s
 += 8;

1019 
b™s
 >= 6) {

1020 
c
;

1022 
b™s
 -= 6;

1023 
c
 = 0x30 + ((
v
 >> 
b™s
) & 0x3F);

1024 
d
[
couÁ
++] = 
c
;

1027 ià(
b™s
) {

1028 
c
;

1030 
c
 = 0x30 + ((
v
 << (6 - 
b™s
)) & 0x3F);

1031 
d
[
couÁ
++] = 
c
;

1033 
d
[
couÁ
++] = 0x70;

1034 (
couÁ
);

1035 
	}
}

1038 
	$¦_uÃsc6
(
¦
 *
¦
, *
s
, 
couÁ
, 
”rÜ
)

1040 
i
;

1041 
c
;

1043 
i
 = 0; i < 
couÁ
; ++i, ++
s
) {

1044 ià(*
s
 == 0x70) {

1045 ià(
¦
->
rcouÁ
 > 8) {

1046 #ifdeà
NOTDEF


1047 
	`´štk
("rbuff %02x %02x %02x %02x\n",

1048 
¦
->
rbuff
[0],

1049 
¦
->
rbuff
[1],

1050 
¦
->
rbuff
[2],

1051 
¦
->
rbuff
[3]

1054 
	`¦_bump
(
¦
);

1056 
	`¦_dequeue
(
¦
, sl->
rcouÁ
);

1057 
¦
->
rcouÁ
 = 0;

1058 
¦
->
æags
 &ğ~(
SLF_ESCAPE
 | 
SLF_ERROR
);

1059 
¦
->
xb™s
 = 0;

1060 } ià(*
s
 >= 0x30 && *s < 0x70) {

1061 
¦
->
xd©a
 = (¦->xd©¨<< 6è| ((*
s
 - 0x30) & 0x3F);

1062 
¦
->
xb™s
 += 6;

1063 ià(
¦
->
xb™s
 >= 8) {

1064 
¦
->
xb™s
 -= 8;

1065 
c
 = ()(
¦
->
xd©a
 >> sl->
xb™s
);

1066 
	`¦_’queue
(
¦
, 
c
);

1071 ià(
”rÜ
)

1072 
¦
->
æags
 |ğ
SLF_ERROR
;

1073 
	}
}

1076 #ifdeà
CONFIG_AX25


1078 
	$¦_£t_mac_add»ss
(
deviû
 *
dev
, *
addr
)

1080 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
addr
,7);

1081 if(
”r
)

1082  
”r
;

1083 
	`memıy_äomfs
(
dev
->
dev_addr
,
addr
,7);

1085 
	}
}

1091 
	$¦_ioùl
(
‰y_¡ruù
 *
‰y
, *
fe
, 
cmd
, *
¬g
)

1093 
¦
 *
¦
;

1094 
”r
;

1097 ià((
¦
 = 
	`¦_fšd
(
‰y
)è=ğ
NULL
) {

1098 
	`DPRINTF
((
DBG_SLIP
, "SLIP: ioùl: TTY %d‚Ù cÚÃùed !\n", 
‰y
->
lše
));

1099 (-
EINVAL
);

1102 
	`DPRINTF
((
DBG_SLIP
, "SLIP: ioùl(%d, 0x%X, 0x%X)\n", 
‰y
->
lše
, 
cmd
, 
¬g
));

1103 
cmd
) {

1104 
SIOCGIFNAME
:

1105 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
¬g
, 16);

1106 if(
”r
)

1107  -
”r
;

1108 
	`memıy_tofs
(
¬g
, 
¦
->
dev
->
Çme
, 
	`¡¾’
(sl->dev->name) + 1);

1110 
SIOCGIFENCAP
:

1111 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
¬g
,());

1112 
	`put_fs_lÚg
(
¦
->
mode
,(*)
¬g
);

1114 
SIOCSIFENCAP
:

1115 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
¬g
,());

1116 
¦
->
mode
=
	`g‘_fs_lÚg
((*)
¬g
);

1117 #ifdeà
CONFIG_AX25


1118 if(
¦
->
mode
 & 
SL_MODE_AX25
)

1120 
¦
->
dev
->
addr_Ën
=7;

1121 
¦
->
dev
->
h¬d_h—d”_Ën
=17;

1122 
¦
->
dev
->
ty³
=3;

1126 
¦
->
dev
->
addr_Ën
=0;

1127 
¦
->
dev
->
h¬d_h—d”_Ën
=0;

1128 
¦
->
dev
->
ty³
=0;

1132 
SIOCSIFHWADDR
:

1133 #ifdeà
CONFIG_AX25


1134  
	`¦_£t_mac_add»ss
(
¦
->
dev
,
¬g
);

1137 (-
EINVAL
);

1139 (-
EINVAL
);

1140 
	}
}

1145 
	$¦_š™
(
deviû
 *
dev
)

1147 
¦
 *
¦
;

1148 
i
;

1149 #ifdeà
CONFIG_AX25


1150 
ax25_bÿ¡
[7]={'Q'<<1,'S'<<1,'T'<<1,' '<<1,' '<<1,' '<<1,'0'<<1};

1151 
ax25_‹¡
[7]={'L'<<1,'I'<<1,'N'<<1,'U'<<1,'X'<<1,' '<<1,'1'<<1};

1154 
¦
 = &
¦_ù¾
[
dev
->
ba£_addr
];

1156 ià(
®»ady
++ == 0) {

1157 
	`´štk
("SLIP: version %s (%d channels)\n",

1158 
SLIP_VERSION
, 
SL_NRUNIT
);

1159 
	`´štk
("CSLIP: code copyright 1989 Regents ofhe University of California\n");

1160 #ifdeà
CONFIG_AX25


1161 
	`´štk
("AX25: KISSƒncapsulationƒnabled\n");

1164 
¦_ldisc
.
æags
 = 0;

1165 
¦_ldisc
.
İ’
 = 
¦_İ’
;

1166 
¦_ldisc
.
şo£
 = 
¦_şo£
;

1167 
¦_ldisc
.
»ad
 = 
NULL
;

1168 
¦_ldisc
.
wr™e
 = 
NULL
;

1169 
¦_ldisc
.
ioùl
 = ((*)(
‰y_¡ruù
 *, 
fe
 *,

1170 , )è
¦_ioùl
;

1171 
¦_ldisc
.
£Ëù
 = 
NULL
;

1172 
¦_ldisc
.
hªdËr
 = 
¦_»cv
;

1173 ià((
i
 = 
	`‰y_»gi¡”_ldisc
(
N_SLIP
, &
¦_ldisc
)) != 0)

1174 
	`´štk
("ERROR: %d\n", 
i
);

1178 
	`¦_š™Ÿlize
(
¦
, 
dev
);

1181 
¦
->
rcouÁ
 = 0;

1182 
¦
->
½ack‘
 = 0;

1183 
¦
->
rov”run
 = 0;

1184 
¦
->
¥ack‘
 = 0;

1185 
¦
->
sbusy
 = 0;

1186 
¦
->
”rÜs
 = 0;

1189 
dev
->
mtu
 = 
SL_MTU
;

1190 
dev
->
h¬d_¡¬t_xm™
 = 
¦_xm™
;

1191 
dev
->
İ’
 = 
¦_İ’
;

1192 
dev
->
¡İ
 = 
¦_şo£
;

1193 
dev
->
h¬d_h—d”
 = 
¦_h—d”
;

1194 
dev
->
add_¬p
 = 
¦_add_¬p
;

1195 
dev
->
ty³_Œªs
 = 
¦_ty³_Œªs
;

1196 
dev
->
g‘_¡©s
 = 
¦_g‘_¡©s
;

1197 #ifdeà
HAVE_SET_MAC_ADDR


1198 #ifdeà
CONFIG_AX25


1199 
dev
->
£t_mac_add»ss
 = 
¦_£t_mac_add»ss
;

1202 
dev
->
h¬d_h—d”_Ën
 = 0;

1203 
dev
->
addr_Ën
 = 0;

1204 
dev
->
ty³
 = 0;

1205 #ifdeà
CONFIG_AX25


1206 
	`memıy
(
dev
->
brßdÿ¡
,
ax25_bÿ¡
,7);

1207 
	`memıy
(
dev
->
dev_addr
,
ax25_‹¡
,7);

1209 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

1210 
dev
->
»bud_h—d”
 = 
¦_»bud_h—d”
;

1211 
i
 = 0; i < 
DEV_NUMBUFFS
; i++)

1212 
dev
->
buffs
[
i
] = 
NULL
;

1215 
dev
->
æags
 = 0;

1216 
dev
->
çmy
 = 
AF_INET
;

1217 
dev
->
·_addr
 = 0;

1218 
dev
->
·_brdaddr
 = 0;

1219 
dev
->
·_mask
 = 0;

1220 
dev
->
·_®’
 = ();

1223 
	}
}

	@drivers/net/slip.h

15 #iâdeà
_LINUX_SLIP_H


16 
	#_LINUX_SLIP_H


	)

19 
	#SL_NRUNIT
 4

	)

20 
	#SL_MTU
 296

	)

23 
	#END
 0300

	)

24 
	#ESC
 0333

	)

25 
	#ESC_END
 0334

	)

26 
	#ESC_ESC
 0335

	)

29 
	s¦
 {

31 
	mšu£
;

32 
	m£ndšg
;

33 
	mesÿ³
;

34 
	munu£d
;

37 
	mlše
;

38 
‰y_¡ruù
 *
	m‰y
;

39 
deviû
 *
	mdev
;

40 
¦com´ess
 *
	m¦comp
;

43 *
	mrbuff
;

44 *
	mxbuff
;

45 *
	mcbuff
;

48 *
	mrh—d
;

49 *
	m»nd
;

50 
	mrcouÁ
;

53 
	m½ack‘
;

54 
	mrov”run
;

55 
	m¥ack‘
;

56 
	msbusy
;

57 
	m”rÜs
;

59 
	mmtu
;

60 
	mæags
;

61 
	#SLF_ESCAPE
 2

	)

62 
	#SLF_ERROR
 4

	)

63 
	#SLF_COMP
 16

	)

64 
	#SLF_EXPN
 32

	)

65 
	mmode
;

66 
	#SL_MODE_SLIP
 0

	)

67 
	#SL_MODE_CSLIP
 1

	)

68 
	#SL_MODE_SLIP6
 2

	)

69 
	#SL_MODE_CSLIP6
 (
SL_MODE_SLIP6
|
SL_MODE_CSLIP
)

	)

70 
	#SL_MODE_AX25
 4

	)

71 
	#SL_MODE_ADAPTIVE
 8

	)

72 
	mxd©a
,
	mxb™s
;

76 
¦_š™
(
deviû
 *
dev
);

77 
¦_esc
(*
s
, *
d
, 
Ën
);

78 
¦_esc6
(*
s
, *
d
, 
Ën
);

79 
¦_uÃsc
(
¦
 *
¦
, *
s
, 
couÁ
, 
”rÜ
);

80 
¦_uÃsc6
(
¦
 *
¦
, *
s
, 
couÁ
, 
”rÜ
);

	@drivers/net/smc-ultra.c

16 *
	gv”siÚ
 =

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/¡ršg.h
>

24 
	~<asm/io.h
>

25 
	~<asm/sy¡em.h
>

27 
	~"dev.h
"

28 
	~"8390.h
"

31 #iâdeà
HAVE_PORTRESERVE


32 
	#check_»giÚ
(
ißddr
, 
size
è0

	)

33 
	#¢¬f_»giÚ
(
ißddr
, 
size
); dØ; 0)

	)

36 
uÉ¿´obe
(
ißddr
, 
deviû
 *
dev
);

37 
uÉ¿´obe1
(
ißddr
, 
deviû
 *
dev
);

39 
uÉ¿_İ’
(
deviû
 *
dev
);

40 
uÉ¿_»£t_8390
(
deviû
 *
dev
);

41 
uÉ¿_block_šput
(
deviû
 *
dev
, 
couÁ
,

42 *
buf
, 
ršg_off£t
);

43 
uÉ¿_block_ouut
(
deviû
 *
dev
, 
couÁ
,

44 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
);

45 
uÉ¿_şo£_ÿrd
(
deviû
 *
dev
);

48 
	#START_PG
 0x00

	)

50 
	#ULTRA_CMDREG
 0

	)

51 
	#ULTRA_RESET
 0x80

	)

52 
	#ULTRA_MEMENB
 0x40

	)

53 
	#ULTRA_NIC_OFFSET
 16

	)

60 
	$uÉ¿_´obe
(
deviû
 *
dev
)

62 *
pÜt
, 
pÜts
[] = {0x200, 0x220, 0x240, 0x280, 0x300, 0x340, 0x380, 0};

63 
ißddr
 = 
dev
->
ba£_addr
;

65 ià(
ißddr
 > 0x1ff)

66  
	`uÉ¿´obe1
(
ißddr
, 
dev
);

67 ià(
ißddr
 > 0)

68  
ENXIO
;

70 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

71 ià(
	`check_»giÚ
(*
pÜt
, 32))

73 ià((
	`šb
(*
pÜt
 + 7) & 0xF0) == 0x20

74 && 
	`uÉ¿´obe1
(*
pÜt
, 
dev
) == 0)

77 
dev
->
ba£_addr
 = 
ißddr
;

78  
ENODEV
;

79 
	}
}

81 
	$uÉ¿´obe1
(
ißddr
, 
deviû
 *
dev
)

83 
i
;

84 *
¡©iÚ_addr
 = 
dev
->
dev_addr
;

85 
checksum
 = 0;

86 *
mod–_Çme
;

87 
“´om_œq
 = 0;

89 
num_·ges
, 
œq»g
, 
addr
, 
»g4
 = 
	`šb
(
ißddr
 + 4) & 0x7f;

93 
	`outb
(
»g4
, 
ißddr
 + 4);

95 
i
 = 0; i < 8; i++)

96 
checksum
 +ğ
	`šb
(
ißddr
 + 8 + 
i
);

97 ià((
checksum
 & 0xff) != 0xFF)

98  
ENODEV
;

100 
	`´štk
("%s: SMC UÉ¿‡ˆ%#3x,", 
dev
->
Çme
, 
ißddr
);

101 
i
 = 0; i < 6; i++)

102 
	`´štk
(" %2.2X", 
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + 8 + i));

106 
	`outb
(0x80 | 
»g4
, 
ißddr
 + 4);

109 
	`outb
(0x80 | 
	`šb
(
ißddr
 + 0x0c), ioaddr + 0x0c);

110 
œq»g
 = 
	`šb
(
ißddr
 + 0xd);

111 
addr
 = 
	`šb
(
ißddr
 + 0xb);

115 
	`outb
(
»g4
, 
ißddr
 + 4);

117 
mod–_Çme
 = "SMC Ultra";

119 ià(
dev
->
œq
 < 2) {

120 
œqm­
[] = {0, 9, 3, 5, 7, 10, 11, 15};

121 
œq
;

124 
œq
 = 
œqm­
[((
œq»g
 & 0x40) >> 4) + ((irqreg & 0x0c) >> 2)];

126 ià(
œq
 == 0) {

127 
	`´štk
(", failedo detect IRQ†ine.\n");

128  -
EAGAIN
;

130 
dev
->
œq
 = irq;

131 
“´om_œq
 = 1;

136 
	`¢¬f_»giÚ
(
ißddr
, 32);

139 
dev
->
ba£_addr
 = 
ißddr
+
ULTRA_NIC_OFFSET
;

142 
addr_tbl
[4] = {0x0C0000, 0x0E0000, 0xFC0000, 0xFE0000};

143 
num_·ges_tbl
[4] = {0x20, 0x40, 0x80, 0xff};

145 
dev
->
mem_¡¬t
 = ((
addr
 & 0x0fè<< 13è+ 
addr_tbl
[(addr >> 6) & 3] ;

146 
num_·ges
 = 
num_·ges_tbl
[(
addr
 >> 4) & 3];

149 
	`‘hdev_š™
(
dev
);

151 
ei_¡©us
.
Çme
 = 
mod–_Çme
;

152 
ei_¡©us
.
wÜd16
 = 1;

153 
ei_¡©us
.
tx_¡¬t_·ge
 = 
START_PG
;

154 
ei_¡©us
.
rx_¡¬t_·ge
 = 
START_PG
 + 
TX_PAGES
;

155 
ei_¡©us
.
¡İ_·ge
 = 
num_·ges
;

157 
dev
->
rmem_¡¬t
 = dev->
mem_¡¬t
 + 
TX_PAGES
*256;

158 
dev
->
mem_’d
 = dev->
rmem_’d


159 ğ
dev
->
mem_¡¬t
 + (
ei_¡©us
.
¡İ_·ge
 - 
START_PG
)*256;

161 
	`´štk
(",% IRQ %d memÜy %#lx-%#lx.\n", 
“´om_œq
 ? "" : "assigned ",

162 
dev
->
œq
, dev->
mem_¡¬t
, dev->
mem_’d
-1);

163 ià(
ei_debug
 > 0)

164 
	`´štk
(
v”siÚ
);

166 
ei_¡©us
.
»£t_8390
 = &
uÉ¿_»£t_8390
;

167 
ei_¡©us
.
block_šput
 = &
uÉ¿_block_šput
;

168 
ei_¡©us
.
block_ouut
 = &
uÉ¿_block_ouut
;

169 
dev
->
İ’
 = &
uÉ¿_İ’
;

170 
dev
->
¡İ
 = &
uÉ¿_şo£_ÿrd
;

171 
	`NS8390_š™
(
dev
, 0);

174 
	}
}

177 
	$uÉ¿_İ’
(
deviû
 *
dev
)

179 
ißddr
 = 
dev
->
ba£_addr
 - 
ULTRA_NIC_OFFSET
;

181 ià(
	`œqaùiÚ
(
dev
->
œq
, &
ei_sigaùiÚ
))

182  -
EAGAIN
;

184 
	`outb
(
ULTRA_MEMENB
, 
ißddr
);

185 
	`outb
(0x80, 
ißddr
 + 5);

186 
	`outb
(0x01, 
ißddr
 + 6);

187  
	`ei_İ’
(
dev
);

188 
	}
}

191 
	$uÉ¿_»£t_8390
(
deviû
 *
dev
)

193 
cmd_pÜt
 = 
dev
->
ba£_addr
 - 
ULTRA_NIC_OFFSET
;

195 
	`outb
(
ULTRA_RESET
, 
cmd_pÜt
);

196 ià(
ei_debug
 > 1è
	`´štk
("»£‰šg UÉ¿,=%ld...", 
jiff›s
);

197 
ei_¡©us
.
txšg
 = 0;

199 
	`outb
(
ULTRA_MEMENB
, 
cmd_pÜt
);

201 ià(
ei_debug
 > 1è
	`´štk
("reset done\n");

203 
	}
}

209 
	$uÉ¿_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
, 
ršg_off£t
)

211 *
xãr_¡¬t
 = (*)(
dev
->
mem_¡¬t
 + 
ršg_off£t


212 - (
START_PG
<<8));

214 ià(
xãr_¡¬t
 + 
couÁ
 > (*è
dev
->
rmem_’d
) {

216 
£mi_couÁ
 = (*)
dev
->
rmem_’d
 - 
xãr_¡¬t
;

217 
	`memıy
(
buf
, 
xãr_¡¬t
, 
£mi_couÁ
);

218 
couÁ
 -ğ
£mi_couÁ
;

219 
	`memıy
(
buf
 + 
£mi_couÁ
, (*)
dev
->
rmem_¡¬t
, 
couÁ
);

220  
dev
->
rmem_¡¬t
 + 
couÁ
;

222 
	`memıy
(
buf
, 
xãr_¡¬t
, 
couÁ
);

224  
ršg_off£t
 + 
couÁ
;

225 
	}
}

228 
	$uÉ¿_block_ouut
(
deviû
 *
dev
, 
couÁ
, cÚ¡ *
buf
,

229 
¡¬t_·ge
)

231 *
shmem


232 ğ(*)
dev
->
mem_¡¬t
 + ((
¡¬t_·ge
 - 
START_PG
)<<8);

234 
	`memıy
(
shmem
, 
buf
, 
couÁ
);

236 
	}
}

239 
	$uÉ¿_şo£_ÿrd
(
deviû
 *
dev
)

241 
ißddr
 = 
dev
->
ba£_addr
 - 
ULTRA_NIC_OFFSET
;

243 
dev
->
¡¬t
 = 0;

244 
dev
->
tbusy
 = 1;

246 ià(
ei_debug
 > 1)

247 
	`´štk
("%s: Shu‰šg dowÀ‘h”ÿrd.\n", 
dev
->
Çme
);

249 
	`outb
(0x00, 
ißddr
 + 6);

250 
	`ä“_œq
(
dev
->
œq
);

251 
œq2dev_m­
[
dev
->
œq
] = 0;

253 
	`NS8390_š™
(
dev
, 0);

259 
	}
}

	@drivers/net/wd.c

17 *
	gv”siÚ
 =

20 
	~<lšux/cÚfig.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/”ºo.h
>

24 
	~<lšux/¡ršg.h
>

25 
	~<asm/io.h
>

26 
	~<asm/sy¡em.h
>

28 
	~"dev.h
"

29 
	~"8390.h
"

32 #iâdeà
HAVE_PORTRESERVE


33 
	#check_»giÚ
(
ißddr
, 
size
è0

	)

34 
	#¢¬f_»giÚ
(
ißddr
, 
size
èdØ; 0)

	)

37 
wd_´obe
(
deviû
 *
dev
);

38 
wd´obe1
(
ißddr
, 
deviû
 *
dev
);

40 
wd_İ’
(
deviû
 *
dev
);

41 
wd_»£t_8390
(
deviû
 *
dev
);

42 
wd_block_šput
(
deviû
 *
dev
, 
couÁ
,

43 *
buf
, 
ršg_off£t
);

44 
wd_block_ouut
(
deviû
 *
dev
, 
couÁ
,

45 cÚ¡ *
buf
, cÚ¡ 
¡¬t_·ge
);

46 
wd_şo£_ÿrd
(
deviû
 *
dev
);

49 
	#WD_START_PG
 0x00

	)

50 
	#WD03_STOP_PG
 0x20

	)

51 
	#WD13_STOP_PG
 0x40

	)

53 
	#WD_CMDREG
 0

	)

54 
	#WD_RESET
 0x80

	)

55 
	#WD_MEMENB
 0x40

	)

56 
	#WD_CMDREG5
 5

	)

57 
	#ISA16
 0x80

	)

58 
	#NIC16
 0x40

	)

59 
	#WD_NIC_OFFSET
 16

	)

69 
	$wd_´obe
(
deviû
 *
dev
)

71 *
pÜt
, 
pÜts
[] = {0x300, 0x280, 0x380, 0x240, 0};

72 
ißddr
 = 
dev
->
ba£_addr
;

74 ià(
ißddr
 < 0)

75  
ENXIO
;

76 ià(
ißddr
 > 0x100)

77  ! 
	`wd´obe1
(
ißddr
, 
dev
);

79 
pÜt
 = &
pÜts
[0]; *port;…ort++) {

80 ià(
	`check_»giÚ
(*
pÜt
, 32))

82 ià(
	`šb
(*
pÜt
 + 8) != 0xff

83 && 
	`šb
(*
pÜt
 + 9) != 0xff

84 && 
	`wd´obe1
(*
pÜt
, 
dev
))

87 
dev
->
ba£_addr
 = 
ißddr
;

88  
ENODEV
;

89 
	}
}

91 
	$wd´obe1
(
ißddr
, 
deviû
 *
dev
)

93 
i
;

94 *
¡©iÚ_addr
 = 
dev
->
dev_addr
;

95 
checksum
 = 0;

96 
ªc›Á
 = 0;

97 
wÜd16
 = 0;

98 *
mod–_Çme
;

100 
i
 = 0; i < 8; i++)

101 
checksum
 +ğ
	`šb
(
ißddr
 + 8 + 
i
);

102 ià((
checksum
 & 0xff) != 0xFF)

105 
	`´štk
("%s: WD80x3‡ˆ%#3x, ", 
dev
->
Çme
, 
ißddr
);

106 
i
 = 0; i < 6; i++)

107 
	`´štk
(" %2.2X", 
¡©iÚ_addr
[
i
] = 
	`šb
(
ißddr
 + 8 + i));

114 ià(
	`šb
(
ißddr
+0) == 'P' && inb(ioaddr+1) == 'D') {

115 
»g5
 = 
	`šb
(
ißddr
+5);

117 
	`šb
(
ißddr
+2)) {

118 0x03: 
wÜd16
 = 0; 
mod–_Çme
 = "PDI8023-8"; ;

119 0x05: 
wÜd16
 = 0; 
mod–_Çme
 = "PDUC8023"; ;

120 0x0a: 
wÜd16
 = 1; 
mod–_Çme
 = "PDI8023-16"; ;

122 : 
wÜd16
 = 0; 
mod–_Çme
 = "PDI8023"; ;

124 
dev
->
mem_¡¬t
 = ((
»g5
 & 0x1c) + 0xc0) << 12;

125 
dev
->
œq
 = (
»g5
 & 0xe0) == 0xe0 ? 10 : (reg5 >> 5) + 1;

133 
i
 = 0; i < 6; i++)

134 ià(
	`šb
(
ißddr
+
i
) != inb(ioaddr+8+i))

136 ià(
i
 >= 6) {

137 
ªc›Á
 = 1;

138 
mod–_Çme
 = "WD8003-old";

139 
wÜd16
 = 0;

141 
tmp
 = 
	`šb
(
ißddr
+1);

142 
	`outb
Ğ
tmp
 ^ 0x01, 
ißddr
+1 );

143 ià(((
	`šb
Ğ
ißddr
+1) & 0x01) == 0x01)

144 && (
tmp
 & 0x01) == 0x01 ) {

145 
asic_»g5
 = 
	`šb
(
ißddr
+
WD_CMDREG5
);

147 
	`outb
Ğ
NIC16
 | (
asic_»g5
&0x1f), 
ißddr
+
WD_CMDREG5
);

148 
	`outb
(
tmp
, 
ißddr
+1);

149 
mod–_Çme
 = "WD8013";

150 
wÜd16
 = 1;

152 
mod–_Çme
 = "WD8003";

153 
wÜd16
 = 0;

155 
	`outb
(
tmp
, 
ißddr
+1);

157 #iâdeà
fš®_v”siÚ


158 iàĞ!
ªc›Á
 && (
	`šb
(
ißddr
+1è& 0x01è!ğ(
wÜd16
 & 0x01))

159 
	`´štk
("\nWD80?3: Bus width conflict, %d (probe) != %d (reg„eport).",

160 
wÜd16
 ? 16 : 8, (
	`šb
(
ißddr
+1) & 0x01) ? 16 : 8);

164 #ià
	`defšed
(
WD_SHMEM
) && WD_SHMEM > 0x80000

166 
dev
->
mem_¡¬t
 = 
WD_SHMEM
;

168 ià(
dev
->
mem_¡¬t
 == 0) {

170 
»g0
 = 
	`šb
(
ißddr
);

171 ià(
»g0
 == 0xff ||„eg0 == 0) {

173 
dev
->
mem_¡¬t
 = 0xd0000;

174 
	`´štk
("‡ssignšg‡dd»s %#lx", 
dev
->
mem_¡¬t
);

176 
high_addr_b™s
 = 
	`šb
(
ißddr
+
WD_CMDREG5
) & 0x1f;

178 ià(
high_addr_b™s
 =ğ0x1à|| 
wÜd16
 == 0)

179 
high_addr_b™s
 = 0x01;

180 
dev
->
mem_¡¬t
 = ((
»g0
&0x3fè<< 13è+ (
high_addr_b™s
 << 19);

186 
dev
->
ba£_addr
 = 
ißddr
+
WD_NIC_OFFSET
;

188 ià(
dev
->
œq
 < 2) {

189 
œqm­
[] = {9,3,5,7,10,11,15,4};

190 
»g1
 = 
	`šb
(
ißddr
+1);

191 
»g4
 = 
	`šb
(
ißddr
+4);

192 ià(
ªc›Á
 || 
»g1
 == 0xff) {

193 
nic_addr
 = 
ißddr
+
WD_NIC_OFFSET
;

198 
	`outb_p
(
E8390_NODMA
 + 
E8390_STOP
, 
nic_addr
);

199 
	`outb
(0x00, 
nic_addr
+
EN0_IMR
);

200 
	`autoœq_£tup
(0);

201 
	`outb_p
(0xff, 
nic_addr
 + 
EN0_IMR
);

202 
	`outb_p
(0x00, 
nic_addr
 + 
EN0_RCNTLO
);

203 
	`outb_p
(0x00, 
nic_addr
 + 
EN0_RCNTHI
);

204 
	`outb
(
E8390_RREAD
+
E8390_START
, 
nic_addr
);

205 
dev
->
œq
 = 
	`autoœq_»pÜt
(2);

206 
	`outb_p
(0x00, 
nic_addr
+
EN0_IMR
);

208 ià(
ei_debug
 > 2)

209 
	`´štk
("‡utoœq i %d", 
dev
->
œq
);

210 ià(
dev
->
œq
 < 2)

211 
dev
->
œq
 = 
wÜd16
 ? 10 : 5;

213 
dev
->
œq
 = 
œqm­
[((
»g4
 >> 5è& 0x03è+ (
»g1
 & 0x04)];

214 } ià(
dev
->
œq
 == 2)

215 
dev
->
œq
 = 9;

219 ià(
	`œqaùiÚ
 (
dev
->
œq
, &
ei_sigaùiÚ
)) {

220 
	`´štk
 (" uÇbËØg‘ IRQ %d.\n", 
dev
->
œq
);

225 
	`¢¬f_»giÚ
(
ißddr
, 32);

226 
	`‘hdev_š™
(
dev
);

228 
ei_¡©us
.
Çme
 = 
mod–_Çme
;

229 
ei_¡©us
.
wÜd16
 = word16;

230 
ei_¡©us
.
tx_¡¬t_·ge
 = 
WD_START_PG
;

231 
ei_¡©us
.
rx_¡¬t_·ge
 = 
WD_START_PG
 + 
TX_PAGES
;

232 
ei_¡©us
.
¡İ_·ge
 = 
wÜd16
 ? 
WD13_STOP_PG
 : 
WD03_STOP_PG
;

235 
dev
->
rmem_¡¬t
 = dev->
mem_¡¬t
 + 
TX_PAGES
*256;

236 
dev
->
mem_’d
 = dev->
rmem_’d


237 ğ
dev
->
mem_¡¬t
 + (
ei_¡©us
.
¡İ_·ge
 - 
WD_START_PG
)*256;

239 
	`´štk
(" %s, IRQ %d, shared memory‡t %#lx-%#lx.\n",

240 
mod–_Çme
, 
dev
->
œq
, dev->
mem_¡¬t
, dev->
mem_’d
-1);

241 ià(
ei_debug
 > 0)

242 
	`´štk
(
v”siÚ
);

244 
ei_¡©us
.
»£t_8390
 = &
wd_»£t_8390
;

245 
ei_¡©us
.
block_šput
 = &
wd_block_šput
;

246 
ei_¡©us
.
block_ouut
 = &
wd_block_ouut
;

247 
dev
->
İ’
 = &
wd_İ’
;

248 
dev
->
¡İ
 = &
wd_şo£_ÿrd
;

249 
	`NS8390_š™
(
dev
, 0);

251  
dev
->
ba£_addr
;

252 
	}
}

255 
	$wd_İ’
(
deviû
 *
dev
)

257 
ißddr
 = 
dev
->
ba£_addr
 - 
WD_NIC_OFFSET
;

261 
ei_¡©us
.
»g0
 = ((
dev
->
mem_¡¬t
>>13è& 0x3fè| 
WD_MEMENB
;

262 
ei_¡©us
.
»g5
 = ((
dev
->
mem_¡¬t
>>19è& 0x1fè| 
NIC16
;

264 ià(
ei_¡©us
.
wÜd16
)

265 
	`outb
(
ei_¡©us
.
»g5
, 
ißddr
+
WD_CMDREG5
);

266 
	`outb
(
ei_¡©us
.
»g0
, 
ißddr
);

268  
	`ei_İ’
(
dev
);

269 
	}
}

272 
	$wd_»£t_8390
(
deviû
 *
dev
)

274 
wd_cmd_pÜt
 = 
dev
->
ba£_addr
 - 
WD_NIC_OFFSET
;

276 
	`outb
(
WD_RESET
, 
wd_cmd_pÜt
);

277 ià(
ei_debug
 > 1è
	`´štk
("»£‰šghWD80x3=%lu...", 
jiff›s
);

278 
ei_¡©us
.
txšg
 = 0;

281 
	`outb
((((
dev
->
mem_¡¬t
>>13è& 0x3f)|
WD_MEMENB
), 
wd_cmd_pÜt
);

282 ià(
ei_¡©us
.
wÜd16
)

283 
	`outb
(
NIC16
 | ((
dev
->
mem_¡¬t
>>19è& 0x1f), 
wd_cmd_pÜt
+
WD_CMDREG5
);

285 ià(
ei_debug
 > 1è
	`´štk
("reset done\n");

287 
	}
}

295 
	$wd_block_šput
(
deviû
 *
dev
, 
couÁ
, *
buf
, 
ršg_off£t
)

297 
wd_cmd»g
 = 
dev
->
ba£_addr
 - 
WD_NIC_OFFSET
;

298 
xãr_¡¬t
 = 
dev
->
mem_¡¬t
 + 
ršg_off£t
 - (
WD_START_PG
<<8);

302 ià(
couÁ
 == 4) {

303 ià(
ei_¡©us
.
wÜd16
)

304 
	`outb
(
ISA16
 | 
ei_¡©us
.
»g5
, 
wd_cmd»g
+
WD_CMDREG5
);

305 ((*)
buf
)[0] = ((*)
xãr_¡¬t
)[0];

309 ià(
xãr_¡¬t
 + 
couÁ
 > 
dev
->
rmem_’d
) {

311 
£mi_couÁ
 = 
dev
->
rmem_’d
 - 
xãr_¡¬t
;

312 
	`memıy
(
buf
, (*)
xãr_¡¬t
, 
£mi_couÁ
);

313 
couÁ
 -ğ
£mi_couÁ
;

314 
	`memıy
(
buf
 + 
£mi_couÁ
, (*)
dev
->
rmem_¡¬t
, 
couÁ
);

316 
	`memıy
(
buf
, (*)
xãr_¡¬t
, 
couÁ
);

319 ià(
ei_¡©us
.
wÜd16
)

320 
	`outb
(
ei_¡©us
.
»g5
, 
wd_cmd»g
+
WD_CMDREG5
);

323 
	}
}

326 
	$wd_block_ouut
(
deviû
 *
dev
, 
couÁ
, cÚ¡ *
buf
,

327 
¡¬t_·ge
)

329 
wd_cmd»g
 = 
dev
->
ba£_addr
 - 
WD_NIC_OFFSET
;

330 
shmem
 = 
dev
->
mem_¡¬t
 + ((
¡¬t_·ge
 - 
WD_START_PG
)<<8);

333 ià(
ei_¡©us
.
wÜd16
) {

335 
	`outb
(
ISA16
 | 
ei_¡©us
.
»g5
, 
wd_cmd»g
+
WD_CMDREG5
);

336 
	`memıy
((*)
shmem
, 
buf
, 
couÁ
);

337 
	`outb
(
ei_¡©us
.
»g5
, 
wd_cmd»g
+
WD_CMDREG5
);

339 
	`memıy
((*)
shmem
, 
buf
, 
couÁ
);

340 
	}
}

344 
	$wd_şo£_ÿrd
(
deviû
 *
dev
)

346 
wd_cmd»g
 = 
dev
->
ba£_addr
 - 
WD_NIC_OFFSET
;

348 ià(
ei_debug
 > 1)

349 
	`´štk
("%s: Shu‰šg dowÀ‘h”ÿrd.\n", 
dev
->
Çme
);

350 
	`NS8390_š™
(
dev
, 0);

353 
	`outb
(
ei_¡©us
.
»g5
, 
wd_cmd»g
 + 
WD_CMDREG5
 );

356 
	`outb
(
ei_¡©us
.
»g0
 & ~
WD_MEMENB
, 
wd_cmd»g
);

359 
	}
}

	@drivers/scsi/NCR5380.c

68 #iâdeà
nÙy‘


69 #undeà
LINKED


70 #undeà
USLEEP


71 #undeà
REAL_DMA


74 #ifdeà
REAL_DMA_POLL


75 #undeà
READ_OVERRUNS


76 
	#READ_OVERRUNS


	)

281 
Scsi_Ho¡
 *
	gfœ¡_š¡ªû
 = 
NULL
;

282 
Scsi_Ho¡_Tem¶©e
 *
	gthe_‹m¶©e
 = 
NULL
;

293 
__šlše__
 
	$š™Ÿlize_SCp
(
Scsi_Cmnd
 *
cmd
) {

299 ià(
cmd
->
u£_sg
) {

300 
cmd
->
SCp
.
bufãr
 = (
sÿ‰”li¡
 *) cmd->buffer;

301 
cmd
->
SCp
.
bufãrs_»sidu®
 = cmd->
u£_sg
 - 1;

302 
cmd
->
SCp
.
±r
 = (*ècmd->SCp.
bufãr
->
add»ss
;

303 
cmd
->
SCp
.
this_»sidu®
 = cmd->SCp.
bufãr
->
Ëngth
;

305 
cmd
->
SCp
.
bufãr
 = 
NULL
;

306 
cmd
->
SCp
.
bufãrs_»sidu®
 = 0;

307 
cmd
->
SCp
.
±r
 = (*ècmd->
»que¡_bufãr
;

308 
cmd
->
SCp
.
this_»sidu®
 = cmd->
»que¡_bufæ’
;

310 
	}
}

312 
	~<lšux/d–ay.h
>

314 #ifdeà
NDEBUG


316 
	mmask
;

317 * 
	mÇme
;}

318 
	gsigÇls
[] = {{ 
SR_DBP
, "PARITY"}, { 
SR_RST
, "RST" }, { 
SR_BSY
, "BSY" },

319 { 
SR_REQ
, "REQ" }, { 
SR_MSG
, "MSG" }, { 
SR_CD
, "CD" }, { 
SR_IO
, "IO" },

320 { 
SR_SEL
, "SEL" }, {0, 
NULL
}},

321 
	gba¤s
[] = {{
BASR_ATN
, "ATN"}, {
BASR_ACK
, "ACK"}, {0, 
NULL
}},

322 
	giüs
[] = {{
ICR_ASSERT_RST
, "ASSERT RST"},{
ICR_ASSERT_ACK
, "ASSERT ACK"},

323 {
ICR_ASSERT_BSY
, "ASSERT BSY"}, {
ICR_ASSERT_SEL
, "ASSERT SEL"},

324 {
ICR_ASSERT_ATN
, "ASSERT ATN"}, {
ICR_ASSERT_DATA
, "ASSERT DATA"},

325 {0, 
NULL
}},

326 
	gmrs
[] = {{
MR_BLOCK_DMA_MODE
, "MODE BLOCK DMA"}, {
MR_TARGET
, "MODE TARGET"},

327 {
MR_ENABLE_PAR_CHECK
, "MODE PARITY CHECK"}, {
MR_ENABLE_PAR_INTR
,

328 "MODE PARITY INTR"}, {
MR_MONITOR_BSY
, "MODE MONITOR BSY"},

329 {
MR_DMA_MODE
, "MODE DMA"}, {
MR_ARBITRATE
, "MODE ARBITRATION"},

330 {0, 
NULL
}};

340 
	$NCR5380_´št
(
Scsi_Ho¡
 *
š¡ªû
) {

341 
	`NCR5380_loÿl_deş¬e
();

342 
¡©us
, 
d©a
, 
ba¤
, 
mr
, 
iü
, 
i
;

343 
	`NCR5380_£tup
(
š¡ªû
);

344 
	`şi
();

345 
d©a
 = 
	`NCR5380_»ad
(
CURRENT_SCSI_DATA_REG
);

346 
¡©us
 = 
	`NCR5380_»ad
(
STATUS_REG
);

347 
mr
 = 
	`NCR5380_»ad
(
MODE_REG
);

348 
iü
 = 
	`NCR5380_»ad
(
INITIATOR_COMMAND_REG
);

349 
ba¤
 = 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
);

350 
	`¡i
();

351 
i
 = 0; 
sigÇls
[i].
mask
 ; ++i)

352 ià(
¡©us
 & 
sigÇls
[
i
].
mask
)

353 
	`´štk
(" %s", 
sigÇls
[
i
].
Çme
);

354 
i
 = 0; 
ba¤s
[i].
mask
 ; ++i)

355 ià(
ba¤
 & 
ba¤s
[
i
].
mask
)

356 
	`´štk
(" %s", 
ba¤s
[
i
].
Çme
);

357 
i
 = 0; 
iüs
[i].
mask
; ++i)

358 ià(
iü
 & 
iüs
[
i
].
mask
)

359 
	`´štk
(" %s", 
iüs
[
i
].
Çme
);

360 
i
 = 0; 
mrs
[i].
mask
; ++i)

361 ià(
mr
 & 
mrs
[
i
].
mask
)

362 
	`´štk
(" %s", 
mrs
[
i
].
Çme
);

363 
	`´štk
("\n");

364 
	}
}

367 
	mv®ue
;

368 *
	mÇme
;

369 } 
	gpha£s
[] = {

370 {
PHASE_DATAOUT
, "DATAOUT"}, {
PHASE_DATAIN
, "DATAIN"}, {
PHASE_CMDOUT
, "CMDOUT"},

371 {
PHASE_STATIN
, "STATIN"}, {
PHASE_MSGOUT
, "MSGOUT"}, {
PHASE_MSGIN
, "MSGIN"},

372 {
PHASE_UNKNOWN
, "UNKNOWN"}};

382 
	$NCR5380_´št_pha£
(
Scsi_Ho¡
 *
š¡ªû
) {

383 
	`NCR5380_loÿl_deş¬e
();

384 
¡©us
;

385 
i
;

386 
	`NCR5380_£tup
(
š¡ªû
);

388 
¡©us
 = 
	`NCR5380_»ad
(
STATUS_REG
);

389 ià(!(
¡©us
 & 
SR_REQ
))

390 
	`´štk
("scsi%d : REQ‚ot‡sserted,…hase unknown.\n",

391 
š¡ªû
->
ho¡_no
);

393 
i
 = 0; (
pha£s
[i].
v®ue
 !ğ
PHASE_UNKNOWN
) &&

394 (
pha£s
[
i
].
v®ue
 !ğ(
¡©us
 & 
PHASE_MASK
)); ++i);

395 
	`´štk
("scsi%d :…ha£ %s\n", 
š¡ªû
->
ho¡_no
, 
pha£s
[
i
].
Çme
);

397 
	}
}

419 vŞ©
	gmaš_ruÂšg
 = 0;

431 
__šlše__
 
	$run_maš
() {

432 
	`şi
();

433 ià(!
maš_ruÂšg
) {

434 
maš_ruÂšg
 = 1;

435 
	`NCR5380_maš
();

440 
	`¡i
();

442 
	`¡i
();

443 
	}
}

445 #ifdeà
USLEEP


446 #iâdeà
NCR5380_TIMER


460 #iâdeà
USLEEP_SLEEP


462 
	#USLEEP_SLEEP
 2

	)

465 #iâdeà
USLEEP_POLL


466 
	#USLEEP_POLL
 20

	)

469 
Scsi_Ho¡
 * 
	gexpœes_fœ¡
 = 
NULL
;

493 
	$should_discÚÃù
 (
cmd
) {

494 
cmd
) {

495 
READ_6
:

496 
WRITE_6
:

497 
SEEK_6
:

498 
READ_10
:

499 
WRITE_10
:

500 
SEEK_10
:

501  
DISCONNECT_TIME_TO_DATA
;

502 
FORMAT_UNIT
:

503 
SEARCH_HIGH
:

504 
SEARCH_LOW
:

505 
SEARCH_EQUAL
:

506  
DISCONNECT_LONG
;

508  
DISCONNECT_NONE
;

510 
	}
}

516 
	$NCR5380_£t_tim”
 (
Scsi_Ho¡
 *
š¡ªû
) {

517 
Scsi_Ho¡
 *
tmp
, **
´ev
;

519 
	`şi
();

520 ià(((
NCR5380_ho¡d©a
 *è(
š¡ªû
->
ho¡_d©a
))->
Ãxt_tim”
) {

521 
	`¡i
();

525 
´ev
 = &
expœes_fœ¡
, 
tmp
 =ƒxpires_first;mp;

526 
´ev
 = &(((
NCR5380_ho¡d©a
 *è
tmp
->
ho¡_d©a
)->
Ãxt_tim”
),

527 
tmp
 = ((
NCR5380_ho¡d©a
 *ètmp->
ho¡_d©a
)->
Ãxt_tim”
)

528 ià(
š¡ªû
->
time_expœes
 < 
tmp
->time_expires)

531 
š¡ªû
->
Ãxt_tim”
 = 
tmp
;

532 *
´ev
 = 
š¡ªû
;

533 
tim”_bË
[
NCR5380_TIMER
].
expœes
 = 
expœes_fœ¡
->
time_expœes
;

534 
tim”_aùive
 |ğ1 << 
NCR5380_TIMER
;

535 
¡i
;

537 
	}
}

540 
	$NCR5380_tim”_â
() {

541 
Scsi_Ho¡
 *
š¡ªû
;

542 
	`şi
();

543 ; 
expœes_fœ¡
 &&ƒxpœes_fœ¡->
time_expœes
 >ğ
jiff›s
; ) {

544 
š¡ªû
 = ((
NCR5380_ho¡d©a
 *è
expœes_fœ¡
->
ho¡_d©a
)->

545 
expœes_Ãxt
;

546 ((
NCR5380_ho¡d©a
 *è
expœes_fœ¡
->
ho¡_d©a
)->
expœes_Ãxt
 =

547 
NULL
;

548 ((
NCR5380_ho¡d©a
 *è
expœes_fœ¡
->
ho¡_d©a
)->
time_expœes
 =

550 
expœes_fœ¡
 = 
š¡ªû
;

553 ià(
expœes_fœ¡
) {

554 
tim”_bË
[
NCR5380_TIMER
].
expœes
 = ((
NCR5380_ho¡d©a
 *)

555 
expœes_fœ¡
->
ho¡_d©a
)->
time_expœes
;

556 
tim”_aùive
 |ğ(1 << 
NCR5380_TIMER
);

558 
tim”_bË
[
NCR5380_TIMER
].
expœes
 = 0;

559 
tim”_aùive
 &ğ~(1 << 
MCR5380_TIMER
);

561 
	`¡i
();

563 
	`run_maš
();

564 
	}
}

567 
	$NCR5380_®l_š™
 () {

568 
dÚe
 = 0;

569 ià(!
dÚe
) {

570 #ià(
NDEBUG
 & 
NDEBUG_INIT
)

571 
	`´štk
("scsi : NCR5380_all_init()\n");

573 
dÚe
 = 1;

574 #ifdeà
USLEEP


575 
tim”_bË
[
NCR5380_TIMER
].
expœes
 = 0;

576 
tim”_bË
[
NCR5380_TIMER
].
â
 = 
NCR5380_tim”_â
;

579 
	}
}

581 #ifdeà
AUTOPROBE_IRQ


596 
	g´obe_œq
;

597 
	$´obe_šŒ
 (
sig
) {

598 
´obe_œq
 = 
sig
;

599 
	}
};

600 
sigaùiÚ
 
	g´obe_sigaùiÚ
 = { 
´obe_šŒ
, 0, 
SA_INTERRUPT
,

601 
NULL
};

603 
	$NCR5380_´obe_œq
 (
Scsi_Ho¡
 *
š¡ªû
, 
possibË
) {

604 
	`NCR5380_loÿl_deş¬e
();

605 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

606 
š¡ªû
->
ho¡d©a
;

607 
timeout
;

608 
Œyšg_œqs
, 
i
, 
mask
;

609 
	`NCR5380_£tup
(
š¡ªû
);

611 
Œyšg_œqs
 = 
i
 = 0, 
mask
 = 1; i < 16; ++i, mask <<= 1)

612 ià((
mask
 & 
possibË
è&& (
	`œqaùiÚ
 (
i
, &
´obe_sigaùiÚ
)

614 
Œyšg_œqs
 |ğ
mask
;

616 
timeout
 = 
jiff›s
 + 25;

617 
´obe_œq
 = 
IRQ_NONE
;

629 
	`NCR5380_wr™e
(
TARGET_COMMAND_REG
, 0);

630 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 
ho¡d©a
->
id_mask
);

631 
	`NCR5380_wr™e
(
OUTPUT_DATA_REG
, 
ho¡d©a
->
id_mask
);

632 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_DATA
 |

633 
ICR_ASSERT_SEL
);

635 
´obe_œq
 =ğ
IRQ_NONE
 && 
jiff›s
 < 
timeout
);

637 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 0);

638 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

640 
i
 = 0, 
mask
 = 1; i < 16; ++i, mask <<= 1)

641 ià(
Œyšg_œqs
 & 
mask
)

642 
	`ä“_œq
(
i
);

644  
´obe_œq
;

645 
	}
}

657 
	$NCR5380_´št_İtiÚs
 (
Scsi_Ho¡
 *
š¡ªû
) {

658 
	`´štk
(" generic options"

659 #ifdeà
AUTOPROBE_IRQ


662 #ifdeà
AUTOSENSE


665 #ifdeà
DIFFERENTIAL


668 #ifdeà
REAL_DMA


671 #ifdeà
REAL_DMA_POLL


674 #ifdeà
PARITY


677 #ifdeà
PSEUDO_DMA


680 #ifdeà
SCSI2


683 #ifdeà
UNSAFE


687 #ifdeà
USLEEP


688 
	`´štk
(" USLEEP, USLEEP_POLL=%d USLEEP_SLEEP=%d", 
USLEEP_POLL
, 
USLEEP_SLEEP
);

690 
	`´štk
(" g’”iø»Ëa£=%d", 
NCR5380_PUBLIC_RELEASE
);

691 
	}
}

706 
	$NCR5380_š™
 (
Scsi_Ho¡
 *
š¡ªû
) {

707 
	`NCR5380_loÿl_deş¬e
();

708 
i
;

709 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

710 
š¡ªû
->
ho¡d©a
;

711 
	`NCR5380_£tup
(
š¡ªû
);

713 
	`NCR5380_®l_š™
();

715 
ho¡d©a
->
id_mask
 = 1 << 
š¡ªû
->
this_id
;

716 
i
 = 
ho¡d©a
->
id_mask
; i <= 0x80; i <<= 1)

717 ià(
i
 > 
ho¡d©a
->
id_mask
)

718 
ho¡d©a
->
id_high”_mask
 |ğ
i
;

719 
i
 = 0; i < 8; ++i)

720 
ho¡d©a
->
busy
[
i
] = 0;

721 #ifdeà
REAL_DMA


722 
ho¡d©a
->
dm®’
 = 0;

724 
ho¡d©a
->
cÚÃùed
 = 
NULL
;

725 
ho¡d©a
->
issue_queue
 = 
NULL
;

726 
ho¡d©a
->
discÚÃùed_queue
 = 
NULL
;

727 
ho¡d©a
->
æags
 = 
FLAG_CHECK_LAST_BYTE_SENT
;

729 ià(!
the_‹m¶©e
) {

730 
the_‹m¶©e
 = 
š¡ªû
->
ho¡t
;

731 
fœ¡_š¡ªû
 = 
š¡ªû
;

735 #ifdeà
USLEEP


736 
ho¡d©a
->
time_expœes
 = 0;

737 
ho¡d©a
->
Ãxt_tim”
 = 
NULL
;

740 #iâdeà
AUTOSENSE


741 ià((
š¡ªû
->
cmd_³r_lun
 > 1è|| in¡ªû->
ÿn_queue
 > 1))

742 
	`´štk
("scsi%d : WARNING : support for multiple outstanding commandsƒnabled\n"

744 " bšcÜ»ùly cË¬ed.\n", 
š¡ªû
->
ho¡_no
);

747 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

748 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

749 
	`NCR5380_wr™e
(
TARGET_COMMAND_REG
, 0);

750 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 0);

751 
	}
}

772 #iâdeà
NCR5380_queue_commªd


775 
NCR5380_queue_commªd
 (
Scsi_Cmnd
 *
cmd
, (*
dÚe
)(Scsi_Cmnd *)) {

776 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

777 
cmd
->
ho¡
->
ho¡d©a
;

778 
Scsi_Cmnd
 *
tmp
;

780 #ià(
NDEBUG
 & 
NDEBUG_NO_WRITE
)

781 
cmd
->
cmnd
[0]) {

782 
WRITE
:

783 
WRITE_10
:

784 
	`´štk
("scsi%d : WRITE‡ttempted with NO_WRITE debugging flag set\n",

785 
š¡ªû
->
ho¡_no
);

786 
cmd
->
»suÉ
 = (
DID_ERROR
 << 16);

787 
	`dÚe
(
cmd
);

798 
cmd
->
ho¡_süibbË
 = 
NULL
;

799 
cmd
->
scsi_dÚe
 = 
dÚe
;

801 
cmd
->
»suÉ
 = 0;

811 
	`şi
();

812 ià(!(
ho¡d©a
->
issue_queue
è|| (
cmd
->
cmnd
[0] =ğ
REQUEST_SENSE
)) {

813 
cmd
->
ho¡_süibbË
 = (*è
ho¡d©a
->
issue_queue
;

814 
ho¡d©a
->
issue_queue
 = 
cmd
;

816 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
issue_queue
;mp->
ho¡_süibbË
;

817 
tmp
 = (
Scsi_Cmnd
 *ètmp->
ho¡_süibbË
);

818 
tmp
->
ho¡_süibbË
 = (*è
cmd
;

820 #ià(
NDEBUG
 & 
NDEBUG_QUEUES
)

821 
	`´štk
("scsi%d : commªd‡ddedØ% oàqueue\n", 
š¡ªû
->
ho¡_no
,

822 (
cmd
->
cmnd
[0] =ğ
REQUEST_SENSE
) ? "head" : "tail");

826 
	`run_maš
();

828 
	}
}

842 
	$NCR5380_maš
 () {

843 
Scsi_Cmnd
 *
tmp
, *
´ev
;

844 
Scsi_Ho¡
 *
š¡ªû
;

845 
NCR5380_ho¡d©a
 *
ho¡d©a
;

846 
dÚe
;

861 
	`şi
();

862 
dÚe
 = 1;

863 
š¡ªû
 = 
fœ¡_š¡ªû
; in¡ªû && in¡ªû->
ho¡t
 =ğ
the_‹m¶©e
;

864 
š¡ªû
=š¡ªû->
Ãxt
) {

865 
ho¡d©a
 = (
NCR5380_ho¡d©a
 *è
š¡ªû
->hostdata;

866 
	`şi
();

867 ià(!
ho¡d©a
->
cÚÃùed
) {

868 #ià(
NDEBUG
 & 
NDEBUG_MAIN
)

869 
	`´štk
("scsi%d :‚Ù cÚÃùed\n", 
š¡ªû
->
ho¡_no
);

875 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
issue_queue
,

876 
´ev
 = 
NULL
; 
tmp
;…»v =mp,m°ğ(
Scsi_Cmnd
 *)

877 
tmp
->
ho¡_süibbË
)

880 ià(!(
ho¡d©a
->
busy
[
tmp
->
rg‘
] & (1 <<mp->
lun
))) {

881 ià(
´ev
)

882 
´ev
->
ho¡_süibbË
 = 
tmp
->host_scribble;

884 
ho¡d©a
->
issue_queue
 = (
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
;

885 
tmp
->
ho¡_süibbË
 = 
NULL
;

888 
	`¡i
();

896 #ià(
NDEBUG
 & (
NDEBUG_MAIN
 | 
NDEBUG_QUEUES
))

897 
	`´štk
("scsi%d : main() : command forarget %d†un %d„emoved from issue_queue\n",

898 
š¡ªû
->
ho¡_no
, 
tmp
->
rg‘
,mp->
lun
);

907 ià(!
	`NCR5380_£Ëù
(
š¡ªû
, 
tmp
,

908 (
tmp
->
cmnd
[0] =ğ
REQUEST_SENSE
è? 
TAG_NONE
 :

909 
TAG_NEXT
)) {

912 
	`şi
();

913 
tmp
->
ho¡_süibbË
 = (*)

914 
ho¡d©a
->
issue_queue
;

915 
ho¡d©a
->
issue_queue
 = 
tmp
;

916 
	`¡i
();

917 #ià(
NDEBUG
 & (
NDEBUG_MAIN
 | 
NDEBUG_QUEUES
))

918 
	`´štk
("scsi%d : main(): select() failed,„eturnedo issue_queue\n",

919 
š¡ªû
->
ho¡_no
);

925 ià(
ho¡d©a
->
cÚÃùed


926 #ifdeà
REAL_DMA


927 && !
ho¡d©a
->
dm®’


929 #ifdeà
USLEEP


930 && (!
ho¡d©a
->
time_expœes
 || ho¡d©a->time_expœe >ğ
jiff›s
)

933 
	`¡i
();

934 #ià(
NDEBUG
 & 
NDEBUG_MAIN
)

935 
	`´štk
("scsi%d : main() :…erforming informationransfer\n",

936 
š¡ªû
->
ho¡_no
);

938 
	`NCR5380_šfÜm©iÚ_Œªsãr
(
š¡ªû
);

939 #ià(
NDEBUG
 & 
NDEBUG_MAIN
)

940 
	`´štk
("scsi%d : maš(è: dÚ£ˆçl£\n", 
š¡ªû
->
ho¡_no
);

942 
dÚe
 = 0;

946 } !
dÚe
);

947 
maš_ruÂšg
 = 0;

948 
	}
}

961 
	$NCR5380_šŒ
 (
œq
) {

962 
	`NCR5380_loÿl_deş¬e
();

963 
Scsi_Ho¡
 *
š¡ªû
;

964 
dÚe
;

965 
ba¤
;

966 #ià(
NDEBUG
 & 
NDEBUG_INTR
)

967 
	`´štk
("scs˜: NCR5380 irq %drigg”ed\n", 
œq
);

970 
dÚe
 = 1;

971 
š¡ªû
 = 
fœ¡_š¡ªû
; in¡ªû && (š¡ªû->
ho¡t
 ==

972 
the_‹m¶©e
); 
š¡ªû
 = in¡ªû->
Ãxt
)

973 ià(
š¡ªû
->
œq
 == irq) {

976 
	`NCR5380_£tup
(
š¡ªû
);

977 
ba¤
 = 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
);

979 ià(
ba¤
 & 
BASR_IRQ
) {

980 #ià(
NDEBUG
 & 
NDEBUG_INTR
)

981 
	`NCR5380_´št
(
š¡ªû
);

983 ià((
	`NCR5380_»ad
(
STATUS_REG
è& (
SR_SEL
 | 
SR_IO
)) ==

984 (
SR_SEL
 | 
SR_IO
)) {

985 
dÚe
 = 0;

986 
	`¡i
();

987 #ià(
NDEBUG
 & 
NDEBUG_INTR
)

988 
	`´štk
("scsi%d : SEL iÁ”ru±\n", 
š¡ªû
->
ho¡_no
);

990 
	`NCR5380_»£Ëù
(
š¡ªû
);

991 (è
	`NCR5380_»ad
(
RESET_PARITY_INTERRUPT_REG
);

992 } ià(
ba¤
 &

993 
BASR_PARITY_ERROR
) {

994 #ià(
NDEBUG
 & 
NDEBUG_INTR
)

995 
	`´štk
("scsi%d : PARITY iÁ”ru±\n", 
š¡ªû
->
ho¡_no
);

997 (è
	`NCR5380_»ad
(
RESET_PARITY_INTERRUPT_REG
);

1004 #ià
	`defšed
(
REAL_DMA
)

1011 ià((
	`NCR5380_»ad
(
MODE_REG
è& 
MR_DMA
è&& ((
ba¤
 &

1012 
BASR_END_DMA_TRANSFER
) ||

1013 !(
ba¤
 & 
BASR_PHASE_MATCH
))) {

1014 
Œªsã»d
;

1016 ià(!
ho¡d©a
->
cÚÃùed
)

1017 
	`·nic
("scsi%d :„ecievedƒnd of DMA interrupt with‚o connected cmd\n",

1018 
š¡ªû
->
ho¡no
);

1020 
Œªsã»d
 = (
ho¡d©a
->
dm®’
 - 
	`NCR5380_dma_»sidu®
(
š¡ªû
));

1021 
ho¡d©a
->
cÚÃùed
->
SCp
.
this_»sidu®
 -ğ
Œªsã¼ed
;

1022 
ho¡d©a
->
cÚÃùed
->
SCp
.
±r
 +ğ
Œªsã¼ed
;

1023 
ho¡d©a
->
dm®’
 = 0;

1025 (è
	`NCR5380_»ad
(
RESET_PARITY_INTERRUPT_REG
);

1027 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
) &

1028 
BASR_ACK
));

1030 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1031 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1034 #ià(
NDEBUG
 & 
NDEBUG_INTR
)

1035 
	`´štk
("scs˜: unknowÀš‹¼u±, BASR 0x%X, MR 0x%X, SR 0x%x\n", 
ba¤
, 
	`NCR5380_»ad
(
MODE_REG
), NCR5380_»ad(
STATUS_REG
));

1037 (è
	`NCR5380_»ad
(
RESET_PARITY_INTERRUPT_REG
);

1041 ià(!
dÚe
)

1042 
	`run_maš
();

1044 } !
dÚe
);

1045 
	}
}

1078 
	$NCR5380_£Ëù
 (
Scsi_Ho¡
 *
š¡ªû
, 
Scsi_Cmnd
 *
cmd
,

1079 
g
) {

1080 
	`NCR5380_loÿl_deş¬e
();

1081 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata*)

1082 
š¡ªû
->
ho¡d©a
;

1083 
tmp
[3], 
pha£
;

1084 *
d©a
;

1085 
Ën
;

1086 
timeout
;

1087 
	`NCR5380_£tup
(
š¡ªû
);

1089 #ià
	`defšed
 (
NDEBUG
è&& (NDEBUG & 
NDEBUG_ARBITRATION
)

1090 
	`NCR5380_´št
(
š¡ªû
);

1091 
	`´štk
("scsi%d : s¹šg‡rb™¿tiÚ, id = %d\n", 
š¡ªû
->
ho¡_no
,

1092 
š¡ªû
->
this_id
);

1100 
	`NCR5380_wr™e
(
TARGET_COMMAND_REG
, 0);

1103 
	`NCR5380_wr™e
(
OUTPUT_DATA_REG
, 
ho¡d©a
->
id_mask
);

1104 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_ARBITRATE
);

1107 !(
	`NCR5380_»ad
(
INITIATOR_COMMAND_REG
è& 
ICR_ARBITRATION_PROGRESS
));

1109 #ià(
NDEBUG
 & 
NDEBUG_ARBITRATION
)

1110 
	`´štk
("scsi%d :‡rb™¿tiÚ com¶‘e\n", 
š¡ªû
->
ho¡_no
);

1112 
	`__asm__
("nop");

1122 
	`ud–ay
(3);

1125 ià((
	`NCR5380_»ad
(
INITIATOR_COMMAND_REG
è& 
ICR_ARBITRATION_LOST
) ||

1126 (
	`NCR5380_»ad
(
CURRENT_SCSI_DATA_REG
è& 
ho¡d©a
->
id_high”_mask
) ||

1127 (
	`NCR5380_»ad
(
INITIATOR_COMMAND_REG
è& 
ICR_ARBITRATION_LOST
)) {

1128 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1129 #ià(
NDEBUG
 & 
NDEBUG_ARBITRATION
)

1130 
	`´štk
("scsi%d :†ost‡rbitration, deasserting MR_ARBITRATE\n",

1131 
š¡ªû
->
ho¡_no
);

1136 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_SEL
);

1138 ià(
	`NCR5380_»ad
(
INITIATOR_COMMAND_REG
è& 
ICR_ARBITRATION_LOST
) {

1139 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1140 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1141 #ià(
NDEBUG
 & 
NDEBUG_ARBITRATION
)

1142 
	`´štk
("scsi%d :†ost‡rbitration, deasserting ICR_ASSERT_SEL\n",

1143 
š¡ªû
->
ho¡_no
);

1153 
	`ud–ay
(2);

1155 #ià(
NDEBUG
 & 
NDEBUG_ARBITRATION
)

1156 
	`´štk
("scsi%d : wÚ‡rb™¿tiÚ\n", 
š¡ªû
->
ho¡_no
);

1164 
	`NCR5380_wr™e
(
OUTPUT_DATA_REG
, (
ho¡d©a
->
id_mask
 | (1 << 
cmd
->
rg‘
)));

1172 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, (
ICR_BASE
 | 
ICR_ASSERT_BSY
 |

1173 
ICR_ASSERT_DATA
 | 
ICR_ASSERT_ATN
 | 
ICR_ASSERT_SEL
 ));

1174 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1180 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 0);

1183 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, (
ICR_BASE
 | 
ICR_ASSERT_DATA
 |

1184 
ICR_ASSERT_ATN
 | 
ICR_ASSERT_SEL
));

1200 
	`ud–ay
(1);

1202 #ià(
NDEBUG
 & 
NDEBUG_SELECTION
)

1203 
	`´štk
("scsi%d : s–eùšg¬g‘ %d\n", 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
);

1211 
timeout
 = 
jiff›s
 + 25;

1219 (
jiff›s
 < 
timeout
è&& !(
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_BSY
));

1221 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ATN
);

1223 ià(!(
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_BSY
)) {

1224 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1225 
cmd
->
»suÉ
 = 
DID_BAD_TARGET
 << 16;

1226 
cmd
->
	`scsi_dÚe
(cmd);

1227 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 
ho¡d©a
->
id_mask
);

1228 #ià(
NDEBUG
 & 
NDEBUG_SELECTION
)

1229 
	`´štk
("scsi%d :arget did‚ot„espond within 250ms\n",

1230 
š¡ªû
->
ho¡_no
);

1251 !(
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
));

1253 #ià(
NDEBUG
 & 
NDEBUG_SELECTION
)

1254 
	`´štk
("scsi%d :arget %d selected, going into MESSAGE OUT…hase.\n",

1255 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
);

1257 
tmp
[0] = 
	`IDENTIFY
(((
š¡ªû
->
œq
 =ğ
IRQ_NONE
è? 0 : 1), 
cmd
->
lun
);

1258 #ifdeà
SCSI2


1259 ià(
scsi_deviûs
[
cmd
->
šdex
].
gged_queue
 && (
g
 !ğ
TAG_NONE
)) {

1260 
tmp
[1] = 
SIMPLE_QUEUE_TAG
;

1261 ià(
g
 =ğ
TAG_NEXT
) {

1263 ià(
scsi_deviûs
[
cmd
->
šdex
].
cu¼’t_g
 == 0)

1264 
scsi_deviûs
[
cmd
->
šdex
].
cu¼’t_g
 = 1;

1266 
cmd
->
g
 = 
scsi_deviûs
[cmd->
šdex
].
cu¼’t_g
;

1267 
scsi_deviûs
[
cmd
->
šdex
].
cu¼’t_g
++;

1269 
cmd
->
g
 = ()ag;

1271 
tmp
[2] = 
cmd
->
g
;

1272 
ho¡d©a
->
Ï¡_mes§ge
 = 
SIMPLE_QUEUE_TAG
;

1273 
Ën
 = 3;

1277 
Ën
 = 1;

1278 
cmd
->
g
=0;

1282 
d©a
 = 
tmp
;

1283 
pha£
 = 
PHASE_MSGOUT
;

1284 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

1285 #ià(
NDEBUG
 & 
NDEBUG_SELECTION
)

1286 
	`´štk
("scsi%d :‚exu e¡ablished.\n", 
š¡ªû
->
ho¡_no
);

1289 
ho¡d©a
->
cÚÃùed
 = 
cmd
;

1290 #ifdeà
SCSI2


1291 ià(!
scsi_deviûs
[
cmd
->
šdex
].
gged_queue
)

1293 
ho¡d©a
->
busy
[
cmd
->
rg‘
] |ğ(1 << cmd->
lun
);

1295 
	`š™Ÿlize_SCp
(
cmd
);

1298 
	}
}

1325 
	$NCR5380_Œªsãr_pio
 (
Scsi_Ho¡
 *
š¡ªû
,

1326 *
pha£
, *
couÁ
, **
d©a
) {

1327 
	`NCR5380_loÿl_deş¬e
();

1328 
p
 = *
pha£
, 
tmp
;

1329 
c
 = *
couÁ
;

1330 *
d
 = *
d©a
;

1331 
	`NCR5380_£tup
(
š¡ªû
);

1339 
	`NCR5380_wr™e
(
TARGET_COMMAND_REG
, 
	`PHASE_SR_TO_TCR
(
p
));

1346 !((
tmp
 = 
	`NCR5380_»ad
(
STATUS_REG
)è& 
SR_REQ
));

1348 #ià(
NDEBUG
 & 
NDEBUG_HANDSHAKE
)

1349 
	`´štk
("scsi%d : REQ d‘eùed\n", 
š¡ªû
->
ho¡_no
);

1353 ià((
tmp
 & 
PHASE_MASK
è!ğ
p
) {

1354 #ià(
NDEBUG
 & 
NDEBUG_PIO
)

1355 
	`´štk
("scsi%d :…ha£ mism©ch\n", 
š¡ªû
->
ho¡_no
);

1356 
	`NCR5380_´št_pha£
(
š¡ªû
);

1362 ià(!(
p
 & 
SR_IO
))

1363 
	`NCR5380_wr™e
(
OUTPUT_DATA_REG
, *
d
);

1365 *
d
 = 
	`NCR5380_»ad
(
CURRENT_SCSI_DATA_REG
);

1367 ++
d
;

1376 ià(!(
p
 & 
SR_IO
)) {

1377 ià(!((
p
 & 
SR_MSG
è&& 
c
 > 1)) {

1378 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1379 
ICR_ASSERT_DATA
);

1380 #ià(
NDEBUG
 & 
NDEBUG_PIO
)

1381 
	`NCR5380_´št
(
š¡ªû
);

1383 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1384 
ICR_ASSERT_DATA
 | 
ICR_ASSERT_ACK
);

1386 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1387 
ICR_ASSERT_DATA
 | 
ICR_ASSERT_ATN
);

1388 #ià(
NDEBUG
 & 
NDEBUG_PIO
)

1389 
	`NCR5380_´št
(
š¡ªû
);

1391 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1392 
ICR_ASSERT_DATA
 | 
ICR_ASSERT_ATN
 | 
ICR_ASSERT_ACK
);

1395 #ià(
NDEBUG
 & 
NDEBUG_PIO
)

1396 
	`NCR5380_´št
(
š¡ªû
);

1398 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ACK
);

1401 
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
);

1403 #ià(
NDEBUG
 & 
NDEBUG_HANDSHAKE
)

1404 
	`´štk
("scsi%d :„eq f®£, hªdshakcom¶‘e\n", 
š¡ªû
->
ho¡_no
);

1407 ià(!(
p
 =ğ
PHASE_MSGOUT
 && 
c
 > 1))

1408 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1410 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ATN
);

1411 } --
c
);

1413 #ià(
NDEBUG
 & 
NDEBUG_PIO
)

1414 
	`´štk
("scsi%d :„esidu® %d\n", 
š¡ªû
->
ho¡_no
, 
c
);

1417 *
couÁ
 = 
c
;

1418 *
d©a
 = 
d
;

1419 
tmp
 = 
	`NCR5380_»ad
(
STATUS_REG
);

1420 ià(
tmp
 & 
SR_REQ
)

1421 *
pha£
 = 
tmp
 & 
PHASE_MASK
;

1423 *
pha£
 = 
PHASE_UNKNOWN
;

1425 ià(!
c
 || (*
pha£
 =ğ
p
))

1429 
	}
}

1431 #ià
defšed
(
REAL_DMA
è|| defšed(
PSEUDO_DMA
è|| defšed (
REAL_DMA_POLL
)

1452 
	$NCR5380_Œªsãr_dma
 (
Scsi_Ho¡
 *
š¡ªû
,

1453 *
pha£
, *
couÁ
, **
d©a
) {

1454 
	`NCR5380_loÿl_deş¬e
();

1455 
c
 = *
couÁ
;

1456 
p
 = *
pha£
;

1457 *
d
 = *
d©a
;

1458 
tmp
;

1459 
foo
;

1460 #ià
	`defšed
(
REAL_DMA_POLL
)

1461 
út
, 
toPIO
;

1462 
§ved_d©a
 = 0, 
ov”run
 = 0, 
»sidue
;

1465 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

1466 
š¡ªû
->
ho¡d©a
;

1468 
	`NCR5380_£tup
(
š¡ªû
);

1470 ià((
tmp
 = (
	`NCR5380_»ad
(
STATUS_REG
è& 
PHASE_MASK
)è!ğ
p
) {

1471 *
pha£
 = 
tmp
;

1474 #ià
	`defšed
(
REAL_DMA
è|| defšed(
REAL_DMA_POLL
)

1475 #ifdeà
READ_OVERRUNS


1476 ià(
p
 & 
SR_IO
) {

1477 
c
 -= 2;

1480 #ià(
NDEBUG
 & 
NDEBUG_DMA
)

1481 
	`´štk
("scsi%d : initializing DMA channel %d for %s, %d bytes %s %0x\n",

1482 
š¡ªû
->
ho¡_no
, in¡ªû->
dma_chªÃl
, (
p
 & 
SR_IO
) ? "reading" :

1483 "wr™šg", 
c
, (
p
 & 
SR_IO
è? "to" : "äom", (è
d
);

1485 
ho¡d©a
->
dma_Ën
 = (
p
 & 
SR_IO
) ?

1486 
	`NCR5380_dma_»ad_£tup
(
š¡ªû
, 
d
, 
c
) :

1487 
	`NCR5380_dma_wr™e_£tup
(
š¡ªû
, 
d
, 
c
);

1490 
	`NCR5380_wr™e
(
TARGET_COMMAND_REG
, 
	`PHASE_SR_TO_TCR
(
p
));

1492 #ifdeà
REAL_DMA


1493 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
 | 
MR_DMA_MODE
 | 
MR_ENABLE_EOP_INTR
 | 
MR_MONITOR_BSY
);

1494 #–ià
	`defšed
(
REAL_DMA_POLL
)

1495 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
 | 
MR_DMA_MODE
);

1503 #ià
	`defšed
(
PSEUDO_DMA
è&& !defšed(
UNSAFE
)

1504 
	`şi
();

1506 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
 | 
MR_DMA_MODE
);

1509 #ià(
NDEBUG
 & 
NDEBUG_DMA
) & 0

1510 
	`´štk
("scsi%d : mod»g = 0x%X\n", 
š¡ªû
->
ho¡_no
, 
	`NCR5380_»ad
(
MODE_REG
));

1513 ià(
p
 & 
SR_IO
)

1514 
	`NCR5380_wr™e
(
START_DMA_INITIATOR_RECIEVE_REG
, 0);

1516 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_DATA
);

1517 
	`NCR5380_wr™e
(
START_DMA_SEND_REG
, 0);

1520 #ià
	`defšed
(
REAL_DMA_POLL
)

1522 
tmp
 = 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
);

1523 } (
tmp
 & 
BASR_PHASE_MATCH
è&& !Ñm°& (
BASR_BUSY_ERROR
 |

1524 
BASR_END_DMA_TRANSFER
)));

1562 ià(
p
 & 
SR_IO
) {

1563 #ifdeà
READ_OVERRUNS


1564 
	`ud–ay
(10);

1565 ià(((
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
è& (
BASR_PHASE_MATCH
|
BASR_ACK
)) ==

1566 (
BASR_PHASE_MATCH
 | 
BASR_ACK
))) {

1567 
§ved_d©a
 = 
	`NCR5380_»ad
(
INPUT_DATA_REGISTER
);

1568 
ov”run
 = 1;

1572 
lim™
 = 100;

1573 ((
tmp
 = 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
)è& 
BASR_ACK
) ||

1574 (
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
)) {

1575 ià(!(
tmp
 & 
BASR_PHASE_MATCH
)) ;

1576 ià(--
lim™
 < 0) ;

1581 #ià(
NDEBUG
 & 
NDEBUG_DMA
)

1582 
	`´štk
("scsi%d :…olled DMAransfer complete, basr 0x%X, sr 0x%X\n",

1583 
š¡ªû
->
ho¡_no
, 
tmp
, 
	`NCR5380_»ad
(
STATUS_REG
));

1586 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1587 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1589 
»sidue
 = 
	`NCR5380_dma_»sidu®
(
š¡ªû
);

1590 
c
 -ğ
»sidue
;

1591 *
couÁ
 -ğ
c
;

1592 *
d©a
 +ğ
c
;

1593 *
pha£
 = 
	`NCR5380_»ad
(
STATUS_REG
è& 
PHASE_MASK
;

1595 #ifdeà
READ_OVERRUNS


1596 ià(*
pha£
 =ğ
p
 && (°& 
SR_IO
è&& 
»sidue
 == 0) {

1597 ià(
ov”run
) {

1598 #ià(
NDEBUG
 & 
NDEBUG_DMA
)

1599 
	`´štk
("Got‡n input overrun, using saved byte\n");

1601 **
d©a
 = 
§ved_d©a
;

1602 *
d©a
 += 1;

1603 *
couÁ
 -= 1;

1604 
út
 = 
toPIO
 = 1;

1606 
	`´štk
("No overrun??\n");

1607 
út
 = 
toPIO
 = 2;

1609 #ià(
NDEBUG
 & 
NDEBUG_DMA
)

1610 
	`´štk
("Došg %d-by‹ PIOØ0x%X\n", 
út
, *
d©a
);

1612 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, 
pha£
, &
út
, 
d©a
);

1613 *
couÁ
 -ğ
toPIO
 - 
út
;

1617 #ià(
NDEBUG
 & 
NDEBUG_DMA
)

1618 
	`´štk
("Return with data…tr = 0x%X, count %d,†ast 0x%X,‚ext 0x%X\n",

1619 *
d©a
, *
couÁ
, *(*data+*count-1), *(*data+*count));

1623 #–ià
	`defšed
(
REAL_DMA
)

1626 ià(
p
 & 
SR_IO
) {

1627 ià(!(
foo
 = 
	`NCR5380_´—d
(
š¡ªû
, 
d
, 
c
 - 1))) {

1650 !(
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
è& 
BASR_DRQ
));

1652 
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
);

1653 
d
[
c
 - 1] = 
	`NCR5380_»ad
(
INPUT_DATA_REG
);

1656 
timeout
;

1657 ià(!(
foo
 = 
	`NCR5380_pwr™e
(
š¡ªû
, 
d
, 
c
))) {

1662 ià(!(
ho¡d©a
->
æags
 & 
FLAG_HAS_LAST_BYTE_SENT
)) {

1663 
timeout
 = 20000;

1666 !(
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
) &

1667 
BASR_DRQ
è&& (
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
) &

1668 
BASR_PHASE_MATCH
));

1670 ià(
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
) {

1671 ; 
timeout
 &&

1672 !(
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
è& 
BASR_ACK
);

1673 --
timeout
);

1674 ; 
timeout
 && (
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
);

1675 --
timeout
);

1680 #ià(
NDEBUG
 & 
NDEBUG_LAST_BYTE_SENT
)

1681 ià(!
timeout
)

1682 
	`´štk
("scsi%d :imed out on†ast byte\n",

1683 
š¡ªû
->
ho¡_no
);

1687 ià(
ho¡d©a
->
æags
 & 
FLAG_CHECK_LAST_BYTE_SENT
) {

1688 
ho¡d©a
->
æags
 &ğ~
FLAG_CHECK_LAST_BYTE_SENT
;

1689 ià(
	`NCR5380_»ad
(
TARGET_COMMAND_REG
è& 
TCR_LAST_BYTE_SENT
) {

1690 
ho¡d©a
->
æags
 |ğ
FLAG_HAS_LAST_BYTE_SENT
;

1691 #ià(
NDEBUG
 & 
NDEBUG_LAST_BYTE_SENT
)

1692 
	`´štk
("scsi%d :†ast bit sent works\n",

1693 
š¡ªû
->
ho¡_no
);

1698 !(
	`NCR5380_»ad
(
TARGET_COMMAND_REG
è& 
TCR_LAST_BYTE_SENT
));

1700 
	`ud–ay
 (5);

1705 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

1706 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

1708 *
d©a
 = 
d
 + 
c
;

1709 *
couÁ
 = 0;

1710 *
pha£
 = (
	`NCR5380_»ad
(
STATUS_REG
 & 
PHASE_MASK
));

1711 #ià
	`defšed
(
PSEUDO_DMA
è&& !defšed(
UNSAFE
)

1712 
	`¡i
();

1714  
foo
;

1736 
	`NCR5380_šfÜm©iÚ_Œªsãr
 (
Scsi_Ho¡
 *
š¡ªû
) {

1737 
	`NCR5380_loÿl_deş¬e
();

1738 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

1739 
š¡ªû
->
ho¡d©a
;

1740 
msgout
 = 
NOP
;

1741 
Ën
, 
Œªsãrsize
;

1742 *
d©a
;

1743 
pha£
, 
tmp
, 
Şd_pha£
=0xff;

1744 
Scsi_Cmnd
 *
cmd
 = (Scsi_Cmnd *è
ho¡d©a
->
cÚÃùed
;

1745 
	`NCR5380_£tup
(
š¡ªû
);

1748 
tmp
 = 
	`NCR5380_»ad
(
STATUS_REG
);

1750 ià(
tmp
 & 
SR_REQ
) {

1751 
pha£
 = (
tmp
 & 
PHASE_MASK
);

1752 ià(
pha£
 !ğ
Şd_pha£
) {

1753 
Şd_pha£
 = 
pha£
;

1754 #ià(
NDEBUG
 & 
NDEBUG_INFORMATION
)

1755 
	`NCR5380_´št_pha£
(
š¡ªû
);

1758 
pha£
) {

1759 
PHASE_DATAIN
:

1760 
PHASE_DATAOUT
:

1761 #ià(
NDEBUG
 & 
NDEBUG_NO_DATAOUT
)

1762 
	`´štk
("scsi%d : NDEBUG_NO_DATAOUT set,‡ttempted DATAOUT‡borted\n",

1763 
š¡ªû
->
ho¡_no
);

1764 
msgout
 = 
ABORT
;

1765 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ATN
);

1773 ià(!
cmd
->
SCp
.
this_»sidu®
 && cmd->SCp.
bufãrs_»sidu®
) {

1774 ++
cmd
->
SCp
.
bufãr
;

1775 --
cmd
->
SCp
.
bufãrs_»sidu®
;

1776 
cmd
->
SCp
.
this_»sidu®
 = cmd->SCp.
bufãr
->
Ëngth
;

1777 
cmd
->
SCp
.
±r
 = cmd->SCp.
bufãr
->
add»ss
;

1778 #ià(
NDEBUG
 & 
NDEBUG_INFORMATION
)

1779 
	`´štk
("scsi%d : %d bytes‡nd %d buffers†eft\n",

1780 
š¡ªû
->
ho¡_no
, 
cmd
->
SCp
.
this_»sidu®
,

1781 
cmd
->
SCp
.
bufãrs_»sidu®
);

1795 #ià
	`defšed
(
PSEUDO_DMA
è|| defšed(
REAL_DMA_POLL
)

1796 #ifdeà
NCR5380_dma_xãr_Ën


1797 ià(!
scsi_deviûs
[
cmd
->
šdex
].
bÜk’
 &&

1798 (
Œªsãrsize
 = 
	`NCR5380_dma_xãr_Ën
(
š¡ªû
, 
cmd
)) != 0) {

1800 ià(!
scsi_deviûs
[
cmd
->
šdex
].
bÜk’
 &&

1801 (
Œªsãrsize
 = 
cmd
->transfersize) &&

1802 
cmd
->
SCp
.
this_»sidu®
 && !(cmd->SCp.this_residual %

1803 
Œªsãrsize
)) {

1805 
Ën
 = 
Œªsãrsize
;

1806 ià(
	`NCR5380_Œªsãr_dma
(
š¡ªû
, &
pha£
,

1807 &
Ën
, (**è&
cmd
->
SCp
.
±r
)) {

1812 
	`´štk
("scsi%d : switchingarget %d†un %do slow handshake\n",

1813 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
);

1814 
scsi_deviûs
[
cmd
->
šdex
].
bÜk’
 = 1;

1815 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1816 
ICR_ASSERT_ATN
);

1817 
msgout
 = 
ABORT
;

1819 
cmd
->
SCp
.
this_»sidu®
 -ğ
Œªsãrsize
 - 
Ën
;

1822 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
,

1823 (*è&
cmd
->
SCp
.
this_»sidu®
, (**)

1824 &
cmd
->
SCp
.
±r
);

1826 
PHASE_MSGIN
:

1833 
Ën
 = 1;

1834 
d©a
 = &
tmp
;

1835 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

1836 
cmd
->
SCp
.
Mes§ge
 = 
tmp
;

1838 
tmp
) {

1849 #ifdeà
LINKED


1850 
LINKED_CMD_COMPLETE
:

1851 
LINKED_FLG_CMD_COMPLETE
:

1852 #ià(
NDEBUG
 & 
NDEBUG_LINKED
)

1853 
	`´štk
("scsi%d :arget %d†un %d†inked command complete.\n",

1854 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
);

1862 ià(!
cmd
->
Ãxt_lšk
) {

1863 
	`´štk
("scsi%d :arget %d†un %d†inked command complete,‚o‚ext_link\n"

1864 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
);

1865 
msgout
 = 
ABORT
;

1866 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

1867 
ICR_ASSERT_ATN
);

1871 
	`š™Ÿlize_SCp
(
cmd
->
Ãxt_lšk
);

1873 
cmd
->
Ãxt_lšk
->
g
 = cmd->tag;

1874 
cmd
->
»suÉ
 = cmd->
SCp
.
Stus
 | (cmd->SCp.
Mes§ge
 << 8);

1875 #ià(
NDEBUG
 & 
NDEBUG_LINKED
)

1876 
	`´štk
("scsi%d :arget %d†un %d†inked„equest done, calling scsi_done().\n",

1877 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
);

1879 
cmd
->
	`scsi_dÚe
(cmd);

1880 
cmd
 = 
ho¡d©a
->
cÚÃùed
;

1883 
ABORT
:

1884 
COMMAND_COMPLETE
:

1885 
ho¡d©a
->
cÚÃùed
 = 
NULL
;

1886 #ià(
NDEBUG
 & 
NDEBUG_QUEUES
)

1887 
	`´štk
("scsi%d : command forarget %d,†un %d completed\n",

1888 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
);

1890 
ho¡d©a
->
busy
[
cmd
->
rg‘
] &ğ~(1 << cmd->
lun
);

1908 ià(
cmd
->
cmnd
[0] !ğ
REQUEST_SENSE
)

1909 
cmd
->
»suÉ
 = cmd->
SCp
.
Stus
 | (cmd->SCp.
Mes§ge
 << 8);

1910 ià(
cmd
->
SCp
.
Stus
 !ğ
GOOD
)

1911 
cmd
->
»suÉ
 = (cmd->»suÉ & 0x00ffffè| (
DID_ERROR
 << 16);

1913 #ifdeà
AUTOSENSE


1914 ià((
cmd
->
cmnd
[0] !ğ
REQUEST_SENSE
) &&

1915 (
cmd
->
SCp
.
Stus
 =ğ
CHECK_CONDITION
)) {

1916 #ià(
NDEBUG
 & 
NDEBUG_AUTOSENSE
)

1917 
	`´štk
("scsi%d :…erforming„equest sense\n",

1918 
š¡ªû
->
ho¡_no
);

1920 
cmd
->
cmnd
[0] = 
REQUEST_SENSE
;

1921 
cmd
->
cmnd
[1] &= 0xe0;

1922 
cmd
->
cmnd
[2] = 0;

1923 
cmd
->
cmnd
[3] = 0;

1924 
cmd
->
cmnd
[4] = (cmd->
£n£_bufãr
);

1925 
cmd
->
cmnd
[5] = 0;

1927 
cmd
->
SCp
.
bufãr
 = 
NULL
;

1928 
cmd
->
SCp
.
bufãrs_»sidu®
 = 0;

1929 
cmd
->
SCp
.
±r
 = (*ècmd->
£n£_bufãr
;

1930 
cmd
->
SCp
.
this_»sidu®
 = (cmd->
£n£_bufãr
);

1932 
	`şi
();

1933 
cmd
->
ho¡_süibbË
 = (*)

1934 
ho¡d©a
->
issue_queue
;

1935 
ho¡d©a
->
issue_queue
 = (
Scsi_Cmnd
 *è
cmd
;

1936 
	`¡i
();

1937 #ià(
NDEBUG
 & 
NDEBUG_QUEUES
)

1938 
	`´štk
("scsi%d : REQUEST SENSE‡ddedo head of issue queue\n");

1942 
cmd
->
	`scsi_dÚe
(cmd);

1944 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 
ho¡d©a
->
id_mask
);

1946 (
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_BSY
) &&

1947 !
ho¡d©a
->
cÚÃùed
);

1949 
MESSAGE_REJECT
:

1950 
ho¡d©a
->
Ï¡_mes§ge
) {

1951 
HEAD_OF_QUEUE_TAG
:

1952 
ORDERED_QUEUE_TAG
:

1953 
SIMPLE_QUEUE_TAG
:

1954 
scsi_deviûs
[
cmd
->
šdex
].
gged_queue
 = 0;

1955 
ho¡d©a
->
busy
[
cmd
->
rg‘
] |ğ(1 << cmd->
lun
);

1960 
DISCONNECT
:

1961 
scsi_deviûs
[
cmd
->
šdex
].
discÚÃù
 = 1;

1962 
	`şi
();

1963 
cmd
->
ho¡_süibbË
 = (*)

1964 
ho¡d©a
->
discÚÃùed_queue
;

1965 
ho¡d©a
->
cÚÃùed
 = 
NULL
;

1966 
ho¡d©a
->
discÚÃùed_queue
 = 
cmd
;

1967 
	`¡i
();

1968 #ià(
NDEBUG
 & 
NDEBUG_QUEUES
)

1969 
	`´štk
("scsi%d : command forarget %d†un %d was moved from connectedo"

1970 "hdiscÚÃùed_queue\n", 
š¡ªû
->
ho¡_no
,

1971 
cmd
->
rg‘
, cmd->
lun
);

1975 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 
ho¡d©a
->
id_mask
);

1977 (
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_BSY
) &&

1978 !
ho¡d©a
->
cÚÃùed
);

1990 
SAVE_POINTERS
:

1991 
RESTORE_POINTERS
:

1999 
	`´štk
("Unknown message!\n");

2001 #ifdeà
nÙy‘


2006 
msgout
 = 
MESSAGE_REJECT
;

2007 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 |

2008 
ICR_ASSERT_ATN
);

2013 
PHASE_MSGOUT
:

2014 
Ën
 = 1;

2015 
d©a
 = &
msgout
;

2016 
ho¡d©a
->
Ï¡_mes§ge
 = 
msgout
;

2017 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

2018 ià(
msgout
 =ğ
ABORT
) {

2019 
ho¡d©a
->
busy
[
cmd
->
rg‘
] &ğ~(1 << cmd->
lun
);

2020 
ho¡d©a
->
cÚÃùed
 = 
NULL
;

2021 
cmd
->
»suÉ
 = 
DID_ERROR
 << 16;

2022 
cmd
->
	`scsi_dÚe
(cmd);

2023 
	`NCR5380_wr™e
(
SELECT_ENABLE_REG
, 
ho¡d©a
->
id_mask
);

2026 
msgout
 = 
NOP
;

2028 
PHASE_CMDOUT
:

2029 
Ën
 = 
	`COMMAND_SIZE
(
cmd
->
cmnd
[0]);

2030 
d©a
 = 
cmd
->
cmnd
;

2036 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
,

2037 &
d©a
);

2038 #ifdeà
USLEEP


2039 ià(!
discÚÃù
 && 
	`should_discÚÃù
(
cmd
->
cmnd
[0])) {

2040 
ho¡d©a
->
time_expœes
 = 
jiff›s
 + 
USLEEP_SLEEP
;

2041 #ià(
NDEBUG
 & 
NDEBUG_USLEEP
)

2042 
	`´štk
("scsi%d : issued commªd, sË•šg uÁ %ul\n", 
š¡ªû
->
ho¡_no
,

2043 
ho¡d©a
->
time_expœes
);

2045 
	`NCR5380_£t_tim”
 (
š¡ªû
);

2050 
PHASE_STATIN
:

2051 
Ën
 = 1;

2052 
d©a
 = &
tmp
;

2053 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

2054 
cmd
->
SCp
.
Stus
 = 
tmp
;

2057 
	`´štk
("scsi%d : unknowÀpha£\n", 
š¡ªû
->
ho¡_no
);

2058 #ifdeà
NDEBUG


2059 
	`NCR5380_´št
(
š¡ªû
);

2063 #ifdeà
USLEEP


2065 ià(!
discÚÃù
 && 
ho¡d©a
->
time_expœes
 && 
jiff›s
 >

2066 
ho¡d©a
->
time_expœes
) {

2067 
ho¡d©a
->
time_expœes
 = 
jiff›s
 + 
USLEEP_SLEEP
;

2068 #ià(
NDEBUG
 & 
NDEBUG_USLEEP
)

2069 
	`´štk
("scsi%d :…ŞÈtimed out, sË•šg uÁ %ul\n", 
š¡ªû
->
ho¡_no
,

2070 
ho¡d©a
->
time_expœes
);

2072 
	`NCR5380_£t_tim”
 (
š¡ªû
);

2092 
	`NCR5380_»£Ëù
 (
Scsi_Ho¡
 *
š¡ªû
) {

2093 
	`NCR5380_loÿl_deş¬e
();

2094 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

2095 
š¡ªû
->
ho¡d©a
;

2096 
rg‘_mask
;

2097 
lun
, 
pha£
;

2098 
Ën
;

2099 #ifdeà
SCSI2


2100 
g
;

2102 
msg
[3];

2103 *
d©a
;

2104 
Scsi_Cmnd
 *
tmp
 = 
NULL
, *
´ev
;

2105 
abÜt
 = 0;

2106 
	`NCR5380_£tup
(
š¡ªû
);

2108 
rg‘_mask
 = 
	`NCR5380_»ad
(
CURRENT_SCSI_DATA_REG
è& ~(
ho¡d©a
->
id_mask
);

2110 #ià(
NDEBUG
 & 
NDEBUG_RESELECTION
)

2111 
	`´štk
("scsi%d :„e£Ëù\n", 
š¡ªû
->
ho¡_no
);

2123 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_BSY
);

2125 
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_SEL
);

2126 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

2132 !(
	`NCR5380_»ad
(
STATUS_REG
è& 
SR_REQ
));

2134 
Ën
 = 3;

2135 
d©a
 = 
msg
;

2136 
pha£
 = 
PHASE_MSGIN
;

2137 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

2139 #ifdeà
SCSI2


2153 ià(!
Ën
)

2154 
g
 = 
msg
[2];

2156 
g
 = 0;

2159 ià(!
msg
[0] & 0x80) {

2160 
	`´štk
("scsi%d :ƒxpecting IDENTIFY message, got ",

2161 
š¡ªû
->
ho¡_no
);

2162 
	`´št_msg
(
msg
);

2163 
abÜt
 = 1;

2166 
lun
 = (
msg
[0] & 0x07);

2173 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
discÚÃùed_queue
, 
´ev
 = 
NULL
;

2174 
tmp
; 
´ev
 =mp,m°ğ(
Scsi_Cmnd
 *ètmp->
ho¡_süibbË
)

2175 ià((
rg‘_mask
 =ğ(1 << 
tmp
->
rg‘
)è&& (
lun
 ==mp->lun)

2176 #ifdeà
SCSI2


2177 && (
g
 =ğ
tmp
->tag)

2180 ià(
´ev
)

2181 
´ev
->
ho¡_süibbË
 = 
tmp
->host_scribble;

2183 
ho¡d©a
->
discÚÃùed_queue
 = (
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
;

2184 
tmp
->
ho¡_süibbË
 = 
NULL
;

2188 ià(!
tmp
) {

2189 #ifdeà
SCSI2


2190 
	`´štk
("scsi%d : warning :arget bitmask %02x†un %dag %d‚ot in disconnect_queue.\n",

2191 
š¡ªû
->
ho¡_no
, 
rg‘_mask
, 
lun
, 
g
);

2193 
	`´štk
("scsi%d : warning :arget bitmask %02x†un %d‚ot in disconnect_queue.\n",

2194 
š¡ªû
->
ho¡_no
, 
rg‘_mask
, 
lun
);

2200 
abÜt
 = 1;

2204 ià(
abÜt
) {

2205 
msg
[0] = 
ABORT
;

2206 
Ën
 = 1;

2207 
d©a
 = 
msg
;

2208 
pha£
 = 
PHASE_MSGOUT
;

2209 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ATN
);

2210 
	`NCR5380_Œªsãr_pio
(
š¡ªû
, &
pha£
, &
Ën
, &
d©a
);

2212 
ho¡d©a
->
cÚÃùed
 = 
tmp
;

2213 #ià(
NDEBUG
 & 
NDEBUG_RESELECTION
)

2214 
´štk
"scsi%d :‚exusƒstablished,arget = %d,†un = %d,ag = %d\n",

2215 
š¡ªû
->
ho¡_no
, 
cmd
->
rg‘
, cmd->
lun
, cmd->
g
);

2232 #ifdeà
REAL_DMA


2233 
	`NCR5380_dma_com¶‘e
 (
NCR5380_š¡ªû
 *
š¡ªû
) {

2234 
	`NCR5380_loÿl_deş¬e
();

2235 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *

2236 
š¡ªû
->
ho¡d©a
);

2237 
Œªsã¼ed
;

2238 
	`NCR5380_£tup
(
š¡ªû
);

2249 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
è& 
BASR_ACK
);

2251 
	`NCR5380_wr™e
(
MODE_REG
, 
MR_BASE
);

2252 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

2260 ià(!(
ho¡d©a
->
cÚÃùed
->
SCp
.
pha£
 & 
SR_CD
)) {

2261 
Œªsã¼ed
 = 
š¡ªû
->
dm®’
 - 
	`NCR5380_dma_»sidu®
();

2262 
ho¡d©a
->
cÚÃùed
->
SCp
.
this_»sidu®
 -ğ
Œªsã¼ed
;

2263 
ho¡d©a
->
cÚÃùed
->
SCp
.
±r
 +ğ
Œªsã¼ed
;

2285 #iâdeà
NCR5380_abÜt


2288 
	`NCR5380_abÜt
 (
Scsi_Cmnd
 *
cmd
, 
code
) {

2289 
	`NCR5380_loÿl_deş¬e
();

2290 
Scsi_Ho¡
 *
š¡ªû
 = 
cmd
->
ho¡
;

2291 
NCR5380_ho¡d©a
 *
ho¡d©a
 = (NCR5380_hostdata *)

2292 
š¡ªû
->
ho¡d©a
;

2293 
Scsi_Cmnd
 *
tmp
, **
´ev
;

2294 
msg
, 
pha£
, *
msg±r
;

2295 
Ën
;

2297 
	`şi
();

2298 
	`NCR5380_£tup
(
š¡ªû
);

2300 #ià(
NDEBUG
 & 
NDEBUG_ABORT
)

2301 
	`´štk
("scsi%d :‡bÜˆÿÎed\n", 
š¡ªû
->
ho¡_no
);

2302 
	`´štk
(" basr 0x%X, sr 0x%X\n",

2303 
	`NCR5380_»ad
(
BUS_AND_STATUS_REG
), NCR5380_»ad(
STATUS_REG
));

2309 
´ev
 = (
Scsi_Cmnd
 **è&(
ho¡d©a
->
issue_queue
),

2310 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
issue_queue
;

2311 
tmp
; 
´ev
 = (
Scsi_Cmnd
 **è&Ñmp->
ho¡_süibbË
),mp =

2312 (
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
)

2313 ià(
cmd
 =ğ
tmp
) {

2314 (*
´ev
èğ(
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
;

2315 
tmp
->
ho¡_süibbË
 = 
NULL
;

2316 
tmp
->
»suÉ
 = (
code
 ? cod: 
DID_ABORT
) << 16;

2317 
	`¡i
();

2318 #ià(
NDEBUG
 & 
NDEBUG_ABORT
)

2319 
	`´štk
("scsi%d :‡bort„emoved command from issue queue.\n",

2320 
š¡ªû
->
ho¡_no
);

2322 
tmp
->
	`dÚe
(tmp);

2337 ià(
ho¡d©a
->
cÚÃùed
) {

2338 
	`¡i
();

2339 #ià(
NDEBUG
 & 
NDEBUG_ABORT
)

2340 
	`´štk
("scsi%d :‡bÜˆçed, commªd cÚÃùed.\n", 
š¡ªû
->
ho¡_no
);

2370 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
discÚÃùed_queue
;mp;

2371 
tmp
 = (
Scsi_Cmnd
 *ètmp->
ho¡_süibbË
)

2372 ià(
cmd
 =ğ
tmp
) {

2373 
	`¡i
();

2374 #ià(
NDEBUG
 & 
NDEBUG_ABORT
)

2375 
	`´štk
("scsi%d :‡bÜtšg discÚÃùed commªd.\n", 
š¡ªû
->
ho¡_no
);

2378 ià(
	`NCR5380_£Ëù
 (
š¡ªû
, 
cmd
, (ècmd->
g
))

2381 #ià(
NDEBUG
 & 
NDEBUG_ABORT
)

2382 
	`´štk
("scsi%d :‚exu »¡ablished.\n", 
š¡ªû
->
ho¡_no
);

2385 
msg
 = 
ABORT
;

2386 
msg±r
 = &
msg
;

2387 
Ën
 = 1;

2388 
pha£
 = 
PHASE_MSGOUT
;

2389 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_ATN
);

2390 
	`NCR5380_Œªsãr_pio
 (
š¡ªû
, &
pha£
, &
Ën
, &
msg±r
);

2392 
	`şi
();

2393 
´ev
 = (
Scsi_Cmnd
 **è&(
ho¡d©a
->
discÚÃùed_queue
),

2394 
tmp
 = (
Scsi_Cmnd
 *è
ho¡d©a
->
discÚÃùed_queue
;

2395 
tmp
; 
´ev
 = (
Scsi_Cmnd
 **è&Ñmp->
ho¡_süibbË
),mp =

2396 (
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
)

2397 ià(
cmd
 =ğ
tmp
) {

2398 *
´ev
 = (
Scsi_Cmnd
 *è
tmp
->
ho¡_süibbË
;

2399 
tmp
->
ho¡_süibbË
 = 
NULL
;

2400 
tmp
->
»suÉ
 = (
code
 ? cod: 
DID_ABORT
) << 16;

2401 
	`¡i
();

2402 
tmp
->
	`dÚe
(tmp);

2417 
	`¡i
();

2418 
	`´štk
("scsi%d : warning : SCSI command…robably completed successfully\n"

2419 " befÜabÜtiÚ\n", 
š¡ªû
->
ho¡_no
);

2433 #iâdeà
NCR5380_»£t


2436 
	`NCR5380_»£t
 (
Scsi_Cmnd
 *
cmd
) {

2437 
	`NCR5380_loÿl_deş¬e
();

2438 
	`NCR5380_£tup
(
cmd
->
ho¡
);

2440 
	`şi
();

2441 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
 | 
ICR_ASSERT_RST
);

2442 
	`ud–ay
(1);

2443 
	`NCR5380_wr™e
(
INITIATOR_COMMAND_REG
, 
ICR_BASE
);

2444 
	`¡i
();

	@drivers/scsi/NCR5380.h

39 #iâdeà
NCR5380_H


40 
	#NCR5380_H


	)

42 
	#NCR5380_PUBLIC_RELEASE
 4

	)

44 
	#NDEBUG_ARBITRATION
 0x1

	)

45 
	#NDEBUG_AUTOSENSE
 0x2

	)

46 
	#NDEBUG_DMA
 0x4

	)

47 
	#NDEBUG_HANDSHAKE
 0x8

	)

48 
	#NDEBUG_INFORMATION
 0x10

	)

49 
	#NDEBUG_INIT
 0x20

	)

50 
	#NDEBUG_INTR
 0x40

	)

51 
	#NDEBUG_LINKED
 0x80

	)

52 
	#NDEBUG_MAIN
 0x100

	)

53 
	#NDEBUG_NO_DATAOUT
 0x200

	)

54 
	#NDEBUG_NO_WRITE
 0x400

	)

55 
	#NDEBUG_PIO
 0x800

	)

56 
	#NDEBUG_PSEUDO_DMA
 0x1000

	)

57 
	#NDEBUG_QUEUES
 0x2000

	)

58 
	#NDEBUG_RESELECTION
 0x4000

	)

59 
	#NDEBUG_SELECTION
 0x8000

	)

60 
	#NDEBUG_USLEEP
 0x10000

	)

61 
	#NDEBUG_LAST_BYTE_SENT
 0x20000

	)

70 
	#OUTPUT_DATA_REG
 0

	)

71 
	#CURRENT_SCSI_DATA_REG
 0

	)

73 
	#INITIATOR_COMMAND_REG
 1

	)

74 
	#ICR_ASSERT_RST
 0x80

	)

75 
	#ICR_ARBITRATION_PROGRESS
 0x40

	)

76 
	#ICR_TRI_STATE
 0x40

	)

77 
	#ICR_ARBITRATION_LOST
 0x20

	)

78 
	#ICR_DIFF_ENABLE
 0x20

	)

79 
	#ICR_ASSERT_ACK
 0x10

	)

80 
	#ICR_ASSERT_BSY
 0x08

	)

81 
	#ICR_ASSERT_SEL
 0x04

	)

82 
	#ICR_ASSERT_ATN
 0x02

	)

83 
	#ICR_ASSERT_DATA
 0x01

	)

85 #ifdeà
DIFFERENTIAL


86 
	#ICR_BASE
 
ICR_DIFF_ENABLE


	)

88 
	#ICR_BASE
 0

	)

91 
	#MODE_REG
 2

	)

97 
	#MR_BLOCK_DMA_MODE
 0x80

	)

98 
	#MR_TARGET
 0x40

	)

99 
	#MR_ENABLE_PAR_CHECK
 0x20

	)

100 
	#MR_ENABLE_PAR_INTR
 0x10

	)

101 
	#MR_ENABLE_EOP_INTR
 0x08

	)

102 
	#MR_MONITOR_BSY
 0x04

	)

103 
	#MR_DMA_MODE
 0x02

	)

104 
	#MR_ARBITRATE
 0x01

	)

106 #ifdeà
PARITY


107 
	#MR_BASE
 
MR_ENABLE_PAR_CHECK


	)

109 
	#MR_BASE
 0

	)

112 
	#TARGET_COMMAND_REG
 3

	)

113 
	#TCR_LAST_BYTE_SENT
 0x80

	)

114 
	#TCR_ASSERT_REQ
 0x08

	)

115 
	#TCR_ASSERT_MSG
 0x04

	)

116 
	#TCR_ASSERT_CD
 0x02

	)

117 
	#TCR_ASSERT_IO
 0x01

	)

119 
	#STATUS_REG
 4

	)

124 
	#SR_RST
 0x80

	)

125 
	#SR_BSY
 0x40

	)

126 
	#SR_REQ
 0x20

	)

127 
	#SR_MSG
 0x10

	)

128 
	#SR_CD
 0x08

	)

129 
	#SR_IO
 0x04

	)

130 
	#SR_SEL
 0x02

	)

131 
	#SR_DBP
 0x01

	)

137 
	#SELECT_ENABLE_REG
 4

	)

139 
	#BUS_AND_STATUS_REG
 5

	)

140 
	#BASR_END_DMA_TRANSFER
 0x80

	)

141 
	#BASR_DRQ
 0x40

	)

142 
	#BASR_PARITY_ERROR
 0x20

	)

143 
	#BASR_IRQ
 0x10

	)

144 
	#BASR_PHASE_MATCH
 0x08

	)

145 
	#BASR_BUSY_ERROR
 0x04

	)

146 
	#BASR_ATN
 0x02

	)

147 
	#BASR_ACK
 0x01

	)

150 
	#START_DMA_SEND_REG
 5

	)

156 
	#INPUT_DATA_REG
 6

	)

159 
	#START_DMA_TARGET_RECIEVE_REG
 6

	)

162 
	#RESET_PARITY_INTERRUPT_REG
 7

	)

165 
	#START_DMA_INITIATOR_RECIEVE_REG
 7

	)

168 
	#PHASE_MASK
 (
SR_MSG
 | 
SR_CD
 | 
SR_IO
)

	)

170 
	#PHASE_DATAOUT
 0

	)

171 
	#PHASE_DATAIN
 
SR_IO


	)

172 
	#PHASE_CMDOUT
 
SR_CD


	)

173 
	#PHASE_STATIN
 (
SR_CD
 | 
SR_IO
)

	)

174 
	#PHASE_MSGOUT
 (
SR_MSG
 | 
SR_CD
)

	)

175 
	#PHASE_MSGIN
 (
SR_MSG
 | 
SR_CD
 | 
SR_IO
)

	)

176 
	#PHASE_UNKNOWN
 0xff

	)

184 
	#PHASE_SR_TO_TCR
(
pha£
è(Õha£è>> 2)

	)

192 
	#DISCONNECT_NONE
 0

	)

193 
	#DISCONNECT_TIME_TO_DATA
 1

	)

194 
	#DISCONNECT_LONG
 2

	)

200 
	#TAG_NEXT
 -1

	)

201 
	#TAG_NONE
 -2

	)

211 
	#IRQ_NONE
 255

	)

212 
	#DMA_NONE
 255

	)

213 
	#IRQ_AUTO
 254

	)

214 
	#DMA_AUTO
 254

	)

216 
	#FLAG_HAS_LAST_BYTE_SENT
 1

	)

217 
	#FLAG_CHECK_LAST_BYTE_SENT
 2

	)

219 #iâdeà
ASM


220 
	sNCR5380_ho¡d©a
 {

221 
	mNCR5380_im¶em’tiÚ_f›lds
;

222 
	mid_mask
, 
	mid_high”_mask
;

223 vŞ©
	mbusy
[8];

224 #ià
defšed
(
REAL_DMA
è|| defšed(
REAL_DMA_POLL
)

225 vŞ©
	mdma_Ën
;

227 vŞ©
	mÏ¡_mes§ge
;

228 vŞ©
Scsi_Cmnd
 *
	mcÚÃùed
;

229 vŞ©
Scsi_Cmnd
 *
	missue_queue
;

230 vŞ©
Scsi_Cmnd
 *
	mdiscÚÃùed_queue
;

231 
	mæags
;

232 #ifdeà
USLEEP


233 
	mtime_expœes
;

234 
Scsi_Ho¡
 *
	mÃxt_tim”
;

238 #ifdeà
__KERNEL__


239 
Scsi_Ho¡
 *
	gfœ¡_š¡ªû
;

241 #ià
defšed
(
AUTOPROBE_IRQ
)

242 
NCR5380_´obe_œq
 (
Scsi_Ho¡
 *
š¡ªû
, 
possibË
);

244 
NCR5380_š™
 (
Scsi_Ho¡
 *
š¡ªû
);

245 
NCR5380_šfÜm©iÚ_Œªsãr
 (
Scsi_Ho¡
 *
š¡ªû
);

246 
NCR5380_šŒ
 (
œq
);

247 
NCR5380_maš
 ();

248 
NCR5380_´št_İtiÚs
 (
Scsi_Ho¡
 *
š¡ªû
);

249 #iâdeà
NCR5380_abÜt


252 
NCR5380_abÜt
 (
Scsi_Cmnd
 *
cmd
, 
code
);

253 #iâdeà
NCR5380_»£t


256 
NCR5380_»£t
 (
Scsi_Cmnd
 *
cmd
);

257 #iâdeà
NCR5380_queue_commªd


260 
NCR5380_queue_commªd
 (
Scsi_Cmnd
 *
cmd
, (*
dÚe
)(Scsi_Cmnd *));

263 
	`NCR5380_»£Ëù
 (
Scsi_Ho¡
 *
š¡ªû
);

264 
	`NCR5380_£Ëù
 (
Scsi_Ho¡
 *
š¡ªû
, 
Scsi_Cmnd
 *
cmd
, 
g
);

265 #ià
	`defšed
(
PSEUDO_DMA
è|| defšed(
REAL_DMA
è|| defšed(
REAL_DMA_POLL
)

266 
	`NCR5380_Œªsãr_dma
 (
Scsi_Ho¡
 *
š¡ªû
,

267 *
pha£
, *
couÁ
, **
d©a
);

269 
	`NCR5380_Œªsãr_pio
 (
Scsi_Ho¡
 *
š¡ªû
,

270 *
pha£
, *
couÁ
, **
d©a
);

272 #ià(
	`defšed
(
REAL_DMA
è|| defšed(
REAL_DMA_POLL
)è&& defšed(
i386
)

273 
__šlše__
 
	$NCR5380_i386_dma_£tup
 (
Scsi_Ho¡
 *
š¡ªû
,

274 *
±r
, 
couÁ
, 
mode
) {

275 
lim™
;

277 ià(
š¡ªû
->
dma_chªÃl
 <=3) {

278 ià(
couÁ
 > 65536)

279 
couÁ
 = 65536;

280 
lim™
 = 65536 - (((è
±r
) & 0xFFFF);

282 ià(
couÁ
 > 65536 * 2)

283 
couÁ
 = 65536 * 2;

284 
lim™
 = 65536* 2 - (((è
±r
) & 0x1FFFF);

287 ià(
couÁ
 > 
lim™
) count =†imit;

289 ià((
couÁ
 & 1è|| (((è
±r
) & 1))

290 
	`·nic
 ("scsi%d :‡‰m±ed uÇligÃd DMA¿nsãr\n", 
š¡ªû
->
ho¡_no
);

291 
	`şi
();

292 
	`di§bË_dma
(
š¡ªû
->
dma_chªÃl
);

293 
	`ş—r_dma_ff
(
š¡ªû
->
dma_chªÃl
);

294 
	`£t_dma_addr
(
š¡ªû
->
dma_chªÃl
, (è
±r
);

295 
	`£t_dma_couÁ
(
š¡ªû
->
dma_chªÃl
, 
couÁ
);

296 
	`£t_dma_mode
(
š¡ªû
->
dma_chªÃl
, 
mode
);

297 
	`’abË_dma
(
š¡ªû
->
dma_chªÃl
);

298 
	`¡i
();

299  
couÁ
;

300 
	}
}

302 
__šlše__
 
	$NCR5380_i386_dma_wr™e_£tup
 (
Scsi_Ho¡
 *
š¡ªû
,

303 *
¤c
, 
couÁ
) {

304  
	`NCR5380_i386_dma_£tup
 (
š¡ªû
, 
¤c
, 
couÁ
, 
DMA_MODE_WRITE
);

305 
	}
}

307 
__šlše__
 
	$NCR5380_i386_dma_»ad_£tup
 (
Scsi_Ho¡
 *
š¡ªû
,

308 *
¤c
, 
couÁ
) {

309  
	`NCR5380_i386_dma_£tup
 (
š¡ªû
, 
¤c
, 
couÁ
, 
DMA_MODE_READ
);

310 
	}
}

312 
__šlše__
 
	$NCR5380_i386_dma_»sidu®
 (
Scsi_Ho¡
 *
š¡ªû
) {

313 
tmp
;

314 
	`şi
();

315 
	`ş—r_dma_ff
(
š¡ªû
->
dma_chªÃl
);

316 
tmp
 = 
	`g‘_dma_»sidue
(
š¡ªû
->
dma_chªÃl
);

317 
	`¡i
();

318  
tmp
;

319 
	}
}

	@drivers/scsi/aha152x.c

158 
	~"aha152x.h
"

160 
	~<lšux/sched.h
>

161 
	~<asm/io.h
>

162 
	~"../block/blk.h
"

163 
	~"scsi.h
"

164 
	~"ho¡s.h
"

165 
	~"cÚ¡ªts.h
"

166 
	~<asm/sy¡em.h
>

167 
	~<lšux/”ºo.h
>

168 
	~<lšux/¡ršg.h
>

169 
	~<lšux/wa™.h
>

170 
	~<lšux/iİÜt.h
>

177 #ià!
defšed
(
AUTOCONF
)

178 #ià!
defšed
(
IRQ
)

179 #”rÜ 
undefšed
 
IRQ
; 
defše
 
AUTOCONF
 
Ü
 IRQ

181 #ià!
defšed
(
SCSI_ID
)

182 #”rÜ 
undefšed
 
SCSI_ID
; 
defše
 
AUTOCONF
 
Ü
 SCSI_ID

184 #ià!
defšed
(
RECONNECT
)

185 #”rÜ 
undefšed
 
RECONNECT
; 
defše
 
AUTOCONF
 
Ü
 RECONNECT

190 
	#DEBUG_TIMING


	)

192 #ià
defšed
(
DEBUG
)

194 #undeà
SKIP_PORTS


196 #undeà
DEBUG_QUEUE


197 #undeà
DEBUG_RESET


198 #undeà
DEBUG_INTR


199 #undeà
DEBUG_SELECTION


200 #undeà
DEBUG_MSGO


201 #undeà
DEBUG_MSGI


202 #undeà
DEBUG_STATUS


203 #undeà
DEBUG_CMD


204 #undeà
DEBUG_DATAI


205 #undeà
DEBUG_DATAO


206 #undeà
DEBUG_ABORT


207 #undeà
DEBUG_DONE


208 #undeà
DEBUG_BIOSPARAM


210 #undeà
DEBUG_RACE


211 #undeà
DEBUG_PHASES


212 #undeà
DEBUG_QUEUES


216 
	#DEBUG_PHASES


	)

217 
	#DEBUG_DATAI


	)

222 
	#DEBUG_RESET


	)

223 
	#DEBUG_ABORT


	)

228 
	#P_BUSFREE
 1

	)

229 
	#P_PARITY
 2

	)

231 *
	gaha152x_id
 = "Adaptec 152x SCSI driver; $Revision: 0.101 $\n";

233 
	gpÜt_ba£
 = 0;

234 
	gthis_ho¡
 = 0;

235 
	gÿn_discÚÃù
 = 0;

236 
	gcommªds
 = 0;

239 
	g£tup_ÿÎed
 = 0;

240 
	g£tup_pÜtba£
 = 0;

241 
	g£tup_œq
 = 0;

242 
	g£tup_scsiid
 = 0;

243 
	g£tup_»cÚÃù
 = 0;

245 *
	g£tup_¡r
 = (*)
NULL
;

248 
	mnÙ_issued
 = 0x01,

249 
	mš_£ËùiÚ
 = 0x02,

250 
	mdiscÚÃùed
 = 0x04,

251 
	mabÜ‹d
 = 0x08,

252 
	m£Á_id’t
 = 0x10,

253 
	mš_Ùh”
 = 0x20,

262 
Scsi_Cmnd
 *
	gissue_SC
 = 
NULL
;

263 
Scsi_Cmnd
 *
	gcu¼’t_SC
 = 
NULL
;

264 
Scsi_Cmnd
 *
	gdiscÚÃùed_SC
 = 
NULL
;

266 
wa™_queue
 *
	gabÜtiÚ_com¶‘e
;

267 
	gabÜt_»suÉ
;

269 
aha152x_šŒ
Ğ
œqno
 );

270 
aha152x_dÚe
Ğ
”rÜ
 );

271 
aha152x_£tup
Ğ*
¡r
, *
šts
 );

273 
aha152x_»£t_pÜts
();

274 
aha152x_·nic
(*
msg
);

276 
di¥_pÜts
();

277 
show_commªd
(
Scsi_Cmnd
 *
±r
);

278 
show_queues
();

279 
di¥_’šŒ
();

281 #ià
defšed
(
DEBUG_RACE
)

282 
’‹r_driv”
(const *);

283 
Ëave_driv”
(const *);

287 *
	gadd»s£s
[] =

298 
	#ADDRESS_COUNT
 (Ğ
add»s£s
 ) / Ğ))

	)

301 
	gpÜts
[] =

306 
	#PORT_COUNT
 (Ğ
pÜts
 ) / Ğ))

	)

309 
	gšts
[] = { 9, 10, 11, 12 };

312 
	ssigÇtu»
 {

313 *
	msigÇtu»
;

314 
	msig_off£t
;

315 
	msig_Ëngth
;

316 } 
	gsigÇtu»s
[] =

333 
	#SIGNATURE_COUNT
 (Ğ
sigÇtu»s
 ) / Ğ
sigÇtu»
 ))

	)

336 
	$do_·u£
Ğ
amouÁ
 )

338 
the_time
 = 
jiff›s
 + 
amouÁ
;

340 
jiff›s
 < 
the_time
)

342 
	}
}

347 
šlše
 
	$­³nd_SC
Ğ
Scsi_Cmnd
 **
SC
, Scsi_Cmnd *
Ãw_SC
)

349 
Scsi_Cmnd
 *
’d
;

351 
Ãw_SC
->
ho¡_süibbË
 = (*è
NULL
;

352 if(!*
SC
)

353 *
SC
=
Ãw_SC
;

356  
’d
=*
SC
;

357 
’d
->
ho¡_süibbË
;

358 
’d
 = (
Scsi_Cmnd
 *è’d->
ho¡_süibbË
 )

360 
’d
->
ho¡_süibbË
 = (*è
Ãw_SC
;

362 
	}
}

364 
šlše
 
Scsi_Cmnd
 *
	$»move_fœ¡_SC
Ğ
Scsi_Cmnd
 **
SC
 )

366 
Scsi_Cmnd
 *
±r
;

368 
±r
=*
SC
;

369 if(
±r
)

370 *
SC
ğ(
Scsi_Cmnd
 *è(*SC)->
ho¡_süibbË
;

371  
±r
;

372 
	}
}

374 
šlše
 
Scsi_Cmnd
 *
	$»move_SC
Ğ
Scsi_Cmnd
 **
SC
, 
rg‘
, 
lun
 )

376 
Scsi_Cmnd
 *
±r
, *
´ev
;

378  
±r
=*
SC
, 
´ev
=
NULL
;

379 
±r
 && (ÕŒ->
rg‘
!ñ¬g‘è|| (±r->
lun
!=lun));

380 
´ev
 = 
±r
,…Œ = (
Scsi_Cmnd
 *è±r->
ho¡_süibbË
 )

383 if(
±r
)

384 if(
´ev
)

385 
´ev
->
ho¡_süibbË
 = 
±r
->host_scribble;

387 *
SC
ğ(
Scsi_Cmnd
 *è
±r
->
ho¡_süibbË
;

388  
±r
;

389 
	}
}

394 
	$make_acklow
()

396 
	`SETPORT
Ğ
SXFRCTL0
, 
CH1
|
SPIOEN
 );

397 
	`GETPORT
(
SCSIDAT
);

398 
	`SETPORT
Ğ
SXFRCTL0
, 
CH1
 );

400  
	`TESTHI
Ğ
SCSISIG
, 
ACKI
 ) )

402 
	}
}

414 
	$g‘pha£
()

416 
pha£
, 
s¡©1
;

422  !ĞĞ
s¡©1
 = 
	`GETPORT
Ğ
SSTAT1
 ) ) & (
BUSFREE
|
SCSIRSTI
|
REQINIT
 ) ) )

424 ifĞ
s¡©1
 & 
BUSFREE
 )

425  
P_BUSFREE
;

426 ifĞ
s¡©1
 & 
SCSIRSTI
 )

429 
	`´štk
("aha152x: RESET IN\n");

430 
	`SETPORT
Ğ
SSTAT1
, 
SCSIRSTI
 );

433  
	`TESTHI
Ğ
SCSISIG
, 
ACKI
 ) || 
	`TESTLO
Ğ
SSTAT1
, 
REQINIT
 ) );

435 
	`SETPORT
Ğ
SSTAT1
, 
CLRSCSIPERR
 );

437 
pha£
 = 
	`GETPORT
Ğ
SCSISIG
 ) & 
P_MASK
 ;

439 ifĞ
	`TESTHI
Ğ
SSTAT1
, 
SCSIPERR
 ) )

441 ifĞ(
pha£
 & (
CDO
|
MSGO
))==0 )

442  
P_PARITY
;

444 
	`make_acklow
();

447  
pha£
;

449 
	}
}

452 
	$aha152x_£tup
Ğ*
¡r
, *
šts
)

454 if(
£tup_ÿÎed
)

455 
	`·nic
("aha152x:‡ha152x_setup calledwice.\n");

457 
£tup_ÿÎed
=
šts
[0];

458 
£tup_¡r
=
¡r
;

460 if(
šts
[0] != 4)

463 
£tup_pÜtba£
 = 
šts
[1];

464 
£tup_œq
 = 
šts
[2];

465 
£tup_scsiid
 = 
šts
[3];

466 
£tup_»cÚÃù
 = 
šts
[4];

467 
	}
}

472 
	$aha152x_pÜ‰e¡
(
pÜt_ba£
)

474 
i
;

476 if(
	`check_»giÚ
(
pÜt_ba£
, 
TEST
-
SCSISEQ
))

479 
	`SETPORT
Ğ
DMACNTRL1
, 0 );

480 
i
=0; i<16; i++)

481 
	`SETPORT
Ğ
STACK
, 
i
 );

483 
	`SETPORT
Ğ
DMACNTRL1
, 0 );

484 
i
=0; i<16 && 
	`GETPORT
(
STACK
)==i; i++)

487 (
i
==16);

488 
	}
}

490 
	$aha152x_d‘eù
(
ho¡no
)

492 
i
, 
j
, 
ok
;

493 
aha152x_cÚfig
 
cÚf
;

494 
sigaùiÚ
 
§
;

495 
š‹¼u±_Ëv–
;

497 #ià
	`defšed
(
DEBUG_RACE
)

498 
	`’‹r_driv”
("detect");

501 
	`´štk
("aha152x: Probing: ");

503 if(
£tup_ÿÎed
)

505 
	`´štk
("processing commandline: ");

507 if(
£tup_ÿÎed
!=4)

509 
	`´štk
("\Çha152x: %s\n", 
£tup_¡r
 );

510 
	`´štk
("aha152x: usage:‡ha152x=<PORTBASE>,<IRQ>,<SCSI ID>,<RECONNECT>\n");

511 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

514 
pÜt_ba£
 = 
£tup_pÜtba£
;

515 
š‹¼u±_Ëv–
 = 
£tup_œq
;

516 
this_ho¡
 = 
£tup_scsiid
;

517 
ÿn_discÚÃù
 = 
£tup_»cÚÃù
;

519  
i
=0; i<
PORT_COUNT
 && (
pÜt_ba£
 !ğ
pÜts
[i]); i++)

522 if(
i
==
PORT_COUNT
)

524 
	`´štk
("unknowÀpÜtba£ 0x%03x\n", 
pÜt_ba£
);

525 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

528 if(!
	`aha152x_pÜ‰e¡
(
pÜt_ba£
))

530 
	`´štk
("pÜtba£ 0x%03x fa ´obe\n", 
pÜt_ba£
);

531 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

534 
i
=0;

535 
šts
[
i
] && (
š‹¼u±_Ëv–
!=ints[i]))

536 
i
++;

537 if(!
šts
[
i
])

539 
	`´štk
("Ëg® IRQ %d\n", 
š‹¼u±_Ëv–
);

540 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

543 ifĞ(
this_ho¡
 < 0) || (this_host > 7) )

545 
	`´štk
("Ëg® SCSI ID %d\n", 
this_ho¡
);

546 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

549 ifĞ(
ÿn_discÚÃù
 < 0) || (can_disconnect > 1) )

551 
	`´štk
("»cÚÃù %d should b0 o¸1\n", 
ÿn_discÚÃù
);

552 
	`·nic
("aha152x…ªic š†š%d", 
__LINE__
);

554 
	`´štk
("ok, ");

558 #ià!
	`defšed
(
SKIP_BIOSTEST
)

559 
	`´štk
("BIOSest: ");

560 
ok
=0;

561  
i
=0; i < 
ADDRESS_COUNT
 && !
ok
; i++)

562  
j
=0; (j < 
SIGNATURE_COUNT
è&& !
ok
; j++)

563 
ok
=!
	`memcmp
((*è
add»s£s
[
i
]+
sigÇtu»s
[
j
].
sig_off£t
,

564 (*è
sigÇtu»s
[
j
].
sigÇtu»
,

565 (è
sigÇtu»s
[
j
].
sig_Ëngth
);

567 if(!
ok
)

569 #ià
	`defšed
(
DEBUG_RACE
)

570 
	`Ëave_driv”
("(1) detect");

572 
	`´štk
("failed\n");

575 
	`´štk
("ok, ");

578 #ià!
	`defšed
(
PORTBASE
)

579 
	`´štk
("porttest: ");

580  
i
=0; i<
PORT_COUNT
 && !
	`aha152x_pÜ‰e¡
(
pÜts
[i]); i++)

583 if(
i
==
PORT_COUNT
)

585 
	`´štk
("failed\n");

586 #ià
	`defšed
(
DEBUG_RACE
)

587 
	`Ëave_driv”
("(2) detect");

592 
pÜt_ba£
=
pÜts
[
i
];

593 
	`´štk
("ok, ");

595 
pÜt_ba£
=
PORTBASE
;

598 #ià
	`defšed
(
AUTOCONF
)

600 
cÚf
.
cf_pÜt
 = (
	`GETPORT
(
PORTA
)<<8è+ GETPORT(
PORTB
);

602 
š‹¼u±_Ëv–
 = 
šts
[
cÚf
.
cf_œq
];

603 
this_ho¡
 = 
cÚf
.
cf_id
;

604 
ÿn_discÚÃù
 = 
cÚf
.
cf_rdisc
;

606 
	`´štk
("auto configuration: ok, ");

610 #ià
	`defšed
(
IRQ
)

611 
š‹¼u±_Ëv–
 = 
IRQ
;

614 #ià
	`defšed
(
SCSI_ID
)

615 
this_ho¡
 = 
SCSI_ID
;

618 #ià
	`defšed
(
RECONNECT
)

619 
ÿn_discÚÃù
=
RECONNECT
;

623 
	`´štk
("detection complete\n");

625 
§
.
§_hªdËr
 = 
aha152x_šŒ
;

626 
§
.
§_æags
 = 
SA_INTERRUPT
;

627 
§
.
§_mask
 = 0;

628 
§
.
§_»¡Ü”
 = 
NULL
;

630 
ok
 = 
	`œqaùiÚ
Ğ
š‹¼u±_Ëv–
, &
§
);

632 if(
ok
<0)

634 if(
ok
 =ğ-
EINVAL
)

636 
	`´štk
("aha152x: bad IRQ %d.\n", 
š‹¼u±_Ëv–
);

637 
	`´štk
(" Contact‡uthor.\n");

640 ifĞ
ok
 =ğ-
EBUSY
)

641 
	`´štk
( "aha152x: IRQ %d‡lready in use. Configure‡nother.\n",

642 
š‹¼u±_Ëv–
);

645 
	`´štk
( "\naha152x: Unexpectedƒrror code on„equesting IRQ %d.\n",

646 
š‹¼u±_Ëv–
);

647 
	`´štk
(" Contact‡uthor.\n");

649 
	`·nic
("aha152x: driver‚eeds‡n IRQ.\n");

652 
	`SETPORT
Ğ
SCSIID
, 
this_ho¡
 << 4 );

653 
scsi_ho¡s
[
ho¡no
].
this_id
=
this_ho¡
;

655 if(
ÿn_discÚÃù
)

656 
scsi_ho¡s
[
ho¡no
].
ÿn_queue
=
AHA152X_MAXQUEUE
;

659 
	`SETBITS
(
SCSISEQ
, 
SCSIRSTO
 );

660 
	`do_·u£
(5);

661 
	`CLRBITS
(
SCSISEQ
, 
SCSIRSTO
 );

662 
	`do_·u£
(10);

664 
	`aha152x_»£t
(
NULL
);

666 
	`´štk
("aha152x: vital data: PORTBASE=0x%03x, IRQ=%d, SCSI ID=%d,„econnect=%s,…arity=enabled\n",

667 
pÜt_ba£
, 
š‹¼u±_Ëv–
, 
this_ho¡
, 
ÿn_discÚÃù
 ? "enabled" : "disabled" );

669 
	`¢¬f_»giÚ
(
pÜt_ba£
, 
TEST
-
SCSISEQ
);

672 
	`SETPORT
(
SIMODE0
, 0);

673 
	`SETPORT
(
SIMODE1
, 0);

675 #ià
	`defšed
(
DEBUG_RACE
)

676 
	`Ëave_driv”
("(3) detect");

679 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
);

681 
	}
}

686 cÚ¡ *
	$aha152x_šfo
()

688 #ià
	`defšed
(
DEBUG_RACE
)

689 
	`’‹r_driv”
("info");

690 
	`Ëave_driv”
("info");

692 #ià
	`defšed
(
DEBUG_INFO
)

693 
	`´štk
("\naha152x: info()\n");

696 (
aha152x_id
);

697 
	}
}

702 
aha152x_queue
Ğ
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

704 #ià
	`defšed
(
DEBUG_RACE
)

705 
	`’‹r_driv”
("queue");

707 #ià
	`defšed
(
DEBUG_QUEUE
)

708 
	`´štk
("aha152x: queue(), ");

713 #ià
	`defšed
(
DEBUG_QUEUE
)

714 
	`´štk
( "SCpnt (target = %d†un = %d cmnd = 0x%02x…ieces = %d size = %u), ",

715 
SC²t
->
rg‘
,

716 
SC²t
->
lun
,

717 *(*)
SC²t
->
cmnd
,

718 
SC²t
->
u£_sg
,

719 
SC²t
->
»que¡_bufæ’
 );

720 
	`di¥_pÜts
();

723 
SC²t
->
scsi_dÚe
 = 
dÚe
;

731 
SC²t
->
SCp
.
pha£
 = 
nÙ_issued
;

732 ià(
SC²t
->
u£_sg
)

734 
SC²t
->
SCp
.
bufãr
 = (
sÿ‰”li¡
 *)SC²t->
»que¡_bufãr
;

735 
SC²t
->
SCp
.
±r
 = SC²t->SCp.
bufãr
->
add»ss
;

736 
SC²t
->
SCp
.
this_»sidu®
 = SC²t->SCp.
bufãr
->
Ëngth
;

737 
SC²t
->
SCp
.
bufãrs_»sidu®
 = SC²t->
u£_sg
 - 1;

741 
SC²t
->
SCp
.
±r
 = (*)SC²t->
»que¡_bufãr
;

742 
SC²t
->
SCp
.
this_»sidu®
 = SC²t->
»que¡_bufæ’
;

743 
SC²t
->
SCp
.
bufãr
 = 
NULL
;

744 
SC²t
->
SCp
.
bufãrs_»sidu®
 = 0;

747 
SC²t
->
SCp
.
Stus
 = 
CHECK_CONDITION
;

748 
SC²t
->
SCp
.
Mes§ge
 = 0;

749 
SC²t
->
SCp
.
have_d©a_š
 = 0;

750 
SC²t
->
SCp
.
£Á_commªd
 = 0;

753 
	`şi
();

754 
commªds
++;

755 if(
commªds
==1)

756 
	`SETPORT
Ğ
PORTA
, 1 );

758 #ià
	`defšed
(
DEBUG_QUEUES
)

759 
	`´štk
("i+ (%d), ", 
commªds
 );

761 
	`­³nd_SC
Ğ&
issue_SC
, 
SC²t
);

764 if(!
cu¼’t_SC
)

766 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

767 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

769 
	`¡i
();

772 
	}
}

777 
	$aha152x_commªd
Ğ
Scsi_Cmnd
 *
SC²t
 )

779 
	`´štk
( "aha152x: interrupt driven driver; use‡ha152x_queue()\n" );

781 
	}
}

787 
	$aha152x_abÜt
Ğ
Scsi_Cmnd
 *
SC²t
, 
code
 )

789 
Scsi_Cmnd
 *
±r
, *
´ev
;

791 
	`şi
();

793 #ià
	`defšed
(
DEBUG_ABORT
)

794 
	`´štk
("aha152x:‡bÜt(), SC²t=0x%08x, ", (è
SC²t
 );

797 
	`show_queues
();

800  
±r
=
issue_SC
, 
´ev
=
NULL
;

801 
±r
 &&…Œ!=
SC²t
;

802 
´ev
=
±r
,…Œ=(
Scsi_Cmnd
 *è±r->
ho¡_süibbË
)

805 if(
±r
)

808 if(
´ev
)

809 
´ev
->
ho¡_süibbË
 = 
±r
->host_scribble;

811 
issue_SC
 = (
Scsi_Cmnd
 *è
±r
->
ho¡_süibbË
;

812 
	`¡i
();

814 
±r
->
ho¡_süibbË
 = 
NULL
;

815 
±r
->
»suÉ
 = (
code
 ? cod: 
DID_ABORT
 ) << 16;

816 
±r
->
	`dÚe
(ptr);

821 ià(
cu¼’t_SC
)

823 
	`¡i
();

828  
±r
=
discÚÃùed_SC
, 
´ev
=
NULL
;

829 
±r
 &&…Œ!=
SC²t
;

830 
´ev
=
±r
,…Œ=(
Scsi_Cmnd
 *è±r->
ho¡_süibbË
)

833 if(
±r
 && 
	`TESTLO
(
SSTAT1
, 
BUSFREE
) )

834 
	`´štk
("bus busy but‚o current command, ");

836 if(
±r
 && 
	`TESTHI
(
SSTAT1
, 
BUSFREE
) )

839 if(
´ev
)

840 
´ev
->
ho¡_süibbË
 = 
±r
->host_scribble;

842 
issue_SC
 = (
Scsi_Cmnd
 *è
±r
->
ho¡_süibbË
;

846 
cu¼’t_SC
 = 
±r
;

847 
±r
->
SCp
.
pha£
 = 
š_£ËùiÚ
|
abÜ‹d
;

848 
	`SETPORT
Ğ
SCSIID
, (
this_ho¡
 << 
OID_
è| 
cu¼’t_SC
->
rg‘
 );

851 
	`SETPORT
Ğ
SIMODE0
, 
ENSELDO
 | (
discÚÃùed_SC
 ? 
ENSELDI
 : 0) );

852 
	`SETPORT
Ğ
SIMODE1
, 
ENSELTIMO
 );

855 
	`SETBITS
(
SCSISEQ
, 
ENSELO
 | 
ENAUTOATNO
 );

857 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

858 
abÜt_»suÉ
=0;

859 
	`¡i
();

862 
	`¦“p_Ú
Ğ&
abÜtiÚ_com¶‘e
 );

863  
abÜt_»suÉ
;

866 
	`´štk
("aha152x: bus busy but‚o current command\n");

869 
	`¡i
();

871 
	}
}

876 
	$aha152x_»£t_pÜts
()

879 
	`SETPORT
(
DMACNTRL0
, 
RSTFIFO
);

881 
	`SETPORT
(
SCSISEQ
, 0);

883 
	`SETPORT
(
SXFRCTL1
, 0);

884 
	`SETPORT
Ğ
SCSISIG
, 0);

885 
	`SETPORT
(
SCSIRATE
, 0);

888 
	`SETPORT
(
SSTAT0
, 0x7f);

889 
	`SETPORT
(
SSTAT1
, 0xef);

891 
	`SETPORT
(
SSTAT4
, 
SYNCERR
|
FWERR
|
FRERR
);

893 
	`SETPORT
(
DMACNTRL0
, 0);

894 
	`SETPORT
(
DMACNTRL1
, 0);

896 
	`SETPORT
(
BRSTCNTRL
, 0xf1);

899 
	`SETPORT
(
SXFRCTL0
, 
CH1
|
CLRCH1
|
CLRSTCNT
);

900 
	`SETPORT
(
SXFRCTL0
, 
CH1
);

903 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

904 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

905 
	}
}

911 
	$aha152x_»£t
(
Scsi_Cmnd
 * 
__unu£d
)

913 
Scsi_Cmnd
 *
±r
;

915 
	`aha152x_»£t_pÜts
();

918 ifĞ
	`TESTLO
Ğ
SSTAT1
, 
BUSFREE
 ) )

920 
	`CLRBITS
Ğ
DMACNTRL0
, 
INTEN
 );

922 #ià
	`defšed
Ğ
DEBUG_RESET
 )

923 
	`´štk
("aha152x:„eset(), bus‚ot free: SCSI RESET OUT\n");

926 
	`show_queues
();

928 if(
cu¼’t_SC
)

930 
cu¼’t_SC
->
ho¡_süibbË
 = 
NULL
;

931 
cu¼’t_SC
->
»suÉ
 = 
DID_RESET
 << 16;

932 
cu¼’t_SC
->
	`dÚe
(current_SC);

933 
cu¼’t_SC
=
NULL
;

936 
discÚÃùed_SC
)

938 
±r
 = 
discÚÃùed_SC
;

939 
discÚÃùed_SC
 = (
Scsi_Cmnd
 *è
±r
->
ho¡_süibbË
;

940 
±r
->
ho¡_süibbË
 = 
NULL
;

941 
±r
->
»suÉ
 = 
DID_RESET
 << 16;

942 
±r
->
	`dÚe
(ptr);

946 
	`SETPORT
(
SCSISEQ
, 
SCSIRSTO
);

947 
	`do_·u£
(5);

948 
	`SETPORT
(
SCSISEQ
, 0);

949 
	`do_·u£
(10);

951 
	`SETPORT
(
SIMODE0
, 0 );

952 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

954 
	`SETPORT
Ğ
DMACNTRL0
, 
INTEN
 );

958 
	}
}

963 
	$aha152x_bio¥¬am
Ğ
size
, 
dev
, *
šfo_¬¿y
 )

965 #ià
	`defšed
(
DEBUG_RACE
)

966 
	`’‹r_driv”
("biosparam");

968 #ià
	`defšed
(
DEBUG_BIOSPARAM
)

969 
	`´štk
("\naha152x: biosparam(), ");

973 #ià
	`defšed
(
DEBUG_BIOSPARAM
)

974 
	`´štk
("dev=%x, size=%d, ", 
dev
, 
size
);

979 
šfo_¬¿y
[0]=64;

980 
šfo_¬¿y
[1]=32;

981 
šfo_¬¿y
[2]=
size
>>11;

983 #ià
	`defšed
(
DEBUG_BIOSPARAM
)

984 
	`´štk
("bios geometry: head=%d, sec=%d, cyl=%d\n",

985 
šfo_¬¿y
[0], info_array[1], info_array[2]);

986 
	`´štk
("WARNING: check, ifhe bios geometry is correct.\n");

989 #ià
	`defšed
(
DEBUG_RACE
)

990 
	`Ëave_driv”
("biosparam");

993 
	}
}

998 
	$aha152x_dÚe
Ğ
”rÜ
 )

1000 
Scsi_Cmnd
 *
dÚe_SC
;

1002 #ià
	`defšed
(
DEBUG_DONE
)

1003 
	`´štk
("\naha152x: done(), ");

1004 
	`di¥_pÜts
();

1007 ià(
cu¼’t_SC
)

1009 #ià
	`defšed
(
DEBUG_DONE
)

1010 
	`´štk
("dÚe(%x), ", 
”rÜ
);

1013 
	`şi
();

1015 
dÚe_SC
 = 
cu¼’t_SC
;

1016 
cu¼’t_SC
 = 
NULL
;

1019 
commªds
--;

1020 if(!
commªds
)

1021 
	`SETPORT
Ğ
PORTA
, 0 );

1023 #ià
	`defšed
(
DEBUG_QUEUES
)

1024 
	`´štk
("ok (%d), ", 
commªds
);

1026 
	`¡i
();

1028 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

1029 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

1031 #ià
	`defšed
(
DEBUG_PHASES
)

1032 
	`´štk
("BUS FREE†oop, ");

1034  
	`TESTLO
Ğ
SSTAT1
, 
BUSFREE
 ) )

1036 #ià
	`defšed
(
DEBUG_PHASES
)

1037 
	`´štk
("BUS FREE\n");

1040 
dÚe_SC
->
»suÉ
 = 
”rÜ
;

1041 if(
dÚe_SC
->
scsi_dÚe
)

1043 #ià
	`defšed
(
DEBUG_DONE
)

1044 
	`´štk
("calling scsi_done, ");

1046 
dÚe_SC
->
	`scsi_dÚe
( done_SC );

1047 #ià
	`defšed
(
DEBUG_DONE
)

1048 
	`´štk
("done„eturned, ");

1052 
	`·nic
( "aha152x: current_SC->scsi_done() == NULL" );

1055 
	`aha152x_·nic
( "done() called outside of command" );

1056 
	}
}

1061 
	$aha152x_šŒ
Ğ
œqno
 )

1063 
dÚe
=0, 
pha£
;

1065 #ià
	`defšed
(
DEBUG_RACE
)

1066 
	`’‹r_driv”
("intr");

1068 #ià
	`defšed
(
DEBUG_INTR
)

1069 
	`´štk
("\naha152x: intr(), ");

1077 
	`CLRBITS
Ğ
DMACNTRL0
, 
INTEN
);

1078 
	`¡i
();

1084 ifĞ
	`TESTHI
Ğ
SSTAT0
, 
SELDI
 ) &&

1085 
discÚÃùed_SC
 &&

1086 Ğ!
cu¼’t_SC
 || ( cu¼’t_SC->
SCp
.
pha£
 & 
š_£ËùiÚ
 ) )

1089 
id’tify_msg
, 
rg‘
, 
i
;

1093 if(
cu¼’t_SC
)

1095 #ià
	`defšed
(
DEBUG_QUEUES
)

1096 
	`´štk
("i+, ");

1098 
	`şi
();

1099 
	`­³nd_SC
Ğ&
issue_SC
, 
cu¼’t_SC
);

1100 
cu¼’t_SC
=
NULL
;

1101 
	`¡i
();

1105 
	`SETPORT
Ğ
SCSISEQ
, 0 );

1106 
	`SETPORT
Ğ
SSTAT0
, 
CLRSELDI
 );

1107 
	`SETPORT
Ğ
SSTAT1
, 
CLRBUSFREE
 );

1109 #ià
	`defšed
(
DEBUG_QUEUES
è|| defšed(
DEBUG_PHASES
)

1110 
	`´štk
("reselected, ");

1113 
i
 = 
	`GETPORT
(
SELID
è& ~(1 << 
this_ho¡
);

1114 
rg‘
=0;

1115 if(
i
)

1116  ; (
i
 & 1)==0; 
rg‘
++, i>>=1)

1119 
	`aha152x_·nic
("reconnectingarget unknown");

1121 #ià
	`defšed
(
DEBUG_QUEUES
)

1122 
	`´štk
("SELID=%02x,¬g‘=%d, ", 
	`GETPORT
(
SELID
), 
rg‘
 );

1124 
	`SETPORT
Ğ
SCSIID
, (
this_ho¡
 << 
OID_
è| 
rg‘
 );

1125 
	`SETPORT
Ğ
SCSISEQ
, 
ENRESELI
 );

1127 if(
	`TESTLO
Ğ
SSTAT0
, 
SELDI
 ))

1128 
	`aha152x_·nic
("RESELI failed");

1130 
	`SETPORT
Ğ
SCSISIG
, 
P_MSGI
 );

1133 if((
i
=
	`g‘pha£
())!=
P_MSGI
)

1135 
	`´štk
("rg‘ dÛ¢'ˆ’‹¸MSGIØid’tify (pha£=%02x)\n", 
i
);

1136 
	`aha152x_·nic
("unknown†un");

1138 
	`SETPORT
Ğ
SCSISEQ
, 0 );

1140 
	`SETPORT
Ğ
SXFRCTL0
, 
CH1
);

1142 
id’tify_msg
 = 
	`GETPORT
(
SCSIBUS
);

1144 if(!(
id’tify_msg
 & 
IDENTIFY_BASE
))

1146 
	`´štk
("target=%d, inbound message (%02x) != IDENTIFY\n",

1147 
rg‘
, 
id’tify_msg
);

1148 
	`aha152x_·nic
("unknown†un");

1151 
	`make_acklow
();

1152 
	`g‘pha£
();

1154 #ià
	`defšed
(
DEBUG_QUEUES
)

1155 
	`´štk
("id’tify=%02x,†un=%d, ", 
id’tify_msg
, identify_msg & 0x3f );

1158 
	`şi
();

1159 #ià
	`defšed
(
DEBUG_QUEUES
)

1160 
	`´štk
("d-, ");

1162 
cu¼’t_SC
 = 
	`»move_SC
Ğ&
discÚÃùed_SC
,

1163 
rg‘
,

1164 
id’tify_msg
 & 0x3f );

1166 if(!
cu¼’t_SC
)

1168 
	`´štk
("lun=%d, ", 
id’tify_msg
 & 0x3f );

1169 
	`aha152x_·nic
("no disconnected command forhat†un");

1172 
cu¼’t_SC
->
SCp
.
pha£
 &ğ~
discÚÃùed
;

1173 
	`¡i
();

1175 
	`SETPORT
Ğ
SIMODE0
, 0 );

1176 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
 );

1177 #ià
	`defšed
(
DEBUG_RACE
)

1178 
	`Ëave_driv”
("(reselected) intr");

1180 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
);

1185 if(!
cu¼’t_SC
)

1188 if(
	`TESTHI
Ğ
SSTAT1
, 
BUSFREE
è&& 
issue_SC
)

1190 
	`şi
();

1191 #ià
	`defšed
(
DEBUG_QUEUES
)

1192 
	`´štk
("i-, ");

1194 
cu¼’t_SC
 = 
	`»move_fœ¡_SC
Ğ&
issue_SC
 );

1195 
	`¡i
();

1197 #ià
	`defšed
(
DEBUG_INTR
è|| defšed(
DEBUG_SELECTION
è|| defšed(
DEBUG_PHASES
)

1198 
	`´štk
("issueing command, ");

1200 
cu¼’t_SC
->
SCp
.
pha£
 = 
š_£ËùiÚ
;

1202 #ià
	`defšed
(
DEBUG_INTR
è|| defšed(
DEBUG_SELECTION
è|| defšed(
DEBUG_PHASES
)

1203 
	`´štk
("£Ëùšg %d, ", 
cu¼’t_SC
->
rg‘
);

1205 
	`SETPORT
Ğ
SCSIID
, (
this_ho¡
 << 
OID_
è| 
cu¼’t_SC
->
rg‘
 );

1208 
	`SETPORT
Ğ
SXFRCTL1
, 
ENSPCHK
|
ENSTIMER
);

1211 
	`SETPORT
Ğ
SIMODE0
, 
ENSELDO
 | (
discÚÃùed_SC
 ? 
ENSELDI
 : 0) );

1212 
	`SETPORT
Ğ
SIMODE1
, 
ENSELTIMO
 );

1215 
	`SETBITS
(
SCSISEQ
, 
ENSELO
 | 
ENAUTOATNO
 );

1217 #ià
	`defšed
(
DEBUG_RACE
)

1218 
	`Ëave_driv”
("(selecting) intr");

1220 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

1225 
	`´štk
("aha152x: ignoring spurious interrupt,‚othingo do\n");

1231 #ià
	`defšed
(
DEBUG_INTR
)

1232 
	`di¥_pÜts
();

1236 if(
cu¼’t_SC
->
SCp
.
pha£
 & 
š_£ËùiÚ
)

1238 ifĞ
	`TESTLO
Ğ
SSTAT1
, 
SELTO
 ) )

1240 ifĞ
	`TESTHI
Ğ
SSTAT0
, 
SELDO
 ) )

1243 
	`SETPORT
Ğ
SSTAT1
, 
CLRBUSFREE
);

1246 
	`CLRBITS
(
SCSISEQ
, 
ENSELO
|
ENAUTOATNO
 );

1249 
	`CLRBITS
(
SIMODE0
, 
ENSELDO
);

1250 
	`CLRBITS
(
SIMODE1
, 
ENSELTIMO
);

1252 ifĞ
	`TESTLO
(
SSTAT0
, 
SELDO
) )

1254 
	`´štk
("aha152x:…assing bus free condition\n");

1256 #ià
	`defšed
(
DEBUG_RACE
)

1257 
	`Ëave_driv”
("(passing bus free) intr");

1259 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
);

1261 if(
cu¼’t_SC
->
SCp
.
pha£
 & 
abÜ‹d
)

1263 
abÜt_»suÉ
=1;

1264 
	`wake_up
Ğ&
abÜtiÚ_com¶‘e
 );

1267 
	`aha152x_dÚe
Ğ
DID_NO_CONNECT
 << 16 );

1270 #ià
	`defšed
(
DEBUG_SELECTION
è|| defšed(
DEBUG_PHASES
)

1271 
	`´štk
("SELDO (SELID=%x), ", 
	`GETPORT
(
SELID
));

1275 
	`SETPORT
Ğ
SSTAT0
, 
CLRSELDO
 );

1277 #ià
	`defšed
(
DEBUG_ABORT
)

1278 if(
cu¼’t_SC
->
SCp
.
pha£
 & 
abÜ‹d
)

1279 
	`´štk
("(ABORT)arget selected, ");

1282 
cu¼’t_SC
->
SCp
.
pha£
 &ğ~
š_£ËùiÚ
;

1283 
cu¼’t_SC
->
SCp
.
pha£
 |ğ
š_Ùh”
;

1285 #ià
	`defšed
(
DEBUG_RACE
)

1286 
	`Ëave_driv”
("(SELDO) intr");

1289 
	`SETPORT
Ğ
SCSISIG
, 
P_MSGO
 );

1291 
	`SETPORT
Ğ
SIMODE0
, 0 );

1292 
	`SETPORT
Ğ
SIMODE1
, 
ENREQINIT
 );

1293 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
);

1297 
	`aha152x_·nic
("neitherimeout‚or selection\007");

1300 #ià
	`defšed
(
DEBUG_SELECTION
è|| defšed(
DEBUG_PHASES
)

1301 
	`´štk
("SELTO, ");

1304 
	`CLRBITS
(
SCSISEQ
, 
ENSELO
|
ENAUTOATNO
 );

1307 
	`SETPORT
Ğ
SSTAT1
, 
CLRSELTIMO
 );

1309 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

1310 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

1311 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

1312 #ià
	`defšed
(
DEBUG_RACE
)

1313 
	`Ëave_driv”
("(SELTO) intr");

1316 if(
cu¼’t_SC
->
SCp
.
pha£
 & 
abÜ‹d
)

1318 #ià
	`defšed
(
DEBUG_ABORT
)

1319 
	`´štk
("(ABORT) selectionimeout, ");

1321 
abÜt_»suÉ
=1;

1322 
	`wake_up
Ğ&
abÜtiÚ_com¶‘e
 );

1325 ifĞ
	`TESTLO
Ğ
SSTAT0
, 
SELINGO
 ) )

1327 
	`aha152x_dÚe
Ğ
DID_BUS_BUSY
 << 16 );

1330 
	`aha152x_dÚe
Ğ
DID_NO_CONNECT
 << 16 );

1336 
pha£
 = 
	`g‘pha£
();

1337 if(!(
pha£
 & ~
P_MASK
))

1338 
	`SETPORT
(
SCSISIG
, 
pha£
);

1339 
	`SETPORT
(
SSTAT1
, 
CLRPHASECHG
);

1340 
cu¼’t_SC
->
SCp
.
pha£
 =

1341 (
cu¼’t_SC
->
SCp
.
pha£
 & ~((
P_MASK
|1)<<16)) | (phase << 16 );

1344  
pha£
 )

1346 
P_MSGO
:

1348 
mes§ge
;

1350 #ià
	`defšed
(
DEBUG_INTR
è|| defšed(
DEBUG_MSGO
è|| defšed(
DEBUG_PHASES
)

1351 
	`´štk
("MESSAGE OUT, ");

1354 ifĞ
cu¼’t_SC
->
SCp
.
pha£
 & 
abÜ‹d
 )

1356 #ià
	`defšed
(
DEBUG_MSGO
è|| defšed(
DEBUG_ABORT
)

1357 
	`´štk
("ABORT, ");

1359 
mes§ge
=
ABORT
;

1365 ifĞ!(
cu¼’t_SC
->
SCp
.
pha£
 & 
£Á_id’t
))

1367 
mes§ge
=
	`IDENTIFY
(
ÿn_discÚÃù
,
cu¼’t_SC
->
lun
);

1368 #ià
	`defšed
(
DEBUG_MSGO
)

1369 
	`´štk
("IDENTIFY (reconnect=%s;lun=%d), ",

1370 
ÿn_discÚÃù
 ? "’abËd" : "di§bËd", 
cu¼’t_SC
->
lun
);

1375 
mes§ge
=
MESSAGE_REJECT
;

1376 #ià
	`defšed
(
DEBUG_MSGO
)

1377 
	`´štk
("REJECT, ");

1381 
	`CLRBITS
Ğ
SXFRCTL0
, 
ENDMA
);

1383 
	`SETPORT
Ğ
SIMODE0
, 0 );

1384 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
|
ENREQINIT
 );

1387  
	`TESTLO
Ğ
DMASTAT
, 
INTSTAT
 ) )

1390 ifĞ
	`TESTHI
Ğ
SSTAT1
, 
PHASEMIS
 ) )

1391 
	`aha152x_·nic
("unableo send message");

1394 
	`SETPORT
Ğ
SSTAT1
, 
CLRATNO
);

1396 
	`SETPORT
Ğ
SCSIDAT
, 
mes§ge
 );

1398 
	`make_acklow
();

1399 
	`g‘pha£
();

1401 if(
mes§ge
==
	`IDENTIFY
(
ÿn_discÚÃù
,
cu¼’t_SC
->
lun
))

1402 
cu¼’t_SC
->
SCp
.
pha£
 |ğ
£Á_id’t
;

1404 if(
mes§ge
==
ABORT
)

1407 
abÜt_»suÉ
=0;

1408 
	`wake_up
Ğ&
abÜtiÚ_com¶‘e
 );

1410 
cu¼’t_SC
->
SCp
.
pha£
 = (cu¼’t_SC->SCp.pha£ & ~(
P_MASK
<<16));

1413 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

1414 #ià
	`defšed
(
DEBUG_RACE
)

1415 
	`Ëave_driv”
("(ABORT) intr");

1417 
	`aha152x_dÚe
(
DID_ABORT
<<16);

1423 
P_CMD
:

1424 #ià
	`defšed
(
DEBUG_INTR
è|| defšed(
DEBUG_CMD
è|| defšed(
DEBUG_PHASES
)

1425 
	`´štk
("COMMAND, ");

1427 ifĞ!(
cu¼’t_SC
->
SCp
.
£Á_commªd
) )

1429 if(
	`GETPORT
(
FIFOSTAT
è|| GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
))

1430 
	`´štk
("aha152x: P_CMD: %d(%d) bytes†eft in FIFO,„esetting\n",

1431 
	`GETPORT
(
FIFOSTAT
), GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
));

1434 
	`SETPORT
(
DMACNTRL0
, 
WRITE_READ
|
RSTFIFO
);

1435 
	`SETPORT
(
DMACNTRL0
, 
ENDMA
|
WRITE_READ
);

1438 
	`SETPORT
(
SXFRCTL0
, 
CH1
|
CLRSTCNT
|
CLRCH1
 );

1439 
	`SETPORT
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
|
CH1
);

1442 
	`SETPORT
Ğ
SIMODE0
, 0 );

1443 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
 );

1445 #ià
	`defšed
(
DEBUG_CMD
)

1446 
	`´štk
("waiting, ");

1449  
	`TESTLO
 ( 
DMASTAT
, 
DFIFOEMP
|
INTSTAT
 ) )

1452 ifĞ
	`TESTHI
Ğ
SSTAT1
, 
PHASEMIS
 ) )

1453 
	`aha152x_·nic
("target†eft COMMAND…hase");

1455 #ià
	`defšed
(
DEBUG_CMD
)

1456 
	`´štk
("DFIFOEMP, outsw (%d words), ",

1457 
	`COMMAND_SIZE
(
cu¼’t_SC
->
cmnd
[0])>>1);

1458 
	`di¥_pÜts
();

1461 
	`outsw
Ğ
DATAPORT
,

1462 &
cu¼’t_SC
->
cmnd
,

1463 
	`COMMAND_SIZE
(
cu¼’t_SC
->
cmnd
[0])>>1 );

1465 #ià
	`defšed
(
DEBUG_CMD
)

1466 
	`´štk
("FCNT=%d, STCNT=%d, ", 
	`GETPORT
(
FIFOSTAT
), 
	`GETSTCNT
() );

1467 
	`di¥_pÜts
();

1472  
	`TESTLO
 ( 
SSTAT2
, 
SEMPTY
 ) )

1475 
	`CLRBITS
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
);

1477  
	`TESTHI
Ğ
SXFRCTL0
, 
SCSIEN
 ) )

1480 
	`CLRBITS
(
DMACNTRL0
, 
ENDMA
);

1482 #ià
	`defšed
(
DEBUG_CMD
è|| defšed(
DEBUG_INTR
)

1483 
	`´štk
("£Á %d/%d commªd by‹s, ", 
	`GETSTCNT
(),

1484 
	`COMMAND_SIZE
(
cu¼’t_SC
->
cmnd
[0]));

1489 
	`aha152x_·nic
("Nothingo sent while in COMMAND OUT");

1492 
P_MSGI
:

1493 #ià
	`defšed
(
DEBUG_INTR
è|| defšed(
DEBUG_MSGI
è|| defšed(
DEBUG_PHASES
)

1494 
	`´štk
("MESSAGE IN, ");

1496 
	`SETPORT
Ğ
SXFRCTL0
, 
CH1
);

1498 
	`SETPORT
Ğ
SIMODE0
, 0);

1499 
	`SETPORT
Ğ
SIMODE1
, 
ENBUSFREE
);

1501  
pha£
 =ğ
P_MSGI
 )

1503 
cu¼’t_SC
->
SCp
.
Mes§ge
 = 
	`GETPORT
Ğ
SCSIBUS
 );

1504 
cu¼’t_SC
->
SCp
.
Mes§ge
)

1506 
DISCONNECT
:

1507 #ià
	`defšed
(
DEBUG_MSGI
è|| defšed(
DEBUG_PHASES
)

1508 
	`´štk
("target disconnected, ");

1510 
cu¼’t_SC
->
SCp
.
Mes§ge
 = 0;

1511 
cu¼’t_SC
->
SCp
.
pha£
 |ğ
discÚÃùed
;

1512 if(!
ÿn_discÚÃù
)

1513 
	`aha152x_·nic
("target was‚ot‡llowedo disconnect");

1516 
COMMAND_COMPLETE
:

1517 #ià
	`defšed
(
DEBUG_MSGI
è|| defšed(
DEBUG_PHASES
)

1518 
	`´štk
("inbound message ( COMMAND COMPLETE ), ");

1520 
dÚe
++;

1523 
MESSAGE_REJECT
:

1524 #ià
	`defšed
(
DEBUG_MSGI
è|| defšed(
DEBUG_TIMING
)

1525 
	`´štk
("inbound message ( MESSAGE REJECT ), ");

1529 
SAVE_POINTERS
:

1530 #ià
	`defšed
(
DEBUG_MSGI
)

1531 
	`´štk
("inbound message ( SAVE DATA POINTERS ), ");

1535 
EXTENDED_MESSAGE
:

1537 
i
, 
code
;

1539 #ià
	`defšed
(
DEBUG_MSGI
)

1540 
	`´štk
("inbound message ( EXTENDED MESSAGE ), ");

1542 
	`make_acklow
();

1543 if(
	`g‘pha£
()!=
P_MSGI
)

1546 
i
=
	`GETPORT
(
SCSIBUS
);

1548 #ià
	`defšed
(
DEBUG_MSGI
)

1549 
	`´štk
("Ëngth (%d), ", 
i
);

1552 #ià
	`defšed
(
DEBUG_MSGI
)

1553 
	`´štk
("code ( ");

1556 
	`make_acklow
();

1557 if(
	`g‘pha£
()!=
P_MSGI
)

1560 
code
 = 
	`GETPORT
(
SCSIBUS
);

1562  
code
 )

1565 #ià
	`defšed
(
DEBUG_MSGI
)

1566 
	`´štk
("MODIFY DATA POINTER ");

1568 
	`SETPORT
(
SCSISIG
, 
P_MSGI
|
ATNO
);

1571 #ià
	`defšed
(
DEBUG_MSGI
)

1572 
	`´štk
("SYNCHRONOUS DATA TRANSFER REQUEST ");

1574 
	`SETPORT
(
SCSISIG
, 
P_MSGI
|
ATNO
);

1577 #ià
	`defšed
(
DEBUG_MSGI
)

1578 
	`´štk
("EXTENDED IDENTIFY ");

1582 #ià
	`defšed
(
DEBUG_MSGI
)

1583 
	`´štk
("WIDE DATA TRANSFER REQUEST ");

1585 
	`SETPORT
(
SCSISIG
, 
P_MSGI
|
ATNO
);

1588 #ià
	`defšed
(
DEBUG_MSGI
)

1589 ifĞ
code
 & 0x80 )

1590 
	`´štk
("»£rved (%dè", 
code
 );

1592 
	`´štk
("v’dÜ s³cifiø(%dè", 
code
);

1594 
	`SETPORT
(
SCSISIG
, 
P_MSGI
|
ATNO
);

1597 #ià
	`defšed
(
DEBUG_MSGI
)

1598 
	`´štk
(" ), data ( ");

1600  --
i
 && (
	`make_acklow
(), 
	`g‘pha£
()==
P_MSGI
))

1602 #ià
	`defšed
(
DEBUG_MSGI
)

1603 
	`´štk
("%x ", 
	`GETPORT
(
SCSIBUS
) );

1605 
	`GETPORT
(
SCSIBUS
);

1608 #ià
	`defšed
(
DEBUG_MSGI
)

1609 
	`´štk
(" ), ");

1615 
	`SETPORT
(
SCSISIG
, 
P_MSGI
|
ATNO
);

1620 
	`´štk
("unsuµÜ‹d inbound mes§g%x, ", 
cu¼’t_SC
->
SCp
.
Mes§ge
);

1625 
	`make_acklow
();

1626 
pha£
=
	`g‘pha£
();

1630 if(
pha£
==
P_BUSFREE
)

1631 
	`SETPORT
(
SXFRCTL0
, 
CH1
|
CLRCH1
);

1633 if(
cu¼’t_SC
->
SCp
.
pha£
 & 
discÚÃùed
)

1635 
	`şi
();

1636 #ià
	`defšed
(
DEBUG_QUEUES
)

1637 
	`´štk
("d+, ");

1639 
	`­³nd_SC
Ğ&
discÚÃùed_SC
, 
cu¼’t_SC
);

1640 
cu¼’t_SC
 = 
NULL
;

1641 
	`¡i
();

1643 
	`SETBITS
Ğ
SCSISEQ
, 
ENRESELI
 );

1645 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

1646 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

1648 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

1653 
P_STATUS
:

1654 #ià
	`defšed
(
DEBUG_STATUS
è|| defšed(
DEBUG_INTR
è|| defšed(
DEBUG_PHASES
)

1655 
	`´štk
("STATUS, ");

1657 
	`SETPORT
Ğ
SXFRCTL0
, 
CH1
);

1659 
	`SETPORT
Ğ
SIMODE0
, 0 );

1660 
	`SETPORT
Ğ
SIMODE1
, 
ENREQINIT
 );

1662 ifĞ
	`TESTHI
Ğ
SSTAT1
, 
PHASEMIS
 ) )

1663 
	`´štk
("aha152x:…assing STATUS…hase");

1665 
cu¼’t_SC
->
SCp
.
Stus
 = 
	`GETPORT
Ğ
SCSIBUS
 );

1666 
	`make_acklow
();

1667 
	`g‘pha£
();

1669 #ià
	`defšed
(
DEBUG_STATUS
)

1670 
	`´štk
("inbound status ");

1671 
	`´št_¡©us
Ğ
cu¼’t_SC
->
SCp
.
Stus
 );

1672 
	`´štk
(", ");

1676 
P_DATAI
:

1678 
fifod©a
, 
d©a_couÁ
, 
dÚe
;

1680 #ià
	`defšed
(
DEBUG_DATAI
è|| defšed(
DEBUG_INTR
è|| defšed(
DEBUG_PHASES
)

1681 
	`´štk
("DATA IN, ");

1684 if(
	`GETPORT
(
FIFOSTAT
è|| GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
))

1685 
	`´štk
("aha152x: P_DATAI: %d(%d) bytes†eft in FIFO,„esetting\n",

1686 
	`GETPORT
(
FIFOSTAT
), GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
));

1689 
	`SETPORT
(
DMACNTRL0
, 
RSTFIFO
);

1690 
	`SETPORT
(
DMACNTRL0
, 
RSTFIFO
|
ENDMA
);

1692 
	`SETPORT
(
SXFRCTL0
, 
CH1
|
SCSIEN
|
DMAEN
 );

1694 
	`SETPORT
Ğ
SIMODE0
, 0 );

1695 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
|
ENBUSFREE
 );

1698 
dÚe
=0;

1701  !
dÚe
 )

1703 #ià
	`defšed
(
DEBUG_DATAI
)

1704 
	`´štk
("expecting data, ");

1707  
	`TESTLO
 ( 
DMASTAT
, 
DFIFOFULL
|
INTSTAT
 ) )

1710 ifĞ
	`TESTHI
Ğ
DMASTAT
, 
DFIFOFULL
 ) )

1711 
fifod©a
=132;

1715  
	`TESTLO
Ğ
SSTAT2
, 
SEMPTY
 ) )

1719 
fifod©a
=
	`GETPORT
(
FIFOSTAT
);

1720 #ià
	`defšed
(
DEBUG_DATAI
)

1721 
	`´štk
("lastransfer, ");

1723 
dÚe
=1;

1726 #ià
	`defšed
(
DEBUG_DATAI
)

1727 
	`´štk
("fifod©a=%d, ", 
fifod©a
);

1730  
fifod©a
 && 
cu¼’t_SC
->
SCp
.
this_»sidu®
 )

1732 
d©a_couÁ
=
fifod©a
;

1735 ià(
d©a_couÁ
 > 
cu¼’t_SC
->
SCp
.
this_»sidu®
)

1736 
d©a_couÁ
 = 
cu¼’t_SC
->
SCp
.
this_»sidu®
;

1738 
fifod©a
 -ğ
d©a_couÁ
;

1740 #ià
	`defšed
(
DEBUG_DATAI
)

1741 
	`´štk
("d©a_couÁ=%d, ", 
d©a_couÁ
);

1744 if(
d©a_couÁ
 == 1)

1747 
	`SETBITS
(
DMACNTRL0
, 
_8BIT
 );

1748 *
cu¼’t_SC
->
SCp
.
±r
++ = 
	`GETPORT
Ğ
DATAPORT
 );

1749 
cu¼’t_SC
->
SCp
.
this_»sidu®
--;

1753 
	`CLRBITS
(
DMACNTRL0
, 
_8BIT
 );

1754 
d©a_couÁ
 >>= 1;

1755 
	`šsw
Ğ
DATAPORT
, 
cu¼’t_SC
->
SCp
.
±r
, 
d©a_couÁ
 );

1756 #ià
	`defšed
(
DEBUG_DATAI
)

1758 if(
dÚe
)

1760 
i
;

1761 *
d©a
;

1763 
	`´štk
("data on†astransfer (%d bytes: ",

1764 2*
d©a_couÁ
);

1765 
d©a
 = (*è
cu¼’t_SC
->
SCp
.
±r
;

1766  
i
=0; i<2*
d©a_couÁ
; i++)

1767 
	`´štk
("%2x ", *
d©a
++);

1768 
	`´štk
("), ");

1771 
cu¼’t_SC
->
SCp
.
±r
 +ğ2 * 
d©a_couÁ
;

1772 
cu¼’t_SC
->
SCp
.
this_»sidu®
 -ğ2 * 
d©a_couÁ
;

1776 ià(!
cu¼’t_SC
->
SCp
.
this_»sidu®
 &&

1777 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
)

1780 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
--;

1781 
cu¼’t_SC
->
SCp
.
bufãr
++;

1782 
cu¼’t_SC
->
SCp
.
±r
 =

1783 
cu¼’t_SC
->
SCp
.
bufãr
->
add»ss
;

1784 
cu¼’t_SC
->
SCp
.
this_»sidu®
 =

1785 
cu¼’t_SC
->
SCp
.
bufãr
->
Ëngth
;

1792 if(
fifod©a
>1)

1794 
	`´štk
("aha152x: more datahanƒxpected (%d bytes)\n",

1795 
	`GETPORT
(
FIFOSTAT
));

1798 #ià
	`defšed
(
DEBUG_DATAI
)

1799 if(!
fifod©a
)

1800 
	`´štk
("fifoƒmpty, ");

1802 
	`´štk
("something†eft in fifo, ");

1806 #ià
	`defšed
(
DEBUG_DATAI
)

1807 if(
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
 || cu¼’t_SC->SCp.
this_»sidu®
)

1808 
	`´štk
("left buffers (buffers=%d, bytes=%d), ",

1809 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
,

1810 
cu¼’t_SC
->
SCp
.
this_»sidu®
);

1813 
	`CLRBITS
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
);

1814  
	`TESTHI
Ğ
SXFRCTL0
, 
SCSIEN
 ) )

1816 
	`CLRBITS
(
DMACNTRL0
, 
ENDMA
 );

1818 #ià
	`defšed
(
DEBUG_DATAI
è|| defšed(
DEBUG_INTR
)

1819 
	`´štk
("gÙ %d by‹s, ", 
	`GETSTCNT
());

1822 
cu¼’t_SC
->
SCp
.
have_d©a_š
++;

1826 
P_DATAO
:

1828 
d©a_couÁ
;

1830 #ià
	`defšed
(
DEBUG_DATAO
è|| defšed(
DEBUG_INTR
è|| defšed(
DEBUG_PHASES
)

1831 
	`´štk
("DATA OUT, ");

1833 #ià
	`defšed
(
DEBUG_DATAO
)

1834 
	`´štk
("got datao send (bytes=%d, buffers=%d), ",

1835 
cu¼’t_SC
->
SCp
.
this_»sidu®
,

1836 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
 );

1839 if(
	`GETPORT
(
FIFOSTAT
è|| GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
) )

1841 
	`´štk
("%d(%dèËá iÀFIFO, ", 
	`GETPORT
(
FIFOSTAT
), GETPORT(
SSTAT2
è& (
SFULL
|
SFCNT
) );

1842 
	`aha152x_·nic
("FIFO should beƒmpty");

1845 
	`SETPORT
(
DMACNTRL0
, 
WRITE_READ
|
RSTFIFO
);

1846 
	`SETPORT
(
DMACNTRL0
, 
ENDMA
|
WRITE_READ
);

1848 
	`SETPORT
(
SXFRCTL0
, 
CH1
|
CLRSTCNT
|
CLRCH1
 );

1849 
	`SETPORT
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
|
CH1
);

1851 
	`SETPORT
Ğ
SIMODE0
, 0 );

1852 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
 );

1856  
	`TESTLO
Ğ
SSTAT1
, 
PHASEMIS
 ) &&

1857 (
cu¼’t_SC
->
SCp
.
this_»sidu®
 ||

1858 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
) )

1860 #ià
	`defšed
(
DEBUG_DATAO
)

1861 
	`´štk
("sending data (left: bytes=%d, buffers=%d), waiting, ",

1862 
cu¼’t_SC
->
SCp
.
this_»sidu®
,

1863 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
);

1866 
d©a_couÁ
 = 
cu¼’t_SC
->
SCp
.
this_»sidu®
 > 128 ?

1867 128 : 
cu¼’t_SC
->
SCp
.
this_»sidu®
 ;

1869 #ià
	`defšed
(
DEBUG_DATAO
)

1870 
	`´štk
("d©a_couÁ=%d, ", 
d©a_couÁ
);

1873 if(
d©a_couÁ
 == 1)

1876 
	`SETBITS
(
DMACNTRL0
, 
_8BIT
 );

1877 
	`SETPORT
(
DATAPORT
, *
cu¼’t_SC
->
SCp
.
±r
++);

1878 
cu¼’t_SC
->
SCp
.
this_»sidu®
--;

1882 
	`CLRBITS
(
DMACNTRL0
, 
_8BIT
 );

1883 
d©a_couÁ
 >>= 1;

1884 
	`outsw
Ğ
DATAPORT
, 
cu¼’t_SC
->
SCp
.
±r
, 
d©a_couÁ
 );

1885 
cu¼’t_SC
->
SCp
.
±r
 +ğ2 * 
d©a_couÁ
;

1886 
cu¼’t_SC
->
SCp
.
this_»sidu®
 -ğ2 * 
d©a_couÁ
;

1890  
	`TESTLO
 ( 
DMASTAT
, 
DFIFOEMP
|
INTSTAT
 ) )

1893 #ià
	`defšed
(
DEBUG_DATAO
)

1894 
	`´štk
("fifo (%d bytes),ransfered (%d bytes), ",

1895 
	`GETPORT
(
FIFOSTAT
), 
	`GETSTCNT
() );

1899 iàĞ
	`TESTLO
Ğ
SSTAT1
, 
PHASEMIS
 ) &&

1900 !
cu¼’t_SC
->
SCp
.
this_»sidu®
 &&

1901 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
)

1904 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
--;

1905 
cu¼’t_SC
->
SCp
.
bufãr
++;

1906 
cu¼’t_SC
->
SCp
.
±r
 =

1907 
cu¼’t_SC
->
SCp
.
bufãr
->
add»ss
;

1908 
cu¼’t_SC
->
SCp
.
this_»sidu®
 =

1909 
cu¼’t_SC
->
SCp
.
bufãr
->
Ëngth
;

1913 iàĞ
cu¼’t_SC
->
SCp
.
this_»sidu®
 ||

1914 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
 )

1920 
d©a_couÁ
 = 
	`GETPORT
(
SSTAT2
è& (
SFULL
|
SFCNT
);

1922 
d©a_couÁ
 +ğ
	`GETPORT
(
FIFOSTAT
) ;

1923 
cu¼’t_SC
->
SCp
.
±r
 -ğ
d©a_couÁ
;

1924 
cu¼’t_SC
->
SCp
.
this_»sidu®
 +ğ
d©a_couÁ
;

1925 #ià
	`defšed
(
DEBUG_DATAO
)

1926 
	`´štk
("left data (bytes=%d, buffers=%d), fifos (bytes=%d),ransfer incomplete,„esetting fifo, ",

1927 
cu¼’t_SC
->
SCp
.
this_»sidu®
,

1928 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
,

1929 
d©a_couÁ
 );

1931 
	`SETPORT
(
DMACNTRL0
, 
WRITE_READ
|
RSTFIFO
);

1932 
	`CLRBITS
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
 );

1933 
	`CLRBITS
(
DMACNTRL0
, 
ENDMA
);

1937 #ià
	`defšed
(
DEBUG_DATAO
)

1938 
	`´štk
("waiting for SCSI fifoo getƒmpty, ");

1941  
	`TESTLO
Ğ
SSTAT2
, 
SEMPTY
 ) )

1943 #ià
	`defšed
(
DEBUG_DATAO
)

1944 
	`´štk
("ok, ");

1947 #ià
	`defšed
(
DEBUG_DATAO
)

1948 
	`´štk
("left data (bytes=%d, buffers=%d) ",

1949 
cu¼’t_SC
->
SCp
.
this_»sidu®
,

1950 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
);

1952 
	`CLRBITS
(
SXFRCTL0
, 
SCSIEN
|
DMAEN
);

1955  
	`TESTHI
Ğ
SXFRCTL0
, 
SCSIEN
 ) )

1958 
	`CLRBITS
(
DMACNTRL0
, 
ENDMA
);

1961 #ià
	`defšed
(
DEBUG_DATAO
è|| defšed(
DEBUG_INTR
)

1962 
	`´štk
("£Á %d d©¨by‹s, ", 
	`GETSTCNT
() );

1967 
P_BUSFREE
:

1968 #ià
	`defšed
(
DEBUG_RACE
)

1969 
	`Ëave_driv”
("(BUSFREE) intr");

1971 #ià
	`defšed
(
DEBUG_PHASES
)

1972 
	`´štk
("unexpected BUS FREE, ");

1974 
cu¼’t_SC
->
SCp
.
pha£
 = (cu¼’t_SC->SCp.pha£ & ~(
P_MASK
<<16));

1976 
	`aha152x_dÚe
Ğ
DID_ERROR
 << 16 );

1980 
P_PARITY
:

1981 #ià
	`defšed
(
DEBUG_RACE
)

1982 
	`Ëave_driv”
("(DID_PARITY) intr");

1984 
	`´štk
("PARITYƒrror in DATA…hase, ");

1986 
cu¼’t_SC
->
SCp
.
pha£
 = (cu¼’t_SC->SCp.pha£ & ~(
P_MASK
<<16));

1988 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

1989 
	`aha152x_dÚe
Ğ
DID_PARITY
 << 16 );

1994 
	`´štk
("aha152x: unexpected…hase\n");

1998 if(
dÚe
)

2000 #ià
	`defšed
(
DEBUG_INTR
)

2001 
	`´štk
("command done.\n");

2003 #ià
	`defšed
(
DEBUG_RACE
)

2004 
	`Ëave_driv”
("(done) intr");

2007 
	`SETPORT
(
SIMODE0
, 
discÚÃùed_SC
 ? 
ENSELDI
 : 0 );

2008 
	`SETPORT
(
SIMODE1
, 
issue_SC
 ? 
ENBUSFREE
 : 0);

2009 
	`SETPORT
Ğ
SCSISEQ
, 
discÚÃùed_SC
 ? 
ENRESELI
 : 0 );

2011 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
 );

2013 
	`aha152x_dÚe
Ğ(
cu¼’t_SC
->
SCp
.
Stus
 & 0xff)

2014 | ( (
cu¼’t_SC
->
SCp
.
Mes§ge
 & 0xff) << 8)

2015 | ( 
DID_OK
 << 16) );

2017 #ià
	`defšed
(
DEBUG_RACE
)

2018 
	`´štk
("done„eturned (DID_OK: Status=%x; Message=%x).\n",

2019 
cu¼’t_SC
->
SCp
.
Stus
, cu¼’t_SC->SCp.
Mes§ge
);

2024 if(
cu¼’t_SC
)

2025 
cu¼’t_SC
->
SCp
.
pha£
 |= 1<<16 ;

2027 
	`SETPORT
Ğ
SIMODE0
, 0 );

2028 
	`SETPORT
Ğ
SIMODE1
, 
ENPHASEMIS
 );

2029 #ià
	`defšed
(
DEBUG_INTR
)

2030 
	`di¥_’šŒ
();

2032 #ià
	`defšed
(
DEBUG_RACE
)

2033 
	`Ëave_driv”
("(PHASEEND) intr");

2036 
	`SETBITS
Ğ
DMACNTRL0
, 
INTEN
);

2038 
	}
}

2043 
	$aha152x_·nic
(*
msg
)

2045 
	`´štk
("\Çha152x_·nic: %s\n", 
msg
);

2046 
	`show_queues
();

2047 
	`·nic
("aha152x…anic");

2048 
	}
}

2053 
	$di¥_pÜts
()

2055 #ià!
	`defšed
(
SKIP_PORTS
)

2056 
s
;

2058 
	`´štk
("\n%s: ", 
cu¼’t_SC
 ? "on bus" : "waiting");

2060 
s
=
	`GETPORT
(
SCSISEQ
);

2061 
	`´štk
("SCSISEQ ( ");

2062 ifĞ
s
 & 
TEMODEO
 ) 
	`´štk
("TARGET MODE ");

2063 ifĞ
s
 & 
ENSELO
 ) 
	`´štk
("SELO ");

2064 ifĞ
s
 & 
ENSELI
 ) 
	`´štk
("SELI ");

2065 ifĞ
s
 & 
ENRESELI
 ) 
	`´štk
("RESELI ");

2066 ifĞ
s
 & 
ENAUTOATNO
 ) 
	`´štk
("AUTOATNO ");

2067 ifĞ
s
 & 
ENAUTOATNI
 ) 
	`´štk
("AUTOATNI ");

2068 ifĞ
s
 & 
ENAUTOATNP
 ) 
	`´štk
("AUTOATNP ");

2069 ifĞ
s
 & 
SCSIRSTO
 ) 
	`´štk
("SCSIRSTO ");

2070 
	`´štk
(");");

2072 
	`´štk
(" SCSISIG ( ");

2073 
s
=
	`GETPORT
(
SCSISIG
);

2074 
s
 & 
P_MASK
)

2076 
P_DATAO
:

2077 
	`´štk
("DATA OUT");

2079 
P_DATAI
:

2080 
	`´štk
("DATA IN");

2082 
P_CMD
:

2083 
	`´štk
("COMMAND");

2085 
P_STATUS
:

2086 
	`´štk
("STATUS");

2088 
P_MSGO
:

2089 
	`´štk
("MESSAGE OUT");

2091 
P_MSGI
:

2092 
	`´štk
("MESSAGE IN");

2095 
	`´štk
("*illegal*");

2099 
	`´štk
(" ); ");

2101 
	`´štk
("INTSTAT ( % ); ", 
	`TESTHI
(
DMASTAT
, 
INTSTAT
) ? "hi" : "lo");

2103 
	`´štk
("SSTAT ( ");

2104 
s
=
	`GETPORT
(
SSTAT0
);

2105 ifĞ
s
 & 
TARGET
 ) 
	`´štk
("TARGET ");

2106 ifĞ
s
 & 
SELDO
 ) 
	`´štk
("SELDO ");

2107 ifĞ
s
 & 
SELDI
 ) 
	`´štk
("SELDI ");

2108 ifĞ
s
 & 
SELINGO
 ) 
	`´štk
("SELINGO ");

2109 ifĞ
s
 & 
SWRAP
 ) 
	`´štk
("SWRAP ");

2110 ifĞ
s
 & 
SDONE
 ) 
	`´štk
("SDONE ");

2111 ifĞ
s
 & 
SPIORDY
 ) 
	`´štk
("SPIORDY ");

2112 ifĞ
s
 & 
DMADONE
 ) 
	`´štk
("DMADONE ");

2114 
s
=
	`GETPORT
(
SSTAT1
);

2115 ifĞ
s
 & 
SELTO
 ) 
	`´štk
("SELTO ");

2116 ifĞ
s
 & 
ATNTARG
 ) 
	`´štk
("ATNTARG ");

2117 ifĞ
s
 & 
SCSIRSTI
 ) 
	`´štk
("SCSIRSTI ");

2118 ifĞ
s
 & 
PHASEMIS
 ) 
	`´štk
("PHASEMIS ");

2119 ifĞ
s
 & 
BUSFREE
 ) 
	`´štk
("BUSFREE ");

2120 ifĞ
s
 & 
SCSIPERR
 ) 
	`´štk
("SCSIPERR ");

2121 ifĞ
s
 & 
PHASECHG
 ) 
	`´štk
("PHASECHG ");

2122 ifĞ
s
 & 
REQINIT
 ) 
	`´štk
("REQINIT ");

2123 
	`´štk
("); ");

2126 
	`´štk
("SSTAT ( ");

2128 
s
=
	`GETPORT
(
SSTAT0
è& GETPORT(
SIMODE0
);

2130 ifĞ
s
 & 
TARGET
 ) 
	`´štk
("TARGET ");

2131 ifĞ
s
 & 
SELDO
 ) 
	`´štk
("SELDO ");

2132 ifĞ
s
 & 
SELDI
 ) 
	`´štk
("SELDI ");

2133 ifĞ
s
 & 
SELINGO
 ) 
	`´štk
("SELINGO ");

2134 ifĞ
s
 & 
SWRAP
 ) 
	`´štk
("SWRAP ");

2135 ifĞ
s
 & 
SDONE
 ) 
	`´štk
("SDONE ");

2136 ifĞ
s
 & 
SPIORDY
 ) 
	`´štk
("SPIORDY ");

2137 ifĞ
s
 & 
DMADONE
 ) 
	`´štk
("DMADONE ");

2139 
s
=
	`GETPORT
(
SSTAT1
è& GETPORT(
SIMODE1
);

2141 ifĞ
s
 & 
SELTO
 ) 
	`´štk
("SELTO ");

2142 ifĞ
s
 & 
ATNTARG
 ) 
	`´štk
("ATNTARG ");

2143 ifĞ
s
 & 
SCSIRSTI
 ) 
	`´štk
("SCSIRSTI ");

2144 ifĞ
s
 & 
PHASEMIS
 ) 
	`´štk
("PHASEMIS ");

2145 ifĞ
s
 & 
BUSFREE
 ) 
	`´štk
("BUSFREE ");

2146 ifĞ
s
 & 
SCSIPERR
 ) 
	`´štk
("SCSIPERR ");

2147 ifĞ
s
 & 
PHASECHG
 ) 
	`´štk
("PHASECHG ");

2148 ifĞ
s
 & 
REQINIT
 ) 
	`´štk
("REQINIT ");

2149 
	`´štk
("); ");

2151 
	`´štk
("SXFRCTL0 ( ");

2153 
s
=
	`GETPORT
(
SXFRCTL0
);

2154 ifĞ
s
 & 
SCSIEN
 ) 
	`´štk
("SCSIEN ");

2155 ifĞ
s
 & 
DMAEN
 ) 
	`´štk
("DMAEN ");

2156 ifĞ
s
 & 
CH1
 ) 
	`´štk
("CH1 ");

2157 ifĞ
s
 & 
CLRSTCNT
 ) 
	`´štk
("CLRSTCNT ");

2158 ifĞ
s
 & 
SPIOEN
 ) 
	`´štk
("SPIOEN ");

2159 ifĞ
s
 & 
CLRCH1
 ) 
	`´štk
("CLRCH1 ");

2160 
	`´štk
("); ");

2162 
	`´štk
("SIGNAL ( ");

2164 
s
=
	`GETPORT
(
SCSISIG
);

2165 ifĞ
s
 & 
ATNI
 ) 
	`´štk
("ATNI ");

2166 ifĞ
s
 & 
SELI
 ) 
	`´štk
("SELI ");

2167 ifĞ
s
 & 
BSYI
 ) 
	`´štk
("BSYI ");

2168 ifĞ
s
 & 
REQI
 ) 
	`´štk
("REQI ");

2169 ifĞ
s
 & 
ACKI
 ) 
	`´štk
("ACKI ");

2170 
	`´štk
("); ");

2172 
	`´štk
("SELID ( %02x ), ", 
	`GETPORT
(
SELID
) );

2174 
	`´štk
("SSTAT2 ( ");

2176 
s
=
	`GETPORT
(
SSTAT2
);

2177 ifĞ
s
 & 
SOFFSET
è
	`´štk
("SOFFSET ");

2178 ifĞ
s
 & 
SEMPTY
è
	`´štk
("SEMPTY ");

2179 ifĞ
s
 & 
SFULL
è
	`´štk
("SFULL ");

2180 
	`´štk
("); SFCNT ( %d ); ", 
s
 & (
SFULL
|
SFCNT
) );

2183 
	`´štk
("SSTAT4 ( ");

2184 
s
=
	`GETPORT
(
SSTAT4
);

2185 ifĞ
s
 & 
SYNCERR
è
	`´štk
("SYNCERR ");

2186 ifĞ
s
 & 
FWERR
è
	`´štk
("FWERR ");

2187 ifĞ
s
 & 
FRERR
è
	`´štk
("FRERR ");

2188 
	`´štk
("); ");

2191 
	`´štk
("FCNT ( %d ); ", 
	`GETPORT
(
FIFOSTAT
) );

2193 
	`´štk
("DMACNTRL0 ( ");

2194 
s
=
	`GETPORT
(
DMACNTRL0
);

2195 
	`´štk
Ğ"% ", 
s
 & 
_8BIT
 ? "8BIT" : "16BIT" );

2196 
	`´štk
Ğ"% ", 
s
 & 
DMA
 ? "DMA" : "PIO" );

2197 
	`´štk
Ğ"% ", 
s
 & 
WRITE_READ
 ? "WRITE" : "READ" );

2198 ifĞ
s
 & 
ENDMA
 ) 
	`´štk
("ENDMA ");

2199 ifĞ
s
 & 
INTEN
 ) 
	`´štk
("INTEN ");

2200 ifĞ
s
 & 
RSTFIFO
 ) 
	`´štk
("RSTFIFO ");

2201 ifĞ
s
 & 
SWINT
 ) 
	`´štk
("SWINT ");

2202 
	`´štk
("); ");

2206 
	`´štk
("DMACNTRL1 ( ");

2208 
s
=
	`GETPORT
(
DMACNTRL1
);

2209 ifĞ
s
 & 
PWRDWN
 ) 
	`´štk
("PWRDN ");

2210 
	`´štk
("); ");

2213 
	`´štk
("STK ( %d ); ", 
s
 & 0xf);

2215 
	`´štk
("DMASTAT (");

2216 
s
=
	`GETPORT
(
DMASTAT
);

2217 ifĞ
s
 & 
ATDONE
 ) 
	`´štk
("ATDONE ");

2218 ifĞ
s
 & 
WORDRDY
 ) 
	`´štk
("WORDRDY ");

2219 ifĞ
s
 & 
DFIFOFULL
 ) 
	`´štk
("DFIFOFULL ");

2220 ifĞ
s
 & 
DFIFOEMP
 ) 
	`´štk
("DFIFOEMP ");

2221 
	`´štk
(")");

2225 
	`´štk
("\n");

2227 
	}
}

2232 
	$di¥_’šŒ
()

2234 
s
;

2236 
	`´štk
("enabled interrupts ( ");

2238 
s
=
	`GETPORT
(
SIMODE0
);

2239 ifĞ
s
 & 
ENSELDO
 ) 
	`´štk
("ENSELDO ");

2240 ifĞ
s
 & 
ENSELDI
 ) 
	`´štk
("ENSELDI ");

2241 ifĞ
s
 & 
ENSELINGO
 ) 
	`´štk
("ENSELINGO ");

2242 ifĞ
s
 & 
ENSWRAP
 ) 
	`´štk
("ENSWRAP ");

2243 ifĞ
s
 & 
ENSDONE
 ) 
	`´štk
("ENSDONE ");

2244 ifĞ
s
 & 
ENSPIORDY
 ) 
	`´štk
("ENSPIORDY ");

2245 ifĞ
s
 & 
ENDMADONE
 ) 
	`´štk
("ENDMADONE ");

2247 
s
=
	`GETPORT
(
SIMODE1
);

2248 ifĞ
s
 & 
ENSELTIMO
 ) 
	`´štk
("ENSELTIMO ");

2249 ifĞ
s
 & 
ENATNTARG
 ) 
	`´štk
("ENATNTARG ");

2250 ifĞ
s
 & 
ENPHASEMIS
 ) 
	`´štk
("ENPHASEMIS ");

2251 ifĞ
s
 & 
ENBUSFREE
 ) 
	`´štk
("ENBUSFREE ");

2252 ifĞ
s
 & 
ENSCSIPERR
 ) 
	`´štk
("ENSCSIPERR ");

2253 ifĞ
s
 & 
ENPHASECHG
 ) 
	`´štk
("ENPHASECHG ");

2254 ifĞ
s
 & 
ENREQINIT
 ) 
	`´štk
("ENREQINIT ");

2255 
	`´štk
(")\n");

2256 
	}
}

2258 #ià
defšed
(
DEBUG_RACE
)

2260 cÚ¡ *
	gshould_Ëave
;

2261 
	gš_driv”
=0;

2266 
	$’‹r_driv”
(cÚ¡ *
func
)

2268 
	`şi
();

2269 
	`´štk
("aha152x:ƒÁ”šg %s(è(%x)\n", 
func
, 
jiff›s
);

2270 if(
š_driv”
)

2272 
	`´štk
("% should†—vfœ¡.\n", 
should_Ëave
);

2273 
	`·nic
("aha152x:‡lready in driver\n");

2276 
š_driv”
++;

2277 
should_Ëave
=
func
;

2278 
	`¡i
();

2279 
	}
}

2281 
	$Ëave_driv”
(cÚ¡ *
func
)

2283 
	`şi
();

2284 
	`´štk
("\Çha152x:†—všg %s(è(%x)\n", 
func
, 
jiff›s
);

2285 if(!
š_driv”
)

2287 
	`´štk
("aha152x: % ®»ady†eá.\n", 
should_Ëave
);

2288 
	`·nic
("aha152x: %s‡lready†eft driver.\n");

2291 
š_driv”
--;

2292 
should_Ëave
=
func
;

2293 
	`¡i
();

2294 
	}
}

2300 
	$show_commªd
(
Scsi_Cmnd
 *
±r
)

2302 
i
;

2304 
	`´štk
("0x%08x:arget=%d;†un=%d; cmnd=( ",

2305 (è
±r
,…Œ->
rg‘
,…Œ->
lun
);

2307 
i
=0; i<
	`COMMAND_SIZE
(
±r
->
cmnd
[0]); i++)

2308 
	`´štk
("%02x ", 
±r
->
cmnd
[
i
]);

2310 
	`´štk
(");„esidual=%d; buffers=%d;…hase |",

2311 
±r
->
SCp
.
this_»sidu®
,…Œ->SCp.
bufãrs_»sidu®
);

2313 ifĞ
±r
->
SCp
.
pha£
 & 
nÙ_issued
 ) 
	`´štk
("not issued|");

2314 ifĞ
±r
->
SCp
.
pha£
 & 
š_£ËùiÚ
 ) 
	`´štk
("in selection|");

2315 ifĞ
±r
->
SCp
.
pha£
 & 
discÚÃùed
 ) 
	`´štk
("disconnected|");

2316 ifĞ
±r
->
SCp
.
pha£
 & 
abÜ‹d
 ) 
	`´štk
("aborted|");

2317 ifĞ
±r
->
SCp
.
pha£
 & 
£Á_id’t
 ) 
	`´štk
("send_ident|");

2318 ifĞ
±r
->
SCp
.
pha£
 & 
š_Ùh”
 )

2320 
	`´štk
("; in other(");

2321  (
±r
->
SCp
.
pha£
 >> 16è& 
P_MASK
 )

2323 
P_DATAO
:

2324 
	`´štk
("DATA OUT");

2326 
P_DATAI
:

2327 
	`´štk
("DATA IN");

2329 
P_CMD
:

2330 
	`´štk
("COMMAND");

2332 
P_STATUS
:

2333 
	`´štk
("STATUS");

2335 
P_MSGO
:

2336 
	`´štk
("MESSAGE OUT");

2338 
P_MSGI
:

2339 
	`´štk
("MESSAGE IN");

2342 
	`´štk
("*illegal*");

2345 
	`´štk
(")");

2346 if(
±r
->
SCp
.
pha£
 & (1<<16))

2347 
	`´štk
(";…haseend");

2349 
	`´štk
(";‚ext=0x%08x\n", (è
±r
->
ho¡_süibbË
);

2350 
	}
}

2355 
	$show_queues
()

2357 
Scsi_Cmnd
 *
±r
;

2359 
	`şi
();

2360 
	`´štk
("QUEUE STATUS:\nissue_SC:\n");

2361 
±r
=
issue_SC
;…Œ;…Œ = (
Scsi_Cmnd
 *è±r->
ho¡_süibbË
 )

2362 
	`show_commªd
(
±r
);

2364 
	`´štk
("current_SC:\n");

2365 if(
cu¼’t_SC
)

2366 
	`show_commªd
(
cu¼’t_SC
);

2368 
	`´štk
("none\n");

2370 
	`´štk
("disconnected_SC:\n");

2371 
±r
=
discÚÃùed_SC
;…Œ;…Œ = (
Scsi_Cmnd
 *è±r->
ho¡_süibbË
 )

2372 
	`show_commªd
(
±r
);

2374 
	`di¥_pÜts
();

2375 
	`di¥_’šŒ
();

2376 
	`¡i
();

2377 
	}
}

	@drivers/scsi/aha152x.h

1 #iâdeà
_AHA152X_H


2 
	#_AHA152X_H


	)

8 
	~"../block/blk.h
"

9 
	~"scsi.h
"

10 #ià
defšed
(
__KERNEL__
)

11 
	~<asm/io.h
>

13 
aha152x_d‘eù
();

14 cÚ¡ *
aha152x_šfo
();

15 
aha152x_commªd
(
Scsi_Cmnd
 *);

16 
aha152x_queue
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

17 
	`aha152x_abÜt
(
Scsi_Cmnd
 *, );

18 
	`aha152x_»£t
(
Scsi_Cmnd
 *);

19 
	`aha152x_bio¥¬am
(, , *);

23 
	#AHA152X_MAXQUEUE
 7

	)

26 
	#AHA152X
 { "Adaptec 152x SCSI driver", \

27  
aha152x_d‘eù
, \

28  
aha152x_šfo
, \

29  
aha152x_commªd
, \

30  
aha152x_queue
, \

31  
aha152x_abÜt
, \

32  
aha152x_»£t
, \

34  
aha152x_bio¥¬am
, \

37  
SG_ALL
, \

40  0 
	}

	)
}

45 
	#SCSISEQ
 (
pÜt_ba£
+0x00è

	)

46 
	#SXFRCTL0
 (
pÜt_ba£
+0x01è

	)

47 
	#SXFRCTL1
 (
pÜt_ba£
+0x02è

	)

48 
	#SCSISIG
 (
pÜt_ba£
+0x03è

	)

49 
	#SCSIRATE
 (
pÜt_ba£
+0x04è

	)

50 
	#SELID
 (
pÜt_ba£
+0x05è

	)

51 
	#SCSIID
 
SELID


	)

52 
	#SCSIDAT
 (
pÜt_ba£
+0x06è

	)

53 
	#SCSIBUS
 (
pÜt_ba£
+0x07è

	)

54 
	#STCNT0
 (
pÜt_ba£
+0x08è

	)

55 
	#STCNT1
 (
pÜt_ba£
+0x09è

	)

56 
	#STCNT2
 (
pÜt_ba£
+0x0aè

	)

57 
	#SSTAT0
 (
pÜt_ba£
+0x0bè

	)

58 
	#SSTAT1
 (
pÜt_ba£
+0x0cè

	)

59 
	#SSTAT2
 (
pÜt_ba£
+0x0dè

	)

60 
	#SCSITEST
 (
pÜt_ba£
+0x0eè

	)

61 
	#SSTAT4
 (
pÜt_ba£
+0x0fè

	)

62 
	#SIMODE0
 (
pÜt_ba£
+0x10è

	)

63 
	#SIMODE1
 (
pÜt_ba£
+0x11è

	)

64 
	#DMACNTRL0
 (
pÜt_ba£
+0x12è

	)

65 
	#DMACNTRL1
 (
pÜt_ba£
+0x13è

	)

66 
	#DMASTAT
 (
pÜt_ba£
+0x14è

	)

67 
	#FIFOSTAT
 (
pÜt_ba£
+0x15è

	)

68 
	#DATAPORT
 (
pÜt_ba£
+0x16è

	)

69 
	#BRSTCNTRL
 (
pÜt_ba£
+0x18è

	)

70 
	#PORTA
 (
pÜt_ba£
+0x1aè

	)

71 
	#PORTB
 (
pÜt_ba£
+0x1bè

	)

72 
	#REV
 (
pÜt_ba£
+0x1cè

	)

73 
	#STACK
 (
pÜt_ba£
+0x1dè

	)

74 
	#TEST
 (
pÜt_ba£
+0x1eè

	)

80 
	#TEMODEO
 0x80

	)

81 
	#ENSELO
 0x40

	)

82 
	#ENSELI
 0x20

	)

83 
	#ENRESELI
 0x10

	)

84 
	#ENAUTOATNO
 0x08

	)

85 
	#ENAUTOATNI
 0x04

	)

86 
	#ENAUTOATNP
 0x02

	)

87 
	#SCSIRSTO
 0x01

	)

90 
	#SCSIEN
 0x80

	)

91 
	#DMAEN
 0x40

	)

92 
	#CH1
 0x20

	)

93 
	#CLRSTCNT
 0x10

	)

94 
	#SPIOEN
 0x08

	)

95 
	#CLRCH1
 0x02

	)

98 
	#BITBUCKET
 0x80

	)

99 
	#SWRAPEN
 0x40

	)

100 
	#ENSPCHK
 0x20

	)

101 
	#STIMESEL
 0x18

	)

102 
	#STIMESEL_
 3

	)

103 
	#ENSTIMER
 0x04

	)

104 
	#BYTEALIGN
 0x02

	)

107 
	#CDI
 0x80

	)

108 
	#IOI
 0x40

	)

109 
	#MSGI
 0x20

	)

110 
	#ATNI
 0x10

	)

111 
	#SELI
 0x08

	)

112 
	#BSYI
 0x04

	)

113 
	#REQI
 0x02

	)

114 
	#ACKI
 0x01

	)

117 
	#P_MASK
 (
MSGI
|
CDI
|
IOI
)

	)

118 
	#P_DATAO
 (0)

	)

119 
	#P_DATAI
 (
IOI
)

	)

120 
	#P_CMD
 (
CDI
)

	)

121 
	#P_STATUS
 (
CDI
|
IOI
)

	)

122 
	#P_MSGO
 (
MSGI
|
CDI
)

	)

123 
	#P_MSGI
 (
MSGI
|
CDI
|
IOI
)

	)

126 
	#CDO
 0x80

	)

127 
	#IOO
 0x40

	)

128 
	#MSGO
 0x20

	)

129 
	#ATNO
 0x10

	)

130 
	#SELO
 0x08

	)

131 
	#BSYO
 0x04

	)

132 
	#REQO
 0x02

	)

133 
	#ACKO
 0x01

	)

136 
	#SXFR
 0x70

	)

137 
	#SXFR_
 4

	)

138 
	#SOFS
 0x0à

	)

141 
	#OID
 0x70

	)

142 
	#OID_
 4

	)

143 
	#TID
 0x07

	)

146 
	#GETSTCNT
(èĞ(
	`GETPORT
(
STCNT2
)<<16) \

147 + (
	`GETPORT
(
STCNT1
)<< 8) \

148 + 
	`GETPORT
(
STCNT0
è)

	)

150 
	#SETSTCNT
(
X
è{ 
	`SETPORT
(
STCNT2
, ((X) & 0xFF0000) >> 16); \

151 
	`SETPORT
(
STCNT1
, ((
X
) & 0x00FF00) >> 8); \

152 
	`SETPORT
(
STCNT0
, ((
X
è& 0x0000FFè); }

	)

155 
	#TARGET
 0x80

	)

156 
	#SELDO
 0x40

	)

157 
	#SELDI
 0x20

	)

158 
	#SELINGO
 0x10

	)

159 
	#SWRAP
 0x08

	)

160 
	#SDONE
 0x04

	)

161 
	#SPIORDY
 0x02

	)

162 
	#DMADONE
 0x01

	)

164 
	#SETSDONE
 0x80

	)

165 
	#CLRSELDO
 0x40

	)

166 
	#CLRSELDI
 0x20

	)

167 
	#CLRSELINGO
 0x10

	)

168 
	#CLRSWRAP
 0x08

	)

169 
	#CLRSDONE
 0x04

	)

170 
	#CLRSPIORDY
 0x02

	)

171 
	#CLRDMADONE
 0x01

	)

174 
	#SELTO
 0x80

	)

175 
	#ATNTARG
 0x40

	)

176 
	#SCSIRSTI
 0x20

	)

177 
	#PHASEMIS
 0x10

	)

178 
	#BUSFREE
 0x08

	)

179 
	#SCSIPERR
 0x04

	)

180 
	#PHASECHG
 0x02

	)

181 
	#REQINIT
 0x01

	)

183 
	#CLRSELTIMO
 0x80

	)

184 
	#CLRATNO
 0x40

	)

185 
	#CLRSCSIRSTI
 0x20

	)

186 
	#CLRBUSFREE
 0x08

	)

187 
	#CLRSCSIPERR
 0x04

	)

188 
	#CLRPHASECHG
 0x02

	)

189 
	#CLRREQINIT
 0x01

	)

192 
	#SOFFSET
 0x20

	)

193 
	#SEMPTY
 0x10

	)

194 
	#SFULL
 0x08

	)

195 
	#SFCNT
 0x07

	)

198 
	#SCSICNT
 0xf0

	)

199 
	#SCSICNT_
 4

	)

200 
	#OFFCNT
 0x0à

	)

203 
	#SCTESTU
 0x08

	)

204 
	#SCTESTD
 0x04

	)

205 
	#STCTEST
 0x01

	)

208 
	#SYNCERR
 0x04

	)

209 
	#FWERR
 0x02

	)

210 
	#FRERR
 0x01

	)

212 
	#CLRSYNCERR
 0x04

	)

213 
	#CLRFWERR
 0x02

	)

214 
	#CLRFRERR
 0x01

	)

217 
	#ENSELDO
 0x40

	)

218 
	#ENSELDI
 0x20

	)

219 
	#ENSELINGO
 0x10

	)

220 
	#ENSWRAP
 0x08

	)

221 
	#ENSDONE
 0x04

	)

222 
	#ENSPIORDY
 0x02

	)

223 
	#ENDMADONE
 0x01

	)

226 
	#ENSELTIMO
 0x80

	)

227 
	#ENATNTARG
 0x40

	)

228 
	#ENSCSIRST
 0x20

	)

229 
	#ENPHASEMIS
 0x10

	)

230 
	#ENBUSFREE
 0x08

	)

231 
	#ENSCSIPERR
 0x04

	)

232 
	#ENPHASECHG
 0x02

	)

233 
	#ENREQINIT
 0x01

	)

236 
	#ENDMA
 0x80

	)

237 
	#_8BIT
 0x40

	)

238 
	#DMA
 0x20

	)

239 
	#WRITE_READ
 0x08

	)

240 
	#INTEN
 0x04

	)

241 
	#RSTFIFO
 0x02

	)

242 
	#SWINT
 0x01

	)

245 
	#PWRDWN
 0x80

	)

246 
	#STK
 0x07

	)

249 
	#ATDONE
 0x80

	)

250 
	#WORDRDY
 0x40

	)

251 
	#INTSTAT
 0x20

	)

252 
	#DFIFOFULL
 0x10

	)

253 
	#DFIFOEMP
 0x08

	)

256 
	#BON
 0xf0

	)

257 
	#BOFF
 0x0f

	)

260 
	#BOFFTMR
 0x40

	)

261 
	#BONTMR
 0x20

	)

262 
	#STCNTH
 0x10

	)

263 
	#STCNTM
 0x08

	)

264 
	#STCNTL
 0x04

	)

265 
	#SCSIBLK
 0x02

	)

266 
	#DMABLK
 0x01

	)

272 
	m»£rved
:2;

273 
	mrdisc
:1;

274 
	msynúeg
:1;

275 
	mmsgşas£s
:2;

281 
	mboÙ
:1;

282 
	mdma
:1;

283 
	mid
:3;

284 
	mœq
:2;

285 
	mdmachª
:2;

286 
	m·r™y
:1;

287 } 
	mf›lds
;

288 
	mpÜt
;

289 } 
	taha152x_cÚfig
 ;

291 
	#cf_·r™y
 
f›lds
.
·r™y


	)

292 
	#cf_dmachª
 
f›lds
.
dmachª


	)

293 
	#cf_œq
 
f›lds
.
œq


	)

294 
	#cf_id
 
f›lds
.
id


	)

295 
	#cf_dma
 
f›lds
.
dma


	)

296 
	#cf_boÙ
 
f›lds
.
boÙ


	)

297 
	#cf_msgşas£s
 
f›lds
.
msgşas£s


	)

298 
	#cf_synúeg
 
f›lds
.
synúeg


	)

299 
	#cf_rdisc
 
f›lds
.
rdisc


	)

300 
	#cf_pÜt
 
pÜt


	)

304 
	#SETPORT
(
PORT
, 
VAL
) \

305 
	`outb
Ğ(
VAL
), (
PORT
è)

	)

307 
	#SETPORTP
(
PORT
, 
VAL
) \

308 
	`outb_p
Ğ(
VAL
), (
PORT
è)

	)

310 
	#SETPORTW
(
PORT
, 
VAL
) \

311 
	`outw
Ğ(
VAL
), (
PORT
è)

	)

313 
	#GETPORT
(
PORT
) \

314 
	`šb
Ğ
PORT
 )

	)

316 
	#GETPORTW
(
PORT
) \

317 
	`šw
Ğ
PORT
 )

	)

319 
	#SETBITS
(
PORT
, 
BITS
) \

320 
	`outb
Ğ(
	`šb
(
PORT
è| (
BITS
)), (PORTè)

	)

322 
	#CLRBITS
(
PORT
, 
BITS
) \

323 
	`outb
Ğ(
	`šb
(
PORT
è& ~(
BITS
)), (PORTè)

	)

325 
	#CLRSETBITS
(
PORT
, 
CLR
, 
SET
) \

326 
	`outb
Ğ(
	`šb
(
PORT
è& ~(
CLR
)è| (
SET
è, (PORTè)

	)

328 
	#TESTHI
(
PORT
, 
BITS
) \

329 ((
	`šb
(
PORT
è& (
BITS
)è=ğBITS)

	)

331 
	#TESTLO
(
PORT
, 
BITS
) \

332 ((
	`šb
(
PORT
è& (
BITS
)è=ğ0)

	)

	@drivers/scsi/aha1542.c

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/h—d.h
>

16 
	~<lšux/ty³s.h
>

17 
	~<lšux/¡ršg.h
>

18 
	~<lšux/iİÜt.h
>

19 
	~<lšux/cÚfig.h
>

21 
	~<lšux/sched.h
>

22 
	~<asm/dma.h
>

24 
	~<asm/sy¡em.h
>

25 
	~<asm/io.h
>

26 
	~"../block/blk.h
"

27 
	~"scsi.h
"

28 
	~"ho¡s.h
"

30 
	~"aha1542.h
"

32 #ifdeà
DEBUG


33 
	#DEB
(
x
è
	)
x

35 
	#DEB
(
x
)

	)

46 
	gba£s
[]={0x330, 0x334};

50 
	#DMA_MODE_REG
 0xd6

	)

51 
	#DMA_MASK_REG
 0xd4

	)

52 
	#CASCADE
 0xc0

	)

54 
	#BIOS_TRANSLATION_1632
 0

	)

55 
	#BIOS_TRANSLATION_6432
 1

	)

56 
	#BIOS_TRANSLATION_25563
 2

	)

58 
	saha1542_ho¡d©a
{

60 
	mbios_Œª¦©iÚ
;

61 
	maha1542_Ï¡_mbi_u£d
;

62 
	maha1542_Ï¡_mbo_u£d
;

63 
Scsi_Cmnd
 * 
	mSCšt
[
AHA1542_MAILBOXES
];

64 
mabox
 
	mmb
[2*
AHA1542_MAILBOXES
];

65 
ccb
 
	mccb
[
AHA1542_MAILBOXES
];

68 
	#HOSTDATA
(
ho¡
è((
aha1542_ho¡d©a
 *è&ho¡->
ho¡d©a
)

	)

70 
Scsi_Ho¡
 * 
	gaha_ho¡
[7] = {
NULL
,};

75 
	#WAITÃx‰imeout
 3000000

	)

77 
£tup_maboxes
(
ba£_io
, 
Scsi_Ho¡
 * 
sh²t
);

79 
	#aha1542_šŒ_»£t
(
ba£
è
	`outb
(
IRST
, 
	`CONTROL
(ba£))

	)

81 
	#WAIT
(
pÜt
, 
mask
, 
®lof
, 
nÚeof
) \

82 { 
WAITb™s
; \

83 
WAITtimeout
 = 
WAITÃx‰imeout
; \

85 
WAITb™s
 = 
	`šb
(
pÜt
è& (
mask
); \

86 ià((
WAITb™s
 & (
®lof
)è=ğ×Îofè&& ((WAITb™ & (
nÚeof
)) == 0)) \

88 ià(--
WAITtimeout
 =ğ0è
ç
; \

90 }

	)

92 
	$aha1542_¡©
()

96 
	}
}

98 
	$aha1542_out
(
ba£
, 
unch¬
 *
cmdp
, 
Ën
)

100 
Ën
--)

102 
	`WAIT
(
	`STATUS
(
ba£
), 
CDF
, 0, CDF);

103 
	`outb
(*
cmdp
++, 
	`DATA
(
ba£
));

106 
ç
:

107 
	`´štk
("aha1542_ouˆçed(%d): ", 
Ën
+1); 
	`aha1542_¡©
();

109 
	}
}

111 
	$aha1542_š
(
ba£
, 
unch¬
 *
cmdp
, 
Ën
)

113 
Ën
--)

115 
	`WAIT
(
	`STATUS
(
ba£
), 
DF
, DF, 0);

116 *
cmdp
++ = 
	`šb
(
	`DATA
(
ba£
));

119 
ç
:

120 
	`´štk
("aha1542_š faed(%d): ", 
Ën
+1); 
	`aha1542_¡©
();

122 
	}
}

124 
	$makecode
(
ho¡”r
, 
scs›¼
)

126 
ho¡”r
) {

130 
ho¡”r
 = 0;

135 
ho¡”r
 = 
DID_TIME_OUT
;

163 
	`DEB
(
	`´štk
("Aha1542: %x %x\n", 
ho¡”r
, 
scs›¼
));

164 
ho¡”r
 = 
DID_ERROR
;

171 
ho¡”r
 = 
DID_RESET
;

174 
	`´štk
("makecode: unknowÀho¡¡©u %x\n", 
ho¡”r
);

177  
scs›¼
|(
ho¡”r
 << 16);

178 
	}
}

180 
	$aha1542_‹¡_pÜt
(
b£
, 
Scsi_Ho¡
 * 
sh²t
)

182 
i
;

183 
unch¬
 
šquœy_cmd
[] = {
CMD_INQUIRY
 };

184 
unch¬
 
šquœy_»suÉ
[4];

185 
unch¬
 *
cmdp
;

186 
Ën
;

187 vŞ©
debug
 = 0;

190 if(
	`šb
(
	`STATUS
(
b£
)) == 0xff)  0;

196 
	`outb
(
SRST
|
IRST
 , 
	`CONTROL
(
b£
));

198 
i
 = 
jiff›s
 + 2;

199 
i
>
jiff›s
);

201 
debug
 = 1;

203 
	`WAIT
(
	`STATUS
(
b£
), 
STATMASK
, 
INIT
|
IDLE
, 
STST
|
DIAGF
|
INVDCMD
|
DF
|
CDF
);

205 
debug
 = 2;

207 ià(
	`šb
(
	`INTRFLAGS
(
b£
))&
INTRMASK
è
ç
;

213 
	`aha1542_out
(
b£
, 
šquœy_cmd
, 1);

215 
debug
 = 3;

216 
Ën
 = 4;

217 
cmdp
 = &
šquœy_»suÉ
[0];

219 
Ën
--)

221 
	`WAIT
(
	`STATUS
(
b£
), 
DF
, DF, 0);

222 *
cmdp
++ = 
	`šb
(
	`DATA
(
b£
));

225 
debug
 = 8;

227 ià(
	`šb
(
	`STATUS
(
b£
)è& 
DF
è
ç
;

229 
debug
 = 9;

231 
	`WAIT
(
	`INTRFLAGS
(
b£
), 
HACC
, HACC, 0);

234 
debug
 = 10;

236 
	`outb
(
IRST
, 
	`CONTROL
(
b£
));

238 
debug
 = 11;

240  
debug
;

241 
ç
:

243 
	}
}

245 cÚ¡ 
	gaha_id’t
[] = "Adaptec 1542";

248 cÚ¡ *
	$aha1542_šfo
()

250  
aha_id’t
;

251 
	}
}

254 
	$aha1542_šŒ_hªdË
(
foo
)

256 (*
my_dÚe
)(
Scsi_Cmnd
 *èğ
NULL
;

257 
”r¡©us
, 
mbi
, 
mbo
, 
mbi¡©us
;

258 
numb”_£rviûd
;

259 
Scsi_Ho¡
 * 
sho¡
;

260 
Scsi_Cmnd
 * 
SCtmp
;

261 
œqno
, * 
œqp
;

262 
mabox
 * 
mb
;

263 
ccb
 *ccb;

265 
œqp
 = (*è
foo
;

266 
œqp
 -= 2;

267 
œqno
 = *
œqp
;

269 
sho¡
 = 
aha_ho¡
[
œqno
 - 9];

270 
mb
 = 
	`HOSTDATA
(
sho¡
)->mb;

271 
ccb
 = 
	`HOSTDATA
(
sho¡
)->ccb;

273 if(!
sho¡
è
	`·nic
("Splunge!");

275 #ifdeà
DEBUG


277 
æag
 = 
	`šb
(
	`INTRFLAGS
(
sho¡
->
io_pÜt
));

278 
	`´štk
("aha1542_intr_handle: ");

279 ià(!(
æag
&
ANYINTR
)è
	`´štk
("no interrupt?");

280 ià(
æag
&
MBIF
è
	`´štk
("MBIF ");

281 ià(
æag
&
MBOA
è
	`´štk
("MBOF ");

282 ià(
æag
&
HACC
è
	`´štk
("HACC ");

283 ià(
æag
&
SCRD
è
	`´štk
("SCRD ");

284 
	`´štk
("¡©u %02x\n", 
	`šb
(
	`STATUS
(
sho¡
->
io_pÜt
)));

287 
numb”_£rviûd
 = 0;

290 
	`aha1542_šŒ_»£t
(
sho¡
->
io_pÜt
);

292 
	`şi
();

293 
mbi
 = 
	`HOSTDATA
(
sho¡
)->
aha1542_Ï¡_mbi_u£d
 + 1;

294 ià(
mbi
 >ğ2*
AHA1542_MAILBOXES
) mbi = AHA1542_MAILBOXES;

297 if(
mb
[
mbi
].
¡©us
 != 0) ;

298 
mbi
++;

299 ià(
mbi
 >ğ2*
AHA1542_MAILBOXES
) mbi = AHA1542_MAILBOXES;

300 } 
mbi
 !ğ
	`HOSTDATA
(
sho¡
)->
aha1542_Ï¡_mbi_u£d
);

302 if(
mb
[
mbi
].
¡©us
 == 0){

303 
	`¡i
();

305 ià(
numb”_£rviûd
) ;

306 
	`´štk
("aha1542.c: interrupt„eceived, but‚o mail.\n");

310 
mbo
 = (
	`scsi2št
(
mb
[
mbi
].
ccb±r
è- ((è&
ccb
[0])) / (ccb);

311 
mbi¡©us
 = 
mb
[
mbi
].
¡©us
;

312 
mb
[
mbi
].
¡©us
 = 0;

313 
	`HOSTDATA
(
sho¡
)->
aha1542_Ï¡_mbi_u£d
 = 
mbi
;

314 
	`¡i
();

316 #ifdeà
DEBUG


318 ià(
ccb
[
mbo
].
r¡©
|ccb[mbo].
ha¡©
)

319 
	`´štk
("aha1542_command:„eturning %x (status %d)\n",

320 
ccb
[
mbo
].
r¡©
 + ((èccb[mbo].
ha¡©
 << 16), 
mb
[
mbi
].
¡©us
);

324 if(
mbi¡©us
 == 3) ;

326 #ifdeà
DEBUG


327 
	`´štk
("...dÚ%d %d\n",
mbo
, 
mbi
);

330 
SCtmp
 = 
	`HOSTDATA
(
sho¡
)->
SCšt
[
mbo
];

332 ià(!
SCtmp
 || !SCtmp->
scsi_dÚe
) {

333 
	`´štk
("aha1542_intr_handle: Unexpected interrupt\n");

337 
my_dÚe
 = 
SCtmp
->
scsi_dÚe
;

338 ià(
SCtmp
->
ho¡_süibbË
è
	`scsi_ä“
(SCtmp->host_scribble, 512);

343 ià(
ccb
[
mbo
].
r¡©
 == 2)

344 
	`memıy
(
SCtmp
->
£n£_bufãr
, &
ccb
[
mbo
].
cdb
[ccb[mbo].
cdbËn
],

345 (
SCtmp
->
£n£_bufãr
));

351 ià(
mbi¡©us
 != 1)

353 
”r¡©us
 = 
	`makecode
(
ccb
[
mbo
].
ha¡©
, ccb[mbo].
r¡©
);

355 
”r¡©us
 = 0;

357 #ifdeà
DEBUG


358 if(
”r¡©us
è
	`´štk
("(aha1542ƒrror:%x %x %x) ",errstatus,

359 
ccb
[
mbo
].
ha¡©
, ccb[mbo].
r¡©
);

362 ià(
ccb
[
mbo
].
r¡©
 == 2) {

363 #ifdeà
DEBUG


364 
i
;

366 
	`DEB
(
	`´štk
("aha1542_intr_handle: sense:"));

367 #ifdeà
DEBUG


368 
i
 = 0; i < 12; i++)

369 
	`´štk
("%02x ", 
ccb
[
mbo
].
cdb
[ccb[mbo].
cdbËn
+
i
]);

370 
	`´štk
("\n");

379 
	`DEB
(ià(
”r¡©us
è
	`´štk
("aha1542_intr_handle:„eturning %6x\n",ƒrrstatus));

380 
SCtmp
->
»suÉ
 = 
”r¡©us
;

381 
	`HOSTDATA
(
sho¡
)->
SCšt
[
mbo
] = 
NULL
;

383 
	`my_dÚe
(
SCtmp
);

384 
numb”_£rviûd
++;

386 
	}
}

388 
aha1542_queuecommªd
(
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

390 
unch¬
 
ahacmd
 = 
CMD_START_SCSI
;

391 
unch¬
 
dœeùiÚ
;

392 
unch¬
 *
cmd
 = (unch¬ *è
SC²t
->
cmnd
;

393 
unch¬
 
rg‘
 = 
SC²t
->target;

394 
unch¬
 
lun
 = 
SC²t
->lun;

395 *
buff
 = 
SC²t
->
»que¡_bufãr
;

396 
bufæ’
 = 
SC²t
->
»que¡_bufæ’
;

397 
mbo
;

398 
mabox
 * 
mb
;

399 
ccb
 *ccb;

401 
	`DEB
(
i
);

403 
mb
 = 
	`HOSTDATA
(
SC²t
->
ho¡
)->mb;

404 
ccb
 = 
	`HOSTDATA
(
SC²t
->
ho¡
)->ccb;

406 
	`DEB
(ià(
rg‘
 > 1) {

407 
SC²t
->
»suÉ
 = 
DID_TIME_OUT
 << 16;

408 
	`dÚe
(
SC²t
);  0;});

410 if(*
cmd
 =ğ
REQUEST_SENSE
){

411 #iâdeà
DEBUG


412 ià(
bufæ’
 !ğ(
SC²t
->
£n£_bufãr
)) {

413 
	`´štk
("WrÚg bufã¸Ëngth suµl›d fÜ„eque¡ s’£ (%d)\n",
bufæ’
);

414 
	`·nic
("aha1542.c");

417 
SC²t
->
»suÉ
 = 0;

418 
	`dÚe
(
SC²t
);

422 #ifdeà
DEBUG


423 ià(*
cmd
 =ğ
READ_10
 || *cmd =ğ
WRITE_10
)

424 
i
 = 
	`xscsi2št
(
cmd
+2);

425 ià(*
cmd
 =ğ
READ_6
 || *cmd =ğ
WRITE_6
)

426 
i
 = 
	`scsi2št
(
cmd
+2);

428 
i
 = -1;

429 ià(
dÚe
)

430 
	`´štk
("aha1542_queuecommªd: dev %d cmd %02x…o %d†’ %d ", 
rg‘
, *
cmd
, 
i
, 
bufæ’
);

432 
	`´štk
("aha1542_commªd: dev %d cmd %02x…o %d†’ %d ", 
rg‘
, *
cmd
, 
i
, 
bufæ’
);

433 
	`aha1542_¡©
();

434 
	`´štk
("aha1542_queuecommand: dumping scsi cmd:");

435 
i
 = 0; i < (
	`COMMAND_SIZE
(*
cmd
)); i++è
	`´štk
("%02x ", cmd[i]);

436 
	`´štk
("\n");

437 ià(*
cmd
 =ğ
WRITE_10
 || *cmd =ğ
WRITE_6
)

443 
	`şi
();

444 
mbo
 = 
	`HOSTDATA
(
SC²t
->
ho¡
)->
aha1542_Ï¡_mbo_u£d
 + 1;

445 ià(
mbo
 >ğ
AHA1542_MAILBOXES
) mbo = 0;

448 if(
mb
[
mbo
].
¡©us
 =ğ0 && 
	`HOSTDATA
(
SC²t
->
ho¡
)->
SCšt
[mbo] =ğ
NULL
)

450 
mbo
++;

451 ià(
mbo
 >ğ
AHA1542_MAILBOXES
) mbo = 0;

452 } 
mbo
 !ğ
	`HOSTDATA
(
SC²t
->
ho¡
)->
aha1542_Ï¡_mbo_u£d
);

454 if(
mb
[
mbo
].
¡©us
 || 
	`HOSTDATA
(
SC²t
->
ho¡
)->
SCšt
[mbo])

455 
	`·nic
("Unableo findƒmpty mailbox for‡ha1542.\n");

457 
	`HOSTDATA
(
SC²t
->
ho¡
)->
SCšt
[
mbo
] = SCpnt;

460 
	`HOSTDATA
(
SC²t
->
ho¡
)->
aha1542_Ï¡_mbo_u£d
 = 
mbo
;

461 
	`¡i
();

463 #ifdeà
DEBUG


464 
	`´štk
("S’dšg commªd (%d %x)...",
mbo
, 
dÚe
);

467 
	`ªy2scsi
(
mb
[
mbo
].
ccb±r
, &
ccb
[mbo]);

469 
	`mem£t
(&
ccb
[
mbo
], 0, (ccb));

471 
ccb
[
mbo
].
cdbËn
 = 
	`COMMAND_SIZE
(*
cmd
);

473 
dœeùiÚ
 = 0;

474 ià(*
cmd
 =ğ
READ_10
 || *cmd =ğ
READ_6
)

475 
dœeùiÚ
 = 8;

476 ià(*
cmd
 =ğ
WRITE_10
 || *cmd =ğ
WRITE_6
)

477 
dœeùiÚ
 = 16;

479 
	`memıy
(
ccb
[
mbo
].
cdb
, 
cmd
, ccb[mbo].
cdbËn
);

481 ià(
SC²t
->
u£_sg
) {

482 
sÿ‰”li¡
 * 
sg²t
;

483 
chaš
 * 
ıŒ
;

484 #ifdeà
DEBUG


485 * 
±r
;

487 
i
;

488 
ccb
[
mbo
].
İ
 = 2;

489 
SC²t
->
ho¡_süibbË
 = (*è
	`scsi_m®loc
(512);

490 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
»que¡_bufãr
;

491 
ıŒ
 = (
chaš
 *è
SC²t
->
ho¡_süibbË
;

492 ià(
ıŒ
 =ğ
NULL
è
	`·nic
("aha1542.c: unableo‡llocate DMA memory\n");

493 
i
=0; i<
SC²t
->
u£_sg
; i++) {

494 if(
sg²t
[
i
].
Ëngth
 =ğ0 || 
SC²t
->
u£_sg
 > 16 ||

495 ((()
sg²t
[
i
].
add»ss
è& 1è|| (sg²t[i].
Ëngth
 & 1)){

496 * 
±r
;

497 
	`´štk
("Bad segm’ˆli¡ suµl›dØaha1542.ø(%d, %d)\n",
SC²t
->
u£_sg
,
i
);

498 
i
=0;i<
SC²t
->
u£_sg
;i++){

499 
	`´štk
("%d: %x %x %d\n",
i
,(è
sg²t
[i].
add»ss
, (èsg²t[i].
®t_add»ss
,

500 
sg²t
[
i
].
Ëngth
);

502 
	`´štk
("ıŒ %x: ",(è
ıŒ
);

503 
±r
 = (*è&
ıŒ
[
i
];

504 
i
=0;i<18;i++è
	`´štk
("%02x ", 
±r
[i]);

505 
	`·nic
("Foooooooood fight!");

507 
	`ªy2scsi
(
ıŒ
[
i
].
d©­Œ
, 
sg²t
[i].
add»ss
);

508 if(((è
sg²t
[
i
].
add»ss
è& 0xff000000è
baddma
;

509 
	`ªy2scsi
(
ıŒ
[
i
].
d©®’
, 
sg²t
[i].
Ëngth
);

511 
	`ªy2scsi
(
ccb
[
mbo
].
d©®’
, 
SC²t
->
u£_sg
 * (
chaš
));

512 if(((è
buff
 & 0xff000000)è
baddma
;

513 
	`ªy2scsi
(
ccb
[
mbo
].
d©­Œ
, 
ıŒ
);

514 #ifdeà
DEBUG


515 
	`´štk
("ıŒ %x: ",
ıŒ
);

516 
±r
 = (*è
ıŒ
;

517 
i
=0;i<18;i++è
	`´štk
("%02x ", 
±r
[i]);

520 
ccb
[
mbo
].
İ
 = 0;

521 
SC²t
->
ho¡_süibbË
 = 
NULL
;

522 
	`ªy2scsi
(
ccb
[
mbo
].
d©®’
, 
bufæ’
);

523 
	`ªy2scsi
(
ccb
[
mbo
].
d©­Œ
, 
buff
);

525 
ccb
[
mbo
].
idlun
 = (
rg‘
&7)<<5 | 
dœeùiÚ
 | (
lun
 & 7);

526 
ccb
[
mbo
].
r§Ën
 = 12;

527 
ccb
[
mbo
].
lšk±r
[0] = ccb[mbo].linkptr[1] = ccb[mbo].linkptr[2] = 0;

528 
ccb
[
mbo
].
commlškid
 = 0;

530 #ifdeà
DEBUGd


531 { 
i
;

532 
	`´štk
("aha1542_command: sending.. ");

533 
i
 = 0; i < (
ccb
[
mbo
])-10; i++)

534 
	`´štk
("%02x ", ((
unch¬
 *)&
ccb
[
mbo
])[
i
]);

538 ià(
dÚe
) {

539 
	`DEB
(
	`´štk
("aha1542_queuecommªd:‚ow wa™šg fÜ iÁ”ru± "); 
	`aha1542_¡©
());

540 
SC²t
->
scsi_dÚe
 = 
dÚe
;

541 
mb
[
mbo
].
¡©us
 = 1;

542 
	`aha1542_out
(
SC²t
->
ho¡
->
io_pÜt
, &
ahacmd
, 1);

543 
	`DEB
(
	`aha1542_¡©
());

546 
	`´štk
("aha1542_queuecommand: done can't be NULL\n");

549 
baddma
:

550 
	`·nic
("Buffer‡t‡ddress > 16Mb used for 1542B");

551 
	}
}

553 
	$š‹º®_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

555 
SC²t
->
SCp
.
Stus
++;

556 
	}
}

558 
	$aha1542_commªd
(
Scsi_Cmnd
 * 
SC²t
)

560 
	`DEB
(
	`´štk
("aha1542_command: ..calling‡ha1542_queuecommand\n"));

562 
	`aha1542_queuecommªd
(
SC²t
, 
š‹º®_dÚe
);

564 
SC²t
->
SCp
.
Stus
 = 0;

565 !
SC²t
->
SCp
.
Stus
);

566  
SC²t
->
»suÉ
;

567 
	}
}

570 
	$£tup_maboxes
(
b£
, 
Scsi_Ho¡
 * 
sh²t
)

572 
i
;

573 
mabox
 * 
mb
;

574 
ccb
 *ccb;

576 
unch¬
 
cmd
[5] = {
CMD_MBINIT
, 
AHA1542_MAILBOXES
};

578 
mb
 = 
	`HOSTDATA
(
sh²t
)->mb;

579 
ccb
 = 
	`HOSTDATA
(
sh²t
)->ccb;

581 
i
=0; i<
AHA1542_MAILBOXES
; i++){

582 
mb
[
i
].
¡©us
 = mb[
AHA1542_MAILBOXES
+i].status = 0;

583 
	`ªy2scsi
(
mb
[
i
].
ccb±r
, &
ccb
[i]);

585 
	`aha1542_šŒ_»£t
(
b£
);

586 
	`ªy2scsi
((
cmd
+2), 
mb
);

587 
	`aha1542_out
(
b£
, 
cmd
, 5);

588 
	`WAIT
(
	`INTRFLAGS
(
b£
), 
INTRMASK
, 
HACC
, 0);

590 
ç
:

591 
	`´štk
("aha1542_detect: failed setting up mailboxes\n");

593 
	`aha1542_šŒ_»£t
(
b£
);

594 
	}
}

596 
	$aha1542_g‘cÚfig
(
ba£_io
, * 
œq_Ëv–
, * 
dma_chª
)

598 
unch¬
 
šquœy_cmd
[] = {
CMD_RETCONF
 };

599 
unch¬
 
šquœy_»suÉ
[3];

600 
i
;

601 
i
 = 
	`šb
(
	`STATUS
(
ba£_io
));

602 ià(
i
 & 
DF
) {

603 
i
 = 
	`šb
(
	`DATA
(
ba£_io
));

605 
	`aha1542_out
(
ba£_io
, 
šquœy_cmd
, 1);

606 
	`aha1542_š
(
ba£_io
, 
šquœy_»suÉ
, 3);

607 
	`WAIT
(
	`INTRFLAGS
(
ba£_io
), 
INTRMASK
, 
HACC
, 0);

609 
ç
:

610 
	`´štk
("aha1542_detect: query board settings\n");

612 
	`aha1542_šŒ_»£t
(
ba£_io
);

613 
šquœy_»suÉ
[0]){

615 *
dma_chª
 = 7;

618 *
dma_chª
 = 6;

621 *
dma_chª
 = 5;

624 
	`´štk
("DMA…riority 0‚ot‡vailable for Adaptec driver\n");

629 *
dma_chª
 = 0xFF;

632 
	`´štk
("Unableo determine Adaptec DMA…riority. Disabling board\n");

635 
šquœy_»suÉ
[1]){

637 *
œq_Ëv–
 = 15;

640 *
œq_Ëv–
 = 14;

643 *
œq_Ëv–
 = 12;

646 *
œq_Ëv–
 = 11;

649 *
œq_Ëv–
 = 10;

652 *
œq_Ëv–
 = 9;

655 
	`´štk
("Unableo determine Adaptec IRQ†evel. Disabling board\n");

659 
	}
}

664 
	$aha1542_mb’abË
(
ba£
)

666 
unch¬
 
mb’abË_cmd
[3];

667 
unch¬
 
mb’abË_»suÉ
[2];

668 
»tv®
;

670 
»tv®
 = 
BIOS_TRANSLATION_6432
;

672 
mb’abË_cmd
[0]=
CMD_EXTBIOS
;

673 
	`aha1542_out
(
ba£
,
mb’abË_cmd
,1);

674 
	`aha1542_š
(
ba£
,
mb’abË_»suÉ
,2);

675 
	`WAIT
(
	`INTRFLAGS
(
ba£
),
INTRMASK
,
HACC
,0);

676 
	`aha1542_šŒ_»£t
(
ba£
);

678 ià((
mb’abË_»suÉ
[0] & 0x08) || mbenable_result[1]) {

679 
mb’abË_cmd
[0]=
CMD_MBENABLE
;

680 
mb’abË_cmd
[1]=0;

681 
mb’abË_cmd
[2]=
mb’abË_»suÉ
[1];

682 if(
mb’abË_»suÉ
[1] & 1è
»tv®
 = 
BIOS_TRANSLATION_25563
;

683 
	`aha1542_out
(
ba£
,
mb’abË_cmd
,3);

684 
	`WAIT
(
	`INTRFLAGS
(
ba£
),
INTRMASK
,
HACC
,0);

687 
ç
:

688 
	`´štk
("aha1542_mbenable: Mailbox init failed\n");

690 
	`aha1542_šŒ_»£t
(
ba£
);

691  
»tv®
;

692 
	}
}

695 
	$aha1542_qu”y
(
ba£_io
, * 
Œª¦
)

697 
unch¬
 
šquœy_cmd
[] = {
CMD_INQUIRY
 };

698 
unch¬
 
šquœy_»suÉ
[4];

699 
i
;

700 
i
 = 
	`šb
(
	`STATUS
(
ba£_io
));

701 ià(
i
 & 
DF
) {

702 
i
 = 
	`šb
(
	`DATA
(
ba£_io
));

704 
	`aha1542_out
(
ba£_io
, 
šquœy_cmd
, 1);

705 
	`aha1542_š
(
ba£_io
, 
šquœy_»suÉ
, 4);

706 
	`WAIT
(
	`INTRFLAGS
(
ba£_io
), 
INTRMASK
, 
HACC
, 0);

708 
ç
:

709 
	`´štk
("aha1542_detect: query cardype\n");

711 
	`aha1542_šŒ_»£t
(
ba£_io
);

713 *
Œª¦
 = 
BIOS_TRANSLATION_6432
;

721 ià(
šquœy_»suÉ
[0] == 0x43) {

722 
	`´štk
("aha1542.c: Emulation mode‚ot supported for AHA 174N hardware.\n");

727 ià(
šquœy_»suÉ
[0] == 0x44 || inquiry_result[0] == 0x45)

729 *
Œª¦
 = 
	`aha1542_mb’abË
(
ba£_io
);

732 
	}
}

736 
	$aha1542_d‘eù
(
ho¡num
)

738 
dma_chª
;

739 
œq_Ëv–
;

740 
ba£_io
;

741 
Œªs
;

742 
Scsi_Ho¡
 * 
sh²t
 = 
NULL
;

743 
couÁ
 = 0;

744 
šdx
;

746 
	`DEB
(
	`´štk
("aha1542_detect: \n"));

748 
šdx
 = 0; indx < (
ba£s
)/(bases[0]); indx++)

749 if(!
	`check_»giÚ
(
ba£s
[
šdx
], 4)) {

750 
sh²t
 = 
	`scsi_»gi¡”
(
ho¡num
,

751 (
aha1542_ho¡d©a
));

753 if(!
	`aha1542_‹¡_pÜt
(
ba£s
[
šdx
], 
sh²t
)è
uÄegi¡”
;

756 
ba£_io
 = 
ba£s
[
šdx
];

760 
unch¬
 
Úcmd
[] = {
CMD_BUSON_TIME
, 7};

761 
unch¬
 
offcmd
[] = {
CMD_BUSOFF_TIME
, 5};

763 
	`aha1542_šŒ_»£t
(
ba£_io
);

764 
	`aha1542_out
(
ba£_io
, 
Úcmd
, 2);

765 
	`WAIT
(
	`INTRFLAGS
(
ba£_io
), 
INTRMASK
, 
HACC
, 0);

766 
	`aha1542_šŒ_»£t
(
ba£_io
);

767 
	`aha1542_out
(
ba£_io
, 
offcmd
, 2);

768 
	`WAIT
(
	`INTRFLAGS
(
ba£_io
), 
INTRMASK
, 
HACC
, 0);

770 
ç
:

771 
	`´štk
("aha1542_detect: setting bus on/off-time failed\n");

773 
	`aha1542_šŒ_»£t
(
ba£_io
);

775 if(
	`aha1542_qu”y
(
ba£_io
, &
Œªs
)è
uÄegi¡”
;

777 ià(
	`aha1542_g‘cÚfig
(
ba£_io
, &
œq_Ëv–
, &
dma_chª
è=ğ-1è
uÄegi¡”
;

779 
	`´štk
("CÚfiguršg Ad­‹ø© IO:%x, IRQ %d",
ba£_io
, 
œq_Ëv–
);

780 ià(
dma_chª
 != 0xFF)

781 
	`´štk
(", DMA…riÜ™y %d", 
dma_chª
);

782 
	`´štk
("\n");

784 
	`DEB
(
	`aha1542_¡©
());

785 
	`£tup_maboxes
(
ba£_io
, 
sh²t
);

787 
	`DEB
(
	`aha1542_¡©
());

789 
	`DEB
(
	`´štk
("aha1542_d‘eù:ƒÇbË iÁ”ru± chªÃÈ%d\n", 
œq_Ëv–
));

790 
	`şi
();

791 ià(
	`»que¡_œq
(
œq_Ëv–
,
aha1542_šŒ_hªdË
)) {

792 
	`´štk
("Unableo‡llocate IRQ for‡daptec controller.\n");

793 
uÄegi¡”
;

796 ià(
dma_chª
 != 0xFF) {

797 ià(
	`»que¡_dma
(
dma_chª
)) {

798 
	`´štk
("Unableo‡llocate DMA channel for Adaptec.\n");

799 
	`ä“_œq
(
œq_Ëv–
);

800 
uÄegi¡”
;

803 ià(
dma_chª
 >= 5) {

804 
	`outb
((
dma_chª
 - 4è| 
CASCADE
, 
DMA_MODE_REG
);

805 
	`outb
(
dma_chª
 - 4, 
DMA_MASK_REG
);

808 
aha_ho¡
[
œq_Ëv–
 - 9] = 
sh²t
;

809 
sh²t
->
io_pÜt
 = 
ba£_io
;

810 
sh²t
->
dma_chªÃl
 = 
dma_chª
;

811 
sh²t
->
œq
 = 
œq_Ëv–
;

812 
	`HOSTDATA
(
sh²t
)->
bios_Œª¦©iÚ
 = 
Œªs
;

813 if(
Œªs
 == 2)

814 
	`´štk
("aha1542.c: Usingƒxtended biosranslation\n");

815 
	`HOSTDATA
(
sh²t
)->
aha1542_Ï¡_mbi_u£d
 = (2*
AHA1542_MAILBOXES
 - 1);

816 
	`HOSTDATA
(
sh²t
)->
aha1542_Ï¡_mbo_u£d
 = (
AHA1542_MAILBOXES
 - 1);

817 
	`mem£t
(
	`HOSTDATA
(
sh²t
)->
SCšt
, 0, (HOSTDATA(shpnt)->SCint));

818 
	`¡i
();

820 
	`DEB
(
	`´štk
(" *** READ CAPACITY ***\n"));

823 
unch¬
 
buf
[8];

824 
unch¬
 
cmd
[] = { 
READ_CAPACITY
, 0, 0, 0, 0, 0, 0, 0, 0, 0};

825 
i
;

827 
i
 = 0; i < (
buf
); ++i) buf[i] = 0x87;

828 
i
 = 0; i < 2; ++i)

829 ià(!
	`aha1542_commªd
(
i
, 
cmd
, 
buf
, (buf))) {

830 
	`´štk
("aha_detect: LU %d sector_size %d device_size %d\n",

831 
i
, 
	`xscsi2št
(
buf
+4), xscsi2int(buf));

835 
	`DEB
(
	`´štk
(" *** NOW RUNNING MY OWN TEST *** \n"));

837 
i
 = 0; i < 4; ++i)

839 
cmd
[10];

840 
bufãr
[512];

842 
cmd
[0] = 
READ_10
;

843 
cmd
[1] = 0;

844 
	`xªy2scsi
(
cmd
+2, 
i
);

845 
cmd
[6] = 0;

846 
cmd
[7] = 0;

847 
cmd
[8] = 1;

848 
cmd
[9] = 0;

849 
	`aha1542_commªd
(0, 
cmd
, 
bufãr
, 512);

852 
	`¢¬f_»giÚ
(
ba£s
[
šdx
], 4);

853 
couÁ
++;

855 
uÄegi¡”
:

856 
	`scsi_uÄegi¡”
(
sh²t
, (
aha1542_ho¡d©a
));

860  
couÁ
;

861 
	}
}

867 
	$aha1542_abÜt
(
Scsi_Cmnd
 * 
SC²t
, 
i
)

870 
unch¬
 
ahacmd
 = 
CMD_START_SCSI
;

871 
mbo
;

873 
	`DEB
(
	`´štk
("aha1542_abort\n"));

875 
	`şi
();

876 
mbo
 = 0; mbØ< 
AHA1542_MAILBOXES
; mbo++)

877 ià(
SC²t
 =ğ
	`HOSTDATA
(SC²t->
ho¡
)->
SCšt
[
mbo
]){

878 
mb
[
mbo
].
¡©us
 = 2;

879 
	`aha1542_out
(&
ahacmd
, 1);

880 
	`¡i
();

885 
	}
}

891 
	$aha1542_»£t
(
Scsi_Cmnd
 * 
SC²t
)

893 
	`DEB
(
	`´štk
("aha1542_reset called\n"));

894 if(
SC²t
èSC²t->
æags
 |ğ
NEEDS_JUMPSTART
;

896 
	}
}

898 #ifdeà
CONFIG_BLK_DEV_SD


899 
	~"sd.h
"

902 
	$aha1542_bio¥¬am
(
size
, 
dev
, * 

)

904 
Œª¦©iÚ_®gÜ™hm
;

905 #ifdeà
CONFIG_BLK_DEV_SD


906 
Scsi_Deviû
 *
disk
;

908 
disk
 = 
rscsi_disks
[
	`MINOR
(
dev
è>> 4].
deviû
;

909 
Œª¦©iÚ_®gÜ™hm
 = 
	`HOSTDATA
(
disk
->
ho¡
)->
bios_Œª¦©iÚ
;

911 if((
size
>>11è> 1024 && 
Œª¦©iÚ_®gÜ™hm
 == 2) {

913 

[0] = 255;

914 

[1] = 63;

915 

[2] = 
size
 /255/63;

917 

[0] = 64;

918 

[1] = 32;

919 

[2] = 
size
 >> 11;

924 
	}
}

	@drivers/scsi/aha1542.h

1 #iâdeà
_AHA1542_H


34 
	~<lšux/ty³s.h
>

38 
	#STATUS
(
ba£
è
	)
base

39 
	#STST
 0x80

	)

40 
	#DIAGF
 0x40

	)

41 
	#INIT
 0x20

	)

42 
	#IDLE
 0x10

	)

43 
	#CDF
 0x08

	)

44 
	#DF
 0x04

	)

45 
	#INVDCMD
 0x01

	)

46 
	#STATMASK
 0xfd

	)

48 
	#INTRFLAGS
(
ba£
è(
	`STATUS
(ba£)+2)

	)

49 
	#ANYINTR
 0x80

	)

50 
	#SCRD
 0x08

	)

51 
	#HACC
 0x04

	)

52 
	#MBOA
 0x02

	)

53 
	#MBIF
 0x01

	)

54 
	#INTRMASK
 0x8f

	)

57 
	#CONTROL
(
ba£
è
	`STATUS
(ba£)

	)

58 
	#HRST
 0x80

	)

59 
	#SRST
 0x40

	)

60 
	#IRST
 0x20

	)

61 
	#SCRST
 0x10

	)

64 
	#DATA
(
ba£
è(
	`STATUS
(ba£)+1)

	)

65 
	#CMD_NOP
 0x00

	)

66 
	#CMD_MBINIT
 0x01

	)

67 
	#CMD_START_SCSI
 0x02

	)

68 
	#CMD_INQUIRY
 0x04

	)

69 
	#CMD_EMBOI
 0x05

	)

70 
	#CMD_BUSON_TIME
 0x07

	)

71 
	#CMD_BUSOFF_TIME
 0x08

	)

72 
	#CMD_RETDEVS
 0x0¨

	)

73 
	#CMD_RETCONF
 0x0b

	)

74 
	#CMD_RETSETUP
 0x0d

	)

75 
	#CMD_ECHO
 0x1à

	)

77 
	#CMD_EXTBIOS
 0x28

	)

78 
	#CMD_MBENABLE
 0x29

	)

81 
	smabox
 {

82 
unch¬
 
	m¡©us
;

83 
unch¬
 
	mccb±r
[3];

87 
	schaš
 {

88 
unch¬
 
	md©®’
[3];

89 
unch¬
 
	md©­Œ
[3];

93 
	#ªy2scsi
(
up
, 
p
) \

94 (
up
)[0] = ((()(
p
)) >> 16) ; \

95 (
up
)[1] = ((()(
p
)) >> 8); \

96 (
up
)[2] = (()(
p
));

	)

98 
	#scsi2št
(
up
èĞ((()*(up)è<< 16è+ ((()(up)[1]è<< 8è+ (()(up)[2]è)

	)

100 
	#xªy2scsi
(
up
, 
p
) \

101 (
up
)[0] = (()(
p
)) >> 24; \

102 (
up
)[1] = (()(
p
)) >> 16; \

103 (
up
)[2] = (()(
p
)) >> 8; \

104 (
up
)[3] = (()(
p
));

	)

106 
	#xscsi2št
(
up
) ( ((()(up)[0]) << 24) + ((()(up)[1]) << 16) \

107 + ((()(
up
)[2]è<< 8è+ (()(up)[3]è)

	)

109 
	#MAX_CDB
 12

	)

110 
	#MAX_SENSE
 14

	)

112 
	sccb
 {

113 
unch¬
 
	mİ
;

114 
unch¬
 
	midlun
;

118 
unch¬
 
	mcdbËn
;

119 
unch¬
 
	mr§Ën
;

120 
unch¬
 
	md©®’
[3];

121 
unch¬
 
	md©­Œ
[3];

122 
unch¬
 
	mlšk±r
[3];

123 
unch¬
 
	mcommlškid
;

124 
unch¬
 
	mha¡©
;

125 
unch¬
 
	mr¡©
;

126 
unch¬
 
	m»£rved
[2];

127 
unch¬
 
	mcdb
[
MAX_CDB
+
MAX_SENSE
];

131 
aha1542_d‘eù
();

132 
aha1542_commªd
(
Scsi_Cmnd
 *);

133 
aha1542_queuecommªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

134 
	`aha1542_abÜt
(
Scsi_Cmnd
 *, );

135 cÚ¡ *
	`aha1542_šfo
();

136 
	`aha1542_»£t
(
Scsi_Cmnd
 *);

137 
	`aha1542_bio¥¬am
(, , *);

139 
	#AHA1542_MAILBOXES
 8

	)

140 
	#AHA1542_SCATTER
 16

	)

141 
	#AHA1542_CMDLUN
 1

	)

143 #iâdeà
NULL


144 
	#NULL
 0

	)

147 
	#AHA1542
 {"Ad­‹ø1542", 
aha1542_d‘eù
, \

148 
aha1542_šfo
, 
aha1542_commªd
, \

149 
aha1542_queuecommªd
, \

150 
aha1542_abÜt
, \

151 
aha1542_»£t
, \

152 
NULL
, \

153 
aha1542_bio¥¬am
, \

154 
AHA1542_MAILBOXES
, 7, 
AHA1542_SCATTER
, 
AHA1542_CMDLUN
 \

155 , 0, 1
	}

	)
}

	@drivers/scsi/aha1740.c

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/h—d.h
>

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/¡ršg.h
>

24 
	~<lšux/iİÜt.h
>

26 
	~<lšux/sched.h
>

27 
	~<asm/dma.h
>

29 
	~<asm/sy¡em.h
>

30 
	~<asm/io.h
>

31 
	~"../block/blk.h
"

32 
	~"scsi.h
"

33 
	~"ho¡s.h
"

35 
	~"aha1740.h
"

41 #ifdeà
DEBUG


42 
	#DEB
(
x
è
	)
x

44 
	#DEB
(
x
)

	)

51 
	g¦Ù
, 
	gba£
;

52 
	gœq_Ëv–
;

54 
ecb
 
	gecb
[
AHA1740_ECBS
];

56 
	gaha1740_Ï¡_ecb_u£d
 = 0;

58 
	$aha1740_makecode
(
unch¬
 *
£n£
, unch¬ *
¡©us
)

60 
	s¡©uswÜd


62 
ushÜt
 
dÚ
:1,

63 
du
:1,

64 :1, 
qf
:1,

65 
sc
:1,

66 
dÜ
:1,

67 
ch
:1,

68 
šŒ
:1,

69 
a§
:1,

70 
¢s
:1,

71 :1, 
ši
:1,

72 
me
:1,

73 :1, 
eÿ
:1,

75 } 
¡©us_wÜd
;

76 
»tv®
 = 
DID_OK
;

78 
¡©us_wÜd
 = * (
¡©uswÜd
 *è
¡©us
;

79 #ifdeà
DEBUG


80 
	`´štk
("makecodäom %x,%x,%x,%x %x,%x,%x,%x",
¡©us
[0],status[1],status[2],status[3],

81 
£n£
[0],sense[1],sense[2],sense[3]);

83 ià(!
¡©us_wÜd
.
dÚ
)

85 iàĞ(
¡©us
[1]&0x18è|| 
¡©us_wÜd
.
sc
 )

88  
¡©us
[2] )

91 iàĞ
¡©us_wÜd
.
dÜ
 )

92 
»tv®
=
DID_ERROR
;

98 
»tv®
=
DID_TIME_OUT
;

101 
»tv®
=
DID_BAD_TARGET
;

105 
»tv®
=
DID_ABORT
;

109 
»tv®
=
DID_ERROR
;

114 iàĞ
¡©us_wÜd
.
qf
 )

116 
»tv®
 = 
DID_TIME_OUT
;

118 
	`´štk
("aha1740.c: WARNING: AHA1740 queue overflow!\n");

120 iàĞ
¡©us
[0]&0x60 )

122 
»tv®
 = 
DID_ERROR
;

130  
¡©us
[3] | 
»tv®
 << 16;

131 
	}
}

133 
	$aha1740_‹¡_pÜt
()

135 
Çme
[4],
tmp
;

138 
Çme
[0]ğ'A' -1 + ((
tmp
 = 
	`šb
(
HID0
)) >> 2);

139 
Çme
[1]ğ'A' -1 + ((
tmp
 & 3) << 3);

140 
Çme
[1]+ğ((
tmp
 = 
	`šb
(
HID1
)) >> 5)&0x7;

141 
Çme
[2]ğ'A' -1 + (
tmp
 & 0x1f);

142 
Çme
[3]=0;

143 
tmp
 = 
	`šb
(
HID2
);

144 iàĞ
	`¡rcmp
 ( 
Çme
, 
HID_MFG
 ) || 
	`šb
(
HID2
è!ğ
HID_PRD
 )

151 iàĞ
	`šb
(
EBCNTRL
è!ğ
EBCNTRL_VALUE
 )

153 
	`´štk
("aha1740: Board detected, but EBCNTRL = %x, so disabled it.\n",

154 
	`šb
(
EBCNTRL
));

158 iàĞ
	`šb
(
PORTADR
è& 
PORTADDR_ENH
 )

161 
	`´štk
("aha1740: Board detected, but‚ot inƒnhanced mode, so disabled it.\n");

163 
	}
}

165 cÚ¡ *
	$aha1740_šfo
()

167 
bufãr
[] = "Adaptec 174x (EISA)";

168  
bufãr
;

169 
	}
}

172 
	$aha1740_šŒ_hªdË
(
foo
)

174 (*
my_dÚe
)(
Scsi_Cmnd
 *);

175 
”r¡©us
, 
ad­¡©
;

176 
numb”_£rviûd
;

177 
ecb
 *
ecb±r
;

178 
Scsi_Cmnd
 *
SCtmp
;

180 
numb”_£rviûd
 = 0;

182 
	`šb
(
G2STAT
è& 
G2STAT_INTPEND
)

184 
	`DEB
(
	`´štk
("aha1740_introp of†oop.\n"));

185 
ad­¡©
 = 
	`šb
(
G2INTST
);

186 
	`outb
(
G2CNTRL_IRST
,
G2CNTRL
);

188  
ad­¡©
 & 
G2INTST_MASK
 )

190 
G2INTST_CCBRETRY
:

191 
G2INTST_CCBERROR
:

192 
G2INTST_CCBGOOD
:

193 
ecb±r
 = (
ecb
 *èĞ((
ulÚg
è
	`šb
(
MBOXIN0
)) +

194 ((
ulÚg
è
	`šb
(
MBOXIN1
) <<8) +

195 ((
ulÚg
è
	`šb
(
MBOXIN2
) <<16) +

196 ((
ulÚg
è
	`šb
(
MBOXIN3
) <<24) );

197 
	`outb
(
G2CNTRL_HRDY
,
G2CNTRL
);

198 
SCtmp
 = 
ecb±r
->
SC²t
;

199 ià(
SCtmp
->
ho¡_süibbË
)

200 
	`scsi_ä“
(
SCtmp
->
ho¡_süibbË
, 512);

204 iàĞ(
ad­¡©
 & 
G2INTST_MASK
è=ğ
G2INTST_CCBERROR
 )

206 
	`memıy
(
SCtmp
->
£n£_bufãr
, 
ecb±r
->
£n£
,

207 (
SCtmp
->
£n£_bufãr
));

208 
”r¡©us
 = 
	`aha1740_makecode
(
ecb±r
->
£n£
,ecb±r->
¡©us
);

211 
”r¡©us
 = 0;

212 
	`DEB
(ià(
”r¡©us
è
	`´štk
("aha1740_intr_handle:„eturning %6x\n",ƒrrstatus));

213 
SCtmp
->
»suÉ
 = 
”r¡©us
;

214 
my_dÚe
 = 
ecb±r
->
dÚe
;

215 
	`mem£t
(
ecb±r
,0,(
ecb
));

216 iàĞ
my_dÚe
 )

217 
	`my_dÚe
(
SCtmp
);

219 
G2INTST_HARDFAIL
:

220 
	`´štk
("aha1740 hardware failure!\n");

221 
	`·nic
("aha1740.c");

222 
G2INTST_ASNEVENT
:

223 
	`´štk
("aha1740‡synchrÚou ev’t: %02x %02x %02x %02x %02x\n",
ad­¡©
,

224 
	`šb
(
MBOXIN0
),šb(
MBOXIN1
),šb(
MBOXIN2
),šb(
MBOXIN3
));

225 
	`outb
(
G2CNTRL_HRDY
,
G2CNTRL
);

227 
G2INTST_CMDGOOD
:

230 
G2INTST_CMDERROR
:

234 
numb”_£rviûd
++;

236 
	}
}

238 
aha1740_queuecommªd
(
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

240 
unch¬
 
dœeùiÚ
;

241 
unch¬
 *
cmd
 = (unch¬ *è
SC²t
->
cmnd
;

242 
unch¬
 
rg‘
 = 
SC²t
->target;

243 *
buff
 = 
SC²t
->
»que¡_bufãr
;

244 
bufæ’
 = 
SC²t
->
»que¡_bufæ’
;

245 
ecbno
;

246 
	`DEB
(
i
);

249 if(*
cmd
 =ğ
REQUEST_SENSE
)

251 ià(
bufæ’
 !ğ(
SC²t
->
£n£_bufãr
))

253 
	`´štk
("WrÚg bufã¸Ëngth suµl›d fÜ„eque¡ s’£ (%d)\n",
bufæ’
);

254 
	`·nic
("aha1740.c");

256 
SC²t
->
»suÉ
 = 0;

257 
	`dÚe
(
SC²t
);

261 #ifdeà
DEBUG


262 ià(*
cmd
 =ğ
READ_10
 || *cmd =ğ
WRITE_10
)

263 
i
 = 
	`xscsi2št
(
cmd
+2);

264 ià(*
cmd
 =ğ
READ_6
 || *cmd =ğ
WRITE_6
)

265 
i
 = 
	`scsi2št
(
cmd
+2);

267 
i
 = -1;

268 
	`´štk
("aha1740_queuecommªd: dev %d cmd %02x…o %d†’ %d ", 
rg‘
, *
cmd
, 
i
, 
bufæ’
);

269 
	`´štk
("scsi cmd:");

270 
i
 = 0; i < (
	`COMMAND_SIZE
(*
cmd
)); i++è
	`´štk
("%02x ", cmd[i]);

271 
	`´štk
("\n");

276 
	`şi
();

277 
ecbno
 = 
aha1740_Ï¡_ecb_u£d
 + 1;

278 ià(
ecbno
 >ğ
AHA1740_ECBS
)ƒcbno = 0;

281 ifĞ! 
ecb
[
ecbno
].
cmdw
 )

283 
ecbno
++;

284 ià(
ecbno
 >ğ
AHA1740_ECBS
 )ƒcbno = 0;

285 } 
ecbno
 !ğ
aha1740_Ï¡_ecb_u£d
);

287 ifĞ
ecb
[
ecbno
].
cmdw
 )

288 
	`·nic
("Unableo findƒmptyƒcb for‡ha1740.\n");

290 
ecb
[
ecbno
].
cmdw
 = 
AHA1740CMD_INIT
;

292 
aha1740_Ï¡_ecb_u£d
 = 
ecbno
;

293 
	`¡i
();

295 #ifdeà
DEBUG


296 
	`´štk
("S’dšg commªd (%d %x)...",
ecbno
, 
dÚe
);

299 
ecb
[
ecbno
].
cdbËn
 = 
	`COMMAND_SIZE
(*
cmd
);

301 
dœeùiÚ
 = 0;

302 ià(*
cmd
 =ğ
READ_10
 || *cmd =ğ
READ_6
)

303 
dœeùiÚ
 = 1;

304 ià(*
cmd
 =ğ
WRITE_10
 || *cmd =ğ
WRITE_6
)

305 
dœeùiÚ
 = 0;

307 
	`memıy
(
ecb
[
ecbno
].
cdb
, 
cmd
,ƒcb[ecbno].
cdbËn
);

309 ià(
SC²t
->
u£_sg
)

311 
sÿ‰”li¡
 * 
sg²t
;

312 
aha1740_chaš
 * 
ıŒ
;

313 
i
;

314 #ifdeà
DEBUG


315 * 
±r
;

317 
ecb
[
ecbno
].
sg
 = 1;

318 
SC²t
->
ho¡_süibbË
 = (*è
	`scsi_m®loc
(512);

319 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
»que¡_bufãr
;

320 
ıŒ
 = (
aha1740_chaš
 *è
SC²t
->
ho¡_süibbË
;

321 ià(
ıŒ
 =ğ
NULL
è
	`·nic
("aha1740.c: unableo‡llocate DMA memory\n");

322 
i
=0; i<
SC²t
->
u£_sg
; i++)

324 
ıŒ
[
i
].
d©­Œ
 = (è
sg²t
[i].
add»ss
;

325 
ıŒ
[
i
].
d©®’
 = 
sg²t
[i].
Ëngth
;

327 
ecb
[
ecbno
].
d©®’
 = 
SC²t
->
u£_sg
 * (
aha1740_chaš
);

328 
ecb
[
ecbno
].
d©­Œ
 = (è
ıŒ
;

329 #ifdeà
DEBUG


330 
	`´štk
("ıŒ %x: ",
ıŒ
);

331 
±r
 = (*è
ıŒ
;

332 
i
=0;i<24;i++è
	`´štk
("%02x ", 
±r
[i]);

337 
SC²t
->
ho¡_süibbË
 = 
NULL
;

338 
ecb
[
ecbno
].
d©®’
 = 
bufæ’
;

339 
ecb
[
ecbno
].
d©­Œ
 = (è
buff
;

341 
ecb
[
ecbno
].
lun
 = 
SC²t
->lun;

342 
ecb
[
ecbno
].
£s
 = 1;

343 
ecb
[
ecbno
].
dœ
ğ
dœeùiÚ
;

344 
ecb
[
ecbno
].
¬s
=1;

345 
ecb
[
ecbno
].
£n£Ën
 = 12;

346 
ecb
[
ecbno
].
£n£±r
 = (èecb[ecbno].
£n£
;

347 
ecb
[
ecbno
].
¡©u¥Œ
 = (èecb[ecbno].
¡©us
;

348 
ecb
[
ecbno
].
dÚe
 = done;

349 
ecb
[
ecbno
].
SC²t
 = SCpnt;

350 #ifdeà
DEBUG


352 
i
;

353 
	`´štk
("aha1740_command: sending.. ");

354 
i
 = 0; i < (
ecb
[
ecbno
])-10; i++)

355 
	`´štk
("%02x ", ((
unch¬
 *)&
ecb
[
ecbno
])[
i
]);

357 
	`´štk
("\n");

359 ià(
dÚe
)

369 
ulÚg
 
adrs
;

371 
	`DEB
(
	`´štk
("aha1740[%d] cr™iÿÈ£ùiÚ\n",
ecbno
));

372 
	`şi
();

373 iàĞ! (
	`šb
(
G2STAT
è& 
G2STAT_MBXOUT
) )

375 
	`´štk
("aha1740[%d]_mbxouˆwa™!\n",
ecbno
);

376 
	`şi
();

378  ! (
	`šb
(
G2STAT
è& 
G2STAT_MBXOUT
) );

379 
adrs
 = (
ulÚg
è&(
ecb
[
ecbno
]);

380 
	`outb
((è(
adrs
&0xff), 
MBOXOUT0
);

381 
	`outb
((è((
adrs
>>8)&0xff), 
MBOXOUT1
);

382 
	`outb
((è((
adrs
>>16)&0xff), 
MBOXOUT2
);

383 
	`outb
((è((
adrs
>>24)&0xff), 
MBOXOUT3
);

384 iàĞ
	`šb
(
G2STAT
è& 
G2STAT_BUSY
 )

386 
	`´štk
("aha1740[%d]_©Š wa™!\n",
ecbno
);

387 
	`şi
();

389  
	`šb
(
G2STAT
è& 
G2STAT_BUSY
 );

390 
	`outb
(
ATTN_START
 | (
rg‘
 & 7), 
ATTN
);

391 
	`¡i
();

392 
	`DEB
(
	`´štk
("aha1740[%d]„eque¡ queued.\n",
ecbno
));

395 
	`´štk
("aha1740_queuecommand: done can't be NULL\n");

398 
	}
}

400 vŞ©
	gš‹º®_dÚe_æag
 = 0;

401 vŞ©
	gš‹º®_dÚe_”rcode
 = 0;

403 
	$š‹º®_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

405 
š‹º®_dÚe_”rcode
 = 
SC²t
->
»suÉ
;

406 ++
š‹º®_dÚe_æag
;

407 
	}
}

409 
	$aha1740_commªd
(
Scsi_Cmnd
 * 
SC²t
)

411 
	`aha1740_queuecommªd
(
SC²t
, 
š‹º®_dÚe
);

413 !
š‹º®_dÚe_æag
);

414 
š‹º®_dÚe_æag
 = 0;

415  
š‹º®_dÚe_”rcode
;

416 
	}
}

421 
	$aha1740_g‘cÚfig
()

423 
šb
[] = { 9,10,11,12,0,14,15,0 };

425 
œq_Ëv–
 = 
šb
 [ 
	`šb
(
INTDEF
)&0x7 ];

426 
	}
}

428 
	$aha1740_d‘eù
(
ho¡num
)

430 
	`mem£t
(&
ecb
, 0, (ecb));

431 
	`DEB
(
	`´štk
("aha1740_detect: \n"));

433  
¦Ù
=
MINEISA
; slÙ <ğ
MAXEISA
; slot++ )

435 
ba£
 = 
	`SLOTBASE
(
¦Ù
);

441 if(
	`check_»giÚ
(
ba£
, 0x5c)) ;

442 iàĞ
	`aha1740_‹¡_pÜt
()) ;

444 iàĞ
¦Ù
 > 
MAXEISA
 )

447 
	`aha1740_g‘cÚfig
();

449 iàĞ(
	`šb
(
G2STAT
è& (
G2STAT_MBXOUT
 | 
G2STAT_BUSY
) ) != G2STAT_MBXOUT )

451 
	`outb
(
G2CNTRL_HRST
,
G2CNTRL
);

452 
	`outb
(0,
G2CNTRL
);

455 
	`´štk
("CÚfiguršg Ad­‹ø© IO:%x, IRQ %d\n",
ba£
,

456 
œq_Ëv–
);

458 
	`DEB
(
	`´štk
("aha1740_d‘eù:ƒÇbË iÁ”ru± chªÃÈ%d\n", 
œq_Ëv–
));

460 ià(
	`»que¡_œq
(
œq_Ëv–
,
aha1740_šŒ_hªdË
))

462 
	`´štk
("Unableo‡llocate IRQ for‡daptec controller.\n");

465 
	`¢¬f_»giÚ
(
ba£
, 0x5c);

467 
	}
}

477 
	$aha1740_abÜt
(
Scsi_Cmnd
 * 
SC²t
, 
i
)

479 
	`DEB
(
	`´štk
("aha1740_abort called\n"));

481 
	}
}

487 
	$aha1740_»£t
(
Scsi_Cmnd
 * 
SC²t
)

489 
	`DEB
(
	`´štk
("aha1740_reset called\n"));

490 ià(
SC²t
èSC²t->
æags
 |ğ
NEEDS_JUMPSTART
;

492 
	}
}

494 
	$aha1740_bio¥¬am
(
size
, 
dev
, * 

)

496 
	`DEB
(
	`´štk
("aha1740_biosparam\n"));

497 

[0] = 64;

498 

[1] = 32;

499 

[2] = 
size
 >> 11;

502 
	}
}

	@drivers/scsi/aha1740.h

1 #iâdeà
_AHA1740_H


13 
	~<lšux/ty³s.h
>

16 
	#MINEISA
 1

	)

17 
	#MAXEISA
 8

	)

19 
	#SLOTBASE
(
x
è((x << 12)+ 0xc80 )

	)

20 
	#BASE
 (
ba£
)

	)

23 
	#HID0
 (
ba£
 + 0x0)

	)

24 
	#HID1
 (
ba£
 + 0x1)

	)

25 
	#HID2
 (
ba£
 + 0x2)

	)

26 
	#HID3
 (
ba£
 + 0x3)

	)

27 
	#EBCNTRL
 (
ba£
 + 0x4)

	)

28 
	#PORTADR
 (
ba£
 + 0x40)

	)

29 
	#BIOSADR
 (
ba£
 + 0x41)

	)

30 
	#INTDEF
 (
ba£
 + 0x42)

	)

31 
	#SCSIDEF
 (
ba£
 + 0x43)

	)

32 
	#BUSDEF
 (
ba£
 + 0x44)

	)

33 
	#RESV0
 (
ba£
 + 0x45)

	)

34 
	#RESV1
 (
ba£
 + 0x46)

	)

35 
	#RESV2
 (
ba£
 + 0x47)

	)

37 
	#HID_MFG
 "ADP"

	)

38 
	#HID_PRD
 0

	)

39 
	#HID_REV
 2

	)

40 
	#EBCNTRL_VALUE
 1

	)

41 
	#PORTADDR_ENH
 0x80

	)

43 
	#G2INTST
 (
BASE
 + 0x56)

	)

44 
	#G2STAT
 (
BASE
 + 0x57)

	)

45 
	#MBOXIN0
 (
BASE
 + 0x58)

	)

46 
	#MBOXIN1
 (
BASE
 + 0x59)

	)

47 
	#MBOXIN2
 (
BASE
 + 0x5a)

	)

48 
	#MBOXIN3
 (
BASE
 + 0x5b)

	)

49 
	#G2STAT2
 (
BASE
 + 0x5c)

	)

51 
	#G2INTST_MASK
 0xf0

	)

52 
	#G2INTST_CCBGOOD
 0x10

	)

53 
	#G2INTST_CCBRETRY
 0x50

	)

54 
	#G2INTST_HARDFAIL
 0x70

	)

55 
	#G2INTST_CMDGOOD
 0xa0

	)

56 
	#G2INTST_CCBERROR
 0xc0

	)

57 
	#G2INTST_ASNEVENT
 0xd0

	)

58 
	#G2INTST_CMDERROR
 0xe0

	)

60 
	#G2STAT_MBXOUT
 4

	)

61 
	#G2STAT_INTPEND
 2

	)

62 
	#G2STAT_BUSY
 1

	)

64 
	#G2STAT2_READY
 0

	)

67 
	#MBOXOUT0
 (
BASE
 + 0x50)

	)

68 
	#MBOXOUT1
 (
BASE
 + 0x51)

	)

69 
	#MBOXOUT2
 (
BASE
 + 0x52)

	)

70 
	#MBOXOUT3
 (
BASE
 + 0x53)

	)

71 
	#ATTN
 (
BASE
 + 0x54)

	)

72 
	#G2CNTRL
 (
BASE
 + 0x55)

	)

74 
	#ATTN_IMMED
 0x10

	)

75 
	#ATTN_START
 0x40

	)

76 
	#ATTN_ABORT
 0x50

	)

78 
	#G2CNTRL_HRST
 0x80

	)

79 
	#G2CNTRL_IRST
 0x40

	)

80 
	#G2CNTRL_HRDY
 0x20

	)

83 
	saha1740_chaš
 {

84 
ulÚg
 
	md©­Œ
;

85 
ulÚg
 
	md©®’
;

89 
	#ªy2scsi
(
up
, 
p
) \

90 (
up
)[0] = ((()(
p
)) >> 16) ; \

91 (
up
)[1] = ((()(
p
)) >> 8); \

92 (
up
)[2] = (()(
p
));

	)

94 
	#scsi2št
(
up
èĞ((()*(up)è<< 16è+ ((()(up)[1]è<< 8è+ (()(up)[2]è)

	)

96 
	#xªy2scsi
(
up
, 
p
) \

97 (
up
)[0] = (()(
p
)) >> 24; \

98 (
up
)[1] = (()(
p
)) >> 16; \

99 (
up
)[2] = (()(
p
)) >> 8; \

100 (
up
)[3] = (()(
p
));

	)

102 
	#xscsi2št
(
up
) ( ((()(up)[0]) << 24) + ((()(up)[1]) << 16) \

103 + ((()(
up
)[2]è<< 8è+ (()(up)[3]è)

	)

105 
	#MAX_CDB
 12

	)

106 
	#MAX_SENSE
 14

	)

107 
	#MAX_STATUS
 32

	)

109 
	secb
 {

110 
ushÜt
 
	mcmdw
;

112 
ushÜt
 
	múe
:1,

113 :6, 
	mdi
:1,

114 :2, 
	m£s
:1,

115 :1, 
	msg
:1,

116 :1, 
	mdsb
:1,

117 
	m¬s
:1;

119 
ushÜt
 
	mlun
:3,

120 
	mg
:1,

121 
	m‰
:2,

122 
	mnd
:1,

123 :1, 
	md©
:1,

124 
	mdœ
:1,

125 
	m¡
:1,

126 
	mchk
:1,

127 :2, 
	m»c
:1, :1;

128 
ushÜt
 
	mn0
;

129 
ulÚg
 
	md©­Œ
;

130 
ulÚg
 
	md©®’
;

131 
ulÚg
 
	m¡©u¥Œ
;

132 
ulÚg
 
	mlšk±r
;

133 
ulÚg
 
	mn1
;

134 
ulÚg
 
	m£n£±r
;

135 
unch¬
 
	m£n£Ën
;

136 
unch¬
 
	mcdbËn
;

137 
ushÜt
 
	md©acheck
;

138 
unch¬
 
	mcdb
[
MAX_CDB
];

140 
unch¬
 
	m£n£
[
MAX_SENSE
];

141 
unch¬
 
	m¡©us
[
MAX_STATUS
];

142 
Scsi_Cmnd
 *
	mSC²t
;

143 (*
	mdÚe
)(
	mScsi_Cmnd
 *);

146 
	#AHA1740CMD_NOP
 0x00

	)

147 
	#AHA1740CMD_INIT
 0x01

	)

148 
	#AHA1740CMD_DIAG
 0x05

	)

149 
	#AHA1740CMD_SCSI
 0x06

	)

150 
	#AHA1740CMD_SENSE
 0x08

	)

151 
	#AHA1740CMD_DOWN
 0x09

	)

152 
	#AHA1740CMD_RINQ
 0x0¨

	)

153 
	#AHA1740CMD_TARG
 0x10

	)

155 
aha1740_d‘eù
();

156 
aha1740_commªd
(
Scsi_Cmnd
 *);

157 
aha1740_queuecommªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

158 
	`aha1740_abÜt
(
Scsi_Cmnd
 *, );

159 cÚ¡ *
	`aha1740_šfo
();

160 
	`aha1740_»£t
(
Scsi_Cmnd
 *);

161 
	`aha1740_bio¥¬am
(, , *);

163 
	#AHA1740_ECBS
 32

	)

164 
	#AHA1740_SCATTER
 16

	)

166 #iâdeà
NULL


167 
	#NULL
 0

	)

170 
	#AHA1740
 {"Ad­‹ø1740", 
aha1740_d‘eù
, \

171 
aha1740_šfo
, 
aha1740_commªd
, \

172 
aha1740_queuecommªd
, \

173 
aha1740_abÜt
, \

174 
aha1740_»£t
, \

175 
NULL
, \

176 
aha1740_bio¥¬am
, \

177 
AHA1740_ECBS
, 7, 
AHA1740_SCATTER
, 1, 0, 0
	}

	)
}

	@drivers/scsi/constants.c

6 
	~<lšux/cÚfig.h
>

7 
	~"../block/blk.h
"

8 
	~<lšux/k”Ãl.h
>

9 
	~"scsi.h
"

11 
	#CONST_COMMAND
 0x01

	)

12 
	#CONST_STATUS
 0x02

	)

13 
	#CONST_SENSE
 0x04

	)

14 
	#CONST_XSENSE
 0x08

	)

15 cÚ¡ 
	gunknown
[] = "UNKNOWN";

17 #ifdeà
CONFIG_SCSI_CONSTANTS


18 #ifdeà
CONSTANTS


19 #undeà
CONSTANTS


21 
	#CONSTANTS
 (
CONST_COMMAND
 | 
CONST_STATUS
 | 
CONST_SENSE
 | 
CONST_XSENSE
)

	)

24 #ià(
CONSTANTS
 & 
CONST_COMMAND
)

25 cÚ¡ * 
	ggroup_0_commªds
[] = {

26  "Te¡ Un™ R—dy", "Rez”ØUn™", 
unknown
, "Request Sense",

27  "FÜm© Un™", "R—d Block Lim™s", 
unknown
, "Reasssign Blocks",

28  "R—d (6)", 
unknown
, "Write (6)", "Seek (6)", unknown, unknown,

29  
unknown
, "Read Reverse", "Write Filemarks", "Space", "Inquiry",

30  
unknown
, "Recover Buffered Data", "Mode Select", "Reserve",

33  "P»v’t/AÎow Medium Remov®", 
unknown
,

37 cÚ¡ *
	ggroup_1_commªds
[] = {

38  
unknown
, unknown, unknown,

39  
unknown
, unknown, "Read Capacity", unknown, unknown, "Read (10)",

40  
unknown
, "Write (10)", "Seek (10)", unknown, unknown,

44  
unknown
, "Compare","Copy Verify", "Write Buffer", "Read Buffer",

45  
unknown
, "Read Long", unknown,

49 cÚ¡ *
	ggroup_2_commªds
[] = {

50  "ChªgDefš™iÚ", 
unknown
,

51  
unknown
, unknown, unknown, unknown, unknown, unknown, unknown,

52  
unknown
, unknown, unknown, "Log Select", "Log Sense", unknown,

53  
unknown
, unknown, unknown, unknown, unknown, "Mode Select (10)",

54  
unknown
, unknown, unknown, unknown, "Mode Sense (10)", unknown,

55  
unknown
, unknown, unknown,

60 
	#group
(
İcode
è(((İcodeè>> 5è& 7)

	)

62 
	#RESERVED_GROUP
 0

	)

63 
	#VENDOR_GROUP
 1

	)

64 
	#NOTEXT_GROUP
 2

	)

66 cÚ¡ **
	gcommªds
[] = {

67 
group_0_commªds
, 
group_1_commªds
, 
group_2_commªds
,

68 (cÚ¡ **è
RESERVED_GROUP
, (const **) RESERVED_GROUP,

69 (cÚ¡ **è
NOTEXT_GROUP
, (cÚ¡ **è
VENDOR_GROUP
,

70 (cÚ¡ **è
VENDOR_GROUP
};

72 cÚ¡ 
	g»£rved
[] = "RESERVED";

73 cÚ¡ 
	gv’dÜ
[] = "VENDOR SPECIFIC";

75 
	$´št_İcode
(
İcode
) {

76 **
bË
 = 
commªds
[ 
	`group
(
İcode
) ];

77 (è
bË
) {

78 
RESERVED_GROUP
:

79 
	`´štk
("%s(0x%02xè", 
»£rved
, 
İcode
);

81 
NOTEXT_GROUP
:

82 
	`´štk
("%s(0x%02xè", 
unknown
, 
İcode
);

84 
VENDOR_GROUP
:

85 
	`´štk
("%s(0x%02xè", 
v’dÜ
, 
İcode
);

88 
	`´štk
("% ",
bË
[
İcode
 & 0x31]);

90 
	}
}

92 
	$´št_İcode
(
İcode
) {

93 
	`´štk
("0x%02x ", 
İcode
);

94 
	}
}

97 
	$´št_commªd
 (*
commªd
) {

98 
i
,
s
;

99 
	`´št_İcode
(
commªd
[0]);

100  
i
 = 1, 
s
 = 
	`COMMAND_SIZE
(
commªd
[0]); i < s; ++i)

101 
	`´štk
("%02x ", 
commªd
[
i
]);

102 
	`´štk
("\n");

103 
	}
}

105 #ià(
CONSTANTS
 & 
CONST_STATUS
)

106 cÚ¡ * 
	g¡©u£s
[] = {

107  "Good", "Check CÚd™iÚ", "CÚd™iÚ Good", 
unknown
, "Busy",

108  
unknown
, unknown, unknown, "Intermediate Good", unknown,

109  "IÁ”emedŸ‹ Good", 
unknown
, "Reservation Conflict", unknown,

110  
unknown
, unknown,

114 
	$´št_¡©us
 (
¡©us
) {

115 
¡©us
 = (status >> 1) & 0xf;

116 #ià(
CONSTANTS
 & 
CONST_STATUS
)

117 
	`´štk
("% ",
¡©u£s
[
¡©us
]);

119 
	`´štk
("0x%0x ", 
¡©us
);

121 
	}
}

123 #ià(
CONSTANTS
 & 
CONST_XSENSE
)

124 
	#D
 0x001

	)

125 
	#T
 0x002

	)

126 
	#L
 0x004

	)

127 
	#P
 0x008

	)

128 
	#W
 0x010

	)

129 
	#R
 0x020

	)

130 
	#S
 0x040

	)

131 
	#O
 0x080

	)

132 
	#M
 0x100

	)

133 
	#C
 0x200

	)

135 
	s”rÜ_šfo
{

136 
	mcode1
, 
	mcode2
;

137 
	mdeviûs
;

138 * 
	m‹xt
;

141 
	s”rÜ_šfo2
{

142 
	mcode1
, 
	mcode2_mš
, 
	mcode2_max
;

143 
	mdeviûs
;

144 * 
	m‹xt
;

147 
”rÜ_šfo2
 
	gadd™iÚ®2
[] =

149 {0x40,0x00,0x7f,
D
,"Ram failure (%x)"},

150 {0x40,0x80,0xff,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Diagnostic failure on component (%x)"},

151 {0x41,0x00,0xff,
D
,"Data…ath failure (%x)"},

152 {0x42,0x00,0xff,
D
,"Power-on or self-test failure (%x)"},

153 {0, 0, 0, 0, 
NULL
}

156 
”rÜ_šfo
 
	gadd™iÚ®
[] =

158 {0x00,0x01,
T
,"Filemark detected"},

159 {0x00,0x02,
T
|
S
,"End-of-partition/medium detected"},

160 {0x00,0x03,
T
,"Setmark detected"},

161 {0x00,0x04,
T
|
S
,"Beginning-of-partition/medium detected"},

162 {0x00,0x05,
T
|
S
,"End-of-data detected"},

163 {0x00,0x06,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"I/O…rocesserminated"},

164 {0x00,0x11,
R
,"Audio…lay operation in…rogress"},

165 {0x00,0x12,
R
,"Audio…lay operation…aused"},

166 {0x00,0x13,
R
,"Audio…lay operation successfully completed"},

167 {0x00,0x14,
R
,"Audio…lay operation stopped dueoƒrror"},

168 {0x00,0x15,
R
,"No current‡udio statuso„eturn"},

169 {0x01,0x00,
D
|
W
|
O
,"No index/sector signal"},

170 {0x02,0x00,
D
|
W
|
R
|
O
|
M
,"No seek complete"},

171 {0x03,0x00,
D
|
T
|
L
|
W
|
S
|
O
,"Peripheral device write fault"},

172 {0x03,0x01,
T
,"No write current"},

173 {0x03,0x02,
T
,"Excessive writeƒrrors"},

174 {0x04,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,

176 {0x04,0x01,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,

178 {0x04,0x02,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,

180 {0x04,0x03,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,

182 {0x04,0x04,
D
|
T
|
L
|
O
,"Logical unit‚ot„eady, format in…rogress"},

183 {0x05,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit does‚ot„espondo selection"},

184 {0x06,0x00,
D
|
W
|
R
|
O
|
M
,"No„eference…osition found"},

185 {0x07,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
,"Multiple…eripheral devices selected"},

186 {0x08,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit communication failure"},

187 {0x08,0x01,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit communicationime-out"},

188 {0x08,0x02,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit communication…arityƒrror"},

189 {0x09,0x00,
D
|
T
|
W
|
R
|
O
,"Track followingƒrror"},

190 {0x09,0x01,
W
|
R
|
O
,"Tracking servo failure"},

191 {0x09,0x02,
W
|
R
|
O
,"Focus servo failure"},

192 {0x09,0x03,
W
|
R
|
O
,"Spindle servo failure"},

193 {0x0A,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Error†og overflow"},

194 {0x0C,0x00,
T
|
S
,"Writeƒrror"},

195 {0x0C,0x01,
D
|
W
|
O
,"Writeƒrror„ecovered with‡uto„eallocation"},

196 {0x0C,0x02,
D
|
W
|
O
,"Writeƒrror -‡uto„eallocation failed"},

197 {0x10,0x00,
D
|
W
|
O
,"Id crc orƒccƒrror"},

198 {0x11,0x00,
D
|
T
|
W
|
R
|
S
|
O
,"Unrecovered„eadƒrror"},

199 {0x11,0x01,
D
|
T
|
W
|
S
|
O
,"Read„etriesƒxhausted"},

200 {0x11,0x02,
D
|
T
|
W
|
S
|
O
,"Erroroo†ongo correct"},

201 {0x11,0x03,
D
|
T
|
W
|
S
|
O
,"Multiple„eadƒrrors"},

202 {0x11,0x04,
D
|
W
|
O
,"Unrecovered„eadƒrror -‡uto„eallocate failed"},

203 {0x11,0x05,
W
|
R
|
O
,"L-ec uncorrectableƒrror"},

204 {0x11,0x06,
W
|
R
|
O
,"Circ unrecoveredƒrror"},

205 {0x11,0x07,
W
|
O
,"Data„esychronizationƒrror"},

206 {0x11,0x08,
T
,"Incomplete block„ead"},

207 {0x11,0x09,
T
,"No gap found"},

208 {0x11,0x0A,
D
|
T
|
O
,"Miscorrectedƒrror"},

209 {0x11,0x0B,
D
|
W
|
O
,"Unrecovered„eadƒrror -„ecommend„eassignment"},

210 {0x11,0x0C,
D
|
W
|
O
,"Unrecovered„eadƒrror -„ecommend„ewritehe data"},

211 {0x12,0x00,
D
|
W
|
O
,"Address mark‚ot found for id field"},

212 {0x13,0x00,
D
|
W
|
O
,"Address mark‚ot found for data field"},

213 {0x14,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
,"Recordedƒntity‚ot found"},

214 {0x14,0x01,
D
|
T
|
W
|
R
|
O
,"Record‚ot found"},

215 {0x14,0x02,
T
,"Filemark or setmark‚ot found"},

216 {0x14,0x03,
T
,"End-of-data‚ot found"},

217 {0x14,0x04,
T
,"Block sequenceƒrror"},

218 {0x15,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
,"Random…ositioningƒrror"},

219 {0x15,0x01,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
,"Mechanical…ositioningƒrror"},

220 {0x15,0x02,
D
|
T
|
W
|
R
|
O
,"Positioningƒrror detected by„ead of medium"},

221 {0x16,0x00,
D
|
W
|
O
,"Data synchronization markƒrror"},

222 {0x17,0x00,
D
|
T
|
W
|
R
|
S
|
O
,"Recovered data with‚oƒrror correction‡pplied"},

223 {0x17,0x01,
D
|
T
|
W
|
R
|
S
|
O
,"Recovered data with„etries"},

224 {0x17,0x02,
D
|
T
|
W
|
R
|
O
,"Recovered data with…ositive head offset"},

225 {0x17,0x03,
D
|
T
|
W
|
R
|
O
,"Recovered data with‚egative head offset"},

226 {0x17,0x04,
W
|
R
|
O
,"Recovered data with„etries‡nd/or circ‡pplied"},

227 {0x17,0x05,
D
|
W
|
R
|
O
,"Recovered data using…revious sector id"},

228 {0x17,0x06,
D
|
W
|
O
,"Recovered data withoutƒcc - data‡uto-reallocated"},

229 {0x17,0x07,
D
|
W
|
O
,"Recovered data withoutƒcc -„ecommend„eassignment"},

230 {0x18,0x00,
D
|
T
|
W
|
R
|
O
,"Recovered data withƒrror correction‡pplied"},

231 {0x18,0x01,
D
|
W
|
R
|
O
,"Recovered data withƒrror correction‡nd„etries‡pplied"},

232 {0x18,0x02,
D
|
W
|
R
|
O
,"Recovered data - data‡uto-reallocated"},

233 {0x18,0x03,
R
,"Recovered data with circ"},

234 {0x18,0x04,
R
,"Recovered data with†ec"},

235 {0x18,0x05,
D
|
W
|
R
|
O
,"Recovered data -„ecommend„eassignment"},

236 {0x19,0x00,
D
|
O
,"Defect†istƒrror"},

237 {0x19,0x01,
D
|
O
,"Defect†ist‚ot‡vailable"},

238 {0x19,0x02,
D
|
O
,"Defect†istƒrror in…rimary†ist"},

239 {0x19,0x03,
D
|
O
,"Defect†istƒrror in grown†ist"},

240 {0x1A,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Parameter†ist†engthƒrror"},

241 {0x1B,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Synchronous dataransferƒrror"},

242 {0x1C,0x00,
D
|
O
,"Defect†ist‚ot found"},

243 {0x1C,0x01,
D
|
O
,"Primary defect†ist‚ot found"},

244 {0x1C,0x02,
D
|
O
,"Grown defect†ist‚ot found"},

245 {0x1D,0x00,
D
|
W
|
O
,"Miscompare during verify operation"},

246 {0x1E,0x00,
D
|
W
|
O
,"Recovered id withƒcc correction"},

247 {0x20,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Invalid command operation code"},

248 {0x21,0x00,
D
|
T
|
W
|
R
|
O
|
M
,"Logical block‡ddress out of„ange"},

249 {0x21,0x01,
M
,"Invalidƒlement‡ddress"},

250 {0x22,0x00,
D
,"Illegal function (should use 20 00, 24 00, or 26 00)"},

251 {0x24,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Invalid field in cdb"},

252 {0x25,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit‚ot supported"},

253 {0x26,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Invalid field in…arameter†ist"},

254 {0x26,0x01,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Parameter‚ot supported"},

255 {0x26,0x02,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Parameter value invalid"},

256 {0x26,0x03,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Threshold…arameters‚ot supported"},

257 {0x27,0x00,
D
|
T
|
W
|
O
,"Write…rotected"},

258 {0x28,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Not„eadyo„eadyransition (medium may have changed)"},

259 {0x28,0x01,
M
,"Import orƒxportƒlement‡ccessed"},

260 {0x29,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Power on,„eset, or bus device„eset occurred"},

261 {0x2A,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Parameters changed"},

262 {0x2A,0x01,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Mode…arameters changed"},

263 {0x2A,0x02,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Log…arameters changed"},

264 {0x2B,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
C
,"Copy cannotƒxecute since host cannot disconnect"},

265 {0x2C,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Command sequenceƒrror"},

266 {0x2C,0x01,
S
,"Too many windows specified"},

267 {0x2C,0x02,
S
,"Invalid combination of windows specified"},

268 {0x2D,0x00,
T
,"Overwriteƒrror on update in…lace"},

269 {0x2F,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Commands cleared by‡nother initiator"},

270 {0x30,0x00,
D
|
T
|
W
|
R
|
O
|
M
,"Incompatible medium installed"},

271 {0x30,0x01,
D
|
T
|
W
|
R
|
O
,"Cannot„ead medium - unknown format"},

272 {0x30,0x02,
D
|
T
|
W
|
R
|
O
,"Cannot„ead medium - incompatible format"},

273 {0x30,0x03,
D
|
T
,"Cleaning cartridge installed"},

274 {0x31,0x00,
D
|
T
|
W
|
O
,"Medium format corrupted"},

275 {0x31,0x01,
D
|
L
|
O
,"Format command failed"},

276 {0x32,0x00,
D
|
W
|
O
,"No defect spare†ocation‡vailable"},

277 {0x32,0x01,
D
|
W
|
O
,"Defect†ist update failure"},

278 {0x33,0x00,
T
,"Tape†engthƒrror"},

279 {0x36,0x00,
L
,"Ribbon, ink, oroner failure"},

280 {0x37,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Rounded…arameter"},

281 {0x39,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
|
C
,"Saving…arameters‚ot supported"},

282 {0x3A,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
,"Medium‚ot…resent"},

283 {0x3B,0x00,
T
|
L
,"Sequential…ositioningƒrror"},

284 {0x3B,0x01,
T
,"Tape…ositionƒrror‡t beginning-of-medium"},

285 {0x3B,0x02,
T
,"Tape…ositionƒrror‡tƒnd-of-medium"},

286 {0x3B,0x03,
L
,"Tape orƒlectronic vertical forms unit‚ot„eady"},

287 {0x3B,0x04,
L
,"Slew failure"},

288 {0x3B,0x05,
L
,"Paper jam"},

289 {0x3B,0x06,
L
,"Failedo senseop-of-form"},

290 {0x3B,0x07,
L
,"Failedo sense bottom-of-form"},

291 {0x3B,0x08,
T
,"Repositionƒrror"},

292 {0x3B,0x09,
S
,"Read…astƒnd of medium"},

293 {0x3B,0x0A,
S
,"Read…ast beginning of medium"},

294 {0x3B,0x0B,
S
,"Position…astƒnd of medium"},

295 {0x3B,0x0C,
S
,"Position…ast beginning of medium"},

296 {0x3B,0x0D,
M
,"Medium destinationƒlement full"},

297 {0x3B,0x0E,
M
,"Medium sourceƒlementƒmpty"},

298 {0x3D,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Invalid bits in identify message"},

299 {0x3E,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit has‚ot self-configured yet"},

300 {0x3F,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Target operating conditions have changed"},

301 {0x3F,0x01,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Microcode has been changed"},

302 {0x3F,0x02,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Changed operating definition"},

303 {0x3F,0x03,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Inquiry data has changed"},

304 {0x43,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Messageƒrror"},

305 {0x44,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Internalarget failure"},

306 {0x45,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Select or„eselect failure"},

307 {0x46,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Unsuccessful soft„eset"},

308 {0x47,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Scsi…arityƒrror"},

309 {0x48,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Initiator detectedƒrror message„eceived"},

310 {0x49,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Invalid messageƒrror"},

311 {0x4A,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Command…haseƒrror"},

312 {0x4B,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Data…haseƒrror"},

313 {0x4C,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Logical unit failed self-configuration"},

314 {0x4E,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
|
C
,"Overlapped commands‡ttempted"},

315 {0x50,0x00,
T
,"Write‡ppendƒrror"},

316 {0x50,0x01,
T
,"Write‡ppend…ositionƒrror"},

317 {0x50,0x02,
T
,"Positionƒrror„elatedoiming"},

318 {0x51,0x00,
T
|
O
,"Erase failure"},

319 {0x52,0x00,
T
,"Cartridge fault"},

320 {0x53,0x00,
D
|
T
|
L
|
W
|
R
|
S
|
O
|
M
,"Media†oad orƒject failed"},

321 {0x53,0x01,
T
,"Unloadape failure"},

322 {0x53,0x02,
D
|
T
|
W
|
R
|
O
|
M
,"Medium„emoval…revented"},

323 {0x54,0x00,
P
,"Scsio host system interface failure"},

324 {0x55,0x00,
P
,"System„esource failure"},

325 {0x57,0x00,
R
,"Unableo„ecoverable-of-contents"},

326 {0x58,0x00,
O
,"Generation does‚otƒxist"},

327 {0x59,0x00,
O
,"Updated block„ead"},

328 {0x5A,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
,"Operator„equest or state change input (unspecified)"},

329 {0x5A,0x01,
D
|
T
|
W
|
R
|
O
|
M
,"Operator medium„emoval„equest"},

330 {0x5A,0x02,
D
|
T
|
W
|
O
,"Operator selected write…rotect"},

331 {0x5A,0x03,
D
|
T
|
W
|
O
,"Operator selected write…ermit"},

332 {0x5B,0x00,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
,"Logƒxception"},

333 {0x5B,0x01,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
,"Threshold condition met"},

334 {0x5B,0x02,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
,"Log counter‡t maximum"},

335 {0x5B,0x03,
D
|
T
|
L
|
P
|
W
|
R
|
S
|
O
|
M
,"Log†ist codesƒxhausted"},

336 {0x5C,0x00,
D
|
O
,"Rpl status change"},

337 {0x5C,0x01,
D
|
O
,"Spindles synchronized"},

338 {0x5C,0x02,
D
|
O
,"Spindles‚ot synchronized"},

339 {0x60,0x00,
S
,"Lamp failure"},

340 {0x61,0x00,
S
,"Video‡cquisitionƒrror"},

341 {0x61,0x01,
S
,"Unableo‡cquire video"},

342 {0x61,0x02,
S
,"Out of focus"},

343 {0x62,0x00,
S
,"Scan head…ositioningƒrror"},

344 {0x63,0x00,
R
,"End of user‡reaƒncountered onhisrack"},

345 {0x64,0x00,
R
,"Illegal mode forhisrack"},

346 {0, 0, 0, 
NULL
}

350 #ià(
CONSTANTS
 & 
CONST_SENSE
)

351 *
	g¢¡ext
[] = {

360 
	$´št_£n£
(* 
devşass
, 
Scsi_Cmnd
 * 
SC²t
)

362 
i
, 
s
;

363 
£n£_şass
, 
v®id
, 
code
;

364 * 
£n£_bufãr
 = 
SC²t
->sense_buffer;

365 * 
”rÜ
 = 
NULL
;

366 
dev
 = 
SC²t
->
»que¡
.dev;

368 
£n£_şass
 = (
£n£_bufãr
[0] >> 4) & 0x07;

369 
code
 = 
£n£_bufãr
[0] & 0xf;

370 
v®id
 = 
£n£_bufãr
[0] & 0x80;

372 ià(
£n£_şass
 == 7) {

373 
s
 = 
£n£_bufãr
[7] + 8;

374 if(
s
 > (
SC²t
->
£n£_bufãr
)) s = (SCpnt->sense_buffer);

376 ià(!
v®id
)

377 
	`´štk
("extra data‚ot valid ");

379 ià(
£n£_bufãr
[2] & 0x80è
	`´štk
( "FMK ");

380 ià(
£n£_bufãr
[2] & 0x40è
	`´štk
( "EOM ");

381 ià(
£n£_bufãr
[2] & 0x20è
	`´štk
( "ILI ");

383 
code
) {

385 
”rÜ
 = "Current";

388 
”rÜ
 = "Deferred";

391 
”rÜ
 = "Invalid";

394 
	`´štk
("% ”rÜ ", 
”rÜ
);

396 #ià(
CONSTANTS
 & 
CONST_SENSE
)

397 ià(
£n£_bufãr
[2] & 0x80è
	`´štk
( "FMK ");

398 ià(
£n£_bufãr
[2] & 0x40è
	`´štk
( "EOM ");

399 ià(
£n£_bufãr
[2] & 0x20è
	`´štk
( "ILI ");

400 
	`´štk
Ğ"%s%x: s’£ key %s\n", 
devşass
, 
dev
, 
¢¡ext
[
£n£_bufãr
[2] & 0x0f]);

402 
	`´štk
("%s%x: sn ğ%2x %2x\n", 
devşass
, 
dev
, 
£n£_bufãr
[0], sense_buffer[2]);

406 if(
£n£_bufãr
[7] + 7 < 13 ||

407 (
£n£_bufãr
[12] =ğ0 && s’£_bufãr[13] =ğ0)è
dÚe
;

409 #ià(
CONSTANTS
 & 
CONST_XSENSE
)

410 
i
=0; 
add™iÚ®
[i].
‹xt
; i++)

411 if(
add™iÚ®
[
i
].
code1
 =ğ
£n£_bufãr
[12] &&

412 
add™iÚ®
[
i
].
code2
 =ğ
£n£_bufãr
[13])

413 
	`´štk
("Add™iÚ® s’£ indiÿ‹ %s\n", 
add™iÚ®
[
i
].
‹xt
);

415 
i
=0; 
add™iÚ®2
[i].
‹xt
; i++)

416 if(
add™iÚ®2
[
i
].
code1
 =ğ
£n£_bufãr
[12] &&

417 
add™iÚ®2
[
i
].
code2_mš
 >ğ
£n£_bufãr
[13] &&

418 
add™iÚ®2
[
i
].
code2_max
 <ğ
£n£_bufãr
[13]) {

419 
	`´štk
("Additional sense indicates ");

420 
	`´štk
(
add™iÚ®2
[
i
].
‹xt
, 
£n£_bufãr
[13]);

421 
	`´štk
("\n");

424 
	`´štk
("ASC=%2x ASCQ=%2x\n", 
£n£_bufãr
[12], sense_buffer[13]);

428 #ià(
CONSTANTS
 & 
CONST_SENSE
)

429 ià(
£n£_bufãr
[0] < 15)

430 
	`´štk
("%s%x: old s’£ key %s\n", 
devşass
, 
dev
, 
¢¡ext
[
£n£_bufãr
[0] & 0x0f]);

433 
	`´štk
("%s%x: sn ğ%2x %2x\n", 
devşass
, 
dev
, 
£n£_bufãr
[0], sense_buffer[2]);

435 
	`´štk
("NÚ-ex‹nded s’£ cÏs %d cod0x%0x ", 
£n£_şass
, 
code
);

436 
s
 = 4;

439 
dÚe
:

440 
i
 = 0; i < 
s
; ++i)

441 
	`´štk
("0x%02x ", 
£n£_bufãr
[
i
]);

444 
	}
}

446 #ià(
CONSTANTS
 & 
CONST_MSG
)

447 cÚ¡ *
	gÚe_by‹_msgs
[] = {

448  "Commªd Com¶‘e", 
NULL
, "Save Pointers",

456 
	#NO_ONE_BYTE_MSGS
 ((
Úe_by‹_msgs
è/  (cÚ¡ *))

	)

458 cÚ¡ *
queue_g_msgs
[] = {

463 
	#NO_TWO_BYTE_MSGS
 ((
two_by‹_msgs
è/  (cÚ¡ *))

	)

465 cÚ¡ *
ex‹nded_msgs
[] = {

470 
	#NO_EXTENDED_MSGS
 ((
two_by‹_msgs
è/  (cÚ¡ *))

	)

473 
	$´št_msg
 (cÚ¡ *
msg
) {

474 
Ën
 = 0, 
i
;

475 ià(
msg
[0] =ğ
EXTENDED_MESSAGE
) {

476 
Ën
 = 3 + 
msg
[1];

477 #ià(
CONSTANTS
 & 
CONST_MSG
)

478 
	`´štk
("Extended Message code %s‡rguments ",

479 (
msg
[2] < 
NO_EXTENDED_MESSAGES
) ?

480 
	`´štk
("% " 
ex‹nded_msgs
[
msg
[2]]),

481 
»£rved
);

482 
i
 = 3; i < 
msg
[1]; ++i)

484 
i
 = 0; i < 
msg
[1]; ++i)

486 
	`´štk
("%02x ", 
msg
[
i
]);

488 } ià(
msg
[0] & 0x80) {

489 #ià(
CONSTANTS
 & 
CONST_MSG
)

490 
	`´štk
("Identify disconnect %sallowed %s %d ",

491 (
msg
[0] & 0x40) ? "" : "not ",

492 (
msg
[0] & 0x20) ? "target„outine" : "lun",

493 
msg
[0] & 0x7);

495 
	`´štk
("%02x ", 
msg
[0]);

497 
Ën
 = 1;

499 } ià(
msg
[0] < 0x1f) {

500 #ià(
CONSTANTS
 & 
CONST_MSG
)

501 ià(
msg
[0] < 
NO_ONE_BYTE_MSGS
)

502 
	`´štk
(
Úe_by‹_msgs
[
msg
[0]]);

504 
	`´štk
("»£rved (%02xè", 
msg
[0]);

506 
	`´štk
("%02x ", 
msg
[0]);

508 
Ën
 = 1;

510 } ià(
msg
[0] <= 0x2f) {

511 #ià(
CONSTANTS
 & 
CONST_MSG
)

512 ià((
msg
[0] - 0x20è< 
NO_TWO_BYTE_MESSAGES
)

513 
	`´štk
("% %02x ", 
two_by‹_msgs
[
msg
[0] - 0x20],

514 
msg
[1]);

516 
	`´štk
("reservedwo byte (%02x %02x) ",

517 
msg
[0], msg[1]);

519 
	`´štk
("%02x %02x", 
msg
[0], msg[1]);

521 
Ën
 = 2;

523 #ià(
CONSTANTS
 & 
CONST_MSG
)

524 
	`´štk
(
»£rved
);

526 
	`´štk
("%02x ", 
msg
[0]);

528  
Ën
;

529 
	}
}

	@drivers/scsi/constants.h

1 #iâdeà
_CONSTANTS_H


2 
	#_CONSTANTS_H


	)

3 
´št_commªd
(*);

4 
´št_msg
(*);

5 
´št_£n£
(*, 
Scsi_Cmnd
 *);

6 
´št_¡©us
();;

	@drivers/scsi/fdomain.c

136 
	~<lšux/sched.h
>

137 
	~<asm/io.h
>

138 
	~"../block/blk.h
"

139 
	~"scsi.h
"

140 
	~"ho¡s.h
"

141 
	~"fdomaš.h
"

142 
	~<asm/sy¡em.h
>

143 
	~<lšux/”ºo.h
>

144 
	~<lšux/¡ršg.h
>

145 
	~<lšux/iİÜt.h
>

147 
	#VERSION
 "$RevisiÚ: 5.9 $"

	)

151 
	#DEBUG
 1

	)

152 
	#ENABLE_PARITY
 1

	)

153 
	#FIFO_COUNT
 2

	)

154 
	#DO_DETECT
 0

	)

158 #ià
DEBUG


159 
	#EVERY_ACCESS
 0

	)

160 
	#ERRORS_ONLY
 1

	)

161 
	#DEBUG_DETECT
 0

	)

162 
	#DEBUG_MESSAGES
 1

	)

163 
	#DEBUG_ABORT
 1

	)

164 
	#DEBUG_RESET
 1

	)

165 
	#DEBUG_RACE
 1

	)

167 
	#EVERY_ACCESS
 0

	)

168 
	#ERRORS_ONLY
 0

	)

169 
	#DEBUG_DETECT
 0

	)

170 
	#DEBUG_MESSAGES
 0

	)

171 
	#DEBUG_ABORT
 0

	)

172 
	#DEBUG_RESET
 0

	)

173 
	#DEBUG_RACE
 0

	)

177 #ià
EVERY_ACCESS


178 #undeà
ERRORS_ONLY


179 
	#ERRORS_ONLY
 0

	)

182 #ià
ENABLE_PARITY


183 
	#PARITY_MASK
 0x08

	)

185 
	#PARITY_MASK
 0x00

	)

188 
	ech_ty³
 {

189 
	munknown
 = 0x00,

190 
	mtmc1800
 = 0x01,

191 
	mtmc18c50
 = 0x02,

195 
	mš_¬b™¿tiÚ
 = 0x02,

196 
	mš_£ËùiÚ
 = 0x04,

197 
	mš_Ùh”
 = 0x08,

198 
	mdiscÚÃù
 = 0x10,

199 
	mabÜ‹d
 = 0x20,

200 
	m£Á_id’t
 = 0x40,

203 
	eš_pÜt_ty³
 {

204 
	mR—d_SCSI_D©a
 = 0,

205 
	mSCSI_Stus
 = 1,

206 
	mTMC_Stus
 = 2,

207 
	mFIFO_Stus
 = 3,

208 
	mIÁ”ru±_CÚd
 = 4,

209 
	mLSB_ID_Code
 = 5,

210 
	mMSB_ID_Code
 = 6,

211 
	mR—d_Loİback
 = 7,

212 
	mSCSI_D©a_NoACK
 = 8,

213 
	mIÁ”ru±_Stus
 = 9,

214 
	mCÚfigu¿tiÚ1
 = 10,

215 
	mCÚfigu¿tiÚ2
 = 11,

216 
	mR—d_FIFO
 = 12,

217 
	mFIFO_D©a_CouÁ
 = 14

220 
	eout_pÜt_ty³
 {

221 
	mWr™e_SCSI_D©a
 = 0,

222 
	mSCSI_CÁl
 = 1,

223 
	mIÁ”ru±_CÁl
 = 2,

224 
	mSCSI_Mode_CÁl
 = 3,

225 
	mTMC_CÁl
 = 4,

226 
	mMemÜy_CÁl
 = 5,

227 
	mWr™e_Loİback
 = 7,

228 
	mWr™e_FIFO
 = 12

231 
	gpÜt_ba£
 = 0;

232 *
	gbios_ba£
 = 
NULL
;

233 
	gbios_majÜ
 = 0;

234 
	gbios_mšÜ
 = 0;

235 
	gš‹¼u±_Ëv–
 = 0;

236 
	gthis_ho¡
 = 0;

237 vŞ©
	gš_commªd
 = 0;

238 
Scsi_Cmnd
 *
	gcu¼’t_SC
 = 
NULL
;

239 
ch_ty³
 
	gch
 = 
unknown
;

240 
	gad­‹r_mask
 = 0x40;

241 #ià
DEBUG_RACE


242 vŞ©
	gš_š‹¼u±_æag
 = 0;

245 
	gSCSI_Mode_CÁl_pÜt
;

246 
	gFIFO_D©a_CouÁ_pÜt
;

247 
	gIÁ”ru±_CÁl_pÜt
;

248 
	gIÁ”ru±_Stus_pÜt
;

249 
	gR—d_FIFO_pÜt
;

250 
	gR—d_SCSI_D©a_pÜt
;

251 
	gSCSI_CÁl_pÜt
;

252 
	gSCSI_D©a_NoACK_pÜt
;

253 
	gSCSI_Stus_pÜt
;

254 
	gTMC_CÁl_pÜt
;

255 
	gTMC_Stus_pÜt
;

256 
	gWr™e_FIFO_pÜt
;

257 
	gWr™e_SCSI_D©a_pÜt
;

259 
fdomaš_16x0_šŒ
Ğ
unu£d
 );

261 *
	gadd»s£s
[] = {

266 
	#ADDRESS_COUNT
 (Ğ
add»s£s
 ) / Ğ))

	)

268 
	gpÜts
[] = { 0x140, 0x150, 0x160, 0x170 };

269 
	#PORT_COUNT
 (Ğ
pÜts
 ) / Ğ))

	)

271 
	gšts
[] = { 3, 5, 10, 11, 12, 14, 15, 0 };

298 
	ssigÇtu»
 {

299 *
	msigÇtu»
;

300 
	msig_off£t
;

301 
	msig_Ëngth
;

302 
	mmajÜ_bios_v”siÚ
;

303 
	mmšÜ_bios_v”siÚ
;

304 } 
	gsigÇtu»s
[] = {

326 
	#SIGNATURE_COUNT
 (Ğ
sigÇtu»s
 ) / Ğ
sigÇtu»
 ))

	)

328 
	$´št_bªÃr
( )

330 
	`´štk
Ğ"%s", 
	`fdomaš_16x0_šfo
() );

331 
	`´štk
( "Future Domain: BIOS version %d.%d, %s\n",

332 
bios_majÜ
, 
bios_mšÜ
,

333 
ch
 =ğ
tmc1800
 ? "TMC-1800"

334 : (
ch
 =ğ
tmc18c50
 ? "TMC-18C50" : "Unknown") );

336 ià(
š‹¼u±_Ëv–
) {

337 
	`´štk
( "Future Domain: BIOS‡t %x;…ort base‡t %x; using IRQ %d\n",

338 ()
bios_ba£
, 
pÜt_ba£
, 
š‹¼u±_Ëv–
 );

340 
	`´štk
( "Future Domain: BIOS‡t %x;…ort base‡t %x; *NO* IRQ\n",

341 ()
bios_ba£
, 
pÜt_ba£
 );

343 
	}
}

345 
	$do_·u£
Ğ
amouÁ
 )

347 
the_time
 = 
jiff›s
 + 
amouÁ
;

349 
jiff›s
 < 
the_time
);

350 
	}
}

352 
šlše
 
	$fdomaš_make_bus_idË
( )

354 
	`outb
Ğ0, 
SCSI_CÁl_pÜt
 );

355 
	`outb
Ğ0, 
SCSI_Mode_CÁl_pÜt
 );

356 ià(
ch
 =ğ
tmc18c50
)

357 
	`outb
Ğ0x21 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

359 
	`outb
Ğ0x01 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

360 
	}
}

362 
	$fdomaš_is_v®id_pÜt
Ğ
pÜt
 )

364 
İtiÚs
;

366 #ià
DEBUG_DETECT


367 
	`´štk
( " (%x%x),",

368 
	`šb
Ğ
pÜt
 + 
MSB_ID_Code
 ), inbĞpÜˆ+ 
LSB_ID_Code
 ) );

377 ià(
	`šb
Ğ
pÜt
 + 
LSB_ID_Code
 ) != 0xe9) {

378 ià(
	`šb
Ğ
pÜt
 + 
LSB_ID_Code
 ) != 0x27)  0;

379 ià(
	`šb
Ğ
pÜt
 + 
MSB_ID_Code
 ) != 0x61)  0;

380 
ch
 = 
tmc1800
;

382 ià(
	`šb
Ğ
pÜt
 + 
MSB_ID_Code
 ) != 0x60)  0;

383 
ch
 = 
tmc18c50
;

392 
İtiÚs
 = 
	`šb
Ğ
pÜt
 + 
CÚfigu¿tiÚ1
 );

394 #ià
DEBUG_DETECT


395 
	`´štk
Ğ" O±iÚ ğ%x\n", 
İtiÚs
 );

399 ià(
add»s£s
[ (
İtiÚs
 & 0xc0è>> 6 ] !ğ
bios_ba£
)

401 
š‹¼u±_Ëv–
 = 
šts
[ (
İtiÚs
 & 0x0e) >> 1 ];

404 
	}
}

406 
	$fdomaš_‹¡_loİback
( )

408 
i
;

409 
»suÉ
;

411 
i
 = 0; i < 255; i++) {

412 
	`outb
Ğ
i
, 
pÜt_ba£
 + 
Wr™e_Loİback
 );

413 
»suÉ
 = 
	`šb
Ğ
pÜt_ba£
 + 
R—d_Loİback
 );

414 ià(
i
 !ğ
»suÉ
)

418 
	}
}

420 
	$fdomaš_16x0_d‘eù
Ğ
ho¡num
 )

422 
i
, 
j
;

423 
æag
 = 0;

424 
sigaùiÚ
 
§
;

425 
»tcode
;

426 #ià
DO_DETECT


427 cÚ¡ 
buæ’
 = 255;

428 
Scsi_Cmnd
 
SCš™
;

429 
do_šquœy
[] = { 
INQUIRY
, 0, 0, 0, 
buæ’
, 0 };

430 
do_»que¡_£n£
[] = { 
REQUEST_SENSE
, 0, 0, 0, 
buæ’
, 0 };

431 
do_»ad_ÿ·c™y
[] = { 
READ_CAPACITY
,

433 
buf
[
buæ’
];

436 #ià
DEBUG_DETECT


437 
	`´štk
( "fdomain_16x0_detect()," );

440 
i
 = 0; !
bios_ba£
 && i < 
ADDRESS_COUNT
; i++) {

441 #ià
DEBUG_DETECT


442 
	`´štk
Ğ" %x(%x),", ()
add»s£s
[
i
], ()
bios_ba£
 );

444 
j
 = 0; !
bios_ba£
 && j < 
SIGNATURE_COUNT
; j++) {

445 ià(!
	`memcmp
Ğ((*)
add»s£s
[
i
] + 
sigÇtu»s
[
j
].
sig_off£t
),

446 
sigÇtu»s
[
j
].
sigÇtu»
, sigÇtu»s[j].
sig_Ëngth
 )) {

447 
bios_majÜ
 = 
sigÇtu»s
[
j
].
majÜ_bios_v”siÚ
;

448 
bios_mšÜ
 = 
sigÇtu»s
[
j
].
mšÜ_bios_v”siÚ
;

449 
bios_ba£
 = 
add»s£s
[
i
];

454 ià(!
bios_ba£
) {

455 #ià
DEBUG_DETECT


456 
	`´štk
( " FAILED: NO BIOS\n" );

461 ià(
bios_majÜ
 == 2) {

470 
pÜt_ba£
 = *((*)
bios_ba£
 + 0x1fcc)

471 + (*((*)
bios_ba£
 + 0x1fcd) << 8);

473 #ià
DEBUG_DETECT


474 
	`´štk
Ğ" %x,", 
pÜt_ba£
 );

477 
æag
 = 0, 
i
 = 0; !æag && i < 
PORT_COUNT
; i++) {

478 ià(
pÜt_ba£
 =ğ
pÜts
[
i
])

479 ++
æag
;

482 ià(
æag
)

483 
æag
 = 
	`fdomaš_is_v®id_pÜt
Ğ
pÜt_ba£
 );

486 ià(!
æag
) {

494 #ià
DEBUG_DETECT


495 ià(
bios_majÜ
 !ğ2è
	`´štk
( " RAM FAILED, " );

509 
i
 = 0; !
æag
 && i < 
PORT_COUNT
; i++) {

510 
pÜt_ba£
 = 
pÜts
[
i
];

511 ià(
	`check_»giÚ
Ğ
pÜt_ba£
, 0x10 )) {

512 #ià
DEBUG_DETECT


513 
	`´štf
Ğ" (%x inu£),", 
pÜt_ba£
 );

517 #ià
DEBUG_DETECT


518 
	`´štk
Ğ" %x,", 
pÜt_ba£
 );

520 
æag
 = 
	`fdomaš_is_v®id_pÜt
Ğ
pÜt_ba£
 );

524 ià(!
æag
) {

525 #ià
DEBUG_DETECT


526 
	`´štk
( " FAILED: NO PORT\n" );

531 
	`´št_bªÃr
();

533 
SCSI_Mode_CÁl_pÜt
 = 
pÜt_ba£
 + 
SCSI_Mode_CÁl
;

534 
FIFO_D©a_CouÁ_pÜt
 = 
pÜt_ba£
 + 
FIFO_D©a_CouÁ
;

535 
IÁ”ru±_CÁl_pÜt
 = 
pÜt_ba£
 + 
IÁ”ru±_CÁl
;

536 
IÁ”ru±_Stus_pÜt
 = 
pÜt_ba£
 + 
IÁ”ru±_Stus
;

537 
R—d_FIFO_pÜt
 = 
pÜt_ba£
 + 
R—d_FIFO
;

538 
R—d_SCSI_D©a_pÜt
 = 
pÜt_ba£
 + 
R—d_SCSI_D©a
;

539 
SCSI_CÁl_pÜt
 = 
pÜt_ba£
 + 
SCSI_CÁl
;

540 
SCSI_D©a_NoACK_pÜt
 = 
pÜt_ba£
 + 
SCSI_D©a_NoACK
;

541 
SCSI_Stus_pÜt
 = 
pÜt_ba£
 + 
SCSI_Stus
;

542 
TMC_CÁl_pÜt
 = 
pÜt_ba£
 + 
TMC_CÁl
;

543 
TMC_Stus_pÜt
 = 
pÜt_ba£
 + 
TMC_Stus
;

544 
Wr™e_FIFO_pÜt
 = 
pÜt_ba£
 + 
Wr™e_FIFO
;

545 
Wr™e_SCSI_D©a_pÜt
 = 
pÜt_ba£
 + 
Wr™e_SCSI_D©a
;

547 
	`fdomaš_16x0_»£t
Ğ
NULL
 );

549 ià(
	`fdomaš_‹¡_loİback
()) {

550 #ià
DEBUG_DETECT


551 
	`´štk
( "Future Domain: LOOPBACK TEST FAILED, FAILING DETECT!\n" );

556 
this_ho¡
 = 
ho¡num
;

560 ià(!
š‹¼u±_Ëv–
) {

561 
	`·nic
( "Future Domain: *NO* interrupt†evel selected!\n" );

565 
§
.
§_hªdËr
 = 
fdomaš_16x0_šŒ
;

566 
§
.
§_æags
 = 
SA_INTERRUPT
;

567 
§
.
§_mask
 = 0;

568 
§
.
§_»¡Ü”
 = 
NULL
;

570 
»tcode
 = 
	`œqaùiÚ
Ğ
š‹¼u±_Ëv–
, &
§
 );

572 ià(
»tcode
 < 0) {

573 ià(
»tcode
 =ğ-
EINVAL
) {

574 
	`´štk
Ğ"Futu» Domaš: IRQ %d i bad!\n", 
š‹¼u±_Ëv–
 );

575 
	`´štk
( " This shouldn't happen!\n" );

576 
	`´štk
( " Send mailo faith@cs.unc.edu\n" );

577 } ià(
»tcode
 =ğ-
EBUSY
) {

578 
	`´štk
( "Future Domain: IRQ %d is‡lready in use!\n",

579 
š‹¼u±_Ëv–
 );

580 
	`´štk
( " Please use‡nother IRQ!\n" );

582 
	`´štk
Ğ"Futu» Domaš: E¼Ü g‘tšg IRQ %d\n", 
š‹¼u±_Ëv–
 );

583 
	`´štk
( " This shouldn't happen!\n" );

584 
	`´štk
( " Send mailo faith@cs.unc.edu\n" );

586 
	`·nic
( "Future Domain: Driver„equires interruptions\n" );

588 
	`´štk
( "Future Domain: IRQ %d„equested from kernel\n",

589 
š‹¼u±_Ëv–
 );

595 
	`¢¬f_»giÚ
Ğ
pÜt_ba£
, 0x10 );

597 ià((
bios_majÜ
 =ğ3 && 
bios_mšÜ
 >= 2) || bios_major < 0) {

598 
ad­‹r_mask
 = 0x80;

599 
scsi_ho¡s
[
this_ho¡
].
this_id
 = 7;

602 #ià
DO_DETECT


611 
SCš™
.
»que¡_bufãr
 = SCš™.
bufãr
 = 
buf
;

612 
SCš™
.
»que¡_bufæ’
 = SCš™.
bufæ’
 = (
buf
)-1;

613 
SCš™
.
u£_sg
 = 0;

614 
SCš™
.
lun
 = 0;

616 
	`´štk
( "Future Domain detection„outine scanning for devices:\n" );

617 
i
 = 0; i < 8; i++) {

618 
SCš™
.
rg‘
 = 
i
;

619 ià(
i
 =ğ
scsi_ho¡s
[
this_ho¡
].
this_id
)

621 
	`memıy
(
SCš™
.
cmnd
, 
do_»que¡_£n£
, (do_request_sense));

622 
»tcode
 = 
	`fdomaš_16x0_commªd
(&
SCš™
);

623 ià(!
»tcode
) {

624 
	`memıy
(
SCš™
.
cmnd
, 
do_šquœy
, (do_inquiry));

625 
»tcode
 = 
	`fdomaš_16x0_commªd
(&
SCš™
);

626 ià(!
»tcode
) {

627 
	`´štk
Ğ" SCSI ID %d: ", 
i
 );

628 
j
 = 8; j < (
buf
[4] < 32 ? buf[4] : 32); j++)

629 
	`´štk
Ğ"%c", 
buf
[
j
] >= 20 ? buf[j] : ' ' );

630 
	`memıy
(
SCš™
.
cmnd
, 
do_»ad_ÿ·c™y
, (do_read_capacity));

631 
»tcode
 = 
	`fdomaš_16x0_commªd
(&
SCš™
);

632 ià(!
»tcode
) {

633 
blocks
, 
size
, 
ÿ·c™y
;

635 
blocks
 = (
buf
[0] << 24) | (buf[1] << 16)

636 | (
buf
[2] << 8) | buf[3];

637 
size
 = (
buf
[4] << 24) | (buf[5] << 16) | (buf[6] << 8) | buf[7];

638 
ÿ·c™y
 = +Ğ+(
blocks
 / 1024Lè* +(
size
 * 10L)) / 1024L;

640 
	`´štk
( "%lu MB (%lu byte blocks)",

641 ((
ÿ·c™y
 + 5Lè/ 10L), 
size
 );

643 
	`memıy
(
SCš™
.
cmnd
, 
do_»que¡_£n£
, (do_request_sense));

644 
»tcode
 = 
	`fdomaš_16x0_commªd
(&
SCš™
);

646 
	`´štk
 ("\n" );

648 
	`memıy
(
SCš™
.
cmnd
, 
do_»que¡_£n£
, (do_request_sense));

649 
»tcode
 = 
	`fdomaš_16x0_commªd
(&
SCš™
);

656 
	}
}

658 cÚ¡ *
	$fdomaš_16x0_šfo
()

660 
bufãr
[80];

661 *
±
;

663 
	`¡rıy
Ğ
bufãr
, "Future Domain: TMC-16x0 SCSI driver, version" );

664 ià(
	`¡rchr
Ğ
VERSION
, ':')) {

665 
	`¡rÿt
Ğ
bufãr
, 
	`¡rchr
Ğ
VERSION
, ':' ) + 1 );

666 
±
 = 
	`¡¼chr
Ğ
bufãr
, '$') - 1;

667 ià(!
±
)

668 
±
 = 
bufãr
 + 
	`¡¾’
( buffer ) - 1;

669 ià(*
±
 != ' ')

670 ++
±
;

671 *
±
++ = '\n';

672 *
±
 = '\0';

674 
	`¡rÿt
Ğ
bufãr
, " " 
VERSION
 "\n" );

677  
bufãr
;

678 
	}
}

681 
	$fdomaš_¬b™¿‹
( )

683 
¡©us
 = 0;

684 
timeout
;

686 #ià
EVERY_ACCESS


687 
	`´štk
( "fdomain_arbitrate()\n" );

690 
	`outb
Ğ0x00, 
SCSI_CÁl_pÜt
 );

691 
	`outb
Ğ
ad­‹r_mask
, 
pÜt_ba£
 + 
SCSI_D©a_NoACK
 );

692 
	`outb
Ğ0x04 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

694 
timeout
 = 
jiff›s
 + 50;

695 
jiff›s
 < 
timeout
) {

696 
¡©us
 = 
	`šb
Ğ
TMC_Stus_pÜt
 );

697 ià(
¡©us
 & 0x02)

702 
	`fdomaš_make_bus_idË
();

704 #ià
EVERY_ACCESS


705 
	`´štk
Ğ"Arb™¿tiÚ faed, stu ğ%x\n", 
¡©us
 );

707 #ià
ERRORS_ONLY


708 
	`´štk
Ğ"Futu» Domaš: Arb™¿tiÚ faed, stu ğ%x", 
¡©us
 );

711 
	}
}

714 
	$fdomaš_£Ëù
Ğ
rg‘
 )

716 
¡©us
;

717 
timeout
;

720 
	`outb
Ğ0x82, 
SCSI_CÁl_pÜt
 );

721 
	`outb
Ğ
ad­‹r_mask
 | (1 << 
rg‘
), 
SCSI_D©a_NoACK_pÜt
 );

724 
	`outb
Ğ
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

726 
timeout
 = 
jiff›s
 + 25;

727 
jiff›s
 < 
timeout
) {

728 
¡©us
 = 
	`šb
Ğ
SCSI_Stus_pÜt
 );

729 ià(
¡©us
 & 1) {

731 
	`outb
Ğ0x80, 
SCSI_CÁl_pÜt
 );

736 
	`fdomaš_make_bus_idË
();

737 #ià
EVERY_ACCESS


738 ià(!
rg‘
è
	`´štk
( "Selection failed\n" );

740 #ià
ERRORS_ONLY


741 ià(!
rg‘
è
	`´štk
( "Future Domain: Selection failed" );

744 
	}
}

746 
	$my_dÚe
Ğ
”rÜ
 )

748 ià(
š_commªd
) {

749 
š_commªd
 = 0;

750 
	`outb
Ğ0x00, 
IÁ”ru±_CÁl_pÜt
 );

751 
	`fdomaš_make_bus_idË
();

752 
cu¼’t_SC
->
»suÉ
 = 
”rÜ
;

753 ià(
cu¼’t_SC
->
scsi_dÚe
)

754 
cu¼’t_SC
->
	`scsi_dÚe
( current_SC );

755 
	`·nic
( "Future Domain: current_SC->scsi_done() == NULL" );

757 
	`·nic
( "Future Domain: my_done() called outside of command\n" );

759 #ià
DEBUG_RACE


760 
š_š‹¼u±_æag
 = 0;

762 
	}
}

764 
	$fdomaš_16x0_šŒ
Ğ
unu£d
 )

766 
¡©us
;

767 
dÚe
 = 0;

768 
d©a_couÁ
;

770 
	`¡i
();

772 
	`outb
Ğ0x00, 
IÁ”ru±_CÁl_pÜt
 );

775 ià(!
š_commªd
 || !
cu¼’t_SC
) {

776 #ià
EVERY_ACCESS


777 
	`´štk
( "Spurious interrupt, in_command = %d, current_SC = %x\n",

778 
š_commªd
, 
cu¼’t_SC
 );

784 ià(
cu¼’t_SC
->
SCp
.
pha£
 & 
abÜ‹d
) {

785 #ià
DEBUG_ABORT


786 
	`´štk
( "Interrupt‡fter‡bort, ignoring\n" );

792 #ià
DEBUG_RACE


793 ++
š_š‹¼u±_æag
;

796 ià(
cu¼’t_SC
->
SCp
.
pha£
 & 
š_¬b™¿tiÚ
) {

797 
¡©us
 = 
	`šb
Ğ
TMC_Stus_pÜt
 );

798 ià(!(
¡©us
 & 0x02)) {

799 #ià
EVERY_ACCESS


800 
	`´štk
( " AFAIL " );

802 
	`my_dÚe
Ğ
DID_BUS_BUSY
 << 16 );

805 
cu¼’t_SC
->
SCp
.
pha£
 = 
š_£ËùiÚ
;

807 
	`outb
Ğ0x40 | 
FIFO_COUNT
, 
IÁ”ru±_CÁl_pÜt
 );

809 
	`outb
Ğ0x82, 
SCSI_CÁl_pÜt
 );

810 
	`outb
Ğ
ad­‹r_mask
 | (1 << 
cu¼’t_SC
->
rg‘
), 
SCSI_D©a_NoACK_pÜt
 );

813 
	`outb
Ğ0x10 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

814 #ià
DEBUG_RACE


815 
š_š‹¼u±_æag
 = 0;

818 } ià(
cu¼’t_SC
->
SCp
.
pha£
 & 
š_£ËùiÚ
) {

819 
¡©us
 = 
	`šb
Ğ
SCSI_Stus_pÜt
 );

820 ià(!(
¡©us
 & 0x01)) {

822 ià(
	`fdomaš_£Ëù
Ğ
cu¼’t_SC
->
rg‘
 )) {

823 #ià
EVERY_ACCESS


824 
	`´štk
( " SFAIL " );

826 
	`my_dÚe
Ğ
DID_NO_CONNECT
 << 16 );

829 #ià
EVERY_ACCESS


830 
	`´štk
( " AltSel " );

833 
	`outb
Ğ0x10 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

836 
cu¼’t_SC
->
SCp
.
pha£
 = 
š_Ùh”
;

837 
	`outb
Ğ0x90 | 
FIFO_COUNT
, 
IÁ”ru±_CÁl_pÜt
 );

838 
	`outb
Ğ0x80, 
SCSI_CÁl_pÜt
 );

839 #ià
DEBUG_RACE


840 
š_š‹¼u±_æag
 = 0;

847 
¡©us
 = 
	`šb
Ğ
SCSI_Stus_pÜt
 );

849 ià(
¡©us
 & 0x10) {

851 
¡©us
 & 0x0e) {

854 
	`outb
Ğ
cu¼’t_SC
->
cmnd
[cu¼’t_SC->
SCp
.
£Á_commªd
++],

855 
Wr™e_SCSI_D©a_pÜt
 );

856 #ià
EVERY_ACCESS


857 
	`´štk
( "CMD = %x,",

858 
cu¼’t_SC
->
cmnd
[ cu¼’t_SC->
SCp
.
£Á_commªd
 - 1] );

862 ià(
ch
 !ğ
tmc1800
 && !
cu¼’t_SC
->
SCp
.
have_d©a_š
) {

863 
cu¼’t_SC
->
SCp
.
have_d©a_š
 = -1;

864 
	`outb
Ğ0xd0 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

868 ià(
ch
 !ğ
tmc1800
 && !
cu¼’t_SC
->
SCp
.
have_d©a_š
) {

869 
cu¼’t_SC
->
SCp
.
have_d©a_š
 = 1;

870 
	`outb
Ğ0x90 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

874 
cu¼’t_SC
->
SCp
.
Stus
 = 
	`šb
Ğ
R—d_SCSI_D©a_pÜt
 );

875 #ià
EVERY_ACCESS


876 
	`´štk
Ğ"Stu ğ%x, ", 
cu¼’t_SC
->
SCp
.
Stus
 );

878 #ià
ERRORS_ONLY


879 ià(
cu¼’t_SC
->
SCp
.
Stus
 && current_SC->SCp.Status != 2) {

880 
	`´štk
( "Future Domain:arget = %d, command = %x, "

882 
cu¼’t_SC
->
rg‘
, cu¼’t_SC->
cmnd
[0],

883 
cu¼’t_SC
->
SCp
.
Stus
 );

888 
	`outb
Ğ
MESSAGE_REJECT
, 
Wr™e_SCSI_D©a_pÜt
 );

891 
cu¼’t_SC
->
SCp
.
Mes§ge
 = 
	`šb
Ğ
R—d_SCSI_D©a_pÜt
 );

892 #ià
EVERY_ACCESS


893 
	`´štk
Ğ"Mes§gğ%x, ", 
cu¼’t_SC
->
SCp
.
Mes§ge
 );

895 ià(!
cu¼’t_SC
->
SCp
.
Mes§ge
è++
dÚe
;

896 #ià
DEBUG_MESSAGES
 || 
EVERY_ACCESS


897 ià(
cu¼’t_SC
->
SCp
.
Mes§ge
) {

898 
	`´štk
( "Future Domain: Message = %x\n",

899 
cu¼’t_SC
->
SCp
.
Mes§ge
 );

906 ià(
ch
 =ğ
tmc1800


907 && !
cu¼’t_SC
->
SCp
.
have_d©a_š


908 && (
cu¼’t_SC
->
SCp
.
£Á_commªd


909 >ğ
	`COMMAND_SIZE
Ğ
cu¼’t_SC
->
cmnd
[ 0 ] ))) {

1036 
cu¼’t_SC
->
cmnd
[0]) {

1037 
CHANGE_DEFINITION
: 
COMPARE
: 
COPY
:

1038 
COPY_VERIFY
: 
LOG_SELECT
: 
MODE_SELECT
:

1039 
MODE_SELECT_10
: 
SEND_DIAGNOSTIC
: 
WRITE_BUFFER
:

1041 
FORMAT_UNIT
: 
REASSIGN_BLOCKS
: 
RESERVE
:

1042 
SEARCH_EQUAL
: 
SEARCH_HIGH
: 
SEARCH_LOW
:

1043 
WRITE_6
: 
WRITE_10
: 
WRITE_VERIFY
:

1057 
cu¼’t_SC
->
SCp
.
have_d©a_š
 = -1;

1058 
	`outb
Ğ0xd0 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

1064 
cu¼’t_SC
->
SCp
.
have_d©a_š
 = 1;

1065 
	`outb
Ğ0x90 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

1070 ià(
cu¼’t_SC
->
SCp
.
have_d©a_š
 == -1) {

1071  (
d©a_couÁ
 = 0x2000 - 
	`šw
Ğ
FIFO_D©a_CouÁ_pÜt
 )) > 512 ) {

1072 #ià
EVERY_ACCESS


1073 
	`´štk
Ğ"DC=%d, ", 
d©a_couÁ
 ) ;

1075 ià(
d©a_couÁ
 > 
cu¼’t_SC
->
SCp
.
this_»sidu®
)

1076 
d©a_couÁ
 = 
cu¼’t_SC
->
SCp
.
this_»sidu®
;

1077 ià(
d©a_couÁ
 > 0) {

1078 #ià
EVERY_ACCESS


1079 
	`´štk
Ğ"%d OUT, ", 
d©a_couÁ
 );

1081 ià(
d©a_couÁ
 == 1) {

1082 
	`outb
Ğ*
cu¼’t_SC
->
SCp
.
±r
++, 
Wr™e_FIFO_pÜt
 );

1083 --
cu¼’t_SC
->
SCp
.
this_»sidu®
;

1085 
d©a_couÁ
 >>= 1;

1086 
	`outsw
Ğ
Wr™e_FIFO_pÜt
, 
cu¼’t_SC
->
SCp
.
±r
, 
d©a_couÁ
 );

1087 
cu¼’t_SC
->
SCp
.
±r
 +ğ2 * 
d©a_couÁ
;

1088 
cu¼’t_SC
->
SCp
.
this_»sidu®
 -ğ2 * 
d©a_couÁ
;

1091 ià(!
cu¼’t_SC
->
SCp
.
this_»sidu®
) {

1092 ià(
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
) {

1093 --
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
;

1094 ++
cu¼’t_SC
->
SCp
.
bufãr
;

1095 
cu¼’t_SC
->
SCp
.
±r
 = cu¼’t_SC->SCp.
bufãr
->
add»ss
;

1096 
cu¼’t_SC
->
SCp
.
this_»sidu®
 = cu¼’t_SC->SCp.
bufãr
->
Ëngth
;

1103 ià(
cu¼’t_SC
->
SCp
.
have_d©a_š
 == 1) {

1104 (
d©a_couÁ
 = 
	`šw
Ğ
FIFO_D©a_CouÁ_pÜt
 )) > 0) {

1105 #ià
EVERY_ACCESS


1106 
	`´štk
Ğ"DC=%d, ", 
d©a_couÁ
 );

1108 ià(
d©a_couÁ
 > 
cu¼’t_SC
->
SCp
.
this_»sidu®
)

1109 
d©a_couÁ
 = 
cu¼’t_SC
->
SCp
.
this_»sidu®
;

1110 ià(
d©a_couÁ
) {

1111 #ià
EVERY_ACCESS


1112 
	`´štk
Ğ"%d IN, ", 
d©a_couÁ
 );

1114 ià(
d©a_couÁ
 == 1) {

1115 *
cu¼’t_SC
->
SCp
.
±r
++ = 
	`šb
Ğ
R—d_FIFO_pÜt
 );

1116 --
cu¼’t_SC
->
SCp
.
this_»sidu®
;

1118 
d©a_couÁ
 >>= 1;

1119 
	`šsw
Ğ
R—d_FIFO_pÜt
, 
cu¼’t_SC
->
SCp
.
±r
, 
d©a_couÁ
 );

1120 
cu¼’t_SC
->
SCp
.
±r
 +ğ2 * 
d©a_couÁ
;

1121 
cu¼’t_SC
->
SCp
.
this_»sidu®
 -ğ2 * 
d©a_couÁ
;

1124 ià(!
cu¼’t_SC
->
SCp
.
this_»sidu®


1125 && 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
) {

1126 --
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
;

1127 ++
cu¼’t_SC
->
SCp
.
bufãr
;

1128 
cu¼’t_SC
->
SCp
.
±r
 = cu¼’t_SC->SCp.
bufãr
->
add»ss
;

1129 
cu¼’t_SC
->
SCp
.
this_»sidu®
 = cu¼’t_SC->SCp.
bufãr
->
Ëngth
;

1134 ià(
dÚe
) {

1135 #ià
EVERY_ACCESS


1136 
	`´štk
Ğ" ** IN DONE %d ** ", 
cu¼’t_SC
->
SCp
.
have_d©a_š
 );

1139 #ià
ERRORS_ONLY


1140 ià(
cu¼’t_SC
->
cmnd
[0] =ğ
REQUEST_SENSE
 && !cu¼’t_SC->
SCp
.
Stus
) {

1141 ià(()(*((*)
cu¼’t_SC
->
»que¡_bufãr
+2)) & 0x0f) {

1142 
key
;

1143 
code
;

1144 
qu®if›r
;

1146 
key
 = ()(*((*)
cu¼’t_SC
->
»que¡_bufãr
 + 2))

1148 
code
 = ()(*((*)
cu¼’t_SC
->
»que¡_bufãr
 + 12));

1149 
qu®if›r
 = ()(*((*)
cu¼’t_SC
->
»que¡_bufãr


1152 ià(!(
key
 =ğ
UNIT_ATTENTION
 && (
code
 == 0x29 || !code))

1153 && !(
key
 =ğ
NOT_READY


1154 && 
code
 == 0x04

1155 && (!
qu®if›r
 || qualifier == 0x02 || qualifier == 0x01))

1156 && !(
key
 =ğ
ILLEGAL_REQUEST
 && (
code
 == 0x25

1157 || 
code
 == 0x24

1158 || !
code
)))

1160 
	`´štk
( "Future Domain: REQUEST SENSE "

1162 
key
, 
code
, 
qu®if›r
 );

1166 #ià
EVERY_ACCESS


1167 
	`´štk
( "BEFORE MY_DONE. . ." );

1169 
	`my_dÚe
Ğ(
cu¼’t_SC
->
SCp
.
Stus
 & 0xff)

1170 | ((
cu¼’t_SC
->
SCp
.
Mes§ge
 & 0xffè<< 8è| (
DID_OK
 << 16) );

1171 #ià
EVERY_ACCESS


1172 
	`´štk
( "RETURNING.\n" );

1176 ià(
cu¼’t_SC
->
SCp
.
pha£
 & 
discÚÃù
) {

1177 
	`outb
Ğ0xd0 | 
FIFO_COUNT
, 
IÁ”ru±_CÁl_pÜt
 );

1178 
	`outb
Ğ0x00, 
SCSI_CÁl_pÜt
 );

1180 
	`outb
Ğ0x90 | 
FIFO_COUNT
, 
IÁ”ru±_CÁl_pÜt
 );

1183 #ià
DEBUG_RACE


1184 
š_š‹¼u±_æag
 = 0;

1187 
	}
}

1189 
fdomaš_16x0_queue
Ğ
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

1191 ià(
š_commªd
) {

1192 
	`·nic
( "Future Domain: fdomain_16x0_queue() NOT REENTRANT!\n" );

1194 #ià
EVERY_ACCESS


1195 
	`´štk
( "queue:arget = %d cmnd = 0x%02x…ieces = %d size = %u\n",

1196 
SC²t
->
rg‘
,

1197 *(*)
SC²t
->
cmnd
,

1198 
SC²t
->
u£_sg
,

1199 
SC²t
->
»que¡_bufæ’
 );

1202 
	`fdomaš_make_bus_idË
();

1204 
cu¼’t_SC
 = 
SC²t
;

1205 
cu¼’t_SC
->
scsi_dÚe
 = 
dÚe
;

1209 ià(
cu¼’t_SC
->
u£_sg
) {

1210 
cu¼’t_SC
->
SCp
.
bufãr
 =

1211 (
sÿ‰”li¡
 *)
cu¼’t_SC
->
»que¡_bufãr
;

1212 
cu¼’t_SC
->
SCp
.
±r
 = cu¼’t_SC->SCp.
bufãr
->
add»ss
;

1213 
cu¼’t_SC
->
SCp
.
this_»sidu®
 = cu¼’t_SC->SCp.
bufãr
->
Ëngth
;

1214 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
 = cu¼’t_SC->
u£_sg
 - 1;

1216 
cu¼’t_SC
->
SCp
.
±r
 = (*)cu¼’t_SC->
»que¡_bufãr
;

1217 
cu¼’t_SC
->
SCp
.
this_»sidu®
 = cu¼’t_SC->
»que¡_bufæ’
;

1218 
cu¼’t_SC
->
SCp
.
bufãr
 = 
NULL
;

1219 
cu¼’t_SC
->
SCp
.
bufãrs_»sidu®
 = 0;

1223 
cu¼’t_SC
->
SCp
.
Stus
 = 0;

1224 
cu¼’t_SC
->
SCp
.
Mes§ge
 = 0;

1225 
cu¼’t_SC
->
SCp
.
have_d©a_š
 = 0;

1226 
cu¼’t_SC
->
SCp
.
£Á_commªd
 = 0;

1227 
cu¼’t_SC
->
SCp
.
pha£
 = 
š_¬b™¿tiÚ
;

1230 
	`outb
Ğ0x00, 
IÁ”ru±_CÁl_pÜt
 );

1231 
	`outb
Ğ0x00, 
SCSI_CÁl_pÜt
 );

1232 
	`outb
Ğ
ad­‹r_mask
, 
SCSI_D©a_NoACK_pÜt
 );

1233 ++
š_commªd
;

1234 
	`outb
Ğ0x20, 
IÁ”ru±_CÁl_pÜt
 );

1235 
	`outb
Ğ0x14 | 
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

1238 
	}
}

1244 vŞ©
	gš‹º®_dÚe_æag
 = 0;

1245 vŞ©
	gš‹º®_dÚe_”rcode
 = 0;

1247 
	$š‹º®_dÚe
Ğ
Scsi_Cmnd
 *
SC²t
 )

1249 
š‹º®_dÚe_”rcode
 = 
SC²t
->
»suÉ
;

1250 ++
š‹º®_dÚe_æag
;

1251 
	}
}

1253 
	$fdomaš_16x0_commªd
Ğ
Scsi_Cmnd
 *
SC²t
 )

1255 
	`fdomaš_16x0_queue
Ğ
SC²t
, 
š‹º®_dÚe
 );

1257 !
š‹º®_dÚe_æag
)

1259 
š‹º®_dÚe_æag
 = 0;

1260  
š‹º®_dÚe_”rcode
;

1261 
	}
}

1265 
	$´št_šfo
Ğ
Scsi_Cmnd
 *
SC²t
 )

1267 
imr
;

1268 
œr
;

1269 
i¤
;

1271 
	`´št_bªÃr
();

1272 
SC²t
->
SCp
.
pha£
) {

1273 
š_¬b™¿tiÚ
: 
	`´štk
( "arbitration " ); ;

1274 
š_£ËùiÚ
: 
	`´štk
( "selection " ); ;

1275 
š_Ùh”
: 
	`´štk
( "other " ); ;

1276 : 
	`´štk
( "unknown " ); ;

1279 
	`´štk
( "(%d),arget = %d cmnd = 0x%02x…ieces = %d size = %u\n",

1280 
SC²t
->
SCp
.
pha£
,

1281 
SC²t
->
rg‘
,

1282 *(*)
SC²t
->
cmnd
,

1283 
SC²t
->
u£_sg
,

1284 
SC²t
->
»que¡_bufæ’
 );

1285 
	`´štk
( "sent_command = %d, have_data_in = %d,imeout = %d\n",

1286 
SC²t
->
SCp
.
£Á_commªd
,

1287 
SC²t
->
SCp
.
have_d©a_š
,

1288 
SC²t
->
timeout
 );

1289 #ià
DEBUG_RACE


1290 
	`´štk
Ğ"š_š‹¼u±_æag = %d\n", 
š_š‹¼u±_æag
 );

1293 
imr
 = (
	`šb
( 0x0a1 ) << 8) + inb( 0x21 );

1294 
	`outb
( 0x0a, 0xa0 );

1295 
œr
 = 
	`šb
( 0xa0 ) << 8;

1296 
	`outb
( 0x0a, 0x20 );

1297 
œr
 +ğ
	`šb
( 0x20 );

1298 
	`outb
( 0x0b, 0xa0 );

1299 
i¤
 = 
	`šb
( 0xa0 ) << 8;

1300 
	`outb
( 0x0b, 0x20 );

1301 
i¤
 +ğ
	`šb
( 0x20 );

1304 
	`´štk
Ğ"IMR = 0x%04x", 
imr
 );

1305 ià(
imr
 & (1 << 
š‹¼u±_Ëv–
))

1306 
	`´štk
( " (masked)" );

1307 
	`´štk
Ğ", IRR = 0x%04x, ISR = 0x%04x\n", 
œr
, 
i¤
 );

1309 
	`´štk
Ğ"SCSI Stu  = 0x%02x\n", 
	`šb
Ğ
SCSI_Stus_pÜt
 ) );

1310 
	`´štk
Ğ"TMC Stu  = 0x%02x", 
	`šb
Ğ
TMC_Stus_pÜt
 ) );

1311 ià(
	`šb
Ğ
TMC_Stus_pÜt
 & 1))

1312 
	`´štk
( " (interrupt)" );

1313 
	`´štk
( "\n" );

1314 
	`´štk
Ğ"IÁ”ru± Stu ğ0x%02x", 
	`šb
Ğ
IÁ”ru±_Stus_pÜt
 ) );

1315 ià(
	`šb
Ğ
IÁ”ru±_Stus_pÜt
 ) & 0x08)

1316 
	`´štk
( " (enabled)" );

1317 
	`´štk
( "\n" );

1318 ià(
ch
 =ğ
tmc18c50
) {

1319 
	`´štk
Ğ"FIFO Stu  = 0x%02x\n", 
	`šb
Ğ
pÜt_ba£
 + 
FIFO_Stus
 ) );

1320 
	`´štk
( "Int. Condition = 0x%02x\n",

1321 
	`šb
Ğ
pÜt_ba£
 + 
IÁ”ru±_CÚd
 ) );

1323 
	`´štk
Ğ"CÚfigu¿tiÚ 1 = 0x%02x\n", 
	`šb
Ğ
pÜt_ba£
 + 
CÚfigu¿tiÚ1
 ) );

1324 ià(
ch
 =ğ
tmc18c50
)

1325 
	`´štk
( "Configuration 2 = 0x%02x\n",

1326 
	`šb
Ğ
pÜt_ba£
 + 
CÚfigu¿tiÚ2
 ) );

1327 
	}
}

1329 
	$fdomaš_16x0_abÜt
Ğ
Scsi_Cmnd
 *
SC²t
, 
code
 )

1332 #ià
EVERY_ACCESS
 || 
ERRORS_ONLY
 || 
DEBUG_ABORT


1333 
	`´štk
( "Future Domain: Abort " );

1336 
	`şi
();

1337 ià(!
š_commªd
) {

1338 #ià
EVERY_ACCESS
 || 
ERRORS_ONLY


1339 
	`´štk
( " (not in command)\n" );

1341 
	`¡i
();

1344 #ià
EVERY_ACCESS
 || 
ERRORS_ONLY


1345 
	`´štk
Ğ" codğ%d\n", 
code
 );

1349 #ià
DEBUG_ABORT


1350 
	`´št_šfo
Ğ
SC²t
 );

1353 
	`fdomaš_make_bus_idË
();

1355 
cu¼’t_SC
->
SCp
.
pha£
 |ğ
abÜ‹d
;

1357 
cu¼’t_SC
->
»suÉ
 = 
code
 ? cod: 
DID_ABORT
;

1359 
	`¡i
();

1362 
	`my_dÚe
Ğ
code
 << 16 );

1365 
	}
}

1367 
	$fdomaš_16x0_»£t
Ğ
Scsi_Cmnd
 *
SC²t
 )

1369 #ià
DEBUG_RESET


1370 
ÿÎed_Úû
 = 0;

1373 #ià
ERRORS_ONLY


1374 
	`´štk
( "Future Domain: SCSI Bus Reset\n" );

1377 #ià
DEBUG_RESET


1378 ià(
ÿÎed_Úû
è
	`´št_šfo
Ğ
cu¼’t_SC
 );

1379 
ÿÎed_Úû
 = 1;

1382 
	`outb
Ğ1, 
SCSI_CÁl_pÜt
 );

1383 
	`do_·u£
( 2 );

1384 
	`outb
Ğ0, 
SCSI_CÁl_pÜt
 );

1385 
	`do_·u£
( 115 );

1386 
	`outb
Ğ0, 
SCSI_Mode_CÁl_pÜt
 );

1387 
	`outb
Ğ
PARITY_MASK
, 
TMC_CÁl_pÜt
 );

1393 ià(
SC²t
)

1394 
SC²t
->
æags
 |ğ
NEEDS_JUMPSTART
;

1397 
	}
}

1399 
	$fdomaš_16x0_bio¥¬am
Ğ
size
, 
dev
, *
šfo_¬¿y
 )

1401 
drive
;

1402 
	sdrive_šfo
 {

1403 
cylšd”s
;

1404 
h—ds
;

1405 
£ùÜs
;

1406 } *
i
;

1440 
drive
 = 
	`MINOR
(
dev
) / 16;

1442 ià(
bios_majÜ
 == 2) {

1443 
i
 = (
drive_šfo
 *)Ğ(*)
bios_ba£
 + 0x1f31 + 
drive
 * 25 );

1444 
šfo_¬¿y
[0] = 
i
->
h—ds
;

1445 
šfo_¬¿y
[1] = 
i
->
£ùÜs
;

1446 
šfo_¬¿y
[2] = 
i
->
cylšd”s
;

1447 } ià(
bios_majÜ
 == 3) {

1448 
i
 = (
drive_šfo
 *)Ğ(*)
bios_ba£
 + 0x1f71 + 
drive
 * 10 );

1449 
šfo_¬¿y
[0] = 
i
->
h—ds
 + 1;

1450 
šfo_¬¿y
[1] = 
i
->
£ùÜs
;

1451 
šfo_¬¿y
[2] = 
i
->
cylšd”s
;

1456 
i
 = (
drive_šfo
 *)Ğ(*)
bios_ba£
 + 0x1f71 + 
drive
 * 10 );

1457 
šfo_¬¿y
[0] = 
i
->
h—ds
 + 1;

1458 
šfo_¬¿y
[1] = 
i
->
£ùÜs
;

1459 
šfo_¬¿y
[2] = 
i
->
cylšd”s
;

1461 ià(!
šfo_¬¿y
[0]

1462 || !
šfo_¬¿y
[1]

1463 || !
šfo_¬¿y
[2]

1464 || 
šfo_¬¿y
[2] > 1024

1472 
šfo_¬¿y
[0]

1473 ğ
šfo_¬¿y
[1]

1474 ğ
šfo_¬¿y
[2]

1480 
	}
}

	@drivers/scsi/fdomain.h

21 #iâdeà
_FDOMAIN_H


22 
	#_FDOMAIN_H


	)

24 
fdomaš_16x0_d‘eù
( );

25 
fdomaš_16x0_commªd
Ğ
Scsi_Cmnd
 * );

26 
fdomaš_16x0_abÜt
Ğ
Scsi_Cmnd
 *, );

27 cÚ¡ *
fdomaš_16x0_šfo
( );

28 
fdomaš_16x0_»£t
Ğ
Scsi_Cmnd
 * );

29 
fdomaš_16x0_queue
Ğ
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *) );

30 
	`fdomaš_16x0_bio¥¬am
( , , * );

32 
	#FDOMAIN_16X0
 { "Future Domain TMC-16x0", \

33 
fdomaš_16x0_d‘eù
, \

34 
fdomaš_16x0_šfo
, \

35 
fdomaš_16x0_commªd
, \

36 
fdomaš_16x0_queue
, \

37 
fdomaš_16x0_abÜt
, \

38 
fdomaš_16x0_»£t
, \

39 
NULL
, \

40 
fdomaš_16x0_bio¥¬am
, \

41 1, 6, 64 , 1 ,0, 0 
	}

	)
}

	@drivers/scsi/g_NCR5380.c

1 
	#AUTOSENSE


	)

58 
	~<lšux/cÚfig.h
>

59 #ià
defšed
(
CONFIG_SCSI_GENERIC_NCR5380
)

61 
	#AUTOPROBE_IRQ


	)

63 
	~<asm/sy¡em.h
>

64 
	~<asm/io.h
>

65 
	~<lšux/sigÇl.h
>

66 
	~<lšux/sched.h
>

67 
	~"../block/blk.h
"

68 
	~"scsi.h
"

69 
	~"ho¡s.h
"

70 
	~"g_NCR5380.h
"

71 
	~"NCR5380.h
"

72 
	~"cÚ¡ªts.h
"

74 
	sov”ride
 {

75 
	mpÜt
;

76 
	mœq
;

77 
	mdma
;

78 } 
	gov”rides


79 #ifdeà
GENERIC_NCR5380_OVERRIDE


80 [] = 
GENERIC_NCR5380_OVERRIDE


85 
	#NO_OVERRIDES
 ((
ov”rides
è/ (
ov”ride
))

	)

97 
	$g’”ic_NCR5380_£tup
(*
¡r
, *
šts
) {

98 
commªdlše_cu¼’t
 = 0;

99 ià(
šts
[0] != 2)

100 
	`´štk
("generic_NCR5380_setup : usage‚cr5380=port,irq,dma\n");

102 ià(
commªdlše_cu¼’t
 < 
NO_OVERRIDES
) {

103 
ov”rides
[
commªdlše_cu¼’t
].
pÜt
 = 
šts
[1];

104 
ov”rides
[
commªdlše_cu¼’t
].
œq
 = 
šts
[2];

105 
ov”rides
[
commªdlše_cu¼’t
].
dma
 = 
šts
[3];

106 ++
commªdlše_cu¼’t
;

108 
	}
}

110 
sigaùiÚ
 
	g§
 = { 
g’”ic_NCR5380_šŒ
, 0,

111 
SA_INTERRUPT
 , 
NULL
 };

125 
	$g’”ic_NCR5380_d‘eù
(
ho¡no
) {

126 
cu¼’t_ov”ride
 = 0;

127 
couÁ
;

128 
Scsi_Ho¡
 *
š¡ªû
;

130 
couÁ
 = 0; 
cu¼’t_ov”ride
 < 
NO_OVERRIDES
; ++current_override) {

131 ià(!(
ov”rides
[
cu¼’t_ov”ride
].
pÜt
))

134 
š¡ªû
 = 
	`scsi_»gi¡”
 (
ho¡no
, (
NCR5380_ho¡d©a
));

135 
š¡ªû
->
io_pÜt
 = 
ov”rides
[
cu¼’t_ov”ride
].
pÜt
;

137 
	`NCR5380_š™
(
š¡ªû
);

139 ià(
ov”rides
[
cu¼’t_ov”ride
].
œq
 !ğ
IRQ_AUTO
)

140 
š¡ªû
->
œq
 = 
ov”rides
[
cu¼’t_ov”ride
].irq;

142 
š¡ªû
->
œq
 = 
	`NCR5380_´obe_œq
(instance, 0xffff);

144 ià(
š¡ªû
->
œq
 !ğ
IRQ_NONE
)

145 ià(
	`œqaùiÚ
 (
š¡ªû
->
œq
, &
§
)) {

146 
	`´štk
("scsi%d : IRQ%d‚ot free, interrupts disabled\n",

147 
ho¡no
, 
š¡ªû
->
œq
);

148 
š¡ªû
->
œq
 = 
IRQ_NONE
;

151 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
) {

152 
	`´štk
("scsi%d : iÁ”ru± nÙƒÇbËd. fÜ b‘‹¸š‹¿ùiv³rfÜmªû,\n", 
ho¡no
);

153 
	`´štk
("scsi%d :…Ëa£ jum³¸thbßrd fÜ‡ f»IRQ.\n", 
ho¡no
);

156 
	`´štk
("scsi%d :‡ˆpÜˆ%d", 
š¡ªû
->
ho¡_no
, in¡ªû->
io_pÜt
);

157 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
)

158 
	`´štk
 (" interrupts disabled");

160 
	`´štk
 (" irq %d", 
š¡ªû
->
œq
);

161 
	`´štk
(" options CAN_QUEUE=%d CMD_PER_LUN=%d„elease=%d",

162 
CAN_QUEUE
, 
CMD_PER_LUN
, 
GENERIC_NCR5380_PUBLIC_RELEASE
);

163 
	`NCR5380_´št_İtiÚs
(
š¡ªû
);

164 
	`´štk
("\n");

166 ++
cu¼’t_ov”ride
;

167 ++
couÁ
;

169  
couÁ
;

170 
	}
}

172 cÚ¡ * 
	$g’”ic_NCR5380_šfo
 () {

173 cÚ¡ 
¡ršg
[]="";

174  
¡ršg
;

175 
	}
}

177 
	~"NCR5380.c
"

	@drivers/scsi/g_NCR5380.h

29 #iâdeà
GENERIC_NCR5380_H


30 
	#GENERIC_NCR5380_H


	)

32 
	#GENERIC_NCR5380_PUBLIC_RELEASE
 1

	)

35 #iâdeà
ASM


36 
g’”ic_NCR5380_abÜt
(
Scsi_Cmnd
 *, );

37 
g’”ic_NCR5380_d‘eù
();

38 cÚ¡ *
g’”ic_NCR5380_šfo
();

39 
g’”ic_NCR5380_queue_commªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

40 
	`g’”ic_NCR5380_»£t
(
Scsi_Cmnd
 *);

43 #iâdeà
NULL


44 
	#NULL
 0

	)

47 #iâdeà
CMD_PER_LUN


48 
	#CMD_PER_LUN
 2

	)

51 #iâdeà
CAN_QUEUE


52 
	#CAN_QUEUE
 16

	)

55 #ifdeà
HOSTS_C


57 
	#GENERIC_NCR5380
 {"Trantor T128/T128F/T228", \

58 
g’”ic_NCR5380_d‘eù
, 
g’”ic_NCR5380_šfo
, 
NULL
, \

59 
g’”ic_NCR5380_queue_commªd
, 
g’”ic_NCR5380_abÜt
, \

60 
g’”ic_NCR5380_»£t
, 
NULL
, \

61 
NULL
, 
CAN_QUEUE
, 7, 
SG_ALL
, \

62  
CMD_PER_LUN
 , 0, 0
	}

	)
}

65 
	#NCR5380_im¶em’tiÚ_f›lds
 \

66 
pÜt


	)

68 
	#NCR5380_loÿl_deş¬e
() \

69 
pÜt


	)

71 
	#NCR5380_£tup
(
š¡ªû
) \

72 
pÜt
 = (
š¡ªû
)->
io_pÜt


	)

74 
	#NCR5380_»ad
(
»g
è(
	`šb
(
pÜt
 + (»g)))

	)

75 
	#NCR5380_wr™e
(
»g
, 
v®ue
è(
	`outb
((v®ue), (
pÜt
 + (»g))))

	)

77 
	#NCR5380_šŒ
 
g’”ic_NCR5380_šŒ


	)

78 
	#NCR5380_queue_commªd
 
g’”ic_NCR5380_queue_commªd


	)

79 
	#NCR5380_abÜt
 
g’”ic_NCR5380_abÜt


	)

80 
	#NCR5380_»£t
 
g’”ic_NCR5380_»£t


	)

	@drivers/scsi/hosts.c

16 
	~<lšux/cÚfig.h
>

17 
	~"../block/blk.h
"

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~"scsi.h
"

22 #iâdeà
NULL


23 
	#NULL
 0L

	)

26 
	#HOSTS_C


	)

28 
	~"ho¡s.h
"

30 #ifdeà
CONFIG_SCSI_AHA152X


31 
	~"aha152x.h
"

34 #ifdeà
CONFIG_SCSI_AHA1542


35 
	~"aha1542.h
"

38 #ifdeà
CONFIG_SCSI_AHA1740


39 
	~"aha1740.h
"

42 #ifdeà
CONFIG_SCSI_FUTURE_DOMAIN


43 
	~"fdomaš.h
"

46 #ifdeà
CONFIG_SCSI_GENERIC_NCR5380


47 
	~"g_NCR5380.h
"

50 #ifdeà
CONFIG_SCSI_PAS16


51 
	~"·s16.h
"

54 #ifdeà
CONFIG_SCSI_SEAGATE


55 
	~"£ag©e.h
"

58 #ifdeà
CONFIG_SCSI_T128


59 
	~"t128.h
"

62 #ifdeà
CONFIG_SCSI_ULTRASTOR


63 
	~"uÉ¿¡Ü.h
"

66 #ifdeà
CONFIG_SCSI_7000FASST


67 
	~"wd7000.h
"

70 #ifdeà
CONFIG_SCSI_DEBUG


71 
	~"scsi_debug.h
"

93 
	#NO_CONTROLLER
 {
NULL
, NULL, NULL, NULL, NULL, NULL, NULL, \

94 
NULL
, NULL, 0, 0, 0, 0, 0, 0}

	)

103 
Scsi_Ho¡_Tem¶©e
 
	gscsi_ho¡s
[] =

105 #ifdeà
CONFIG_SCSI_AHA152X


106 
AHA152X
,

108 #ifdeà
CONFIG_SCSI_AHA1542


109 
AHA1542
,

111 #ifdeà
CONFIG_SCSI_AHA1740


112 
AHA1740
,

114 #ifdeà
CONFIG_SCSI_FUTURE_DOMAIN


115 
FDOMAIN_16X0
,

117 #ifdeà
CONFIG_SCSI_GENERIC_NCR5380


118 
GENERIC_NCR5380
,

120 #ifdeà
CONFIG_SCSI_PAS16


121 
MV_PAS16
,

123 #ifdeà
CONFIG_SCSI_SEAGATE


124 
SEAGATE_ST0X
,

126 #ifdeà
CONFIG_SCSI_T128


127 
TRANTOR_T128
,

129 #ifdeà
CONFIG_SCSI_ULTRASTOR


130 
ULTRASTOR_14F
,

132 #ifdeà
CONFIG_SCSI_7000FASST


133 
WD7000
,

135 #ifdeà
CONFIG_SCSI_DEBUG


136 
SCSI_DEBUG
,

140 
	#MAX_SCSI_HOSTS
 ((
scsi_ho¡s
è/ (
Scsi_Ho¡_Tem¶©e
))

	)

146 
Scsi_Ho¡
 * 
	gscsi_ho¡li¡
 = 
NULL
;

148 
	gscsi_š™_memÜy_¡¬t
 = 0;

150 
	gmax_scsi_ho¡s
 = 0;

151 
	gÃxt_ho¡
 = 0;

154 
	$scsi_uÄegi¡”
(
Scsi_Ho¡
 * 
sh
, 
j
){

155 
Scsi_Ho¡
 * 
sh²t
;

157 if(((è
sh
è+ (
Scsi_Ho¡
è+ 
j
 !ğ
scsi_š™_memÜy_¡¬t
)

158 
	`·nic
("Unableo unregister scsi host");

159 if(
scsi_ho¡li¡
 =ğ
sh
)

160 
scsi_ho¡li¡
 = 
NULL
;

162 
sh²t
 = 
scsi_ho¡li¡
;

163 
sh²t
->
Ãxt
 !ğ
sh
) shpnt = shpnt->next;

164 
sh²t
->
Ãxt
 = shpnt->next->next;

167 
Ãxt_ho¡
--;

168 
scsi_š™_memÜy_¡¬t
 = (è
sh
;

169 
	}
}

175 
Scsi_Ho¡
 * 
	$scsi_»gi¡”
(
i
, 
j
){

176 
Scsi_Ho¡
 * 
»tv®
, *
sh²t
;

177 
»tv®
 = (
Scsi_Ho¡
*è
scsi_š™_memÜy_¡¬t
;

178 
scsi_š™_memÜy_¡¬t
 +ğ(
Scsi_Ho¡
è+ 
j
;

179 
»tv®
->
ho¡_busy
 = 0;

180 
»tv®
->
ho¡_no
 = 
Ãxt_ho¡
++;

181 
»tv®
->
ho¡_queue
 = 
NULL
;

182 
»tv®
->
ho¡_wa™
 = 
NULL
;

183 
»tv®
->
Ï¡_»£t
 = 0;

184 
»tv®
->
ho¡t
 = &
scsi_ho¡s
[
i
];

185 
»tv®
->
Ãxt
 = 
NULL
;

186 #ifdeà
DEBUG


187 
	`´štk
("Regi¡” %x %x: %d %d\n", 
»tv®
,„‘v®->
ho¡t
, 
i
, 
j
);

192 
»tv®
->
this_id
 = 
scsi_ho¡s
[
i
].this_id;

193 
»tv®
->
sg_bËsize
 = 
scsi_ho¡s
[
i
].sg_tablesize;

194 
»tv®
->
unchecked_i§_dma
 = 
scsi_ho¡s
[
i
].unchecked_isa_dma;

196 if(!
scsi_ho¡li¡
)

197 
scsi_ho¡li¡
 = 
»tv®
;

200 
sh²t
 = 
scsi_ho¡li¡
;

201 
sh²t
->
Ãxt
) shpnt = shpnt->next;

202 
sh²t
->
Ãxt
 = 
»tv®
;

205  
»tv®
;

206 
	}
}

209 
	$scsi_š™
(
memÜy_¡¬t
,
memÜy_’d
)

211 
ÿÎed
 = 0;

212 
i
, 
j
, 
couÁ
, 
pcouÁ
;

214 
couÁ
 = 0;

216 if(
ÿÎed
è 
memÜy_¡¬t
;

218 
scsi_š™_memÜy_¡¬t
 = 
memÜy_¡¬t
;

219 
ÿÎed
 = 1;

220 
i
 = 0; i < 
MAX_SCSI_HOSTS
; ++i)

227 
pcouÁ
 = 
Ãxt_ho¡
;

228 ià((
scsi_ho¡s
[
i
].
d‘eù
) &&

229 (
scsi_ho¡s
[
i
].
´e£Á
 =

230 
scsi_ho¡s
[
i
].
	`d‘eù
(i)))

234 if(
pcouÁ
 =ğ
Ãxt_ho¡
) {

235 if(
scsi_ho¡s
[
i
].
´e£Á
 > 1)

236 
	`·nic
("Failureo„egister†ow-level scsi driver");

239 
	`scsi_»gi¡”
(
i
,0);

241 
j
 = 0; j < 
scsi_ho¡s
[
i
].
´e£Á
; j++)

242 
	`´štk
 ("scsi%d : %s\n",

243 
couÁ
++, 
scsi_ho¡s
[
i
].
Çme
);

246 
	`´štk
 ("scs˜: %d ho¡s.\n", 
couÁ
);

248 
max_scsi_ho¡s
 = 
couÁ
;

249  
scsi_š™_memÜy_¡¬t
;

250 
	}
}

252 #iâdeà
CONFIG_BLK_DEV_SD


253 
	$sd_š™
(
memÜy_¡¬t
, 
memÜy_’d
){

254  
memÜy_¡¬t
;

255 
	}
};

256 
	$sd_š™1
(
memÜy_¡¬t
, 
memÜy_’d
){

257  
memÜy_¡¬t
;

258 
	}
};

259 
	$sd_©ch
(
Scsi_Deviû
 * 
SDp
){

260 
	}
};

261 
	gNR_SD
=-1;

262 
	gMAX_SD
=0;

266 #iâdeà
CONFIG_BLK_DEV_SR


267 
	$¤_š™
(
memÜy_¡¬t
, 
memÜy_’d
){

268  
memÜy_¡¬t
;

269 
	}
};

270 
	$¤_š™1
(
memÜy_¡¬t
, 
memÜy_’d
){

271  
memÜy_¡¬t
;

272 
	}
};

273 
	$¤_©ch
(
Scsi_Deviû
 * 
SDp
){

274 
	}
};

275 
	gNR_SR
=-1;

276 
	gMAX_SR
=0;

280 #iâdeà
CONFIG_CHR_DEV_ST


281 
	$¡_š™
(
memÜy_¡¬t
, 
memÜy_’d
){

282  
memÜy_¡¬t
;

283 
	}
};

284 
	$¡_š™1
(
memÜy_¡¬t
, 
memÜy_’d
){

285  
memÜy_¡¬t
;

286 
	}
};

287 
	$¡_©ch
(
Scsi_Deviû
 * 
SDp
){

288 
	}
};

289 
	gNR_ST
=-1;

290 
	gMAX_ST
=0;

293 #iâdeà
CONFIG_CHR_DEV_SG


294 
	$sg_š™
(
memÜy_¡¬t
, 
memÜy_’d
){

295  
memÜy_¡¬t
;

296 
	}
};

297 
	$sg_š™1
(
memÜy_¡¬t
, 
memÜy_’d
){

298  
memÜy_¡¬t
;

299 
	}
};

300 
	$sg_©ch
(
Scsi_Deviû
 * 
SDp
){

301 
	}
};

302 
	gNR_SG
=-1;

303 
	gMAX_SG
=0;

	@drivers/scsi/hosts.h

16 #iâdeà
_HOSTS_H


17 
	#_HOSTS_H


	)

30 
	#NEEDS_JUMPSTART
 0x20

	)

32 
	#SG_NONE
 0

	)

33 
	#SG_ALL
 0xff

	)

57 *
	mÇme
;

75 (* 
	md‘eù
)();

82 cÚ¡ *(* 
	mšfo
)();

96 (* 
	mcommªd
)(
	mScsi_Cmnd
 *);

107 (* 
	mqueuecommªd
)(
	mScsi_Cmnd
 *, (*
	mdÚe
)(Scsi_Cmnd *));

120 (* 
	mabÜt
)(
	mScsi_Cmnd
 *, );

133 (* 
	m»£t
)(
	mScsi_Cmnd
 *);

140 (* 
	m¦ave_©ch
)(, );

148 (* 
	mbios_·¿m
)(, , []);

155 
	mÿn_queue
;

165 
	mthis_id
;

172 
	msg_bËsize
;

184 
	mcmd_³r_lun
;

190 
	m´e£Á
;

194 
	munchecked_i§_dma
:1;

195 } 
	tScsi_Ho¡_Tem¶©e
;

206 
	sScsi_Ho¡


208 
Scsi_Ho¡
 * 
	mÃxt
;

209 vŞ©
	mho¡_busy
;

210 
	mho¡_no
;

211 
	mÏ¡_»£t
;

212 
wa™_queue
 *
	mho¡_wa™
;

213 
Scsi_Cmnd
 *
	mho¡_queue
;

214 
Scsi_Ho¡_Tem¶©e
 * 
	mho¡t
;

217 *
	mba£
;

218 
	mio_pÜt
;

219 
	mœq
;

220 
	mdma_chªÃl
;

226 
	mthis_id
;

227 
	msg_bËsize
;

228 
	munchecked_i§_dma
:1;

229 
	mho¡d©a
[0];

232 
Scsi_Ho¡
 * 
scsi_ho¡li¡
;

234 
Scsi_Ho¡_Tem¶©e
 
scsi_ho¡s
[];

241 
scsi_š™
(
memÜy_¡¬t
,
memÜy_’d
);

242 
Scsi_Ho¡
 * 
scsi_»gi¡”
(
i
, 
j
);

243 
scsi_uÄegi¡”
(
Scsi_Ho¡
 * 
i
, 
j
);

245 
	#BLANK_HOST
 {"", 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}

	)

	@drivers/scsi/pas16.c

1 
	#AUTOSENSE


	)

2 
	#PSEUDO_DMA


	)

83 
	~<asm/sy¡em.h
>

84 
	~<lšux/sigÇl.h
>

85 
	~<lšux/sched.h
>

86 
	~<asm/io.h
>

87 
	~"../block/blk.h
"

88 
	~"scsi.h
"

89 
	~"ho¡s.h
"

90 
	~"·s16.h
"

91 
	#AUTOPROBE_IRQ


	)

92 
	~"NCR5380.h
"

93 
	~"cÚ¡ªts.h
"

97 
	gscsi_œq_Œª¦©e
[] =

105 
	gdeçuÉ_œqs
[] = { 
PAS16_DEFAULT_BOARD_1_IRQ
,

106 
PAS16_DEFAULT_BOARD_2_IRQ
,

107 
PAS16_DEFAULT_BOARD_3_IRQ
,

108 
PAS16_DEFAULT_BOARD_4_IRQ


111 
	sov”ride
 {

112 
	mio_pÜt
;

113 
	mœq
;

114 } 
	gov”rides


115 #ifdeà
PAS16_OVERRIDE


116 [] = 
PAS16_OVERRIDE
;

118 [4] = {{0,
IRQ_AUTO
}, {0,IRQ_AUTO}, {0,IRQ_AUTO},

119 {0,
IRQ_AUTO
}};

122 
	#NO_OVERRIDES
 ((
ov”rides
è/ (
ov”ride
))

	)

124 
	sba£
 {

125 
	mio_pÜt
;

126 
	mnßuto
;

127 } 
	gba£s
[] = { {
PAS16_DEFAULT_BASE_1
, 0},

128 {
PAS16_DEFAULT_BASE_2
, 0},

129 {
PAS16_DEFAULT_BASE_3
, 0},

130 {
PAS16_DEFAULT_BASE_4
, 0}

133 
	#NO_BASES
 ( (
ba£s
è/  (
ba£
))

	)

135 
	g·s16_off£t
[ 8 ] =

162 
	$’abË_bßrd
Ğ
bßrd_num
, 
pÜt
 )

164 
	`outb
Ğ0xbø+ 
bßrd_num
, 
MASTER_ADDRESS_PTR
 );

165 
	`outb
Ğ
pÜt
 >> 2, 
MASTER_ADDRESS_PTR
 );

166 
	}
}

180 
	$š™_bßrd
Ğ
io_pÜt
, 
œq
 )

182 
tmp
;

186 
	`outb
Ğ0x30, 
io_pÜt
 + 
P_TIMEOUT_COUNTER_REG
 );

187 
	`outb
Ğ0x01, 
io_pÜt
 + 
P_TIMEOUT_STATUS_REG_OFFSET
 );

188 
	`outb
Ğ0x01, 
io_pÜt
 + 
WAIT_STATE
 );

190 
	`NCR5380_»ad
Ğ
RESET_PARITY_INTERRUPT_REG
 );

195 
tmp
 = 
	`šb
Ğ
io_pÜt
 + 
IO_CONFIG_3
 );

196 
tmp
 = (m°& 0x0àè| ( 
scsi_œq_Œª¦©e
[
œq
] << 4 );

197 
	`outb
Ğ
tmp
, 
io_pÜt
 + 
IO_CONFIG_3
 );

200 
	`outb
Ğ0x6d, 
io_pÜt
 + 
SYS_CONFIG_4
 );

201 
	}
}

214 
	$·s16_hw_d‘eù
Ğ
bßrd_num
 )

216 
bßrd_»v
, 
tmp
;

217 
pÜt
 = 
ba£s
[ 
bßrd_num
 ].
io_pÜt
;

226 
	`’abË_bßrd
Ğ
bßrd_num
, 
pÜt
 );

229 
bßrd_»v
 = 
	`šb
Ğ
pÜt
 + 
PCB_CONFIG
 );

231 ifĞ
bßrd_»v
 == 0xff )

234 
tmp
 = 
bßrd_»v
 ^ 0xe0;

236 
	`outb
Ğ
tmp
, 
pÜt
 + 
PCB_CONFIG
 );

237 
tmp
 = 
	`šb
Ğ
pÜt
 + 
PCB_CONFIG
 );

238 
	`outb
Ğ
bßrd_»v
, 
pÜt
 + 
PCB_CONFIG
 );

240 ifĞ
bßrd_»v
 !ğ
tmp
 )

243 ifĞĞ
	`šb
Ğ
pÜt
 + 
OPERATION_MODE_1
 ) & 0x03 ) != 0x03 )

247 
	}
}

260 
	$·s16_£tup
(*
¡r
, *
šts
) {

261 
commªdlše_cu¼’t
 = 0;

262 
i
;

263 ià(
šts
[0] != 2)

264 
	`´štk
("pas16_setup : usage…as16=io_port,irq\n");

266 ià(
commªdlše_cu¼’t
 < 
NO_OVERRIDES
) {

267 
ov”rides
[
commªdlše_cu¼’t
].
io_pÜt
 = (è
šts
[1];

268 
ov”rides
[
commªdlše_cu¼’t
].
œq
 = 
šts
[2];

269 
i
 = 0; i < 
NO_BASES
; ++i)

270 ià(
ba£s
[
i
].
io_pÜt
 =ğ(è
šts
[1]) {

271 
ba£s
[
i
].
nßuto
 = 1;

274 ++
commªdlše_cu¼’t
;

276 
	}
}

278 
sigaùiÚ
 
	g·s16_sigaùiÚ
 = { 
·s16_šŒ
, 0, 
SA_INTERRUPT
 , 
NULL
 };

293 
	$·s16_d‘eù
(
ho¡no
) {

294 
cu¼’t_ov”ride
 = 0;

295 
cu¼’t_ba£
 = 0;

296 
Scsi_Ho¡
 *
š¡ªû
;

297 
io_pÜt
;

298 
couÁ
;

300 
couÁ
 = 0; 
cu¼’t_ov”ride
 < 
NO_OVERRIDES
; ++current_override) {

301 
io_pÜt
 = 0;

303 ià(
ov”rides
[
cu¼’t_ov”ride
].
io_pÜt
)

305 
io_pÜt
 = 
ov”rides
[
cu¼’t_ov”ride
].io_port;

306 
	`’abË_bßrd
Ğ
cu¼’t_ov”ride
, 
io_pÜt
 );

307 
	`š™_bßrd
Ğ
io_pÜt
, 
ov”rides
[
cu¼’t_ov”ride
].
œq
 );

310 ; !
io_pÜt
 && (
cu¼’t_ba£
 < 
NO_BASES
); ++current_base) {

311 #ià(
PDEBUG
 & 
PDEBUG_INIT
)

312 
	`´štk
("scsi%d :…robšg io_pÜˆ%04x\n", 
ho¡no
, (è
ba£s
[
cu¼’t_ba£
].
io_pÜt
);

314 iàĞ!
ba£s
[
cu¼’t_ba£
].
nßuto
 &&

315 
	`·s16_hw_d‘eù
Ğ
cu¼’t_ba£
 ) ){

316 
io_pÜt
 = 
ba£s
[
cu¼’t_ba£
].io_port;

317 
	`š™_bßrd
Ğ
io_pÜt
, 
deçuÉ_œqs
[ 
cu¼’t_ba£
 ] );

318 #ià(
PDEBUG
 & 
PDEBUG_INIT
)

319 
	`´štk
("scsi%d : d‘eùed bßrd.\n", 
ho¡no
);

325 #ià
	`defšed
(
PDEBUG
è&& (PDEBUG & 
PDEBUG_INIT
)

326 
	`´štk
("scsi%d : io_pÜˆğ%04x\n", 
ho¡no
, (è
io_pÜt
);

329 ià(!
io_pÜt
)

332 
š¡ªû
 = 
	`scsi_»gi¡”
 (
ho¡no
, (
NCR5380_ho¡d©a
));

333 
š¡ªû
->
io_pÜt
 = io_port;

335 
	`NCR5380_š™
(
š¡ªû
);

337 ià(
ov”rides
[
cu¼’t_ov”ride
].
œq
 !ğ
IRQ_AUTO
)

338 
š¡ªû
->
œq
 = 
ov”rides
[
cu¼’t_ov”ride
].irq;

340 
š¡ªû
->
œq
 = 
	`NCR5380_´obe_œq
(š¡ªû, 
PAS16_IRQS
);

342 ià(
š¡ªû
->
œq
 !ğ
IRQ_NONE
)

343 ià(
	`œqaùiÚ
 (
š¡ªû
->
œq
, &
·s16_sigaùiÚ
)) {

344 
	`´štk
("scsi%d : IRQ%d‚ot free, interrupts disabled\n",

345 
ho¡no
, 
š¡ªû
->
œq
);

346 
š¡ªû
->
œq
 = 
IRQ_NONE
;

349 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
) {

350 
	`´štk
("scsi%d : iÁ”ru± nÙƒÇbËd. fÜ b‘‹¸š‹¿ùiv³rfÜmªû,\n", 
ho¡no
);

351 
	`´štk
("scsi%d :…Ëa£ jum³¸thbßrd fÜ‡ f»IRQ.\n", 
ho¡no
);

354 #ià
	`defšed
(
PDEBUG
è&& (PDEBUG & 
PDEBUG_INIT
)

355 
	`´štk
("scsi%d : irq = %d\n", 
ho¡no
, 
š¡ªû
->
œq
);

358 
	`´štk
("scsi%d :‡ˆ0x%04x", 
š¡ªû
->
ho¡_no
, ()

359 
š¡ªû
->
io_pÜt
);

360 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
)

361 
	`´štk
 (" interrupts disabled");

363 
	`´štk
 (" irq %d", 
š¡ªû
->
œq
);

364 
	`´štk
(" options CAN_QUEUE=%d CMD_PER_LUN=%d„elease=%d",

365 
CAN_QUEUE
, 
CMD_PER_LUN
, 
PAS16_PUBLIC_RELEASE
);

366 
	`NCR5380_´št_İtiÚs
(
š¡ªû
);

367 
	`´štk
("\n");

369 ++
cu¼’t_ov”ride
;

370 ++
couÁ
;

371 ++
ho¡no
;

373  
couÁ
;

374 
	}
}

396 
	$·s16_bio¥¬am
(
size
, 
dev
, * 

)

398 

[0] = 64;

399 

[1] = 32;

400 

[2] = 
size
 >> 11;

402 
	}
}

417 
šlše
 
	$NCR5380_´—d
 (
Scsi_Ho¡
 *
š¡ªû
, *
d¡
,

418 
Ën
) {

419 *
d
 = 
d¡
;

420 
»g
 = (è(
š¡ªû
->
io_pÜt
 +

421 
P_DATA_REG_OFFSET
);

422 
i
 = 
Ën
;

424  
	`šb
(
š¡ªû
->
io_pÜt
 + 
P_STATUS_REG_OFFSET
è& 
P_ST_RDY
 );

426 ; 
i
; --i)

427 *
d
++ = (è
	`šb
(
»g
);

429 iàĞ
	`šb
(
š¡ªû
->
io_pÜt
 + 
P_TIMEOUT_STATUS_REG_OFFSET
è& 
P_TS_TIM
) {

430 
	`outb
Ğ
P_TS_CT
, 
š¡ªû
->
io_pÜt
 + 
P_TIMEOUT_STATUS_REG_OFFSET
);

431 
	`´štk
("scsi%d : watchdogimer fired in NCR5480_pread()\n",

432 
š¡ªû
->
ho¡_no
);

436 
	}
}

451 
šlše
 
	$NCR5380_pwr™e
 (
Scsi_Ho¡
 *
š¡ªû
, *
¤c
,

452 
Ën
) {

453 *
s
 = 
¤c
;

454 
»g
 = (
š¡ªû
->
io_pÜt
 + 
P_DATA_REG_OFFSET
);

455 
i
 = 
Ën
;

457  ( 
	`šb
Ğ
š¡ªû
->
io_pÜt
 + 
P_STATUS_REG_OFFSET
 ) ) & 
P_ST_RDY
 );

458 ; 
i
; --i)

459 
	`outb
Ğ*
s
++, 
»g
 );

461 ià(
	`šb
(
š¡ªû
->
io_pÜt
 + 
P_TIMEOUT_STATUS_REG_OFFSET
è& 
P_TS_TIM
) {

462 
	`outb
Ğ
P_TS_CT
, 
š¡ªû
->
io_pÜt
 + 
P_TIMEOUT_STATUS_REG_OFFSET
);

463 
	`´štk
("scsi%d : watchdogimer fired in NCR5480_pwrite()\n",

464 
š¡ªû
->
ho¡_no
);

468 
	}
}

478 cÚ¡ *
	$·s16_šfo
 () {

479 cÚ¡ 
¡ršg
[]="";

480  
¡ršg
;

481 
	}
}

483 
	~"NCR5380.c
"

	@drivers/scsi/pas16.h

36 #iâdeà
PAS16_H


37 
	#PAS16_H


	)

39 
	#PAS16_PUBLIC_RELEASE
 1

	)

41 
	#PDEBUG_INIT
 0x1

	)

42 
	#PDEBUG_TRANSFER
 0x2

	)

44 
	#PAS16_DEFAULT_BASE_1
 0x388

	)

45 
	#PAS16_DEFAULT_BASE_2
 0x384

	)

46 
	#PAS16_DEFAULT_BASE_3
 0x38c

	)

47 
	#PAS16_DEFAULT_BASE_4
 0x288

	)

49 
	#PAS16_DEFAULT_BOARD_1_IRQ
 10

	)

50 
	#PAS16_DEFAULT_BOARD_2_IRQ
 12

	)

51 
	#PAS16_DEFAULT_BOARD_3_IRQ
 14

	)

52 
	#PAS16_DEFAULT_BOARD_4_IRQ
 15

	)

71 
	#P_TIMEOUT_COUNTER_REG
 0x4000

	)

72 
	#P_TC_DISABLE
 0x80

	)

76 
	#P_TIMEOUT_STATUS_REG_OFFSET
 0x4001

	)

77 
	#P_TS_TIM
 0x80

	)

79 
	#P_TS_ARM_DRQ_INT
 0x08

	)

87 
	#P_TS_ENABLE_TO_ERR_INTERRUPT


	)

88 
	#P_TS_ENABLE_WAIT


	)

90 
	#P_TS_CT
 0x01

	)

100 
	#P_DATA_REG_OFFSET
 0x5c00

	)

102 
	#P_STATUS_REG_OFFSET
 0x5c01

	)

103 
	#P_ST_RDY
 0x80

	)

105 
	#P_IRQ_STATUS
 0x5c03

	)

106 
	#P_IS_IRQ
 0x80

	)

108 
	#PCB_CONFIG
 0x803

	)

109 
	#MASTER_ADDRESS_PTR
 0x9a01

	)

110 
	#SYS_CONFIG_4
 0x8003

	)

111 
	#WAIT_STATE
 0xbc00

	)

112 
	#OPERATION_MODE_1
 0xec03

	)

113 
	#IO_CONFIG_3
 0xf002

	)

116 #iâdeà
ASM


117 
·s16_abÜt
(
Scsi_Cmnd
 *, );

118 
·s16_bio¥¬am
(, , *);

119 
·s16_d‘eù
();

120 cÚ¡ *
·s16_šfo
();

121 
·s16_queue_commªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

122 
	`·s16_»£t
(
Scsi_Cmnd
 *);

124 #iâdeà
NULL


125 
	#NULL
 0

	)

128 #iâdeà
CMD_PER_LUN


129 
	#CMD_PER_LUN
 2

	)

132 #iâdeà
CAN_QUEUE


133 
	#CAN_QUEUE
 32

	)

142 #ifdeà
HOSTS_C


144 
	#MV_PAS16
 {"PrØAudiØS³ùrum-16 SCSI", 
·s16_d‘eù
, 
·s16_šfo
,\

145 
NULL
, 
·s16_queue_commªd
, 
·s16_abÜt
, 
·s16_»£t
, NULL, \

146 
·s16_bio¥¬am
, \

147  
CAN_QUEUE
, 7, 
SG_ALL
, \

148  
CMD_PER_LUN
 , 0, 0
	}

	)
}

152 
	#NCR5380_im¶em’tiÚ_f›lds
 \

153 vŞ©
io_pÜt


	)

155 
	#NCR5380_loÿl_deş¬e
() \

156 vŞ©
io_pÜt


	)

158 
	#NCR5380_£tup
(
š¡ªû
) \

159 
io_pÜt
 = (
š¡ªû
)->
	)
io_port

161 
	#PAS16_io_pÜt
(
»g
èĞ
io_pÜt
 + 
·s16_off£t
[Ôeg)] )

	)

163 #ià!(
PDEBUG
 & 
PDEBUG_TRANSFER
)

164 
	#NCR5380_»ad
(
»g
èĞ
	`šb
(
	`PAS16_io_pÜt
Ôeg)è)

	)

165 
	#NCR5380_wr™e
(
»g
, 
v®ue
èĞ
	`outb
((v®ue),
	`PAS16_io_pÜt
Ôeg)è)

	)

167 
	#NCR5380_»ad
(
»g
) \

168 (((è
	`´štk
("scsi%d :„ead„egister %d‡t io_port %04x\n"\

169 , 
š¡ªû
->
ho¡no
, (
»g
), 
	`PAS16_io_pÜt
Ôeg))), 
	`šb
ĞPAS16_io_pÜtÔeg)è)

	)

171 
	#NCR5380_wr™e
(
»g
, 
v®ue
) \

172 (
	`´štk
("scsi%d : write %02xo„egister %d‡t io_port %04x\n", \

173 
š¡ªû
->
ho¡no
, (
v®ue
), (
»g
), 
	`PAS16_io_pÜt
(reg)), \

174 
	`outb
Ğ(
v®ue
),
	`PAS16_io_pÜt
(
»g
èè)

	)

179 
	#NCR5380_šŒ
 
·s16_šŒ


	)

180 
	#NCR5380_queue_commªd
 
·s16_queue_commªd


	)

181 
	#NCR5380_abÜt
 
·s16_abÜt


	)

182 
	#NCR5380_»£t
 
·s16_»£t


	)

187 
	#PAS16_IRQS
 0xd4a8

	)

	@drivers/scsi/scsi.c

18 
	~<asm/sy¡em.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/tim”.h
>

21 
	~<lšux/¡ršg.h
>

23 
	~"../block/blk.h
"

24 
	~"scsi.h
"

25 
	~"ho¡s.h
"

26 
	~"cÚ¡ªts.h
"

33 cÚ¡ 
	gscsi_commªd_size
[8] = { 6, 10, 10, 12, 12, 12, 10, 10 };

35 
	#INTERNAL_ERROR
 (
	`·nic
 ("IÁ”ÇÈ”rÜ iÀf%s,†š%d.\n", 
__FILE__
, 
__LINE__
))

	)

37 
scsi_dÚe
 (
Scsi_Cmnd
 *
SC²t
);

38 
upd©e_timeout
 (
Scsi_Cmnd
 *, );

39 
´št_šquœy
(*
d©a
);

40 
scsi_times_out
 (
Scsi_Cmnd
 * 
SC²t
);

42 
	gtime_¡¬t
;

43 
	gtime_–­£d
;

45 
	#MAX_SCSI_DEVICE_CODE
 10

	)

46 cÚ¡ *cÚ¡ 
	gscsi_deviû_ty³s
[
MAX_SCSI_DEVICE_CODE
] =

68 
	gNR_SCSI_DEVICES
=0;

70 
Scsi_Deviû
 * 
	gscsi_deviûs
 = 
NULL
;

72 
	gg’”ic_£n£
[6] = {
REQUEST_SENSE
, 0,0,0, 255, 0};

75  
Scsi_Cmnd
 * 
	gÏ¡_cmnd
 = 
NULL
;

83 
	#WAS_RESET
 0x01

	)

84 
	#WAS_TIMEDOUT
 0x02

	)

85 
	#WAS_SENSE
 0x04

	)

86 
	#IS_RESETTING
 0x08

	)

87 
	#ASKED_FOR_SENSE
 0x10

	)

100 #ifdeà
DEBUG


101 
	#SCSI_TIMEOUT
 500

	)

103 
	#SCSI_TIMEOUT
 100

	)

106 #ifdeà
DEBUG


107 
	#SENSE_TIMEOUT
 
SCSI_TIMEOUT


	)

108 
	#ABORT_TIMEOUT
 
SCSI_TIMEOUT


	)

109 
	#RESET_TIMEOUT
 
SCSI_TIMEOUT


	)

111 
	#SENSE_TIMEOUT
 50

	)

112 
	#RESET_TIMEOUT
 50

	)

113 
	#ABORT_TIMEOUT
 50

	)

114 
	#MIN_RESET_DELAY
 100

	)

121 
	sbli¡
{

122 * 
	mv’dÜ
;

123 * 
	mmod–
;

124 * 
	m»visiÚ
;

127 
bli¡
 
	gbÏckli¡
[] =

147 {
NULL
, NULL, NULL}};

149 
	$bÏckli¡ed
(* 
»¥Ú£_d©a
){

150 
i
 = 0;

151 * 
²t
;

152 
i
=0; 1; i++){

153 if(
bÏckli¡
[
i
].
v’dÜ
 =ğ
NULL
)  0;

154 
²t
 = &
»¥Ú£_d©a
[8];

155 *
²t
 && *pnt == ' ')…nt++;

156 if(
	`memcmp
(
bÏckli¡
[
i
].
v’dÜ
, 
²t
,

157 
	`¡¾’
(
bÏckli¡
[
i
].
v’dÜ
))) ;

158 
²t
 = &
»¥Ú£_d©a
[16];

159 *
²t
 && *pnt == ' ')…nt++;

160 if(
	`memcmp
(
bÏckli¡
[
i
].
mod–
, 
²t
,

161 
	`¡¾’
(
bÏckli¡
[
i
].
mod–
))) ;

164 
	}
};

175 vŞ©
	gš_sÿn
 = 0;

176 
	gthe_»suÉ
;

177 
	$sÿn_scsis_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

180 #ifdeà
DEBUG


181 
	`´štk
 ("sÿn_scsis_dÚe(%d, %06x)\n", 
SC²t
->
ho¡
, SC²t->
»suÉ
);

183 
SC²t
->
»que¡
.
dev
 = 0xfffe;

184 
	}
}

193 
	$sÿn_scsis
 ()

195 
dev
, 
lun
, 
ty³
;

196 
scsi_cmd
 [12];

197 
scsi_»suÉ
 [256];

198 
Scsi_Ho¡
 * 
sh²t
;

199 
Scsi_Cmnd
 
SCmd
;

201 ++
š_sÿn
;

202 
lun
 = 0;

204 
SCmd
.
Ãxt
 = 
NULL
;

205 
SCmd
.
´ev
 = 
NULL
;

206 
sh²t
 = 
scsi_ho¡li¡
; sh²t; sh²ˆğsh²t->
Ãxt
)

208 
sh²t
->
ho¡_queue
 = &
SCmd
;

210 
dev
 = 0; dev < 8; ++dev)

211 ià(
sh²t
->
this_id
 !ğ
dev
)

216 #ifdeà
NO_MULTI_LUN


217 
lun
 = 0;†un < 1; ++lun)

219 
lun
 = 0;†un < 8; ++lun)

222 
scsi_deviûs
[
NR_SCSI_DEVICES
].
ho¡
 = 
sh²t
;

223 
scsi_deviûs
[
NR_SCSI_DEVICES
].
id
 = 
dev
;

224 
scsi_deviûs
[
NR_SCSI_DEVICES
].
lun
 =†un;

225 
scsi_deviûs
[
NR_SCSI_DEVICES
].
šdex
 = NR_SCSI_DEVICES;

226 
scsi_deviûs
[
NR_SCSI_DEVICES
].
deviû_wa™
 = 
NULL
;

231 
scsi_deviûs
[
NR_SCSI_DEVICES
].
bÜk’
 = 1;

233 
scsi_cmd
[0] = 
TEST_UNIT_READY
;

234 
scsi_cmd
[1] = 
lun
 << 5;

235 
scsi_cmd
[2] = scsi_cmd[3] = scsi_cmd[5] = 0;

236 
scsi_cmd
[4] = 0;

238 
SCmd
.
ho¡
 = 
sh²t
;

239 
SCmd
.
rg‘
 = 
dev
;

240 
SCmd
.
lun
 =†un;

242 
SCmd
.
»que¡
.
dev
 = 0xffff;

243 
SCmd
.
u£_sg
 = 0;

244 
SCmd
.
Şd_u£_sg
 = 0;

245 
SCmd
.
Œªsãrsize
 = 0;

246 
SCmd
.
und”æow
 = 0;

247 
SCmd
.
šdex
 = 
NR_SCSI_DEVICES
;

249 
	`scsi_do_cmd
 (&
SCmd
,

250 (*è
scsi_cmd
, (*)

251 
scsi_»suÉ
, 256, 
sÿn_scsis_dÚe
,

252 
SCSI_TIMEOUT
 + 400, 5);

254 
SCmd
.
»que¡
.
dev
 != 0xfffe);

255 #ià
	`defšed
(
DEBUG
è|| defšed(
DEBUG_INIT
)

256 
	`´štk
("scsi: sÿÀSCSIS id %d†uÀ%d\n", 
dev
, 
lun
);

257 
	`´štk
("scsi:„‘uº cod%08x\n", 
SCmd
.
»suÉ
);

261 if(
SCmd
.
»suÉ
) {

262 ià((
	`driv”_by‹
(
SCmd
.
»suÉ
è& 
DRIVER_SENSE
) &&

263 ((
SCmd
.
£n£_bufãr
[0] & 0x70) >> 4) == 7) {

264 ià(
SCmd
.
£n£_bufãr
[2] &0xe0)

266 if(((
SCmd
.
£n£_bufãr
[2] & 0xfè!ğ
NOT_READY
) &&

267 ((
SCmd
.
£n£_bufãr
[2] & 0xfè!ğ
UNIT_ATTENTION
))

274 #ià
	`defšed
 (
DEBUG
è|| defšed(
DEBUG_INIT
)

275 
	`´štk
("scsi:…erforming INQUIRY\n");

282 
scsi_cmd
[0] = 
INQUIRY
;

283 
scsi_cmd
[1] = (
lun
 << 5) & 0xe0;

284 
scsi_cmd
[2] = 0;

285 
scsi_cmd
[3] = 0;

286 
scsi_cmd
[4] = 255;

287 
scsi_cmd
[5] = 0;

289 
SCmd
.
»que¡
.
dev
 = 0xffff;

291 
	`scsi_do_cmd
 (&
SCmd
,

292 (*è
scsi_cmd
, (*)

293 
scsi_»suÉ
, 256, 
sÿn_scsis_dÚe
,

294 
SCSI_TIMEOUT
, 3);

296 
SCmd
.
»que¡
.
dev
 != 0xfffe);

298 
the_»suÉ
 = 
SCmd
.
»suÉ
;

300 #ià
	`defšed
(
DEBUG
è|| defšed(
DEBUG_INIT
)

301 ià(!
the_»suÉ
)

302 
	`´štk
("scsi: INQUIRY successful\n");

304 
	`´štk
("scsi: INQUIRY failed with code %08x\n");

307 if(
the_»suÉ
) ;

311 ià(!
the_»suÉ
)

313 
scsi_deviûs
[
NR_SCSI_DEVICES
].

314 
»movabË
 = (0x80 &

315 
scsi_»suÉ
[1]) >> 7;

316 
scsi_deviûs
[
NR_SCSI_DEVICES
].
lockabË
 =

317 
scsi_deviûs
[
NR_SCSI_DEVICES
].
»movabË
;

318 
scsi_deviûs
[
NR_SCSI_DEVICES
].

319 
chªged
 = 0;

320 
scsi_deviûs
[
NR_SCSI_DEVICES
].

321 
acûss_couÁ
 = 0;

322 
scsi_deviûs
[
NR_SCSI_DEVICES
].

323 
busy
 = 0;

330 
ty³
 = 
scsi_»suÉ
[0])

332 
TYPE_TAPE
 :

333 
TYPE_DISK
 :

334 
TYPE_MOD
 :

335 
scsi_deviûs
[
NR_SCSI_DEVICES
].
wr™—bË
 = 1;

337 
TYPE_WORM
 :

338 
TYPE_ROM
 :

339 
scsi_deviûs
[
NR_SCSI_DEVICES
].
wr™—bË
 = 0;

343 #ifdeà
DEBUG


344 
	`´štk
("scsi: unknowÀty³ %d\n", 
ty³
);

345 
	`´št_šquœy
(
scsi_»suÉ
);

348 
ty³
 = -1;

351 
scsi_deviûs
[
NR_SCSI_DEVICES
].
¿ndom
 =

352 (
ty³
 =ğ
TYPE_TAPE
) ? 0 : 1;

353 
scsi_deviûs
[
NR_SCSI_DEVICES
].
ty³
 =ype;

355 ià(
ty³
 != -1)

357 
	`´št_šquœy
(
scsi_»suÉ
);

358 
ty³
){

359 
TYPE_TAPE
:

360 
	`´štk
("D‘eùed scs˜³ st%d‡ˆscsi%d, id %d,†uÀ%d\n", 
MAX_ST
,

361 
sh²t
->
ho¡_no
 , 
dev
, 
lun
);

362 if(
NR_ST
 !ğ-1è++
MAX_ST
;

364 
TYPE_ROM
:

365 
	`´štk
("D‘eùed scs˜CD-ROM sr%d‡ˆscsi%d, id %d,†uÀ%d\n", 
MAX_SR
,

366 
sh²t
->
ho¡_no
 , 
dev
, 
lun
);

367 if(
NR_SR
 !ğ-1è++
MAX_SR
;

369 
TYPE_DISK
:

370 
TYPE_MOD
:

371 
	`´štk
("D‘eùed scs˜disk sd%ø© scsi%d, id %d,†uÀ%d\n", 'a'+
MAX_SD
,

372 
sh²t
->
ho¡_no
 , 
dev
, 
lun
);

373 if(
NR_SD
 !ğ-1è++
MAX_SD
;

379 if(
NR_SG
 !ğ-1è++
MAX_SG
;

381 
scsi_deviûs
[
NR_SCSI_DEVICES
].
scsi_Ëv–
 =

382 
scsi_»suÉ
[2] & 0x07;

383 ià(
scsi_deviûs
[
NR_SCSI_DEVICES
].
scsi_Ëv–
 >= 2 ||

384 (
scsi_deviûs
[
NR_SCSI_DEVICES
].
scsi_Ëv–
 == 1 &&

385 (
scsi_»suÉ
[3] & 0x0f) == 1))

386 
scsi_deviûs
[
NR_SCSI_DEVICES
].
scsi_Ëv–
++;

392 
scsi_deviûs
[
NR_SCSI_DEVICES
].
gged_queue
 = 0;

394 ià((
scsi_deviûs
[
NR_SCSI_DEVICES
].
scsi_Ëv–
 >ğ
SCSI_2
) &&

395 (
scsi_»suÉ
[7] & 2)) {

396 
scsi_deviûs
[
NR_SCSI_DEVICES
].
gged_suµÜ‹d
 = 1;

397 
scsi_deviûs
[
NR_SCSI_DEVICES
].
cu¼’t_g
 = 0;

405 
scsi_deviûs
[
NR_SCSI_DEVICES
].
discÚÃù
 = 0;

415 if(
	`¡ºcmp
("TEXEL", (*è&
scsi_»suÉ
[8], 5) != 0 ||

416 
	`¡ºcmp
("CD-ROM", (*è&
scsi_»suÉ
[16], 6) != 0

423 #ifdeà
nÙy‘


424 || (
	`¡ºcmp
("1.06", (*è&
scsi_»suÉ
[[, 4) != 0)

427 
scsi_deviûs
[
NR_SCSI_DEVICES
].
bÜk’
 = 0;

432 if(
	`memcmp
("INSITE", &
scsi_»suÉ
[8], 6) == 0 &&

433 (
	`memcmp
("FlİtiÿÈ F*8I", &
scsi_»suÉ
[16], 16) == 0

434 || 
	`memcmp
("I325VM", &
scsi_»suÉ
[16], 6) == 0)) {

435 
	`´štk
("Unlocked floptical drive.\n");

436 
scsi_deviûs
[
NR_SCSI_DEVICES
].
lockabË
 = 0;

437 
scsi_cmd
[0] = 
MODE_SENSE
;

438 
scsi_cmd
[1] = (
lun
 << 5) & 0xe0;

439 
scsi_cmd
[2] = 0x2e;

440 
scsi_cmd
[3] = 0;

441 
scsi_cmd
[4] = 0x2a;

442 
scsi_cmd
[5] = 0;

444 
SCmd
.
»que¡
.
dev
 = 0xffff;

446 
	`scsi_do_cmd
 (&
SCmd
,

447 (*è
scsi_cmd
, (*)

448 
scsi_»suÉ
, 0x2a, 
sÿn_scsis_dÚe
,

449 
SCSI_TIMEOUT
, 3);

451 
SCmd
.
»que¡
.
dev
 != 0xfffe);

454 ++
NR_SCSI_DEVICES
;

457 if(
	`bÏckli¡ed
(
scsi_»suÉ
)) ;

459 ià((
scsi_»suÉ
[2] & 0x07) == 0)

463 if((
scsi_»suÉ
[2] & 0x07) == 1 &&

464 (
scsi_»suÉ
[3] & 0x0f) == 0) ;

468 
sh²t
->
ho¡_queue
 = 
NULL
;

471 
	`´štk
("scsi : detected ");

472 if(
NR_SD
 != -1)

473 
	`´štk
("%d SCSI disk% ", 
MAX_SD
, (MAX_SD != 1) ? "s" : "");

475 if(
NR_ST
 != -1)

476 
	`´štk
("%d­e% ", 
MAX_ST
, (MAX_ST != 1) ? "s" : "");

478 if(
NR_SR
 != -1)

479 
	`´štk
("%d CD-ROM drive% ", 
MAX_SR
, (MAX_SR != 1) ? "s" : "");

481 
	`´štk
("total.\n");

482 
š_sÿn
 = 0;

483 
	}
}

489 
	#NORMAL_TIMEOUT
 0

	)

490 
	#IN_ABORT
 1

	)

491 
	#IN_RESET
 2

	)

498 
	$scsi_times_out
 (
Scsi_Cmnd
 * 
SC²t
)

501 
SC²t
->
š‹º®_timeout
 & (
IN_ABORT
 | 
IN_RESET
))

503 
NORMAL_TIMEOUT
:

504 ià(!
š_sÿn
)

505 
	`´štk
("SCSI host %dimed out -‡borting command\n",

506 
SC²t
->
ho¡
->
ho¡_no
);

508 ià(!
	`scsi_abÜt
 (
SC²t
, 
DID_TIME_OUT
))

510 
IN_ABORT
:

511 
	`´štk
("SCSI host %d‡bort()imed out -„eseting\n",

512 
SC²t
->
ho¡
->
ho¡_no
);

513 ià(!
	`scsi_»£t
 (
SC²t
))

515 
IN_RESET
:

516 (
IN_ABORT
 | 
IN_RESET
):

517 
	`·nic
("UÇbËØ»£ˆscs˜ho¡ %d\n",
SC²t
->
ho¡
->
ho¡_no
);

519 
INTERNAL_ERROR
;

522 
	}
}

531 
Scsi_Cmnd
 * 
	$»que¡_queu—bË
 (
»que¡
 * 
»q
, 
šdex
)

533 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

534 
bËsize
;

535 
bufãr_h—d
 * 
bh
;

537 ià((
šdex
 < 0è|| (šdex > 
NR_SCSI_DEVICES
))

538 
	`·nic
 ("Index‚umber in‡llocate_device() is out of„ange.\n");

540 ià(
»q
 &&„eq->
dev
 <= 0)

541 
	`·nic
("Invalid device in‡llocate_device");

543 
SC²t
 = 
scsi_deviûs
[
šdex
].
ho¡
->
ho¡_queue
;

544 
SC²t
){

545 if(
SC²t
->
rg‘
 =ğ
scsi_deviûs
[
šdex
].
id
 &&

546 
SC²t
->
lun
 =ğ
scsi_deviûs
[
šdex
].lun)

547 if(
SC²t
->
»que¡
.
dev
 < 0) ;

548 
SC²t
 = SC²t->
Ãxt
;

551 ià(!
SC²t
è 
NULL
;

553 ià(
scsi_deviûs
[
šdex
].
ho¡
->
ho¡t
->
ÿn_queue


554 && 
scsi_deviûs
[
šdex
].
ho¡
->
ho¡_busy
 >ğscsi_deviûs[šdex].ho¡->
ho¡t
->
ÿn_queue
è 
NULL
;

556 ià(
»q
) {

557 
	`memıy
(&
SC²t
->
»que¡
, 
»q
, (request));

558 
bËsize
 = 
scsi_deviûs
[
šdex
].
ho¡
->
sg_bËsize
;

559 
bh
 = 
»q
->bh;

560 if(!
bËsize
è
bh
 = 
NULL
;

563 
»q
->
Ä_£ùÜs
 && 
bh
){

564 
bËsize
--;

565 
»q
->
Ä_£ùÜs
 -ğ
bh
->
b_size
 >> 9;

566 
»q
->
£ùÜ
 +ğ
bh
->
b_size
 >> 9;

567 if(!
bËsize
) ;

568 
bh
 = bh->
b_»qÃxt
;

570 if(
»q
->
Ä_£ùÜs
 && 
bh
 && bh->
b_»qÃxt
){

571 
SC²t
->
»que¡
.
bh
 = 
bh
;

572 
»q
->
bh
 = bh->
b_»qÃxt
;

573 
bh
->
b_»qÃxt
 = 
NULL
;

574 
bh
 = 
»q
->bh;

577 
SC²t
->
»que¡
.
Ä_£ùÜs
 -ğ
»q
->nr_sectors;

578 
»q
->
cu¼’t_Ä_£ùÜs
 = 
bh
->
b_size
 >> 9;

579 
»q
->
bufãr
 = 
bh
->
b_d©a
;

580 
SC²t
->
»que¡
.
wa™šg
 = 
NULL
;

582 
»q
->
dev
 = -1;

585 
SC²t
->
»que¡
.
dev
 = 0xffff;

586 
SC²t
->
»que¡
.
wa™šg
 = 
NULL
;

589 
SC²t
->
u£_sg
 = 0;

590 
SC²t
->
Şd_u£_sg
 = 0;

591 
SC²t
->
Œªsãrsize
 = 0;

592 
SC²t
->
und”æow
 = 0;

593  
SC²t
;

594 
	}
}

605 
Scsi_Cmnd
 * 
	$®loÿ‹_deviû
 (
»que¡
 ** 
»qp
, 
šdex
, 
wa™
)

607 
dev
 = -1;

608 
»que¡
 * 
»q
 = 
NULL
;

609 
bËsize
;

610 
bufãr_h—d
 * 
bh
;

611 
Scsi_Ho¡
 * 
ho¡
;

612 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

613 
Scsi_Cmnd
 * 
SCwa™
 = 
NULL
;

615 ià((
šdex
 < 0è|| (šdex > 
NR_SCSI_DEVICES
))

616 
	`·nic
 ("Index‚umber in‡llocate_device() is out of„ange.\n");

618 ià(
»qp
è
»q
 = *reqp;

621 ià(
»q
 && (
dev
 =„eq->devè<ğ0è 
NULL
;

623 
ho¡
 = 
scsi_deviûs
[
šdex
].host;

626 
SC²t
 = 
ho¡
->
ho¡_queue
;

627 
SC²t
){

628 if(
SC²t
->
rg‘
 =ğ
scsi_deviûs
[
šdex
].
id
 &&

629 
SC²t
->
lun
 =ğ
scsi_deviûs
[
šdex
].lun) {

630 
SCwa™
 = 
SC²t
;

631 if(
SC²t
->
»que¡
.
dev
 < 0) ;

633 
SC²t
 = SC²t->
Ãxt
;

635 
	`şi
();

637 ià(
»q
 && (Ôeq->
dev
 < 0) || (req->dev != dev))) {

638 
	`¡i
();

639  
NULL
;

641 ià(!
SC²t
 || SC²t->
»que¡
.
dev
 >= 0)

643 
	`¡i
();

644 if(!
wa™
è 
NULL
;

645 ià(!
SCwa™
) {

646 
	`´štk
("Attempto‡llocate device index %d,arget %d,†un %d\n",

647 
šdex
, 
scsi_deviûs
[šdex].
id
 ,scsi_deviûs[šdex].
lun
);

648 
	`·nic
("No device found in‡llocate_device\n");

650 
	`SCSI_SLEEP
(&
scsi_deviûs
[
SCwa™
->
šdex
].
deviû_wa™
,

651 (
SCwa™
->
»que¡
.
dev
 > 0));

653 ià(
»q
) {

654 
	`memıy
(&
SC²t
->
»que¡
, 
»q
, (request));

655 
bËsize
 = 
scsi_deviûs
[
šdex
].
ho¡
->
sg_bËsize
;

656 
bh
 = 
»q
->bh;

657 if(!
bËsize
è
bh
 = 
NULL
;

660 
»q
->
Ä_£ùÜs
 && 
bh
){

661 
bËsize
--;

662 
»q
->
Ä_£ùÜs
 -ğ
bh
->
b_size
 >> 9;

663 
»q
->
£ùÜ
 +ğ
bh
->
b_size
 >> 9;

664 if(!
bËsize
) ;

665 
bh
 = bh->
b_»qÃxt
;

667 if(
»q
->
Ä_£ùÜs
 && 
bh
 && bh->
b_»qÃxt
){

668 
SC²t
->
»que¡
.
bh
 = 
bh
;

669 
»q
->
bh
 = bh->
b_»qÃxt
;

670 
bh
->
b_»qÃxt
 = 
NULL
;

671 
bh
 = 
»q
->bh;

673 
SC²t
->
»que¡
.
Ä_£ùÜs
 -ğ
»q
->nr_sectors;

674 
»q
->
cu¼’t_Ä_£ùÜs
 = 
bh
->
b_size
 >> 9;

675 
»q
->
bufãr
 = 
bh
->
b_d©a
;

676 
SC²t
->
»que¡
.
wa™šg
 = 
NULL
;

680 
»q
->
dev
 = -1;

681 *
»qp
 = 
»q
->
Ãxt
;

684 
SC²t
->
»que¡
.
dev
 = 0xffff;

685 
SC²t
->
»que¡
.
wa™šg
 = 
NULL
;

687 
	`¡i
();

692 
SC²t
->
u£_sg
 = 0;

693 
SC²t
->
Şd_u£_sg
 = 0;

694 
SC²t
->
Œªsãrsize
 = 0;

695 
SC²t
->
und”æow
 = 0;

696  
SC²t
;

697 
	}
}

703 
šlše
 
	$š‹º®_cmnd
 (
Scsi_Cmnd
 * 
SC²t
)

705 
‹mp
;

706 
Scsi_Ho¡
 * 
ho¡
;

707 #ifdeà
DEBUG_DELAY


708 
şock
;

711 ià((è&
SC²t
 < 
cu¼’t
->
k”Ãl_¡ack_·ge
)

712 
	`·nic
("Kernel stack overflow.");

714 
ho¡
 = 
SC²t
->host;

720 
‹mp
 = 
ho¡
->
Ï¡_»£t
;

721 
jiff›s
 < 
‹mp
);

723 
	`upd©e_timeout
(
SC²t
, SC²t->
timeout_³r_commªd
);

729 #ifdeà
DEBUG


730 
	`´štk
("internal_cmnd (host = %d,arget = %d, command = %08x, buffer = %08x, \n"

731 "bufæ’ = %d, dÚğ%08x)\n", 
SC²t
->
ho¡
->
ho¡_no
, SC²t->
rg‘
, SC²t->
cmnd
, SC²t->
bufãr
, SC²t->
bufæ’
, SC²t->
dÚe
);

734 ià(
ho¡
->
ho¡t
->
ÿn_queue
)

736 #ifdeà
DEBUG


737 
	`´štk
("queuecommand :„outine‡t %08x\n",

738 
ho¡
->
ho¡t
->
queuecommªd
);

740 
ho¡
->
ho¡t
->
	`queuecommªd
 (
SC²t
, 
scsi_dÚe
);

745 #ifdeà
DEBUG


746 
	`´štk
("commªd(è:„outš© %08x\n", 
ho¡
->
ho¡t
->
commªd
);

748 
‹mp
=
ho¡
->
ho¡t
->
	`commªd
 (
SC²t
);

749 
SC²t
->
»suÉ
 = 
‹mp
;

750 #ifdeà
DEBUG_DELAY


751 
şock
 = 
jiff›s
 + 400;

752 
jiff›s
 < 
şock
);

753 
	`´štk
("dÚe(ho¡ = %d,„esuÉ = %04xè:„outš© %08x\n", 
ho¡
->
ho¡_no
, 
‹mp
, 
dÚe
);

755 
	`scsi_dÚe
(
SC²t
);

757 #ifdeà
DEBUG


758 
	`´štk
("leaving internal_cmnd()\n");

760 
	}
}

762 
	$scsi_»que¡_£n£
 (
Scsi_Cmnd
 * 
SC²t
)

764 
	`şi
();

765 
SC²t
->
æags
 |ğ
WAS_SENSE
 | 
ASKED_FOR_SENSE
;

766 
	`upd©e_timeout
(
SC²t
, 
SENSE_TIMEOUT
);

767 
	`¡i
();

770 
	`memıy
 ((*è
SC²t
->
cmnd
 , (*è
g’”ic_£n£
,

771 (
g’”ic_£n£
));

773 
SC²t
->
cmnd
[1] = SC²t->
lun
 << 5;

774 
SC²t
->
cmnd
[4] = (SC²t->
£n£_bufãr
);

776 
SC²t
->
»que¡_bufãr
 = &SC²t->
£n£_bufãr
;

777 
SC²t
->
»que¡_bufæ’
 = (SC²t->
£n£_bufãr
);

778 
SC²t
->
u£_sg
 = 0;

779 
	`š‹º®_cmnd
 (
SC²t
);

780 
SC²t
->
u£_sg
 = SC²t->
Şd_u£_sg
;

781 
	}
}

792 
scsi_do_cmd
 (
Scsi_Cmnd
 * 
SC²t
, cÚ¡ *
cmnd
 ,

793 *
bufãr
, 
bufæ’
, (*
dÚe
)(
Scsi_Cmnd
 *),

794 
timeout
, 
»Œ›s


797 
Scsi_Ho¡
 * 
ho¡
 = 
SC²t
->host;

799 #ifdeà
DEBUG


801 
i
;

802 
rg‘
 = 
SC²t
->target;

803 
	`´štk
 ("scsi_do_cmd (host = %d,arget = %d, buffer =%08x, "

805 "commªd : " , 
ho¡
->
ho¡_no
, 
rg‘
, 
bufãr
, 
bufæ’
, 
dÚe
, 
timeout
, 
»Œ›s
);

806 
i
 = 0; i < 10; ++i)

807 
	`´štk
 ("%02x ", ((*è
cmnd
)[
i
]);

808 
	`´štk
("\n");

812 ià(!
ho¡
)

814 
	`·nic
 ("Inv®id o¸nÙ…»£Á ho¡. %d\n", 
ho¡
->
ho¡_no
);

827 
	`şi
();

828 ià(
ho¡
->
ho¡t
->
ÿn_queue


829 && 
ho¡
->
ho¡_busy
 >ğho¡->
ho¡t
->
ÿn_queue
)

831 
	`¡i
();

832 
	`SCSI_SLEEP
(&
ho¡
->
ho¡_wa™
,

833 (
ho¡
->
ho¡_busy
 >ğho¡->
ho¡t
->
ÿn_queue
));

835 
ho¡
->
ho¡_busy
++;

836 
	`¡i
();

848 
	`memıy
 ((*è
SC²t
->
d©a_cmnd
 , (*è
cmnd
, 12);

850 
SC²t
->
ho¡
 = host;

851 
SC²t
->
rg‘
 =arget;

852 
SC²t
->
lun
 = (SC²t->
d©a_cmnd
[1] >> 5);

854 
SC²t
->
bufæ’
 = bufflen;

855 
SC²t
->
bufãr
 = buffer;

856 
SC²t
->
æags
=0;

857 
SC²t
->
»Œ›s
=0;

858 
SC²t
->
®lowed
=
»Œ›s
;

859 
SC²t
->
dÚe
 = done;

860 
SC²t
->
timeout_³r_commªd
 = 
timeout
;

862 
	`memıy
 ((*è
SC²t
->
cmnd
 , (*) cmnd, 12);

865 
	`mem£t
 ((*è
SC²t
->
£n£_bufãr
, 0,  SCpnt->sense_buffer);

866 
SC²t
->
»que¡_bufãr
 = 
bufãr
;

867 
SC²t
->
»que¡_bufæ’
 = 
bufæ’
;

868 
SC²t
->
Şd_u£_sg
 = SC²t->
u£_sg
;

872 
SC²t
->
š‹º®_timeout
 = 0;

873 
	`š‹º®_cmnd
 (
SC²t
);

875 #ifdeà
DEBUG


876 
	`´štk
 ("Leaving scsi_do_cmd()\n");

878 
	}
}

888 
	$»£t
 (
Scsi_Cmnd
 * 
SC²t
)

890 #ifdeà
DEBUG


891 
	`´štk
("scsi:„e£t(%d)\n", 
SC²t
->
ho¡
->
ho¡_no
);

894 
SC²t
->
æags
 |ğ(
WAS_RESET
 | 
IS_RESETTING
);

895 
	`scsi_»£t
(
SC²t
);

897 #ifdeà
DEBUG


898 
	`´štk
("performing„equest sense\n");

901 if(
SC²t
->
æags
 & 
NEEDS_JUMPSTART
) {

902 
SC²t
->
æags
 &ğ~
NEEDS_JUMPSTART
;

903 
	`scsi_»que¡_£n£
 (
SC²t
);

905 
	}
}

909 
	$check_£n£
 (
Scsi_Cmnd
 * 
SC²t
)

914 ià(((
SC²t
->
£n£_bufãr
[0] & 0x70) >> 4) != 7) {

915 if(!(
SC²t
->
æags
 & 
ASKED_FOR_SENSE
))

916  
SUGGEST_SENSE
;

918  
SUGGEST_RETRY
;

921 
SC²t
->
æags
 &ğ~
ASKED_FOR_SENSE
;

923 #ifdeà
DEBUG_INIT


924 
	`´štk
("scsi%d : ", 
SC²t
->
ho¡
->
ho¡_no
);

925 
	`´št_£n£
("", 
SC²t
);

926 
	`´štk
("\n");

928 ià(
SC²t
->
£n£_bufãr
[2] &0xe0)

929  
SUGGEST_ABORT
;

931 
SC²t
->
£n£_bufãr
[2] & 0xf)

933 
NO_SENSE
:

935 
RECOVERED_ERROR
:

936 ià(
scsi_deviûs
[
SC²t
->
šdex
].
ty³
 =ğ
TYPE_TAPE
)

937  
SUGGEST_IS_OK
;

941 
ABORTED_COMMAND
:

942  
SUGGEST_RETRY
;

943 
NOT_READY
:

944 
UNIT_ATTENTION
:

945  
SUGGEST_ABORT
;

948 
COPY_ABORTED
:

949 
VOLUME_OVERFLOW
:

950 
MISCOMPARE
:

952 
MEDIUM_ERROR
:

953  
SUGGEST_REMAP
;

954 
BLANK_CHECK
:

955 
DATA_PROTECT
:

956 
HARDWARE_ERROR
:

957 
ILLEGAL_REQUEST
:

959  
SUGGEST_ABORT
;

961 
	}
}

984 
	$scsi_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

986 
¡©us
=0;

987 
ex™
=0;

988 
checked
;

989 
Şdto
;

990 
Scsi_Ho¡
 * 
ho¡
 = 
SC²t
->host;

991 
»suÉ
 = 
SC²t
->result;

992 
Şdto
 = 
	`upd©e_timeout
(
SC²t
, 0);

994 
	#FINISHED
 0

	)

995 
	#MAYREDO
 1

	)

996 
	#REDO
 3

	)

997 
	#PENDING
 4

	)

999 #ifdeà
DEBUG


1000 
	`´štk
("IÀscsi_dÚe(ho¡ = %d,„esuÉ = %06x)\n", 
ho¡
->
ho¡_no
, 
»suÉ
);

1002 
	`ho¡_by‹
(
»suÉ
))

1004 
DID_OK
:

1005 ià(
SC²t
->
æags
 & 
IS_RESETTING
)

1007 
SC²t
->
æags
 &ğ~
IS_RESETTING
;

1008 
¡©us
 = 
REDO
;

1012 ià(
	`¡©us_by‹
(
»suÉ
è&& (
SC²t
->
æags
 & 
WAS_SENSE
))

1015 
SC²t
->
æags
 &ğ~
WAS_SENSE
;

1016 
SC²t
->
š‹º®_timeout
 &ğ~
SENSE_TIMEOUT
;

1018 ià(!(
SC²t
->
æags
 & 
WAS_RESET
))

1020 
	`´štk
("scsi%d :arget %d†un %d„equest sense failed,…erforming„eset.\n",

1021 
SC²t
->
ho¡
->
ho¡_no
, SC²t->
rg‘
, SC²t->
lun
);

1022 
	`»£t
(
SC²t
);

1027 
ex™
 = (
DRIVER_HARD
 | 
SUGGEST_ABORT
);

1028 
¡©us
 = 
FINISHED
;

1031 
	`msg_by‹
(
»suÉ
))

1033 
COMMAND_COMPLETE
:

1034 
	`¡©us_by‹
(
»suÉ
))

1036 
GOOD
:

1037 ià(
SC²t
->
æags
 & 
WAS_SENSE
)

1039 #ifdeà
DEBUG


1040 
	`´štk
 ("In scsi_done, GOOD status, COMMAND COMPLETE,…arsing sense information.\n");

1043 
SC²t
->
æags
 &ğ~
WAS_SENSE
;

1044 
SC²t
->
š‹º®_timeout
 &ğ~
SENSE_TIMEOUT
;

1046 
checked
 = 
	`check_£n£
(
SC²t
))

1048 
SUGGEST_SENSE
:

1050 #ifdeà
DEBUG


1051 
	`´štk
("NO SENSE. status = REDO\n");

1054 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1055 
¡©us
 = 
REDO
;

1057 
SUGGEST_IS_OK
:

1059 
SUGGEST_REMAP
:

1060 
SUGGEST_RETRY
:

1061 #ifdeà
DEBUG


1062 
	`´štk
("SENSE SUGGEST REMAP or SUGGEST RETRY - status = MAYREDO\n");

1065 
¡©us
 = 
MAYREDO
;

1066 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_RETRY
;

1068 
SUGGEST_ABORT
:

1069 #ifdeà
DEBUG


1070 
	`´štk
("SENSE SUGGEST ABORT - status = FINISHED");

1073 
¡©us
 = 
FINISHED
;

1074 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_ABORT
;

1077 
	`´štk
 ("IÁ”ÇÈ”rÜ % %d \n", 
__FILE__
,

1078 
__LINE__
);

1083 #ifdeà
DEBUG


1084 
	`´štk
("COMMAND COMPLETE message„eturned, status = FINISHED. \n");

1087 
ex™
 = 
DRIVER_OK
;

1088 
¡©us
 = 
FINISHED
;

1092 
CHECK_CONDITION
:

1093 
	`check_£n£
(
SC²t
))

1096 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1097 
¡©us
 = 
REDO
;

1099 
SUGGEST_REMAP
:

1100 
SUGGEST_RETRY
:

1101 
¡©us
 = 
MAYREDO
;

1102 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_RETRY
;

1104 
SUGGEST_ABORT
:

1105 
¡©us
 = 
FINISHED
;

1106 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_ABORT
;

1108 
SUGGEST_SENSE
:

1109 
	`scsi_»que¡_£n£
 (
SC²t
);

1110 
¡©us
 = 
PENDING
;

1115 
CONDITION_GOOD
:

1116 
INTERMEDIATE_GOOD
:

1117 
INTERMEDIATE_C_GOOD
:

1120 
BUSY
:

1121 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1122 
¡©us
 = 
REDO
;

1125 
RESERVATION_CONFLICT
:

1126 
	`´štk
("scsi%d : RESERVATION CONFLICT…erforming„eset.\n",

1127 
SC²t
->
ho¡
->
ho¡_no
);

1128 
	`»£t
(
SC²t
);

1131 
ex™
 = 
DRIVER_SOFT
 | 
SUGGEST_ABORT
;

1132 
¡©us
 = 
MAYREDO
;

1136 
	`´štk
 ("Internalƒrror %s %d \n"

1137 "¡©u by‹ = %d \n", 
__FILE__
,

1138 
__LINE__
, 
	`¡©us_by‹
(
»suÉ
));

1143 
	`·nic
("scsi: unsuµÜ‹d mes§gby‹ %d„ec›ved\n", 
	`msg_by‹
(
»suÉ
));

1146 
DID_TIME_OUT
:

1147 #ifdeà
DEBUG


1148 
	`´štk
("Host„eturned DID_TIME_OUT - ");

1151 ià(
SC²t
->
æags
 & 
WAS_TIMEDOUT
)

1153 #ifdeà
DEBUG


1154 
	`´štk
("Aborting\n");

1156 
ex™
 = (
DRIVER_TIMEOUT
 | 
SUGGEST_ABORT
);

1160 #ifdeà
DEBUG


1161 
	`´štk
 ("Retrying.\n");

1163 
SC²t
->
æags
 |ğ
WAS_TIMEDOUT
;

1164 
¡©us
 = 
REDO
;

1167 
DID_BUS_BUSY
:

1168 
DID_PARITY
:

1169 
¡©us
 = 
REDO
;

1171 
DID_NO_CONNECT
:

1172 #ifdeà
DEBUG


1173 
	`´štk
("Couldn't connect.\n");

1175 
ex™
 = (
DRIVER_HARD
 | 
SUGGEST_ABORT
);

1177 
DID_ERROR
:

1178 
¡©us
 = 
MAYREDO
;

1179 
ex™
 = (
DRIVER_HARD
 | 
SUGGEST_ABORT
);

1181 
DID_BAD_TARGET
:

1182 
DID_ABORT
:

1183 
ex™
 = (
DRIVER_INVALID
 | 
SUGGEST_ABORT
);

1185 
DID_RESET
:

1186 if(
	`msg_by‹
(
»suÉ
è=ğ
GOOD
 &&

1187 
	`¡©us_by‹
(
»suÉ
è=ğ
CHECK_CONDITION
) {

1188 
	`check_£n£
(
SC²t
)) {

1190 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1191 
¡©us
 = 
REDO
;

1193 
SUGGEST_REMAP
:

1194 
SUGGEST_RETRY
:

1195 
¡©us
 = 
MAYREDO
;

1196 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_RETRY
;

1198 
SUGGEST_ABORT
:

1199 
¡©us
 = 
FINISHED
;

1200 
ex™
 = 
DRIVER_SENSE
 | 
SUGGEST_ABORT
;

1202 
SUGGEST_SENSE
:

1203 
	`scsi_»que¡_£n£
 (
SC²t
);

1204 
¡©us
 = 
PENDING
;

1208 
¡©us
=
REDO
;

1209 
ex™
 = 
SUGGEST_RETRY
;

1213 
ex™
 = (
DRIVER_ERROR
 | 
SUGGEST_DIE
);

1216 
¡©us
)

1218 
FINISHED
:

1219 
PENDING
:

1221 
MAYREDO
:

1223 #ifdeà
DEBUG


1224 
	`´štk
("In MAYREDO,‡llowing %d„etries, have %d\n",

1225 
SC²t
->
®lowed
, SC²t->
»Œ›s
);

1228 ià((++
SC²t
->
»Œ›s
è< SC²t->
®lowed
)

1230 ià((
SC²t
->
»Œ›s
 >ğ(SC²t->
®lowed
 >> 1))

1231 && !(
SC²t
->
æags
 & 
WAS_RESET
))

1233 
	`´štk
("scsi%d :„eseting for second half of„etries.\n",

1234 
SC²t
->
ho¡
->
ho¡_no
);

1235 
	`»£t
(
SC²t
);

1242 
¡©us
 = 
FINISHED
;

1247 
REDO
:

1248 ià(
SC²t
->
æags
 & 
WAS_SENSE
)

1249 
	`scsi_»que¡_£n£
(
SC²t
);

1252 
	`memıy
 ((*è
SC²t
->
cmnd
,

1253 (*è
SC²t
->
d©a_cmnd
,

1254 (
SC²t
->
d©a_cmnd
));

1255 
SC²t
->
»que¡_bufãr
 = SC²t->
bufãr
;

1256 
SC²t
->
»que¡_bufæ’
 = SC²t->
bufæ’
;

1257 
SC²t
->
u£_sg
 = SC²t->
Şd_u£_sg
;

1258 
	`š‹º®_cmnd
 (
SC²t
);

1262 
INTERNAL_ERROR
;

1265 ià(
¡©us
 =ğ
FINISHED
)

1267 #ifdeà
DEBUG


1268 
	`´štk
("C®lšg dÚfunùiÚ -‡ˆadd»s %08x\n", 
SC²t
->
dÚe
);

1270 
ho¡
->
ho¡_busy
--;

1271 
	`wake_up
(&
ho¡
->
ho¡_wa™
);

1272 
SC²t
->
»suÉ
 =„esuÉ | ((
ex™
 & 0xff) << 24);

1273 
SC²t
->
u£_sg
 = SC²t->
Şd_u£_sg
;

1274 
SC²t
->
	`dÚe
 (SCpnt);

1278 #undeà
FINISHED


1279 #undeà
REDO


1280 #undeà
MAYREDO


1281 #undeà
PENDING


1282 
	}
}

1300 
	$scsi_abÜt
 (
Scsi_Cmnd
 * 
SC²t
, 
why
)

1302 
‹mp
, 
Şdto
;

1303 
Scsi_Ho¡
 * 
ho¡
 = 
SC²t
->host;

1307 
	`şi
();

1308 ià(
SC²t
->
š‹º®_timeout
 & 
IN_ABORT
)

1310 
	`¡i
();

1311 
SC²t
->
š‹º®_timeout
 & 
IN_ABORT
);

1315 
SC²t
->
š‹º®_timeout
 |ğ
IN_ABORT
;

1316 
Şdto
 = 
	`upd©e_timeout
(
SC²t
, 
ABORT_TIMEOUT
);

1319 
	`¡i
();

1320 ià(!
ho¡
->
ho¡_busy
 || !ho¡->
ho¡t
->
	`abÜt
(
SC²t
, 
why
))

1321 
‹mp
 = 0;

1323 
‹mp
 = 1;

1325 
	`şi
();

1326 
SC²t
->
š‹º®_timeout
 &ğ~
IN_ABORT
;

1327 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1328 
	`¡i
();

1329  
‹mp
;

1332 
	}
}

1334 
	$scsi_»£t
 (
Scsi_Cmnd
 * 
SC²t
)

1336 
‹mp
, 
Şdto
;

1337 
Scsi_Cmnd
 * 
SC²t1
;

1338 
Scsi_Ho¡
 * 
ho¡
 = 
SC²t
->host;

1340 #ifdeà
DEBUG


1341 
	`´štk
("Dªg” WÈRobšsÚ! - SCSI bu fÜ ho¡ %d i bešg„e£t.\n",
ho¡
->
ho¡_no
);

1344 
	`şi
();

1345 ià(
SC²t
->
š‹º®_timeout
 & 
IN_RESET
)

1347 
	`¡i
();

1348 
SC²t
->
š‹º®_timeout
 & 
IN_RESET
);

1352 
SC²t
->
š‹º®_timeout
 |ğ
IN_RESET
;

1353 
Şdto
 = 
	`upd©e_timeout
(
SC²t
, 
RESET_TIMEOUT
);

1355 ià(
ho¡
->
ho¡_busy
)

1357 
	`¡i
();

1358 
SC²t1
 = 
ho¡
->
ho¡_queue
;

1359 
SC²t1
) {

1360 ià((
SC²t1
->
»que¡
.
dev
 > 0) &&

1361 !(
SC²t1
->
æags
 & 
IS_RESETTING
) &&

1362 !(
SC²t1
->
š‹º®_timeout
 & 
IN_ABORT
))

1363 
	`scsi_abÜt
(
SC²t1
, 
DID_RESET
);

1364 
SC²t1
 = SC²t1->
Ãxt
;

1367 
‹mp
 = 
ho¡
->
ho¡t
->
	`»£t
(
SC²t
);

1371 
ho¡
->
ho¡_busy
++;

1373 
	`¡i
();

1374 
‹mp
 = 
ho¡
->
ho¡t
->
	`»£t
(
SC²t
);

1375 
ho¡
->
Ï¡_»£t
 = 
jiff›s
;

1376 
ho¡
->
ho¡_busy
--;

1379 
	`şi
();

1380 
SC²t
->
š‹º®_timeout
 &ğ~
IN_RESET
;

1381 
	`upd©e_timeout
(
SC²t
, 
Şdto
);

1382 
	`¡i
();

1383  
‹mp
;

1386 
	}
}

1389 
	$scsi_maš_timeout
()

1395 
timed_out
;

1396 
Scsi_Ho¡
 * 
ho¡
;

1397 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

1400 
	`şi
();

1407 
timed_out
 = 0;

1408 
ho¡
 = 
scsi_ho¡li¡
; ho¡; ho¡ = ho¡->
Ãxt
) {

1409 
SC²t
 = 
ho¡
->
ho¡_queue
;

1410 
SC²t
){

1411 ià(
SC²t
->
timeout
 > 0 && SC²t->timeouˆ<ğ
time_–­£d
)

1413 
	`¡i
();

1414 
SC²t
->
timeout
 = 0;

1415 
	`scsi_times_out
(
SC²t
);

1416 ++
timed_out
;

1417 
	`şi
();

1419 
SC²t
 = SC²t->
Ãxt
;

1422 
	`upd©e_timeout
(
NULL
, 0);

1423 } 
timed_out
);

1424 
	`¡i
();

1425 
	}
}

1435 
	$upd©e_timeout
(
Scsi_Cmnd
 * 
SC£t
, 
timeout
)

1437 
Ëa¡
, 
u£d
;

1438 
Şdto
;

1439 
Scsi_Ho¡
 * 
ho¡
;

1440 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

1442 
	`şi
();

1448 
u£d
 = (
time_¡¬t
è? (
jiff›s
 -ime_start) : 0;

1456 
Şdto
 = 0;

1458 if(
SC£t
){

1459 
Şdto
 = 
SC£t
->
timeout
 - 
u£d
;

1460 
SC£t
->
timeout
 =imeouˆ+ 
u£d
;

1463 
Ëa¡
 = 0xffffffff;

1465 
ho¡
 = 
scsi_ho¡li¡
; ho¡; ho¡ = ho¡->
Ãxt
) {

1466 
SC²t
 = 
ho¡
->
ho¡_queue
;

1467 
SC²t
){

1468 ià(
SC²t
->
timeout
 > 0 && (SC²t->timeouˆ-ğ
u£d
è< 
Ëa¡
)

1469 
Ëa¡
 = 
SC²t
->
timeout
;

1470 
SC²t
 = SC²t->
Ãxt
;

1479 ià(
Ëa¡
 != 0xffffffff)

1481 
time_¡¬t
 = 
jiff›s
;

1482 
tim”_bË
[
SCSI_TIMER
].
expœes
 = (
time_–­£d
 = 
Ëa¡
è+ 
jiff›s
;

1483 
tim”_aùive
 |ğ1 << 
SCSI_TIMER
;

1487 
tim”_bË
[
SCSI_TIMER
].
expœes
 = 
time_¡¬t
 = 
time_–­£d
 = 0;

1488 
tim”_aùive
 &ğ~(1 << 
SCSI_TIMER
);

1490 
	`¡i
();

1491  
Şdto
;

1492 
	}
}

1495 * 
	gdma_m®loc_ä“li¡
 = 
NULL
;

1496 
	gdma_£ùÜs
 = 0;

1497 
	gdma_ä“_£ùÜs
 = 0;

1498 
	gÃed_i§_bufãr
 = 0;

1499 * 
	gdma_m®loc_bufãr
 = 
NULL
;

1501 *
	$scsi_m®loc
(
Ën
)

1503 
nb™s
, 
mask
;

1504 
i
, 
j
;

1505 if((
Ën
 & 0x1ff) ||†en > 4096)

1506 
	`·nic
("Inappropriate buffer size„equested");

1508 
	`şi
();

1509 
nb™s
 = 
Ën
 >> 9;

1510 
mask
 = (1 << 
nb™s
) - 1;

1512 
i
=0;˜< (
dma_£ùÜs
 >> 4); i++)

1513 
j
=0; j<17-
nb™s
; j++){

1514 ià((
dma_m®loc_ä“li¡
[
i
] & (
mask
 << 
j
)) == 0){

1515 
dma_m®loc_ä“li¡
[
i
] |ğ(
mask
 << 
j
);

1516 
	`¡i
();

1517 
dma_ä“_£ùÜs
 -ğ
nb™s
;

1518 #ifdeà
DEBUG


1519 
	`´štk
("SM®loc: %d %x ",
Ën
, 
dma_m®loc_bufãr
 + (
i
 << 13è+ (
j
 << 9));

1521  (*è((è
dma_m®loc_bufãr
 + (
i
 << 13è+ (
j
 << 9));

1524 
	`¡i
();

1525  
NULL
;

1526 
	}
}

1528 
	$scsi_ä“
(*
obj
, 
Ën
)

1530 
off£t
;

1531 
·ge
, 
£ùÜ
, 
nb™s
, 
mask
;

1533 #ifdeà
DEBUG


1534 
	`´štk
("Sä“ %x %d\n",
obj
, 
Ën
);

1537 
off£t
 = ((è
obj
è- ((è
dma_m®loc_bufãr
);

1539 ià(
off£t
 < 0è
	`·nic
("Bad offset");

1540 
·ge
 = 
off£t
 >> 13;

1541 
£ùÜ
 = 
off£t
 >> 9;

1542 if(
£ùÜ
 >ğ
dma_£ùÜs
è
	`·nic
 ("Bad…age");

1544 
£ùÜ
 = (
off£t
 >> 9) & 15;

1545 
nb™s
 = 
Ën
 >> 9;

1546 
mask
 = (1 << 
nb™s
) - 1;

1548 ià((
mask
 << 
£ùÜ
è> 0xffffè
	`·nic
 ("Bad memory‡lignment");

1550 
	`şi
();

1551 if(
dma_m®loc_ä“li¡
[
·ge
] & (
mask
 << 
£ùÜ
) != (mask<<sector))

1552 
	`·nic
("Tryingo free unused memory");

1554 
dma_ä“_£ùÜs
 +ğ
nb™s
;

1555 
dma_m®loc_ä“li¡
[
·ge
] &ğ~(
mask
 << 
£ùÜ
);

1556 
	`¡i
();

1558 
	}
}

1566 
	$scsi_dev_š™
 (
memÜy_¡¬t
,
memÜy_’d
)

1568 
i
;

1569 
Scsi_Ho¡
 * 
ho¡
;

1570 
Scsi_Cmnd
 * 
SC²t
;

1571 #ifdeà
FOO_ON_YOU


1574 
tim”_bË
[
SCSI_TIMER
].
â
 = 
scsi_maš_timeout
;

1575 
tim”_bË
[
SCSI_TIMER
].
expœes
 = 0;

1578 
memÜy_¡¬t
 = 
	`scsi_š™
(memÜy_¡¬t, 
memÜy_’d
);

1580 
scsi_deviûs
 = (
Scsi_Deviû
 *è
memÜy_¡¬t
;

1581 
	`sÿn_scsis
();

1582 
memÜy_¡¬t
 +ğ
NR_SCSI_DEVICES
 * (
Scsi_Deviû
);

1584 
memÜy_¡¬t
 = 
	`sd_š™1
(memÜy_¡¬t, 
memÜy_’d
);

1585 
memÜy_¡¬t
 = 
	`¡_š™1
(memÜy_¡¬t, 
memÜy_’d
);

1586 
memÜy_¡¬t
 = 
	`¤_š™1
(memÜy_¡¬t, 
memÜy_’d
);

1587 
memÜy_¡¬t
 = 
	`sg_š™1
(memÜy_¡¬t, 
memÜy_’d
);

1589 
Ï¡_cmnd
 = (
Scsi_Cmnd
 *è
memÜy_¡¬t
;

1591 
SC²t
 = 
Ï¡_cmnd
;

1593 
i
=0; i< 
NR_SCSI_DEVICES
; i++) {

1594 
j
;

1595 
scsi_deviûs
[
i
].
ty³
)

1597 
TYPE_TAPE
 :

1598 
	`¡_©ch
(&
scsi_deviûs
[
i
]);

1600 
TYPE_ROM
:

1601 
	`¤_©ch
(&
scsi_deviûs
[
i
]);

1603 
TYPE_DISK
:

1604 
TYPE_MOD
:

1605 
	`sd_©ch
(&
scsi_deviûs
[
i
]);

1609 
	`sg_©ch
(&
scsi_deviûs
[
i
]);

1610 if(
scsi_deviûs
[
i
].
ty³
 != -1){

1611 
j
=0;j<
scsi_deviûs
[
i
].
ho¡
->
ho¡t
->
cmd_³r_lun
;j++){

1612 
SC²t
->
ho¡
 = 
scsi_deviûs
[
i
].host;

1613 
SC²t
->
rg‘
 = 
scsi_deviûs
[
i
].
id
;

1614 
SC²t
->
lun
 = 
scsi_deviûs
[
i
].lun;

1615 
SC²t
->
šdex
 = 
i
;

1616 
SC²t
->
»que¡
.
dev
 = -1;

1617 
SC²t
->
u£_sg
 = 0;

1618 
SC²t
->
Şd_u£_sg
 = 0;

1619 
SC²t
->
und”æow
 = 0;

1620 
SC²t
->
Œªsãrsize
 = 0;

1621 
SC²t
->
ho¡_süibbË
 = 
NULL
;

1622 
ho¡
 = 
scsi_deviûs
[
i
].host;

1623 if(
ho¡
->
ho¡_queue
)

1624 
ho¡
->
ho¡_queue
->
´ev
 = 
SC²t
;

1625 
SC²t
->
Ãxt
 = 
ho¡
->
ho¡_queue
;

1626 
SC²t
->
´ev
 = 
NULL
;

1627 
ho¡
->
ho¡_queue
 = 
SC²t
;

1628 
SC²t
++;

1633 
memÜy_¡¬t
 = (è
SC²t
;

1635 ià(
NR_SD
 > 0 || 
NR_SR
 > 0 || 
NR_ST
 > 0)

1636 
dma_£ùÜs
 = 16;

1638 
i
 = 0; i < 
NR_SCSI_DEVICES
; ++i) {

1639 
Scsi_Ho¡
 * 
ho¡
;

1640 
ho¡
 = 
scsi_deviûs
[
i
].host;

1642 if(
scsi_deviûs
[
i
].
ty³
 !ğ
TYPE_TAPE
)

1643 
dma_£ùÜs
 +ğ((
ho¡
->
sg_bËsize
 *

1644 (
sÿ‰”li¡
) + 511) >> 9) *

1645 
ho¡
->
ho¡t
->
cmd_³r_lun
;

1647 if(
ho¡
->
unchecked_i§_dma
 &&

1648 
memÜy_’d
 > 
ISA_DMA_THRESHOLD
 &&

1649 
scsi_deviûs
[
i
].
ty³
 !ğ
TYPE_TAPE
) {

1650 
dma_£ùÜs
 +ğ(
PAGE_SIZE
 >> 9è* 
ho¡
->
sg_bËsize
 *

1651 
ho¡
->
ho¡t
->
cmd_³r_lun
;

1652 
Ãed_i§_bufãr
++;

1656 
dma_£ùÜs
 = (dma_sectors + 15) & 0xfff0;

1657 
dma_ä“_£ùÜs
 = 
dma_£ùÜs
;

1659 
memÜy_¡¬t
 = (memory_start + 3) & 0xfffffffc;

1660 
dma_m®loc_ä“li¡
 = (*è
memÜy_¡¬t
;

1661 
memÜy_¡¬t
 +ğ
dma_£ùÜs
 >> 3;

1662 
	`mem£t
(
dma_m®loc_ä“li¡
, 0, 
dma_£ùÜs
 >> 3);

1664 if(
memÜy_¡¬t
 & 1) memory_start++;

1666 
dma_m®loc_bufãr
 = (*è
memÜy_¡¬t
;

1667 
memÜy_¡¬t
 +ğ
dma_£ùÜs
 << 9;

1669 
memÜy_¡¬t
 = 
	`sd_š™
(memÜy_¡¬t, 
memÜy_’d
);

1670 
memÜy_¡¬t
 = 
	`¡_š™
(memÜy_¡¬t, 
memÜy_’d
);

1671 
memÜy_¡¬t
 = 
	`¤_š™
(memÜy_¡¬t, 
memÜy_’d
);

1672 
memÜy_¡¬t
 = 
	`sg_š™
(memÜy_¡¬t, 
memÜy_’d
);

1674  
memÜy_¡¬t
;

1675 
	}
}

1677 
	$´št_šquœy
(*
d©a
)

1679 
i
;

1681 
	`´štk
(" Vendor: ");

1682 
i
 = 8; i < 16; i++)

1684 ià(
d©a
[
i
] >= 0x20 && i < data[4] + 5)

1685 
	`´štk
("%c", 
d©a
[
i
]);

1687 
	`´štk
(" ");

1690 
	`´štk
(" Model: ");

1691 
i
 = 16; i < 32; i++)

1693 ià(
d©a
[
i
] >= 0x20 && i < data[4] + 5)

1694 
	`´štk
("%c", 
d©a
[
i
]);

1696 
	`´štk
(" ");

1699 
	`´štk
(" Rev: ");

1700 
i
 = 32; i < 36; i++)

1702 ià(
d©a
[
i
] >= 0x20 && i < data[4] + 5)

1703 
	`´štk
("%c", 
d©a
[
i
]);

1705 
	`´štk
(" ");

1708 
	`´štk
("\n");

1710 
i
 = 
d©a
[0] & 0x1f;

1712 
	`´štk
(" Type: %s ",

1713 
i
 < 
MAX_SCSI_DEVICE_CODE
 ? 
scsi_deviû_ty³s
[i] : "Unknown " );

1714 
	`´štk
(" ANSI SCSI„evisiÚ: %02x", 
d©a
[2] & 0x07);

1715 ià((
d©a
[2] & 0x07) == 1 && (data[3] & 0x0f) == 1)

1716 
	`´štk
(" CCS\n");

1718 
	`´štk
("\n");

1719 
	}
}

	@drivers/scsi/scsi.h

13 #iâdeà
_SCSI_H


14 
	#_SCSI_H


	)

28 
	#TEST_UNIT_READY
 0x00

	)

29 
	#REZERO_UNIT
 0x01

	)

30 
	#REQUEST_SENSE
 0x03

	)

31 
	#FORMAT_UNIT
 0x04

	)

32 
	#READ_BLOCK_LIMITS
 0x05

	)

33 
	#REASSIGN_BLOCKS
 0x07

	)

34 
	#READ_6
 0x08

	)

35 
	#WRITE_6
 0x0a

	)

36 
	#SEEK_6
 0x0b

	)

37 
	#READ_REVERSE
 0x0f

	)

38 
	#WRITE_FILEMARKS
 0x10

	)

39 
	#SPACE
 0x11

	)

40 
	#INQUIRY
 0x12

	)

41 
	#RECOVER_BUFFERED_DATA
 0x14

	)

42 
	#MODE_SELECT
 0x15

	)

43 
	#RESERVE
 0x16

	)

44 
	#RELEASE
 0x17

	)

45 
	#COPY
 0x18

	)

46 
	#ERASE
 0x19

	)

47 
	#MODE_SENSE
 0x1a

	)

48 
	#START_STOP
 0x1b

	)

49 
	#RECEIVE_DIAGNOSTIC
 0x1c

	)

50 
	#SEND_DIAGNOSTIC
 0x1d

	)

51 
	#ALLOW_MEDIUM_REMOVAL
 0x1e

	)

53 
	#READ_CAPACITY
 0x25

	)

54 
	#READ_10
 0x28

	)

55 
	#WRITE_10
 0x2a

	)

56 
	#SEEK_10
 0x2b

	)

57 
	#WRITE_VERIFY
 0x2e

	)

58 
	#VERIFY
 0x2f

	)

59 
	#SEARCH_HIGH
 0x30

	)

60 
	#SEARCH_EQUAL
 0x31

	)

61 
	#SEARCH_LOW
 0x32

	)

62 
	#SET_LIMITS
 0x33

	)

63 
	#PRE_FETCH
 0x34

	)

64 
	#READ_POSITION
 0x34

	)

65 
	#SYNCRONIZE_CACHE
 0x35

	)

66 
	#LOCK_UNLOCK_CACHE
 0x36

	)

67 
	#READ_DEFECT_DATA
 0x37

	)

68 
	#COMPARE
 0x39

	)

69 
	#COPY_VERIFY
 0x3a

	)

70 
	#WRITE_BUFFER
 0x3b

	)

71 
	#READ_BUFFER
 0x3c

	)

72 
	#READ_LONG
 0x3e

	)

73 
	#CHANGE_DEFINITION
 0x40

	)

74 
	#LOG_SELECT
 0x4c

	)

75 
	#LOG_SENSE
 0x4d

	)

76 
	#MODE_SELECT_10
 0x55

	)

77 
	#MODE_SENSE_10
 0x5a

	)

79 cÚ¡ 
scsi_commªd_size
[8];

80 
	#COMMAND_SIZE
(
İcode
è
scsi_commªd_size
[((İcodeè>> 5è& 7]

	)

86 
	#COMMAND_COMPLETE
 0x00

	)

87 
	#EXTENDED_MESSAGE
 0x01

	)

88 
	#SAVE_POINTERS
 0x02

	)

89 
	#RESTORE_POINTERS
 0x03

	)

90 
	#DISCONNECT
 0x04

	)

91 
	#INITIATOR_ERROR
 0x05

	)

92 
	#ABORT
 0x06

	)

93 
	#MESSAGE_REJECT
 0x07

	)

94 
	#NOP
 0x08

	)

95 
	#MSG_PARITY_ERROR
 0x09

	)

96 
	#LINKED_CMD_COMPLETE
 0x0a

	)

97 
	#LINKED_FLG_CMD_COMPLETE
 0x0b

	)

98 
	#BUS_DEVICE_RESET
 0x0c

	)

100 
	#SIMPLE_QUEUE_TAG
 0x20

	)

101 
	#HEAD_OF_QUEUE_TAG
 0x21

	)

102 
	#ORDERED_QUEUE_TAG
 0x22

	)

104 
	#IDENTIFY_BASE
 0x80

	)

105 
	#IDENTIFY
(
ÿn_discÚÃù
, 
lun
è(
IDENTIFY_BASE
 |\

106 ((
ÿn_discÚÃù
) ? 0x40 : 0) |\

107 ((
lun
è& 0x07))

	)

114 
	#GOOD
 0x00

	)

115 
	#CHECK_CONDITION
 0x01

	)

116 
	#CONDITION_GOOD
 0x02

	)

117 
	#BUSY
 0x04

	)

118 
	#INTERMEDIATE_GOOD
 0x08

	)

119 
	#INTERMEDIATE_C_GOOD
 0x0a

	)

120 
	#RESERVATION_CONFLICT
 0x0c

	)

122 
	#STATUS_MASK
 0x1e

	)

144 
	#DID_OK
 0x00

	)

146 
	#DID_NO_CONNECT
 0x01

	)

148 
	#DID_BUS_BUSY
 0x02

	)

150 
	#DID_TIME_OUT
 0x03

	)

152 
	#DID_BAD_TARGET
 0x04

	)

154 
	#DID_ABORT
 0x05

	)

158 
	#DID_PARITY
 0x06

	)

162 
	#DID_ERROR
 0x07

	)

166 
	#DID_RESET
 0x08

	)

170 
	#DID_BAD_INTR
 0x09

	)

175 
	#DRIVER_OK
 0x00

	)

181 
	#DRIVER_BUSY
 0x01

	)

182 
	#DRIVER_SOFT
 0x02

	)

183 
	#DRIVER_MEDIA
 0x03

	)

184 
	#DRIVER_ERROR
 0x04

	)

186 
	#DRIVER_INVALID
 0x05

	)

187 
	#DRIVER_TIMEOUT
 0x06

	)

188 
	#DRIVER_HARD
 0x07

	)

190 
	#SUGGEST_RETRY
 0x10

	)

191 
	#SUGGEST_ABORT
 0x20

	)

192 
	#SUGGEST_REMAP
 0x30

	)

193 
	#SUGGEST_DIE
 0x40

	)

194 
	#SUGGEST_SENSE
 0x80

	)

195 
	#SUGGEST_IS_OK
 0xff

	)

197 
	#DRIVER_SENSE
 0x08

	)

199 
	#DRIVER_MASK
 0x0f

	)

200 
	#SUGGEST_MASK
 0xf0

	)

207 
	#NO_SENSE
 0x00

	)

208 
	#RECOVERED_ERROR
 0x01

	)

209 
	#NOT_READY
 0x02

	)

210 
	#MEDIUM_ERROR
 0x03

	)

211 
	#HARDWARE_ERROR
 0x04

	)

212 
	#ILLEGAL_REQUEST
 0x05

	)

213 
	#UNIT_ATTENTION
 0x06

	)

214 
	#DATA_PROTECT
 0x07

	)

215 
	#BLANK_CHECK
 0x08

	)

216 
	#COPY_ABORTED
 0x0a

	)

217 
	#ABORTED_COMMAND
 0x0b

	)

218 
	#VOLUME_OVERFLOW
 0x0d

	)

219 
	#MISCOMPARE
 0x0e

	)

227 
	#TYPE_DISK
 0x00

	)

228 
	#TYPE_TAPE
 0x01

	)

229 
	#TYPE_WORM
 0x04

	)

230 
	#TYPE_ROM
 0x05

	)

231 
	#TYPE_MOD
 0x07

	)

232 
	#TYPE_NO_LUN
 0x7f

	)

235 
	#MAX_COMMAND_SIZE
 12

	)

241 
	#SCSI_UNKNOWN
 0

	)

242 
	#SCSI_1
 1

	)

243 
	#SCSI_1_CCS
 2

	)

244 
	#SCSI_2
 3

	)

260 
	sscsi_deviû
 {

261 
	mid
, 
	mlun
, 
	mšdex
;

262 
	macûss_couÁ
;

263 
wa™_queue
 * 
	mdeviû_wa™
;

264 
Scsi_Ho¡
 * 
	mho¡
;

265 
	mty³
;

266 
	mscsi_Ëv–
;

267 
	mwr™—bË
:1;

268 
	m»movabË
:1;

269 
	m¿ndom
:1;

270 
	mchªged
:1;

271 
	mbusy
:1;

272 
	mlockabË
:1;

273 
	mbÜk’
:1;

275 
	mgged_suµÜ‹d
:1;

276 
	mgged_queue
:1;

277 
	mdiscÚÃù
:1;

278 
	mcu¼’t_g
;

279 } 
	tScsi_Deviû
;

284 
	#¡©us_by‹
(
»suÉ
è((ÔesuÉè>> 1è& 0xf)

	)

285 
	#msg_by‹
(
»suÉ
è((ÔesuÉè>> 8è& 0xff)

	)

286 
	#ho¡_by‹
(
»suÉ
è((ÔesuÉè>> 16è& 0xff)

	)

287 
	#driv”_by‹
(
»suÉ
è((ÔesuÉè>> 24è& 0xff)

	)

288 
	#suge¡iÚ
(
»suÉ
è(
	`driv”_by‹
ÔesuÉè& 
SUGGEST_MASK
)

	)

290 
	#£n£_şass
(
£n£
è(((£n£è>> 4è& 0x7)

	)

291 
	#£n£_”rÜ
(
£n£
è((£n£è& 0xf)

	)

292 
	#£n£_v®id
(
£n£
è((£n£è& 0x80);

	)

298 
NR_SCSI_DEVICES
;

299 
Scsi_Deviû
 * 
scsi_deviûs
;

304 
scsi_dev_š™
 (, );

306 
	ssÿ‰”li¡
 {

307 * 
	madd»ss
;

308 * 
	m®t_add»ss
;

310 
	mËngth
;

313 
	#ISA_DMA_THRESHOLD
 (0x00ffffff)

	)

315 * 
scsi_m®loc
();

316 
scsi_ä“
(*, );

317 
dma_ä“_£ùÜs
;

318 
Ãed_i§_bufãr
;

325 
	sscsi_poš‹r
 {

326 * 
	m±r
;

327 
	mthis_»sidu®
;

328 
sÿ‰”li¡
 *
	mbufãr
;

329 
	mbufãrs_»sidu®
;

331 vŞ©
	mStus
;

332 vŞ©
	mMes§ge
;

333 vŞ©
	mhave_d©a_š
;

334 vŞ©
	m£Á_commªd
;

335 vŞ©
	mpha£
;

336 } 
	tScsi_Poš‹r
;

338 
	sscsi_cmnd
 {

339 
Scsi_Ho¡
 * 
	mho¡
;

340 
	mrg‘
, 
	mlun
, 
	mšdex
;

341 
scsi_cmnd
 *
	mÃxt
, *
	m´ev
;

344 
	mcmnd
[12];

345 
	m»que¡_bufæ’
;

347 * 
	m»que¡_bufãr
;

350 
	md©a_cmnd
[12];

351 
	mŞd_u£_sg
;

353 
	mu£_sg
;

354 
	msgli¡_Ën
;

355 
	mbufæ’
;

356 *
	mbufãr
;

358 
	mund”æow
;

361 
	mŒªsãrsize
;

367 
»que¡
 
	m»que¡
;

369 
	m£n£_bufãr
[16];

372 
	m»Œ›s
;

373 
	m®lowed
;

374 
	mtimeout_³r_commªd
, 
	mtimeout_tÙ®
, 
	mtimeout
;

380 vŞ©
	mš‹º®_timeout
;

382 
	mæags
;

386 
	mthis_couÁ
;

391 (*
	mscsi_dÚe
)(
	mscsi_cmnd
 *);

393 (*
	mdÚe
)(
	mscsi_cmnd
 *);

398 
Scsi_Poš‹r
 
	mSCp
;

400 * 
	mho¡_süibbË
;

408 
	m»suÉ
;

410 
	mg
;

411 } 
	tScsi_Cmnd
;

419 
scsi_abÜt
 (
Scsi_Cmnd
 *, 
code
);

421 
scsi_do_cmd
 (
Scsi_Cmnd
 *, cÚ¡ *
cmnd
 ,

422 *
bufãr
, 
bufæ’
, (*
dÚe
)(
scsi_cmnd
 *),

423 
timeout
, 
»Œ›s
);

426 
Scsi_Cmnd
 * 
	`®loÿ‹_deviû
(
»que¡
 **, , );

428 
Scsi_Cmnd
 * 
	`»que¡_queu—bË
(
»que¡
 *, );

430 
	`scsi_»£t
 (
Scsi_Cmnd
 *);

432 
max_scsi_ho¡s
;

433 
MAX_SD
, 
NR_SD
, 
MAX_ST
, 
NR_ST
, 
MAX_SR
, 
NR_SR
, 
NR_SG
, 
MAX_SG
;

434 
	`sd_š™
(, );

435 
	`sd_š™1
(, );

436 
	`sd_©ch
(
Scsi_Deviû
 *);

438 
	`¤_š™
(, );

439 
	`¤_š™1
(, );

440 
	`¤_©ch
(
Scsi_Deviû
 *);

442 
	`¡_š™
(, );

443 
	`¡_š™1
(, );

444 
	`¡_©ch
(
Scsi_Deviû
 *);

446 
	`sg_š™
(, );

447 
	`sg_š™1
(, );

448 
	`sg_©ch
(
Scsi_Deviû
 *);

450 #ià
	`defšed
(
MAJOR_NR
è&& (MAJOR_NR !ğ
SCSI_TAPE_MAJOR
)

451 
	$’d_scsi_»que¡
(
Scsi_Cmnd
 * 
SC²t
, 
u±od©e
, 
£ùÜs
)

453 
»que¡
 * 
»q
;

454 
bufãr_h—d
 * 
bh
;

455 
sk_¡ruù
 * 
p
;

457 
»q
 = &
SC²t
->
»que¡
;

458 
»q
->
”rÜs
 = 0;

459 ià(!
u±od©e
) {

460 
	`´štk
(
DEVICE_NAME
 " I/Oƒrror: dev %04x, sector %lu\n",

461 
»q
->
dev
,»q->
£ùÜ
);

465 ià((
bh
 = 
»q
->bhè!ğ
NULL
) {

466 
»q
->
bh
 = bh->
b_»qÃxt
;

467 
»q
->
Ä_£ùÜs
 -ğ
bh
->
b_size
 >> 9;

468 
»q
->
£ùÜ
 +ğ
bh
->
b_size
 >> 9;

469 
bh
->
b_»qÃxt
 = 
NULL
;

470 
bh
->
b_u±od©e
 = 
u±od©e
;

471 
	`uÆock_bufãr
(
bh
);

472 
£ùÜs
 -ğ
bh
->
b_size
 >> 9;

473 ià((
bh
 = 
»q
->bhè!ğ
NULL
) {

474 
»q
->
cu¼’t_Ä_£ùÜs
 = 
bh
->
b_size
 >> 9;

475 ià(
»q
->
Ä_£ùÜs
 <„eq->
cu¼’t_Ä_£ùÜs
) {

476 
»q
->
Ä_£ùÜs
 =„eq->
cu¼’t_Ä_£ùÜs
;

477 
	`´štk
("end_scsi_request: buffer-list destroyed\n");

481 } 
£ùÜs
 && 
bh
);

482 ià(
»q
->
bh
){

483 
»q
->
bufãr
 = 
bh
->
b_d©a
;

486 
	`DEVICE_OFF
(
»q
->
dev
);

487 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

488 
»q
->
wa™šg
 = 
NULL
;

489 
p
->
¡©e
 = 
TASK_RUNNING
;

490 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

491 
Ãed_»sched
 = 1;

493 
»q
->
dev
 = -1;

494 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

496 
	}
}

503 
	#INIT_SCSI_REQUEST
 \

504 ià(!
CURRENT
) {\

505 
CLEAR_INTR
; \

506 
	`¡i
(); \

509 ià(
	`MAJOR
(
CURRENT
->
dev
è!ğ
MAJOR_NR
) \

510 
	`·nic
(
DEVICE_NAME
 ":„equest†ist destroyed"); \

511 ià(
CURRENT
->
bh
) { \

512 ià(!
CURRENT
->
bh
->
b_lock
) \

513 
	`·nic
(
DEVICE_NAME
 ": block‚ot†ocked"); \

514 }

	)

517 
	#SCSI_SLEEP
(
QUEUE
, 
CONDITION
) { \

518 ià(
CONDITION
) { \

519 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
}; \

520 
	`add_wa™_queue
(
QUEUE
, &
wa™
); \

521 
¦“p_»³©
: \

522 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
; \

523 ià(
CONDITION
) { \

524 
	`scheduË
(); \

525 
¦“p_»³©
; \

527 
	`»move_wa™_queue
(
QUEUE
, &
wa™
); \

528 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
; \

529 }; }

	)

	@drivers/scsi/scsi_debug.c

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/tim”.h
>

13 
	~<lšux/h—d.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/g’hd.h
>

17 
	~<lšux/fs.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/io.h
>

22 
	~"../block/blk.h
"

23 
	~"scsi.h
"

24 
	~"ho¡s.h
"

27 
	gNR_REAL
=-1;

29 
	#MAJOR_NR
 
SCSI_DISK_MAJOR


	)

30 
	#START_PARTITION
 4

	)

31 
	#SCSI_DEBUG_TIMER
 20

	)

33 
	#DISK_SPEED
 10

	)

34 
	#CAPACITY
 (0x80000)

	)

36 
	g¡¬ts
[] = {4, 1000, 50000, 
CAPACITY
, 0};

37 
	gÅ¬t
 = 0;

39 
	~"scsi_debug.h
"

40 #ifdeà
DEBUG


41 
	#DEB
(
x
è
	)
x

43 
	#DEB
(
x
)

	)

46 
	#VERIFY1_DEBUG
(
RW
) \

47 ià(
bufæ’
 !ğ1024è{
	`´štk
("%d", bufæ’); 
	`·nic
("(1)Bad bufflen");}; \

48 
¡¬t
 = 0; \

49 ià((
SC²t
->
»que¡
.
dev
 & 0xfè!ğ0è
¡¬t
 = 
¡¬ts
[(SCpnt->request.dev & 0xf) - 1]; \

50 ià(
bh
){ \

51 ià(
bh
->
b_size
 !ğ1024è
	`·nic
 ("Wrong bh size"); \

52 ià((
bh
->
b_blockÄ
 << 1è+ 
¡¬t
 !ğ
block
) \

53 { 
	`´štk
("WrÚg bh block# %d %d ",
bh
->
b_blockÄ
, 
block
); \

54 
	`·nic
 ("Wrong bh block#");}; \

55 ià(
bh
->
b_dev
 !ğ
SC²t
->
»que¡
.
dev
è
	`·nic
 ("Bad bharget");\

56 };

	)

61 ià((
	gSC²t
->
	g»que¡
.
	gdev
 & 0xfff0è!ğ((
rg‘
 + 
NR_REAL
è<< 4è+(
MAJOR_NR
 << 8)){ \

62 
´štk
("Dev # %x %x ",
SC²t
->
»que¡
.
dev
, 
rg‘
); \

63 
·nic
 ("Badarget");}; \

67 
	#VERIFY_DEBUG
(
RW
) \

68 ià(
bufæ’
 !ğ1024 && (!
SC²t
->
u£_sg
)è{
	`´štk
("%x %d\À",bufæ’, SC²t->u£_sg); 
	`·nic
("Bad bufflen");}; \

69 
¡¬t
 = 0; \

70 ià((
SC²t
->
»que¡
.
dev
 & 0xfè> 
Å¬t
è
	`·nic
 ("Bad…artition"); \

71 ià((
SC²t
->
»que¡
.
dev
 & 0xfè!ğ0è
¡¬t
 = 
¡¬ts
[(SCpnt->request.dev & 0xf) - 1]; \

72 ià(
SC²t
->
»que¡
.
cmd
 !ğ
RW
è
	`·nic
 ("Wrong operation"); \

73 ià(
SC²t
->
»que¡
.
£ùÜ
 + 
¡¬t
 !ğ
block
è
	`·nic
("Wrong block."); \

74 ià(
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
 !ğ2 && (!SC²t->
u£_sg
)è
	`·nic
 ("Wrong # blocks"); \

75 ià(
SC²t
->
»que¡
.
bh
){ \

76 ià(
SC²t
->
»que¡
.
bh
->
b_size
 !ğ1024è
	`·nic
 ("Wrong bh size"); \

77 ià((
SC²t
->
»que¡
.
bh
->
b_blockÄ
 << 1è+ 
¡¬t
 !ğ
block
) \

78 { 
	`´štk
("WrÚg bh block# %d %d ",
SC²t
->
»que¡
.
bh
->
b_blockÄ
, 
block
); \

79 
	`·nic
 ("Wrong bh block#");}; \

80 ià(
SC²t
->
»que¡
.
bh
->
b_dev
 !ğSC²t->»que¡.
dev
è
	`·nic
 ("Bad bharget");\

81 };

	)

83 vŞ©(*
do_dÚe
[
SCSI_DEBUG_MAILBOXES
])(
Scsi_Cmnd
 *èğ{
NULL
, 
	}
};

84 
	gscsi_debug_ho¡
 = 0;

85 
scsi_debug_š‹¼u±
();

87 vŞ©
Scsi_Cmnd
 * 
	gSCšt
[
SCSI_DEBUG_MAILBOXES
] = {
NULL
,};

88 vŞ©
	gtimeout
[
SCSI_DEBUG_MAILBOXES
] ={0,};

90 
	g£n£_bufãr
[128] = {0,};

92 
	$scsi_dump
(
Scsi_Cmnd
 * 
SC²t
, 
æag
){

93 
i
;

95 * 
²t
;

97 * 
ÍÁ
;

98 
sÿ‰”li¡
 * 
sg²t
 = 
NULL
;

99 
	`´štk
("u£_sg: %d",
SC²t
->
u£_sg
);

100 ià(
SC²t
->
u£_sg
){

101 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
bufãr
;

102 
i
=0; i<
SC²t
->
u£_sg
; i++) {

103 
ÍÁ
 = (*è
sg²t
[
i
].
®t_add»ss
;

104 
	`´štk
(":%x %x %d\n",
sg²t
[
i
].
®t_add»ss
, sg²t[i].
add»ss
, sg²t[i].
Ëngth
);

105 ià(
ÍÁ
è
	`´štk
(" (Alt %x) ",lpnt[15]);

108 
	`´štk
("nosg: %x %x %d\n",
SC²t
->
»que¡
.
bufãr
, SCpnt->buffer,

109 
SC²t
->
bufæ’
);

110 
ÍÁ
 = (*è
SC²t
->
»que¡
.
bufãr
;

111 ià(
ÍÁ
è
	`´štk
(" (Alt %x) ",lpnt[15]);

113 
ÍÁ
 = (*è
SC²t
;

114 
i
=0;i<(
Scsi_Cmnd
)/4+1; i++) {

115 ià((
i
 & 7è=ğ0è
	`´štk
("\n");

116 
	`´štk
("%x ",*
ÍÁ
++);

118 
	`´štk
("\n");

119 ià(
æag
 == 0) ;

120 
ÍÁ
 = (*è
sg²t
[0].
®t_add»ss
;

121 
i
=0;i<(
Scsi_Cmnd
)/4+1; i++) {

122 ià((
i
 & 7è=ğ0è
	`´štk
("\n");

123 
	`´štk
("%x ",*
ÍÁ
++);

126 
	`´štk
("\n");

127 
ÍÁ
 = (*è
sg²t
[0].
add»ss
;

128 
i
=0;i<(
Scsi_Cmnd
)/4+1; i++) {

129 ià((
i
 & 7è=ğ0è
	`´štk
("\n");

130 
	`´štk
("%x ",*
ÍÁ
++);

132 
	`´štk
("\n");

134 
	`´štk
("DMA f»%d seùÜs.\n", 
dma_ä“_£ùÜs
);

135 
	}
}

137 
scsi_debug_queuecommªd
(
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

139 
unch¬
 *
cmd
 = (unch¬ *è
SC²t
->
cmnd
;

140 
·¹™iÚ
 * 
p
;

141 
block
, 
¡¬t
;

142 
bufãr_h—d
 * 
bh
 = 
NULL
;

143 * 
buff
;

144 
nby‹s
, 
sgcouÁ
;

145 
scsi_debug_”r¡s
;

146 
sÿ‰”li¡
 * 
sg²t
;

147 
rg‘
 = 
SC²t
->target;

148 
bufæ’
 = 
SC²t
->
»que¡_bufæ’
;

149 
i
;

150 
sgcouÁ
 = 0;

151 
sg²t
 = 
NULL
;

153 
	`DEB
(ià(
rg‘
 > 1è{ 
SC²t
->
»suÉ
 = 
DID_TIME_OUT
 << 16;
	`dÚe
(SCpnt); 0;});

155 
buff
 = (*è
SC²t
->
»que¡_bufãr
;

157 if(
rg‘
>=2 || 
SC²t
->
lun
 != 0) {

158 
SC²t
->
»suÉ
 = 
DID_NO_CONNECT
 << 16;

159 
	`dÚe
(
SC²t
);

163 *
cmd
){

164 
REQUEST_SENSE
:

165 
	`´štk
("Request sense...\n");

166 #iâdeà
DEBUG


167 { 
i
;

168 
	`´štk
("scsi_debug: Reque¡šg s’£ bufã¸(%x %x %x %d):", 
SC²t
, 
buff
, 
dÚe
, 
bufæ’
);

169 
i
=0;i<12;i++è
	`´štk
("%d ",
£n£_bufãr
[i]);

170 
	`´štk
("\n");

173 
	`mem£t
(
buff
, 0, 
bufæ’
);

174 
	`memıy
(
buff
, 
£n£_bufãr
, 
bufæ’
);

175 
	`mem£t
(
£n£_bufãr
, 0, (sense_buffer));

176 
SC²t
->
»suÉ
 = 0;

177 
	`dÚe
(
SC²t
);

179 
ALLOW_MEDIUM_REMOVAL
:

180 if(
cmd
[4]è
	`´štk
("Medium„emoval inhibited...");

181 
	`´štk
("Medium„emovalƒnabled...");

182 
scsi_debug_”r¡s
 = 0;

184 
INQUIRY
:

185 
	`´štk
("Inquœy...(%x %d)\n", 
buff
, 
bufæ’
);

186 
	`mem£t
(
buff
, 0, 
bufæ’
);

187 
buff
[0] = 
TYPE_DISK
;

188 
buff
[1] = 0x80;

189 
buff
[2] = 1;

190 
	`memıy
(&
buff
[8],"Foo Inc",7);

191 
	`memıy
(&
buff
[16],"XYZZY",5);

192 
	`memıy
(&
buff
[32],"1",1);

193 
scsi_debug_”r¡s
 = 0;

195 
TEST_UNIT_READY
:

196 
	`´štk
("Test unit„eady.\n");

197 ià(
buff
)

198 
	`mem£t
(
buff
, 0, 
bufæ’
);

199 
scsi_debug_”r¡s
 = 0;

201 
READ_CAPACITY
:

202 
	`´štk
("Read Capacity\n");

203 if(
NR_REAL
 < 0èNR_REAL = (
SC²t
->
»que¡
.
dev
 >> 4) & 0x0f;

204 
	`mem£t
(
buff
, 0, 
bufæ’
);

205 
buff
[0] = (
CAPACITY
 >> 24);

206 
buff
[1] = (
CAPACITY
 >> 16) & 0xff;

207 
buff
[2] = (
CAPACITY
 >> 8) & 0xff;

208 
buff
[3] = 
CAPACITY
 & 0xff;

209 
buff
[6] = 2;

210 
scsi_debug_”r¡s
 = 0;

212 
READ_10
:

213 
READ_6
:

214 #ifdeà
DEBUG


215 
	`´štk
("Read...");

217 ià((*
cmd
è=ğ
READ_10
)

218 
block
 = 
cmd
[5] + (cmd[4] << 8) + (cmd[3] << 16) + (cmd[2] << 24);

220 
block
 = 
cmd
[3] + (cmd[2] << 8) + ((cmd[1] & 0x1f) << 16);

221 
	`VERIFY_DEBUG
(
READ
);

222 
	`´štk
("Ô%d)",
SC²t
->
»que¡
.
Ä_£ùÜs
);

223 
nby‹s
 = 
bufæ’
;

224 if(
SC²t
->
u£_sg
){

225 
sgcouÁ
 = 0;

226 
sg²t
 = (
sÿ‰”li¡
 *è
buff
;

227 
buff
 = 
sg²t
[
sgcouÁ
].
add»ss
;

228 
bufæ’
 = 
sg²t
[
sgcouÁ
].
Ëngth
;

229 
bh
 = 
SC²t
->
»que¡
.bh;

231 
scsi_debug_”r¡s
 = 0;

233 
	`VERIFY1_DEBUG
(
READ
);

234 
	`mem£t
(
buff
, 0, 
bufæ’
);

237 if(
block
 =ğ0 && 
rg‘
 == 0) {

238 *((*è(
buff
+510)) = 0xAA55;

239 
p
 = (
·¹™iÚ
* ) (
buff
 + 0x1be);

240 
Å¬t
 = 0;

241 
¡¬ts
[
Å¬t
+1]){

242 
p
->
¡¬t_£ù
 = 
¡¬ts
[
Å¬t
];

243 
p
->
Ä_£ùs
 = 
¡¬ts
[
Å¬t
+1] - starts [npart];

244 
p
->
sys_šd
 = 0x81;

245 
p
++;

246 
Å¬t
++;

248 
scsi_debug_”r¡s
 = 0;

251 #ifdeà
DEBUG


252 ià(
SC²t
->
u£_sg
è
	`´štk
("Block %x (%d %d)\n",
block
, SC²t->
»que¡
.
Ä_£ùÜs
,

253 
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
);

256 if(
block
 == 0xfff0) {

257 
£n£_bufãr
[0] = 0x70;

258 
£n£_bufãr
[2] = 
UNIT_ATTENTION
;

259 
¡¬ts
[0] += 10;

260 
¡¬ts
[1] += 10;

261 
¡¬ts
[2] += 10;

263 #ifdeà
DEBUG


264 { 
i
;

265 
	`´štk
("scsi_debug: Filling sense buffer:");

266 
i
=0;i<12;i++è
	`´štk
("%d ",
£n£_bufãr
[i]);

267 
	`´štk
("\n");

270 
scsi_debug_”r¡s
 = (
COMMAND_COMPLETE
 << 8è| (
CHECK_CONDITION
 << 1);

273 
	`mem£t
(
buff
, 0, 
bufæ’
);

274 
	`memıy
(
buff
, &
rg‘
, (target));

275 
	`memıy
(
buff
+(
rg‘
), 
cmd
, 24);

276 
	`memıy
(
buff
+60, &
block
, (block));

277 
	`memıy
(
buff
+64, 
SC²t
, (
Scsi_Cmnd
));

278 
nby‹s
 -ğ
bufæ’
;

279 if(
SC²t
->
u£_sg
){

280 
	`memıy
(
buff
+128, 
bh
, (
bufãr_h—d
));

281 
block
 +ğ
bufæ’
 >> 9;

282 
bh
 = bh->
b_»qÃxt
;

283 
sgcouÁ
++;

284 ià(
nby‹s
) {

285 if(!
bh
è
	`·nic
("Too few blocks for†inked„equest.");

286 
buff
 = 
sg²t
[
sgcouÁ
].
add»ss
;

287 
bufæ’
 = 
sg²t
[
sgcouÁ
].
Ëngth
;

290 } 
nby‹s
);

291 ià(
SC²t
->
u£_sg
 && !
scsi_debug_”r¡s
)

292 if(
bh
è
	`scsi_dump
(
SC²t
, 0);

294 
WRITE_10
:

295 
WRITE_6
:

296 #ifdeà
DEBUG


297 
	`´štk
("Write\n");

299 ià((*
cmd
è=ğ
WRITE_10
)

300 
block
 = 
cmd
[5] + (cmd[4] << 8) + (cmd[3] << 16) + (cmd[2] << 24);

302 
block
 = 
cmd
[3] + (cmd[2] << 8) + ((cmd[1] & 0x1f) << 16);

303 
	`VERIFY_DEBUG
(
WRITE
);

304 
	`´štk
("(w%d)",
SC²t
->
»que¡
.
Ä_£ùÜs
);

305 ià(
SC²t
->
u£_sg
){

306 ià((
bufæ’
 >> 9è!ğ
SC²t
->
»que¡
.
Ä_£ùÜs
)

307 
	`·nic
 ("Tryingo write wrong‚umber of blocks\n");

308 
sg²t
 = (
sÿ‰”li¡
 *è
buff
;

309 
buff
 = 
sg²t
[
sgcouÁ
].
add»ss
;

312 ià(
block
 !ğ*((*è(
buff
+60))) {

313 
	`´štk
("%x %x :",
block
, *((*è(
buff
+60)));

314 
	`scsi_dump
(
SC²t
,1);

315 
	`·nic
("Bad block written.\n");

318 
scsi_debug_”r¡s
 = 0;

321 
	`´štk
("UnknowÀcommªd %d\n",*
cmd
);

322 
SC²t
->
»suÉ
 = 
DID_NO_CONNECT
 << 16;

323 
	`dÚe
(
SC²t
);

327 
	`şi
();

328 
i
=0;i<
SCSI_DEBUG_MAILBOXES
; i++){

329 ià(
SCšt
[
i
] == 0) ;

332 ià(
i
 >ğ
SCSI_DEBUG_MAILBOXES
 || 
SCšt
[i] != 0)

333 
	`·nic
("Unableo findƒmpty SCSI_DEBUG command slot.\n");

335 
SCšt
[
i
] = 
SC²t
;

337 ià(
dÚe
) {

338 
	`DEB
(
	`´štk
("scsi_debug_queuecommand:‚ow waiting for interrupt "););

339 ià(
do_dÚe
[
i
])

340 
	`´štk
("scsi_debug_queuecommand: Two concurrent queuecommand?\n");

342 
do_dÚe
[
i
] = 
dÚe
;

345 
	`´štk
("scsi_debug_queuecommand: done cant be NULL\n");

347 
timeout
[
i
] = 
jiff›s
+
DISK_SPEED
;

350 ià((
tim”_aùive
 & (1 << 
SCSI_DEBUG_TIMER
)) == 0) {

351 
tim”_bË
[
SCSI_DEBUG_TIMER
].
expœes
 = 
timeout
[
i
];

352 
tim”_aùive
 |ğ1 << 
SCSI_DEBUG_TIMER
;

355 
SC²t
->
»suÉ
 = 
scsi_debug_”r¡s
;

356 
	`¡i
();

359 
	`´štk
("S’dšg commªd (%d %x %d %d)...", 
i
, 
dÚe
, 
timeout
[i],
jiff›s
);

363 
	}
}

365 vŞ©
	gš‹º®_dÚe_æag
 = 0;

366 vŞ©
	gš‹º®_dÚe_”rcode
 = 0;

367 
	$š‹º®_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

369 
š‹º®_dÚe_”rcode
 = 
SC²t
->
»suÉ
;

370 ++
š‹º®_dÚe_æag
;

371 
	}
}

373 
	$scsi_debug_commªd
(
Scsi_Cmnd
 * 
SC²t
)

375 
	`DEB
(
	`´štk
("scsi_debug_command: ..calling scsi_debug_queuecommand\n"));

376 
	`scsi_debug_queuecommªd
(
SC²t
, 
š‹º®_dÚe
);

378 !
š‹º®_dÚe_æag
);

379 
š‹º®_dÚe_æag
 = 0;

380  
š‹º®_dÚe_”rcode
;

381 
	}
}

386 
	$scsi_debug_šŒ_hªdË
()

388 
Scsi_Cmnd
 * 
SCtmp
;

389 
i
, 
³ndšg
;

390 (*
my_dÚe
)(
Scsi_Cmnd
 *);

391 
to
;

393 
tim”_bË
[
SCSI_DEBUG_TIMER
].
expœes
 = 0;

394 
tim”_aùive
 &ğ~(1 << 
SCSI_DEBUG_TIMER
);

396 
»³©
:

397 
	`şi
();

398 
i
=0;i<
SCSI_DEBUG_MAILBOXES
; i++) {

399 ià(
SCšt
[
i
] == 0) ;

400 ià(
timeout
[
i
] == 0) ;

401 ià(
timeout
[
i
] <ğ
jiff›s
) ;

404 if(
i
 =ğ
SCSI_DEBUG_MAILBOXES
){

405 
³ndšg
 = 
INT_MAX
;

406 
i
=0;i<
SCSI_DEBUG_MAILBOXES
; i++) {

407 ià(
SCšt
[
i
] == 0) ;

408 ià(
timeout
[
i
] == 0) ;

409 ià(
timeout
[
i
] <ğ
jiff›s
è{
	`¡i
(); 
»³©
;};

410 ià(
timeout
[
i
] > 
jiff›s
) {

411 ià(
³ndšg
 > 
timeout
[
i
])…ending =imeout[i];

415 ià(
³ndšg
 &&…’dšg !ğ
INT_MAX
) {

416 
tim”_bË
[
SCSI_DEBUG_TIMER
].
expœes
 =

417 (
³ndšg
 <ğ
jiff›s
 ? jiffies+1 :…ending);

418 
tim”_aùive
 |ğ1 << 
SCSI_DEBUG_TIMER
;

420 
	`¡i
();

424 if(
i
 < 
SCSI_DEBUG_MAILBOXES
){

425 
timeout
[
i
] = 0;

426 
my_dÚe
 = 
do_dÚe
[
i
];

427 
do_dÚe
[
i
] = 
NULL
;

428 
to
 = 
timeout
[
i
];

429 
timeout
[
i
] = 0;

430 
SCtmp
 = (
Scsi_Cmnd
 *è
SCšt
[
i
];

431 
SCšt
[
i
] = 
NULL
;

432 
	`¡i
();

434 ià(!
my_dÚe
) {

435 
	`´štk
("scsi_debug_intr_handle: Unexpected interrupt\n");

439 #ifdeà
DEBUG


440 
	`´štk
("In intr_handle...");

441 
	`´štk
("...dÚ%d %x %d %d\n",
i
 , 
my_dÚe
, 
to
, 
jiff›s
);

442 
	`´štk
("IÀšŒ_hªdË: %d %x %x\n",
i
, 
SCtmp
, 
my_dÚe
);

445 
	`my_dÚe
(
SCtmp
);

446 #ifdeà
DEBUG


447 
	`´štk
("Called done.\n");

450 
»³©
;

451 
	}
}

454 
	$scsi_debug_d‘eù
(
ho¡num
)

456 
scsi_debug_ho¡
 = 
ho¡num
;

457 
tim”_bË
[
SCSI_DEBUG_TIMER
].
â
 = 
scsi_debug_šŒ_hªdË
;

458 
tim”_bË
[
SCSI_DEBUG_TIMER
].
expœes
 = 0;

460 
	}
}

462 
	$scsi_debug_abÜt
(
Scsi_Cmnd
 * 
SC²t
,
i
)

464 
j
;

465 (*
my_dÚe
)(
Scsi_Cmnd
 *);

466 
	`DEB
(
	`´štk
("scsi_debug_abort\n"));

467 
SC²t
->
»suÉ
 = 
i
 << 16;

468 
j
=0;j<
SCSI_DEBUG_MAILBOXES
; j++) {

469 if(
SC²t
 =ğ
SCšt
[
j
]) {

470 
my_dÚe
 = 
do_dÚe
[
j
];

471 
	`my_dÚe
(
SC²t
);

472 
	`şi
();

473 
timeout
[
j
] = 0;

474 
SCšt
[
j
] = 
NULL
;

475 
do_dÚe
[
j
] = 
NULL
;

476 
	`¡i
();

480 
	}
}

482 
	$scsi_debug_bio¥¬am
(
size
, * 
šfo
){

483 
šfo
[0] = 32;

484 
šfo
[1] = 64;

485 
šfo
[2] = (
size
 + 2047) >> 11;

486 ià(
šfo
[2] >= 1024) info[2] = 1024;

488 
	}
}

490 
	$scsi_debug_»£t
(
Scsi_Cmnd
 * 
SC²t
)

492 
i
;

493 (*
my_dÚe
)(
Scsi_Cmnd
 *);

494 
	`DEB
(
	`´štk
("scsi_debug_reset called\n"));

495 
i
=0;i<
SCSI_DEBUG_MAILBOXES
; i++) {

496 ià(
SCšt
[
i
] =ğ
NULL
) ;

497 
SCšt
[
i
]->
»suÉ
 = 
DID_ABORT
 << 16;

498 
my_dÚe
 = 
do_dÚe
[
i
];

499 
	`my_dÚe
(
SCšt
[
i
]);

500 
	`şi
();

501 
SCšt
[
i
] = 
NULL
;

502 
do_dÚe
[
i
] = 
NULL
;

503 
timeout
[
i
] = 0;

504 
	`¡i
();

507 
	}
}

509 *
	$scsi_debug_šfo
()

511 
bufãr
[] = " ";

512  
bufãr
;

513 
	}
}

	@drivers/scsi/scsi_debug.h

1 #iâdeà
_SCSI_DEBUG_H


3 
	~<lšux/ty³s.h
>

5 
scsi_debug_d‘eù
();

6 
scsi_debug_commªd
(
Scsi_Cmnd
 *);

7 
scsi_debug_queuecommªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

8 
	`scsi_debug_abÜt
(
Scsi_Cmnd
 *, );

9 
	`scsi_debug_bio¥¬am
(, *);

10 *
	`scsi_debug_šfo
();

11 
	`scsi_debug_»£t
(
Scsi_Cmnd
 *);

13 #iâdeà
NULL


14 
	#NULL
 0

	)

17 
	#SCSI_DEBUG_MAILBOXES
 8

	)

19 
	#SCSI_DEBUG
 {"SCSI DEBUG", 
scsi_debug_d‘eù
, \

20 
scsi_debug_šfo
, 
scsi_debug_commªd
, \

21 
scsi_debug_queuecommªd
, \

22 
scsi_debug_abÜt
, \

23 
scsi_debug_»£t
, \

24 
NULL
, \

25 
scsi_debug_bio¥¬am
, \

26 
SCSI_DEBUG_MAILBOXES
, 7, 
SG_ALL
, 1, 0, 1
	}

	)
}

	@drivers/scsi/scsi_ioctl.c

1 
	~<asm/io.h
>

2 
	~<asm/£gm’t.h
>

3 
	~<asm/sy¡em.h
>

5 
	~<lšux/”ºo.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/¡ršg.h
>

10 
	~"../block/blk.h
"

11 
	~"scsi.h
"

12 
	~"ho¡s.h
"

13 
	~"scsi_ioùl.h
"

15 
	#MAX_RETRIES
 5

	)

16 
	#MAX_TIMEOUT
 200

	)

17 
	#MAX_BUF
 4096

	)

19 
	#max
(
a
,
b
è((×è> (b)è? (aè: (b))

	)

28 
	$ioùl_´obe
(
Scsi_Ho¡
 * 
ho¡
, *
bufãr
)

30 
‹mp
;

31 
Ën
,
¦’
;

32 cÚ¡ * 
¡ršg
;

34 ià((
‹mp
 = 
ho¡
->
ho¡t
->
´e£Á
è&& 
bufãr
) {

35 
Ën
 = 
	`g‘_fs_lÚg
 ((*è
bufãr
);

36 
¡ršg
 = 
ho¡
->
ho¡t
->
	`šfo
();

37 
¦’
 = 
	`¡¾’
(
¡ršg
);

38 ià(
Ën
 > 
¦’
)

39 
Ën
 = 
¦’
 + 1;

40 
	`v”ify_¬—
(
VERIFY_WRITE
, 
bufãr
, 
Ën
);

41 
	`memıy_tofs
 (
bufãr
, 
¡ršg
, 
Ën
);

43  
‹mp
;

44 
	}
}

73 
	$scsi_ioùl_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

75 
»que¡
 * 
»q
;

76 
sk_¡ruù
 * 
p
;

78 
»q
 = &
SC²t
->
»que¡
;

79 
»q
->
dev
 = 0xfffe;

81 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

82 
»q
->
wa™šg
 = 
NULL
;

83 
p
->
¡©e
 = 
TASK_RUNNING
;

84 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

85 
Ãed_»sched
 = 1;

87 
	}
}

89 
	$ioùl_š‹º®_commªd
(
Scsi_Deviû
 *
dev
, * 
cmd
)

91 
»suÉ
;

92 
Scsi_Cmnd
 * 
SC²t
;

94 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, 
dev
->
šdex
, 1);

95 
	`scsi_do_cmd
(
SC²t
, 
cmd
, 
NULL
, 0,

96 
scsi_ioùl_dÚe
, 
MAX_TIMEOUT
,

97 
MAX_RETRIES
);

99 ià(
SC²t
->
»que¡
.
dev
 != 0xfffe){

100 
SC²t
->
»que¡
.
wa™šg
 = 
cu¼’t
;

101 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

102 
SC²t
->
»que¡
.
dev
 !ğ0xffãè
	`scheduË
();

105 if(
	`driv”_by‹
(
SC²t
->
»suÉ
) != 0)

106 
SC²t
->
£n£_bufãr
[2] & 0xf) {

107 
ILLEGAL_REQUEST
:

108 if(
cmd
[0] =ğ
ALLOW_MEDIUM_REMOVAL
è
dev
->
lockabË
 = 0;

109 
	`´štk
("SCSI device (ioctl)„eports ILLEGAL REQUEST.\n");

111 
NOT_READY
:

112 if(
dev
->
»movabË
){

113 
	`´štk
("Device‚ot„eady. Make surehere is‡ disc inhe drive.\n");

116 
UNIT_ATTENTION
:

117 ià(
dev
->
»movabË
){

118 
dev
->
chªged
 = 1;

119 
SC²t
->
»suÉ
 = 0;

120 
	`´štk
("Disc change detected.\n");

124 
	`´štk
("SCSI CDƒrror: host %d id %d†un %d„eturn code = %x\n",

125 
dev
->
ho¡
->
ho¡_no
,

126 
dev
->
id
,

127 
dev
->
lun
,

128 
SC²t
->
»suÉ
);

129 
	`´štk
("\tSense class %x, senseƒrror %x,ƒxtended sense %x\n",

130 
	`£n£_şass
(
SC²t
->
£n£_bufãr
[0]),

131 
	`£n£_”rÜ
(
SC²t
->
£n£_bufãr
[0]),

132 
SC²t
->
£n£_bufãr
[2] & 0xf);

136 
»suÉ
 = 
SC²t
->result;

137 
SC²t
->
»que¡
.
dev
 = -1;

138 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

139  
»suÉ
;

140 
	}
}

142 
	$ioùl_commªd
(
Scsi_Deviû
 *
dev
, *
bufãr
)

144 * 
buf
;

145 
cmd
[12];

146 * 
cmd_š
;

147 
Scsi_Cmnd
 * 
SC²t
;

148 
İcode
;

149 
šËn
, 
ou’
, 
cmdËn
;

150 
Ãeded
;

151 
»suÉ
;

153 ià(!
bufãr
)

154  -
EINVAL
;

156 
šËn
 = 
	`g‘_fs_lÚg
((*è
bufãr
);

157 
ou’
 = 
	`g‘_fs_lÚg
Ğ((*è
bufãr
) + 1);

159 
cmd_š
 = (*èĞ((*)
bufãr
) + 2);

160 
İcode
 = 
	`g‘_fs_by‹
(
cmd_š
);

162 
Ãeded
 = (
šËn
 > 
ou’
 ? inlen : outlen);

163 if(
Ãeded
){

164 
Ãeded
 = (needed + 511) & ~511;

165 ià(
Ãeded
 > 
MAX_BUF
)‚eeded = MAX_BUF;

166 
buf
 = (*è
	`scsi_m®loc
(
Ãeded
);

167 ià(!
buf
è -
ENOMEM
;

169 
buf
 = 
NULL
;

171 
	`memıy_äomfs
 ((*è
cmd
, 
cmd_š
, 
cmdËn
 = 
	`COMMAND_SIZE
 (
İcode
));

172 
	`memıy_äomfs
 ((*è
buf
, (*è(
cmd_š
 + 
cmdËn
), 
šËn
 > 
MAX_BUF
 ? MAX_BUF : inlen);

174 
cmd
[1] = ( cmd[1] & 0x1àè| (
dev
->
lun
 << 5);

176 #iâdeà
DEBUG_NO_CMD


178 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, 
dev
->
šdex
, 1);

180 
	`scsi_do_cmd
(
SC²t
, 
cmd
, 
buf
, 
Ãeded
, 
scsi_ioùl_dÚe
, 
MAX_TIMEOUT
,

181 
MAX_RETRIES
);

183 ià(
SC²t
->
»que¡
.
dev
 != 0xfffe){

184 
SC²t
->
»que¡
.
wa™šg
 = 
cu¼’t
;

185 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

186 
SC²t
->
»que¡
.
dev
 !ğ0xffãè
	`scheduË
();

191 if(
SC²t
->
»suÉ
) {

192 
»suÉ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
cmd_š
, (
SC²t
->
£n£_bufãr
));

193 ià(
»suÉ
)

194  
»suÉ
;

195 
	`memıy_tofs
((*è
cmd_š
, 
SC²t
->
£n£_bufãr
, (SCpnt->sense_buffer));

198 
»suÉ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
cmd_š
, (
ou’
 > 
MAX_BUF
) ? MAX_BUF : outlen);

199 ià(
»suÉ
)

200  
»suÉ
;

201 
	`memıy_tofs
 ((*è
cmd_š
, 
buf
, (
ou’
 > 
MAX_BUF
) ? MAX_BUF : outlen);

203 
»suÉ
 = 
SC²t
->result;

204 
SC²t
->
»que¡
.
dev
 = -1;

205 ià(
buf
è
	`scsi_ä“
(buf, 
Ãeded
);

206 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

207  
»suÉ
;

210 
i
;

211 
	`´štk
("scsi_ioùÈ: deviû %d. commªd = ", 
dev
->
id
);

212 
i
 = 0; i < 12; ++i)

213 
	`´štk
("%02x ", 
cmd
[
i
]);

214 
	`´štk
("\nbuffer =");

215 
i
 = 0; i < 20; ++i)

216 
	`´štk
("%02x ", 
buf
[
i
]);

217 
	`´štk
("\n");

218 
	`´štk
("inlen = %d, outlen = %d, cmdlen = %d\n",

219 
šËn
, 
ou’
, 
cmdËn
);

220 
	`´štk
("bufã¸ğ%d, cmd_š = %d\n", 
bufãr
, 
cmd_š
);

224 
	}
}

233 
	$scsi_ioùl
 (
Scsi_Deviû
 *
dev
, 
cmd
, *
¬g
)

235 
scsi_cmd
[12];

237 ià((
cmd
 !ğ0 && 
dev
->
šdex
 > 
NR_SCSI_DEVICES
))

238  -
ENODEV
;

240 
cmd
) {

241 
SCSI_IOCTL_GET_IDLUN
:

242 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

243 
	`put_fs_lÚg
(
dev
->
id
 + (dev->
lun
 << 8) +

244 (
dev
->
ho¡
->
ho¡_no
 << 16), (*è
¬g
);

246 
SCSI_IOCTL_TAGGED_ENABLE
:

247 if(!
	`su£r
()è -
EACCES
;

248 if(!
dev
->
gged_suµÜ‹d
è -
EINVAL
;

249 
dev
->
gged_queue
 = 1;

250 
dev
->
cu¼’t_g
 = 1;

252 
SCSI_IOCTL_TAGGED_DISABLE
:

253 if(!
	`su£r
()è -
EACCES
;

254 if(!
dev
->
gged_suµÜ‹d
è -
EINVAL
;

255 
dev
->
gged_queue
 = 0;

256 
dev
->
cu¼’t_g
 = 0;

258 
SCSI_IOCTL_PROBE_HOST
:

259  
	`ioùl_´obe
(
dev
->
ho¡
, 
¬g
);

260 
SCSI_IOCTL_SEND_COMMAND
:

261 if(!
	`su£r
()è -
EACCES
;

262  
	`ioùl_commªd
((
Scsi_Deviû
 *è
dev
, 
¬g
);

263 
SCSI_IOCTL_DOORLOCK
:

264 ià(!
dev
->
»movabË
 || !dev->
lockabË
)  0;

265 
scsi_cmd
[0] = 
ALLOW_MEDIUM_REMOVAL
;

266 
scsi_cmd
[1] = 
dev
->
lun
 << 5;

267 
scsi_cmd
[2] = scsi_cmd[3] = scsi_cmd[5] = 0;

268 
scsi_cmd
[4] = 
SCSI_REMOVAL_PREVENT
;

269  
	`ioùl_š‹º®_commªd
((
Scsi_Deviû
 *è
dev
, 
scsi_cmd
);

271 
SCSI_IOCTL_DOORUNLOCK
:

272 ià(!
dev
->
»movabË
 || !dev->
lockabË
)  0;

273 
scsi_cmd
[0] = 
ALLOW_MEDIUM_REMOVAL
;

274 
scsi_cmd
[1] = 
dev
->
lun
 << 5;

275 
scsi_cmd
[2] = scsi_cmd[3] = scsi_cmd[5] = 0;

276 
scsi_cmd
[4] = 
SCSI_REMOVAL_ALLOW
;

277  
	`ioùl_š‹º®_commªd
((
Scsi_Deviû
 *è
dev
, 
scsi_cmd
);

278 
SCSI_IOCTL_TEST_UNIT_READY
:

279 
scsi_cmd
[0] = 
TEST_UNIT_READY
;

280 
scsi_cmd
[1] = 
dev
->
lun
 << 5;

281 
scsi_cmd
[2] = scsi_cmd[3] = scsi_cmd[5] = 0;

282 
scsi_cmd
[4] = 0;

283  
	`ioùl_š‹º®_commªd
((
Scsi_Deviû
 *è
dev
, 
scsi_cmd
);

286  -
EINVAL
;

288  -
EINVAL
;

289 
	}
}

296 
	$k”Ãl_scsi_ioùl
 (
Scsi_Deviû
 *
dev
, 
cmd
, *
¬g
) {

297 
Şdfs
;

298 
tmp
;

299 
Şdfs
 = 
	`g‘_fs
();

300 
	`£t_fs
(
	`g‘_ds
());

301 
tmp
 = 
	`scsi_ioùl
 (
dev
, 
cmd
, 
¬g
);

302 
	`£t_fs
(
Şdfs
);

303  
tmp
;

304 
	}
}

	@drivers/scsi/scsi_ioctl.h

1 #iâdeà
_SCSI_IOCTL_H


2 
	#_SCSI_IOCTL_H


	)

4 
	#SCSI_IOCTL_PROBE_HOST
 0

	)

5 
	#SCSI_IOCTL_SEND_COMMAND
 1

	)

6 
	#SCSI_IOCTL_TEST_UNIT_READY
 2

	)

9 
	#SCSI_IOCTL_DOORLOCK
 0x5380

	)

10 
	#SCSI_IOCTL_DOORUNLOCK
 0x5381

	)

12 
	#SCSI_REMOVAL_PREVENT
 1

	)

13 
	#SCSI_REMOVAL_ALLOW
 0

	)

15 
scsi_ioùl
 (
Scsi_Deviû
 *
dev
, 
cmd
, *
¬g
);

16 
k”Ãl_scsi_ioùl
 (
Scsi_Deviû
 *
dev
, 
cmd
, *
¬g
);

	@drivers/scsi/sd.c

13 
	~<lšux/fs.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<asm/sy¡em.h
>

20 
	#MAJOR_NR
 
SCSI_DISK_MAJOR


	)

21 
	~"../block/blk.h
"

22 
	~"scsi.h
"

23 
	~"ho¡s.h
"

24 
	~"sd.h
"

25 
	~"scsi_ioùl.h
"

26 
	~"cÚ¡ªts.h
"

28 
	~<lšux/g’hd.h
>

34 
	#MAX_RETRIES
 5

	)

40 
	#SD_TIMEOUT
 300

	)

42 
hd_¡ruù
 * 
	gsd
;

44 
	gNR_SD
=0;

45 
	gMAX_SD
=0;

46 
Scsi_Disk
 * 
	grscsi_disks
;

47 * 
	gsd_sizes
;

48 * 
	gsd_blocksizes
;

50 
sd_ioùl
(
šode
 *, 
fe
 *, , );

52 
sd_š™_Úedisk
();

54 
»queue_sd_»que¡
 (
Scsi_Cmnd
 * 
SC²t
);

56 
	$sd_İ’
(
šode
 * inode, 
fe
 * 
fp
)

58 
rg‘
;

59 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

61 if(
rg‘
 >ğ
NR_SD
 || !
rscsi_disks
[rg‘].
deviû
)

62  -
ENODEV
;

67 
rscsi_disks
[
rg‘
].
deviû
->
busy
);

69 if(
rscsi_disks
[
rg‘
].
deviû
->
»movabË
) {

70 
	`check_disk_chªge
(
šode
->
i_rdev
);

72 if(!
rscsi_disks
[
rg‘
].
deviû
->
acûss_couÁ
)

73 
	`sd_ioùl
(
šode
, 
NULL
, 
SCSI_IOCTL_DOORLOCK
, 0);

75 
rscsi_disks
[
rg‘
].
deviû
->
acûss_couÁ
++;

77 
	}
}

79 
	$sd_»Ëa£
(
šode
 * inode, 
fe
 * file)

81 
rg‘
;

82 
	`sync_dev
(
šode
->
i_rdev
);

84 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
šode
->
i_rdev
));

86 
rscsi_disks
[
rg‘
].
deviû
->
acûss_couÁ
--;

88 if(
rscsi_disks
[
rg‘
].
deviû
->
»movabË
) {

89 if(!
rscsi_disks
[
rg‘
].
deviû
->
acûss_couÁ
)

90 
	`sd_ioùl
(
šode
, 
NULL
, 
SCSI_IOCTL_DOORUNLOCK
, 0);

92 
	}
}

94 
sd_g’š™
();

96 
fe_İ”©iÚs
 
	gsd_fİs
 = {

97 
NULL
,

98 
block_»ad
,

99 
block_wr™e
,

100 
NULL
,

101 
NULL
,

102 
sd_ioùl
,

103 
NULL
,

104 
sd_İ’
,

105 
sd_»Ëa£
,

106 
block_fsync


109 
g’disk
 
	gsd_g’disk
 = {

110 
MAJOR_NR
,

115 
sd_g’š™
,

116 
NULL
,

117 
NULL
,

119 
NULL
,

120 
NULL


123 
	$sd_g’š™
 ()

125 
i
;

127 
i
 = 0; i < 
NR_SD
; ++i)

128 
sd
[
i
 << 4].
Ä_£ùs
 = 
rscsi_disks
[i].
ÿ·c™y
;

129 
sd_g’disk
.
Ä_»®
 = 
NR_SD
;

130 
	}
}

138 
	$rw_šŒ
 (
Scsi_Cmnd
 *
SC²t
)

140 
»suÉ
 = 
SC²t
->result;

141 
this_couÁ
 = 
SC²t
->
bufæ’
 >> 9;

143 #ifdeà
DEBUG


144 
	`´štk
("sd%d :„w_šŒ(%d, %d)\n", 
	`MINOR
(
SC²t
->
»que¡
.
dev
), SC²t->
ho¡
->
ho¡_no
, 
»suÉ
);

153 ià(!
»suÉ
) {

155 #ifdeà
DEBUG


156 
	`´štk
("sd%d : %d seùÜ »maš.\n", 
	`MINOR
(
SC²t
->
»que¡
.
dev
), SC²t->»que¡.
Ä_£ùÜs
);

157 
	`´štk
("u£_sg i %d\À",
SC²t
->
u£_sg
);

159 ià(
SC²t
->
u£_sg
) {

160 
sÿ‰”li¡
 * 
sg²t
;

161 
i
;

162 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
bufãr
;

163 
i
=0; i<
SC²t
->
u£_sg
; i++) {

164 #ifdeà
DEBUG


165 
	`´štk
(":%x %x %d\n",
sg²t
[
i
].
®t_add»ss
, sg²t[i].
add»ss
, sg²t[i].
Ëngth
);

167 ià(
sg²t
[
i
].
®t_add»ss
) {

168 ià(
SC²t
->
»que¡
.
cmd
 =ğ
READ
)

169 
	`memıy
(
sg²t
[
i
].
®t_add»ss
, sg²t[i].
add»ss
, sg²t[i].
Ëngth
);

170 
	`scsi_ä“
(
sg²t
[
i
].
add»ss
, sg²t[i].
Ëngth
);

173 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
sgli¡_Ën
);

175 ià(
SC²t
->
bufãr
 !ğSC²t->
»que¡
.buffer) {

176 #ifdeà
DEBUG


177 
	`´štk
("nosg: %x %x %d\n",
SC²t
->
»que¡
.
bufãr
, SCpnt->buffer,

178 
SC²t
->
bufæ’
);

180 ià(
SC²t
->
»que¡
.
cmd
 =ğ
READ
)

181 
	`memıy
(
SC²t
->
»que¡
.
bufãr
, SCpnt->buffer,

182 
SC²t
->
bufæ’
);

183 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
bufæ’
);

191 ià(
SC²t
->
»que¡
.
Ä_£ùÜs
 > 
this_couÁ
)

193 
SC²t
->
»que¡
.
”rÜs
 = 0;

195 ià(!
SC²t
->
»que¡
.
bh
)

197 #ifdeà
DEBUG


198 
	`´štk
("sd%d : handling…age„equest,‚o buffer\n",

199 
	`MINOR
(
SC²t
->
»que¡
.
dev
));

205 
	`·nic
("sd.c:†inked…age„equest (%lx %x)",

206 
SC²t
->
»que¡
.
£ùÜ
, 
this_couÁ
);

209 
	`’d_scsi_»que¡
(
SC²t
, 1, 
this_couÁ
);

210 
	`»queue_sd_»que¡
(
SC²t
);

215 ià(
SC²t
->
u£_sg
) {

216 
sÿ‰”li¡
 * 
sg²t
;

217 
i
;

218 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
bufãr
;

219 
i
=0; i<
SC²t
->
u£_sg
; i++) {

220 #ifdeà
DEBUG


221 
	`´štk
("”r: %x %x %d\n",
SC²t
->
»que¡
.
bufãr
, SCpnt->buffer,

222 
SC²t
->
bufæ’
);

224 ià(
sg²t
[
i
].
®t_add»ss
) {

225 
	`scsi_ä“
(
sg²t
[
i
].
add»ss
, sg²t[i].
Ëngth
);

228 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
sgli¡_Ën
);

230 #ifdeà
DEBUG


231 
	`´štk
("nosg”r: %x %x %d\n",
SC²t
->
»que¡
.
bufãr
, SCpnt->buffer,

232 
SC²t
->
bufæ’
);

234 ià(
SC²t
->
bufãr
 !ğSC²t->
»que¡
.buffer)

235 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
bufæ’
);

244 ià(
	`driv”_by‹
(
»suÉ
) != 0) {

245 ià(
	`suge¡iÚ
(
»suÉ
è=ğ
SUGGEST_REMAP
) {

246 #ifdeà
REMAP


251 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
»m­


253 
»suÉ
 = 0;

260 ià((
SC²t
->
£n£_bufãr
[0] & 0x7f) == 0x70) {

261 ià((
SC²t
->
£n£_bufãr
[2] & 0xfè=ğ
UNIT_ATTENTION
) {

262 if(
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
»movabË
) {

266 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
chªged
 = 1;

267 
	`’d_scsi_»que¡
(
SC²t
, 0, 
this_couÁ
);

268 
	`»queue_sd_»que¡
(
SC²t
);

282 ià(
SC²t
->
£n£_bufãr
[2] =ğ
ILLEGAL_REQUEST
) {

283 ià(
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
‹n
) {

284 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
‹n
 = 0;

285 
	`»queue_sd_»que¡
(
SC²t
);

286 
»suÉ
 = 0;

291 ià(
»suÉ
) {

292 
	`´štk
("SCSI diskƒrror : host %d id %d†un %d„eturn code = %x\n",

293 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
ho¡
->
ho¡_no
,

294 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
id
,

295 
rscsi_disks
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
lun
, 
»suÉ
);

297 ià(
	`driv”_by‹
(
»suÉ
è& 
DRIVER_SENSE
)

298 
	`´št_£n£
("sd", 
SC²t
);

299 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
cu¼’t_Ä_£ùÜs
);

300 
	`»queue_sd_»que¡
(
SC²t
);

303 
	}
}

311 
	$do_sd_»que¡
 ()

313 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

314 
»que¡
 * 
»q
 = 
NULL
;

315 
æag
 = 0;

317 
	`şi
();

318 ià(
CURRENT
 !ğ
NULL
 && CURRENT->
dev
 == -1) {

319 
	`¡i
();

323 
INIT_SCSI_REQUEST
;

337 ià(
æag
++ == 0)

338 
SC²t
 = 
	`®loÿ‹_deviû
(&
CURRENT
,

339 
rscsi_disks
[
	`DEVICE_NR
(
	`MINOR
(
CURRENT
->
dev
))].
deviû
->
šdex
, 0);

340 
SC²t
 = 
NULL
;

341 
	`¡i
();

350 ià(!
SC²t
 && 
NR_SD
 > 1){

351 
»que¡
 *
»q1
;

352 
»q1
 = 
NULL
;

353 
	`şi
();

354 
»q
 = 
CURRENT
;

355 
»q
){

356 
SC²t
 = 
	`»que¡_queu—bË
(
»q
,

357 
rscsi_disks
[
	`DEVICE_NR
(
	`MINOR
(
»q
->
dev
))].
deviû
->
šdex
);

358 if(
SC²t
) ;

359 
»q1
 = 
»q
;

360 
»q
 =„eq->
Ãxt
;

362 ià(
SC²t
 && 
»q
->
dev
 == -1) {

363 ià(
»q
 =ğ
CURRENT
)

364 
CURRENT
 = CURRENT->
Ãxt
;

366 
»q1
->
Ãxt
 = 
»q
->next;

368 
	`¡i
();

371 ià(!
SC²t
) ;

373 
	`wake_up
(&
wa™_fÜ_»que¡
);

376 
	`»queue_sd_»que¡
(
SC²t
);

378 
	}
}

380 
	$»queue_sd_»que¡
 (
Scsi_Cmnd
 * 
SC²t
)

382 
dev
, 
block
, 
this_couÁ
;

383 
cmd
[10];

384 * 
buff
;

386 
»³©
:

388 if(
SC²t
->
»que¡
.
dev
 <= 0) {

389 
	`do_sd_»que¡
();

393 
dev
 = 
	`MINOR
(
SC²t
->
»que¡
.dev);

394 
block
 = 
SC²t
->
»que¡
.
£ùÜ
;

395 
this_couÁ
 = 0;

397 #ifdeà
DEBUG


398 
	`´štk
("Došg sd„eque¡, dev = %d, block = %d\n", 
dev
, 
block
);

401 ià(
dev
 >ğ(
NR_SD
 << 4è|| 
block
 + 
SC²t
->
»que¡
.
Ä_£ùÜs
 > 
sd
[dev].
Ä_£ùs
)

403 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

404 
»³©
;

407 
block
 +ğ
sd
[
dev
].
¡¬t_£ù
;

408 
dev
 = 
	`DEVICE_NR
(dev);

410 ià(
rscsi_disks
[
dev
].
deviû
->
chªged
)

416 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

417 
»³©
;

420 #ifdeà
DEBUG


421 
	`´štk
("sd%d :„—Èdev = /dev/sd%d, block = %d\n", 
	`MINOR
(
SC²t
->
»que¡
.
dev
), dev, 
block
);

424 
SC²t
->
»que¡
.
cmd
)

426 
WRITE
 :

427 ià(!
rscsi_disks
[
dev
].
deviû
->
wr™—bË
)

429 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

430 
»³©
;

432 
cmd
[0] = 
WRITE_6
;

434 
READ
 :

435 
cmd
[0] = 
READ_6
;

438 
	`·nic
 ("UnknowÀsd commªd %d\n", 
SC²t
->
»que¡
.
cmd
);

441 
SC²t
->
this_couÁ
 = 0;

443 ià(!
SC²t
->
»que¡
.
bh
 ||

444 (
SC²t
->
»que¡
.
Ä_£ùÜs
 =ğSC²t->»que¡.
cu¼’t_Ä_£ùÜs
)) {

447 
this_couÁ
 = 
SC²t
->
»que¡
.
Ä_£ùÜs
;

448 
buff
 = 
SC²t
->
»que¡
.
bufãr
;

449 
SC²t
->
u£_sg
 = 0;

451 } ià(
SC²t
->
ho¡
->
sg_bËsize
 == 0 ||

452 (
Ãed_i§_bufãr
 &&

453 
dma_ä“_£ùÜs
 < 10)) {

462 ià(
SC²t
->
ho¡
->
sg_bËsize
 != 0 &&

463 
Ãed_i§_bufãr
 &&

464 
dma_ä“_£ùÜs
 < 10)

465 
	`´štk
("Warning: SCSI DMA buffer space„unning†ow. Using‚on scatter-gather I/O.\n");

467 
this_couÁ
 = 
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
;

468 
buff
 = 
SC²t
->
»que¡
.
bufãr
;

469 
SC²t
->
u£_sg
 = 0;

474 
bufãr_h—d
 * 
bh
;

475 
sÿ‰”li¡
 * 
sg²t
;

476 
couÁ
, 
this_couÁ_max
;

477 
bh
 = 
SC²t
->
»que¡
.bh;

478 
this_couÁ
 = 0;

479 
this_couÁ_max
 = (
rscsi_disks
[
dev
].
‹n
 ? 0xffff : 0xff);

480 
couÁ
 = 0;

481 
bh
 && 
couÁ
 < 
SC²t
->
ho¡
->
sg_bËsize
) {

482 ià((
this_couÁ
 + (
bh
->
b_size
 >> 9)è> 
this_couÁ_max
) ;

483 
this_couÁ
 +ğ(
bh
->
b_size
 >> 9);

484 
couÁ
++;

485 
bh
 = bh->
b_»qÃxt
;

487 
SC²t
->
u£_sg
 = 
couÁ
;

488 
couÁ
 = 512;

489  
couÁ
 < (
SC²t
->
u£_sg
 * (
sÿ‰”li¡
)))

490 
couÁ
 = count << 1;

491 
SC²t
->
sgli¡_Ën
 = 
couÁ
;

492 
sg²t
 = (
sÿ‰”li¡
 * ) 
	`scsi_m®loc
(
couÁ
);

493 ià(!
sg²t
) {

494 
	`´štk
("Warning -„unning *really* short on DMA buffers\n");

495 
SC²t
->
u£_sg
 = 0;

496 
this_couÁ
 = 
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
;

497 
buff
 = 
SC²t
->
»que¡
.
bufãr
;

499 
buff
 = (*è
sg²t
;

500 
couÁ
 = 0;

501 
bh
 = 
SC²t
->
»que¡
.bh;

502 
couÁ
 = 0, 
bh
 = 
SC²t
->
»que¡
.bh; couÁ < SC²t->
u£_sg
;

503 
couÁ
++, 
bh
 = bh->
b_»qÃxt
) {

504 
sg²t
[
couÁ
].
add»ss
 = 
bh
->
b_d©a
;

505 
sg²t
[
couÁ
].
®t_add»ss
 = 
NULL
;

506 
sg²t
[
couÁ
].
Ëngth
 = 
bh
->
b_size
;

507 ià(((è
sg²t
[
couÁ
].
add»ss
è+ sg²t[couÁ].
Ëngth
 >

508 
ISA_DMA_THRESHOLD
 & (
SC²t
->
ho¡
->
unchecked_i§_dma
)) {

509 
sg²t
[
couÁ
].
®t_add»ss
 = sg²t[couÁ].
add»ss
;

513 if(
dma_ä“_£ùÜs
 < (
bh
->
b_size
 >> 9) + 5) {

514 
sg²t
[
couÁ
].
add»ss
 = 
NULL
;

516 
sg²t
[
couÁ
].
add»ss
 = (*è
	`scsi_m®loc
(sg²t[couÁ].
Ëngth
);

522 if(
sg²t
[
couÁ
].
add»ss
 =ğ
NULL
){

523 
	`´štk
("Warning: Running†ow on SCSI DMA buffers");

525 --
couÁ
 >= 0){

526 if(
sg²t
[
couÁ
].
®t_add»ss
)

527 
	`scsi_ä“
(
sg²t
[
couÁ
].
add»ss
, sg²t[couÁ].
Ëngth
);

529 
this_couÁ
 = 
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
;

530 
buff
 = 
SC²t
->
»que¡
.
bufãr
;

531 
SC²t
->
u£_sg
 = 0;

532 
	`scsi_ä“
(
buff
, 
SC²t
->
sgli¡_Ën
);

536 ià(
SC²t
->
»que¡
.
cmd
 =ğ
WRITE
)

537 
	`memıy
(
sg²t
[
couÁ
].
add»ss
, sg²t[couÁ].
®t_add»ss
,

538 
sg²t
[
couÁ
].
Ëngth
);

546 if(
SC²t
->
u£_sg
 == 0){

547 ià(((è
buff
è+ (
this_couÁ
 << 9è> 
ISA_DMA_THRESHOLD
 &&

548 (
SC²t
->
ho¡
->
unchecked_i§_dma
)) {

549 
buff
 = (*è
	`scsi_m®loc
(
this_couÁ
 << 9);

550 if(
buff
 =ğ
NULL
è
	`·nic
("Ran out of DMA buffers.");

551 ià(
SC²t
->
»que¡
.
cmd
 =ğ
WRITE
)

552 
	`memıy
(
buff
, (*)
SC²t
->
»que¡
.
bufãr
, 
this_couÁ
 << 9);

556 #ifdeà
DEBUG


557 
	`´štk
("sd%d : % %d/%d 512 by‹ blocks.\n", 
	`MINOR
(
SC²t
->
»que¡
.
dev
),

558 (
SC²t
->
»que¡
.
cmd
 =ğ
WRITE
) ? "writing" : "reading",

559 
this_couÁ
, 
SC²t
->
»que¡
.
Ä_£ùÜs
);

562 
cmd
[1] = (
SC²t
->
lun
 << 5) & 0xe0;

564 ià(
rscsi_disks
[
dev
].
£ùÜ_size
 == 1024){

565 if(
block
 & 1è
	`·nic
("sd.c:Bad block‚umber„equested");

566 if(
this_couÁ
 & 1è
	`·nic
("sd.c:Bad block‚umber„equested");

567 
block
 = block >> 1;

568 
this_couÁ
 =his_count >> 1;

571 ià(
rscsi_disks
[
dev
].
£ùÜ_size
 == 256){

572 
block
 = block << 1;

573 
this_couÁ
 =his_count << 1;

576 ià(((
this_couÁ
 > 0xffè|| (
block
 > 0x1fffff)è&& 
rscsi_disks
[
dev
].
‹n
)

578 ià(
this_couÁ
 > 0xffff)

579 
this_couÁ
 = 0xffff;

581 
cmd
[0] +ğ
READ_10
 - 
READ_6
 ;

582 
cmd
[2] = (è(
block
 >> 24) & 0xff;

583 
cmd
[3] = (è(
block
 >> 16) & 0xff;

584 
cmd
[4] = (è(
block
 >> 8) & 0xff;

585 
cmd
[5] = (è
block
 & 0xff;

586 
cmd
[6] = cmd[9] = 0;

587 
cmd
[7] = (è(
this_couÁ
 >> 8) & 0xff;

588 
cmd
[8] = (è
this_couÁ
 & 0xff;

592 ià(
this_couÁ
 > 0xff)

593 
this_couÁ
 = 0xff;

595 
cmd
[1] |ğ(è((
block
 >> 16) & 0x1f);

596 
cmd
[2] = (è((
block
 >> 8) & 0xff);

597 
cmd
[3] = (è
block
 & 0xff;

598 
cmd
[4] = (è
this_couÁ
;

599 
cmd
[5] = 0;

608 
SC²t
->
Œªsãrsize
 = 
rscsi_disks
[
dev
].
£ùÜ_size
;

609 
SC²t
->
und”æow
 = 
this_couÁ
 << 9;

611 
	`scsi_do_cmd
 (
SC²t
, (*è
cmd
, 
buff
,

612 
this_couÁ
 * 
rscsi_disks
[
dev
].
£ùÜ_size
,

613 
rw_šŒ
, 
SD_TIMEOUT
, 
MAX_RETRIES
);

614 
	}
}

616 
	$check_scsidisk_medŸ_chªge
(
fuÎ_dev
, 
æag
){

617 
»tv®
;

618 
rg‘
;

619 
šode
 inode;

621 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
fuÎ_dev
));

623 ià(
rg‘
 >ğ
NR_SD
) {

624 
	`´štk
("SCSI disk„equestƒrror: invalid device.\n");

628 if(!
rscsi_disks
[
rg‘
].
deviû
->
»movabË
)  0;

630 
šode
.
i_rdev
 = 
fuÎ_dev
;

631 
»tv®
 = 
	`sd_ioùl
(&
šode
, 
NULL
, 
SCSI_IOCTL_TEST_UNIT_READY
, 0);

633 if(
»tv®
){

638 
rscsi_disks
[
rg‘
].
deviû
->
chªged
 = 1;

643 
»tv®
 = 
rscsi_disks
[
rg‘
].
deviû
->
chªged
;

644 if(!
æag
è
rscsi_disks
[
rg‘
].
deviû
->
chªged
 = 0;

645  
»tv®
;

646 
	}
}

648 
	$sd_š™_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

650 
»que¡
 * 
»q
;

651 
sk_¡ruù
 * 
p
;

653 
»q
 = &
SC²t
->
»que¡
;

654 
»q
->
dev
 = 0xfffe;

656 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

657 
»q
->
wa™šg
 = 
NULL
;

658 
p
->
¡©e
 = 
TASK_RUNNING
;

659 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

660 
Ãed_»sched
 = 1;

662 
	}
}

664 
	$sd_š™_Úedisk
(
i
)

666 
j
 = 0;

667 
cmd
[10];

668 *
bufãr
;

669 
¥štime
;

670 
the_»suÉ
, 
»Œ›s
;

671 
Scsi_Cmnd
 * 
SC²t
;

677 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, 
rscsi_disks
[
i
].
deviû
->
šdex
, 1);

678 
bufãr
 = (*è
	`scsi_m®loc
(512);

680 
¥štime
 = 0;

683 ià(
cu¼’t
 =ğ
sk
[0]){

685 
cmd
[0] = 
TEST_UNIT_READY
;

686 
cmd
[1] = (
rscsi_disks
[
i
].
deviû
->
lun
 << 5) & 0xe0;

687 
	`mem£t
 ((*è&
cmd
[2], 0, 8);

688 
SC²t
->
»que¡
.
dev
 = 0xffff;

689 
SC²t
->
£n£_bufãr
[0] = 0;

690 
SC²t
->
£n£_bufãr
[2] = 0;

692 
	`scsi_do_cmd
 (
SC²t
,

693 (*è
cmd
, (*è
bufãr
,

694 512, 
sd_š™_dÚe
, 
SD_TIMEOUT
,

695 
MAX_RETRIES
);

697 
SC²t
->
»que¡
.
dev
 != 0xfffe);

699 
the_»suÉ
 = 
SC²t
->
»suÉ
;

703 if(
the_»suÉ
 && !
rscsi_disks
[
i
].
deviû
->
»movabË
 &&

704 
SC²t
->
£n£_bufãr
[2] =ğ
NOT_READY
) {

705 
time1
;

706 if(!
¥štime
){

707 
	`´štk
Ğ"sd%d: Spšnšg u°disk...", 
i
 );

708 
cmd
[0] = 
START_STOP
;

709 
cmd
[1] = (
rscsi_disks
[
i
].
deviû
->
lun
 << 5) & 0xe0;

710 
cmd
[1] |= 1;

711 
	`mem£t
 ((*è&
cmd
[2], 0, 8);

712 
cmd
[4] = 1;

713 
SC²t
->
»que¡
.
dev
 = 0xffff;

714 
SC²t
->
£n£_bufãr
[0] = 0;

715 
SC²t
->
£n£_bufãr
[2] = 0;

717 
	`scsi_do_cmd
 (
SC²t
,

718 (*è
cmd
, (*è
bufãr
,

719 512, 
sd_š™_dÚe
, 
SD_TIMEOUT
,

720 
MAX_RETRIES
);

722 
SC²t
->
»que¡
.
dev
 != 0xfffe);

724 
¥štime
 = 
jiff›s
;

727 
time1
 = 
jiff›s
;

728 
jiff›s
 < 
time1
 + 100);

729 
	`´štk
( "." );

731 } 
the_»suÉ
 && 
¥štime
 && spštime+5000 > 
jiff›s
);

732 ià(
¥štime
) {

733 ià(
the_»suÉ
)

734 
	`´štk
( "not„esponding...\n" );

736 
	`´štk
( "ready\n" );

741 
»Œ›s
 = 3;

743 
cmd
[0] = 
READ_CAPACITY
;

744 
cmd
[1] = (
rscsi_disks
[
i
].
deviû
->
lun
 << 5) & 0xe0;

745 
	`mem£t
 ((*è&
cmd
[2], 0, 8);

746 
	`mem£t
 ((*è
bufãr
, 0, 8);

747 
SC²t
->
»que¡
.
dev
 = 0xffff;

748 
SC²t
->
£n£_bufãr
[0] = 0;

749 
SC²t
->
£n£_bufãr
[2] = 0;

751 
	`scsi_do_cmd
 (
SC²t
,

752 (*è
cmd
, (*è
bufãr
,

753 8, 
sd_š™_dÚe
, 
SD_TIMEOUT
,

754 
MAX_RETRIES
);

756 ià(
cu¼’t
 =ğ
sk
[0])

757 
SC²t
->
»que¡
.
dev
 != 0xfffe);

759 ià(
SC²t
->
»que¡
.
dev
 != 0xfffe){

760 
SC²t
->
»que¡
.
wa™šg
 = 
cu¼’t
;

761 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

762 
SC²t
->
»que¡
.
dev
 !ğ0xffãè
	`scheduË
();

765 
the_»suÉ
 = 
SC²t
->
»suÉ
;

766 
»Œ›s
--;

768 } 
the_»suÉ
 && 
»Œ›s
);

770 
SC²t
->
»que¡
.
dev
 = -1;

772 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

789 ià(
the_»suÉ
)

791 
	`´štk
 ("sd%d : READ CAPACITY failed.\n"

793 
i
,i,

794 
	`¡©us_by‹
(
the_»suÉ
),

795 
	`msg_by‹
(
the_»suÉ
),

796 
	`ho¡_by‹
(
the_»suÉ
),

797 
	`driv”_by‹
(
the_»suÉ
)

799 ià(
	`driv”_by‹
(
the_»suÉ
è& 
DRIVER_SENSE
)

800 
	`´štk
("sd%d :ƒx‹nded s’£ codğ%1x \n", 
i
, 
SC²t
->
£n£_bufãr
[2] & 0xf);

802 
	`´štk
("sd%d : s’£‚Ù‡vaabË. \n", 
i
);

804 
	`´štk
("sd%d : block sizassumedØb512 by‹s, disk siz1GB. \n", 
i
);

805 
rscsi_disks
[
i
].
ÿ·c™y
 = 0x1fffff;

806 
rscsi_disks
[
i
].
£ùÜ_size
 = 512;

810 if(
rscsi_disks
[
i
].
deviû
->
»movabË
 &&

811 
SC²t
->
£n£_bufãr
[2] =ğ
NOT_READY
)

812 
rscsi_disks
[
i
].
deviû
->
chªged
 = 1;

817 
rscsi_disks
[
i
].
ÿ·c™y
 = (
bufãr
[0] << 24) |

818 (
bufãr
[1] << 16) |

819 (
bufãr
[2] << 8) |

820 
bufãr
[3];

822 
rscsi_disks
[
i
].
£ùÜ_size
 = (
bufãr
[4] << 24) |

823 (
bufãr
[5] << 16) | (buffer[6] << 8) | buffer[7];

825 ià(
rscsi_disks
[
i
].
£ùÜ_size
 != 512 &&

826 
rscsi_disks
[
i
].
£ùÜ_size
 != 1024 &&

827 
rscsi_disks
[
i
].
£ùÜ_size
 != 256)

829 
	`´štk
 ("sd%d : unsupported sector size %d.\n",

830 
i
, 
rscsi_disks
[i].
£ùÜ_size
);

831 if(
rscsi_disks
[
i
].
deviû
->
»movabË
){

832 
rscsi_disks
[
i
].
ÿ·c™y
 = 0;

834 
	`´štk
 ("scsi : deleting diskƒntry.\n");

835 
j
=
i
; j < 
NR_SD
 - 1;)

836 
rscsi_disks
[
j
] =„scsi_disks[++j];

837 --
i
;

838 --
NR_SD
;

839 
	`scsi_ä“
(
bufãr
, 512);

840  
i
;

843 if(
rscsi_disks
[
i
].
£ùÜ_size
 == 1024)

844 
rscsi_disks
[
i
].
ÿ·c™y
 <<= 1;

845 if(
rscsi_disks
[
i
].
£ùÜ_size
 == 256)

846 
rscsi_disks
[
i
].
ÿ·c™y
 >>= 1;

849 
rscsi_disks
[
i
].
‹n
 = 1;

850 
rscsi_disks
[
i
].
»m­
 = 1;

851 
	`scsi_ä“
(
bufãr
, 512);

852  
i
;

853 
	}
}

860 
	$sd_š™
(
memÜy_¡¬t
, 
memÜy_’d
)

862 
i
;

864 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"sd",&
sd_fİs
)) {

865 
	`´štk
("UÇbËØg‘ majÜ %d fÜ SCSI disk\n",
MAJOR_NR
);

866  
memÜy_¡¬t
;

868 ià(
MAX_SD
 =ğ0è 
memÜy_¡¬t
;

870 
sd_sizes
 = (*è
memÜy_¡¬t
;

871 
memÜy_¡¬t
 +ğ(
MAX_SD
 << 4) * ();

872 
	`mem£t
(
sd_sizes
, 0, (
MAX_SD
 << 4) * ());

874 
sd_blocksizes
 = (*è
memÜy_¡¬t
;

875 
memÜy_¡¬t
 +ğ(
MAX_SD
 << 4) * ();

876 
i
=0;i<(
MAX_SD
 << 4);i++è
sd_blocksizes
[i] = 1024;

877 
blksize_size
[
MAJOR_NR
] = 
sd_blocksizes
;

879 
sd
 = (
hd_¡ruù
 *è
memÜy_¡¬t
;

880 
memÜy_¡¬t
 +ğ(
MAX_SD
 << 4è* (
hd_¡ruù
);

882 
sd_g’disk
.
max_Ä
 = 
MAX_SD
;

883 
sd_g’disk
.
·¹
 = 
sd
;

884 
sd_g’disk
.
sizes
 = 
sd_sizes
;

885 
sd_g’disk
.
»®_deviûs
 = (*è
rscsi_disks
;

887 
i
 = 0; i < 
NR_SD
; ++i)

888 
i
 = 
	`sd_š™_Úedisk
(i);

890 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

895 if(
rscsi_disks
[0].
deviû
->
ho¡
->
sg_bËsize
)

896 
»ad_ah—d
[
MAJOR_NR
] = 32;

899 
»ad_ah—d
[
MAJOR_NR
] = 4;

901 
sd_g’disk
.
Ãxt
 = 
g’disk_h—d
;

902 
g’disk_h—d
 = &
sd_g’disk
;

903  
memÜy_¡¬t
;

904 
	}
}

906 
	$sd_š™1
(
mem_¡¬t
, 
mem_’d
){

907 
rscsi_disks
 = (
Scsi_Disk
 *è
mem_¡¬t
;

908 
mem_¡¬t
 +ğ
MAX_SD
 * (
Scsi_Disk
);

909  
mem_¡¬t
;

910 
	}
};

912 
	$sd_©ch
(
Scsi_Deviû
 * 
SDp
){

913 
rscsi_disks
[
NR_SD
++].
deviû
 = 
SDp
;

914 if(
NR_SD
 > 
MAX_SD
è
	`·nic
 ("scsi_devices corrupt (sd)");

915 
	}
};

917 
	#DEVICE_BUSY
 
rscsi_disks
[
rg‘
].
deviû
->
busy


	)

918 
	#USAGE
 
rscsi_disks
[
rg‘
].
deviû
->
acûss_couÁ


	)

919 
	#CAPACITY
 
rscsi_disks
[
rg‘
].
ÿ·c™y


	)

920 
	#MAYBE_REINIT
 
	`sd_š™_Úedisk
(
rg‘
)

	)

921 
	#GENDISK_STRUCT
 
sd_g’disk


	)

930 
	$»v®id©e_scsidisk
(
dev
, 
maxu§ge
){

931 
rg‘
, 
majÜ
;

932 
g’disk
 * 
gdev
;

933 
max_p
;

934 
¡¬t
;

935 
i
;

937 
rg‘
 = 
	`DEVICE_NR
(
	`MINOR
(
dev
));

938 
gdev
 = &
GENDISK_STRUCT
;

940 
	`şi
();

941 ià(
DEVICE_BUSY
 || 
USAGE
 > 
maxu§ge
) {

942 
	`¡i
();

943 
	`´štk
("Deviû busy fÜ„ev®id©iÚ (u§ge=%d)\n", 
USAGE
);

944  -
EBUSY
;

946 
DEVICE_BUSY
 = 1;

947 
	`¡i
();

949 
max_p
 = 
gdev
->max_p;

950 
¡¬t
 = 
rg‘
 << 
gdev
->
mšÜ_shiá
;

951 
majÜ
 = 
MAJOR_NR
 << 8;

953 
i
=
max_p
 - 1; i >=0 ; i--) {

954 
	`sync_dev
(
majÜ
 | 
¡¬t
 | 
i
);

955 
	`šv®id©e_šodes
(
majÜ
 | 
¡¬t
 | 
i
);

956 
	`šv®id©e_bufãrs
(
majÜ
 | 
¡¬t
 | 
i
);

957 
gdev
->
·¹
[
¡¬t
+
i
].
¡¬t_£ù
 = 0;

958 
gdev
->
·¹
[
¡¬t
+
i
].
Ä_£ùs
 = 0;

961 #ifdeà
MAYBE_REINIT


962 
MAYBE_REINIT
;

965 
gdev
->
·¹
[
¡¬t
].
Ä_£ùs
 = 
CAPACITY
;

966 
	`»£tup_Úe_dev
(
gdev
, 
rg‘
);

968 
DEVICE_BUSY
 = 0;

970 
	}
}

	@drivers/scsi/sd.h

12 #iâdeà
_SD_H


13 
	#_SD_H


	)

18 #iâdeà
_SCSI_H


19 
	~"scsi.h
"

22 #iâdeà
_GENDISK_H


23 
	~<lšux/g’hd.h
>

32 
hd_¡ruù
 * 
sd
;

35 
	mÿ·c™y
;

36 
	m£ùÜ_size
;

37 
Scsi_Deviû
 *
	mdeviû
;

38 
	m£ùÜ_b™_size
;

39 
	m£ùÜ_b™_shiá
;

40 
	m‹n
:1;

41 
	m»m­
:1;

42 } 
	tScsi_Disk
;

44 
Scsi_Disk
 * 
rscsi_disks
;

	@drivers/scsi/sd_ioctl.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/fs.h
>

4 
	~<lšux/hd»g.h
>

5 
	~<lšux/”ºo.h
>

7 
	~<asm/£gm’t.h
>

9 
	~"../block/blk.h
"

10 
	~"scsi.h
"

11 
	~"scsi_ioùl.h
"

12 
	~"ho¡s.h
"

13 
	~"sd.h
"

15 
»v®id©e_scsidisk
(, );

17 
	$sd_ioùl
(
šode
 * inode, 
fe
 * fe, 
cmd
, 
¬g
)

19 
dev
 = 
šode
->
i_rdev
;

20 
”rÜ
;

21 
Scsi_Ho¡
 * 
ho¡
;

22 
diskšfo
[4];

23 
hd_geom‘ry
 *
loc
 = (hd_geom‘ry *è
¬g
;

25 
cmd
) {

26 
HDIO_REQ
:

27 ià(!
loc
è -
EINVAL
;

28 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
loc
, (*loc));

29 ià(
”rÜ
)

30  
”rÜ
;

31 
ho¡
 = 
rscsi_disks
[
	`MINOR
(
dev
è>> 4].
deviû
->host;

32 
diskšfo
[0] = 0;

33 
diskšfo
[1] = 0;

34 
diskšfo
[2] = 0;

35 if(
ho¡
->
ho¡t
->
bios_·¿m
 !ğ
NULL
)

36 
ho¡
->
ho¡t
->
	`bios_·¿m
(
rscsi_disks
[
	`MINOR
(
dev
è>> 4].
ÿ·c™y
,

37 
dev
,

38 &
diskšfo
[0]);

39 
	`put_fs_by‹
(
diskšfo
[0],

40 (*è&
loc
->
h—ds
);

41 
	`put_fs_by‹
(
diskšfo
[1],

42 (*è&
loc
->
£ùÜs
);

43 
	`put_fs_wÜd
(
diskšfo
[2],

44 (*è&
loc
->
cylšd”s
);

45 
	`put_fs_lÚg
(
sd
[
	`MINOR
(
šode
->
i_rdev
)].
¡¬t_£ù
,

46 (*è&
loc
->
¡¬t
);

48 
BLKGETSIZE
:

49 ià(!
¬g
è -
EINVAL
;

50 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
, ());

51 ià(
”rÜ
)

52  
”rÜ
;

53 
	`put_fs_lÚg
(
sd
[
	`MINOR
(
šode
->
i_rdev
)].
Ä_£ùs
,

54 (*è
¬g
);

56 
BLKFLSBUF
:

57 if(!
	`su£r
()è -
EACCES
;

58 if(!
šode
->
i_rdev
è -
EINVAL
;

59 
	`fsync_dev
(
šode
->
i_rdev
);

60 
	`šv®id©e_bufãrs
(
šode
->
i_rdev
);

63 
BLKRRPART
:

64  
	`»v®id©e_scsidisk
(
dev
, 1);

66  
	`scsi_ioùl
(
rscsi_disks
[
	`MINOR
(
dev
è>> 4].
deviû
 , 
cmd
, (*è
¬g
);

68 
	}
}

	@drivers/scsi/seagate.c

49 
	~<lšux/cÚfig.h
>

51 #ià
defšed
(
CONFIG_SCSI_SEAGATE
è|| defšed(
CONFIG_SCSI_FD_8xx
)

52 
	~<asm/io.h
>

53 
	~<asm/sy¡em.h
>

54 
	~<lšux/sigÇl.h
>

55 
	~<lšux/sched.h
>

56 
	~<lšux/¡ršg.h
>

57 
	~"../block/blk.h
"

58 
	~"scsi.h
"

59 
	~"ho¡s.h
"

60 
	~"£ag©e.h
"

61 
	~"cÚ¡ªts.h
"

64 #iâdeà
IRQ


65 
	#IRQ
 5

	)

68 #ià(
defšed
(
FAST32
è&& !defšed(
FAST
))

69 
	#FAST


	)

72 #ià
defšed
(
SLOW_RATE
è&& !defšed(
SLOW_HANDSHAKE
)

73 
	#SLOW_HANDSHAKE


	)

76 #ià
defšed
(
SLOW_HANDSHAKE
è&& !defšed(
SLOW_RATE
)

77 
	#SLOW_RATE
 50

	)

81 #ià
defšed
(
LINKED
)

82 #undeà
LINKED


85 
š‹º®_commªd
(
rg‘
, 
lun
,

86 cÚ¡ *
cmnd
,

87 *
buff
, 
bufæ’
, 
»£Ëù
);

89 
	gšcommªd
;

94 *
	gba£_add»ss
 = 
NULL
;

99 vŞ©
	gabÜt_cÚfœm
 = 0;

101 vŞ©*
	g¡0x_ü_¤
;

112 vŞ©*
	g¡0x_dr
;

118 vŞ©
	g¡0x_abÜ‹d
=0;

122 
	gcÚŒŞËr_ty³
 = 0;

123 
	gœq
 = 
IRQ
;

125 
	#»tcode
(
»suÉ
è((ÔesuÉè<< 16è| (
mes§ge
 << 8è| 
¡©us
)

	)

126 
	#STATUS
 (*(vŞ©*è
¡0x_ü_¤
)

	)

127 
	#CONTROL
 
STATUS


	)

128 
	#DATA
 (*(vŞ©*è
¡0x_dr
)

	)

130 
	$¡0x_£tup
 (*
¡r
, *
šts
) {

131 
cÚŒŞËr_ty³
 = 
SEAGATE
;

132 
ba£_add»ss
 = (*è
šts
[1];

133 
œq
 = 
šts
[2];

134 
	}
}

136 
	$tmc8xx_£tup
 (*
¡r
, *
šts
) {

137 
cÚŒŞËr_ty³
 = 
FD
;

138 
ba£_add»ss
 = (*è
šts
[1];

139 
œq
 = 
šts
[2];

140 
	}
}

143 #iâdeà
OVERRIDE


144 cÚ¡ * 
	g£ag©e_ba£s
[] = {

150 *
	msigÇtu»
 ;

151 
	moff£t
;

152 
	mËngth
;

153 
	mty³
;

154 } 
	tSigÇtu»
;

156 cÚ¡ 
SigÇtu»
 
	gsigÇtu»s
[] = {

157 #ifdeà
CONFIG_SCSI_SEAGATE


158 {"ST01 v1.7 (CèCİyrighˆ1987 S—g©e", 15, 37, 
SEAGATE
},

159 {"SCSI BIOS 2.00 (CèCİyrighˆ1987 S—g©e", 15, 40, 
SEAGATE
},

168 {"SEAGATE SCSI BIOS ",16, 17, 
SEAGATE
},

169 {"SEAGATE SCSI BIOS ",17, 17, 
SEAGATE
},

176 {"FUTURE DOMAIN CORP. (Cè1986-1989 V5.0C2/14/89", 5, 46, 
FD
},

177 {"FUTURE DOMAIN CORP. (Cè1986-1989 V6.0A7/28/89", 5, 46, 
FD
},

178 {"FUTURE DOMAIN CORP. (Cè1986-1990 V6.0105/31/90",5, 47, 
FD
},

179 {"FUTURE DOMAIN CORP. (Cè1986-1990 V6.0209/18/90",5, 47, 
FD
},

180 {"FUTURE DOMAIN CORP. (Cè1986-1990 V7.009/18/90", 5, 46, 
FD
},

181 {"FUTURE DOMAIN CORP. (Cè1992 V8.00.004/02/92", 5, 44, 
FD
},

182 {"FUTURE DOMAIN TMC-950", 5, 21, 
FD
},

187 
	#NUM_SIGNATURES
 ((
sigÇtu»s
è/ (
SigÇtu»
))

	)

194 
	gho¡no
 = -1;

195 
£ag©e_»cÚÃù_šŒ
();

197 #ifdeà
FAST


198 
	gç¡
 = 1;

201 #ifdeà
SLOW_HANDSHAKE


239 
	gbÜk’_ÿlib¿tiÚ
 = 0;

240 
	$bÜk’_š™
 () {

241 
couÁ
 = 0, 
¡¬t
 = 
jiff›s
 + 1, 
¡İ
 = start + 25;

243 
jiff›s
 < 
¡¬t
);

244 ;
jiff›s
 < 
¡İ
; ++
couÁ
);

251 
bÜk’_ÿlib¿tiÚ
 = (
couÁ
 * 4è/ (
SLOW_RATE
*1024);

253 ià(
bÜk’_ÿlib¿tiÚ
 < 1)

254 
bÜk’_ÿlib¿tiÚ
 = 1;

255 #ià(
DEBUG
 & 
DEBUG_BORKEN
)

256 
	`´štk
("scsi%d : borken calibratedo %dK/sec, %d cycles…erransfer\n",

257 
ho¡no
, 
BORKEN_RATE
, 
bÜk’_ÿlib¿tiÚ
);

259 
	}
}

261 
šlše
 
	$bÜk’_wa™
() {

262 
couÁ
;

263 
couÁ
 = 
bÜk’_ÿlib¿tiÚ
; couÁ && (
STATUS
 & 
STAT_REQ
);

264 --
couÁ
);

265 ià(
couÁ
)

266 #ià(
DEBUG
 & 
DEBUG_BORKEN
)

267 
	`´štk
("scsi%d : bÜk’imeout\n", 
ho¡no
);

271 
	}
}

275 
	$£ag©e_¡0x_d‘eù
 (
ho¡num
)

277 #iâdeà
OVERRIDE


278 
i
,
j
;

280 
sigaùiÚ
 
£ag©e_sigaùiÚ
 = {

281 &
£ag©e_»cÚÃù_šŒ
,

283 
SA_INTERRUPT
,

284 
NULL


290 #ifdeà
DEBUG


291 
	`´štk
("Autodetecting seagate ST0x\n");

294 ià(
ho¡no
 != -1)

296 
	`´štk
 ("ERROR : seagate_st0x_detect() calledwice.\n");

303 ià(!
cÚŒŞËr_ty³
) {

304 #ifdeà
OVERRIDE


305 
ba£_add»ss
 = (*è
OVERRIDE
;

308 #ifdeà
CONTROLLER


309 
cÚŒŞËr_ty³
 = 
CONTROLLER
;

311 #”rÜ 
PËa£
 
u£
 -
DCONTROLLER
=
SEAGATE
 
Ü
 -DCONTROLLER=
FD
 
to
 
ov”ride
 
cÚŒŞËr
 
ty³


313 #ifdeà
DEBUG


314 
	`´štk
("Base‡ddress overriddeno %x, controllerype is %s\n",

315 
ba£_add»ss
,
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? "SEAGATE" : "FD");

328 
i
 = 0; i < ( (
£ag©e_ba£s
) /  (* )); ++i)

329 
j
 = 0; !
ba£_add»ss
 && j < 
NUM_SIGNATURES
; ++j)

330 ià(!
	`memcmp
 ((*è(
£ag©e_ba£s
[
i
] +

331 
sigÇtu»s
[
j
].
off£t
), (*èsigÇtu»s[j].
sigÇtu»
,

332 
sigÇtu»s
[
j
].
Ëngth
)) {

333 
ba£_add»ss
 = (*è
£ag©e_ba£s
[
i
];

334 
cÚŒŞËr_ty³
 = 
sigÇtu»s
[
j
].
ty³
;

339 
scsi_ho¡s
[
ho¡num
].
this_id
 = (
cÚŒŞËr_ty³
 =ğ
SEAGATE
) ? 7 : 6;

341 ià(
ba£_add»ss
)

343 
¡0x_ü_¤
 =(*è(((*è
ba£_add»ss
è+ (
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? 0x1a00 : 0x1c00));

344 
¡0x_dr
 = (*è(((*è
ba£_add»ss
 ) + (
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? 0x1c00 : 0x1e00));

345 #ifdeà
DEBUG


346 
	`´štk
("ST0x d‘eùed. Ba£‡dd»s ğ%x, c¸ğ%x, d¸ğ%x\n", 
ba£_add»ss
, 
¡0x_ü_¤
, 
¡0x_dr
);

352 
ho¡no
 = 
ho¡num
;

353 ià(
	`œqaùiÚ
((è
œq
, &
£ag©e_sigaùiÚ
)) {

354 
	`´štk
("scsi%d : unableo‡llocate IRQ%d\n",

355 
ho¡no
, (è
œq
);

358 #ifdeà
SLOW_HANDSHAKE


359 
	`bÜk’_š™
();

366 #ifdeà
DEBUG


367 
	`´štk
("ST0x‚ot detected.\n");

371 
	}
}

373 cÚ¡ *
	$£ag©e_¡0x_šfo
() {

374 
bufãr
[256];

375 
	`¥rštf
(
bufãr
, "scsi%d : %s‡t irq %d‡ddress %p options :"

376 #ifdeà
ARBITRATE


379 #ifdeà
SLOW_HANDSHAKE


382 #ifdeà
FAST


383 #ifdeà
FAST32


390 #ifdeà
LINKED


393 "\n", 
ho¡no
, (
cÚŒŞËr_ty³
 =ğ
SEAGATE
) ? "seagate" :

394 "FD TMC-8xx", 
œq
, 
ba£_add»ss
);

395  
bufãr
;

396 
	}
}

403 
	gcu¼’t_rg‘
, 
	gcu¼’t_lun
;

404 *
	gcu¼’t_cmnd
, *
	gcu¼’t_d©a
;

405 
	gcu¼’t_nobuffs
;

406 
sÿ‰”li¡
 *
	gcu¼’t_bufãr
;

407 
	gcu¼’t_bufæ’
;

409 #ifdeà
LINKED


417 
	glšked_cÚÃùed
 = 0;

418 
	glšked_rg‘
, 
	glšked_lun
;

422 (*
dÚe_â
)(
Scsi_Cmnd
 *èğ
NULL
;

423 
Scsi_Cmnd
 * 
SCšt
 = 
NULL
;

430 
	#NO_RECONNECT
 0

	)

431 
	#RECONNECT_NOW
 1

	)

432 
	#CAN_RECONNECT
 2

	)

434 #ifdeà
LINKED


442 
	#LINKED_RIGHT
 3

	)

443 
	#LINKED_WRONG
 4

	)

450 
should_»cÚÃù
 = 0;

458 
	$£ag©e_»cÚÃù_šŒ
 (
unu£d
)

460 
‹mp
;

461 
Scsi_Cmnd
 * 
SCtmp
;

464 
	`¡i
();

465 #ià(
DEBUG
 & 
PHASE_RESELECT
)

466 
	`´štk
("scsi%d : s—g©e_»cÚÃù_šŒ(èÿÎed\n", 
ho¡no
);

469 ià(!
should_»cÚÃù
)

470 
	`´štk
("scsi%d: uÃx³ùed iÁ”ru±.\n", 
ho¡no
);

472 
should_»cÚÃù
 = 0;

474 #ià(
DEBUG
 & 
PHASE_RESELECT
)

475 
	`´štk
("scsi%d : internal_command("

476 "%d, %08x, %08x, %d, RECONNECT_NOW\n", 
ho¡no
,

477 
cu¼’t_rg‘
, 
cu¼’t_d©a
, 
cu¼’t_bufæ’
);

480 
‹mp
 = 
	`š‹º®_commªd
 (
cu¼’t_rg‘
, 
cu¼’t_lun
,

481 
cu¼’t_cmnd
, 
cu¼’t_d©a
, 
cu¼’t_bufæ’
,

482 
RECONNECT_NOW
);

484 ià(
	`msg_by‹
(
‹mp
è!ğ
DISCONNECT
) {

485 ià(
dÚe_â
) {

486 #ià(
DEBUG
 & 
PHASE_RESELECT
)

487 
	`´štk
("scsi%d : dÚe_â(%d,%08x)", 
ho¡no
,

488 
ho¡no
, 
‹mp
);

490 if(!
SCšt
è
	`·nic
("SCint == NULL in seagate");

491 
SCtmp
 = 
SCšt
;

492 
SCšt
 = 
NULL
;

493 
SCtmp
->
»suÉ
 = 
‹mp
;

494 
	`dÚe_â
 (
SCtmp
);

496 
	`´štk
("done_fn()‚ot defined.\n");

499 
	}
}

512 
	g»cursiÚ_d•th
 = 0;

514 
£ag©e_¡0x_queue_commªd
 (
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

516 
»suÉ
, 
»cÚÃù
;

517 
Scsi_Cmnd
 * 
SCtmp
;

519 
dÚe_â
 = 
dÚe
;

520 
cu¼’t_rg‘
 = 
SC²t
->
rg‘
;

521 
cu¼’t_lun
 = 
SC²t
->
lun
;

522 (cÚ¡ *è
cu¼’t_cmnd
 = 
SC²t
->
cmnd
;

523 
cu¼’t_d©a
 = (*è
SC²t
->
»que¡_bufãr
;

524 
cu¼’t_bufæ’
 = 
SC²t
->
»que¡_bufæ’
;

525 
SCšt
 = 
SC²t
;

526 if(
»cursiÚ_d•th
) {

529 
»cursiÚ_d•th
++;

531 #ifdeà
LINKED


536 
cu¼’t_cmnd
[
	`COMMAND_SIZE
(current_cmnd[0])] |= 0x01;

537 ià(
lšked_cÚÃùed
) {

538 #ià(
DEBUG
 & 
DEBUG_LINKED
)

539 
	`´štk
("scsi%d : using†inked commands, current I_T_L‚exus is ",

540 
ho¡no
);

542 ià((
lšked_rg‘
 =ğ
cu¼’t_rg‘
) &&

543 (
lšked_lun
 =ğ
cu¼’t_lun
)) {

544 #ià(
DEBUG
 & 
DEBUG_LINKED
)

545 
	`´štk
("correct\n");

547 
»cÚÃù
 = 
LINKED_RIGHT
;

549 #ià(
DEBUG
 & 
DEBUG_LINKED
)

550 
	`´štk
("incorrect\n");

552 
»cÚÃù
 = 
LINKED_WRONG
;

556 
»cÚÃù
 = 
CAN_RECONNECT
;

562 
»suÉ
 = 
	`š‹º®_commªd
 (
SCšt
->
rg‘
, SCšt->
lun
, SCšt->
cmnd
, SCšt->
»que¡_bufãr
,

563 
SCšt
->
»que¡_bufæ’
,

564 
»cÚÃù
);

565 ià(
	`msg_by‹
(
»suÉ
è=ğ
DISCONNECT
) ;

566 
SCtmp
 = 
SCšt
;

567 
SCšt
 = 
NULL
;

568 
SCtmp
->
»suÉ
 =„esult;

569 
	`dÚe_â
 (
SCtmp
);

570 } 
SCšt
);

571 
»cursiÚ_d•th
--;

573 
	}
}

575 
	$£ag©e_¡0x_commªd
 (
Scsi_Cmnd
 * 
SC²t
) {

576  
	`š‹º®_commªd
 (
SC²t
->
rg‘
, SC²t->
lun
, SC²t->
cmnd
, SC²t->
»que¡_bufãr
,

577 
SC²t
->
»que¡_bufæ’
,

578 (è
NO_RECONNECT
);

579 
	}
}

581 
	$š‹º®_commªd
(
rg‘
, 
lun
, cÚ¡ *
cmnd
,

582 *
buff
, 
bufæ’
, 
»£Ëù
) {

583 
Ën
 = 0;

584 *
d©a
 = 
NULL
;

585 
sÿ‰”li¡
 *
bufãr
 = 
NULL
;

586 
nobuffs
 = 0;

587 
şock
;

588 
‹mp
;

589 #ifdeà
SLOW_HANDSHAKE


590 
bÜk’
;

594 #ià(
DEBUG
 & 
PHASE_DATAIN
è|| (DEBUG & 
PHASE_DATOUT
)

595 
Œªsã»d
 = 0;

598 #ià(((
DEBUG
 & 
PHASE_ETC
è=ğPHASE_ETCè|| (DEBUG & 
PRINT_COMMAND
) || \

599 (
DEBUG
 & 
PHASE_EXIT
))

600 
i
;

603 #ià((
DEBUG
 & 
PHASE_ETC
) == PHASE_ETC)

604 
pha£
=0, 
Ãwpha£
;

607 
dÚe
 = 0;

608 
¡©us
 = 0;

609 
mes§ge
 = 0;

610 
¡©us_»ad
;

612 
Œªsãrsize
 = 0, 
und”æow
 = 0;

614 
šcommªd
 = 0;

615 
¡0x_abÜ‹d
 = 0;

617 #ifdeà
SLOW_HANDSHAKE


618 
bÜk’
 = (è
scsi_deviûs
[
SCšt
->
šdex
].borken;

621 #ià(
DEBUG
 & 
PRINT_COMMAND
)

622 
	`´štk
 ("scsi%d :¬g‘ = %d, commªd = ", 
ho¡no
, 
rg‘
);

623 
	`´št_commªd
((*è
cmnd
);

624 
	`´štk
("\n");

627 #ià(
DEBUG
 & 
PHASE_RESELECT
)

628 
»£Ëù
) {

629 
RECONNECT_NOW
 :

630 
	`´štk
("scsi%d :„ecÚÃùšg\n", 
ho¡no
);

632 #ifdeà
LINKED


633 
LINKED_RIGHT
 :

634 
	`´štk
("scsi%d : cÚÃùed, cª„ecÚÃù\n", 
ho¡no
);

636 
LINKED_WRONG
 :

637 
	`´štk
("scsi%d : connectedo wrongarget, can„econnect\n",

638 
ho¡no
);

641 
CAN_RECONNECT
 :

642 
	`´štk
("scsi%d :‡ÎowedØ»cÚÃù\n", 
ho¡no
);

645 
	`´štk
("scsi%d :‚Ù‡ÎowedØ»cÚÃù\n", 
ho¡no
);

650 ià(
rg‘
 =ğ(
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? 7 : 6))

651  
DID_BAD_TARGET
;

659 
»£Ëù
) {

660 
RECONNECT_NOW
:

661 #ià(
DEBUG
 & 
PHASE_RESELECT
)

662 
	`´štk
("scsi%d :…ha£ RESELECT \n", 
ho¡no
);

674 
şock
 = 
jiff›s
 + 10, 
‹mp
 = 0; (jiffies < clock) &&

675 !(
STATUS
 & 
STAT_IO
););

677 ià(
jiff›s
 >ğ
şock
)

679 #ià(
DEBUG
 & 
PHASE_RESELECT
)

680 
	`´štk
("scsi%d : RESELECTimed out while waiting for IO .\n",

681 
ho¡no
);

683  (
DID_BAD_INTR
 << 16);

691 ià(!((
‹mp
 = 
DATA
è& (
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? 0x80 : 0x40)))

693 #ià(
DEBUG
 & 
PHASE_RESELECT
)

694 
	`´štk
("scsi%d : detected„econnect„equesto differentarget.\n"

695 "\tD©¨bu ğ%d\n", 
ho¡no
, 
‹mp
);

697  (
DID_BAD_INTR
 << 16);

700 ià(!(
‹mp
 & (1 << 
cu¼’t_rg‘
)))

702 
	`´štk
("scsi%d : Unexpected„eselect interrupt. Data bus = %d\n",

703 
ho¡no
, 
‹mp
);

704  (
DID_BAD_INTR
 << 16);

707 
bufãr
=
cu¼’t_bufãr
;

708 
cmnd
=
cu¼’t_cmnd
;

709 
d©a
=
cu¼’t_d©a
;

710 
Ën
=
cu¼’t_bufæ’
;

711 
nobuffs
=
cu¼’t_nobuffs
;

719 
CONTROL
 = (
BASE_CMD
 | 
CMD_DRVR_ENABLE
 | 
CMD_BSY
);

721 
CONTROL
 = (
BASE_CMD
 | 
CMD_BSY
);

729 
şock
 = 
jiff›s
 + 10; (jiff› < clockè&& (
STATUS
 & 
STAT_SEL
););

731 ià(
jiff›s
 >ğ
şock
)

733 
CONTROL
 = (
BASE_CMD
 | 
CMD_INTR
);

734 #ià(
DEBUG
 & 
PHASE_RESELECT
)

735 
	`´štk
("scsi%d : RESELECTimed out while waiting for SEL.\n",

736 
ho¡no
);

738  (
DID_BAD_INTR
 << 16);

741 
CONTROL
 = 
BASE_CMD
;

748 
CAN_RECONNECT
:

750 #ifdeà
LINKED


758 
cÚÃù_loİ
 :

762 #ià(
DEBUG
 & 
PHASE_BUS_FREE
)

763 
	`´štk
 ("scsi%d :…ha£ = BUS FREE \n", 
ho¡no
);

775 
şock
 = 
jiff›s
 + 
ST0X_BUS_FREE_DELAY
;

777 #ià!
	`defšed
 (
ARBITRATE
)

778 ((
STATUS
 | STATUS | STATUS) &

779 (
STAT_BSY
 | 
STAT_SEL
)) &&

780 (!
¡0x_abÜ‹d
è&& (
jiff›s
 < 
şock
));

782 ià(
jiff›s
 > 
şock
)

783  
	`»tcode
(
DID_BUS_BUSY
);

784 ià(
¡0x_abÜ‹d
)

785  
	`»tcode
(
¡0x_abÜ‹d
);

788 #ià(
DEBUG
 & 
PHASE_SELECTION
)

789 
	`´štk
("scsi%d :…ha£ = SELECTION\n", 
ho¡no
);

792 
şock
 = 
jiff›s
 + 
ST0X_SELECTION_DELAY
;

805 #ià
	`defšed
(
ARBITRATE
)

806 
	`şi
();

807 
CONTROL
 = 0;

808 
DATA
 = (
cÚŒŞËr_ty³
 =ğ
SEAGATE
) ? 0x80 : 0x40;

809 
CONTROL
 = 
CMD_START_ARB
;

810 
	`¡i
();

811 !((
¡©us_»ad
 = 
STATUS
è& (
STAT_ARB_CMPL
 | 
STAT_SEL
)) &&

812 (
jiff›s
 < 
şock
è&& !
¡0x_abÜ‹d
);

814 ià(!(
¡©us_»ad
 & 
STAT_ARB_CMPL
)) {

815 #ià(
DEBUG
 & 
PHASE_SELECTION
)

816 ià(
¡©us_»ad
 & 
STAT_SEL
)

817 
	`´štk
("scsi%d :‡rb™¿tiÚ†o¡\n", 
ho¡no
);

819 
	`´štk
("scsi%d :‡rb™¿tiÚimeout.\n", 
ho¡no
);

821 
CONTROL
 = 
BASE_CMD
;

822  
	`»tcode
(
DID_NO_CONNECT
);

825 #ià(
DEBUG
 & 
PHASE_SELECTION
)

826 
	`´štk
("scsi%d :‡rb™¿tiÚ com¶‘e\n", 
ho¡no
);

843 
	`şi
();

844 
DATA
 = (è((1 << 
rg‘
è| (
cÚŒŞËr_ty³
 =ğ
SEAGATE
 ? 0x80 : 0x40));

845 
CONTROL
 = 
BASE_CMD
 | 
CMD_DRVR_ENABLE
 | 
CMD_SEL
 |

846 (
»£Ëù
 ? 
CMD_ATTN
 : 0);

847 
	`¡i
();

848 !((
¡©us_»ad
 = 
STATUS
è& 
STAT_BSY
) &&

849 (
jiff›s
 < 
şock
è&& !
¡0x_abÜ‹d
)

851 #ià0 && (
DEBUG
 & 
PHASE_SELECTION
)

853 
‹mp
 = 
şock
 - 
jiff›s
;

855 ià(!(
jiff›s
 % 5))

856 
	`´štk
("£ag©e_¡0x_timeouˆ: %d \r",
‹mp
);

859 
	`´štk
("Done. \n");

860 
	`´štk
("scsi%d : status = %02x, seagate_st0x_timeout = %d,‡borted = %02x \n",

861 
ho¡no
, 
¡©us_»ad
, 
‹mp
, 
¡0x_abÜ‹d
);

867 ià((
jiff›s
 >ğ
şock
è&& !(
¡©us_»ad
 & 
STAT_BSY
))

869 #ià(
DEBUG
 & 
PHASE_SELECTION
)

870 
	`´štk
 ("scsi%d : NO CONNECT witharget %d, status = %x \n",

871 
ho¡no
, 
rg‘
, 
STATUS
);

873  
	`»tcode
(
DID_NO_CONNECT
);

882 ià(
¡0x_abÜ‹d
) {

883 
CONTROL
 = 
BASE_CMD
;

884 ià(
STATUS
 & 
STAT_BSY
) {

885 
	`´štk
("scsi%d : BST‡sserted‡fter we've been‡borted.\n",

886 
ho¡no
);

887 
	`£ag©e_¡0x_»£t
(
NULL
);

888  
	`»tcode
(
DID_RESET
);

890  
	`»tcode
(
¡0x_abÜ‹d
);

895 ià((
nobuffs
 = 
SCšt
->
u£_sg
)) {

896 #ià(
DEBUG
 & 
DEBUG_SG
)

898 
i
;

899 
	`´štk
("scsi%d : scatter gather„equested, using %d buffers.\n",

900 
ho¡no
, 
nobuffs
);

901 
i
 = 0; i < 
nobuffs
; ++i)

902 
	`´štk
("scsi%d : buffer %d‡ddress = %08x†ength = %d\n",

903 
ho¡no
, 
i
, 
bufãr
[i].
add»ss
, bufãr[i].
Ëngth
);

907 
bufãr
 = (
sÿ‰”li¡
 *è
SCšt
->buffer;

908 
Ën
 = 
bufãr
->
Ëngth
;

909 
d©a
 = (*è
bufãr
->
add»ss
;

911 #ià(
DEBUG
 & 
DEBUG_SG
)

912 
	`´štk
("scsi%d : sÿ‰” g©h”‚Ù„eque¡ed.\n", 
ho¡no
);

914 
bufãr
 = 
NULL
;

915 
Ën
 = 
SCšt
->
»que¡_bufæ’
;

916 
d©a
 = (*è
SCšt
->
»que¡_bufãr
;

919 #ià(
DEBUG
 & (
PHASE_DATAIN
 | 
PHASE_DATAOUT
))

920 
	`´štk
("scsi%d :†’ = %d\n", 
ho¡no
, 
Ën
);

924 #ifdeà
LINKED


925 
LINKED_RIGHT
:

927 
LINKED_WRONG
:

942 
CONTROL
 = 
BASE_CMD
 | 
CMD_DRVR_ENABLE
 |

943 (((
»£Ëù
 =ğ
CAN_RECONNECT
)

944 #ifdeà
LINKED


945 || (
»£Ëù
 =ğ
LINKED_WRONG
)

947 è? 
CMD_ATTN
 : 0) ;

958 #ià((
DEBUG
 & 
PHASE_ETC
) == PHASE_ETC)

959 
	`´štk
("scsi%d :…ha£ = INFORMATION TRANSFER\n", 
ho¡no
);

962 
šcommªd
 = 1;

963 
Œªsãrsize
 = 
SCšt
->transfersize;

964 
und”æow
 = 
SCšt
->underflow;

975 ((
¡©us_»ad
 = 
STATUS
è& 
STAT_BSY
è&& !
¡0x_abÜ‹d
 && !
dÚe
)

977 #ifdeà
PARITY


978 ià(
¡©us_»ad
 & 
STAT_PARITY
)

980 
	`´štk
("scsi%d : gÙ…¬™yƒ¼Ü\n", 
ho¡no
);

981 
¡0x_abÜ‹d
 = 
DID_PARITY
;

985 ià(
¡©us_»ad
 & 
STAT_REQ
)

987 #ià((
DEBUG
 & 
PHASE_ETC
) == PHASE_ETC)

988 ià((
Ãwpha£
 = (
¡©us_»ad
 & 
REQ_MASK
)è!ğ
pha£
)

990 
pha£
 = 
Ãwpha£
;

991 
pha£
)

993 
REQ_DATAOUT
:

994 
	`´štk
("scsi%d :…hase = DATA OUT\n",

995 
ho¡no
);

997 
REQ_DATAIN
 :

998 
	`´štk
("scsi%d :…hase = DATA IN\n",

999 
ho¡no
);

1001 
REQ_CMDOUT
 :

1002 
	`´štk
("scsi%d :…hase = COMMAND OUT\n",

1003 
ho¡no
);

1005 
REQ_STATIN
 :

1006 
	`´štk
("scsi%d :…hase = STATUS IN\n",

1007 
ho¡no
);

1009 
REQ_MSGOUT
 :

1010 
	`´štk
("scsi%d :…hase = MESSAGE OUT\n",

1011 
ho¡no
);

1013 
REQ_MSGIN
 :

1014 
	`´štk
("scsi%d :…hase = MESSAGE IN\n",

1015 
ho¡no
);

1018 
	`´štk
("scsi%d :…hase = UNKNOWN\n",

1019 
ho¡no
);

1020 
¡0x_abÜ‹d
 = 
DID_ERROR
;

1024 
¡©us_»ad
 & 
REQ_MASK
)

1026 
REQ_DATAOUT
 :

1032 #ifdeà
FAST


1033 ià(!
Ën
) {

1035 
	`´štk
("scsi%d: underflowoarget %d†un %d \n",

1036 
ho¡no
, 
rg‘
, 
lun
);

1037 
¡0x_abÜ‹d
 = 
DID_ERROR
;

1038 
ç¡
 = 0;

1043 ià(
ç¡
 && 
Œªsãrsize
 && !(
Ën
 %ransfersize) && (len >=ransfersize)

1044 #ifdeà
FAST32


1045 && !(
Œªsãrsize
 % 4)

1048 #ià(
DEBUG
 & 
DEBUG_FAST
)

1049 
	`´štk
("scsi%d : FASTransfer, underflow = %d,ransfersize = %d\n"

1050 "†’ = %d, d©¨ğ%08x\n", 
ho¡no
, 
SCšt
->
und”æow
,

1051 
SCšt
->
Œªsãrsize
, 
Ën
, 
d©a
);

1054 
	`__asm__
("

1055 
şd
;

1057 #ifdeà
FAST32


1059 1: 
lod¦
;

1060 
movl
 %%
—x
, (%%
edi
);

1064 
movb
 %%
®
, (%%
edi
);

1069 "D" (
¡0x_dr
), "S" (
d©a
), "c" (
SCšt
->
Œªsãrsize
) :

1073 
Ën
 -ğ
Œªsãrsize
;

1074 
d©a
 +ğ
Œªsãrsize
;

1076 #ià(
DEBUG
 & 
DEBUG_FAST
)

1077 
	`´štk
("scsi%d : FASTransfer complete†en = %d data = %08x\n",

1078 
ho¡no
, 
Ën
, 
d©a
);

1090 
	`__asm__
 (

1102 
jz
 2f

1104 
şd


1106 
movl
 
_¡0x_ü_¤
, %%
ebx


1107 
movl
 
_¡0x_dr
, %%
edi


1109 1: 
	`movb
 (%%
ebx
), %%
®
\
n
"

1115 
jz
 2f\
n
"

1121 
jnz
 2à\
n
"

1126 
jz
 1b

1127 
lodsb


1128 
movb
 %%
®
, (%%
edi
)

1129 
loİ
 1b

1134 "=S" (
d©a
), "=c" (
Ën
) :

1136 "0" (
d©a
), "1" (
Ën
) :

1141 ià(!
Ën
 && 
nobuffs
) {

1142 --
nobuffs
;

1143 ++
bufãr
;

1144 
Ën
 = 
bufãr
->
Ëngth
;

1145 
d©a
 = (*è
bufãr
->
add»ss
;

1146 #ià(
DEBUG
 & 
DEBUG_SG
)

1147 
	`´štk
("scsi%d :‚ext scatter-gather buffer†en = %d‡ddress = %08x\n",

1148 
ho¡no
, 
Ën
, 
d©a
);

1153 
REQ_DATAIN
 :

1154 #ifdeà
SLOW_HANDSHAKE


1155 ià(
bÜk’
) {

1156 #ià(
DEBUG
 & (
PHASE_DATAIN
))

1157 
Œªsã»d
 +ğ
Ën
;

1159 ; 
Ën
 && (
STATUS
 & (
REQ_MASK
 | 
STAT_REQ
)è=ğ(
REQ_DATAIN
 |

1160 
STAT_REQ
); --
Ën
) {

1161 *
d©a
++ = 
DATA
;

1162 
	`bÜk’_wa™
();

1164 #ià(
DEBUG
 & (
PHASE_DATAIN
))

1165 
Œªsã»d
 -ğ
Ën
;

1169 #ifdeà
FAST


1170 ià(
ç¡
 && 
Œªsãrsize
 && !(
Ën
 %ransfersize) && (len >=ransfersize)

1171 #ifdeà
FAST32


1172 && !(
Œªsãrsize
 % 4)

1175 #ià(
DEBUG
 & 
DEBUG_FAST
)

1176 
	`´štk
("scsi%d : FASTransfer, underflow = %d,ransfersize = %d\n"

1177 "†’ = %d, d©¨ğ%08x\n", 
ho¡no
, 
SCšt
->
und”æow
,

1178 
SCšt
->
Œªsãrsize
, 
Ën
, 
d©a
);

1180 
	`__asm__
("

1181 
şd
;

1183 #ifdeà
FAST32


1185 1: 
	`movl
 (%%
esi
), %%
—x
;

1186 
¡o¦
;

1190 
¡osb
;

1196 "S" (
¡0x_dr
), "D" (
d©a
), "c" (
SCšt
->
Œªsãrsize
) :

1200 
Ën
 -ğ
Œªsãrsize
;

1201 
d©a
 +ğ
Œªsãrsize
;

1203 #ià(
DEBUG
 & 
PHASE_DATAIN
)

1204 
	`´štk
("scsi%d:¿nsã»d +ğ%d\n", 
ho¡no
, 
Œªsãrsize
);

1205 
Œªsã»d
 +ğ
Œªsãrsize
;

1208 #ià(
DEBUG
 & 
DEBUG_FAST
)

1209 
	`´štk
("scsi%d : FASTransfer complete†en = %d data = %08x\n",

1210 
ho¡no
, 
Ën
, 
d©a
);

1217 #ià(
DEBUG
 & 
PHASE_DATAIN
)

1218 
	`´štk
("scsi%d:¿nsã»d +ğ%d\n", 
ho¡no
, 
Ën
);

1219 
Œªsã»d
 +ğ
Ën
;

1228 
	`__asm__
 (

1239 
jz
 2f

1241 
şd


1242 
movl
 
_¡0x_ü_¤
, %%
esi


1243 
movl
 
_¡0x_dr
, %%
ebx


1245 1: 
	`movb
 (%%
esi
), %%
®
\
n
"

1251 
jz
 2f\
n
"

1257 
ªdb
 %%
®
, %%
ah


1258 
cmpb
 
$0x04
, %%
ah


1259 
jÃ
 2f\
n
"

1265 
jz
 1b

1267 
	`movb
 (%%
ebx
), %%
®


1268 
¡osb


1269 
loİ
 1b\
n
"

1274 "=D" (
d©a
), "=c" (
Ën
) :

1276 "0" (
d©a
), "1" (
Ën
) :

1280 #ià(
DEBUG
 & 
PHASE_DATAIN
)

1281 
	`´štk
("scsi%d:¿nsã»d -ğ%d\n", 
ho¡no
, 
Ën
);

1282 
Œªsã»d
 -ğ
Ën
;

1287 ià(!
Ën
 && 
nobuffs
) {

1288 --
nobuffs
;

1289 ++
bufãr
;

1290 
Ën
 = 
bufãr
->
Ëngth
;

1291 
d©a
 = (*è
bufãr
->
add»ss
;

1292 #ià(
DEBUG
 & 
DEBUG_SG
)

1293 
	`´štk
("scsi%d :‚ext scatter-gather buffer†en = %d‡ddress = %08x\n",

1294 
ho¡no
, 
Ën
, 
d©a
);

1300 
REQ_CMDOUT
 :

1301 ((
¡©us_»ad
 = 
STATUS
è& 
STAT_BSY
) &&

1302 ((
¡©us_»ad
 & 
REQ_MASK
è=ğ
REQ_CMDOUT
))

1303 ià(
¡©us_»ad
 & 
STAT_REQ
) {

1304 
DATA
 = *(*è
cmnd
;

1305 
cmnd
 = 1+(*) cmnd;

1306 #ifdeà
SLOW_HANDSHAKE


1307 ià(
bÜk’
)

1308 
	`bÜk’_wa™
();

1313 
REQ_STATIN
 :

1314 
¡©us
 = 
DATA
;

1317 
REQ_MSGOUT
 :

1323 
CONTROL
 = 
BASE_CMD
 | 
CMD_DRVR_ENABLE
;

1328 
»£Ëù
) {

1329 
CAN_RECONNECT
:

1330 
DATA
 = 
	`IDENTIFY
(1, 
lun
);

1332 #ià(
DEBUG
 & (
PHASE_RESELECT
 | 
PHASE_MSGOUT
))

1333 
	`´štk
("scsi%d : s’ˆIDENTIFY mes§ge.\n", 
ho¡no
);

1336 #ifdeà
LINKED


1337 
LINKED_WRONG
:

1338 
DATA
 = 
ABORT
;

1339 
lšked_cÚÃùed
 = 0;

1340 
»£Ëù
 = 
CAN_RECONNECT
;

1341 
cÚÃù_loİ
;

1342 #ià(
DEBUG
 & (
PHASE_MSGOUT
 | 
DEBUG_LINKED
))

1343 
	`´štk
("scsi%d : s’ˆABORT mes§gtØÿnşšcÜ»ù I_T_L‚exus.\n", 
ho¡no
);

1346 #ià(
DEBUG
 & 
DEBUG_LINKED
)

1347 
	`´štk
("correct\n");

1350 
DATA
 = 
NOP
;

1351 
	`´štk
("scsi%d :¬g‘ %d„eque¡ed MSGOUT, s’ˆNOP mes§ge.\n", 
ho¡no
, 
rg‘
);

1355 
REQ_MSGIN
 :

1356 
mes§ge
 = 
DATA
) {

1357 
DISCONNECT
 :

1358 
should_»cÚÃù
 = 1;

1359 
cu¼’t_d©a
 = 
d©a
;

1360 
cu¼’t_bufãr
 = 
bufãr
;

1361 
cu¼’t_bufæ’
 = 
Ën
;

1362 
cu¼’t_nobuffs
 = 
nobuffs
;

1363 #ifdeà
LINKED


1364 
lšked_cÚÃùed
 = 0;

1366 
dÚe
=1;

1367 #ià(
DEBUG
 & (
PHASE_RESELECT
 | 
PHASE_MSGIN
))

1368 
	`´štk
("scsi%d : discÚÃùed.\n", 
ho¡no
);

1372 #ifdeà
LINKED


1373 
LINKED_CMD_COMPLETE
:

1374 
LINKED_FLG_CMD_COMPLETE
:

1376 
COMMAND_COMPLETE
 :

1380 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1381 
	`´štk
("scsi%d : commªd com¶‘e.\n", 
ho¡no
);

1383 
dÚe
 = 1;

1385 
ABORT
 :

1386 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1387 
	`´štk
("scsi%d :‡bÜˆmes§ge.\n", 
ho¡no
);

1389 
dÚe
=1;

1391 
SAVE_POINTERS
 :

1392 
cu¼’t_bufãr
 = 
bufãr
;

1393 
cu¼’t_bufæ’
 = 
Ën
;

1394 
cu¼’t_d©a
 = 
d©a
;

1395 
cu¼’t_nobuffs
 = 
nobuffs
;

1396 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1397 
	`´štk
("scsi%d :…oš‹r §ved.\n", 
ho¡no
);

1400 
RESTORE_POINTERS
:

1401 
bufãr
=
cu¼’t_bufãr
;

1402 
cmnd
=
cu¼’t_cmnd
;

1403 
d©a
=
cu¼’t_d©a
;

1404 
Ën
=
cu¼’t_bufæ’
;

1405 
nobuffs
=
cu¼’t_nobuffs
;

1406 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1407 
	`´štk
("scsi%d :…oš‹r »¡Üed.\n", 
ho¡no
);

1421 ià(
mes§ge
 & 0x80) {

1422 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1423 
	`´štk
("scsi%d : IDENTIFY message„eceived from id %d,†un %d.\n",

1424 
ho¡no
, 
rg‘
, 
mes§ge
 & 7);

1434 #ià(
DEBUG
 & 
PHASE_MSGIN
)

1435 
	`´štk
("scsi%d : unknown message %d fromarget %d.\n",

1436 
ho¡no
, 
mes§ge
, 
rg‘
);

1443 
	`´štk
("scsi%d : unknowÀpha£.\n", 
ho¡no
);

1444 
¡0x_abÜ‹d
 = 
DID_ERROR
;

1447 #ifdeà
SLOW_HANDSHAKE


1453 ià(
bÜk’
)

1454 
	`bÜk’_wa™
();

1460 #ià(
DEBUG
 & (
PHASE_DATAIN
 | 
PHASE_DATAOUT
 | 
PHASE_EXIT
))

1461 
	`´štk
("scsi%d : T¿nsã»d %d by‹s\n", 
ho¡no
, 
Œªsã»d
);

1464 #ià(
DEBUG
 & 
PHASE_EXIT
)

1466 
	`´štk
("Buffer : \n");

1467 
i
 = 0; i < 20; ++i)

1468 
	`´štk
 ("%02x ", ((*è
d©a
)[
i
]);

1469 
	`´štk
("\n");

1471 
	`´štk
("scsi%d : stu ğ", 
ho¡no
);

1472 
	`´št_¡©us
(
¡©us
);

1473 
	`´štk
("mes§gğ%02x\n", 
mes§ge
);

1478 #ifdeà
nÙy‘


1479 ià(
¡0x_abÜ‹d
) {

1480 ià(
STATUS
 & 
STAT_BSY
) {

1481 
	`£ag©e_¡0x_»£t
(
NULL
);

1482 
¡0x_abÜ‹d
 = 
DID_RESET
;

1484 
abÜt_cÚfœm
 = 1;

1488 #ifdeà
LINKED


1500 
mes§ge
) {

1501 
LINKED_CMD_COMPLETE
 :

1502 
LINKED_FLG_CMD_COMPLETE
 :

1503 
mes§ge
 = 
COMMAND_COMPLETE
;

1504 
lšked_rg‘
 = 
cu¼’t_rg‘
;

1505 
lšked_lun
 = 
cu¼’t_lun
;

1506 
lšked_cÚÃùed
 = 1;

1507 #ià(
DEBUG
 & 
DEBUG_LINKED
)

1508 
	`´štk
("scsi%d : keeping I_T_L‚exusƒstablished for†inked command.\n",

1509 
ho¡no
);

1514 ià((
¡©us
 =ğ
INTERMEDIATE_GOOD
) ||

1515 (
¡©us
 =ğ
INTERMEDIATE_C_GOOD
))

1516 
¡©us
 = 
GOOD
;

1526 #ià(
DEBUG
 & 
DEBUG_LINKED
)

1527 
	`´štk
("scsi%d : closšg I_T_L‚exus.\n", 
ho¡no
);

1529 
lšked_cÚÃùed
 = 0;

1537 ià(
should_»cÚÃù
) {

1538 #ià(
DEBUG
 & 
PHASE_RESELECT
)

1539 
	`´štk
("scsi%d :ƒxiting seagate_st0x_queue_command() with„econnectƒnabled.\n",

1540 
ho¡no
);

1542 
CONTROL
 = 
BASE_CMD
 | 
CMD_INTR
 ;

1544 
CONTROL
 = 
BASE_CMD
;

1546  
	`»tcode
 (
¡0x_abÜ‹d
);

1547 
	}
}

1549 
	$£ag©e_¡0x_abÜt
 (
Scsi_Cmnd
 * 
SC²t
, 
code
)

1551 ià(
code
)

1552 
¡0x_abÜ‹d
 = 
code
;

1554 
¡0x_abÜ‹d
 = 
DID_ABORT
;

1557 
	}
}

1563 
	$£ag©e_¡0x_»£t
 (
Scsi_Cmnd
 * 
SC²t
)

1565 
şock
;

1571 #ifdeà
DEBUG


1572 
	`´štk
("In seagate_st0x_reset()\n");

1578 
CONTROL
 = 
BASE_CMD
 | 
CMD_RST
;

1579 
şock
=
jiff›s
+2;

1584 
jiff›s
 < 
şock
);

1586 
CONTROL
 = 
BASE_CMD
;

1588 
¡0x_abÜ‹d
 = 
DID_RESET
;

1590 #ifdeà
DEBUG


1591 
	`´štk
("SCSI bus„eset.\n");

1593 if(
SC²t
èSC²t->
æags
 |ğ
NEEDS_JUMPSTART
;

1595 
	}
}

1597 #ifdeà
CONFIG_BLK_DEV_SD


1599 
	~<asm/£gm’t.h
>

1600 
	~"sd.h
"

1601 
	~"scsi_ioùl.h
"

1603 
	$£ag©e_¡0x_bio¥¬am
(
size
, 
dev
, * 

) {

1604 
buf
[256 + (è* 2], 
cmd
[6], *
d©a
, *
·ge
;

1605 *
sizes
, 
»suÉ
, 
fÜm©‹d_£ùÜs
, 
tÙ®_£ùÜs
;

1606 
cylšd”s
, 
h—ds
, 
£ùÜs
;

1608 
Scsi_Deviû
 *
disk
;

1610 
disk
 = 
rscsi_disks
[
	`MINOR
(
dev
è>> 4].
deviû
;

1617 ià(
disk
->
scsi_Ëv–
 < 2)

1620 
sizes
 = (*è
buf
;

1621 
d©a
 = (*è(
sizes
 + 2);

1623 
cmd
[0] = 
MODE_SENSE
;

1624 
cmd
[1] = (
disk
->
lun
 << 5) & 0xe5;

1625 
cmd
[2] = 0x04;

1626 
cmd
[3] = 0;

1627 
cmd
[4] = 255;

1628 
cmd
[5] = 0;

1635 
sizes
[0] = 0;

1636 
sizes
[1] = 256;

1638 
	`memıy
 (
d©a
, 
cmd
, 6);

1640 ià(!(
»suÉ
 = 
	`k”Ãl_scsi_ioùl
 (
disk
, 
SCSI_IOCTL_SEND_COMMAND
, (*è
buf
))) {

1646 
·ge
 = 
d©a
 + 4 + data[3];

1647 
h—ds
 = (è
·ge
[5];

1648 
cylšd”s
 = (
·ge
[2] << 16) | (page[3] << 8) |…age[4];

1650 
cmd
[2] = 0x03;

1651 
	`memıy
 (
d©a
, 
cmd
, 6);

1653 ià(!(
»suÉ
 = 
	`k”Ãl_scsi_ioùl
 (
disk
, 
SCSI_IOCTL_SEND_COMMAND
, (*è
buf
))) {

1654 
·ge
 = 
d©a
 + 4 + data[3];

1655 
£ùÜs
 = (
·ge
[10] << 8) |…age[11];

1663 
fÜm©‹d_£ùÜs
 = (
d©a
[4 + 1] << 16) | (data[4 + 2] << 8) |

1664 
d©a
[4 + 3] ;

1666 
tÙ®_£ùÜs
 = (
h—ds
 * 
cylšd”s
 * 
£ùÜs
);

1676 
	`´štk
("scsi%d : heads = %d cylinders = %d sectors = %dotal = %d formatted = %d\n",

1677 
ho¡no
, 
h—ds
, 
cylšd”s
, 
£ùÜs
, 
tÙ®_£ùÜs
, 
fÜm©‹d_£ùÜs
);

1679 ià(!
h—ds
 || !
£ùÜs
 || !
cylšd”s
)

1680 
»suÉ
 = -1;

1682 
cylšd”s
 -ğ((
tÙ®_£ùÜs
 - 
fÜm©‹d_£ùÜs
è/ (
h—ds
 * 
£ùÜs
));

1690 ià((
cylšd”s
 > 1024è|| (
£ùÜs
 > 64))

1691 
»suÉ
 = -1;

1693 

[0] = 
h—ds
;

1694 

[1] = 
£ùÜs
;

1695 

[2] = 
cylšd”s
;

1706  
»suÉ
;

1707 
	}
}

	@drivers/scsi/seagate.h

9 #iâdeà
_SEAGATE_H


10 
	#SEAGATE_H


	)

14 #iâdeà
ASM


15 
£ag©e_¡0x_d‘eù
();

16 
£ag©e_¡0x_commªd
(
Scsi_Cmnd
 *);

17 
£ag©e_¡0x_queue_commªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

19 
	`£ag©e_¡0x_abÜt
(
Scsi_Cmnd
 *, );

20 cÚ¡ *
	`£ag©e_¡0x_šfo
();

21 
	`£ag©e_¡0x_»£t
(
Scsi_Cmnd
 *);

23 #iâdeà
NULL


24 
	#NULL
 0

	)

27 #ifdeà
CONFIG_BLK_DEV_SD


28 
	`£ag©e_¡0x_bio¥¬am
(, , *);

30 
	#£ag©e_¡0x_bio¥¬am
 
NULL


	)

33 
	#SEAGATE_ST0X
 {"S—g©ST-01/ST-02", 
£ag©e_¡0x_d‘eù
, \

34 
£ag©e_¡0x_šfo
, 
£ag©e_¡0x_commªd
, \

35 
£ag©e_¡0x_queue_commªd
, 
£ag©e_¡0x_abÜt
, \

36 
£ag©e_¡0x_»£t
, 
NULL
, 
£ag©e_¡0x_bio¥¬am
, \

37 1, 7, 
SG_ALL
, 1, 0, 0
	}

	)
}

45 
	#PARITY


	)

58 
	#CMD_RST
 0x01

	)

59 
	#CMD_SEL
 0x02

	)

60 
	#CMD_BSY
 0x04

	)

61 
	#CMD_ATTN
 0x08

	)

62 
	#CMD_START_ARB
 0x10

	)

63 
	#CMD_EN_PARITY
 0x20

	)

64 
	#CMD_INTR
 0x40

	)

65 
	#CMD_DRVR_ENABLE
 0x80

	)

71 
	#STAT_BSY
 0x01

	)

72 
	#STAT_MSG
 0x02

	)

73 
	#STAT_IO
 0x04

	)

74 
	#STAT_CD
 0x08

	)

75 
	#STAT_REQ
 0x10

	)

76 
	#STAT_SEL
 0x20

	)

77 
	#STAT_PARITY
 0x40

	)

78 
	#STAT_ARB_CMPL
 0x80

	)

84 
	#REQ_MASK
 (
STAT_CD
 | 
STAT_IO
 | 
STAT_MSG
)

	)

85 
	#REQ_DATAOUT
 0

	)

86 
	#REQ_DATAIN
 
STAT_IO


	)

87 
	#REQ_CMDOUT
 
STAT_CD


	)

88 
	#REQ_STATIN
 (
STAT_CD
 | 
STAT_IO
)

	)

89 
	#REQ_MSGOUT
 (
STAT_MSG
 | 
STAT_CD
)

	)

90 
	#REQ_MSGIN
 (
STAT_MSG
 | 
STAT_CD
 | 
STAT_IO
)

	)

92 vŞ©
£ag©e_¡0x_timeout
;

94 #ifdeà
PARITY


95 
	#BASE_CMD
 
CMD_EN_PARITY


	)

97 
	#BASE_CMD
 0

	)

104 
	#PHASE_BUS_FREE
 1

	)

105 
	#PHASE_ARBITRATION
 2

	)

106 
	#PHASE_SELECTION
 4

	)

107 
	#PHASE_DATAIN
 8

	)

108 
	#PHASE_DATAOUT
 0x10

	)

109 
	#PHASE_CMDOUT
 0x20

	)

110 
	#PHASE_MSGIN
 0x40

	)

111 
	#PHASE_MSGOUT
 0x80

	)

112 
	#PHASE_STATUSIN
 0x100

	)

113 
	#PHASE_ETC
 (
PHASE_DATAIN
 | 
PHASE_DATA_OUT
 | 
PHASE_CMDOUT
 | 
PHASE_MSGIN
 | 
PHASE_MSGOUT
 | 
PHASE_STATUSIN
)

	)

114 
	#PRINT_COMMAND
 0x200

	)

115 
	#PHASE_EXIT
 0x400

	)

116 
	#PHASE_RESELECT
 0x800

	)

117 
	#DEBUG_FAST
 0x1000

	)

118 
	#DEBUG_SG
 0x2000

	)

119 
	#DEBUG_LINKED
 0x4000

	)

120 
	#DEBUG_BORKEN
 0x8000

	)

127 
	#ST0X_BUS_FREE_DELAY
 25

	)

128 
	#ST0X_SELECTION_DELAY
 25

	)

130 
	#eoi
(è
	`__asm__
("push %%—x\nmovb $0x20, %%®\noutb %%®, $0x20\Åİ %%—x"::)

	)

132 
	#SEAGATE
 1

	)

133 
	#FD
 2

	)

	@drivers/scsi/sg.c

10 
	~<lšux/fs.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/mtio.h
>

16 
	~<lšux/ioùl.h
>

17 
	~<lšux/fú.h
>

18 
	~<asm/io.h
>

19 
	~<asm/£gm’t.h
>

20 
	~<asm/sy¡em.h
>

22 
	~"../block/blk.h
"

23 
	~"scsi.h
"

24 
	~"scsi_ioùl.h
"

25 
	~"sg.h
"

27 
	gNR_SG
=0;

28 
	gMAX_SG
=0;

30 #ifdeà
SG_BIG_BUFF


31 *
	gbig_buff
;

32 
wa™_queue
 *
	gbig_wa™
;

33 
	gbig_šu£
=0;

36 
	sscsi_g’”ic


38 
Scsi_Deviû
 *
	mdeviû
;

39 
	mu£rs
;

40 
wa™_queue
 *
	mg’”ic_wa™
;

41 
wa™_queue
 *
	m»ad_wa™
;

42 
wa™_queue
 *
	mwr™e_wa™
;

43 
	mtimeout
;

44 
	mbuff_Ën
;

45 *
	mbuff
;

46 
sg_h—d”
 
	mh—d”
;

47 
	mexşude
;

48 
	m³ndšg
;

49 
	mcom¶‘e
;

52 
scsi_g’”ic
 *
	gscsi_g’”ics
=
NULL
;

54 
	$sg_ioùl
(
šode
 * inode,
fe
 * file,

55 
cmd_š
, 
¬g
)

57 
dev
 = 
	`MINOR
(
šode
->
i_rdev
);

58 ià((
dev
<0è|| (dev>=
NR_SG
))

59  -
ENODEV
;

60 
cmd_š
)

62 
SG_SET_TIMEOUT
:

63 
scsi_g’”ics
[
dev
].
timeout
=
	`g‘_fs_lÚg
((*è
¬g
);

65 
SG_GET_TIMEOUT
:

66  
scsi_g’”ics
[
dev
].
timeout
;

68  
	`scsi_ioùl
(
scsi_g’”ics
[
dev
].
deviû
, 
cmd_š
, (*è
¬g
);

70 
	}
}

72 
	$sg_İ’
(
šode
 * inode, 
fe
 * 
fp
)

74 
dev
=
	`MINOR
(
šode
->
i_rdev
);

75 
æags
=
fp
->
f_æags
;

76 ià(
dev
>=
NR_SG
)

77  -
ENODEV
;

78 ià(
O_RDWR
!=(
æags
 & 
O_ACCMODE
))

79  -
EACCES
;

80 ià(
æags
 & 
O_EXCL
)

82 
scsi_g’”ics
[
dev
].
u£rs
)

84 ià(
æags
 & 
O_NONBLOCK
)

85  -
EBUSY
;

86 
	`š‹¼u±ibË_¦“p_Ú
(&
scsi_g’”ics
[
dev
].
g’”ic_wa™
);

87 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

88  -
ERESTARTSYS
;

90 
scsi_g’”ics
[
dev
].
exşude
=1;

93 
scsi_g’”ics
[
dev
].
exşude
)

95 ià(
æags
 & 
O_NONBLOCK
)

96  -
EBUSY
;

97 
	`š‹¼u±ibË_¦“p_Ú
(&
scsi_g’”ics
[
dev
].
g’”ic_wa™
);

98 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

99  -
ERESTARTSYS
;

101 ià(!
scsi_g’”ics
[
dev
].
u£rs
 && scsi_g’”ics[dev].
³ndšg
 && scsi_g’”ics[dev].
com¶‘e
)

103 
	`scsi_ä“
(
scsi_g’”ics
[
dev
].
buff
,scsi_g’”ics[dev].
buff_Ën
);

104 
scsi_g’”ics
[
dev
].
³ndšg
=0;

106 ià(!
scsi_g’”ics
[
dev
].
u£rs
)

107 
scsi_g’”ics
[
dev
].
timeout
=
SG_DEFAULT_TIMEOUT
;

108 
scsi_g’”ics
[
dev
].
u£rs
++;

110 
	}
}

112 
	$sg_şo£
(
šode
 * inode, 
fe
 * 
fp
)

114 
dev
=
	`MINOR
(
šode
->
i_rdev
);

115 
scsi_g’”ics
[
dev
].
u£rs
--;

116 
scsi_g’”ics
[
dev
].
exşude
=0;

117 
	`wake_up
(&
scsi_g’”ics
[
dev
].
g’”ic_wa™
);

118 
	}
}

120 *
	$sg_m®loc
(
size
)

122 ià(
size
<=4096)

123  (*è
	`scsi_m®loc
(
size
);

124 #ifdeà
SG_BIG_BUFF


125 ià(
size
<
SG_BIG_BUFF
)

127 
big_šu£
)

129 
	`š‹¼u±ibË_¦“p_Ú
(&
big_wa™
);

130 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

131  
NULL
;

133 
big_šu£
=1;

134  
big_buff
;

137  
NULL
;

138 
	}
}

140 
	$sg_ä“
(*
buff
,
size
)

142 #ifdeà
SG_BIG_BUFF


143 ià(
buff
==
big_buff
)

145 
big_šu£
=0;

146 
	`wake_up
(&
big_wa™
);

150 
	`scsi_ä“
(
buff
,
size
);

151 
	}
}

153 
	$sg_»ad
(
šode
 *šode,
fe
 *
fp
,*
buf
,
couÁ
)

155 
dev
=
	`MINOR
(
šode
->
i_rdev
);

156 
i
;

157 
scsi_g’”ic
 *
deviû
=&
scsi_g’”ics
[
dev
];

158 ià((
i
=
	`v”ify_¬—
(
VERIFY_WRITE
,
buf
,
couÁ
)))

159  
i
;

160 !
deviû
->
³ndšg
 || !deviû->
com¶‘e
)

162 ià(
fp
->
f_æags
 & 
O_NONBLOCK
)

163  -
EWOULDBLOCK
;

164 
	`š‹¼u±ibË_¦“p_Ú
(&
deviû
->
»ad_wa™
);

165 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

166  -
ERESTARTSYS
;

168 
deviû
->
h—d”
.
·ck_Ën
=deviû->h—d”.
»¶y_Ën
;

169 
deviû
->
h—d”
.
»suÉ
=0;

170 ià(
couÁ
>=(
sg_h—d”
))

172 
	`memıy_tofs
(
buf
,&
deviû
->
h—d”
,(
sg_h—d”
));

173 
buf
+=(
sg_h—d”
);

174 ià(
couÁ
>
deviû
->
h—d”
.
·ck_Ën
)

175 
couÁ
=
deviû
->
h—d”
.
·ck_Ën
;

176 
	`memıy_tofs
(
buf
,
deviû
->
buff
,
couÁ
-(
sg_h—d”
));

179 
couÁ
=0;

180 
	`sg_ä“
(
deviû
->
buff
,deviû->
buff_Ën
);

181 
deviû
->
³ndšg
=0;

182 
	`wake_up
(&
deviû
->
wr™e_wa™
);

183  
couÁ
;

184 
	}
}

186 
	$sg_commªd_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

188 
dev
=
SC²t
->
»que¡
.dev;

189 
scsi_g’”ic
 *
deviû
=&
scsi_g’”ics
[
dev
];

190 ià(!
deviû
->
³ndšg
)

192 
	`´štk
("uÃx³ùed dÚfÜ sg %d\n",
dev
);

193 
SC²t
->
»que¡
.
dev
=-1;

196 ià(
SC²t
->
£n£_bufãr
[0])

198 
deviû
->
h—d”
.
»suÉ
=
EIO
;

201 
deviû
->
h—d”
.
»suÉ
=
SC²t
->result;

202 
deviû
->
com¶‘e
=1;

203 
SC²t
->
»que¡
.
dev
=-1;

204 
	`wake_up
(&
scsi_g’”ics
[
dev
].
»ad_wa™
);

205 
	}
}

207 
	$sg_wr™e
(
šode
 *šode,
fe
 *
fp
,*
buf
,
couÁ
)

209 
dev
=
	`MINOR
(
šode
->
i_rdev
);

210 
Scsi_Cmnd
 *
SC²t
;

211 
bsize
,
size
,
amt
,
i
;

212 
cmnd
[
MAX_COMMAND_SIZE
];

213 
scsi_g’”ic
 *
deviû
=&
scsi_g’”ics
[
dev
];

214 ià((
i
=
	`v”ify_¬—
(
VERIFY_READ
,
buf
,
couÁ
)))

215  
i
;

216 ià(
couÁ
<(
sg_h—d”
))

217  -
EIO
;

219 
deviû
->
³ndšg
)

221 ià(
fp
->
f_æags
 & 
O_NONBLOCK
)

222  -
EWOULDBLOCK
;

223 #ifdeà
DEBUG


224 
	`´štk
("sg_write: sleeping on…ending„equest\n");

226 
	`š‹¼u±ibË_¦“p_Ú
(&
deviû
->
wr™e_wa™
);

227 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

228  -
ERESTARTSYS
;

230 
deviû
->
³ndšg
=1;

231 
deviû
->
com¶‘e
=0;

232 
	`memıy_äomfs
(&
deviû
->
h—d”
,
buf
,(
sg_h—d”
));

234 
deviû
->
h—d”
.
·ck_Ën
=
couÁ
;

235 
buf
+=(
sg_h—d”
);

236 
bsize
=(
deviû
->
h—d”
.
·ck_Ën
>deviû->h—d”.
»¶y_Ën
) ? device->header.pack_len : device->header.reply_len;

237 
bsize
-=(
sg_h—d”
);

238 
amt
=
bsize
;

239 ià(!
bsize
)

240 
bsize
++;

241 
bsize
=(bsize+511) & ~511;

242 ià((
bsize
<0è|| !(
deviû
->
buff
=
	`sg_m®loc
(deviû->
buff_Ën
=bsize)))

244 
deviû
->
³ndšg
=0;

245 
	`wake_up
(&
deviû
->
wr™e_wa™
);

246  -
ENOMEM
;

248 #ifdeà
DEBUG


249 
	`´štk
("allocating device\n");

251 ià(!(
SC²t
=
	`®loÿ‹_deviû
(
NULL
,
deviû
->deviû->
šdex
, !(
fp
->
f_æags
 & 
O_NONBLOCK
))))

253 
deviû
->
³ndšg
=0;

254 
	`wake_up
(&
deviû
->
wr™e_wa™
);

255 
	`sg_ä“
(
deviû
->
buff
,deviû->
buff_Ën
);

256  -
EWOULDBLOCK
;

258 #ifdeà
DEBUG


259 
	`´štk
("device‡llocated\n");

262 
SC²t
->
»que¡
.
dev
=dev;

263 
SC²t
->
£n£_bufãr
[0]=0;

264 
size
=
	`COMMAND_SIZE
(
	`g‘_fs_by‹
(
buf
));

265 
	`memıy_äomfs
(
cmnd
,
buf
,
size
);

266 
buf
+=
size
;

267 
	`memıy_äomfs
(
deviû
->
buff
,
buf
,deviû->
h—d”
.
·ck_Ën
-
size
-(
sg_h—d”
));

268 
cmnd
[1]=(cmnd[1] & 0x1fè| (
deviû
->deviû->
lun
<<5);

269 #ifdeà
DEBUG


270 
	`´štk
("do cmd\n");

272 
	`scsi_do_cmd
 (
SC²t
,(*è
cmnd
,

273 (*è
deviû
->
buff
,
amt
,
sg_commªd_dÚe
,deviû->
timeout
,
SG_DEFAULT_RETRIES
);

274 #ifdeà
DEBUG


275 
	`´štk
("done cmd\n");

277  
couÁ
;

278 
	}
}

280 
fe_İ”©iÚs
 
	gsg_fİs
 = {

281 
NULL
,

282 
sg_»ad
,

283 
sg_wr™e
,

284 
NULL
,

285 
NULL
,

286 
sg_ioùl
,

287 
NULL
,

288 
sg_İ’
,

289 
sg_şo£
,

290 
NULL


295 
	$sg_š™
(
mem_¡¬t
, 
mem_’d
)

297 ià(
	`»gi¡”_chrdev
(
SCSI_GENERIC_MAJOR
,"sg",&
sg_fİs
))

299 
	`´štk
("Unableo get major %d for generic SCSI device\n",

300 
SCSI_GENERIC_MAJOR
);

301  
mem_¡¬t
;

303 ià(
NR_SG
 =ğ0è 
mem_¡¬t
;

305 #ifdeà
DEBUG


306 
	`´štk
("sg: Init generic device.\n");

309 #ifdeà
SG_BIG_BUFF


310 
big_buff
ğ(*è
mem_¡¬t
;

311 
mem_¡¬t
+=
SG_BIG_BUFF
;

313  
mem_¡¬t
;

314 
	}
}

316 
	$sg_š™1
(
mem_¡¬t
, 
mem_’d
)

318 
scsi_g’”ics
 = (
scsi_g’”ic
 *è
mem_¡¬t
;

319 
mem_¡¬t
 +ğ
MAX_SG
 * (
scsi_g’”ic
);

320  
mem_¡¬t
;

321 
	}
};

323 
	$sg_©ch
(
Scsi_Deviû
 * 
SDp
)

325 if(
NR_SG
 >ğ
MAX_SG
)

326 
	`·nic
 ("scsi_devices corrupt (sg)");

327 
scsi_g’”ics
[
NR_SG
].
deviû
=
SDp
;

328 
scsi_g’”ics
[
NR_SG
].
u£rs
=0;

329 
scsi_g’”ics
[
NR_SG
].
g’”ic_wa™
=
NULL
;

330 
scsi_g’”ics
[
NR_SG
].
»ad_wa™
=
NULL
;

331 
scsi_g’”ics
[
NR_SG
].
wr™e_wa™
=
NULL
;

332 
scsi_g’”ics
[
NR_SG
].
exşude
=0;

333 
scsi_g’”ics
[
NR_SG
].
³ndšg
=0;

334 
scsi_g’”ics
[
NR_SG
].
timeout
=
SG_DEFAULT_TIMEOUT
;

335 
NR_SG
++;

336 
	}
};

	@drivers/scsi/sg.h

14 
	ssg_h—d”


16 
	m·ck_Ën
;

17 
	m»¶y_Ën
;

18 
	m·ck_id
;

19 
	m»suÉ
;

24 
	#SG_SET_TIMEOUT
 0x2201

	)

25 
	#SG_GET_TIMEOUT
 0x2202

	)

27 
	#SG_DEFAULT_TIMEOUT
 6000

	)

28 
	#SG_DEFAULT_RETRIES
 1

	)

30 
	#SG_MAX_QUEUE
 4

	)

33 
	#SG_BIG_BUFF
 32768

	)

	@drivers/scsi/sr.c

16 
	~<lšux/fs.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/sched.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<asm/sy¡em.h
>

23 
	#MAJOR_NR
 
SCSI_CDROM_MAJOR


	)

24 
	~"../block/blk.h
"

25 
	~"scsi.h
"

26 
	~"ho¡s.h
"

27 
	~"¤.h
"

28 
	~"scsi_ioùl.h
"

29 
	~"cÚ¡ªts.h
"

31 
	#MAX_RETRIES
 1

	)

32 
	#SR_TIMEOUT
 500

	)

34 
	gNR_SR
=0;

35 
	gMAX_SR
=0;

36 
Scsi_CD
 * 
	gscsi_CDs
;

37 * 
	g¤_sizes
;

39 * 
	g¤_blocksizes
;

41 
¤_İ’
(
šode
 *, 
fe
 *);

42 
g‘_£ùÜsize
();

44 
¤_ioùl
(
šode
 *, 
fe
 *, , );

46 
»queue_¤_»que¡
 (
Scsi_Cmnd
 * 
SC²t
);

48 
	$¤_»Ëa£
(
šode
 * inode, 
fe
 * file)

50 
	`sync_dev
(
šode
->
i_rdev
);

51 if(! --
scsi_CDs
[
	`MINOR
(
šode
->
i_rdev
)].
deviû
->
acûss_couÁ
)

52 
	`¤_ioùl
(
šode
, 
NULL
, 
SCSI_IOCTL_DOORUNLOCK
, 0);

53 
	}
}

55 
fe_İ”©iÚs
 
	g¤_fİs
 =

57 
NULL
,

58 
block_»ad
,

59 
block_wr™e
,

60 
NULL
,

61 
NULL
,

62 
¤_ioùl
,

63 
NULL
,

64 
¤_İ’
,

65 
¤_»Ëa£
,

66 
NULL


79 
	$check_cdrom_medŸ_chªge
(
fuÎ_dev
, 
æag
){

80 
»tv®
, 
rg‘
;

81 
šode
 inode;

83 
rg‘
 = 
	`MINOR
(
fuÎ_dev
);

85 ià(
rg‘
 >ğ
NR_SR
) {

86 
	`´štk
("CD-ROM„equestƒrror: invalid device.\n");

90 
šode
.
i_rdev
 = 
fuÎ_dev
;

91 
»tv®
 = 
	`¤_ioùl
(&
šode
, 
NULL
, 
SCSI_IOCTL_TEST_UNIT_READY
, 0);

93 if(
»tv®
){

98 
scsi_CDs
[
rg‘
].
deviû
->
chªged
 = 1;

103 
»tv®
 = 
scsi_CDs
[
rg‘
].
deviû
->
chªged
;

104 if(!
æag
) {

105 
scsi_CDs
[
rg‘
].
deviû
->
chªged
 = 0;

108 ià(
»tv®
è
scsi_CDs
[
rg‘
].
Ãeds_£ùÜ_size
 = 1;

110  
»tv®
;

111 
	}
}

118 
	$rw_šŒ
 (
Scsi_Cmnd
 * 
SC²t
)

120 
»suÉ
 = 
SC²t
->result;

121 
this_couÁ
 = 
SC²t
->this_count;

123 #ifdeà
DEBUG


124 
	`´štk
("¤.ødÚe: %x %x\n",
»suÉ
, 
SC²t
->
»que¡
.
bh
->
b_d©a
);

126 ià(!
»suÉ
)

128 ià(
SC²t
->
u£_sg
 == 0) {

129 ià(
SC²t
->
bufãr
 !ğSC²t->
»que¡
.buffer)

131 
off£t
;

132 
off£t
 = (
SC²t
->
»que¡
.
£ùÜ
 % 4) << 9;

133 
	`memıy
((*)
SC²t
->
»que¡
.
bufãr
,

134 (*)
SC²t
->
bufãr
 + 
off£t
,

135 
this_couÁ
 << 9);

140 if((
off£t
 =ğ0è&& 
this_couÁ
 == 2 &&

141 
SC²t
->
»que¡
.
Ä_£ùÜs
 > 
this_couÁ
 &&

142 
SC²t
->
»que¡
.
bh
 &&

143 
SC²t
->
»que¡
.
bh
->
b_»qÃxt
 &&

144 
SC²t
->
»que¡
.
bh
->
b_»qÃxt
->
b_size
 == 1024) {

145 
	`memıy
((*)
SC²t
->
»que¡
.
bh
->
b_»qÃxt
->
b_d©a
,

146 (*)
SC²t
->
bufãr
 + 1024,

148 
this_couÁ
 += 2;

151 
	`scsi_ä“
(
SC²t
->
bufãr
, 2048);

154 
sÿ‰”li¡
 * 
sg²t
;

155 
i
;

156 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
bufãr
;

157 
i
=0; i<
SC²t
->
u£_sg
; i++) {

158 ià(
sg²t
[
i
].
®t_add»ss
) {

159 ià(
sg²t
[
i
].
®t_add»ss
 !ğsg²t[i].
add»ss
) {

160 
	`memıy
(
sg²t
[
i
].
®t_add»ss
, sg²t[i].
add»ss
, sg²t[i].
Ëngth
);

162 
	`scsi_ä“
(
sg²t
[
i
].
add»ss
, sg²t[i].
Ëngth
);

165 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
sgli¡_Ën
);

166 if(
SC²t
->
»que¡
.
£ùÜ
 % 4è
this_couÁ
 -= 2;

168 if(
this_couÁ
 > 
SC²t
->
»que¡
.
Ä_£ùÜs
)

169 
this_couÁ
 -= 2;

172 #ifdeà
DEBUG


173 
	`´štk
("(%x %x %xè",
SC²t
->
»que¡
.
bh
, SC²t->»que¡.
Ä_£ùÜs
,

174 
this_couÁ
);

176 ià(
SC²t
->
»que¡
.
Ä_£ùÜs
 > 
this_couÁ
)

178 
SC²t
->
»que¡
.
”rÜs
 = 0;

179 ià(!
SC²t
->
»que¡
.
bh
)

180 
	`·nic
("sr.c:†inked…age„equest (%lx %x)",

181 
SC²t
->
»que¡
.
£ùÜ
, 
this_couÁ
);

184 
	`’d_scsi_»que¡
(
SC²t
, 1, 
this_couÁ
);

185 
	`»queue_¤_»que¡
(
SC²t
);

192 ià(
SC²t
->
u£_sg
) {

193 
sÿ‰”li¡
 * 
sg²t
;

194 
i
;

195 
sg²t
 = (
sÿ‰”li¡
 *è
SC²t
->
bufãr
;

196 
i
=0; i<
SC²t
->
u£_sg
; i++) {

197 ià(
sg²t
[
i
].
®t_add»ss
) {

198 
	`scsi_ä“
(
sg²t
[
i
].
add»ss
, sg²t[i].
Ëngth
);

201 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
sgli¡_Ën
);

203 ià(
SC²t
->
bufãr
 !ğSC²t->
»que¡
.buffer)

204 
	`scsi_ä“
(
SC²t
->
bufãr
, SC²t->
bufæ’
);

207 ià(
	`driv”_by‹
(
»suÉ
) != 0) {

208 ià((
SC²t
->
£n£_bufãr
[0] & 0x7f) == 0x70) {

209 ià((
SC²t
->
£n£_bufãr
[2] & 0xfè=ğ
UNIT_ATTENTION
) {

213 
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
chªged
 = 1;

214 
	`’d_scsi_»que¡
(
SC²t
, 0, 
this_couÁ
);

215 
	`»queue_¤_»que¡
(
SC²t
);

220 ià(
SC²t
->
£n£_bufãr
[2] =ğ
ILLEGAL_REQUEST
) {

221 
	`´štk
("CD-ROMƒrror: Drive„eports ILLEGAL REQUEST.\n");

222 ià(
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
‹n
) {

223 
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
‹n
 = 0;

224 
	`»queue_¤_»que¡
(
SC²t
);

225 
»suÉ
 = 0;

228 
	`´štk
("CD-ROMƒ¼Ü: Driv»pÜt %d.\n", 
SC²t
->
£n£_bufãr
[2]);

229 
	`’d_scsi_»que¡
(
SC²t
, 0, 
this_couÁ
);

230 
	`»queue_¤_»que¡
(
SC²t
);

236 ià(
SC²t
->
£n£_bufãr
[2] =ğ
NOT_READY
) {

237 
	`´štk
("CDROM‚ot„eady. Make sure you have‡ disc inhe drive.\n");

238 
	`’d_scsi_»que¡
(
SC²t
, 0, 
this_couÁ
);

239 
	`»queue_¤_»que¡
(
SC²t
);

245 if(
»suÉ
) {

246 
	`´štk
("SCSI CDƒrror : host %d id %d†un %d„eturn code = %03x\n",

247 
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
ho¡
->
ho¡_no
,

248 
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
id
,

249 
scsi_CDs
[
	`DEVICE_NR
(
SC²t
->
»que¡
.
dev
)].
deviû
->
lun
,

250 
»suÉ
);

252 ià(
	`¡©us_by‹
(
»suÉ
è=ğ
CHECK_CONDITION
)

253 
	`´št_£n£
("¤", 
SC²t
);

255 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
cu¼’t_Ä_£ùÜs
);

256 
	`»queue_¤_»que¡
(
SC²t
);

258 
	}
}

260 
	$¤_İ’
(
šode
 * inode, 
fe
 * 
fp
)

262 if(
	`MINOR
(
šode
->
i_rdev
è>ğ
NR_SR
 ||

263 !
scsi_CDs
[
	`MINOR
(
šode
->
i_rdev
)].
deviû
è -
ENODEV
;

265 
	`check_disk_chªge
(
šode
->
i_rdev
);

267 if(!
scsi_CDs
[
	`MINOR
(
šode
->
i_rdev
)].
deviû
->
acûss_couÁ
++)

268 
	`¤_ioùl
(
šode
, 
NULL
, 
SCSI_IOCTL_DOORLOCK
, 0);

275 if(
scsi_CDs
[
	`MINOR
(
šode
->
i_rdev
)].
Ãeds_£ùÜ_size
)

276 
	`g‘_£ùÜsize
(
	`MINOR
(
šode
->
i_rdev
));

279 
	}
}

287 
	$do_¤_»que¡
 ()

289 
Scsi_Cmnd
 * 
SC²t
 = 
NULL
;

290 
»que¡
 * 
»q
 = 
NULL
;

291 
æag
 = 0;

294 
	`şi
();

295 ià(
CURRENT
 !ğ
NULL
 && CURRENT->
dev
 == -1) {

296 
	`¡i
();

300 
INIT_SCSI_REQUEST
;

302 ià(
æag
++ == 0)

303 
SC²t
 = 
	`®loÿ‹_deviû
(&
CURRENT
,

304 
scsi_CDs
[
	`DEVICE_NR
(
	`MINOR
(
CURRENT
->
dev
))].
deviû
->
šdex
, 0);

305 
SC²t
 = 
NULL
;

306 
	`¡i
();

315 ià(!
SC²t
 && 
NR_SR
 > 1){

316 
»que¡
 *
»q1
;

317 
»q1
 = 
NULL
;

318 
	`şi
();

319 
»q
 = 
CURRENT
;

320 
»q
){

321 
SC²t
 = 
	`»que¡_queu—bË
(
»q
,

322 
scsi_CDs
[
	`DEVICE_NR
(
	`MINOR
(
»q
->
dev
))].
deviû
->
šdex
);

323 if(
SC²t
) ;

324 
»q1
 = 
»q
;

325 
»q
 =„eq->
Ãxt
;

327 ià(
SC²t
 && 
»q
->
dev
 == -1) {

328 ià(
»q
 =ğ
CURRENT
)

329 
CURRENT
 = CURRENT->
Ãxt
;

331 
»q1
->
Ãxt
 = 
»q
->next;

333 
	`¡i
();

336 ià(!
SC²t
)

339 
	`wake_up
(&
wa™_fÜ_»que¡
);

342 
	`»queue_¤_»que¡
(
SC²t
);

344 
	}
}

346 
	$»queue_¤_»que¡
 (
Scsi_Cmnd
 * 
SC²t
)

348 
dev
, 
block
, 
»®couÁ
;

349 
cmd
[10], *
bufãr
, 
Œ›s
;

350 
this_couÁ
, 
¡¬t
, 
’d_»c
;

352 
Œ›s
 = 2;

354 
»³©
:

355 if(
SC²t
->
»que¡
.
dev
 <= 0) {

356 
	`do_¤_»que¡
();

360 
dev
 = 
	`MINOR
(
SC²t
->
»que¡
.dev);

361 
block
 = 
SC²t
->
»que¡
.
£ùÜ
;

362 
bufãr
 = 
NULL
;

363 
this_couÁ
 = 0;

365 ià(
dev
 >ğ
NR_SR
)

368 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

369 
Œ›s
 = 2;

370 
»³©
;

373 ià(!
scsi_CDs
[
dev
].
u£
)

376 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

377 
Œ›s
 = 2;

378 
»³©
;

381 ià(
scsi_CDs
[
dev
].
deviû
->
chªged
)

387 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

388 
Œ›s
 = 2;

389 
»³©
;

392 
SC²t
->
»que¡
.
cmd
)

394 
WRITE
:

395 
	`’d_scsi_»que¡
(
SC²t
, 0, SC²t->
»que¡
.
Ä_£ùÜs
);

396 
»³©
;

398 
READ
 :

399 
cmd
[0] = 
READ_6
;

402 
	`·nic
 ("UnknowÀ¤ commªd %d\n", 
SC²t
->
»que¡
.
cmd
);

405 
cmd
[1] = (
SC²t
->
lun
 << 5) & 0xe0;

423 
SC²t
->
u£_sg
 = 0;

425 ià(
SC²t
->
ho¡
->
sg_bËsize
 > 0 &&

426 (!
Ãed_i§_bufãr
 ||

427 
dma_ä“_£ùÜs
 >= 10)) {

428 
bufãr_h—d
 * 
bh
;

429 
sÿ‰”li¡
 * 
sg²t
;

430 
couÁ
, 
this_couÁ_max
;

431 
bh
 = 
SC²t
->
»que¡
.bh;

432 
this_couÁ
 = 0;

433 
couÁ
 = 0;

434 
this_couÁ_max
 = (
scsi_CDs
[
dev
].
‹n
 ? 0xffff : 0xff) << 4;

437 
this_couÁ
 = 
SC²t
->
»que¡
.
£ùÜ
 % 4;

438 if(
this_couÁ
è
couÁ
++;

439 
bh
 && 
couÁ
 < 
SC²t
->
ho¡
->
sg_bËsize
) {

440 ià((
this_couÁ
 + (
bh
->
b_size
 >> 9)è> 
this_couÁ_max
) ;

441 
this_couÁ
 +ğ(
bh
->
b_size
 >> 9);

442 
couÁ
++;

443 
bh
 = bh->
b_»qÃxt
;

446 
’d_»c
 = 0;

447 if(
this_couÁ
 % 4) {

448 ià(
couÁ
 < 
SC²t
->
ho¡
->
sg_bËsize
) {

449 
couÁ
++;

450 
’d_»c
 = (4 - (
this_couÁ
 % 4)) << 9;

451 
this_couÁ
 += 4 - (this_count % 4);

453 
couÁ
--;

454 
this_couÁ
 -= (this_count % 4);

457 
SC²t
->
u£_sg
 = 
couÁ
;

458 
couÁ
 = 512;

459  
couÁ
 < (
SC²t
->
u£_sg
 * (
sÿ‰”li¡
)))

460 
couÁ
 = count << 1;

461 
SC²t
->
sgli¡_Ën
 = 
couÁ
;

462 
sg²t
 = (
sÿ‰”li¡
 * ) 
	`scsi_m®loc
(
couÁ
);

463 ià(!
sg²t
) {

464 
	`´štk
("Warning -„unning *really* short on DMA buffers\n");

465 
SC²t
->
u£_sg
 = 0;

467 
bufãr
 = (*è
sg²t
;

468 
couÁ
 = 0;

469 
bh
 = 
SC²t
->
»que¡
.bh;

470 if(
SC²t
->
»que¡
.
£ùÜ
 % 4) {

471 
sg²t
[
couÁ
].
Ëngth
 = (
SC²t
->
»que¡
.
£ùÜ
 % 4) << 9;

472 
sg²t
[
couÁ
].
add»ss
 = (*è
	`scsi_m®loc
(sg²t[couÁ].
Ëngth
);

473 if(!
sg²t
[
couÁ
].
add»ss
è
	`·nic
("SCSI DMA…oolƒxhausted.");

474 
sg²t
[
couÁ
].
®t_add»ss
 = sg²t[couÁ].
add»ss
;

476 
couÁ
++;

478 
bh
 = 
SC²t
->
»que¡
.bh; 
couÁ
 < SC²t->
u£_sg
;

479 
couÁ
++, 
bh
 = bh->
b_»qÃxt
) {

480 ià(
bh
) {

481 
sg²t
[
couÁ
].
add»ss
 = 
bh
->
b_d©a
;

482 
sg²t
[
couÁ
].
Ëngth
 = 
bh
->
b_size
;

483 
sg²t
[
couÁ
].
®t_add»ss
 = 
NULL
;

485 
sg²t
[
couÁ
].
add»ss
 = (*è
	`scsi_m®loc
(
’d_»c
);

486 if(!
sg²t
[
couÁ
].
add»ss
è
	`·nic
("SCSI DMA…oolƒxhausted.");

487 
sg²t
[
couÁ
].
Ëngth
 = 
’d_»c
;

488 
sg²t
[
couÁ
].
®t_add»ss
 = sg²t[couÁ].
add»ss
;

489 ià(
couÁ
+1 !ğ
SC²t
->
u£_sg
è
	`·nic
("Bad sr„equest†ist");

492 ià(((è
sg²t
[
couÁ
].
add»ss
è+ sg²t[couÁ].
Ëngth
 >

493 
ISA_DMA_THRESHOLD
 & (
SC²t
->
ho¡
->
unchecked_i§_dma
)) {

494 
sg²t
[
couÁ
].
®t_add»ss
 = sg²t[couÁ].
add»ss
;

498 if(
dma_ä“_£ùÜs
 < (
sg²t
[
couÁ
].
Ëngth
 >> 9) + 5) {

499 
sg²t
[
couÁ
].
add»ss
 = 
NULL
;

501 
sg²t
[
couÁ
].
add»ss
 = (*è
	`scsi_m®loc
(sg²t[couÁ].
Ëngth
);

507 if(
sg²t
[
couÁ
].
add»ss
 =ğ
NULL
){

508 
	`´štk
("Warning: Running†ow on SCSI DMA buffers");

510 --
couÁ
 >= 0){

511 if(
sg²t
[
couÁ
].
®t_add»ss
)

512 
	`scsi_ä“
(
sg²t
[
couÁ
].
add»ss
, sg²t[couÁ].
Ëngth
);

514 
SC²t
->
u£_sg
 = 0;

515 
	`scsi_ä“
(
bufãr
, 
SC²t
->
sgli¡_Ën
);

520 #ifdeà
DEBUG


521 
	`´štk
("SG: %d %d %d %d %d *** ",
SC²t
->
u£_sg
, SC²t->
»que¡
.
£ùÜ
,

522 
this_couÁ
,

523 
SC²t
->
»que¡
.
cu¼’t_Ä_£ùÜs
,

524 
SC²t
->
»que¡
.
Ä_£ùÜs
);

525 
couÁ
=0; couÁ<
SC²t
->
u£_sg
; count++)

526 
	`´štk
("SGli¡: %d %x %x %x\n", 
couÁ
,

527 
sg²t
[
couÁ
].
add»ss
,

528 
sg²t
[
couÁ
].
®t_add»ss
,

529 
sg²t
[
couÁ
].
Ëngth
);

534 ià(
SC²t
->
u£_sg
 == 0){

536 ià(!
SC²t
->
»que¡
.
bh
)

537 
this_couÁ
 = 
SC²t
->
»que¡
.
Ä_£ùÜs
;

539 
this_couÁ
 = (
SC²t
->
»que¡
.
bh
->
b_size
 >> 9);

541 
¡¬t
 = 
block
 % 4;

542 ià(
¡¬t
)

544 
this_couÁ
 = (Ñhis_couÁ > 4 - 
¡¬t
) ?

545 (4 - 
¡¬t
è: (
this_couÁ
));

546 
bufãr
 = (*è
	`scsi_m®loc
(2048);

548 ià(
this_couÁ
 < 4)

550 
bufãr
 = (*è
	`scsi_m®loc
(2048);

554 
this_couÁ
 -=his_count % 4;

555 
bufãr
 = (*è
SC²t
->
»que¡
.buffer;

556 ià(((è
bufãr
è+ (
this_couÁ
 << 9è> 
ISA_DMA_THRESHOLD
 &

557 (
SC²t
->
ho¡
->
unchecked_i§_dma
))

558 
bufãr
 = (*è
	`scsi_m®loc
(
this_couÁ
 << 9);

562 ià(
scsi_CDs
[
dev
].
£ùÜ_size
 == 2048)

563 
block
 = block >> 2;

565 
block
 = block & 0xfffffffc;

567 
»®couÁ
 = (
this_couÁ
 + 3) / 4;

569 ià(
scsi_CDs
[
dev
].
£ùÜ_size
 =ğ512è
»®couÁ
 =„ealcount << 2;

571 ià(((
»®couÁ
 > 0xffè|| (
block
 > 0x1fffff)è&& 
scsi_CDs
[
dev
].
‹n
)

573 ià(
»®couÁ
 > 0xffff)

575 
»®couÁ
 = 0xffff;

576 
this_couÁ
 = 
»®couÁ
 * (
scsi_CDs
[
dev
].
£ùÜ_size
 >> 9);

579 
cmd
[0] +ğ
READ_10
 - 
READ_6
 ;

580 
cmd
[2] = (è(
block
 >> 24) & 0xff;

581 
cmd
[3] = (è(
block
 >> 16) & 0xff;

582 
cmd
[4] = (è(
block
 >> 8) & 0xff;

583 
cmd
[5] = (è
block
 & 0xff;

584 
cmd
[6] = cmd[9] = 0;

585 
cmd
[7] = (è(
»®couÁ
 >> 8) & 0xff;

586 
cmd
[8] = (è
»®couÁ
 & 0xff;

590 ià(
»®couÁ
 > 0xff)

592 
»®couÁ
 = 0xff;

593 
this_couÁ
 = 
»®couÁ
 * (
scsi_CDs
[
dev
].
£ùÜ_size
 >> 9);

596 
cmd
[1] |ğ(è((
block
 >> 16) & 0x1f);

597 
cmd
[2] = (è((
block
 >> 8) & 0xff);

598 
cmd
[3] = (è
block
 & 0xff;

599 
cmd
[4] = (è
»®couÁ
;

600 
cmd
[5] = 0;

603 #ifdeà
DEBUG


605 
i
;

606 
	`´štk
("R—dCD: %d %d %d %d\n",
block
, 
»®couÁ
, 
bufãr
, 
this_couÁ
);

607 
	`´štk
("U£ sg: %d\n", 
SC²t
->
u£_sg
);

608 
	`´štk
("Dumping command: ");

609 
i
=0; i<12; i++è
	`´štk
("%2.2x ", 
cmd
[i]);

610 
	`´štk
("\n");

614 
SC²t
->
this_couÁ
 =his_count;

615 
	`scsi_do_cmd
 (
SC²t
, (*è
cmd
, 
bufãr
,

616 
»®couÁ
 * 
scsi_CDs
[
dev
].
£ùÜ_size
,

617 
rw_šŒ
, 
SR_TIMEOUT
, 
MAX_RETRIES
);

618 
	}
}

620 
	$¤_š™1
(
mem_¡¬t
, 
mem_’d
){

621 
scsi_CDs
 = (
Scsi_CD
 *è
mem_¡¬t
;

622 
mem_¡¬t
 +ğ
MAX_SR
 * (
Scsi_CD
);

623  
mem_¡¬t
;

624 
	}
};

626 
	$¤_©ch
(
Scsi_Deviû
 * 
SDp
){

627 
scsi_CDs
[
NR_SR
++].
deviû
 = 
SDp
;

628 if(
NR_SR
 > 
MAX_SR
è
	`·nic
 ("scsi_devices corrupt (sr)");

629 
	}
};

631 
	$¤_š™_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

633 
»que¡
 * 
»q
;

634 
sk_¡ruù
 * 
p
;

636 
»q
 = &
SC²t
->
»que¡
;

637 
»q
->
dev
 = 0xfffe;

639 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

640 
»q
->
wa™šg
 = 
NULL
;

641 
p
->
¡©e
 = 
TASK_RUNNING
;

642 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

643 
Ãed_»sched
 = 1;

645 
	}
}

647 
	$g‘_£ùÜsize
(
i
){

648 
cmd
[10];

649 
bufãr
[513];

650 
the_»suÉ
, 
»Œ›s
;

651 
Scsi_Cmnd
 * 
SC²t
;

653 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, 
scsi_CDs
[
i
].
deviû
->
šdex
, 1);

655 
»Œ›s
 = 3;

657 
cmd
[0] = 
READ_CAPACITY
;

658 
cmd
[1] = (
scsi_CDs
[
i
].
deviû
->
lun
 << 5) & 0xe0;

659 
	`mem£t
 ((*è&
cmd
[2], 0, 8);

660 
SC²t
->
»que¡
.
dev
 = 0xffff;

662 
	`mem£t
(
bufãr
, 0, 8);

664 
	`scsi_do_cmd
 (
SC²t
,

665 (*è
cmd
, (*è
bufãr
,

666 512, 
¤_š™_dÚe
, 
SR_TIMEOUT
,

667 
MAX_RETRIES
);

669 ià(
cu¼’t
 =ğ
sk
[0])

670 
SC²t
->
»que¡
.
dev
 != 0xfffe);

672 ià(
SC²t
->
»que¡
.
dev
 != 0xfffe){

673 
SC²t
->
»que¡
.
wa™šg
 = 
cu¼’t
;

674 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

675 
SC²t
->
»que¡
.
dev
 !ğ0xffãè
	`scheduË
();

678 
the_»suÉ
 = 
SC²t
->
»suÉ
;

679 
»Œ›s
--;

681 } 
the_»suÉ
 && 
»Œ›s
);

683 
SC²t
->
»que¡
.
dev
 = -1;

685 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

687 ià(
the_»suÉ
) {

688 
scsi_CDs
[
i
].
ÿ·c™y
 = 0x1fffff;

689 
scsi_CDs
[
i
].
£ùÜ_size
 = 2048;

690 
scsi_CDs
[
i
].
Ãeds_£ùÜ_size
 = 1;

692 
scsi_CDs
[
i
].
ÿ·c™y
 = (
bufãr
[0] << 24) |

693 (
bufãr
[1] << 16) | (buffer[2] << 8) | buffer[3];

694 
scsi_CDs
[
i
].
£ùÜ_size
 = (
bufãr
[4] << 24) |

695 (
bufãr
[5] << 16) | (buffer[6] << 8) | buffer[7];

696 if(
scsi_CDs
[
i
].
£ùÜ_size
 == 0) scsi_CDs[i].sector_size = 2048;

697 if(
scsi_CDs
[
i
].
£ùÜ_size
 != 2048 &&

698 
scsi_CDs
[
i
].
£ùÜ_size
 != 512) {

699 
	`´štk
 ("scd%d : unsupported sector size %d.\n",

700 
i
, 
scsi_CDs
[i].
£ùÜ_size
);

701 
scsi_CDs
[
i
].
ÿ·c™y
 = 0;

702 
scsi_CDs
[
i
].
Ãeds_£ùÜ_size
 = 1;

704 if(
scsi_CDs
[
i
].
£ùÜ_size
 == 2048)

705 
scsi_CDs
[
i
].
ÿ·c™y
 *= 4;

706 
scsi_CDs
[
i
].
Ãeds_£ùÜ_size
 = 0;

708 
	}
}

710 
	$¤_š™
(
memÜy_¡¬t
, 
memÜy_’d
)

712 
i
;

714 ià(
	`»gi¡”_blkdev
(
MAJOR_NR
,"¤",&
¤_fİs
)) {

715 
	`´štk
("UÇbËØg‘ majÜ %d fÜ SCSI-CD\n",
MAJOR_NR
);

716  
memÜy_¡¬t
;

718 if(
MAX_SR
 =ğ0è 
memÜy_¡¬t
;

720 
¤_sizes
 = (*è
memÜy_¡¬t
;

721 
memÜy_¡¬t
 +ğ
MAX_SR
 * ();

722 
	`mem£t
(
¤_sizes
, 0, 
MAX_SR
 * ());

724 
¤_blocksizes
 = (*è
memÜy_¡¬t
;

725 
memÜy_¡¬t
 +ğ
MAX_SR
 * ();

726 
i
=0;i<
MAX_SR
;i++è
¤_blocksizes
[i] = 2048;

727 
blksize_size
[
MAJOR_NR
] = 
¤_blocksizes
;

729 
i
 = 0; i < 
NR_SR
; ++i)

731 
	`g‘_£ùÜsize
(
i
);

732 
	`´štk
("Scd seùÜsizğ%d by‹s\n", 
scsi_CDs
[
i
].
£ùÜ_size
);

733 
scsi_CDs
[
i
].
u£
 = 1;

734 
scsi_CDs
[
i
].
‹n
 = 1;

735 
scsi_CDs
[
i
].
»m­
 = 1;

736 
¤_sizes
[
i
] = 
scsi_CDs
[i].
ÿ·c™y
;

739 
blk_dev
[
MAJOR_NR
].
»que¡_â
 = 
DEVICE_REQUEST
;

740 
blk_size
[
MAJOR_NR
] = 
¤_sizes
;

745 if(
scsi_CDs
[0].
deviû
->
ho¡
->
sg_bËsize
)

746 
»ad_ah—d
[
MAJOR_NR
] = 32;

748 
»ad_ah—d
[
MAJOR_NR
] = 4;

750  
memÜy_¡¬t
;

751 
	}
}

	@drivers/scsi/sr.h

17 #iâdeà
_SR_H


18 
	#_SR_H


	)

20 
	~"scsi.h
"

24 
	mÿ·c™y
;

25 
	m£ùÜ_size
;

26 
Scsi_Deviû
 *
	mdeviû
;

27 
	m£ùÜ_b™_size
;

28 
	m£ùÜ_b™_shiá
;

29 
	mÃeds_£ùÜ_size
:1;

30 
	m‹n
:1;

31 
	m»m­
:1;

32 
	mu£
:1;

33 } 
	tScsi_CD
;

35 
Scsi_CD
 * 
scsi_CDs
;

	@drivers/scsi/sr_ioctl.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/sched.h
>

3 
	~<lšux/fs.h
>

4 
	~<asm/£gm’t.h
>

5 
	~<lšux/”ºo.h
>

7 
	~"../block/blk.h
"

8 
	~"scsi.h
"

9 
	~"ho¡s.h
"

10 
	~"¤.h
"

11 
	~"scsi_ioùl.h
"

13 
	~<lšux/cdrom.h
>

15 
	#IOCTL_RETRIES
 3

	)

17 
	#IOCTL_TIMEOUT
 200

	)

19 
scsi_ioùl
 (
Scsi_Deviû
 *
dev
, 
cmd
, *
¬g
);

21 
	$¤_ioùl_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

23 
»que¡
 * 
»q
;

24 
sk_¡ruù
 * 
p
;

26 
»q
 = &
SC²t
->
»que¡
;

27 
»q
->
dev
 = 0xfffe;

29 ià((
p
 = 
»q
->
wa™šg
è!ğ
NULL
) {

30 
»q
->
wa™šg
 = 
NULL
;

31 
p
->
¡©e
 = 
TASK_RUNNING
;

32 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

33 
Ãed_»sched
 = 1;

35 
	}
}

41 
	$do_ioùl
(
rg‘
, * 
¤_cmd
, * 
bufãr
, 
buæ’gth
)

43 
Scsi_Cmnd
 * 
SC²t
;

44 
»suÉ
;

46 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, 
scsi_CDs
[
rg‘
].
deviû
->
šdex
, 1);

47 
	`scsi_do_cmd
(
SC²t
,

48 (*è
¤_cmd
, 
bufãr
, 
buæ’gth
, 
¤_ioùl_dÚe
,

49 
IOCTL_TIMEOUT
, 
IOCTL_RETRIES
);

52 ià(
SC²t
->
»que¡
.
dev
 != 0xfffe){

53 
SC²t
->
»que¡
.
wa™šg
 = 
cu¼’t
;

54 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

55 
SC²t
->
»que¡
.
dev
 !ğ0xffãè
	`scheduË
();

58 
»suÉ
 = 
SC²t
->result;

61 if(
	`driv”_by‹
(
»suÉ
) != 0)

62 
SC²t
->
£n£_bufãr
[2] & 0xf) {

63 
UNIT_ATTENTION
:

64 
scsi_CDs
[
rg‘
].
deviû
->
chªged
 = 1;

65 
	`´štk
("Disc change detected.\n");

67 
NOT_READY
:

68 
	`´štk
("CDROM‚ot„eady. Make surehere is‡ disc inhe drive.\n");

70 
ILLEGAL_REQUEST
:

71 
	`´štk
("CDROM (ioctl)„eports ILLEGAL REQUEST.\n");

74 
	`´štk
("SCSI CDƒrror: host %d id %d†un %d„eturn code = %03x\n",

75 
scsi_CDs
[
rg‘
].
deviû
->
ho¡
->
ho¡_no
,

76 
scsi_CDs
[
rg‘
].
deviû
->
id
,

77 
scsi_CDs
[
rg‘
].
deviû
->
lun
,

78 
»suÉ
);

79 
	`´štk
("\tSense class %x, senseƒrror %x,ƒxtended sense %x\n",

80 
	`£n£_şass
(
SC²t
->
£n£_bufãr
[0]),

81 
	`£n£_”rÜ
(
SC²t
->
£n£_bufãr
[0]),

82 
SC²t
->
£n£_bufãr
[2] & 0xf);

86 
»suÉ
 = 
SC²t
->result;

87 
SC²t
->
»que¡
.
dev
 = -1;

88 
	`wake_up
(&
scsi_deviûs
[
SC²t
->
šdex
].
deviû_wa™
);

90  
»suÉ
;

91 
	}
}

93 
	$¤_ioùl
(
šode
 * inode, 
fe
 * fe, 
cmd
, 
¬g
)

95 
u_ch¬
 
¤_cmd
[10];

97 
dev
 = 
šode
->
i_rdev
;

98 
»suÉ
, 
rg‘
;

100 
rg‘
 = 
	`MINOR
(
dev
);

101 ià(
rg‘
 >ğ
NR_SR
è -
ENODEV
;

103 
cmd
)

106 
CDROMPAUSE
:

108 
¤_cmd
[0] = 
SCMD_PAUSE_RESUME
;

109 
¤_cmd
[1] = 
scsi_CDs
[
rg‘
].
deviû
->
lun
 << 5;

110 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[4] = 0;

111 
¤_cmd
[5] = sr_cmd[6] = sr_cmd[7] = 0;

112 
¤_cmd
[8] = 0;

113 
¤_cmd
[9] = 0;

115 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

116  
»suÉ
;

118 
CDROMRESUME
:

120 
¤_cmd
[0] = 
SCMD_PAUSE_RESUME
;

121 
¤_cmd
[1] = 
scsi_CDs
[
rg‘
].
deviû
->
lun
 << 5;

122 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[4] = 0;

123 
¤_cmd
[5] = sr_cmd[6] = sr_cmd[7] = 0;

124 
¤_cmd
[8] = 1;

125 
¤_cmd
[9] = 0;

127 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

129  
»suÉ
;

131 
CDROMPLAYMSF
:

133 
cdrom_msf
 
msf
;

134 
	`memıy_äomfs
(&
msf
, (*è
¬g
, (msf));

136 
¤_cmd
[0] = 
SCMD_PLAYAUDIO_MSF
;

137 
¤_cmd
[1] = 
scsi_CDs
[
rg‘
].
deviû
->
lun
 << 5;

138 
¤_cmd
[2] = 0;

139 
¤_cmd
[3] = 
msf
.
cdmsf_mš0
;

140 
¤_cmd
[4] = 
msf
.
cdmsf_£c0
;

141 
¤_cmd
[5] = 
msf
.
cdmsf_äame0
;

142 
¤_cmd
[6] = 
msf
.
cdmsf_mš1
;

143 
¤_cmd
[7] = 
msf
.
cdmsf_£c1
;

144 
¤_cmd
[8] = 
msf
.
cdmsf_äame1
;

145 
¤_cmd
[9] = 0;

147 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

148  
»suÉ
;

151 
CDROMPLAYTRKIND
:

153 
cdrom_ti
 
ti
;

154 
	`memıy_äomfs
(&
ti
, (*è
¬g
, (ti));

156 
¤_cmd
[0] = 
SCMD_PLAYAUDIO_TI
;

157 
¤_cmd
[1] = 
scsi_CDs
[
rg‘
].
deviû
->
lun
 << 5;

158 
¤_cmd
[2] = 0;

159 
¤_cmd
[3] = 0;

160 
¤_cmd
[4] = 
ti
.
cdti_Œk0
;

161 
¤_cmd
[5] = 
ti
.
cdti_šd0
;

162 
¤_cmd
[6] = 0;

163 
¤_cmd
[7] = 
ti
.
cdti_Œk1
;

164 
¤_cmd
[8] = 
ti
.
cdti_šd1
;

165 
¤_cmd
[9] = 0;

167 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

169  
»suÉ
;

172 
CDROMREADTOCHDR
:

174 
cdrom_tochdr
 
tochdr
;

175 * 
bufãr
;

177 
¤_cmd
[0] = 
SCMD_READ_TOC
;

178 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
->
lun
) << 5) | 0x02;

179 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[4] = sr_cmd[5] = 0;

180 
¤_cmd
[6] = 0;

181 
¤_cmd
[7] = 0;

182 
¤_cmd
[8] = 12;

183 
¤_cmd
[9] = 0;

185 
bufãr
 = (*è
	`scsi_m®loc
(512);

186 if(!
bufãr
è -
ENOMEM
;

188 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
bufãr
, 12);

190 
tochdr
.
cdth_Œk0
 = 
bufãr
[2];

191 
tochdr
.
cdth_Œk1
 = 
bufãr
[3];

193 
	`scsi_ä“
(
bufãr
, 512);

195 
	`v”ify_¬—
 (
VERIFY_WRITE
, (*è
¬g
,  (
cdrom_tochdr
));

196 
	`memıy_tofs
 ((*è
¬g
, &
tochdr
,  (
cdrom_tochdr
));

198  
»suÉ
;

201 
CDROMREADTOCENTRY
:

203 
cdrom_toûÁry
 
toûÁry
;

204 * 
bufãr
;

206 
	`v”ify_¬—
 (
VERIFY_READ
, (*è
¬g
,  (
cdrom_toûÁry
));

207 
	`memıy_äomfs
 (&
toûÁry
, (*è
¬g
,  (
cdrom_toûÁry
));

209 
¤_cmd
[0] = 
SCMD_READ_TOC
;

210 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
->
lun
) << 5) | 0x02;

211 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[4] = sr_cmd[5] = 0;

212 
¤_cmd
[6] = 
toûÁry
.
cd‹_Œack
;

213 
¤_cmd
[7] = 0;

214 
¤_cmd
[8] = 12;

215 
¤_cmd
[9] = 0;

217 
bufãr
 = (*è
	`scsi_m®loc
(512);

218 if(!
bufãr
è -
ENOMEM
;

220 
»suÉ
 = 
	`do_ioùl
 (
rg‘
, 
¤_cmd
, 
bufãr
, 12);

222 ià(
toûÁry
.
cd‹_fÜm©
 =ğ
CDROM_MSF
) {

223 
toûÁry
.
cd‹_addr
.
msf
.
mšu‹
 = 
bufãr
[9];

224 
toûÁry
.
cd‹_addr
.
msf
.
£cÚd
 = 
bufãr
[10];

225 
toûÁry
.
cd‹_addr
.
msf
.
äame
 = 
bufãr
[11];

226 
toûÁry
.
cd‹_ù¾
 = 
bufãr
[5] & 0xf;

229 
toûÁry
.
cd‹_addr
.
lba
 = (è
bufãr
[0];

231 
	`scsi_ä“
(
bufãr
, 512);

233 
	`v”ify_¬—
 (
VERIFY_WRITE
, (*è
¬g
,  (
cdrom_toûÁry
));

234 
	`memıy_tofs
 ((*è
¬g
, &
toûÁry
,  (
cdrom_toûÁry
));

236  
»suÉ
;

239 
CDROMSTOP
:

240 
¤_cmd
[0] = 
START_STOP
;

241 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
->
lun
) << 5) | 1;

242 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[5] = 0;

243 
¤_cmd
[4] = 0;

245 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

246  
»suÉ
;

248 
CDROMSTART
:

249 
¤_cmd
[0] = 
START_STOP
;

250 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
->
lun
) << 5) | 1;

251 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[5] = 0;

252 
¤_cmd
[4] = 1;

254 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255);

255  
»suÉ
;

257 
CDROMEJECT
:

258 ià(
scsi_CDs
[
rg‘
].
deviû
 -> 
acûss_couÁ
 == 1)

259 
	`¤_ioùl
 (
šode
, 
NULL
, 
SCSI_IOCTL_DOORUNLOCK
, 0);

261 
¤_cmd
[0] = 
START_STOP
;

262 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
 -> 
lun
) << 5) | 1;

263 
¤_cmd
[2] = sr_cmd[3] = sr_cmd[5] = 0;

264 
¤_cmd
[4] = 0x02;

266 ià(!(
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
NULL
, 255)))

267 
scsi_CDs
[
rg‘
].
deviû
 -> 
chªged
 = 1;

269  
»suÉ
;

271 
CDROMVOLCTRL
:

273 * 
bufãr
, * 
mask
;

274 
cdrom_vŞù¾
 
vŞù¾
;

276 
	`v”ify_¬—
 (
VERIFY_READ
, (*è
¬g
,  (
cdrom_vŞù¾
));

277 
	`memıy_äomfs
 (&
vŞù¾
, (*è
¬g
,  (
cdrom_vŞù¾
));

281 
¤_cmd
[0] = 
MODE_SENSE
;

282 
¤_cmd
[1] = (
scsi_CDs
[
rg‘
].
deviû
 -> 
lun
) << 5;

283 
¤_cmd
[2] = 0xe;

284 
¤_cmd
[3] = 0;

285 
¤_cmd
[4] = 28;

286 
¤_cmd
[5] = 0;

288 
bufãr
 = (*è
	`scsi_m®loc
(512);

289 if(!
bufãr
è -
ENOMEM
;

291 ià((
»suÉ
 = 
	`do_ioùl
 (
rg‘
, 
¤_cmd
, 
bufãr
, 28))) {

292 
	`´štk
 ("Hosed while obtaining‡udio mode…age\n");

293 
	`scsi_ä“
(
bufãr
, 512);

294  
»suÉ
;

297 
¤_cmd
[0] = 
MODE_SENSE
;

298 
¤_cmd
[1] = (
scsi_CDs
[
rg‘
].
deviû
 -> 
lun
) << 5;

299 
¤_cmd
[2] = 0x4e;

300 
¤_cmd
[3] = 0;

301 
¤_cmd
[4] = 28;

302 
¤_cmd
[5] = 0;

304 
mask
 = (*è
	`scsi_m®loc
(512);

305 if(!
mask
) {

306 
	`scsi_ä“
(
bufãr
, 512);

307  -
ENOMEM
;

310 ià((
»suÉ
 = 
	`do_ioùl
 (
rg‘
, 
¤_cmd
, 
mask
, 28))) {

311 
	`´štk
 ("Hosed while obtaining mask for‡udio mode…age\n");

312 
	`scsi_ä“
(
bufãr
, 512);

313 
	`scsi_ä“
(
mask
, 512);

314  
»suÉ
;

318 
bufãr
[0] = 0;

320 
bufãr
[21] = 
vŞù¾
.
chªÃl0
 & 
mask
[21];

321 
bufãr
[23] = 
vŞù¾
.
chªÃl1
 & 
mask
[23];

322 
bufãr
[25] = 
vŞù¾
.
chªÃl2
 & 
mask
[25];

323 
bufãr
[27] = 
vŞù¾
.
chªÃl3
 & 
mask
[27];

325 
¤_cmd
[0] = 
MODE_SELECT
;

326 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
 -> 
lun
) << 5) | 0x10;

327 
¤_cmd
[2] = sr_cmd[3] = 0;

328 
¤_cmd
[4] = 28;

329 
¤_cmd
[5] = 0;

331 
»suÉ
 = 
	`do_ioùl
 (
rg‘
, 
¤_cmd
, 
bufãr
, 28);

332 
	`scsi_ä“
(
bufãr
, 512);

333 
	`scsi_ä“
(
mask
, 512);

334  
»suÉ
;

337 
CDROMSUBCHNL
:

339 
cdrom_subchÆ
 
subchÆ
;

340 * 
bufãr
;

342 
¤_cmd
[0] = 
SCMD_READ_SUBCHANNEL
;

343 
¤_cmd
[1] = ((
scsi_CDs
[
rg‘
].
deviû
->
lun
) << 5) | 0x02;

344 
¤_cmd
[2] = 0x40;

345 
¤_cmd
[3] = 0x01;

346 
¤_cmd
[4] = sr_cmd[5] = 0;

347 
¤_cmd
[6] = 0;

348 
¤_cmd
[7] = 0;

349 
¤_cmd
[8] = 16;

350 
¤_cmd
[9] = 0;

352 
bufãr
 = (*è
	`scsi_m®loc
(512);

353 if(!
bufãr
è -
ENOMEM
;

355 
»suÉ
 = 
	`do_ioùl
(
rg‘
, 
¤_cmd
, 
bufãr
, 16);

357 
subchÆ
.
cdsc_audio¡©us
 = 
bufãr
[1];

358 
subchÆ
.
cdsc_fÜm©
 = 
CDROM_MSF
;

359 
subchÆ
.
cdsc_ù¾
 = 
bufãr
[5] & 0xf;

360 
subchÆ
.
cdsc_Œk
 = 
bufãr
[6];

361 
subchÆ
.
cdsc_šd
 = 
bufãr
[7];

363 
subchÆ
.
cdsc_»Ïddr
.
msf
.
mšu‹
 = 
bufãr
[13];

364 
subchÆ
.
cdsc_»Ïddr
.
msf
.
£cÚd
 = 
bufãr
[14];

365 
subchÆ
.
cdsc_»Ïddr
.
msf
.
äame
 = 
bufãr
[15];

366 
subchÆ
.
cdsc_ab§ddr
.
msf
.
mšu‹
 = 
bufãr
[9];

367 
subchÆ
.
cdsc_ab§ddr
.
msf
.
£cÚd
 = 
bufãr
[10];

368 
subchÆ
.
cdsc_ab§ddr
.
msf
.
äame
 = 
bufãr
[11];

370 
	`scsi_ä“
(
bufãr
, 512);

372 
	`v”ify_¬—
 (
VERIFY_WRITE
, (*è
¬g
,  (
cdrom_subchÆ
));

373 
	`memıy_tofs
 ((*è
¬g
, &
subchÆ
,  (
cdrom_subchÆ
));

374  
»suÉ
;

377 
CDROMREADMODE2
:

378  -
EINVAL
;

379 
CDROMREADMODE1
:

380  -
EINVAL
;

382 
	`RO_IOCTLS
(
dev
,
¬g
);

384  
	`scsi_ioùl
(
scsi_CDs
[
rg‘
].
deviû
,
cmd
,(*è
¬g
);

386 
	}
}

	@drivers/scsi/st.c

42 
	~<lšux/fs.h
>

43 
	~<lšux/k”Ãl.h
>

44 
	~<lšux/sched.h
>

45 
	~<lšux/¡ršg.h
>

46 
	~<lšux/”ºo.h
>

47 
	~<lšux/mtio.h
>

48 
	~<lšux/ioùl.h
>

49 
	~<lšux/fú.h
>

50 
	~<asm/£gm’t.h
>

51 
	~<asm/sy¡em.h
>

53 
	#MAJOR_NR
 
SCSI_TAPE_MAJOR


	)

54 
	~"../block/blk.h
"

55 
	~"scsi.h
"

56 
	~"scsi_ioùl.h
"

57 
	~"¡.h
"

58 
	~"cÚ¡ªts.h
"

78 
	#ST_BUFFER_BLOCKS
 64

	)

81 
	#ST_WRITE_THRESHOLD_BLOCKS
 60

	)

82 
	#ST_BLOCK_SIZE
 512

	)

83 
	#ST_BUFFER_SIZE
 (
ST_BUFFER_BLOCKS
 * 
ST_BLOCK_SIZE
)

	)

84 
	#ST_WRITE_THRESHOLD
 (
ST_WRITE_THRESHOLD_BLOCKS
 * 
ST_BLOCK_SIZE
)

	)

86 #ifdeà
ST_NO_DELAYED_WRITES


87 #undeà
ST_WRITE_THRESHOLD_BLOCKS


88 
	#ST_WRITE_THRESHOLD_BLOCKS
 
ST_BUFFER_BLOCKS


	)

93 #ià
ST_BUFFER_SIZE
 >= (2 << 24 - 1)

99 
	#MAX_RETRIES
 0

	)

100 
	#MAX_READY_RETRIES
 5

	)

101 
	#NO_TAPE
 
NOT_READY


	)

103 
	#ST_TIMEOUT
 9000

	)

104 
	#ST_LONG_TIMEOUT
 200000

	)

106 
	g¡_nbr_bufãrs
;

107 
ST_bufãr
 *
	g¡_bufãrs
[2];

109 
Scsi_T­e
 * 
	gscsi_³s
;

110 
	gNR_ST
=0;

111 
	gMAX_ST
=0;

113 
¡_št_ioùl
(
šode
 * inode,
fe
 * file,

114 
cmd_š
, 
¬g
);

121 
	$¡_chk_»suÉ
(
Scsi_Cmnd
 * 
SC²t
)

123 
dev
 = 
SC²t
->
»que¡
.dev;

124 
»suÉ
 = 
SC²t
->result;

125 * 
£n£
 = 
SC²t
->
£n£_bufãr
;

126 *
¡p
;

128 ià(!
»suÉ
 && 
SC²t
->
£n£_bufãr
[0] == 0)

130 #ifdeà
DEBUG


131 
	`´štk
("¡%d: E¼Ü: %x\n", 
dev
, 
»suÉ
);

132 
	`´št_£n£
("¡", 
SC²t
);

137 ià((
£n£
[0] & 0x70) == 0x70 &&

138 
£n£
[2] =ğ
RECOVERED_ERROR


139 #ifdeà
ST_RECOVERED_WRITE_FATAL


140 && 
SC²t
->
cmnd
[0] !ğ
WRITE_6


141 && 
SC²t
->
cmnd
[0] !ğ
WRITE_FILEMARKS


144 
scsi_³s
[
dev
].
»cov”_couÁ
++;

145 ià(
SC²t
->
cmnd
[0] =ğ
READ_6
)

146 
¡p
 = "read";

147 ià(
SC²t
->
cmnd
[0] =ğ
WRITE_6
)

148 
¡p
 = "write";

150 
¡p
 = "ioctl";

151 
	`´štk
("¡%d: Recov”ed % ”rÜ (%d).\n", 
dev
, 
¡p
,

152 
scsi_³s
[
dev
].
»cov”_couÁ
);

155  (-
EIO
);

156 
	}
}

161 
	$¡_¦“p_dÚe
 (
Scsi_Cmnd
 * 
SC²t
)

163 
¡_nbr
, 
»mašd”
;

164 
Scsi_T­e
 * 
STp
;

166 ià((
¡_nbr
 = 
SC²t
->
»que¡
.
dev
è< 
NR_ST
 && st_nbr >= 0) {

167 
STp
 = &(
scsi_³s
[
¡_nbr
]);

168 ià((
STp
->
bufãr
)->
wr™šg
 &&

169 (
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70 &&

170 (
SC²t
->
£n£_bufãr
[2] & 0x40)) {

172 ià((
SC²t
->
£n£_bufãr
[0] & 0x80) != 0)

173 
»mašd”
 = (
SC²t
->
£n£_bufãr
[3] << 24) |

174 (
SC²t
->
£n£_bufãr
[4] << 16) |

175 (
SC²t
->
£n£_bufãr
[5] << 8) | SCpnt->sense_buffer[6];

177 
»mašd”
 = 0;

178 ià((
SC²t
->
£n£_bufãr
[2] & 0x0fè=ğ
VOLUME_OVERFLOW
 ||

179 
»mašd”
 > 0)

180 (
STp
->
bufãr
)->
Ï¡_»suÉ
 = 
SC²t
->
»suÉ
;

182 (
STp
->
bufãr
)->
Ï¡_»suÉ
 = 
INT_MAX
;

185 (
STp
->
bufãr
)->
Ï¡_»suÉ
 = 
SC²t
->
»suÉ
;

186 (
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 = 
	`¡_chk_»suÉ
(
SC²t
);

187 ià((
STp
->
bufãr
)->
wr™šg
)

188 
SC²t
->
»que¡
.
dev
 = -1;

190 
SC²t
->
»que¡
.
dev
 = 0xffff;

191 ià((
STp
->
bufãr
)->
wr™šg
 <= 0)

192 
	`wake_up
Ğ&(
STp
->
wa™šg
) );

194 #ifdeà
DEBUG


196 
	`´štk
("¡?: IÎeg® iÁ”ru± deviû %x\n", 
¡_nbr
);

198 
	}
}

201 #ià
ST_WRITE_THRESHOLD_BLOCKS
 < 
ST_BUFFER_BLOCKS


204 
	$wr™e_behšd_check
(
dev
)

206 
Scsi_T­e
 * 
STp
;

207 
ST_bufãr
 * 
STbufãr
;

209 
STp
 = &(
scsi_³s
[
dev
]);

210 
STbufãr
 = 
STp
->
bufãr
;

212 
	`şi
();

213 ià(
STbufãr
->
Ï¡_»suÉ
 < 0) {

214 
STbufãr
->
wr™šg
 = (- STbuffer->writing);

215 
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

216 
STbufãr
->
wr™šg
 = (- STbuffer->writing);

218 
	`¡i
();

220 ià(
STbufãr
->
wr™šg
 < STbufãr->
bufãr_by‹s
)

221 
	`memıy
(
STbufãr
->
b_d©a
,

222 
STbufãr
->
b_d©a
 + STbufãr->
wr™šg
,

223 
STbufãr
->
bufãr_by‹s
 - STbufãr->
wr™šg
);

224 
STbufãr
->
bufãr_by‹s
 -ğSTbufãr->
wr™šg
;

225 
STbufãr
->
wr™šg
 = 0;

228 
	}
}

234 
	$æush_wr™e_bufãr
(
dev
)

236 
off£t
, 
Œªsãr
, 
blks
;

237 
»suÉ
;

238 
cmd
[10];

239 
Scsi_Cmnd
 *
SC²t
;

240 
Scsi_T­e
 *
STp
 = &(
scsi_³s
[
dev
]);

242 #ià
ST_WRITE_THRESHOLD_BLOCKS
 < 
ST_BUFFER_BLOCKS


243 ià((
STp
->
bufãr
)->
wr™šg
) {

244 
	`wr™e_behšd_check
(
dev
);

245 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
) {

246 #ifdeà
DEBUG


247 
	`´štk
("¡%d: Asynøwr™”rÜ %x.\n", 
dev
,

248 (
STp
->
bufãr
)->
Ï¡_»suÉ
);

250 ià((
STp
->
bufãr
)->
Ï¡_»suÉ
 =ğ
INT_MAX
)

251  (-
ENOSPC
);

252  (-
EIO
);

257 
»suÉ
 = 0;

258 ià(
STp
->
dœty
 == 1) {

259 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

261 
off£t
 = (
STp
->
bufãr
)->
bufãr_by‹s
;

262 
Œªsãr
 = ((
off£t
 + 
STp
->
block_size
 - 1) /

263 
STp
->
block_size
) * STp->block_size;

264 #ifdeà
DEBUG


265 
	`´štk
("¡%d: Flushšg %d by‹s.\n", 
dev
, 
Œªsãr
);

267 
	`mem£t
((
STp
->
bufãr
)->
b_d©a
 + 
off£t
, 0, 
Œªsãr
 - offset);

269 
SC²t
->
£n£_bufãr
[0] = 0;

270 
	`mem£t
(
cmd
, 0, 10);

271 
cmd
[0] = 
WRITE_6
;

272 
cmd
[1] = 1;

273 
blks
 = 
Œªsãr
 / 
STp
->
block_size
;

274 
cmd
[2] = 
blks
 >> 16;

275 
cmd
[3] = 
blks
 >> 8;

276 
cmd
[4] = 
blks
;

277 
SC²t
->
»que¡
.
dev
 = dev;

278 
	`scsi_do_cmd
 (
SC²t
,

279 (*è
cmd
, (
STp
->
bufãr
)->
b_d©a
, 
Œªsãr
,

280 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_RETRIES
);

282 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

284 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

285 
	`´štk
("¡%d: E¼Ü oÀæush.\n", 
dev
);

286 ià((
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70 &&

287 (
SC²t
->
£n£_bufãr
[2] & 0x40) &&

288 (
SC²t
->
£n£_bufãr
[2] & 0x0fè!ğ
VOLUME_OVERFLOW
) {

289 
STp
->
dœty
 = 0;

290 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

291 
»suÉ
 = (-
ENOSPC
);

294 
»suÉ
 = (-
EIO
);

297 
STp
->
dœty
 = 0;

298 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

300 
SC²t
->
»que¡
.
dev
 = -1;

302  
»suÉ
;

303 
	}
}

309 
	$æush_bufãr
(
šode
 * inode, 
fe
 * 
fp
, 
£ek_Ãxt
)

311 
dev
;

312 
back¥aû
, 
»suÉ
;

313 
Scsi_T­e
 * 
STp
;

314 
ST_bufãr
 * 
STbufãr
;

316 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) & 127;

317 
STp
 = &(
scsi_³s
[
dev
]);

318 
STbufãr
 = 
STp
->
bufãr
;

320 ià(
STp
->
rw
 =ğ
ST_WRITING
)

321  
	`æush_wr™e_bufãr
(
dev
);

323 ià(
STp
->
block_size
 == 0)

326 
back¥aû
 = ((
STp
->
bufãr
)->
bufãr_by‹s
 +

327 (
STp
->
bufãr
)->
»ad_poš‹r
è/ STp->
block_size
 -

328 ((
STp
->
bufãr
)->
»ad_poš‹r
 + STp->
block_size
 - 1) /

329 
STp
->
block_size
;

330 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

331 (
STp
->
bufãr
)->
»ad_poš‹r
 = 0;

332 
»suÉ
 = 0;

333 ià(!
£ek_Ãxt
) {

334 ià((
STp
->
eof
 =ğ
ST_FM
è&& !STp->
eof_h™
) {

335 
»suÉ
 = 
	`¡_št_ioùl
(
šode
, 
fp
, 
MTBSF
, 1);

336 ià(!
»suÉ
) {

337 
STp
->
eof
 = 
ST_NOEOF
;

338 
STp
->
eof_h™
 = 0;

341 ià(!
»suÉ
 && 
back¥aû
 > 0)

342 
»suÉ
 = 
	`¡_št_ioùl
(
šode
, 
fp
, 
MTBSR
, 
back¥aû
);

344  
»suÉ
;

346 
	}
}

351 
	$scsi_³_İ’
(
šode
 * inode, 
fe
 * 
fp
)

353 
dev
;

354 
æags
;

355 
i
;

356 
cmd
[10];

357 
Scsi_Cmnd
 * 
SC²t
;

358 
Scsi_T­e
 * 
STp
;

360 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) & 127;

361 ià(
dev
 >ğ
NR_ST
)

362  (-
ENODEV
);

363 
STp
 = &(
scsi_³s
[
dev
]);

364 ià(
STp
->
š_u£
) {

365 
	`´štk
("¡%d: Deviû‡Ì—dy iÀu£.\n", 
dev
);

366  (-
EBUSY
);

370 
i
=0; i < 
¡_nbr_bufãrs
; i++)

371 ià(!
¡_bufãrs
[
i
]->
š_u£
)

373 ià(
i
 >ğ
¡_nbr_bufãrs
) {

374 
	`´štk
("¡%d: NØä“ bufãrs.\n", 
dev
);

375  (-
EBUSY
);

377 
STp
->
bufãr
 = 
¡_bufãrs
[
i
];

378 (
STp
->
bufãr
)->
š_u£
 = 1;

379 (
STp
->
bufãr
)->
wr™šg
 = 0;

380 
STp
->
š_u£
 = 1;

382 
æags
 = 
fp
->
f_æags
;

383 
STp
->
wr™e_´Ù
 = ((
æags
 & 
O_ACCMODE
è=ğ
O_RDONLY
);

385 
STp
->
dœty
 = 0;

386 
STp
->
rw
 = 
ST_IDLE
;

387 
STp
->
eof
 = 
ST_NOEOF
;

388 
STp
->
eof_h™
 = 0;

389 
STp
->
»cov”_couÁ
 = 0;

391 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

392 ià(!
SC²t
) {

393 
	`´štk
("¡%d: T­»que¡‚Ù‡Îoÿ‹d", 
dev
);

394  (-
EBUSY
);

397 
SC²t
->
£n£_bufãr
[0]=0;

398 
	`mem£t
 ((*è&
cmd
[0], 0, 10);

399 
cmd
[0] = 
TEST_UNIT_READY
;

400 
SC²t
->
»que¡
.
dev
 = dev;

401 
	`scsi_do_cmd
(
SC²t
,

402 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

403 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_LONG_TIMEOUT
,

404 
MAX_READY_RETRIES
);

406 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

408 ià((
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70 &&

409 (
SC²t
->
£n£_bufãr
[2] & 0x0fè=ğ
UNIT_ATTENTION
) {

410 
SC²t
->
£n£_bufãr
[0]=0;

411 
	`mem£t
 ((*è&
cmd
[0], 0, 10);

412 
cmd
[0] = 
TEST_UNIT_READY
;

413 
SC²t
->
»que¡
.
dev
 = dev;

414 
	`scsi_do_cmd
(
SC²t
,

415 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

416 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_LONG_TIMEOUT
,

417 
MAX_READY_RETRIES
);

419 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

422 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

423 ià((
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70 &&

424 (
SC²t
->
£n£_bufãr
[2] & 0x0fè=ğ
NO_TAPE
)

425 
	`´štk
("¡%d: NØ³.\n", 
dev
);

427 
	`´štk
("¡%d: E¼Ü %x.\n", 
dev
, 
SC²t
->
»suÉ
);

428 (
STp
->
bufãr
)->
š_u£
 = 0;

429 
STp
->
š_u£
 = 0;

430 
SC²t
->
»que¡
.
dev
 = -1;

431  (-
EIO
);

434 
SC²t
->
£n£_bufãr
[0]=0;

435 
	`mem£t
 ((*è&
cmd
[0], 0, 10);

436 
cmd
[0] = 
READ_BLOCK_LIMITS
;

437 
SC²t
->
»que¡
.
dev
 = dev;

438 
	`scsi_do_cmd
(
SC²t
,

439 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

440 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_READY_RETRIES
);

442 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

444 ià(!
SC²t
->
»suÉ
 && !SC²t->
£n£_bufãr
[0]) {

445 
STp
->
max_block
 = ((STp->
bufãr
)->
b_d©a
[1] << 16) |

446 ((
STp
->
bufãr
)->
b_d©a
[2] << 8) | (STp->buffer)->b_data[3];

447 
STp
->
mš_block
 = ((STp->
bufãr
)->
b_d©a
[4] << 8) |

448 (
STp
->
bufãr
)->
b_d©a
[5];

449 #ifdeà
DEBUG


450 
	`´štk
("¡%d: Block†im™ %d - %d by‹s.\n", 
dev
, 
STp
->
mš_block
,

451 
STp
->
max_block
);

455 
STp
->
mš_block
 = STp->
max_block
 = (-1);

456 #ifdeà
DEBUG


457 
	`´štk
("¡%d: Cª'ˆ»ad block†im™s.\n", 
dev
);

461 
SC²t
->
£n£_bufãr
[0]=0;

462 
	`mem£t
 ((*è&
cmd
[0], 0, 10);

463 
cmd
[0] = 
MODE_SENSE
;

464 
cmd
[4] = 12;

465 
SC²t
->
»que¡
.
dev
 = dev;

466 
	`scsi_do_cmd
(
SC²t
,

467 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

468 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_READY_RETRIES
);

470 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

472 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

473 #ifdeà
DEBUG


474 
	`´štk
("¡%d: NØModS’£.\n", 
dev
);

476 (
STp
->
bufãr
)->
b_d©a
[2] =

477 (
STp
->
bufãr
)->
b_d©a
[3] = 0;

479 
SC²t
->
»que¡
.
dev
 = -1;

481 #ifdeà
DEBUG


482 
	`´štk
("¡%d: Mod£n£. L’gth %d, medium %x, WBS %x, BLL %d\n", 
dev
,

483 (
STp
->
bufãr
)->
b_d©a
[0], (STp->buffer)->b_data[1],

484 (
STp
->
bufãr
)->
b_d©a
[2], (STp->buffer)->b_data[3]);

487 ià((
STp
->
bufãr
)->
b_d©a
[3] >= 8) {

488 
STp
->
drv_bufãr
 = ((STp->
bufãr
)->
b_d©a
[2] >> 4) & 7;

489 
STp
->
d’s™y
 = (STp->
bufãr
)->
b_d©a
[4];

490 
STp
->
block_size
 = (STp->
bufãr
)->
b_d©a
[9] * 65536 +

491 (
STp
->
bufãr
)->
b_d©a
[10] * 256 + (STp->buffer)->b_data[11];

492 #ifdeà
DEBUG


493 
	`´štk
(

495 
dev
, 
STp
->
d’s™y
, (STp->
bufãr
)->
b_d©a
[5] * 65536 +

496 (
STp
->
bufãr
)->
b_d©a
[6] * 256 + (STp->buffer)->b_data[7],

497 
STp
->
block_size
, STp->
drv_bufãr
);

499 ià(
STp
->
block_size
 > 
ST_BUFFER_SIZE
) {

500 
	`´štk
("¡%d: Blocksiz%doØÏrgfÜ bufãr.\n", 
dev
,

501 
STp
->
block_size
);

502 (
STp
->
bufãr
)->
š_u£
 = 0;

503 
STp
->
š_u£
 = 0;

504  (-
EIO
);

509 
STp
->
block_size
 = 
ST_BLOCK_SIZE
;

511 ià(
STp
->
block_size
 > 0) {

512 (
STp
->
bufãr
)->
bufãr_blocks
 = 
ST_BUFFER_SIZE
 / STp->
block_size
;

513 (
STp
->
bufãr
)->
bufãr_size
 =

514 (
STp
->
bufãr
)->
bufãr_blocks
 * STp->
block_size
;

517 (
STp
->
bufãr
)->
bufãr_blocks
 = 1;

518 (
STp
->
bufãr
)->
bufãr_size
 = 
ST_BUFFER_SIZE
;

520 (
STp
->
bufãr
)->
bufãr_by‹s
 = (STp->bufãr)->
»ad_poš‹r
 = 0;

522 #ifdeà
DEBUG


523 
	`´štk
("¡%d: Block size: %d, bufã¸size: %d (%d blocks).\n", 
dev
,

524 
STp
->
block_size
, (STp->
bufãr
)->
bufãr_size
,

525 (
STp
->
bufãr
)->
bufãr_blocks
);

528 ià((
STp
->
bufãr
)->
b_d©a
[2] & 0x80) {

529 
STp
->
wr™e_´Ù
 = 1;

530 #ifdeà
DEBUG


531 
	`´štk
Ğ"¡%d: Wr™´Ùeùed\n", 
dev
);

536 
	}
}

541 
	$scsi_³_şo£
(
šode
 * inode, 
fe
 * 
fp
)

543 
dev
;

544 
»suÉ
;

545 
»wšd
;

546 
cmd
[10];

547 
Scsi_Cmnd
 * 
SC²t
;

548 
Scsi_T­e
 * 
STp
;

550 
dev
 = 
	`MINOR
(
šode
->
i_rdev
);

551 
»wšd
 = (
dev
 & 0x80) == 0;

552 
dev
 = dev & 127;

553 
STp
 = &(
scsi_³s
[
dev
]);

555 iàĞ
STp
->
rw
 =ğ
ST_WRITING
) {

557 
»suÉ
 = 
	`æush_wr™e_bufãr
(
dev
);

559 #ifdeà
DEBUG


560 
	`´štk
("¡%d: FËngth %d by‹s.\n", 
dev
, 
fp
->
f_pos
);

563 ià(
»suÉ
 =ğ0 ||„esuÉ =ğ(-
ENOSPC
)) {

564 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

566 
SC²t
->
£n£_bufãr
[0] = 0;

567 
	`mem£t
(
cmd
, 0, 10);

568 
cmd
[0] = 
WRITE_FILEMARKS
;

569 
cmd
[4] = 1;

570 
SC²t
->
»que¡
.
dev
 = dev;

571 
	`scsi_do_cmd
Ğ
SC²t
,

572 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

573 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_RETRIES
);

575 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

577 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0)

578 
	`´štk
("¡%d: E¼Ü oÀwr™fem¬k.\n", 
dev
);

580 
SC²t
->
»que¡
.
dev
 = -1;

583 #ifdeà
DEBUG


584 
	`´štk
("¡%d: Bufã¸æushed, EOF wr™‹n\n", 
dev
);

587 ià(!
»wšd
) {

588 #iâdeà
ST_IN_FILE_POS


589 ià((
STp
->
eof
 =ğ
ST_FM
è&& !STp->
eof_h™
)

590 
	`¡_št_ioùl
(
šode
, 
fp
, 
MTBSF
, 1);

592 
	`æush_bufãr
(
šode
, 
fp
, 0);

596 ià(
»wšd
)

597 
	`¡_št_ioùl
(
šode
, 
fp
, 
MTREW
, 1);

599 (
STp
->
bufãr
)->
š_u£
 = 0;

600 
STp
->
š_u£
 = 0;

603 
	}
}

608 
	$¡_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

610 
dev
;

611 
tÙ®
, 
do_couÁ
, 
blks
, 
»tv®
, 
Œªsãr
;

612 
wr™e_th»shŞd
;

613 
cmd
[10];

614 *
b_pošt
;

615 
Scsi_Cmnd
 * 
SC²t
;

616 
Scsi_T­e
 * 
STp
;

618 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) & 127;

619 
STp
 = &(
scsi_³s
[
dev
]);

620 #ifdeà
DEBUG


621 ià(!
STp
->
š_u£
) {

622 
	`´štk
("¡%d: IncÜ»ù deviû.\n", 
dev
);

623  (-
EIO
);

627 ià(
STp
->
wr™e_´Ù
)

628  (-
EACCES
);

630 ià(
STp
->
block_size
 =ğ0 && 
couÁ
 > 
ST_BUFFER_SIZE
)

631  (-
EOVERFLOW
);

633 ià(
STp
->
rw
 =ğ
ST_READING
) {

634 
»tv®
 = 
	`æush_bufãr
(
šode
, 
fp
, 0);

635 ià(
»tv®
)

636  
»tv®
;

637 
STp
->
rw
 = 
ST_WRITING
;

640 #ià
ST_WRITE_THRESHOLD_BLOCKS
 < 
ST_BUFFER_BLOCKS


641 ià((
STp
->
bufãr
)->
wr™šg
) {

642 
	`wr™e_behšd_check
(
dev
);

643 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
) {

644 #ifdeà
DEBUG


645 
	`´štk
("¡%d: Asynøwr™”rÜ %x.\n", 
dev
,

646 (
STp
->
bufãr
)->
Ï¡_»suÉ
);

648 ià((
STp
->
bufãr
)->
Ï¡_»suÉ
 =ğ
INT_MAX
) {

649 
»tv®
 = (-
ENOSPC
);

650 
STp
->
eof
 = 
ST_EOM_OK
;

653 
»tv®
 = (-
EIO
);

654  
»tv®
;

659 ià(
STp
->
eof
 =ğ
ST_EOM_OK
)

660  (-
ENOSPC
);

661 ià(
STp
->
eof
 =ğ
ST_EOM_ERROR
)

662  (-
EIO
);

664 #ifdeà
ST_NO_DELAYED_WRITES


665 ià(
STp
->
block_size
 !ğ0 && (
couÁ
 % STp->block_size) != 0)

666  (-
EIO
);

667 
wr™e_th»shŞd
 = 1;

669 
wr™e_th»shŞd
 = (
STp
->
bufãr
)->
bufãr_size
;

672 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

674 
tÙ®
 = 
couÁ
;

676 
	`mem£t
(
cmd
, 0, 10);

677 
cmd
[0] = 
WRITE_6
;

678 
cmd
[1] = (
STp
->
block_size
 != 0);

680 
STp
->
rw
 = 
ST_WRITING
;

682 
b_pošt
 = 
buf
;

684 #ià
ST_WRITE_THRESHOLD_BLOCKS
 < 
ST_BUFFER_BLOCKS


685 
STp
->
block_size
 != 0 &&

686 ((
STp
->
bufãr
)->
bufãr_by‹s
 + 
couÁ
) >

687 
wr™e_th»shŞd
)

689 (
STp
->
block_size
 =ğ0 && 
couÁ
 > 0) ||

690 ((
STp
->
bufãr
)->
bufãr_by‹s
 + 
couÁ
) >=

691 
wr™e_th»shŞd
)

694 ià(
STp
->
block_size
 == 0)

695 
do_couÁ
 = 
couÁ
;

697 
do_couÁ
 = (
STp
->
bufãr
)->
bufãr_size
 - (STp->bufãr)->
bufãr_by‹s
;

698 ià(
do_couÁ
 > 
couÁ
)

699 
do_couÁ
 = 
couÁ
;

701 
	`memıy_äomfs
((
STp
->
bufãr
)->
b_d©a
 +

702 (
STp
->
bufãr
)->
bufãr_by‹s
, 
b_pošt
, 
do_couÁ
);

704 ià(
STp
->
block_size
 == 0)

705 
blks
 = 
do_couÁ
;

707 
blks
 = ((
STp
->
bufãr
)->
bufãr_by‹s
 + 
do_couÁ
) /

708 
STp
->
block_size
;

709 
cmd
[2] = 
blks
 >> 16;

710 
cmd
[3] = 
blks
 >> 8;

711 
cmd
[4] = 
blks
;

712 
SC²t
->
£n£_bufãr
[0] = 0;

713 
SC²t
->
»que¡
.
dev
 = dev;

714 
	`scsi_do_cmd
 (
SC²t
,

715 (*è
cmd
, (
STp
->
bufãr
)->
b_d©a
,

716 (
STp
->
bufãr
)->
bufãr_size
,

717 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_RETRIES
);

719 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

721 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

722 #ifdeà
DEBUG


723 
	`´štk
("¡%d: E¼Ü oÀwr™e:\n", 
dev
);

725 ià((
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70 &&

726 (
SC²t
->
£n£_bufãr
[2] & 0x40)) {

727 ià(
STp
->
block_size
 !ğ0 && (
SC²t
->
£n£_bufãr
[0] & 0x80) != 0)

728 
Œªsãr
 = (
SC²t
->
£n£_bufãr
[3] << 24) |

729 (
SC²t
->
£n£_bufãr
[4] << 16) |

730 (
SC²t
->
£n£_bufãr
[5] << 8) | SCpnt->sense_buffer[6];

731 ià(
STp
->
block_size
 == 0 &&

732 (
SC²t
->
£n£_bufãr
[2] & 0x0fè=ğ
VOLUME_OVERFLOW
)

733 
Œªsãr
 = 
do_couÁ
;

735 
Œªsãr
 = 0;

736 ià(
STp
->
block_size
 != 0)

737 
Œªsãr
 *ğ
STp
->
block_size
;

738 ià(
Œªsãr
 <ğ
do_couÁ
) {

739 
fp
->
f_pos
 +ğ
do_couÁ
 - 
Œªsãr
;

740 
couÁ
 -ğ
do_couÁ
 - 
Œªsãr
;

741 
STp
->
eof
 = 
ST_EOM_OK
;

742 
»tv®
 = (-
ENOSPC
);

743 #ifdeà
DEBUG


744 
	`´štk
("st%d: EOM with %d bytes unwritten.\n",

745 
dev
, 
Œªsãr
);

749 
STp
->
eof
 = 
ST_EOM_ERROR
;

750 
»tv®
 = (-
EIO
);

751 #ifdeà
DEBUG


752 
	`´štk
("¡%d: EOM w™h†o¡ d©a.\n", 
dev
);

757 
»tv®
 = (-
EIO
);

759 
SC²t
->
»que¡
.
dev
 = -1;

760 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

761 
STp
->
dœty
 = 0;

762 ià(
couÁ
 < 
tÙ®
)

763  
tÙ®
 - 
couÁ
;

765  
»tv®
;

767 
fp
->
f_pos
 +ğ
do_couÁ
;

768 
b_pošt
 +ğ
do_couÁ
;

769 
couÁ
 -ğ
do_couÁ
;

770 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

771 
STp
->
dœty
 = 0;

773 ià(
couÁ
 != 0) {

774 
STp
->
dœty
 = 1;

775 
	`memıy_äomfs
((
STp
->
bufãr
)->
b_d©a
 +

776 (
STp
->
bufãr
)->
bufãr_by‹s
,
b_pošt
,
couÁ
);

777 
fp
->
f_pos
 +ğ
couÁ
;

778 (
STp
->
bufãr
)->
bufãr_by‹s
 +ğ
couÁ
;

779 
couÁ
 = 0;

782 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

783 
SC²t
->
»que¡
.
dev
 = -1;

784  (
STp
->
bufãr
)->
Ï¡_»suÉ_çl
;

787 #ià
ST_WRITE_THRESHOLD_BLOCKS
 < 
ST_BUFFER_BLOCKS


788 ià((
STp
->
bufãr
)->
bufãr_by‹s
 >ğ
ST_WRITE_THRESHOLD
 ||

789 
STp
->
block_size
 == 0) {

791 ià(
STp
->
block_size
 == 0)

792 (
STp
->
bufãr
)->
wr™šg
 = (STp->bufãr)->
bufãr_by‹s
;

794 (
STp
->
bufãr
)->
wr™šg
 = ((STp->bufãr)->
bufãr_by‹s
 /

795 
STp
->
block_size
) * STp->block_size;

796 
STp
->
dœty
 = 0;

798 ià(
STp
->
block_size
 == 0)

799 
blks
 = (
STp
->
bufãr
)->
wr™šg
;

801 
blks
 = (
STp
->
bufãr
)->
wr™šg
 / STp->
block_size
;

802 
cmd
[2] = 
blks
 >> 16;

803 
cmd
[3] = 
blks
 >> 8;

804 
cmd
[4] = 
blks
;

805 
SC²t
->
»suÉ
 = (
STp
->
bufãr
)->
Ï¡_»suÉ
 = -1;

806 
SC²t
->
£n£_bufãr
[0] = 0;

807 
SC²t
->
»que¡
.
dev
 = dev;

808 
	`scsi_do_cmd
 (
SC²t
,

809 (*è
cmd
, (
STp
->
bufãr
)->
b_d©a
,

810 (
STp
->
bufãr
)->
wr™šg
,

811 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_RETRIES
);

815 
SC²t
->
»que¡
.
dev
 = -1;

817 Ğ
tÙ®
);

818 
	}
}

823 
	$¡_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

825 
dev
;

826 
tÙ®
;

827 
Œªsãr
, 
blks
, 
by‹s
;

828 
cmd
[10];

829 
Scsi_Cmnd
 * 
SC²t
;

830 
Scsi_T­e
 * 
STp
;

832 
dev
 = 
	`MINOR
(
šode
->
i_rdev
) & 127;

833 
STp
 = &(
scsi_³s
[
dev
]);

834 #ifdeà
DEBUG


835 ià(!
STp
->
š_u£
) {

836 
	`´štk
("¡%d: IncÜ»ù deviû.\n", 
dev
);

837  (-
EIO
);

841 ià(
STp
->
block_size
 =ğ0 && 
couÁ
 > 
ST_BUFFER_SIZE
)

842  (-
EOVERFLOW
);

844 ià(
STp
->
rw
 =ğ
ST_WRITING
) {

845 
Œªsãr
 = 
	`æush_bufãr
(
šode
, 
fp
, 0);

846 ià(
Œªsãr
)

847  
Œªsãr
;

848 
STp
->
rw
 = 
ST_READING
;

851 #ifdeà
DEBUG


852 ià(
STp
->
eof
 !ğ
ST_NOEOF
)

853 
	`´štk
("¡%d: EOF fÏg up. By‹ %d\n", 
dev
,

854 (
STp
->
bufãr
)->
bufãr_by‹s
);

856 ià(((
STp
->
bufãr
)->
bufãr_by‹s
 == 0) &&

857 
STp
->
eof
 =ğ
ST_EOM_OK
)

858  (-
EIO
);

860 
STp
->
rw
 = 
ST_READING
;

862 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

864 
tÙ®
 = 0;Ù® < 
couÁ
; ) {

866 ià((
STp
->
bufãr
)->
bufãr_by‹s
 == 0 &&

867 
STp
->
eof
 =ğ
ST_NOEOF
) {

869 
	`mem£t
(
cmd
, 0, 10);

870 
cmd
[0] = 
READ_6
;

871 
cmd
[1] = (
STp
->
block_size
 != 0);

872 ià(
STp
->
block_size
 == 0)

873 
blks
 = 
by‹s
 = 
couÁ
;

875 
blks
 = (
STp
->
bufãr
)->
bufãr_blocks
;

876 
by‹s
 = 
blks
 * 
STp
->
block_size
;

878 
cmd
[2] = 
blks
 >> 16;

879 
cmd
[3] = 
blks
 >> 8;

880 
cmd
[4] = 
blks
;

882 
SC²t
->
£n£_bufãr
[0] = 0;

883 
SC²t
->
»que¡
.
dev
 = dev;

884 
	`scsi_do_cmd
 (
SC²t
,

885 (*è
cmd
, (
STp
->
bufãr
)->
b_d©a
,

886 (
STp
->
bufãr
)->
bufãr_size
,

887 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_RETRIES
);

889 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

891 (
STp
->
bufãr
)->
»ad_poš‹r
 = 0;

892 
STp
->
eof_h™
 = 0;

894 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
) {

895 #ifdeà
DEBUG


896 
	`´štk
("¡%d: S’£: %2x %2x %2x %2x %2x %2x %2x %2x\n", 
dev
,

897 
SC²t
->
£n£_bufãr
[0], SCpnt->sense_buffer[1],

898 
SC²t
->
£n£_bufãr
[2], SCpnt->sense_buffer[3],

899 
SC²t
->
£n£_bufãr
[4], SCpnt->sense_buffer[5],

900 
SC²t
->
£n£_bufãr
[6], SCpnt->sense_buffer[7]);

902 ià((
SC²t
->
£n£_bufãr
[0] & 0x70) == 0x70) {

904 ià((
SC²t
->
£n£_bufãr
[2] & 0xe0) != 0) {

906 ià((
SC²t
->
£n£_bufãr
[0] & 0x80) != 0)

907 
Œªsãr
 = (
SC²t
->
£n£_bufãr
[3] << 24) |

908 (
SC²t
->
£n£_bufãr
[4] << 16) |

909 (
SC²t
->
£n£_bufãr
[5] << 8) | SCpnt->sense_buffer[6];

911 
Œªsãr
 = 0;

912 ià(
STp
->
block_size
 == 0 &&

913 (
SC²t
->
£n£_bufãr
[2] & 0x0fè=ğ
MEDIUM_ERROR
)

914 
Œªsãr
 = 
by‹s
;

916 ià(
SC²t
->
£n£_bufãr
[2] & 0x20) {

917 ià(
STp
->
block_size
 == 0) {

918 ià(
Œªsãr
 <= 0)

919 
Œªsãr
 = 0;

920 (
STp
->
bufãr
)->
bufãr_by‹s
 = 
couÁ
 - 
Œªsãr
;

923 
	`´štk
("¡%d: IncÜ»ù block size.\n", 
dev
);

924 
SC²t
->
»que¡
.
dev
 = -1;

925  (-
EIO
);

928 ià(
SC²t
->
£n£_bufãr
[2] & 0x40) {

929 
STp
->
eof
 = 
ST_EOM_OK
;

930 ià(
STp
->
block_size
 == 0)

931 (
STp
->
bufãr
)->
bufãr_by‹s
 = 
couÁ
 - 
Œªsãr
;

933 (
STp
->
bufãr
)->
bufãr_by‹s
 =

934 ((
STp
->
bufãr
)->
bufãr_blocks
 - 
Œªsãr
) *

935 
STp
->
block_size
;

936 #ifdeà
DEBUG


937 
	`´štk
("¡%d: EOM d‘eùed (%d by‹ »ad).\n", 
dev
,

938 (
STp
->
bufãr
)->
bufãr_by‹s
);

941 ià(
SC²t
->
£n£_bufãr
[2] & 0x80) {

942 
STp
->
eof
 = 
ST_FM
;

943 ià(
STp
->
block_size
 == 0)

944 (
STp
->
bufãr
)->
bufãr_by‹s
 = 0;

946 (
STp
->
bufãr
)->
bufãr_by‹s
 =

947 ((
STp
->
bufãr
)->
bufãr_blocks
 - 
Œªsãr
) *

948 
STp
->
block_size
;

949 #ifdeà
DEBUG


950 
	`´štk
(

952 
dev
, (
STp
->
bufãr
)->
bufãr_by‹s
, 
tÙ®
);

957 #ifdeà
DEBUG


958 
	`´štk
("¡%d: T­”rÜ wh»adšg.\n", 
dev
);

960 
SC²t
->
»que¡
.
dev
 = -1;

961 ià(
tÙ®
)

962  
tÙ®
;

964  -
EIO
;

968 
Œªsãr
 = (
STp
->
bufãr
)->
Ï¡_»suÉ_çl
;

969 
SC²t
->
»que¡
.
dev
 = -1;

970  
Œªsãr
;

974 (
STp
->
bufãr
)->
bufãr_by‹s
 = 
by‹s
;

979 ià((
STp
->
bufãr
)->
bufãr_by‹s
 > 0) {

980 #ifdeà
DEBUG


981 ià(
STp
->
eof
 !ğ
ST_NOEOF
)

982 
	`´štk
("¡%d: EOF up. Leá %d,‚“ded %d.\n", 
dev
,

983 (
STp
->
bufãr
)->
bufãr_by‹s
, 
couÁ
 - 
tÙ®
);

985 
Œªsãr
 = (
STp
->
bufãr
)->
bufãr_by‹s
 < 
couÁ
 - 
tÙ®
 ?

986 (
STp
->
bufãr
)->
bufãr_by‹s
 : 
couÁ
 - 
tÙ®
;

987 
	`memıy_tofs
(
buf
, (
STp
->
bufãr
)->
b_d©a
 +

988 (
STp
->
bufãr
)->
»ad_poš‹r
,
Œªsãr
);

989 
fp
->
f_pos
 +ğ
Œªsãr
;

990 
buf
 +ğ
Œªsãr
;

991 
tÙ®
 +ğ
Œªsãr
;

992 (
STp
->
bufãr
)->
bufãr_by‹s
 -ğ
Œªsãr
;

993 (
STp
->
bufãr
)->
»ad_poš‹r
 +ğ
Œªsãr
;

995 ià(
STp
->
eof
 !ğ
ST_NOEOF
) {

996 
STp
->
eof_h™
 = 1;

997 
SC²t
->
»que¡
.
dev
 = -1;

998 ià(
tÙ®
 =ğ0 && 
STp
->
eof
 =ğ
ST_FM
)

999 
STp
->
eof
 = 0;

1000 ià(
tÙ®
 =ğ0 && 
STp
->
eof
 =ğ
ST_EOM_OK
)

1001  (-
EIO
);

1002  
tÙ®
;

1005 ià(
STp
->
block_size
 == 0)

1006 
couÁ
 = 
tÙ®
;

1010 
SC²t
->
»que¡
.
dev
 = -1;

1012  
tÙ®
;

1013 
	}
}

1018 
	$¡_št_ioùl
(
šode
 * inode,
fe
 * file,

1019 
cmd_š
, 
¬g
)

1021 
dev
 = 
	`MINOR
(
šode
->
i_rdev
);

1022 
timeout
 = 
ST_LONG_TIMEOUT
;

1023 
Émp
;

1024 
ioùl_»suÉ
;

1025 
cmd
[10];

1026 
Scsi_Cmnd
 * 
SC²t
;

1027 
Scsi_T­e
 * 
STp
;

1029 
dev
 = dev & 127;

1030 
STp
 = &(
scsi_³s
[
dev
]);

1032 
	`mem£t
(
cmd
, 0, 10);

1033 
cmd_š
) {

1034 
MTFSF
:

1035 
MTFSFM
:

1036 
cmd
[0] = 
SPACE
;

1037 
cmd
[1] = 0x01;

1038 
cmd
[2] = (
¬g
 >> 16);

1039 
cmd
[3] = (
¬g
 >> 8);

1040 
cmd
[4] = 
¬g
;

1041 #ifdeà
DEBUG


1042 
	`´štk
("¡%d: S·cšg­fÜw¬d ov” %d fem¬ks.\n", 
dev
,

1043 
cmd
[2] * 65536 + cmd[3] * 256 + cmd[4]);

1046 
MTBSF
:

1047 
MTBSFM
:

1048 
cmd
[0] = 
SPACE
;

1049 
cmd
[1] = 0x01;

1050 
Émp
 = (-
¬g
);

1051 
cmd
[2] = (
Émp
 >> 16);

1052 
cmd
[3] = (
Émp
 >> 8);

1053 
cmd
[4] = 
Émp
;

1054 #ifdeà
DEBUG


1055 ià(
cmd
[2] & 0x80)

1056 
Émp
 = 0xff000000;

1057 
Émp
 =†tm°| (
cmd
[2] << 16) | (cmd[3] << 8) | cmd[4];

1058 
	`´štk
("¡%d: S·cšg­backw¬d ov” %d fem¬ks.\n", 
dev
, (-
Émp
));

1061 
MTFSR
:

1062 
cmd
[0] = 
SPACE
;

1063 
cmd
[1] = 0x00;

1064 
cmd
[2] = (
¬g
 >> 16);

1065 
cmd
[3] = (
¬g
 >> 8);

1066 
cmd
[4] = 
¬g
;

1067 #ifdeà
DEBUG


1068 
	`´štk
("¡%d: S·cšg­fÜw¬d %d blocks.\n", 
dev
,

1069 
cmd
[2] * 65536 + cmd[3] * 256 + cmd[4]);

1072 
MTBSR
:

1073 
cmd
[0] = 
SPACE
;

1074 
cmd
[1] = 0x00;

1075 
Émp
 = (-
¬g
);

1076 
cmd
[2] = (
Émp
 >> 16);

1077 
cmd
[3] = (
Émp
 >> 8);

1078 
cmd
[4] = 
Émp
;

1079 #ifdeà
DEBUG


1080 ià(
cmd
[2] & 0x80)

1081 
Émp
 = 0xff000000;

1082 
Émp
 =†tm°| (
cmd
[2] << 16) | (cmd[3] << 8) | cmd[4];

1083 
	`´štk
("¡%d: S·cšg­backw¬d %d blocks.\n", 
dev
, (-
Émp
));

1086 
MTWEOF
:

1087 ià(
STp
->
wr™e_´Ù
)

1088  (-
EACCES
);

1089 
cmd
[0] = 
WRITE_FILEMARKS
;

1090 
cmd
[2] = (
¬g
 >> 16);

1091 
cmd
[3] = (
¬g
 >> 8);

1092 
cmd
[4] = 
¬g
;

1093 
timeout
 = 
ST_TIMEOUT
;

1094 #ifdeà
DEBUG


1095 
	`´štk
("¡%d: Wr™šg %d fem¬ks.\n", 
dev
,

1096 
cmd
[2] * 65536 + cmd[3] * 256 + cmd[4]);

1099 
MTREW
:

1100 
cmd
[0] = 
REZERO_UNIT
;

1101 #ifdeà
ST_NOWAIT


1102 
cmd
[1] = 1;

1103 
timeout
 = 
ST_TIMEOUT
;

1105 #ifdeà
DEBUG


1106 
	`´štk
("¡%d: Rewšdšg­e.\n", 
dev
);

1109 
MTOFFL
:

1110 
cmd
[0] = 
START_STOP
;

1111 #ifdeà
ST_NOWAIT


1112 
cmd
[1] = 1;

1113 
timeout
 = 
ST_TIMEOUT
;

1115 #ifdeà
DEBUG


1116 
	`´štk
("¡%d: UÆßdšg­e.\n", 
dev
);

1119 
MTNOP
:

1120 #ifdeà
DEBUG


1121 
	`´štk
("¡%d: NØİ oÀ³.\n", 
dev
);

1125 
MTRETEN
:

1126 
cmd
[0] = 
START_STOP
;

1127 #ifdeà
ST_NOWAIT


1128 
cmd
[1] = 1;

1129 
timeout
 = 
ST_TIMEOUT
;

1131 
cmd
[4] = 3;

1132 #ifdeà
DEBUG


1133 
	`´štk
("¡%d: R‘’siÚšg­e.\n", 
dev
);

1136 
MTEOM
:

1137 
cmd
[0] = 
SPACE
;

1138 
cmd
[1] = 3;

1139 #ifdeà
DEBUG


1140 
	`´štk
("¡%d: S·cšgØ’d oà»cÜded medium.\n", 
dev
);

1143 
MTERASE
:

1144 ià(
STp
->
wr™e_´Ù
)

1145  (-
EACCES
);

1146 
cmd
[0] = 
ERASE
;

1147 
cmd
[1] = 1;

1148 #ifdeà
DEBUG


1149 
	`´štk
("¡%d: E¿sšg­e.\n", 
dev
);

1152 
MTSEEK
:

1153 ià((
STp
->
deviû
)->
scsi_Ëv–
 < 
SCSI_2
) {

1154 
cmd
[0] = 
QFA_SEEK_BLOCK
;

1155 
cmd
[2] = (
¬g
 >> 16);

1156 
cmd
[3] = (
¬g
 >> 8);

1157 
cmd
[4] = 
¬g
;

1158 
cmd
[5] = 0;

1161 
cmd
[0] = 
SEEK_10
;

1162 
cmd
[1] = 4;

1163 
cmd
[3] = (
¬g
 >> 24);

1164 
cmd
[4] = (
¬g
 >> 16);

1165 
cmd
[5] = (
¬g
 >> 8);

1166 
cmd
[6] = 
¬g
;

1168 #ifdeà
ST_NOWAIT


1169 
cmd
[1] |= 1;

1170 
timeout
 = 
ST_TIMEOUT
;

1172 #ifdeà
DEBUG


1173 
	`´štk
("¡%d: S“kšg­tØblock %d.\n", 
dev
, 
¬g
);

1176 
MTSETBLK
:

1177 
MTSETDENSITY
:

1178 
MTSETDRVBUFFER
:

1179 ià(
STp
->
dœty
 || (STp->
bufãr
)->
bufãr_by‹s
 != 0)

1180  (-
EIO
);

1181 ià(
cmd_š
 =ğ
MTSETBLK
 &&

1182 
¬g
 != 0 &&

1183 (
¬g
 < 
STp
->
mš_block
 ||‡rg > STp->
max_block
 ||

1184 
¬g
 > 
ST_BUFFER_SIZE
)) {

1185 
	`´štk
("¡%d: IÎeg® block size.\n", 
dev
);

1186  (-
EINVAL
);

1188 
cmd
[0] = 
MODE_SELECT
;

1189 
cmd
[4] = 12;

1191 
	`mem£t
((
STp
->
bufãr
)->
b_d©a
, 0, 12);

1192 ià(
cmd_š
 =ğ
MTSETDRVBUFFER
)

1193 (
STp
->
bufãr
)->
b_d©a
[2] = (
¬g
 & 7) << 4;

1195 (
STp
->
bufãr
)->
b_d©a
[2] =

1196 
STp
->
drv_bufãr
 << 4;

1197 (
STp
->
bufãr
)->
b_d©a
[3] = 8;

1198 ià(
cmd_š
 =ğ
MTSETDENSITY
)

1199 (
STp
->
bufãr
)->
b_d©a
[4] = 
¬g
;

1201 (
STp
->
bufãr
)->
b_d©a
[4] = STp->
d’s™y
;

1202 ià(
cmd_š
 =ğ
MTSETBLK
)

1203 
Émp
 = 
¬g
;

1205 
Émp
 = 
STp
->
block_size
;

1206 (
STp
->
bufãr
)->
b_d©a
[9] = (
Émp
 >> 16);

1207 (
STp
->
bufãr
)->
b_d©a
[10] = (
Émp
 >> 8);

1208 (
STp
->
bufãr
)->
b_d©a
[11] = 
Émp
;

1209 
timeout
 = 
ST_TIMEOUT
;

1210 #ifdeà
DEBUG


1211 ià(
cmd_š
 =ğ
MTSETBLK
)

1212 
	`´štk
("¡%d: S‘tšg block siztØ%d by‹s.\n", 
dev
,

1213 (
STp
->
bufãr
)->
b_d©a
[9] * 65536 +

1214 (
STp
->
bufãr
)->
b_d©a
[10] * 256 +

1215 (
STp
->
bufãr
)->
b_d©a
[11]);

1216 ià(
cmd_š
 =ğ
MTSETDENSITY
)

1217 
	`´štk
("¡%d: S‘tšg d’s™y codtØ%x.\n", 
dev
,

1218 (
STp
->
bufãr
)->
b_d©a
[4]);

1220 
	`´štk
("¡%d: S‘tšg drivbufã¸codtØ%d.\n", 
dev
,

1221 ((
STp
->
bufãr
)->
b_d©a
[2] >> 4) & 7);

1225 
	`´štk
("¡%d: UnknowÀ¡_ioùÈcommªd %x.\n", 
dev
, 
cmd_š
);

1226  (-
ENOSYS
);

1229 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

1230 
SC²t
->
£n£_bufãr
[0] = 0;

1231 
SC²t
->
»que¡
.
dev
 = dev;

1232 
	`scsi_do_cmd
(
SC²t
,

1233 (*è
cmd
, (*è(
STp
->
bufãr
)->
b_d©a
, 
ST_BLOCK_SIZE
,

1234 
¡_¦“p_dÚe
, 
timeout
, 
MAX_RETRIES
);

1236 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

1238 
ioùl_»suÉ
 = (
STp
->
bufãr
)->
Ï¡_»suÉ_çl
;

1240 
SC²t
->
»que¡
.
dev
 = -1;

1242 ià(!
ioùl_»suÉ
) {

1243 ià(
cmd_š
 =ğ
MTBSFM
)

1244 
ioùl_»suÉ
 = 
	`¡_št_ioùl
(
šode
, 
fe
, 
MTFSF
, 1);

1245 ià(
cmd_š
 =ğ
MTFSFM
)

1246 
ioùl_»suÉ
 = 
	`¡_št_ioùl
(
šode
, 
fe
, 
MTBSF
, 1);

1247 ià(
cmd_š
 =ğ
MTSETBLK
) {

1248 
STp
->
block_size
 = 
¬g
;

1249 ià(
¬g
 != 0) {

1250 (
STp
->
bufãr
)->
bufãr_blocks
 =

1251 
ST_BUFFER_SIZE
 / 
STp
->
block_size
;

1252 (
STp
->
bufãr
)->
bufãr_size
 =

1253 (
STp
->
bufãr
)->
bufãr_blocks
 * STp->
block_size
;

1256 (
STp
->
bufãr
)->
bufãr_blocks
 = 1;

1257 (
STp
->
bufãr
)->
bufãr_size
 = 
ST_BUFFER_SIZE
;

1259 (
STp
->
bufãr
)->
bufãr_by‹s
 =

1260 (
STp
->
bufãr
)->
»ad_poš‹r
 = 0;

1262 ià(
cmd_š
 =ğ
MTSETDRVBUFFER
)

1263 
STp
->
drv_bufãr
 = 
¬g
;

1264 ià(
cmd_š
 =ğ
MTSETDENSITY
)

1265 
STp
->
d’s™y
 = 
¬g
;

1266 ià(
cmd_š
 =ğ
MTEOM
 || cmd_š =ğ
MTWEOF
) {

1267 
STp
->
eof
 = 
ST_EOM_OK
;

1268 
STp
->
eof_h™
 = 0;

1270 ià(
cmd_š
 !ğ
MTSETBLK
 && cmd_š !ğ
MTNOP
) {

1271 
STp
->
eof
 = 
ST_NOEOF
;

1272 
STp
->
eof_h™
 = 0;

1276  
ioùl_»suÉ
 ;

1277 
	}
}

1283 
	$¡_ioùl
(
šode
 * inode,
fe
 * file,

1284 
cmd_š
, 
¬g
)

1286 
dev
 = 
	`MINOR
(
šode
->
i_rdev
);

1287 
i
, 
cmd
, 
»suÉ
;

1288 
mtİ
 
mtc
;

1289 
mos
 
mt_pos
;

1290 
scmd
[10];

1291 
Scsi_Cmnd
 *
SC²t
;

1292 
Scsi_T­e
 *
STp
;

1294 
dev
 = dev & 127;

1295 
STp
 = &(
scsi_³s
[
dev
]);

1296 #ifdeà
DEBUG


1297 ià(!
STp
->
š_u£
) {

1298 
	`´štk
("¡%d: IncÜ»ù deviû.\n", 
dev
);

1299  (-
EIO
);

1303 
cmd
 = 
cmd_š
 & 
IOCCMD_MASK
;

1304 ià(
cmd
 =ğ(
MTIOCTOP
 & 
IOCCMD_MASK
)) {

1306 ià(((
cmd_š
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mtc
))

1307  (-
EINVAL
);

1309 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, (
mtc
));

1310 ià(
i
)

1311  
i
;

1313 
	`memıy_äomfs
((*è&
mtc
, (*)
¬g
, (
mtİ
));

1315 
i
 = 
	`æush_bufãr
(
šode
, 
fe
, 
mtc
.
mt_İ
 =ğ
MTSEEK
 ||

1316 
mtc
.
mt_İ
 =ğ
MTREW
 || mtc.mt_İ =ğ
MTOFFL
 ||

1317 
mtc
.
mt_İ
 =ğ
MTRETEN
 || mtc.mt_İ =ğ
MTEOM
);

1318 ià(
i
 < 0)

1319  
i
;

1321  
	`¡_št_ioùl
(
šode
, 
fe
, 
mtc
.
mt_İ
, mtc.
mt_couÁ
);

1323 ià(
cmd
 =ğ(
MTIOCGET
 & 
IOCCMD_MASK
)) {

1325 ià(((
cmd_š
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mtg‘
))

1326  (-
EINVAL
);

1327 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, (
mtg‘
));

1328 ià(
i
)

1329  
i
;

1331 
	`memıy_tofs
((*)
¬g
, (*)(
STp
->
bufãr
)->
mt_¡©us
,

1332 (
mtg‘
));

1335 ià(
cmd
 =ğ(
MTIOCPOS
 & 
IOCCMD_MASK
)) {

1336 #ifdeà
DEBUG


1337 
	`´štk
("¡%d: g‘­pos™iÚ.\n", 
dev
);

1339 ià(((
cmd_š
 & 
IOCSIZE_MASK
è>> 
IOCSIZE_SHIFT
è!ğ(
mos
))

1340  (-
EINVAL
);

1342 
i
 = 
	`æush_bufãr
(
šode
, 
fe
, 0);

1343 ià(
i
 < 0)

1344  
i
;

1346 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*)
¬g
, (
mos
));

1347 ià(
i
)

1348  
i
;

1350 
SC²t
 = 
	`®loÿ‹_deviû
(
NULL
, (
STp
->
deviû
)->
šdex
, 1);

1352 
SC²t
->
£n£_bufãr
[0]=0;

1353 
	`mem£t
 (
scmd
, 0, 10);

1354 ià((
STp
->
deviû
)->
scsi_Ëv–
 < 
SCSI_2
) {

1355 
scmd
[0] = 
QFA_REQUEST_BLOCK
;

1356 
scmd
[4] = 3;

1359 
scmd
[0] = 
READ_POSITION
;

1360 
scmd
[1] = 1;

1362 
SC²t
->
»que¡
.
dev
 = dev;

1363 
SC²t
->
£n£_bufãr
[0] = 0;

1364 
	`scsi_do_cmd
(
SC²t
,

1365 (*è
scmd
, (*è(
STp
->
bufãr
)->
b_d©a
,

1366 
ST_BLOCK_SIZE
, 
¡_¦“p_dÚe
, 
ST_TIMEOUT
, 
MAX_READY_RETRIES
);

1368 ià(
SC²t
->
»que¡
.
dev
 =ğdevè
	`¦“p_Ú
Ğ&(
STp
->
wa™šg
) );

1370 ià((
STp
->
bufãr
)->
Ï¡_»suÉ_çl
 != 0) {

1371 
mt_pos
.
mt_blkno
 = (-1);

1372 #ifdeà
DEBUG


1373 
	`´štk
("¡%d: Cª'ˆ»ad­pos™iÚ.\n", 
dev
);

1375 
»suÉ
 = (-
EIO
);

1378 
»suÉ
 = 0;

1379 ià((
STp
->
deviû
)->
scsi_Ëv–
 < 
SCSI_2
)

1380 
mt_pos
.
mt_blkno
 = ((
STp
->
bufãr
)->
b_d©a
[0] << 16)

1381 + ((
STp
->
bufãr
)->
b_d©a
[1] << 8)

1382 + (
STp
->
bufãr
)->
b_d©a
[2];

1384 
mt_pos
.
mt_blkno
 = ((
STp
->
bufãr
)->
b_d©a
[4] << 24)

1385 + ((
STp
->
bufãr
)->
b_d©a
[5] << 16)

1386 + ((
STp
->
bufãr
)->
b_d©a
[6] << 8)

1387 + (
STp
->
bufãr
)->
b_d©a
[7];

1391 
SC²t
->
»que¡
.
dev
 = -1;

1393 
	`memıy_tofs
((*)
¬g
, (*è(&
mt_pos
), (
mos
));

1394  
»suÉ
;

1397  
	`scsi_ioùl
(
STp
->
deviû
, 
cmd_š
, (*è
¬g
);

1398 
	}
}

1402 
fe_İ”©iÚs
 
	g¡_fİs
 = {

1403 
NULL
,

1404 
¡_»ad
,

1405 
¡_wr™e
,

1406 
NULL
,

1407 
NULL
,

1408 
¡_ioùl
,

1409 
NULL
,

1410 
scsi_³_İ’
,

1411 
scsi_³_şo£
,

1412 
NULL


1415 
	$¡_©ch
(
Scsi_Deviû
 * 
SDp
){

1416 
scsi_³s
[
NR_ST
++].
deviû
 = 
SDp
;

1417 if(
NR_ST
 > 
MAX_ST
è
	`·nic
 ("scsi_devices corrupt (st)");

1418 
	}
};

1420 
	$¡_š™1
(
mem_¡¬t
, 
mem_’d
){

1421 
scsi_³s
 = (
Scsi_T­e
 *è
mem_¡¬t
;

1422 
mem_¡¬t
 +ğ
MAX_ST
 * (
Scsi_T­e
);

1423  
mem_¡¬t
;

1424 
	}
};

1427 
	$¡_š™
(
mem_¡¬t
, 
mem_’d
)

1429 
i
;

1431 ià(
	`»gi¡”_chrdev
(
MAJOR_NR
,"¡",&
¡_fİs
)) {

1432 
	`´štk
("UÇbËØg‘ majÜ %d fÜ SCSI­es\n",
MAJOR_NR
);

1433  
mem_¡¬t
;

1435 ià(
NR_ST
 =ğ0è 
mem_¡¬t
;

1437 #ifdeà
DEBUG


1438 
	`´štk
("st: Initape.\n");

1441 
i
=0; i < 
NR_ST
; ++i) {

1442 
scsi_³s
[
i
].
ÿ·c™y
 = 0xfffff;

1443 
scsi_³s
[
i
].
dœty
 = 0;

1444 
scsi_³s
[
i
].
rw
 = 
ST_IDLE
;

1445 
scsi_³s
[
i
].
eof
 = 
ST_NOEOF
;

1446 
scsi_³s
[
i
].
wa™šg
 = 
NULL
;

1447 
scsi_³s
[
i
].
š_u£
 = 0;

1448 
scsi_³s
[
i
].
drv_bufãr
 = 1;

1449 
scsi_³s
[
i
].
d’s™y
 = 0;

1454 ià(
NR_ST
 == 1)

1455 
¡_nbr_bufãrs
 = 1;

1457 
¡_nbr_bufãrs
 = 2;

1458 
i
=0; i < 
¡_nbr_bufãrs
; i++) {

1459 
¡_bufãrs
[
i
] = (
ST_bufãr
 *è
mem_¡¬t
;

1460 #ifdeà
DEBUG


1461 
	`´štk
("¡: Bufã¸add»ss: %p\n", 
¡_bufãrs
[
i
]);

1463 
mem_¡¬t
 +ğ(
ST_bufãr
è- 1 + 
ST_BUFFER_BLOCKS
 * 
ST_BLOCK_SIZE
;

1464 
¡_bufãrs
[
i
]->
mt_¡©us
 = (
mtg‘
 *è
mem_¡¬t
;

1465 
mem_¡¬t
 +ğ(
mtg‘
);

1466 
¡_bufãrs
[
i
]->
š_u£
 = 0;

1467 
¡_bufãrs
[
i
]->
wr™šg
 = 0;

1470 
	`mem£t
((*è
¡_bufãrs
[
i
]->
mt_¡©us
, 0, (
mtg‘
));

1471 
¡_bufãrs
[
i
]->
mt_¡©us
->
mt_ty³
 = 
MT_ISSCSI1
;

1474  
mem_¡¬t
;

1475 
	}
}

	@drivers/scsi/st.h

2 #iâdeà
_ST_H


3 
	#_ST_H


	)

8 #iâdeà
_SCSI_H


9 
	~"scsi.h
"

13 
	mš_u£
;

14 
mtg‘
 * 
	mmt_¡©us
;

15 
	mbufãr_size
;

16 
	mbufãr_blocks
;

17 
	mbufãr_by‹s
;

18 
	m»ad_poš‹r
;

19 
	mwr™šg
;

20 
	mÏ¡_»suÉ
;

21 
	mÏ¡_»suÉ_çl
;

22 
	mb_d©a
[1];

23 } 
	tST_bufãr
;

26 
	mÿ·c™y
;

27 
wa™_queue
 * 
	mwa™šg
;

28 
Scsi_Deviû
* 
	mdeviû
;

29 
	mdœty
:1;

30 
	mrw
:2;

31 
	meof
:2;

32 
	mwr™e_´Ù
:1;

33 
	mš_u£
:1;

34 
	meof_h™
:1;

35 
	mdrv_bufãr
:3;

36 
	md’s™y
;

37 
ST_bufãr
 * 
	mbufãr
;

38 
	mblock_size
;

39 
	mmš_block
;

40 
	mmax_block
;

41 
	m»cov”_couÁ
;

42 
Scsi_Cmnd
 
	mSC²t
;

43 } 
	tScsi_T­e
;

46 
	#ST_NOEOF
 0

	)

47 
	#ST_FM
 1

	)

48 
	#ST_EOM_OK
 2

	)

49 
	#ST_EOM_ERROR
 3

	)

52 
	#ST_IDLE
 0

	)

53 
	#ST_READING
 1

	)

54 
	#ST_WRITING
 2

	)

57 
	#QFA_REQUEST_BLOCK
 0x02

	)

58 
	#QFA_SEEK_BLOCK
 0x0c

	)

	@drivers/scsi/t128.c

1 
	#AUTOSENSE


	)

2 
	#PSEUDO_DMA


	)

109 
	~<asm/sy¡em.h
>

110 
	~<lšux/sigÇl.h
>

111 
	~<lšux/sched.h
>

112 
	~"../block/blk.h
"

113 
	~"scsi.h
"

114 
	~"ho¡s.h
"

115 
	~"t128.h
"

116 
	#AUTOPROBE_IRQ


	)

117 
	~"NCR5380.h
"

118 
	~"cÚ¡ªts.h
"

123 
	sov”ride
 {

124 *
	madd»ss
;

125 
	mœq
;

126 } 
	gov”rides


127 #ifdeà
T128_OVERRIDE


128 [] = 
T128_OVERRIDE
;

130 [4] = {{
NULL
,
IRQ_AUTO
}, {NULL,IRQ_AUTO}, {NULL,IRQ_AUTO},

131 {
NULL
,
IRQ_AUTO
}};

134 
	#NO_OVERRIDES
 ((
ov”rides
è/ (
ov”ride
))

	)

136 
	sba£
 {

137 *
	madd»ss
;

138 
	mnßuto
;

139 } 
	gba£s
[] = {{(*) 0xcc000, 0}, {(*) 0xc8000, 0},

142 
	#NO_BASES
 ( (
ba£s
è/  (
ba£
))

	)

144 cÚ¡ 
	ssigÇtu»
 {

145 cÚ¡ *
	m¡ršg
;

146 
	moff£t
;

147 } 
	gsigÇtu»s
[] = {

151 
	#NO_SIGNATURES
 ( (
sigÇtu»s
è/  (
sigÇtu»
))

	)

163 
	$t128_£tup
(*
¡r
, *
šts
) {

164 
commªdlše_cu¼’t
 = 0;

165 
i
;

166 ià(
šts
[0] != 2)

167 
	`´štk
("t128_setup : usage128=address,irq\n");

169 ià(
commªdlše_cu¼’t
 < 
NO_OVERRIDES
) {

170 
ov”rides
[
commªdlše_cu¼’t
].
add»ss
 = (*è
šts
[1];

171 
ov”rides
[
commªdlše_cu¼’t
].
œq
 = 
šts
[2];

172 
i
 = 0; i < 
NO_BASES
; ++i)

173 ià(
ba£s
[
i
].
add»ss
 =ğ(*è
šts
[1]) {

174 
ba£s
[
i
].
nßuto
 = 1;

177 ++
commªdlše_cu¼’t
;

179 
	}
}

181 
sigaùiÚ
 
	gt128_sigaùiÚ
 = { 
t128_šŒ
, 0, 
SA_INTERRUPT
 , 
NULL
 };

196 
	$t128_d‘eù
(
ho¡no
) {

197 
cu¼’t_ov”ride
 = 0, 
cu¼’t_ba£
 = 0;

198 
Scsi_Ho¡
 *
š¡ªû
;

199 *
ba£
;

200 
sig
, 
couÁ
;

202 
couÁ
 = 0; 
cu¼’t_ov”ride
 < 
NO_OVERRIDES
; ++current_override) {

203 
ba£
 = 
NULL
;

205 ià(
ov”rides
[
cu¼’t_ov”ride
].
add»ss
)

206 
ba£
 = 
ov”rides
[
cu¼’t_ov”ride
].
add»ss
;

208 ; !
ba£
 && (
cu¼’t_ba£
 < 
NO_BASES
); ++current_base) {

209 #ià(
TDEBUG
 & 
TDEBUG_INIT
)

210 
	`´štk
("scsi%d :…robšg‡dd»s %08x\n", 
ho¡no
, (è
ba£s
[
cu¼’t_ba£
].
add»ss
);

212 
sig
 = 0; sig < 
NO_SIGNATURES
; ++sig)

213 ià(!
ba£s
[
cu¼’t_ba£
].
nßuto
 && !
memcmp


214 (
ba£s
[
cu¼’t_ba£
].
add»ss
 + 
sigÇtu»s
[
sig
].
off£t
,

215 
sigÇtu»s
[
sig
].
¡ršg
, 
	`¡¾’
(signatures[sig].string))) {

216 
ba£
 = 
ba£s
[
cu¼’t_ba£
].
add»ss
;

217 #ià(
TDEBUG
 & 
TDEBUG_INIT
)

218 
	`´štk
("scsi%d : d‘eùed bßrd.\n", 
ho¡no
);

224 #ià
	`defšed
(
TDEBUG
è&& (TDEBUG & 
TDEBUG_INIT
)

225 
	`´štk
("scsi%d : ba£ = %08x\n", 
ho¡no
, (è
ba£
);

228 ià(!
ba£
)

231 
š¡ªû
 = 
	`scsi_»gi¡”
 (
ho¡no
, (
NCR5380_ho¡d©a
));

232 
š¡ªû
->
ba£
 = base;

234 
	`NCR5380_š™
(
š¡ªû
);

236 ià(
ov”rides
[
cu¼’t_ov”ride
].
œq
 !ğ
IRQ_AUTO
)

237 
š¡ªû
->
œq
 = 
ov”rides
[
cu¼’t_ov”ride
].irq;

239 
š¡ªû
->
œq
 = 
	`NCR5380_´obe_œq
(š¡ªû, 
T128_IRQS
);

241 ià(
š¡ªû
->
œq
 !ğ
IRQ_NONE
)

242 ià(
	`œqaùiÚ
 (
š¡ªû
->
œq
, &
t128_sigaùiÚ
)) {

243 
	`´štk
("scsi%d : IRQ%d‚ot free, interrupts disabled\n",

244 
ho¡no
, 
š¡ªû
->
œq
);

245 
š¡ªû
->
œq
 = 
IRQ_NONE
;

248 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
) {

249 
	`´štk
("scsi%d : iÁ”ru± nÙƒÇbËd. fÜ b‘‹¸š‹¿ùiv³rfÜmªû,\n", 
ho¡no
);

250 
	`´štk
("scsi%d :…Ëa£ jum³¸thbßrd fÜ‡ f»IRQ.\n", 
ho¡no
);

253 #ià
	`defšed
(
TDEBUG
è&& (TDEBUG & 
TDEBUG_INIT
)

254 
	`´štk
("scsi%d : irq = %d\n", 
ho¡no
, 
š¡ªû
->
œq
);

257 
	`´štk
("scsi%d :‡ˆ0x%08x", 
š¡ªû
->
ho¡_no
, ()

258 
š¡ªû
->
ba£
);

259 ià(
š¡ªû
->
œq
 =ğ
IRQ_NONE
)

260 
	`´štk
 (" interrupts disabled");

262 
	`´štk
 (" irq %d", 
š¡ªû
->
œq
);

263 
	`´štk
(" options CAN_QUEUE=%d CMD_PER_LUN=%d„elease=%d",

264 
CAN_QUEUE
, 
CMD_PER_LUN
, 
T128_PUBLIC_RELEASE
);

265 
	`NCR5380_´št_İtiÚs
(
š¡ªû
);

266 
	`´štk
("\n");

268 ++
cu¼’t_ov”ride
;

269 ++
couÁ
;

270 ++
ho¡no
;

272  
couÁ
;

273 
	}
}

295 
	$t128_bio¥¬am
(
size
, 
dev
, * 

)

297 

[0] = 64;

298 

[1] = 32;

299 

[2] = 
size
 >> 11;

301 
	}
}

316 
šlše
 
	$NCR5380_´—d
 (
Scsi_Ho¡
 *
š¡ªû
, *
d¡
,

317 
Ën
) {

318 *
»g
 = (*è(
š¡ªû
->
ba£
 +

319 
T_DATA_REG_OFFSET
), *
d
 = 
d¡
;

320 
i
 = 
Ën
;

322 !(
š¡ªû
->
ba£
[
T_STATUS_REG_OFFSET
]è& 
T_ST_RDY
);

324 ; 
i
; --i)

325 *
d
++ = *
»g
;

327 ià(*(
š¡ªû
->
ba£
 + 
T_STATUS_REG_OFFSET
è& 
T_ST_TIM
) {

328 
tmp
;

329 vŞ©*
foo
;

330 
foo
 = 
š¡ªû
->
ba£
 + 
T_CONTROL_REG_OFFSET
;

331 
tmp
 = *
foo
;

332 *
foo
 = 
tmp
 | 
T_CR_CT
;

333 *
foo
 = 
tmp
;

334 
	`´štk
("scsi%d : watchdogimer fired in NCR5480_pread()\n",

335 
š¡ªû
->
ho¡_no
);

339 
	}
}

354 
šlše
 
	$NCR5380_pwr™e
 (
Scsi_Ho¡
 *
š¡ªû
, *
¤c
,

355 
Ën
) {

356 *
»g
 = (*è(
š¡ªû
->
ba£
 +

357 
T_DATA_REG_OFFSET
), *
s
 = 
¤c
;

358 
i
 = 
Ën
;

360 !(
š¡ªû
->
ba£
[
T_STATUS_REG_OFFSET
]è& 
T_ST_RDY
);

361 ; 
i
; --i)

362 *
»g
 = *
s
++;

364 ià(*(
š¡ªû
->
ba£
 + 
T_STATUS_REG_OFFSET
è& 
T_ST_TIM
) {

365 
tmp
;

366 vŞ©*
foo
;

367 
foo
 = 
š¡ªû
->
ba£
 + 
T_CONTROL_REG_OFFSET
;

368 
tmp
 = *
foo
;

369 *
foo
 = 
tmp
 | 
T_CR_CT
;

370 *
foo
 = 
tmp
;

371 
	`´štk
("scsi%d : watchdogimer fired in NCR5480_pwrite()\n",

372 
š¡ªû
->
ho¡_no
);

376 
	}
}

386 cÚ¡ *
	$t128_šfo
 () {

387 cÚ¡ 
¡ršg
[]="";

388  
¡ršg
;

389 
	}
}

391 
	~"NCR5380.c
"

	@drivers/scsi/t128.h

41 #iâdeà
T128_H


42 
	#T128_H


	)

44 
	#T128_PUBLIC_RELEASE
 3

	)

46 
	#TDEBUG_INIT
 0x1

	)

47 
	#TDEBUG_TRANSFER
 0x2

	)

63 
	#T_ROM_OFFSET
 0

	)

69 
	#T_RAM_OFFSET
 0x1800

	)

75 
	#T_CONTROL_REG_OFFSET
 0x1c00

	)

76 
	#T_CR_INT
 0x10

	)

77 
	#T_CR_CT
 0x02

	)

79 
	#T_STATUS_REG_OFFSET
 0x1c20

	)

80 
	#T_ST_BOOT
 0x80

	)

81 
	#T_ST_S3
 0x40

	)

82 
	#T_ST_S2
 0x20

	)

83 
	#T_ST_S1
 0x10

	)

84 
	#T_ST_PS2
 0x08

	)

85 
	#T_ST_RDY
 0x04

	)

86 
	#T_ST_TIM
 0x02

	)

87 
	#T_ST_ZERO
 0x01

	)

89 
	#T_5380_OFFSET
 0x1d00

	)

91 
	#T_DATA_REG_OFFSET
 0x1e00

	)

93 #iâdeà
ASM


94 
t128_abÜt
(
Scsi_Cmnd
 *, );

95 
t128_bio¥¬am
(, , *);

96 
t128_d‘eù
();

97 cÚ¡ *
t128_šfo
();

98 
t128_queue_commªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

99 
	`t128_»£t
(
Scsi_Cmnd
 *);

101 #iâdeà
NULL


102 
	#NULL
 0

	)

105 #iâdeà
CMD_PER_LUN


106 
	#CMD_PER_LUN
 2

	)

109 #iâdeà
CAN_QUEUE


110 
	#CAN_QUEUE
 32

	)

119 #ifdeà
HOSTS_C


121 
	#TRANTOR_T128
 {"T¿ÁÜ T128/T128F/T228", 
t128_d‘eù
, 
t128_šfo
,\

122 
NULL
, 
t128_queue_commªd
, 
t128_abÜt
, 
t128_»£t
, NULL, \

123 
t128_bio¥¬am
, \

124  
CAN_QUEUE
, 7, 
SG_ALL
, \

125  
CMD_PER_LUN
 , 0, 0
	}

	)
}

129 
	#NCR5380_im¶em’tiÚ_f›lds
 \

130 vŞ©*
ba£


	)

132 
	#NCR5380_loÿl_deş¬e
() \

133 vŞ©*
ba£


	)

135 
	#NCR5380_£tup
(
š¡ªû
) \

136 
ba£
 = (vŞ©*è(
š¡ªû
)->
	)
base

138 
	#T128_add»ss
(
»g
è(
ba£
 + 
T_5380_OFFSET
 + (Ôegè* 0x20))

	)

140 #ià!(
TDEBUG
 & 
TDEBUG_TRANSFER
)

141 
	#NCR5380_»ad
(
»g
è(*(
	`T128_add»ss
Ôeg)))

	)

142 
	#NCR5380_wr™e
(
»g
, 
v®ue
è(*(
	`T128_add»ss
Ôeg)èğ(v®ue))

	)

144 
	#NCR5380_»ad
(
»g
) \

145 (((è
	`´štk
("scsi%d :„ead„egister %d‡t‡ddress %08x\n"\

146 , 
š¡ªû
->
ho¡no
, (
»g
), 
	`T128_add»ss
Ôeg))), *(T128_add»ssÔeg)))

	)

148 
	#NCR5380_wr™e
(
»g
, 
v®ue
) { \

149 
	`´štk
("scsi%d : write %02xo„egister %d‡t‡ddress %08x\n", \

150 
š¡ªû
->
ho¡no
, (
v®ue
), (
»g
), 
	`T128_add»ss
(reg)); \

151 *(
	`T128_add»ss
(
»g
)èğ(
v®ue
); \

152 }

	)

155 
	#NCR5380_šŒ
 
t128_šŒ


	)

156 
	#NCR5380_queue_commªd
 
t128_queue_commªd


	)

157 
	#NCR5380_abÜt
 
t128_abÜt


	)

158 
	#NCR5380_»£t
 
t128_»£t


	)

163 
	#T128_IRQS
 0xc4a8

	)

	@drivers/scsi/ultrastor.c

117 
	~<lšux/¡ddef.h
>

118 
	~<lšux/¡ršg.h
>

119 
	~<lšux/sched.h
>

120 
	~<lšux/k”Ãl.h
>

121 
	~<lšux/iİÜt.h
>

123 
	~<asm/io.h
>

124 
	~<asm/b™İs.h
>

125 
	~<asm/sy¡em.h
>

126 
	~<asm/dma.h
>

128 
	#ULTRASTOR_PRIVATE


	)

129 
	~"../block/blk.h
"

130 
	~"scsi.h
"

131 
	~"ho¡s.h
"

132 
	~"uÉ¿¡Ü.h
"

134 
	#FALSE
 0

	)

135 
	#TRUE
 1

	)

137 #iâdeà
ULTRASTOR_DEBUG


138 
	#ULTRASTOR_DEBUG
 (
UD_ABORT
|
UD_CSIR
|
UD_RESET
)

	)

141 
	#VERSION
 "1.11‡Íha"

	)

143 
	#ARRAY_SIZE
(
¬r
è( (¬rè/  (¬r)[0])

	)

145 
	#PACKED
 
	`__©Œibu‹__
((
·cked
))

	)

146 
	#ALIGNED
(
x
è
	`__©Œibu‹__
((
	`®igÃd
(x)))

	)

155 
	madd»ss
;

156 
	mnum_by‹s
;

157 } 
	tuÉ¿¡Ü_sg_li¡
;

162 
	smsı
 {

163 
	mİcode
: 3;

164 
	mxdœ
: 2;

165 
	mdú
: 1;

166 
	mÿ
: 1;

167 
	msg
: 1;

168 
	mrg‘_id
: 3;

169 
	mch_no
: 2;

170 
	mlun
: 3;

171 
Œªsãr_d©a
 
	mPACKED
;

172 
Œªsãr_d©a_Ëngth
 
	mPACKED
;

173 
commªd_lšk
 
	mPACKED
;

174 
	mscsi_commªd_lšk_id
;

175 
	mnumb”_of_sg_li¡
;

176 
	mËngth_of_£n£_by‹
;

177 
	mËngth_of_scsi_cdbs
;

178 
	mscsi_cdbs
[12];

179 
	mad­‹r_¡©us
;

180 
	mrg‘_¡©us
;

181 
£n£_d©a
 
	mPACKED
;

184 (*
	mdÚe
)(
	mScsi_Cmnd
 *);

185 
Scsi_Cmnd
 *
	mSCšt
;

186 
uÉ¿¡Ü_sg_li¡
 
	msgli¡
[
ULTRASTOR_14F_MAX_SG
];

191 
	#U14F_PRODUCT_ID
(
pÜt
è(ÕÜtè+ 0x4)

	)

192 
	#CONFIG
(
pÜt
è(ÕÜtè+ 0x6)

	)

195 
	#LCL_DOORBELL_MASK
(
pÜt
è(ÕÜtè+ 0x0)

	)

196 
	#LCL_DOORBELL_INTR
(
pÜt
è(ÕÜtè+ 0x1)

	)

197 
	#SYS_DOORBELL_MASK
(
pÜt
è(ÕÜtè+ 0x2)

	)

198 
	#SYS_DOORBELL_INTR
(
pÜt
è(ÕÜtè+ 0x3)

	)

210 
	suÉ¿¡Ü_cÚfig


212 
	mpÜt_add»ss
;

213 
	mdoÜb–l_add»ss
;

214 
	mogm_add»ss
;

215 
	micm_add»ss
;

216 cÚ¡ *
	mbios_£gm’t
;

217 
	mš‹¼u±
: 4;

218 
	mdma_chªÃl
: 3;

219 
	mbios_drive_numb”
: 1;

220 
	mh—ds
;

221 
	m£ùÜs
;

222 
	mha_scsi_id
: 3;

223 
	msubv”siÚ
: 4;

224 
	m»visiÚ
;

227 
	m¦Ù
;

229 #ifdeà
PRINT_U24F_VERSION


230 vŞ©
	mcsœ_dÚe
;

234 
	mho¡_numb”
;

240 #ià
ULTRASTOR_MAX_CMDS
 == 1

241 
	mmsı_busy
;

243 
	mmsı_ä“
;

245 vŞ©
	mabÜ‹d
[
ULTRASTOR_MAX_CMDS
];

246 
msı
 
	mmsı
[
ULTRASTOR_MAX_CMDS
];

247 } 
	gcÚfig
 = {0};

250 
	guÉ¿¡Ü_bus_»£t
 = 0;

254 cÚ¡ *cÚ¡ 
	gbios_£gm’t_bË
[8] = {

255 
NULL
, (*)0xC4000, (*)0xC8000, (*)0xCC000,

260 cÚ¡ 
	gš‹¼u±_bË_14f
[4] = { 15, 14, 11, 10 };

263 cÚ¡ 
	gdma_chªÃl_bË_14f
[4] = { 5, 6, 7, 0 };

267 
	mh—ds
;

268 
	m£ùÜs
;

269 } 
	gm­pšg_bË
[4] = { { 16, 63 }, { 64, 32 }, { 64, 63 }, { 64, 32 } };

271 #iâdeà
PORT_OVERRIDE


273 cÚ¡ 
	guÉ¿¡Ü_pÜts_14f
[] = {

278 
uÉ¿¡Ü_š‹¼u±
(
ıl
);

279 
šlše
 
bud_sg_li¡
(
msı
 *, 
Scsi_Cmnd
 *
SC²t
);

282 
šlše
 
	$fšd_ªd_ş—r_b™_16
(*
f›ld
)

284 
rv
;

285 
	`şi
();

286 ià(*
f›ld
 =ğ0è
	`·nic
("No free mscp");

287 
	`asm
("xorl %0,%0\n0:\tbsfw %1,%w0\n\tbtr %0,%1\n\tjnc 0b"

288 : "=&r" (
rv
), "=m" (*
f›ld
) : "1" (*field));

289 
	`¡i
();

290  
rv
;

291 
	}
}

296 
šlše
 
	$xchgb
(
»g
,

297 vŞ©*
mem
)

299 
	`asm
("xchgb %0,%1" :

300 "ô" (
»g
), "=m" (*(*)
mem
) :

301 "0" (
»g
), "1" (*(*)
mem
));

302  
»g
;

303 
	}
}

305 #ià
ULTRASTOR_DEBUG
 & (
UD_COMMAND
 | 
UD_ABORT
)

307 
	$log_uÉ¿¡Ü_abÜt
(
uÉ¿¡Ü_cÚfig
 *
cÚfig
,

308 
commªd
)

310 
fmt
[80] = "abort %d (%x); MSCP free…ool: %x;";

311 
i
;

312 
æags
;

313 
	`§ve_æags
(
æags
);

314 
	`şi
();

316 
i
 = 0; i < 
ULTRASTOR_MAX_CMDS
; i++)

318 
fmt
[20 + 
i
*2] = ' ';

319 ià(! (
cÚfig
->
msı_ä“
 & (1 << 
i
)))

320 
fmt
[21 + 
i
*2] = '0' + 
cÚfig
->
msı
[i].
rg‘_id
;

322 
fmt
[21 + 
i
*2] = '-';

324 
fmt
[20 + 
ULTRASTOR_MAX_CMDS
 * 2] = '\n';

325 
fmt
[21 + 
ULTRASTOR_MAX_CMDS
 * 2] = 0;

326 
	`´štk
(
fmt
, 
commªd
, &
cÚfig
->
msı
[commªd], cÚfig->
msı_ä“
);

327 
	`»¡Üe_æags
(
æags
);

328 
	}
}

331 
	$uÉ¿¡Ü_14f_d‘eù
(
ho¡num
)

333 
size_t
 
i
;

334 
š_by‹
, 
v”siÚ_by‹
 = 0;

335 
	scÚfig_1
 {

336 
bios_£gm’t
: 3;

337 
»movabË_disks_as_fixed
: 1;

338 
š‹¼u±
: 2;

339 
dma_chªÃl
: 2;

340 } 
cÚfig_1
;

341 
	scÚfig_2
 {

342 
ha_scsi_id
: 3;

343 
m­pšg_mode
: 2;

344 
bios_drive_numb”
: 1;

345 
tä_pÜt
: 2;

346 } 
cÚfig_2
;

348 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

349 
	`´štk
("US14F: detect: called\n");

353 ià(
cÚfig
.
bios_£gm’t
)

354  
FALSE
;

356 #ifdeà
PORT_OVERRIDE


357 if(
	`check_»giÚ
(
PORT_OVERRIDE
, 0xc)) {

358 
	`´štk
("Ultrastor I/O space‡lready in use\n");

359  
FALSE
;

361 
cÚfig
.
pÜt_add»ss
 = 
PORT_OVERRIDE
;

363 
i
 = 0; i < 
	`ARRAY_SIZE
(
uÉ¿¡Ü_pÜts_14f
); i++) {

364 if(
	`check_»giÚ
(
uÉ¿¡Ü_pÜts_14f
[
i
], 0x0c)) ;

365 
cÚfig
.
pÜt_add»ss
 = 
uÉ¿¡Ü_pÜts_14f
[
i
];

368 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

369 
	`´štk
("US14F: d‘eù:e¡šg…Üˆadd»s %03X\n", 
cÚfig
.
pÜt_add»ss
);

372 
š_by‹
 = 
	`šb
(
	`U14F_PRODUCT_ID
(
cÚfig
.
pÜt_add»ss
));

373 ià(
š_by‹
 !ğ
US14F_PRODUCT_ID_0
) {

374 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

375 #ifdeà
PORT_OVERRIDE


376 
	`´štk
("US14F: d‘eù: wrÚg…roduù ID 0 - %02X\n", 
š_by‹
);

378 
	`´štk
("US14F: d‘eù:‚Øad­‹¸©…Üˆ%03X\n", 
cÚfig
.
pÜt_add»ss
);

381 #ifdeà
PORT_OVERRIDE


382  
FALSE
;

387 
š_by‹
 = 
	`šb
(
	`U14F_PRODUCT_ID
(
cÚfig
.
pÜt_add»ss
) + 1);

389 ià((
š_by‹
 & 0xF0è!ğ
US14F_PRODUCT_ID_1
) {

390 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

391 #ifdeà
PORT_OVERRIDE


392 
	`´štk
("US14F: d‘eù: wrÚg…roduù ID 1 - %02X\n", 
š_by‹
);

394 
	`´štk
("US14F: d‘eù:‚Øad­‹¸©…Üˆ%03X\n", 
cÚfig
.
pÜt_add»ss
);

397 #ifdeà
PORT_OVERRIDE


398  
FALSE
;

403 
v”siÚ_by‹
 = 
š_by‹
;

404 #iâdeà
PORT_OVERRIDE


407 ià(
i
 =ğ
	`ARRAY_SIZE
(
uÉ¿¡Ü_pÜts_14f
)) {

408 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

409 
	`´štk
("US14F: detect:‚o…ort‡ddress found!\n");

411  
FALSE
;

415 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

416 
	`´štk
("US14F: detect:‡dapter found‡t…ort‡ddress %03X\n",

417 
cÚfig
.
pÜt_add»ss
);

422 
	`outb
(
uÉ¿¡Ü_bus_»£t
 ? 0xc2 : 0x82, 
	`LCL_DOORBELL_MASK
(
cÚfig
.
pÜt_add»ss
));

427 
	`¢¬f_»giÚ
(
cÚfig
.
pÜt_add»ss
, 0x0c);

429 *(*)&
cÚfig_1
 = 
	`šb
(
	`CONFIG
(
cÚfig
.
pÜt_add»ss
 + 0));

430 *(*)&
cÚfig_2
 = 
	`šb
(
	`CONFIG
(
cÚfig
.
pÜt_add»ss
 + 1));

431 
cÚfig
.
bios_£gm’t
 = 
bios_£gm’t_bË
[
cÚfig_1
.bios_segment];

432 
cÚfig
.
doÜb–l_add»ss
 = cÚfig.
pÜt_add»ss
;

433 
cÚfig
.
ogm_add»ss
 = cÚfig.
pÜt_add»ss
 + 0x8;

434 
cÚfig
.
icm_add»ss
 = cÚfig.
pÜt_add»ss
 + 0xC;

435 
cÚfig
.
š‹¼u±
 = 
š‹¼u±_bË_14f
[
cÚfig_1
.interrupt];

436 
cÚfig
.
ha_scsi_id
 = 
cÚfig_2
.ha_scsi_id;

437 
cÚfig
.
h—ds
 = 
m­pšg_bË
[
cÚfig_2
.
m­pšg_mode
].heads;

438 
cÚfig
.
£ùÜs
 = 
m­pšg_bË
[
cÚfig_2
.
m­pšg_mode
].sectors;

439 
cÚfig
.
bios_drive_numb”
 = 
cÚfig_2
.bios_drive_number;

440 
cÚfig
.
subv”siÚ
 = (
v”siÚ_by‹
 & 0x0F);

441 ià(
cÚfig
.
subv”siÚ
 =ğ
U34F
)

442 
cÚfig
.
dma_chªÃl
 = 0;

444 
cÚfig
.
dma_chªÃl
 = 
dma_chªÃl_bË_14f
[
cÚfig_1
.dma_channel];

446 ià(!
cÚfig
.
bios_£gm’t
) {

447 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

448 
	`´štk
("US14F: detect:‚ot detected.\n");

450  
FALSE
;

454 ià(
cÚfig
.
subv”siÚ
 !ğ
U34F
)

455 ià(!
cÚfig
.
dma_chªÃl
 || !(
cÚfig_2
.
tä_pÜt
 & 0x2)) {

456 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

457 
	`´štk
("US14F: detect: consistancy check failed\n");

459  
FALSE
;

467 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

468 
	`´štk
("US14F: detect: detect succeeded\n"

475 
cÚfig
.
pÜt_add»ss
, cÚfig.
bios_£gm’t
, cÚfig.
š‹¼u±
,

476 
cÚfig
.
dma_chªÃl
, cÚfig.
ha_scsi_id
, cÚfig.
subv”siÚ
);

478 
cÚfig
.
ho¡_numb”
 = 
ho¡num
;

479 
scsi_ho¡s
[
ho¡num
].
this_id
 = 
cÚfig
.
ha_scsi_id
;

480 
scsi_ho¡s
[
ho¡num
].
unchecked_i§_dma
 = (
cÚfig
.
subv”siÚ
 !ğ
U34F
);

482 #ià
ULTRASTOR_MAX_CMDS
 > 1

483 
cÚfig
.
msı_ä“
 = ~0;

486 ià(
	`»que¡_œq
(
cÚfig
.
š‹¼u±
, 
uÉ¿¡Ü_š‹¼u±
)) {

487 
	`´štk
("Unableo‡llocate IRQ%u for UltraStor controller.\n",

488 
cÚfig
.
š‹¼u±
);

489  
FALSE
;

491 ià(
cÚfig
.
dma_chªÃl
 && 
	`»que¡_dma
(config.dma_channel)) {

492 
	`´štk
("Unableo‡llocate DMA channel %u for UltraStor controller.\n",

493 
cÚfig
.
dma_chªÃl
);

494 
	`ä“_œq
(
cÚfig
.
š‹¼u±
);

495  
FALSE
;

497 
scsi_ho¡s
[
ho¡num
].
sg_bËsize
 = 
ULTRASTOR_14F_MAX_SG
;

498 
	`´štk
("UÉ¿StÜ driv” v”siÚ" 
VERSION
 ". Using %d SG†ists.\n",

499 
ULTRASTOR_14F_MAX_SG
);

501  
TRUE
;

504 
	`uÉ¿¡Ü_24f_d‘eù
(
ho¡num
)

506 
i
;

508 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

509 
	`´štk
("US24F: detect");

513 
i
 = 1; i < 15; i++)

515 
cÚfig_1
, 
cÚfig_2
;

516 
addr
 = (
i
 << 12è| 
ULTRASTOR_24F_PORT
;

518 ià(
	`šb
(
addr
è!ğ
US24F_PRODUCT_ID_0
 &&

519 
	`šb
(
addr
+1è!ğ
US24F_PRODUCT_ID_1
 &&

520 
	`šb
(
addr
+2è!ğ
US24F_PRODUCT_ID_2
)

523 
cÚfig
.
»visiÚ
 = 
	`šb
(
addr
+3);

524 
cÚfig
.
¦Ù
 = 
i
;

525 ià(! (
	`šb
(
addr
+4) & 1))

527 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

528 
	`´štk
("U24F: found di§bËd c¬d iÀ¦Ù %u\n", 
i
);

532 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

533 
	`´štk
("U24F: found c¬d iÀ¦Ù %u\n", 
i
);

535 
cÚfig_1
 = 
	`šb
(
addr
 + 5);

536 
cÚfig
.
bios_£gm’t
 = 
bios_£gm’t_bË
[
cÚfig_1
 & 7];

537 
cÚfig_1
 >> 4)

540 
cÚfig
.
š‹¼u±
 = 15;

543 
cÚfig
.
š‹¼u±
 = 14;

546 
cÚfig
.
š‹¼u±
 = 11;

549 
cÚfig
.
š‹¼u±
 = 10;

552 
	`´štk
("U24F: invalid IRQ\n");

553  
FALSE
;

555 ià(
	`»que¡_œq
(
cÚfig
.
š‹¼u±
, 
uÉ¿¡Ü_š‹¼u±
))

557 
	`´štk
("Unableo‡llocate IRQ%u for UltraStor controller.\n",

558 
cÚfig
.
š‹¼u±
);

559  
FALSE
;

563 
cÚfig
.
pÜt_add»ss
 = 
addr
;

564 
cÚfig
.
doÜb–l_add»ss
 = 
addr
 + 12;

565 
cÚfig
.
ogm_add»ss
 = 
addr
 + 0x17;

566 
cÚfig
.
icm_add»ss
 = 
addr
 + 0x1C;

567 
cÚfig_2
 = 
	`šb
(
addr
 + 7);

568 
cÚfig
.
ha_scsi_id
 = 
cÚfig_2
 & 7;

569 
cÚfig
.
h—ds
 = 
m­pšg_bË
[(
cÚfig_2
 >> 3) & 3].heads;

570 
cÚfig
.
£ùÜs
 = 
m­pšg_bË
[(
cÚfig_2
 >> 3) & 3].sectors;

571 #ià(
ULTRASTOR_DEBUG
 & 
UD_DETECT
)

572 
	`´štk
("US24F: detect: detect succeeded\n"

577 
cÚfig
.
pÜt_add»ss
, cÚfig.
bios_£gm’t
,

578 
cÚfig
.
š‹¼u±
, cÚfig.
ha_scsi_id
);

580 
cÚfig
.
ho¡_numb”
 = 
ho¡num
;

581 
scsi_ho¡s
[
ho¡num
].
this_id
 = 
cÚfig
.
ha_scsi_id
;

582 
scsi_ho¡s
[
ho¡num
].
unchecked_i§_dma
 = 0;

583 
scsi_ho¡s
[
ho¡num
].
sg_bËsize
 = 
ULTRASTOR_14F_MAX_SG
;

585 #ià
ULTRASTOR_MAX_CMDS
 > 1

586 
cÚfig
.
msı_ä“
 = ~0;

589 
	`outb
(0, 
addr
 + 0x16);

590 
	`outb
(0, 
addr
 + 0x1B);

594 
	`outb
(
uÉ¿¡Ü_bus_»£t
 ? 0xc2 : 0x82, 
	`LCL_DOORBELL_MASK
(
addr
+12));

595 
	`outb
(0x02, 
	`SYS_DOORBELL_MASK
(
addr
+12));

596 
	`´štk
("UÉ¿StÜ driv” v”siÚ " 
VERSION
 ". Using %d SG†ists.\n",

597 
ULTRASTOR_14F_MAX_SG
);

598  
TRUE
;

600  
FALSE
;

603 
	`uÉ¿¡Ü_d‘eù
(
ho¡num
)

605  
	`uÉ¿¡Ü_14f_d‘eù
(
ho¡num
è|| 
	`uÉ¿¡Ü_24f_d‘eù
(hostnum);

608 cÚ¡ *
	`uÉ¿¡Ü_šfo
()

610 
buf
[64];

612 ià(
cÚfig
.
¦Ù
)

613 
	`¥rštf
(
buf
, "UltraStor 24F SCSI @ Slot %u IRQ%u\n",

614 
cÚfig
.
¦Ù
, cÚfig.
š‹¼u±
);

615 ià(
cÚfig
.
subv”siÚ
)

616 
	`¥rštf
(
buf
, "UltraStor 34F SCSI @ Port %03X BIOS %05X IRQ%u\n",

617 
cÚfig
.
pÜt_add»ss
, ()cÚfig.
bios_£gm’t
,

618 
cÚfig
.
š‹¼u±
);

620 
	`¥rštf
(
buf
, "UltraStor 14F SCSI @ Port %03X BIOS %05X IRQ%u DMA%u\n",

621 
cÚfig
.
pÜt_add»ss
, ()cÚfig.
bios_£gm’t
,

622 
cÚfig
.
š‹¼u±
, cÚfig.
dma_chªÃl
);

623  
buf
;

626 
šlše
 
	`bud_sg_li¡
(
msı
 *msı, 
Scsi_Cmnd
 *
SC²t
)

628 
sÿ‰”li¡
 *
¦
;

629 
Œªsãr_Ëngth
 = 0;

630 
i
, 
max
;

632 
¦
 = (
sÿ‰”li¡
 *è
SC²t
->
»que¡_bufãr
;

633 
max
 = 
SC²t
->
u£_sg
;

634 
i
 = 0; i < 
max
; i++) {

635 
msı
->
sgli¡
[
i
].
add»ss
 = ()
¦
[i].address;

636 
msı
->
sgli¡
[
i
].
num_by‹s
 = 
¦
[i].
Ëngth
;

637 
Œªsãr_Ëngth
 +ğ
¦
[
i
].
Ëngth
;

639 
msı
->
numb”_of_sg_li¡
 = 
max
;

640 
msı
->
Œªsãr_d©a
 = ()msı->
sgli¡
;

644 
msı
->
Œªsãr_d©a_Ëngth
 = 
Œªsãr_Ëngth
;

647 
	`uÉ¿¡Ü_queuecommªd
(
Scsi_Cmnd
 *
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

649 
msı
 *
my_msı
;

650 #ià
ULTRASTOR_MAX_CMDS
 > 1

651 
msı_šdex
;

653 
¡©us
;

654 
æags
;

657 ià((
cÚfig
.
msı_ä“
 & ((1U << 
ULTRASTOR_MAX_CMDS
) - 1)) == 0)

658 
	`·nic
("ultrastor_queuecommand:‚o free MSCP\n");

659 
msı_šdex
 = 
	`fšd_ªd_ş—r_b™_16
(&
cÚfig
.
msı_ä“
);

662 ià(
	`xchgb
(0xff, &
cÚfig
.
abÜ‹d
[
msı_šdex
]) != 0)

664 
¡©us
 = 
DID_ABORT
 << 16;

665 
abÜ‹d
;

668 
my_msı
 = &
cÚfig
.
msı
[
msı_šdex
];

672 *(*)
my_msı
 = 
OP_SCSI
 | (
DTD_SCSI
 << 3);

674 
my_msı
->
İcode
 = 
OP_SCSI
;

675 
my_msı
->
xdœ
 = 
DTD_SCSI
;

676 
my_msı
->
dú
 = 
FALSE
;

685 
my_msı
->
ÿ
 = 
scsi_deviûs
[
SC²t
->
šdex
].
ty³
 !ğ
TYPE_TAPE
;

686 
my_msı
->
rg‘_id
 = 
SC²t
->
rg‘
;

687 
my_msı
->
ch_no
 = 0;

688 
my_msı
->
lun
 = 
SC²t
->lun;

689 ià(
SC²t
->
u£_sg
) {

691 
my_msı
->
sg
 = 
TRUE
;

692 
	`bud_sg_li¡
(
my_msı
, 
SC²t
);

695 
my_msı
->
sg
 = 
FALSE
;

696 
my_msı
->
Œªsãr_d©a
 = ()
SC²t
->
»que¡_bufãr
;

697 
my_msı
->
Œªsãr_d©a_Ëngth
 = 
SC²t
->
»que¡_bufæ’
;

699 
my_msı
->
commªd_lšk
 = 0;

700 
my_msı
->
scsi_commªd_lšk_id
 = 0;

701 
my_msı
->
Ëngth_of_£n£_by‹
 =  
SC²t
->
£n£_bufãr
;

702 
my_msı
->
Ëngth_of_scsi_cdbs
 = 
	`COMMAND_SIZE
(*(*)
SC²t
->
cmnd
);

703 
	`memıy
(
my_msı
->
scsi_cdbs
, 
SC²t
->
cmnd
, my_msı->
Ëngth_of_scsi_cdbs
);

704 
my_msı
->
ad­‹r_¡©us
 = 0;

705 
my_msı
->
rg‘_¡©us
 = 0;

706 
my_msı
->
£n£_d©a
 = ()&
SC²t
->
£n£_bufãr
;

707 
my_msı
->
dÚe
 = done;

708 
my_msı
->
SCšt
 = 
SC²t
;

709 
SC²t
->
ho¡_süibbË
 = (*)
my_msı
;

714 
»Œy
:

715 ià(
cÚfig
.
¦Ù
)

716 
	`šb
(
cÚfig
.
ogm_add»ss
 - 1) != 0 &&

717 
cÚfig
.
abÜ‹d
[
msı_šdex
] == 0xff);

721 (
	`šb
(
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
)) &

722 (
cÚfig
.
¦Ù
 ? 2 : 1))

723 && 
cÚfig
.
abÜ‹d
[
msı_šdex
] == 0xff);

728 
	`§ve_æags
(
æags
);

729 
	`şi
();

731 ià(
	`šb
(
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
)) &

732 (
cÚfig
.
¦Ù
 ? 2 : 1))

734 
	`»¡Üe_æags
(
æags
);

735 
»Œy
;

738 
¡©us
 = 
	`xchgb
(0, &
cÚfig
.
abÜ‹d
[
msı_šdex
]);

739 ià(
¡©us
 != 0xff) {

740 
	`»¡Üe_æags
(
æags
);

742 #ià
ULTRASTOR_DEBUG
 & (
UD_COMMAND
 | 
UD_ABORT
)

743 
	`´štk
("USx4F: queuecommand:‡borted\n");

744 #ià
ULTRASTOR_MAX_CMDS
 > 1

745 
	`log_uÉ¿¡Ü_abÜt
(&
cÚfig
, 
msı_šdex
);

748 
¡©us
 <<= 16;

750 
abÜ‹d
:

751 
	`£t_b™
(
msı_šdex
, &
cÚfig
.
msı_ä“
);

754 #ià
ULTRASTOR_MAX_CMDS
 > 1

755 
SC²t
->
»suÉ
 = 
¡©us
;

756 
	`dÚe
(
SC²t
);

759  
¡©us
;

764 
	`ou
(()
my_msı
, 
cÚfig
.
ogm_add»ss
);

767 ià(
cÚfig
.
¦Ù
) {

769 
	`outb
(1, 
cÚfig
.
ogm_add»ss
 - 1);

770 
	`outb
(0x2, 
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

772 
	`outb
(0x1, 
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

775 
	`»¡Üe_æags
(
æags
);

777 #ià(
ULTRASTOR_DEBUG
 & 
UD_COMMAND
)

778 
	`´štk
("USx4F: queuecommand:„eturning\n");

799 
	`uÉ¿¡Ü_abÜt
(
Scsi_Cmnd
 *
SC²t
, 
code
)

801 #ià
ULTRASTOR_DEBUG
 & 
UD_ABORT


802 
out
[108];

803 
icm_¡©us
 = 0, 
ogm_¡©us
 = 0;

804 
icm_addr
 = 0, 
ogm_addr
 = 0;

806 
msı_šdex
;

807 
Şd_abÜ‹d
;

808 (*
dÚe
)(
Scsi_Cmnd
 *);

810 if(
cÚfig
.
¦Ù
)  0;

812 
msı_šdex
 = ((
msı
 *)
SC²t
->
ho¡_süibbË
è- 
cÚfig
.mscp;

813 ià(
msı_šdex
 >ğ
ULTRASTOR_MAX_CMDS
)

814 
	`·nic
("Ux4F‡borting invalid MSCP");

816 #ià
ULTRASTOR_DEBUG
 & 
UD_ABORT


817 ià(
cÚfig
.
¦Ù
)

819 
pÜt0
 = (
cÚfig
.
¦Ù
 << 12) | 0xc80;

820 
i
;

821 
æags
;

822 
	`§ve_æags
(
æags
);

823 
	`şi
();

824 
	`¡rıy
(
out
, "OGM %d:%x ICM %d:%x…orts: ");

825 
i
 = 0; i < 16; i++)

827 
p
 = 
	`šb
(
pÜt0
 + 
i
);

828 
out
[28 + 
i
 * 3] = "0123456789abcdef"[
p
 >> 4];

829 
out
[29 + 
i
 * 3] = "0123456789abcdef"[
p
 & 15];

830 
out
[30 + 
i
 * 3] = ' ';

832 
out
[28 + 
i
 * 3] = '\n';

833 
out
[29 + 
i
 * 3] = 0;

834 
ogm_¡©us
 = 
	`šb
(
pÜt0
 + 22);

835 
ogm_addr
 = 
	`šl
(
pÜt0
 + 23);

836 
icm_¡©us
 = 
	`šb
(
pÜt0
 + 27);

837 
icm_addr
 = 
	`šl
(
pÜt0
 + 28);

838 
	`»¡Üe_æags
(
æags
);

844 ià(
cÚfig
.
¦Ù
 ? 
	`šb
(cÚfig.
icm_add»ss
 - 1) == 2 :

845 (
	`šb
(
	`SYS_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
)) & 1))

847 
æags
;

848 
	`§ve_æags
(
æags
);

849 
	`´štk
("Ux4F:‡bort while completed command…ending\n");

850 
	`»¡Üe_æags
(
æags
);

851 
	`şi
();

852 
	`uÉ¿¡Ü_š‹¼u±
(0);

853 
	`»¡Üe_æags
(
æags
);

858 
Şd_abÜ‹d
 = 
	`xchgb
(
code
 ? cod: 
DID_ABORT
, &
cÚfig
.
abÜ‹d
[
msı_šdex
]);

862 ià(
Şd_abÜ‹d
 == 0xff)

867 ià(
cÚfig
.
¦Ù
 && 
	`šb
(cÚfig.
ogm_add»ss
 - 1) == 0)

869 
æags
;

871 
	`§ve_æags
(
æags
);

872 
	`şi
();

873 
	`ou
(()&
cÚfig
.
msı
[
msı_šdex
], cÚfig.
ogm_add»ss
);

874 
	`šb
(0xc80);

875 
	`outb
(0x80, 
cÚfig
.
ogm_add»ss
 - 1);

876 
	`outb
(0x2, 
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

877 #ià
ULTRASTOR_DEBUG
 & 
UD_ABORT


878 
	`log_uÉ¿¡Ü_abÜt
(&
cÚfig
, 
msı_šdex
);

879 
	`´štk
(
out
, 
ogm_¡©us
, 
ogm_addr
, 
icm_¡©us
, 
icm_addr
);

881 
	`»¡Üe_æags
(
æags
);

885 #ià
ULTRASTOR_DEBUG
 & 
UD_ABORT


886 
	`log_uÉ¿¡Ü_abÜt
(&
cÚfig
, 
msı_šdex
);

894 #ià
ULTRASTOR_DEBUG
 & 
UD_ABORT


895 ià(
cÚfig
.
msı
[
msı_šdex
].
SCšt
 !ğ
SC²t
)

896 
	`´štk
("abort: command mismatch, %x != %x\n",

897 
cÚfig
.
msı
[
msı_šdex
].
SCšt
, 
SC²t
);

899 ià(
cÚfig
.
msı
[
msı_šdex
].
SCšt
 == 0)

902 ià(
cÚfig
.
msı
[
msı_šdex
].
SCšt
 !ğ
SC²t
è
	`·nic
("Bad‡bort");

903 
cÚfig
.
msı
[
msı_šdex
].
SCšt
 = 0;

904 
dÚe
 = 
cÚfig
.
msı
[
msı_šdex
].done;

905 
cÚfig
.
msı
[
msı_šdex
].
dÚe
 = 0;

906 
SC²t
->
»suÉ
 = 
DID_ABORT
 << 16;

908 
	`dÚe
(
SC²t
);

915 
	`uÉ¿¡Ü_»£t
(
Scsi_Cmnd
 * 
SC²t
)

917 
æags
;

918 
i
;

919 #ià(
ULTRASTOR_DEBUG
 & 
UD_RESET
)

920 
	`´štk
("US14F:„eset: called\n");

923 if(
cÚfig
.
¦Ù
) {

924 ià(
SC²t
èSC²t->
æags
 |ğ
NEEDS_JUMPSTART
;

928 
	`§ve_æags
(
æags
);

929 
	`şi
();

933 
	`outb
(0xc0, 
	`LCL_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

934 ià(
cÚfig
.
¦Ù
)

936 
	`outb
(0, 
cÚfig
.
ogm_add»ss
 - 1);

937 
	`outb
(0, 
cÚfig
.
icm_add»ss
 - 1);

940 #ià
ULTRASTOR_MAX_CMDS
 == 1

941 ià(
cÚfig
.
msı_busy
 && cÚfig.
msı
->
dÚe
 && cÚfig.msı->
SCšt
)

943 
cÚfig
.
msı
->
SCšt
->
»suÉ
 = 
DID_RESET
 << 16;

944 
cÚfig
.
msı
->
	`dÚe
(cÚfig.msı->
SCšt
);

946 
cÚfig
.
msı
->
SCšt
 = 0;

948 
i
 = 0; i < 
ULTRASTOR_MAX_CMDS
; i++)

950 ià(! (
cÚfig
.
msı_ä“
 & (1 << 
i
)) &&

951 
cÚfig
.
msı
[
i
].
dÚe
 && cÚfig.msı[i].
SCšt
)

953 
cÚfig
.
msı
[
i
].
SCšt
->
»suÉ
 = 
DID_RESET
 << 16;

954 
cÚfig
.
msı
[
i
].
	`dÚe
(cÚfig.msı[i].
SCšt
);

955 
cÚfig
.
msı
[
i
].
dÚe
 = 0;

957 
cÚfig
.
msı
[
i
].
SCšt
 = 0;

961 
	`mem£t
((*)
cÚfig
.
abÜ‹d
, 0,  config.aborted);

962 #ià
ULTRASTOR_MAX_CMDS
 == 1

963 
cÚfig
.
msı_busy
 = 0;

965 
cÚfig
.
msı_ä“
 = ~0;

968 
	`»¡Üe_æags
(
æags
);

973 
	`uÉ¿¡Ü_bio¥¬am
(
size
, 
dev
, * 
dkšfo
)

975 
s
 = 
cÚfig
.
h—ds
 * cÚfig.
£ùÜs
;

977 
dkšfo
[0] = 
cÚfig
.
h—ds
;

978 
dkšfo
[1] = 
cÚfig
.
£ùÜs
;

979 
dkšfo
[2] = 
size
 / 
s
;

981 ià(
dkšfo
[2] > 1024)

982 
dkšfo
[2] = 1024;

987 
	`uÉ¿¡Ü_š‹¼u±
(
ıl
)

989 
¡©us
;

990 #ià
ULTRASTOR_MAX_CMDS
 > 1

991 
msı_šdex
;

993 
msı
 *mscp;

994 (*
dÚe
)(
Scsi_Cmnd
 *);

995 
Scsi_Cmnd
 *
SCtmp
;

997 #ià
ULTRASTOR_MAX_CMDS
 == 1

998 
msı
 = &
cÚfig
.mscp[0];

1000 
msı
 = (msı *)
	`šl
(
cÚfig
.
icm_add»ss
);

1001 
msı_šdex
 = 
msı
 - 
cÚfig
.mscp;

1002 ià(
msı_šdex
 >ğ
ULTRASTOR_MAX_CMDS
) {

1003 
	`´štk
("Ux4F iÁ”ru±: bad MSCP‡dd»s %x\n", (è
msı
);

1006 
	`uÉ¿¡Ü_»£t
(
NULL
);

1012 ià(
cÚfig
.
¦Ù
) {

1013 
icm_¡©us
 = 
	`šb
(
cÚfig
.
icm_add»ss
 - 1);

1014 #ià
ULTRASTOR_DEBUG
 & (
UD_INTERRUPT
|
UD_ERROR
|
UD_ABORT
)

1015 ià(
icm_¡©us
 != 1 && icm_status != 2)

1016 
	`´štk
("US24F: ICM stu %x fÜ MSCP %d (%x)\n", 
icm_¡©us
,

1017 
msı_šdex
, (è
msı
);

1021 
	`outb
(2, 
	`SYS_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

1022 
	`outb
(0, 
cÚfig
.
icm_add»ss
 - 1);

1023 ià(
icm_¡©us
 == 4) {

1024 
	`´štk
("UltraStor‡bort command failed\n");

1027 ià(
icm_¡©us
 == 3) {

1028 (*
dÚe
)(
Scsi_Cmnd
 *èğ
msı
->done;

1029 ià(
dÚe
) {

1030 
msı
->
dÚe
 = 0;

1031 
msı
->
SCšt
->
»suÉ
 = 
DID_ABORT
 << 16;

1032 
	`dÚe
(
msı
->
SCšt
);

1037 
	`outb
(1, 
	`SYS_DOORBELL_INTR
(
cÚfig
.
doÜb–l_add»ss
));

1040 
SCtmp
 = 
msı
->
SCšt
;

1041 
msı
->
SCšt
 = 
NULL
;

1043 ià(
SCtmp
 == 0)

1045 #ià
ULTRASTOR_DEBUG
 & (
UD_ABORT
|
UD_INTERRUPT
)

1046 
	`´štk
("MSCP %d (%x):‚Øcommªd\n", 
msı_šdex
, (è
msı
);

1048 #ià
ULTRASTOR_MAX_CMDS
 == 1

1049 
cÚfig
.
msı_busy
 = 
FALSE
;

1051 
	`£t_b™
(
msı_šdex
, &
cÚfig
.
msı_ä“
);

1053 
cÚfig
.
abÜ‹d
[
msı_šdex
] = 0;

1060 
dÚe
 = 
msı
->done;

1061 
msı
->
dÚe
 = 0;

1064 
msı
->
ad­‹r_¡©us
)

1067 
¡©us
 = 
DID_OK
 << 16;

1073 
¡©us
 = 
DID_ERROR
 << 16;

1076 
¡©us
 = 
DID_ABORT
 << 16;

1079 
¡©us
 = 
DID_TIME_OUT
 << 16;

1083 
SCtmp
->
»suÉ
 = 
¡©us
 | 
msı
->
rg‘_¡©us
;

1085 
SCtmp
->
ho¡_süibbË
 = 0;

1088 #ià
ULTRASTOR_MAX_CMDS
 == 1

1089 
cÚfig
.
msı_busy
 = 
FALSE
;

1091 
	`£t_b™
(
msı_šdex
, &
cÚfig
.
msı_ä“
);

1094 #ià
ULTRASTOR_DEBUG
 & (
UD_ABORT
|
UD_INTERRUPT
)

1095 ià(
cÚfig
.
abÜ‹d
[
msı_šdex
])

1096 
	`´štk
("Ux4 interrupt: MSCP %d (%x)‡borted = %d\n",

1097 
msı_šdex
, (è
msı
, 
cÚfig
.
abÜ‹d
[mscp_index]);

1099 
cÚfig
.
abÜ‹d
[
msı_šdex
] = 0;

1101 ià(
dÚe
)

1102 
	`dÚe
(
SCtmp
);

1104 
	`´štk
("US14F: interrupt: unexpected interrupt\n");

1106 ià(
cÚfig
.
¦Ù
 ? 
	`šb
(cÚfig.
icm_add»ss
 - 1è: (šb(
	`SYS_DOORBELL_INTR
(cÚfig.
doÜb–l_add»ss
)) & 1))

1107 
	`´štk
("Ux4F: multiple commands completed\n");

1109 #ià(
ULTRASTOR_DEBUG
 & 
UD_INTERRUPT
)

1110 
	`´štk
("USx4F: interrupt:„eturning\n");

	@drivers/scsi/ultrastor.h

13 #iâdeà
_ULTRASTOR_H


14 
	#_ULTRASTOR_H


	)

16 
uÉ¿¡Ü_d‘eù
();

17 cÚ¡ *
uÉ¿¡Ü_šfo
();

18 
uÉ¿¡Ü_queuecommªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

19 
	`uÉ¿¡Ü_abÜt
(
Scsi_Cmnd
 *, );

20 
	`uÉ¿¡Ü_»£t
(
Scsi_Cmnd
 *);

21 
	`uÉ¿¡Ü_bio¥¬am
(, , *);

23 
	#ULTRASTOR_14F_MAX_SG
 16

	)

24 
	#ULTRASTOR_MAX_CMDS_PER_LUN
 5

	)

25 
	#ULTRASTOR_MAX_CMDS
 16

	)

27 
	#ULTRASTOR_24F_PORT
 0xC80

	)

30 
	#ULTRASTOR_14F
 \

31 { "UÉ¿StÜ 14F/24F/34F", 
uÉ¿¡Ü_d‘eù
, 
uÉ¿¡Ü_šfo
, 0, \

32 
uÉ¿¡Ü_queuecommªd
, 
uÉ¿¡Ü_abÜt
, 
uÉ¿¡Ü_»£t
, \

33 0, 
uÉ¿¡Ü_bio¥¬am
, 
ULTRASTOR_MAX_CMDS
, 0, \

34 
ULTRASTOR_14F_MAX_SG
, 
ULTRASTOR_MAX_CMDS_PER_LUN
, 0, 1 
	}

	)
}

37 #ifdeà
ULTRASTOR_PRIVATE


39 
	#UD_ABORT
 0x0001

	)

40 
	#UD_COMMAND
 0x0002

	)

41 
	#UD_DETECT
 0x0004

	)

42 
	#UD_INTERRUPT
 0x0008

	)

43 
	#UD_RESET
 0x0010

	)

44 
	#UD_MULTI_CMD
 0x0020

	)

45 
	#UD_CSIR
 0x0040

	)

46 
	#UD_ERROR
 0x0080

	)

51 
	#US14F_PRODUCT_ID_0
 0x56

	)

52 
	#US14F_PRODUCT_ID_1
 0x40

	)

54 
	#US24F_PRODUCT_ID_0
 0x56

	)

55 
	#US24F_PRODUCT_ID_1
 0x63

	)

56 
	#US24F_PRODUCT_ID_2
 0x02

	)

59 
	#U14F
 0

	)

60 
	#U34F
 1

	)

65 
	#OP_HOST_ADAPTER
 0x1

	)

66 
	#OP_SCSI
 0x2

	)

67 
	#OP_RESET
 0x4

	)

70 
	#DTD_SCSI
 0x0

	)

71 
	#DTD_IN
 0x1

	)

72 
	#DTD_OUT
 0x2

	)

73 
	#DTD_NONE
 0x3

	)

76 
	#HA_CMD_INQUIRY
 0x1

	)

77 
	#HA_CMD_SELF_DIAG
 0x2

	)

78 
	#HA_CMD_READ_BUFF
 0x3

	)

79 
	#HA_CMD_WRITE_BUFF
 0x4

	)

	@drivers/scsi/wd7000.c

14 
	~<¡d¬g.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/h—d.h
>

17 
	~<lšux/ty³s.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/sched.h
>

20 
	~<asm/sy¡em.h
>

21 
	~<asm/dma.h
>

22 
	~<asm/io.h
>

23 
	~<lšux/iİÜt.h
>

25 
	~"../block/blk.h
"

26 
	~"scsi.h
"

27 
	~"ho¡s.h
"

31 
	~"wd7000.h
"

34 #ifdeà
DEBUG


35 
	#DEB
(
x
è
	)
x

37 
	#DEB
(
x
)

	)

67 
wd_mabox
 
	mogmb
[
OGMB_CNT
];

68 
wd_mabox
 
	micmb
[
ICMB_CNT
];

69 } 
	gmb
;

70 
	gÃxt_ogmb
 = 0;

72 
Scb
 
	gscbs
[
MAX_SCBS
];

73 
Scb
 *
	gscbä“
 = 
NULL
;

75 
	gwd7000_ho¡
 = 0;

76 
unch¬
 
	gcÚŒŞ¡©
 = 0;

78 
unch¬
 
	g»v_1
 = 0, 
	g»v_2
 = 0;

80 
	#wd7000_šŒ_ack
(è
	`outb
(0,
INTR_ACK
)

	)

82 
	#WAITÃx‰imeout
 3000000

	)

85 
šlše
 
	$wd7000_’abË_šŒ
()

87 
cÚŒŞ¡©
 |ğ
INT_EN
;

88 
	`outb
(
cÚŒŞ¡©
,
CONTROL
);

89 
	}
}

92 
šlše
 
	$wd7000_’abË_dma
()

94 
cÚŒŞ¡©
 |ğ
DMA_EN
;

95 
	`outb
(
cÚŒŞ¡©
,
CONTROL
);

96 
	`£t_dma_mode
(
DMA_CH
, 
DMA_MODE_CASCADE
);

97 
	`’abË_dma
(
DMA_CH
);

98 
	}
}

101 
	#WAIT
(
pÜt
, 
mask
, 
®lof
, 
nÚeof
) \

102 { 
WAITb™s
; \

103 
WAITtimeout
 = 
WAITÃx‰imeout
; \

105 
WAITb™s
 = 
	`šb
(
pÜt
è& (
mask
); \

106 ià((
WAITb™s
 & (
®lof
)è=ğ×Îofè&& ((WAITb™ & (
nÚeof
)) == 0)) \

108 ià(--
WAITtimeout
 =ğ0è
ç
; \

110 }

	)

113 
šlše
 
	$d–ay
Ğ
how_lÚg
 )

115 
time
 = 
jiff›s
 + 
how_lÚg
;

117 
jiff›s
 < 
time
);

118 
	}
}

121 
šlše
 
	$commªd_out
(
unch¬
 *
cmdp
, 
Ën
)

123 
Ën
--) {

124 
	`WAIT
(
ASC_STAT
, 
STATMASK
, 
CMD_RDY
, 0);

125 
	`outb
(*
cmdp
++, 
COMMAND
);

129 
ç
:

130 
	`´štk
("wd7000_ouˆWAIT faed(%d): ", 
Ën
+1);

132 
	}
}

134 
šlše
 
Scb
 *
	$®loc_scb
()

136 
Scb
 *
scb
;

137 
æags
;

139 
	`§ve_æags
(
æags
);

140 
	`şi
();

142 ià(
scbä“
 =ğ
NULL
) {

143 
	`·nic
("wd7000: can't‡llocate free SCB.\n");

144 
	`»¡Üe_æags
(
æags
);

145  
NULL
;

147 
scb
 = 
scbä“
; scbä“ = scb->
Ãxt
;

148 
	`mem£t
(
scb
, 0, (
Scb
)); scb->
Ãxt
 = 
NULL
;

150 
	`»¡Üe_æags
(
æags
);

152  
scb
;

153 
	}
}

156 
šlše
 
	$ä“_scb
Ğ
Scb
 *
scb
 )

158 
æags
;

160 
	`§ve_æags
(
æags
);

161 
	`şi
();

163 
	`mem£t
(
scb
, 0, (
Scb
));

164 
scb
->
Ãxt
 = 
scbä“
; scbfree = scb;

166 
	`»¡Üe_æags
(
æags
);

167 
	}
}

170 
šlše
 
	$š™_scbs
()

172 
i
;

173 
æags
;

175 
	`§ve_æags
(
æags
);

176 
	`şi
();

178 
scbä“
 = &(
scbs
[0]);

179 
i
 = 0; i < 
MAX_SCBS
-1; i++è
scbs
[i].
Ãxt
 = &(scbs[i+1]);

180 
scbs
[
MAX_SCBS
-1].
Ãxt
 = 
NULL
;

182 
	`»¡Üe_æags
(
æags
);

183 
	}
}

186 
	$ma_out
Ğ
Scb
 *
scb±r
 )

191 
i
, 
ogmb
;

192 
æags
;

194 
	`DEB
(
	`´štk
("wd7000_scb_out: %06x");)

197 
	`§ve_æags
(
æags
);

198 
	`şi
();

199 
ogmb
 = 
Ãxt_ogmb
;

200 
i
 = 0; i < 
OGMB_CNT
; i++) {

201 ià(
mb
.
ogmb
[ogmb].
¡©us
 == 0) {

202 
	`DEB
(
	`´štk
(" usšg OGMB %x",
ogmb
));

203 
mb
.
ogmb
[ogmb].
¡©us
 = 1;

204 
	`ªy2scsi
(
mb
.
ogmb
[ogmb].
scb±r
, scbptr);

206 
Ãxt_ogmb
 = (
ogmb
+1è% 
OGMB_CNT
;

209 
ogmb
 = (++ogmbè% 
OGMB_CNT
;

211 
	`»¡Üe_æags
(
æags
);

212 
	`DEB
(
	`´štk
(", scb i %x",
scb±r
);)

214 ià(
i
 >ğ
OGMB_CNT
) {

215 
	`DEB
(
	`´štk
(",‚o free OGMBs.\n");)

220 
	`wd7000_’abË_šŒ
();

222 
	`WAIT
(
ASC_STAT
,
STATMASK
,
CMD_RDY
,0);

223 
	`outb
(
START_OGMB
|
ogmb
, 
COMMAND
);

224 
	`WAIT
(
ASC_STAT
,
STATMASK
,
CMD_RDY
,0);

225 } 
	`šb
(
ASC_STAT
è& 
CMD_REJ
);

227 
	`DEB
(
	`´štk
(",‡waiting interrupt.\n");)

230 
ç
:

231 
	`DEB
(
	`´štk
(", WAITimed out.\n");)

233 
	}
}

236 
	$make_code
(
ho¡”r
, 
scs›¼
)

238 #ifdeà
DEBUG


239 
š_”rÜ
 = 
ho¡”r
;

242 (
ho¡”r
>>8)&0xff){

244 
ho¡”r
 = 
DID_ERROR
;

247 
ho¡”r
 = 
DID_OK
;

250 
ho¡”r
 = 
DID_OK
;

253 
ho¡”r
 = 
DID_TIME_OUT
;

256 
ho¡”r
 = 
DID_RESET
;

259 
ho¡”r
 = 
DID_BAD_TARGET
;

263 
ho¡”r
 = 
DID_BAD_INTR
;

266 
ho¡”r
 = 
DID_ABORT
;

270 
ho¡”r
 = 
DID_RESET
;

273 
ho¡”r
 = 
DID_ERROR
;

276 #ifdeà
DEBUG


277 ià(
scs›¼
||
ho¡”r
)

278 
	`´štk
("\nSCSI commandƒrror: SCSI %02x host %04x„eturn %d",

279 
scs›¼
,
š_”rÜ
,
ho¡”r
);

281  
scs›¼
 | (
ho¡”r
 << 16);

282 
	}
}

285 
	$wd7000_scsi_dÚe
(
Scsi_Cmnd
 * 
SC²t
)

287 
	`DEB
(
	`´štk
("wd7000_scsi_dÚe: %06x\n",
SC²t
);)

288 
SC²t
->
SCp
.
pha£
 = 0;

289 
	}
}

292 
	$wd7000_šŒ_hªdË
(
œq
)

294 
æag
, 
icmb
, 
”r¡©us
, 
icmb_¡©us
;

295 
ho¡_”rÜ
, 
scsi_”rÜ
;

296 
Scb
 *
scb
;

297 
unch¬
 *
icb
;

298 
Scsi_Cmnd
 *
SC²t
;

300 
æag
 = 
	`šb
(
INTR_STAT
);

301 
	`DEB
(
	`´štk
("wd7000_šŒ_hªdË: iÁ¸¡© = %02x",
æag
);)

303 ià(!(
	`šb
(
ASC_STAT
)&0x80)){

304 
	`DEB
(
	`´štk
("\nwd7000_intr_handle:…hantom interrupt...\n");)

305 
	`wd7000_šŒ_ack
();

310 ià((
æag
 & 0x40) == 0) {

312 
	`DEB
(
	`´štk
("wd7000_intr_handle: free outgoing mailbox\n");)

313 
	`wd7000_šŒ_ack
();

317 
icmb
 = 
æag
 & 0x3f;

318 
scb
 = (scb *è
	`scsi2št
(
mb
.
icmb
[icmb].
scb±r
);

319 
icmb_¡©us
 = 
mb
.
icmb
[icmb].
¡©us
;

320 
mb
.
icmb
[icmb].
¡©us
 = 0;

322 #ifdeà
DEBUG


323 
	`´štk
(" ICMB %d…osted for SCB/ICB %06x, status %02x, vue %02x",

324 
icmb
, 
scb
, 
icmb_¡©us
, scb->
vue
 );

327 ià(!(
scb
->
İ
 & 0x80)) {

328 
SC²t
 = 
scb
->SCpnt;

329 ià(--(
SC²t
->
SCp
.
pha£
) <= 0) {

330 
ho¡_”rÜ
 = 
scb
->
vue
 | (
icmb_¡©us
 << 8);

331 
scsi_”rÜ
 = 
scb
->
¡©us
;

332 
”r¡©us
 = 
	`make_code
(
ho¡_”rÜ
,
scsi_”rÜ
);

333 
SC²t
->
»suÉ
 = 
”r¡©us
;

335 ià(
SC²t
->
ho¡_süibbË
 !ğ
NULL
)

336 
	`scsi_ä“
(
SC²t
->
ho¡_süibbË
,
WD7000_SCRIBBLE
);

337 
	`ä“_scb
(
scb
);

339 
SC²t
->
	`scsi_dÚe
(SCpnt);

342 
icb
 = (
unch¬
 *è
scb
;

343 
icb
[
ICB_STATUS
] = 
icmb_¡©us
;

344 
icb
[
ICB_PHASE
] = 0;

347 
	`wd7000_šŒ_ack
();

348 
	`DEB
(
	`´štk
(".\n");)

350 
	}
}

353 
wd7000_queuecommªd
(
Scsi_Cmnd
 * 
SC²t
, (*
dÚe
)(Scsi_Cmnd *))

355 
Scb
 *
scb
;

356 
Sgb
 *
sgb
;

357 
unch¬
 *
cdb
;

358 
unch¬
 
idlun
;

359 
cdbËn
;

361 
cdb
 = (
unch¬
 *è
SC²t
->
cmnd
;

362 
cdbËn
 = 
	`COMMAND_SIZE
(*
cdb
);

363 
idlun
 = ((
SC²t
->
rg‘
 << 5è& 0xe0è| (SC²t->
lun
 & 7);

364 
SC²t
->
scsi_dÚe
 = 
dÚe
;

365 
SC²t
->
SCp
.
pha£
 = 1;

366 
scb
 = 
	`®loc_scb
();

367 
scb
->
idlun
 = idlun;

368 
	`memıy
(
scb
->
cdb
, cdb, 
cdbËn
);

369 
scb
->
dœec
 = 0x40;

370 
scb
->
SC²t
 = SCpnt;

371 
SC²t
->
ho¡_süibbË
 = 
NULL
;

372 
	`DEB
(
	`´štk
("request_bufflen is %x, bufflen is %x\n",\

373 
SC²t
->
»que¡_bufæ’
, SC²t->
bufæ’
);)

375 ià(
SC²t
->
u£_sg
) {

376 
sÿ‰”li¡
 *
sg
 = (sÿ‰”li¡ *è
SC²t
->
»que¡_bufãr
;

377 
i
;

379 ià(
scsi_ho¡s
[
wd7000_ho¡
].
sg_bËsize
 <= 0) {

380 
	`·nic
("wd7000_queuecommand: scatter/gather‚ot supported.\n");

382 #ifdeà
DEBUG


383 
	`´štk
("Usšg sÿ‰”/g©h” w™h %dƒËm’ts.\n",
SC²t
->
u£_sg
);

389 #ifdeà
DEBUG


390 ià(
SC²t
->
u£_sg
 > 
WD7000_SG
)

391 
	`·nic
("WD7000:„equestingoo many scatterblocks\n");

393 
SC²t
->
ho¡_süibbË
 = (*è
	`scsi_m®loc
(
WD7000_SCRIBBLE
);

394 
sgb
 = (
Sgb
 *è
SC²t
->
ho¡_süibbË
;

395 ià(
sgb
 =ğ
NULL
)

396 
	`·nic
("wd7000_queuecommand: scsi_malloc() failed.\n");

398 
scb
->
İ
 = 1;

399 
	`ªy2scsi
(
scb
->
d©­Œ
, 
sgb
);

400 
	`ªy2scsi
(
scb
->
maxËn
, 
SC²t
->
u£_sg
 *  (
Sgb
) );

402 
i
 = 0; i < 
SC²t
->
u£_sg
; i++) {

403 
	`ªy2scsi
(
sgb
->
±r
, 
sg
[
i
].
add»ss
);

404 
	`ªy2scsi
(
sgb
->
Ën
, 
sg
[
i
].
Ëngth
);

405 
sgb
++;

407 
	`DEB
(
	`´štk
("Using %d bytes for %d scatter/gather blocks\n",\

408 
	`scsi2št
(
scb
->
maxËn
), 
SC²t
->
u£_sg
);)

410 
scb
->
İ
 = 0;

411 
	`ªy2scsi
(
scb
->
d©­Œ
, 
SC²t
->
»que¡_bufãr
);

412 
	`ªy2scsi
(
scb
->
maxËn
, 
SC²t
->
»que¡_bufæ’
);

415  
	`ma_out
(
scb
);

416 
	}
}

419 
	$wd7000_commªd
(
Scsi_Cmnd
 *
SC²t
)

421 
	`wd7000_queuecommªd
(
SC²t
, 
wd7000_scsi_dÚe
);

423 
SC²t
->
SCp
.
pha£
 > 0);

425  
SC²t
->
»suÉ
;

426 
	}
}

429 
	$wd7000_š™
()

430 { 
i
;

431 
unch¬
 
š™_block
[] = {

432 
INITIALIZATION
, 7, 
BUS_ON
, 
BUS_OFF
, 0, 0, 0, 0, 
OGMB_CNT
, 
ICMB_CNT


436 
	`outb
(
SCSI_RES
|
ASC_RES
, 
CONTROL
);

437 
	`d–ay
(1);

438 
	`outb
(0,
CONTROL
); 
cÚŒŞ¡©
 = 0;

447 
	`d–ay
(200);

449 
	`WAIT
(
ASC_STAT
, 
STATMASK
, 
CMD_RDY
, 0);

450 
	`DEB
(
	`´štk
("wd7000_init: Power-on Diagnostics finished\n");)

451 ià(((
i
=
	`šb
(
INTR_STAT
)) != 1) && (i != 7)) {

452 
	`·nic
("wd7000_init: Power-on Diagnosticsƒrror\n");

457 
	`mem£t
(&
mb
,0, (mb));

459 
	`š™_scbs
();

462 
	`ªy2scsi
(
š™_block
+5,&
mb
);

464 ià(!
	`commªd_out
(
š™_block
,(init_block))) {

465 
	`·nic
("WD-7000 Initialization failed.\n");

470 
	`WAIT
(
ASC_STAT
, 
STATMASK
, 
CMD_RDY
 | 
ASC_INI
, 0);

471 
	`outb
(
DISABLE_UNS_INTR
, 
COMMAND
);

472 
	`WAIT
(
ASC_STAT
, 
STATMASK
, 
CMD_RDY
 | 
ASC_INI
, 0);

475 ià(
	`»que¡_œq
(
IRQ_LVL
, 
wd7000_šŒ_hªdË
)) {

476 
	`·nic
("Unableo‡llocate IRQ for WD-7000.\n");

479 if(
	`»que¡_dma
(
DMA_CH
)) {

480 
	`·nic
("Unableo‡llocate DMA channel for WD-7000.\n");

481 
	`ä“_œq
(
IRQ_LVL
);

484 
	`wd7000_’abË_dma
();

485 
	`wd7000_’abË_šŒ
();

487 
	`´štk
("WD-7000 initialized.\n");

489 
ç
:

491 
	}
}

494 
	$wd7000_»visiÚ
()

496 vŞ©
unch¬
 
icb
[
ICB_LEN
] = {0x8c};

498 
icb
[
ICB_PHASE
] = 1;

499 
	`ma_out
Ğ(
scb
 *è
icb
 );

500 
icb
[
ICB_PHASE
]) ;

501 
»v_1
 = 
icb
[1];

502 
»v_2
 = 
icb
[2];

507 ià(
»v_1
 >ğ7è
scsi_ho¡s
[
wd7000_ho¡
].
sg_bËsize
 = 
WD7000_SG
;

508 
	}
}

511 cÚ¡ *
	gwd_ba£s
[] = {(*)0xce000,(*)0xd8000};

514 * 
	msigÇtu»
;

515 
	moff£t
;

516 
	mËngth
;

517 } 
	tSigÇtu»
;

519 cÚ¡ 
SigÇtu»
 
	gsigÇtu»s
[] = {{"SSTBIOS",0xd,0x7}};

521 
	#NUM_SIGNATURES
 ((
sigÇtu»s
)/(
SigÇtu»
))

	)

524 
	$wd7000_d‘eù
(
ho¡num
)

529 
i
,
j
;

530 cÚ¡ *
ba£_add»ss
 = 
NULL
;

532 if(
	`check_»giÚ
(
IO_BASE
, 4))  0;

533 
i
=0;i<((
wd_ba£s
)/(*));i++){

534 
j
=0;j<
NUM_SIGNATURES
;j++){

535 if(!
	`memcmp
((*)(
wd_ba£s
[
i
] + 
sigÇtu»s
[
j
].
off£t
),

536 (*è
sigÇtu»s
[
j
].
sigÇtu»
,sigÇtu»s[j].
Ëngth
)){

537 
ba£_add»ss
=
wd_ba£s
[
i
];

538 
	`´štk
("WD-7000 detected.\n");

542 ià(
ba£_add»ss
 =ğ
NULL
)  0;

544 
	`¢¬f_»giÚ
(
IO_BASE
, 4);

546 
wd7000_ho¡
 = 
ho¡num
;

548 
	`wd7000_š™
();

549 
	`wd7000_»visiÚ
();

552 
	}
}

556 
	$wd7000_­³nd_šfo
Ğ*
šfo
, cÚ¡ *
fmt
, ... )

561 
va_li¡
 
¬gs
;

562 
	`v¥rštf
(*
buf
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
);

564 
	`va_¡¬t
(
¬gs
, 
fmt
);

565 
	`v¥rštf
(
šfo
, 
fmt
, 
¬gs
);

566 
	`va_’d
(
¬gs
);

569 
	}
}

572 cÚ¡ *
	$wd7000_šfo
()

574 
šfo
[80] = "Western Digital WD-7000, Firmware Revision ";

576 
	`wd7000_»visiÚ
();

577 
	`wd7000_­³nd_šfo
Ğ
šfo
+
	`¡¾’
(šfo), "%d.%d.\n", 
»v_1
, 
»v_2
 );

579  
šfo
;

580 
	}
}

582 
	$wd7000_abÜt
(
Scsi_Cmnd
 * 
SC²t
, 
i
)

584 #ifdeà
DEBUG


585 
	`´štk
("wd7000_abÜt: Scsi_Cmnd = 0x%08x, codğ%d ", 
SC²t
, 
i
);

586 
	`´štk
("id %d†uÀ%d cdb", 
SC²t
->
rg‘
, SC²t->
lun
);

587 { 
j
; 
unch¬
 *
cdbj
 = (unch¬ *è
SC²t
->
cmnd
;

588 
j
=0; j < 
	`COMMAND_SIZE
(*
cdbj
); j++è
	`´štk
(" %02x", *(cdbj++));

589 
	`´štk
("„esuÉ %08x\n", 
SC²t
->
»suÉ
);

593 
	}
}

600 
	$wd7000_»£t
(
Scsi_Cmnd
 * 
SC²t
)

602 #ifdeà
DEBUG


603 
	`´štk
("wd7000_reset\n");

605 ià(
SC²t
èSC²t->
æags
 |ğ
NEEDS_JUMPSTART
;

607 
	}
}

610 
	$wd7000_bio¥¬am
(
size
, 
dev
, * 

)

616 

[0] = 64;

617 

[1] = 32;

618 

[2] = 
size
 >> 11;

621 
	}
}

	@drivers/scsi/wd7000.h

1 #iâdeà
_WD7000_H


25 
	~<lšux/ty³s.h
>

27 #undeà
STATMASK


28 #undeà
CONTROL


30 
	#IO_BASE
 0x350

	)

31 
	#IRQ_LVL
 15

	)

32 
	#DMA_CH
 6

	)

33 
	#OGMB_CNT
 8

	)

34 
	#ICMB_CNT
 16

	)

38 
	#ASC_STAT
 
IO_BASE


	)

39 
	#INT_IM
 0x80

	)

40 
	#CMD_RDY
 0x40

	)

41 
	#CMD_REJ
 0x20

	)

42 
	#ASC_INI
 0x10

	)

43 
	#STATMASK
 0xf0

	)

49 
	#INTR_STAT
 
ASC_STAT
+1

	)

50 
	#ANYINTR
 0x80

	)

51 
	#IMB
 0x40

	)

52 
	#MBMASK
 0x3f

	)

68 
	#COMMAND
 
ASC_STAT


	)

72 
	#NO_OP
 0

	)

73 
	#INITIALIZATION
 1

	)

74 
	#DISABLE_UNS_INTR
 2

	)

75 
	#ENABLE_UNS_INTR
 3

	)

76 
	#INTR_ON_FREE_OGMB
 4

	)

77 
	#SCSI_SOFT_RESET
 5

	)

78 
	#SCSI_HARD_RESET
 6

	)

79 
	#START_OGMB
 0x80

	)

80 
	#SCAN_OGMBS
 0xc0

	)

85 
	#BUS_ON
 48

	)

86 
	#BUS_OFF
 24

	)

88 
	#INTR_ACK
 
ASC_STAT
+1

	)

91 
	#CONTROL
 
ASC_STAT
+2

	)

92 
	#INT_EN
 0x08

	)

93 
	#DMA_EN
 0x04

	)

94 
	#SCSI_RES
 0x02

	)

95 
	#ASC_RES
 0x01

	)

99 
	swd_mabox
{

100 
unch¬
 
	m¡©us
;

101 
unch¬
 
	mscb±r
[3];

106 #undeà
ªy2scsi


107 
	#ªy2scsi
(
up
, 
p
) \

108 (
up
)[0] = ((()(
p
)) >> 16); \

109 (
up
)[1] = (()(
p
)) >> 8; \

110 (
up
)[2] = (()(
p
));

	)

112 
	#scsi2št
(
up
èĞ((()*(up)è<< 16è+ ((()(up)[1]è<< 8è+ (()(up)[2]è)

	)

114 
	#xªy2scsi
(
up
, 
p
) \

115 (
up
)[0] = (()(
p
)) >> 24; \

116 (
up
)[1] = (()(
p
)) >> 16; \

117 (
up
)[2] = (()(
p
)) >> 8; \

118 (
up
)[3] = (()(
p
));

	)

120 
	#xscsi2št
(
up
) ( ((()(up)[0]) << 24) + ((()(up)[1]) << 16) \

121 + ((()(
up
)[2]è<< 8è+ (()(up)[3]è)

	)

123 
	#MAX_CDB
 12

	)

124 
	#MAX_SENSE
 14

	)

126 
	sscb
 {

127 
unch¬
 
	mİ
;

128 
unch¬
 
	midlun
;

132 
unch¬
 
	mcdb
[12];

133 
unch¬
 
	m¡©us
;

134 
unch¬
 
	mvue
;

135 
unch¬
 
	mmaxËn
[3];

136 
unch¬
 
	md©­Œ
[3];

137 
unch¬
 
	mlšk±r
[3];

138 
unch¬
 
	mdœec
;

139 
unch¬
 
	m»£rved2
[6];

141 
Scsi_Cmnd
 *
	mSC²t
;

142 
scb
 *
	mÃxt
;

143 } 
	tScb
;

148 
	ssgb
 {

149 
unch¬
 
	mËn
[3];

150 
unch¬
 
	m±r
[3];

151 } 
	tSgb
;

158 
	#MAX_SCBS
 ((
WD7000_Q
+1è* (
WD7000_SG
+1))

	)

166 
	#ICB_STATUS
 16

	)

167 
	#ICB_PHASE
 17

	)

168 
	#ICB_LEN
 18

	)

170 
wd7000_d‘eù
();

171 
wd7000_commªd
(
Scsi_Cmnd
 *);

172 
wd7000_queuecommªd
(
Scsi_Cmnd
 *, (*
dÚe
)(Scsi_Cmnd *));

173 
	`wd7000_abÜt
(
Scsi_Cmnd
 *, );

174 cÚ¡ *
	`wd7000_šfo
();

175 
	`wd7000_»£t
(
Scsi_Cmnd
 *);

176 
	`wd7000_bio¥¬am
(, , *);

178 #iâdeà
NULL


179 
	#NULL
 0

	)

190 
	#WD7000_SCRIBBLE
 512

	)

192 
	#WD7000_Q
 
OGMB_CNT


	)

193 
	#WD7000_SG
 (
WD7000_SCRIBBLE
 / (
Sgb
))

	)

195 
	#WD7000
 {\

197 
wd7000_d‘eù
, \

198 
wd7000_šfo
, 
wd7000_commªd
, \

199 
wd7000_queuecommªd
, \

200 
wd7000_abÜt
, \

201 
wd7000_»£t
, \

202 
NULL
, \

203 
wd7000_bio¥¬am
, \

204 
WD7000_Q
, 7, 
SG_NONE
, 1, 0, 1
	}

	)
}

	@drivers/sound/adlib_card.c

30 
	~"sound_cÚfig.h
"

32 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_YM3812
)

35 
	$©ch_adlib_ÿrd
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

38 ià(
	`İl3_d‘eù
 (
FM_MONO
))

40 
mem_¡¬t
 = 
	`İl3_š™
 (mem_start);

42  
mem_¡¬t
;

43 
	}
}

46 
	$´obe_adlib
 (
add»ss_šfo
 *
hw_cÚfig
)

48  
	`İl3_d‘eù
 (
FM_MONO
);

49 
	}
}

	@drivers/sound/audio.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


33 #iâdeà
EXCLUDE_AUDIO


35 
	~"uÏw.h
"

37 
	#ON
 1

	)

38 
	#OFF
 0

	)

40 
	gwr_buff_no
[
MAX_DSP_DEV
];

42 
	gwr_buff_size
[
MAX_DSP_DEV
], 
	gwr_buff_±r
[MAX_DSP_DEV];

44 
	gaudio_mode
[
MAX_DSP_DEV
];

45 
	#AM_NONE
 0

	)

46 
	#AM_WRITE
 1

	)

47 
	#AM_READ
 2

	)

49 *
	gwr_dma_buf
[
MAX_DSP_DEV
];

52 
	$audio_İ’
 (
dev
, 
fešfo
 *
fe
)

54 
»t
;

55 
b™s
;

56 
dev_ty³
 = 
dev
 & 0x0f;

57 
mode
 = 
fe
->mod& 
O_ACCMODE
;

59 
dev
 = dev >> 4;

61 ià(
dev_ty³
 =ğ
SND_DEV_DSP16
)

62 
b™s
 = 16;

64 
b™s
 = 8;

66 ià((
»t
 = 
	`DMAbuf_İ’
 (
dev
, 
mode
)) < 0)

67  
»t
;

69 ià(
	`DMAbuf_ioùl
 (
dev
, 
SNDCTL_DSP_SAMPLESIZE
, 
b™s
, 1) != bits)

71 
	`audio_»Ëa£
 (
dev
, 
fe
);

72  
	`RET_ERROR
 (
ENXIO
);

75 
wr_buff_no
[
dev
] = -1;

76 
audio_mode
[
dev
] = 
AM_NONE
;

78  
»t
;

79 
	}
}

82 
	$audio_»Ëa£
 (
dev
, 
fešfo
 *
fe
)

84 
mode
;

86 
dev
 = dev >> 4;

87 
mode
 = 
fe
->mod& 
O_ACCMODE
;

89 ià(
wr_buff_no
[
dev
] >= 0)

91 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev]);

93 
wr_buff_no
[
dev
] = -1;

96 
	`DMAbuf_»Ëa£
 (
dev
, 
mode
);

97 
	}
}

99 #ifdeà
NO_INLINE_ASM


101 
	$Œª¦©e_by‹s
 (cÚ¡ *
bË
, *
buff
, 
n
)

103 
i
;

105 
i
 = 0; i < 
n
; ++i)

106 
buff
[
i
] = 
bË
[buff[i]];

107 
	}
}

110 
šlše
 

111 
	$Œª¦©e_by‹s
 (cÚ¡ *
bË
, *
buff
, 
n
)

113 
	`__asm__
 ("cld\n"

118 :"b" ((è
bË
), "c" (
n
), "D" ((è
buff
), "S" (() buff)

120 
	}
}

125 
	$audio_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

127 
c
, 
p
, 
l
;

128 
”r
;

129 
dev_ty³
 = 
dev
 & 0x0f;

131 
dev
 = dev >> 4;

133 
p
 = 0;

134 
c
 = 
couÁ
;

136 ià(
audio_mode
[
dev
] =ğ
AM_READ
)

138 
wr_buff_no
[
dev
] = -1;

141 
audio_mode
[
dev
] = 
AM_WRITE
;

143 ià(!
couÁ
)

145 ià(
wr_buff_no
[
dev
] >= 0)

147 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev]);

149 
wr_buff_no
[
dev
] = -1;

154 
c
)

156 ià(
wr_buff_no
[
dev
] < 0)

158 ià((
wr_buff_no
[
dev
] = 
	`DMAbuf_g‘wrbufãr
 (dev, &
wr_dma_buf
[dev], &
wr_buff_size
[dev])) < 0)

159  
wr_buff_no
[
dev
];

160 
wr_buff_±r
[
dev
] = 0;

163 
l
 = 
c
;

164 ià(
l
 > (
wr_buff_size
[
dev
] - 
wr_buff_±r
[dev]))

165 
l
 = (
wr_buff_size
[
dev
] - 
wr_buff_±r
[dev]);

167 ià(!
d¥_devs
[
dev
]->
cİy_äom_u£r
)

169 
	`COPY_FROM_USER
 (&
wr_dma_buf
[
dev
][
wr_buff_±r
[dev]], 
buf
, 
p
, 
l
);

172 
d¥_devs
[
dev
]->
	`cİy_äom_u£r
 (dev,

173 
wr_dma_buf
[
dev
], 
wr_buff_±r
[dev], 
buf
, 
p
, 
l
);

178 ià(
dev_ty³
 =ğ
SND_DEV_AUDIO
)

180 #ifdeà
lšux


182 
	`__asm__
 ("sti");

184 
	`Œª¦©e_by‹s
 (
uÏw_d¥
, &
wr_dma_buf
[
dev
][
wr_buff_±r
[dev]], 
l
);

187 
c
 -ğ
l
;

188 
p
 +ğ
l
;

189 
wr_buff_±r
[
dev
] +ğ
l
;

191 ià(
wr_buff_±r
[
dev
] >ğ
wr_buff_size
[dev])

193 ià((
”r
 = 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev])) < 0)

194  
”r
;

196 
wr_buff_no
[
dev
] = -1;

201  
couÁ
;

202 
	}
}

205 
	$audio_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

207 
c
, 
p
, 
l
;

208 *
dmabuf
;

209 
buff_no
;

210 
dev_ty³
 = 
dev
 & 0x0f;

212 
dev
 = dev >> 4;

213 
p
 = 0;

214 
c
 = 
couÁ
;

216 ià(
audio_mode
[
dev
] =ğ
AM_WRITE
)

218 ià(
wr_buff_no
[
dev
] >= 0)

220 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev]);

222 
wr_buff_no
[
dev
] = -1;

226 
audio_mode
[
dev
] = 
AM_READ
;

228 
c
)

230 ià((
buff_no
 = 
	`DMAbuf_g‘rdbufãr
 (
dev
, &
dmabuf
, &
l
)) < 0)

231  
buff_no
;

233 ià(
l
 > 
c
)

234 
l
 = 
c
;

238 ià(
dev_ty³
 =ğ
SND_DEV_AUDIO
)

240 #ifdeà
lšux


242 
	`__asm__
 ("sti");

245 
	`Œª¦©e_by‹s
 (
d¥_uÏw
, 
dmabuf
, 
l
);

248 
	`COPY_TO_USER
 (
buf
, 
p
, 
dmabuf
, 
l
);

250 
	`DMAbuf_rmch¬s
 (
dev
, 
buff_no
, 
l
);

252 
p
 +ğ
l
;

253 
c
 -ğ
l
;

256  
couÁ
 - 
c
;

257 
	}
}

260 
	$audio_ioùl
 (
dev
, 
fešfo
 *
fe
,

261 
cmd
, 
¬g
)

263 
dev_ty³
 = 
dev
 & 0x0f;

264 
dev
 = dev >> 4;

266 
cmd
)

268 
SNDCTL_DSP_SYNC
:

269 ià(
wr_buff_no
[
dev
] >= 0)

271 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev]);

273 
wr_buff_no
[
dev
] = -1;

275  
	`DMAbuf_ioùl
 (
dev
, 
cmd
, 
¬g
, 0);

278 
SNDCTL_DSP_POST
:

279 ià(
wr_buff_no
[
dev
] >= 0)

281 
	`DMAbuf_¡¬t_ouut
 (
dev
, 
wr_buff_no
[dev], 
wr_buff_±r
[dev]);

283 
wr_buff_no
[
dev
] = -1;

288 
SNDCTL_DSP_RESET
:

289 
wr_buff_no
[
dev
] = -1;

290  
	`DMAbuf_ioùl
 (
dev
, 
cmd
, 
¬g
, 0);

294 ià(
dev_ty³
 =ğ
SND_DEV_AUDIO
)

295  
	`RET_ERROR
 (
EIO
);

297  
	`DMAbuf_ioùl
 (
dev
, 
cmd
, 
¬g
, 0);

299 
	}
}

302 
	$audio_š™
 (
mem_¡¬t
)

304  
mem_¡¬t
;

305 
	}
}

311 
	$audio_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

313  
	`RET_ERROR
 (
EIO
);

314 
	}
}

317 
	$audio_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

319  
	`RET_ERROR
 (
EIO
);

320 
	}
}

323 
	$audio_İ’
 (
dev
, 
fešfo
 *
fe
)

325  
	`RET_ERROR
 (
ENXIO
);

326 
	}
}

329 
	$audio_»Ëa£
 (
dev
, 
fešfo
 *
fe
)

331 
	}
};

333 
	$audio_ioùl
 (
dev
, 
fešfo
 *
fe
,

334 
cmd
, 
¬g
)

336  
	`RET_ERROR
 (
EIO
);

337 
	}
}

340 
	$audio_l£ek
 (
dev
, 
fešfo
 *
fe
, 
off_t
 
off£t
, 
Üig
)

342  
	`RET_ERROR
 (
EIO
);

343 
	}
}

346 
	$audio_š™
 (
mem_¡¬t
)

348  
mem_¡¬t
;

349 
	}
}

	@drivers/sound/configure.c

28 
	~<¡dio.h
>

30 
	#B
(
x
è(1 << (x))

	)

36 
	#OPT_PAS
 0

	)

37 
	#OPT_SB
 1

	)

38 
	#OPT_ADLIB
 2

	)

39 
	#OPT_LAST_MUTUAL
 2

	)

41 
	#OPT_GUS
 3

	)

42 
	#OPT_MPU401
 4

	)

44 
	#OPT_HIGHLEVEL
 5

	)

45 
	#OPT_SBPRO
 5

	)

46 
	#OPT_SB16
 6

	)

47 
	#OPT_AUDIO
 7

	)

48 
	#OPT_MIDI_AUTO
 8

	)

49 
	#OPT_MIDI
 9

	)

50 
	#OPT_YM3812_AUTO
 10

	)

52 
	#OPT_YM3812
 11

	)

54 
	#OPT_SEQUENCER
 12

	)

55 
	#OPT_CHIP_MIDI
 13

	)

57 
	#OPT_LAST
 12

	)

59 
	#ANY_DEVS
 (
	`B
(
OPT_AUDIO
)|B(
OPT_MIDI
)|B(
OPT_SEQUENCER
)|B(
OPT_GUS
)|B(
OPT_MPU401
))

	)

63 
	mcÚd™iÚs
;

64 
	mexşusive_İtiÚs
;

65 
	mmaüo
[20];

66 
	mv”ify
;

67 
	m®Ÿs
;

68 
	mdeçuÉ_ªsw
;

71 
	thw_’Œy
;

88 
hw_’Œy
 
	ghw_bË
[] =

93 {0, 
B
 (
OPT_PAS
è| B (
OPT_SB
), "ADLIB", 1, 0, 0},

98 {
B
 (
OPT_SB
), B (
OPT_PAS
), "SBPRO", 1, 0, 1},

99 {
B
 (
OPT_SB
è| B (
OPT_SBPRO
), B (
OPT_PAS
), "SB16", 1, 0, 1},

100 {
B
 (
OPT_SB
è| B (
OPT_PAS
è| B (
OPT_GUS
), 0, "AUDIO", 1, 0, 1},

101 {
B
 (
OPT_MPU401
), 0, "MIDI_AUTO", 0, 
OPT_MIDI
, 0},

102 {
B
 (
OPT_SB
è| B (
OPT_PAS
è| B (
OPT_MPU401
è| B (
OPT_GUS
), 0, "MIDI", 1, 0, 1},

103 {
B
 (
OPT_ADLIB
), 0, "YM3812_AUTO", 0, 
OPT_YM3812
, 0},

104 {
B
 (
OPT_SB
è| B (
OPT_PAS
è| B (
OPT_ADLIB
), B (
OPT_YM3812_AUTO
), "YM3812", 1, 0, 1},

106 {
B
 (
OPT_MIDI
è| B (
OPT_YM3812
è| B (
OPT_YM3812_AUTO
è| B (
OPT_GUS
), 0, "SEQUENCER", 0, 0, 1},

110 *
	gque¡iÚs
[] =

129 
	g£Ëùed_İtiÚs
 = 0;

130 
	gsb_dma
 = 0;

133 
	$ÿn_£Ëù_İtiÚ
 (
Ä
)

135 
Ä
)

138 
	`årštf
 (
¡d”r
, "The SoundBlaster, AdLib‡nd ProAudioSpectrum\n"

140 
	`årštf
 (
¡d”r
, "\nSelect‡t most one ofhem:\n");

141 
	`årštf
 (
¡d”r
, " - ProAudioSpectrum 16\n");

142 
	`årštf
 (
¡d”r
, " - SoundBlaster / SB Pro\n");

143 
	`årštf
 (
¡d”r
, " (Could be selected with PAS16‡lso\n"

145 
	`årštf
 (
¡d”r
, " - AdLib\n");

146 
	`årštf
 (
¡d”r
, "\nDon'tƒnable SoundBlaster if you have GUS‡t 0x220!\n\n");

149 
OPT_LAST_MUTUAL
 + 1:

150 
	`årštf
 (
¡d”r
, "\nThe following cards should work with‡ny other cards.\n"

154 
OPT_HIGHLEVEL
:

155 
	`årštf
 (
¡d”r
, "\nSelect one or more ofhe following options\n");

161 ià(
hw_bË
[
Ä
].
cÚd™iÚs
)

162 ià(!(
hw_bË
[
Ä
].
cÚd™iÚs
 & 
£Ëùed_İtiÚs
))

165 ià(
hw_bË
[
Ä
].
exşusive_İtiÚs
)

166 ià(
hw_bË
[
Ä
].
exşusive_İtiÚs
 & 
£Ëùed_İtiÚs
)

170 
	}
}

173 
	$thšk_pos™iv–y
 (
def_ªsw
)

175 
ªsw
[512];

176 
Ën
;

178 ià((
Ën
 = 
	`»ad
 (0, &
ªsw
,  (answ))) < 1)

180 
	`årštf
 (
¡d”r
, "\n\nERROR! Cannot„ead stdin\n");

182 
	`³¼Ü
 ("stdin");

183 
	`´štf
 ("#undef CONFIGURE_SOUNDCARD\n");

184 
	`´štf
 ("#undef KERNEL_SOUNDCARD\n");

185 
	`ex™
 (-1);

188 ià(
Ën
 < 2)

189  
def_ªsw
;

191 
ªsw
[
Ën
 - 1] = 0;

193 ià(!
	`¡rcmp
 (
ªsw
, "y") || !strcmp (answ, "Y"))

197 
	}
}

200 
	$ask_v®ue
 (*
fÜm©
, 
deçuÉ_ªsw”
)

202 
ªsw
[512];

203 
Ën
, 
num
;

205 
¶ay_™_agaš_Sam
:

207 ià((
Ën
 = 
	`»ad
 (0, &
ªsw
,  (answ))) < 1)

209 
	`årštf
 (
¡d”r
, "\n\nERROR! Cannot„ead stdin\n");

211 
	`³¼Ü
 ("stdin");

212 
	`´štf
 ("#undef CONFIGURE_SOUNDCARD\n");

213 
	`´štf
 ("#undef KERNEL_SOUNDCARD\n");

214 
	`ex™
 (-1);

217 ià(
Ën
 < 2)

218  
deçuÉ_ªsw”
;

220 
ªsw
[
Ën
 - 1] = 0;

222 ià(
	`ssÿnf
 (
ªsw
, 
fÜm©
, &
num
) != 1)

224 
	`årštf
 (
¡d”r
, "Illegal format. Try‡gain: ");

225 
¶ay_™_agaš_Sam
;

228  
num
;

229 
	}
}

232 
	$maš
 (
¬gc
, *
¬gv
[])

234 
i
, 
num
, 
def_size
, 
fuÎ_driv”
 = 1;

235 
ªsw
[10];

237 
	`´štf
 ("/*\tGenerated by configure. Don'tƒdit!!!!\t*/\n\n");

239 
	`årštf
 (
¡d”r
, "\nConfiguringhe sound support\n\n");

241 
	`årštf
 (
¡d”r
, "Do you wanto include full version ofhe sound driver (n/y) ? ");

243 ià(
	`thšk_pos™iv–y
 (0))

245 
£Ëùed_İtiÚs
 = 0xfffffffà& ~
	`B
 (
OPT_MPU401
);

246 
	`årštf
 (
¡d”r
, "Note! MPU-401 driver was‚otƒnabled\n");

247 
fuÎ_driv”
 = 1;

251 
	`årštf
 (
¡d”r
, "Do you wanto DISABLEhe Sound Driver (n/y) ?");

252 ià(
	`thšk_pos™iv–y
 (0))

254 
	`´štf
 ("#undef CONFIGURE_SOUNDCARD\n");

255 
	`´štf
 ("#undef KERNEL_SOUNDCARD\n");

256 
	`ex™
 (0);

260 
fuÎ_driv”
 = 0;

262 
i
 = 0; i <ğ
OPT_LAST
; i++)

263 ià(
	`ÿn_£Ëù_İtiÚ
 (
i
))

265 ià(!(
£Ëùed_İtiÚs
 & 
	`B
 (
i
)))

266 ià(!
hw_bË
[
i
].
v”ify
)

268 ià(
hw_bË
[
i
].
®Ÿs
)

269 
£Ëùed_İtiÚs
 |ğ
	`B
 (
hw_bË
[
i
].
®Ÿs
);

271 
£Ëùed_İtiÚs
 |ğ
	`B
 (
i
);

275 
def_ªsw
 = 
hw_bË
[
i
].
deçuÉ_ªsw
;

277 
	`årštf
 (
¡d”r
,

278 
def_ªsw
 ? " %s (y/n) ? " : " %s (n/y) ? ",

279 
que¡iÚs
[
i
]);

280 ià(
	`thšk_pos™iv–y
 (
def_ªsw
))

281 ià(
hw_bË
[
i
].
®Ÿs
)

282 
£Ëùed_İtiÚs
 |ğ
	`B
 (
hw_bË
[
i
].
®Ÿs
);

284 
£Ëùed_İtiÚs
 |ğ
	`B
 (
i
);

289 ià(
£Ëùed_İtiÚs
 & 
	`B
(
OPT_SB16
))

290 
£Ëùed_İtiÚs
 |ğ
	`B
(
OPT_SBPRO
);

292 ià(!(
£Ëùed_İtiÚs
 & 
ANY_DEVS
))

294 
	`´štf
 ("#undef CONFIGURE_SOUNDCARD\n");

295 
	`´štf
 ("#undef KERNEL_SOUNDCARD\n");

296 
	`årštf
 (
¡d”r
, "\n*** This combination is useless. Sound driver disabled!!! ***\n\n");

297 
	`ex™
 (0);

300 
	`´štf
 ("#define KERNEL_SOUNDCARD\n");

302 
i
 = 0; i <ğ
OPT_LAST
; i++)

303 ià(!
hw_bË
[
i
].
®Ÿs
)

304 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
i
))

305 
	`´štf
 ("#undeà EXCLUDE_%s\n", 
hw_bË
[
i
].
maüo
);

307 
	`´štf
 ("#defšEXCLUDE_%s\n", 
hw_bË
[
i
].
maüo
);

310 
	`´štf
 ("#define EXCLUDE_PRO_MIDI\n");

311 
	`´štf
 ("#define EXCLUDE_CHIP_MIDI\n");

316 
	`´štf
 ("\n");

318 #ià
	`defšed
(
lšux
)

319 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_SB
è&& s–eùed_İtiÚ & (B (
OPT_AUDIO
è| B (
OPT_MIDI
)))

321 
	`årštf
 (
¡d”r
, "\nIRQ‚umber for SoundBlaster?\n"

326 
num
 = 
	`ask_v®ue
 ("%d", 7);

327 ià(
num
 != 9 &&‚um != 5 &&‚um != 7 &&‚um != 10)

330 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

331 
num
 = 7;

333 
	`årštf
 (
¡d”r
, "SoundBÏ¡” IRQ s‘Ø%d\n", 
num
);

334 
	`´štf
 ("#defšSBC_IRQ %d\n", 
num
);

336 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_SBPRO
))

339 
	`årštf
 (
¡d”r
, "\nDMA channel for SoundBlaster?\n"

346 
num
 = 
	`ask_v®ue
 ("%d", 1);

347 ià(
num
 < 0 ||‚um > 3)

350 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

351 
num
 = 1;

353 
	`årštf
 (
¡d”r
, "SoundBÏ¡” DMA s‘Ø%d\n", 
num
);

354 
	`´štf
 ("#defšSBC_DMA %d\n", 
num
);

355 
sb_dma
 = 
num
;

358 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_SB16
))

361 
	`årštf
 (
¡d”r
, "\n16 bit DMA channel for SoundBlaster 16?\n"

366 
num
 = 
	`ask_v®ue
 ("%d", 6);

367 ià((
num
 < 5 ||‚um > 7è&& (num !ğ
sb_dma
))

370 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

371 
num
 = 6;

373 
	`årštf
 (
¡d”r
, "SoundBÏ¡” DMA s‘Ø%d\n", 
num
);

374 
	`´štf
 ("#defšSB16_DMA %d\n", 
num
);

376 
	`årštf
 (
¡d”r
, "\nI/O base for SB16 Midi?\n"

381 
num
 = 
	`ask_v®ue
 ("%x", 0x330);

382 
	`årštf
 (
¡d”r
, "SB16 Mid˜I/O ba£ s‘Ø%03x\n", 
num
);

383 
	`´štf
 ("#defšSB16MIDI_BASE 0x%03x\n", 
num
);

387 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_PAS
))

389 ià(
£Ëùed_İtiÚs
 & (
	`B
 (
OPT_AUDIO
è| B (
OPT_MIDI
)))

391 
	`årštf
 (
¡d”r
, "\nIRQ‚umber for ProAudioSpectrum?\n"

397 
num
 = 
	`ask_v®ue
 ("%d", 10);

398 ià(
num
 == 6 ||‚um < 3 ||‚um > 15 ||‚um == 2)

401 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

402 
num
 = 10;

404 
	`årštf
 (
¡d”r
, "ProAudioS³ùrum IRQ s‘Ø%d\n", 
num
);

405 
	`´štf
 ("#defšPAS_IRQ %d\n", 
num
);

408 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_AUDIO
))

410 
	`årštf
 (
¡d”r
, "\nDMA‚umber for ProAudioSpectrum?\n"

416 
num
 = 
	`ask_v®ue
 ("%d", 3);

417 ià(
num
 == 4 ||‚um < 0 ||‚um > 7)

420 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

421 
num
 = 3;

423 
	`årštf
 (
¡d”r
, "\nProAudioS³ùrum DMA s‘Ø%d\n", 
num
);

424 
	`´štf
 ("#defšPAS_DMA %d\n", 
num
);

428 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_GUS
))

430 
	`årštf
 (
¡d”r
, "\nI/O base for Gravis Ultrasound?\n"

435 
num
 = 
	`ask_v®ue
 ("%x", 0x220);

436 ià((
num
 > 0x260) || ((num & 0xf0f) != 0x200) || ((num & 0x0f0) > 0x060))

439 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

440 
num
 = 0x220;

443 ià((
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_SB
)è&& (
num
 == 0x220))

445 
	`årštf
 (
¡d”r
, "FATAL ERROR!!!!!!!!!!!!!!\n"

448 
	`´štf
 ("#undef CONFIGURE_SOUNDCARD\n");

449 
	`´štf
 ("#undef KERNEL_SOUNDCARD\n");

450 
	`ex™
 (-1);

452 
	`årštf
 (
¡d”r
, "GUS I/O ba£ s‘Ø%03x\n", 
num
);

453 
	`´štf
 ("#defšGUS_BASE 0x%03x\n", 
num
);

455 
	`årštf
 (
¡d”r
, "\nIRQ‚umber for Gravis UltraSound?\n"

461 
num
 = 
	`ask_v®ue
 ("%d", 15);

462 ià(
num
 == 6 ||‚um < 3 ||‚um > 15 ||‚um == 2)

465 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

466 
num
 = 15;

468 
	`årštf
 (
¡d”r
, "G¿vi UÉ¿Sound IRQ s‘Ø%d\n", 
num
);

469 
	`´štf
 ("#defšGUS_IRQ %d\n", 
num
);

471 
	`årštf
 (
¡d”r
, "\nDMA‚umber for Gravis UltraSound?\n"

477 
num
 = 
	`ask_v®ue
 ("%d", 6);

478 ià(
num
 == 4 ||‚um < 0 ||‚um > 7)

480 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

481 
num
 = 6;

483 
	`årštf
 (
¡d”r
, "\nG¿vi UÉ¿Sound DMA s‘Ø%d\n", 
num
);

484 
	`´štf
 ("#defšGUS_DMA %d\n", 
num
);

487 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_MPU401
))

489 
	`årštf
 (
¡d”r
, "\nI/O base for MPU-401?\n"

493 
num
 = 
	`ask_v®ue
 ("%x", 0x330);

494 
	`årštf
 (
¡d”r
, "MPU-401 I/O ba£ s‘Ø%03x\n", 
num
);

495 
	`´štf
 ("#defšMPU_BASE 0x%03x\n", 
num
);

497 
	`årštf
 (
¡d”r
, "\nIRQ‚umber for MPU-401?\n"

502 
num
 = 
	`ask_v®ue
 ("%d", 5);

503 ià(
num
 == 6 ||‚um < 3 ||‚um > 15)

506 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

507 
num
 = 5;

509 
	`årštf
 (
¡d”r
, "MPU-401 IRQ s‘Ø%d\n", 
num
);

510 
	`´štf
 ("#defšMPU_IRQ %d\n", 
num
);

514 ià(
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_AUDIO
))

516 
def_size
 = 16384;

518 ià(
£Ëùed_İtiÚs
 & (
	`B
 (
OPT_SBPRO
è| B (
OPT_PAS
è| B(
OPT_SB16
)))

519 
def_size
 = 32768;

521 #iâdeà
__386BSD__


522 ià(((
£Ëùed_İtiÚs
 & 
	`B
 (
OPT_PAS
)è|| (£Ëùed_İtiÚ & B (
OPT_SB16
))) &&

523 !
fuÎ_driv”
)

524 
def_size
 = 65536;

527 
	`årštf
 (
¡d”r
, "\nSelecthe DMA buffer size (4096, 16384, 32768 or 65536 bytes)\n"

529 "EÁ”hv®ue: ", 
def_size
);

531 
num
 = 
	`ask_v®ue
 ("%d", 
def_size
);

532 ià(
num
 != 4096 &&‚um != 16384 &&‚um != 32768 &&‚um != 65536)

535 
	`årštf
 (
¡d”r
, "*** Illegal input! ***\n");

536 
num
 = 
def_size
;

538 
	`årštf
 (
¡d”r
, "ThDMA bufã¸siz£ˆtØ%d\n", 
num
);

539 
	`´štf
 ("#defšDSP_BUFFSIZE %d\n", 
num
);

542 
	`´štf
 ("#defšSELECTED_SOUND_OPTIONS\t0x%08x\n", 
£Ëùed_İtiÚs
);

543 
	`årštf
 (
¡d”r
, "The sound driver is‚ow configured.\n");

545 #ià
	`defšed
(
SCO
è|| defšed(
ISC
è|| defšed(
SYSV
)

546 
	`årštf
(
¡d”r
, "Rembero updatehe System file\n");

549 
	`ex™
 (0);

550 
	}
}

	@drivers/sound/dev_table.c

30 
	#_DEV_TABLE_C_


	)

31 
	~"sound_cÚfig.h
"

33 #ifdeà
CONFIGURE_SOUNDCARD


36 
	$¢dbË_š™
 (
mem_¡¬t
)

38 
i
, 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

40 
i
 = 0; i < (
n
 - 1); i++)

41 ià(
suµÜ‹d_driv”s
[
i
].
’abËd
)

42 ià(
suµÜ‹d_driv”s
[
i
].
	`´obe
 (&suµÜ‹d_driv”s[i].
cÚfig
))

44 #iâdeà
SHORT_BANNERS


45 
	`´štk
 ("snd%d",

46 
suµÜ‹d_driv”s
[
i
].
ÿrd_ty³
);

49 
mem_¡¬t
 = 
suµÜ‹d_driv”s
[
i
].
	`©ch
 (mem_¡¬t, &suµÜ‹d_driv”s[i].
cÚfig
);

50 #iâdeà
SHORT_BANNERS


51 
	`´štk
 ("‡t 0x%x irq %d drq %d\n",

52 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
io_ba£
,

53 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
œq
,

54 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
dma
);

58 
suµÜ‹d_driv”s
[
i
].
’abËd
=0;

59  
mem_¡¬t
;

60 
	}
}

63 
	$¢dbË_´obe
 (
un™
, 
add»ss_šfo
 *
hw_cÚfig
)

65 
i
, 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

67 ià(!
un™
)

68  
TRUE
;

70 
i
 = 0; i < (
n
 - 1); i++)

71 ià(
suµÜ‹d_driv”s
[
i
].
ÿrd_ty³
 =ğ
un™
)

73 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
io_ba£
 = 
hw_cÚfig
->io_base;

74 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
œq
 = 
hw_cÚfig
->irq;

75 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
dma
 = 
hw_cÚfig
->dma;

76 ià(
suµÜ‹d_driv”s
[
i
].
	`´obe
 (
hw_cÚfig
))  1;

77 
suµÜ‹d_driv”s
[
i
].
’abËd
=0;

81  
FALSE
;

82 
	}
}

85 
	$¢dbË_š™_ÿrd
 (
un™
, 
add»ss_šfo
 *
hw_cÚfig
)

87 
i
, 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

89 ià(!
un™
)

91 ià(
	`¢dbË_š™
 (0) != 0)

92 
	`·nic
 ("snd: Invalid memory‡llocation\n");

93  
TRUE
;

96 
i
 = 0; i < (
n
 - 1); i++)

97 ià(
suµÜ‹d_driv”s
[
i
].
ÿrd_ty³
 =ğ
un™
)

99 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
io_ba£
 = 
hw_cÚfig
->io_base;

100 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
œq
 = 
hw_cÚfig
->irq;

101 
suµÜ‹d_driv”s
[
i
].
cÚfig
.
dma
 = 
hw_cÚfig
->dma;

103 ià(
suµÜ‹d_driv”s
[
i
].
	`©ch
 (0, 
hw_cÚfig
) != 0)

104 
	`·nic
 ("snd#: Invalid memory‡llocation\n");

105  
TRUE
;

108  
FALSE
;

109 
	}
}

112 
	$¢dbË_g‘_ÿrdcouÁ
 ()

114  
num_d¥devs
 + 
num_mix”s
 + 
num_syÁhs
 + 
num_midis
;

115 
	}
}

117 #ifdeà
lšux


118 
	$sound_£tup
(*
¡r
, *
šts
)

120 
i
, 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

126 
i
=0;i<
n
;i++)

127 
suµÜ‹d_driv”s
[
i
].
’abËd
 = 0;

129 ià(
šts
[0] == 0 || ints[1] == 0) ;

134 
i
=1;i<=
šts
[0];i++)

136 
ÿrd_ty³
, 
ißddr
, 
œq
, 
dma
, 
±r
, 
j
;

137 
v®
;

139 
v®
 = ()
šts
[
i
];

141 
ÿrd_ty³
 = (
v®
 & 0x0ff00000) >> 20;

143 ià(
ÿrd_ty³
 > 127)

149 
ißddr
 = (
v®
 & 0x000fff00) >> 8;

150 
œq
 = (
v®
 & 0x000000f0) >> 4;

151 
dma
 = (
v®
 & 0x0000000f);

153 
±r
 = -1;

154 
j
=0;j<
n
 && 
±r
 == -1;j++)

155 ià(
suµÜ‹d_driv”s
[
j
].
ÿrd_ty³
 == card_type)

156 
±r
 = 
j
;

158 ià(
±r
 == -1)

159 
	`´štk
("Sound: Inv®id s‘u°·¿m‘” 0x%08x\n", 
v®
);

162 
suµÜ‹d_driv”s
[
±r
].
’abËd
 = 1;

163 
suµÜ‹d_driv”s
[
±r
].
cÚfig
.
io_ba£
 = 
ißddr
;

164 
suµÜ‹d_driv”s
[
±r
].
cÚfig
.
œq
 = irq;

165 
suµÜ‹d_driv”s
[
±r
].
cÚfig
.
dma
 = dma;

168 
	}
}

170 
	$sound_chcÚf
(
ÿrd_ty³
, 
ißddr
, 
œq
, 
dma
)

172 
i
, 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

174 
±r
, 
j
;

176 
±r
 = -1;

177 
j
=0;j<
n
 && 
±r
 == -1;j++)

178 ià(
suµÜ‹d_driv”s
[
j
].
ÿrd_ty³
 == card_type)

179 
±r
 = 
j
;

181 ià(
±r
 != -1)

183 
suµÜ‹d_driv”s
[
±r
].
’abËd
 = 1;

184 ià(
ißddr
è
suµÜ‹d_driv”s
[
±r
].
cÚfig
.
io_ba£
 = ioaddr;

185 ià(
œq
è
suµÜ‹d_driv”s
[
±r
].
cÚfig
.irq = irq;

186 ià(
dma
è
suµÜ‹d_driv”s
[
±r
].
cÚfig
.dma = dma;

188 
	}
}

191 
add»ss_šfo
 *
	$sound_g‘cÚf
(
ÿrd_ty³
)

193 
j
, 
±r
;

194 
n
 =  (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

196 
±r
 = -1;

197 
j
=0;j<
n
 && 
±r
 == -1;j++)

198 ià(
suµÜ‹d_driv”s
[
j
].
ÿrd_ty³
 == card_type)

199 
±r
 = 
j
;

201 ià(
±r
 =ğ-1è (
add»ss_šfo
 *)
NULL
;

203  &
suµÜ‹d_driv”s
[
±r
].
cÚfig
;

204 
	}
}

	@drivers/sound/dev_table.h

32 #iâdeà
_DEV_TABLE_H_


33 
	#_DEV_TABLE_H_


	)

43 
	sÿrd_šfo
 {

44 
	mÿrd_ty³
;

45 *
	mÇme
;

46 (*
	m©ch
è(
	mmem_¡¬t
, 
add»ss_šfo
 *
	mhw_cÚfig
);

47 (*
	m´obe
è(
add»ss_šfo
 *
	mhw_cÚfig
);

48 
add»ss_šfo
 
	mcÚfig
;

49 
	m’abËd
;

54 
	sg’”ic_midi_šfo
{

55 *
	mÇme
;

56 (*
	m©ch
è(
	mmem_¡¬t
);

59 
	saudio_İ”©iÚs
 {

60 
	mÇme
[32];

61 (*
	mİ’
è(
	mdev
, 
	mmode
);

62 (*
	mşo£
è(
	mdev
);

63 (*
	mouut_block
è(
	mdev
, 
	mbuf
,

64 
	mcouÁ
, 
	mšŒæag
, 
	mdma_»¡¬t
);

65 (*
	m¡¬t_šput
è(
	mdev
, 
	mbuf
,

66 
	mcouÁ
, 
	mšŒæag
, 
	mdma_»¡¬t
);

67 (*
	mioùl
è(
	mdev
, 
	mcmd
, 
	m¬g
, 
	mloÿl
);

68 (*
	m´•¬e_fÜ_šput
è(
	mdev
, 
	mbufsize
, 
	mnbufs
);

69 (*
	m´•¬e_fÜ_ouut
è(
	mdev
, 
	mbufsize
, 
	mnbufs
);

70 (*
	m»£t
è(
	mdev
);

71 (*
	mh®t_xãr
è(
	mdev
);

72 (*
	mhas_ouut_d¿šed
)(
	mdev
);

73 (*
	mcİy_äom_u£r
)(
	mdev
, *
	mloÿlbuf
, 
	mloÿloffs
,

74 
¢d_rw_buf
 *
	mu£rbuf
, 
	mu£roffs
, 
	mËn
);

77 
	smix”_İ”©iÚs
 {

78 (*
	mioùl
è(
	mdev
, 
	mcmd
, 
	m¬g
);

81 
	ssyÁh_İ”©iÚs
 {

82 
syÁh_šfo
 *
	mšfo
;

83 
	msyÁh_ty³
;

84 
	msyÁh_subty³
;

86 (*
	mİ’
è(
	mdev
, 
	mmode
);

87 (*
	mşo£
è(
	mdev
);

88 (*
	mioùl
è(
	mdev
, 
	mcmd
, 
	m¬g
);

89 (*
	mkl_nÙe
è(
	mdev
, 
	mvoiû
, 
	mv–oc™y
);

90 (*
	m¡¬t_nÙe
è(
	mdev
, 
	mvoiû
, 
	mnÙe
, 
	mv–oc™y
);

91 (*
	m£t_š¡r
è(
	mdev
, 
	mvoiû
, 
	mš¡r
);

92 (*
	m»£t
è(
	mdev
);

93 (*
	mhw_cÚŒŞ
è(
	mdev
, *
	mev’t
);

94 (*
	mlßd_·tch
è(
	mdev
, 
	mfÜm©
, 
¢d_rw_buf
 *
	maddr
,

95 
	moffs
, 
	mcouÁ
, 
	mpmgr_æag
);

96 (*
	maá”touch
è(
	mdev
, 
	mvoiû
, 
	m´essu»
);

97 (*
	mcÚŒŞËr
è(
	mdev
, 
	mvoiû
, 
	mù¾_num
, 
	mv®ue
);

98 (*
	m·Âšg
è(
	mdev
, 
	mvoiû
, 
	mv®ue
);

99 (*
	mpmgr_š‹rçû
è(
	mdev
, 
·tmgr_šfo
 *
	mšfo
);

102 
	smidi_İ”©iÚs
 {

103 
midi_šfo
 
	mšfo
;

104 (*
	mİ’
è(
	mdev
, 
	mmode
,

105 (*
	mšputšŒ
)(
	mdev
, 
	md©a
),

106 (*
	mouutšŒ
)(
	mdev
)

108 (*
	mşo£
è(
	mdev
);

109 (*
	mioùl
è(
	mdev
, 
	mcmd
, 
	m¬g
);

110 (*
	mputc
è(
	mdev
, 
	md©a
);

111 (*
	m¡¬t_»ad
è(
	mdev
);

112 (*
	m’d_»ad
è(
	mdev
);

113 (*
	mkick
)(
	mdev
);

114 (*
	mcommªd
è(
	mdev
, 
	md©a
);

115 (*
	mbufãr_¡©us
è(
	mdev
);

120 
	sg’”ic_midi_İ”©iÚs
 {

121 
midi_šfo
 
	mšfo
;

122 (*
	mİ’
è(
	mdev
, 
	mmode
);

123 (*
	mşo£
è(
	mdev
);

124 (*
	mwr™e
è(
	mdev
, 
¢d_rw_buf
 *
	md©a
);

125 (*
	m»ad
è(
	mdev
, 
¢d_rw_buf
 *
	md©a
);

128 #iâdeà
ALL_EXTERNAL_TO_ME


130 #ifdeà
_MIDI_TABLE_C_


133 
g’”ic_midi_İ”©iÚs
 * 
	gg’”ic_midi_devs
[
MAX_MIDI_DEV
] = {
NULL
};

134 
	gnum_g’”ic_midis
 = 0, 
	g´o_midi_dev
 = 0;

136 
g’”ic_midi_šfo
 
	gmidi_suµÜ‹d
[] = {

138 #iâdeà
EXCLUDE_PRO_MIDI


139 {"ProAudioS³ùrum MV101",
´o_midi_©ch
}

143 
	gnum_midi_driv”s
 =

144  (
midi_suµÜ‹d
è/ (
g’”ic_midi_šfo
);

149 #ifdeà
_DEV_TABLE_C_


150 
audio_İ”©iÚs
 * 
	gd¥_devs
[
MAX_DSP_DEV
] = {
NULL
}; 
	gnum_d¥devs
 = 0;

151 
mix”_İ”©iÚs
 * 
	gmix”_devs
[
MAX_MIXER_DEV
] = {
NULL
}; 
	gnum_mix”s
 = 0;

152 
syÁh_İ”©iÚs
 * 
	gsyÁh_devs
[
MAX_SYNTH_DEV
] = {
NULL
}; 
	gnum_syÁhs
 = 0;

153 
midi_İ”©iÚs
 * 
	gmidi_devs
[
MAX_MIDI_DEV
] = {
NULL
}; 
	gnum_midis
 = 0;

156 #iâdeà
EXCLUDE_MPU401


157 
	gmpu401_dev
 = 0;

164 
ÿrd_šfo
 
	gsuµÜ‹d_driv”s
[] = {

165 #ià!
defšed
(
EXCLUDE_MPU401
è&& !defšed(
EXCLUDE_MIDI
)

166 {
SNDCARD_MPU401
,"RŞªd MPU-401", 
©ch_mpu401
, 
´obe_mpu401
,

167 {
MPU_BASE
, 
MPU_IRQ
, 0}, 
SND_DEFAULT_ENABLE
},

170 #iâdeà
EXCLUDE_PAS


171 {
SNDCARD_PAS
, "ProAudioS³ùrum", 
©ch_·s_ÿrd
, 
´obe_·s
,

172 {
PAS_BASE
, 
PAS_IRQ
, 
PAS_DMA
}, 
SND_DEFAULT_ENABLE
},

175 #iâdeà
EXCLUDE_SB


176 {
SNDCARD_SB
, "SoundBÏ¡”", 
©ch_sb_ÿrd
, 
´obe_sb
,

177 {
SBC_BASE
, 
SBC_IRQ
, 
SBC_DMA
}, 
SND_DEFAULT_ENABLE
},

180 #ià!
defšed
(
EXCLUDE_SB
è&& !defšed(
EXCLUDE_SB16
)

181 #iâdeà
EXCLUDE_AUDIO


182 {
SNDCARD_SB16
, "SoundBÏ¡”16", 
sb16_d¥_š™
, 
sb16_d¥_d‘eù
,

183 {
SBC_BASE
, 
SBC_IRQ
, 
SB16_DMA
}, 
SND_DEFAULT_ENABLE
},

185 #iâdeà
EXCLUDE_MIDI


186 {
SNDCARD_SB16MIDI
,"SB16 MPU-401", 
©ch_sb16midi
, 
´obe_sb16midi
,

187 {
SB16MIDI_BASE
, 
SBC_IRQ
, 0}, 
SND_DEFAULT_ENABLE
},

191 #iâdeà
EXCLUDE_GUS


192 {
SNDCARD_GUS
, "G¿vi UÉ¿sound", 
©ch_gus_ÿrd
, 
´obe_gus
,

193 {
GUS_BASE
, 
GUS_IRQ
, 
GUS_DMA
}, 
SND_DEFAULT_ENABLE
},

196 #iâdeà
EXCLUDE_YM3812


197 {
SNDCARD_ADLIB
, "AdLib", 
©ch_adlib_ÿrd
, 
´obe_adlib
,

198 {
FM_MONO
, 0, 0}, 
SND_DEFAULT_ENABLE
},

200 {0, "*?*", 
NULL
, 0}

203 
	gnum_sound_driv”s
 =

204 (
suµÜ‹d_driv”s
è/  (
ÿrd_šfo
);

207 #iâdeà
EXCLUDE_AUDIO


208 
	gsound_buffcouÁs
[
MAX_DSP_DEV
] = {0};

209 
	gsound_buffsizes
[
MAX_DSP_DEV
] = {0};

210 
	gsound_d¥_dmachª
[
MAX_DSP_DEV
] = {0};

211 
	gsound_dma_automode
[
MAX_DSP_DEV
] = {0};

214 
audio_İ”©iÚs
 * 
d¥_devs
[
MAX_DSP_DEV
]; 
	gnum_d¥devs
;

215 
mix”_İ”©iÚs
 * 
mix”_devs
[
MAX_MIXER_DEV
]; 
num_mix”s
;

216 
syÁh_İ”©iÚs
 * 
syÁh_devs
[
MAX_SYNTH_DEV
]; 
num_syÁhs
;

217 
midi_İ”©iÚs
 * 
midi_devs
[
MAX_MIDI_DEV
]; 
num_midis
;

218 #iâdeà
EXCLUDE_MPU401


219 
mpu401_dev
;

222 
ÿrd_šfo
 
suµÜ‹d_driv”s
[];

223 
num_sound_driv”s
;

225 #iâdeà
EXCLUDE_AUDIO


226 
sound_buffcouÁs
[
MAX_DSP_DEV
];

227 
sound_buffsizes
[
MAX_DSP_DEV
];

228 
sound_d¥_dmachª
[
MAX_DSP_DEV
];

229 
sound_dma_automode
[
MAX_DSP_DEV
];

234 
¢dbË_š™
(
mem_¡¬t
);

235 
¢dbË_g‘_ÿrdcouÁ
 ();

236 
CMIDI_š™
(
mem_¡¬t
);

237 
add»ss_šfo
 *
sound_g‘cÚf
(
ÿrd_ty³
);

238 
sound_chcÚf
(
ÿrd_ty³
, 
ißddr
, 
œq
, 
dma
);

245 #ifdeà
ALL_EXTERNAL_TO_ME


247 
audio_İ”©iÚs
 * 
d¥_devs
[
MAX_DSP_DEV
]; 
	gnum_d¥devs
;

248 
mix”_İ”©iÚs
 * 
mix”_devs
[
MAX_MIXER_DEV
]; 
num_mix”s
;

249 
syÁh_İ”©iÚs
 * 
syÁh_devs
[
MAX_SYNTH_DEV
]; 
num_syÁhs
;

250 
midi_İ”©iÚs
 * 
midi_devs
[
MAX_MIDI_DEV
]; 
num_midis
;

251 
g’”ic_midi_İ”©iÚs
 *
g’”ic_midi_devs
[];

252 
num_g’”ic_midis
, 
´o_midi_dev
;

254 #iâdeà
EXCLUDE_MPU401


255 
mpu401_dev
;

258 
g’”ic_midi_šfo
 
midi_suµÜ‹d
[];

259 
ÿrd_šfo
 
suµÜ‹d_driv”s
[];

260 
num_sound_driv”s
;

261 
num_midi_driv”s
;

262 #iâdeà
EXCLUDE_AUDIO


263 
sound_buffcouÁs
[
MAX_DSP_DEV
];

264 
sound_buffsizes
[
MAX_DSP_DEV
];

265 
sound_d¥_dmachª
[
MAX_DSP_DEV
];

266 
sound_dma_automode
[
MAX_DSP_DEV
];

	@drivers/sound/dma.h

8 #iâdeà
_ASM_DMA_H


9 
	#_ASM_DMA_H


	)

11 
	~<asm/io.h
>

13 
	#deb_outb
(
x
,
y
è{
	`´štk
("ouˆ%02x, %02x\n", x, y);
	`outb
(x,y);}

	)

16 #ifdeà
HAVE_REALLY_SLOW_DMA_CONTROLLER


17 
	#outb
 
outb_p


	)

68 
	#MAX_DMA_CHANNELS
 8

	)

71 
	#IO_DMA1_BASE
 0x00

	)

72 
	#IO_DMA2_BASE
 0xC0

	)

75 
	#DMA1_CMD_REG
 0x08

	)

76 
	#DMA1_STAT_REG
 0x08

	)

77 
	#DMA1_REQ_REG
 0x09

	)

78 
	#DMA1_MASK_REG
 0x0A

	)

79 
	#DMA1_MODE_REG
 0x0B

	)

80 
	#DMA1_CLEAR_FF_REG
 0x0C

	)

81 
	#DMA1_TEMP_REG
 0x0D

	)

82 
	#DMA1_RESET_REG
 0x0D

	)

83 
	#DMA1_CLR_MASK_REG
 0x0E

	)

84 
	#DMA1_MASK_ALL_REG
 0x0F

	)

86 
	#DMA2_CMD_REG
 0xD0

	)

87 
	#DMA2_STAT_REG
 0xD0

	)

88 
	#DMA2_REQ_REG
 0xD2

	)

89 
	#DMA2_MASK_REG
 0xD4

	)

90 
	#DMA2_MODE_REG
 0xD6

	)

91 
	#DMA2_CLEAR_FF_REG
 0xD8

	)

92 
	#DMA2_TEMP_REG
 0xDA

	)

93 
	#DMA2_RESET_REG
 0xDA

	)

94 
	#DMA2_CLR_MASK_REG
 0xDC

	)

95 
	#DMA2_MASK_ALL_REG
 0xDE

	)

97 
	#DMA_ADDR_0
 0x00

	)

98 
	#DMA_ADDR_1
 0x02

	)

99 
	#DMA_ADDR_2
 0x04

	)

100 
	#DMA_ADDR_3
 0x06

	)

101 
	#DMA_ADDR_4
 0xC0

	)

102 
	#DMA_ADDR_5
 0xC4

	)

103 
	#DMA_ADDR_6
 0xC8

	)

104 
	#DMA_ADDR_7
 0xCC

	)

106 
	#DMA_CNT_0
 0x01

	)

107 
	#DMA_CNT_1
 0x03

	)

108 
	#DMA_CNT_2
 0x05

	)

109 
	#DMA_CNT_3
 0x07

	)

110 
	#DMA_CNT_4
 0xC2

	)

111 
	#DMA_CNT_5
 0xC6

	)

112 
	#DMA_CNT_6
 0xCA

	)

113 
	#DMA_CNT_7
 0xCE

	)

115 
	#DMA_PAGE_0
 0x87

	)

116 
	#DMA_PAGE_1
 0x83

	)

117 
	#DMA_PAGE_2
 0x81

	)

118 
	#DMA_PAGE_3
 0x82

	)

119 
	#DMA_PAGE_5
 0x8B

	)

120 
	#DMA_PAGE_6
 0x89

	)

121 
	#DMA_PAGE_7
 0x8A

	)

123 
	#DMA_MODE_READ
 0x44

	)

124 
	#DMA_MODE_WRITE
 0x48

	)

125 
	#DMA_MODE_CASCADE
 0xC0

	)

128 
__šlše__
 
	$’abË_dma
(
dmªr
)

130 ià(
dmªr
<=3)

131 
	`deb_outb
(
dmªr
, 
DMA1_MASK_REG
)

133 
	`deb_outb
(
dmªr
 & 3, 
DMA2_MASK_REG
);

134 
	}
}

136 
__šlše__
 
	$di§bË_dma
(
dmªr
)

138 ià(
dmªr
<=3)

139 
	`deb_outb
(
dmªr
 | 4, 
DMA1_MASK_REG
)

141 
	`deb_outb
((
dmªr
 & 3è| 4, 
DMA2_MASK_REG
);

142 
	}
}

151 
__šlše__
 
	$ş—r_dma_ff
(
dmªr
)

153 ià(
dmªr
<=3)

154 
	`deb_outb
(0, 
DMA1_CLEAR_FF_REG
)

156 
	`deb_outb
(0, 
DMA2_CLEAR_FF_REG
);

157 
	}
}

160 
__šlše__
 
	$£t_dma_mode
(
dmªr
, 
mode
)

162 ià(
dmªr
<=3)

163 
	`deb_outb
(
mode
 | 
dmªr
, 
DMA1_MODE_REG
)

165 
	`deb_outb
(
mode
 | (
dmªr
&3), 
DMA2_MODE_REG
);

166 
	}
}

173 
__šlše__
 
	$£t_dma_·ge
(
dmªr
, 
·g’r
)

175 
dmªr
) {

177 
	`deb_outb
(
·g’r
, 
DMA_PAGE_0
);

180 
	`deb_outb
(
·g’r
, 
DMA_PAGE_1
);

183 
	`deb_outb
(
·g’r
, 
DMA_PAGE_2
);

186 
	`deb_outb
(
·g’r
, 
DMA_PAGE_3
);

189 
	`deb_outb
(
·g’r
 & 0xã, 
DMA_PAGE_5
);

192 
	`deb_outb
(
·g’r
 & 0xã, 
DMA_PAGE_6
);

195 
	`deb_outb
(
·g’r
 & 0xã, 
DMA_PAGE_7
);

198 
	}
}

204 
__šlše__
 
	$£t_dma_addr
(
dmªr
, 
a
)

206 
	`£t_dma_·ge
(
dmªr
, 
a
>>16);

207 ià(
dmªr
 <= 3) {

208 
	`deb_outb
Ğ
a
 & 0xff, ((
dmªr
&3)<<1è+ 
IO_DMA1_BASE
 );

209 
	`deb_outb
Ğ(
a
>>8è& 0xff, ((
dmªr
&3)<<1è+ 
IO_DMA1_BASE
 )

211 
	`deb_outb
Ğ(
a
>>1è& 0xff, ((
dmªr
&3)<<2è+ 
IO_DMA2_BASE
 );

212 
	`deb_outb
Ğ(
a
>>9è& 0xff, ((
dmªr
&3)<<2è+ 
IO_DMA2_BASE
 );

214 
	}
}

225 
__šlše__
 
	$£t_dma_couÁ
(
dmªr
, 
couÁ
)

227 
couÁ
--;

228 ià(
dmªr
 <= 3) {

229 
	`deb_outb
Ğ
couÁ
 & 0xff, ((
dmªr
&3)<<1è+ 1 + 
IO_DMA1_BASE
 );

230 
	`deb_outb
Ğ(
couÁ
>>8è& 0xff, ((
dmªr
&3)<<1è+ 1 + 
IO_DMA1_BASE
 );

232 
	`deb_outb
Ğ(
couÁ
>>1è& 0xff, ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
 );

233 
	`deb_outb
Ğ(
couÁ
>>9è& 0xff, ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
 );

235 
	}
}

246 
__šlše__
 
	$g‘_dma_»sidue
(
dmªr
)

248 
io_pÜt
 = (
dmªr
<=3)? ((dmªr&3)<<1è+ 1 + 
IO_DMA1_BASE


249 : ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
;

252 
couÁ
;

254 
couÁ
 = 1 + 
	`šb
(
io_pÜt
);

255 
couÁ
 +ğ
	`šb
(
io_pÜt
) << 8;

257  (
dmªr
<=3)? 
couÁ
 : (count<<1);

258 
	}
}

262 
»que¡_dma
(
dmªr
);

263 
ä“_dma
(
dmªr
);

	@drivers/sound/dmabuf.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


34 
	~"sound_ÿÎs.h
"

36 #ià!
defšed
(
EXCLUDE_AUDIO
è|| !defšed(
EXCLUDE_GUS
)

38 
	#MAX_SUB_BUFFERS
 (32*
MAX_REALTIME_FACTOR
)

	)

48 
	#DMODE_NONE
 0

	)

49 
	#DMODE_OUTPUT
 1

	)

50 
	#DMODE_INPUT
 2

	)

52 
DEFINE_WAIT_QUEUES
 (
dev_¦“³r
[
MAX_DSP_DEV
], 
dev_¦“p_æag
[MAX_DSP_DEV]);

54 
	gdma_mode
[
MAX_DSP_DEV
] =

57 vŞ©
	gdmabuf_š‹¼u±ed
[
MAX_DSP_DEV
] =

64 *
	g¢d_¿w_buf
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
] =

66 {
NULL
}};

67 
	g¢d_¿w_buf_phys
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
];

68 
	g¢d_¿w_couÁ
[
MAX_DSP_DEV
];

74 
	gdev_busy
[
MAX_DSP_DEV
];

75 
	gdev_Ãeds_»¡¬t
[
MAX_DSP_DEV
];

76 
	gdev_modes
[
MAX_DSP_DEV
];

77 
	gdev_aùive
[
MAX_DSP_DEV
];

78 
	gdev_¡¬‹d
[
MAX_DSP_DEV
];

79 
	gdev_qËn
[
MAX_DSP_DEV
];

80 
	gdev_qh—d
[
MAX_DSP_DEV
];

81 
	gdev_q
[
MAX_DSP_DEV
];

82 
	gdev_und”run
[
MAX_DSP_DEV
];

83 
	gbufã¿Îoc_dÚe
[
MAX_DSP_DEV
] =

90 
	gdev_nbufs
[
MAX_DSP_DEV
];

92 
	gdev_couÁs
[
MAX_DSP_DEV
][
MAX_SUB_BUFFERS
];

93 
	gdev_subdivisiÚ
[
MAX_DSP_DEV
];

94 
	gdev_buf_phys
[
MAX_DSP_DEV
][
MAX_SUB_BUFFERS
];

95 *
	gdev_buf
[
MAX_DSP_DEV
][
MAX_SUB_BUFFERS
] =

96 {{
NULL
}};

97 
	gdev_buffsize
[
MAX_DSP_DEV
];

100 
	$»Ügªize_bufãrs
 (
dev
)

106 
i
, 
p
, 
n
;

107 
¤
, 
nc
, 
sz
, 
bsz
;

109 
¤
 = 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_READ_RATE
, 0, 1);

110 
nc
 = 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_READ_CHANNELS
, 0, 1);

111 
sz
 = 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_READ_BITS
, 0, 1);

113 ià(
¤
 < 1 || 
nc
 < 1 || 
sz
 < 1)

115 
	`´štk
 ("SOUND: Inv®id PCM…¬am‘”s[%d] sr=%d,‚c=%d, sz=%d\n", 
dev
, 
¤
, 
nc
, 
sz
);

116 
¤
 = 
DSP_DEFAULT_SPEED
;

117 
nc
 = 1;

118 
sz
 = 8;

121 
sz
 /= 8;

123 
sz
 = 
¤
 * 
nc
 * sz;

129 
bsz
 = 
sound_buffsizes
[
dev
];

131 
bsz
 > 
sz
)

132 
bsz
 >>= 1;

134 ià(
sound_buffcouÁs
[
dev
] =ğ1 && 
bsz
 =ğ
sound_buffsizes
[dev])

135 
bsz
 >>= 1;

137 ià(
dev_subdivisiÚ
[
dev
] == 0)

138 
dev_subdivisiÚ
[
dev
] = 1;

140 
bsz
 /ğ
dev_subdivisiÚ
[
dev
];

142 ià(
bsz
 == 0) bsz = 4096;

144 (
sound_buffsizes
[
dev
]*
sound_buffcouÁs
[dev])/
bsz
 > 
MAX_SUB_BUFFERS
)

145 
bsz
 <<= 1;

147 
dev_buffsize
[
dev
] = 
bsz
;

148 
n
 = 0;

154 
i
 = 0; i < 
¢d_¿w_couÁ
[
dev
]; i++)

156 
p
 = 0;

158 (
p
 + 
bsz
è<ğ
sound_buffsizes
[
dev
])

160 
dev_buf
[
dev
][
n
] = 
¢d_¿w_buf
[dev][
i
] + 
p
;

161 
dev_buf_phys
[
dev
][
n
] = 
¢d_¿w_buf_phys
[dev][
i
] + 
p
;

162 
p
 +ğ
bsz
;

163 
n
++;

167 
dev_nbufs
[
dev
] = 
n
;

169 
i
 = 0; i < 
dev_nbufs
[
dev
]; i++)

171 
dev_couÁs
[
dev
][
i
] = 0;

174 
bufã¿Îoc_dÚe
[
dev
] = 1;

175 
	}
}

178 
	$dma_š™_bufãrs
(
dev
)

180 
	`RESET_WAIT_QUEUE
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

181 
dev_und”run
[
dev
] = 0;

183 
dev_busy
[
dev
] = 1;

185 
bufã¿Îoc_dÚe
[
dev
] = 0;

187 
dev_aùive
[
dev
] = 
dev_qËn
[dev] = 
dev_q
[dev] = 
dev_qh—d
[dev] = 0;

188 
dev_Ãeds_»¡¬t
[
dev
] = 
dev_¡¬‹d
[dev] = 0;

189 
dma_mode
[
dev
] = 
DMODE_NONE
;

190 
	}
}

193 
	$DMAbuf_İ’
 (
dev
, 
mode
)

195 
»tv®
;

197 ià(
dev
 >ğ
num_d¥devs
)

199 
	`´štk
 ("PCM deviû %d‚Ù in¡®Ëd.\n", 
dev
);

200  
	`RET_ERROR
 (
ENXIO
);

203 ià(
dev_busy
[
dev
])

204  
	`RET_ERROR
 (
EBUSY
);

206 ià(!
d¥_devs
[
dev
])

208 
	`´štk
 ("DSP deviû %d‚Ù in™Ÿlized\n", 
dev
);

209  
	`RET_ERROR
 (
ENXIO
);

212 #ifdeà
USE_RUNTIME_DMAMEM


213 
	`sound_dma_m®loc
(
dev
);

216 ià(
¢d_¿w_buf
[
dev
][0] =ğ
NULL
)

217  
	`RET_ERROR
 (
ENOSPC
);

219 ià((
»tv®
 = 
d¥_devs
[
dev
]->
	`İ’
 (dev, 
mode
)) < 0)

220  
»tv®
;

222 
dev_modes
[
dev
] = 
mode
;

223 
dev_subdivisiÚ
[
dev
] = 0;

225 
	`dma_š™_bufãrs
(
dev
);

226 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_WRITE_BITS
, 8, 1);

227 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_WRITE_CHANNELS
, 1, 1);

228 
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
SOUND_PCM_WRITE_RATE
, 
DSP_DEFAULT_SPEED
, 1);

231 
	}
}

234 
	$dma_»£t
 (
dev
)

236 
»tv®
;

237 
æags
;

239 
	`DISABLE_INTR
(
æags
);

240 
d¥_devs
[
dev
]->
	`»£t
 (dev);

241 
d¥_devs
[
dev
]->
	`şo£
 (dev);

243 ià((
»tv®
 = 
d¥_devs
[
dev
]->
	`İ’
 (dev, 
dev_modes
[dev])) < 0)

244 
	`´štk
("Sound: Reset failed - Can't„eopen device\n");

245 
	`RESTORE_INTR
(
æags
);

247 
	`dma_š™_bufãrs
(
dev
);

248 
	`»Ügªize_bufãrs
(
dev
);

249 
	}
}

252 
	$dma_sync
 (
dev
)

254 
æags
;

255 
time
;

256 
timed_out
;

258 ià(
dma_mode
[
dev
] =ğ
DMODE_OUTPUT
)

260 
	`DISABLE_INTR
 (
æags
);

262 
timed_out
 = 0;

263 
time
 = 
	`GET_TIME
 ();

265 (!(
	`PROCESS_ABORTING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]) ||

266 
dmabuf_š‹¼u±ed
[
dev
]è&& !
timed_out
)

267 && 
dev_qËn
[
dev
])

269 
	`DO_SLEEP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev], 10 * 
HZ
);

270 ià((
	`GET_TIME
 (è- 
time
è> (10 * 
HZ
))

271 
timed_out
 = 1;

273 
	`RESTORE_INTR
 (
æags
);

280 
	`DISABLE_INTR
 (
æags
);

281 ià(
d¥_devs
[
dev
]->
has_ouut_d¿šed
)

283 !(
	`PROCESS_ABORTING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]) ||

284 
dmabuf_š‹¼u±ed
[
dev
])

285 && !
d¥_devs
[
dev
]->
	`has_ouut_d¿šed
 (dev))

287 
	`DO_SLEEP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev], 
HZ
 / 4);

290 
	`RESTORE_INTR
 (
æags
);

292  
dev_qËn
[
dev
];

293 
	}
}

296 
	$DMAbuf_»Ëa£
 (
dev
, 
mode
)

299 ià(!(
	`PROCESS_ABORTING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]) ||

300 
dmabuf_š‹¼u±ed
[
dev
])

301 && (
dma_mode
[
dev
] =ğ
DMODE_OUTPUT
))

303 
	`dma_sync
 (
dev
);

306 #ifdeà
USE_RUNTIME_DMAMEM


307 
	`sound_dma_ä“
(
dev
);

310 
d¥_devs
[
dev
]->
	`»£t
 (dev);

312 
d¥_devs
[
dev
]->
	`şo£
 (dev);

314 
dma_mode
[
dev
] = 
DMODE_NONE
;

315 
dev_busy
[
dev
] = 0;

318 
	}
}

321 
	$DMAbuf_g‘rdbufãr
 (
dev
, **
buf
, *
Ën
)

323 
æags
;

324 
”r
 = 
EIO
;

326 
	`DISABLE_INTR
 (
æags
);

327 ià(!
dev_qËn
[
dev
])

329 ià(
dev_Ãeds_»¡¬t
[
dev
])

331 
	`dma_»£t
(
dev
);

332 
dev_Ãeds_»¡¬t
[
dev
] = 0;

335 ià(
dma_mode
[
dev
] =ğ
DMODE_OUTPUT
)

337 
	`dma_sync
(
dev
);

338 
	`dma_»£t
(
dev
);

339 
dma_mode
[
dev
] = 
DMODE_NONE
;

342 ià(!
bufã¿Îoc_dÚe
[
dev
])

343 
	`»Ügªize_bufãrs
 (
dev
);

345 ià(!
dma_mode
[
dev
])

347 
”r
;

349 ià((
”r
 = 
d¥_devs
[
dev
]->
	`´•¬e_fÜ_šput
 (dev,

350 
dev_buffsize
[
dev
], 
dev_nbufs
[dev])) < 0)

352 
	`RESTORE_INTR
 (
æags
);

353  
”r
;

355 
dma_mode
[
dev
] = 
DMODE_INPUT
;

358 ià(!
dev_aùive
[
dev
])

360 
d¥_devs
[
dev
]->
	`¡¬t_šput
 (dev, 
dev_buf_phys
[dev][
dev_q
[dev]],

361 
dev_buffsize
[
dev
], 0,

362 !
sound_dma_automode
[
dev
] ||

363 !
dev_¡¬‹d
[
dev
]);

364 
dev_aùive
[
dev
] = 1;

365 
dev_¡¬‹d
[
dev
] = 1;

369 
	`DO_SLEEP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev], 2 * 
HZ
);

370 ià(
	`TIMED_OUT
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]))

372 
	`´štk
 ("Sound: DMAimed out - IRQ/DRQ configƒrror?\n");

373 
”r
 = 
EIO
;

374 
	`SET_ABORT_FLAG
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

377 
”r
 = 
EINTR
;

379 
	`RESTORE_INTR
 (
æags
);

381 ià(!
dev_qËn
[
dev
])

382  
	`RET_ERROR
 (
”r
);

384 *
buf
 = &
dev_buf
[
dev
][
dev_qh—d
[dev]][
dev_couÁs
[dev][dev_qhead[dev]]];

385 *
Ën
 = 
dev_buffsize
[
dev
] - 
dev_couÁs
[dev][
dev_qh—d
[dev]];

387  
dev_qh—d
[
dev
];

388 
	}
}

391 
	$DMAbuf_rmch¬s
 (
dev
, 
buff_no
, 
c
)

393 
p
 = 
dev_couÁs
[
dev
][
dev_qh—d
[dev]] + 
c
;

395 ià(
p
 >ğ
dev_buffsize
[
dev
])

397 
dev_couÁs
[
dev
][
dev_qh—d
[dev]] = 0;

398 
dev_qËn
[
dev
]--;

399 
dev_qh—d
[
dev
] = (dev_qh—d[dev] + 1è% 
dev_nbufs
[dev];

402 
dev_couÁs
[
dev
][
dev_qh—d
[dev]] = 
p
;

405 
	}
}

408 
	$DMAbuf_»ad
 (
dev
, 
¢d_rw_buf
 * 
u£r_buf
, 
couÁ
)

410 *
dmabuf
;

411 
buff_no
, 
c
, 
”r
;

418 ià((
buff_no
 = 
	`DMAbuf_g‘rdbufãr
 (
dev
, &
dmabuf
, &
c
)) < 0)

419  
buff_no
;

421 ià(
c
 > 
couÁ
)

422 
c
 = 
couÁ
;

424 
	`COPY_TO_USER
 (
u£r_buf
, 0, 
dmabuf
, 
c
);

426 ià((
”r
 = 
	`DMAbuf_rmch¬s
 (
dev
, 
buff_no
, 
c
)) < 0)

427  
”r
;

428  
c
;

430 
	}
}

433 
	$DMAbuf_ioùl
 (
dev
, 
cmd
, 
¬g
, 
loÿl
)

435 
cmd
)

437 
SNDCTL_DSP_RESET
:

438 
	`dma_»£t
 (
dev
);

442 
SNDCTL_DSP_SYNC
:

443 
	`dma_sync
 (
dev
);

444 
	`dma_»£t
 (
dev
);

448 
SNDCTL_DSP_GETBLKSIZE
:

449 ià(!
bufã¿Îoc_dÚe
[
dev
])

450 
	`»Ügªize_bufãrs
 (
dev
);

452  
	`IOCTL_OUT
 (
¬g
, 
dev_buffsize
[
dev
]);

455 
SNDCTL_DSP_SUBDIVIDE
:

457 
çù
 = 
	`IOCTL_IN
(
¬g
);

459 ià(
çù
 == 0)

461 
çù
 = 
dev_subdivisiÚ
[
dev
];

462 ià(
çù
 == 0) fact = 1;

463  
	`IOCTL_OUT
(
¬g
, 
çù
);

466 ià(
dev_subdivisiÚ
[
dev
] != 0)

467  
	`RET_ERROR
(
EINVAL
);

469 ià(
çù
 > 
MAX_REALTIME_FACTOR
è 
	`RET_ERROR
(
EINVAL
);

471 ià(
çù
 != 1 && fact != 2 && fact != 4 && fact != 8 && fact !=16)

472  
	`RET_ERROR
(
EINVAL
);

474 
dev_subdivisiÚ
[
dev
] = 
çù
;

475  
	`IOCTL_OUT
(
¬g
, 
çù
);

480  
d¥_devs
[
dev
]->
	`ioùl
 (dev, 
cmd
, 
¬g
, 
loÿl
);

483  
	`RET_ERROR
 (
EIO
);

484 
	}
}

487 
	$DMAbuf_g‘wrbufãr
 (
dev
, **
buf
, *
size
)

489 
æags
;

490 
”r
 = 
EIO
;

492 ià(
dma_mode
[
dev
] =ğ
DMODE_INPUT
)

494 
	`dma_»£t
(
dev
);

495 
dma_mode
[
dev
] = 
DMODE_NONE
;

498 ià(
dev_Ãeds_»¡¬t
[
dev
])

500 
	`dma_sync
(
dev
);

501 
	`dma_»£t
(
dev
);

504 
dev_Ãeds_»¡¬t
[
dev
] = 0;

506 ià(!
bufã¿Îoc_dÚe
[
dev
])

507 
	`»Ügªize_bufãrs
 (
dev
);

509 ià(!
dma_mode
[
dev
])

511 
”r
;

513 
dma_mode
[
dev
] = 
DMODE_OUTPUT
;

514 ià((
”r
 = 
d¥_devs
[
dev
]->
	`´•¬e_fÜ_ouut
 (dev,

515 
dev_buffsize
[
dev
], 
dev_nbufs
[dev])) < 0)

516  
”r
;

520 
	`DISABLE_INTR
 (
æags
);

522 
	`RESET_WAIT_QUEUE
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

524 ià(
dev_qËn
[
dev
] =ğ
dev_nbufs
[dev])

526 ià(!
dev_aùive
[
dev
])

528 
	`´štk
 ("Soundcard warning: DMA‚ot‡ctivated %d/%d\n",

529 
dev_qËn
[
dev
], 
dev_nbufs
[dev]);

530  
	`RET_ERROR
 (
EIO
);

534 
	`DO_SLEEP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev], 2 * 
HZ
);

535 ià(
	`TIMED_OUT
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]))

537 
	`´štk
 ("Sound: DMAimed out - IRQ/DRQ configƒrror?\n");

538 
”r
 = 
EIO
;

539 
	`SET_ABORT_FLAG
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

541 ià(
	`PROCESS_ABORTING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]))

542 
”r
 = 
EINTR
;

544 
	`RESTORE_INTR
 (
æags
);

546 ià(
dev_qËn
[
dev
] =ğ
dev_nbufs
[dev])

547  
	`RET_ERROR
 (
”r
);

549 *
buf
 = 
dev_buf
[
dev
][
dev_q
[dev]];

550 *
size
 = 
dev_buffsize
[
dev
];

551 
dev_couÁs
[
dev
][
dev_q
[dev]] = 0;

553  
dev_q
[
dev
];

554 
	}
}

557 
	$DMAbuf_¡¬t_ouut
 (
dev
, 
buff_no
, 
l
)

559 ià(
buff_no
 !ğ
dev_q
[
dev
])

560 
	`´štk
 ("Soundÿrd w¬nšg: DMA bufãr ouˆoàsynø%d !ğ%d\n", 
buff_no
, 
dev_q
[
dev
]);

562 
dev_qËn
[
dev
]++;

564 
dev_couÁs
[
dev
][
dev_q
[dev]] = 
l
;

566 
dev_Ãeds_»¡¬t
[
dev
] = (
l
 !ğ
dev_buffsize
[dev]);

568 
dev_q
[
dev
] = (dev_q[dev] + 1è% 
dev_nbufs
[dev];

570 ià(!
dev_aùive
[
dev
])

572 
dev_aùive
[
dev
] = 1;

573 
d¥_devs
[
dev
]->
	`ouut_block
 (dev, 
dev_buf_phys
[dev][
dev_qh—d
[dev]],

574 
dev_couÁs
[
dev
][
dev_qh—d
[dev]], 0,

575 !
sound_dma_automode
[
dev
] || !
dev_¡¬‹d
[dev]);

576 
dev_¡¬‹d
[
dev
] = 1;

580 
	}
}

583 
	$DMAbuf_¡¬t_dma
 (
dev
, 
phy§ddr
, 
couÁ
, 
dma_mode
)

585 
chª
 = 
sound_d¥_dmachª
[
dev
];

586 
æags
;

597 ià(
sound_dma_automode
[
dev
])

600 #ifdeà
lšux


601 
	`DISABLE_INTR
 (
æags
);

602 
	`di§bË_dma
 (
chª
);

603 
	`ş—r_dma_ff
 (
chª
);

604 
	`£t_dma_mode
 (
chª
, 
dma_mode
 | 
DMA_AUTOINIT
);

605 
	`£t_dma_addr
 (
chª
, 
¢d_¿w_buf_phys
[
dev
][0]);

606 
	`£t_dma_couÁ
 (
chª
, 
sound_buffsizes
[
dev
]);

607 
	`’abË_dma
 (
chª
);

608 
	`RESTORE_INTR
 (
æags
);

611 #ifdeà
__386BSD__


612 
	`´štk
 ("sound: Inv®id DMA modfÜ deviû %d\n", 
dev
);

614 
	`i§_dma¡¬t
 ((
dma_mode
 =ğ
DMA_MODE_READ
è? 
B_READ
 : 
B_WRITE
,

615 
¢d_¿w_buf_phys
[
dev
][0],

616 
sound_buffsizes
[
dev
],

617 
chª
);

619 #ià
	`defšed
(
ISC
è|| defšed(
SCO
)

620 #iâdeà
DMAMODE_AUTO


621 
	`´štk
 ("sound: Inv®id DMA modfÜ deviû %d\n", 
dev
);

623 
	`dma_·¿m
 (
chª
, ((
dma_mode
 =ğ
DMA_MODE_READ
è? 
DMA_Rdmode
 : 
DMA_Wrmode
)

624 #ifdeà
DMAMODE_AUTO


625 | 
DMAMODE_AUTO


628 
¢d_¿w_buf_phys
[
dev
][0], 
couÁ
);

629 
	`dma_’abË
 (
chª
);

631 #”rÜ 
This
 
routše
 
is
 
nÙ
 
v®id
 
this
 
OS
.

639 #ifdeà
lšux


640 
	`DISABLE_INTR
 (
æags
);

641 
	`di§bË_dma
 (
chª
);

642 
	`ş—r_dma_ff
 (
chª
);

643 
	`£t_dma_mode
 (
chª
, 
dma_mode
);

644 
	`£t_dma_addr
 (
chª
, 
phy§ddr
);

645 
	`£t_dma_couÁ
 (
chª
, 
couÁ
);

646 
	`’abË_dma
 (
chª
);

647 
	`RESTORE_INTR
 (
æags
);

649 #ifdeà
__386BSD__


650 
	`i§_dma¡¬t
 ((
dma_mode
 =ğ
DMA_MODE_READ
è? 
B_READ
 : 
B_WRITE
,

651 
phy§ddr
,

652 
couÁ
,

653 
chª
);

656 #ià
	`defšed
(
ISC
è|| defšed(
SCO
)

657 
	`dma_·¿m
 (
chª
, ((
dma_mode
 =ğ
DMA_MODE_READ
è? 
DMA_Rdmode
 : 
DMA_Wrmode
),

658 
phy§ddr
, 
couÁ
);

659 
	`dma_’abË
 (
chª
);

661 #”rÜ 
This
 
routše
 
is
 
nÙ
 
v®id
 
this
 
OS
.

668  
couÁ
;

669 
	}
}

672 
	$DMAbuf_š™
 (
mem_¡¬t
)

674 
i
;

681 
i
 = 0; i < 
MAX_DSP_DEV
; i++)

683 
dev_qËn
[
i
] = 0;

684 
dev_qh—d
[
i
] = 0;

685 
dev_q
[
i
] = 0;

686 
dev_aùive
[
i
] = 0;

687 
dev_busy
[
i
] = 0;

688 
bufã¿Îoc_dÚe
[
i
] = 0;

691  
mem_¡¬t
;

692 
	}
}

695 
	$DMAbuf_ouutšŒ
 (
dev
, 
und”run_æag
)

697 
æags
;

699 
dev_qËn
[
dev
]--;

700 
dev_qh—d
[
dev
] = (dev_qh—d[dev] + 1è% 
dev_nbufs
[dev];

701 
dev_aùive
[
dev
] = 0;

703 ià(
dev_qËn
[
dev
])

705 
d¥_devs
[
dev
]->
	`ouut_block
 (dev, 
dev_buf_phys
[dev][
dev_qh—d
[dev]],

706 
dev_couÁs
[
dev
][
dev_qh—d
[dev]], 1,

707 !
sound_dma_automode
[
dev
]);

708 
dev_aùive
[
dev
] = 1;

711 ià(
und”run_æag
)

713 
dev_und”run
[
dev
]++;

714 
d¥_devs
[
dev
]->
	`h®t_xãr
 (dev);

715 
dev_Ãeds_»¡¬t
[
dev
] = 1;

718 
	`DISABLE_INTR
 (
æags
);

719 ià(
	`SOMEONE_WAITING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]))

721 
	`WAKE_UP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

723 
	`RESTORE_INTR
 (
æags
);

724 
	}
}

727 
	$DMAbuf_šputšŒ
 (
dev
)

729 
æags
;

731 ià(!
dev_busy
[
dev
])

733 
d¥_devs
[
dev
]->
	`şo£
 (dev);

735 ià(
dev_qËn
[
dev
] =ğ(
dev_nbufs
[dev] - 1))

737 
	`´štk
("Sound: Recording overrun\n");

738 
dev_und”run
[
dev
]++;

739 
d¥_devs
[
dev
]->
	`h®t_xãr
 (dev);

740 
dev_aùive
[
dev
] = 0;

741 
dev_Ãeds_»¡¬t
[
dev
] = 1;

745 
dev_qËn
[
dev
]++;

746 
dev_q
[
dev
] = (dev_q[dev] + 1è% 
dev_nbufs
[dev];

748 
d¥_devs
[
dev
]->
	`¡¬t_šput
 (dev, 
dev_buf_phys
[dev][
dev_q
[dev]],

749 
dev_buffsize
[
dev
], 1,

750 !
sound_dma_automode
[
dev
]);

751 
dev_aùive
[
dev
] = 1;

754 
	`DISABLE_INTR
 (
æags
);

755 ià(
	`SOMEONE_WAITING
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]))

757 
	`WAKE_UP
 (
dev_¦“³r
[
dev
], 
dev_¦“p_æag
[dev]);

759 
	`RESTORE_INTR
 (
æags
);

760 
	}
}

763 
	$DMAbuf_İ’_dma
 (
dev
)

765 
æags
;

766 
chª
 = 
sound_d¥_dmachª
[
dev
];

768 ià(
	`ALLOC_DMA_CHN
 (
chª
))

770 
	`´štk
 ("UÇbËØg¿b DMA%d fÜhaudiØdriv”\n", 
chª
);

774 
	`DISABLE_INTR
 (
æags
);

775 #ifdeà
lšux


776 
	`di§bË_dma
 (
chª
);

777 
	`ş—r_dma_ff
 (
chª
);

779 
	`RESTORE_INTR
 (
æags
);

782 
	}
}

785 
	$DMAbuf_şo£_dma
 (
dev
)

787 
chª
 = 
sound_d¥_dmachª
[
dev
];

789 
	`DMAbuf_»£t_dma
 (
chª
);

790 
	`RELEASE_DMA_CHN
 (
chª
);

791 
	}
}

794 
	$DMAbuf_»£t_dma
 (
chª
)

796 
	}
}

810 
	$DMAbuf_İ’
 (
dev
, 
mode
)

812  
	`RET_ERROR
 (
ENXIO
);

813 
	}
}

816 
	$DMAbuf_»Ëa£
 (
dev
, 
mode
)

819 
	}
}

822 
	$DMAbuf_»ad
 (
dev
, 
¢d_rw_buf
 * 
u£r_buf
, 
couÁ
)

824  
	`RET_ERROR
 (
EIO
);

825 
	}
}

828 
	$DMAbuf_g‘wrbufãr
 (
dev
, **
buf
, *
size
)

830  
	`RET_ERROR
 (
EIO
);

831 
	}
}

834 
	$DMAbuf_g‘rdbufãr
 (
dev
, **
buf
, *
Ën
)

836  
	`RET_ERROR
 (
EIO
);

837 
	}
}

840 
	$DMAbuf_rmch¬s
 (
dev
, 
buff_no
, 
c
)

842  
	`RET_ERROR
 (
EIO
);

843 
	}
}

846 
	$DMAbuf_¡¬t_ouut
 (
dev
, 
buff_no
, 
l
)

848  
	`RET_ERROR
 (
EIO
);

849 
	}
}

852 
	$DMAbuf_ioùl
 (
dev
, 
cmd
, 
¬g
, 
loÿl
)

854  
	`RET_ERROR
 (
EIO
);

855 
	}
}

858 
	$DMAbuf_š™
 (
mem_¡¬t
)

860  
mem_¡¬t
;

861 
	}
}

864 
	$DMAbuf_¡¬t_dma
 (
dev
, 
phy§ddr
, 
couÁ
, 
dma_mode
)

866  
	`RET_ERROR
 (
EIO
);

867 
	}
}

870 
	$DMAbuf_İ’_dma
 (
chª
)

872  
	`RET_ERROR
 (
ENXIO
);

873 
	}
}

876 
	$DMAbuf_şo£_dma
 (
chª
)

879 
	}
}

882 
	$DMAbuf_»£t_dma
 (
chª
)

885 
	}
}

888 
	$DMAbuf_šputšŒ
 (
dev
)

891 
	}
}

894 
	$DMAbuf_ouutšŒ
 (
dev
, 
und”run_æag
)

897 
	}
}

	@drivers/sound/finetune.h

1 #ifdeà
SEQUENCER_C


28 
	gfš‘uÃ_bË
[128] =

48 
fš‘uÃ_bË
[128];

	@drivers/sound/gus_card.c

30 
	~"sound_cÚfig.h
"

32 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_GUS
)

34 
	~"gus_hw.h
"

36 
gusšŒ
 ();

38 
	ggus_ba£
, 
	ggus_œq
, 
	ggus_dma
;

41 
	$©ch_gus_ÿrd
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

43 
io_addr
;

45 
	`¢d_£t_œq_hªdËr
 (
hw_cÚfig
->
œq
, 
gusšŒ
);

47 ià(
	`gus_wave_d‘eù
 (
hw_cÚfig
->
io_ba£
))

49 
mem_¡¬t
 = 
	`gus_wave_š™
 (mem_¡¬t, 
hw_cÚfig
->
œq
, hw_cÚfig->
dma
);

50 #iâdeà
EXCLUDE_MIDI


51 
mem_¡¬t
 = 
	`gus_midi_š™
 (mem_start);

53  
mem_¡¬t
;

56 #iâdeà
EXCLUDE_GUS_IODETECT


62 
io_addr
 = 0x210; io_addr <= 0x260; io_addr += 0x10)

63 ià(
io_addr
 !ğ
hw_cÚfig
->
io_ba£
)

64 ià(
	`gus_wave_d‘eù
 (
io_addr
))

66 
	`´štk
 (" WARNING! GUS found‡ˆ%x, cÚfig wa %x ", 
io_addr
, 
hw_cÚfig
->
io_ba£
);

67 
mem_¡¬t
 = 
	`gus_wave_š™
 (mem_¡¬t, 
hw_cÚfig
->
œq
, hw_cÚfig->
dma
);

68 #iâdeà
EXCLUDE_MIDI


69 
mem_¡¬t
 = 
	`gus_midi_š™
 (mem_start);

71  
mem_¡¬t
;

76  
mem_¡¬t
;

77 
	}
}

80 
	$´obe_gus
 (
add»ss_šfo
 *
hw_cÚfig
)

82 
io_addr
;

84 ià(
	`gus_wave_d‘eù
 (
hw_cÚfig
->
io_ba£
))

87 #iâdeà
EXCLUDE_GUS_IODETECT


93 
io_addr
 = 0x210; io_addr <= 0x260; io_addr += 0x10)

94 ià(
io_addr
 !ğ
hw_cÚfig
->
io_ba£
)

95 ià(
	`gus_wave_d‘eù
 (
io_addr
))

101 
	}
}

104 
	$gusšŒ
 (
un™
)

106 
¤c
;

108 #ifdeà
lšux


109 
	`¡i
();

114 ià(!(
¤c
 = 
	`INB
 (
u_IrqStus
)))

117 ià(
¤c
 & 
DMA_TC_IRQ
)

119 
	`guswave_dma_œq
 ();

122 ià(
¤c
 & (
MIDI_TX_IRQ
 | 
MIDI_RX_IRQ
))

124 #iâdeà
EXCLUDE_MIDI


125 
	`gus_midi_š‹¼u±
 (0);

129 ià(
¤c
 & (
GF1_TIMER1_IRQ
 | 
GF1_TIMER2_IRQ
))

131 
	`´štk
 ("T");

132 
	`gus_wr™e8
 (0x45, 0);

135 ià(
¤c
 & (
WAVETABLE_IRQ
 | 
ENVELOPE_IRQ
))

137 
	`gus_voiû_œq
 ();

140 
	}
}

	@drivers/sound/gus_hw.h

6 
	#u_Ba£
 (
gus_ba£
 + 0x000)

	)

7 
	#u_Mix”
 
u_Ba£


	)

8 
	#u_Stus
 (
gus_ba£
 + 0x006)

	)

9 
	#u_Tim”CÚŒŞ
 (
gus_ba£
 + 0x008)

	)

10 
	#u_Tim”D©a
 (
gus_ba£
 + 0x009)

	)

11 
	#u_IRQDMACÚŒŞ
 (
gus_ba£
 + 0x00b)

	)

12 
	#u_MidiCÚŒŞ
 (
gus_ba£
 + 0x100)

	)

13 
	#MIDI_RESET
 0x03

	)

14 
	#MIDI_ENABLE_XMIT
 0x20

	)

15 
	#MIDI_ENABLE_RCV
 0x80

	)

16 
	#u_MidiStus
 
u_MidiCÚŒŞ


	)

17 
	#MIDI_RCV_FULL
 0x01

	)

18 
	#MIDI_XMIT_EMPTY
 0x02

	)

19 
	#MIDI_FRAME_ERR
 0x10

	)

20 
	#MIDI_OVERRUN
 0x20

	)

21 
	#MIDI_IRQ_PEND
 0x80

	)

22 
	#u_MidiD©a
 (
gus_ba£
 + 0x101)

	)

23 
	#u_Voiû
 (
gus_ba£
 + 0x102)

	)

24 
	#u_Commªd
 (
gus_ba£
 + 0x103)

	)

25 
	#u_D©aLo
 (
gus_ba£
 + 0x104)

	)

26 
	#u_D©aHi
 (
gus_ba£
 + 0x105)

	)

27 
	#u_IrqStus
 
u_Stus


	)

28 
	#MIDI_TX_IRQ
 0x01

	)

29 
	#MIDI_RX_IRQ
 0x02

	)

30 
	#GF1_TIMER1_IRQ
 0x04

	)

31 
	#GF1_TIMER2_IRQ
 0x08

	)

32 
	#WAVETABLE_IRQ
 0x20

	)

33 
	#ENVELOPE_IRQ
 0x40

	)

34 
	#DMA_TC_IRQ
 0x80

	)

35 
	#u_DRAMIO
 (
gus_ba£
 + 0x107)

	)

	@drivers/sound/gus_midi.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


34 
	~"gus_hw.h
"

36 #ià!
defšed
(
EXCLUDE_GUS
è&& !defšed(
EXCLUDE_MIDI
)

38 
	gmidi_busy
 = 0, 
	gšput_İ’ed
 = 0;

39 
	gmy_dev
;

40 
	gouut_u£d
 = 0;

41 vŞ©
	ggus_midi_cÚŒŞ
;

43 (*
midi_šput_šŒ
è(
dev
, 
d©a
);

45 
tmp_queue
[256];

46 vŞ©
qËn
;

47 vŞ©
qh—d
, 
q
;

48 
gus_ba£
, 
gus_œq
, 
gus_dma
;

50 
	#GUS_MIDI_STATUS
(è
	`INB
(
u_MidiStus
)

	)

53 
	`gus_midi_İ’
 (
dev
, 
mode
,

54 (*
šput
è(
dev
, 
d©a
),

55 (*
ouut
è(
dev
)

59 ià(
midi_busy
)

61 
	`´štk
 ("GUS: Midi busy\n");

62  
	`RET_ERROR
 (
EBUSY
);

65 
	`OUTB
 (
MIDI_RESET
, 
u_MidiCÚŒŞ
);

66 
	`gus_d–ay
 ();

68 
gus_midi_cÚŒŞ
 = 0;

69 
šput_İ’ed
 = 0;

71 ià(
mode
 =ğ
OPEN_READ
 || mod=ğ
OPEN_READWRITE
)

73 
gus_midi_cÚŒŞ
 |ğ
MIDI_ENABLE_RCV
;

74 
šput_İ’ed
 = 1;

77 ià(
mode
 =ğ
OPEN_WRITE
 || mod=ğ
OPEN_READWRITE
)

79 
gus_midi_cÚŒŞ
 |ğ
MIDI_ENABLE_XMIT
;

82 
	`OUTB
 (
gus_midi_cÚŒŞ
, 
u_MidiCÚŒŞ
);

84 
midi_busy
 = 1;

85 
qËn
 = 
qh—d
 = 
q
 = 
ouut_u£d
 = 0;

86 
midi_šput_šŒ
 = 
šput
;

89 
	}
}

92 
	$dump_to_midi
 (
midi_by‹
)

94 
æags
;

95 
ok
 = 0;

97 
ouut_u£d
 = 1;

99 
	`DISABLE_INTR
 (
æags
);

101 ià(
	`GUS_MIDI_STATUS
 (è& 
MIDI_XMIT_EMPTY
)

103 
ok
 = 1;

104 
	`OUTB
 (
midi_by‹
, 
u_MidiD©a
);

109 
gus_midi_cÚŒŞ
 |ğ
MIDI_ENABLE_XMIT
;

110 
	`OUTB
 (
gus_midi_cÚŒŞ
, 
u_MidiCÚŒŞ
);

113 
	`RESTORE_INTR
 (
æags
);

114  
ok
;

115 
	}
}

118 
	$gus_midi_şo£
 (
dev
)

122 
	`OUTB
 (
MIDI_RESET
, 
u_MidiCÚŒŞ
);

123 
midi_busy
 = 0;

124 
	}
}

127 
	$gus_midi_out
 (
dev
, 
midi_by‹
)

130 
æags
;

136 
	`DISABLE_INTR
 (
æags
);

138 
qËn
 && 
	`dump_to_midi
 (
tmp_queue
[
qh—d
]))

140 
qËn
--;

141 
qh—d
++;

144 
	`RESTORE_INTR
 (
æags
);

150 ià(!
qËn
)

151 ià(
	`dump_to_midi
 (
midi_by‹
))

158 ià(
qËn
 >= 256)

161 
	`DISABLE_INTR
 (
æags
);

163 
tmp_queue
[
q
] = 
midi_by‹
;

164 
qËn
++;

165 
q
++;

167 
	`RESTORE_INTR
 (
æags
);

170 
	}
}

173 
	$gus_midi_¡¬t_»ad
 (
dev
)

176 
	}
}

179 
	$gus_midi_’d_»ad
 (
dev
)

182 
	}
}

185 
	$gus_midi_ioùl
 (
dev
, 
cmd
, 
¬g
)

187  
	`RET_ERROR
 (
EINVAL
);

188 
	}
}

191 
	$gus_midi_kick
 (
dev
)

193 
	}
}

196 
	$gus_midi_bufãr_¡©us
 (
dev
)

198 
æags
;

200 ià(!
ouut_u£d
)

203 
	`DISABLE_INTR
 (
æags
);

205 ià(
qËn
 && 
	`dump_to_midi
 (
tmp_queue
[
qh—d
]))

207 
qËn
--;

208 
qh—d
++;

211 
	`RESTORE_INTR
 (
æags
);

213  (
qËn
 > 0è| !(
	`GUS_MIDI_STATUS
 (è& 
MIDI_XMIT_EMPTY
);

214 
	}
}

216 
midi_İ”©iÚs
 
	ggus_midi_İ”©iÚs
 =

218 {"G¿vi UÉ¿Sound", 0, 0, 
SNDCARD_GUS
},

219 
gus_midi_İ’
,

220 
gus_midi_şo£
,

221 
gus_midi_ioùl
,

222 
gus_midi_out
,

223 
gus_midi_¡¬t_»ad
,

224 
gus_midi_’d_»ad
,

225 
gus_midi_kick
,

226 
NULL
,

227 
gus_midi_bufãr_¡©us


231 
	$gus_midi_š™
 (
mem_¡¬t
)

233 
	`OUTB
 (
MIDI_RESET
, 
u_MidiCÚŒŞ
);

235 
my_dev
 = 
num_midis
;

236 
midi_devs
[
num_midis
++] = &
gus_midi_İ”©iÚs
;

237  
mem_¡¬t
;

238 
	}
}

241 
	$gus_midi_š‹¼u±
 (
dummy
)

243 
¡©
, 
d©a
;

244 
æags
;

246 
	`DISABLE_INTR
 (
æags
);

248 
¡©
 = 
	`GUS_MIDI_STATUS
 ();

250 ià(
¡©
 & 
MIDI_RCV_FULL
)

252 
d©a
 = 
	`INB
 (
u_MidiD©a
);

253 ià(
šput_İ’ed
)

254 
	`midi_šput_šŒ
 (
my_dev
, 
d©a
);

257 ià(
¡©
 & 
MIDI_XMIT_EMPTY
)

259 
qËn
 && 
	`dump_to_midi
 (
tmp_queue
[
qh—d
]))

261 
qËn
--;

262 
qh—d
++;

265 ià(!
qËn
)

268 
gus_midi_cÚŒŞ
 &ğ~
MIDI_ENABLE_XMIT
;

269 
	`OUTB
 (
gus_midi_cÚŒŞ
, 
u_MidiCÚŒŞ
);

273 ià(
¡©
 & 
MIDI_FRAME_ERR
)

274 
	`´štk
 ("Midi framingƒrror\n");

275 ià(
¡©
 & 
MIDI_OVERRUN
 && 
šput_İ’ed
)

276 
	`´štk
 ("GUS: Midi input overrun\n");

278 
	`RESTORE_INTR
 (
æags
);

279 
	}
}

	@drivers/sound/gus_vol.c

6 
	~"sound_cÚfig.h
"

7 #iâdeà
EXCLUDE_GUS


9 
	#GUS_VOLUME
 
gus_wave_vŞume


	)

12 
gus_wave_vŞume
;

29 
	$gus_adagio_vŞ
 (
v–
, 
mašv
, 
x²
, 
voiûv
)

31 
i
, 
m
, 
n
, 
x
;

39 
x
 = 256 + 6 * (
voiûv
 - 64);

44 ià(
voiûv
 > 65)

45 
x²
 +ğ
voiûv
 - 64;

46 
x²
 +ğ(
voiûv
 - 64) / 2;

51 
x
 = 
v–
 * 
x²
 * 6 + (
voiûv
 / 4) * x;

53 #ifdeà
GUS_VOLUME


58 
x
 = (x * 
GUS_VOLUME
 * GUS_VOLUME) / 10000;

61 #ifdeà
GUS_USE_CHN_MAIN_VOLUME


66 
mašv
 = (mainv / 2) + 64;

67 
x
 = (x * 
mašv
 * mainv) / 16384;

70 ià(
x
 < 2)

72 ià(
x
 >= 65535)

79 
n
 = 
x
;

80 
i
 = 7;

81 ià(
n
 < 128)

83 
i
 > 0 && 
n
 < (1 << i))

84 
i
--;

87 
n
 > 255)

89 
n
 >>= 1;

90 
i
++;

96 
m
 = 
x
 - (1 << 
i
);

101 ià(
m
 > 0)

103 ià(
i
 > 8)

104 
m
 >>ğ
i
 - 8;

105 ià(
i
 < 8)

106 
m
 <<ğ8 - 
i
;

109  ((
i
 << 8è+ 
m
);

110 
	}
}

	@drivers/sound/gus_wave.c

31 
	~"sound_cÚfig.h
"

32 
	~<lšux/uÉ¿sound.h
>

33 
	~"gus_hw.h
"

35 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_GUS
)

37 
	#MAX_SAMPLE
 128

	)

38 
	#MAX_PATCH
 256

	)

40 
	svoiû_šfo


42 
	mÜig_äeq
;

43 
	mcu¼’t_äeq
;

44 
	mmode
;

45 
	mb’d”
;

46 
	mb’d”_¿nge
;

47 
	m·Âšg
;

48 
	mmidi_vŞume
;

49 
	mš™Ÿl_vŞume
;

50 
	mcu¼’t_vŞume
;

51 
	mloİ_œq_mode
, 
	mloİ_œq_·rm
;

52 
	#LMODE_FINISH
 1

	)

53 
	#LMODE_PCM
 2

	)

54 
	#LMODE_PCM_STOP
 3

	)

55 
	mvŞume_œq_mode
, 
	mvŞume_œq_·rm
;

56 
	#VMODE_HALT
 1

	)

57 
	#VMODE_ENVELOPE
 2

	)

58 
	#VMODE_START_NOTE
 3

	)

60 
	m’v_pha£
;

61 
	m’v_¿‹
[6];

62 
	m’v_off£t
[6];

67 
	mmaš_vŞ
, 
	mex´essiÚ_vŞ
, 
	m·tch_vŞ
;

70 
	mdev_³ndšg
, 
	mnÙe_³ndšg
, 
	mvŞume_³ndšg
, 
	m§m¶e_³ndšg
;

71 
	mkl_³ndšg
;

72 
	moff£t_³ndšg
;

76 
gus_ba£
;

77 
gus_œq
, 
gus_dma
;

78 *
¢d_¿w_buf
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
];

79 
¢d_¿w_buf_phys
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
];

80 
¢d_¿w_couÁ
[
MAX_DSP_DEV
];

81 
	ggus_mem_size
 = 0;

82 
	gä“_mem_±r
 = 0;

83 
	ggus_busy
 = 0;

84 
	gÄ_voiûs
 = 0;

85 
	ggus_devnum
 = 0;

86 
	gvŞume_ba£
, 
	gvŞume_sÿË
, 
	gvŞume_m‘hod
;

87 
	ggus_lše_vŞ
 = 100, 
	ggus_mic_vŞ
 = 0;

88 
	ggus_»cmask
 = 
SOUND_MASK_MIC
;

89 
	g»cÜdšg_aùive
 = 0;

91 
	#VOL_METHOD_ADAGIO
 1

	)

92 
	ggus_wave_vŞume
 = 60;

93 
	ggus_pcm_vŞume
 = 80;

94 
	gmix_image
 = 0x00;

100 
	gaùive_deviû
 = 0;

102 
	#GUS_DEV_WAVE
 1

	)

104 
	#GUS_DEV_PCM_DONE
 2

	)

106 
	#GUS_DEV_PCM_CONTINUE
 3

	)

110 
	ggus_§m¶šg_¥“d
;

111 
	ggus_§m¶šg_chªÃls
;

112 
	ggus_§m¶šg_b™s
;

114 
DEFINE_WAIT_QUEUE
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
);

119 
	#MAX_PCM_BUFFERS
 (32*
MAX_REALTIME_FACTOR
è

	)

125 
	gpcm_bsize
,

128 
	gpcm_nblk
,

131 
	gpcm_bªksize
;

135 
	gpcm_d©asize
[
MAX_PCM_BUFFERS
];

140 vŞ©
	gpcm_h—d
, 
	gpcm_
, 
	gpcm_qËn
;

145 vŞ©
	gpcm_aùive
;

146 
	gpcm_İ’ed
 = 0;

147 
	gpcm_cu¼’t_dev
;

148 
	gpcm_cu¼’t_block
;

149 
	gpcm_cu¼’t_buf
;

150 
	gpcm_cu¼’t_couÁ
;

151 
	gpcm_cu¼’t_šŒæag
;

153 
voiû_šfo
 
	gvoiûs
[32];

155 
	gäeq_div_bË
[] =

216 
·tch_šfo
 *
	g§m¶es
;

217 
	g§m¶e_±rs
[
MAX_SAMPLE
 + 1];

218 
	g§m¶e_m­
[32];

219 
	gä“_§m¶e
;

222 
	g·tch_bË
[
MAX_PATCH
];

223 
	g·tch_m­
[32];

225 
syÁh_šfo
 
	ggus_šfo
 =

226 {"G¿vi UÉ¿Sound", 0, 
SYNTH_TYPE_SAMPLE
, 
SAMPLE_TYPE_GUS
, 0, 16, 0, 
MAX_PATCH
};

228 
gus_poke
 (
addr
, 
d©a
);

229 
compu‹_ªd_£t_vŞume
 (
voiû
, 
vŞume
, 
¿mp_time
);

230 
gus_adagio_vŞ
 (
v–
, 
mašv
, 
x²
, 
voiûv
);

231 
compu‹_vŞume
 (
voiû
, 
vŞume
);

232 
do_vŞume_œq
 (
voiû
);

233 
£t_šput_vŞumes
();

235 
	#INSTANT_RAMP
 -1

	)

237 
	#FAST_RAMP
 0

	)

241 
	$»£t_§m¶e_memÜy
 ()

243 
i
;

245 
i
 = 0; i <ğ
MAX_SAMPLE
; i++)

246 
§m¶e_±rs
[
i
] = -1;

247 
i
 = 0; i < 32; i++)

248 
§m¶e_m­
[
i
] = -1;

249 
i
 = 0; i < 32; i++)

250 
·tch_m­
[
i
] = -1;

252 
	`gus_poke
 (0, 0);

255 
	`gus_poke
 (1, 0);

257 
ä“_mem_±r
 = 2;

258 
ä“_§m¶e
 = 0;

260 
i
 = 0; i < 
MAX_PATCH
; i++)

261 
·tch_bË
[
i
] = -1;

262 
	}
}

265 
	$gus_d–ay
 ()

267 
i
;

269 
i
 = 0; i < 7; i++)

270 
	`INB
 (
u_DRAMIO
);

271 
	}
}

274 
	$gus_poke
 (
addr
, 
d©a
)

276 
æags
;

278 
	`DISABLE_INTR
 (
æags
);

279 
	`OUTB
 (0x43, 
u_Commªd
);

280 
	`OUTB
 (
addr
 & 0xff, 
u_D©aLo
);

281 
	`OUTB
 ((
addr
 >> 8è& 0xff, 
u_D©aHi
);

283 
	`OUTB
 (0x44, 
u_Commªd
);

284 
	`OUTB
 ((
addr
 >> 16è& 0xff, 
u_D©aHi
);

285 
	`OUTB
 (
d©a
, 
u_DRAMIO
);

286 
	`RESTORE_INTR
 (
æags
);

287 
	}
}

290 
	$gus_³ek
 (
addr
)

292 
æags
;

293 
tmp
;

295 
	`DISABLE_INTR
 (
æags
);

296 
	`OUTB
 (0x43, 
u_Commªd
);

297 
	`OUTB
 (
addr
 & 0xff, 
u_D©aLo
);

298 
	`OUTB
 ((
addr
 >> 8è& 0xff, 
u_D©aHi
);

300 
	`OUTB
 (0x44, 
u_Commªd
);

301 
	`OUTB
 ((
addr
 >> 16è& 0xff, 
u_D©aHi
);

302 
tmp
 = 
	`INB
 (
u_DRAMIO
);

303 
	`RESTORE_INTR
 (
æags
);

305  
tmp
;

306 
	}
}

309 
	$gus_wr™e8
 (
»g
, 
d©a
)

311 
æags
;

313 
	`DISABLE_INTR
 (
æags
);

315 
	`OUTB
 (
»g
, 
u_Commªd
);

316 
	`OUTB
 ((è(
d©a
 & 0xff), 
u_D©aHi
);

318 
	`RESTORE_INTR
 (
æags
);

319 
	}
}

322 
	$gus_»ad8
 (
»g
)

324 
æags
;

325 
v®
;

327 
	`DISABLE_INTR
 (
æags
);

328 
	`OUTB
 (
»g
 | 0x80, 
u_Commªd
);

329 
v®
 = 
	`INB
 (
u_D©aHi
);

330 
	`RESTORE_INTR
 (
æags
);

332  
v®
;

333 
	}
}

336 
	$gus_look8
 (
»g
)

338 
æags
;

339 
v®
;

341 
	`DISABLE_INTR
 (
æags
);

342 
	`OUTB
 (
»g
, 
u_Commªd
);

343 
v®
 = 
	`INB
 (
u_D©aHi
);

344 
	`RESTORE_INTR
 (
æags
);

346  
v®
;

347 
	}
}

350 
	$gus_wr™e16
 (
»g
, 
d©a
)

352 
æags
;

354 
	`DISABLE_INTR
 (
æags
);

356 
	`OUTB
 (
»g
, 
u_Commªd
);

358 
	`OUTB
 ((è(
d©a
 & 0xff), 
u_D©aLo
);

359 
	`OUTB
 ((è((
d©a
 >> 8è& 0xff), 
u_D©aHi
);

361 
	`RESTORE_INTR
 (
æags
);

362 
	}
}

365 
	$gus_»ad16
 (
»g
)

367 
æags
;

368 
hi
, 
lo
;

370 
	`DISABLE_INTR
 (
æags
);

372 
	`OUTB
 (
»g
 | 0x80, 
u_Commªd
);

374 
lo
 = 
	`INB
 (
u_D©aLo
);

375 
hi
 = 
	`INB
 (
u_D©aHi
);

377 
	`RESTORE_INTR
 (
æags
);

379  ((
hi
 << 8è& 0xff00è| 
lo
;

380 
	}
}

383 
	$gus_wr™e_addr
 (
»g
, 
add»ss
, 
is16b™
)

385 
hŞd_add»ss
;

387 ià(
is16b™
)

393 
hŞd_add»ss
 = 
add»ss
;

394 
add»ss
 =‡ddress >> 1;

395 
add»ss
 &= 0x0001ffffL;

396 
add»ss
 |ğ(
hŞd_add»ss
 & 0x000c0000L);

399 
	`gus_wr™e16
 (
»g
, (è((
add»ss
 >> 7) & 0xffff));

400 
	`gus_wr™e16
 (
»g
 + 1, (è((
add»ss
 << 9) & 0xffff));

401 
	}
}

404 
	$gus_£Ëù_voiû
 (
voiû
)

406 ià(
voiû
 < 0 || voice > 31)

409 
	`OUTB
 (
voiû
, 
u_Voiû
);

410 
	}
}

413 
	$gus_£Ëù_max_voiûs
 (
nvoiûs
)

415 ià(
nvoiûs
 < 14)

416 
nvoiûs
 = 14;

417 ià(
nvoiûs
 > 32)

418 
nvoiûs
 = 32;

420 
Ä_voiûs
 = 
nvoiûs
;

422 
	`gus_wr™e8
 (0x0e, (
nvoiûs
 - 1) | 0xc0);

423 
	}
}

426 
	$gus_voiû_Ú
 (
mode
)

428 
	`gus_wr™e8
 (0x00, (è(
mode
 & 0xfc));

429 
	`gus_d–ay
 ();

430 
	`gus_wr™e8
 (0x00, (è(
mode
 & 0xfc));

431 
	}
}

434 
	$gus_voiû_off
 ()

436 
	`gus_wr™e8
 (0x00, 
	`gus_»ad8
 (0x00) | 0x03);

437 
	}
}

440 
	$gus_voiû_mode
 (
m
)

442 
mode
 = (è(
m
 & 0xff);

444 
	`gus_wr™e8
 (0x00, (
	`gus_»ad8
 (0x00è& 0x03è| (
mode
 & 0xfc));

452 
	`gus_d–ay
 ();

453 
	`gus_wr™e8
 (0x00, (
	`gus_»ad8
 (0x00è& 0x03è| (
mode
 & 0xfc));

454 
	}
}

457 
	$gus_voiû_äeq
 (
äeq
)

459 
divisÜ
 = 
äeq_div_bË
[
Ä_voiûs
 - 14];

460 
fc
;

462 
fc
 = (è(((
äeq
 << 9è+ (
divisÜ
 >> 1)) / divisor);

463 
fc
 = fc << 1;

465 
	`gus_wr™e16
 (0x01, 
fc
);

466 
	}
}

469 
	$gus_voiû_vŞume
 (
vŞ
)

471 
	`gus_wr™e8
 (0x0d, 0x03);

474 
	`gus_wr™e16
 (0x09, (è(
vŞ
 << 4));

475 
	}
}

478 
	$gus_voiû_b®ªû
 (
b®ªû
)

480 
	`gus_wr™e8
 (0x0c, (è(
b®ªû
 & 0xff));

481 
	}
}

484 
	$gus_¿mp_¿nge
 (
low
, 
high
)

486 
	`gus_wr™e8
 (0x07, (è((
low
 >> 4) & 0xff));

487 
	`gus_wr™e8
 (0x08, (è((
high
 >> 4) & 0xff));

488 
	}
}

491 
	$gus_¿mp_¿‹
 (
sÿË
, 
¿‹
)

493 
	`gus_wr™e8
 (0x06, (è(((
sÿË
 & 0x03è<< 6è| (
¿‹
 & 0x3f)));

494 
	}
}

497 
	$gus_¿mpÚ
 (
m
)

499 
mode
 = (è(
m
 & 0xff);

501 
	`gus_wr™e8
 (0x0d, 
mode
 & 0xfc);

502 
	`gus_d–ay
 ();

503 
	`gus_wr™e8
 (0x0d, 
mode
 & 0xfc);

504 
	}
}

507 
	$gus_¿mp_mode
 (
m
)

509 
mode
 = (è(
m
 & 0xff);

511 
	`gus_wr™e8
 (0x0d, (
	`gus_»ad8
 (0x0dè& 0x03è| (
mode
 & 0xfc));

519 
	`gus_d–ay
 ();

520 
	`gus_wr™e8
 (0x0d, (
	`gus_»ad8
 (0x0dè& 0x03è| (
mode
 & 0xfc));

521 
	}
}

524 
	$gus_¿mpoff
 ()

526 
	`gus_wr™e8
 (0x0d, 0x03);

527 
	}
}

530 
	$gus_£t_voiû_pos
 (
voiû
, 
pos™iÚ
)

532 
§m¶e_no
;

534 ià((
§m¶e_no
 = 
§m¶e_m­
[
voiû
]) != -1)

535 ià(
pos™iÚ
 < 
§m¶es
[
§m¶e_no
].
Ën
)

536 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 =ğ
VMODE_START_NOTE
)

537 
voiûs
[
voiû
].
off£t_³ndšg
 = 
pos™iÚ
;

539 
	`gus_wr™e_addr
 (0x0a, 
§m¶e_±rs
[
§m¶e_no
] + 
pos™iÚ
,

540 
§m¶es
[
§m¶e_no
].
mode
 & 
WAVE_16_BITS
);

541 
	}
}

544 
	$gus_voiû_š™
 (
voiû
)

546 
æags
;

548 
	`DISABLE_INTR
 (
æags
);

549 
	`gus_£Ëù_voiû
 (
voiû
);

550 
	`gus_voiû_vŞume
 (0);

551 
	`gus_wr™e_addr
 (0x0a, 0, 0);

554 
	`gus_wr™e8
 (0x00, 0x03);

557 
	`gus_wr™e8
 (0x0d, 0x03);

560 
	`RESTORE_INTR
 (
æags
);

562 
	}
}

565 
	$gus_voiû_š™2
 (
voiû
)

567 
voiûs
[
voiû
].
·Âšg
 = 0;

568 
voiûs
[
voiû
].
mode
 = 0;

569 
voiûs
[
voiû
].
Üig_äeq
 = 20000;

570 
voiûs
[
voiû
].
cu¼’t_äeq
 = 20000;

571 
voiûs
[
voiû
].
b’d”
 = 0;

572 
voiûs
[
voiû
].
b’d”_¿nge
 = 200;

573 
voiûs
[
voiû
].
š™Ÿl_vŞume
 = 0;

574 
voiûs
[
voiû
].
cu¼’t_vŞume
 = 0;

575 
voiûs
[
voiû
].
loİ_œq_mode
 = 0;

576 
voiûs
[
voiû
].
loİ_œq_·rm
 = 0;

577 
voiûs
[
voiû
].
vŞume_œq_mode
 = 0;

578 
voiûs
[
voiû
].
vŞume_œq_·rm
 = 0;

579 
voiûs
[
voiû
].
’v_pha£
 = 0;

580 
voiûs
[
voiû
].
maš_vŞ
 = 127;

581 
voiûs
[
voiû
].
·tch_vŞ
 = 127;

582 
voiûs
[
voiû
].
ex´essiÚ_vŞ
 = 127;

583 
voiûs
[
voiû
].
§m¶e_³ndšg
 = -1;

584 
	}
}

587 
	$¡•_’v–İe
 (
voiû
)

589 
vŞ
, 
´ev_vŞ
, 
pha£
;

590 
¿‹
;

592 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_SUSTAIN_ON
 && voiûs[voiû].
’v_pha£
 == 2)

594 
	`gus_¿mpoff
 ();

600 ià(
voiûs
[
voiû
].
’v_pha£
 >= 5)

606 
	`gus_voiû_š™
 (
voiû
);

610 
´ev_vŞ
 = 
voiûs
[
voiû
].
cu¼’t_vŞume
;

611 
	`gus_voiû_vŞume
 (
´ev_vŞ
);

612 
pha£
 = ++
voiûs
[
voiû
].
’v_pha£
;

614 
	`compu‹_vŞume
 (
voiû
, 
voiûs
[voiû].
midi_vŞume
);

616 
vŞ
 = 
voiûs
[
voiû
].
š™Ÿl_vŞume
 * voiûs[voiû].
’v_off£t
[
pha£
] / 255;

617 
¿‹
 = 
voiûs
[
voiû
].
’v_¿‹
[
pha£
];

618 
	`gus_wr™e8
 (0x06, 
¿‹
);

622 
voiûs
[
voiû
].
vŞume_œq_mode
 = 
VMODE_ENVELOPE
;

624 ià(((
vŞ
 - 
´ev_vŞ
) / 64) == 0)

628 
	`¡•_’v–İe
 (
voiû
);

634 ià(
vŞ
 > 
´ev_vŞ
)

636 ià(
vŞ
 >= (4096 - 64))

637 
vŞ
 = 4096 - 65;

638 
	`gus_¿mp_¿nge
 (0, 
vŞ
);

639 
	`gus_¿mpÚ
 (0x20);

645 ià(
vŞ
 <= 64)

646 
vŞ
 = 65;

647 
	`gus_¿mp_¿nge
 (
vŞ
, 4030);

648 
	`gus_¿mpÚ
 (0x60);

652 
voiûs
[
voiû
].
cu¼’t_vŞume
 = 
vŞ
;

653 
	}
}

656 
	$š™_’v–İe
 (
voiû
)

658 
voiûs
[
voiû
].
’v_pha£
 = -1;

659 
voiûs
[
voiû
].
cu¼’t_vŞume
 = 64;

661 
	`¡•_’v–İe
 (
voiû
);

662 
	}
}

665 
	$¡¬t_»Ëa£
 (
voiû
)

667 ià(
	`gus_»ad8
 (0x00) & 0x03)

672 
voiûs
[
voiû
].
’v_pha£
 = 2;

676 
voiûs
[
voiû
].
cu¼’t_vŞume
 =

677 
voiûs
[
voiû
].
š™Ÿl_vŞume
 =

678 
	`gus_»ad16
 (0x09) >> 4;

682 
voiûs
[
voiû
].
mode
 &ğ~
WAVE_SUSTAIN_ON
;

683 
	`gus_¿mpoff
 ();

684 
	`¡•_’v–İe
 (
voiû
);

685 
	}
}

688 
	$gus_voiû_çde
 (
voiû
)

690 
š¡r_no
 = 
§m¶e_m­
[
voiû
], 
is16b™s
;

692 ià(
š¡r_no
 < 0 || in¡r_nØ> 
MAX_SAMPLE
)

694 
	`gus_wr™e8
 (0x00, 0x03);

700 
is16b™s
 = (
§m¶es
[
š¡r_no
].
mode
 & 
WAVE_16_BITS
) ? 1 : 0;

706 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

708 
	`¡¬t_»Ëa£
 (
voiû
);

715 ià((
	`gus_»ad16
 (0x09) >> 4) < 100)

719 
	`gus_voiû_off
 ();

720 
	`gus_¿mpoff
 ();

721 
	`gus_voiû_š™
 (
voiû
);

725 
	`gus_¿mp_¿nge
 (65, 4030);

726 
	`gus_¿mp_¿‹
 (2, 4);

727 
	`gus_¿mpÚ
 (0x40 | 0x20);

730 
voiûs
[
voiû
].
vŞume_œq_mode
 = 
VMODE_HALT
;

731 
	}
}

734 
	$gus_»£t
 ()

736 
i
;

738 
	`gus_£Ëù_max_voiûs
 (24);

739 
vŞume_ba£
 = 3071;

740 
vŞume_sÿË
 = 4;

741 
vŞume_m‘hod
 = 
VOL_METHOD_ADAGIO
;

743 
i
 = 0; i < 32; i++)

745 
	`gus_voiû_š™
 (
i
);

748 
	`gus_voiû_š™2
 (
i
);

751 
	`INB
 (
u_Stus
);

755 
	`gus_look8
 (0x41);

758 
	`gus_look8
 (0x49);

761 
	`gus_»ad8
 (0x0f);

765 
	}
}

768 
	$gus_š™Ÿlize
 ()

770 
æags
;

771 
dma_image
, 
œq_image
, 
tmp
;

773 
gus_œq_m­
[16] =

776 
gus_dma_m­
[8] =

779 
	`DISABLE_INTR
 (
æags
);

781 
	`gus_wr™e8
 (0x4c, 0);

784 
	`gus_d–ay
 ();

785 
	`gus_d–ay
 ();

787 
	`gus_wr™e8
 (0x4c, 1);

790 
	`gus_d–ay
 ();

791 
	`gus_d–ay
 ();

797 
	`gus_wr™e8
 (0x41, 0);

800 
	`gus_wr™e8
 (0x45, 0);

803 
	`gus_wr™e8
 (0x49, 0);

807 
	`gus_£Ëù_max_voiûs
 (24);

809 
	`INB
 (
u_Stus
);

813 
	`gus_look8
 (0x41);

816 
	`gus_look8
 (0x49);

819 
	`gus_»ad8
 (0x0f);

823 
	`gus_»£t
 ();

827 
	`gus_look8
 (0x41);

830 
	`gus_look8
 (0x49);

833 
	`gus_»ad8
 (0x0f);

837 
	`gus_wr™e8
 (0x4c, 7);

845 
	`OUTB
 (0x05, 
gus_ba£
 + 0x0f);

847 
mix_image
 |= 0x02;

850 
	`OUTB
 (
mix_image
, 
u_Mix”
);

852 
	`OUTB
 (0x00, 
u_IRQDMACÚŒŞ
);

854 
	`OUTB
 (0x00, 
gus_ba£
 + 0x0f);

866 
œq_image
 = 0;

867 
tmp
 = 
gus_œq_m­
[
gus_œq
];

868 ià(!
tmp
)

869 
	`´štk
 ("Warning! GUS IRQ‚ot selected\n");

870 
œq_image
 |ğ
tmp
;

871 
œq_image
 |= 0x40;

875 
dma_image
 = 0x40;

878 
tmp
 = 
gus_dma_m­
[
gus_dma
];

879 ià(!
tmp
)

880 
	`´štk
 ("Warning! GUS DMA‚ot selected\n");

881 
dma_image
 |ğ
tmp
;

891 
	`OUTB
 (
mix_image
, 
u_Mix”
);

894 
	`OUTB
 (
dma_image
 | 0x80, 
u_IRQDMACÚŒŞ
);

898 
	`OUTB
 (
mix_image
 | 0x40, 
u_Mix”
);

901 
	`OUTB
 (
œq_image
, 
u_IRQDMACÚŒŞ
);

909 
	`OUTB
 (
mix_image
, 
u_Mix”
);

912 
	`OUTB
 (
dma_image
, 
u_IRQDMACÚŒŞ
);

916 
	`OUTB
 (
mix_image
 | 0x40, 
u_Mix”
);

919 
	`OUTB
 (
œq_image
, 
u_IRQDMACÚŒŞ
);

923 
	`gus_£Ëù_voiû
 (0);

927 
mix_image
 &= ~0x02;

930 
mix_image
 |= 0x08;

933 
	`OUTB
 (
mix_image
, 
u_Mix”
);

938 
	`gus_£Ëù_voiû
 (0);

942 
	`gusšŒ
 (0);

945 
	`RESTORE_INTR
 (
æags
);

946 
	}
}

949 
	$gus_wave_d‘eù
 (
ba£addr
)

951 
i
;

952 
loc
;

954 
gus_ba£
 = 
ba£addr
;

956 
	`gus_wr™e8
 (0x4c, 0);

957 
	`gus_d–ay
 ();

958 
	`gus_d–ay
 ();

960 
	`gus_wr™e8
 (0x4c, 1);

961 
	`gus_d–ay
 ();

962 
	`gus_d–ay
 ();

965 
	`gus_poke
 (0L, 0xaa);

966 ià(
	`gus_³ek
 (0L) != 0xaa)

970 
	`gus_poke
 (0L, 0x00);

971 
i
 = 1L; i < 1024L; i++)

973 
n
, 
çed
;

976 ià(
	`gus_³ek
 (0L) != 0)

978 
loc
 = 
i
 << 10;

980 
n
 = 
loc
 - 1, 
çed
 = 0;‚ <=†oc;‚++)

982 
	`gus_poke
 (
loc
, 0xaa);

983 ià(
	`gus_³ek
 (
loc
) != 0xaa)

984 
çed
 = 1;

986 
	`gus_poke
 (
loc
, 0x55);

987 ià(
	`gus_³ek
 (
loc
) != 0x55)

988 
çed
 = 1;

991 ià(
çed
)

994 
gus_mem_size
 = 
i
 << 10;

996 
	}
}

999 
	$guswave_ioùl
 (
dev
,

1000 
cmd
, 
¬g
)

1003 
cmd
)

1005 
SNDCTL_SYNTH_INFO
:

1006 
gus_šfo
.
Ä_voiûs
 =‚r_voices;

1007 
	`IOCTL_TO_USER
 ((*è
¬g
, 0, &
gus_šfo
,  (gus_info));

1011 
SNDCTL_SEQ_RESETSAMPLES
:

1012 
	`»£t_§m¶e_memÜy
 ();

1016 
SNDCTL_SEQ_PERCMODE
:

1020 
SNDCTL_SYNTH_MEMAVL
:

1021  
gus_mem_size
 - 
ä“_mem_±r
 - 32;

1024  
	`RET_ERROR
 (
EINVAL
);

1026 
	}
}

1029 
	$guswave_£t_š¡r
 (
dev
, 
voiû
, 
š¡r_no
)

1031 
§m¶e_no
;

1033 ià(
š¡r_no
 < 0 || in¡r_nØ> 
MAX_PATCH
)

1034  
	`RET_ERROR
 (
EINVAL
);

1036 ià(
voiû
 < 0 || voice > 31)

1037  
	`RET_ERROR
 (
EINVAL
);

1039 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 =ğ
VMODE_START_NOTE
)

1041 
voiûs
[
voiû
].
§m¶e_³ndšg
 = 
š¡r_no
;

1045 
§m¶e_no
 = 
·tch_bË
[
š¡r_no
];

1046 
·tch_m­
[
voiû
] = -1;

1048 ià(
§m¶e_no
 < 0)

1050 
	`´štk
 ("GUS: Undefšed…©ch %d fÜ voiû %d\n", 
š¡r_no
, 
voiû
);

1051  
	`RET_ERROR
 (
EINVAL
);

1056 ià(
§m¶e_±rs
[
§m¶e_no
] == -1)

1060 
	`´štk
 ("GUS: Sam¶#%d‚Ù†ßded fÜ…©ch %d (voiû %d)\n", 
§m¶e_no
, 
š¡r_no
, 
voiû
);

1061  
	`RET_ERROR
 (
EINVAL
);

1064 
§m¶e_m­
[
voiû
] = 
§m¶e_no
;

1065 
·tch_m­
[
voiû
] = 
š¡r_no
;

1067 
	}
}

1070 #ifdeà
FUTURE_VERSION


1071 
	$guswave_kl_nÙe
 (
dev
, 
voiû
, 
nÙe
, 
v–oc™y
)

1073 
	$guswave_kl_nÙe
 (
dev
, 
voiû
, 
v–oc™y
)

1076 
æags
;

1078 
	`DISABLE_INTR
 (
æags
);

1079 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 =ğ
VMODE_START_NOTE
)

1080 
voiûs
[
voiû
].
kl_³ndšg
 = 1;

1083 
	`gus_£Ëù_voiû
 (
voiû
);

1084 
	`gus_voiû_çde
 (
voiû
);

1086 
	`RESTORE_INTR
 (
æags
);

1089 
	}
}

1092 
	$guswave_aá”touch
 (
dev
, 
voiû
, 
´essu»
)

1094 
lo_lim™
, 
hi_lim™
;

1095 
æags
;

1101 ià(
voiû
 < 0 || voice > 31)

1104 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
 && voiûs[voiû].
’v_pha£
 != 2)

1109 ià(
´essu»
 < 32)

1111 
	`DISABLE_INTR
 (
æags
);

1112 
	`gus_£Ëù_voiû
 (
voiû
);

1113 
	`gus_¿mpoff
 ();

1114 
	`compu‹_ªd_£t_vŞume
 (
voiû
, 255, 0);

1117 
	`RESTORE_INTR
 (
æags
);

1121 
hi_lim™
 = 
voiûs
[
voiû
].
cu¼’t_vŞume
;

1122 
lo_lim™
 = 
hi_lim™
 * 99 / 100;

1123 ià(
lo_lim™
 < 65)

1124 
lo_lim™
 = 65;

1126 
	`DISABLE_INTR
 (
æags
);

1127 
	`gus_£Ëù_voiû
 (
voiû
);

1128 ià(
hi_lim™
 > (4095 - 65))

1130 
hi_lim™
 = 4095 - 65;

1131 
	`gus_voiû_vŞume
 (
hi_lim™
);

1133 
	`gus_¿mp_¿nge
 (
lo_lim™
, 
hi_lim™
);

1134 
	`gus_¿mp_¿‹
 (3, 8);

1135 
	`gus_¿mpÚ
 (0x58);

1138 
	`RESTORE_INTR
 (
æags
);

1139 
	}
}

1142 
	$guswave_·Âšg
 (
dev
, 
voiû
, 
v®ue
)

1144 ià(
voiû
 >= 0 || voice < 32)

1145 
voiûs
[
voiû
].
·Âšg
 = 
v®ue
;

1146 
	}
}

1149 
	$compu‹_vŞume
 (
voiû
, 
vŞume
)

1151 ià(
vŞume
 < 128)

1152 
voiûs
[
voiû
].
midi_vŞume
 = 
vŞume
;

1154 
vŞume_m‘hod
)

1156 
VOL_METHOD_ADAGIO
:

1157 
voiûs
[
voiû
].
š™Ÿl_vŞume
 =

1158 
	`gus_adagio_vŞ
 (
voiûs
[
voiû
].
midi_vŞume
, voiûs[voiû].
maš_vŞ
,

1159 
voiûs
[
voiû
].
ex´essiÚ_vŞ
,

1160 
voiûs
[
voiû
].
·tch_vŞ
);

1164 
voiûs
[
voiû
].
š™Ÿl_vŞume
 = 
vŞume_ba£
 +

1165 (
voiûs
[
voiû
].
midi_vŞume
 * 
vŞume_sÿË
);

1168 ià(
voiûs
[
voiû
].
š™Ÿl_vŞume
 > 4030)

1169 
voiûs
[
voiû
].
š™Ÿl_vŞume
 = 4030;

1170 
	}
}

1173 
	$compu‹_ªd_£t_vŞume
 (
voiû
, 
vŞume
, 
¿mp_time
)

1175 
cu¼’t
, 
rg‘
, 
¿‹
;

1176 
æags
;

1178 
	`DISABLE_INTR
 (
æags
);

1183 
	`gus_£Ëù_voiû
 (
voiû
);

1185 
	`compu‹_vŞume
 (
voiû
, 
vŞume
);

1186 
voiûs
[
voiû
].
cu¼’t_vŞume
 = voiûs[voiû].
š™Ÿl_vŞume
;

1188 
cu¼’t
 = 
	`gus_»ad16
 (0x09) >> 4;

1189 
rg‘
 = 
voiûs
[
voiû
].
š™Ÿl_vŞume
;

1191 ià(
¿mp_time
 =ğ
INSTANT_RAMP
)

1193 
	`gus_¿mpoff
 ();

1194 
	`gus_voiû_vŞume
 (
rg‘
);

1195 
	`RESTORE_INTR
 (
æags
);

1199 ià(
¿mp_time
 =ğ
FAST_RAMP
)

1200 
¿‹
 = 63;

1202 
¿‹
 = 16;

1203 
	`gus_¿mp_¿‹
 (0, 
¿‹
);

1205 ià((
rg‘
 - 
cu¼’t
) / 64 == 0)

1209 
	`gus_¿mpoff
 ();

1210 
	`gus_voiû_vŞume
 (
rg‘
);

1211 
	`RESTORE_INTR
 (
æags
);

1215 ià(
rg‘
 > 
cu¼’t
)

1217 ià(
rg‘
 > (4095 - 65))

1218 
rg‘
 = 4095 - 65;

1219 
	`gus_¿mp_¿nge
 (
cu¼’t
, 
rg‘
);

1220 
	`gus_¿mpÚ
 (0x00);

1226 ià(
rg‘
 < 65)

1227 
rg‘
 = 65;

1229 
	`gus_¿mp_¿nge
 (
rg‘
, 
cu¼’t
);

1230 
	`gus_¿mpÚ
 (0x40);

1234 
	`RESTORE_INTR
 (
æags
);

1235 
	}
}

1238 
	$dyÇmic_vŞume_chªge
 (
voiû
)

1240 
¡©us
;

1241 
æags
;

1243 
	`DISABLE_INTR
 (
æags
);

1244 
	`gus_£Ëù_voiû
 (
voiû
);

1245 
¡©us
 = 
	`gus_»ad8
 (0x00);

1248 
	`RESTORE_INTR
 (
æags
);

1250 ià(
¡©us
 & 0x03)

1255 ià(!(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
))

1257 
	`compu‹_ªd_£t_vŞume
 (
voiû
, 
voiûs
[voiû].
midi_vŞume
, 1);

1265 
	`DISABLE_INTR
 (
æags
);

1266 
	`gus_£Ëù_voiû
 (
voiû
);

1267 
¡©us
 = 
	`gus_»ad8
 (0x0d);

1270 
	`RESTORE_INTR
 (
æags
);

1272 ià(
¡©us
 & 0x03)

1276 
	`compu‹_ªd_£t_vŞume
 (
voiû
, 
voiûs
[voiû].
midi_vŞume
, 1);

1280 ià(
voiûs
[
voiû
].
’v_pha£
 < 0)

1283 
	`compu‹_vŞume
 (
voiû
, 
voiûs
[voiû].
midi_vŞume
);

1287 
voiûs
[
voiû
].
cu¼’t_vŞume
 =

1288 
	`gus_»ad16
 (0x09) >> 4;

1292 
voiûs
[
voiû
].
’v_pha£
--;

1293 
	`¡•_’v–İe
 (
voiû
);

1295 
	}
}

1298 
	$guswave_cÚŒŞËr
 (
dev
, 
voiû
, 
ù¾_num
, 
v®ue
)

1300 
æags
;

1301 
äeq
;

1303 ià(
voiû
 < 0 || voice > 31)

1306 
ù¾_num
)

1308 
CTRL_PITCH_BENDER
:

1309 
voiûs
[
voiû
].
b’d”
 = 
v®ue
;

1311 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 !ğ
VMODE_START_NOTE
)

1313 
äeq
 = 
	`compu‹_fš‘uÃ
 (
voiûs
[
voiû
].
Üig_äeq
, 
v®ue
, voiûs[voiû].
b’d”_¿nge
);

1314 
voiûs
[
voiû
].
cu¼’t_äeq
 = 
äeq
;

1316 
	`DISABLE_INTR
 (
æags
);

1317 
	`gus_£Ëù_voiû
 (
voiû
);

1318 
	`gus_voiû_äeq
 (
äeq
);

1319 
	`RESTORE_INTR
 (
æags
);

1323 
CTRL_PITCH_BENDER_RANGE
:

1324 
voiûs
[
voiû
].
b’d”_¿nge
 = 
v®ue
;

1326 #ifdeà
FUTURE_VERSION


1327 
CTL_EXPRESSION
:

1328 
v®ue
 /= 128;

1330 
CTRL_EXPRESSION
:

1331 
vŞume_m‘hod
 = 
VOL_METHOD_ADAGIO
;

1332 
voiûs
[
voiû
].
ex´essiÚ_vŞ
 = 
v®ue
;

1333 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 !ğ
VMODE_START_NOTE
)

1334 
	`dyÇmic_vŞume_chªge
 (
voiû
);

1337 #ifdeà
FUTURE_VERSION


1338 
CTL_PAN
:

1339 
voiûs
[
voiû
].
·Âšg
 = (
v®ue
 * 2) - 128;

1342 
CTL_MAIN_VOLUME
:

1343 
v®ue
 = (value * 100) / 16383;

1346 
CTRL_MAIN_VOLUME
:

1347 
vŞume_m‘hod
 = 
VOL_METHOD_ADAGIO
;

1348 
voiûs
[
voiû
].
maš_vŞ
 = 
v®ue
;

1349 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 !ğ
VMODE_START_NOTE
)

1350 
	`dyÇmic_vŞume_chªge
 (
voiû
);

1358 
	}
}

1361 
	$guswave_¡¬t_nÙe2
 (
dev
, 
voiû
, 
nÙe_num
, 
vŞume
)

1363 
§m¶e
, 
be¡_§m¶e
, 
be¡_d–
, 
d–_äeq
;

1364 
is16b™s
, 
§m¶•
, 
·tch
, 
·n
;

1365 
nÙe_äeq
, 
ba£_nÙe
, 
äeq
, 
æags
;

1366 
mode
 = 0;

1368 ià(
voiû
 < 0 || voice > 31)

1370 
	`´štk
 ("GUS: Invalid voice\n");

1371  
	`RET_ERROR
 (
EINVAL
);

1374 ià(
nÙe_num
 == 255)

1376 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

1378 
voiûs
[
voiû
].
midi_vŞume
 = 
vŞume
;

1379 
	`dyÇmic_vŞume_chªge
 (
voiû
);

1383 
	`compu‹_ªd_£t_vŞume
 (
voiû
, 
vŞume
, 1);

1387 ià((
·tch
 = 
·tch_m­
[
voiû
]) == -1)

1389  
	`RET_ERROR
 (
EINVAL
);

1392 ià((
§m¶•
 = 
·tch_bË
[
·tch
]) == -1)

1394  
	`RET_ERROR
 (
EINVAL
);

1397 
nÙe_äeq
 = 
	`nÙe_to_äeq
 (
nÙe_num
);

1403 
§m¶e
 = -1;

1405 
be¡_§m¶e
 = 
§m¶•
;

1406 
be¡_d–
 = 1000000;

1407 
§m¶•
 >ğ0 && 
§m¶e
 == -1)

1409 
d–_äeq
 = 
nÙe_äeq
 - 
§m¶es
[
§m¶•
].
ba£_nÙe
;

1410 ià(
d–_äeq
 < 0)

1411 
d–_äeq
 = -delta_freq;

1412 ià(
d–_äeq
 < 
be¡_d–
)

1414 
be¡_§m¶e
 = 
§m¶•
;

1415 
be¡_d–
 = 
d–_äeq
;

1417 ià(
§m¶es
[
§m¶•
].
low_nÙe
 <ğ
nÙe_äeq
 &&‚Ùe_äeq <ğ§m¶es[§m¶•].
high_nÙe
)

1418 
§m¶e
 = 
§m¶•
;

1420 
§m¶•
 = 
§m¶es
[§m¶•].
key
;

1424 ià(
§m¶e
 == -1)

1425 
§m¶e
 = 
be¡_§m¶e
;

1427 ià(
§m¶e
 == -1)

1429 
	`´štk
 ("GUS: P©ch %d‚Ù defšed fÜ‚Ù%d\n", 
·tch
, 
nÙe_num
);

1435 
is16b™s
 = (
§m¶es
[
§m¶e
].
mode
 & 
WAVE_16_BITS
) ? 1 : 0;

1440 
voiûs
[
voiû
].
mode
 = 
§m¶es
[
§m¶e
].mode;

1441 
voiûs
[
voiû
].
·tch_vŞ
 = 
§m¶es
[
§m¶e
].
vŞume
;

1443 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

1445 
i
;

1447 
i
 = 0; i < 6; i++)

1449 
voiûs
[
voiû
].
’v_¿‹
[
i
] = 
§m¶es
[
§m¶e
].env_rate[i];

1450 
voiûs
[
voiû
].
’v_off£t
[
i
] = 
§m¶es
[
§m¶e
].env_offset[i];

1454 
§m¶e_m­
[
voiû
] = 
§m¶e
;

1456 
ba£_nÙe
 = 
§m¶es
[
§m¶e
].base_note / 100;

1459 
nÙe_äeq
 /= 100;

1461 
äeq
 = 
§m¶es
[
§m¶e
].
ba£_äeq
 * 
nÙe_äeq
 / 
ba£_nÙe
;

1463 
voiûs
[
voiû
].
Üig_äeq
 = 
äeq
;

1470 
äeq
 = 
	`compu‹_fš‘uÃ
 (
voiûs
[
voiû
].
Üig_äeq
, voiûs[voiû].
b’d”
, voiûs[voiû].
b’d”_¿nge
);

1471 
voiûs
[
voiû
].
cu¼’t_äeq
 = 
äeq
;

1473 
·n
 = (
§m¶es
[
§m¶e
].
·Âšg
 + 
voiûs
[
voiû
].panning) / 32;

1474 
·n
 += 7;

1475 ià(
·n
 < 0)

1476 
·n
 = 0;

1477 ià(
·n
 > 15)

1478 
·n
 = 15;

1480 ià(
§m¶es
[
§m¶e
].
mode
 & 
WAVE_16_BITS
)

1482 
mode
 |= 0x04;

1485 ià((
§m¶e_±rs
[
§m¶e
] >> 18) !=

1486 ((
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
Ën
) >> 18))

1487 
	`´štk
 ("GUS: Sample‡ddressƒrror\n");

1494 
	`DISABLE_INTR
 (
æags
);

1495 
	`gus_£Ëù_voiû
 (
voiû
);

1496 
	`gus_voiû_off
 ();

1499 
	`gus_¿mpoff
 ();

1500 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

1502 
	`compu‹_vŞume
 (
voiû
, 
vŞume
);

1503 
	`š™_’v–İe
 (
voiû
);

1506 
	`compu‹_ªd_£t_vŞume
 (
voiû
, 
vŞume
, 0);

1508 ià(
§m¶es
[
§m¶e
].
mode
 & 
WAVE_LOOP_BACK
)

1509 
	`gus_wr™e_addr
 (0x0a, 
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
Ën
 -

1510 
voiûs
[
voiû
].
off£t_³ndšg
, 
is16b™s
);

1513 
	`gus_wr™e_addr
 (0x0a, 
§m¶e_±rs
[
§m¶e
] + 
voiûs
[
voiû
].
off£t_³ndšg
,

1514 
is16b™s
);

1516 ià(
§m¶es
[
§m¶e
].
mode
 & 
WAVE_LOOPING
)

1518 
mode
 |= 0x08;

1522 ià(
§m¶es
[
§m¶e
].
mode
 & 
WAVE_BIDIR_LOOP
)

1523 
mode
 |= 0x10;

1527 ià(
§m¶es
[
§m¶e
].
mode
 & 
WAVE_LOOP_BACK
)

1529 
	`gus_wr™e_addr
 (0x0a,

1530 
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
loİ_’d
 -

1531 
voiûs
[
voiû
].
off£t_³ndšg
, 
is16b™s
);

1532 
mode
 |= 0x40;

1535 
	`gus_wr™e_addr
 (0x02, 
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
loİ_¡¬t
, 
is16b™s
);

1540 
	`gus_wr™e_addr
 (0x04, 
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
loİ_’d
, 
is16b™s
);

1548 
mode
 |= 0x20;

1551 
voiûs
[
voiû
].
loİ_œq_mode
 = 
LMODE_FINISH
;

1555 
voiûs
[
voiû
].
loİ_œq_·rm
 = 1;

1556 
	`gus_wr™e_addr
 (0x02, 
§m¶e_±rs
[
§m¶e
], 
is16b™s
);

1560 
	`gus_wr™e_addr
 (0x04, 
§m¶e_±rs
[
§m¶e
] + 
§m¶es
[§m¶e].
Ën
-1, 
is16b™s
);

1566 
	`gus_voiû_äeq
 (
äeq
);

1567 
	`gus_voiû_b®ªû
 (
·n
);

1568 
	`gus_voiû_Ú
 (
mode
);

1569 
	`RESTORE_INTR
 (
æags
);

1572 
	}
}

1580 
	$guswave_¡¬t_nÙe
 (
dev
, 
voiû
, 
nÙe_num
, 
vŞume
)

1582 
æags
;

1583 
mode
;

1584 
»t_v®
 = 0;

1586 
	`DISABLE_INTR
 (
æags
);

1587 ià(
nÙe_num
 == 255)

1589 ià(
voiûs
[
voiû
].
vŞume_œq_mode
 =ğ
VMODE_START_NOTE
)

1590 
voiûs
[
voiû
].
vŞume_³ndšg
 = 
vŞume
;

1592 
»t_v®
 = 
	`guswave_¡¬t_nÙe2
 (
dev
, 
voiû
, 
nÙe_num
, 
vŞume
);

1596 
	`gus_£Ëù_voiû
 (
voiû
);

1597 
mode
 = 
	`gus_»ad8
 (0x00);

1598 ià(
mode
 & 0x20)

1599 
	`gus_wr™e8
 (0x00, 
mode
 & 0xdf);

1601 
voiûs
[
voiû
].
off£t_³ndšg
 = 0;

1602 
voiûs
[
voiû
].
kl_³ndšg
 = 0;

1603 
voiûs
[
voiû
].
vŞume_œq_mode
 = 0;

1604 
voiûs
[
voiû
].
loİ_œq_mode
 = 0;

1606 ià(
voiûs
[
voiû
].
§m¶e_³ndšg
 >= 0)

1608 
	`guswave_£t_š¡r
 (
voiûs
[
voiû
].
dev_³ndšg
, voice,

1609 
voiûs
[
voiû
].
§m¶e_³ndšg
);

1610 
voiûs
[
voiû
].
§m¶e_³ndšg
 = -1;

1613 ià((
mode
 & 0x01è|| ((
	`gus_»ad16
 (0x09) >> 4) < 2065))

1615 
»t_v®
 = 
	`guswave_¡¬t_nÙe2
 (
dev
, 
voiû
, 
nÙe_num
, 
vŞume
);

1619 
voiûs
[
voiû
].
dev_³ndšg
 = 
dev
;

1620 
voiûs
[
voiû
].
nÙe_³ndšg
 = 
nÙe_num
;

1621 
voiûs
[
voiû
].
vŞume_³ndšg
 = 
vŞume
;

1622 
voiûs
[
voiû
].
vŞume_œq_mode
 = 
VMODE_START_NOTE
;

1624 
	`gus_¿mpoff
 ();

1625 
	`gus_¿mp_¿nge
 (2000, 4065);

1626 
	`gus_¿mp_¿‹
 (0, 63);

1627 
	`gus_¿mpÚ
 (0x20 | 0x40);

1630 
	`RESTORE_INTR
 (
æags
);

1631  
»t_v®
;

1632 
	}
}

1635 
	$guswave_»£t
 (
dev
)

1637 
i
;

1639 
i
 = 0; i < 32; i++)

1641 
	`gus_voiû_š™
 (
i
);

1642 
	`gus_voiû_š™2
 (
i
);

1644 
	}
}

1647 
	$guswave_İ’
 (
dev
, 
mode
)

1649 
”r
;

1651 ià(
gus_busy
)

1652  
	`RET_ERROR
 (
EBUSY
);

1654 
	`gus_š™Ÿlize
 ();

1656 ià((
”r
 = 
	`DMAbuf_İ’_dma
 (
gus_devnum
)))

1657  
”r
;

1659 
	`RESET_WAIT_QUEUE
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
);

1660 
gus_busy
 = 1;

1661 
aùive_deviû
 = 
GUS_DEV_WAVE
;

1663 
	`gus_»£t
 ();

1666 
	}
}

1669 
	$guswave_şo£
 (
dev
)

1671 
gus_busy
 = 0;

1672 
aùive_deviû
 = 0;

1673 
	`gus_»£t
 ();

1675 
	`DMAbuf_şo£_dma
 (
gus_devnum
);

1676 
	}
}

1679 
	$guswave_lßd_·tch
 (
dev
, 
fÜm©
, 
¢d_rw_buf
 * 
addr
,

1680 
offs
, 
couÁ
, 
pmgr_æag
)

1682 
·tch_šfo
 
·tch
;

1683 
š¡r
;

1684 
sizeof_·tch
;

1686 
blk_size
, 
blk_’d
, 
Ëá
, 
¤c_offs
, 
rg‘
;

1688 
sizeof_·tch
 = (è&
·tch
.
d©a
[0] - () &patch;

1694 ià(
fÜm©
 !ğ
GUS_PATCH
)

1696 
	`´štk
 ("GUS E¼Ü: Inv®id…©ch fÜm© (keyè0x%x\n", 
fÜm©
);

1697  
	`RET_ERROR
 (
EINVAL
);

1700 ià(
couÁ
 < 
sizeof_·tch
)

1702 
	`´štk
 ("GUS Error: Patch headeroo short\n");

1703  
	`RET_ERROR
 (
EINVAL
);

1706 
couÁ
 -ğ
sizeof_·tch
;

1708 ià(
ä“_§m¶e
 >ğ
MAX_SAMPLE
)

1710 
	`´štk
 ("GUS: Sampleable full\n");

1711  
	`RET_ERROR
 (
ENOSPC
);

1719 
	`COPY_FROM_USER
 (&((*è&
·tch
)[
offs
], 
addr
, offs, 
sizeof_·tch
 - offs);

1721 
š¡r
 = 
·tch
.
š¡r_no
;

1723 ià(
š¡r
 < 0 || in¡¸> 
MAX_PATCH
)

1725 
	`´štk
 ("GUS: Inv®id…©ch‚umb” %d\n", 
š¡r
);

1726  
	`RET_ERROR
 (
EINVAL
);

1729 ià(
couÁ
 < 
·tch
.
Ën
)

1731 
	`´štk
 ("GUS Warning: Patch„ecordoo short (%d<%d)\n",

1732 
couÁ
, (è
·tch
.
Ën
);

1733 
·tch
.
Ën
 = 
couÁ
;

1736 ià(
·tch
.
Ën
 <ğ0 ||…©ch.ËÀ> 
gus_mem_size
)

1738 
	`´štk
 ("GUS: Inv®id sam¶Ëngth %d\n", (è
·tch
.
Ën
);

1739  
	`RET_ERROR
 (
EINVAL
);

1742 ià(
·tch
.
mode
 & 
WAVE_LOOPING
)

1744 ià(
·tch
.
loİ_¡¬t
 < 0 ||…©ch.loİ_¡¬ˆ>ğ·tch.
Ën
)

1746 
	`´štk
 ("GUS: Invalid†oop start\n");

1747  
	`RET_ERROR
 (
EINVAL
);

1750 ià(
·tch
.
loİ_’d
 <…©ch.
loİ_¡¬t
 ||…©ch.loİ_’d >…©ch.
Ën
)

1752 
	`´štk
 ("GUS: Invalid†oopƒnd\n");

1753  
	`RET_ERROR
 (
EINVAL
);

1757 
ä“_mem_±r
 = (free_mem_ptr + 31) & ~31;

1761 
	#GUS_BANK_SIZE
 (256*1024)

	)

1763 ià(
·tch
.
mode
 & 
WAVE_16_BITS
)

1768 ià(
·tch
.
Ën
 >ğ
GUS_BANK_SIZE
)

1770 
	`´štk
 ("GUS: Sam¶(16 b™ètoØlÚg %d\n", (è
·tch
.
Ën
);

1771  
	`RET_ERROR
 (
ENOSPC
);

1774 ià((
ä“_mem_±r
 / 
GUS_BANK_SIZE
) !=

1775 ((
ä“_mem_±r
 + 
·tch
.
Ën
è/ 
GUS_BANK_SIZE
))

1777 
tmp_mem
 =

1780 ((
ä“_mem_±r
 / 
GUS_BANK_SIZE
) + 1) * GUS_BANK_SIZE;

1782 ià((
tmp_mem
 + 
·tch
.
Ën
è> 
gus_mem_size
)

1783  
	`RET_ERROR
 (
ENOSPC
);

1785 
ä“_mem_±r
 = 
tmp_mem
;

1791 ià((
ä“_mem_±r
 + 
·tch
.
Ën
è> 
gus_mem_size
)

1792  
	`RET_ERROR
 (
ENOSPC
);

1794 
§m¶e_±rs
[
ä“_§m¶e
] = 
ä“_mem_±r
;

1800 ià(
·tch
.
mode
 & 
WAVE_ENVELOPES
)

1801 
·tch
.
mode
 &ğ~
WAVE_TREMOLO
;

1803 
	`memıy
 ((*è&
§m¶es
[
ä“_§m¶e
], &
·tch
, 
sizeof_·tch
);

1809 
§m¶es
[
ä“_§m¶e
].
key
 = 
·tch_bË
[
š¡r
];

1810 
·tch_bË
[
š¡r
] = 
ä“_§m¶e
;

1816 
Ëá
 = 
·tch
.
Ën
;

1817 
¤c_offs
 = 0;

1818 
rg‘
 = 
ä“_mem_±r
;

1820 
Ëá
)

1824 
blk_size
 = 
sound_buffsizes
[
gus_devnum
];

1825 ià(
blk_size
 > 
Ëá
)

1826 
blk_size
 = 
Ëá
;

1831 
blk_’d
 = 
rg‘
 + 
blk_size
;

1833 ià((
rg‘
 >> 18è!ğ(
blk_’d
 >> 18))

1838 
blk_’d
 &= ~(256 * 1024 - 1);

1839 
blk_size
 = 
blk_’d
 - 
rg‘
;

1842 #ià
	`defšed
(
GUS_NO_DMA
è|| defšed(
GUS_PATCH_NO_DMA
)

1847 
i
;

1848 
d©a
;

1850 
i
 = 0; i < 
blk_size
; i++)

1852 
	`GET_BYTE_FROM_USER
 (
d©a
, 
addr
, 
sizeof_·tch
 + 
i
);

1853 ià(
·tch
.
mode
 & 
WAVE_UNSIGNED
)

1855 ià(!(
·tch
.
mode
 & 
WAVE_16_BITS
è|| (
i
 & 0x01))

1856 
d©a
 ^= 0x80;

1859 
	`gus_poke
 (
rg‘
 + 
i
, 
d©a
);

1863 * * * 
GUS_NO_DMA
 */

1865 
add»ss
, 
hŞd_add»ss
;

1866 
dma_commªd
;

1867 
æags
;

1873 
	`COPY_FROM_USER
 (
¢d_¿w_buf
[
gus_devnum
][0],

1874 
addr
, 
sizeof_·tch
 + 
¤c_offs
,

1875 
blk_size
);

1877 
	`DISABLE_INTR
 (
æags
);

1878 
	`gus_wr™e8
 (0x41, 0);

1881 
	`DMAbuf_¡¬t_dma
 (
gus_devnum
, 
¢d_¿w_buf_phys
[gus_devnum][0],

1882 
blk_size
, 
DMA_MODE_WRITE
);

1888 
add»ss
 = 
rg‘
;

1890 ià(
sound_d¥_dmachª
[
gus_devnum
] > 3)

1892 
hŞd_add»ss
 = 
add»ss
;

1893 
add»ss
 =‡ddress >> 1;

1894 
add»ss
 &= 0x0001ffffL;

1895 
add»ss
 |ğ(
hŞd_add»ss
 & 0x000c0000L);

1898 
	`gus_wr™e16
 (0x42, (
add»ss
 >> 4) & 0xffff);

1906 
dma_commªd
 = 0x21;

1909 ià(
·tch
.
mode
 & 
WAVE_UNSIGNED
)

1910 
dma_commªd
 |= 0x80;

1913 ià(
·tch
.
mode
 & 
WAVE_16_BITS
)

1914 
dma_commªd
 |= 0x40;

1917 ià(
sound_d¥_dmachª
[
gus_devnum
] > 3)

1918 
dma_commªd
 |= 0x04;

1922 
	`gus_wr™e8
 (0x41, 
dma_commªd
);

1929 
aùive_deviû
 = 
GUS_DEV_WAVE
;

1931 
	`DO_SLEEP
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
, 
HZ
);

1932 ià(
	`TIMED_OUT
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
))

1933 
	`´štk
 ("GUS: DMA Transferimed out\n");

1934 
	`RESTORE_INTR
 (
æags
);

1937 * * * 
GUS_NO_DMA
 */

1943 
Ëá
 -ğ
blk_size
;

1944 
¤c_offs
 +ğ
blk_size
;

1945 
rg‘
 +ğ
blk_size
;

1947 
	`gus_wr™e8
 (0x41, 0);

1952 
ä“_mem_±r
 +ğ
·tch
.
Ën
;

1954 ià(!
pmgr_æag
)

1955 
	`pmgr_šfÜm
 (
dev
, 
PM_E_PATCH_LOADED
, 
š¡r
, 
ä“_§m¶e
, 0, 0);

1956 
ä“_§m¶e
++;

1958 
	}
}

1961 
	$guswave_hw_cÚŒŞ
 (
dev
, *
ev’t
)

1963 
voiû
, 
cmd
;

1964 
p1
, 
p2
;

1965 
¶Úg
, 
æags
;

1967 
cmd
 = 
ev’t
[2];

1968 
voiû
 = 
ev’t
[3];

1969 
p1
 = *(*è&
ev’t
[4];

1970 
p2
 = *(*è&
ev’t
[6];

1971 
¶Úg
 = *(*è&
ev’t
[4];

1973 ià((
voiûs
[
voiû
].
vŞume_œq_mode
 =ğ
VMODE_START_NOTE
) &&

1974 (
cmd
 !ğ
_GUS_VOICESAMPLE
è&& (cmd !ğ
_GUS_VOICE_POS
))

1975 
	`do_vŞume_œq
 (
voiû
);

1977 
cmd
)

1980 
_GUS_NUMVOICES
:

1981 
	`DISABLE_INTR
 (
æags
);

1982 
	`gus_£Ëù_voiû
 (
voiû
);

1983 
	`gus_£Ëù_max_voiûs
 (
p1
);

1984 
	`RESTORE_INTR
 (
æags
);

1987 
_GUS_VOICESAMPLE
:

1988 
	`guswave_£t_š¡r
 (
dev
, 
voiû
, 
p1
);

1991 
_GUS_VOICEON
:

1992 
	`DISABLE_INTR
 (
æags
);

1993 
	`gus_£Ëù_voiû
 (
voiû
);

1994 
p1
 &= ~0x20;

1997 
	`gus_voiû_Ú
 (
p1
);

1998 
	`RESTORE_INTR
 (
æags
);

2001 
_GUS_VOICEOFF
:

2002 
	`DISABLE_INTR
 (
æags
);

2003 
	`gus_£Ëù_voiû
 (
voiû
);

2004 
	`gus_voiû_off
 ();

2005 
	`RESTORE_INTR
 (
æags
);

2008 
_GUS_VOICEFADE
:

2009 
	`DISABLE_INTR
 (
æags
);

2010 
	`gus_£Ëù_voiû
 (
voiû
);

2011 
	`gus_voiû_çde
 (
voiû
);

2012 
	`RESTORE_INTR
 (
æags
);

2015 
_GUS_VOICEMODE
:

2016 
	`DISABLE_INTR
 (
æags
);

2017 
	`gus_£Ëù_voiû
 (
voiû
);

2018 
p1
 &= ~0x20;

2021 
	`gus_voiû_mode
 (
p1
);

2022 
	`RESTORE_INTR
 (
æags
);

2025 
_GUS_VOICEBALA
:

2026 
	`DISABLE_INTR
 (
æags
);

2027 
	`gus_£Ëù_voiû
 (
voiû
);

2028 
	`gus_voiû_b®ªû
 (
p1
);

2029 
	`RESTORE_INTR
 (
æags
);

2032 
_GUS_VOICEFREQ
:

2033 
	`DISABLE_INTR
 (
æags
);

2034 
	`gus_£Ëù_voiû
 (
voiû
);

2035 
	`gus_voiû_äeq
 (
¶Úg
);

2036 
	`RESTORE_INTR
 (
æags
);

2039 
_GUS_VOICEVOL
:

2040 
	`DISABLE_INTR
 (
æags
);

2041 
	`gus_£Ëù_voiû
 (
voiû
);

2042 
	`gus_voiû_vŞume
 (
p1
);

2043 
	`RESTORE_INTR
 (
æags
);

2046 
_GUS_VOICEVOL2
:

2049 
voiûs
[
voiû
].
š™Ÿl_vŞume
 =

2050 
voiûs
[
voiû
].
cu¼’t_vŞume
 = 
p1
;

2053 
_GUS_RAMPRANGE
:

2054 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

2058 
	`DISABLE_INTR
 (
æags
);

2059 
	`gus_£Ëù_voiû
 (
voiû
);

2060 
	`gus_¿mp_¿nge
 (
p1
, 
p2
);

2061 
	`RESTORE_INTR
 (
æags
);

2064 
_GUS_RAMPRATE
:

2065 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

2069 
	`DISABLE_INTR
 (
æags
);

2070 
	`gus_£Ëù_voiû
 (
voiû
);

2071 
	`gus_¿mp_¿‹
 (
p1
, 
p2
);

2072 
	`RESTORE_INTR
 (
æags
);

2075 
_GUS_RAMPMODE
:

2076 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

2080 
	`DISABLE_INTR
 (
æags
);

2081 
	`gus_£Ëù_voiû
 (
voiû
);

2082 
p1
 &= ~0x20;

2085 
	`gus_¿mp_mode
 (
p1
);

2086 
	`RESTORE_INTR
 (
æags
);

2089 
_GUS_RAMPON
:

2090 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

2094 
	`DISABLE_INTR
 (
æags
);

2095 
	`gus_£Ëù_voiû
 (
voiû
);

2096 
p1
 &= ~0x20;

2099 
	`gus_¿mpÚ
 (
p1
);

2100 
	`RESTORE_INTR
 (
æags
);

2103 
_GUS_RAMPOFF
:

2104 ià(
voiûs
[
voiû
].
mode
 & 
WAVE_ENVELOPES
)

2108 
	`DISABLE_INTR
 (
æags
);

2109 
	`gus_£Ëù_voiû
 (
voiû
);

2110 
	`gus_¿mpoff
 ();

2111 
	`RESTORE_INTR
 (
æags
);

2114 
_GUS_VOLUME_SCALE
:

2115 
vŞume_ba£
 = 
p1
;

2116 
vŞume_sÿË
 = 
p2
;

2119 
_GUS_VOICE_POS
:

2120 
	`DISABLE_INTR
 (
æags
);

2121 
	`gus_£Ëù_voiû
 (
voiû
);

2122 
	`gus_£t_voiû_pos
 (
voiû
, 
¶Úg
);

2123 
	`RESTORE_INTR
 (
æags
);

2128 
	}
}

2131 
	$gus_§m¶šg_£t_¥“d
 (
¥“d
)

2133 ià(
¥“d
 <= 0)

2134  
gus_§m¶šg_¥“d
;

2136 ià(
¥“d
 > 44100)

2137 
¥“d
 = 44100;

2139 
gus_§m¶šg_¥“d
 = 
¥“d
;

2140  
¥“d
;

2141 
	}
}

2144 
	$gus_§m¶šg_£t_chªÃls
 (
chªÃls
)

2146 ià(!
chªÃls
)

2147  
gus_§m¶šg_chªÃls
;

2148 ià(
chªÃls
 > 2)

2149 
chªÃls
 = 2;

2150 ià(
chªÃls
 < 1)

2151 
chªÃls
 = 1;

2152 
gus_§m¶šg_chªÃls
 = 
chªÃls
;

2153  
chªÃls
;

2154 
	}
}

2157 
	$gus_§m¶šg_£t_b™s
 (
b™s
)

2159 ià(!
b™s
)

2160  
gus_§m¶šg_b™s
;

2162 ià(
b™s
 != 8 && bits != 16)

2163 
b™s
 = 8;

2165 
gus_§m¶šg_b™s
 = 
b™s
;

2166  
b™s
;

2167 
	}
}

2170 
	$gus_§m¶šg_ioùl
 (
dev
, 
cmd
, 
¬g
, 
loÿl
)

2172 
cmd
)

2174 
SOUND_PCM_WRITE_RATE
:

2175 ià(
loÿl
)

2176  
	`gus_§m¶šg_£t_¥“d
 (
¬g
);

2177  
	`IOCTL_OUT
 (
¬g
, 
	`gus_§m¶šg_£t_¥“d
 (
	`IOCTL_IN
 (arg)));

2180 
SOUND_PCM_READ_RATE
:

2181 ià(
loÿl
)

2182  
gus_§m¶šg_¥“d
;

2183  
	`IOCTL_OUT
 (
¬g
, 
gus_§m¶šg_¥“d
);

2186 
SNDCTL_DSP_STEREO
:

2187 ià(
loÿl
)

2188  
	`gus_§m¶šg_£t_chªÃls
 (
¬g
 + 1) - 1;

2189  
	`IOCTL_OUT
 (
¬g
, 
	`gus_§m¶šg_£t_chªÃls
 (
	`IOCTL_IN
 (arg) + 1) - 1);

2192 
SOUND_PCM_WRITE_CHANNELS
:

2193 ià(
loÿl
)

2194  
	`gus_§m¶šg_£t_chªÃls
 (
¬g
);

2195  
	`IOCTL_OUT
 (
¬g
, 
	`gus_§m¶šg_£t_chªÃls
 (
	`IOCTL_IN
 (arg)));

2198 
SOUND_PCM_READ_CHANNELS
:

2199 ià(
loÿl
)

2200  
gus_§m¶šg_chªÃls
;

2201  
	`IOCTL_OUT
 (
¬g
, 
gus_§m¶šg_chªÃls
);

2204 
SNDCTL_DSP_SAMPLESIZE
:

2205 ià(
loÿl
)

2206  
	`gus_§m¶šg_£t_b™s
 (
¬g
);

2207  
	`IOCTL_OUT
 (
¬g
, 
	`gus_§m¶šg_£t_b™s
 (
	`IOCTL_IN
 (arg)));

2210 
SOUND_PCM_READ_BITS
:

2211 ià(
loÿl
)

2212  
gus_§m¶šg_b™s
;

2213  
	`IOCTL_OUT
 (
¬g
, 
gus_§m¶šg_b™s
);

2215 
SOUND_PCM_WRITE_FILTER
:

2218  
	`IOCTL_OUT
 (
¬g
, 
	`RET_ERROR
 (
EINVAL
));

2221 
SOUND_PCM_READ_FILTER
:

2222  
	`IOCTL_OUT
 (
¬g
, 
	`RET_ERROR
 (
EINVAL
));

2226  
	`RET_ERROR
 (
EINVAL
);

2228  
	`RET_ERROR
 (
EINVAL
);

2229 
	}
}

2232 
	$gus_§m¶šg_»£t
 (
dev
)

2234 
	}
}

2237 
	$gus_§m¶šg_İ’
 (
dev
, 
mode
)

2239 #ifdeà
GUS_NO_DMA


2240 
	`´štk
 ("GUS: DMA mode‚otƒnabled. Device‚ot supported\n");

2241  
	`RET_ERROR
 (
ENXIO
);

2244 ià(
gus_busy
)

2245  
	`RET_ERROR
 (
EBUSY
);

2247 
	`gus_š™Ÿlize
 ();

2249 
gus_busy
 = 1;

2250 
aùive_deviû
 = 0;

2252 
	`gus_»£t
 ();

2253 
	`»£t_§m¶e_memÜy
 ();

2254 
	`gus_£Ëù_max_voiûs
 (14);

2256 
pcm_aùive
 = 0;

2257 
pcm_İ’ed
 = 1;

2258 ià(
mode
 & 
OPEN_READ
)

2260 
»cÜdšg_aùive
 = 1;

2261 
	`£t_šput_vŞumes
();

2265 
	}
}

2268 
	$gus_§m¶šg_şo£
 (
dev
)

2270 
	`gus_»£t
 ();

2271 
gus_busy
 = 0;

2272 
pcm_İ’ed
 = 0;

2273 
aùive_deviû
 = 0;

2275 ià(
»cÜdšg_aùive
)

2276 
	`£t_šput_vŞumes
();

2278 
»cÜdšg_aùive
 = 0;

2279 
	}
}

2282 
	$gus_§m¶šg_upd©e_vŞume
 ()

2284 
æags
;

2285 
voiû
;

2287 
	`DISABLE_INTR
 (
æags
);

2288 ià(
pcm_aùive
 && 
pcm_İ’ed
)

2289 
voiû
 = 0; voiû < 
gus_§m¶šg_chªÃls
; voice++)

2291 
	`gus_£Ëù_voiû
 (
voiû
);

2292 
	`gus_¿mpoff
 ();

2293 
	`gus_voiû_vŞume
 (1530 + (25 * 
gus_pcm_vŞume
));

2294 
	`gus_¿mp_¿nge
 (65, 1530 + (25 * 
gus_pcm_vŞume
));

2296 
	`RESTORE_INTR
 (
æags
);

2297 
	}
}

2300 
	$¶ay_Ãxt_pcm_block
 ()

2302 
æags
;

2303 
¥“d
 = 
gus_§m¶šg_¥“d
;

2304 
this_Úe
, 
is16b™s
, 
chn
;

2305 
d¿m_loc
;

2306 
mode
[2], 
¿mp_mode
[2];

2308 ià(!
pcm_qËn
)

2311 
this_Úe
 = 
pcm_h—d
;

2313 
chn
 = 0; chÀ< 
gus_§m¶šg_chªÃls
; chn++)

2315 
mode
[
chn
] = 0x00;

2316 
¿mp_mode
[
chn
] = 0x03;

2320 ià(
chn
 == 0)

2322 
mode
[
chn
] |= 0x20;

2325 
voiûs
[
chn
].
loİ_œq_mode
 = 
LMODE_PCM
;

2328 ià(
gus_§m¶šg_b™s
 != 8)

2330 
is16b™s
 = 1;

2331 
mode
[
chn
] |= 0x04;

2336 
is16b™s
 = 0;

2338 
d¿m_loc
 = 
this_Úe
 * 
pcm_bsize
;

2339 
d¿m_loc
 +ğ
chn
 * 
pcm_bªksize
;

2341 ià(
this_Úe
 =ğ(
pcm_nblk
 - 1))

2345 
mode
[
chn
] |= 0x08;

2348 
¿mp_mode
[
chn
] = 0x03;

2354 ià(
chn
 == 0)

2355 
¿mp_mode
[
chn
] = 0x04;

2360 
	`DISABLE_INTR
 (
æags
);

2361 
	`gus_£Ëù_voiû
 (
chn
);

2362 
	`gus_voiû_äeq
 (
¥“d
);

2364 ià(
gus_§m¶šg_chªÃls
 == 1)

2365 
	`gus_voiû_b®ªû
 (7);

2368 ià(
chn
 == 0)

2369 
	`gus_voiû_b®ªû
 (0);

2373 
	`gus_voiû_b®ªû
 (15);

2377 ià(!
pcm_aùive
)

2388 
	`gus_voiû_off
 ();

2391 
	`gus_¿mpoff
 ();

2392 
	`gus_voiû_vŞume
 (1530 + (25 * 
gus_pcm_vŞume
));

2393 
	`gus_¿mp_¿nge
 (65, 1530 + (25 * 
gus_pcm_vŞume
));

2395 
	`gus_wr™e_addr
 (0x0a, 
d¿m_loc
, 
is16b™s
);

2398 
	`gus_wr™e_addr
 (0x02, 
chn
 * 
pcm_bªksize
, 
is16b™s
);

2403 ià(
chn
 != 0)

2404 
	`gus_wr™e_addr
 (0x04, 
pcm_bªksize
 + (
pcm_bsize
 * 
pcm_nblk
),

2405 
is16b™s
);

2410 ià(
chn
 == 0)

2411 
	`gus_wr™e_addr
 (0x04, 
d¿m_loc
 + 
pcm_d©asize
[
this_Úe
], 
is16b™s
);

2417 
mode
[
chn
] |= 0x08;

2421 ià(
pcm_d©asize
[
this_Úe
] !ğ
pcm_bsize
)

2426 ià(
chn
 == 0)

2428 
mode
[
chn
] &= ~0x08;

2431 
mode
[
chn
] |= 0x20;

2434 
voiûs
[0].
loİ_œq_mode
 = 
LMODE_PCM_STOP
;

2435 
¿mp_mode
[
chn
] = 0x03;

2441 
	`gus_wr™e_addr
 (0x04, 
d¿m_loc
 + 
pcm_d©asize
[
this_Úe
], 
is16b™s
);

2446 
mode
[
chn
] &= ~0x08;

2452 
	`RESTORE_INTR
 (
æags
);

2455 
chn
 = 0; chÀ< 
gus_§m¶šg_chªÃls
; chn++)

2457 
	`DISABLE_INTR
 (
æags
);

2458 
	`gus_£Ëù_voiû
 (
chn
);

2459 
	`gus_wr™e8
 (0x0d, 
¿mp_mode
[
chn
]);

2460 
	`gus_voiû_Ú
 (
mode
[
chn
]);

2461 
	`RESTORE_INTR
 (
æags
);

2464 
pcm_aùive
 = 1;

2465 
	}
}

2468 
	$gus_Œªsãr_ouut_block
 (
dev
, 
buf
,

2469 
tÙ®_couÁ
, 
šŒæag
, 
chn
)

2480 
this_Úe
, 
couÁ
;

2481 
æags
;

2482 
dma_commªd
;

2483 
add»ss
, 
hŞd_add»ss
;

2485 
	`DISABLE_INTR
 (
æags
);

2487 
couÁ
 = 
tÙ®_couÁ
 / 
gus_§m¶šg_chªÃls
;

2489 ià(
chn
 == 0)

2491 ià(
pcm_qËn
 >ğ
pcm_nblk
)

2492 
	`´štk
 ("GUS Warning: PCM buffers out of sync\n");

2494 
this_Úe
 = 
pcm_cu¼’t_block
 = 
pcm_
;

2495 
pcm_qËn
++;

2496 
pcm_
 = (pcm_ + 1è% 
pcm_nblk
;

2497 
pcm_d©asize
[
this_Úe
] = 
couÁ
;

2500 
this_Úe
 = 
pcm_cu¼’t_block
;

2502 
	`gus_wr™e8
 (0x41, 0);

2505 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
 + (
chn
 * 
couÁ
), couÁ, 
DMA_MODE_WRITE
);

2507 
add»ss
 = 
this_Úe
 * 
pcm_bsize
;

2508 
add»ss
 +ğ
chn
 * 
pcm_bªksize
;

2510 ià(
sound_d¥_dmachª
[
dev
] > 3)

2512 
hŞd_add»ss
 = 
add»ss
;

2513 
add»ss
 =‡ddress >> 1;

2514 
add»ss
 &= 0x0001ffffL;

2515 
add»ss
 |ğ(
hŞd_add»ss
 & 0x000c0000L);

2518 
	`gus_wr™e16
 (0x42, (
add»ss
 >> 4) & 0xffff);

2522 
dma_commªd
 = 0x21;

2526 ià(
gus_§m¶šg_b™s
 != 8)

2527 
dma_commªd
 |= 0x40;

2531 
dma_commªd
 |= 0x80;

2535 ià(
sound_d¥_dmachª
[
dev
] > 3)

2536 
dma_commªd
 |= 0x04;

2540 
	`gus_wr™e8
 (0x41, 
dma_commªd
);

2544 ià(
chn
 =ğ(
gus_§m¶šg_chªÃls
 - 1))

2551 
aùive_deviû
 = 
GUS_DEV_PCM_DONE
;

2552 ià(!
pcm_aùive
 && (
pcm_qËn
 > 2 || 
couÁ
 < 
pcm_bsize
))

2554 
	`¶ay_Ãxt_pcm_block
 ();

2560 
aùive_deviû
 = 
GUS_DEV_PCM_CONTINUE
;

2562 
	`RESTORE_INTR
 (
æags
);

2563 
	}
}

2566 
	$gus_§m¶šg_ouut_block
 (
dev
, 
buf
, 
tÙ®_couÁ
,

2567 
šŒæag
, 
»¡¬t_dma
)

2569 
pcm_cu¼’t_buf
 = 
buf
;

2570 
pcm_cu¼’t_couÁ
 = 
tÙ®_couÁ
;

2571 
pcm_cu¼’t_šŒæag
 = 
šŒæag
;

2572 
pcm_cu¼’t_dev
 = 
dev
;

2573 
	`gus_Œªsãr_ouut_block
 (
dev
, 
buf
, 
tÙ®_couÁ
, 
šŒæag
, 0);

2574 
	}
}

2577 
	$gus_§m¶šg_¡¬t_šput
 (
dev
, 
buf
, 
couÁ
,

2578 
šŒæag
, 
»¡¬t_dma
)

2580 
æags
;

2581 
mode
;

2583 
	`DISABLE_INTR
 (
æags
);

2585 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_READ
);

2587 
mode
 = 0xa0;

2591 ià(
sound_d¥_dmachª
[
dev
] > 3)

2592 
mode
 |= 0x04;

2595 ià(
gus_§m¶šg_chªÃls
 > 1)

2596 
mode
 |= 0x02;

2599 
mode
 |= 0x01;

2603 
	`gus_wr™e8
 (0x49, 
mode
);

2605 
	`RESTORE_INTR
 (
æags
);

2606 
	}
}

2609 
	$gus_§m¶šg_´•¬e_fÜ_šput
 (
dev
, 
bsize
, 
bcouÁ
)

2611 
¿‹
;

2613 
¿‹
 = (9878400 / (
gus_§m¶šg_¥“d
 + 2)) / 16;

2615 
	`gus_wr™e8
 (0x48, 
¿‹
 & 0xff);

2619 ià(
gus_§m¶šg_b™s
 != 8)

2621 
	`´štk
 ("GUS Error: 16 bit„ecording‚ot supported\n");

2622  
	`RET_ERROR
 (
EINVAL
);

2626 
	}
}

2629 
	$gus_§m¶šg_´•¬e_fÜ_ouut
 (
dev
, 
bsize
, 
bcouÁ
)

2631 
i
;

2633 
mem_±r
, 
mem_size
;

2635 
mem_±r
 = 0;

2636 
mem_size
 = 
gus_mem_size
 / 
gus_§m¶šg_chªÃls
;

2638 ià(
mem_size
 > (256 * 1024))

2639 
mem_size
 = 256 * 1024;

2641 
pcm_bsize
 = 
bsize
 / 
gus_§m¶šg_chªÃls
;

2642 
pcm_h—d
 = 
pcm_
 = 
pcm_qËn
 = 0;

2644 
pcm_nblk
 = 
MAX_PCM_BUFFERS
;

2645 ià((
pcm_bsize
 * 
pcm_nblk
è> 
mem_size
)

2646 
pcm_nblk
 = 
mem_size
 / 
pcm_bsize
;

2648 
i
 = 0; i < 
pcm_nblk
; i++)

2649 
pcm_d©asize
[
i
] = 0;

2651 
pcm_bªksize
 = 
pcm_nblk
 * 
pcm_bsize
;

2653 ià(
gus_§m¶šg_b™s
 !ğ8 && 
pcm_bªksize
 == (256 * 1024))

2654 
pcm_nblk
--;

2657 
	}
}

2660 
	$gus_has_ouut_d¿šed
 (
dev
)

2662  !
pcm_qËn
;

2663 
	}
}

2666 
	$gus_cİy_äom_u£r
 (
dev
, *
loÿlbuf
, 
loÿloffs
,

2667 
¢d_rw_buf
 * 
u£rbuf
, 
u£roffs
, 
Ën
)

2669 ià(
gus_§m¶šg_chªÃls
 == 1)

2671 
	`COPY_FROM_USER
 (&
loÿlbuf
[
loÿloffs
], 
u£rbuf
, 
u£roffs
, 
Ën
);

2673 ià(
gus_§m¶šg_b™s
 == 8)

2675 
š_Ëá
 = 
u£roffs
;

2676 
š_right
 = 
u£roffs
 + 1;

2677 *
out_Ëá
, *
out_right
;

2678 
i
;

2680 
Ën
 /= 2;

2681 
loÿloffs
 /= 2;

2682 
out_Ëá
 = &
loÿlbuf
[
loÿloffs
];

2683 
out_right
 = 
out_Ëá
 + 
pcm_bsize
;

2685 
i
 = 0; i < 
Ën
; i++)

2687 
	`GET_BYTE_FROM_USER
 (*
out_Ëá
++, 
u£rbuf
, 
š_Ëá
);

2688 
š_Ëá
 += 2;

2689 
	`GET_BYTE_FROM_USER
 (*
out_right
++, 
u£rbuf
, 
š_right
);

2690 
š_right
 += 2;

2695 
š_Ëá
 = 
u£roffs
;

2696 
š_right
 = 
u£roffs
 + 1;

2697 *
out_Ëá
, *
out_right
;

2698 
i
;

2700 
Ën
 /= 4;

2701 
loÿloffs
 /= 4;

2703 
out_Ëá
 = (*è&
loÿlbuf
[
loÿloffs
];

2704 
out_right
 = 
out_Ëá
 + (
pcm_bsize
 / 2);

2706 
i
 = 0; i < 
Ën
; i++)

2708 
	`GET_SHORT_FROM_USER
 (*
out_Ëá
++, (*è
u£rbuf
, 
š_Ëá
);

2709 
š_Ëá
 += 2;

2710 
	`GET_SHORT_FROM_USER
 (*
out_right
++, (*è
u£rbuf
, 
š_right
);

2711 
š_right
 += 2;

2714 
	}
}

2716 
audio_İ”©iÚs
 
	ggus_§m¶šg_İ”©iÚs
 =

2719 
gus_§m¶šg_İ’
,

2720 
gus_§m¶šg_şo£
,

2721 
gus_§m¶šg_ouut_block
,

2722 
gus_§m¶šg_¡¬t_šput
,

2723 
gus_§m¶šg_ioùl
,

2724 
gus_§m¶šg_´•¬e_fÜ_šput
,

2725 
gus_§m¶šg_´•¬e_fÜ_ouut
,

2726 
gus_§m¶šg_»£t
,

2727 
gus_§m¶šg_»£t
,

2728 
gus_has_ouut_d¿šed
,

2729 
gus_cİy_äom_u£r


2732 #ifdeà
FUTURE_VERSION


2734 
	$guswave_b’d”
 (
dev
, 
voiû
, 
v®ue
)

2736 
äeq
;

2737 
æags
;

2739 
voiûs
[
voiû
].
b’d”
 = 
v®ue
 - 8192;

2740 
äeq
 = 
	`compu‹_fš‘uÃ
 (
voiûs
[
voiû
].
Üig_äeq
, 
v®ue
, voiûs[voiû].
b’d”_¿nge
);

2741 
voiûs
[
voiû
].
cu¼’t_äeq
 = 
äeq
;

2743 
	`DISABLE_INTR
 (
æags
);

2744 
	`gus_£Ëù_voiû
 (
voiû
);

2745 
	`gus_voiû_äeq
 (
äeq
);

2746 
	`RESTORE_INTR
 (
æags
);

2747 
	}
}

2751 
	$guswave_·tchmgr
 (
dev
, 
·tmgr_šfo
 *
»c
)

2753 
i
, 
n
;

2755 
»c
->
commªd
)

2757 
PM_GET_DEVTYPE
:

2758 
»c
->
·rm1
 = 
PMTYPE_WAVE
;

2762 
PM_GET_NRPGM
:

2763 
»c
->
·rm1
 = 
MAX_PATCH
;

2767 
PM_GET_PGMMAP
:

2768 
»c
->
·rm1
 = 
MAX_PATCH
;

2770 
i
 = 0; i < 
MAX_PATCH
; i++)

2772 
±r
 = 
·tch_bË
[
i
];

2774 
»c
->
d©a
.
d©a8
[
i
] = 0;

2776 
±r
 >ğ0 &&…Œ < 
ä“_§m¶e
)

2778 
»c
->
d©a
.
d©a8
[
i
]++;

2779 
±r
 = 
§m¶es
[±r].
key
;

2787 
PM_GET_PGM_PATCHES
:

2789 
±r
 = 
·tch_bË
[
»c
->
·rm1
];

2791 
n
 = 0;

2793 
±r
 >ğ0 &&…Œ < 
ä“_§m¶e
)

2795 
»c
->
d©a
.
d©a32
[
n
++] = 
±r
;

2796 
±r
 = 
§m¶es
[±r].
key
;

2801 
»c
->
·rm1
 = 
n
;

2805 
PM_GET_PATCH
:

2807 
±r
 = 
»c
->
·rm1
;

2808 
·tch_šfo
 *
·t
;

2810 ià(
±r
 < 0 ||…Œ >ğ
ä“_§m¶e
)

2811  
	`RET_ERROR
 (
EINVAL
);

2813 
	`memıy
 (
»c
->
d©a
.
d©a8
, (*è&
§m¶es
[
±r
],

2814  (
·tch_šfo
));

2816 
·t
 = (
·tch_šfo
 *è
»c
->
d©a
.
d©a8
;

2818 
·t
->
key
 = 
GUS_PATCH
;

2821 
»c
->
·rm1
 = 
§m¶e_±rs
[
±r
];

2824 
»c
->
·rm2
 =  (
·tch_šfo
);

2829 
PM_SET_PATCH
:

2831 
±r
 = 
»c
->
·rm1
;

2832 
·tch_šfo
 *
·t
;

2834 ià(
±r
 < 0 ||…Œ >ğ
ä“_§m¶e
)

2835  
	`RET_ERROR
 (
EINVAL
);

2837 
·t
 = (
·tch_šfo
 *è
»c
->
d©a
.
d©a8
;

2839 ià(
·t
->
Ën
 > 
§m¶es
[
±r
].len)

2842  
	`RET_ERROR
 (
EINVAL
);

2844 
·t
->
key
 = 
§m¶es
[
±r
].key;

2848 
	`memıy
 ((*è&
§m¶es
[
±r
], 
»c
->
d©a
.
d©a8
,

2849  (
·tch_šfo
));

2851 
·t
->
key
 = 
GUS_PATCH
;

2856 
PM_READ_PATCH
:

2860 
§m¶e
 = 
»c
->
·rm1
;

2861 
n
;

2862 
offs
 = 
»c
->
·rm2
;

2863 
l
 = 
»c
->
·rm3
;

2865 ià(
§m¶e
 < 0 || sam¶>ğ
ä“_§m¶e
)

2866  
	`RET_ERROR
 (
EINVAL
);

2868 ià(
offs
 < 0 || off >ğ
§m¶es
[
§m¶e
].
Ën
)

2869  
	`RET_ERROR
 (
EINVAL
);

2873 
n
 = 
§m¶es
[
§m¶e
].
Ën
 - 
offs
;

2877 ià(
l
 > 
n
)

2878 
l
 = 
n
;

2880 ià(
l
 >  (
»c
->
d©a
.
d©a8
))

2881 
l
 =  (
»c
->
d©a
.
d©a8
);

2883 ià(
l
 <= 0)

2884  
	`RET_ERROR
 (
EINVAL
);

2888 
offs
 +ğ
§m¶e_±rs
[
§m¶e
];

2892 
n
 = 0;‚ < 
l
;‚++)

2893 
»c
->
d©a
.
d©a8
[
n
] = 
	`gus_³ek
 (
offs
++);

2894 
»c
->
·rm1
 = 
n
;

2901 
PM_WRITE_PATCH
:

2905 
§m¶e
 = 
»c
->
·rm1
;

2906 
n
;

2907 
offs
 = 
»c
->
·rm2
;

2908 
l
 = 
»c
->
·rm3
;

2910 ià(
§m¶e
 < 0 || sam¶>ğ
ä“_§m¶e
)

2911  
	`RET_ERROR
 (
EINVAL
);

2913 ià(
offs
 < 0 || off >ğ
§m¶es
[
§m¶e
].
Ën
)

2914  
	`RET_ERROR
 (
EINVAL
);

2918 
n
 = 
§m¶es
[
§m¶e
].
Ën
 - 
offs
;

2922 ià(
l
 > 
n
)

2923 
l
 = 
n
;

2925 ià(
l
 >  (
»c
->
d©a
.
d©a8
))

2926 
l
 =  (
»c
->
d©a
.
d©a8
);

2928 ià(
l
 <= 0)

2929  
	`RET_ERROR
 (
EINVAL
);

2933 
offs
 +ğ
§m¶e_±rs
[
§m¶e
];

2937 
n
 = 0;‚ < 
l
;‚++)

2938 
	`gus_poke
 (
offs
++, 
»c
->
d©a
.
d©a8
[
n
]);

2939 
»c
->
·rm1
 = 
n
;

2947  
	`RET_ERROR
 (
EINVAL
);

2949 
	}
}

2951 
syÁh_İ”©iÚs
 
	gguswave_İ”©iÚs
 =

2953 &
gus_šfo
,

2954 #ifdeà
FUTURE_VERSION


2957 
SYNTH_TYPE_SAMPLE
,

2958 
SAMPLE_TYPE_GUS
,

2959 
guswave_İ’
,

2960 
guswave_şo£
,

2961 
guswave_ioùl
,

2962 
guswave_kl_nÙe
,

2963 
guswave_¡¬t_nÙe
,

2964 
guswave_£t_š¡r
,

2965 
guswave_»£t
,

2966 
guswave_hw_cÚŒŞ
,

2967 
guswave_lßd_·tch
,

2968 
guswave_aá”touch
,

2969 
guswave_cÚŒŞËr
,

2970 
guswave_·Âšg
,

2971 
guswave_·tchmgr
,

2972 #ifdeà
FUTURE_VERSION


2973 
guswave_b’d”


2978 
	$£t_šput_vŞumes
()

2980 
æags
;

2981 
mask
 = 0xff & ~0x06;

2983 
	`DISABLE_INTR
(
æags
);

2990 ià(
gus_lše_vŞ
 > 10è
mask
 &= ~0x01;

2991 ià(
gus_mic_vŞ
 > 10è
mask
 |= 0x04;

2993 ià(
»cÜdšg_aùive
)

2998 ià(!(
gus_»cmask
 & 
SOUND_MASK_LINE
)è
mask
 |= 0x01;

2999 ià(!(
gus_»cmask
 & 
SOUND_MASK_MIC
)è
mask
 &= ~0x04;

3002 
mix_image
 &= ~0x07;

3003 
mix_image
 |ğ
mask
 & 0x07;

3004 
	`OUTB
 (
mix_image
, 
u_Mix”
);

3006 
	`RESTORE_INTR
(
æags
);

3007 
	}
}

3010 
	$gus_mix”_ioùl
 (
dev
, 
cmd
, 
¬g
)

3012 
	#MIX_DEVS
 (
SOUND_MASK_MIC
|
SOUND_MASK_LINE
| \

3013 
SOUND_MASK_SYNTH
|
SOUND_MASK_PCM
)

	)

3014 ià(((
cmd
 >> 8) & 0xff) == 'M')

3016 ià(
cmd
 & 
IOC_IN
)

3017 
cmd
 & 0xff)

3019 
SOUND_MIXER_RECSRC
:

3020 
gus_»cmask
 = 
	`IOCTL_IN
(
¬g
è& 
MIX_DEVS
;

3021 ià(!(
gus_»cmask
 & (
SOUND_MASK_MIC
|
SOUND_MASK_LINE
)))

3022 
gus_»cmask
 = 
SOUND_MASK_MIC
;

3024  
	`IOCTL_OUT
 (
¬g
, 
gus_»cmask
);

3027 
SOUND_MIXER_MIC
:

3029 
vŞ
 = 
	`IOCTL_IN
 (
¬g
) & 0xff;

3030 ià(
vŞ
 < 0) vol = 0;

3031 ià(
vŞ
 > 100) vol = 100;

3032 
gus_mic_vŞ
 = 
vŞ
;

3033 
	`£t_šput_vŞumes
();

3034  
	`IOCTL_OUT
 (
¬g
, 
vŞ
 | (vol << 8));

3038 
SOUND_MIXER_LINE
:

3040 
vŞ
 = 
	`IOCTL_IN
 (
¬g
) & 0xff;

3041 ià(
vŞ
 < 0) vol = 0;

3042 ià(
vŞ
 > 100) vol = 100;

3043 
gus_lše_vŞ
 = 
vŞ
;

3044 
	`£t_šput_vŞumes
();

3045  
	`IOCTL_OUT
 (
¬g
, 
vŞ
 | (vol << 8));

3049 
SOUND_MIXER_PCM
:

3050 
gus_pcm_vŞume
 = 
	`IOCTL_IN
 (
¬g
) & 0xff;

3051 ià(
gus_pcm_vŞume
 < 0)

3052 
gus_pcm_vŞume
 = 0;

3053 ià(
gus_pcm_vŞume
 > 100)

3054 
gus_pcm_vŞume
 = 100;

3055 
	`gus_§m¶šg_upd©e_vŞume
 ();

3056  
	`IOCTL_OUT
 (
¬g
, 
gus_pcm_vŞume
 | (gus_pcm_volume << 8));

3059 
SOUND_MIXER_SYNTH
:

3061 
voiû
;

3063 
gus_wave_vŞume
 = 
	`IOCTL_IN
 (
¬g
) & 0xff;

3065 ià(
gus_wave_vŞume
 < 0)

3066 
gus_wave_vŞume
 = 0;

3067 ià(
gus_wave_vŞume
 > 100)

3068 
gus_wave_vŞume
 = 100;

3070 ià(
aùive_deviû
 =ğ
GUS_DEV_WAVE
)

3071 
voiû
 = 0; voiû < 
Ä_voiûs
; voice++)

3072 
	`dyÇmic_vŞume_chªge
 (
voiû
);

3077  
	`IOCTL_OUT
 (
¬g
, 
gus_wave_vŞume
 | (gus_wave_volume << 8));

3082  
	`RET_ERROR
 (
EINVAL
);

3085 
cmd
 & 0xff)

3090 
SOUND_MIXER_RECSRC
:

3091  
	`IOCTL_OUT
 (
¬g
, 
gus_»cmask
);

3094 
SOUND_MIXER_DEVMASK
:

3095  
	`IOCTL_OUT
 (
¬g
, 
MIX_DEVS
);

3098 
SOUND_MIXER_STEREODEVS
:

3099  
	`IOCTL_OUT
 (
¬g
, 0);

3102 
SOUND_MIXER_RECMASK
:

3103  
	`IOCTL_OUT
 (
¬g
, 
SOUND_MASK_MIC
|
SOUND_MASK_LINE
);

3106 
SOUND_MIXER_CAPS
:

3107  
	`IOCTL_OUT
 (
¬g
, 0);

3110 
SOUND_MIXER_MIC
:

3111  
	`IOCTL_OUT
 (
¬g
, 
gus_mic_vŞ
 | (gus_mic_vol << 8));

3114 
SOUND_MIXER_LINE
:

3115  
	`IOCTL_OUT
 (
¬g
, 
gus_lše_vŞ
 | (gus_line_vol << 8));

3118 
SOUND_MIXER_PCM
:

3119  
	`IOCTL_OUT
 (
¬g
, 
gus_pcm_vŞume
 | (gus_pcm_volume << 8));

3122 
SOUND_MIXER_SYNTH
:

3123  
	`IOCTL_OUT
 (
¬g
, 
gus_wave_vŞume
 | (gus_wave_volume << 8));

3127  
	`RET_ERROR
 (
EINVAL
);

3131  
	`RET_ERROR
 (
EINVAL
);

3132 
	}
}

3134 
mix”_İ”©iÚs
 
	ggus_mix”_İ”©iÚs
 =

3136 
gus_mix”_ioùl


3140 
	$gus_wave_š™
 (
mem_¡¬t
, 
œq
, 
dma
)

3142 
	`´štk
 (" <G¿vi UÉ¿Sound %dk>", (è
gus_mem_size
 / 1024);

3144 ià(
œq
 < 0 || irq > 15)

3146 
	`´štk
 ("ERROR! Inv®id IRQ#%d. GUS Di§bËd", 
œq
);

3147  
mem_¡¬t
;

3150 ià(
dma
 < 0 || dma > 7)

3152 
	`´štk
 ("ERROR! Inv®id DMA#%d. GUS Di§bËd", 
dma
);

3153  
mem_¡¬t
;

3156 
gus_œq
 = 
œq
;

3157 
gus_dma
 = 
dma
;

3159 ià(
num_syÁhs
 >ğ
MAX_SYNTH_DEV
)

3160 
	`´štk
 ("GUS Error: Too many synthesizers\n");

3162 
syÁh_devs
[
num_syÁhs
++] = &
guswave_İ”©iÚs
;

3164 
	`PERMANENT_MALLOC
 (
·tch_šfo
 *, 
§m¶es
,

3165 (
MAX_SAMPLE
 + 1è*  (*
§m¶es
), 
mem_¡¬t
);

3167 
	`»£t_§m¶e_memÜy
 ();

3169 
	`gus_š™Ÿlize
 ();

3171 ià(
num_d¥devs
 < 
MAX_DSP_DEV
)

3173 
d¥_devs
[
gus_devnum
 = 
num_d¥devs
++] = &
gus_§m¶šg_İ”©iÚs
;

3174 
sound_d¥_dmachª
[
gus_devnum
] = 
dma
;

3175 
sound_buffcouÁs
[
gus_devnum
] = 1;

3176 
sound_buffsizes
[
gus_devnum
] = 
DSP_BUFFSIZE
;

3177 
sound_dma_automode
[
gus_devnum
] = 0;

3180 
	`´štk
 ("GUS: Too many PCM devices‡vailable\n");

3182 ià(
num_mix”s
 < 
MAX_MIXER_DEV
)

3186 
mix”_devs
[
num_mix”s
++] = &
gus_mix”_İ”©iÚs
;

3188  
mem_¡¬t
;

3189 
	}
}

3192 
	$do_loİ_œq
 (
voiû
)

3194 
tmp
;

3195 
mode
, 
·rm
;

3196 
æags
;

3198 
	`DISABLE_INTR
 (
æags
);

3199 
	`gus_£Ëù_voiû
 (
voiû
);

3201 
tmp
 = 
	`gus_»ad8
 (0x00);

3202 
tmp
 &= ~0x20;

3205 
	`gus_wr™e8
 (0x00, 
tmp
);

3207 
mode
 = 
voiûs
[
voiû
].
loİ_œq_mode
;

3208 
voiûs
[
voiû
].
loİ_œq_mode
 = 0;

3209 
·rm
 = 
voiûs
[
voiû
].
loİ_œq_·rm
;

3211 
mode
)

3214 
LMODE_FINISH
:

3218 ià((
	`gus_»ad16
 (0x09) >> 4) < 100)

3222 
	`gus_voiû_off
 ();

3223 
	`gus_¿mpoff
 ();

3224 
	`gus_voiû_š™
 (
voiû
);

3227 
	`gus_¿mp_¿nge
 (65, 4065);

3228 
	`gus_¿mp_¿‹
 (0, 63);

3231 
	`gus_¿mpÚ
 (0x20 | 0x40);

3234 
voiûs
[
voiû
].
vŞume_œq_mode
 = 
VMODE_HALT
;

3237 
LMODE_PCM_STOP
:

3238 
pcm_aùive
 = 0;

3241 
LMODE_PCM
:

3243 
Üig_qËn
 = 
pcm_qËn
;

3245 
pcm_qËn
--;

3246 
pcm_h—d
 = (pcm_h—d + 1è% 
pcm_nblk
;

3247 ià(
pcm_qËn
)

3249 
	`¶ay_Ãxt_pcm_block
 ();

3255 
	`gus_voiû_off
 ();

3256 
	`gus_¿mpoff
 ();

3257 
pcm_aùive
 = 0;

3260 ià(
Üig_qËn
 =ğ
pcm_nblk
)

3262 
	`DMAbuf_ouutšŒ
 (
gus_devnum
, 0);

3269 
	`RESTORE_INTR
 (
æags
);

3270 
	}
}

3273 
	$do_vŞume_œq
 (
voiû
)

3275 
tmp
;

3276 
mode
, 
·rm
;

3277 
æags
;

3279 
	`DISABLE_INTR
 (
æags
);

3281 
	`gus_£Ëù_voiû
 (
voiû
);

3283 
tmp
 = 
	`gus_»ad8
 (0x0d);

3284 
tmp
 &= ~0x20;

3287 
	`gus_wr™e8
 (0x0d, 
tmp
);

3289 
mode
 = 
voiûs
[
voiû
].
vŞume_œq_mode
;

3290 
voiûs
[
voiû
].
vŞume_œq_mode
 = 0;

3291 
·rm
 = 
voiûs
[
voiû
].
vŞume_œq_·rm
;

3293 
mode
)

3295 
VMODE_HALT
:

3298 
	`gus_voiû_š™
 (
voiû
);

3301 
VMODE_ENVELOPE
:

3302 
	`gus_¿mpoff
 ();

3303 
	`¡•_’v–İe
 (
voiû
);

3306 
VMODE_START_NOTE
:

3307 
	`guswave_¡¬t_nÙe2
 (
voiûs
[
voiû
].
dev_³ndšg
, voice,

3308 
voiûs
[
voiû
].
nÙe_³ndšg
, voiûs[voiû].
vŞume_³ndšg
);

3309 ià(
voiûs
[
voiû
].
kl_³ndšg
)

3310 
	`guswave_kl_nÙe
 (
voiûs
[
voiû
].
dev_³ndšg
, voice, 0);

3311 ià(
voiûs
[
voiû
].
§m¶e_³ndšg
 >= 0)

3313 
	`guswave_£t_š¡r
 (
voiûs
[
voiû
].
dev_³ndšg
, voice,

3314 
voiûs
[
voiû
].
§m¶e_³ndšg
);

3315 
voiûs
[
voiû
].
§m¶e_³ndšg
 = -1;

3322 
	`RESTORE_INTR
 (
æags
);

3323 
	}
}

3326 
	$gus_voiû_œq
 ()

3328 
wave_ignÜe
 = 0, 
vŞume_ignÜe
 = 0;

3329 
voiû_b™
;

3331 
¤c
, 
voiû
;

3335 
¤c
 = 
	`gus_»ad8
 (0x0f);

3338 
voiû
 = 
¤c
 & 0x1f;

3339 
¤c
 &= 0xc0;

3341 ià(
¤c
 == (0x80 | 0x40))

3346 
voiû_b™
 = 1 << 
voiû
;

3348 ià(!(
¤c
 & 0x80))

3351 ià(!(
wave_ignÜe
 & 
voiû_b™
è&& 
voiû
 < 
Ä_voiûs
)

3356 
wave_ignÜe
 |ğ
voiû_b™
;

3357 
	`do_loİ_œq
 (
voiû
);

3360 ià(!(
¤c
 & 0x40))

3363 ià(!(
vŞume_ignÜe
 & 
voiû_b™
è&& 
voiû
 < 
Ä_voiûs
)

3368 
vŞume_ignÜe
 |ğ
voiû_b™
;

3369 
	`do_vŞume_œq
 (
voiû
);

3372 
	}
}

3375 
	$guswave_dma_œq
 ()

3377 
¡©us
;

3379 
¡©us
 = 
	`gus_look8
 (0x41);

3382 ià(
¡©us
 & 0x40)

3385 
aùive_deviû
)

3387 
GUS_DEV_WAVE
:

3388 ià(
	`SOMEONE_WAITING
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
))

3389 
	`WAKE_UP
 (
d¿m_¦“³r
, 
d¿m_¦“p_æag
);

3392 
GUS_DEV_PCM_CONTINUE
:

3393 
	`gus_Œªsãr_ouut_block
 (
pcm_cu¼’t_dev
, 
pcm_cu¼’t_buf
,

3394 
pcm_cu¼’t_couÁ
,

3395 
pcm_cu¼’t_šŒæag
, 1);

3398 
GUS_DEV_PCM_DONE
:

3399 ià(
pcm_qËn
 < 
pcm_nblk
)

3401 
	`DMAbuf_ouutšŒ
 (
gus_devnum
, 
pcm_qËn
 == 0);

3408 
¡©us
 = 
	`gus_look8
 (0x49);

3411 ià(
¡©us
 & 0x40)

3415 
	`DMAbuf_šputšŒ
 (
gus_devnum
);

3418 
	}
}

	@drivers/sound/midibuf.c

32 
	~"sound_cÚfig.h
"

34 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_MPU401
)

37 
	~"midiioùl.h
"

38 
	~"midiv¬.h
"

41 
	gmidibuf_busy
 = 0;

44 
	$MIDIbuf_İ’
 (
dev
, 
fešfo
 *
fe
)

46 
mode
, 
”r
;

48 
dev
 = dev >> 4;

49 
mode
 = 
fe
->mod& 
O_ACCMODE
;

51 ià(
midibuf_busy
)

52  
	`RET_ERROR
 (
EBUSY
);

54 ià(!
mpu401_dev
)

56 
	`´štk
 ("Midi: MPU-401 compatible Midi interface‚ot…resent\n");

57  
	`RET_ERROR
 (
ENXIO
);

60 ià((
”r
 = 
midi_devs
[
mpu401_dev
]->
	`İ’
 (mpu401_dev, 
mode
, 
NULL
, NULL)) < 0)

61  
”r
;

63 
midibuf_busy
 = 1;

65  
	`RET_ERROR
 (
ENXIO
);

66 
	}
}

69 
	$MIDIbuf_»Ëa£
 (
dev
, 
fešfo
 *
fe
)

71 
mode
;

73 
dev
 = dev >> 4;

74 
mode
 = 
fe
->mod& 
O_ACCMODE
;

76 
midi_devs
[
mpu401_dev
]->
	`şo£
 (mpu401_dev);

77 
midibuf_busy
 = 0;

78 
	}
}

81 
	$MIDIbuf_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

84 
dev
 = dev >> 4;

86  
couÁ
;

87 
	}
}

91 
	$MIDIbuf_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

93 
dev
 = dev >> 4;

95  
	`RET_ERROR
 (
EIO
);

96 
	}
}

99 
	$MIDIbuf_ioùl
 (
dev
, 
fešfo
 *
fe
,

100 
cmd
, 
¬g
)

102 
dev
 = dev >> 4;

104 
cmd
)

108  
midi_devs
[0]->
	`ioùl
 (
dev
, 
cmd
, 
¬g
);

110 
	}
}

113 
	$MIDIbuf_by‹s_»ûived
 (
dev
, *
buf
, 
couÁ
)

115 
	}
}

118 
	$MIDIbuf_š™
 (
mem_¡¬t
)

120  
mem_¡¬t
;

121 
	}
}

	@drivers/sound/mpu401.c

32 
	~"sound_cÚfig.h
"

34 #ifdeà
CONFIGURE_SOUNDCARD


36 #ià!
defšed
(
EXCLUDE_MPU401
è&& !defšed(
EXCLUDE_MIDI
)

38 
	#DATAPORT
 (
mpu401_ba£
è

	)

39 
	#COMDPORT
 (
mpu401_ba£
+1è

	)

40 
	#STATPORT
 (
mpu401_ba£
+1è

	)

42 
	#mpu401_¡©us
(è
	`INB
(
STATPORT
)

	)

43 
	#šput_ava
(è(!(
	`mpu401_¡©us
()&
INPUT_AVAIL
))

	)

44 
	#ouut_»ady
(è(!(
	`mpu401_¡©us
()&
OUTPUT_READY
))

	)

45 
	#mpu401_cmd
(
cmd
è
	`OUTB
(cmd, 
COMDPORT
)

	)

46 
	#mpu401_»ad
(è
	`INB
(
DATAPORT
)

	)

47 
	#mpu401_wr™e
(
by‹
è
	`OUTB
(by‹, 
DATAPORT
)

	)

49 
	#OUTPUT_READY
 0x40

	)

50 
	#INPUT_AVAIL
 0x80

	)

51 
	#MPU_ACK
 0xFE

	)

52 
	#MPU_RESET
 0xFF

	)

53 
	#UART_MODE_ON
 0x3F

	)

55 
	gmpu401_İ’ed
 = 0;

56 
	gmpu401_ba£
 = 0x330;

57 
	gmpu401_œq
;

58 
	gmpu401_d‘eùed
 = 0;

59 
	gmy_dev
;

61 
»£t_mpu401
 ();

62 (*
midi_šput_šŒ
è(
dev
, 
d©a
);

65 
	$mpu401_šput_loİ
 ()

67 
couÁ
;

69 
couÁ
 = 10;

71 
couÁ
)

72 ià(
	`šput_ava
 ())

74 
c
 = 
	`mpu401_»ad
 ();

76 
couÁ
 = 100;

78 ià(
mpu401_İ’ed
 & 
OPEN_READ
)

79 
	`midi_šput_šŒ
 (
my_dev
, 
c
);

82 !
	`šput_ava
 (è&& 
couÁ
)

83 
couÁ
--;

84 
	}
}

87 
	$mpušŒ
 (
un™
)

89 ià(
	`šput_ava
 ())

90 
	`mpu401_šput_loİ
 ();

91 
	}
}

99 
	$pŞl_mpu401
 (
dummy
)

101 
æags
;

103 
	`DEFINE_TIMER
(
mpu401_tim”
, 
pŞl_mpu401
);

105 ià(!(
mpu401_İ’ed
 & 
OPEN_READ
))

108 
	`DISABLE_INTR
 (
æags
);

110 ià(
	`šput_ava
 ())

111 
	`mpu401_šput_loİ
 ();

113 
	`ACTIVATE_TIMER
(
mpu401_tim”
, 
pŞl_mpu401
, 1);

115 
	`RESTORE_INTR
 (
æags
);

116 
	}
}

119 
mpu401_İ’
 (
dev
, 
mode
,

120 (*
šput
è(
dev
, 
d©a
),

121 (*
ouut
è(
dev
)

124 ià(
mpu401_İ’ed
)

126 
	`´štk
 ("MPU-401: Midi busy\n");

127  
	`RET_ERROR
 (
EBUSY
);

130 
	`mpu401_šput_loİ
 ();

132 
midi_šput_šŒ
 = 
šput
;

133 
mpu401_İ’ed
 = 
mode
;

134 
	`pŞl_mpu401
 (0);

137 
	}
}

140 
	$mpu401_şo£
 (
dev
)

142 
mpu401_İ’ed
 = 0;

143 
	}
}

146 
	$mpu401_out
 (
dev
, 
midi_by‹
)

148 
timeout
;

149 
æags
;

155 
	`DISABLE_INTR
 (
æags
);

157 ià(
	`šput_ava
 ())

158 
	`mpu401_šput_loİ
 ();

160 
	`RESTORE_INTR
 (
æags
);

167 
timeout
 = 30000;imeouˆ> 0 && !
	`ouut_»ady
 ();imeout--);

169 ià(!
	`ouut_»ady
 ())

171 
	`´štk
 ("MPU-401: Timeout\n");

175 
	`mpu401_wr™e
 (
midi_by‹
);

177 
	}
}

180 
	$mpu401_commªd
 (
dev
, 
midi_by‹
)

183 
	}
}

186 
	$mpu401_¡¬t_»ad
 (
dev
)

189 
	}
}

192 
	$mpu401_’d_»ad
 (
dev
)

195 
	}
}

198 
	$mpu401_ioùl
 (
dev
, 
cmd
, 
¬g
)

200  
	`RET_ERROR
 (
EINVAL
);

201 
	}
}

204 
	$mpu401_kick
 (
dev
)

206 
	}
}

209 
	$mpu401_bufãr_¡©us
 (
dev
)

212 
	}
}

214 
midi_İ”©iÚs
 
	gmpu401_İ”©iÚs
 =

216 {"MPU-401", 0, 0, 
SNDCARD_MPU401
},

217 
mpu401_İ’
,

218 
mpu401_şo£
,

219 
mpu401_ioùl
,

220 
mpu401_out
,

221 
mpu401_¡¬t_»ad
,

222 
mpu401_’d_»ad
,

223 
mpu401_kick
,

224 
mpu401_commªd
,

225 
mpu401_bufãr_¡©us


230 
	$©ch_mpu401
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

232 
ok
, 
timeout
;

233 
æags
;

235 
mpu401_ba£
 = 
hw_cÚfig
->
io_ba£
;

236 
mpu401_œq
 = 
hw_cÚfig
->
œq
;

238 ià(!
mpu401_d‘eùed
)

239  
	`RET_ERROR
 (
EIO
);

241 
	`DISABLE_INTR
 (
æags
);

242 
timeout
 = 30000;imeouˆ< 0 && !
	`ouut_»ady
 ();imeout--);

243 
	`mpu401_cmd
 (
UART_MODE_ON
);

245 
ok
 = 0;

246 
timeout
 = 50000;imeouˆ> 0 && !
ok
;imeout--)

247 ià(
	`šput_ava
 ())

248 ià(
	`mpu401_»ad
 (è=ğ
MPU_ACK
)

249 
ok
 = 1;

251 
	`RESTORE_INTR
 (
æags
);

253 
	`´štk
 (" <Roland MPU-401>");

255 
my_dev
 = 
num_midis
;

256 
mpu401_dev
 = 
num_midis
;

257 
midi_devs
[
num_midis
++] = &
mpu401_İ”©iÚs
;

258  
mem_¡¬t
;

259 
	}
}

262 
	$»£t_mpu401
 ()

264 
æags
;

265 
ok
, 
timeout
, 
n
;

271 
ok
 = 0;

273 
	`DISABLE_INTR
 (
æags
);

275 
n
 = 0;‚ < 2 && !
ok
;‚++)

277 
timeout
 = 30000;imeouˆ< 0 && !
	`ouut_»ady
 ();imeout--);

278 
	`mpu401_cmd
 (
MPU_RESET
);

285 
timeout
 = 50000;imeouˆ> 0 && !
ok
;imeout--)

286 ià(
	`šput_ava
 ())

287 ià(
	`mpu401_»ad
 (è=ğ
MPU_ACK
)

288 
ok
 = 1;

292 
mpu401_İ’ed
 = 0;

293 ià(
ok
)

294 
	`mpu401_šput_loİ
 ();

296 
	`RESTORE_INTR
 (
æags
);

298  
ok
;

299 
	}
}

303 
	$´obe_mpu401
 (
add»ss_šfo
 *
hw_cÚfig
)

305 
ok
 = 0;

307 
mpu401_ba£
 = 
hw_cÚfig
->
io_ba£
;

308 
mpu401_œq
 = 
hw_cÚfig
->
œq
;

310 ià(
	`¢d_£t_œq_hªdËr
 (
mpu401_œq
, 
mpušŒ
) < 0)

313 
ok
 = 
	`»£t_mpu401
 ();

315 
mpu401_d‘eùed
 = 
ok
;

316  
ok
;

317 
	}
}

	@drivers/sound/opl3.c

33 
	~"sound_cÚfig.h
"

35 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_YM3812
)

37 
	~"İl3.h
"

39 
	#MAX_VOICE
 18

	)

40 
	#OFFS_4OP
 11

	)

43 
	gİl3_’abËd
 = 0;

44 
	gËá_add»ss
 = 0x388, 
	gright_add»ss
 = 0x388, 
	gbÙh_add»ss
 = 0;

46 
	gÄ_voiûs
 = 9;

47 
	glogiÿl_voiûs
[
MAX_VOICE
] =

50 
	svoiû_šfo


52 
	mkeyÚ_by‹
;

53 
	mb’d”
;

54 
	mb’d”_¿nge
;

55 
	mÜig_äeq
;

56 
	mcu¼’t_äeq
;

57 
	mmode
;

60 
voiû_šfo
 
	gvoiûs
[
MAX_VOICE
];

62 
sbi_š¡rum’t
 *
	gš¡rm­
;

63 
sbi_š¡rum’t
 *
	gaùive_š¡rum’t
[
MAX_VOICE
] =

64 {
NULL
};

66 
syÁh_šfo
 
	gfm_šfo
 =

67 {"AdLib", 0, 
SYNTH_TYPE_FM
, 
FM_TYPE_ADLIB
, 0, 9, 0, 
SBFM_MAXINSTR
, 0};

69 
	g®»ady_š™Ÿlized
 = 0;

71 
	gİl3_ok
 = 0;

72 
	gİl3_busy
 = 0;

73 
	gfm_mod–
 = 0;

75 
¡Üe_š¡r
 (
š¡r_no
, 
sbi_š¡rum’t
 *
š¡r
);

76 
äeq_to_âum
 (
äeq
, *
block
, *
âum
);

77 
İl3_commªd
 (
io_addr
, 
addr
, 
v®
);

78 
İl3_kl_nÙe
 (
dev
, 
voiû
, 
v–oc™y
);

79 
	gcÚÃùiÚ_mask
 = 0x00;

82 
	$’abË_İl3_mode
 (
Ëá
, 
right
, 
bÙh
)

84 
İl3_’abËd
 = 1;

85 
Ëá_add»ss
 = 
Ëá
;

86 
right_add»ss
 = 
right
;

87 
bÙh_add»ss
 = 
bÙh
;

88 
fm_šfo
.
ÿ·b™›s
 = 
SYNTH_CAP_OPL3
;

89 
fm_šfo
.
syÁh_subty³
 = 
FM_TYPE_OPL3
;

90 
	}
}

93 
	$’‹r_4İ_mode
 ()

95 
i
;

96 
voiûs_4İ
[
MAX_VOICE
] =

99 
cÚÃùiÚ_mask
 = 0x3f;

100 
	`İl3_commªd
 (
right_add»ss
, 
CONNECTION_SELECT_REGISTER
, 0x3f);

102 
i
 = 0; i < 3; i++)

103 
physiÿl_voiûs
[
i
].
voiû_mode
 = 4;

104 
i
 = 3; i < 6; i++)

105 
physiÿl_voiûs
[
i
].
voiû_mode
 = 0;

107 
i
 = 9; i < 12; i++)

108 
physiÿl_voiûs
[
i
].
voiû_mode
 = 4;

109 
i
 = 12; i < 15; i++)

110 
physiÿl_voiûs
[
i
].
voiû_mode
 = 0;

112 
i
 = 0; i < 12; i++)

113 
logiÿl_voiûs
[
i
] = 
voiûs_4İ
[i];

114 
Ä_voiûs
 = 12;

115 
	}
}

118 
	$İl3_ioùl
 (
dev
,

119 
cmd
, 
¬g
)

121 
cmd
)

124 
SNDCTL_FM_LOAD_INSTR
:

126 
sbi_š¡rum’t
 
šs
;

128 
	`IOCTL_FROM_USER
 ((*è&
šs
, (*è
¬g
, 0,  (ins));

130 ià(
šs
.
chªÃl
 < 0 || ins.chªÃÈ>ğ
SBFM_MAXINSTR
)

132 
	`´štk
 ("FM E¼Ü: Inv®id in¡rum’ˆnumb” %d\n", 
šs
.
chªÃl
);

133  
	`RET_ERROR
 (
EINVAL
);

136 
	`pmgr_šfÜm
 (
dev
, 
PM_E_PATCH_LOADED
, 
šs
.
chªÃl
, 0, 0, 0);

137  
	`¡Üe_š¡r
 (
šs
.
chªÃl
, &ins);

141 
SNDCTL_SYNTH_INFO
:

142 
fm_šfo
.
Ä_voiûs
 = (nr_voices == 12) ? 6 :‚r_voices;

144 
	`IOCTL_TO_USER
 ((*è
¬g
, 0, &
fm_šfo
,  (fm_info));

148 
SNDCTL_SYNTH_MEMAVL
:

152 
SNDCTL_FM_4OP_ENABLE
:

153 ià(
İl3_’abËd
)

154 
	`’‹r_4İ_mode
 ();

159  
	`RET_ERROR
 (
EINVAL
);

162 
	}
}

165 
	$İl3_d‘eù
 (
ißddr
)

178 
¡©1
, 
¡©2
;

179 
i
;

181 ià(
®»ady_š™Ÿlized
)

186 ià(
İl3_’abËd
)

187 
ißddr
 = 
Ëá_add»ss
;

189 
	`İl3_commªd
 (
ißddr
, 
TIMER_CONTROL_REGISTER
, 
TIMER1_MASK
 | 
TIMER2_MASK
);

190 
	`İl3_commªd
 (
ißddr
, 
TIMER_CONTROL_REGISTER
, 
IRQ_RESET
);

193 
¡©1
 = 
	`INB
 (
ißddr
);

195 ià((
¡©1
 & 0xE0) != 0x00)

200 
	`İl3_commªd
 (
ißddr
, 
TIMER1_REGISTER
, 0xff);

201 
	`İl3_commªd
 (
ißddr
, 
TIMER_CONTROL_REGISTER
,

202 
TIMER2_MASK
 | 
TIMER1_START
);

208 
i
 = 0; i < 50; i++)

209 
	`‹nmiüo£c
 ();

211 
¡©2
 = 
	`INB
 (
ißddr
);

215 
	`İl3_commªd
 (
ißddr
, 
TIMER_CONTROL_REGISTER
, 
TIMER1_MASK
 | 
TIMER2_MASK
);

216 
	`İl3_commªd
 (
ißddr
, 
TIMER_CONTROL_REGISTER
, 
IRQ_RESET
);

219 ià((
¡©2
 & 0xE0) != 0xc0)

226 
i
 = 0; i < 9; i++)

227 
	`İl3_commªd
 (
ißddr
, 
KEYON_BLOCK
 + 
i
, 0);

229 
	`İl3_commªd
 (
ißddr
, 
TEST_REGISTER
, 
ENABLE_WAVE_SELECT
);

230 
	`İl3_commªd
 (
ißddr
, 
PERCUSSION_REGISTER
, 0x00);

233 
	}
}

236 
	$İl3_kl_nÙe
 (
dev
, 
voiû
, 
v–oc™y
)

238 
physiÿl_voiû_šfo
 *
m­
;

240 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

243 
m­
 = &
physiÿl_voiûs
[
logiÿl_voiûs
[
voiû
]];

245 
	`DEB
 (
	`´štk
 ("KÈnÙ%d\n", 
voiû
));

247 ià(
m­
->
voiû_mode
 == 0)

250 
	`İl3_commªd
 (
m­
->
ißddr
, 
KEYON_BLOCK
 + m­->
voiû_num
, 
voiûs
[
voiû
].
keyÚ_by‹
 & ~0x20);

252 
voiûs
[
voiû
].
keyÚ_by‹
 = 0;

253 
voiûs
[
voiû
].
b’d”
 = 0;

254 
voiûs
[
voiû
].
b’d”_¿nge
 = 200;

255 
voiûs
[
voiû
].
Üig_äeq
 = 0;

256 
voiûs
[
voiû
].
cu¼’t_äeq
 = 0;

257 
voiûs
[
voiû
].
mode
 = 0;

260 
	}
}

262 
	#HIHAT
 0

	)

263 
	#CYMBAL
 1

	)

264 
	#TOMTOM
 2

	)

265 
	#SNARE
 3

	)

266 
	#BDRUM
 4

	)

267 
	#UNDEFINED
 
TOMTOM


	)

268 
	#DEFAULT
 
TOMTOM


	)

271 
	$¡Üe_š¡r
 (
š¡r_no
, 
sbi_š¡rum’t
 *
š¡r
)

274 ià(
š¡r
->
key
 !ğ
FM_PATCH
 && (š¡r->key !ğ
OPL3_PATCH
 || !
İl3_’abËd
))

275 
	`´štk
 ("FM w¬nšg: Inv®id…©ch fÜm© f›ld (keyè0x%x\n", 
š¡r
->
key
);

276 
	`memıy
 ((*è&(
š¡rm­
[
š¡r_no
]), (*è
š¡r
,  (*instr));

279 
	}
}

282 
	$İl3_£t_š¡r
 (
dev
, 
voiû
, 
š¡r_no
)

284 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

287 ià(
š¡r_no
 < 0 || in¡r_nØ>ğ
SBFM_MAXINSTR
)

290 
aùive_š¡rum’t
[
voiû
] = &
š¡rm­
[
š¡r_no
];

292 
	}
}

303 
	gfm_vŞume_bË
[128] =

322 
	$ÿlc_vŞ
 (*
»gby‹
, 
vŞume
)

324 
Ëv–
 = (~*
»gby‹
 & 0x3f);

326 ià(
Ëv–
)

327 
Ëv–
 +ğ
fm_vŞume_bË
[
vŞume
];

329 ià(
Ëv–
 > 0x3f)

330 
Ëv–
 = 0x3f;

331 ià(
Ëv–
 < 0)

332 
Ëv–
 = 0;

334 *
»gby‹
 = (*»gby‹ & 0xc0è| (~
Ëv–
 & 0x3f);

335 
	}
}

338 
	$£t_voiû_vŞume
 (
voiû
, 
vŞume
)

340 
vŞ1
, 
vŞ2
, 
vŞ3
, 
vŞ4
;

341 
sbi_š¡rum’t
 *
š¡r
;

342 
physiÿl_voiû_šfo
 *
m­
;

344 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

347 
m­
 = &
physiÿl_voiûs
[
logiÿl_voiûs
[
voiû
]];

349 
š¡r
 = 
aùive_š¡rum’t
[
voiû
];

351 ià(!
š¡r
)

352 
š¡r
 = &
š¡rm­
[0];

354 ià(
š¡r
->
chªÃl
 < 0)

357 ià(
voiûs
[
voiû
].
mode
 == 0)

360 ià(
voiûs
[
voiû
].
mode
 == 2)

363 
vŞ1
 = 
š¡r
->
İ”©Üs
[2];

364 
vŞ2
 = 
š¡r
->
İ”©Üs
[3];

366 ià((
š¡r
->
İ”©Üs
[10] & 0x01))

368 
	`ÿlc_vŞ
 (&
vŞ1
, 
vŞume
);

369 
	`ÿlc_vŞ
 (&
vŞ2
, 
vŞume
);

373 
	`ÿlc_vŞ
 (&
vŞ2
, 
vŞume
);

376 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[0], 
vŞ1
);

377 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[1], 
vŞ2
);

381 
cÚÃùiÚ
;

383 
vŞ1
 = 
š¡r
->
İ”©Üs
[2];

384 
vŞ2
 = 
š¡r
->
İ”©Üs
[3];

385 
vŞ3
 = 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 2];

386 
vŞ4
 = 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 3];

393 
cÚÃùiÚ
 = ((
š¡r
->
İ”©Üs
[10] & 0x01è<< 1è| (š¡r->İ”©Üs[10 + 
OFFS_4OP
] & 0x01);

395 
cÚÃùiÚ
)

398 
	`ÿlc_vŞ
 (&
vŞ4
, 
vŞume
);

402 
	`ÿlc_vŞ
 (&
vŞ2
, 
vŞume
);

403 
	`ÿlc_vŞ
 (&
vŞ4
, 
vŞume
);

407 
	`ÿlc_vŞ
 (&
vŞ1
, 
vŞume
);

408 
	`ÿlc_vŞ
 (&
vŞ4
, 
vŞume
);

412 
	`ÿlc_vŞ
 (&
vŞ1
, 
vŞume
);

413 
	`ÿlc_vŞ
 (&
vŞ3
, 
vŞume
);

414 
	`ÿlc_vŞ
 (&
vŞ4
, 
vŞume
);

420 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[0], 
vŞ1
);

421 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[1], 
vŞ2
);

422 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[2], 
vŞ3
);

423 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[3], 
vŞ4
);

425 
	}
}

428 
	$İl3_¡¬t_nÙe
 (
dev
, 
voiû
, 
nÙe
, 
vŞume
)

430 
d©a
, 
åc
;

431 
block
, 
âum
, 
äeq
, 
voiû_mode
;

432 
sbi_š¡rum’t
 *
š¡r
;

433 
physiÿl_voiû_šfo
 *
m­
;

435 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

438 
m­
 = &
physiÿl_voiûs
[
logiÿl_voiûs
[
voiû
]];

440 ià(
m­
->
voiû_mode
 == 0)

443 ià(
nÙe
 == 255)

445 
	`£t_voiû_vŞume
 (
voiû
, 
vŞume
);

450 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[1], 0xff);

451 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[0], 0xff);

453 ià(
m­
->
voiû_mode
 == 4)

455 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[2], 0xff);

456 
	`İl3_commªd
 (
m­
->
ißddr
, 
KSL_LEVEL
 + m­->
İ
[3], 0xff);

459 
	`İl3_commªd
 (
m­
->
ißddr
, 
KEYON_BLOCK
 + m­->
voiû_num
, 0x00);

461 
š¡r
 = 
aùive_š¡rum’t
[
voiû
];

463 ià(!
š¡r
)

464 
š¡r
 = &
š¡rm­
[0];

466 ià(
š¡r
->
chªÃl
 < 0)

468 
	`´štk
 (

470 
voiû
);

474 ià(
m­
->
voiû_mode
 =ğ2 && 
š¡r
->
key
 =ğ
OPL3_PATCH
)

477 
voiû_mode
 = 
m­
->voice_mode;

479 ià(
voiû_mode
 == 4)

481 
voiû_shiá
;

483 
voiû_shiá
 = (
m­
->
ißddr
 =ğ
Ëá_add»ss
) ? 0 : 3;

484 
voiû_shiá
 +ğ
m­
->
voiû_num
;

486 ià(
š¡r
->
key
 !ğ
OPL3_PATCH
)

488 
voiû_mode
 = 2;

489 
cÚÃùiÚ_mask
 &ğ~(1 << 
voiû_shiá
);

493 
cÚÃùiÚ_mask
 |ğ(1 << 
voiû_shiá
);

496 
	`İl3_commªd
 (
right_add»ss
, 
CONNECTION_SELECT_REGISTER
, 
cÚÃùiÚ_mask
);

500 
	`İl3_commªd
 (
m­
->
ißddr
, 
AM_VIB
 + m­->
İ
[0], 
š¡r
->
İ”©Üs
[0]);

501 
	`İl3_commªd
 (
m­
->
ißddr
, 
AM_VIB
 + m­->
İ
[1], 
š¡r
->
İ”©Üs
[1]);

504 
	`İl3_commªd
 (
m­
->
ißddr
, 
ATTACK_DECAY
 + m­->
İ
[0], 
š¡r
->
İ”©Üs
[4]);

505 
	`İl3_commªd
 (
m­
->
ißddr
, 
ATTACK_DECAY
 + m­->
İ
[1], 
š¡r
->
İ”©Üs
[5]);

508 
	`İl3_commªd
 (
m­
->
ißddr
, 
SUSTAIN_RELEASE
 + m­->
İ
[0], 
š¡r
->
İ”©Üs
[6]);

509 
	`İl3_commªd
 (
m­
->
ißddr
, 
SUSTAIN_RELEASE
 + m­->
İ
[1], 
š¡r
->
İ”©Üs
[7]);

512 
	`İl3_commªd
 (
m­
->
ißddr
, 
WAVE_SELECT
 + m­->
İ
[0], 
š¡r
->
İ”©Üs
[8]);

513 
	`İl3_commªd
 (
m­
->
ißddr
, 
WAVE_SELECT
 + m­->
İ
[1], 
š¡r
->
İ”©Üs
[9]);

516 
åc
 = 
š¡r
->
İ”©Üs
[10];

517 ià(!(
åc
 & 0x30))

518 
åc
 |= 0x30;

519 
	`İl3_commªd
 (
m­
->
ißddr
, 
FEEDBACK_CONNECTION
 + m­->
voiû_num
,

520 
åc
);

526 ià(
voiû_mode
 == 4)

530 
	`İl3_commªd
 (
m­
->
ißddr
, 
AM_VIB
 + m­->
İ
[2], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 0]);

531 
	`İl3_commªd
 (
m­
->
ißddr
, 
AM_VIB
 + m­->
İ
[3], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 1]);

534 
	`İl3_commªd
 (
m­
->
ißddr
, 
ATTACK_DECAY
 + m­->
İ
[2], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 4]);

535 
	`İl3_commªd
 (
m­
->
ißddr
, 
ATTACK_DECAY
 + m­->
İ
[3], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 5]);

538 
	`İl3_commªd
 (
m­
->
ißddr
, 
SUSTAIN_RELEASE
 + m­->
İ
[2], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 6]);

539 
	`İl3_commªd
 (
m­
->
ißddr
, 
SUSTAIN_RELEASE
 + m­->
İ
[3], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 7]);

542 
	`İl3_commªd
 (
m­
->
ißddr
, 
WAVE_SELECT
 + m­->
İ
[2], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 8]);

543 
	`İl3_commªd
 (
m­
->
ißddr
, 
WAVE_SELECT
 + m­->
İ
[3], 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 9]);

546 
åc
 = 
š¡r
->
İ”©Üs
[
OFFS_4OP
 + 10];

547 ià(!(
åc
 & 0x30))

548 
åc
 |= 0x30;

549 
	`İl3_commªd
 (
m­
->
ißddr
, 
FEEDBACK_CONNECTION
 + m­->
voiû_num
 + 3, 
åc
);

552 
voiûs
[
voiû
].
mode
 = 
voiû_mode
;

554 
	`£t_voiû_vŞume
 (
voiû
, 
vŞume
);

556 
äeq
 = 
voiûs
[
voiû
].
Üig_äeq
 = 
	`nÙe_to_äeq
 (
nÙe
) / 1000;

563 
äeq
 = 
	`compu‹_fš‘uÃ
 (
voiûs
[
voiû
].
Üig_äeq
, voiûs[voiû].
b’d”
, voiûs[voiû].
b’d”_¿nge
);

564 
voiûs
[
voiû
].
cu¼’t_äeq
 = 
äeq
;

566 
	`äeq_to_âum
 (
äeq
, &
block
, &
âum
);

570 
d©a
 = 
âum
 & 0xff;

571 
	`İl3_commªd
 (
m­
->
ißddr
, 
FNUM_LOW
 + m­->
voiû_num
, 
d©a
);

573 
d©a
 = 0x20 | ((
block
 & 0x7è<< 2è| ((
âum
 >> 8) & 0x3);

574 
voiûs
[
voiû
].
keyÚ_by‹
 = 
d©a
;

575 
	`İl3_commªd
 (
m­
->
ißddr
, 
KEYON_BLOCK
 + m­->
voiû_num
, 
d©a
);

576 ià(
voiû_mode
 == 4)

577 
	`İl3_commªd
 (
m­
->
ißddr
, 
KEYON_BLOCK
 + m­->
voiû_num
 + 3, 
d©a
);

580 
	}
}

583 
	$äeq_to_âum
 (
äeq
, *
block
, *
âum
)

585 
f
, 
oùave
;

590 
f
 = 
äeq
;

592 
oùave
 = 5;

594 ià(
f
 == 0)

595 
oùave
 = 0;

596 ià(
f
 < 261)

598 
f
 < 261)

600 
oùave
--;

601 
f
 <<= 1;

604 ià(
f
 > 493)

606 
f
 > 493)

608 
oùave
++;

609 
f
 >>= 1;

613 ià(
oùave
 > 7)

614 
oùave
 = 7;

616 *
âum
 = 
äeq
 * (1 << (20 - 
oùave
)) / 49716;

617 *
block
 = 
oùave
;

618 
	}
}

621 
	$İl3_commªd
 (
io_addr
, 
addr
, 
v®
)

623 
i
;

630 
	`OUTB
 (()(
addr
 & 0xff), 
io_addr
);

632 ià(!
İl3_’abËd
)

633 
	`‹nmiüo£c
 ();

635 
i
 = 0; i < 2; i++)

636 
	`INB
 (
io_addr
);

638 
	`OUTB
 (()(
v®
 & 0xff), 
io_addr
 + 1);

640 ià(!
İl3_’abËd
)

642 
	`‹nmiüo£c
 ();

643 
	`‹nmiüo£c
 ();

644 
	`‹nmiüo£c
 ();

647 
i
 = 0; i < 2; i++)

648 
	`INB
 (
io_addr
);

649 
	}
}

652 
	$İl3_»£t
 (
dev
)

654 
i
;

656 
i
 = 0; i < 
Ä_voiûs
; i++)

658 
	`İl3_commªd
 (
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
ißddr
,

659 
KSL_LEVEL
 + 
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
İ
[0], 0xff);

661 
	`İl3_commªd
 (
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
ißddr
,

662 
KSL_LEVEL
 + 
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
İ
[1], 0xff);

664 ià(
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
voiû_mode
 == 4)

666 
	`İl3_commªd
 (
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
ißddr
,

667 
KSL_LEVEL
 + 
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
İ
[2], 0xff);

669 
	`İl3_commªd
 (
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
ißddr
,

670 
KSL_LEVEL
 + 
physiÿl_voiûs
[
logiÿl_voiûs
[
i
]].
İ
[3], 0xff);

673 
	`İl3_kl_nÙe
 (
dev
, 
i
, 64);

676 ià(
İl3_’abËd
)

678 
Ä_voiûs
 = 18;

680 
i
 = 0; i < 18; i++)

681 
logiÿl_voiûs
[
i
] = i;

683 
i
 = 0; i < 18; i++)

684 
physiÿl_voiûs
[
i
].
voiû_mode
 = 2;

688 
	}
}

691 
	$İl3_İ’
 (
dev
, 
mode
)

693 ià(!
İl3_ok
)

694  
	`RET_ERROR
 (
ENXIO
);

695 ià(
İl3_busy
)

696  
	`RET_ERROR
 (
EBUSY
);

697 
İl3_busy
 = 1;

699 
cÚÃùiÚ_mask
 = 0x00;

700 ià(
İl3_’abËd
)

701 
	`İl3_commªd
 (
right_add»ss
, 
CONNECTION_SELECT_REGISTER
, 
cÚÃùiÚ_mask
);

703 
	}
}

706 
	$İl3_şo£
 (
dev
)

708 
İl3_busy
 = 0;

709 
Ä_voiûs
 = 
İl3_’abËd
 ? 18 : 9;

710 
fm_šfo
.
Ä_drums
 = 0;

711 
fm_šfo
.
³rc_mode
 = 0;

713 
	`İl3_»£t
 (
dev
);

714 
	}
}

717 
	$İl3_hw_cÚŒŞ
 (
dev
, *
ev’t
)

719 
	}
}

722 
	$İl3_lßd_·tch
 (
dev
, 
fÜm©
, 
¢d_rw_buf
 * 
addr
,

723 
offs
, 
couÁ
, 
pmgr_æag
)

725 
sbi_š¡rum’t
 
šs
;

727 ià(
couÁ
 <  (
šs
))

729 
	`´štk
 ("FM Error: Patch„ecordoo short\n");

730  
	`RET_ERROR
 (
EINVAL
);

733 
	`COPY_FROM_USER
 (&((*è&
šs
)[
offs
], (*è
addr
, offs,  (ins) - offs);

735 ià(
šs
.
chªÃl
 < 0 || ins.chªÃÈ>ğ
SBFM_MAXINSTR
)

737 
	`´štk
 ("FM E¼Ü: Inv®id in¡rum’ˆnumb” %d\n", 
šs
.
chªÃl
);

738  
	`RET_ERROR
 (
EINVAL
);

740 
šs
.
key
 = 
fÜm©
;

742  
	`¡Üe_š¡r
 (
šs
.
chªÃl
, &ins);

743 
	}
}

746 
	$İl3_·Âšg
 (
dev
, 
voiû
, 
´essu»
)

748 
	}
}

750 
	#SET_VIBRATO
(
ûÎ
) { \

751 
tmp
 = 
š¡r
->
İ”©Üs
[(
ûÎ
-1)+(((ûÎ-1)/2)*
OFFS_4OP
)]; \

752 ià(
´essu»
 > 110) \

753 
tmp
 |= 0x40; \

754 
	`İl3_commªd
 (
m­
->
ißddr
, 
AM_VIB
 + m­->
İ
[
ûÎ
-1], 
tmp
);}

	)

757 
	$İl3_aá”touch
 (
dev
, 
voiû
, 
´essu»
)

759 
tmp
;

760 
sbi_š¡rum’t
 *
š¡r
;

761 
physiÿl_voiû_šfo
 *
m­
;

763 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

766 
m­
 = &
physiÿl_voiûs
[
logiÿl_voiûs
[
voiû
]];

768 
	`DEB
 (
	`´štk
 ("Aá”touch %d\n", 
voiû
));

770 ià(
m­
->
voiû_mode
 == 0)

777 
š¡r
 = 
aùive_š¡rum’t
[
voiû
];

779 ià(!
š¡r
)

780 
š¡r
 = &
š¡rm­
[0];

782 ià(
voiûs
[
voiû
].
mode
 == 4)

784 
cÚÃùiÚ
 = ((
š¡r
->
İ”©Üs
[10] & 0x01è<< 1è| (š¡r->İ”©Üs[10 + 
OFFS_4OP
] & 0x01);

786 
cÚÃùiÚ
)

789 
	`SET_VIBRATO
 (4);

793 
	`SET_VIBRATO
 (2);

794 
	`SET_VIBRATO
 (4);

798 
	`SET_VIBRATO
 (1);

799 
	`SET_VIBRATO
 (4);

803 
	`SET_VIBRATO
 (1);

804 
	`SET_VIBRATO
 (3);

805 
	`SET_VIBRATO
 (4);

813 
	`SET_VIBRATO
 (1);

815 ià((
š¡r
->
İ”©Üs
[10] & 0x01))

816 
	`SET_VIBRATO
 (2);

818 
	}
}

820 #undeà
SET_VIBRATO


823 
	$İl3_cÚŒŞËr
 (
dev
, 
voiû
, 
ù¾_num
, 
v®ue
)

825 
d©a
;

826 
block
, 
âum
, 
äeq
;

827 
physiÿl_voiû_šfo
 *
m­
;

829 ià(
voiû
 < 0 || voiû >ğ
Ä_voiûs
)

832 
m­
 = &
physiÿl_voiûs
[
logiÿl_voiûs
[
voiû
]];

834 ià(
m­
->
voiû_mode
 == 0)

837 
ù¾_num
)

839 
CTRL_PITCH_BENDER
:

840 
voiûs
[
voiû
].
b’d”
 = 
v®ue
;

841 ià(!
v®ue
)

843 ià(!(
voiûs
[
voiû
].
keyÚ_by‹
 & 0x20))

846 
äeq
 = 
	`compu‹_fš‘uÃ
 (
voiûs
[
voiû
].
Üig_äeq
, voiûs[voiû].
b’d”
, voiûs[voiû].
b’d”_¿nge
);

847 
voiûs
[
voiû
].
cu¼’t_äeq
 = 
äeq
;

849 
	`äeq_to_âum
 (
äeq
, &
block
, &
âum
);

851 
d©a
 = 
âum
 & 0xff;

852 
	`İl3_commªd
 (
m­
->
ißddr
, 
FNUM_LOW
 + m­->
voiû_num
, 
d©a
);

854 
d©a
 = 0x20 | ((
block
 & 0x7è<< 2è| ((
âum
 >> 8) & 0x3);

856 
voiûs
[
voiû
].
keyÚ_by‹
 = 
d©a
;

857 
	`İl3_commªd
 (
m­
->
ißddr
, 
KEYON_BLOCK
 + m­->
voiû_num
, 
d©a
);

860 
CTRL_PITCH_BENDER_RANGE
:

861 
voiûs
[
voiû
].
b’d”_¿nge
 = 
v®ue
;

864 
	}
}

867 
	$İl3_·tchmgr
 (
dev
, 
·tmgr_šfo
 *
»c
)

869  
	`RET_ERROR
 (
EINVAL
);

870 
	}
}

872 
syÁh_İ”©iÚs
 
	gİl3_İ”©iÚs
 =

874 &
fm_šfo
,

875 
SYNTH_TYPE_FM
,

876 
FM_TYPE_ADLIB
,

877 
İl3_İ’
,

878 
İl3_şo£
,

879 
İl3_ioùl
,

880 
İl3_kl_nÙe
,

881 
İl3_¡¬t_nÙe
,

882 
İl3_£t_š¡r
,

883 
İl3_»£t
,

884 
İl3_hw_cÚŒŞ
,

885 
İl3_lßd_·tch
,

886 
İl3_aá”touch
,

887 
İl3_cÚŒŞËr
,

888 
İl3_·Âšg
,

889 
İl3_·tchmgr


893 
	$İl3_š™
 (
mem_¡¬t
)

895 
i
;

897 
	`PERMANENT_MALLOC
(
sbi_š¡rum’t
*, 
š¡rm­
,

898 
SBFM_MAXINSTR
*(*
š¡rm­
), 
mem_¡¬t
);

900 
syÁh_devs
[
num_syÁhs
++] = &
İl3_İ”©iÚs
;

901 
fm_mod–
 = 0;

902 
İl3_ok
 = 1;

903 ià(
İl3_’abËd
)

905 
	`´štk
 (" <Yamaha OPL-3 FM>");

906 
fm_mod–
 = 2;

907 
Ä_voiûs
 = 18;

908 
fm_šfo
.
Ä_drums
 = 0;

909 
fm_šfo
.
ÿ·b™›s
 |ğ
SYNTH_CAP_OPL3
;

910 #iâdeà
SCO


911 
	`¡rıy
 (
fm_šfo
.
Çme
, "Yamaha OPL-3");

914 
i
 = 0; i < 18; i++)

915 ià(
physiÿl_voiûs
[
i
].
ißddr
 =ğ
USE_LEFT
)

916 
physiÿl_voiûs
[
i
].
ißddr
 = 
Ëá_add»ss
;

918 
physiÿl_voiûs
[
i
].
ißddr
 = 
right_add»ss
;

921 
	`İl3_commªd
 (
right_add»ss
, 
OPL3_MODE_REGISTER
, 
OPL3_ENABLE
);

922 
	`İl3_commªd
 (
right_add»ss
, 
CONNECTION_SELECT_REGISTER
, 0x00);

927 
	`´štk
 (" <Yamaha 2-OP FM>");

928 
fm_mod–
 = 1;

929 
Ä_voiûs
 = 9;

930 
fm_šfo
.
Ä_drums
 = 0;

932 
i
 = 0; i < 18; i++)

933 
physiÿl_voiûs
[
i
].
ißddr
 = 
Ëá_add»ss
;

936 
®»ady_š™Ÿlized
 = 1;

937 
i
 = 0; i < 
SBFM_MAXINSTR
; i++)

938 
š¡rm­
[
i
].
chªÃl
 = -1;

940  
mem_¡¬t
;

941 
	}
}

	@drivers/sound/opl3.h

61 
	#TEST_REGISTER
 0x01

	)

62 
	#ENABLE_WAVE_SELECT
 0x20

	)

64 
	#TIMER1_REGISTER
 0x02

	)

65 
	#TIMER2_REGISTER
 0x03

	)

66 
	#TIMER_CONTROL_REGISTER
 0x04

	)

67 
	#IRQ_RESET
 0x80

	)

68 
	#TIMER1_MASK
 0x40

	)

69 
	#TIMER2_MASK
 0x20

	)

70 
	#TIMER1_START
 0x01

	)

71 
	#TIMER2_START
 0x02

	)

73 
	#CONNECTION_SELECT_REGISTER
 0x04

	)

74 
	#RIGHT_4OP_0
 0x01

	)

75 
	#RIGHT_4OP_1
 0x02

	)

76 
	#RIGHT_4OP_2
 0x04

	)

77 
	#LEFT_4OP_0
 0x08

	)

78 
	#LEFT_4OP_1
 0x10

	)

79 
	#LEFT_4OP_2
 0x20

	)

81 
	#OPL3_MODE_REGISTER
 0x05

	)

82 
	#OPL3_ENABLE
 0x01

	)

84 
	#KBD_SPLIT_REGISTER
 0x08

	)

85 
	#COMPOSITE_SINE_WAVE_MODE
 0x80

	)

86 
	#KEYBOARD_SPLIT
 0x40

	)

88 
	#PERCUSSION_REGISTER
 0xbd

	)

89 
	#TREMOLO_DEPTH
 0x80

	)

90 
	#VIBRATO_DEPTH
 0x40

	)

91 
	#PERCUSSION_ENABLE
 0x20

	)

92 
	#BASSDRUM_ON
 0x10

	)

93 
	#SNAREDRUM_ON
 0x08

	)

94 
	#TOMTOM_ON
 0x04

	)

95 
	#CYMBAL_ON
 0x02

	)

96 
	#HIHAT_ON
 0x01

	)

104 
	#AM_VIB
 0x20

	)

105 
	#TREMOLO_ON
 0x80

	)

106 
	#VIBRATO_ON
 0x40

	)

107 
	#SUSTAIN_ON
 0x20

	)

108 
	#KSR
 0x10

	)

109 
	#MULTIPLE_MASK
 0x0à

	)

114 
	#KSL_LEVEL
 0x40

	)

115 
	#KSL_MASK
 0xc0

	)

116 
	#TOTAL_LEVEL_MASK
 0x3à

	)

121 
	#ATTACK_DECAY
 0x60

	)

122 
	#ATTACK_MASK
 0xf0

	)

123 
	#DECAY_MASK
 0x0f

	)

128 
	#SUSTAIN_RELEASE
 0x80

	)

129 
	#SUSTAIN_MASK
 0xf0

	)

130 
	#RELEASE_MASK
 0x0f

	)

135 
	#WAVE_SELECT
 0xe0

	)

143 
	#FNUM_LOW
 0xa0

	)

148 
	#KEYON_BLOCK
 0xb0

	)

149 
	#KEYON_BIT
 0x20

	)

150 
	#BLOCKNUM_MASK
 0x1c

	)

151 
	#FNUM_HIGH_MASK
 0x03

	)

165 
	#FEEDBACK_CONNECTION
 0xc0

	)

166 
	#FEEDBACK_MASK
 0x0

	)

167 
	#CONNECTION_BIT
 0x01

	)

202 
	#STEREO_BITS
 0x30

	)

203 
	#VOICE_TO_LEFT
 0x10

	)

204 
	#VOICE_TO_RIGHT
 0x20

	)

210 
	sphysiÿl_voiû_šfo
 {

211 
	mvoiû_num
;

212 
	mvoiû_mode
;

213 
	mißddr
;

214 
	mİ
[4];

230 
	#USE_LEFT
 0

	)

231 
	#USE_RIGHT
 1

	)

233 
physiÿl_voiû_šfo
 
	gphysiÿl_voiûs
[18] =

237 { 0, 2, 
USE_LEFT
, {0x00, 0x03, 0x08, 0x0b}},

238 { 1, 2, 
USE_LEFT
, {0x01, 0x04, 0x09, 0x0c}},

239 { 2, 2, 
USE_LEFT
, {0x02, 0x05, 0x0a, 0x0d}},

241 { 3, 2, 
USE_LEFT
, {0x08, 0x0b, 0x00, 0x00}},

242 { 4, 2, 
USE_LEFT
, {0x09, 0x0c, 0x00, 0x00}},

243 { 5, 2, 
USE_LEFT
, {0x0a, 0x0d, 0x00, 0x00}},

245 { 6, 2, 
USE_LEFT
, {0x10, 0x13, 0x00, 0x00}},

246 { 7, 2, 
USE_LEFT
, {0x11, 0x14, 0x00, 0x00}},

247 { 8, 2, 
USE_LEFT
, {0x12, 0x15, 0x00, 0x00}},

249 { 0, 2, 
USE_RIGHT
, {0x00, 0x03, 0x08, 0x0b}},

250 { 1, 2, 
USE_RIGHT
, {0x01, 0x04, 0x09, 0x0c}},

251 { 2, 2, 
USE_RIGHT
, {0x02, 0x05, 0x0a, 0x0d}},

253 { 3, 2, 
USE_RIGHT
, {0x08, 0x0b, 0x00, 0x00}},

254 { 4, 2, 
USE_RIGHT
, {0x09, 0x0c, 0x00, 0x00}},

255 { 5, 2, 
USE_RIGHT
, {0x0a, 0x0d, 0x00, 0x00}},

257 { 6, 2, 
USE_RIGHT
, {0x10, 0x13, 0x00, 0x00}},

258 { 7, 2, 
USE_RIGHT
, {0x11, 0x14, 0x00, 0x00}},

259 { 8, 2, 
USE_RIGHT
, {0x12, 0x15, 0x00, 0x00}}

	@drivers/sound/os.h

29 
	#ALLOW_SELECT


	)

31 
	~<lšux/·¿m.h
>

32 
	~<lšux/ty³s.h
>

33 
	~<lšux/”ºo.h
>

34 
	~<lšux/sigÇl.h
>

35 
	~<lšux/fú.h
>

36 
	~<lšux/sched.h
>

37 
	~<lšux/tim”.h
>

38 
	~<lšux/‰y.h
>

39 
	~<lšux/ùy³.h
>

40 
	~<asm/io.h
>

41 
	~<asm/£gm’t.h
>

42 
	~<asm/sy¡em.h
>

43 
	~<asm/dma.h
>

44 
	~<sys/kd.h
>

45 
	~<lšux/wa™.h
>

46 
	~<lšux/m®loc.h
>

47 
	~<lšux/soundÿrd.h
>

49 
	t¢d_rw_buf
;

51 
	#FALSE
 0

	)

52 
	#TRUE
 1

	)

54 
	#COPY_FROM_USER
(
d
, 
s
, 
o
, 
c
è
	`memıy_äomfs
((d), &((s)[o]), (c))

	)

55 
	#COPY_TO_USER
(
d
, 
o
, 
s
, 
c
è
	`memıy_tofs
(&((d)[o]), (s), (c))

	)

56 
	#IOCTL_FROM_USER
(
d
, 
s
, 
o
, 
c
è
	`memıy_äomfs
((d), &((s)[o]), (c))

	)

57 
	#IOCTL_TO_USER
(
d
, 
o
, 
s
, 
c
è
	`memıy_tofs
(&((d)[o]), (s), (c))

	)

59 
	#GET_BYTE_FROM_USER
(
rg‘
, 
addr
, 
offs
èrg‘ = 
	`g‘_fs_by‹
(&(×ddr)[offs]))

	)

60 
	#GET_SHORT_FROM_USER
(
rg‘
, 
addr
, 
offs
èrg‘ = 
	`g‘_fs_wÜd
(&(×ddr)[offs]))

	)

61 
	#GET_WORD_FROM_USER
(
rg‘
, 
addr
, 
offs
èrg‘ = 
	`g‘_fs_lÚg
((*)&(×ddr)[offs]))

	)

62 
	#PUT_WORD_TO_USER
(
addr
, 
offs
, 
d©a
è
	`put_fs_lÚg
(d©a, (*)&(×ddr)[offs]))

	)

63 
	#IOCTL_IN
(
¬g
è
	`g‘_fs_lÚg
((*)×rg))

	)

64 
	#IOCTL_OUT
(
¬g
, 
»t
è
	`¢d_ioùl_»tuº
((*ïrg,„‘)

	)

66 
	s¢d_wa™
 {

67 
	mmode
; 
	mabÜtšg
;

70 
	#DEFINE_WAIT_QUEUE
(
Çme
, 
æag
è
wa™_queue
 *Çmğ
NULL
; \

71 vŞ©
¢d_wa™
 
æag
 = {0}

	)

72 
	#DEFINE_WAIT_QUEUES
(
Çme
, 
æag
è
wa™_queue
 *Çmğ{
NULL
}; \

73 vŞ©
¢d_wa™
 
æag
 = {{0}}

	)

74 
	#RESET_WAIT_QUEUE
(
q
, 
f
è{f.
abÜtšg
 = 0;f.
mode
 = 
WK_NONE
;}

	)

75 
	#PROCESS_ABORTING
(
q
, 
f
è(f.
abÜtšg
 | (
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
))

	)

76 
	#SET_ABORT_FLAG
(
q
, 
f
èf.
abÜtšg
 = 1

	)

77 
	#TIMED_OUT
(
q
, 
f
è(f.
mode
 & 
WK_TIMEOUT
)

	)

78 
	#DO_SLEEP
(
q
, 
f
, 
time_lim™
) \

79 { 

;\

80 ià(
time_lim™
è

 = 
cu¼’t
->
timeout
 = 
jiff›s
 + (time_limit); \

81 

 = 0xffffffff; \

82 
f
.
mode
 = 
WK_SLEEP
;
	`š‹¼u±ibË_¦“p_Ú
(&
q
); \

83 ià(!(
f
.
mode
 & 
WK_WAKEUP
)) \

85 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) \

86 
f
.
abÜtšg
 = 1; \

88 ià(
jiff›s
 >ğ

è
f
.
mode
 |ğ
WK_TIMEOUT
; \

90 
f
.
mode
 &ğ~
WK_SLEEP
; \

91 }

	)

92 
	#SOMEONE_WAITING
(
q
, 
f
è(f.
mode
 & 
WK_SLEEP
)

	)

93 
	#WAKE_UP
(
q
, 
f
è{f.
mode
 = 
WK_WAKEUP
;
	`wake_up
(&q);}

	)

95 
	#ALLOC_DMA_CHN
(
chn
è
	`»que¡_dma
(chn)

	)

96 
	#RELEASE_DMA_CHN
(
chn
è
	`ä“_dma
(chn)

	)

98 
	#GET_TIME
(è
jiff›s


	)

99 
	#RELEASE_IRQ
 
ä“_œq


	)

100 
	#RET_ERROR
(
”r
è-
	)
err

107 
	#DISABLE_INTR
(
æags
è
__asm__
 
	`__vŞ©e__
("pushæ ;…İÈ%0 ; cli":"ô" (æags));

	)

108 
	#RESTORE_INTR
(
æags
è
__asm__
 
	`__vŞ©e__
("pushl %0 ;…opfl": \

109 :"r" (
æags
));

	)

119 
	#KERNEL_MALLOC
(
nby‹s
è
	`km®loc
Òby‹s, 
GFP_KERNEL
)

	)

120 
	#KERNEL_FREE
(
addr
è
	`kä“
×ddr)

	)

131 
	#PERMANENT_MALLOC
(
ty³ÿ¡
, 
mem_±r
, 
size
, 
lšux_±r
) \

132 {
mem_±r
 = (
ty³ÿ¡
)
lšux_±r
; \

133 
lšux_±r
 +ğ(
size
);}

	)

141 
	#DEFINE_TIMER
(
Çme
, 
´oc
) \

142 
tim”_li¡
 
Çme
 = \

143 {
NULL
, NULL, 0, 0, 
´oc
}

	)

149 
	#ACTIVATE_TIMER
(
Çme
, 
´oc
, 
time
) \

150 {
Çme
.
expœes
 = 
time
; \

151 
	`add_tim”
 (&
Çme
);}

	)

153 
	#INB
 
šb


	)

154 
	#OUTB
 
outb


	)

	@drivers/sound/pas.h

28 
	#PAS_DEFAULT_BASE
 0x388

	)

31 
	#SPEAKER_CONTROL
 0x61

	)

32 
	#SPEAKER_CONTROL_GHOST
 0x738B

	)

33 
	#SPEAKER_TIMER_CONTROL
 0x43

	)

34 
	#SPEAKER_TIMER_CONTROL_GHOST
 0x778B

	)

35 
	#SPEAKER_TIMER_DATA
 0x42

	)

36 
	#SPEAKER_TIMER_DATA_GHOST
 0x138A

	)

38 
	#WARM_BOOT
 0x41

	)

39 
	#WARM_BOOT_GHOST
 0x7789

	)

40 
	#MASTER_DECODE
 0x9A01

	)

41 
	#PRESCALE_DIVIDER
 0xBF8A

	)

42 
	#WAIT_STATE
 0xBF88

	)

43 
	#BOARD_REV_ID
 0x2789

	)

45 
	#SYSTEM_CONFIGURATION_1
 0x8388

	)

46 
	#S_C_1_PCS_ENABLE
 0x01

	)

47 
	#S_C_1_PCM_CLOCK_SELECT
 0x02

	)

48 
	#S_C_1_FM_EMULATE_CLOCK
 0x04

	)

49 
	#S_C_1_PCS_STEREO
 0x10

	)

50 
	#S_C_1_PCS_REALSOUND
 0x20

	)

51 
	#S_C_1_FORCE_EXT_RESET
 0x40

	)

52 
	#S_C_1_FORCE_INT_RESET
 0x80

	)

53 
	#SYSTEM_CONFIGURATION_2
 0x8389

	)

54 
	#S_C_2_PCM_OVERSAMPLING
 0x03

	)

55 
	#S_C_2_PCM_16_BIT
 0x04

	)

56 
	#SYSTEM_CONFIGURATION_3
 0x838A

	)

57 
	#S_C_3_PCM_CLOCK_SELECT
 0x02

	)

58 
	#SYSTEM_CONFIGURATION_4
 0x838B

	)

60 
	#IO_CONFIGURATION_1
 0xF388

	)

61 
	#I_C_1_BOOT_RESET_ENABLE
 0x80

	)

62 
	#IO_CONFIGURATION_2
 0xF389

	)

63 
	#I_C_2_PCM_DMA_DISABLED
 0x00

	)

64 
	#IO_CONFIGURATION_3
 0xF38A

	)

65 
	#I_C_3_PCM_IRQ_DISABLED
 0x00

	)

67 
	#COMPATIBILITY_ENABLE
 0xF788

	)

68 
	#C_E_MPU401_ENABLE
 0x01

	)

69 
	#C_E_SB_ENABLE
 0x02

	)

70 
	#C_E_SB_ACTIVE
 0x04

	)

71 
	#C_E_MPU401_ACTIVE
 0x08

	)

72 
	#C_E_PCM_COMPRESSION
 0x10

	)

73 
	#EMULATION_ADDRESS
 0xF789

	)

74 
	#E_A_SB_BASE
 0x0à

	)

75 
	#E_A_MPU401_BASE
 0xf0

	)

76 
	#EMULATION_CONFIGURATION
 0xFB8A

	)

77 
	#E_C_MPU401_IRQ
 0x07

	)

78 
	#E_C_SB_IRQ
 0x38

	)

79 
	#E_C_SB_DMA
 0xC0

	)

81 
	#OPERATION_MODE_1
 0xEF8B

	)

82 
	#O_M_1_CDROM_TYPE
 0x03

	)

83 
	#O_M_1_FM_TYPE
 0x04

	)

84 
	#O_M_1_PCM_TYPE
 0x08

	)

85 
	#OPERATION_MODE_2
 0xFF8B

	)

86 
	#O_M_2_PCS_ENABLED
 0x02

	)

87 
	#O_M_2_BUS_TIMING
 0x10

	)

88 
	#O_M_2_BOARD_REVISION
 0xe0

	)

90 
	#INTERRUPT_MASK
 0x0B8B

	)

91 
	#I_M_FM_LEFT_IRQ_ENABLE
 0x01

	)

92 
	#I_M_FM_RIGHT_IRQ_ENABLE
 0x02

	)

93 
	#I_M_PCM_RATE_IRQ_ENABLE
 0x04

	)

94 
	#I_M_PCM_BUFFER_IRQ_ENABLE
 0x08

	)

95 
	#I_M_MIDI_IRQ_ENABLE
 0x10

	)

96 
	#I_M_BOARD_REV
 0xE0

	)

98 
	#INTERRUPT_STATUS
 0x0B89

	)

99 
	#I_S_FM_LEFT_IRQ
 0x01

	)

100 
	#I_S_FM_RIGHT_IRQ
 0x02

	)

101 
	#I_S_PCM_SAMPLE_RATE_IRQ
 0x04

	)

102 
	#I_S_PCM_SAMPLE_BUFFER_IRQ
 0x08

	)

103 
	#I_S_MIDI_IRQ
 0x10

	)

104 
	#I_S_PCM_CHANNEL
 0x20

	)

105 
	#I_S_RESET_ACTIVE
 0x40

	)

106 
	#I_S_PCM_CLIPPING
 0x80

	)

108 
	#FILTER_FREQUENCY
 0x0B8A

	)

109 
	#F_F_FILTER_DISABLED
 0x00

	)

112 
	mäeq
:24;

113 
	mv®ue
:8;

114 } 
	gF_F_FILTER_Œª¦©e
[] =

127 
	#F_F_MIXER_UNMUTE
 0x20

	)

128 
	#F_F_PCM_RATE_COUNTER
 0x40

	)

129 
	#F_F_PCM_BUFFER_COUNTER
 0x80

	)

131 
	#PAS_NONE
 0

	)

132 
	#PAS_PLUS
 1

	)

133 
	#PAS_CDPC
 2

	)

134 
	#PAS_16
 3

	)

135 
	#PAS_16D
 4

	)

137 #ifdeà
DEFINE_TRANSLATIONS


138 
	gI_C_2_PCM_DMA_Œª¦©e
[] =

140 
	gI_C_3_PCM_IRQ_Œª¦©e
[] =

142 
	gE_C_MPU401_IRQ_Œª¦©e
[] =

144 
	gE_C_SB_IRQ_Œª¦©e
[] =

146 
	gE_C_SB_DMA_Œª¦©e
[] =

148 
	gO_M_1_to_ÿrd
[] =

151 
I_C_2_PCM_DMA_Œª¦©e
[];

152 
I_C_3_PCM_IRQ_Œª¦©e
[];

153 
E_C_MPU401_IRQ_Œª¦©e
[];

154 
E_C_SB_IRQ_Œª¦©e
[];

155 
E_C_SB_DMA_Œª¦©e
[];

156 
O_M_1_to_ÿrd
[];

159 
	#PARALLEL_MIXER
 0x078B

	)

160 
	#P_M_MV508_ADDRESS
 0x80

	)

161 
	#P_M_MV508_DATA
 0x00

	)

162 
	#P_M_MV508_LEFT
 0x20

	)

163 
	#P_M_MV508_RIGHT
 0x40

	)

164 
	#P_M_MV508_BOTH
 0x00

	)

165 
	#P_M_MV508_MIXER
 0x10

	)

166 
	#P_M_MV508_VOLUME
 0x00

	)

168 
	#P_M_MV508_INPUTMIX
 0x20

	)

169 
	#P_M_MV508_OUTPUTMIX
 0x00

	)

171 
	#P_M_MV508_MASTER_A
 0x01

	)

172 
	#P_M_MV508_MASTER_B
 0x02

	)

173 
	#P_M_MV508_BASS
 0x03

	)

174 
	#P_M_MV508_TREBLE
 0x04

	)

175 
	#P_M_MV508_MODE
 0x05

	)

177 
	#P_M_MV508_LOUDNESS
 0x04

	)

178 
	#P_M_MV508_ENHANCE_BITS
 0x03

	)

179 
	#P_M_MV508_ENHANCE_NONE
 0x00

	)

180 
	#P_M_MV508_ENHANCE_40
 0x01

	)

181 
	#P_M_MV508_ENHANCE_60
 0x02

	)

182 
	#P_M_MV508_ENHANCE_80
 0x03

	)

184 
	#P_M_MV508_FM
 0x00

	)

185 
	#P_M_MV508_IMIXER
 0x01

	)

186 
	#P_M_MV508_LINE
 0x02

	)

187 
	#P_M_MV508_CDROM
 0x03

	)

188 
	#P_M_MV508_MIC
 0x04

	)

189 
	#P_M_MV508_PCM
 0x05

	)

190 
	#P_M_MV508_SPEAKER
 0x06

	)

191 
	#P_M_MV508_SB
 0x07

	)

193 
	#SERIAL_MIXER
 0xB88

	)

194 
	#S_M_PCM_RESET
 0x01

	)

195 
	#S_M_FM_RESET
 0x02

	)

196 
	#S_M_SB_RESET
 0x04

	)

197 
	#S_M_MIXER_RESET
 0x10

	)

198 
	#S_M_INTEGRATOR_ENABLE
 0x40

	)

199 
	#S_M_OPL3_DUAL_MONO
 0x80

	)

201 
	#PCM_CONTROL
 0xF8A

	)

202 
	#P_C_MIXER_CROSS_FIELD
 0x0f

	)

203 
	#P_C_MIXER_CROSS_R_TO_R
 0x01

	)

204 
	#P_C_MIXER_CROSS_L_TO_R
 0x02

	)

205 
	#P_C_MIXER_CROSS_R_TO_L
 0x04

	)

206 
	#P_C_MIXER_CROSS_L_TO_L
 0x08

	)

207 
	#P_C_PCM_DAC_MODE
 0x10

	)

208 
	#P_C_PCM_ADC_MODE
 0x00

	)

209 
	#P_C_PCM_MONO
 0x20

	)

210 
	#P_C_PCM_STEREO
 0x00

	)

211 
	#P_C_PCM_ENABLE
 0x40

	)

212 
	#P_C_PCM_DMA_ENABLE
 0x80

	)

214 
	#SAMPLE_COUNTER_CONTROL
 0x138B

	)

215 
	#S_C_C_SQUARE_WAVE
 0x04

	)

216 
	#S_C_C_RATE
 0x06

	)

217 
	#S_C_C_LSB_THEN_MSB
 0x30

	)

220 
	#S_C_C_SAMPLE_RATE
 0x00

	)

221 
	#S_C_C_SAMPLE_BUFFER
 0x40

	)

223 
	#S_C_C_PC_SPEAKER
 0x80

	)

225 
	#SAMPLE_RATE_TIMER
 0x1388

	)

226 
	#SAMPLE_BUFFER_COUNTER
 0x1389

	)

228 
	#MIDI_CONTROL
 0x178b

	)

229 
	#M_C_ENA_TSTAMP_IRQ
 0x01

	)

230 
	#M_C_ENA_TME_COMP_IRQ
 0x02

	)

231 
	#M_C_ENA_INPUT_IRQ
 0x04

	)

232 
	#M_C_ENA_OUTPUT_IRQ
 0x08

	)

233 
	#M_C_ENA_OUTPUT_HALF_IRQ
 0x10

	)

234 
	#M_C_RESET_INPUT_FIFO
 0x20

	)

235 
	#M_C_RESET_OUTPUT_FIFO
 0x40

	)

236 
	#M_C_ENA_THRU_MODE
 0x80

	)

238 
	#MIDI_STATUS
 0x1B88

	)

239 
	#M_S_TIMESTAMP
 0x01

	)

240 
	#M_S_COMPARE
 0x02

	)

241 
	#M_S_INPUT_AVAIL
 0x04

	)

242 
	#M_S_OUTPUT_EMPTY
 0x08

	)

243 
	#M_S_OUTPUT_HALF_EMPTY
 0x10

	)

244 
	#M_S_INPUT_OVERRUN
 0x20

	)

245 
	#M_S_OUTPUT_OVERRUN
 0x40

	)

246 
	#M_S_FRAMING_ERROR
 0x80

	)

248 
	#MIDI_FIFO_STATUS
 0x1B89

	)

249 
	#MIDI_DATA
 0x178A

	)

250 
	#MIDI_INPUT_AVAILABLE
 0x0à

	)

	@drivers/sound/pas2_card.c

1 
	#_PAS2_CARD_C_


	)

2 
	#SND_SA_INTERRUPT


	)

32 
	~"sound_cÚfig.h
"

34 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_PAS
)

36 
	#DEFINE_TRANSLATIONS


	)

37 
	~"·s.h
"

44 
	gŒª¦©_code
;

45 
	g·s_šŒ_mask
 = 0;

46 
	g·s_œq
 = 0;

48 
	g·s_mod–
;

49 *
	g·s_mod–_Çmes
[] =

57 
	$·s_»ad
 (
ißddr
)

59  
	`INB
 (
ißddr
 ^ 
Œª¦©_code
);

60 
	}
}

63 
	$·s_wr™e
 (
d©a
, 
ißddr
)

65 
	`OUTB
 (
d©a
, 
ißddr
 ^ 
Œª¦©_code
);

66 
	}
}

69 
	$·s2_msg
 (*
foo
)

71 
	`´štk
 (" PAS2: %s.\n", 
foo
);

72 
	}
}

77 
	$·sšŒ
 (
unu£d
)

79 
¡©us
;

81 
¡©us
 = 
	`·s_»ad
 (
INTERRUPT_STATUS
);

82 
	`·s_wr™e
 (
¡©us
, 
INTERRUPT_STATUS
);

84 ià(
¡©us
 & 
I_S_PCM_SAMPLE_BUFFER_IRQ
)

86 #iâdeà
EXCLUDE_AUDIO


87 
	`·s_pcm_š‹¼u±
 (
¡©us
, 1);

89 
¡©us
 &ğ~
I_S_PCM_SAMPLE_BUFFER_IRQ
;

91 ià(
¡©us
 & 
I_S_MIDI_IRQ
)

93 #iâdeà
EXCLUDE_MIDI


94 #ifdeà
EXCLUDE_PRO_MIDI


95 
	`·s_midi_š‹¼u±
 ();

98 
¡©us
 &ğ~
I_S_MIDI_IRQ
;

101 
	}
}

104 
	$·s_£t_šŒ
 (
mask
)

106 
”r
;

108 ià(!
mask
)

111 ià(!
·s_šŒ_mask
)

113 ià((
”r
 = 
	`¢d_£t_œq_hªdËr
 (
·s_œq
, 
·sšŒ
)) < 0)

114  
”r
;

116 
·s_šŒ_mask
 |ğ
mask
;

118 
	`·s_wr™e
 (
·s_šŒ_mask
, 
INTERRUPT_MASK
);

120 
	}
}

123 
	$·s_»move_šŒ
 (
mask
)

125 ià(!
mask
)

128 
·s_šŒ_mask
 &ğ~
mask
;

129 
	`·s_wr™e
 (
·s_šŒ_mask
, 
INTERRUPT_MASK
);

131 ià(!
·s_šŒ_mask
)

133 
	`¢d_»Ëa£_œq
 (
·s_œq
);

136 
	}
}

143 
	$cÚfig_·s_hw
 (
add»ss_šfo
 *
hw_cÚfig
)

145 
ok
 = 1;

147 
·s_œq
 = 
hw_cÚfig
->
œq
;

149 
	`·s_wr™e
 (0x00, 
INTERRUPT_MASK
);

151 
	`·s_wr™e
 (0x36, 
SAMPLE_COUNTER_CONTROL
);

154 
	`·s_wr™e
 (0x36, 
SAMPLE_RATE_TIMER
);

155 
	`·s_wr™e
 (0, 
SAMPLE_RATE_TIMER
);

157 
	`·s_wr™e
 (0x74, 
SAMPLE_COUNTER_CONTROL
);

160 
	`·s_wr™e
 (0x74, 
SAMPLE_BUFFER_COUNTER
);

162 
	`·s_wr™e
 (0, 
SAMPLE_BUFFER_COUNTER
);

164 
	`·s_wr™e
 (
F_F_PCM_BUFFER_COUNTER
 | 
F_F_PCM_RATE_COUNTER
 | 
F_F_MIXER_UNMUTE
 | 1, 
FILTER_FREQUENCY
);

165 
	`·s_wr™e
 (
P_C_PCM_DMA_ENABLE
 | 
P_C_PCM_MONO
 | 
P_C_PCM_DAC_MODE
 | 
P_C_MIXER_CROSS_L_TO_L
 | 
P_C_MIXER_CROSS_R_TO_R
, 
PCM_CONTROL
);

166 
	`·s_wr™e
 (
S_M_PCM_RESET
 | 
S_M_FM_RESET
 | 
S_M_SB_RESET
 | 
S_M_MIXER_RESET
 , 
SERIAL_MIXER
);

168 
	`·s_wr™e
 (
I_C_1_BOOT_RESET_ENABLE
, 
IO_CONFIGURATION_1
);

170 ià(
·s_œq
 < 0 ||…as_irq > 15)

172 
	`´štk
 ("PAS2: Inv®id IRQ %d", 
·s_œq
);

173 
ok
 = 0;

177 
	`·s_wr™e
 (
I_C_3_PCM_IRQ_Œª¦©e
[
·s_œq
], 
IO_CONFIGURATION_3
);

178 ià(!
I_C_3_PCM_IRQ_Œª¦©e
[
·s_œq
])

180 
	`´štk
 ("PAS2: Inv®id IRQ %d", 
·s_œq
);

181 
ok
 = 0;

185 ià(
hw_cÚfig
->
dma
 < 0 || hw_config->dma > 7)

187 
	`´štk
 ("PAS2: Inv®id DMA s–eùiÚ %d", 
hw_cÚfig
->
dma
);

188 
ok
 = 0;

192 
	`·s_wr™e
 (
I_C_2_PCM_DMA_Œª¦©e
[
hw_cÚfig
->
dma
], 
IO_CONFIGURATION_2
);

193 ià(!
I_C_2_PCM_DMA_Œª¦©e
[
hw_cÚfig
->
dma
])

195 
	`´štk
 ("PAS2: Inv®id DMA s–eùiÚ %d", 
hw_cÚfig
->
dma
);

196 
ok
 = 0;

204 #ifdeà
SYMPHONY_PAS


205 
	`OUTB
(0x05,0xa8);

206 
	`OUTB
(0x60,0xa9);

209 #ifdeà
BROKEN_BUS_CLOCK


210 
	`·s_wr™e
 (
S_C_1_PCS_ENABLE
 | 
S_C_1_PCS_STEREO
 | 
S_C_1_PCS_REALSOUND
 | 
S_C_1_FM_EMULATE_CLOCK
, 
SYSTEM_CONFIGURATION_1
);

213 
	`·s_wr™e
 (
S_C_1_PCS_ENABLE
 | 
S_C_1_PCS_STEREO
 | 
S_C_1_PCS_REALSOUND
, 
SYSTEM_CONFIGURATION_1
);

215 
	`·s_wr™e
 (0x18, 
SYSTEM_CONFIGURATION_3
);

217 
	`·s_wr™e
 (
F_F_MIXER_UNMUTE
 | 0x01, 
FILTER_FREQUENCY
);

221 ià(
·s_mod–
 =ğ
PAS_16
 ||…as_mod– =ğ
PAS_16D
)

222 
	`·s_wr™e
 (8, 
PRESCALE_DIVIDER
);

224 
	`·s_wr™e
 (0, 
PRESCALE_DIVIDER
);

226 
	`·s_wr™e
 (
P_M_MV508_ADDRESS
 | 5, 
PARALLEL_MIXER
);

227 
	`·s_wr™e
 (5, 
PARALLEL_MIXER
);

229 #ià!
	`defšed
(
EXCLUDE_SB_EMULATION
è|| !defšed(
EXCLUDE_SB
)

232 
add»ss_šfo
 *
sb_cÚfig
;

234 ià((
sb_cÚfig
=
	`sound_g‘cÚf
(
SNDCARD_SB
)))

236 
œq_dma
;

241 
	`·s_wr™e
 (0x02, 
COMPATIBILITY_ENABLE
);

244 
	`·s_wr™e
 ((
sb_cÚfig
->
io_ba£
 >> 4è& 0x0f, 
EMULATION_ADDRESS
);

246 ià(!
E_C_SB_DMA_Œª¦©e
[
sb_cÚfig
->
dma
])

247 
	`´štk
("\n\nPAS16 Warning: Invalid SB DMA %d\n\n",

248 
sb_cÚfig
->
dma
);

250 ià(!
E_C_SB_IRQ_Œª¦©e
[
sb_cÚfig
->
œq
])

251 
	`´štk
("\n\nPAS16 Warning: Invalid SB IRQ %d\n\n",

252 
sb_cÚfig
->
œq
);

254 
œq_dma
 = 
E_C_SB_DMA_Œª¦©e
[
sb_cÚfig
->
dma
] |

255 
E_C_SB_IRQ_Œª¦©e
[
sb_cÚfig
->
œq
];

257 
	`·s_wr™e
(
œq_dma
, 
EMULATION_CONFIGURATION
);

262 ià(!
ok
)

263 
	`·s2_msg
 ("Driver‚otƒnabled");

265  
ok
;

266 
	}
}

269 
	$d‘eù_·s_hw
 (
add»ss_šfo
 *
hw_cÚfig
)

271 
bßrd_id
, 
foo
;

280 
	`OUTB
 (0xBC, 
MASTER_DECODE
);

281 
	`OUTB
 (
hw_cÚfig
->
io_ba£
 >> 2, 
MASTER_DECODE
);

282 
Œª¦©_code
 = 
PAS_DEFAULT_BASE
 ^ 
hw_cÚfig
->
io_ba£
;

283 
	`·s_wr™e
 (1, 
WAIT_STATE
);

285 
bßrd_id
 = 
	`·s_»ad
 (
INTERRUPT_MASK
);

287 ià(
bßrd_id
 == 0xff)

296 
foo
 = 
bßrd_id
 ^ 0xe0;

298 
	`·s_wr™e
 (
foo
, 
INTERRUPT_MASK
);

299 
foo
 = 
	`INB
 (
INTERRUPT_MASK
);

300 
	`·s_wr™e
 (
bßrd_id
, 
INTERRUPT_MASK
);

302 ià(
bßrd_id
 !ğ
foo
)

305 
·s_mod–
 = 
O_M_1_to_ÿrd
[
	`·s_»ad
 (
OPERATION_MODE_1
) & 0x0f];

307  
·s_mod–
;

308 
	}
}

311 
	$©ch_·s_ÿrd
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

313 
·s_œq
 = 
hw_cÚfig
->
œq
;

315 ià(
	`d‘eù_·s_hw
 (
hw_cÚfig
))

318 ià((
·s_mod–
 = 
O_M_1_to_ÿrd
[
	`·s_»ad
 (
OPERATION_MODE_1
) & 0x0f]))

320 
	`´štk
 (" <% »v %d>", 
·s_mod–_Çmes
[(è
·s_mod–
], 
	`·s_»ad
 (
BOARD_REV_ID
));

323 ià(
	`cÚfig_·s_hw
 (
hw_cÚfig
))

326 #iâdeà
EXCLUDE_AUDIO


327 
mem_¡¬t
 = 
	`·s_pcm_š™
 (mem_¡¬t, 
hw_cÚfig
);

330 #ià!
	`defšed
(
EXCLUDE_SB_EMULATION
è&& !defšed(
EXCLUDE_SB
)

332 
	`sb_d¥_di§bË_midi
 ();

336 #iâdeà
EXCLUDE_YM3812


337 
	`’abË_İl3_mode
 (0x388, 0x38a, 0);

340 #iâdeà
EXCLUDE_MIDI


341 #ifdeà
EXCLUDE_PRO_MIDI


342 
mem_¡¬t
 = 
	`·s_midi_š™
 (mem_start);

346 
	`·s_š™_mix”
 ();

350  
mem_¡¬t
;

351 
	}
}

354 
	$´obe_·s
 (
add»ss_šfo
 *
hw_cÚfig
)

356  
	`d‘eù_·s_hw
 (
hw_cÚfig
);

357 
	}
}

	@drivers/sound/pas2_midi.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


34 
	~"·s.h
"

36 #ià!
defšed
(
EXCLUDE_PAS
è&& !defšed(
EXCLUDE_MIDI
è&& defšed(
EXCLUDE_PRO_MIDI
)

38 
	gmidi_busy
 = 0, 
	gšput_İ’ed
 = 0;

39 
	gmy_dev
;

40 vŞ©
	gofifo_by‹s
 = 0;

42 
	gtmp_queue
[256];

43 vŞ©
	gqËn
;

44 vŞ©
	gqh—d
, 
	gq
;

46 (*
midi_šput_šŒ
è(
dev
, 
d©a
);

49 
	`·s_midi_İ’
 (
dev
, 
mode
,

50 (*
šput
è(
dev
, 
d©a
),

51 (*
ouut
è(
dev
)

54 
”r
;

55 
æags
;

56 
ù¾
;

59 ià(
midi_busy
)

61 
	`´štk
 ("PAS2: Midi busy\n");

62  
	`RET_ERROR
 (
EBUSY
);

66 
	`·s_wr™e
 (
M_C_RESET_INPUT_FIFO
 | 
M_C_RESET_OUTPUT_FIFO
,

67 
MIDI_CONTROL
);

69 
	`DISABLE_INTR
 (
æags
);

71 ià((
”r
 = 
	`·s_£t_šŒ
 (
I_M_MIDI_IRQ_ENABLE
)) < 0)

72  
”r
;

76 
ù¾
 = 0;

77 
šput_İ’ed
 = 0;

78 
midi_šput_šŒ
 = 
šput
;

80 ià(
mode
 =ğ
OPEN_READ
 || mod=ğ
OPEN_READWRITE
)

82 
ù¾
 |ğ
M_C_ENA_INPUT_IRQ
;

83 
šput_İ’ed
 = 1;

86 ià(
mode
 =ğ
OPEN_WRITE
 || mod=ğ
OPEN_READWRITE
)

88 
ù¾
 |ğ
M_C_ENA_OUTPUT_IRQ
 |

89 
M_C_ENA_OUTPUT_HALF_IRQ
;

92 
	`·s_wr™e
 (
ù¾
,

93 
MIDI_CONTROL
);

97 
	`·s_wr™e
 (0xff, 
MIDI_STATUS
);

98 
ofifo_by‹s
 = 0;

100 
	`RESTORE_INTR
 (
æags
);

102 
midi_busy
 = 1;

103 
qËn
 = 
qh—d
 = 
q
 = 0;

105 
	}
}

108 
	$·s_midi_şo£
 (
dev
)

112 
	`·s_wr™e
 (
M_C_RESET_INPUT_FIFO
 | 
M_C_RESET_OUTPUT_FIFO
, 
MIDI_CONTROL
);

114 
	`·s_»move_šŒ
 (
I_M_MIDI_IRQ_ENABLE
);

115 
midi_busy
 = 0;

116 
	}
}

119 
	$dump_to_midi
 (
midi_by‹
)

121 
fifo_¥aû
, 
x
;

123 
fifo_¥aû
 = ((
x
 = 
	`·s_»ad
 (
MIDI_FIFO_STATUS
)) >> 4) & 0x0f;

125 ià(
fifo_¥aû
 =ğ15 || (fifo_¥aû < 2 && 
ofifo_by‹s
 > 13))

130 
ofifo_by‹s
++;

132 
	`·s_wr™e
 (
midi_by‹
, 
MIDI_DATA
);

135 
	}
}

138 
	$·s_midi_out
 (
dev
, 
midi_by‹
)

141 
æags
;

147 
	`DISABLE_INTR
 (
æags
);

149 
qËn
 && 
	`dump_to_midi
 (
tmp_queue
[
qh—d
]))

151 
qËn
--;

152 
qh—d
++;

155 
	`RESTORE_INTR
 (
æags
);

161 ià(!
qËn
)

162 ià(
	`dump_to_midi
 (
midi_by‹
))

169 ià(
qËn
 >= 256)

172 
	`DISABLE_INTR
 (
æags
);

174 
tmp_queue
[
q
] = 
midi_by‹
;

175 
qËn
++;

176 
q
++;

178 
	`RESTORE_INTR
 (
æags
);

181 
	}
}

184 
	$·s_midi_¡¬t_»ad
 (
dev
)

187 
	}
}

190 
	$·s_midi_’d_»ad
 (
dev
)

193 
	}
}

196 
	$·s_midi_ioùl
 (
dev
, 
cmd
, 
¬g
)

198  
	`RET_ERROR
 (
EINVAL
);

199 
	}
}

202 
	$·s_midi_kick
 (
dev
)

204 
ofifo_by‹s
 = 0;

205 
	}
}

208 
	$·s_bufãr_¡©us
 (
dev
)

210  !
qËn
;

211 
	}
}

213 
midi_İ”©iÚs
 
	g·s_midi_İ”©iÚs
 =

215 {"PrØAudiØS³ùrum", 0, 0, 
SNDCARD_PAS
},

216 
·s_midi_İ’
,

217 
·s_midi_şo£
,

218 
·s_midi_ioùl
,

219 
·s_midi_out
,

220 
·s_midi_¡¬t_»ad
,

221 
·s_midi_’d_»ad
,

222 
·s_midi_kick
,

223 
NULL
,

224 
·s_bufãr_¡©us


228 
	$·s_midi_š™
 (
mem_¡¬t
)

230 
my_dev
 = 
num_midis
;

231 
midi_devs
[
num_midis
++] = &
·s_midi_İ”©iÚs
;

232  
mem_¡¬t
;

233 
	}
}

236 
	$·s_midi_š‹¼u±
 ()

238 
¡©
;

239 
i
, 
šcouÁ
;

240 
æags
;

242 
¡©
 = 
	`·s_»ad
 (
MIDI_STATUS
);

244 ià(
¡©
 & 
M_S_INPUT_AVAIL
)

246 
šcouÁ
 = 
	`·s_»ad
 (
MIDI_FIFO_STATUS
) & 0x0f;

247 ià(!
šcouÁ
)

248 
šcouÁ
 = 16;

250 
i
 = 0; i < 
šcouÁ
; i++)

251 ià(
šput_İ’ed
)

253 
	`midi_šput_šŒ
 (
my_dev
, 
	`·s_»ad
 (
MIDI_DATA
));

256 
	`·s_»ad
 (
MIDI_DATA
);

259 ià(
¡©
 & (
M_S_OUTPUT_EMPTY
 | 
M_S_OUTPUT_HALF_EMPTY
))

261 ià(!(
¡©
 & 
M_S_OUTPUT_EMPTY
))

263 
ofifo_by‹s
 = 8;

267 
ofifo_by‹s
 = 0;

270 
	`DISABLE_INTR
 (
æags
);

272 
qËn
 && 
	`dump_to_midi
 (
tmp_queue
[
qh—d
]))

274 
qËn
--;

275 
qh—d
++;

278 
	`RESTORE_INTR
 (
æags
);

281 ià(
¡©
 & 
M_S_FRAMING_ERROR
)

282 
	`´štk
 ("MIDI framingƒrror\n");

284 ià(
¡©
 & 
M_S_OUTPUT_OVERRUN
)

286 
	`´štk
 ("MIDI ouuˆov”ruÀ%x,%x,%d \n", 
	`·s_»ad
 (
MIDI_FIFO_STATUS
), 
¡©
, 
ofifo_by‹s
);

287 
ofifo_by‹s
 = 100;

290 
	`·s_wr™e
 (
¡©
, 
MIDI_STATUS
);

291 
	}
}

	@drivers/sound/pas2_mixer.c

1 
	#_PAS2_MIXER_C_


	)

32 
	~"sound_cÚfig.h
"

34 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_PAS
)

36 
	~"·s.h
"

38 
	#TRACE
(
wh©
è

	)

40 
Œª¦©_code
;

42 
	g»c_deviûs
 = (
SOUND_MASK_MIC
);

43 
	gmode_cÚŒŞ
 = 0;

45 
	#POSSIBLE_RECORDING_DEVICES
 (
SOUND_MASK_SYNTH
 | 
SOUND_MASK_SPEAKER
 | 
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | \

46 
SOUND_MASK_CD
 | 
SOUND_MASK_ALTPCM
)

	)

48 
	#SUPPORTED_MIXER_DEVICES
 (
SOUND_MASK_SYNTH
 | 
SOUND_MASK_PCM
 | 
SOUND_MASK_SPEAKER
 | 
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | \

49 
SOUND_MASK_CD
 | 
SOUND_MASK_ALTPCM
 | 
SOUND_MASK_IMIX
 | \

50 
SOUND_MASK_VOLUME
 | 
SOUND_MASK_BASS
 | 
SOUND_MASK_TREBLE
 | 
SOUND_MASK_RECLEV
 | \

51 
SOUND_MASK_MUTE
 | 
SOUND_MASK_ENHANCE
 | 
SOUND_MASK_LOUD
)

	)

53 
	gËv–s
[
SOUND_MIXER_NRDEVICES
] =

69 
	$mix”_ouut
 (
right_vŞ
, 
Ëá_vŞ
, 
div
, 
b™s
,

70 
mix”
 )

72 
Ëá
 = 
Ëá_vŞ
 * 
div
 / 100;

73 
right
 = 
right_vŞ
 * 
div
 / 100;

83 ià(
b™s
 & 
P_M_MV508_MIXER
)

85 
Ëá
 |ğ
mix”
;

86 
right
 |ğ
mix”
;

89 ià(
b™s
 =ğ
P_M_MV508_BASS
 || b™ =ğ
P_M_MV508_TREBLE
)

91 
	`·s_wr™e
 (
P_M_MV508_ADDRESS
 | 
b™s
, 
PARALLEL_MIXER
);

92 
	`·s_wr™e
 (
Ëá
, 
PARALLEL_MIXER
);

93 
right_vŞ
 = 
Ëá_vŞ
;

97 
	`·s_wr™e
 (
P_M_MV508_ADDRESS
 | 
P_M_MV508_LEFT
 | 
b™s
, 
PARALLEL_MIXER
);

98 
	`·s_wr™e
 (
Ëá
, 
PARALLEL_MIXER
);

99 
	`·s_wr™e
 (
P_M_MV508_ADDRESS
 | 
P_M_MV508_RIGHT
 | 
b™s
, 
PARALLEL_MIXER
);

100 
	`·s_wr™e
 (
right
, 
PARALLEL_MIXER
);

103  (
Ëá_vŞ
 | (
right_vŞ
 << 8));

104 
	}
}

107 
	$£t_mode
 (
Ãw_mode
)

109 
	`·s_wr™e
 (
P_M_MV508_ADDRESS
 | 
P_M_MV508_MODE
, 
PARALLEL_MIXER
);

110 
	`·s_wr™e
 (
Ãw_mode
, 
PARALLEL_MIXER
);

112 
mode_cÚŒŞ
 = 
Ãw_mode
;

113 
	}
}

116 
	$·s_mix”_£t
 (
whichDev
, 
Ëv–
)

118 
Ëá
, 
right
, 
devmask
, 
chªged
, 
i
, 
mix”
 = 0;

120 
	`TRACE
 (
	`´štk
 ("¡©iøšˆ·s_mix”_£t(šˆwhichDev = %d, unsigÃd iÁ†ev– = %X)\n", 
whichDev
, 
Ëv–
));

122 
Ëá
 = 
Ëv–
 & 0x7f;

123 
right
 = (
Ëv–
 & 0x7f00) >> 8;

125 ià(
whichDev
 < 
SOUND_MIXER_NRDEVICES
)

126 ià((1 << 
whichDev
è& 
»c_deviûs
)

127 
mix”
 = 
P_M_MV508_INPUTMIX
;

129 
mix”
 = 
P_M_MV508_OUTPUTMIX
;

131 
whichDev
)

133 
SOUND_MIXER_VOLUME
:

134 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 63, 
P_M_MV508_MASTER_A
, 0);

141 
SOUND_MIXER_BASS
:

142 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 12, 
P_M_MV508_BASS
, 0);

144 
SOUND_MIXER_TREBLE
:

145 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 12, 
P_M_MV508_TREBLE
, 0);

148 
SOUND_MIXER_SYNTH
:

149 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_FM
, 
mix”
);

151 
SOUND_MIXER_PCM
:

152 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_PCM
, 
mix”
);

154 
SOUND_MIXER_ALTPCM
:

155 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_SB
, 
mix”
);

157 
SOUND_MIXER_SPEAKER
:

158 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_SPEAKER
, 
mix”
);

160 
SOUND_MIXER_LINE
:

161 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_LINE
, 
mix”
);

163 
SOUND_MIXER_CD
:

164 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_CDROM
, 
mix”
);

166 
SOUND_MIXER_MIC
:

167 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_MIC
, 
mix”
);

169 
SOUND_MIXER_IMIX
:

171 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 31, 
P_M_MV508_MIXER
 | 
P_M_MV508_IMIXER
,

172 
P_M_MV508_OUTPUTMIX
);

174 
SOUND_MIXER_RECLEV
:

175 
Ëv–s
[
whichDev
] = 
	`mix”_ouut
 (
right
, 
Ëá
, 15, 
P_M_MV508_MASTER_B
, 0);

178 
SOUND_MIXER_MUTE
:

182 
SOUND_MIXER_ENHANCE
:

183 
i
 = 0;

184 
Ëv–
 &= 0x7f;

185 ià(
Ëv–
)

186 
i
 = (
Ëv–
 / 20) - 1;

188 
mode_cÚŒŞ
 &ğ~
P_M_MV508_ENHANCE_BITS
;

189 
mode_cÚŒŞ
 |ğ
P_M_MV508_ENHANCE_BITS
;

190 
	`£t_mode
 (
mode_cÚŒŞ
);

192 ià(
i
)

193 
i
 = (i + 1) * 20;

194  
i
;

197 
SOUND_MIXER_LOUD
:

198 
mode_cÚŒŞ
 &ğ~
P_M_MV508_LOUDNESS
;

199 ià(
Ëv–
)

200 
mode_cÚŒŞ
 |ğ
P_M_MV508_LOUDNESS
;

201 
	`£t_mode
 (
mode_cÚŒŞ
);

202  !!
Ëv–
;

205 
SOUND_MIXER_RECSRC
:

206 
devmask
 = 
Ëv–
 & 
POSSIBLE_RECORDING_DEVICES
;

208 
chªged
 = 
devmask
 ^ 
»c_deviûs
;

209 
»c_deviûs
 = 
devmask
;

211 
i
 = 0; i < 
SOUND_MIXER_NRDEVICES
; i++)

212 ià(
chªged
 & (1 << 
i
))

214 
	`·s_mix”_£t
 (
i
, 
Ëv–s
[i]);

216  
»c_deviûs
;

220  
	`RET_ERROR
 (
EINVAL
);

223  (
Ëv–s
[
whichDev
]);

224 
	}
}

229 
	$mix”_£t_Ëv–s
 (
sb_mix”_Ëv–s
 *
u£r_l
)

231 
	#cmix
(
v
è((((v.
r
*100+7)/15)<<8)| ((v.
l
*100+7)/15))

	)

233 
sb_mix”_Ëv–s
 
l
;

235 
	`IOCTL_FROM_USER
 ((*è&
l
, (*è
u£r_l
, 0,  (l));

237 ià(
l
.
ma¡”
.È& ~0xF ||†.ma¡”.
r
 & ~0xF

238 || 
l
.
lše
.È& ~0xF ||†.lše.
r
 & ~0xF

239 || 
l
.
voc
.È& ~0xF ||†.voc.
r
 & ~0xF

240 || 
l
.
fm
.È& ~0xF ||†.fm.
r
 & ~0xF

241 || 
l
.
cd
.È& ~0xF ||†.cd.
r
 & ~0xF

242 || 
l
.
mic
 & ~0x7)

243  (
	`RET_ERROR
 (
EINVAL
));

245 
	`·s_mix”_£t
 (
SOUND_MIXER_VOLUME
, 
	`cmix
 (
l
.
ma¡”
));

246 
	`·s_mix”_£t
 (
SOUND_MIXER_LINE
, 
	`cmix
 (
l
.
lše
));

247 
	`·s_mix”_£t
 (
SOUND_MIXER_PCM
, 
	`cmix
 (
l
.
voc
));

248 
	`·s_mix”_£t
 (
SOUND_MIXER_ALTPCM
, 
	`cmix
 (
l
.
voc
));

249 
	`·s_mix”_£t
 (
SOUND_MIXER_SYNTH
, 
	`cmix
 (
l
.
fm
));

250 
	`·s_mix”_£t
 (
SOUND_MIXER_CD
, 
	`cmix
 (
l
.
cd
));

251 
	`·s_mix”_£t
 (
SOUND_MIXER_MIC
, ((
l
.
mic
 * 100 + 3) / 7) | (((l.mic * 100 + 3) / 7) << 8));

253 
	}
}

260 
	$mix”_£t_·¿ms
 (
sb_mix”_·¿ms
 *
u£r_p
)

262 
sb_mix”_·¿ms
 
p
;

263 
S_BYTE
 
v®
;

264 
¤c
;

265 
æags
;

267 
	`IOCTL_FROM_USER
 ((*è&
p
, (*è
u£r_p
, 0,  (p));

269 ià(
p
.
»cÜd_sourû
 !ğ
SRC_MIC


270 && 
p
.
»cÜd_sourû
 !ğ
SRC_CD


271 && 
p
.
»cÜd_sourû
 !ğ
SRC_LINE
)

272  (
	`RET_ERROR
 (
EINVAL
));

280 
	`DISABLE_INTR
 (
æags
);

282 
v®
 = (
	`·s_»ad
 (
PCM_CONTROL
è& ~
P_C_MIXER_CROSS_FIELD
è| 
P_C_MIXER_CROSS_R_TO_R
 | 
P_C_MIXER_CROSS_L_TO_L
;

283 ià(!
p
.
d¥_¡”eo
)

284 
v®
 |ğ(
P_C_MIXER_CROSS_R_TO_L
 | 
P_C_MIXER_CROSS_L_TO_R
);

285 
	`·s_wr™e
 (
v®
, 
PCM_CONTROL
);

287 
	`RESTORE_INTR
 (
æags
);

289 
p
.
»cÜd_sourû
)

291 
SRC_CD
:

292 
¤c
 = 
SOUND_MASK_CD
;

295 
SRC_LINE
:

296 
¤c
 = 
SOUND_MASK_LINE
;

300 
¤c
 = 
SOUND_MASK_MIC
;

304 
	`·s_mix”_£t
 (
SOUND_MIXER_RECSRC
, 
¤c
);

311 
	}
}

314 
	$g‘mix”
 (
dev
, 
chn
)

316 ià(
chn
 =ğ
P_M_MV508_RIGHT
)

318  (
Ëv–s
[
dev
] >> 8) & 0x7f;

322  
Ëv–s
[
dev
] & 0x7f;

324 
	}
}

328 
	$mix”_g‘_Ëv–s
 (
sb_mix”_Ëv–s
 *
u£r_l
)

331 
sb_mix”_Ëv–s
 
l
;

333 
l
.
ma¡”
.
r
 = ((((
Ëv–s
[
SOUND_MIXER_VOLUME
] >> 8) & 0x7f) * 15) + 50) / 100;

334 
l
.
ma¡”
.Èğ(((
Ëv–s
[
SOUND_MIXER_VOLUME
] & 0x7f) * 15) + 50) / 100;

336 
l
.
lše
.
r
 = ((
	`g‘mix”
 (
SOUND_MIXER_LINE
, 
P_M_MV508_RIGHT
) * 15) + 50) / 100;

337 
l
.
lše
.Èğ((
	`g‘mix”
 (
SOUND_MIXER_LINE
, 
P_M_MV508_LEFT
) * 15) + 50) / 100;

339 
l
.
voc
.
r
 = ((
	`g‘mix”
 (
SOUND_MIXER_PCM
, 
P_M_MV508_RIGHT
) * 15) + 50) / 100;

340 
l
.
voc
.Èğ((
	`g‘mix”
 (
SOUND_MIXER_PCM
, 
P_M_MV508_LEFT
) * 15) + 50) / 100;

342 
l
.
fm
.
r
 = ((
	`g‘mix”
 (
SOUND_MIXER_SYNTH
, 
P_M_MV508_RIGHT
) * 15) + 50) / 100;

343 
l
.
fm
.Èğ((
	`g‘mix”
 (
SOUND_MIXER_SYNTH
, 
P_M_MV508_LEFT
) * 15) + 50) / 100;

345 
l
.
cd
.
r
 = ((
	`g‘mix”
 (
SOUND_MIXER_CD
, 
P_M_MV508_RIGHT
) * 15) + 50) / 100;

346 
l
.
cd
.Èğ((
	`g‘mix”
 (
SOUND_MIXER_CD
, 
P_M_MV508_LEFT
) * 15) + 50) / 100;

348 
l
.
mic
 = ((
	`g‘mix”
 (
SOUND_MIXER_MIC
, 
P_M_MV508_LEFT
) * 7) + 50) / 100;

350 
	`IOCTL_TO_USER
 ((*è
u£r_l
, 0, (*è&
l
,  (l));

352 
	}
}

356 
	$mix”_g‘_·¿ms
 (
sb_mix”_·¿ms
 *
u£r_·¿ms
)

358 
S_BYTE
 
v®
;

359 
sb_mix”_·¿ms
 
·¿ms
;

361 
»c_deviûs
)

363 
SOUND_MASK_CD
:

364 
·¿ms
.
»cÜd_sourû
 = 
SRC_CD
;

367 
SOUND_MASK_LINE
:

368 
·¿ms
.
»cÜd_sourû
 = 
SRC_LINE
;

371 
SOUND_MASK_MIC
:

372 
·¿ms
.
»cÜd_sourû
 = 
SRC_MIC
;

376 
·¿ms
.
»cÜd_sourû
 = 
SRC_MIC
;

377 
	`·s_mix”_£t
 (
SOUND_MIXER_RECSRC
, 
SOUND_MASK_MIC
);

380 
·¿ms
.
hiäeq_f‹r
 = 
OFF
;

381 
·¿ms
.
f‹r_šput
 = 
OFF
;

382 
·¿ms
.
f‹r_ouut
 = 
OFF
;

384 
v®
 = 
	`INB
 (
PCM_CONTROL
);

385 
·¿ms
.
d¥_¡”eo
 = ((
v®
 & 
P_C_MIXER_CROSS_FIELD
è=ğ(
P_C_MIXER_CROSS_L_TO_L
 | 
P_C_MIXER_CROSS_R_TO_R
));

387 
	`IOCTL_TO_USER
 ((*è
u£r_·¿ms
, 0, (*è&
·¿ms
,  (params));

389 
	}
}

394 
	$·s_mix”_»£t
 ()

396 
foo
;

398 
	`TRACE
 (
	`´štk
 ("pas2_mixer.c: void…as_mixer_reset(void)\n"));

400 
foo
 = 0; foØ< 
SOUND_MIXER_NRDEVICES
; foo++)

401 
	`·s_mix”_£t
 (
foo
, 
Ëv–s
[foo]);

403 
	`£t_mode
 (
P_M_MV508_LOUDNESS
 | 
P_M_MV508_ENHANCE_40
);

404 
	}
}

407 
	$·s_mix”_ioùl
 (
dev
, 
cmd
, 
¬g
)

409 
	`TRACE
 (
	`´štk
 ("·s2_mix”.c: iÁ…as_mix”_ioùl(unsigÃd iÁ cmd = %X, unsigÃd iÁ‡rg = %X)\n", 
cmd
, 
¬g
));

411 ià(((
cmd
 >> 8) & 0xff) == 'M')

413 ià(
cmd
 & 
IOC_IN
)

414  
	`IOCTL_OUT
 (
¬g
, 
	`·s_mix”_£t
 (
cmd
 & 0xff, 
	`IOCTL_IN
 (arg)));

418 
cmd
 & 0xff)

421 
SOUND_MIXER_RECSRC
:

422  
	`IOCTL_OUT
 (
¬g
, 
»c_deviûs
);

425 
SOUND_MIXER_STEREODEVS
:

426  
	`IOCTL_OUT
 (
¬g
, 
SUPPORTED_MIXER_DEVICES
 & ~(
SOUND_MASK_BASS
 | 
SOUND_MASK_TREBLE
));

429 
SOUND_MIXER_DEVMASK
:

430  
	`IOCTL_OUT
 (
¬g
, 
SUPPORTED_MIXER_DEVICES
);

433 
SOUND_MIXER_RECMASK
:

434  
	`IOCTL_OUT
 (
¬g
, 
POSSIBLE_RECORDING_DEVICES
 & 
SUPPORTED_MIXER_DEVICES
);

437 
SOUND_MIXER_CAPS
:

438  
	`IOCTL_OUT
 (
¬g
, 0);

441 
SOUND_MIXER_MUTE
:

442  
	`IOCTL_OUT
 (
¬g
, 0);

445 
SOUND_MIXER_ENHANCE
:

446 ià(!(
mode_cÚŒŞ
 & 
P_M_MV508_ENHANCE_BITS
))

447  
	`IOCTL_OUT
 (
¬g
, 0);

448  
	`IOCTL_OUT
 (
¬g
, ((
mode_cÚŒŞ
 & 
P_M_MV508_ENHANCE_BITS
) + 1) * 20);

451 
SOUND_MIXER_LOUD
:

452 ià(
mode_cÚŒŞ
 & 
P_M_MV508_LOUDNESS
)

453  
	`IOCTL_OUT
 (
¬g
, 1);

454  
	`IOCTL_OUT
 (
¬g
, 0);

458  
	`IOCTL_OUT
 (
¬g
, 
Ëv–s
[
cmd
 & 0xff]);

464 
cmd
)

466 
MIXER_IOCTL_SET_LEVELS
:

467 
	`mix”_£t_Ëv–s
 ((
sb_mix”_Ëv–s
 *è
¬g
);

468  
	`mix”_g‘_Ëv–s
 ((
sb_mix”_Ëv–s
 *è
¬g
);

469 
MIXER_IOCTL_SET_PARAMS
:

470 
	`mix”_£t_·¿ms
 ((
sb_mix”_·¿ms
 *è
¬g
);

471  
	`mix”_g‘_·¿ms
 ((
sb_mix”_·¿ms
 *è
¬g
);

472 
MIXER_IOCTL_READ_LEVELS
:

473  
	`mix”_g‘_Ëv–s
 ((
sb_mix”_Ëv–s
 *è
¬g
);

474 
MIXER_IOCTL_READ_PARAMS
:

475  
	`mix”_g‘_·¿ms
 ((
sb_mix”_·¿ms
 *è
¬g
);

476 
MIXER_IOCTL_RESET
:

477 
	`·s_mix”_»£t
 ();

480  
	`RET_ERROR
 (
EINVAL
);

483  
	`RET_ERROR
 (
EINVAL
);

484 
	}
}

486 
mix”_İ”©iÚs
 
	g·s_mix”_İ”©iÚs
 =

488 
·s_mix”_ioùl


492 
	$·s_š™_mix”
 ()

494 
	`·s_mix”_»£t
 ();

496 
mix”_devs
[
num_mix”s
++] = &
·s_mix”_İ”©iÚs
;

498 
	}
}

	@drivers/sound/pas2_pcm.c

1 
	#_PAS2_PCM_C_


	)

31 
	~"sound_cÚfig.h
"

33 #ifdeà
CONFIGURE_SOUNDCARD


35 
	~"·s.h
"

37 #ià!
defšed
(
EXCLUDE_PAS
è&& !defšed(
EXCLUDE_AUDIO
)

39 
	#TRACE
(
WHAT
è

	)

41 
	#PAS_PCM_INTRBITS
 (0x08)

	)

44 
	#PCM_NON
 0

	)

45 
	#PCM_DAC
 1

	)

46 
	#PCM_ADC
 2

	)

48 
	gpcm_¥“d
 = 0;

49 
	gpcm_chªÃls
 = 1;

50 
	gpcm_b™s
 = 8;

51 
	gpcm_f‹r
 = 0;

52 
	gpcm_mode
 = 
PCM_NON
;

53 
	gpcm_couÁ
 = 0;

54 
	gpcm_b™sok
 = 8;

55 
	gmy_devnum
 = 0;

58 
	$pcm_£t_¥“d
 (
¬g
)

60 
foo
, 
tmp
;

61 
æags
;

63 ià(
¬g
 > 44100)

64 
¬g
 = 44100;

65 ià(
¬g
 < 5000)

66 
¬g
 = 5000;

68 
foo
 = 1193180 / 
¬g
;

69 
¬g
 = 1193180 / 
foo
;

71 ià(
pcm_chªÃls
 & 2)

72 
foo
 = foo >> 1;

74 
pcm_¥“d
 = 
¬g
;

76 
tmp
 = 
	`·s_»ad
 (
FILTER_FREQUENCY
);

78 
	`DISABLE_INTR
 (
æags
);

80 
	`·s_wr™e
 (
tmp
 & ~(
F_F_PCM_RATE_COUNTER
 | 
F_F_PCM_BUFFER_COUNTER
), 
FILTER_FREQUENCY
);

81 
	`·s_wr™e
 (
S_C_C_SAMPLE_RATE
 | 
S_C_C_LSB_THEN_MSB
 | 
S_C_C_SQUARE_WAVE
, 
SAMPLE_COUNTER_CONTROL
);

82 
	`·s_wr™e
 (
foo
 & 0xff, 
SAMPLE_RATE_TIMER
);

83 
	`·s_wr™e
 ((
foo
 >> 8è& 0xff, 
SAMPLE_RATE_TIMER
);

84 
	`·s_wr™e
 (
tmp
, 
FILTER_FREQUENCY
);

86 
	`RESTORE_INTR
 (
æags
);

88  
pcm_¥“d
;

89 
	}
}

92 
	$pcm_£t_chªÃls
 (
¬g
)

95 ià((
¬g
 != 1) && (arg != 2))

96  
pcm_chªÃls
;

98 ià(
¬g
 !ğ
pcm_chªÃls
)

100 
	`·s_wr™e
 (
	`·s_»ad
 (
PCM_CONTROL
è^ 
P_C_PCM_MONO
, PCM_CONTROL);

102 
pcm_chªÃls
 = 
¬g
;

103 
	`pcm_£t_¥“d
 (
pcm_¥“d
);

106  
pcm_chªÃls
;

107 
	}
}

110 
	$pcm_£t_b™s
 (
¬g
)

112 ià((
¬g
 & 
pcm_b™sok
) !=‡rg)

113  
pcm_b™s
;

115 ià(
¬g
 !ğ
pcm_b™s
)

117 
	`·s_wr™e
 (
	`·s_»ad
 (
SYSTEM_CONFIGURATION_2
è^ 
S_C_2_PCM_16_BIT
, SYSTEM_CONFIGURATION_2);

119 
pcm_b™s
 = 
¬g
;

122  
pcm_b™s
;

123 
	}
}

126 
	$·s_pcm_ioùl
 (
dev
, 
cmd
, 
¬g
, 
loÿl
)

128 
	`TRACE
 (
	`´štk
 ("·s2_pcm.c: stiøšˆ·s_pcm_ioùl(unsigÃd iÁ cmd = %X, unsigÃd iÁ‡rg = %X)\n", 
cmd
, 
¬g
));

130 
cmd
)

132 
SOUND_PCM_WRITE_RATE
:

133 ià(
loÿl
)

134  
	`pcm_£t_¥“d
 (
¬g
);

135  
	`IOCTL_OUT
 (
¬g
, 
	`pcm_£t_¥“d
 (
	`IOCTL_IN
 (arg)));

138 
SOUND_PCM_READ_RATE
:

139 ià(
loÿl
)

140  
pcm_¥“d
;

141  
	`IOCTL_OUT
 (
¬g
, 
pcm_¥“d
);

144 
SNDCTL_DSP_STEREO
:

145 ià(
loÿl
)

146  
	`pcm_£t_chªÃls
 (
¬g
 + 1) - 1;

147  
	`IOCTL_OUT
 (
¬g
, 
	`pcm_£t_chªÃls
 (
	`IOCTL_IN
 (arg) + 1) - 1);

150 
SOUND_PCM_WRITE_CHANNELS
:

151 ià(
loÿl
)

152  
	`pcm_£t_chªÃls
 (
¬g
);

153  
	`IOCTL_OUT
 (
¬g
, 
	`pcm_£t_chªÃls
 (
	`IOCTL_IN
 (arg)));

156 
SOUND_PCM_READ_CHANNELS
:

157 ià(
loÿl
)

158  
pcm_chªÃls
;

159  
	`IOCTL_OUT
 (
¬g
, 
pcm_chªÃls
);

162 
SNDCTL_DSP_SAMPLESIZE
:

163 ià(
loÿl
)

164  
	`pcm_£t_b™s
 (
¬g
);

165  
	`IOCTL_OUT
 (
¬g
, 
	`pcm_£t_b™s
 (
	`IOCTL_IN
 (arg)));

168 
SOUND_PCM_READ_BITS
:

169 ià(
loÿl
)

170  
pcm_b™s
;

171  
	`IOCTL_OUT
 (
¬g
, 
pcm_b™s
);

173 
SOUND_PCM_WRITE_FILTER
:

174 ià(
	`IOCTL_IN
 (
¬g
) > 1)

175  
	`IOCTL_OUT
 (
¬g
, 
	`RET_ERROR
 (
EINVAL
));

178 
pcm_f‹r
 = 
	`IOCTL_IN
 (
¬g
);

179 
SOUND_PCM_READ_FILTER
:

180  
	`IOCTL_OUT
 (
¬g
, 
pcm_f‹r
);

184  
	`RET_ERROR
 (
EINVAL
);

187  
	`RET_ERROR
 (
EINVAL
);

188 
	}
}

191 
	$·s_pcm_»£t
 (
dev
)

193 
	`TRACE
 (
	`´štk
 ("pas2_pcm.c: static void…as_pcm_reset(void)\n"));

195 
	`·s_wr™e
 (
	`·s_»ad
 (
PCM_CONTROL
è& ~
P_C_PCM_ENABLE
, PCM_CONTROL);

196 
	}
}

199 
	$·s_pcm_İ’
 (
dev
, 
mode
)

201 
”r
;

203 
	`TRACE
 (
	`´štk
 ("·s2_pcm.c: stiøšˆ·s_pcm_İ’(šˆmodğ%X)\n", 
mode
));

205 ià((
”r
 = 
	`·s_£t_šŒ
 (
PAS_PCM_INTRBITS
)) < 0)

206  
”r
;

208 ià(!
	`DMAbuf_İ’_dma
 (
dev
))

210 
	`·s_»move_šŒ
 (
PAS_PCM_INTRBITS
);

211  
	`RET_ERROR
 (
EBUSY
);

214 
pcm_couÁ
 = 0;

217 
	}
}

220 
	$·s_pcm_şo£
 (
dev
)

222 
æags
;

224 
	`TRACE
 (
	`´štk
 ("pas2_pcm.c: static void…as_pcm_close(void)\n"));

226 
	`DISABLE_INTR
 (
æags
);

228 
	`·s_pcm_»£t
 (
dev
);

229 
	`DMAbuf_şo£_dma
 (
dev
);

230 
	`·s_»move_šŒ
 (
PAS_PCM_INTRBITS
);

231 
pcm_mode
 = 
PCM_NON
;

233 
	`RESTORE_INTR
 (
æags
);

234 
	}
}

237 
	$·s_pcm_ouut_block
 (
dev
, 
buf
, 
couÁ
,

238 
šŒæag
, 
»¡¬t_dma
)

240 
æags
, 
út
;

242 
	`TRACE
 (
	`´štk
 ("·s2_pcm.c: stiøvoid…as_pcm_ouut_block(ch¬ *buàğ%P, iÁ couÁ = %X)\n", 
buf
, 
couÁ
));

244 
út
 = 
couÁ
;

245 ià(
sound_d¥_dmachª
[
dev
] > 3)

246 
út
 >>= 1;

248 ià(
sound_dma_automode
[
dev
] &&

249 
šŒæag
 &&

250 
út
 =ğ
pcm_couÁ
)

253 
	`DISABLE_INTR
 (
æags
);

255 
	`·s_wr™e
 (
	`·s_»ad
 (
PCM_CONTROL
è& ~
P_C_PCM_ENABLE
,

256 
PCM_CONTROL
);

258 ià(
»¡¬t_dma
)

259 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_WRITE
);

261 ià(
sound_d¥_dmachª
[
dev
] > 3)

262 
couÁ
 >>= 1;

264 ià(
couÁ
 !ğ
pcm_couÁ
)

266 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è& ~
F_F_PCM_BUFFER_COUNTER
, FILTER_FREQUENCY);

267 
	`·s_wr™e
 (
S_C_C_SAMPLE_BUFFER
 | 
S_C_C_LSB_THEN_MSB
 | 
S_C_C_SQUARE_WAVE
, 
SAMPLE_COUNTER_CONTROL
);

268 
	`·s_wr™e
 (
couÁ
 & 0xff, 
SAMPLE_BUFFER_COUNTER
);

269 
	`·s_wr™e
 ((
couÁ
 >> 8è& 0xff, 
SAMPLE_BUFFER_COUNTER
);

270 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è| 
F_F_PCM_BUFFER_COUNTER
, FILTER_FREQUENCY);

272 
pcm_couÁ
 = 
couÁ
;

274 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è| 
F_F_PCM_BUFFER_COUNTER
 | 
F_F_PCM_RATE_COUNTER
, FILTER_FREQUENCY);

275 
	`·s_wr™e
 (
	`·s_»ad
 (
PCM_CONTROL
è| 
P_C_PCM_ENABLE
 | 
P_C_PCM_DAC_MODE
, PCM_CONTROL);

277 
pcm_mode
 = 
PCM_DAC
;

279 
	`RESTORE_INTR
 (
æags
);

280 
	}
}

283 
	$·s_pcm_¡¬t_šput
 (
dev
, 
buf
, 
couÁ
,

284 
šŒæag
, 
»¡¬t_dma
)

286 
æags
;

287 
út
;

289 
	`TRACE
 (
	`´štk
 ("·s2_pcm.c: stiøvoid…as_pcm_¡¬t_šput(ch¬ *buàğ%P, iÁ couÁ = %X)\n", 
buf
, 
couÁ
));

291 
út
 = 
couÁ
;

292 ià(
sound_d¥_dmachª
[
dev
] > 3)

293 
út
 >>= 1;

295 ià(
sound_dma_automode
[
my_devnum
] &&

296 
šŒæag
 &&

297 
út
 =ğ
pcm_couÁ
)

300 
	`DISABLE_INTR
 (
æags
);

302 ià(
»¡¬t_dma
)

303 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_READ
);

305 ià(
sound_d¥_dmachª
[
dev
] > 3)

306 
couÁ
 >>= 1;

308 ià(
couÁ
 !ğ
pcm_couÁ
)

310 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è& ~
F_F_PCM_BUFFER_COUNTER
, FILTER_FREQUENCY);

311 
	`·s_wr™e
 (
S_C_C_SAMPLE_BUFFER
 | 
S_C_C_LSB_THEN_MSB
 | 
S_C_C_SQUARE_WAVE
, 
SAMPLE_COUNTER_CONTROL
);

312 
	`·s_wr™e
 (
couÁ
 & 0xff, 
SAMPLE_BUFFER_COUNTER
);

313 
	`·s_wr™e
 ((
couÁ
 >> 8è& 0xff, 
SAMPLE_BUFFER_COUNTER
);

314 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è| 
F_F_PCM_BUFFER_COUNTER
, FILTER_FREQUENCY);

316 
pcm_couÁ
 = 
couÁ
;

318 
	`·s_wr™e
 (
	`·s_»ad
 (
FILTER_FREQUENCY
è| 
F_F_PCM_BUFFER_COUNTER
 | 
F_F_PCM_RATE_COUNTER
, FILTER_FREQUENCY);

319 
	`·s_wr™e
 ((
	`·s_»ad
 (
PCM_CONTROL
è| 
P_C_PCM_ENABLE
è& ~
P_C_PCM_DAC_MODE
, PCM_CONTROL);

321 
pcm_mode
 = 
PCM_ADC
;

323 
	`RESTORE_INTR
 (
æags
);

324 
	}
}

327 
	$·s_pcm_´•¬e_fÜ_šput
 (
dev
, 
bsize
, 
bcouÁ
)

330 
	}
}

332 
	$·s_pcm_´•¬e_fÜ_ouut
 (
dev
, 
bsize
, 
bcouÁ
)

335 
	}
}

337 
audio_İ”©iÚs
 
	g·s_pcm_İ”©iÚs
 =

340 
·s_pcm_İ’
,

341 
·s_pcm_şo£
,

342 
·s_pcm_ouut_block
,

343 
·s_pcm_¡¬t_šput
,

344 
·s_pcm_ioùl
,

345 
·s_pcm_´•¬e_fÜ_šput
,

346 
·s_pcm_´•¬e_fÜ_ouut
,

347 
·s_pcm_»£t
,

348 
·s_pcm_»£t
,

349 
NULL
,

350 
NULL


354 
	$·s_pcm_š™
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

356 
	`TRACE
 (
	`´štk
 ("·s2_pcm.c:†Úg…as_pcm_š™ÖÚg mem_¡¬ˆğ%X)\n", 
mem_¡¬t
));

358 
pcm_b™sok
 = 8;

359 ià(
	`·s_»ad
 (
OPERATION_MODE_1
è& 
O_M_1_PCM_TYPE
)

360 
pcm_b™sok
 |= 16;

362 
	`pcm_£t_¥“d
 (
DSP_DEFAULT_SPEED
);

364 ià(
num_d¥devs
 < 
MAX_DSP_DEV
)

366 
d¥_devs
[
my_devnum
 = 
num_d¥devs
++] = &
·s_pcm_İ”©iÚs
;

367 
sound_d¥_dmachª
[
my_devnum
] = 
hw_cÚfig
->
dma
;

368 #iâdeà
PAS_NO_AUTODMA


369 ià(
hw_cÚfig
->
dma
 > 3)

371 
sound_buffcouÁs
[
my_devnum
] = 1;

372 
sound_buffsizes
[
my_devnum
] = 2 * 65536;

373 
sound_dma_automode
[
my_devnum
] = 1;

377 
sound_buffcouÁs
[
my_devnum
] = 1;

378 
sound_buffsizes
[
my_devnum
] = 
DSP_BUFFSIZE
;

379 
sound_dma_automode
[
my_devnum
] = 1;

382 
sound_buffcouÁs
[
my_devnum
] = 2;

383 
sound_buffsizes
[
my_devnum
] = 
DSP_BUFFSIZE
;

384 
sound_dma_automode
[
my_devnum
] = 0;

388 
	`´štk
 ("PAS2: Too many PCM devices‡vailable\n");

390  
mem_¡¬t
;

391 
	}
}

394 
	$·s_pcm_š‹¼u±
 (
¡©us
, 
ÿu£
)

396 ià(
ÿu£
 == 1)

403 ià(!
sound_dma_automode
[
my_devnum
])

405 
	`·s_wr™e
 (
	`·s_»ad
 (
PCM_CONTROL
è& ~
P_C_PCM_ENABLE
,

406 
PCM_CONTROL
);

409 
pcm_mode
)

412 
PCM_DAC
:

413 
	`DMAbuf_ouutšŒ
 (
my_devnum
, 1);

416 
PCM_ADC
:

417 
	`DMAbuf_šputšŒ
 (
my_devnum
);

421 
	`´štk
 ("PAS: Unexpected PCM interrupt\n");

424 
	}
}

	@drivers/sound/patmgr.c

30 
	#PATMGR_C


	)

31 
	~"sound_cÚfig.h
"

33 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SEQUENCER
)

35 
DEFINE_WAIT_QUEUES
 (
£rv”_´ocs
[
MAX_SYNTH_DEV
],

36 
£rv”_wa™_æag
[
MAX_SYNTH_DEV
]);

38 
·tmgr_šfo
 *
	gmbox
[
MAX_SYNTH_DEV
] =

39 {
NULL
};

40 vŞ©
	gmsg_dœeùiÚ
[
MAX_SYNTH_DEV
] =

43 
	gpmgr_İ’ed
[
MAX_SYNTH_DEV
] =

46 
	#A_TO_S
 1

	)

47 
	#S_TO_A
 2

	)

49 
DEFINE_WAIT_QUEUE
 (
­¶_´oc
, 
­¶_wa™_æag
);

52 
	$pmgr_İ’
 (
dev
)

54 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

55  
	`RET_ERROR
 (
ENXIO
);

57 ià(
pmgr_İ’ed
[
dev
])

58  
	`RET_ERROR
 (
EBUSY
);

59 
pmgr_İ’ed
[
dev
] = 1;

61 
	`RESET_WAIT_QUEUE
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]);

64 
	}
}

67 
	$pmgr_»Ëa£
 (
dev
)

70 ià(
mbox
[
dev
])

73 
mbox
[
dev
]->
key
 = 
PM_ERROR
;

74 
mbox
[
dev
]->
·rm1
 = 
	`RET_ERROR
 (
EIO
);

76 ià(
	`SOMEONE_WAITING
 (
­¶_´oc
, 
­¶_wa™_æag
))

77 
	`WAKE_UP
 (
­¶_´oc
, 
­¶_wa™_æag
);

80 
pmgr_İ’ed
[
dev
] = 0;

81 
	}
}

84 
	$pmgr_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

86 
æags
;

87 
ok
 = 0;

89 ià(
couÁ
 !ğ (
·tmgr_šfo
))

91 
	`´štk
 ("PATMGR%d: Inv®id„—d couÁ\n", 
dev
);

92  
	`RET_ERROR
 (
EIO
);

95 !
ok
 && !
	`PROCESS_ABORTING
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]))

97 
	`DISABLE_INTR
 (
æags
);

99 !(
mbox
[
dev
] && 
msg_dœeùiÚ
[dev] =ğ
A_TO_S
) &&

100 !
	`PROCESS_ABORTING
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]))

102 
	`DO_SLEEP
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev], 0);

105 ià(
mbox
[
dev
] && 
msg_dœeùiÚ
[dev] =ğ
A_TO_S
)

107 
	`COPY_TO_USER
 (
buf
, 0, (*è
mbox
[
dev
], 
couÁ
);

108 
msg_dœeùiÚ
[
dev
] = 0;

109 
ok
 = 1;

112 
	`RESTORE_INTR
 (
æags
);

116 ià(!
ok
)

117  
	`RET_ERROR
 (
EINTR
);

118  
couÁ
;

119 
	}
}

122 
	$pmgr_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

124 
æags
;

126 ià(
couÁ
 < 4)

128 
	`´štk
 ("PATMGR%d: Wr™couÁ < 4\n", 
dev
);

129  
	`RET_ERROR
 (
EIO
);

132 
	`COPY_FROM_USER
 (
mbox
[
dev
], 
buf
, 0, 4);

134 ià(*(*è
mbox
[
dev
] =ğ
SEQ_FULLSIZE
)

136 
tmp_dev
;

138 
tmp_dev
 = ((*è
mbox
[
dev
])[2];

139 ià(
tmp_dev
 !ğ
dev
)

140  
	`RET_ERROR
 (
ENXIO
);

142  
syÁh_devs
[
dev
]->
	`lßd_·tch
 (dev, *(*è
mbox
[dev],

143 
buf
, 4, 
couÁ
, 1);

146 ià(
couÁ
 !ğ (
·tmgr_šfo
))

148 
	`´štk
 ("PATMGR%d: Inv®id wr™couÁ\n", 
dev
);

149  
	`RET_ERROR
 (
EIO
);

157 
	`DISABLE_INTR
 (
æags
);

159 ià(
mbox
[
dev
] && !
msg_dœeùiÚ
[dev])

161 
	`COPY_FROM_USER
 (&((*è
mbox
[
dev
])[4], 
buf
, 4, 
couÁ
 - 4);

162 
msg_dœeùiÚ
[
dev
] = 
S_TO_A
;

164 ià(
	`SOMEONE_WAITING
 (
­¶_´oc
, 
­¶_wa™_æag
))

166 
	`WAKE_UP
 (
­¶_´oc
, 
­¶_wa™_æag
);

170 
	`RESTORE_INTR
 (
æags
);

172  
couÁ
;

173 
	}
}

176 
	$pmgr_acûss
 (
dev
, 
·tmgr_šfo
 *
»c
)

178 
æags
;

179 
”r
 = 0;

181 
	`DISABLE_INTR
 (
æags
);

183 ià(
mbox
[
dev
])

184 
	`´štk
 (" PATMGR: S”v” %d mbox fuÎ. Why?\n", 
dev
);

187 
»c
->
key
 = 
PM_K_COMMAND
;

188 
mbox
[
dev
] = 
»c
;

189 
msg_dœeùiÚ
[
dev
] = 
A_TO_S
;

191 ià(
	`SOMEONE_WAITING
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]))

193 
	`WAKE_UP
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]);

196 
	`DO_SLEEP
 (
­¶_´oc
, 
­¶_wa™_æag
, 0);

198 ià(
msg_dœeùiÚ
[
dev
] !ğ
S_TO_A
)

200 
»c
->
key
 = 
PM_ERROR
;

201 
»c
->
·rm1
 = 
	`RET_ERROR
 (
EIO
);

203 ià(
»c
->
key
 =ğ
PM_ERROR
)

205 
”r
 = 
»c
->
·rm1
;

206 ià(
”r
 > 0)

207 
”r
 = -err;

210 
mbox
[
dev
] = 
NULL
;

211 
msg_dœeùiÚ
[
dev
] = 0;

214 
	`RESTORE_INTR
 (
æags
);

216  
”r
;

217 
	}
}

220 
	$pmgr_šfÜm
 (
dev
, 
ev’t
, 
p1
, 
p2
,

221 
p3
, 
p4
)

223 
æags
;

224 
”r
 = 0;

226 ià(!
pmgr_İ’ed
[
dev
])

229 
	`DISABLE_INTR
 (
æags
);

231 ià(
mbox
[
dev
])

232 
	`´štk
 (" PATMGR: S”v” %d mbox fuÎ. Why?\n", 
dev
);

235 
mbox
[
dev
] =

236 (
·tmgr_šfo
 *è
	`KERNEL_MALLOC
 ( (patmgr_info));

238 
mbox
[
dev
]->
key
 = 
PM_K_EVENT
;

239 
mbox
[
dev
]->
commªd
 = 
ev’t
;

240 
mbox
[
dev
]->
·rm1
 = 
p1
;

241 
mbox
[
dev
]->
·rm2
 = 
p2
;

242 
mbox
[
dev
]->
·rm3
 = 
p3
;

243 
msg_dœeùiÚ
[
dev
] = 
A_TO_S
;

245 ià(
	`SOMEONE_WAITING
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]))

247 
	`WAKE_UP
 (
£rv”_´ocs
[
dev
], 
£rv”_wa™_æag
[dev]);

250 
	`DO_SLEEP
 (
­¶_´oc
, 
­¶_wa™_æag
, 0);

251 ià(
mbox
[
dev
])

252 
	`KERNEL_FREE
 (
mbox
[
dev
]);

253 
mbox
[
dev
] = 
NULL
;

254 
msg_dœeùiÚ
[
dev
] = 0;

257 
	`RESTORE_INTR
 (
æags
);

259  
”r
;

260 
	}
}

	@drivers/sound/sb.h

1 
	#DSP_RESET
 (
sbc_ba£
 + 0x6)

	)

2 
	#DSP_READ
 (
sbc_ba£
 + 0xA)

	)

3 
	#DSP_WRITE
 (
sbc_ba£
 + 0xC)

	)

4 
	#DSP_COMMAND
 (
sbc_ba£
 + 0xC)

	)

5 
	#DSP_STATUS
 (
sbc_ba£
 + 0xC)

	)

6 
	#DSP_DATA_AVAIL
 (
sbc_ba£
 + 0xE)

	)

7 
	#DSP_DATA_AVL16
 (
sbc_ba£
 + 0xF)

	)

8 
	#MIXER_ADDR
 (
sbc_ba£
 + 0x4)

	)

9 
	#MIXER_DATA
 (
sbc_ba£
 + 0x5)

	)

10 
	#OPL3_LEFT
 (
sbc_ba£
 + 0x0)

	)

11 
	#OPL3_RIGHT
 (
sbc_ba£
 + 0x2)

	)

12 
	#OPL3_BOTH
 (
sbc_ba£
 + 0x8)

	)

15 
	#DSP_CMD_SPKON
 0xD1

	)

16 
	#DSP_CMD_SPKOFF
 0xD3

	)

17 
	#DSP_CMD_DMAON
 0xD0

	)

18 
	#DSP_CMD_DMAOFF
 0xD4

	)

20 
	#IMODE_NONE
 0

	)

21 
	#IMODE_OUTPUT
 1

	)

22 
	#IMODE_INPUT
 2

	)

23 
	#IMODE_INIT
 3

	)

24 
	#IMODE_MIDI
 4

	)

26 
	#NORMAL_MIDI
 0

	)

27 
	#UART_MIDI
 1

	)

	@drivers/sound/sb16_dsp.c

32 
	#DEB
(
x
)

	)

33 
	#DEB1
(
x
)

	)

37 
	~"sound_cÚfig.h
"

38 
	~"sb.h
"

39 
	~"sb_mix”.h
"

41 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SB16
è&& !defšed(
EXCLUDE_SB
è&& !defšed(
EXCLUDE_AUDIO
è&& !defšed(
EXCLUDE_SBPRO
)

43 
sbc_ba£
;

45 
	gsb16_d¥_ok
 = 0;

46 
	gd¥_16b™
 = 0;

47 
	gd¥_¡”eo
 = 0;

48 
	gd¥_cu¼’t_¥“d
 = 8000;

49 
	gd¥_busy
 = 0;

50 
	gdma16
, 
	gdma8
;

51 
	gd¥_couÁ
 = 0;

53 
	gœq_mode
 = 
IMODE_NONE
;

55 
	gmy_dev
 = 0;

57 vŞ©
	gšŒ_aùive
 = 0;

59 
sb16_d¥_İ’
 (
dev
, 
mode
);

60 
sb16_d¥_şo£
 (
dev
);

61 
sb16_d¥_ouut_block
 (
dev
, 
buf
, 
couÁ
,
šŒæag
, 
dma_»¡¬t
);

62 
sb16_d¥_¡¬t_šput
 (
dev
, 
buf
, 
couÁ
,
šŒæag
, 
dma_»¡¬t
);

63 
sb16_d¥_ioùl
 (
dev
, 
cmd
, 
¬g
,
loÿl
);

64 
sb16_d¥_´•¬e_fÜ_šput
 (
dev
, 
bsize
, 
bcouÁ
);

65 
sb16_d¥_´•¬e_fÜ_ouut
 (
dev
, 
bsize
, 
bcouÁ
);

66 
sb16_d¥_»£t
 (
dev
);

67 
sb16_d¥_h®t
 (
dev
);

68 
d¥_£t_¥“d
 ();

69 
d¥_£t_¡”eo
 ();

70 
d¥_ş—nup
 ();

71 
sb_»£t_d¥
 ();

73 
audio_İ”©iÚs
 
	gsb16_d¥_İ”©iÚs
 =

76 
sb16_d¥_İ’
,

77 
sb16_d¥_şo£
,

78 
sb16_d¥_ouut_block
,

79 
sb16_d¥_¡¬t_šput
,

80 
sb16_d¥_ioùl
,

81 
sb16_d¥_´•¬e_fÜ_šput
,

82 
sb16_d¥_´•¬e_fÜ_ouut
,

83 
sb16_d¥_»£t
,

84 
sb16_d¥_h®t
,

85 
NULL
,

86 
NULL


89 
	$sb_d¥_commªd01
 (
v®
)

91 
i
=1<<16;

93 --
i
 & (!
	`INB
 (
DSP_STATUS
) & 0x80));

94 if(!
i
)

95 
	`´štk
("SB16 sb_dsp_command01 Timeout\n");

96  
	`sb_d¥_commªd
(
v®
);

97 
	}
}

99 
	$wa™_d©a_ava
(
t
)

101 
loİc
=5000000;

102 
t
+=
	`GET_TIME
();

104 if(
	`INB
(
DSP_DATA_AVAIL
) & 0x80)

106 } --
loİc
 && 
	`GET_TIME
()<
t
);

107 
	`´štk
("!d©a_ava†=%d\n",
loİc
);

109 
	}
}

111 
	$»ad_d¥
(
t
)

113 if(!
	`wa™_d©a_ava
(
t
))

116  
	`INB
(
DSP_READ
);

117 
	}
}

119 
	$d¥_ši2
()

123 
	`sb_d¥_commªd
(0xe2);

124 
	`sb_d¥_commªd
(0x76);

125 
	`sb_d¥_commªd
(0xe2);

126 
	`sb_d¥_commªd
(0x30);

127 
	`sb_d¥_commªd
(0xe4);

128 
	`sb_d¥_commªd
(0xaa);

129 
	`sb_d¥_commªd
(0xe8);

130 if(
	`»ad_d¥
(100)!=0xaa)

131 
	`´štk
("Error dsp_ini2\n");

134 
	}
}

165 
	$d¥_£t_¥“d
(
mode
)

167 
	`DEB
(
	`´štk
("d¥_£t_¥“d(%d)\n",
mode
));

168 ià(
mode
)

170 ià(
mode
 < 5000) mode = 5000;

171 ià(
mode
 > 44100) mode = 44100;

172 
d¥_cu¼’t_¥“d
=
mode
;

174  
mode
;

175 
	}
}

177 
	$d¥_£t_¡”eo
(
mode
)

179 
	`DEB
(
	`´štk
("d¥_£t_¡”eo(%d)\n",
mode
));

181 
d¥_¡”eo
=
mode
;

183  
mode
;

184 
	}
}

186 
	$d¥_£t_b™s
(
¬g
) {

187 
	`DEB
(
	`´štk
("d¥_£t_b™s(%d)\n",
¬g
));

189 ià(
¬g
)

190 
¬g
) {

192 
d¥_16b™
=0; ;

194 
d¥_16b™
=1; ;

196  
	`RET_ERROR
(
EINVAL
);

198  
d¥_16b™
? 16:8;

199 
	}
}

202 
	$sb16_d¥_ioùl
 (
dev
, 
cmd
, 
¬g
,
loÿl
)

204 
cmd
) {

205 
SOUND_PCM_WRITE_RATE
:

206 if(
loÿl
)

207  
	`d¥_£t_¥“d
(
¬g
);

208  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_¥“d
 (
	`IOCTL_IN
 (arg)));

210 
SOUND_PCM_READ_RATE
:

211 if(
loÿl
)

212  
d¥_cu¼’t_¥“d
;

213  
	`IOCTL_OUT
 (
¬g
, 
d¥_cu¼’t_¥“d
);

215 
SNDCTL_DSP_STEREO
:

216 ià(
loÿl
)

217  
	`d¥_£t_¡”eo
(
¬g
);

218  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_¡”eo
(
	`IOCTL_IN
(arg)));

220 
SOUND_PCM_WRITE_CHANNELS
:

221 ià(
loÿl
)

222  
	`d¥_£t_¡”eo
(
¬g
-1)+1;

223  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_¡”eo
 (
	`IOCTL_IN
 (arg) - 1) + 1);

225 
SOUND_PCM_READ_CHANNELS
:

226 ià(
loÿl
)

227  
d¥_¡”eo
+1;

228  
	`IOCTL_OUT
 (
¬g
, 
d¥_¡”eo
+1);

230 
SNDCTL_DSP_SAMPLESIZE
:

231 ià(
loÿl
)

232  
	`d¥_£t_b™s
 (
¬g
);

233  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_b™s
 (
	`IOCTL_IN
 (arg)));

235 
SOUND_PCM_READ_BITS
:

236 ià(
loÿl
)

237  
d¥_16b™
?16:8;

238  
	`IOCTL_OUT
 (
¬g
, 
d¥_16b™
?16:8);

240 
SOUND_PCM_WRITE_FILTER
:

241 ià(
	`IOCTL_IN
 (
¬g
) > 1)

242  
	`IOCTL_OUT
 (
¬g
, 
	`RET_ERROR
 (
EINVAL
));

244  
	`RET_ERROR
 (
EINVAL
);

247  
	`RET_ERROR
 (
EINVAL
);

248 
	}
}

251 
	$sb16_d¥_İ’
 (
dev
, 
mode
)

253 
»tv®
;

255 
	`DEB
(
	`´štk
("sb16_dsp_open()\n"));

256 ià(!
sb16_d¥_ok
)

258 
	`´štk
 ("SB16 Error: SoundBlaster board‚ot installed\n");

259  
	`RET_ERROR
(
ENXIO
);

262 ià(
šŒ_aùive
)

263  
	`RET_ERROR
(
EBUSY
);

265 
»tv®
 = 
	`sb_g‘_œq
 ();

266 ià(
»tv®
<0)

267  
»tv®
;

269 ià(
	`ALLOC_DMA_CHN
 (
dma8
))

271 
	`´štk
 ("SB16: UÇbËØg¿b DMA%d\n", 
dma8
);

272 
	`sb_ä“_œq
();

273  
	`RET_ERROR
(
EBUSY
);

276 ià(
dma16
 !ğ
dma8
)

277 ià(
	`ALLOC_DMA_CHN
 (
dma16
))

279 
	`´štk
 ("SB16: UÇbËØg¿b DMA%d\n", 
dma16
);

280 
	`sb_ä“_œq
();

281 
	`RELEASE_DMA_CHN
 (
dma8
);

282  
	`RET_ERROR
(
EBUSY
);

285 
	`d¥_ši2
();

287 
œq_mode
 = 
IMODE_NONE
;

288 
d¥_busy
 = 1;

291 
	}
}

294 
	$sb16_d¥_şo£
 (
dev
)

296 
æags
;

297 
	`DEB
(
	`´štk
("sb16_dsp_close()\n"));

298 
	`sb_d¥_commªd01
(0xd9);

299 
	`sb_d¥_commªd01
(0xd5);

301 
	`DISABLE_INTR
 (
æags
);

302 
	`RELEASE_DMA_CHN
 (
dma8
);

304 ià(
dma16
 !ğ
dma8
)

305 
	`RELEASE_DMA_CHN
 (
dma16
);

306 
	`sb_ä“_œq
 ();

307 
	`d¥_ş—nup
 ();

308 
d¥_busy
 = 0;

309 
	`RESTORE_INTR
 (
æags
);

310 
	}
}

313 
	$sb16_d¥_ouut_block
 (
dev
, 
buf
, 
couÁ
,
šŒæag
, 
dma_»¡¬t
)

315 
æags
, 
út
;

317 
út
 = 
couÁ
;

318 ià(
d¥_16b™
)

319 
út
 >>= 1;

320 
út
--;

322 #ifdeà
DEB_DMARES


323 
	`´štk
("ouut_block: %x %d %d\n",
buf
,
couÁ
,
šŒæag
);

324 if(
šŒæag
) {

325 
pos
,
chª
=
sound_d¥_dmachª
[
dev
];

326 
	`DISABLE_INTR
 (
æags
);

327 
	`ş—r_dma_ff
(
chª
);

328 
	`di§bË_dma
(
chª
);

329 
pos
=
	`g‘_dma_»sidue
(
chª
);

330 
	`’abË_dma
(
chª
);

331 
	`RESTORE_INTR
 (
æags
);

332 
	`´štk
("dm­os=%d %x\n",
pos
,pos);

335 ià(
sound_dma_automode
[
dev
] &&

336 
šŒæag
 &&

337 
út
 =ğ
d¥_couÁ
) {

338 
œq_mode
 = 
IMODE_OUTPUT
;

339 
šŒ_aùive
 = 1;

342 
	`DISABLE_INTR
 (
æags
);

344 ià(
dma_»¡¬t
)

346 
	`sb16_d¥_h®t
(
dev
);

347 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_WRITE
);

349 
	`sb_d¥_commªd
 (0x41);

350 
	`sb_d¥_commªd
 (()((
d¥_cu¼’t_¥“d
 >> 8) & 0xff));

351 
	`sb_d¥_commªd
 (()(
d¥_cu¼’t_¥“d
 & 0xff));

352 
	`sb_d¥_commªd
 (()(
d¥_16b™
 ? 0xb6 : 0xc6));

353 
	`sb_d¥_commªd
 (()((
d¥_¡”eo
 ? 0x20 : 0) +

354 (
d¥_16b™
 ? 0x10:0)));

355 
	`sb_d¥_commªd01
 (()(
út
&0xff));

356 
	`sb_d¥_commªd
 (()(
út
>>8));

360 
	`RESTORE_INTR
 (
æags
);

361 
d¥_couÁ
=
út
;

362 
œq_mode
 = 
IMODE_OUTPUT
;

363 
šŒ_aùive
 = 1;

364 
	}
}

367 
	$sb16_d¥_¡¬t_šput
 (
dev
, 
buf
, 
couÁ
,
šŒæag
, 
dma_»¡¬t
)

369 
æags
, 
út
;

371 
út
 = 
couÁ
;

372 ià(
d¥_16b™
)

373 
út
 >>= 1;

374 
út
--;

376 #ifdeà
DEB_DMARES


377 
	`´štk
("¡¬t_šput: %x %d %d\n",
buf
,
couÁ
,
šŒæag
);

378 if(
šŒæag
) {

379 
pos
,
chª
=
sound_d¥_dmachª
[
dev
];

380 
	`DISABLE_INTR
 (
æags
);

381 
	`ş—r_dma_ff
(
chª
);

382 
	`di§bË_dma
(
chª
);

383 
pos
=
	`g‘_dma_»sidue
(
chª
);

384 
	`’abË_dma
(
chª
);

385 
	`RESTORE_INTR
 (
æags
);

386 
	`´štk
("dm­os=%d %x\n",
pos
,pos);

389 ià(
sound_dma_automode
[
dev
] &&

390 
šŒæag
 &&

391 
út
 =ğ
d¥_couÁ
) {

392 
œq_mode
 = 
IMODE_INPUT
;

393 
šŒ_aùive
 = 1;

396 
	`DISABLE_INTR
 (
æags
);

398 ià(
dma_»¡¬t
)

400 
	`sb16_d¥_h®t
(
dev
);

401 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_READ
);

404 
	`sb_d¥_commªd
 (0x42);

405 
	`sb_d¥_commªd
 (()((
d¥_cu¼’t_¥“d
 >> 8) & 0xff));

406 
	`sb_d¥_commªd
 (()(
d¥_cu¼’t_¥“d
 & 0xff));

407 
	`sb_d¥_commªd
 (()(
d¥_16b™
 ? 0xbe : 0xce));

408 
	`sb_d¥_commªd
 (()((
d¥_¡”eo
 ? 0x20 : 0) +

409 (
d¥_16b™
 ? 0x10:0)));

410 
	`sb_d¥_commªd01
 (()(
út
&0xff));

411 
	`sb_d¥_commªd
 (()(
út
>>8));

415 
	`RESTORE_INTR
 (
æags
);

416 
d¥_couÁ
=
út
;

417 
œq_mode
 = 
IMODE_INPUT
;

418 
šŒ_aùive
 = 1;

419 
	}
}

422 
	$sb16_d¥_´•¬e_fÜ_šput
 (
dev
, 
bsize
, 
bcouÁ
)

424 
sound_d¥_dmachª
[
my_dev
] = 
d¥_16b™
? 
dma16
:
dma8
;

425 
d¥_couÁ
 = 0;

426 
	`d¥_ş—nup
 ();

428 
	}
}

431 
	$sb16_d¥_´•¬e_fÜ_ouut
 (
dev
, 
bsize
, 
bcouÁ
)

433 
sound_d¥_dmachª
[
my_dev
] = 
d¥_16b™
? 
dma16
:
dma8
;

434 
d¥_couÁ
 = 0;

435 
	`d¥_ş—nup
 ();

437 
	}
}

440 
	$d¥_ş—nup
 ()

442 
œq_mode
 = 
IMODE_NONE
;

443 
šŒ_aùive
 = 0;

444 
	}
}

447 
	$sb16_d¥_»£t
 (
dev
)

449 
æags
;

451 
	`DISABLE_INTR
 (
æags
);

453 
	`sb_»£t_d¥
 ();

454 
	`d¥_ş—nup
 ();

456 
	`RESTORE_INTR
 (
æags
);

457 
	}
}

460 
	$sb16_d¥_h®t
 (
dev
)

462 ià(
d¥_16b™
)

464 
	`sb_d¥_commªd01
(0xd9);

465 
	`sb_d¥_commªd01
(0xd5);

469 
	`sb_d¥_commªd01
(0xda);

470 
	`sb_d¥_commªd01
(0xd0);

472 
	}
}

475 
	$£t_œq_hw
(
Ëv–
) {

476 
iv®
;

477 
Ëv–
) {

479 
iv®
=2; ;

481 
iv®
=4; ;

483 
iv®
=8; ;

485 
	`´štk
("SB16_IRQ_LEVEL %d dÛ nÙƒxi¡\n",
Ëv–
);

488 
	`sb_£tmix”
(
IRQ_NR
,
iv®
);

489 
	}
}

492 
	$sb16_d¥_š™
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

494 
i
, 
majÜ
, 
mšÜ
;

496 
majÜ
 = 
mšÜ
 = 0;

497 
	`sb_d¥_commªd
 (0xe1);

499 
i
 = 1000; i; i--) {

500 ià(
	`INB
 (
DSP_DATA_AVAIL
) & 0x80)

502 ià(
majÜ
 == 0)

503 
majÜ
 = 
	`INB
 (
DSP_READ
);

506 
mšÜ
 = 
	`INB
 (
DSP_READ
);

512 #iâdeà
SCO


513 
	`¥rštf
 (
sb16_d¥_İ”©iÚs
.
Çme
, "SoundBÏ¡” 16 %d.%d", 
majÜ
, 
mšÜ
);

516 
	`´štk
 (" <%s>", 
sb16_d¥_İ”©iÚs
.
Çme
);

518 ià(
num_d¥devs
 < 
MAX_DSP_DEV
)

520 
d¥_devs
[
my_dev
 = 
num_d¥devs
++] = &
sb16_d¥_İ”©iÚs
;

521 
sound_d¥_dmachª
[
my_dev
] = 
hw_cÚfig
->
dma
;

522 
sound_buffcouÁs
[
my_dev
] = 1;

523 
sound_buffsizes
[
my_dev
] = 
DSP_BUFFSIZE
;

524 
sound_dma_automode
[
my_dev
] = 1;

527 
	`´štk
 ("SB: Too many DSP devices‡vailable\n");

528 
sb16_d¥_ok
 = 1;

529  
mem_¡¬t
;

530 
	}
}

533 
	$sb16_d¥_d‘eù
 (
add»ss_šfo
 *
hw_cÚfig
)

535 
add»ss_šfo
 *
sb_cÚfig
;

537 ià(
sb16_d¥_ok
)

540 ià(!(
sb_cÚfig
=
	`sound_g‘cÚf
(
SNDCARD_SB
)))

542 
	`´štk
("SB16 Error: Plain SB‚ot configured\n");

546 ià(
sbc_ba£
 !ğ
hw_cÚfig
->
io_ba£
)

547 
	`´štk
("Warning! SB16 I/O != SB I/O\n");

553 ià(!
	`sb_»£t_d¥
 ())

556 ià(
hw_cÚfig
->
œq
 !ğ
sb_cÚfig
->irq)

558 
	`´štk
("SB16 Error: Invalid IRQ‚umber %d/%d\n",

559 
sb_cÚfig
->
œq
, 
hw_cÚfig
->irq);

563 ià(
hw_cÚfig
->
dma
 < 4)

564 ià(
hw_cÚfig
->
dma
 !ğ
sb_cÚfig
->dma)

566 
	`´štk
("SB16 Error: Invalid DMA channel %d/%d\n",

567 
sb_cÚfig
->
dma
, 
hw_cÚfig
->dma);

571 
dma16
 = 
hw_cÚfig
->
dma
;

572 
dma8
 = 
sb_cÚfig
->
dma
;

573 
	`£t_œq_hw
(
hw_cÚfig
->
œq
);

574 
	`sb_£tmix”
(
DMA_NR
, (1<<
hw_cÚfig
->
dma
è| (1<<
sb_cÚfig
->dma));

576 
	`DEB
(
	`´štk
 ("SoundBÏ¡” 16: IRQ %d DMA %d OK\n",
hw_cÚfig
->
œq
,hw_cÚfig->
dma
));

581 
sb16_d¥_ok
 = 1;

583 
	}
}

586 
	$sb16_d¥_š‹¼u±
 (
unu£d
)

588 
d©a
;

589 
d©a
 = 
	`INB
 (
DSP_DATA_AVL16
);

591 ià(
šŒ_aùive
)

592 
œq_mode
)

594 
IMODE_OUTPUT
:

595 
šŒ_aùive
 = 0;

596 
	`DMAbuf_ouutšŒ
 (
my_dev
, 1);

599 
IMODE_INPUT
:

600 
šŒ_aùive
 = 0;

601 
	`DMAbuf_šputšŒ
 (
my_dev
);

605 
	`´štk
 ("SoundBlaster: Unexpected interrupt\n");

607 
	}
}

	@drivers/sound/sb16_midi.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


34 #ià!
defšed
(
EXCLUDE_SB
è&& !defšed(
EXCLUDE_SB16
è&& !defšed(
EXCLUDE_MIDI
)

36 
	#DATAPORT
 (
sb16midi_ba£
è

	)

37 
	#COMDPORT
 (
sb16midi_ba£
+1è

	)

38 
	#STATPORT
 (
sb16midi_ba£
+1è

	)

40 
	#sb16midi_¡©us
(è
	`INB
(
STATPORT
)

	)

41 
	#šput_ava
(è(!(
	`sb16midi_¡©us
()&
INPUT_AVAIL
))

	)

42 
	#ouut_»ady
(è(!(
	`sb16midi_¡©us
()&
OUTPUT_READY
))

	)

43 
	#sb16midi_cmd
(
cmd
è
	`OUTB
(cmd, 
COMDPORT
)

	)

44 
	#sb16midi_»ad
(è
	`INB
(
DATAPORT
)

	)

45 
	#sb16midi_wr™e
(
by‹
è
	`OUTB
(by‹, 
DATAPORT
)

	)

47 
	#OUTPUT_READY
 0x40

	)

48 
	#INPUT_AVAIL
 0x80

	)

49 
	#MPU_ACK
 0xFE

	)

50 
	#MPU_RESET
 0xFF

	)

51 
	#UART_MODE_ON
 0x3F

	)

53 
	gsb16midi_İ’ed
 = 0;

54 
	gsb16midi_ba£
 = 0x330;

55 
	gsb16midi_d‘eùed
 = 0;

56 
	gmy_dev
;

58 
»£t_sb16midi
 ();

59 (*
midi_šput_šŒ
è(
dev
, 
d©a
);

62 
	$sb16midi_šput_loİ
 ()

64 
couÁ
;

66 
couÁ
 = 10;

68 
couÁ
)

69 ià(
	`šput_ava
 ())

71 
c
 = 
	`sb16midi_»ad
 ();

73 
couÁ
 = 100;

75 ià(
sb16midi_İ’ed
 & 
OPEN_READ
)

76 
	`midi_šput_šŒ
 (
my_dev
, 
c
);

79 !
	`šput_ava
 (è&& 
couÁ
)

80 
couÁ
--;

81 
	}
}

84 
	$sb16midišŒ
 (
un™
)

86 ià(
	`šput_ava
 ())

87 
	`sb16midi_šput_loİ
 ();

88 
	}
}

96 
	$pŞl_sb16midi
 (
dummy
)

98 
æags
;

100 
	`DEFINE_TIMER
(
sb16midi_tim”
, 
pŞl_sb16midi
);

102 ià(!(
sb16midi_İ’ed
 & 
OPEN_READ
))

105 
	`DISABLE_INTR
 (
æags
);

107 ià(
	`šput_ava
 ())

108 
	`sb16midi_šput_loİ
 ();

110 
	`ACTIVATE_TIMER
(
sb16midi_tim”
, 
pŞl_sb16midi
, 1);

112 
	`RESTORE_INTR
 (
æags
);

113 
	}
}

116 
sb16midi_İ’
 (
dev
, 
mode
,

117 (*
šput
è(
dev
, 
d©a
),

118 (*
ouut
è(
dev
)

121 ià(
sb16midi_İ’ed
)

123  
	`RET_ERROR
 (
EBUSY
);

126 
	`sb16midi_šput_loİ
 ();

128 
midi_šput_šŒ
 = 
šput
;

129 
sb16midi_İ’ed
 = 
mode
;

130 
	`pŞl_sb16midi
 (0);

133 
	}
}

136 
	$sb16midi_şo£
 (
dev
)

138 
sb16midi_İ’ed
 = 0;

139 
	}
}

142 
	$sb16midi_out
 (
dev
, 
midi_by‹
)

144 
timeout
;

145 
æags
;

151 
	`DISABLE_INTR
 (
æags
);

153 ià(
	`šput_ava
 ())

154 
	`sb16midi_šput_loİ
 ();

156 
	`RESTORE_INTR
 (
æags
);

163 
timeout
 = 30000;imeouˆ> 0 && !
	`ouut_»ady
 ();imeout--);

165 ià(!
	`ouut_»ady
 ())

167 
	`´štk
 ("MPU-401: Timeout\n");

171 
	`sb16midi_wr™e
 (
midi_by‹
);

173 
	}
}

176 
	$sb16midi_commªd
 (
dev
, 
midi_by‹
)

179 
	}
}

182 
	$sb16midi_¡¬t_»ad
 (
dev
)

185 
	}
}

188 
	$sb16midi_’d_»ad
 (
dev
)

191 
	}
}

194 
	$sb16midi_ioùl
 (
dev
, 
cmd
, 
¬g
)

196  
	`RET_ERROR
 (
EINVAL
);

197 
	}
}

200 
	$sb16midi_kick
 (
dev
)

202 
	}
}

205 
	$sb16midi_bufãr_¡©us
 (
dev
)

208 
	}
}

210 
midi_İ”©iÚs
 
	gsb16midi_İ”©iÚs
 =

212 {"SoundBÏ¡” MPU-401", 0, 0, 
SNDCARD_SB16MIDI
},

213 
sb16midi_İ’
,

214 
sb16midi_şo£
,

215 
sb16midi_ioùl
,

216 
sb16midi_out
,

217 
sb16midi_¡¬t_»ad
,

218 
sb16midi_’d_»ad
,

219 
sb16midi_kick
,

220 
sb16midi_commªd
,

221 
sb16midi_bufãr_¡©us


226 
	$©ch_sb16midi
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

228 
ok
, 
timeout
;

229 
æags
;

231 
sb16midi_ba£
 = 
hw_cÚfig
->
io_ba£
;

233 ià(!
sb16midi_d‘eùed
)

234  
	`RET_ERROR
 (
EIO
);

236 
	`DISABLE_INTR
 (
æags
);

237 
timeout
 = 30000;imeouˆ< 0 && !
	`ouut_»ady
 ();imeout--);

238 
	`sb16midi_cmd
 (
UART_MODE_ON
);

240 
ok
 = 0;

241 
timeout
 = 50000;imeouˆ> 0 && !
ok
;imeout--)

242 ià(
	`šput_ava
 ())

243 ià(
	`sb16midi_»ad
 (è=ğ
MPU_ACK
)

244 
ok
 = 1;

246 
	`RESTORE_INTR
 (
æags
);

248 
	`´štk
 (" <SoundBlaster MPU-401>");

250 
my_dev
 = 
num_midis
;

251 
midi_devs
[
num_midis
++] = &
sb16midi_İ”©iÚs
;

252  
mem_¡¬t
;

253 
	}
}

256 
	$»£t_sb16midi
 ()

258 
æags
;

259 
ok
, 
timeout
, 
n
;

265 
ok
 = 0;

267 
	`DISABLE_INTR
 (
æags
);

269 
n
 = 0;‚ < 2 && !
ok
;‚++)

271 
timeout
 = 30000;imeouˆ< 0 && !
	`ouut_»ady
 ();imeout--);

272 
	`sb16midi_cmd
 (
MPU_RESET
);

279 
timeout
 = 50000;imeouˆ> 0 && !
ok
;imeout--)

280 ià(
	`šput_ava
 ())

281 ià(
	`sb16midi_»ad
 (è=ğ
MPU_ACK
)

282 
ok
 = 1;

286 
sb16midi_İ’ed
 = 0;

287 ià(
ok
)

288 
	`sb16midi_šput_loİ
 ();

290 
	`RESTORE_INTR
 (
æags
);

292  
ok
;

293 
	}
}

297 
	$´obe_sb16midi
 (
add»ss_šfo
 *
hw_cÚfig
)

299 
ok
 = 0;

301 
sb16midi_ba£
 = 
hw_cÚfig
->
io_ba£
;

303 ià(
	`sb_g‘_œq
 () < 0)

306 
ok
 = 
	`»£t_sb16midi
 ();

308 
sb16midi_d‘eùed
 = 
ok
;

309  
ok
;

310 
	}
}

	@drivers/sound/sb_card.c

30 
	~"sound_cÚfig.h
"

32 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SB
)

35 
	$©ch_sb_ÿrd
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

37 #ià!
	`defšed
(
EXCLUDE_AUDIO
è|| !defšed(
EXCLUDE_MIDI
)

38 ià(!
	`sb_d¥_d‘eù
 (
hw_cÚfig
))

39  
mem_¡¬t
;

40 
mem_¡¬t
 = 
	`sb_d¥_š™
 (mem_¡¬t, 
hw_cÚfig
);

43  
mem_¡¬t
;

44 
	}
}

47 
	$´obe_sb
 (
add»ss_šfo
 *
hw_cÚfig
)

49  
	`sb_d¥_d‘eù
 (
hw_cÚfig
);

50 
	}
}

	@drivers/sound/sb_dsp.c

30 
	~"sound_cÚfig.h
"

32 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SB
)

34 
	~"sb.h
"

35 
	~"sb_mix”.h
"

36 #undeà
SB_TEST_IRQ


38 
	gsbc_ba£
 = 0;

39 
	gsbc_œq
 = 0;

49 
	gsb_d¥_ok
 = 0;

50 
	gmidi_di§bËd
 = 0;

51 
	gsb_d¥_high¥“d
 = 0;

52 
	gmajÜ
=1, 
	gmšÜ
=0;

53 
	gd¥_¡”eo
 = 0;

54 
	gd¥_cu¼’t_¥“d
 = 
DSP_DEFAULT_SPEED
;

55 
	gsb16
 = 0;

56 
	gœq_v”if›d
 = 0;

58 
	gsb_midi_mode
 = 
NORMAL_MIDI
;

59 
	gsb_midi_busy
 = 0;

60 
	gsb_d¥_busy
 = 0;

62 vŞ©
	gsb_œq_mode
 = 
IMODE_NONE
;

64 vŞ©
	gœq_ok
 = 0;

66 
	gsb_d¥_mod–
 = 1;

67 
	gsb_du¶ex_midi
 = 0;

68 
	gmy_dev
 = 0;

70 vŞ©
	gsb_šŒ_aùive
 = 0;

72 
d¥_¥“d
 ();

73 
d¥_£t_¡”eo
 (
mode
);

74 
sb_d¥_commªd
 (
v®
);

76 #ià!
defšed
(
EXCLUDE_MIDI
è|| !defšed(
EXCLUDE_AUDIO
)

81 
	$sb_d¥_commªd
 (
v®
)

83 
i
, 
lim™
;

85 
lim™
 = 
	`GET_TIME
 () + 10;

95 
i
 = 0; i < 500000 && 
	`GET_TIME
 (è< 
lim™
; i++)

97 ià((
	`INB
 (
DSP_STATUS
) & 0x80) == 0)

99 
	`OUTB
 (
v®
, 
DSP_COMMAND
);

104 
	`´štk
 ("SoundBÏ¡”: DSP Commªd(%xèTimeout.\n", 
v®
);

105 
	`´štk
 ("IRQ conflict???\n");

107 
	}
}

110 
	$sbšŒ
 (
un™
)

112 
¡©us
, 
d©a
;

114 #iâdeà
EXCLUDE_SBPRO


115 ià(
sb16
)

117 
¤c
 = 
	`sb_g‘mix”
 (
IRQ_STAT
);

119 #iâdeà
EXCLUDE_SB16


120 ià(
¤c
 & 3è
	`sb16_d¥_š‹¼u±
(
un™
);

122 #iâdeà
EXCLUDE_MIDI


123 ià(
¤c
 & 4è
	`sb16midišŒ
 (
un™
);

128 ià(!(
¤c
 & 1))

133 
¡©us
 = 
	`INB
 (
DSP_DATA_AVAIL
);

135 ià(
sb_šŒ_aùive
)

136 
sb_œq_mode
)

138 
IMODE_OUTPUT
:

139 
sb_šŒ_aùive
 = 0;

140 
	`DMAbuf_ouutšŒ
 (
my_dev
, 1);

143 
IMODE_INPUT
:

144 
sb_šŒ_aùive
 = 0;

145 
	`DMAbuf_šputšŒ
 (
my_dev
);

149 
IMODE_INIT
:

150 
sb_šŒ_aùive
 = 0;

151 
œq_ok
 = 1;

154 
IMODE_MIDI
:

155 
	`´štk
 ("+");

156 
d©a
 = 
	`INB
 (
DSP_READ
);

157 
	`´štk
 ("%x", 
d©a
);

162 
	`´štk
 ("SoundBlaster: Unexpected interrupt\n");

164 
	}
}

166 
	gsb_œq_u£couÁ
 = 0;

169 
	$sb_g‘_œq
()

171 
ok
;

173 ià(!
sb_œq_u£couÁ
)

174 ià((
ok
=
	`¢d_£t_œq_hªdËr
(
sbc_œq
, 
sbšŒ
))<0)  ok;

176 
sb_œq_u£couÁ
++;

179 
	}
}

182 
	$sb_ä“_œq
()

184 ià(!
sb_œq_u£couÁ
) ;

186 
sb_œq_u£couÁ
--;

188 ià(!
sb_œq_u£couÁ
è
	`¢d_»Ëa£_œq
(
sbc_œq
);

189 
	}
}

192 
	$sb_»£t_d¥
 ()

194 
loİc
;

196 
	`OUTB
 (1, 
DSP_RESET
);

197 
	`‹nmiüo£c
 ();

198 
	`OUTB
 (0, 
DSP_RESET
);

199 
	`‹nmiüo£c
 ();

200 
	`‹nmiüo£c
 ();

201 
	`‹nmiüo£c
 ();

203 
loİc
 = 0;†oİø< 1000 && !(
	`INB
 (
DSP_DATA_AVAIL
) & 0x80);†oopc++);

206 ià(
	`INB
 (
DSP_READ
) != 0xAA)

210 
	}
}

214 #iâdeà
EXCLUDE_AUDIO


217 
	$d¥_¥—k”
 (
¡©e
)

219 ià(
¡©e
)

220 
	`sb_d¥_commªd
 (
DSP_CMD_SPKON
);

222 
	`sb_d¥_commªd
 (
DSP_CMD_SPKOFF
);

223 
	}
}

226 
	$d¥_¥“d
 (
¥“d
)

228 
tcÚ¡
;

229 
æags
;

231 ià(
¥“d
 < 4000)

232 
¥“d
 = 4000;

234 ià(
¥“d
 > 44100)

235 
¥“d
 = 44100;

237 ià(
sb_d¥_mod–
 =ğ1 && 
¥“d
 > 22050)

238 
¥“d
 = 22050;

242 ià(
d¥_¡”eo
 && 
¥“d
 > 22050)

243 
¥“d
 = 22050;

246 ià((
¥“d
 > 22050è&& 
sb_midi_busy
)

248 
	`´štk
 ("SB Warning: High speed DSP‚ot…ossible simultaneously with MIDI output\n");

249 
¥“d
 = 22050;

252 ià(
d¥_¡”eo
)

253 
¥“d
 *= 2;

257 ià(
¥“d
 > 22050)

259 
tmp
;

261 
tcÚ¡
 = () ((65536 -

262 ((256000000+
¥“d
/2) / speed)) >> 8);

263 
sb_d¥_high¥“d
 = 1;

265 
	`DISABLE_INTR
 (
æags
);

266 ià(
	`sb_d¥_commªd
 (0x40))

267 
	`sb_d¥_commªd
 (
tcÚ¡
);

268 
	`RESTORE_INTR
 (
æags
);

270 
tmp
 = 65536 - (
tcÚ¡
 << 8);

271 
¥“d
 = (256000000+
tmp
/2) /mp;

275 
tmp
;

277 
sb_d¥_high¥“d
 = 0;

278 
tcÚ¡
 = (256 - ((1000000+
¥“d
/2) / speed)) & 0xff;

280 
	`DISABLE_INTR
 (
æags
);

281 ià(
	`sb_d¥_commªd
 (0x40))

282 
	`sb_d¥_commªd
 (
tcÚ¡
);

283 
	`RESTORE_INTR
 (
æags
);

285 
tmp
 = 256 - 
tcÚ¡
;

286 
¥“d
 = (1000000+
tmp
/2) /mp;

289 ià(
d¥_¡”eo
)

290 
¥“d
 /= 2;

292 
d¥_cu¼’t_¥“d
 = 
¥“d
;

293  
¥“d
;

294 
	}
}

297 
	$d¥_£t_¡”eo
 (
mode
)

299 
d¥_¡”eo
 = 0;

301 #ifdeà
EXCLUDE_SBPRO


304 ià(
sb_d¥_mod–
 =ğ1 || 
sb16
)

307 ià(
mode
 && 
sb_midi_busy
)

309 
	`´štk
 ("SB Warning: Stereo DSP‚ot…ossible simultaneously with MIDI output\n");

313 
d¥_¡”eo
 = !!
mode
;

314  
d¥_¡”eo
;

316 
	}
}

319 
	$sb_d¥_ouut_block
 (
dev
, 
buf
, 
couÁ
,

320 
šŒæag
, 
»¡¬t_dma
)

322 
æags
;

324 ià(!
sb_œq_mode
)

325 
	`d¥_¥—k”
 (
ON
);

327 
sb_œq_mode
 = 
IMODE_OUTPUT
;

328 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_WRITE
);

330 ià(
sound_d¥_dmachª
[
dev
] > 3)

331 
couÁ
 >>= 1;

332 
couÁ
--;

334 ià(
sb_d¥_high¥“d
)

336 
	`DISABLE_INTR
 (
æags
);

337 ià(
	`sb_d¥_commªd
 (0x48))

339 
	`sb_d¥_commªd
 (()(
couÁ
 & 0xff));

340 
	`sb_d¥_commªd
 (()((
couÁ
 >> 8) & 0xff));

341 
	`sb_d¥_commªd
 (0x91);

344 
	`´štk
 ("SB Error: Unableo start (high speed) DAC\n");

345 
	`RESTORE_INTR
 (
æags
);

349 
	`DISABLE_INTR
 (
æags
);

350 ià(
	`sb_d¥_commªd
 (0x14))

352 
	`sb_d¥_commªd
 (()(
couÁ
 & 0xff));

353 
	`sb_d¥_commªd
 (()((
couÁ
 >> 8) & 0xff));

356 
	`´štk
 ("SB Error: Unableo start DAC\n");

357 
	`RESTORE_INTR
 (
æags
);

359 
sb_šŒ_aùive
 = 1;

360 
	}
}

363 
	$sb_d¥_¡¬t_šput
 (
dev
, 
buf
, 
couÁ
, 
šŒæag
,

364 
»¡¬t_dma
)

368 
æags
;

370 ià(!
sb_œq_mode
)

371 
	`d¥_¥—k”
 (
OFF
);

373 
sb_œq_mode
 = 
IMODE_INPUT
;

374 
	`DMAbuf_¡¬t_dma
 (
dev
, 
buf
, 
couÁ
, 
DMA_MODE_READ
);

376 ià(
sound_d¥_dmachª
[
dev
] > 3)

377 
couÁ
 >>= 1;

378 
couÁ
--;

380 ià(
sb_d¥_high¥“d
)

382 
	`DISABLE_INTR
 (
æags
);

383 ià(
	`sb_d¥_commªd
 (0x48))

385 
	`sb_d¥_commªd
 (()(
couÁ
 & 0xff));

386 
	`sb_d¥_commªd
 (()((
couÁ
 >> 8) & 0xff));

387 
	`sb_d¥_commªd
 (0x99);

390 
	`´štk
 ("SB Error: Unableo start (high speed) ADC\n");

391 
	`RESTORE_INTR
 (
æags
);

395 
	`DISABLE_INTR
 (
æags
);

396 ià(
	`sb_d¥_commªd
 (0x24))

398 
	`sb_d¥_commªd
 (()(
couÁ
 & 0xff));

399 
	`sb_d¥_commªd
 (()((
couÁ
 >> 8) & 0xff));

402 
	`´štk
 ("SB Error: Unableo start ADC\n");

403 
	`RESTORE_INTR
 (
æags
);

406 
sb_šŒ_aùive
 = 1;

407 
	}
}

410 
	$d¥_ş—nup
 ()

412 
sb_šŒ_aùive
 = 0;

413 
	}
}

416 
	$sb_d¥_´•¬e_fÜ_šput
 (
dev
, 
bsize
, 
bcouÁ
)

418 
	`d¥_ş—nup
 ();

419 
	`d¥_¥—k”
 (
OFF
);

421 ià(
majÜ
 == 3)

423 ià(
d¥_¡”eo
)

424 
	`sb_d¥_commªd
(0xa8);

426 
	`sb_d¥_commªd
(0xa0);

428 
	`d¥_¥“d
 (
d¥_cu¼’t_¥“d
);

432 
	}
}

435 
	$sb_d¥_´•¬e_fÜ_ouut
 (
dev
, 
bsize
, 
bcouÁ
)

437 
	`d¥_ş—nup
 ();

438 
	`d¥_¥—k”
 (
ON
);

440 #iâdeà
EXCLUDE_SBPRO


441 ià(
majÜ
 == 3)

443 
	`sb_mix”_£t_¡”eo
(
d¥_¡”eo
);

444 
	`d¥_¥“d
 (
d¥_cu¼’t_¥“d
);

449 
	}
}

452 
	$sb_d¥_h®t_xãr
 (
dev
)

454 
	}
}

457 
	$v”ify_œq
 ()

460 
	`DEFINE_WAIT_QUEUE
(
‹¡q
, 
‹¡f
);

462 
œq_ok
 = 0;

464 ià(
	`sb_g‘_œq
 () == -1)

466 
	`´štk
 ("*** SB E¼Ü: Irq %d‡Ì—dy iÀu£\n", 
sbc_œq
);

471 
sb_œq_mode
 = 
IMODE_INIT
;

473 
	`sb_d¥_commªd
 (0xf2);

475 
	`DO_SLEEP
(
‹¡q
, 
‹¡f
, 
HZ
 / 5);

477 
	`sb_ä“_œq
();

479 ià(!
œq_ok
)

481 
	`´štk
 ("SB W¬nšg: IRQ%de¡‚Ù…as£d!", 
sbc_œq
);

482 
œq_ok
 = 1;

485 
œq_ok
 = 1;

487  
œq_ok
;

488 
	}
}

491 
	$sb_d¥_İ’
 (
dev
, 
mode
)

493 
»tv®
;

495 ià(!
sb_d¥_ok
)

497 
	`´štk
 ("SB Error: SoundBlaster board‚ot installed\n");

498  
	`RET_ERROR
 (
ENXIO
);

501 ià(
sb_šŒ_aùive
 || (
sb_midi_busy
 && 
sb_midi_mode
 =ğ
UART_MIDI
))

503 
	`´štk
 ("SB: PCM‚ot…ossible during MIDI input\n");

504  
	`RET_ERROR
 (
EBUSY
);

507 ià(!
œq_v”if›d
)

509 
	`v”ify_œq
();

510 
œq_v”if›d
 = 1;

513 ià(!
œq_ok
)

514 
	`´štk
("SB Warning: Incorrect IRQ setting %d\n",

515 
sbc_œq
);

517 
»tv®
 = 
	`sb_g‘_œq
 ();

518 ià(
»tv®
)

519  
»tv®
;

521 ià(!
	`DMAbuf_İ’_dma
 (
dev
))

523 
	`sb_ä“_œq
 ();

524 
	`´štk
 ("SB: DMA Busy\n");

525  
	`RET_ERROR
 (
EBUSY
);

528 
sb_œq_mode
 = 
IMODE_NONE
;

530 
sb_d¥_busy
 = 1;

533 
	}
}

536 
	$sb_d¥_şo£
 (
dev
)

538 
	`DMAbuf_şo£_dma
 (
dev
);

539 
	`sb_ä“_œq
 ();

540 
	`d¥_ş—nup
 ();

541 
	`d¥_¥—k”
 (
OFF
);

542 
sb_d¥_busy
 = 0;

543 
sb_d¥_high¥“d
 = 0;

544 
	}
}

547 
	$sb_d¥_ioùl
 (
dev
, 
cmd
, 
¬g
, 
loÿl
)

549 
cmd
)

551 
SOUND_PCM_WRITE_RATE
:

552 ià(
loÿl
)

553  
	`d¥_¥“d
 (
¬g
);

554  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_¥“d
 (
	`IOCTL_IN
 (arg)));

557 
SOUND_PCM_READ_RATE
:

558 ià(
loÿl
)

559  
d¥_cu¼’t_¥“d
;

560  
	`IOCTL_OUT
 (
¬g
, 
d¥_cu¼’t_¥“d
);

563 
SOUND_PCM_WRITE_CHANNELS
:

564 ià(
loÿl
)

565  
	`d¥_£t_¡”eo
 (
¬g
 - 1) + 1;

566  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_¡”eo
 (
	`IOCTL_IN
 (arg) - 1) + 1);

569 
SOUND_PCM_READ_CHANNELS
:

570 ià(
loÿl
)

571  
d¥_¡”eo
 + 1;

572  
	`IOCTL_OUT
 (
¬g
, 
d¥_¡”eo
 + 1);

575 
SNDCTL_DSP_STEREO
:

576 ià(
loÿl
)

577  
	`d¥_£t_¡”eo
 (
¬g
);

578  
	`IOCTL_OUT
 (
¬g
, 
	`d¥_£t_¡”eo
 (
	`IOCTL_IN
 (arg)));

581 
SOUND_PCM_WRITE_BITS
:

582 
SOUND_PCM_READ_BITS
:

583 ià(
loÿl
)

585  
	`IOCTL_OUT
 (
¬g
, 8);

588 
SOUND_PCM_WRITE_FILTER
:

589 
SOUND_PCM_READ_FILTER
:

590  
	`RET_ERROR
 (
EINVAL
);

594  
	`RET_ERROR
 (
EINVAL
);

597  
	`RET_ERROR
 (
EINVAL
);

598 
	}
}

601 
	$sb_d¥_»£t
 (
dev
)

603 
æags
;

605 
	`DISABLE_INTR
 (
æags
);

607 
	`sb_»£t_d¥
 ();

608 
	`d¥_ş—nup
 ();

610 
	`RESTORE_INTR
 (
æags
);

611 
	}
}

616 
	$sb_d¥_d‘eù
 (
add»ss_šfo
 *
hw_cÚfig
)

618 
sbc_ba£
 = 
hw_cÚfig
->
io_ba£
;

619 
sbc_œq
 = 
hw_cÚfig
->
œq
;

621 ià(
sb_d¥_ok
)

624 ià(!
	`sb_»£t_d¥
 ())

628 
	}
}

630 #iâdeà
EXCLUDE_AUDIO


631 
audio_İ”©iÚs
 
	gsb_d¥_İ”©iÚs
 =

634 
sb_d¥_İ’
,

635 
sb_d¥_şo£
,

636 
sb_d¥_ouut_block
,

637 
sb_d¥_¡¬t_šput
,

638 
sb_d¥_ioùl
,

639 
sb_d¥_´•¬e_fÜ_šput
,

640 
sb_d¥_´•¬e_fÜ_ouut
,

641 
sb_d¥_»£t
,

642 
sb_d¥_h®t_xãr
,

643 
NULL
,

644 
NULL


650 
	$sb_d¥_š™
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
)

652 
i
;

654 
majÜ
 = 
mšÜ
 = 0;

655 
	`sb_d¥_commªd
 (0xe1);

657 
i
 = 1000; i; i--)

659 ià(
	`INB
 (
DSP_DATA_AVAIL
) & 0x80)

661 ià(
majÜ
 == 0)

662 
majÜ
 = 
	`INB
 (
DSP_READ
);

665 
mšÜ
 = 
	`INB
 (
DSP_READ
);

671 ià(
majÜ
 == 2 || major == 3)

672 
sb_du¶ex_midi
 = 1;

674 ià(
majÜ
 == 4)

675 
sb16
 = 1;

677 ià(
majÜ
 >= 3)

678 
sb_d¥_mod–
 = 2;

680 #iâdeà
EXCLUDE_SBPRO


681 ià(
majÜ
 >= 3)

682 
	`sb_mix”_š™
(
majÜ
);

685 #iâdeà
EXCLUDE_YM3812


686 ià(
majÜ
 > 3 || (majÜ =ğ3 && 
mšÜ
 > 0))

688 
	`’abË_İl3_mode
 (
OPL3_LEFT
, 
OPL3_RIGHT
, 
OPL3_BOTH
);

692 ià(
majÜ
 >= 3)

694 #iâdeà
SCO


695 
	`¥rštf
 (
sb_d¥_İ”©iÚs
.
Çme
, "SoundBÏ¡” PrØ%d.%d", 
majÜ
, 
mšÜ
);

700 #iâdeà
SCO


701 
	`¥rštf
 (
sb_d¥_İ”©iÚs
.
Çme
, "SoundBÏ¡” %d.%d", 
majÜ
, 
mšÜ
);

705 
	`´štk
 (" <%s>", 
sb_d¥_İ”©iÚs
.
Çme
);

707 #iâdeà
EXCLUDE_AUDIO


708 #ià!
	`defšed
(
EXCLUDE_SB16
è&& !defšed(
EXCLUDE_SBPRO
)

709 ià(!
sb16
)

711 ià(
num_d¥devs
 < 
MAX_DSP_DEV
)

713 
d¥_devs
[
my_dev
 = 
num_d¥devs
++] = &
sb_d¥_İ”©iÚs
;

714 
sound_buffcouÁs
[
my_dev
] = 
DSP_BUFFCOUNT
;

715 
sound_buffsizes
[
my_dev
] = 
DSP_BUFFSIZE
;

716 
sound_d¥_dmachª
[
my_dev
] = 
hw_cÚfig
->
dma
;

717 
sound_dma_automode
[
my_dev
] = 0;

720 
	`´štk
 ("SB: Too many DSP devices‡vailable\n");

723 #iâdeà
EXCLUDE_MIDI


724 ià(!
midi_di§bËd
 && !
sb16
)

726 
	`sb_midi_š™
(
majÜ
);

729 
sb_d¥_ok
 = 1;

730  
mem_¡¬t
;

731 
	}
}

734 
	$sb_d¥_di§bË_midi
 ()

736 
midi_di§bËd
 = 1;

737 
	}
}

	@drivers/sound/sb_midi.c

30 
	~"sound_cÚfig.h
"

32 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SB
è&& !defšed(
EXCLUDE_MIDI
)

34 
	~"sb.h
"

35 #undeà
SB_TEST_IRQ


45 
sb_d¥_ok
;

47 
sb_midi_mode
;

48 
sb_midi_busy
;

49 
sb_d¥_busy
;

50 
sb_d¥_high¥“d
;

52 vŞ©
sb_œq_mode
;

54 
sb_d¥_mod–
;

55 
sb_du¶ex_midi
;

56 
sb_šŒ_aùive
;

59 
sb_midi_İ’
 (
dev
, 
mode
,

60 (*
šput
è(
dev
, 
d©a
),

61 (*
ouut
è(
dev
)

64 
»t
;

66 ià(!
sb_d¥_ok
)

68 
	`´štk
 ("SB Error: MIDI hardware‚ot installed\n");

69  
	`RET_ERROR
 (
ENXIO
);

72 ià(
mode
 !ğ
OPEN_WRITE
 && !
sb_du¶ex_midi
)

74 ià(
num_midis
 == 1)

75 
	`´štk
 ("SoundBlaster: Midi input‚ot currently supported\n");

76  
	`RET_ERROR
 (
EPERM
);

79 
sb_midi_mode
 = 
NORMAL_MIDI
;

80 ià(
mode
 !ğ
OPEN_WRITE
)

82 ià(
sb_d¥_busy
 || 
sb_šŒ_aùive
)

83  
	`RET_ERROR
 (
EBUSY
);

84 
sb_midi_mode
 = 
UART_MIDI
;

87 ià(
sb_d¥_high¥“d
)

89 
	`´štk
 ("SB Error: Midi output‚ot…ossible during stereo or high speed‡udio\n");

90  
	`RET_ERROR
 (
EBUSY
);

93 ià(
sb_midi_mode
 =ğ
UART_MIDI
)

95 
sb_œq_mode
 = 
IMODE_MIDI
;

97 
	`sb_»£t_d¥
 ();

99 ià(!
	`sb_d¥_commªd
 (0x35))

100  
	`RET_ERROR
 (
EIO
);

101 
sb_šŒ_aùive
 = 1;

103 ià((
»t
 = 
	`sb_g‘_œq
 ()) < 0)

105 
	`sb_»£t_d¥
 ();

110 
sb_midi_busy
 = 1;

113 
	}
}

116 
	$sb_midi_şo£
 (
dev
)

118 ià(
sb_midi_mode
 =ğ
UART_MIDI
)

120 
	`sb_»£t_d¥
 ();

121 
	`sb_ä“_œq
 ();

123 
sb_šŒ_aùive
 = 0;

124 
sb_midi_busy
 = 0;

125 
	}
}

128 
	$sb_midi_out
 (
dev
, 
midi_by‹
)

130 
æags
;

132 
sb_midi_busy
 = 1;

134 ià(
sb_midi_mode
 =ğ
NORMAL_MIDI
)

136 
	`DISABLE_INTR
 (
æags
);

137 ià(
	`sb_d¥_commªd
 (0x38))

138 
	`sb_d¥_commªd
 (
midi_by‹
);

140 
	`´štk
 ("SB Error: Unableo send‡ MIDI byte\n");

141 
	`RESTORE_INTR
 (
æags
);

144 
	`sb_d¥_commªd
 (
midi_by‹
);

147 
	}
}

150 
	$sb_midi_¡¬t_»ad
 (
dev
)

152 ià(
sb_midi_mode
 !ğ
UART_MIDI
)

154 
	`´štk
 ("SoundBlaster: MIDI input‚ot implemented.\n");

155  
	`RET_ERROR
 (
EPERM
);

158 
	}
}

161 
	$sb_midi_’d_»ad
 (
dev
)

163 ià(
sb_midi_mode
 =ğ
UART_MIDI
)

165 
	`sb_»£t_d¥
 ();

166 
sb_šŒ_aùive
 = 0;

169 
	}
}

172 
	$sb_midi_ioùl
 (
dev
, 
cmd
, 
¬g
)

174  
	`RET_ERROR
 (
EPERM
);

175 
	}
}

177 
midi_İ”©iÚs
 
	gsb_midi_İ”©iÚs
 =

179 {"SoundBÏ¡”", 0, 0, 
SNDCARD_SB
},

180 
sb_midi_İ’
,

181 
sb_midi_şo£
,

182 
sb_midi_ioùl
,

183 
sb_midi_out
,

184 
sb_midi_¡¬t_»ad
,

185 
sb_midi_’d_»ad
,

186 
NULL
,

187 
NULL
,

188 
NULL


192 
	$sb_midi_š™
(
mod–
)

194 
midi_devs
[
num_midis
++] = &
sb_midi_İ”©iÚs
;

195 
	}
}

	@drivers/sound/sb_mixer.c

31 
	~"sound_cÚfig.h
"

33 #ià
defšed
(
CONFIGURE_SOUNDCARD
è&& !defšed(
EXCLUDE_SB
è&& !defšed(
EXCLUDE_SBPRO
)

34 
	#__SB_MIXER_C__


	)

36 
	~"sb.h
"

37 
	~"sb_mix”.h
"

38 #undeà
SB_TEST_IRQ


40 
sbc_ba£
;

42 
	gmix”_š™Ÿlized
 = 0;

44 
	gsuµÜ‹d_»c_deviûs
;

45 
	gsuµÜ‹d_deviûs
;

46 
	g»cmask
 = 0;

47 
	gmix”_mod–
;

48 
	gmix”_ÿps
;

49 
mix”_b
 *
	giom­
;

52 
	$sb_£tmix”
 (
pÜt
, 
v®ue
)

54 
æags
;

56 
	`DISABLE_INTR
(
æags
);

57 
	`OUTB
 (()(
pÜt
 & 0xff), 
MIXER_ADDR
);

58 
	`‹nmiüo£c
 ();

59 
	`OUTB
 (()(
v®ue
 & 0xff), 
MIXER_DATA
);

60 
	`‹nmiüo£c
 ();

61 
	`RESTORE_INTR
(
æags
);

62 
	}
}

65 
	$sb_g‘mix”
 (
pÜt
)

67 
v®
;

68 
æags
;

70 
	`DISABLE_INTR
(
æags
);

71 
	`OUTB
 (()(
pÜt
 & 0xff), 
MIXER_ADDR
);

72 
	`‹nmiüo£c
 ();

73 
v®
 = 
	`INB
 (
MIXER_DATA
);

74 
	`‹nmiüo£c
 ();

75 
	`RESTORE_INTR
(
æags
);

77  
v®
;

78 
	}
}

81 
	$sb_mix”_£t_¡”eo
(
mode
)

83 ià(!
mix”_š™Ÿlized
) ;

85 
	`sb_£tmix”
 (
OUT_FILTER
, ((
	`sb_g‘mix”
 (OUT_FILTERè& ~
STEREO_DAC
)

86 | (
mode
 ? 
STEREO_DAC
 : 
MONO_DAC
)));

87 
	}
}

90 
	$d‘eù_mix”
 ()

97 
	`sb_£tmix”
 (
FM_VOL
, 0xff);

98 
	`sb_£tmix”
 (
VOC_VOL
, 0x33);

100 ià(
	`sb_g‘mix”
 (
FM_VOL
) != 0xff)

102 ià(
	`sb_g‘mix”
 (
VOC_VOL
) != 0x33)

106 
	}
}

109 
	$chªge_b™s
(*
»gv®
, 
dev
, 
chn
, 
Ãwv®
)

111 
mask
;

112 
shiá
;

114 
mask
 = (1 << (*
iom­
)[
dev
][
chn
].
nb™s
)-1;

115 
Ãwv®
 = (Òewv® * 
mask
) + 50) / 100;

117 
shiá
 = (*
iom­
)[
dev
][
chn
].
b™offs
-(*iom­)[dev][
LEFT_CHN
].
nb™s
+1;

119 *
»gv®
 &ğ~(
mask
 << 
shiá
);

120 *
»gv®
 |ğ(
Ãwv®
 & 
mask
è<< 
shiá
;

121 
	}
}

124 
	$sb_mix”_g‘
(
dev
)

126 ià(!((1<<
dev
è& 
suµÜ‹d_deviûs
))

127  
	`RET_ERROR
(
EINVAL
);

129  
Ëv–s
[
dev
];

130 
	}
}

133 
	$sb_mix”_£t
 (
dev
, 
v®ue
)

135 
Ëá
 = 
v®ue
 & 0x000000ff;

136 
right
 = (
v®ue
 & 0x0000ff00) >> 8;

138 
»goffs
;

139 
v®
;

141 ià(
Ëá
 > 100)†eft = 100;

142 ià(
right
 > 100)„ight = 100;

144 ià(
dev
 > 31è 
	`RET_ERROR
(
EINVAL
);

146 ià(!(
suµÜ‹d_deviûs
 & (1 << 
dev
)))

147  
	`RET_ERROR
(
EINVAL
);

149 
»goffs
 = (*
iom­
)[
dev
][
LEFT_CHN
].
»gno
;

151 ià(
»goffs
 == 0)

152  
	`RET_ERROR
(
EINVAL
);

154 
v®
 = 
	`sb_g‘mix”
(
»goffs
);

155 
	`chªge_b™s
(&
v®
, 
dev
, 
LEFT_CHN
, 
Ëá
);

157 
Ëv–s
[
dev
] = 
Ëá
|(left << 8);

159 ià((*
iom­
)[
dev
][
RIGHT_CHN
].
»gno
 !ğ
»goffs
)

161 
	`sb_£tmix”
(
»goffs
, 
v®
);

162 
»goffs
 = (*
iom­
)[
dev
][
RIGHT_CHN
].
»gno
;

164 ià(
»goffs
 == 0)

165  
Ëá
|(left << 8);

167 
v®
 = 
	`sb_g‘mix”
(
»goffs
);

170 
	`chªge_b™s
(&
v®
, 
dev
, 
RIGHT_CHN
, 
right
);

171 
	`sb_£tmix”
(
»goffs
, 
v®
);

173 
Ëv–s
[
dev
] = 
Ëá
 | (
right
 << 8);

174  
Ëá
 | (
right
 << 8);

175 
	}
}

178 
	$£t_»c¤c
(
¤c
)

180 
	`sb_£tmix”
(
RECORD_SRC
, (
	`sb_g‘mix”
(RECORD_SRC)&~7è| (
¤c
&0x7));

181 
	}
}

184 
	$£t_»cmask
(
mask
)

186 
devmask
, 
i
;

187 
»gimageL
, 
»gimageR
;

189 
devmask
 = 
mask
 & 
suµÜ‹d_»c_deviûs
;

191 
mix”_mod–
)

195 ià(
devmask
 !ğ
SOUND_MASK_MIC
 &&

196 
devmask
 !ğ
SOUND_MASK_LINE
 &&

197 
devmask
 !ğ
SOUND_MASK_CD
)

200 
devmask
 &ğ~
»cmask
;

203 ià(
devmask
 !ğ
SOUND_MASK_MIC
 &&

204 
devmask
 !ğ
SOUND_MASK_LINE
 &&

205 
devmask
 !ğ
SOUND_MASK_CD
)

208 
devmask
 = 
SOUND_MASK_MIC
;

212 ià(
devmask
 ^ 
»cmask
)

214 
devmask
)

217 
SOUND_MASK_MIC
:

218 
	`£t_»c¤c
 (
SRC_MIC
);

221 
SOUND_MASK_LINE
:

222 
	`£t_»c¤c
 (
SRC_LINE
);

225 
SOUND_MASK_CD
:

226 
	`£t_»c¤c
 (
SRC_CD
);

230 
	`£t_»c¤c
 (
SRC_MIC
);

237 ià(!
devmask
èdevmask = 
SOUND_MASK_MIC
;

239 
»gimageL
 = 
»gimageR
 = 0;

240 
i
=0;i<
SOUND_MIXER_NRDEVICES
;i++)

241 ià((1<<
i
è& 
devmask
)

243 
»gimageL
 |ğ
sb16_»cmasks_L
[
i
];

244 
»gimageR
 |ğ
sb16_»cmasks_R
[
i
];

246 
	`sb_£tmix”
(
SB16_IMASK_L
, 
»gimageL
);

247 
	`sb_£tmix”
(
SB16_IMASK_R
, 
»gimageR
);

251 
»cmask
 = 
devmask
;

252  
»cmask
;

253 
	}
}

256 
	$sb_mix”_ioùl
 (
dev
, 
cmd
, 
¬g
)

258 ià(((
cmd
 >> 8) & 0xff) == 'M')

260 ià(
cmd
 & 
IOC_IN
)

261 
cmd
 & 0xff)

263 
SOUND_MIXER_RECSRC
:

264  
	`IOCTL_OUT
(
¬g
, 
	`£t_»cmask
(
	`IOCTL_IN
(arg)));

268  
	`IOCTL_OUT
 (
¬g
, 
	`sb_mix”_£t
 (
cmd
 & 0xff, 
	`IOCTL_IN
 (arg)));

271 
cmd
 & 0xff)

274 
SOUND_MIXER_RECSRC
:

275  
	`IOCTL_OUT
 (
¬g
, 
»cmask
);

278 
SOUND_MIXER_DEVMASK
:

279  
	`IOCTL_OUT
 (
¬g
, 
suµÜ‹d_deviûs
);

282 
SOUND_MIXER_STEREODEVS
:

283  
	`IOCTL_OUT
 (
¬g
, 
suµÜ‹d_deviûs
 &

284 ~(
SOUND_MASK_MIC
|
SOUND_MASK_SPEAKER
));

287 
SOUND_MIXER_RECMASK
:

288  
	`IOCTL_OUT
 (
¬g
, 
suµÜ‹d_»c_deviûs
);

291 
SOUND_MIXER_CAPS
:

292  
	`IOCTL_OUT
 (
¬g
, 
mix”_ÿps
);

296  
	`IOCTL_OUT
 (
¬g
, 
	`sb_mix”_g‘
 (
cmd
 & 0xff));

300  
	`RET_ERROR
 (
EINVAL
);

301 
	}
}

303 
mix”_İ”©iÚs
 
	gsb_mix”_İ”©iÚs
 =

305 
sb_mix”_ioùl


309 
	$sb_mix”_»£t
()

311 
i
;

313 
i
 = 0; i < 
SOUND_MIXER_NRDEVICES
; i++)

314 
	`sb_mix”_£t
 (
i
, 
Ëv–s
[i]);

315 
	`£t_»cmask
(
SOUND_MASK_MIC
);

316 
	}
}

319 
	$sb_mix”_š™
(
majÜ_mod–
)

321 
	`sb_£tmix”
(0x00, 0);

323 ià(!
	`d‘eù_mix”
()) ;

325 
mix”_š™Ÿlized
 = 1;

326 
mix”_mod–
 = 
majÜ_mod–
;

328 
majÜ_mod–
)

331 
mix”_ÿps
 = 
SOUND_CAP_EXCL_INPUT
;

332 
suµÜ‹d_deviûs
 = 
SBPRO_MIXER_DEVICES
;

333 
suµÜ‹d_»c_deviûs
 = 
SBPRO_RECORDING_DEVICES
;

334 
iom­
 = &
sb´o_mix
;

338 
mix”_ÿps
 = 0;

339 
suµÜ‹d_deviûs
 = 
SB16_MIXER_DEVICES
;

340 
suµÜ‹d_»c_deviûs
 = 
SB16_RECORDING_DEVICES
;

341 
iom­
 = &
sb16_mix
;

345 
	`´štk
("SB Warning: Unsupported mixerype\n");

349 
mix”_devs
[
num_mix”s
++] = &
sb_mix”_İ”©iÚs
;

350 
	`sb_mix”_»£t
();

351 
	}
}

	@drivers/sound/sb_mixer.h

29 
	#SBPRO_RECORDING_DEVICES
 (
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | 
SOUND_MASK_CD
)

	)

31 
	#SBPRO_MIXER_DEVICES
 (
SOUND_MASK_SYNTH
 | 
SOUND_MASK_PCM
 | 
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | \

32 
SOUND_MASK_CD
 | 
SOUND_MASK_VOLUME
)

	)

34 
	#SB16_RECORDING_DEVICES
 (
SOUND_MASK_SYNTH
 | 
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | \

35 
SOUND_MASK_CD
)

	)

37 
	#SB16_MIXER_DEVICES
 (
SOUND_MASK_SYNTH
 | 
SOUND_MASK_PCM
 | 
SOUND_MASK_SPEAKER
 | 
SOUND_MASK_LINE
 | 
SOUND_MASK_MIC
 | \

38 
SOUND_MASK_CD
 | 
SOUND_MASK_RECLEV
 | \

39 
SOUND_MASK_VOLUME
 | 
SOUND_MASK_BASS
 | 
SOUND_MASK_TREBLE
)

	)

50 
	#VOC_VOL
 0x04

	)

51 
	#MIC_VOL
 0x0A

	)

52 
	#MIC_MIX
 0x0A

	)

53 
	#RECORD_SRC
 0x0C

	)

54 
	#IN_FILTER
 0x0C

	)

55 
	#OUT_FILTER
 0x0E

	)

56 
	#MASTER_VOL
 0x22

	)

57 
	#FM_VOL
 0x26

	)

58 
	#CD_VOL
 0x28

	)

59 
	#LINE_VOL
 0x2E

	)

60 
	#IRQ_NR
 0x80

	)

61 
	#DMA_NR
 0x81

	)

62 
	#IRQ_STAT
 0x82

	)

63 
	#OPSW
 0x3c

	)

65 
	#FREQ_HI
 (1 << 3)

	)

66 
	#FREQ_LOW
 0

	)

67 
	#FILT_ON
 0

	)

68 
	#FILT_OFF
 (1 << 5)

	)

70 
	#MONO_DAC
 0x00

	)

71 
	#STEREO_DAC
 0x02

	)

76 
	#SB16_IMASK_L
 0x3d

	)

77 
	#SB16_IMASK_R
 0x3e

	)

79 
	#LEFT_CHN
 0

	)

80 
	#RIGHT_CHN
 1

	)

82 
	smix”_def
 {

83 
	m»gno
: 8;

84 
	mb™offs
:4;

85 
	mnb™s
:4;

89 
mix”_def
 
	tmix”_b
[32][2];

90 
mix”_def
 
	tmix”_’t
;

92 
	#MIX_ENT
(
Çme
, 
»g_l
, 
b™_l
, 
Ën_l
, 
»g_r
, 
b™_r
, 
Ën_r
) \

93 {{
»g_l
, 
b™_l
, 
Ën_l
}, {
»g_r
, 
b™_r
, 
Ën_r
}}

	)

95 #ifdeà
__SB_MIXER_C__


96 
mix”_b
 
	gsb´o_mix
 = {

97 
MIX_ENT
(
SOUND_MIXER_VOLUME
, 0x22, 7, 4, 0x22, 3, 4),

98 
MIX_ENT
(
SOUND_MIXER_BASS
, 0x00, 0, 0, 0x00, 0, 0),

99 
MIX_ENT
(
SOUND_MIXER_TREBLE
, 0x00, 0, 0, 0x00, 0, 0),

100 
MIX_ENT
(
SOUND_MIXER_SYNTH
, 0x26, 7, 4, 0x26, 3, 4),

101 
MIX_ENT
(
SOUND_MIXER_PCM
, 0x04, 7, 4, 0x04, 3, 4),

102 
MIX_ENT
(
SOUND_MIXER_SPEAKER
, 0x00, 0, 0, 0x00, 0, 0),

103 
MIX_ENT
(
SOUND_MIXER_LINE
, 0x2e, 7, 4, 0x2e, 3, 4),

104 
MIX_ENT
(
SOUND_MIXER_MIC
, 0x0a, 2, 3, 0x00, 0, 0),

105 
MIX_ENT
(
SOUND_MIXER_CD
, 0x28, 7, 4, 0x28, 3, 4),

106 
MIX_ENT
(
SOUND_MIXER_IMIX
, 0x00, 0, 0, 0x00, 0, 0),

107 
MIX_ENT
(
SOUND_MIXER_ALTPCM
, 0x00, 0, 0, 0x00, 0, 0),

108 
MIX_ENT
(
SOUND_MIXER_RECLEV
, 0x00, 0, 0, 0x00, 0, 0)

111 
mix”_b
 
	gsb16_mix
 = {

112 
MIX_ENT
(
SOUND_MIXER_VOLUME
, 0x30, 7, 5, 0x31, 7, 5),

113 
MIX_ENT
(
SOUND_MIXER_BASS
, 0x46, 7, 4, 0x47, 7, 4),

114 
MIX_ENT
(
SOUND_MIXER_TREBLE
, 0x44, 7, 4, 0x45, 7, 4),

115 
MIX_ENT
(
SOUND_MIXER_SYNTH
, 0x34, 7, 5, 0x35, 7, 5),

116 
MIX_ENT
(
SOUND_MIXER_PCM
, 0x32, 7, 5, 0x33, 7, 5),

117 
MIX_ENT
(
SOUND_MIXER_SPEAKER
, 0x3b, 7, 2, 0x00, 0, 0),

118 
MIX_ENT
(
SOUND_MIXER_LINE
, 0x38, 7, 5, 0x39, 7, 5),

119 
MIX_ENT
(
SOUND_MIXER_MIC
, 0x3a, 7, 5, 0x00, 0, 0),

120 
MIX_ENT
(
SOUND_MIXER_CD
, 0x36, 7, 5, 0x37, 7, 5),

121 
MIX_ENT
(
SOUND_MIXER_IMIX
, 0x00, 0, 0, 0x00, 0, 0),

122 
MIX_ENT
(
SOUND_MIXER_ALTPCM
, 0x00, 0, 0, 0x00, 0, 0),

123 
MIX_ENT
(
SOUND_MIXER_RECLEV
, 0x3f, 7, 2, 0x40, 7, 2)

126 
	gËv–s
[
SOUND_MIXER_NRDEVICES
] =

141 
	gsb16_»cmasks_L
[
SOUND_MIXER_NRDEVICES
] =

157 
	gsb16_»cmasks_R
[
SOUND_MIXER_NRDEVICES
] =

	@drivers/sound/sequencer.c

30 
	#SEQUENCER_C


	)

31 
	~"sound_cÚfig.h
"

33 #ifdeà
CONFIGURE_SOUNDCARD


35 #iâdeà
EXCLUDE_SEQUENCER


37 
	g£qu’ûr_ok
 = 0;

39 
DEFINE_WAIT_QUEUE
 (
£q_¦“³r
, 
£q_¦“p_æag
);

41 
	#midi_¦“³r
 
£q_¦“³r


	)

42 
	#midi_¦“p_æag
 
£q_¦“p_æag


	)

44 
	gmidi_İ’ed
[
MAX_MIDI_DEV
] =

46 
	gmidi_wr™‹n
[
MAX_MIDI_DEV
] =

49 
	g£q_time
 = 0;

51 
	~"tunšg.h
"

53 
	#EV_SZ
 8

	)

54 
	#IEV_SZ
 4

	)

55 *
	gqueue
 = 
NULL
;

56 *
	giqueue
 = 
NULL
;

58 vŞ©
	gqh—d
 = 0, 
	gq
 = 0, 
	gqËn
 = 0;

59 vŞ©
	giqh—d
 = 0, 
	giq
 = 0, 
	giqËn
 = 0;

60 vŞ©
	g£q_¶ayšg
 = 0;

61 
	g£qu’ûr_busy
 = 0;

62 
	gouut_ŒeshŞd
;

63 
	gsyÁh_İ’_mask
;

65 
£q_queue
 (*
nÙe
);

66 
£q_¡¬Ïy
 ();

67 
£q_sync
 ();

68 
£q_»£t
 ();

69 
	gpmgr_´e£Á
[
MAX_SYNTH_DEV
] =

72 #ià
MAX_SYNTH_DEV
 > 15

73 #”rÜ 
Too
 
mªy
 
syÁhesiz”
 
deviûs


77 
	$£qu’ûr_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

79 
c
 = 
couÁ
, 
p
 = 0;

81 
dev
 = dev >> 4;

83 ià(
dev
)

84  
	`pmgr_»ad
 (
dev
 - 1, 
fe
, 
buf
, 
couÁ
);

86 
c
 > 3)

88 ià(!
iqËn
)

90 
	`DO_SLEEP
 (
midi_¦“³r
, 
midi_¦“p_æag
, 0);

92 ià(!
iqËn
)

93  
couÁ
 - 
c
;

96 
	`COPY_TO_USER
 (
buf
, 
p
, &
iqueue
[
iqh—d
 * 
IEV_SZ
], IEV_SZ);

97 
p
 += 4;

98 
c
 -= 4;

100 
iqh—d
 = (iqh—d + 1è% 
SEQ_MAX_QUEUE
;

101 
iqËn
--;

104  
couÁ
 - 
c
;

105 
	}
}

108 
	$£qu’ûr_midi_ouut
 (
dev
)

111 
	}
}

114 
	$cİy_to_šput
 (*
ev’t
)

116 
æags
;

118 ià(
iqËn
 >ğ(
SEQ_MAX_QUEUE
 - 1))

121 
	`memıy
 (&
iqueue
[
iq
 * 
IEV_SZ
], 
ev’t
, IEV_SZ);

122 
iqËn
++;

123 
iq
 = (iq + 1è% 
SEQ_MAX_QUEUE
;

125 
	`DISABLE_INTR
 (
æags
);

126 ià(
	`SOMEONE_WAITING
 (
midi_¦“³r
, 
midi_¦“p_æag
))

128 
	`WAKE_UP
 (
midi_¦“³r
, 
midi_¦“p_æag
);

130 
	`RESTORE_INTR
 (
æags
);

131 
	}
}

134 
	$£qu’ûr_midi_šput
 (
dev
, 
d©a
)

136 
t¡amp
;

137 
ev’t
[4];

139 ià(
d©a
 == 0xfe)

142 
t¡amp
 = 
	`GET_TIME
 (è- 
£q_time
;

143 
t¡amp
 = (t¡am°<< 8è| 
SEQ_WAIT
;

145 
	`cİy_to_šput
 ((*è&
t¡amp
);

147 
ev’t
[0] = 
SEQ_MIDIPUTC
;

148 
ev’t
[1] = 
d©a
;

149 
ev’t
[2] = 
dev
;

150 
ev’t
[3] = 0;

152 
	`cİy_to_šput
 (
ev’t
);

153 
	}
}

156 
	$£qu’ûr_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

158 
ev’t
[
EV_SZ
], 
ev_code
;

159 
p
 = 0, 
c
, 
ev_size
;

160 
”r
;

161 
mode
 = 
fe
->mod& 
O_ACCMODE
;

163 
dev
 = dev >> 4;

165 
	`DEB
 (
	`´štk
 ("£qu’ûr_wr™e(dev=%d, couÁ=%d)\n", 
dev
, 
couÁ
));

167 ià(
mode
 =ğ
OPEN_READ
)

168  
	`RET_ERROR
 (
EIO
);

170 ià(
dev
)

171  
	`pmgr_wr™e
 (
dev
 - 1, 
fe
, 
buf
, 
couÁ
);

173 
c
 = 
couÁ
;

175 
c
 >= 4)

177 
	`COPY_FROM_USER
 (
ev’t
, 
buf
, 
p
, 4);

178 
ev_code
 = 
ev’t
[0];

180 ià(
ev_code
 =ğ
SEQ_FULLSIZE
)

182 
”r
;

184 
dev
 = *(*è&
ev’t
[2];

185 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

186  
	`RET_ERROR
 (
ENXIO
);

188 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)))

189  
	`RET_ERROR
 (
ENXIO
);

191 
”r
 = 
syÁh_devs
[
dev
]->
	`lßd_·tch
 (dev, *(*è&
ev’t
[0], 
buf
, 
p
 + 4, 
c
, 0);

192 ià(
”r
 < 0)

193  
”r
;

195  
”r
;

198 ià(
ev_code
 =ğ
SEQ_EXTENDED
 ||ƒv_cod=ğ
SEQ_PRIVATE
)

201 
ev_size
 = 8;

203 ià(
c
 < 
ev_size
)

205 ià(!
£q_¶ayšg
)

206 
	`£q_¡¬Ïy
 ();

207  
couÁ
 - 
c
;

210 
	`COPY_FROM_USER
 (&
ev’t
[4], 
buf
, 
p
 + 4, 4);

214 
ev_size
 = 4;

216 ià(
ev’t
[0] =ğ
SEQ_MIDIPUTC
)

219 ià(!
midi_İ’ed
[
ev’t
[2]])

221 
mode
;

222 
dev
 = 
ev’t
[2];

224 ià(
dev
 >ğ
num_midis
)

226 
	`´štk
 ("Sequ’û¸E¼Ü: NÚexi¡’ˆMIDI deviû %d\n", 
dev
);

227  
	`RET_ERROR
 (
ENXIO
);

230 
mode
 = 
fe
->mod& 
O_ACCMODE
;

232 ià((
”r
 = 
midi_devs
[
dev
]->
	`İ’
 (dev, 
mode
,

233 
£qu’ûr_midi_šput
, 
£qu’ûr_midi_ouut
)) < 0)

235 
	`£q_»£t
 ();

236 
	`´štk
 ("Sequ’û¸E¼Ü: UÇbËØİ’ Mid˜#%d\n", 
dev
);

237  
”r
;

240 
midi_İ’ed
[
dev
] = 1;

245 ià(!
	`£q_queue
 (
ev’t
))

248 ià(!
£q_¶ayšg
)

249 
	`£q_¡¬Ïy
 ();

250  
couÁ
 - 
c
;

253 
p
 +ğ
ev_size
;

254 
c
 -ğ
ev_size
;

257 ià(!
£q_¶ayšg
)

258 
	`£q_¡¬Ïy
 ();

260  
couÁ
;

261 
	}
}

264 
	$£q_queue
 (*
nÙe
)

269 ià(
qËn
 >ğ
SEQ_MAX_QUEUE
)

270 ià(!
£q_¶ayšg
)

271 
	`£q_¡¬Ïy
 ();

273 ià(
qËn
 >ğ
SEQ_MAX_QUEUE
 && !
	`SOMEONE_WAITING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

276 
	`DO_SLEEP
 (
£q_¦“³r
, 
£q_¦“p_æag
, 0);

279 ià(
qËn
 >ğ
SEQ_MAX_QUEUE
)

282 
	`memıy
 (&
queue
[
q
 * 
EV_SZ
], 
nÙe
, EV_SZ);

284 
q
 = (q + 1è% 
SEQ_MAX_QUEUE
;

285 
qËn
++;

288 
	}
}

291 
	$ex‹nded_ev’t
 (*
q
)

293 
dev
 = 
q
[2];

295 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

296  
	`RET_ERROR
 (
ENXIO
);

298 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)))

299  
	`RET_ERROR
 (
ENXIO
);

301 
q
[1])

303 
SEQ_NOTEOFF
:

304 
syÁh_devs
[
dev
]->
	`kl_nÙe
 (dev, 
q
[3], q[5]);

307 
SEQ_NOTEON
:

308 ià(
q
[4] > 127 && q[4] != 255)

311 
syÁh_devs
[
dev
]->
	`¡¬t_nÙe
 (dev, 
q
[3], q[4], q[5]);

314 
SEQ_PGMCHANGE
:

315 
syÁh_devs
[
dev
]->
	`£t_š¡r
 (dev, 
q
[3], q[4]);

318 
SEQ_AFTERTOUCH
:

319 
syÁh_devs
[
dev
]->
	`aá”touch
 (dev, 
q
[3], q[4]);

322 
SEQ_BALANCE
:

323 
syÁh_devs
[
dev
]->
	`·Âšg
 (dev, 
q
[3], () q[4]);

326 
SEQ_CONTROLLER
:

327 
syÁh_devs
[
dev
]->
	`cÚŒŞËr
 (dev, 
q
[3], q[4], *(*) &q[5]);

331  
	`RET_ERROR
 (
EINVAL
);

335 
	}
}

338 
	$£q_¡¬Ïy
 ()

340 
this_Úe
;

341 *
d–ay
;

342 *
q
;

344 
qËn
 > 0)

346 
qh—d
 = ((
this_Úe
 = qh—dè+ 1è% 
SEQ_MAX_QUEUE
;

347 
qËn
--;

349 
q
 = &
queue
[
this_Úe
*
EV_SZ
];

351 
q
[0])

353 
SEQ_NOTEOFF
:

354 ià(
syÁh_İ’_mask
 & (1 << 0))

355 ià(
syÁh_devs
[0])

356 
syÁh_devs
[0]->
	`kl_nÙe
 (0, 
q
[1], q[3]);

359 
SEQ_NOTEON
:

360 ià(
q
[4] < 128 || q[4] == 255)

361 ià(
syÁh_İ’_mask
 & (1 << 0))

362 ià(
syÁh_devs
[0])

363 
syÁh_devs
[0]->
	`¡¬t_nÙe
 (0, 
q
[1], q[2], q[3]);

366 
SEQ_WAIT
:

367 
d–ay
 = (*è
q
;

369 *
d–ay
 = (*delay >> 8) & 0xffffff;

371 ià(*
d–ay
 > 0)

373 
time
;

375 
£q_¶ayšg
 = 1;

376 
time
 = *
d–ay
;

378 
	`»que¡_sound_tim”
 (
time
);

380 ià((
SEQ_MAX_QUEUE
 - 
qËn
è>ğ
ouut_ŒeshŞd
)

382 
æags
;

384 
	`DISABLE_INTR
 (
æags
);

385 ià(
	`SOMEONE_WAITING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

387 
	`WAKE_UP
 (
£q_¦“³r
, 
£q_¦“p_æag
);

389 
	`RESTORE_INTR
 (
æags
);

396 
SEQ_PGMCHANGE
:

397 ià(
syÁh_İ’_mask
 & (1 << 0))

398 ià(
syÁh_devs
[0])

399 
syÁh_devs
[0]->
	`£t_š¡r
 (0, 
q
[1], q[2]);

402 
SEQ_SYNCTIMER
:

403 
£q_time
 = 
	`GET_TIME
 ();

406 
SEQ_MIDIPUTC
:

407 ià(
midi_İ’ed
[
q
[2]])

409 
dev
;

411 
dev
 = 
q
[2];

413 ià(!
midi_devs
[
dev
]->
	`putc
 (dev, 
q
[1]))

419 
qËn
++;

420 
qh—d
 = 
this_Úe
;

421 
£q_¶ayšg
 = 1;

422 
	`»que¡_sound_tim”
 (-1);

426 
midi_wr™‹n
[
dev
] = 1;

430 
SEQ_ECHO
:

431 
	`cİy_to_šput
 (
q
);

434 
SEQ_PRIVATE
:

435 ià(
q
[1] < 
num_syÁhs
)

436 
syÁh_devs
[
q
[1]]->
	`hw_cÚŒŞ
 (q[1], q);

439 
SEQ_EXTENDED
:

440 
	`ex‹nded_ev’t
 (
q
);

448 
£q_¶ayšg
 = 0;

450 ià((
SEQ_MAX_QUEUE
 - 
qËn
è>ğ
ouut_ŒeshŞd
)

452 
æags
;

454 
	`DISABLE_INTR
 (
æags
);

455 ià(
	`SOMEONE_WAITING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

457 
	`WAKE_UP
 (
£q_¦“³r
, 
£q_¦“p_æag
);

459 
	`RESTORE_INTR
 (
æags
);

462 
	}
}

465 
	$£qu’ûr_İ’
 (
dev
, 
fešfo
 *
fe
)

467 
»tv®
, 
mode
, 
i
;

469 
dev
 = dev >> 4;

470 
mode
 = 
fe
->mod& 
O_ACCMODE
;

472 
	`DEB
 (
	`´štk
 ("£qu’ûr_İ’(dev=%d)\n", 
dev
));

474 ià(!
£qu’ûr_ok
)

476 
	`´štk
 ("Soundcard: Sequencer‚ot initialized\n");

477  
	`RET_ERROR
 (
ENXIO
);

480 ià(
dev
)

482 
”r
;

484 
dev
--;

485 ià(
pmgr_´e£Á
[
dev
])

486  
	`RET_ERROR
 (
EBUSY
);

487 ià((
”r
 = 
	`pmgr_İ’
 (
dev
)) < 0)

488  
”r
;

490 
pmgr_´e£Á
[
dev
] = 1;

491  
”r
;

494 ià(
£qu’ûr_busy
)

496 
	`´štk
 ("Sequencer busy\n");

497  
	`RET_ERROR
 (
EBUSY
);

500 ià(!(
num_syÁhs
 + 
num_midis
))

501  
	`RET_ERROR
 (
ENXIO
);

503 
syÁh_İ’_mask
 = 0;

505 ià(
mode
 =ğ
OPEN_WRITE
 || mod=ğ
OPEN_READWRITE
)

506 
i
 = 0; i < 
num_syÁhs
; i++)

507 ià(
syÁh_devs
[
i
]->
	`İ’
 (i, 
mode
) < 0)

508 
	`´štk
 ("Sequ’ûr: W¬nšg! CªnÙ o³ÀsyÁh deviû #%d\n", 
i
);

510 
syÁh_İ’_mask
 |ğ(1 << 
i
);

512 
£q_time
 = 
	`GET_TIME
 ();

514 
i
 = 0; i < 
num_midis
; i++)

516 
midi_İ’ed
[
i
] = 0;

517 
midi_wr™‹n
[
i
] = 0;

520 ià(
mode
 =ğ
OPEN_READ
 || mod=ğ
OPEN_READWRITE
)

522 ià(!
num_midis
)

524 
	`´štk
 ("Sequencer: No Midi devices. Input‚ot…ossible\n");

525  
	`RET_ERROR
 (
ENXIO
);

528 
i
 = 0; i < 
num_midis
; i++)

530 ià((
»tv®
 = 
midi_devs
[
i
]->
	`İ’
 (i, 
mode
,

531 
£qu’ûr_midi_šput
, 
£qu’ûr_midi_ouut
)) >= 0)

532 
midi_İ’ed
[
i
] = 1;

536 
£qu’ûr_busy
 = 1;

537 
	`RESET_WAIT_QUEUE
 (
£q_¦“³r
, 
£q_¦“p_æag
);

538 
	`RESET_WAIT_QUEUE
 (
midi_¦“³r
, 
midi_¦“p_æag
);

539 
ouut_ŒeshŞd
 = 
SEQ_MAX_QUEUE
 / 2;

541 
i
 = 0; i < 
num_syÁhs
; i++)

542 ià(
pmgr_´e£Á
[
i
])

543 
	`pmgr_šfÜm
 (
i
, 
PM_E_OPENED
, 0, 0, 0, 0);

546 
	}
}

549 
	$£q_d¿š_midi_queues
 ()

551 
i
, 
n
;

557 
n
 = 1;

559 !
	`PROCESS_ABORTING
 (
midi_¦“³r
, 
midi_¦“p_æag
è&& 
n
)

561 
n
 = 0;

563 
i
 = 0; i < 
num_midis
; i++)

564 ià(
midi_İ’ed
[
i
] && 
midi_wr™‹n
[i])

565 ià(
midi_devs
[
i
]->
bufãr_¡©us
 !ğ
NULL
)

566 ià(
midi_devs
[
i
]->
	`bufãr_¡©us
 (i))

567 
n
++;

572 ià(
n
)

574 
	`DO_SLEEP
 (
£q_¦“³r
, 
£q_¦“p_æag
, 
HZ
 / 10);

577 
	}
}

580 
	$£qu’ûr_»Ëa£
 (
dev
, 
fešfo
 *
fe
)

582 
i
;

583 
mode
 = 
fe
->mod& 
O_ACCMODE
;

585 
dev
 = dev >> 4;

587 
	`DEB
 (
	`´štk
 ("£qu’ûr_»Ëa£(dev=%d)\n", 
dev
));

589 ià(
dev
)

591 
dev
--;

592 
	`pmgr_»Ëa£
 (
dev
);

593 
pmgr_´e£Á
[
dev
] = 0;

601 !
	`PROCESS_ABORTING
 (
£q_¦“³r
, 
£q_¦“p_æag
è&& 
qËn
)

603 
	`£q_sync
 ();

606 ià(
mode
 !ğ
OPEN_READ
)

607 
	`£q_d¿š_midi_queues
 ();

608 
	`£q_»£t
 ();

609 ià(
mode
 !ğ
OPEN_READ
)

610 
	`£q_d¿š_midi_queues
 ();

612 
i
 = 0; i < 
num_midis
; i++)

613 ià(
midi_İ’ed
[
i
])

614 
midi_devs
[
i
]->
	`şo£
 (i);

616 ià(
mode
 =ğ
OPEN_WRITE
 || mod=ğ
OPEN_READWRITE
)

617 
i
 = 0; i < 
num_syÁhs
; i++)

618 ià(
syÁh_İ’_mask
 & (1 << 
i
))

619 ià(
syÁh_devs
[
i
])

620 
syÁh_devs
[
i
]->
	`şo£
 (i);

622 
i
 = 0; i < 
num_syÁhs
; i++)

623 ià(
pmgr_´e£Á
[
i
])

624 
	`pmgr_šfÜm
 (
i
, 
PM_E_CLOSED
, 0, 0, 0, 0);

626 
£qu’ûr_busy
 = 0;

627 
	}
}

630 
	$£q_sync
 ()

632 ià(
qËn
 && !
£q_¶ayšg
 && !
	`PROCESS_ABORTING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

633 
	`£q_¡¬Ïy
 ();

635 ià(
qËn
 && !
	`SOMEONE_WAITING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

637 
	`DO_SLEEP
 (
£q_¦“³r
, 
£q_¦“p_æag
, 0);

640  
qËn
;

641 
	}
}

644 
	$midi_outc
 (
dev
, 
d©a
)

650 
n
;

656 
n
 = 300;

658 
n
 && !
midi_devs
[
dev
]->
	`putc
 (dev, 
d©a
))

660 
	`DO_SLEEP
 (
£q_¦“³r
, 
£q_¦“p_æag
, 4);

661 
n
--;

663 
	}
}

666 
	$£q_»£t
 ()

672 
i
, 
chn
;

674 
	`sound_¡İ_tim”
 ();

676 
qËn
 = 
qh—d
 = 
q
 = 0;

677 
iqËn
 = 
iqh—d
 = 
iq
 = 0;

679 
i
 = 0; i < 
num_syÁhs
; i++)

680 ià(
syÁh_İ’_mask
 & (1 << 
i
))

681 ià(
syÁh_devs
[
i
])

682 
syÁh_devs
[
i
]->
	`»£t
 (i);

684 
i
 = 0; i < 
num_midis
; i++)

685 ià(
midi_wr™‹n
[
i
])

687 
chn
 = 0; chn < 16; chn++)

689 
	`midi_outc
 (
i
,

690 ()(0xb0 + (
chn
 & 0xff)));

691 
	`midi_outc
 (
i
, 0x7b);

692 
	`midi_outc
 (
i
, 0);

695 
midi_devs
[
i
]->
	`şo£
 (i);

697 
midi_wr™‹n
[
i
] = 0;

698 
midi_İ’ed
[
i
] = 0;

701 
£q_¶ayšg
 = 0;

703 ià(
	`SOMEONE_WAITING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

704 
	`´štk
 ("Sequencer Warning: Unexpected sleeping…rocess\n");

706 
	}
}

709 
	$£qu’ûr_ioùl
 (
dev
, 
fešfo
 *
fe
,

710 
cmd
, 
¬g
)

712 
midi_dev
, 
Üig_dev
;

713 
mode
 = 
fe
->mod& 
O_ACCMODE
;

715 
Üig_dev
 = 
dev
 = dev >> 4;

717 
cmd
)

720 
SNDCTL_SEQ_SYNC
:

721 ià(
dev
)

722  
	`RET_ERROR
 (
EIO
);

724 ià(
mode
 =ğ
OPEN_READ
)

726 
qËn
 && !
	`PROCESS_ABORTING
 (
£q_¦“³r
, 
£q_¦“p_æag
))

727 
	`£q_sync
 ();

731 
SNDCTL_SEQ_RESET
:

732 ià(
dev
)

733  
	`RET_ERROR
 (
EIO
);

735 
	`£q_»£t
 ();

739 
SNDCTL_SEQ_TESTMIDI
:

740 ià(
dev
)

741  
	`RET_ERROR
 (
EIO
);

743 
midi_dev
 = 
	`IOCTL_IN
 (
¬g
);

744 ià(
midi_dev
 >ğ
num_midis
)

745  
	`RET_ERROR
 (
ENXIO
);

747 ià(!
midi_İ’ed
[
midi_dev
])

749 
”r
, 
mode
;

751 
mode
 = 
fe
->mod& 
O_ACCMODE
;

752 ià((
”r
 = 
midi_devs
[
midi_dev
]->
	`İ’
 (midi_dev, 
mode
,

753 
£qu’ûr_midi_šput
,

754 
£qu’ûr_midi_ouut
)) < 0)

755  
”r
;

758 
midi_İ’ed
[
midi_dev
] = 1;

763 
SNDCTL_SEQ_GETINCOUNT
:

764 ià(
dev
)

765  
	`RET_ERROR
 (
EIO
);

767 ià(
mode
 =ğ
OPEN_WRITE
)

769  
	`IOCTL_OUT
 (
¬g
, 
iqËn
);

772 
SNDCTL_SEQ_GETOUTCOUNT
:

774 ià(
mode
 =ğ
OPEN_READ
)

776  
	`IOCTL_OUT
 (
¬g
, 
SEQ_MAX_QUEUE
 - 
qËn
);

779 
SNDCTL_SEQ_CTRLRATE
:

780 ià(
dev
)

781  
	`RET_ERROR
 (
EIO
);

784  
	`IOCTL_OUT
 (
¬g
, 
HZ
);

787 
SNDCTL_SEQ_RESETSAMPLES
:

788 
dev
 = 
	`IOCTL_IN
 (
¬g
);

789 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

790  
	`RET_ERROR
 (
ENXIO
);

792 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)è&& !
Üig_dev
)

793  
	`RET_ERROR
 (
EBUSY
);

795 ià(!
Üig_dev
 && 
pmgr_´e£Á
[
dev
])

796 
	`pmgr_šfÜm
 (
dev
, 
PM_E_PATCH_RESET
, 0, 0, 0, 0);

798  
syÁh_devs
[
dev
]->
	`ioùl
 (dev, 
cmd
, 
¬g
);

801 
SNDCTL_SEQ_NRSYNTHS
:

802  
	`IOCTL_OUT
 (
¬g
, 
num_syÁhs
);

805 
SNDCTL_SEQ_NRMIDIS
:

806  
	`IOCTL_OUT
 (
¬g
, 
num_midis
);

809 
SNDCTL_SYNTH_MEMAVL
:

811 
dev
 = 
	`IOCTL_IN
 (
¬g
);

813 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

814  
	`RET_ERROR
 (
ENXIO
);

816 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)è&& !
Üig_dev
)

817  
	`RET_ERROR
 (
EBUSY
);

819  
	`IOCTL_OUT
 (
¬g
, 
syÁh_devs
[
dev
]->
	`ioùl
 (dev, 
cmd
,‡rg));

823 
SNDCTL_FM_4OP_ENABLE
:

825 
dev
 = 
	`IOCTL_IN
 (
¬g
);

827 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

828  
	`RET_ERROR
 (
ENXIO
);

830 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)))

831  
	`RET_ERROR
 (
ENXIO
);

833 
syÁh_devs
[
dev
]->
	`ioùl
 (dev, 
cmd
, 
¬g
);

838 
SNDCTL_SYNTH_INFO
:

840 
syÁh_šfo
 
šf
;

841 
dev
;

843 
	`IOCTL_FROM_USER
 ((*è&
šf
, (*è
¬g
, 0,  (inf));

844 
dev
 = 
šf
.
deviû
;

846 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

847  
	`RET_ERROR
 (
ENXIO
);

849 ià(!(
syÁh_İ’_mask
 & (1 << 
dev
)è&& !
Üig_dev
)

850  
	`RET_ERROR
 (
EBUSY
);

852  
syÁh_devs
[
dev
]->
	`ioùl
 (dev, 
cmd
, 
¬g
);

856 
SNDCTL_MIDI_INFO
:

858 
midi_šfo
 
šf
;

859 
dev
;

861 
	`IOCTL_FROM_USER
 ((*è&
šf
, (*è
¬g
, 0,  (inf));

862 
dev
 = 
šf
.
deviû
;

864 ià(
dev
 < 0 || dev >ğ
num_midis
)

865  
	`RET_ERROR
 (
ENXIO
);

867 
	`IOCTL_TO_USER
 ((*è
¬g
, 0, (*è&(
midi_devs
[
dev
]->
šfo
),  (
šf
));

872 
SNDCTL_PMGR_IFACE
:

874 
·tmgr_šfo
 *
šf
;

875 
dev
, 
”r
;

877 
šf
 = (
·tmgr_šfo
 *è
	`KERNEL_MALLOC
 ( (*inf));

879 
	`IOCTL_FROM_USER
 ((*è
šf
, (*è
¬g
, 0,  (*inf));

880 
dev
 = 
šf
->
deviû
;

882 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

884 
	`KERNEL_FREE
 (
šf
);

885  
	`RET_ERROR
 (
ENXIO
);

888 ià(!
syÁh_devs
[
dev
]->
pmgr_š‹rçû
)

890 
	`KERNEL_FREE
 (
šf
);

891  
	`RET_ERROR
 (
ENXIO
);

894 ià((
”r
 = 
syÁh_devs
[
dev
]->
	`pmgr_š‹rçû
 (dev, 
šf
)) == -1)

896 
	`KERNEL_FREE
 (
šf
);

897  
”r
;

900 
	`IOCTL_TO_USER
 ((*è
¬g
, 0, (*è
šf
,  (*inf));

901 
	`KERNEL_FREE
 (
šf
);

906 
SNDCTL_PMGR_ACCESS
:

908 
·tmgr_šfo
 *
šf
;

909 
dev
, 
”r
;

911 
šf
 = (
·tmgr_šfo
 *è
	`KERNEL_MALLOC
 ( (*inf));

913 
	`IOCTL_FROM_USER
 ((*è
šf
, (*è
¬g
, 0,  (*inf));

914 
dev
 = 
šf
->
deviû
;

916 ià(
dev
 < 0 || dev >ğ
num_syÁhs
)

918 
	`KERNEL_FREE
 (
šf
);

919  
	`RET_ERROR
 (
ENXIO
);

922 ià(!
pmgr_´e£Á
[
dev
])

924 
	`KERNEL_FREE
 (
šf
);

925  
	`RET_ERROR
 (
ESRCH
);

928 ià((
”r
 = 
	`pmgr_acûss
 (
dev
, 
šf
)) < 0)

930 
	`KERNEL_FREE
 (
šf
);

931  
”r
;

934 
	`IOCTL_TO_USER
 ((*è
¬g
, 0, (*è
šf
,  (*inf));

935 
	`KERNEL_FREE
 (
šf
);

940 
SNDCTL_SEQ_TRESHOLD
:

942 
tmp
 = 
	`IOCTL_IN
 (
¬g
);

944 ià(
dev
)

945  
	`RET_ERROR
 (
EIO
);

947 ià(
tmp
 < 1)

948 
tmp
 = 1;

949 ià(
tmp
 >ğ
SEQ_MAX_QUEUE
)

950 
tmp
 = 
SEQ_MAX_QUEUE
 - 1;

951 
ouut_ŒeshŞd
 = 
tmp
;

957 ià(
dev
)

958  
	`RET_ERROR
 (
EIO
);

960 ià(
mode
 =ğ
OPEN_READ
)

961  
	`RET_ERROR
 (
EIO
);

963 ià(!
syÁh_devs
[0])

964  
	`RET_ERROR
 (
ENXIO
);

965 ià(!(
syÁh_İ’_mask
 & (1 << 0)))

966  
	`RET_ERROR
 (
ENXIO
);

967  
syÁh_devs
[0]->
	`ioùl
 (0, 
cmd
, 
¬g
);

971  
	`RET_ERROR
 (
EINVAL
);

972 
	}
}

974 #ifdeà
ALLOW_SELECT


976 
	$£qu’ûr_£Ëù
 (
dev
, 
fešfo
 *
fe
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

978 
dev
 = dev >> 4;

980 
£l_ty³
)

982 
SEL_IN
:

983 ià(!
iqËn
)

985 
	`£Ëù_wa™
 (&
midi_¦“³r
, 
wa™
);

992 
SEL_OUT
:

993 ià(
qËn
 >ğ
SEQ_MAX_QUEUE
)

995 
	`£Ëù_wa™
 (&
£q_¦“³r
, 
wa™
);

1001 
SEL_EX
:

1006 
	}
}

1011 
	$£qu’ûr_tim”
 ()

1013 
	`£q_¡¬Ïy
 ();

1014 
	}
}

1017 
	$nÙe_to_äeq
 (
nÙe_num
)

1024 
nÙe
, 
oùave
, 
nÙe_äeq
;

1025 
nÙes
[] =

1031 
	#BASE_OCTAVE
 5

	)

1033 
oùave
 = 
nÙe_num
 / 12;

1034 
nÙe
 = 
nÙe_num
 % 12;

1036 
nÙe_äeq
 = 
nÙes
[
nÙe
];

1038 ià(
oùave
 < 
BASE_OCTAVE
)

1039 
nÙe_äeq
 >>ğ(
BASE_OCTAVE
 - 
oùave
);

1040 ià(
oùave
 > 
BASE_OCTAVE
)

1041 
nÙe_äeq
 <<ğ(
oùave
 - 
BASE_OCTAVE
);

1045  
nÙe_äeq
;

1046 
	}
}

1049 
	$compu‹_fš‘uÃ
 (
ba£_äeq
, 
b’d
, 
¿nge
)

1051 
amouÁ
;

1052 
Ãg©ive
, 
£m™Úes
, 
ûÁs
;

1054 ià(!
b’d
)

1055  
ba£_äeq
;

1056 ià(!
¿nge
)

1057  
ba£_äeq
;

1059 ià(!
ba£_äeq
)

1060  
ba£_äeq
;

1062 ià(
¿nge
 >= 8192)

1063 
¿nge
 = 8191;

1065 
b’d
 = b’d * 
¿nge
 / 8192;

1066 ià(!
b’d
)

1067  
ba£_äeq
;

1069 
Ãg©ive
 = 
b’d
 < 0 ? 1 : 0;

1071 ià(
b’d
 < 0)

1072 
b’d
 *= -1;

1073 ià(
b’d
 > 
¿nge
)

1074 
b’d
 = 
¿nge
;

1076 ià(
b’d
 > 2399)

1077 
b’d
 = 2399;

1079 
£m™Úes
 = 
b’d
 / 100;

1080 
ûÁs
 = 
b’d
 % 100;

1082 
amouÁ
 = 
£m™Úe_tunšg
[
£m™Úes
] * 
ûÁ_tunšg
[
ûÁs
] / 10000;

1084 ià(
Ãg©ive
)

1085  (
ba£_äeq
 * 10000è/ 
amouÁ
;

1087  (
ba£_äeq
 * 
amouÁ
) / 10000;

1088 
	}
}

1092 
	$£qu’ûr_š™
 (
mem_¡¬t
)

1095 
£qu’ûr_ok
 = 1;

1096 
	`PERMANENT_MALLOC
(*, 
queue
, 
SEQ_MAX_QUEUE
*
EV_SZ
, 
mem_¡¬t
);

1097 
	`PERMANENT_MALLOC
(*, 
iqueue
, 
SEQ_MAX_QUEUE
*
IEV_SZ
, 
mem_¡¬t
);

1098  
mem_¡¬t
;

1099 
	}
}

1104 
	$£qu’ûr_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

1106  
	`RET_ERROR
 (
EIO
);

1107 
	}
}

1110 
	$£qu’ûr_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
)

1112  
	`RET_ERROR
 (
EIO
);

1113 
	}
}

1116 
	$£qu’ûr_İ’
 (
dev
, 
fešfo
 *
fe
)

1118  
	`RET_ERROR
 (
ENXIO
);

1119 
	}
}

1122 
	$£qu’ûr_»Ëa£
 (
dev
, 
fešfo
 *
fe
)

1124 
	}
}

1126 
	$£qu’ûr_ioùl
 (
dev
, 
fešfo
 *
fe
,

1127 
cmd
, 
¬g
)

1129  
	`RET_ERROR
 (
EIO
);

1130 
	}
}

1133 
	$£qu’ûr_l£ek
 (
dev
, 
fešfo
 *
fe
, 
off_t
 
off£t
, 
Üig
)

1135  
	`RET_ERROR
 (
EIO
);

1136 
	}
}

1139 
	$£qu’ûr_š™
 (
mem_¡¬t
)

1141  
mem_¡¬t
;

1142 
	}
}

1145 
	$£qu’ûr_£Ëù
 (
dev
, 
fešfo
 *
fe
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

1147  
	`RET_ERROR
 (
EIO
);

1148 
	}
}

	@drivers/sound/sound_calls.h

5 
DMAbuf_İ’
(
dev
, 
mode
);

6 
DMAbuf_»Ëa£
(
dev
, 
mode
);

7 
DMAbuf_»ad
 (
dev
, 
¢d_rw_buf
 *
u£r_buf
, 
couÁ
);

8 
DMAbuf_g‘wrbufãr
(
dev
, **
buf
, *
size
);

9 
DMAbuf_g‘rdbufãr
(
dev
, **
buf
, *
Ën
);

10 
DMAbuf_rmch¬s
(
dev
, 
buff_no
, 
c
);

11 
DMAbuf_¡¬t_ouut
(
dev
, 
buff_no
, 
l
);

12 
DMAbuf_ioùl
(
dev
, 
cmd
, 
¬g
, 
loÿl
);

13 
DMAbuf_š™
(
mem_¡¬t
);

14 
DMAbuf_¡¬t_dma
 (
dev
, 
phy§ddr
, 
couÁ
, 
dma_mode
);

15 
DMAbuf_İ’_dma
 (
chª
);

16 
DMAbuf_şo£_dma
 (
chª
);

17 
DMAbuf_»£t_dma
 (
chª
);

18 
DMAbuf_šputšŒ
(
dev
);

19 
DMAbuf_ouutšŒ
(
dev
, 
und”æow_æag
);

25 
audio_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

26 
audio_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

27 
audio_İ’
 (
dev
, 
fešfo
 *
fe
);

28 
audio_»Ëa£
 (
dev
, 
fešfo
 *
fe
);

29 
audio_ioùl
 (
dev
, 
fešfo
 *
fe
,

30 
cmd
, 
¬g
);

31 
audio_l£ek
 (
dev
, 
fešfo
 *
fe
, 
off_t
 
off£t
, 
Üig
);

32 
audio_š™
 (
mem_¡¬t
);

38 
£qu’ûr_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

39 
£qu’ûr_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

40 
£qu’ûr_İ’
 (
dev
, 
fešfo
 *
fe
);

41 
£qu’ûr_»Ëa£
 (
dev
, 
fešfo
 *
fe
);

42 
£qu’ûr_ioùl
 (
dev
, 
fešfo
 *
fe
,

43 
cmd
, 
¬g
);

44 
£qu’ûr_l£ek
 (
dev
, 
fešfo
 *
fe
, 
off_t
 
off£t
, 
Üig
);

45 
£qu’ûr_š™
 (
mem_¡¬t
);

46 
£qu’ûr_tim”
();

47 
nÙe_to_äeq
(
nÙe_num
);

48 
compu‹_fš‘uÃ
(
ba£_äeq
, 
b’d
, 
¿nge
);

50 #ifdeà
ALLOW_SELECT


51 
£qu’ûr_£Ëù
(
dev
, 
fešfo
 *
fe
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
);

58 
MIDIbuf_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

59 
MIDIbuf_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

60 
MIDIbuf_İ’
 (
dev
, 
fešfo
 *
fe
);

61 
MIDIbuf_»Ëa£
 (
dev
, 
fešfo
 *
fe
);

62 
MIDIbuf_ioùl
 (
dev
, 
fešfo
 *
fe
,

63 
cmd
, 
¬g
);

64 
MIDIbuf_l£ek
 (
dev
, 
fešfo
 *
fe
, 
off_t
 
off£t
, 
Üig
);

65 
MIDIbuf_by‹s_»ûived
(
dev
, *
buf
, 
couÁ
);

66 
MIDIbuf_š™
(
mem_¡¬t
);

73 
CMIDI_š™
 (
mem_¡¬t
);

74 
CMIDI_İ’
 (
dev
, 
fešfo
 *
fe
);

75 
CMIDI_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

76 
CMIDI_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

77 
CMIDI_şo£
 (
dev
, 
fešfo
 *
fe
);

86 
´o_midi_©ch
(
mem_¡¬t
);

87 
´o_midi_İ’
(
dev
, 
mode
);

88 
´o_midi_şo£
(
dev
);

89 
´o_midi_wr™e
(
dev
, 
¢d_rw_buf
 *
uio
);

90 
´o_midi_»ad
(
dev
, 
¢d_rw_buf
 *
uio
);

93 
soundÿrd_š™
(
mem_¡¬t
);

94 
‹nmiüo£c
();

95 
»que¡_sound_tim”
 (
couÁ
);

96 
sound_¡İ_tim”
();

97 
¢d_ioùl_»tuº
(*
addr
, 
v®ue
);

98 
¢d_£t_œq_hªdËr
 (
š‹¼u±_Ëv–
, (*
hndÌ
)());

99 
	`¢d_»Ëa£_œq
(
veù
);

100 
	`sound_dma_m®loc
(
dev
);

101 
	`sound_dma_ä“
(
dev
);

104 
	`sound_»ad_sw
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

105 
	`sound_wr™e_sw
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
);

106 
	`sound_İ’_sw
 (
dev
, 
fešfo
 *
fe
);

107 
	`sound_»Ëa£_sw
 (
dev
, 
fešfo
 *
fe
);

108 
	`sound_ioùl_sw
 (
dev
, 
fešfo
 *
fe
,

109 
cmd
, 
¬g
);

112 
	`sb_d¥_d‘eù
 (
add»ss_šfo
 *
hw_cÚfig
);

113 
	`sb_d¥_š™
 (
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

114 
	`sb_d¥_di§bË_midi
();

115 
	`sb_g‘_œq
();

116 
	`sb_ä“_œq
();

117 
	`sb_d¥_commªd
 (
v®
);

118 
	`sb_»£t_d¥
 ();

121 
	`sb16_d¥_š‹¼u±
 (
unu£d
);

122 
	`sb16_d¥_š™
(
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

123 
	`sb16_d¥_d‘eù
(
add»ss_šfo
 *
hw_cÚfig
);

126 
	`sb16midišŒ
 (
un™
);

127 
	`©ch_sb16midi
(
mem_¡¬t
, 
add»ss_šfo
 * 
hw_cÚfig
);

128 
	`´obe_sb16midi
(
add»ss_šfo
 *
hw_cÚfig
);

131 
	`sb_midi_š™
(
mod–
);

134 
	`sb_£tmix”
 (
pÜt
, 
v®ue
);

135 
	`sb_g‘mix”
 (
pÜt
);

136 
	`sb_mix”_£t_¡”eo
(
mode
);

137 
	`sb_mix”_š™
(
majÜ_mod–
);

140 
	`İl3_d‘eù
 (
ißddr
);

141 
	`İl3_š™
(
mem_¡¬t
);

144 
	`©ch_sb_ÿrd
(
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

145 
	`´obe_sb
(
add»ss_šfo
 *
hw_cÚfig
);

148 
	`©ch_adlib_ÿrd
(
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

149 
	`´obe_adlib
(
add»ss_šfo
 *
hw_cÚfig
);

152 
	`©ch_·s_ÿrd
(
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

153 
	`´obe_·s
(
add»ss_šfo
 *
hw_cÚfig
);

154 
	`·s_£t_šŒ
(
mask
);

155 
	`·s_»move_šŒ
(
mask
);

156 
	`·s_»ad
(
ißddr
);

157 
	`·s_wr™e
(
d©a
, 
ißddr
);

160 
	`·s_pcm_š‹¼u±
(
¡©us
, 
ÿu£
);

161 
	`·s_pcm_š™
(
mem_¡¬t
, 
add»ss_šfo
 *
hw_cÚfig
);

164 
	`·s_š™_mix”
();

167 
	`·s_midi_š™
(
mem_¡¬t
);

168 
	`·s_midi_š‹¼u±
();

171 
	`©ch_gus_ÿrd
(
mem_¡¬t
, 
add»ss_šfo
 * 
hw_cÚfig
);

172 
	`´obe_gus
(
add»ss_šfo
 *
hw_cÚfig
);

173 
	`gus_£t_midi_œq
(
num
);

174 
	`gusšŒ
();

177 
	`gus_wave_d‘eù
(
ba£addr
);

178 
	`gus_wave_š™
(
mem_¡¬t
, 
œq
, 
dma
);

179 
	`gus_voiû_œq
();

180 
	`gus_»ad8
 (
»g
);

181 
	`gus_wr™e8
(
»g
, 
d©a
);

182 
	`guswave_dma_œq
();

183 
	`gus_d–ay
();

186 
	`gus_midi_š™
(
mem_¡¬t
);

187 
	`gus_midi_š‹¼u±
(
dummy
);

190 
	`©ch_mpu401
(
mem_¡¬t
, 
add»ss_šfo
 * 
hw_cÚfig
);

191 
	`´obe_mpu401
(
add»ss_šfo
 *
hw_cÚfig
);

194 
	`’abË_İl3_mode
(
Ëá
, 
right
, 
bÙh
);

197 
	`pmgr_İ’
(
dev
);

198 
	`pmgr_»Ëa£
(
dev
);

199 
	`pmgr_»ad
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
);

200 
	`pmgr_wr™e
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 * 
buf
, 
couÁ
);

201 
	`pmgr_acûss
(
dev
, 
·tmgr_šfo
 *
»c
);

202 
	`pmgr_šfÜm
(
dev
, 
ev’t
, 
·rm1
, 
·rm2
,

203 
·rm3
, 
·rm4
);

	@drivers/sound/sound_config.h

31 
	~"loÿl.h
"

34 #undeà
CONFIGURE_SOUNDCARD


35 #undeà
DYNAMIC_BUFFER


37 #ifdeà
KERNEL_SOUNDCARD


38 
	#CONFIGURE_SOUNDCARD


	)

39 
	#DYNAMIC_BUFFER


	)

40 #undeà
LOADABLE_SOUNDCARD


43 #ifdeà
EXCLUDE_SEQUENCER


44 
	#EXCLUDE_MIDI


	)

45 
	#EXCLUDE_YM3812


	)

46 
	#EXCLUDE_OPL3


	)

49 #iâdeà
SND_DEFAULT_ENABLE


50 
	#SND_DEFAULT_ENABLE
 1

	)

55 #ifdeà
EXCLUDE_CHIP_MIDI


56 
	#EXCLUDE_PRO_MIDI


	)

61 #ià
defšed
(
EXCLUDE_SEQUENCER
è&& defšed(
EXCLUDE_AUDIO
)

62 #undeà
CONFIGURE_SOUNDCARD


65 #ifdeà
CONFIGURE_SOUNDCARD


72 #iâdeà
SBC_BASE


73 
	#SBC_BASE
 0x220

	)

76 #iâdeà
SBC_IRQ


77 
	#SBC_IRQ
 7

	)

80 #iâdeà
SBC_DMA


81 
	#SBC_DMA
 1

	)

84 #iâdeà
SB16_DMA


85 
	#SB16_DMA
 6

	)

88 #iâdeà
SB16MIDI_BASE


89 
	#SB16MIDI_BASE
 0x300

	)

92 #iâdeà
PAS_BASE


93 
	#PAS_BASE
 0x388

	)

96 #iâdeà
PAS_IRQ


97 
	#PAS_IRQ
 5

	)

100 #iâdeà
PAS_DMA


101 
	#PAS_DMA
 3

	)

104 #iâdeà
GUS_BASE


105 
	#GUS_BASE
 0x220

	)

108 #iâdeà
GUS_IRQ


109 
	#GUS_IRQ
 15

	)

112 #iâdeà
GUS_MIDI_IRQ


113 
	#GUS_MIDI_IRQ
 
GUS_IRQ


	)

116 #iâdeà
GUS_DMA


117 
	#GUS_DMA
 6

	)

120 #iâdeà
MPU_BASE


121 
	#MPU_BASE
 0x330

	)

124 #iâdeà
MPU_IRQ


125 
	#MPU_IRQ
 6

	)

128 #iâdeà
MAX_REALTIME_FACTOR


129 
	#MAX_REALTIME_FACTOR
 4

	)

143 #iâdeà
DSP_BUFFSIZE


144 
	#DSP_BUFFSIZE
 (4096)

	)

147 #iâdeà
DSP_BUFFCOUNT


148 
	#DSP_BUFFCOUNT
 2

	)

151 
	#DMA_AUTOINIT
 0x10

	)

153 
	#FM_MONO
 0x388

	)

157 
	#SEQ_MAX_QUEUE
 1024

	)

159 
	#SBFM_MAXINSTR
 (256è

	)

163 
	#SND_NDEVS
 50

	)

164 
	#SND_DEV_CTL
 0

	)

165 
	#SND_DEV_SEQ
 1

	)

167 
	#SND_DEV_MIDIN
 2

	)

169 
	#SND_DEV_DSP
 3

	)

170 
	#SND_DEV_AUDIO
 4

	)

171 
	#SND_DEV_DSP16
 5

	)

172 
	#SND_DEV_STATUS
 6

	)

182 
	#CMIDI_DEV_PRO
 15

	)

192 
	#DSP_DEFAULT_SPEED
 8000

	)

194 
	#ON
 1

	)

195 
	#OFF
 0

	)

197 
	#MAX_DSP_DEV
 4

	)

198 
	#MAX_MIXER_DEV
 2

	)

199 
	#MAX_SYNTH_DEV
 3

	)

200 
	#MAX_MIDI_DEV
 4

	)

202 
	sfešfo
 {

203 
	mmode
;

206 
	sadd»ss_šfo
 {

207 
	mio_ba£
;

208 
	mœq
;

209 
	mdma
;

215 
	#WK_NONE
 0x00

	)

216 
	#WK_WAKEUP
 0x01

	)

217 
	#WK_TIMEOUT
 0x02

	)

218 
	#WK_SIGNAL
 0x04

	)

219 
	#WK_SLEEP
 0x08

	)

221 
	#OPEN_READ
 1

	)

222 
	#OPEN_WRITE
 2

	)

223 
	#OPEN_READWRITE
 3

	)

225 
	~"os.h
"

226 
	~"sound_ÿÎs.h
"

227 
	~"dev_bË.h
"

229 #iâdeà
DEB


230 
	#DEB
(
x
)

	)

	@drivers/sound/sound_switch.c

30 
	~"sound_cÚfig.h
"

32 #ifdeà
CONFIGURE_SOUNDCARD


34 
	ssbc_deviû


36 
	mu£couÁ
;

39 
sbc_deviû
 
	gsbc_deviûs
[
SND_NDEVS
] = {{0}};

41 
	gš_u£
 = 0;

47 *
	g¡©us_buf
 = 
NULL
;

48 
	g¡©us_Ën
, 
	g¡©us_±r
;

49 
	g¡©us_busy
 = 0;

52 
	$put_¡©us
 (*
s
)

54 
l
;

56 
l
=0;l<256,
s
[l];l++);

58 ià(
¡©us_Ën
 + 
l
 >= 4000)

61 
	`memıy
 (&
¡©us_buf
[
¡©us_Ën
], 
s
, 
l
);

62 
¡©us_Ën
 +ğ
l
;

65 
	}
}

68 
	$put_¡©us_št
 (
v®
, 
¿dix
)

70 
l
, 
v
;

72 
hx
[] = "0123456789abcdef";

73 
buf
[11];

75 ià(!
v®
è 
	`put_¡©us
("0");

77 
l
 = 0;

78 
buf
[10]=0;

80 
v®
)

82 
v
 = 
v®
 % 
¿dix
;

83 
v®
 = v® / 
¿dix
;

85 
buf
[9-
l
] = 
hx
[
v
];

86 
l
++;

89 ià(
¡©us_Ën
 + 
l
 >= 4000)

92 
	`memıy
 (&
¡©us_buf
[
¡©us_Ën
], &
buf
[10-
l
],†);

93 
¡©us_Ën
 +ğ
l
;

96 
	}
}

99 
	$š™_¡©us
 ()

106 
i
;

108 
¡©us_±r
 = 0;

110 
	`put_¡©us
 ("Sound Driv”:" 
SOUND_VERSION_STRING


111 " (" 
SOUND_CONFIG_DATE
 " " 
SOUND_CONFIG_BY
 "@"

112 
SOUND_CONFIG_HOST
 "." 
SOUND_CONFIG_DOMAIN
 ")"

115 ià(!
	`put_¡©us
 ("Config options: "))

117 ià(!
	`put_¡©us_št
(
SELECTED_SOUND_OPTIONS
, 16))

120 ià(!
	`put_¡©us
 ("\n\nHW config: \n"))

123 
i
 = 0; i < (
num_sound_driv”s
 - 1); i++)

125 ià(!
suµÜ‹d_driv”s
[
i
].
’abËd
)

126 ià(!
	`put_¡©us
 ("("))

129 ià(!
	`put_¡©us
 ("Type ")) ;

130 ià(!
	`put_¡©us_št
(
suµÜ‹d_driv”s
[
i
].
ÿrd_ty³
, 10)) ;

131 ià(!
	`put_¡©us
 (": ")) ;

132 ià(!
	`put_¡©us
 (
suµÜ‹d_driv”s
[
i
].
Çme
)) ;

133 ià(!
	`put_¡©us
 ("‡t 0x")) ;

134 ià(!
	`put_¡©us_št
(
suµÜ‹d_driv”s
[
i
].
cÚfig
.
io_ba£
, 16)) ;

135 ià(!
	`put_¡©us
 (" irq ")) ;

136 ià(!
	`put_¡©us_št
(
suµÜ‹d_driv”s
[
i
].
cÚfig
.
œq
, 10)) ;

137 ià(!
	`put_¡©us
 (" drq ")) ;

138 ià(!
	`put_¡©us_št
(
suµÜ‹d_driv”s
[
i
].
cÚfig
.
dma
, 10)) ;

140 ià(!
suµÜ‹d_driv”s
[
i
].
’abËd
)

141 ià(!
	`put_¡©us
 (")"))

144 ià(!
	`put_¡©us
 ("\n"))

148 ià(!
	`put_¡©us
 ("\nPCM devices:\n"))

151 
i
 = 0; i < 
num_d¥devs
; i++)

153 ià(!
	`put_¡©us_št
(
i
, 10)) ;

154 ià(!
	`put_¡©us
(": "));

155 ià(!
	`put_¡©us
(
d¥_devs
[
i
]->
Çme
));

156 ià(!
	`put_¡©us
("\n"));

159 ià(!
	`put_¡©us
 ("\nSynth devices:\n"))

162 
i
 = 0; i < 
num_syÁhs
; i++)

164 ià(!
	`put_¡©us_št
(
i
, 10)) ;

165 ià(!
	`put_¡©us
(": "));

166 ià(!
	`put_¡©us
(
syÁh_devs
[
i
]->
šfo
->
Çme
));

167 ià(!
	`put_¡©us
("\n"));

170 ià(!
	`put_¡©us
 ("\nMidi devices:\n"))

173 
i
 = 0; i < 
num_midis
; i++)

175 ià(!
	`put_¡©us_št
(
i
, 10)) ;

176 ià(!
	`put_¡©us
(": "));

177 ià(!
	`put_¡©us
(
midi_devs
[
i
]->
šfo
.
Çme
));

178 ià(!
	`put_¡©us
("\n"));

181 ià(
num_mix”s
)

183 ià(!
	`put_¡©us
 ("\nMixer(s) installed\n"))

188 ià(!
	`put_¡©us
 ("\nNo mixers installed\n"))

191 
	}
}

194 
	$»ad_¡©us
 (
¢d_rw_buf
 *
buf
, 
couÁ
)

199 
l
, 
c
;

201 
l
 = 
couÁ
;

202 
c
 = 
¡©us_Ën
 - 
¡©us_±r
;

204 ià(
l
 > 
c
)

205 
l
 = 
c
;

206 ià(
l
 <= 0)

209 
	`COPY_TO_USER
(
buf
, 0, &
¡©us_buf
[
¡©us_±r
], 
l
);

210 
¡©us_±r
 +ğ
l
;

212  
l
;

213 
	}
}

216 
	$sound_»ad_sw
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
)

218 
	`DEB
 (
	`´štk
 ("sound_»ad_sw(dev=%d, couÁ=%d)\n", 
dev
, 
couÁ
));

220 
dev
 & 0x0f)

222 
SND_DEV_STATUS
:

223  
	`»ad_¡©us
 (
buf
, 
couÁ
);

226 
SND_DEV_DSP
:

227 
SND_DEV_DSP16
:

228 
SND_DEV_AUDIO
:

229  
	`audio_»ad
 (
dev
, 
fe
, 
buf
, 
couÁ
);

232 
SND_DEV_SEQ
:

233  
	`£qu’ûr_»ad
 (
dev
, 
fe
, 
buf
, 
couÁ
);

236 #iâdeà
EXCLUDE_MPU401


237 
SND_DEV_MIDIN
:

238  
	`MIDIbuf_»ad
 (
dev
, 
fe
, 
buf
, 
couÁ
);

242 
	`´štk
 ("Sound: Undefšed mšÜ deviû %d\n", 
dev
);

245  
	`RET_ERROR
 (
EPERM
);

246 
	}
}

249 
	$sound_wr™e_sw
 (
dev
, 
fešfo
 *
fe
, 
¢d_rw_buf
 *
buf
, 
couÁ
)

252 
	`DEB
 (
	`´štk
 ("sound_wr™e_sw(dev=%d, couÁ=%d)\n", 
dev
, 
couÁ
));

254 
dev
 & 0x0f)

257 
SND_DEV_SEQ
:

258  
	`£qu’ûr_wr™e
 (
dev
, 
fe
, 
buf
, 
couÁ
);

261 
SND_DEV_DSP
:

262 
SND_DEV_DSP16
:

263 
SND_DEV_AUDIO
:

264  
	`audio_wr™e
 (
dev
, 
fe
, 
buf
, 
couÁ
);

268  
	`RET_ERROR
 (
EPERM
);

271  
couÁ
;

272 
	}
}

275 
	$sound_İ’_sw
 (
dev
, 
fešfo
 *
fe
)

277 
»tv®
;

278 
	`DEB
 (
	`´štk
 ("sound_İ’_sw(dev=%dè: u£couÁ=%d\n", 
dev
, 
sbc_deviûs
[dev].
u£couÁ
));

280 ià((
dev
 >ğ
SND_NDEVS
) || (dev < 0))

282 
	`´štk
 ("Inv®id mšÜ deviû %d\n", 
dev
);

283  
	`RET_ERROR
 (
ENXIO
);

286 
dev
 & 0x0f)

288 
SND_DEV_STATUS
:

289 ià(
¡©us_busy
)

290  
	`RET_ERROR
 (
EBUSY
);

291 
¡©us_busy
 = 1;

292 ià((
¡©us_buf
 = (*è
	`KERNEL_MALLOC
 (4000)è=ğ
NULL
)

293  
	`RET_ERROR
 (
EIO
);

294 
¡©us_Ën
 = 
¡©us_±r
 = 0;

295 
	`š™_¡©us
 ();

298 
SND_DEV_CTL
:

302 
SND_DEV_SEQ
:

303 ià((
»tv®
 = 
	`£qu’ûr_İ’
 (
dev
, 
fe
)) < 0)

304  
»tv®
;

307 #iâdeà
EXCLUDE_MPU401


308 
SND_DEV_MIDIN
:

309 ià((
»tv®
 = 
	`MIDIbuf_İ’
 (
dev
, 
fe
)) < 0)

310  
»tv®
;

314 
SND_DEV_DSP
:

315 
SND_DEV_DSP16
:

316 
SND_DEV_AUDIO
:

317 ià((
»tv®
 = 
	`audio_İ’
 (
dev
, 
fe
)) < 0)

318  
»tv®
;

322 
	`´štk
 ("Inv®id mšÜ deviû %d\n", 
dev
);

323  
	`RET_ERROR
 (
ENXIO
);

326 
sbc_deviûs
[
dev
].
u£couÁ
++;

327 
š_u£
++;

330 
	}
}

333 
	$sound_»Ëa£_sw
 (
dev
, 
fešfo
 *
fe
)

336 
	`DEB
 (
	`´štk
 ("sound_»Ëa£_sw(dev=%d)\n", 
dev
));

338 
dev
 & 0x0f)

340 
SND_DEV_STATUS
:

341 ià(
¡©us_buf
)

342 
	`KERNEL_FREE
 (
¡©us_buf
);

343 
¡©us_buf
 = 
NULL
;

344 
¡©us_busy
 = 0;

347 
SND_DEV_CTL
:

350 
SND_DEV_SEQ
:

351 
	`£qu’ûr_»Ëa£
 (
dev
, 
fe
);

354 #iâdeà
EXCLUDE_MPU401


355 
SND_DEV_MIDIN
:

356 
	`MIDIbuf_»Ëa£
 (
dev
, 
fe
);

360 
SND_DEV_DSP
:

361 
SND_DEV_DSP16
:

362 
SND_DEV_AUDIO
:

363 
	`audio_»Ëa£
 (
dev
, 
fe
);

367 
	`´štk
 ("Soundƒ¼Ü: R–—sšg unknowÀdeviû 0x%02x\n", 
dev
);

370 
sbc_deviûs
[
dev
].
u£couÁ
--;

371 
š_u£
--;

372 
	}
}

375 
	$sound_ioùl_sw
 (
dev
, 
fešfo
 *
fe
,

376 
cmd
, 
¬g
)

378 
	`DEB
 (
	`´štk
 ("sound_ioùl_sw(dev=%d, cmd=0x%x,‡rg=0x%x)\n", 
dev
, 
cmd
, 
¬g
));

380 
dev
 & 0x0f)

383 
SND_DEV_CTL
:

385 ià(!
num_mix”s
)

386  
	`RET_ERROR
 (
ENXIO
);

388 ià((
dev
 >> 4è>ğ
num_mix”s
)

389  
	`RET_ERROR
 (
ENXIO
);

391  
mix”_devs
[
dev
 >> 4]->
	`ioùl
 (dev >> 4, 
cmd
, 
¬g
);

394 
SND_DEV_SEQ
:

395  
	`£qu’ûr_ioùl
 (
dev
, 
fe
, 
cmd
, 
¬g
);

398 
SND_DEV_DSP
:

399 
SND_DEV_DSP16
:

400 
SND_DEV_AUDIO
:

401  
	`audio_ioùl
 (
dev
, 
fe
, 
cmd
, 
¬g
);

404 #iâdeà
EXCLUDE_MPU401


405 
SND_DEV_MIDIN
:

406  
	`MIDIbuf_ioùl
 (
dev
, 
fe
, 
cmd
, 
¬g
);

411  
	`RET_ERROR
 (
EPERM
);

415  
	`RET_ERROR
 (
EPERM
);

416 
	}
}

	@drivers/sound/soundcard.c

31 
	~"sound_cÚfig.h
"

33 #ifdeà
CONFIGURE_SOUNDCARD


35 
	~<lšux/majÜ.h
>

37 
£q_time
;

39 
	gsoundÿrds_š¡®Ëd
 = 0;

41 
	gsoundÿrd_cÚfigu»d
 = 0;

43 
fešfo
 
	gfes
[
SND_NDEVS
];

45 *
¢d_¿w_buf
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
];

46 
¢d_¿w_buf_phys
[
MAX_DSP_DEV
][
DSP_BUFFCOUNT
];

47 
¢d_¿w_couÁ
[
MAX_DSP_DEV
];

50 
	$¢d_ioùl_»tuº
 (*
addr
, 
v®ue
)

52 ià(
v®ue
 < 0)

53  
v®ue
;

55 
	`PUT_WORD_TO_USER
 (
addr
, 0, 
v®ue
);

57 
	}
}

60 
	$sound_»ad
 (
šode
 *šode, 
fe
 *fe, *
buf
, 
couÁ
)

62 
dev
;

64 
dev
 = 
šode
->
i_rdev
;

65 
dev
 = 
	`MINOR
 (dev);

67  
	`sound_»ad_sw
 (
dev
, &
fes
[dev], 
buf
, 
couÁ
);

68 
	}
}

71 
	$sound_wr™e
 (
šode
 *šode, 
fe
 *fe, *
buf
, 
couÁ
)

73 
dev
;

75 
dev
 = 
šode
->
i_rdev
;

76 
dev
 = 
	`MINOR
 (dev);

78  
	`sound_wr™e_sw
 (
dev
, &
fes
[dev], 
buf
, 
couÁ
);

79 
	}
}

82 
	$sound_l£ek
 (
šode
 *šode, 
fe
 *fe, 
off_t
 
off£t
, 
Üig
)

84  
	`RET_ERROR
 (
EPERM
);

85 
	}
}

88 
	$sound_İ’
 (
šode
 *šode, 
fe
 *file)

90 
dev
;

92 
dev
 = 
šode
->
i_rdev
;

93 
dev
 = 
	`MINOR
 (dev);

95 ià(!
soundÿrd_cÚfigu»d
 && 
dev
 !ğ
SND_DEV_CTL
 && dev !ğ
SND_DEV_STATUS
)

97 
	`´štk
 ("SoundCard Error: The soundcard system has‚ot been configured\n");

98  
	`RET_ERROR
 (
ENXIO
);

101 
fes
[
dev
].
mode
 = 0;

103 ià((
fe
->
f_æags
 & 
O_ACCMODE
è=ğ
O_RDWR
)

104 
fes
[
dev
].
mode
 = 
OPEN_READWRITE
;

105 ià((
fe
->
f_æags
 & 
O_ACCMODE
è=ğ
O_RDONLY
)

106 
fes
[
dev
].
mode
 = 
OPEN_READ
;

107 ià((
fe
->
f_æags
 & 
O_ACCMODE
è=ğ
O_WRONLY
)

108 
fes
[
dev
].
mode
 = 
OPEN_WRITE
;

110  
	`sound_İ’_sw
 (
dev
, &
fes
[dev]);

111 
	}
}

114 
	$sound_»Ëa£
 (
šode
 *šode, 
fe
 *file)

116 
dev
;

118 
dev
 = 
šode
->
i_rdev
;

119 
dev
 = 
	`MINOR
 (dev);

121 
	`sound_»Ëa£_sw
 (
dev
, &
fes
[dev]);

122 
	}
}

125 
	$sound_ioùl
 (
šode
 *šode, 
fe
 *file,

126 
cmd
, 
¬g
)

128 
dev
;

130 
dev
 = 
šode
->
i_rdev
;

131 
dev
 = 
	`MINOR
 (dev);

133  
	`sound_ioùl_sw
 (
dev
, &
fes
[dev], 
cmd
, 
¬g
);

134 
	}
}

137 
	$sound_£Ëù
 (
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

139 
dev
;

141 
dev
 = 
šode
->
i_rdev
;

142 
dev
 = 
	`MINOR
 (dev);

144 
	`DEB
 (
	`´štk
 ("sound_£Ëù(dev=%d,y³=0x%x)\n", 
dev
, 
£l_ty³
));

146 
dev
 & 0x0f)

148 
SND_DEV_SEQ
:

149  
	`£qu’ûr_£Ëù
 (
dev
, &
fes
[dev], 
£l_ty³
, 
wa™
);

157 
	}
}

159 
fe_İ”©iÚs
 
	gsound_fİs
 =

161 
sound_l£ek
,

162 
sound_»ad
,

163 
sound_wr™e
,

164 
NULL
,

165 
sound_£Ëù
,

166 
sound_ioùl
,

167 
NULL
,

168 
sound_İ’
,

169 
sound_»Ëa£


173 
	$soundÿrd_š™
 (
mem_¡¬t
)

175 
	`»gi¡”_chrdev
 (
SOUND_MAJOR
, "sound", &
sound_fİs
);

177 
soundÿrd_cÚfigu»d
 = 1;

179 
mem_¡¬t
 = 
	`¢dbË_š™
 (mem_start);

182 ià(!(
soundÿrds_š¡®Ëd
 = 
	`¢dbË_g‘_ÿrdcouÁ
 ()))

183  
mem_¡¬t
;

185 ià(
num_d¥devs
)

187 
mem_¡¬t
 = 
	`DMAbuf_š™
 (mem_start);

188 
mem_¡¬t
 = 
	`audio_š™
 (mem_start);

191 #iâdeà
EXCLUDE_MPU401


192 ià(
num_midis
)

193 
mem_¡¬t
 = 
	`MIDIbuf_š™
 (mem_start);

196 ià(
num_midis
 + 
num_syÁhs
)

197 
mem_¡¬t
 = 
	`£qu’ûr_š™
 (mem_start);

199  
mem_¡¬t
;

200 
	}
}

203 
	$‹nmiüo£c
 ()

205 
i
;

207 
i
 = 0; i < 16; i++)

208 
	`šb
 (0x80);

209 
	}
}

212 
¢d_£t_œq_hªdËr
 (
š‹¼u±_Ëv–
, (*
hndÌ
)())

214 
»tcode
;

216 
sigaùiÚ
 
§
;

218 
§
.
§_hªdËr
 = 
hndÌ
;

220 #ifdeà
SND_SA_INTERRUPT


221 
§
.
§_æags
 = 
SA_INTERRUPT
;

223 
§
.
§_æags
 = 0;

226 
§
.
§_mask
 = 0;

227 
§
.
§_»¡Ü”
 = 
NULL
;

229 
»tcode
 = 
	`œqaùiÚ
 (
š‹¼u±_Ëv–
, &
§
);

231 ià(
»tcode
 < 0)

233 
	`´štk
 ("Sound: IRQ%d‡Ì—dy iÀu£\n", 
š‹¼u±_Ëv–
);

236  
»tcode
;

237 
	}
}

240 
	$¢d_»Ëa£_œq
(
veù
)

242 
	`ä“_œq
(
veù
);

243 
	}
}

246 
	$»que¡_sound_tim”
 (
couÁ
)

248 #iâdeà
EXCLUDE_SEQUENCER


249 ià(
couÁ
 < 0)

250 
couÁ
 = 
jiff›s
 + (-count);

252 
couÁ
 +ğ
£q_time
;

253 
tim”_bË
[
SOUND_TIMER
].
â
 = 
£qu’ûr_tim”
;

254 
tim”_bË
[
SOUND_TIMER
].
expœes
 = 
couÁ
;

255 
tim”_aùive
 |ğ1 << 
SOUND_TIMER
;

257 
	}
}

260 
	$sound_¡İ_tim”
 ()

262 #iâdeà
EXCLUDE_SEQUENCER


263 
tim”_bË
[
SOUND_TIMER
].
expœes
 = 0;

264 
tim”_aùive
 &ğ~(1 << 
SOUND_TIMER
);

266 
	}
}

268 #iâdeà
EXCLUDE_AUDIO


270 
	$v®id_dma_·ge
 (
addr
, 
dev_buffsize
, 
dma_·gesize
)

272 ià(((
addr
 & (
dma_·gesize
 - 1)è+ 
dev_buffsize
) <= dma_pagesize)

276 
	}
}

279 
	$sound_mem_š™
 ()

281 
i
, 
dev
;

282 
¡¬t_addr
, 
’d_addr
, 
mem_±r
, 
dma_·gesize
;

284 
mem_±r
 = 
high_memÜy
;

288 ià(
mem_±r
 > (16 * 1024 * 1024))

289 
mem_±r
 = 16 * 1024 * 1024;

291 
dev
 = 0; dev < 
num_d¥devs
; dev++)

292 ià(
sound_buffcouÁs
[
dev
] > 0 && 
sound_d¥_dmachª
[dev] > 0)

294 ià(
sound_dma_automode
[
dev
])

295 
sound_buffcouÁs
[
dev
] = 1;

297 ià(
sound_d¥_dmachª
[
dev
] > 3 && 
sound_buffsizes
[dev] > 65536)

298 
dma_·gesize
 = 131072;

300 
dma_·gesize
 = 65536;

304 ià(
sound_buffsizes
[
dev
] > 
dma_·gesize
)

305 
sound_buffsizes
[
dev
] = 
dma_·gesize
;

306 
sound_buffsizes
[
dev
] &= 0xfffff000;

307 ià(
sound_buffsizes
[
dev
] < 4096)

308 
sound_buffsizes
[
dev
] = 4096;

312 
¢d_¿w_couÁ
[
dev
] = 0; snd_¿w_couÁ[dev] < 
sound_buffcouÁs
[dev]; snd_raw_count[dev]++)

314 
¡¬t_addr
 = 
mem_±r
 - 
sound_buffsizes
[
dev
];

315 ià(!
	`v®id_dma_·ge
 (
¡¬t_addr
, 
sound_buffsizes
[
dev
], 
dma_·gesize
))

316 
¡¬t_addr
 &ğ~(
dma_·gesize
 - 1);

319 
’d_addr
 = 
¡¬t_addr
 + 
sound_buffsizes
[
dev
] - 1;

321 
¢d_¿w_buf
[
dev
][
¢d_¿w_couÁ
[dev]] = (*è
¡¬t_addr
;

322 
¢d_¿w_buf_phys
[
dev
][
¢d_¿w_couÁ
[dev]] = 
¡¬t_addr
;

323 
mem_±r
 = 
¡¬t_addr
;

325 
i
 = 
	`MAP_NR
 (
¡¬t_addr
); i <ğMAP_NR (
’d_addr
); i++)

327 ià(
mem_m­
[
i
])

328 
	`·nic
 ("sound_mem_init: Page‚ot free (driver incompatible with kernel).\n");

330 
mem_m­
[
i
] = 
MAP_PAGE_RESERVED
;

334 
	}
}

341 
	$soundÿrd_š™
 (
mem_¡¬t
)

343  
mem_¡¬t
;

344 
	}
}

348 #ià!
defšed
(
CONFIGURE_SOUNDCARD
è|| defšed(
EXCLUDE_AUDIO
)

350 
	$sound_mem_š™
 ()

353 
	}
}

	@drivers/sound/tuning.h

1 #ifdeà
SEQUENCER_C


3 
	g£m™Úe_tunšg
[24] =

10 
	gûÁ_tunšg
[100] =

27 
£m™Úe_tunšg
[24];

28 
ûÁ_tunšg
[100];

	@drivers/sound/ulaw.h

1 
	guÏw_d¥
[] = {

36 
	gd¥_uÏw
[] = {

	@fs/binfmt_coff.c

18 
	~<lšux/fs.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/mm.h
>

21 
	~<lšux/mmª.h
>

22 
	~<lšux/a.out.h
>

23 
	~<lšux/”ºo.h
>

24 
	~<lšux/sigÇl.h
>

25 
	~<lšux/bšfmts.h
>

26 
	~<asm/£gm’t.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/fú.h
>

29 
	~<lšux/±¿û.h
>

30 
	~<lšux/coff.h
>

31 
	~<lšux/m®loc.h
>

33 
asmlškage
 
sys_ex™
 (
ex™_code
);

34 
asmlškage
 
sys_şo£
 (
fd
);

35 
asmlškage
 
sys_İ’
 (const *, , );

36 
asmlškage
 
sys_u£lib
(cÚ¡ * 
lib¿ry
);

38 
´–ßd_lib¿ry
 (
lšux_bš´m
 *
exe_b´m
,

39 
COFF_SCNHDR
 * 
£ù
,

40 
fe
 *
å
);

42 
lßd_objeù
 (
lšux_bš´m
 *
b´m
,

43 
±_»gs
 *
»gs
,

44 
lib_ok
);

50 
šlše
 

51 
	$is_´İ”ly_®igÃd
 (
COFF_SCNHDR
 *
£ù
)

53 
sú±r
 = 
	`COFF_LONG
 (
£ù
->
s_sú±r
);

54 
vaddr
 = 
	`COFF_LONG
 (
£ù
->
s_vaddr
);

59 #ifdeà
COFF_DEBUG


60 
	`´štk
 ("%s, scnptr = %d, vaddr = %d\n",

61 
£ù
->
s_Çme
,

62 
sú±r
, 
vaddr
);

69 #ifdeà
COFF_DEBUG


70 ià(((
vaddr
 - 
sú±r
è& ~
PAGE_MASK
) != 0)

71 
	`´štk
 ("bad‡lignm’ˆš %s\n", 
£ù
->
s_Çme
);

73  ((((
vaddr
 - 
sú±r
è& ~
PAGE_MASK
è!ğ0è? -
ENOEXEC
 : 0);

74 
	}
}

81 
	$ş—r_memÜy
 (
addr
, 
size
)

83 
¡©us
;

85 
size
 = (
PAGE_SIZE
 - (
addr
 & ~
PAGE_MASK
)) & ~PAGE_MASK;

86 ià(
size
 == 0)

87 
¡©us
 = 0;

90 #ifdeà
COFF_DEBUG


91 
	`´štk
 ("un-š™Ÿlized stÜagš†a¡…ag%d\n", 
size
);

94 
¡©us
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
,

95 (*è
addr
, 
size
);

96 #ifdeà
COFF_DEBUG


97 
	`´štk
 ("»suÉ from v”ify_¬— = %d\n", 
¡©us
);

100 ià(
¡©us
 >= 0)

101 
size
-- != 0)

102 
	`put_fs_by‹
 (0, 
addr
++);

104  
¡©us
;

105 
	}
}

112 
	$lßd_objeù
 (
lšux_bš´m
 * 
b´m
, 
±_»gs
 *
»gs
, 
lib_ok
)

114 
COFF_FILHDR
 *
coff_hdr
 = (COFF_FILHDR *è
b´m
->
buf
;

115 
COFF_SCNHDR
 *
£ù_buä
;

116 
COFF_SCNHDR
 *
‹xt_£ù
;

117 
COFF_SCNHDR
 *
d©a_£ù
;

118 
COFF_SCNHDR
 *
bss_£ù
;

119 
‹xt_couÁ
;

120 
d©a_couÁ
;

121 
bss_couÁ
;

122 
lib_couÁ
;

123 
¡¬t_addr
 = 0;

124 
¡©us
 = 0;

125 
fd
 = -1;

126 
fe
 *
å
 = 
NULL
;

127 
£ùiÚs
 = 0;

128 
aout_size
 = 0;

129 
æags
;

131 #ifdeà
COFF_DEBUG


132 
	`´štk
 ("bšfmt_cofà’Œy: %s\n", 
b´m
->
f’ame
);

139 ià(
	`COFF_I386BADMAG
 (*
coff_hdr
)) {

140 #ifdeà
COFF_DEBUG


141 
	`´štk
 ("bad filehdr magic\n");

143 
¡©us
 = -
ENOEXEC
;

151 
æags
 = 
	`COFF_SHORT
 (
coff_hdr
->
f_æags
);

152 ià((
æags
 & (
COFF_F_AR32WR
 | 
COFF_F_AR16WR
)) != COFF_F_AR32WR) {

153 #ifdeà
COFF_DEBUG


154 
	`´štk
 ("invalid f_flags bits\n");

156 
¡©us
 = -
ENOEXEC
;

162 
£ùiÚs
 = 
	`COFF_SHORT
 (
coff_hdr
->
f_nsús
);

163 
aout_size
 = 
	`COFF_SHORT
 (
coff_hdr
->
f_İthdr
);

168 ià((
æags
 & 
COFF_F_EXEC
) == 0) {

169 #ifdeà
COFF_DEBUG


170 
	`´štk
 ("notƒxecutable bit\n");

172 
¡©us
 = -
ENOEXEC
;

178 ià(
£ùiÚs
 == 0) {

179 #ifdeà
COFF_DEBUG


180 
	`´štk
 ("no sections\n");

182 
¡©us
 = -
ENOEXEC
;

190 ià(!
b´m
->
šode
->
i_İ
 ||

191 !
b´m
->
šode
->
i_İ
->
deçuÉ_fe_İs
->
mm­
) {

192 #ifdeà
COFF_DEBUG


193 
	`´štk
 ("no mmap in fs\n");

195 
¡©us
 = -
ENOEXEC
;

202 ià(
¡©us
 >= 0) {

203 
nby‹s
 = 
£ùiÚs
 * 
COFF_SCNHSZ
;

205 
£ù_buä
 = (
COFF_SCNHDR
 *è
	`km®loc
 (
nby‹s
, 
GFP_KERNEL
);

206 ià(0 =ğ
£ù_buä
) {

207 #ifdeà
COFF_DEBUG


208 
	`´štk
 ("kmalloc failed\n");

210 
¡©us
 = -
ENOEXEC
;

216 
Şd_fs
 = 
	`g‘_fs
 ();

217 
	`£t_fs
 (
	`g‘_ds
 ());

218 
¡©us
 = 
	`»ad_exec
 (
b´m
->
šode
,

219 
aout_size
 + 
COFF_FILHSZ
,

220 (*è
£ù_buä
,

221 
nby‹s
);

222 
	`£t_fs
 (
Şd_fs
);

223 #ifdeà
COFF_DEBUG


224 ià(
¡©us
 < 0)

225 
	`´štk
 ("»ad‡ouˆhdr, stu ğ%d\n", 
¡©us
);

230 
£ù_buä
 = 
NULL
;

235 
‹xt_couÁ
 = 0;

236 
d©a_couÁ
 = 0;

237 
bss_couÁ
 = 0;

238 
lib_couÁ
 = 0;

240 
‹xt_£ù
 = 
NULL
;

241 
d©a_£ù
 = 
NULL
;

242 
bss_£ù
 = 
NULL
;

246 ià(
¡©us
 >= 0) {

247 
nIndex
;

248 
COFF_SCNHDR
 *
£ù_±r
 = 
£ù_buä
;

250 
nIndex
 = 0;‚Index < 
£ùiÚs
; ++nIndex) {

251 
£ù_æags
 = 
	`COFF_LONG
 (
£ù_±r
->
s_æags
);

253 
£ù_æags
) {

254 
COFF_STYP_TEXT
:

255 
‹xt_£ù
 = 
£ù_±r
;

256 ++
‹xt_couÁ
;

257 
¡©us
 = 
	`is_´İ”ly_®igÃd
 (
£ù_±r
);

260 
COFF_STYP_DATA
:

261 
d©a_£ù
 = 
£ù_±r
;

262 ++
d©a_couÁ
;

263 
¡©us
 = 
	`is_´İ”ly_®igÃd
 (
£ù_±r
);

266 
COFF_STYP_BSS
:

267 
bss_£ù
 = 
£ù_±r
;

268 ++
bss_couÁ
;

271 
COFF_STYP_LIB
:

272 #ifdeà
COFF_DEBUG


273 
	`´štk
 (".lib section found\n");

275 ++
lib_couÁ
;

281 
£ù_±r
 = (
COFF_SCNHDR
 *è& ((*è£ù_±r)[
COFF_SCNHSZ
];

288 ià(
‹xt_couÁ
 != 1) {

289 
¡©us
 = -
ENOEXEC
;

290 #ifdeà
COFF_DEBUG


291 
	`´štk
 ("noext sections\n");

295 ià(
lib_ok
) {

296 ià(
d©a_couÁ
 !ğ1 || 
bss_couÁ
 != 1) {

297 
¡©us
 = -
ENOEXEC
;

298 #ifdeà
COFF_DEBUG


299 
	`´štk
 ("no .data‚or .bss sections\n");

311 ià(
¡©us
 >= 0) {

312 ià(
aout_size
 == 0) {

313 ià(!
lib_ok
) {

314 
¡©us
 = -
ENOEXEC
;

315 #ifdeà
COFF_DEBUG


316 
	`´štk
 ("no header in†ibrary\n");

319 
¡¬t_addr
 = 
	`COFF_LONG
 (
‹xt_£ù
->
s_vaddr
);

325 ià(
aout_size
 < 
COFF_AOUTSZ
) {

326 
¡©us
 = -
ENOEXEC
;

327 #ifdeà
COFF_DEBUG


328 
	`´štk
 ("headeroo small\n");

332 
COFF_AOUTHDR
 *
aout_hdr
 =

333 (
COFF_AOUTHDR
 *è& ((*è
coff_hdr
)[
COFF_FILHSZ
];

334 
aout_magic
 = 
	`COFF_SHORT
 (
aout_hdr
->
magic
);

340 
aout_magic
) {

341 
COFF_OMAGIC
:

342 
COFF_ZMAGIC
:

343 
COFF_STMAGIC
:

344 ià(!
lib_ok
) {

345 
¡©us
 = -
ENOEXEC
;

346 #ifdeà
COFF_DEBUG


347 
	`´štk
 ("wrong‡.out header magic\n");

350 
¡¬t_addr
 = (è
	`COFF_LONG
 (
aout_hdr
->
’Œy
);

356 
COFF_SHMAGIC
:

357 ià(
lib_ok
) {

358 #ifdeà
COFF_DEBUG


359 
	`´štk
 ("wrong‡.out header magic\n");

361 
¡©us
 = -
ENOEXEC
;

366 #ifdeà
COFF_DEBUG


367 
	`´štk
 ("wrong‡.out header magic\n");

369 
¡©us
 = -
ENOEXEC
;

378 ià(
¡©us
 >= 0) {

379 
fd
 = 
	`İ’_šode
 (
b´m
->
šode
, 
O_RDONLY
);

380 ià(
fd
 < 0) {

381 #ifdeà
COFF_DEBUG


382 
	`´štk
 ("ÿÀnÙ o³Àšode,„esuÉ = %d\n", 
fd
);

384 
¡©us
 = 
fd
;

387 
å
 = 
cu¼’t
->
fp
[
fd
];

390 
fd
 = -1;

397 ià(
¡©us
 >= 0) {

398 
‹xt_sú±r
 = 
	`COFF_LONG
 (
‹xt_£ù
->
s_sú±r
);

399 
‹xt_size
 = 
	`COFF_LONG
 (
‹xt_£ù
->
s_size
);

400 
‹xt_vaddr
 = 
	`COFF_LONG
 (
‹xt_£ù
->
s_vaddr
);

402 
d©a_sú±r
;

403 
d©a_size
;

404 
d©a_vaddr
;

406 
bss_size
;

407 
bss_vaddr
;

411 ià(
d©a_£ù
 !ğ
NULL
) {

412 
d©a_sú±r
 = 
	`COFF_LONG
 (
d©a_£ù
->
s_sú±r
);

413 
d©a_size
 = 
	`COFF_LONG
 (
d©a_£ù
->
s_size
);

414 
d©a_vaddr
 = 
	`COFF_LONG
 (
d©a_£ù
->
s_vaddr
);

417 
d©a_sú±r
 = 0;

418 
d©a_size
 = 0;

419 
d©a_vaddr
 = 0;

424 ià(
bss_£ù
 !ğ
NULL
) {

425 
bss_size
 = 
	`COFF_LONG
 (
bss_£ù
->
s_size
);

426 
bss_vaddr
 = 
	`COFF_LONG
 (
bss_£ù
->
s_vaddr
);

429 
bss_size
 = 0;

430 
bss_vaddr
 = 0;

436 ià(
lib_ok
) {

437 #ifdeà
COFF_DEBUG


438 
	`´štk
 ("flushingƒxecutable\n");

440 
	`æush_Şd_exec
 (
b´m
);

444 
cu¼’t
->
mm­
 = 
NULL
;

445 
cu¼’t
->
rss
 = 0;

449 
b´m
->
p
 +ğ
	`chªge_ldt
 (0, b´m->
·ge
);

450 
b´m
->
p
 -ğ
MAX_ARG_PAGES
*
PAGE_SIZE
;

451 
b´m
->
p
 = (è
	`ü—‹_bËs
 ((*) bprm->p,

452 
b´m
->
¬gc
,

453 
b´m
->
’vc
,

458 
cu¼’t
->
¡¬t_code
 = 
‹xt_vaddr
 & 
PAGE_MASK
;

459 
cu¼’t
->
’d_code
 = 
‹xt_vaddr
 + 
‹xt_size
;

460 
cu¼’t
->
’d_d©a
 = 
d©a_vaddr
 + 
d©a_size
;

461 
cu¼’t
->
¡¬t_brk
 =

462 
cu¼’t
->
brk
 = 
bss_vaddr
 + 
bss_size
;

463 
cu¼’t
->
suid
 =

464 
cu¼’t
->
euid
 = 
b´m
->
e_uid
;

465 
cu¼’t
->
sgid
 =

466 
cu¼’t
->
egid
 = 
b´m
->
e_gid
;

467 
cu¼’t
->
execubË
 = 
b´m
->
šode
;

468 ++
b´m
->
šode
->
i_couÁ
;

469 
»gs
->
e
 = 
¡¬t_addr
;

470 
»gs
->
e¥
 =

471 
cu¼’t
->
¡¬t_¡ack
 = 
b´m
->
p
;

477 #ifdeà
COFF_DEBUG


478 
	`´štk
 (".text: vaddr = %d, size = %d, scnptr = %d\n",

479 
‹xt_vaddr
,

480 
‹xt_size
,

481 
‹xt_sú±r
);

483 
¡©us
 = 
	`do_mm­
 (
å
,

484 
‹xt_vaddr
 & 
PAGE_MASK
,

485 
‹xt_size
 + (
‹xt_vaddr
 & ~
PAGE_MASK
),

486 
PROT_READ
 | 
PROT_EXEC
,

487 
MAP_FIXED
 | 
MAP_SHARED
,

488 
‹xt_sú±r
 & 
PAGE_MASK
);

490 
¡©us
 = (¡©u =ğ(
‹xt_vaddr
 & 
PAGE_MASK
)è? 0 : -
ENOEXEC
;

494 ià(
¡©us
 >ğ0 && 
d©a_size
 != 0) {

495 #ifdeà
COFF_DEBUG


496 
	`´štk
 (".data: vaddr = %d, size = %d, scnptr = %d\n",

497 
d©a_vaddr
,

498 
d©a_size
,

499 
d©a_sú±r
);

501 
¡©us
 = 
	`do_mm­
 (
å
,

502 
d©a_vaddr
 & 
PAGE_MASK
,

503 
d©a_size
 + (
d©a_vaddr
 & ~
PAGE_MASK
),

504 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
,

505 
MAP_FIXED
 | 
MAP_PRIVATE
,

506 
d©a_sú±r
 & 
PAGE_MASK
);

508 
¡©us
 = (¡©u =ğ(
d©a_vaddr
 & 
PAGE_MASK
)è? 0 : -
ENOEXEC
;

515 ià(
¡©us
 >ğ0 && 
bss_size
 != 0) {

516 #ifdeà
COFF_DEBUG


517 
	`´štk
 (".bss: vaddr = %d, size = %d\n",

518 
bss_vaddr
,

519 
bss_size
);

521 
	`z”om­_·ge_¿nge
 (
	`PAGE_ALIGN
 (
bss_vaddr
),

522 
	`PAGE_ALIGN
 (
bss_size
),

523 
PAGE_COPY
);

525 
¡©us
 = 
	`ş—r_memÜy
 (
bss_vaddr
, 
bss_size
);

530 ià(
¡©us
 >ğ0 && 
lib_ok
 && 
lib_couÁ
 != 0) {

531 
nIndex
;

532 
COFF_SCNHDR
 *
£ù_±r
 = 
£ù_buä
;

538 
nIndex
 = 0;‚Index < 
£ùiÚs
; ++nIndex) {

539 
£ù_æags
 = 
	`COFF_LONG
 (
£ù_±r
->
s_æags
);

540 ià(
£ù_æags
 =ğ
COFF_STYP_LIB
) {

541 
¡©us
 = 
	`´–ßd_lib¿ry
 (
b´m
, 
£ù_±r
, 
å
);

542 ià(
¡©us
 != 0)

545 
£ù_±r
 = (
COFF_SCNHDR
 *è&((*è£ù_±rè[
COFF_SCNHSZ
];

555 ià(
lib_ok
) {

556 ià(
¡©us
 < 0)

557 
	`£nd_sig
 (
SIGSEGV
, 
cu¼’t
, 0);

559 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

560 
	`£nd_sig
 (
SIGTRAP
, 
cu¼’t
, 0);

562 
¡©us
 = 0;

568 ià(
fd
 >= 0)

569 
	`sys_şo£
 (
fd
);

571 ià(
£ù_buä
 !ğ
NULL
)

572 
	`kä“
 (
£ù_buä
);

576 #ifdeà
COFF_DEBUG


577 
	`´štk
 ("bšfmt_coff:„esuÉ = %d\n", 
¡©us
);

579  (
¡©us
);

580 
	}
}

589 
	$´–ßd_this_lib¿ry
 (
lšux_bš´m
 *
exe_b´m
, *
lib_Çme
)

591 
¡©us
;

592 
Şd_fs
 = 
	`g‘_fs
();

596 #ifdeà
COFF_DEBUG


597 
	`´štk
 ("%s†oading shared†ibrary %s\n",

598 
exe_b´m
->
f’ame
,

599 
lib_Çme
);

606 
	`£t_fs
 (
	`g‘_ds
 ());

607 
¡©us
 = 
	`sys_u£lib
 (
lib_Çme
);

608 
	`£t_fs
 (
Şd_fs
);

612  (
¡©us
);

613 
	}
}

621 
	$´–ßd_lib¿ry
 (
lšux_bš´m
 *
exe_b´m
,

622 
COFF_SCNHDR
 * 
£ù
, 
fe
 *
å
)

624 
¡©us
 = 0;

625 
nby‹s
;

630 
nby‹s
 = 
	`COFF_LONG
 (
£ù
->
s_size
);

631 ià(
nby‹s
 < 
COFF_SLIBSZ
) {

632 
¡©us
 = -
ENOEXEC
;

633 #ifdeà
COFF_DEBUG


634 
	`´štk
 ("library sectionoo small\n");

641 
COFF_SLIBHD
 *
phdr
;

642 *
bufãr
 = (*è
	`km®loc
 (
nby‹s
, 
GFP_KERNEL
);

644 ià(0 =ğ
bufãr
) {

645 
¡©us
 = -
ENOEXEC
;

646 #ifdeà
COFF_DEBUG


647 
	`´štk
 ("kmalloc failed\n");

651 
Şd_fs
 = 
	`g‘_fs
 ();

655 
	`£t_fs
 (
	`g‘_ds
 ());

656 
¡©us
 = 
	`»ad_exec
 (
exe_b´m
->
šode
,

657 
	`COFF_LONG
 (
£ù
->
s_sú±r
),

658 
bufãr
,

659 
nby‹s
);

660 
	`£t_fs
 (
Şd_fs
);

664 ià(
¡©us
 >ğ0 && stu !ğ
nby‹s
) {

665 #ifdeà
COFF_DEBUG


666 
	`´štk
 ("read of†ib section was short\n");

668 
¡©us
 = -
ENOEXEC
;

674 
phdr
 = (
COFF_SLIBHD
 *è
bufãr
;

675 
¡©us
 >ğ0 && 
nby‹s
 > 
COFF_SLIBSZ
) {

676 
’Œy_size
 = 
	`COFF_LONG
 (
phdr
->
¦_’tsz
) *  ();

677 
h—d”_size
 = 
	`COFF_LONG
 (
phdr
->
¦_·thndx
) *  ();

681 ià((è
h—d”_size
 >ğ(è
nby‹s
 ||

682 
’Œy_size
 <= 0 ||

683 (è
’Œy_size
 <ğ(è
h—d”_size
) {

684 
¡©us
 = -
ENOEXEC
;

685 #ifdeà
COFF_DEBUG


686 
	`´štk
 ("header count is invalid\n");

693 
¡©us
 = 
	`´–ßd_this_lib¿ry
 (
exe_b´m
,

694 &((*è
phdr
)[
h—d”_size
]);

695 #ifdeà
COFF_DEBUG


696 
	`´štk
 ("´–ßd_this_lib¿ry„esuÉ = %d\n", 
¡©us
);

702 
nby‹s
 -ğ
’Œy_size
;

703 
phdr
 = (
COFF_SLIBHD
 *è&((*èphdr)[
’Œy_size
];

708 ià(
bufãr
 !ğ
NULL
)

709 
	`kä“
 (
bufãr
);

714  (
¡©us
);

715 
	}
}

725 
	$lßd_coff_bš¬y
 (
lšux_bš´m
 *
b´m
, 
±_»gs
 *
»gs
)

727  (
	`lßd_objeù
 (
b´m
, 
»gs
, 1));

728 
	}
}

737 
	$lßd_coff_lib¿ry
 (
fd
)

739 
lšux_bš´m
 *
b´m
;

740 
¡©us
;

744 
b´m
 = (
lšux_bš´m
 *è
	`km®loc
 ( (linux_binprm),

745 
GFP_KERNEL
);

746 ià(0 =ğ
b´m
) {

747 #ifdeà
COFF_DEBUG


748 
	`´štk
 ("kmalloc failed\n");

750 
¡©us
 = -
ENOEXEC
;

753 
fe
 *file;

754 
±_»gs
 
»gs
;

755 
Şd_fs
 = 
	`g‘_fs
 ();

757 
	`mem£t
 (
b´m
, '\0',  (
lšux_bš´m
));

759 
fe
 = 
cu¼’t
->
fp
[
fd
];

760 
b´m
->
šode
 = 
fe
->
f_šode
;

761 
b´m
->
f’ame
 = "";

765 
	`£t_fs
 (
	`g‘_ds
 ());

766 
¡©us
 = 
	`»ad_exec
 (
b´m
->
šode
,

768 
b´m
->
buf
,

769  (
b´m
->
buf
));

770 
	`£t_fs
 (
Şd_fs
);

774 
¡©us
 = 
	`lßd_objeù
 (
b´m
, &
»gs
, 0);

778 
	`kä“
 (
b´m
);

783  (
¡©us
);

784 
	}
}

	@fs/binfmt_elf.c

4 
	~<lšux/fs.h
>

5 
	~<lšux/sched.h
>

6 
	~<lšux/mm.h
>

7 
	~<lšux/mmª.h
>

8 
	~<lšux/a.out.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sigÇl.h
>

11 
	~<lšux/bšfmts.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/fú.h
>

14 
	~<lšux/±¿û.h
>

15 
	~<lšux/m®loc.h
>

16 
	~<lšux/shm.h
>

18 
	~<asm/£gm’t.h
>

20 
asmlškage
 
sys_ex™
(
ex™_code
);

21 
asmlškage
 
sys_şo£
(
fd
);

22 
asmlškage
 
sys_İ’
(const *, , );

23 
asmlškage
 
sys_brk
();

25 
	#DLINFO_ITEMS
 8

	)

27 
	~<lšux/–f.h
>

34 
	$·dz”o
(
–f_bss
){

35 
åÁ
, 
nby‹
;

37 if(
–f_bss
 & 0xfff) {

39 
nby‹
 = (
PAGE_SIZE
 - (
–f_bss
 & 0xfff)) & 0xfff;

40 if(
nby‹
){

41 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
–f_bss
, 
nby‹
);

43 
åÁ
 = 
–f_bss
;

44 
åÁ
 & 0xfffè
	`put_fs_by‹
(0, fpnt++);

47 
	}
}

49 * 
	$ü—‹_–f_bËs
(* 
p
,
¬gc
,
’vc
,
–fhdr
 * 
exec
, 
lßd_addr
, 
ibcs
)

51 *
¬gv
,*
’vp
, *
dlšfo
;

52 * 
¥
;

53 
vm_¬—_¡ruù
 *
m²t
;

55 
m²t
 = (
vm_¬—_¡ruù
 *)
	`km®loc
((*m²t), 
GFP_KERNEL
);

56 ià(
m²t
) {

57 
m²t
->
vm_sk
 = 
cu¼’t
;

58 
m²t
->
vm_¡¬t
 = 
PAGE_MASK
 & (è
p
;

59 
m²t
->
vm_’d
 = 
TASK_SIZE
;

60 
m²t
->
vm_·ge_´Ù
 = 
PAGE_PRIVATE
|
PAGE_DIRTY
;

61 
m²t
->
vm_sh¬e
 = 
NULL
;

62 
m²t
->
vm_šode
 = 
NULL
;

63 
m²t
->
vm_off£t
 = 0;

64 
m²t
->
vm_İs
 = 
NULL
;

65 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

66 
cu¼’t
->
¡k_vma
 = 
m²t
;

68 
¥
 = (*è(0xfffffffø& (è
p
);

69 if(
exec
è
¥
 -ğ
DLINFO_ITEMS
*2;

70 
dlšfo
 = 
¥
;

71 
¥
 -ğ
’vc
+1;

72 
’vp
 = 
¥
;

73 
¥
 -ğ
¬gc
+1;

74 
¬gv
 = 
¥
;

75 ià(!
ibcs
) {

76 
	`put_fs_lÚg
(()
’vp
,--
¥
);

77 
	`put_fs_lÚg
(()
¬gv
,--
¥
);

83 if(
exec
) {

84 
–f_phdr
 * 
•²t
;

85 
•²t
 = (
–f_phdr
 *è
exec
->
e_phoff
;

86 
	`put_fs_lÚg
(3,
dlšfo
++);…ut_fs_lÚg(
lßd_addr
 + 
exec
->
e_phoff
,dlinfo++);

87 
	`put_fs_lÚg
(4,
dlšfo
++);…ut_fs_lÚg((
–f_phdr
),dlinfo++);

88 
	`put_fs_lÚg
(5,
dlšfo
++);…ut_fs_lÚg(
exec
->
e_phnum
,dlinfo++);

89 
	`put_fs_lÚg
(9,
dlšfo
++);…ut_fs_lÚg((è
exec
->
e_’Œy
,dlinfo++);

90 
	`put_fs_lÚg
(7,
dlšfo
++);…ut_fs_lÚg(
SHM_RANGE_START
,dlinfo++);

91 
	`put_fs_lÚg
(8,
dlšfo
++);…ut_fs_long(0,dlinfo++);

92 
	`put_fs_lÚg
(6,
dlšfo
++);…ut_fs_lÚg(
PAGE_SIZE
,dlinfo++);

93 
	`put_fs_lÚg
(0,
dlšfo
++);…ut_fs_long(0,dlinfo++);

96 
	`put_fs_lÚg
(()
¬gc
,--
¥
);

97 
cu¼’t
->
¬g_¡¬t
 = (è
p
;

98 
¬gc
-->0) {

99 
	`put_fs_lÚg
((è
p
,
¬gv
++);

100 
	`g‘_fs_by‹
(
p
++)) ;

102 
	`put_fs_lÚg
(0,
¬gv
);

103 
cu¼’t
->
¬g_’d
 = cu¼’t->
’v_¡¬t
 = (è
p
;

104 
’vc
-->0) {

105 
	`put_fs_lÚg
((è
p
,
’vp
++);

106 
	`g‘_fs_by‹
(
p
++)) ;

108 
	`put_fs_lÚg
(0,
’vp
);

109 
cu¼’t
->
’v_’d
 = (è
p
;

110  
¥
;

111 
	}
}

119 
	$lßd_–f_š‹½
(
–fhdr
 * 
š‹½_–f_ex
,

120 
šode
 * 
š‹½»‹r_šode
)

122 
fe
 * file;

123 
–f_phdr
 *
–f_phd©a
 = 
NULL
;

124 
–f_phdr
 *
•²t
;

125 
Ën
;

126 
lßd_addr
;

127 
–f_exec_f’o
;

128 
–f_bss
;

129 
Şd_fs
, 
»tv®
;

130 
Ï¡_bss
;

131 
”rÜ
;

132 
i
, 
k
;

134 
–f_bss
 = 0;

135 
Ï¡_bss
 = 0;

136 
”rÜ
 = 
lßd_addr
 = 0;

139 if((
š‹½_–f_ex
->
e_ty³
 !ğ
ET_EXEC
 &&

140 
š‹½_–f_ex
->
e_ty³
 !ğ
ET_DYN
) ||

141 (
š‹½_–f_ex
->
e_machše
 !ğ
EM_386
 && iÁ”p_–f_ex->e_machš!ğ
EM_486
) ||

142 (!
š‹½»‹r_šode
->
i_İ
 || !š‹½»‹r_šode->i_İ->
bm­
 ||

143 !
š‹½»‹r_šode
->
i_İ
->
deçuÉ_fe_İs
->
mm­
)){

149 if((
–f_phdr
è* 
š‹½_–f_ex
->
e_phnum
 > 
PAGE_SIZE
)

152 
–f_phd©a
 = (
–f_phdr
 *)

153 
	`km®loc
((
–f_phdr
è* 
š‹½_–f_ex
->
e_phnum
, 
GFP_KERNEL
);

154 if(!
–f_phd©a
)  0xffffffff;

156 
Şd_fs
 = 
	`g‘_fs
();

157 
	`£t_fs
(
	`g‘_ds
());

158 
»tv®
 = 
	`»ad_exec
(
š‹½»‹r_šode
, 
š‹½_–f_ex
->
e_phoff
, (*è
–f_phd©a
,

159 (
–f_phdr
è* 
š‹½_–f_ex
->
e_phnum
);

160 
	`£t_fs
(
Şd_fs
);

162 
–f_exec_f’o
 = 
	`İ’_šode
(
š‹½»‹r_šode
, 
O_RDONLY
);

163 ià(
–f_exec_f’o
 < 0)  0xffffffff;

164 
fe
 = 
cu¼’t
->
fp
[
–f_exec_f’o
];

166 
•²t
 = 
–f_phd©a
;

167 
i
=0; i<
š‹½_–f_ex
->
e_phnum
; i++, 
•²t
++)

168 if(
•²t
->
p_ty³
 =ğ
PT_LOAD
) {

169 
”rÜ
 = 
	`do_mm­
(
fe
,

170 
•²t
->
p_vaddr
 & 0xfffff000,

171 
•²t
->
p_fesz
 + (•²t->
p_vaddr
 & 0xfff),

172 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
,

173 
MAP_PRIVATE
 | (
š‹½_–f_ex
->
e_ty³
 =ğ
ET_EXEC
 ? 
MAP_FIXED
 : 0),

174 
•²t
->
p_off£t
 & 0xfffff000);

176 if(!
lßd_addr
 && 
š‹½_–f_ex
->
e_ty³
 =ğ
ET_DYN
)

177 
lßd_addr
 = 
”rÜ
;

178 
k
 = 
lßd_addr
 + 
•²t
->
p_vaddr
 +ƒµÁ->
p_fesz
;

179 if(
k
 > 
–f_bss
)ƒlf_bss = k;

180 if(
”rÜ
 < 0 &&ƒrror > -1024) ;

181 
k
 = 
lßd_addr
 + 
•²t
->
p_memsz
 +ƒµÁ->
p_vaddr
;

182 if(
k
 > 
Ï¡_bss
)†ast_bss = k;

188 
	`sys_şo£
(
–f_exec_f’o
);

189 if(
”rÜ
 < 0 &&ƒrror > -1024) {

190 
	`kä“
(
–f_phd©a
);

194 
	`·dz”o
(
–f_bss
);

195 
Ën
 = (
–f_bss
 + 0xfff) & 0xfffff000;

198 ià(
Ï¡_bss
 > 
Ën
)

199 
	`do_mm­
(
NULL
, 
Ën
, 
Ï¡_bss
-len,

200 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

201 
MAP_FIXED
|
MAP_PRIVATE
, 0);

202 
	`kä“
(
–f_phd©a
);

204  ((è
š‹½_–f_ex
->
e_’Œy
è+ 
lßd_addr
;

205 
	}
}

207 
	$lßd_aout_š‹½
(
exec
 * 
š‹½_ex
,

208 
šode
 * 
š‹½»‹r_šode
)

210 
»tv®
;

211 
–f_’Œy
;

213 
cu¼’t
->
brk
 = 
š‹½_ex
->
a_bss
 +

214 (
cu¼’t
->
’d_d©a
 = 
š‹½_ex
->
a_d©a
 +

215 (
cu¼’t
->
’d_code
 = 
š‹½_ex
->
a_‹xt
));

216 
–f_’Œy
 = 
š‹½_ex
->
a_’Œy
;

219 ià(
	`N_MAGIC
(*
š‹½_ex
è=ğ
OMAGIC
) {

220 
	`do_mm­
(
NULL
, 0, 
š‹½_ex
->
a_‹xt
+š‹½_ex->
a_d©a
,

221 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

222 
MAP_FIXED
|
MAP_PRIVATE
, 0);

223 
»tv®
 = 
	`»ad_exec
(
š‹½»‹r_šode
, 32, (*) 0,

224 
š‹½_ex
->
a_‹xt
+š‹½_ex->
a_d©a
);

225 } ià(
	`N_MAGIC
(*
š‹½_ex
è=ğ
ZMAGIC
 || N_MAGIC(*š‹½_exè=ğ
QMAGIC
) {

226 
	`do_mm­
(
NULL
, 0, 
š‹½_ex
->
a_‹xt
+š‹½_ex->
a_d©a
,

227 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

228 
MAP_FIXED
|
MAP_PRIVATE
, 0);

229 
»tv®
 = 
	`»ad_exec
(
š‹½»‹r_šode
,

230 
	`N_TXTOFF
(*
š‹½_ex
) ,

231 (*è
	`N_TXTADDR
(*
š‹½_ex
),

232 
š‹½_ex
->
a_‹xt
+š‹½_ex->
a_d©a
);

234 
»tv®
 = -1;

236 if(
»tv®
 >= 0)

237 
	`do_mm­
(
NULL
, (
š‹½_ex
->
a_‹xt
 + iÁ”p_ex->
a_d©a
 + 0xfff) &

238 0xfffff000, 
š‹½_ex
->
a_bss
,

239 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

240 
MAP_FIXED
|
MAP_PRIVATE
, 0);

241 if(
»tv®
 < 0)  0xffffffff;

242  
–f_’Œy
;

243 
	}
}

250 
	#INTERPRETER_NONE
 0

	)

251 
	#INTERPRETER_AOUT
 1

	)

252 
	#INTERPRETER_ELF
 2

	)

254 
	$lßd_–f_bš¬y
(
lšux_bš´m
 * 
b´m
, 
±_»gs
 * 
»gs
)

256 
–fhdr
 
–f_ex
;

257 
–fhdr
 
š‹½_–f_ex
;

258 
fe
 * file;

259 
exec
 
š‹½_ex
;

260 
šode
 *
š‹½»‹r_šode
;

261 
lßd_addr
;

262 
š‹½»‹r_ty³
 = 
INTERPRETER_NONE
;

263 
i
;

264 
Şd_fs
;

265 
”rÜ
;

266 
–f_phdr
 * 
–f_µÁ
, *
–f_phd©a
;

267 
–f_exec_f’o
;

268 
–f_bss
, 
k
, 
–f_brk
;

269 
»tv®
;

270 * 
–f_š‹½»‹r
;

271 
–f_’Œy
;

272 
¡©us
;

273 
¡¬t_code
, 
’d_code
, 
’d_d©a
;

274 
–f_¡ack
;

275 
·s£d_f’o
[6];

277 
¡©us
 = 0;

278 
lßd_addr
 = 0;

279 
–f_ex
 = *((
–fhdr
 *è
b´m
->
buf
);

281 ià(
–f_ex
.
e_id’t
[0] != 0x7f ||

282 
	`¡ºcmp
(&
–f_ex
.
e_id’t
[1], "ELF",3) != 0)

283  -
ENOEXEC
;

287 if(
–f_ex
.
e_ty³
 !ğ
ET_EXEC
 ||

288 (
–f_ex
.
e_machše
 !ğ
EM_386
 &&ƒlf_ex.e_machš!ğ
EM_486
) ||

289 (!
b´m
->
šode
->
i_İ
 || !b´m->šode->i_İ->
deçuÉ_fe_İs
 ||

290 !
b´m
->
šode
->
i_İ
->
deçuÉ_fe_İs
->
mm­
)){

291  -
ENOEXEC
;

296 
–f_phd©a
 = (
–f_phdr
 *è
	`km®loc
(
–f_ex
.
e_ph’tsize
 *

297 
–f_ex
.
e_phnum
, 
GFP_KERNEL
);

299 
Şd_fs
 = 
	`g‘_fs
();

300 
	`£t_fs
(
	`g‘_ds
());

301 
»tv®
 = 
	`»ad_exec
(
b´m
->
šode
, 
–f_ex
.
e_phoff
, (*è
–f_phd©a
,

302 
–f_ex
.
e_ph’tsize
 *ƒlf_ex.
e_phnum
);

303 
	`£t_fs
(
Şd_fs
);

304 ià(
»tv®
 < 0) {

305 
	`kä“
 (
–f_phd©a
);

306  
»tv®
;

309 
–f_µÁ
 = 
–f_phd©a
;

311 
–f_bss
 = 0;

312 
–f_brk
 = 0;

314 
–f_exec_f’o
 = 
	`İ’_šode
(
b´m
->
šode
, 
O_RDONLY
);

316 ià(
–f_exec_f’o
 < 0) {

317 
	`kä“
 (
–f_phd©a
);

318  
–f_exec_f’o
;

321 
fe
 = 
cu¼’t
->
fp
[
–f_exec_f’o
];

323 
–f_¡ack
 = 0xffffffff;

324 
–f_š‹½»‹r
 = 
NULL
;

325 
¡¬t_code
 = 0;

326 
’d_code
 = 0;

327 
’d_d©a
 = 0;

329 
Şd_fs
 = 
	`g‘_fs
();

330 
	`£t_fs
(
	`g‘_ds
());

332 
i
=0;˜< 
–f_ex
.
e_phnum
; i++){

333 if(
–f_µÁ
->
p_ty³
 =ğ
PT_INTERP
) {

337 
–f_š‹½»‹r
 = (*è
	`km®loc
(
–f_µÁ
->
p_fesz
,

338 
GFP_KERNEL
);

340 
»tv®
 = 
	`»ad_exec
(
b´m
->
šode
,
–f_µÁ
->
p_off£t
,
–f_š‹½»‹r
,

341 
–f_µÁ
->
p_fesz
);

343 
	`´štk
("Usšg ELF iÁ”´‘” %s\n", 
–f_š‹½»‹r
);

345 if(
»tv®
 >= 0)

346 
»tv®
 = 
	`Çmei
(
–f_š‹½»‹r
, &
š‹½»‹r_šode
);

347 if(
»tv®
 >= 0)

348 
»tv®
 = 
	`»ad_exec
(
š‹½»‹r_šode
,0,
b´m
->
buf
,128);

350 if(
»tv®
 >= 0){

351 
š‹½_ex
 = *((
exec
 *è
b´m
->
buf
);

352 
š‹½_–f_ex
 = *((
–fhdr
 *è
b´m
->
buf
);

355 if(
»tv®
 < 0) {

356 
	`kä“
 (
–f_phd©a
);

357 
	`kä“
(
–f_š‹½»‹r
);

358  
»tv®
;

361 
–f_µÁ
++;

364 
	`£t_fs
(
Şd_fs
);

367 if(
–f_š‹½»‹r
){

368 
š‹½»‹r_ty³
 = 
INTERPRETER_ELF
 | 
INTERPRETER_AOUT
;

369 if(
»tv®
 < 0) {

370 
	`kä“
(
–f_š‹½»‹r
);

371 
	`kä“
(
–f_phd©a
);

372  -
ELIBACC
;

375 if((
	`N_MAGIC
(
š‹½_ex
è!ğ
OMAGIC
) &&

376 (
	`N_MAGIC
(
š‹½_ex
è!ğ
ZMAGIC
) &&

377 (
	`N_MAGIC
(
š‹½_ex
è!ğ
QMAGIC
))

378 
š‹½»‹r_ty³
 = 
INTERPRETER_ELF
;

380 ià(
š‹½_–f_ex
.
e_id’t
[0] != 0x7f ||

381 
	`¡ºcmp
(&
š‹½_–f_ex
.
e_id’t
[1], "ELF",3) != 0)

382 
š‹½»‹r_ty³
 &ğ~
INTERPRETER_ELF
;

384 if(!
š‹½»‹r_ty³
)

386 
	`kä“
(
–f_š‹½»‹r
);

387 
	`kä“
(
–f_phd©a
);

388  -
ELIBBAD
;

395 ià(!
b´m
->
sh_bªg
) {

396 * 
·s£d_p
;

398 if(
š‹½»‹r_ty³
 =ğ
INTERPRETER_AOUT
) {

399 
	`¥rštf
(
·s£d_f’o
, "%d", 
–f_exec_f’o
);

400 
·s£d_p
 = 
·s£d_f’o
;

402 if(
–f_š‹½»‹r
) {

403 
b´m
->
p
 = 
	`cİy_¡ršgs
(1,&
·s£d_p
,b´m->
·ge
,bprm->p,2);

404 
b´m
->
¬gc
++;

407 ià(!
b´m
->
p
) {

408 if(
–f_š‹½»‹r
) {

409 
	`kä“
(
–f_š‹½»‹r
);

411 
	`kä“
 (
–f_phd©a
);

412  -
E2BIG
;

417 
	`æush_Şd_exec
(
b´m
);

419 
cu¼’t
->
’d_d©a
 = 0;

420 
cu¼’t
->
’d_code
 = 0;

421 
cu¼’t
->
¡¬t_mm­
 = 
ELF_START_MMAP
;

422 
cu¼’t
->
mm­
 = 
NULL
;

423 
–f_’Œy
 = (è
–f_ex
.
e_’Œy
;

427 
cu¼’t
->
rss
 = 0;

428 
b´m
->
p
 +ğ
	`chªge_ldt
(0, b´m->
·ge
);

429 
cu¼’t
->
¡¬t_¡ack
 = 
b´m
->
p
;

436 
Şd_fs
 = 
	`g‘_fs
();

437 
	`£t_fs
(
	`g‘_ds
());

439 
–f_µÁ
 = 
–f_phd©a
;

440 
i
=0;˜< 
–f_ex
.
e_phnum
; i++){

442 if(
–f_µÁ
->
p_ty³
 =ğ
PT_INTERP
) {

445 
	`£t_fs
(
Şd_fs
);

447 if(
š‹½»‹r_ty³
 & 1è
–f_’Œy
 =

448 
	`lßd_aout_š‹½
(&
š‹½_ex
, 
š‹½»‹r_šode
);

450 if(
š‹½»‹r_ty³
 & 2è
–f_’Œy
 =

451 
	`lßd_–f_š‹½
(&
š‹½_–f_ex
, 
š‹½»‹r_šode
);

453 
Şd_fs
 = 
	`g‘_fs
();

454 
	`£t_fs
(
	`g‘_ds
());

456 
	`ut
(
š‹½»‹r_šode
);

457 
	`kä“
(
–f_š‹½»‹r
);

459 if(
–f_’Œy
 == 0xffffffff) {

460 
	`´štk
("Unableo†oad interpreter\n");

461 
	`kä“
(
–f_phd©a
);

462 
	`£nd_sig
(
SIGSEGV
, 
cu¼’t
, 0);

468 if(
–f_µÁ
->
p_ty³
 =ğ
PT_LOAD
) {

469 
”rÜ
 = 
	`do_mm­
(
fe
,

470 
–f_µÁ
->
p_vaddr
 & 0xfffff000,

471 
–f_µÁ
->
p_fesz
 + (–f_µÁ->
p_vaddr
 & 0xfff),

472 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
,

473 
MAP_FIXED
 | 
MAP_PRIVATE
,

474 
–f_µÁ
->
p_off£t
 & 0xfffff000);

476 #ifdeà
LOW_ELF_STACK


477 if(
–f_µÁ
->
p_vaddr
 & 0xfffff000 < 
–f_¡ack
)

478 
–f_¡ack
 = 
–f_µÁ
->
p_vaddr
 & 0xfffff000;

481 if(!
lßd_addr
)

482 
lßd_addr
 = 
–f_µÁ
->
p_vaddr
 -ƒlf_µÁ->
p_off£t
;

483 
k
 = 
–f_µÁ
->
p_vaddr
;

484 if(
k
 > 
¡¬t_code
) start_code = k;

485 
k
 = 
–f_µÁ
->
p_vaddr
 +ƒlf_µÁ->
p_fesz
;

486 if(
k
 > 
–f_bss
)ƒlf_bss = k;

487 if((
–f_µÁ
->
p_æags
 | 
PROT_WRITE
è&& 
’d_code
 < 
k
)

488 
’d_code
 = 
k
;

489 if(
’d_d©a
 < 
k
)ƒnd_data = k;

490 
k
 = 
–f_µÁ
->
p_vaddr
 +ƒlf_µÁ->
p_memsz
;

491 if(
k
 > 
–f_brk
)ƒlf_brk = k;

493 
–f_µÁ
++;

495 
	`£t_fs
(
Şd_fs
);

497 
	`kä“
(
–f_phd©a
);

499 if(!
–f_š‹½»‹r
è
	`sys_şo£
(
–f_exec_f’o
);

500 
cu¼’t
->
–f_execubË
 = 1;

501 
cu¼’t
->
execubË
 = 
b´m
->
šode
;

502 
b´m
->
šode
->
i_couÁ
++;

503 #ifdeà
LOW_ELF_STACK


504 
cu¼’t
->
¡¬t_¡ack
 = 
p
 = 
–f_¡ack
 - 4;

506 
b´m
->
p
 -ğ
MAX_ARG_PAGES
*
PAGE_SIZE
;

507 
b´m
->
p
 = ()

508 
	`ü—‹_–f_bËs
((*)
b´m
->
p
,

509 
b´m
->
¬gc
,

510 
b´m
->
’vc
,

511 (
š‹½»‹r_ty³
 =ğ
INTERPRETER_ELF
 ? &
–f_ex
 : 
NULL
),

512 
lßd_addr
,

513 (
š‹½»‹r_ty³
 =ğ
INTERPRETER_AOUT
 ? 0 : 1));

514 if(
š‹½»‹r_ty³
 =ğ
INTERPRETER_AOUT
)

515 
cu¼’t
->
¬g_¡¬t
 +ğ
	`¡¾’
(
·s£d_f’o
) + 1;

516 
cu¼’t
->
¡¬t_brk
 = cu¼’t->
brk
 = 
–f_brk
;

517 
cu¼’t
->
’d_code
 =ƒnd_code;

518 
cu¼’t
->
¡¬t_code
 = start_code;

519 
cu¼’t
->
’d_d©a
 =ƒnd_data;

520 
cu¼’t
->
¡¬t_¡ack
 = 
b´m
->
p
;

521 
cu¼’t
->
suid
 = cu¼’t->
euid
 = 
b´m
->
e_uid
;

522 
cu¼’t
->
sgid
 = cu¼’t->
egid
 = 
b´m
->
e_gid
;

526 
cu¼’t
->
brk
 = (
–f_bss
 + 0xfff) & 0xfffff000;

527 
	`sys_brk
((
–f_brk
 + 0xfff) & 0xfffff000);

529 
	`·dz”o
(
–f_bss
);

535 
”rÜ
 = 
	`do_mm­
(
NULL
, 0, 4096, 
PROT_READ
 | 
PROT_EXEC
,

536 
MAP_FIXED
 | 
MAP_PRIVATE
, 0);

538 
»gs
->
e
 = 
–f_’Œy
;

539 
»gs
->
e¥
 = 
b´m
->
p
;

540 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

541 
	`£nd_sig
(
SIGTRAP
, 
cu¼’t
, 0);

543 
	}
}

548 
	$lßd_–f_lib¿ry
(
fd
){

549 
fe
 * file;

550 
–fhdr
 
–f_ex
;

551 
–f_phdr
 *
–f_phd©a
 = 
NULL
;

552 
šode
 * inode;

553 
Ën
;

554 
–f_bss
;

555 
Şd_fs
, 
»tv®
;

556 
bss
;

557 
”rÜ
;

558 
i
,
j
, 
k
;

560 
Ën
 = 0;

561 
fe
 = 
cu¼’t
->
fp
[
fd
];

562 
šode
 = 
fe
->
f_šode
;

563 
–f_bss
 = 0;

565 
	`£t_fs
(
KERNEL_DS
);

566 ià(
fe
->
f_İ
->
	`»ad
(
šode
, fe, (*è&
–f_ex
, (elf_ex)) != (elf_ex)) {

567 
	`sys_şo£
(
fd
);

568  -
EACCES
;

570 
	`£t_fs
(
USER_DS
);

572 ià(
–f_ex
.
e_id’t
[0] != 0x7f ||

573 
	`¡ºcmp
(&
–f_ex
.
e_id’t
[1], "ELF",3) != 0)

574  -
ENOEXEC
;

577 if(
–f_ex
.
e_ty³
 !ğ
ET_EXEC
 ||ƒlf_ex.
e_phnum
 > 2 ||

578 (
–f_ex
.
e_machše
 !ğ
EM_386
 &&ƒlf_ex.e_machš!ğ
EM_486
) ||

579 (!
šode
->
i_İ
 || !šode->i_İ->
bm­
 ||

580 !
šode
->
i_İ
->
deçuÉ_fe_İs
->
mm­
)){

581  -
ENOEXEC
;

586 if((
–f_phdr
è* 
–f_ex
.
e_phnum
 > 
PAGE_SIZE
)

587  -
ENOEXEC
;

589 
–f_phd©a
 = (
–f_phdr
 *)

590 
	`km®loc
((
–f_phdr
è* 
–f_ex
.
e_phnum
, 
GFP_KERNEL
);

592 
Şd_fs
 = 
	`g‘_fs
();

593 
	`£t_fs
(
	`g‘_ds
());

594 
»tv®
 = 
	`»ad_exec
(
šode
, 
–f_ex
.
e_phoff
, (*è
–f_phd©a
,

595 (
–f_phdr
è* 
–f_ex
.
e_phnum
);

596 
	`£t_fs
(
Şd_fs
);

598 
j
 = 0;

599 
i
=0; i<
–f_ex
.
e_phnum
; i++)

600 if((
–f_phd©a
 + 
i
)->
p_ty³
 =ğ
PT_LOAD
è
j
++;

602 if(
j
 != 1) {

603 
	`kä“
(
–f_phd©a
);

604  -
ENOEXEC
;

607 
–f_phd©a
->
p_ty³
 !ğ
PT_LOAD
)ƒlf_phdata++;

610 
”rÜ
 = 
	`do_mm­
(
fe
,

611 
–f_phd©a
->
p_vaddr
 & 0xfffff000,

612 
–f_phd©a
->
p_fesz
 + (–f_phd©a->
p_vaddr
 & 0xfff),

613 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
,

614 
MAP_FIXED
 | 
MAP_PRIVATE
,

615 
–f_phd©a
->
p_off£t
 & 0xfffff000);

617 
k
 = 
–f_phd©a
->
p_vaddr
 +ƒlf_phd©a->
p_fesz
;

618 if(
k
 > 
–f_bss
)ƒlf_bss = k;

620 
	`sys_şo£
(
fd
);

621 ià(
”rÜ
 !ğ
–f_phd©a
->
p_vaddr
 & 0xfffff000) {

622 
	`kä“
(
–f_phd©a
);

623  
”rÜ
;

626 
	`·dz”o
(
–f_bss
);

628 
Ën
 = (
–f_phd©a
->
p_fesz
 +ƒlf_phd©a->
p_vaddr
+ 0xfff) & 0xfffff000;

629 
bss
 = 
–f_phd©a
->
p_memsz
 +ƒlf_phd©a->
p_vaddr
;

630 ià(
bss
 > 
Ën
)

631 
	`do_mm­
(
NULL
, 
Ën
, 
bss
-len,

632 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

633 
MAP_FIXED
|
MAP_PRIVATE
, 0);

634 
	`kä“
(
–f_phd©a
);

636 
	}
}

	@fs/block_dev.c

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/locks.h
>

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

14 *
blk_size
[];

15 *
blksize_size
[];

17 
	$block_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

19 
blocksize
, 
blocksize_b™s
, 
i
;

20 
block
;

21 
off£t
;

22 
ch¬s
;

23 
wr™‹n
 = 0;

24 
size
;

25 
dev
;

26 
bufãr_h—d
 * 
bh
;

27 * 
p
;

29 
dev
 = 
šode
->
i_rdev
;

30 
blocksize
 = 
BLOCK_SIZE
;

31 ià(
blksize_size
[
	`MAJOR
(
dev
)] && blksize_size[MAJOR(dev)][
	`MINOR
(dev)])

32 
blocksize
 = 
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)];

34 
i
 = 
blocksize
;

35 
blocksize_b™s
 = 0;

36 
i
 != 1) {

37 
blocksize_b™s
++;

38 
i
 >>= 1;

41 
block
 = 
fp
->
f_pos
 >> 
blocksize_b™s
;

42 
off£t
 = 
fp
->
f_pos
 & (
blocksize
-1);

44 ià(
blk_size
[
	`MAJOR
(
dev
)])

45 
size
 = (
blk_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] << 
BLOCK_SIZE_BITS
è>> 
blocksize_b™s
;

47 
size
 = 
INT_MAX
;

48 
couÁ
>0) {

49 ià(
block
 >ğ
size
)

50  
wr™‹n
;

51 
ch¬s
 = 
blocksize
 - 
off£t
;

52 ià(
ch¬s
 > 
couÁ
)

53 
ch¬s
=
couÁ
;

54 ià(
ch¬s
 =ğ
blocksize
)

55 
bh
 = 
	`g‘blk
(
dev
, 
block
, 
blocksize
);

57 
bh
 = 
	`b»ada
(
dev
,
block
,block+1,block+2,-1);

58 
block
++;

59 ià(!
bh
)

60  
wr™‹n
?wr™‹n:-
EIO
;

61 
p
 = 
off£t
 + 
bh
->
b_d©a
;

62 
off£t
 = 0;

63 
fp
->
f_pos
 +ğ
ch¬s
;

64 
wr™‹n
 +ğ
ch¬s
;

65 
couÁ
 -ğ
ch¬s
;

66 
	`memıy_äomfs
(
p
,
buf
,
ch¬s
);

67 
p
 +ğ
ch¬s
;

68 
buf
 +ğ
ch¬s
;

69 
bh
->
b_u±od©e
 = 1;

70 
bh
->
b_dœt
 = 1;

71 
	`b»l£
(
bh
);

73  
wr™‹n
;

74 
	}
}

76 
	#NBUF
 32

	)

78 
	$block_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

80 
block
;

81 
off£t
;

82 
blocksize
;

83 
blocksize_b™s
, 
i
;

84 
Ëá
;

85 
blocks
;

86 
bh»que¡
, 
u±od©e
;

87 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

88 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

89 
bufãr_h—d
 * 
bh»q
[
NBUF
];

90 
ch¬s
;

91 
size
;

92 
dev
;

93 
»ad
;

95 
dev
 = 
šode
->
i_rdev
;

96 
blocksize
 = 
BLOCK_SIZE
;

97 ià(
blksize_size
[
	`MAJOR
(
dev
)] && blksize_size[MAJOR(dev)][
	`MINOR
(dev)])

98 
blocksize
 = 
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)];

99 
i
 = 
blocksize
;

100 
blocksize_b™s
 = 0;

101 
i
 != 1) {

102 
blocksize_b™s
++;

103 
i
 >>= 1;

106 
off£t
 = 
fp
->
f_pos
;

107 ià(
blk_size
[
	`MAJOR
(
dev
)])

108 
size
 = 
blk_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] << 
BLOCK_SIZE_BITS
;

110 
size
 = 
INT_MAX
;

112 ià(
off£t
 > 
size
)

113 
Ëá
 = 0;

115 
Ëá
 = 
size
 - 
off£t
;

116 ià(
Ëá
 > 
couÁ
)

117 
Ëá
 = 
couÁ
;

118 ià(
Ëá
 <= 0)

120 
»ad
 = 0;

121 
block
 = 
off£t
 >> 
blocksize_b™s
;

122 
off£t
 &ğ
blocksize
-1;

123 
size
 >>ğ
blocksize_b™s
;

124 
blocks
 = (
Ëá
 + 
off£t
 + 
blocksize
 - 1è>> 
blocksize_b™s
;

125 
bhb
 = 
bhe
 = 
buæi¡
;

126 ià(
fp
->
f_»ada
) {

127 
blocks
 +ğ
»ad_ah—d
[
	`MAJOR
(
dev
)] / (
blocksize
 >> 9);

128 ià(
block
 + 
blocks
 > 
size
)

129 
blocks
 = 
size
 - 
block
;

143 
bh»que¡
 = 0;

144 
u±od©e
 = 1;

145 
blocks
) {

146 --
blocks
;

147 *
bhb
 = 
	`g‘blk
(
dev
, 
block
++, 
blocksize
);

148 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

149 
u±od©e
 = 0;

150 
bh»q
[
bh»que¡
++] = *
bhb
;

153 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

154 
bhb
 = 
buæi¡
;

158 ià(
u±od©e
)

160 ià(
bhb
 =ğ
bhe
)

165 ià(
bh»que¡
)

166 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

169 ià(*
bhe
) {

170 
	`wa™_Ú_bufãr
(*
bhe
);

171 ià(!(*
bhe
)->
b_u±od©e
) {

172 
	`b»l£
(*
bhe
);

173 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

174 
bhe
 = 
buæi¡
;

175 
Ëá
 = 0;

179 ià(
Ëá
 < 
blocksize
 - 
off£t
)

180 
ch¬s
 = 
Ëá
;

182 
ch¬s
 = 
blocksize
 - 
off£t
;

183 
fp
->
f_pos
 +ğ
ch¬s
;

184 
Ëá
 -ğ
ch¬s
;

185 
»ad
 +ğ
ch¬s
;

186 ià(*
bhe
) {

187 
	`memıy_tofs
(
buf
,
off£t
+(*
bhe
)->
b_d©a
,
ch¬s
);

188 
	`b»l£
(*
bhe
);

189 
buf
 +ğ
ch¬s
;

191 
ch¬s
-->0)

192 
	`put_fs_by‹
(0,
buf
++);

194 
off£t
 = 0;

195 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

196 
bhe
 = 
buæi¡
;

197 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!*bh|| !(*bhe)->
b_lock
));

198 } 
Ëá
 > 0);

201 
bhe
 !ğ
bhb
) {

202 
	`b»l£
(*
bhe
);

203 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

204 
bhe
 = 
buæi¡
;

206 ià(!
»ad
)

207  -
EIO
;

208 
fp
->
f_»ada
 = 1;

209  
»ad
;

210 
	}
}

212 
	$block_fsync
(
šode
 *šode, 
fe
 *
fp
)

214  
	`fsync_dev
 (
šode
->
i_rdev
);

215 
	}
}

	@fs/buffer.c

19 
	~<¡d¬g.h
>

21 
	~<lšux/cÚfig.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/majÜ.h
>

26 
	~<lšux/¡ršg.h
>

27 
	~<lšux/locks.h
>

28 
	~<lšux/”ºo.h
>

30 
	~<asm/sy¡em.h
>

31 
	~<asm/io.h
>

33 #ifdeà
CONFIG_SCSI


34 #ifdeà
CONFIG_BLK_DEV_SR


35 
check_cdrom_medŸ_chªge
(, );

37 #ifdeà
CONFIG_BLK_DEV_SD


38 
check_scsidisk_medŸ_chªge
(, );

39 
»v®id©e_scsidisk
(, );

42 #ifdeà
CONFIG_CDU31A


43 
check_cdu31a_medŸ_chªge
(, );

45 #ifdeà
CONFIG_MCD


46 
check_mcd_medŸ_chªge
(, );

49 
grow_bufãrs
(
´i
, 
size
);

51 
bufãr_h—d
 * 
	ghash_bË
[
NR_HASH
];

52 
bufãr_h—d
 * 
	gä“_li¡
 = 
NULL
;

53 
bufãr_h—d
 * 
	gunu£d_li¡
 = 
NULL
;

54 
wa™_queue
 * 
	gbufãr_wa™
 = 
NULL
;

56 
	gÄ_bufãrs
 = 0;

57 
	gbufãrmem
 = 0;

58 
	gÄ_bufãr_h—ds
 = 0;

59 
	gmš_ä“_·ges
 = 20;

60 *
blksize_size
[];

71 
	$__wa™_Ú_bufãr
(
bufãr_h—d
 * 
bh
)

73 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

75 
bh
->
b_couÁ
++;

76 
	`add_wa™_queue
(&
bh
->
b_wa™
, &
wa™
);

77 
»³©
:

78 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

79 ià(
bh
->
b_lock
) {

80 
	`scheduË
();

81 
»³©
;

83 
	`»move_wa™_queue
(&
bh
->
b_wa™
, &
wa™
);

84 
bh
->
b_couÁ
--;

85 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

86 
	}
}

92 
	$sync_bufãrs
(
dev_t
 
dev
, 
wa™
)

94 
i
, 
»Œy
, 
·ss
 = 0, 
”r
 = 0;

95 
bufãr_h—d
 * 
bh
;

102 
»³©
:

103 
»Œy
 = 0;

104 
bh
 = 
ä“_li¡
;

105 
i
 = 
Ä_bufãrs
*2 ; i-- > 0 ; 
bh
 = bh->
b_Ãxt_ä“
) {

106 ià(
dev
 && 
bh
->
b_dev
 != dev)

109 ià(
bh
->
b_»q
 && !bh->
b_lock
 &&

110 !
bh
->
b_dœt
 && !bh->
b_u±od©e
)

111 
	`´štk
 ("Warning (IOƒrror) - orphaned block %08x on %04x\n",

112 
bh
->
b_blockÄ
, bh->
b_dev
);

114 ià(
bh
->
b_lock
)

118 ià(!
wa™
 || !
·ss
) {

119 
»Œy
 = 1;

122 
	`wa™_Ú_bufãr
 (
bh
);

126 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_lock
 &&

127 !
bh
->
b_dœt
 && !bh->
b_u±od©e
)

129 
”r
 = 1;

134 ià(!
bh
->
b_dœt
 || 
·ss
>=2)

136 
bh
->
b_couÁ
++;

137 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

138 
bh
->
b_couÁ
--;

139 
»Œy
 = 1;

145 ià(
wa™
 && 
»Œy
 && ++
·ss
<=2)

146 
»³©
;

147  
”r
;

148 
	}
}

150 
	$sync_dev
(
dev_t
 
dev
)

152 
	`sync_bufãrs
(
dev
, 0);

153 
	`sync_su³rs
(
dev
);

154 
	`sync_šodes
(
dev
);

155 
	`sync_bufãrs
(
dev
, 0);

156 
	}
}

158 
	$fsync_dev
(
dev_t
 
dev
)

160 
	`sync_bufãrs
(
dev
, 0);

161 
	`sync_su³rs
(
dev
);

162 
	`sync_šodes
(
dev
);

163  
	`sync_bufãrs
(
dev
, 1);

164 
	}
}

166 
asmlškage
 
	$sys_sync
()

168 
	`sync_dev
(0);

170 
	}
}

172 
	$fe_fsync
 (
šode
 *šode, 
fe
 *
fp
)

174  
	`fsync_dev
(
šode
->
i_dev
);

175 
	}
}

177 
asmlškage
 
	$sys_fsync
(
fd
)

179 
fe
 * file;

180 
šode
 * inode;

182 ià(
fd
>=
NR_OPEN
 || !(
fe
=
cu¼’t
->
fp
[fd]è|| !(
šode
=fe->
f_šode
))

183  -
EBADF
;

184 ià(!
fe
->
f_İ
 || !fe->f_İ->
fsync
)

185  -
EINVAL
;

186 ià(
fe
->
f_İ
->
	`fsync
(
šode
,file))

187  -
EIO
;

189 
	}
}

191 
	$šv®id©e_bufãrs
(
dev_t
 
dev
)

193 
i
;

194 
bufãr_h—d
 * 
bh
;

196 
bh
 = 
ä“_li¡
;

197 
i
 = 
Ä_bufãrs
*2 ; --˜> 0 ; 
bh
 = bh->
b_Ãxt_ä“
) {

198 ià(
bh
->
b_dev
 !ğ
dev
)

200 
	`wa™_Ú_bufãr
(
bh
);

201 ià(
bh
->
b_dev
 =ğ
dev
)

202 
bh
->
b_u±od©e
 = bh->
b_dœt
 = bh->
b_»q
 = 0;

204 
	}
}

220 
	$check_disk_chªge
(
dev_t
 
dev
)

222 
i
;

223 
bufãr_h—d
 * 
bh
;

225 
	`MAJOR
(
dev
)){

226 
FLOPPY_MAJOR
:

227 ià(!(
bh
 = 
	`g‘blk
(
dev
,0,1024)))

229 
i
 = 
	`æİpy_chªge
(
bh
);

230 
	`b»l£
(
bh
);

233 #ià
	`defšed
(
CONFIG_BLK_DEV_SD
è&& defšed(
CONFIG_SCSI
)

234 
SCSI_DISK_MAJOR
:

235 
i
 = 
	`check_scsidisk_medŸ_chªge
(
dev
, 0);

239 #ià
	`defšed
(
CONFIG_BLK_DEV_SR
è&& defšed(
CONFIG_SCSI
)

240 
SCSI_CDROM_MAJOR
:

241 
i
 = 
	`check_cdrom_medŸ_chªge
(
dev
, 0);

245 #ià
	`defšed
(
CONFIG_CDU31A
)

246 
CDU31A_CDROM_MAJOR
:

247 
i
 = 
	`check_cdu31a_medŸ_chªge
(
dev
, 0);

251 #ià
	`defšed
(
CONFIG_MCD
)

252 
MITSUMI_CDROM_MAJOR
:

253 
i
 = 
	`check_mcd_medŸ_chªge
(
dev
, 0);

261 ià(!
i
) ;

263 
	`´štk
("VFS: Disk change detected on device %d/%d\n",

264 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

265 
i
=0 ; i<
NR_SUPER
 ; i++)

266 ià(
su³r_blocks
[
i
].
s_dev
 =ğ
dev
)

267 
	`put_su³r
(
su³r_blocks
[
i
].
s_dev
);

268 
	`šv®id©e_šodes
(
dev
);

269 
	`šv®id©e_bufãrs
(
dev
);

271 #ià
	`defšed
(
CONFIG_BLK_DEV_SD
è&& defšed(
CONFIG_SCSI
)

274 ià(
	`MAJOR
(
dev
è=ğ
SCSI_DISK_MAJOR
)

275 
	`»v®id©e_scsidisk
(
dev
, 0);

277 
	}
}

279 
	#_hashâ
(
dev
,
block
è((()(dev^block))%
NR_HASH
)

	)

280 
	#hash
(
dev
,
block
è
hash_bË
[
	`_hashâ
(dev,block)]

	)

282 
šlše
 
	$»move_äom_hash_queue
(
bufãr_h—d
 * 
bh
)

284 ià(
bh
->
b_Ãxt
)

285 
bh
->
b_Ãxt
->
b_´ev
 = bh->b_prev;

286 ià(
bh
->
b_´ev
)

287 
bh
->
b_´ev
->
b_Ãxt
 = bh->b_next;

288 ià(
	`hash
(
bh
->
b_dev
,bh->
b_blockÄ
) == bh)

289 
	`hash
(
bh
->
b_dev
,bh->
b_blockÄ
èğbh->
b_Ãxt
;

290 
bh
->
b_Ãxt
 = bh->
b_´ev
 = 
NULL
;

291 
	}
}

293 
šlše
 
	$»move_äom_ä“_li¡
(
bufãr_h—d
 * 
bh
)

295 ià(!(
bh
->
b_´ev_ä“
è|| !(bh->
b_Ãxt_ä“
))

296 
	`·nic
("VFS: Free block†ist corrupted");

297 
bh
->
b_´ev_ä“
->
b_Ãxt_ä“
 = bh->b_next_free;

298 
bh
->
b_Ãxt_ä“
->
b_´ev_ä“
 = bh->b_prev_free;

299 ià(
ä“_li¡
 =ğ
bh
)

300 
ä“_li¡
 = 
bh
->
b_Ãxt_ä“
;

301 
bh
->
b_Ãxt_ä“
 = bh->
b_´ev_ä“
 = 
NULL
;

302 
	}
}

304 
šlše
 
	$»move_äom_queues
(
bufãr_h—d
 * 
bh
)

306 
	`»move_äom_hash_queue
(
bh
);

307 
	`»move_äom_ä“_li¡
(
bh
);

308 
	}
}

310 
šlše
 
	$put_fœ¡_ä“
(
bufãr_h—d
 * 
bh
)

312 ià(!
bh
 || (bh =ğ
ä“_li¡
))

314 
	`»move_äom_ä“_li¡
(
bh
);

316 
bh
->
b_Ãxt_ä“
 = 
ä“_li¡
;

317 
bh
->
b_´ev_ä“
 = 
ä“_li¡
->b_prev_free;

318 
ä“_li¡
->
b_´ev_ä“
->
b_Ãxt_ä“
 = 
bh
;

319 
ä“_li¡
->
b_´ev_ä“
 = 
bh
;

320 
ä“_li¡
 = 
bh
;

321 
	}
}

323 
šlše
 
	$put_Ï¡_ä“
(
bufãr_h—d
 * 
bh
)

325 ià(!
bh
)

327 ià(
bh
 =ğ
ä“_li¡
) {

328 
ä“_li¡
 = 
bh
->
b_Ãxt_ä“
;

331 
	`»move_äom_ä“_li¡
(
bh
);

333 
bh
->
b_Ãxt_ä“
 = 
ä“_li¡
;

334 
bh
->
b_´ev_ä“
 = 
ä“_li¡
->b_prev_free;

335 
ä“_li¡
->
b_´ev_ä“
->
b_Ãxt_ä“
 = 
bh
;

336 
ä“_li¡
->
b_´ev_ä“
 = 
bh
;

337 
	}
}

339 
šlše
 
	$š£¹_što_queues
(
bufãr_h—d
 * 
bh
)

342 
bh
->
b_Ãxt_ä“
 = 
ä“_li¡
;

343 
bh
->
b_´ev_ä“
 = 
ä“_li¡
->b_prev_free;

344 
ä“_li¡
->
b_´ev_ä“
->
b_Ãxt_ä“
 = 
bh
;

345 
ä“_li¡
->
b_´ev_ä“
 = 
bh
;

347 
bh
->
b_´ev
 = 
NULL
;

348 
bh
->
b_Ãxt
 = 
NULL
;

349 ià(!
bh
->
b_dev
)

351 
bh
->
b_Ãxt
 = 
	`hash
(bh->
b_dev
,bh->
b_blockÄ
);

352 
	`hash
(
bh
->
b_dev
,bh->
b_blockÄ
) = bh;

353 ià(
bh
->
b_Ãxt
)

354 
bh
->
b_Ãxt
->
b_´ev
 = bh;

355 
	}
}

357 
bufãr_h—d
 * 
	$fšd_bufãr
(
dev_t
 
dev
, 
block
, 
size
)

359 
bufãr_h—d
 * 
tmp
;

361 
tmp
 = 
	`hash
(
dev
,
block
è;m°!ğ
NULL
 ;m°ğtmp->
b_Ãxt
)

362 ià(
tmp
->
b_dev
==
dev
 &&mp->
b_blockÄ
==
block
)

363 ià(
tmp
->
b_size
 =ğ
size
)

364  
tmp
;

366 
	`´štk
("VFS: Wrong blocksize on device %d/%d\n",

367 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

368  
NULL
;

370  
NULL
;

371 
	}
}

380 
bufãr_h—d
 * 
	$g‘_hash_bË
(
dev_t
 
dev
, 
block
, 
size
)

382 
bufãr_h—d
 * 
bh
;

385 ià(!(
bh
=
	`fšd_bufãr
(
dev
,
block
,
size
)))

386  
NULL
;

387 
bh
->
b_couÁ
++;

388 
	`wa™_Ú_bufãr
(
bh
);

389 ià(
bh
->
b_dev
 =ğ
dev
 && bh->
b_blockÄ
 =ğ
block
 && bh->
b_size
 =ğ
size
)

390  
bh
;

391 
bh
->
b_couÁ
--;

393 
	}
}

395 
	$£t_blocksize
(
dev_t
 
dev
, 
size
)

397 
i
;

398 
bufãr_h—d
 * 
bh
, *
bhÃxt
;

400 ià(!
blksize_size
[
	`MAJOR
(
dev
)])

403 
size
) {

404 : 
	`·nic
("Invalid blocksize…assedo set_blocksize");

408 ià(
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] =ğ0 && 
size
 =ğ
BLOCK_SIZE
) {

409 
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] = 
size
;

412 ià(
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] =ğ
size
)

414 
	`sync_bufãrs
(
dev
, 2);

415 
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)] = 
size
;

420 
bh
 = 
ä“_li¡
;

421 
i
 = 
Ä_bufãrs
*2 ; --˜> 0 ; 
bh
 = 
bhÃxt
) {

422 
bhÃxt
 = 
bh
->
b_Ãxt_ä“
;

423 ià(
bh
->
b_dev
 !ğ
dev
)

425 ià(
bh
->
b_size
 =ğ
size
)

428 
	`wa™_Ú_bufãr
(
bh
);

429 ià(
bh
->
b_dev
 =ğ
dev
 && bh->
b_size
 !ğ
size
)

430 
bh
->
b_u±od©e
 = bh->
b_dœt
 = 0;

431 
	`»move_äom_hash_queue
(
bh
);

434 
	}
}

446 
	#BADNESS
(
bh
è(((bh)->
b_dœt
<<1)+(bh)->
b_lock
)

	)

447 
bufãr_h—d
 * 
	$g‘blk
(
dev_t
 
dev
, 
block
, 
size
)

449 
bufãr_h—d
 * 
bh
, * 
tmp
;

450 
bufãrs
;

451 
grow_size
 = 0;

453 
»³©
:

454 
bh
 = 
	`g‘_hash_bË
(
dev
, 
block
, 
size
);

455 ià(
bh
) {

456 ià(
bh
->
b_u±od©e
 && !bh->
b_dœt
)

457 
	`put_Ï¡_ä“
(
bh
);

458  
bh
;

460 
grow_size
 -ğ
size
;

461 ià(
Ä_ä“_·ges
 > 
mš_ä“_·ges
 && 
grow_size
 <= 0) {

462 ià(
	`grow_bufãrs
(
GFP_BUFFER
, 
size
))

463 
grow_size
 = 
PAGE_SIZE
;

465 
bufãrs
 = 
Ä_bufãrs
;

466 
bh
 = 
NULL
;

468 
tmp
 = 
ä“_li¡
; 
bufãrs
-- > 0 ;m°ğtmp->
b_Ãxt_ä“
) {

469 ià(
tmp
->
b_couÁ
 ||mp->
b_size
 !ğ
size
)

471 ià(
mem_m­
[
	`MAP_NR
((è
tmp
->
b_d©a
)] != 1)

473 ià(!
bh
 || 
	`BADNESS
(
tmp
)<BADNESS(bh)) {

474 
bh
 = 
tmp
;

475 ià(!
	`BADNESS
(
tmp
))

479 ià(
tmp
->
b_dœt
) {

480 
tmp
->
b_couÁ
++;

481 
	`Î_rw_block
(
WRITEA
, 1, &
tmp
);

482 
tmp
->
b_couÁ
--;

487 ià(!
bh
) {

488 ià(
Ä_ä“_·ges
 > 5)

489 ià(
	`grow_bufãrs
(
GFP_BUFFER
, 
size
))

490 
»³©
;

491 ià(!
	`grow_bufãrs
(
GFP_ATOMIC
, 
size
))

492 
	`¦“p_Ú
(&
bufãr_wa™
);

493 
»³©
;

496 
	`wa™_Ú_bufãr
(
bh
);

497 ià(
bh
->
b_couÁ
 || bh->
b_size
 !ğ
size
)

498 
»³©
;

499 ià(
bh
->
b_dœt
) {

500 
	`sync_bufãrs
(0,0);

501 
»³©
;

505 ià(
	`fšd_bufãr
(
dev
,
block
,
size
))

506 
»³©
;

509 
bh
->
b_couÁ
=1;

510 
bh
->
b_dœt
=0;

511 
bh
->
b_u±od©e
=0;

512 
bh
->
b_»q
=0;

513 
	`»move_äom_queues
(
bh
);

514 
bh
->
b_dev
=
dev
;

515 
bh
->
b_blockÄ
=
block
;

516 
	`š£¹_što_queues
(
bh
);

517  
bh
;

518 
	}
}

520 
	$b»l£
(
bufãr_h—d
 * 
buf
)

522 ià(!
buf
)

524 
	`wa™_Ú_bufãr
(
buf
);

525 ià(
buf
->
b_couÁ
) {

526 ià(--
buf
->
b_couÁ
)

528 
	`wake_up
(&
bufãr_wa™
);

531 
	`´štk
("VFS: brelse: Tryingo free free buffer\n");

532 
	}
}

538 
bufãr_h—d
 * 
	$b»ad
(
dev_t
 
dev
, 
block
, 
size
)

540 
bufãr_h—d
 * 
bh
;

542 ià(!(
bh
 = 
	`g‘blk
(
dev
, 
block
, 
size
))) {

543 
	`´štk
("VFS: bread: READƒrror on device %d/%d\n",

544 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

545  
NULL
;

547 ià(
bh
->
b_u±od©e
)

548  
bh
;

549 
	`Î_rw_block
(
READ
, 1, &
bh
);

550 
	`wa™_Ú_bufãr
(
bh
);

551 ià(
bh
->
b_u±od©e
)

552  
bh
;

553 
	`b»l£
(
bh
);

554  
NULL
;

555 
	}
}

562 
bufãr_h—d
 * 
	$b»ada
(
dev_t
 
dev
,
fœ¡
, ...)

564 
va_li¡
 
¬gs
;

565 
blocksize
;

566 
bufãr_h—d
 * 
bh
, *
tmp
;

568 
	`va_¡¬t
(
¬gs
,
fœ¡
);

570 
blocksize
 = 
BLOCK_SIZE
;

571 ià(
blksize_size
[
	`MAJOR
(
dev
)] && blksize_size[MAJOR(dev)][
	`MINOR
(dev)])

572 
blocksize
 = 
blksize_size
[
	`MAJOR
(
dev
)][
	`MINOR
(dev)];

574 ià(!(
bh
 = 
	`g‘blk
(
dev
, 
fœ¡
, 
blocksize
))) {

575 
	`´štk
("VFS: breada: READƒrror on device %d/%d\n",

576 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

577  
NULL
;

579 ià(!
bh
->
b_u±od©e
)

580 
	`Î_rw_block
(
READ
, 1, &
bh
);

581 (
fœ¡
=
	`va_¬g
(
¬gs
,))>=0) {

582 
tmp
 = 
	`g‘blk
(
dev
, 
fœ¡
, 
blocksize
);

583 ià(
tmp
) {

584 ià(!
tmp
->
b_u±od©e
)

585 
	`Î_rw_block
(
READA
, 1, &
tmp
);

586 
tmp
->
b_couÁ
--;

589 
	`va_’d
(
¬gs
);

590 
	`wa™_Ú_bufãr
(
bh
);

591 ià(
bh
->
b_u±od©e
)

592  
bh
;

593 
	`b»l£
(
bh
);

594  (
NULL
);

595 
	}
}

600 
	$put_unu£d_bufãr_h—d
(
bufãr_h—d
 * 
bh
)

602 
wa™_queue
 * 
wa™
;

604 
wa™
 = ((vŞ©
bufãr_h—d
 *è
bh
)->
b_wa™
;

605 
	`mem£t
((*è
bh
,0,(*bh));

606 ((vŞ©
bufãr_h—d
 *è
bh
)->
b_wa™
 = 
wa™
;

607 
bh
->
b_Ãxt_ä“
 = 
unu£d_li¡
;

608 
unu£d_li¡
 = 
bh
;

609 
	}
}

611 
	$g‘_mÜe_bufãr_h—ds
()

613 
i
;

614 
bufãr_h—d
 * 
bh
;

616 ià(
unu£d_li¡
)

619 if(! (
bh
 = (
bufãr_h—d
*è
	`g‘_ä“_·ge
(
GFP_BUFFER
)))

622 
Ä_bufãr_h—ds
+=
i
=
PAGE_SIZE
/*
bh
 ; i>0; i--) {

623 
bh
->
b_Ãxt_ä“
 = 
unu£d_li¡
;

624 
unu£d_li¡
 = 
bh
++;

626 
	}
}

628 
bufãr_h—d
 * 
	$g‘_unu£d_bufãr_h—d
()

630 
bufãr_h—d
 * 
bh
;

632 
	`g‘_mÜe_bufãr_h—ds
();

633 ià(!
unu£d_li¡
)

634  
NULL
;

635 
bh
 = 
unu£d_li¡
;

636 
unu£d_li¡
 = 
bh
->
b_Ãxt_ä“
;

637 
bh
->
b_Ãxt_ä“
 = 
NULL
;

638 
bh
->
b_d©a
 = 
NULL
;

639 
bh
->
b_size
 = 0;

640 
bh
->
b_»q
 = 0;

641  
bh
;

642 
	}
}

650 
bufãr_h—d
 * 
	$ü—‹_bufãrs
(
·ge
, 
size
)

652 
bufãr_h—d
 *
bh
, *
h—d
;

653 
off£t
;

655 
h—d
 = 
NULL
;

656 
off£t
 = 
PAGE_SIZE
;

657 (
off£t
 -ğ
size
è< 
PAGE_SIZE
) {

658 
bh
 = 
	`g‘_unu£d_bufãr_h—d
();

659 ià(!
bh
)

660 
no_grow
;

661 
bh
->
b_this_·ge
 = 
h—d
;

662 
h—d
 = 
bh
;

663 
bh
->
b_d©a
 = (*è(
·ge
+
off£t
);

664 
bh
->
b_size
 = 
size
;

666  
h—d
;

670 
no_grow
:

671 
bh
 = 
h—d
;

672 
bh
) {

673 
h—d
 = 
bh
;

674 
bh
 = bh->
b_this_·ge
;

675 
	`put_unu£d_bufãr_h—d
(
h—d
);

677  
NULL
;

678 
	}
}

680 
	$»ad_bufãrs
(
bufãr_h—d
 * 
bh
[], 
Äbuf
)

682 
i
;

683 
bhnum
 = 0;

684 
bufãr_h—d
 * 
bhr
[8];

686 
i
 = 0 ; i < 
Äbuf
 ; i++) {

687 ià(
bh
[
i
] && !bh[i]->
b_u±od©e
)

688 
bhr
[
bhnum
++] = 
bh
[
i
];

690 ià(
bhnum
)

691 
	`Î_rw_block
(
READ
, 
bhnum
, 
bhr
);

692 
i
 = 0 ; i < 
Äbuf
 ; i++) {

693 ià(
bh
[
i
]) {

694 
	`wa™_Ú_bufãr
(
bh
[
i
]);

697 
	}
}

699 
	$check_®igÃd
(
bufãr_h—d
 * 
fœ¡
, 
add»ss
,

700 
dev_t
 
dev
, *
b
, 
size
)

702 
bufãr_h—d
 * 
bh
[8];

703 
·ge
;

704 
off£t
;

705 
block
;

706 
Äbuf
;

708 
·ge
 = (è
fœ¡
->
b_d©a
;

709 ià(
·ge
 & ~
PAGE_MASK
) {

710 
	`b»l£
(
fœ¡
);

713 
mem_m­
[
	`MAP_NR
(
·ge
)]++;

714 
bh
[0] = 
fœ¡
;

715 
Äbuf
 = 1;

716 
off£t
 = 
size
 ; off£ˆ< 
PAGE_SIZE
 ; offset += size) {

717 
block
 = *++
b
;

718 ià(!
block
)

719 
no_go
;

720 
fœ¡
 = 
	`g‘_hash_bË
(
dev
, 
block
, 
size
);

721 ià(!
fœ¡
)

722 
no_go
;

723 
bh
[
Äbuf
++] = 
fœ¡
;

724 ià(
·ge
+
off£t
 !ğ(è
fœ¡
->
b_d©a
)

725 
no_go
;

727 
	`»ad_bufãrs
(
bh
,
Äbuf
);

728 
Äbuf
-- > 0)

729 
	`b»l£
(
bh
[
Äbuf
]);

730 
	`ä“_·ge
(
add»ss
);

731 ++
cu¼’t
->
mš_æt
;

732  
·ge
;

733 
no_go
:

734 
Äbuf
-- > 0)

735 
	`b»l£
(
bh
[
Äbuf
]);

736 
	`ä“_·ge
(
·ge
);

738 
	}
}

740 
	$Œy_to_lßd_®igÃd
(
add»ss
,

741 
dev_t
 
dev
, 
b
[], 
size
)

743 
bufãr_h—d
 * 
bh
, * 
tmp
, * 
¬r
[8];

744 
off£t
;

745 * 
p
;

746 
block
;

748 
bh
 = 
	`ü—‹_bufãrs
(
add»ss
, 
size
);

749 ià(!
bh
)

752 
p
 = 
b
;

753 
off£t
 = 0 ; off£ˆ< 
PAGE_SIZE
 ; off£ˆ+ğ
size
) {

754 
block
 = *(
p
++);

755 ià(!
block
)

756 
nÙ_®igÃd
;

757 ià(
	`fšd_bufãr
(
dev
, 
block
, 
size
))

758 
nÙ_®igÃd
;

760 
tmp
 = 
bh
;

761 
p
 = 
b
;

762 
block
 = 0;

764 
¬r
[
block
++] = 
bh
;

765 
bh
->
b_couÁ
 = 1;

766 
bh
->
b_dœt
 = 0;

767 
bh
->
b_u±od©e
 = 0;

768 
bh
->
b_dev
 = 
dev
;

769 
bh
->
b_blockÄ
 = *(
p
++);

770 
Ä_bufãrs
++;

771 
	`š£¹_što_queues
(
bh
);

772 ià(
bh
->
b_this_·ge
)

773 
bh
 = bh->
b_this_·ge
;

777 
bufãrmem
 +ğ
PAGE_SIZE
;

778 
bh
->
b_this_·ge
 = 
tmp
;

779 
mem_m­
[
	`MAP_NR
(
add»ss
)]++;

780 
	`»ad_bufãrs
(
¬r
,
block
);

781 
block
-- > 0)

782 
	`b»l£
(
¬r
[
block
]);

783 ++
cu¼’t
->
maj_æt
;

784  
add»ss
;

785 
nÙ_®igÃd
:

786 (
tmp
 = 
bh
è!ğ
NULL
) {

787 
bh
 = bh->
b_this_·ge
;

788 
	`put_unu£d_bufãr_h—d
(
tmp
);

791 
	}
}

804 
šlše
 
	$Œy_to_sh¬e_bufãrs
(
add»ss
,

805 
dev_t
 
dev
, *
b
, 
size
)

807 
bufãr_h—d
 * 
bh
;

808 
block
;

810 
block
 = 
b
[0];

811 ià(!
block
)

813 
bh
 = 
	`g‘_hash_bË
(
dev
, 
block
, 
size
);

814 ià(
bh
)

815  
	`check_®igÃd
(
bh
, 
add»ss
, 
dev
, 
b
, 
size
);

816  
	`Œy_to_lßd_®igÃd
(
add»ss
, 
dev
, 
b
, 
size
);

817 
	}
}

819 
	#COPYBLK
(
size
,
äom
,
to
) \

820 
__asm__
 
	`__vŞ©e__
("rep ; movsl": \

821 :"c" (((è
size
è>> 2),"S" (
äom
),"D" (
to
) \

822 :"cx","di","si")

	)

831 
	$b»ad_·ge
(
add»ss
, 
dev_t
 
dev
, 
b
[], 
size
, 
´Ù
)

833 
bufãr_h—d
 * 
bh
[8];

834 
wh”e
;

835 
i
, 
j
;

837 ià(!(
´Ù
 & 
PAGE_RW
)) {

838 
wh”e
 = 
	`Œy_to_sh¬e_bufãrs
(
add»ss
,
dev
,
b
,
size
);

839 ià(
wh”e
)

840  
wh”e
;

842 ++
cu¼’t
->
maj_æt
;

843 
i
=0, 
j
=0; j<
PAGE_SIZE
 ; i++, j+ğ
size
) {

844 
bh
[
i
] = 
NULL
;

845 ià(
b
[
i
])

846 
bh
[
i
] = 
	`g‘blk
(
dev
, 
b
[i], 
size
);

848 
	`»ad_bufãrs
(
bh
,
i
);

849 
wh”e
 = 
add»ss
;

850 
i
=0, 
j
=0; j<
PAGE_SIZE
 ; i++, j +ğ
size
,
add»ss
 += size) {

851 ià(
bh
[
i
]) {

852 ià(
bh
[
i
]->
b_u±od©e
)

853 
	`COPYBLK
(
size
, (è
bh
[
i
]->
b_d©a
,
add»ss
);

854 
	`b»l£
(
bh
[
i
]);

857  
wh”e
;

858 
	}
}

864 
	$grow_bufãrs
(
´i
, 
size
)

866 
·ge
;

867 
bufãr_h—d
 *
bh
, *
tmp
;

869 ià((
size
 & 511è|| (siz> 
PAGE_SIZE
)) {

870 
	`´štk
("VFS: grow_bufãrs: sizğ%d\n",
size
);

873 if(!(
·ge
 = 
	`__g‘_ä“_·ge
(
´i
)))

875 
bh
 = 
	`ü—‹_bufãrs
(
·ge
, 
size
);

876 ià(!
bh
) {

877 
	`ä“_·ge
(
·ge
);

880 
tmp
 = 
bh
;

882 ià(
ä“_li¡
) {

883 
tmp
->
b_Ãxt_ä“
 = 
ä“_li¡
;

884 
tmp
->
b_´ev_ä“
 = 
ä“_li¡
->b_prev_free;

885 
ä“_li¡
->
b_´ev_ä“
->
b_Ãxt_ä“
 = 
tmp
;

886 
ä“_li¡
->
b_´ev_ä“
 = 
tmp
;

888 
tmp
->
b_´ev_ä“
 =mp;

889 
tmp
->
b_Ãxt_ä“
 =mp;

891 
ä“_li¡
 = 
tmp
;

892 ++
Ä_bufãrs
;

893 ià(
tmp
->
b_this_·ge
)

894 
tmp
 =mp->
b_this_·ge
;

898 
tmp
->
b_this_·ge
 = 
bh
;

899 
bufãrmem
 +ğ
PAGE_SIZE
;

901 
	}
}

907 
	$Œy_to_ä“
(
bufãr_h—d
 * 
bh
, bufãr_h—d ** 
bhp
)

909 
·ge
;

910 
bufãr_h—d
 * 
tmp
, * 
p
;

912 *
bhp
 = 
bh
;

913 
·ge
 = (è
bh
->
b_d©a
;

914 
·ge
 &ğ
PAGE_MASK
;

915 
tmp
 = 
bh
;

917 ià(!
tmp
)

919 ià(
tmp
->
b_couÁ
 ||mp->
b_dœt
 ||mp->
b_lock
 ||mp->
b_wa™
)

921 
tmp
 =mp->
b_this_·ge
;

922 } 
tmp
 !ğ
bh
);

923 
tmp
 = 
bh
;

925 
p
 = 
tmp
;

926 
tmp
 =mp->
b_this_·ge
;

927 
Ä_bufãrs
--;

928 ià(
p
 =ğ*
bhp
)

929 *
bhp
 = 
p
->
b_´ev_ä“
;

930 
	`»move_äom_queues
(
p
);

931 
	`put_unu£d_bufãr_h—d
(
p
);

932 } 
tmp
 !ğ
bh
);

933 
bufãrmem
 -ğ
PAGE_SIZE
;

934 
	`ä“_·ge
(
·ge
);

935  !
mem_m­
[
	`MAP_NR
(
·ge
)];

936 
	}
}

945 
	$shršk_bufãrs
(
´iÜ™y
)

947 
bufãr_h—d
 *
bh
;

948 
i
;

950 ià(
´iÜ™y
 < 2)

951 
	`sync_bufãrs
(0,0);

952 
bh
 = 
ä“_li¡
;

953 
i
 = 
Ä_bufãrs
 >> 
´iÜ™y
;

954  ; 
i
-- > 0 ; 
bh
 = bh->
b_Ãxt_ä“
) {

955 ià(
bh
->
b_couÁ
 ||

956 (
´iÜ™y
 >= 5 &&

957 
mem_m­
[
	`MAP_NR
((è
bh
->
b_d©a
)] > 1)) {

958 
	`put_Ï¡_ä“
(
bh
);

961 ià(!
bh
->
b_this_·ge
)

963 ià(
bh
->
b_lock
)

964 ià(
´iÜ™y
)

967 
	`wa™_Ú_bufãr
(
bh
);

968 ià(
bh
->
b_dœt
) {

969 
bh
->
b_couÁ
++;

970 
	`Î_rw_block
(
WRITEA
, 1, &
bh
);

971 
bh
->
b_couÁ
--;

974 ià(
	`Œy_to_ä“
(
bh
, &bh))

978 
	}
}

980 
	$show_bufãrs
()

982 
bufãr_h—d
 * 
bh
;

983 
found
 = 0, 
locked
 = 0, 
dœty
 = 0, 
u£d
 = 0, 
Ï¡u£d
 = 0;

985 
	`´štk
("Bufã¸memÜy: %6dkB\n",
bufãrmem
>>10);

986 
	`´štk
("Bufã¸h—ds: %6d\n",
Ä_bufãr_h—ds
);

987 
	`´štk
("Bufã¸blocks: %6d\n",
Ä_bufãrs
);

988 
bh
 = 
ä“_li¡
;

990 
found
++;

991 ià(
bh
->
b_lock
)

992 
locked
++;

993 ià(
bh
->
b_dœt
)

994 
dœty
++;

995 ià(
bh
->
b_couÁ
)

996 
u£d
++, 
Ï¡u£d
 = 
found
;

997 
bh
 = bh->
b_Ãxt_ä“
;

998 } 
bh
 !ğ
ä“_li¡
);

999 
	`´štk
("Buffer mem: %d buffers, %d used (last=%d), %d†ocked, %d dirty\n",

1000 
found
, 
u£d
, 
Ï¡u£d
, 
locked
, 
dœty
);

1001 
	}
}

1010 
	$bufãr_š™
()

1012 
i
;

1014 ià(
high_memÜy
 >= 4*1024*1024)

1015 
mš_ä“_·ges
 = 200;

1017 
mš_ä“_·ges
 = 20;

1018 
i
 = 0 ; i < 
NR_HASH
 ; i++)

1019 
hash_bË
[
i
] = 
NULL
;

1020 
ä“_li¡
 = 0;

1021 
	`grow_bufãrs
(
GFP_KERNEL
, 
BLOCK_SIZE
);

1022 ià(!
ä“_li¡
)

1023 
	`·nic
("VFS: Unableo initialize buffer free†ist!");

1025 
	}
}

	@fs/devices.c

9 
	~<lšux/fs.h
>

10 
	~<lšux/majÜ.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/ext_fs.h
>

14 
	~<lšux/¡©.h
>

15 
	~<lšux/fú.h
>

16 
	~<lšux/”ºo.h
>

18 
	sdeviû_¡ruù
 {

19 cÚ¡ * 
	mÇme
;

20 
fe_İ”©iÚs
 * 
	mfİs
;

23 
deviû_¡ruù
 
	gchrdevs
[
MAX_CHRDEV
] = {

24 { 
NULL
, NULL },

27 
deviû_¡ruù
 
	gblkdevs
[
MAX_BLKDEV
] = {

28 { 
NULL
, NULL },

31 
fe_İ”©iÚs
 * 
	$g‘_blkfİs
(
majÜ
)

33 ià(
majÜ
 >ğ
MAX_BLKDEV
)

34  
NULL
;

35  
blkdevs
[
majÜ
].
fİs
;

36 
	}
}

38 
fe_İ”©iÚs
 * 
	$g‘_chrfİs
(
majÜ
)

40 ià(
majÜ
 >ğ
MAX_CHRDEV
)

41  
NULL
;

42  
chrdevs
[
majÜ
].
fİs
;

43 
	}
}

45 
	$»gi¡”_chrdev
(
majÜ
, cÚ¡ * 
Çme
, 
fe_İ”©iÚs
 *
fİs
)

47 ià(
majÜ
 >ğ
MAX_CHRDEV
)

48  -
EINVAL
;

49 ià(
chrdevs
[
majÜ
].
fİs
)

50  -
EBUSY
;

51 
chrdevs
[
majÜ
].
Çme
 =‚ame;

52 
chrdevs
[
majÜ
].
fİs
 = fops;

54 
	}
}

56 
	$»gi¡”_blkdev
(
majÜ
, cÚ¡ * 
Çme
, 
fe_İ”©iÚs
 *
fİs
)

58 ià(
majÜ
 >ğ
MAX_BLKDEV
)

59  -
EINVAL
;

60 ià(
blkdevs
[
majÜ
].
fİs
)

61  -
EBUSY
;

62 
blkdevs
[
majÜ
].
Çme
 =‚ame;

63 
blkdevs
[
majÜ
].
fİs
 = fops;

65 
	}
}

67 
	$uÄegi¡”_chrdev
(
majÜ
, cÚ¡ * 
Çme
)

69 ià(
majÜ
 >ğ
MAX_CHRDEV
)

70  -
EINVAL
;

71 ià(!
chrdevs
[
majÜ
].
fİs
)

72  -
EINVAL
;

73 ià(
	`¡rcmp
(
chrdevs
[
majÜ
].
Çme
,‚ame))

74  -
EINVAL
;

75 
chrdevs
[
majÜ
].
Çme
 = 
NULL
;

76 
chrdevs
[
majÜ
].
fİs
 = 
NULL
;

78 
	}
}

80 
	$uÄegi¡”_blkdev
(
majÜ
, cÚ¡ * 
Çme
)

82 ià(
majÜ
 >ğ
MAX_BLKDEV
)

83  -
EINVAL
;

84 ià(!
blkdevs
[
majÜ
].
fİs
)

85  -
EINVAL
;

86 ià(
	`¡rcmp
(
blkdevs
[
majÜ
].
Çme
,‚ame))

87  -
EINVAL
;

88 
blkdevs
[
majÜ
].
Çme
 = 
NULL
;

89 
blkdevs
[
majÜ
].
fİs
 = 
NULL
;

91 
	}
}

96 
	$blkdev_İ’
(
šode
 * inode, 
fe
 * 
fp
)

98 
i
;

100 
i
 = 
	`MAJOR
(
šode
->
i_rdev
);

101 ià(
i
 >ğ
MAX_BLKDEV
 || !
blkdevs
[i].
fİs
)

102  -
ENODEV
;

103 
fp
->
f_İ
 = 
blkdevs
[
i
].
fİs
;

104 ià(
fp
->
f_İ
->
İ’
)

105  
fp
->
f_İ
->
	`İ’
(
šode
,filp);

107 
	}
}

114 
fe_İ”©iÚs
 
	gdef_blk_fİs
 = {

115 
NULL
,

116 
NULL
,

117 
NULL
,

118 
NULL
,

119 
NULL
,

120 
NULL
,

121 
NULL
,

122 
blkdev_İ’
,

123 
NULL
,

126 
šode_İ”©iÚs
 
	gblkdev_šode_İ”©iÚs
 = {

127 &
def_blk_fİs
,

128 
NULL
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NULL
,

139 
NULL
,

140 
NULL
,

141 
NULL


147 
	$chrdev_İ’
(
šode
 * inode, 
fe
 * 
fp
)

149 
i
;

151 
i
 = 
	`MAJOR
(
šode
->
i_rdev
);

152 ià(
i
 >ğ
MAX_CHRDEV
 || !
chrdevs
[i].
fİs
)

153  -
ENODEV
;

154 
fp
->
f_İ
 = 
chrdevs
[
i
].
fİs
;

155 ià(
fp
->
f_İ
->
İ’
)

156  
fp
->
f_İ
->
	`İ’
(
šode
,filp);

158 
	}
}

165 
fe_İ”©iÚs
 
	gdef_chr_fİs
 = {

166 
NULL
,

167 
NULL
,

168 
NULL
,

169 
NULL
,

170 
NULL
,

171 
NULL
,

172 
NULL
,

173 
chrdev_İ’
,

174 
NULL
,

177 
šode_İ”©iÚs
 
	gchrdev_šode_İ”©iÚs
 = {

178 &
def_chr_fİs
,

179 
NULL
,

180 
NULL
,

181 
NULL
,

182 
NULL
,

183 
NULL
,

184 
NULL
,

185 
NULL
,

186 
NULL
,

187 
NULL
,

188 
NULL
,

189 
NULL
,

190 
NULL
,

191 
NULL
,

192 
NULL


	@fs/exec.c

26 
	~<lšux/fs.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/mmª.h
>

31 
	~<lšux/a.out.h
>

32 
	~<lšux/”ºo.h
>

33 
	~<lšux/sigÇl.h
>

34 
	~<lšux/¡ršg.h
>

35 
	~<lšux/¡©.h
>

36 
	~<lšux/fú.h
>

37 
	~<lšux/±¿û.h
>

38 
	~<lšux/u£r.h
>

39 
	~<lšux/£gm’t.h
>

40 
	~<lšux/m®loc.h
>

42 
	~<asm/sy¡em.h
>

44 
	~<lšux/bšfmts.h
>

46 
	~<asm/£gm’t.h
>

47 
	~<asm/sy¡em.h
>

49 
asmlškage
 
sys_ex™
(
ex™_code
);

50 
asmlškage
 
sys_şo£
(
fd
);

51 
asmlškage
 
sys_İ’
(const *, , );

52 
asmlškage
 
sys_brk
();

54 
shm_ex™
 ();

56 
	$İ’_šode
(
šode
 * inode, 
mode
)

58 
”rÜ
, 
fd
;

59 
fe
 *
f
, **
åp
;

61 ià(!
šode
->
i_İ
 || !šode->i_İ->
deçuÉ_fe_İs
)

62  -
EINVAL
;

63 
f
 = 
	`g‘_em±y_fp
();

64 ià(!
f
)

65  -
EMFILE
;

66 
fd
 = 0;

67 
åp
 = 
cu¼’t
->
fp
;

69 ià(!*
åp
)

71 ià(++
fd
 > 
NR_OPEN
)

72  -
ENFILE
;

73 
åp
++;

75 *
åp
 = 
f
;

76 
f
->
f_æags
 = 
mode
;

77 
f
->
f_mode
 = (
mode
+1è& 
O_ACCMODE
;

78 
f
->
f_šode
 = 
šode
;

79 
f
->
f_pos
 = 0;

80 
f
->
f_»ada
 = 0;

81 
f
->
f_İ
 = 
šode
->
i_İ
->
deçuÉ_fe_İs
;

82 ià(
f
->
f_İ
->
İ’
) {

83 
”rÜ
 = 
f
->
f_İ
->
	`İ’
(
šode
,f);

84 ià(
”rÜ
) {

85 *
åp
 = 
NULL
;

86 
f
->
f_couÁ
--;

87  
”rÜ
;

90 
šode
->
i_couÁ
++;

91  
fd
;

92 
	}
}

98 
	#DUMP_WRITE
(
addr
,
Ä
) \

99 
fe
.
f_İ
->
	`wr™e
(
šode
,&fe,(*)(
addr
),(
Ä
)è!ğÒr)è
şo£_cÜedump


	)

101 
	#DUMP_SEEK
(
off£t
) \

102 ià(
fe
.
f_İ
->
l£ek
) { \

103 ià(
fe
.
f_İ
->
	`l£ek
(
šode
,&fe,(
off£t
),0) != (offset)) \

104 
şo£_cÜedump
; \

105 } 
fe
.
f_pos
 = (
off£t
)

	)

116 
	$cÜe_dump
(
sigÄ
, 
±_»gs
 * 
»gs
)

118 
šode
 * inodğ
NULL
;

119 
fe
 file;

120 
fs
;

121 
has_dum³d
 = 0;

122 
cÜefe
[6+(
cu¼’t
->
comm
)];

123 
i
;

124 
dump_¡¬t
, 
dump_size
;

125 
u£r
 
dump
;

127 ià(!
cu¼’t
->
dum·bË
)

129 
cu¼’t
->
dum·bË
 = 0;

132 ià(
cu¼’t
->
¾im
[
RLIMIT_CORE
].
¾im_cur
 < 
PAGE_SIZE
)

134 
fs
 = 
	`g‘_fs
();

135 
	`£t_fs
(
KERNEL_DS
);

136 
	`memıy
(
cÜefe
,"core.",5);

138 
	`memıy
(
cÜefe
+5,
cu¼’t
->
comm
,(current->comm));

140 
cÜefe
[4] = '\0';

142 ià(
	`İ’_Çmei
(
cÜefe
,
O_CREAT
 | 2 | 
O_TRUNC
,0600,&
šode
,
NULL
)) {

143 
šode
 = 
NULL
;

144 
’d_cÜedump
;

146 ià(!
	`S_ISREG
(
šode
->
i_mode
))

147 
’d_cÜedump
;

148 ià(!
šode
->
i_İ
 || !šode->i_İ->
deçuÉ_fe_İs
)

149 
’d_cÜedump
;

150 
fe
.
f_mode
 = 3;

151 
fe
.
f_æags
 = 0;

152 
fe
.
f_couÁ
 = 1;

153 
fe
.
f_šode
 = 
šode
;

154 
fe
.
f_pos
 = 0;

155 
fe
.
f_»ada
 = 0;

156 
fe
.
f_İ
 = 
šode
->
i_İ
->
deçuÉ_fe_İs
;

157 ià(
fe
.
f_İ
->
İ’
)

158 ià(
fe
.
f_İ
->
	`İ’
(
šode
,&file))

159 
’d_cÜedump
;

160 ià(!
fe
.
f_İ
->
wr™e
)

161 
şo£_cÜedump
;

162 
has_dum³d
 = 1;

164 
dump
.
magic
 = 
CMAGIC
;

165 
dump
.
¡¬t_code
 = 0;

166 
dump
.
¡¬t_¡ack
 = 
»gs
->
e¥
 & ~(
PAGE_SIZE
 - 1);

167 
dump
.
u_tsize
 = ((è
cu¼’t
->
’d_code
) >> 12;

168 
dump
.
u_dsize
 = ((è(
cu¼’t
->
brk
 + (
PAGE_SIZE
-1))) >> 12;

169 
dump
.
u_dsize
 -ğdump.
u_tsize
;

170 
dump
.
u_ssize
 = 0;

171 
i
=0; i<8; i++è
dump
.
u_debug»g
[i] = 
cu¼’t
->
debug»g
[i];

172 ià(
dump
.
¡¬t_¡ack
 < 
TASK_SIZE
)

173 
dump
.
u_ssize
 = ((è(
TASK_SIZE
 - dump.
¡¬t_¡ack
)) >> 12;

176 ià((
dump
.
u_dsize
+dump.
u_ssize
+1è* 
PAGE_SIZE
 >

177 
cu¼’t
->
¾im
[
RLIMIT_CORE
].
¾im_cur
)

178 
dump
.
u_dsize
 = 0;

180 ià((
dump
.
u_ssize
+1è* 
PAGE_SIZE
 >

181 
cu¼’t
->
¾im
[
RLIMIT_CORE
].
¾im_cur
)

182 
dump
.
u_ssize
 = 0;

183 
	`¡ºıy
(
dump
.
u_comm
, 
cu¼’t
->
comm
, (current->comm));

184 
dump
.
u_¬0
 = (
±_»gs
 *)((()(&dump.
»gs
)) -(()(&dump)));

185 
dump
.
sigÇl
 = 
sigÄ
;

186 
dump
.
»gs
 = *regs;

189 ià(
h¬d_m©h
) {

190 ià((
dump
.
u_åv®id
 = 
cu¼’t
->
u£d_m©h
) != 0) {

191 ià(
Ï¡_sk_u£d_m©h
 =ğ
cu¼’t
)

192 
	`__asm__
("şt ; fn§v%0": :"m" (
dump
.
i387
));

194 
	`memıy
(&
dump
.
i387
,&
cu¼’t
->
tss
.i387.
h¬d
,(dump.i387));

199 
dump
.
u_åv®id
 = 0;

201 
	`£t_fs
(
KERNEL_DS
);

203 
	`DUMP_WRITE
(&
dump
,(dump));

205 
	`DUMP_SEEK
(
PAGE_SIZE
);

207 
	`£t_fs
(
USER_DS
);

209 ià(
dump
.
u_dsize
 != 0) {

210 
dump_¡¬t
 = 
dump
.
u_tsize
 << 12;

211 
dump_size
 = 
dump
.
u_dsize
 << 12;

212 
	`DUMP_WRITE
(
dump_¡¬t
,
dump_size
);

215 ià(
dump
.
u_ssize
 != 0) {

216 
dump_¡¬t
 = 
dump
.
¡¬t_¡ack
;

217 
dump_size
 = 
dump
.
u_ssize
 << 12;

218 
	`DUMP_WRITE
(
dump_¡¬t
,
dump_size
);

221 
	`£t_fs
(
KERNEL_DS
);

222 
	`DUMP_WRITE
(
cu¼’t
,(*current));

223 
şo£_cÜedump
:

224 ià(
fe
.
f_İ
->
»Ëa£
)

225 
fe
.
f_İ
->
	`»Ëa£
(
šode
,&file);

226 
’d_cÜedump
:

227 
	`£t_fs
(
fs
);

228 
	`ut
(
šode
);

229  
has_dum³d
;

230 
	}
}

238 
asmlškage
 
	$sys_u£lib
(cÚ¡ * 
lib¿ry
)

240 
fd
, 
»tv®
;

241 
fe
 * file;

242 
lšux_bšfmt
 * 
fmt
;

244 
fd
 = 
	`sys_İ’
(
lib¿ry
, 0, 0);

245 ià(
fd
 < 0)

246  
fd
;

247 
fe
 = 
cu¼’t
->
fp
[
fd
];

248 
»tv®
 = -
ENOEXEC
;

249 ià(
fe
 && fe->
f_šode
 && fe->
f_İ
 && fe->f_İ->
»ad
) {

250 
fmt
 = 
fÜm©s
;

252 (*
â
)(èğ
fmt
->
lßd_shlib
;

253 ià(!
â
)

255 
»tv®
 = 
	`â
(
fd
);

256 
fmt
++;

257 } 
»tv®
 =ğ-
ENOEXEC
);

259 
	`sys_şo£
(
fd
);

260  
»tv®
;

261 
	}
}

268 * 
	$ü—‹_bËs
(* 
p
,
¬gc
,
’vc
,
ibcs
)

270 *
¬gv
,*
’vp
;

271 * 
¥
;

272 
vm_¬—_¡ruù
 *
m²t
;

274 
m²t
 = (
vm_¬—_¡ruù
 *)
	`km®loc
((*m²t), 
GFP_KERNEL
);

275 ià(
m²t
) {

276 
m²t
->
vm_sk
 = 
cu¼’t
;

277 
m²t
->
vm_¡¬t
 = 
PAGE_MASK
 & (è
p
;

278 
m²t
->
vm_’d
 = 
TASK_SIZE
;

279 
m²t
->
vm_·ge_´Ù
 = 
PAGE_PRIVATE
|
PAGE_DIRTY
;

280 
m²t
->
vm_sh¬e
 = 
NULL
;

281 
m²t
->
vm_šode
 = 
NULL
;

282 
m²t
->
vm_off£t
 = 0;

283 
m²t
->
vm_İs
 = 
NULL
;

284 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

285 
cu¼’t
->
¡k_vma
 = 
m²t
;

287 
¥
 = (*è(0xfffffffø& (è
p
);

288 
¥
 -ğ
’vc
+1;

289 
’vp
 = 
¥
;

290 
¥
 -ğ
¬gc
+1;

291 
¬gv
 = 
¥
;

292 ià(!
ibcs
) {

293 
	`put_fs_lÚg
(()
’vp
,--
¥
);

294 
	`put_fs_lÚg
(()
¬gv
,--
¥
);

296 
	`put_fs_lÚg
(()
¬gc
,--
¥
);

297 
cu¼’t
->
¬g_¡¬t
 = (è
p
;

298 
¬gc
-->0) {

299 
	`put_fs_lÚg
((è
p
,
¬gv
++);

300 
	`g‘_fs_by‹
(
p
++)) ;

302 
	`put_fs_lÚg
(0,
¬gv
);

303 
cu¼’t
->
¬g_’d
 = cu¼’t->
’v_¡¬t
 = (è
p
;

304 
’vc
-->0) {

305 
	`put_fs_lÚg
((è
p
,
’vp
++);

306 
	`g‘_fs_by‹
(
p
++)) ;

308 
	`put_fs_lÚg
(0,
’vp
);

309 
cu¼’t
->
’v_’d
 = (è
p
;

310  
¥
;

311 
	}
}

316 
	$couÁ
(** 
¬gv
)

318 
i
=0;

319 ** 
tmp
;

321 ià((
tmp
 = 
¬gv
) != 0)

322 
	`g‘_fs_lÚg
((*è(
tmp
++)))

323 
i
++;

325  
i
;

326 
	}
}

345 
	$cİy_¡ršgs
(
¬gc
,** 
¬gv
,*
·ge
,

346 
p
, 
äom_kmem
)

348 *
tmp
, *
·g
 = 
NULL
;

349 
Ën
, 
off£t
 = 0;

350 
Şd_fs
, 
Ãw_fs
;

352 ià(!
p
)

354 
Ãw_fs
 = 
	`g‘_ds
();

355 
Şd_fs
 = 
	`g‘_fs
();

356 ià(
äom_kmem
==2)

357 
	`£t_fs
(
Ãw_fs
);

358 
¬gc
-- > 0) {

359 ià(
äom_kmem
 == 1)

360 
	`£t_fs
(
Ãw_fs
);

361 ià(!(
tmp
 = (*)
	`g‘_fs_lÚg
(((*)
¬gv
)+
¬gc
)))

362 
	`·nic
("VFS:‡rgc is wrong");

363 ià(
äom_kmem
 == 1)

364 
	`£t_fs
(
Şd_fs
);

365 
Ën
=0;

367 
Ën
++;

368 } 
	`g‘_fs_by‹
(
tmp
++));

369 ià(
p
 < 
Ën
) {

370 
	`£t_fs
(
Şd_fs
);

373 
Ën
) {

374 --
p
; --
tmp
; --
Ën
;

375 ià(--
off£t
 < 0) {

376 
off£t
 = 
p
 % 
PAGE_SIZE
;

377 ià(
äom_kmem
==2)

378 
	`£t_fs
(
Şd_fs
);

379 ià(!(
·g
 = (*è
·ge
[
p
/
PAGE_SIZE
]) &&

380 !(
·g
 = (*è
·ge
[
p
/
PAGE_SIZE
] =

381 (*è
	`g‘_ä“_·ge
(
GFP_USER
)))

383 ià(
äom_kmem
==2)

384 
	`£t_fs
(
Ãw_fs
);

387 *(
·g
 + 
off£t
èğ
	`g‘_fs_by‹
(
tmp
);

390 ià(
äom_kmem
==2)

391 
	`£t_fs
(
Şd_fs
);

392  
p
;

393 
	}
}

395 
	$chªge_ldt
(
‹xt_size
,* 
·ge
)

397 
code_lim™
,
d©a_lim™
,
code_ba£
,
d©a_ba£
;

398 
i
;

400 
code_lim™
 = 
TASK_SIZE
;

401 
d©a_lim™
 = 
TASK_SIZE
;

402 
code_ba£
 = 
d©a_ba£
 = 0;

403 
cu¼’t
->
¡¬t_code
 = 
code_ba£
;

404 
d©a_ba£
 +ğ
d©a_lim™
;

405 
i
=
MAX_ARG_PAGES
-1 ; i>=0 ; i--) {

406 
d©a_ba£
 -ğ
PAGE_SIZE
;

407 ià(
·ge
[
i
]) {

408 
cu¼’t
->
rss
++;

409 
	`put_dœty_·ge
(
cu¼’t
,
·ge
[
i
],
d©a_ba£
);

412  
d©a_lim™
;

413 
	}
}

420 
	$»ad_exec
(
šode
 *šode, 
off£t
,

421 * 
addr
, 
couÁ
)

423 
fe
 file;

424 
»suÉ
 = -
ENOEXEC
;

426 ià(!
šode
->
i_İ
 || !šode->i_İ->
deçuÉ_fe_İs
)

427 
’d_»adexec
;

428 
fe
.
f_mode
 = 1;

429 
fe
.
f_æags
 = 0;

430 
fe
.
f_couÁ
 = 1;

431 
fe
.
f_šode
 = 
šode
;

432 
fe
.
f_pos
 = 0;

433 
fe
.
f_»ada
 = 0;

434 
fe
.
f_İ
 = 
šode
->
i_İ
->
deçuÉ_fe_İs
;

435 ià(
fe
.
f_İ
->
İ’
)

436 ià(
fe
.
f_İ
->
	`İ’
(
šode
,&file))

437 
’d_»adexec
;

438 ià(!
fe
.
f_İ
 || !fe.f_İ->
»ad
)

439 
şo£_»adexec
;

440 ià(
fe
.
f_İ
->
l£ek
) {

441 ià(
fe
.
f_İ
->
	`l£ek
(
šode
,&fe,
off£t
,0) != offset)

442 
şo£_»adexec
;

444 
fe
.
f_pos
 = 
off£t
;

445 ià(
	`g‘_fs
(è=ğ
USER_DS
) {

446 
»suÉ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
addr
, 
couÁ
);

447 ià(
»suÉ
)

448 
şo£_»adexec
;

450 
»suÉ
 = 
fe
.
f_İ
->
	`»ad
(
šode
, &fe, 
addr
, 
couÁ
);

451 
şo£_»adexec
:

452 ià(
fe
.
f_İ
->
»Ëa£
)

453 
fe
.
f_İ
->
	`»Ëa£
(
šode
,&file);

454 
’d_»adexec
:

455  
»suÉ
;

456 
	}
}

464 
	$æush_Şd_exec
(
lšux_bš´m
 * 
b´m
)

466 
i
;

467 
ch
;

468 * 
Çme
;

469 
vm_¬—_¡ruù
 * 
m²t
, *
m²t1
;

471 
cu¼’t
->
dum·bË
 = 1;

472 
Çme
 = 
b´m
->
f’ame
;

473 
i
=0; (
ch
 = *(
Çme
++)) != '\0';) {

474 ià(
ch
 == '/')

475 
i
 = 0;

477 ià(
i
 < 15)

478 
cu¼’t
->
comm
[
i
++] = 
ch
;

480 
cu¼’t
->
comm
[
i
] = '\0';

481 ià(
cu¼’t
->
shm
)

482 
	`shm_ex™
();

483 ià(
cu¼’t
->
execubË
) {

484 
	`ut
(
cu¼’t
->
execubË
);

485 
cu¼’t
->
execubË
 = 
NULL
;

489 
m²t
 = 
cu¼’t
->
mm­
;

490 
cu¼’t
->
mm­
 = 
NULL
;

491 
cu¼’t
->
¡k_vma
 = 
NULL
;

492 
m²t
) {

493 
m²t1
 = 
m²t
->
vm_Ãxt
;

494 ià(
m²t
->
vm_İs
 && m²t->vm_İs->
şo£
)

495 
m²t
->
vm_İs
->
	`şo£
(mpnt);

496 
	`kä“
(
m²t
);

497 
m²t
 = 
m²t1
;

501 ià(
cu¼’t
->
ldt
) {

502 
	`ä“_·ge
((è
cu¼’t
->
ldt
);

503 
cu¼’t
->
ldt
 = 
NULL
;

504 
i
=1 ; i<
NR_TASKS
 ; i++) {

505 ià(
sk
[
i
] =ğ
cu¼’t
) {

506 
	`£t_ldt_desc
(
gdt
+(
i
<<1)+

507 
FIRST_LDT_ENTRY
,&
deçuÉ_ldt
, 1);

508 
	`lßd_ldt
(
i
);

513 
i
=0 ; i<8 ; i++è
cu¼’t
->
debug»g
[i] = 0;

515 ià(
b´m
->
e_uid
 !ğ
cu¼’t
->
euid
 || b´m->
e_gid
 !ğcu¼’t->
egid
 ||

516 !
	`³rmissiÚ
(
b´m
->
šode
,
MAY_READ
))

517 
cu¼’t
->
dum·bË
 = 0;

518 
cu¼’t
->
sigÇl
 = 0;

519 
i
=0 ; i<32 ; i++) {

520 
cu¼’t
->
sigaùiÚ
[
i
].
§_mask
 = 0;

521 
cu¼’t
->
sigaùiÚ
[
i
].
§_æags
 = 0;

522 ià(
cu¼’t
->
sigaùiÚ
[
i
].
§_hªdËr
 !ğ
SIG_IGN
)

523 
cu¼’t
->
sigaùiÚ
[
i
].
§_hªdËr
 = 
NULL
;

525 
i
=0 ; i<
NR_OPEN
 ; i++)

526 ià(
	`FD_ISSET
(
i
,&
cu¼’t
->
şo£_Ú_exec
))

527 
	`sys_şo£
(
i
);

528 
	`FD_ZERO
(&
cu¼’t
->
şo£_Ú_exec
);

529 
	`ş—r_·ge_bËs
(
cu¼’t
);

530 ià(
Ï¡_sk_u£d_m©h
 =ğ
cu¼’t
)

531 
Ï¡_sk_u£d_m©h
 = 
NULL
;

532 
cu¼’t
->
u£d_m©h
 = 0;

533 
cu¼’t
->
–f_execubË
 = 0;

534 
	}
}

539 
	$do_execve
(* 
f’ame
, ** 
¬gv
, ** 
’vp
, 
±_»gs
 * 
»gs
)

541 
lšux_bš´m
 
b´m
;

542 
lšux_bšfmt
 * 
fmt
;

543 
Şd_fs
;

544 
i
;

545 
»tv®
;

546 
sh_bªg
 = 0;

548 ià(
»gs
->
cs
 !ğ
USER_CS
)

549  -
EINVAL
;

550 
b´m
.
p
 = 
PAGE_SIZE
*
MAX_ARG_PAGES
-4;

551 
i
=0 ; i<
MAX_ARG_PAGES
 ; i++)

552 
b´m
.
·ge
[
i
] = 0;

553 
»tv®
 = 
	`İ’_Çmei
(
f’ame
, 0, 0, &
b´m
.
šode
, 
NULL
);

554 ià(
»tv®
)

555  
»tv®
;

556 
b´m
.
f’ame
 = filename;

557 
b´m
.
¬gc
 = 
	`couÁ
(
¬gv
);

558 
b´m
.
’vc
 = 
	`couÁ
(
’vp
);

560 
»¡¬t_š‹½
:

561 ià(!
	`S_ISREG
(
b´m
.
šode
->
i_mode
)) {

562 
»tv®
 = -
EACCES
;

563 
exec_”rÜ2
;

565 ià(
	`IS_NOEXEC
(
b´m
.
šode
)) {

566 
»tv®
 = -
EPERM
;

567 
exec_”rÜ2
;

569 ià(!
b´m
.
šode
->
i_sb
) {

570 
»tv®
 = -
EACCES
;

571 
exec_”rÜ2
;

573 
i
 = 
b´m
.
šode
->
i_mode
;

574 ià(
	`IS_NOSUID
(
b´m
.
šode
è&& (((
i
 & 
S_ISUID
è&& b´m.šode->
i_uid
 !ğ
cu¼’t
->

575 
euid
è|| ((
i
 & 
S_ISGID
è&& !
	`š_group_p
(
b´m
.
šode
->
i_gid
))) &&

576 !
	`su£r
()) {

577 
»tv®
 = -
EPERM
;

578 
exec_”rÜ2
;

581 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
) {

582 
b´m
.
e_uid
 = 
cu¼’t
->
euid
;

583 
b´m
.
e_gid
 = 
cu¼’t
->
egid
;

585 
b´m
.
e_uid
 = (
i
 & 
S_ISUID
è? b´m.
šode
->
i_uid
 : 
cu¼’t
->
euid
;

586 
b´m
.
e_gid
 = (
i
 & 
S_ISGID
è? b´m.
šode
->
i_gid
 : 
cu¼’t
->
egid
;

588 ià(
cu¼’t
->
euid
 =ğ
b´m
.
šode
->
i_uid
)

589 
i
 >>= 6;

590 ià(
	`š_group_p
(
b´m
.
šode
->
i_gid
))

591 
i
 >>= 3;

592 ià(!(
i
 & 1) &&

593 !((
b´m
.
šode
->
i_mode
 & 0111è&& 
	`su£r
())) {

594 
»tv®
 = -
EACCES
;

595 
exec_”rÜ2
;

597 
	`mem£t
(
b´m
.
buf
,0,(bprm.buf));

598 
Şd_fs
 = 
	`g‘_fs
();

599 
	`£t_fs
(
	`g‘_ds
());

600 
»tv®
 = 
	`»ad_exec
(
b´m
.
šode
,0,b´m.
buf
,128);

601 
	`£t_fs
(
Şd_fs
);

602 ià(
»tv®
 < 0)

603 
exec_”rÜ2
;

604 ià((
b´m
.
buf
[0] =ğ'#'è&& (b´m.buf[1] =ğ'!'è&& (!
sh_bªg
)) {

610 *
ı
, *
š‹½
, *
i_Çme
, *
i_¬g
;

612 
	`ut
(
b´m
.
šode
);

613 
b´m
.
buf
[127] = '\0';

614 ià((
ı
 = 
	`¡rchr
(
b´m
.
buf
, '\n')è=ğ
NULL
)

615 
ı
 = 
b´m
.
buf
+127;

616 *
ı
 = '\0';

617 
ı
 > 
b´m
.
buf
) {

618 
ı
--;

619 ià((*
ı
 == ' ') || (*cp == '\t'))

620 *
ı
 = '\0';

624 
ı
 = 
b´m
.
buf
+2; (*cp == ' ') || (*cp == '\t'); cp++);

625 ià(!
ı
 || *cp == '\0') {

626 
»tv®
 = -
ENOEXEC
;

627 
exec_”rÜ1
;

629 
š‹½
 = 
i_Çme
 = 
ı
;

630 
i_¬g
 = 0;

631  ; *
ı
 && (*cp != ' ') && (*cp != '\t'); cp++) {

632 ià(*
ı
 == '/')

633 
i_Çme
 = 
ı
+1;

635 (*
ı
 == ' ') || (*cp == '\t'))

636 *
ı
++ = '\0';

637 ià(*
ı
)

638 
i_¬g
 = 
ı
;

643 ià(
sh_bªg
++ == 0) {

644 
b´m
.
p
 = 
	`cİy_¡ršgs
(b´m.
’vc
, 
’vp
, b´m.
·ge
, bprm.p, 0);

645 
b´m
.
p
 = 
	`cİy_¡ršgs
(--b´m.
¬gc
, 
¬gv
+1, b´m.
·ge
, bprm.p, 0);

655 
b´m
.
p
 = 
	`cİy_¡ršgs
(1, &b´m.
f’ame
, b´m.
·ge
, bprm.p, 2);

656 
b´m
.
¬gc
++;

657 ià(
i_¬g
) {

658 
b´m
.
p
 = 
	`cİy_¡ršgs
(1, &
i_¬g
, b´m.
·ge
, bprm.p, 2);

659 
b´m
.
¬gc
++;

661 
b´m
.
p
 = 
	`cİy_¡ršgs
(1, &
i_Çme
, b´m.
·ge
, bprm.p, 2);

662 
b´m
.
¬gc
++;

663 ià(!
b´m
.
p
) {

664 
»tv®
 = -
E2BIG
;

665 
exec_”rÜ1
;

672 
»tv®
 = 
	`İ’_Çmei
(
š‹½
, 0, 0, &
b´m
.
šode
, 
NULL
);

673 ià(
»tv®
)

674 
exec_”rÜ1
;

675 
»¡¬t_š‹½
;

677 ià(!
sh_bªg
) {

678 
b´m
.
p
 = 
	`cİy_¡ršgs
(b´m.
’vc
,
’vp
,b´m.
·ge
,bprm.p,0);

679 
b´m
.
p
 = 
	`cİy_¡ršgs
(b´m.
¬gc
,
¬gv
,b´m.
·ge
,bprm.p,0);

680 ià(!
b´m
.
p
) {

681 
»tv®
 = -
E2BIG
;

682 
exec_”rÜ2
;

686 
b´m
.
sh_bªg
 = sh_bang;

687 
fmt
 = 
fÜm©s
;

689 (*
â
)(
lšux_bš´m
 *, 
±_»gs
 *èğ
fmt
->
lßd_bš¬y
;

690 ià(!
â
)

692 
»tv®
 = 
	`â
(&
b´m
, 
»gs
);

693 ià(
»tv®
 == 0) {

694 
	`ut
(
b´m
.
šode
);

695 
cu¼’t
->
did_exec
 = 1;

698 
fmt
++;

699 } 
»tv®
 =ğ-
ENOEXEC
);

700 
exec_”rÜ2
:

701 
	`ut
(
b´m
.
šode
);

702 
exec_”rÜ1
:

703 
i
=0 ; i<
MAX_ARG_PAGES
 ; i++)

704 
	`ä“_·ge
(
b´m
.
·ge
[
i
]);

705 (
»tv®
);

706 
	}
}

711 
asmlškage
 
	$sys_execve
(
±_»gs
 
»gs
)

713 
”rÜ
;

714 * 
f’ame
;

716 
”rÜ
 = 
	`g‘Çme
((*è
»gs
.
ebx
, &
f’ame
);

717 ià(
”rÜ
)

718  
”rÜ
;

719 
”rÜ
 = 
	`do_execve
(
f’ame
, (**è
»gs
.
ecx
, (**è»gs.
edx
, &regs);

720 
	`puŠame
(
f’ame
);

721  
”rÜ
;

722 
	}
}

729 
lßd_aout_bš¬y
(
lšux_bš´m
 *,

730 
±_»gs
 * 
»gs
);

731 
lßd_aout_lib¿ry
(
fd
);

733 #ifdeà
CONFIG_BINFMT_ELF


734 
lßd_–f_bš¬y
(
lšux_bš´m
 *,

735 
±_»gs
 * 
»gs
);

736 
lßd_–f_lib¿ry
(
fd
);

739 #ifdeà
CONFIG_BINFMT_COFF


740 
lßd_coff_bš¬y
(
lšux_bš´m
 *,

741 
±_»gs
 * 
»gs
);

742 
lßd_coff_lib¿ry
(
fd
);

746 
lšux_bšfmt
 
	gfÜm©s
[] = {

747 {
lßd_aout_bš¬y
, 
lßd_aout_lib¿ry
},

748 #ifdeà
CONFIG_BINFMT_ELF


749 {
lßd_–f_bš¬y
, 
lßd_–f_lib¿ry
},

751 #ifdeà
CONFIG_BINFMT_COFF


752 {
lßd_coff_bš¬y
, 
lßd_coff_lib¿ry
},

754 {
NULL
, NULL}

762 
	$lßd_aout_bš¬y
(
lšux_bš´m
 * 
b´m
, 
±_»gs
 * 
»gs
)

764 
exec
 
ex
;

765 
fe
 * file;

766 
fd
, 
”rÜ
;

767 
p
 = 
b´m
->p;

769 
ex
 = *((
exec
 *è
b´m
->
buf
);

770 ià((
	`N_MAGIC
(
ex
è!ğ
ZMAGIC
 && N_MAGICÓxè!ğ
OMAGIC
 &&

771 
	`N_MAGIC
(
ex
è!ğ
QMAGIC
) ||

772 
ex
.
a_Œsize
 ||ƒx.
a_drsize
 ||

773 
b´m
->
šode
->
i_size
 < 
ex
.
a_‹xt
+ex.
a_d©a
+ex.
a_syms
+
	`N_TXTOFF
(ex)) {

774  -
ENOEXEC
;

777 ià(
	`N_MAGIC
(
ex
è=ğ
ZMAGIC
 &&

778 (
	`N_TXTOFF
(
ex
è< 
b´m
->
šode
->
i_sb
->
s_blocksize
)) {

779 
	`´štk
("N_TXTOFF < BLOCK_SIZE. Please convert binary.");

780  -
ENOEXEC
;

783 ià(
	`N_TXTOFF
(
ex
è!ğ
BLOCK_SIZE
 && 
	`N_MAGIC
Óxè=ğ
ZMAGIC
) {

784 
	`´štk
("N_TXTOFF != BLOCK_SIZE. See‡.out.h.");

785  -
ENOEXEC
;

789 
	`æush_Şd_exec
(
b´m
);

791 
cu¼’t
->
’d_code
 = 
	`N_TXTADDR
(
ex
è+ƒx.
a_‹xt
;

792 
cu¼’t
->
’d_d©a
 = 
ex
.
a_d©a
 + cu¼’t->
’d_code
;

793 
cu¼’t
->
¡¬t_brk
 = cu¼’t->
brk
 = cu¼’t->
’d_d©a
;

794 
cu¼’t
->
¡¬t_code
 +ğ
	`N_TXTADDR
(
ex
);

795 
cu¼’t
->
rss
 = 0;

796 
cu¼’t
->
suid
 = cu¼’t->
euid
 = 
b´m
->
e_uid
;

797 
cu¼’t
->
mm­
 = 
NULL
;

798 
cu¼’t
->
execubË
 = 
NULL
;

799 
cu¼’t
->
sgid
 = cu¼’t->
egid
 = 
b´m
->
e_gid
;

800 ià(
	`N_MAGIC
(
ex
è=ğ
OMAGIC
) {

801 
	`do_mm­
(
NULL
, 0, 
ex
.
a_‹xt
+ex.
a_d©a
,

802 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

803 
MAP_FIXED
|
MAP_PRIVATE
, 0);

804 
	`»ad_exec
(
b´m
->
šode
, 32, (*è0, 
ex
.
a_‹xt
+ex.
a_d©a
);

806 ià(
ex
.
a_‹xt
 & 0xffà||ƒx.
a_d©a
 & 0xfff)

807 
	`´štk
("%s:ƒxecubË‚Ù…ag®igÃd\n", 
cu¼’t
->
comm
);

809 
fd
 = 
	`İ’_šode
(
b´m
->
šode
, 
O_RDONLY
);

811 ià(
fd
 < 0)

812  
fd
;

813 
fe
 = 
cu¼’t
->
fp
[
fd
];

814 ià(!
fe
->
f_İ
 || !fe->f_İ->
mm­
) {

815 
	`sys_şo£
(
fd
);

816 
	`do_mm­
(
NULL
, 0, 
ex
.
a_‹xt
+ex.
a_d©a
,

817 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

818 
MAP_FIXED
|
MAP_PRIVATE
, 0);

819 
	`»ad_exec
(
b´m
->
šode
, 
	`N_TXTOFF
(
ex
),

820 (*è
	`N_TXTADDR
(
ex
),ƒx.
a_‹xt
+ex.
a_d©a
);

821 
beyÚd_if
;

823 
”rÜ
 = 
	`do_mm­
(
fe
, 
	`N_TXTADDR
(
ex
),ƒx.
a_‹xt
,

824 
PROT_READ
 | 
PROT_EXEC
,

825 
MAP_FIXED
 | 
MAP_SHARED
, 
	`N_TXTOFF
(
ex
));

827 ià(
”rÜ
 !ğ
	`N_TXTADDR
(
ex
)) {

828 
	`sys_şo£
(
fd
);

829 
	`£nd_sig
(
SIGSEGV
, 
cu¼’t
, 0);

833 
”rÜ
 = 
	`do_mm­
(
fe
, 
	`N_TXTADDR
(
ex
è+ƒx.
a_‹xt
,ƒx.
a_d©a
,

834 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
,

835 
MAP_FIXED
 | 
MAP_PRIVATE
, 
	`N_TXTOFF
(
ex
è+ƒx.
a_‹xt
);

836 
	`sys_şo£
(
fd
);

837 ià(
”rÜ
 !ğ
	`N_TXTADDR
(
ex
è+ƒx.
a_‹xt
) {

838 
	`£nd_sig
(
SIGSEGV
, 
cu¼’t
, 0);

841 
cu¼’t
->
execubË
 = 
b´m
->
šode
;

842 
b´m
->
šode
->
i_couÁ
++;

844 
beyÚd_if
:

845 
	`sys_brk
(
cu¼’t
->
brk
+
ex
.
a_bss
);

847 
p
 +ğ
	`chªge_ldt
(
ex
.
a_‹xt
,
b´m
->
·ge
);

848 
p
 -ğ
MAX_ARG_PAGES
*
PAGE_SIZE
;

849 
p
 = (è
	`ü—‹_bËs
((*í,
b´m
->
¬gc
,b´m->
’vc
,0);

850 
cu¼’t
->
¡¬t_¡ack
 = 
p
;

851 
»gs
->
e
 = 
ex
.
a_’Œy
;

852 
»gs
->
e¥
 = 
p
;

853 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

854 
	`£nd_sig
(
SIGTRAP
, 
cu¼’t
, 0);

856 
	}
}

859 
	$lßd_aout_lib¿ry
(
fd
)

861 
fe
 * file;

862 
exec
 
ex
;

863 
šode
 * inode;

864 
Ën
;

865 
bss
;

866 
¡¬t_addr
;

867 
”rÜ
;

869 
fe
 = 
cu¼’t
->
fp
[
fd
];

870 
šode
 = 
fe
->
f_šode
;

872 
	`£t_fs
(
KERNEL_DS
);

873 ià(
fe
->
f_İ
->
	`»ad
(
šode
, fe, (*è&
ex
, (ex)) != (ex)) {

874  -
EACCES
;

876 
	`£t_fs
(
USER_DS
);

879 ià((
	`N_MAGIC
(
ex
è!ğ
ZMAGIC
 && N_MAGICÓxè!ğ
QMAGIC
è||ƒx.
a_Œsize
 ||

880 
ex
.
a_drsize
 || (Óx.
a_’Œy
 & 0xfffè&& 
	`N_MAGIC
Óxè=ğ
ZMAGIC
) ||

881 
šode
->
i_size
 < 
ex
.
a_‹xt
+ex.
a_d©a
+ex.
a_syms
+
	`N_TXTOFF
(ex)) {

882  -
ENOEXEC
;

884 ià(
	`N_MAGIC
(
ex
è=ğ
ZMAGIC
 && 
	`N_TXTOFF
(ex) &&

885 (
	`N_TXTOFF
(
ex
è< 
šode
->
i_sb
->
s_blocksize
)) {

886 
	`´štk
("N_TXTOFF < BLOCK_SIZE. Please convert†ibrary\n");

887  -
ENOEXEC
;

890 ià(
	`N_FLAGS
(
ex
)è -
ENOEXEC
;

895 
¡¬t_addr
 = 
ex
.
a_’Œy
 & 0xfffff000;

898 
”rÜ
 = 
	`do_mm­
(
fe
, 
¡¬t_addr
, 
ex
.
a_‹xt
 +ƒx.
a_d©a
,

899 
PROT_READ
 | 
PROT_WRITE
 | 
PROT_EXEC
, 
MAP_FIXED
 | 
MAP_PRIVATE
,

900 
	`N_TXTOFF
(
ex
));

901 ià(
”rÜ
 !ğ
¡¬t_addr
)

902  
”rÜ
;

903 
Ën
 = 
	`PAGE_ALIGN
(
ex
.
a_‹xt
 +ƒx.
a_d©a
);

904 
bss
 = 
ex
.
a_‹xt
 +ƒx.
a_d©a
 +ƒx.
a_bss
;

905 ià(
bss
 > 
Ën
)

906 
	`do_mm­
(
NULL
, 
¡¬t_addr
 + 
Ën
, 
bss
-len,

907 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

908 
MAP_PRIVATE
|
MAP_FIXED
, 0);

910 
	}
}

	@fs/ext/dir.c

15 
	~<asm/£gm’t.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/fs.h
>

20 
	~<lšux/ext_fs.h
>

21 
	~<lšux/¡©.h
>

23 
	$ext_dœ_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

25  -
EISDIR
;

26 
	}
}

28 
ext_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

30 
fe_İ”©iÚs
 
	gext_dœ_İ”©iÚs
 = {

31 
NULL
,

32 
ext_dœ_»ad
,

33 
NULL
,

34 
ext_»addœ
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
fe_fsync


46 
šode_İ”©iÚs
 
	gext_dœ_šode_İ”©iÚs
 = {

47 &
ext_dœ_İ”©iÚs
,

48 
ext_ü—‹
,

49 
ext_lookup
,

50 
ext_lšk
,

51 
ext_uÆšk
,

52 
ext_symlšk
,

53 
ext_mkdœ
,

54 
ext_rmdœ
,

55 
ext_mknod
,

56 
ext_»Çme
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
ext_Œunÿ‹
,

61 
NULL


64 
	$ext_»addœ
(
šode
 * inode, 
fe
 * 
fp
,

65 
dœ’t
 * dœ’t, 
couÁ
)

67 
off£t
,
i
;

68 
c
;

69 
bufãr_h—d
 * 
bh
;

70 
ext_dœ_’Œy
 * 
de
;

72 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

73  -
EBADF
;

74 ià(
fp
->
f_pos
 % 8 != 0)

75  -
EBADF
;

76 
fp
->
f_pos
 < 
šode
->
i_size
) {

77 
off£t
 = 
fp
->
f_pos
 & 1023;

78 
bh
 = 
	`ext_b»ad
(
šode
,(
fp
->
f_pos
)>>
BLOCK_SIZE_BITS
,0);

79 ià(!
bh
) {

80 
fp
->
f_pos
 +ğ1024-
off£t
;

83 
de
 = (
ext_dœ_’Œy
 *è(
off£t
 + 
bh
->
b_d©a
);

84 
off£t
 < 1024 && 
fp
->
f_pos
 < 
šode
->
i_size
) {

85 ià(
de
->
»c_Ën
 < 8 || de->rec_len % 8 != 0 ||

86 
de
->
»c_Ën
 < de->
Çme_Ën
 + 8 ||

87 (
de
->
»c_Ën
 + 
fp
->
f_pos
 - 1) / 1024 > (filp->f_pos / 1024)) {

88 
	`´štk
 ("ext_readdir: bad dirƒntry, skipping\n");

89 
	`´štk
 ("dev=%d, dir=%d, offset=%d,„ec_len=%d,‚ame_len=%d\n",

90 
šode
->
i_dev
, inode->
i_šo
, 
off£t
, 
de
->
»c_Ën
, de->
Çme_Ën
);

91 
fp
->
f_pos
 +ğ1024-
off£t
;

92 ià(
fp
->
f_pos
 > 
šode
->
i_size
)

93 
fp
->
f_pos
 = 
šode
->
i_size
;

96 
off£t
 +ğ
de
->
»c_Ën
;

97 
fp
->
f_pos
 +ğ
de
->
»c_Ën
;

98 ià(
de
->
šode
) {

99 
i
 = 0; i < 
de
->
Çme_Ën
; i++)

100 ià((
c
 = 
de
->
Çme
[
i
]) != 0)

101 
	`put_fs_by‹
(
c
,
i
+
dœ’t
->
d_Çme
);

104 ià(
i
) {

105 
	`put_fs_lÚg
(
de
->
šode
,&
dœ’t
->
d_šo
);

106 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

107 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

108 
	`b»l£
(
bh
);

109  
i
;

112 
de
 = (
ext_dœ_’Œy
 *) ((*) de

113 + 
de
->
»c_Ën
);

115 
	`b»l£
(
bh
);

118 
	}
}

	@fs/ext/file.c

15 
	~<asm/£gm’t.h
>

16 
	~<asm/sy¡em.h
>

18 
	~<lšux/sched.h
>

19 
	~<lšux/ext_fs.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/fú.h
>

23 
	~<lšux/¡©.h
>

24 
	~<lšux/locks.h
>

26 
	#NBUF
 32

	)

28 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

29 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

31 
	~<lšux/fs.h
>

32 
	~<lšux/ext_fs.h
>

34 
ext_fe_»ad
(
šode
 *, 
fe
 *, *, );

35 
ext_fe_wr™e
(
šode
 *, 
fe
 *, *, );

41 
fe_İ”©iÚs
 
	gext_fe_İ”©iÚs
 = {

42 
NULL
,

43 
ext_fe_»ad
,

44 
ext_fe_wr™e
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
g’”ic_mm­
,

49 
NULL
,

50 
NULL
,

51 
ext_sync_fe


54 
šode_İ”©iÚs
 
	gext_fe_šode_İ”©iÚs
 = {

55 &
ext_fe_İ”©iÚs
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
ext_bm­
,

68 
ext_Œunÿ‹
,

69 
NULL


72 
	$ext_fe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

74 
»ad
,
Ëá
,
ch¬s
;

75 
block
, 
blocks
, 
off£t
;

76 
bh»que¡
, 
u±od©e
;

77 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

78 
bufãr_h—d
 * 
bh»q
[
NBUF
];

79 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

80 
size
;

82 ià(!
šode
) {

83 
	`´štk
("ext_file_read: inode = NULL\n");

84  -
EINVAL
;

86 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

87 
	`´štk
("ext_fe_»ad: modğ%07o\n",
šode
->
i_mode
);

88  -
EINVAL
;

90 
off£t
 = 
fp
->
f_pos
;

91 
size
 = 
šode
->
i_size
;

92 ià(
off£t
 > 
size
)

93 
Ëá
 = 0;

95 
Ëá
 = 
size
 - 
off£t
;

96 ià(
Ëá
 > 
couÁ
)

97 
Ëá
 = 
couÁ
;

98 ià(
Ëá
 <= 0)

100 
»ad
 = 0;

101 
block
 = 
off£t
 >> 
BLOCK_SIZE_BITS
;

102 
off£t
 &ğ
BLOCK_SIZE
-1;

103 
size
 = (siz+ (
BLOCK_SIZE
-1)è>> 
BLOCK_SIZE_BITS
;

104 
blocks
 = (
Ëá
 + 
off£t
 + 
BLOCK_SIZE
 - 1è>> 
BLOCK_SIZE_BITS
;

105 
bhb
 = 
bhe
 = 
buæi¡
;

106 ià(
fp
->
f_»ada
) {

107 
blocks
 +ğ
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] / (
BLOCK_SIZE
 >> 9);

108 ià(
block
 + 
blocks
 > 
size
)

109 
blocks
 = 
size
 - 
block
;

123 
bh»que¡
 = 0;

124 
u±od©e
 = 1;

125 
blocks
) {

126 --
blocks
;

127 *
bhb
 = 
	`ext_g‘blk
(
šode
, 
block
++, 0);

128 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

129 
u±od©e
 = 0;

130 
bh»q
[
bh»que¡
++] = *
bhb
;

133 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

134 
bhb
 = 
buæi¡
;

138 ià(
u±od©e
)

140 ià(
bhb
 =ğ
bhe
)

145 ià(
bh»que¡
)

146 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

149 ià(*
bhe
) {

150 
	`wa™_Ú_bufãr
(*
bhe
);

151 ià(!(*
bhe
)->
b_u±od©e
) {

152 
	`b»l£
(*
bhe
);

153 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

154 
bhe
 = 
buæi¡
;

155 
Ëá
 = 0;

159 ià(
Ëá
 < 
BLOCK_SIZE
 - 
off£t
)

160 
ch¬s
 = 
Ëá
;

162 
ch¬s
 = 
BLOCK_SIZE
 - 
off£t
;

163 
fp
->
f_pos
 +ğ
ch¬s
;

164 
Ëá
 -ğ
ch¬s
;

165 
»ad
 +ğ
ch¬s
;

166 ià(*
bhe
) {

167 
	`memıy_tofs
(
buf
,
off£t
+(*
bhe
)->
b_d©a
,
ch¬s
);

168 
	`b»l£
(*
bhe
);

169 
buf
 +ğ
ch¬s
;

171 
ch¬s
-->0)

172 
	`put_fs_by‹
(0,
buf
++);

174 
off£t
 = 0;

175 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

176 
bhe
 = 
buæi¡
;

177 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!*bh|| !(*bhe)->
b_lock
));

178 } 
Ëá
 > 0);

181 
bhe
 !ğ
bhb
) {

182 
	`b»l£
(*
bhe
);

183 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

184 
bhe
 = 
buæi¡
;

186 ià(!
»ad
)

187  -
EIO
;

188 
fp
->
f_»ada
 = 1;

189 ià(!
	`IS_RDONLY
(
šode
)) {

190 
šode
->
i_©ime
 = 
CURRENT_TIME
;

191 
šode
->
i_dœt
 = 1;

193  
»ad
;

194 
	}
}

196 
	$ext_fe_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

198 
off_t
 
pos
;

199 
wr™‹n
,
c
;

200 
bufãr_h—d
 * 
bh
;

201 * 
p
;

203 ià(!
šode
) {

204 
	`´štk
("ext_file_write: inode = NULL\n");

205  -
EINVAL
;

207 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

208 
	`´štk
("ext_fe_wr™e: modğ%07o\n",
šode
->
i_mode
);

209  -
EINVAL
;

215 ià(
fp
->
f_æags
 & 
O_APPEND
)

216 
pos
 = 
šode
->
i_size
;

218 
pos
 = 
fp
->
f_pos
;

219 
wr™‹n
 = 0;

220 
wr™‹n
<
couÁ
) {

221 
bh
 = 
	`ext_g‘blk
(
šode
,
pos
/
BLOCK_SIZE
,1);

222 ià(!
bh
) {

223 ià(!
wr™‹n
)

224 
wr™‹n
 = -
ENOSPC
;

227 
c
 = 
BLOCK_SIZE
 - (
pos
 % BLOCK_SIZE);

228 ià(
c
 > 
couÁ
-
wr™‹n
)

229 
c
 = 
couÁ
-
wr™‹n
;

230 ià(
c
 !ğ
BLOCK_SIZE
 && !
bh
->
b_u±od©e
) {

231 
	`Î_rw_block
(
READ
, 1, &
bh
);

232 
	`wa™_Ú_bufãr
(
bh
);

233 ià(!
bh
->
b_u±od©e
) {

234 
	`b»l£
(
bh
);

235 ià(!
wr™‹n
)

236 
wr™‹n
 = -
EIO
;

240 
p
 = (
pos
 % 
BLOCK_SIZE
è+ 
bh
->
b_d©a
;

241 
pos
 +ğ
c
;

242 ià(
pos
 > 
šode
->
i_size
) {

243 
šode
->
i_size
 = 
pos
;

244 
šode
->
i_dœt
 = 1;

246 
wr™‹n
 +ğ
c
;

247 
	`memıy_äomfs
(
p
,
buf
,
c
);

248 
buf
 +ğ
c
;

249 
bh
->
b_u±od©e
 = 1;

250 
bh
->
b_dœt
 = 1;

251 
	`b»l£
(
bh
);

253 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

254 
fp
->
f_pos
 = 
pos
;

255 
šode
->
i_dœt
 = 1;

256  
wr™‹n
;

257 
	}
}

	@fs/ext/freelists.c

33 
	~<lšux/sched.h
>

34 
	~<lšux/ext_fs.h
>

35 
	~<lšux/¡©.h
>

36 
	~<lšux/k”Ãl.h
>

37 
	~<lšux/¡ršg.h
>

38 
	~<lšux/locks.h
>

40 
	#ş—r_block
(
addr
) \

41 
	`__asm__
("cld\n\t" \

45 :"a" (0),"c" (
BLOCK_SIZE
/4),"D" ((è(
addr
)):"cx","di")

	)

47 
	$ext_ä“_block
(
su³r_block
 * 
sb
, 
block
)

49 
bufãr_h—d
 * 
bh
;

50 
ext_ä“_block
 * 
efb
;

52 ià(!
sb
) {

53 
	`´štk
("tryingo free block on‚on-existent device\n");

56 
	`lock_su³r
 (
sb
);

57 ià(
block
 < 
sb
->
u
.
ext_sb
.
s_fœ¡d©azÚe
 ||

58 
block
 >ğ
sb
->
u
.
ext_sb
.
s_nzÚes
) {

59 
	`´štk
("tryingo free block‚ot in datazone\n");

62 
bh
 = 
	`g‘_hash_bË
(
sb
->
s_dev
, 
block
, sb->
s_blocksize
);

63 ià(
bh
)

64 
bh
->
b_dœt
=0;

65 
	`b»l£
(
bh
);

66 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
)

67 
efb
 = (
ext_ä“_block
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_d©a
;

68 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
 || 
efb
->
couÁ
 == 254) {

69 #ifdeà
EXTFS_DEBUG


70 
	`´štk
("ext_ä“_block: block fuÎ, skpšgØ%d\n", 
block
);

72 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
)

73 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
);

74 ià(!(
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
 = 
	`b»ad
 (sb->
s_dev
,

75 
block
, 
sb
->
s_blocksize
)))

76 
	`·nic
 ("ext_free_block: unableo„ead blocko free\n");

77 
efb
 = (
ext_ä“_block
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_d©a
;

78 
efb
->
Ãxt
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
;

79 
efb
->
couÁ
 = 0;

80 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
 = 
block
;

82 
efb
->
ä“
[efb->
couÁ
++] = 
block
;

84 
sb
->
u
.
ext_sb
.
s_ä“blockscouÁ
 ++;

85 
sb
->
s_dœt
 = 1;

86 
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_dœt
 = 1;

87 
	`uÆock_su³r
 (
sb
);

89 
	}
}

91 
	$ext_Ãw_block
(
su³r_block
 * 
sb
)

93 
bufãr_h—d
 * 
bh
;

94 
ext_ä“_block
 * 
efb
;

95 
j
;

97 ià(!
sb
) {

98 
	`´štk
("tryingo get‚ew block from‚on-existent device\n");

101 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
)

103 
	`lock_su³r
 (
sb
);

104 
efb
 = (
ext_ä“_block
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_d©a
;

105 ià(
efb
->
couÁ
) {

106 
j
 = 
efb
->
ä“
[--efb->
couÁ
];

107 
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_dœt
 = 1;

109 #ifdeà
EXTFS_DEBUG


110 
	`´štk
("ext_Ãw_block: blockƒm±y, skpšgØ%d\n", 
efb
->
Ãxt
);

112 
j
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
;

113 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
 = 
efb
->
Ãxt
;

114 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
);

115 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
) {

116 
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
 = 
NULL
;

118 ià(!(
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
 = 
	`b»ad
 (sb->
s_dev
,

119 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
,

120 
sb
->
s_blocksize
)))

121 
	`·nic
 ("ext_new_block: unableo„ead‚ext free block\n");

124 ià(
j
 < 
sb
->
u
.
ext_sb
.
s_fœ¡d©azÚe
 || j > sb->u.ext_sb.
s_nzÚes
) {

125 
	`´štk
 ("ext_Ãw_block: blk = %d\n", 
j
);

126 
	`´štk
("allocating block‚ot in data zone\n");

129 
sb
->
u
.
ext_sb
.
s_ä“blockscouÁ
 --;

130 
sb
->
s_dœt
 = 1;

132 ià(!(
bh
=
	`g‘blk
(
sb
->
s_dev
, 
j
, sb->
s_blocksize
))) {

133 
	`´štk
("new_block: cannot get block");

136 
	`ş—r_block
(
bh
->
b_d©a
);

137 
bh
->
b_u±od©e
 = 1;

138 
bh
->
b_dœt
 = 1;

139 
	`b»l£
(
bh
);

140 #ifdeà
EXTFS_DEBUG


141 
	`´štk
("ext_Ãw_block:‡Îoÿtšg block %d\n", 
j
);

143 
	`uÆock_su³r
 (
sb
);

144  
j
;

145 
	}
}

147 
	$ext_couÁ_ä“_blocks
(
su³r_block
 *
sb
)

149 #ifdeà
EXTFS_DEBUG


150 
bufãr_h—d
 * 
bh
;

151 
ext_ä“_block
 * 
efb
;

152 
couÁ
, 
block
;

154 
	`lock_su³r
 (
sb
);

155 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
)

156 
couÁ
 = 0;

158 
efb
 = (
ext_ä“_block
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
->
b_d©a
;

159 
couÁ
 = 
efb
->count + 1;

160 
block
 = 
efb
->
Ãxt
;

161 
block
) {

162 ià(!(
bh
 = 
	`b»ad
 (
sb
->
s_dev
, 
block
, sb->
s_blocksize
))) {

163 
	`´štk
 ("ext_count_free:ƒrror while„eading free blocks†ist\n");

164 
block
 = 0;

166 
efb
 = (
ext_ä“_block
 *è
bh
->
b_d©a
;

167 
couÁ
 +ğ
efb
->count + 1;

168 
block
 = 
efb
->
Ãxt
;

169 
	`b»l£
 (
bh
);

173 
	`´štk
("ext_count_free_blocks: stored = %d, computed = %d\n",

174 
sb
->
u
.
ext_sb
.
s_ä“blockscouÁ
, 
couÁ
);

175 
	`uÆock_su³r
 (
sb
);

176  
couÁ
;

178  
sb
->
u
.
ext_sb
.
s_ä“blockscouÁ
;

180 
	}
}

182 
	$ext_ä“_šode
(
šode
 * inode)

184 
bufãr_h—d
 * 
bh
;

185 
ext_ä“_šode
 * 
efi
;

186 
su³r_block
 * 
sb
;

187 
block
;

188 
šo
;

189 
dev_t
 
dev
;

191 ià(!
šode
)

193 ià(!
šode
->
i_dev
) {

194 
	`´štk
("free_inode: inode has‚o device\n");

197 ià(
šode
->
i_couÁ
 != 1) {

198 
	`´štk
("ä“_šode: inodha couÁ=%d\n",
šode
->
i_couÁ
);

201 ià(
šode
->
i_Æšk
) {

202 
	`´štk
("ä“_šode: inodha Æšk=%d\n",
šode
->
i_Æšk
);

205 ià(!
šode
->
i_sb
) {

206 
	`´štk
("free_inode: inode on‚on-existent device\n");

209 
sb
 = 
šode
->
i_sb
;

210 
šo
 = 
šode
->
i_šo
;

211 
dev
 = 
šode
->
i_dev
;

212 
	`ş—r_šode
(
šode
);

213 
	`lock_su³r
 (
sb
);

214 ià(
šo
 < 1 || inØ> 
sb
->
u
.
ext_sb
.
s_nšodes
) {

215 
	`´štk
("free_inode: inode 0 or‚on-existent inode\n");

216 
	`uÆock_su³r
 (
sb
);

219 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
)

220 
efi
 = ((
ext_ä“_šode
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
->
b_d©a
) +

221 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
-1)%
EXT_INODES_PER_BLOCK
;

222 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 || 
efi
->
couÁ
 == 14) {

223 #ifdeà
EXTFS_DEBUG


224 
	`´štk
("ext_ä“_šode: inodfuÎ, skpšgØ%d\n", 
šo
);

226 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
)

227 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
);

228 
block
 = 2 + (
šo
 - 1è/ 
EXT_INODES_PER_BLOCK
;

229 ià(!(
bh
 = 
	`b»ad
(
dev
, 
block
, 
sb
->
s_blocksize
)))

230 
	`·nic
("ext_free_inode: unableo„ead inode block\n");

231 
efi
 = ((
ext_ä“_šode
 *è
bh
->
b_d©a
) +

232 (
šo
 - 1è% 
EXT_INODES_PER_BLOCK
;

233 
efi
->
Ãxt
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
;

234 
efi
->
couÁ
 = 0;

235 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
 = 
šo
;

236 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 = 
bh
;

238 
efi
->
ä“
[efi->
couÁ
++] = 
šo
;

240 
sb
->
u
.
ext_sb
.
s_ä“šodescouÁ
 ++;

241 
sb
->
s_dœt
 = 1;

242 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
->
b_dœt
 = 1;

243 
	`uÆock_su³r
 (
sb
);

244 
	}
}

246 
šode
 * 
	$ext_Ãw_šode
(cÚ¡ 
šode
 * 
dœ
)

248 
su³r_block
 * 
sb
;

249 
šode
 * inode;

250 
ext_ä“_šode
 * 
efi
;

251 
block
;

252 
j
;

254 ià(!
dœ
 || !(
šode
=
	`g‘_em±y_šode
()))

255  
NULL
;

256 
sb
 = 
dœ
->
i_sb
;

257 
šode
->
i_sb
 = 
sb
;

258 
šode
->
i_æags
 = 
sb
->
s_æags
;

259 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
)

261 
	`lock_su³r
 (
sb
);

262 
efi
 = ((
ext_ä“_šode
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
->
b_d©a
) +

263 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
-1)%
EXT_INODES_PER_BLOCK
;

264 ià(
efi
->
couÁ
) {

265 
j
 = 
efi
->
ä“
[--efi->
couÁ
];

266 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
->
b_dœt
 = 1;

268 #ifdeà
EXTFS_DEBUG


269 
	`´štk
("ext_ä“_šode: inodem±y, skpšgØ%d\n", 
efi
->
Ãxt
);

271 
j
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
;

272 ià(
efi
->
Ãxt
 > 
sb
->
u
.
ext_sb
.
s_nšodes
) {

273 
	`´štk
 ("efi->Ãxˆğ%d\n", 
efi
->
Ãxt
);

274 
	`·nic
 ("ext_new_inode: bad inode‚umber in free†ist\n");

276 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
 = 
efi
->
Ãxt
;

277 
block
 = 2 + (((è
efi
->
Ãxt
è- 1è/ 
EXT_INODES_PER_BLOCK
;

278 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
);

279 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
) {

280 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 = 
NULL
;

282 ià(!(
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 =

283 
	`b»ad
(
sb
->
s_dev
, 
block
, sb->
s_blocksize
)))

284 
	`·nic
 ("ext_new_inode: unableo„ead‚ext free inode block\n");

287 
sb
->
u
.
ext_sb
.
s_ä“šodescouÁ
 --;

288 
sb
->
s_dœt
 = 1;

289 
šode
->
i_couÁ
 = 1;

290 
šode
->
i_Æšk
 = 1;

291 
šode
->
i_dev
 = 
sb
->
s_dev
;

292 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

293 
šode
->
i_gid
 = (
dœ
->
i_mode
 & 
S_ISGID
è? dœ->i_gid : 
cu¼’t
->
egid
;

294 
šode
->
i_dœt
 = 1;

295 
šode
->
i_šo
 = 
j
;

296 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

297 
šode
->
i_İ
 = 
NULL
;

298 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

299 
	`š£¹_šode_hash
(
šode
);

300 #ifdeà
EXTFS_DEBUG


301 
	`´štk
("ext_Ãw_šod:‡Îoÿtšg inod%d\n", 
šode
->
i_šo
);

303 
	`uÆock_su³r
 (
sb
);

304  
šode
;

305 
	}
}

307 
	$ext_couÁ_ä“_šodes
(
su³r_block
 *
sb
)

309 #ifdeà
EXTFS_DEBUG


310 
bufãr_h—d
 * 
bh
;

311 
ext_ä“_šode
 * 
efi
;

312 
couÁ
, 
block
, 
šo
;

314 
	`lock_su³r
 (
sb
);

315 ià(!
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
)

316 
couÁ
 = 0;

318 
efi
 = ((
ext_ä“_šode
 *è
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
->
b_d©a
) +

319 ((
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
-1)%
EXT_INODES_PER_BLOCK
);

320 
couÁ
 = 
efi
->count + 1;

321 
šo
 = 
efi
->
Ãxt
;

322 
šo
) {

323 ià(
šo
 < 1 || inØ> 
sb
->
u
.
ext_sb
.
s_nšodes
) {

324 
	`´štk
 ("u.ext_sb.s_firstfreeinodenumber = %d, ino = %d\n",

325 (è
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
,
šo
);

326 
	`·nic
 ("ext_count_fre_inodes: bad inode‚umber in free†ist\n");

328 
block
 = 2 + ((
šo
 - 1è/ 
EXT_INODES_PER_BLOCK
);

329 ià(!(
bh
 = 
	`b»ad
 (
sb
->
s_dev
, 
block
, sb->
s_blocksize
))) {

330 
	`´štk
 ("ext_count_free_inodes:ƒrror while„eading free inodes†ist\n");

331 
block
 = 0;

333 
efi
 = ((
ext_ä“_šode
 *è
bh
->
b_d©a
) +

334 ((
šo
 - 1è% 
EXT_INODES_PER_BLOCK
);

335 
couÁ
 +ğ
efi
->count + 1;

336 
šo
 = 
efi
->
Ãxt
;

337 
	`b»l£
 (
bh
);

341 
	`´štk
("ext_count_free_inodes: stored = %d, computed = %d\n",

342 
sb
->
u
.
ext_sb
.
s_ä“šodescouÁ
, 
couÁ
);

343 
	`uÆock_su³r
 (
sb
);

344  
couÁ
;

346  
sb
->
u
.
ext_sb
.
s_ä“šodescouÁ
;

348 
	}
}

	@fs/ext/fsync.c

14 
	~<asm/£gm’t.h
>

15 
	~<asm/sy¡em.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/sched.h
>

19 
	~<lšux/¡©.h
>

20 
	~<lšux/fú.h
>

21 
	~<lšux/locks.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/ext_fs.h
>

27 
	#blocksize
 
BLOCK_SIZE


	)

28 
	#addr_³r_block
 256

	)

30 
	$sync_block
 (
šode
 * inode, * 
block
, 
wa™
)

32 
bufãr_h—d
 * 
bh
;

33 
tmp
;

35 ià(!*
block
)

37 
tmp
 = *
block
;

38 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
, *
block
, 
blocksize
);

39 ià(!
bh
)

41 ià(*
block
 !ğ
tmp
) {

42 
	`b»l£
 (
bh
);

45 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_u±od©e
) {

46 
	`b»l£
(
bh
);

49 ià(
wa™
 || !
bh
->
b_u±od©e
 || !bh->
b_dœt
)

51 
	`b»l£
(
bh
);

54 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

55 
bh
->
b_couÁ
--;

57 
	}
}

59 
	$sync_iblock
 (
šode
 * inode, * 
iblock
,

60 
bufãr_h—d
 **
bh
, 
wa™
)

62 
rc
, 
tmp
;

64 *
bh
 = 
NULL
;

65 
tmp
 = *
iblock
;

66 ià(!
tmp
)

68 
rc
 = 
	`sync_block
 (
šode
, 
iblock
, 
wa™
);

69 ià(
rc
)

70  
rc
;

71 *
bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
blocksize
);

72 ià(
tmp
 !ğ*
iblock
) {

73 
	`b»l£
(*
bh
);

74 *
bh
 = 
NULL
;

77 ià(!*
bh
)

80 
	}
}

83 
	$sync_dœeù
(
šode
 *šode, 
wa™
)

85 
i
;

86 
rc
, 
”r
 = 0;

88 
i
 = 0; i < 9; i++) {

89 
rc
 = 
	`sync_block
 (
šode
, inode->
u
.
ext_i
.
i_d©a
 + 
i
, 
wa™
);

90 ià(
rc
 > 0)

92 ià(
rc
)

93 
”r
 = 
rc
;

95  
”r
;

96 
	}
}

98 
	$sync_šdœeù
(
šode
 *šode, *
iblock
, 
wa™
)

100 
i
;

101 
bufãr_h—d
 * 
šd_bh
;

102 
rc
, 
”r
 = 0;

104 
rc
 = 
	`sync_iblock
 (
šode
, 
iblock
, &
šd_bh
, 
wa™
);

105 ià(
rc
 || !
šd_bh
)

106  
rc
;

108 
i
 = 0; i < 
addr_³r_block
; i++) {

109 
rc
 = 
	`sync_block
 (
šode
,

110 ((*è
šd_bh
->
b_d©a
è+ 
i
,

111 
wa™
);

112 ià(
rc
 > 0)

114 ià(
rc
)

115 
”r
 = 
rc
;

117 
	`b»l£
(
šd_bh
);

118  
”r
;

119 
	}
}

121 
	$sync_dšdœeù
(
šode
 *šode, *
diblock
,

122 
wa™
)

124 
i
;

125 
bufãr_h—d
 * 
dšd_bh
;

126 
rc
, 
”r
 = 0;

128 
rc
 = 
	`sync_iblock
 (
šode
, 
diblock
, &
dšd_bh
, 
wa™
);

129 ià(
rc
 || !
dšd_bh
)

130  
rc
;

132 
i
 = 0; i < 
addr_³r_block
; i++) {

133 
rc
 = 
	`sync_šdœeù
 (
šode
,

134 ((*è
dšd_bh
->
b_d©a
è+ 
i
,

135 
wa™
);

136 ià(
rc
 > 0)

138 ià(
rc
)

139 
”r
 = 
rc
;

141 
	`b»l£
(
dšd_bh
);

142  
”r
;

143 
	}
}

145 
	$sync_tšdœeù
(
šode
 *šode, *
tiblock
,

146 
wa™
)

148 
i
;

149 
bufãr_h—d
 * 
tšd_bh
;

150 
rc
, 
”r
 = 0;

152 
rc
 = 
	`sync_iblock
 (
šode
, 
tiblock
, &
tšd_bh
, 
wa™
);

153 ià(
rc
 || !
tšd_bh
)

154  
rc
;

156 
i
 = 0; i < 
addr_³r_block
; i++) {

157 
rc
 = 
	`sync_dšdœeù
 (
šode
,

158 ((*è
tšd_bh
->
b_d©a
è+ 
i
,

159 
wa™
);

160 ià(
rc
 > 0)

162 ià(
rc
)

163 
”r
 = 
rc
;

165 
	`b»l£
(
tšd_bh
);

166  
”r
;

167 
	}
}

169 
	$ext_sync_fe
(
šode
 * inode, 
fe
 *file)

171 
wa™
, 
”r
 = 0;

173 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

174 
	`S_ISLNK
(
šode
->
i_mode
)))

175  -
EINVAL
;

176 
wa™
=0; wait<=1; wait++)

178 
”r
 |ğ
	`sync_dœeù
(
šode
, 
wa™
);

179 
”r
 |ğ
	`sync_šdœeù
(
šode
, inode->
u
.
ext_i
.
i_d©a
+9, 
wa™
);

180 
”r
 |ğ
	`sync_dšdœeù
(
šode
, inode->
u
.
ext_i
.
i_d©a
+10, 
wa™
);

181 
”r
 |ğ
	`sync_tšdœeù
(
šode
, inode->
u
.
ext_i
.
i_d©a
+11, 
wa™
);

183 
”r
 |ğ
	`ext_sync_šode
 (
šode
);

184  (
”r
 < 0è? -
EIO
 : 0;

185 
	}
}

	@fs/ext/inode.c

13 
	~<lšux/sched.h
>

14 
	~<lšux/ext_fs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/mm.h
>

17 
	~<lšux/¡ršg.h
>

18 
	~<lšux/¡©.h
>

19 
	~<lšux/locks.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/£gm’t.h
>

24 
	$ext_put_šode
(
šode
 *inode)

26 ià(
šode
->
i_Æšk
)

28 
šode
->
i_size
 = 0;

29 
	`ext_Œunÿ‹
(
šode
);

30 
	`ext_ä“_šode
(
šode
);

31 
	}
}

33 
	$ext_put_su³r
(
su³r_block
 *
sb
)

36 
	`lock_su³r
(
sb
);

37 
sb
->
s_dev
 = 0;

38 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
)

39 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
);

40 ià(
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
)

41 
	`b»l£
 (
sb
->
u
.
ext_sb
.
s_fœ¡ä“block
);

42 
	`uÆock_su³r
(
sb
);

44 
	}
}

46 
su³r_İ”©iÚs
 
	gext_sİs
 = {

47 
ext_»ad_šode
,

48 
NULL
,

49 
ext_wr™e_šode
,

50 
ext_put_šode
,

51 
ext_put_su³r
,

52 
ext_wr™e_su³r
,

53 
ext_¡©fs
,

54 
NULL


57 
su³r_block
 *
	$ext_»ad_su³r
(
su³r_block
 *
s
,*
d©a
,

58 
s’t
)

60 
bufãr_h—d
 *
bh
;

61 
ext_su³r_block
 *
es
;

62 
dev
 = 
s
->
s_dev
,
block
;

64 
	`lock_su³r
(
s
);

65 
	`£t_blocksize
(
dev
, 
BLOCK_SIZE
);

66 ià(!(
bh
 = 
	`b»ad
(
dev
, 1, 
BLOCK_SIZE
))) {

67 
s
->
s_dev
=0;

68 
	`uÆock_su³r
(
s
);

69 
	`´štk
("EXT-fs: unableo„ead superblock\n");

70  
NULL
;

72 
es
 = (
ext_su³r_block
 *è
bh
->
b_d©a
;

73 
s
->
s_blocksize
 = 1024;

74 
s
->
s_blocksize_b™s
 = 10;

75 
s
->
u
.
ext_sb
.
s_nšodes
 = 
es
->s_ninodes;

76 
s
->
u
.
ext_sb
.
s_nzÚes
 = 
es
->s_nzones;

77 
s
->
u
.
ext_sb
.
s_fœ¡d©azÚe
 = 
es
->s_firstdatazone;

78 
s
->
u
.
ext_sb
.
s_log_zÚe_size
 = 
es
->s_log_zone_size;

79 
s
->
u
.
ext_sb
.
s_max_size
 = 
es
->s_max_size;

80 
s
->
s_magic
 = 
es
->s_magic;

81 
s
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
 = 
es
->
s_fœ¡ä“block
;

82 
s
->
u
.
ext_sb
.
s_ä“blockscouÁ
 = 
es
->s_freeblockscount;

83 
s
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
 = 
es
->
s_fœ¡ä“šode
;

84 
s
->
u
.
ext_sb
.
s_ä“šodescouÁ
 = 
es
->s_freeinodescount;

85 
	`b»l£
(
bh
);

86 ià(
s
->
s_magic
 !ğ
EXT_SUPER_MAGIC
) {

87 
s
->
s_dev
 = 0;

88 
	`uÆock_su³r
(
s
);

89 ià(!
s’t
)

90 
	`´štk
("VFS: Can't find‡nƒxtfs filesystem on dev 0x%04x.\n",

91 
dev
);

92  
NULL
;

94 ià(!
s
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
)

95 
s
->
u
.
ext_sb
.
s_fœ¡ä“block
 = 
NULL
;

97 ià(!(
s
->
u
.
ext_sb
.
s_fœ¡ä“block
 = 
	`b»ad
(
dev
,

98 
s
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
, 
BLOCK_SIZE
))) {

99 
	`´štk
("ext_read_super: unableo„ead first free block\n");

100 
s
->
s_dev
 = 0;

101 
	`uÆock_su³r
(
s
);

102  
NULL
;

104 ià(!
s
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
)

105 
s
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 = 
NULL
;

107 
block
 = 2 + (
s
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
 - 1è/ 
EXT_INODES_PER_BLOCK
;

108 ià(!(
s
->
u
.
ext_sb
.
s_fœ¡ä“šodeblock
 = 
	`b»ad
(
dev
, 
block
, 
BLOCK_SIZE
))) {

109 
	`´štk
("ext_read_super: unableo„ead first free inode block\n");

110 
	`b»l£
(
s
->
u
.
ext_sb
.
s_fœ¡ä“block
);

111 
s
->
s_dev
 = 0;

112 
	`uÆock_su³r
 (
s
);

113  
NULL
;

116 
	`uÆock_su³r
(
s
);

118 
s
->
s_dev
 = 
dev
;

119 
s
->
s_İ
 = &
ext_sİs
;

120 ià(!(
s
->
s_mouÁed
 = 
	`ig‘
(s,
EXT_ROOT_INO
))) {

121 
s
->
s_dev
=0;

122 
	`´štk
("EXT-fs: get„oot inode failed\n");

123  
NULL
;

125  
s
;

126 
	}
}

128 
	$ext_wr™e_su³r
 (
su³r_block
 *
sb
)

130 
bufãr_h—d
 * 
bh
;

131 
ext_su³r_block
 * 
es
;

133 ià(!(
bh
 = 
	`b»ad
(
sb
->
s_dev
, 1, 
BLOCK_SIZE
))) {

134 
	`´štk
 ("ext_write_super: bread failed\n");

137 
es
 = (
ext_su³r_block
 *è
bh
->
b_d©a
;

138 
es
->
s_fœ¡ä“block
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“blocknumb”
;

139 
es
->
s_ä“blockscouÁ
 = 
sb
->
u
.
ext_sb
.s_freeblockscount;

140 
es
->
s_fœ¡ä“šode
 = 
sb
->
u
.
ext_sb
.
s_fœ¡ä“šod’umb”
;

141 
es
->
s_ä“šodescouÁ
 = 
sb
->
u
.
ext_sb
.s_freeinodescount;

142 
bh
->
b_dœt
 = 1;

143 
	`b»l£
 (
bh
);

144 
sb
->
s_dœt
 = 0;

145 
	}
}

147 
	$ext_¡©fs
 (
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

149 
tmp
;

151 
	`put_fs_lÚg
(
EXT_SUPER_MAGIC
, &
buf
->
f_ty³
);

152 
	`put_fs_lÚg
(1024, &
buf
->
f_bsize
);

153 
	`put_fs_lÚg
(
sb
->
u
.
ext_sb
.
s_nzÚes
 << sb->u.ext_sb.
s_log_zÚe_size
,

154 &
buf
->
f_blocks
);

155 
tmp
 = 
	`ext_couÁ_ä“_blocks
(
sb
);

156 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bä“
);

157 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bava
);

158 
	`put_fs_lÚg
(
sb
->
u
.
ext_sb
.
s_nšodes
, &
buf
->
f_fes
);

159 
	`put_fs_lÚg
(
	`ext_couÁ_ä“_šodes
(
sb
), &
buf
->
f_fä“
);

160 
	`put_fs_lÚg
(
EXT_NAME_LEN
, &
buf
->
f_Çm–’
);

162 
	}
}

164 
	#šode_bm­
(
šode
,
Ä
è((šode)->
u
.
ext_i
.
i_d©a
[Òr)])

	)

166 
	$block_bm­
(
bufãr_h—d
 * 
bh
, 
Ä
)

168 
tmp
;

170 ià(!
bh
)

172 
tmp
 = ((*è
bh
->
b_d©a
)[
Ä
];

173 
	`b»l£
(
bh
);

174  
tmp
;

175 
	}
}

177 
	$ext_bm­
(
šode
 * inode,
block
)

179 
i
;

181 ià(
block
<0) {

182 
	`´štk
("ext_bmap: block<0");

185 ià(
block
 >= 9+256+256*256+256*256*256) {

186 
	`´štk
("ext_bmap: block>big");

189 ià(
block
<9)

190  
	`šode_bm­
(
šode
,
block
);

191 
block
 -= 9;

192 ià(
block
<256) {

193 
i
 = 
	`šode_bm­
(
šode
,9);

194 ià(!
i
)

196  
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
),
block
);

198 
block
 -= 256;

199 ià(
block
<256*256) {

200 
i
 = 
	`šode_bm­
(
šode
,10);

201 ià(!
i
)

203 
i
 = 
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,i,
BLOCK_SIZE
),
block
>>8);

204 ià(!
i
)

206  
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
),
block
 & 255);

208 
block
 -= 256*256;

209 
i
 = 
	`šode_bm­
(
šode
,11);

210 ià(!
i
)

212 
i
 = 
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,i,
BLOCK_SIZE
),
block
>>16);

213 ià(!
i
)

215 
i
 = 
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,i,
BLOCK_SIZE
),(
block
>>8) & 255);

216 ià(!
i
)

218  
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
),
block
 & 255);

219 
	}
}

221 
bufãr_h—d
 * 
	$šode_g‘blk
(
šode
 * inode, 
Ä
, 
ü—‹
)

223 
tmp
;

224 * 
p
;

225 
bufãr_h—d
 * 
»suÉ
;

227 
p
 = 
šode
->
u
.
ext_i
.
i_d©a
 + 
Ä
;

228 
»³©
:

229 
tmp
 = *
p
;

230 ià(
tmp
) {

231 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

232 ià(
tmp
 =ğ*
p
)

233  
»suÉ
;

234 
	`b»l£
(
»suÉ
);

235 
»³©
;

237 ià(!
ü—‹
)

238  
NULL
;

239 
tmp
 = 
	`ext_Ãw_block
(
šode
->
i_sb
);

240 ià(!
tmp
)

241  
NULL
;

242 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

243 ià(*
p
) {

244 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

245 
	`b»l£
(
»suÉ
);

246 
»³©
;

248 *
p
 = 
tmp
;

249 
šode
->
i_ùime
 = 
CURRENT_TIME
;

250 
šode
->
i_dœt
 = 1;

251  
»suÉ
;

252 
	}
}

254 
bufãr_h—d
 * 
	$block_g‘blk
(
šode
 * inode,

255 
bufãr_h—d
 * 
bh
, 
Ä
, 
ü—‹
)

257 
tmp
;

258 * 
p
;

259 
bufãr_h—d
 * 
»suÉ
;

261 ià(!
bh
)

262  
NULL
;

263 ià(!
bh
->
b_u±od©e
) {

264 
	`Î_rw_block
(
READ
, 1, &
bh
);

265 
	`wa™_Ú_bufãr
(
bh
);

266 ià(!
bh
->
b_u±od©e
) {

267 
	`b»l£
(
bh
);

268  
NULL
;

271 
p
 = 
Ä
 + (*è
bh
->
b_d©a
;

272 
»³©
:

273 
tmp
 = *
p
;

274 ià(
tmp
) {

275 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
BLOCK_SIZE
);

276 ià(
tmp
 =ğ*
p
) {

277 
	`b»l£
(
bh
);

278  
»suÉ
;

280 
	`b»l£
(
»suÉ
);

281 
»³©
;

283 ià(!
ü—‹
) {

284 
	`b»l£
(
bh
);

285  
NULL
;

287 
tmp
 = 
	`ext_Ãw_block
(
šode
->
i_sb
);

288 ià(!
tmp
) {

289 
	`b»l£
(
bh
);

290  
NULL
;

292 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
BLOCK_SIZE
);

293 ià(*
p
) {

294 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

295 
	`b»l£
(
»suÉ
);

296 
»³©
;

298 *
p
 = 
tmp
;

299 
bh
->
b_dœt
 = 1;

300 
	`b»l£
(
bh
);

301  
»suÉ
;

302 
	}
}

304 
bufãr_h—d
 * 
	$ext_g‘blk
(
šode
 * inode, 
block
, 
ü—‹
)

306 
bufãr_h—d
 * 
bh
;

308 ià(
block
<0) {

309 
	`´štk
("ext_getblk: block<0\n");

310  
NULL
;

312 ià(
block
 >= 9+256+256*256+256*256*256) {

313 
	`´štk
("ext_getblk: block>big\n");

314  
NULL
;

316 ià(
block
<9)

317  
	`šode_g‘blk
(
šode
,
block
,
ü—‹
);

318 
block
 -= 9;

319 ià(
block
<256) {

320 
bh
 = 
	`šode_g‘blk
(
šode
,9,
ü—‹
);

321  
	`block_g‘blk
(
šode
,
bh
,
block
,
ü—‹
);

323 
block
 -= 256;

324 ià(
block
<256*256) {

325 
bh
 = 
	`šode_g‘blk
(
šode
,10,
ü—‹
);

326 
bh
 = 
	`block_g‘blk
(
šode
,bh,
block
>>8,
ü—‹
);

327  
	`block_g‘blk
(
šode
,
bh
,
block
 & 255,
ü—‹
);

329 
block
 -= 256*256;

330 
bh
 = 
	`šode_g‘blk
(
šode
,11,
ü—‹
);

331 
bh
 = 
	`block_g‘blk
(
šode
,bh,
block
>>16,
ü—‹
);

332 
bh
 = 
	`block_g‘blk
(
šode
,bh,(
block
>>8è& 255,
ü—‹
);

333  
	`block_g‘blk
(
šode
,
bh
,
block
 & 255,
ü—‹
);

334 
	}
}

336 
bufãr_h—d
 * 
	$ext_b»ad
(
šode
 * inode, 
block
, 
ü—‹
)

338 
bufãr_h—d
 * 
bh
;

340 
bh
 = 
	`ext_g‘blk
(
šode
,
block
,
ü—‹
);

341 ià(!
bh
 || bh->
b_u±od©e
)

342  
bh
;

343 
	`Î_rw_block
(
READ
, 1, &
bh
);

344 
	`wa™_Ú_bufãr
(
bh
);

345 ià(
bh
->
b_u±od©e
)

346  
bh
;

347 
	`b»l£
(
bh
);

348  
NULL
;

349 
	}
}

351 
	$ext_»ad_šode
(
šode
 * inode)

353 
bufãr_h—d
 * 
bh
;

354 
ext_šode
 * 
¿w_šode
;

355 
block
;

357 
block
 = 2 + (
šode
->
i_šo
-1)/
EXT_INODES_PER_BLOCK
;

358 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
, 
block
, 
BLOCK_SIZE
)))

359 
	`·nic
("unableo„ead i-node block");

360 
¿w_šode
 = ((
ext_šode
 *è
bh
->
b_d©a
) +

361 (
šode
->
i_šo
-1)%
EXT_INODES_PER_BLOCK
;

362 
šode
->
i_mode
 = 
¿w_šode
->i_mode;

363 
šode
->
i_uid
 = 
¿w_šode
->i_uid;

364 
šode
->
i_gid
 = 
¿w_šode
->i_gid;

365 
šode
->
i_Æšk
 = 
¿w_šode
->
i_Æšks
;

366 
šode
->
i_size
 = 
¿w_šode
->i_size;

367 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
¿w_šode
->
i_time
;

368 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

369 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

370 
šode
->
i_rdev
 = 
¿w_šode
->
i_zÚe
[0];

371 
block
 = 0; block < 12; block++)

372 
šode
->
u
.
ext_i
.
i_d©a
[
block
] = 
¿w_šode
->
i_zÚe
[block];

373 
	`b»l£
(
bh
);

374 
šode
->
i_İ
 = 
NULL
;

375 ià(
	`S_ISREG
(
šode
->
i_mode
))

376 
šode
->
i_İ
 = &
ext_fe_šode_İ”©iÚs
;

377 ià(
	`S_ISDIR
(
šode
->
i_mode
))

378 
šode
->
i_İ
 = &
ext_dœ_šode_İ”©iÚs
;

379 ià(
	`S_ISLNK
(
šode
->
i_mode
))

380 
šode
->
i_İ
 = &
ext_symlšk_šode_İ”©iÚs
;

381 ià(
	`S_ISCHR
(
šode
->
i_mode
))

382 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

383 ià(
	`S_ISBLK
(
šode
->
i_mode
))

384 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

385 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

386 
	`š™_fifo
(
šode
);

387 
	}
}

389 
bufãr_h—d
 * 
	$ext_upd©e_šode
(
šode
 * inode)

391 
bufãr_h—d
 * 
bh
;

392 
ext_šode
 * 
¿w_šode
;

393 
block
;

395 
block
 = 2 + (
šode
->
i_šo
-1)/
EXT_INODES_PER_BLOCK
;

396 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
, 
block
, 
BLOCK_SIZE
)))

397 
	`·nic
("unableo„ead i-node block");

398 
¿w_šode
 = ((
ext_šode
 *)
bh
->
b_d©a
) +

399 (
šode
->
i_šo
-1)%
EXT_INODES_PER_BLOCK
;

400 
¿w_šode
->
i_mode
 = 
šode
->i_mode;

401 
¿w_šode
->
i_uid
 = 
šode
->i_uid;

402 
¿w_šode
->
i_gid
 = 
šode
->i_gid;

403 
¿w_šode
->
i_Æšks
 = 
šode
->
i_Æšk
;

404 
¿w_šode
->
i_size
 = 
šode
->i_size;

405 
¿w_šode
->
i_time
 = 
šode
->
i_mtime
;

406 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

407 
¿w_šode
->
i_zÚe
[0] = 
šode
->
i_rdev
;

408 
block
 = 0; block < 12; block++)

409 
¿w_šode
->
i_zÚe
[
block
] = 
šode
->
u
.
ext_i
.
i_d©a
[block];

410 
bh
->
b_dœt
=1;

411 
šode
->
i_dœt
=0;

412  
bh
;

413 
	}
}

415 
	$ext_wr™e_šode
(
šode
 * inode)

417 
bufãr_h—d
 *
bh
;

418 
bh
 = 
	`ext_upd©e_šode
 (
šode
);

419 
	`b»l£
(
bh
);

420 
	}
}

422 
	$ext_sync_šode
 (
šode
 *inode)

424 
”r
 = 0;

425 
bufãr_h—d
 *
bh
;

427 
bh
 = 
	`ext_upd©e_šode
(
šode
);

428 ià(
bh
 && bh->
b_dœt
)

430 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

431 
	`wa™_Ú_bufãr
(
bh
);

432 ià(
bh
->
b_»q
 && !bh->
b_u±od©e
)

434 
	`´štk
 ("IOƒrror syncingƒxt inode [%04x:%08x]\n",

435 
šode
->
i_dev
, inode->
i_šo
);

436 
”r
 = -1;

439 ià(!
bh
)

440 
”r
 = -1;

441 
	`b»l£
 (
bh
);

442  
”r
;

443 
	}
}

	@fs/ext/namei.c

13 
	~<lšux/sched.h
>

14 
	~<lšux/ext_fs.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/fú.h
>

19 
	~<lšux/”ºo.h
>

21 
	~<asm/£gm’t.h
>

37 
	#EXT_DIR_PAD
 8

	)

47 
	#EXT_DIR_MIN_SIZE
 12

	)

56 
	$ext_m©ch
(
Ën
,cÚ¡ * 
Çme
,
ext_dœ_’Œy
 * 
de
)

58 
§me
 
	`__asm__
("ax");

60 ià(!
de
 || !de->
šode
 || 
Ën
 > 
EXT_NAME_LEN
)

63 ià(!
Ën
 && (
de
->
Çme
[0]=='.') && (de->name[1]=='\0'))

65 ià(
Ën
 < 
EXT_NAME_LEN
 &&†’ !ğ
de
->
Çme_Ën
)

67 
	`__asm__
("cld\n\t"

70 :"÷" (
§me
)

71 :"0" (0),"S" ((è
Çme
),"D" ((è
de
->Çme),"c" (
Ën
)

73  
§me
;

74 
	}
}

87 
bufãr_h—d
 * 
	$ext_fšd_’Œy
(
šode
 * 
dœ
,

88 cÚ¡ * 
Çme
, 
Çm–’
, 
ext_dœ_’Œy
 ** 
»s_dœ
,

89 
ext_dœ_’Œy
 ** 
´ev_dœ
, ext_dœ_’Œy ** 
Ãxt_dœ
)

91 
off£t
;

92 
bufãr_h—d
 * 
bh
;

93 
ext_dœ_’Œy
 * 
de
;

95 *
»s_dœ
 = 
NULL
;

96 ià(!
dœ
)

97  
NULL
;

98 #ifdeà
NO_TRUNCATE


99 ià(
Çm–’
 > 
EXT_NAME_LEN
)

100  
NULL
;

102 ià(
Çm–’
 > 
EXT_NAME_LEN
)

103 
Çm–’
 = 
EXT_NAME_LEN
;

105 
bh
 = 
	`ext_b»ad
(
dœ
,0,0);

106 ià(!
bh
)

107  
NULL
;

108 ià(
´ev_dœ
)

109 *
´ev_dœ
 = 
NULL
;

110 ià(
Ãxt_dœ
)

111 *
Ãxt_dœ
 = 
NULL
;

112 
off£t
 = 0;

113 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

114 
off£t
 < 
dœ
->
i_size
) {

115 ià((*)
de
 >ğ
BLOCK_SIZE
+
bh
->
b_d©a
) {

116 
	`b»l£
(
bh
);

117 
bh
 = 
NULL
;

118 
bh
 = 
	`ext_b»ad
(
dœ
,
off£t
>>
BLOCK_SIZE_BITS
,0);

119 ià(!
bh
)

121 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

122 ià(
´ev_dœ
)

123 *
´ev_dœ
 = 
NULL
;

125 ià(
de
->
»c_Ën
 < 8 || de->rec_len % 8 != 0 ||

126 
de
->
»c_Ën
 < de->
Çme_Ën
 + 8 ||

127 (((*è
de
è+ de->
»c_Ën
-1 >ğ
BLOCK_SIZE
+
bh
->
b_d©a
)) {

128 
	`´štk
 ("ext_find_entry: bad dirƒntry\n");

129 
	`´štk
 ("dev=%d, dir=%d, offset=%d,„ec_len=%d,‚ame_len=%d\n",

130 
dœ
->
i_dev
, dœ->
i_šo
, 
off£t
, 
de
->
»c_Ën
, de->
Çme_Ën
);

131 
de
 = (
ext_dœ_’Œy
 *è(
bh
->
b_d©a
+
BLOCK_SIZE
);

132 
off£t
 = ((off£ˆ/ 
BLOCK_SIZE
) + 1) * BLOCK_SIZE;

137 ià(
	`ext_m©ch
(
Çm–’
,
Çme
,
de
)) {

138 *
»s_dœ
 = 
de
;

139 ià(
Ãxt_dœ
)

140 ià(
off£t
 + 
de
->
»c_Ën
 < 
dœ
->
i_size
 &&

141 ((*)
de
è+ de->
»c_Ën
 < 
BLOCK_SIZE
+
bh
->
b_d©a
)

142 *
Ãxt_dœ
 = (
ext_dœ_’Œy
 *)

143 ((*è
de
 + de->
»c_Ën
);

145 *
Ãxt_dœ
 = 
NULL
;

146  
bh
;

148 
off£t
 +ğ
de
->
»c_Ën
;

149 ià(
´ev_dœ
)

150 *
´ev_dœ
 = 
de
;

151 
de
 = (
ext_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

153 
	`b»l£
(
bh
);

154  
NULL
;

155 
	}
}

157 
	$ext_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

158 
šode
 ** 
»suÉ
)

160 
šo
;

161 
ext_dœ_’Œy
 * 
de
;

162 
bufãr_h—d
 * 
bh
;

164 *
»suÉ
 = 
NULL
;

165 ià(!
dœ
)

166  -
ENOENT
;

167 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

168 
	`ut
(
dœ
);

169  -
ENOENT
;

171 ià(!(
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,
NULL
,NULL))) {

172 
	`ut
(
dœ
);

173  -
ENOENT
;

175 
šo
 = 
de
->
šode
;

176 
	`b»l£
(
bh
);

177 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

178 
	`ut
(
dœ
);

179  -
EACCES
;

181 
	`ut
(
dœ
);

183 
	}
}

195 
bufãr_h—d
 * 
	$ext_add_’Œy
(
šode
 * 
dœ
,

196 cÚ¡ * 
Çme
, 
Çm–’
, 
ext_dœ_’Œy
 ** 
»s_dœ
)

198 
i
;

199 
off£t
;

200 
»c_Ën
;

201 
bufãr_h—d
 * 
bh
;

202 
ext_dœ_’Œy
 * 
de
, * 
de1
;

204 *
»s_dœ
 = 
NULL
;

205 ià(!
dœ
)

206  
NULL
;

207 #ifdeà
NO_TRUNCATE


208 ià(
Çm–’
 > 
EXT_NAME_LEN
)

209  
NULL
;

211 ià(
Çm–’
 > 
EXT_NAME_LEN
)

212 
Çm–’
 = 
EXT_NAME_LEN
;

214 ià(!
Çm–’
)

215  
NULL
;

216 
bh
 = 
	`ext_b»ad
(
dœ
,0,0);

217 ià(!
bh
)

218  
NULL
;

219 
»c_Ën
 = ((8 + 
Çm–’
 + 
EXT_DIR_PAD
 - 1) / EXT_DIR_PAD) * EXT_DIR_PAD;

220 
off£t
 = 0;

221 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

223 ià((*)
de
 >ğ
BLOCK_SIZE
+
bh
->
b_d©a
 && 
off£t
 < 
dœ
->
i_size
) {

224 #ifdeà
EXTFS_DEBUG


225 
	`´štk
 ("ext_add_entry: skippingo‚ext block\n");

227 
	`b»l£
(
bh
);

228 
bh
 = 
NULL
;

229 
bh
 = 
	`ext_b»ad
(
dœ
,
off£t
>>
BLOCK_SIZE_BITS
,0);

230 ià(!
bh
)

231  
NULL
;

232 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

234 ià(
off£t
 >ğ
dœ
->
i_size
) {

236 ià(
off£t
 % 
BLOCK_SIZE
 == 0 ||

237 (
BLOCK_SIZE
 - (
off£t
 % BLOCK_SIZE)è< 
»c_Ën
) {

238 ià((
off£t
 % 
BLOCK_SIZE
) != 0) {

242 
de
->
šode
 = 0;

243 
de
->
»c_Ën
 = 
BLOCK_SIZE


244 - (
off£t
 & (
BLOCK_SIZE
 - 1));

245 
de
->
Çme_Ën
 = 0;

246 
off£t
 +ğ
de
->
»c_Ën
;

247 
dœ
->
i_size
 +ğ
de
->
»c_Ën
;

248 
dœ
->
i_dœt
 = 1;

250 
dœ
->
i_ùime
 = 
CURRENT_TIME
;

252 
bh
->
b_dœt
 = 1;

254 
	`b»l£
 (
bh
);

255 
bh
 = 
NULL
;

256 #ifdeà
EXTFS_DEBUG


257 
	`´štk
 ("ext_add_entry : creating‚ext block\n");

259 
bh
 = 
	`ext_b»ad
(
dœ
,
off£t
>>
BLOCK_SIZE_BITS
,1);

260 ià(!
bh
)

261  
NULL
;

262 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

265 
de
->
šode
=0;

266 
de
->
»c_Ën
 =„ec_len;

267 
dœ
->
i_size
 +ğ
de
->
»c_Ën
;

268 
dœ
->
i_dœt
 = 1;

270 
dœ
->
i_ùime
 = 
CURRENT_TIME
;

273 ià(
de
->
»c_Ën
 < 8 || de->rec_len % 4 != 0 ||

274 
de
->
»c_Ën
 < de->
Çme_Ën
 + 8 ||

275 (((*è
de
è+ de->
»c_Ën
-1 >ğ
BLOCK_SIZE
+
bh
->
b_d©a
)) {

276 
	`´štk
 ("ext_addr_entry: bad dirƒntry\n");

277 
	`´štk
 ("dev=%d, dir=%d, offset=%d,„ec_len=%d,‚ame_len=%d\n",

278 
dœ
->
i_dev
, dœ->
i_šo
, 
off£t
, 
de
->
»c_Ën
, de->
Çme_Ën
);

279 
	`b»l£
 (
bh
);

280  
NULL
;

282 ià(!
de
->
šode
 && de->
»c_Ën
 >=„ec_len) {

283 ià(
de
->
»c_Ën
 >„ec_len

284 && 
de
->
»c_Ën
 -„ec_ËÀ>ğ
EXT_DIR_MIN_SIZE
) {

289 
de1
 = (
ext_dœ_’Œy
 *è((*è
de
 + 
»c_Ën
);

290 
de1
->
šode
 = 0;

291 
de1
->
»c_Ën
 = 
de
->rec_len -„ec_len;

292 
de1
->
Çme_Ën
 = 0;

293 
de
->
»c_Ën
 =„ec_len;

295 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

296 
de
->
Çme_Ën
 = 
Çm–’
;

297 
i
=0; i < 
Çm–’
 ; i++)

298 
de
->
Çme
[
i
] =‚ame[i];

299 
bh
->
b_dœt
 = 1;

300 *
»s_dœ
 = 
de
;

301  
bh
;

303 
off£t
 +ğ
de
->
»c_Ën
;

304 
de
 = (
ext_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

306 
	`b»l£
(
bh
);

307  
NULL
;

308 
	}
}

310 
	$ext_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

311 
šode
 ** 
»suÉ
)

313 
šode
 * inode;

314 
bufãr_h—d
 * 
bh
;

315 
ext_dœ_’Œy
 * 
de
;

317 *
»suÉ
 = 
NULL
;

318 ià(!
dœ
)

319  -
ENOENT
;

320 
šode
 = 
	`ext_Ãw_šode
(
dœ
);

321 ià(!
šode
) {

322 
	`ut
(
dœ
);

323  -
ENOSPC
;

325 
šode
->
i_İ
 = &
ext_fe_šode_İ”©iÚs
;

326 
šode
->
i_mode
 = 
mode
;

327 
šode
->
i_dœt
 = 1;

328 
bh
 = 
	`ext_add_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

329 ià(!
bh
) {

330 
šode
->
i_Æšk
--;

331 
šode
->
i_dœt
 = 1;

332 
	`ut
(
šode
);

333 
	`ut
(
dœ
);

334  -
ENOSPC
;

336 
de
->
šode
 = inode->
i_šo
;

337 
bh
->
b_dœt
 = 1;

338 
	`b»l£
(
bh
);

339 
	`ut
(
dœ
);

340 *
»suÉ
 = 
šode
;

342 
	}
}

344 
	$ext_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
)

346 
šode
 * inode;

347 
bufãr_h—d
 * 
bh
;

348 
ext_dœ_’Œy
 * 
de
;

350 ià(!
dœ
)

351  -
ENOENT
;

352 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,
NULL
,NULL);

353 ià(
bh
) {

354 
	`b»l£
(
bh
);

355 
	`ut
(
dœ
);

356  -
EEXIST
;

358 
šode
 = 
	`ext_Ãw_šode
(
dœ
);

359 ià(!
šode
) {

360 
	`ut
(
dœ
);

361  -
ENOSPC
;

363 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

364 
šode
->
i_mode
 = 
mode
;

365 
šode
->
i_İ
 = 
NULL
;

366 ià(
	`S_ISREG
(
šode
->
i_mode
))

367 
šode
->
i_İ
 = &
ext_fe_šode_İ”©iÚs
;

368 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

369 
šode
->
i_İ
 = &
ext_dœ_šode_İ”©iÚs
;

370 ià(
dœ
->
i_mode
 & 
S_ISGID
)

371 
šode
->
i_mode
 |ğ
S_ISGID
;

373 ià(
	`S_ISLNK
(
šode
->
i_mode
))

374 
šode
->
i_İ
 = &
ext_symlšk_šode_İ”©iÚs
;

375 ià(
	`S_ISCHR
(
šode
->
i_mode
))

376 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

377 ià(
	`S_ISBLK
(
šode
->
i_mode
))

378 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

379 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

380 
	`š™_fifo
(
šode
);

381 ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode))

382 
šode
->
i_rdev
 = 
rdev
;

384 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME
;

386 
šode
->
i_dœt
 = 1;

387 
bh
 = 
	`ext_add_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

388 ià(!
bh
) {

389 
šode
->
i_Æšk
--;

390 
šode
->
i_dœt
 = 1;

391 
	`ut
(
šode
);

392 
	`ut
(
dœ
);

393  -
ENOSPC
;

395 
de
->
šode
 = inode->
i_šo
;

396 
bh
->
b_dœt
 = 1;

397 
	`b»l£
(
bh
);

398 
	`ut
(
dœ
);

399 
	`ut
(
šode
);

401 
	}
}

403 
	$ext_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
)

405 
šode
 * inode;

406 
bufãr_h—d
 * 
bh
, *
dœ_block
;

407 
ext_dœ_’Œy
 * 
de
;

409 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,
NULL
,NULL);

410 ià(
bh
) {

411 
	`b»l£
(
bh
);

412 
	`ut
(
dœ
);

413  -
EEXIST
;

415 
šode
 = 
	`ext_Ãw_šode
(
dœ
);

416 ià(!
šode
) {

417 
	`ut
(
dœ
);

418  -
ENOSPC
;

420 
šode
->
i_İ
 = &
ext_dœ_šode_İ”©iÚs
;

421 
šode
->
i_size
 = 2 * 16;

427 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME
;

429 
dœ_block
 = 
	`ext_b»ad
(
šode
,0,1);

430 ià(!
dœ_block
) {

431 
	`ut
(
dœ
);

432 
šode
->
i_Æšk
--;

433 
šode
->
i_dœt
 = 1;

434 
	`ut
(
šode
);

435  -
ENOSPC
;

437 
de
 = (
ext_dœ_’Œy
 *è
dœ_block
->
b_d©a
;

438 
de
->
šode
=šode->
i_šo
;

439 
de
->
»c_Ën
=16;

440 
de
->
Çme_Ën
=1;

441 
	`¡rıy
(
de
->
Çme
,".");

442 
de
 = (
ext_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

443 
de
->
šode
 = 
dœ
->
i_šo
;

444 
de
->
»c_Ën
=16;

445 
de
->
Çme_Ën
=2;

446 
	`¡rıy
(
de
->
Çme
,"..");

447 
šode
->
i_Æšk
 = 2;

448 
dœ_block
->
b_dœt
 = 1;

449 
	`b»l£
(
dœ_block
);

450 
šode
->
i_mode
 = 
S_IFDIR
 | (
mode
 & 0777 & ~
cu¼’t
->
umask
);

451 ià(
dœ
->
i_mode
 & 
S_ISGID
)

452 
šode
->
i_mode
 |ğ
S_ISGID
;

453 
šode
->
i_dœt
 = 1;

454 
bh
 = 
	`ext_add_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

455 ià(!
bh
) {

456 
	`ut
(
dœ
);

457 
šode
->
i_Æšk
=0;

458 
	`ut
(
šode
);

459  -
ENOSPC
;

461 
de
->
šode
 = inode->
i_šo
;

462 
bh
->
b_dœt
 = 1;

463 
dœ
->
i_Æšk
++;

464 
dœ
->
i_dœt
 = 1;

465 
	`ut
(
dœ
);

466 
	`ut
(
šode
);

467 
	`b»l£
(
bh
);

469 
	}
}

474 
	$em±y_dœ
(
šode
 * inode)

476 
off£t
;

477 
bufãr_h—d
 * 
bh
;

478 
ext_dœ_’Œy
 * 
de
, * 
de1
;

480 ià(
šode
->
i_size
 < 2 * 12 || !(
bh
 = 
	`ext_b»ad
(inode,0,0))) {

481 
	`´štk
("w¬nšg - bad dœeùÜy oÀdev %04x\n",
šode
->
i_dev
);

484 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

485 
de1
 = (
ext_dœ_’Œy
 *è((*è
de
 + de->
»c_Ën
);

486 ià(
de
->
šode
 !ğšode->
i_šo
 || !
de1
->inode ||

487 
	`¡rcmp
(".",
de
->
Çme
è|| sŒcmp("..",
de1
->name)) {

488 
	`´štk
("w¬nšg - bad dœeùÜy oÀdev %04x\n",
šode
->
i_dev
);

491 
off£t
 = 
de
->
»c_Ën
 + 
de1
->rec_len;

492 
de
 = (
ext_dœ_’Œy
 *è((*è
de1
 + de1->
»c_Ën
);

493 
off£t
 < 
šode
->
i_size
 ) {

494 ià((*è
de
 >ğ(*è(
bh
->
b_d©a
+
BLOCK_SIZE
)) {

495 
	`b»l£
(
bh
);

496 
bh
 = 
	`ext_b»ad
(
šode
, 
off£t
 >> 
BLOCK_SIZE_BITS
,1);

497 ià(!
bh
) {

498 
off£t
 +ğ
BLOCK_SIZE
;

501 
de
 = (
ext_dœ_’Œy
 *è
bh
->
b_d©a
;

503 ià(
de
->
»c_Ën
 < 8 || de->rec_len %4 != 0 ||

504 
de
->
»c_Ën
 < de->
Çme_Ën
 + 8) {

505 
	`´štk
 ("empty_dir: bad dirƒntry\n");

506 
	`´štk
 ("dev=%d, dir=%d, offset=%d,„ec_len=%d,‚ame_len=%d\n",

507 
šode
->
i_dev
, inode->
i_šo
, 
off£t
, 
de
->
»c_Ën
, de->
Çme_Ën
);

508 
	`b»l£
 (
bh
);

511 ià(
de
->
šode
) {

512 
	`b»l£
(
bh
);

515 
off£t
 +ğ
de
->
»c_Ën
;

516 
de
 = (
ext_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

518 
	`b»l£
(
bh
);

520 
	}
}

522 
šlše
 
	$ext_m”ge_’Œ›s
 (
ext_dœ_’Œy
 * 
de
,

523 
ext_dœ_’Œy
 * 
pde
, ext_dœ_’Œy * 
nde
)

525 ià(
nde
 && !nde->
šode
)

526 
de
->
»c_Ën
 +ğ
nde
->rec_len;

527 ià(
pde
 && !pde->
šode
)

528 
pde
->
»c_Ën
 +ğ
de
->rec_len;

529 
	}
}

531 
	$ext_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

533 
»tv®
;

534 
šode
 * inode;

535 
bufãr_h—d
 * 
bh
;

536 
ext_dœ_’Œy
 * 
de
, * 
pde
, * 
nde
;

538 
šode
 = 
NULL
;

539 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,&
pde
,&
nde
);

540 
»tv®
 = -
ENOENT
;

541 ià(!
bh
)

542 
’d_rmdœ
;

543 
»tv®
 = -
EPERM
;

544 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

545 
’d_rmdœ
;

546 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& 
cu¼’t
->
euid
 &&

547 
šode
->
i_uid
 !ğ
cu¼’t
->
euid
)

548 
’d_rmdœ
;

549 ià(
šode
->
i_dev
 !ğ
dœ
->i_dev)

550 
’d_rmdœ
;

551 ià(
šode
 =ğ
dœ
)

552 
’d_rmdœ
;

553 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

554 
»tv®
 = -
ENOTDIR
;

555 
’d_rmdœ
;

557 ià(!
	`em±y_dœ
(
šode
)) {

558 
»tv®
 = -
ENOTEMPTY
;

559 
’d_rmdœ
;

561 ià(
šode
->
i_couÁ
 > 1) {

562 
»tv®
 = -
EBUSY
;

563 
’d_rmdœ
;

565 ià(
šode
->
i_Æšk
 != 2)

566 
	`´štk
("em±y dœeùÜy ha Æšk!=2 (%d)\n",
šode
->
i_Æšk
);

567 
de
->
šode
 = 0;

568 
de
->
Çme_Ën
 = 0;

569 
	`ext_m”ge_’Œ›s
 (
de
, 
pde
, 
nde
);

570 
bh
->
b_dœt
 = 1;

571 
šode
->
i_Æšk
=0;

572 
šode
->
i_dœt
=1;

573 
dœ
->
i_Æšk
--;

574 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

575 
dœ
->
i_dœt
=1;

576 
»tv®
 = 0;

577 
’d_rmdœ
:

578 
	`ut
(
dœ
);

579 
	`ut
(
šode
);

580 
	`b»l£
(
bh
);

581  
»tv®
;

582 
	}
}

584 
	$ext_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

586 
»tv®
;

587 
šode
 * inode;

588 
bufãr_h—d
 * 
bh
;

589 
ext_dœ_’Œy
 * 
de
, * 
pde
, * 
nde
;

591 
»tv®
 = -
ENOENT
;

592 
šode
 = 
NULL
;

593 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,&
pde
,&
nde
);

594 ià(!
bh
)

595 
’d_uÆšk
;

596 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

597 
’d_uÆšk
;

598 
»tv®
 = -
EPERM
;

599 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& !
	`su£r
() &&

600 
cu¼’t
->
euid
 !ğ
šode
->
i_uid
 &&

601 
cu¼’t
->
euid
 !ğ
dœ
->
i_uid
)

602 
’d_uÆšk
;

603 ià(
	`S_ISDIR
(
šode
->
i_mode
))

604 
’d_uÆšk
;

605 ià(!
šode
->
i_Æšk
) {

606 
	`´štk
("Deleting‚onexistent file (%04x:%d), %d\n",

607 
šode
->
i_dev
,šode->
i_šo
,šode->
i_Æšk
);

608 
šode
->
i_Æšk
=1;

610 
de
->
šode
 = 0;

611 
de
->
Çme_Ën
 = 0;

612 
	`ext_m”ge_’Œ›s
 (
de
, 
pde
, 
nde
);

613 
bh
->
b_dœt
 = 1;

614 
šode
->
i_Æšk
--;

615 
šode
->
i_dœt
 = 1;

616 
šode
->
i_ùime
 = 
CURRENT_TIME
;

617 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
šode
->i_ctime;

618 
dœ
->
i_dœt
 = 1;

619 
»tv®
 = 0;

620 
’d_uÆšk
:

621 
	`b»l£
(
bh
);

622 
	`ut
(
šode
);

623 
	`ut
(
dœ
);

624  
»tv®
;

625 
	}
}

627 
	$ext_symlšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, cÚ¡ * 
symÇme
)

629 
ext_dœ_’Œy
 * 
de
;

630 
šode
 * inodğ
NULL
;

631 
bufãr_h—d
 * 
bh
 = 
NULL
, * 
Çme_block
 = NULL;

632 
i
;

633 
c
;

635 ià(!(
šode
 = 
	`ext_Ãw_šode
(
dœ
))) {

636 
	`ut
(
dœ
);

637  -
ENOSPC
;

639 
šode
->
i_mode
 = 
S_IFLNK
 | 0777;

640 
šode
->
i_İ
 = &
ext_symlšk_šode_İ”©iÚs
;

641 
Çme_block
 = 
	`ext_b»ad
(
šode
,0,1);

642 ià(!
Çme_block
) {

643 
	`ut
(
dœ
);

644 
šode
->
i_Æšk
--;

645 
šode
->
i_dœt
 = 1;

646 
	`ut
(
šode
);

647  -
ENOSPC
;

649 
i
 = 0;

650 
i
 < 1023 && (
c
 = *(
symÇme
++)))

651 
Çme_block
->
b_d©a
[
i
++] = 
c
;

652 
Çme_block
->
b_d©a
[
i
] = 0;

653 
Çme_block
->
b_dœt
 = 1;

654 
	`b»l£
(
Çme_block
);

655 
šode
->
i_size
 = 
i
;

656 
šode
->
i_dœt
 = 1;

657 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,
NULL
,NULL);

658 ià(
bh
) {

659 
šode
->
i_Æšk
--;

660 
šode
->
i_dœt
 = 1;

661 
	`ut
(
šode
);

662 
	`b»l£
(
bh
);

663 
	`ut
(
dœ
);

664  -
EEXIST
;

666 
bh
 = 
	`ext_add_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

667 ià(!
bh
) {

668 
šode
->
i_Æšk
--;

669 
šode
->
i_dœt
 = 1;

670 
	`ut
(
šode
);

671 
	`ut
(
dœ
);

672  -
ENOSPC
;

674 
de
->
šode
 = inode->
i_šo
;

675 
bh
->
b_dœt
 = 1;

676 
	`b»l£
(
bh
);

677 
	`ut
(
dœ
);

678 
	`ut
(
šode
);

680 
	}
}

682 
	$ext_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

684 
ext_dœ_’Œy
 * 
de
;

685 
bufãr_h—d
 * 
bh
;

687 ià(
	`S_ISDIR
(
Şdšode
->
i_mode
)) {

688 
	`ut
(
Şdšode
);

689 
	`ut
(
dœ
);

690  -
EPERM
;

692 ià(
Şdšode
->
i_Æšk
 > 32000) {

693 
	`ut
(
Şdšode
);

694 
	`ut
(
dœ
);

695  -
EMLINK
;

697 
bh
 = 
	`ext_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
,
NULL
,NULL);

698 ià(
bh
) {

699 
	`b»l£
(
bh
);

700 
	`ut
(
dœ
);

701 
	`ut
(
Şdšode
);

702  -
EEXIST
;

704 
bh
 = 
	`ext_add_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

705 ià(!
bh
) {

706 
	`ut
(
dœ
);

707 
	`ut
(
Şdšode
);

708  -
ENOSPC
;

710 
de
->
šode
 = 
Şdšode
->
i_šo
;

711 
bh
->
b_dœt
 = 1;

712 
	`b»l£
(
bh
);

713 
	`ut
(
dœ
);

714 
Şdšode
->
i_Æšk
++;

715 
Şdšode
->
i_ùime
 = 
CURRENT_TIME
;

716 
Şdšode
->
i_dœt
 = 1;

717 
	`ut
(
Şdšode
);

719 
	}
}

721 
	$subdœ
(
šode
 * 
Ãw_šode
, šod* 
Şd_šode
)

723 
šo
;

724 
»suÉ
;

726 
Ãw_šode
->
i_couÁ
++;

727 
»suÉ
 = 0;

729 ià(
Ãw_šode
 =ğ
Şd_šode
) {

730 
»suÉ
 = 1;

733 ià(
Ãw_šode
->
i_dev
 !ğ
Şd_šode
->i_dev)

735 
šo
 = 
Ãw_šode
->
i_šo
;

736 ià(
	`ext_lookup
(
Ãw_šode
,"..",2,&new_inode))

738 ià(
Ãw_šode
->
i_šo
 =ğ
šo
)

741 
	`ut
(
Ãw_šode
);

742  
»suÉ
;

743 
	}
}

745 
	#PARENT_INO
(
bufãr
) \

746 ((
ext_dœ_’Œy
 *è((*è
bufãr
 + \

747 ((
ext_dœ_’Œy
 *è
bufãr
)->
»c_Ën
))->
šode


	)

749 
	#PARENT_NAME
(
bufãr
) \

750 ((
ext_dœ_’Œy
 *è((*è
bufãr
 + \

751 ((
ext_dœ_’Œy
 *è
bufãr
)->
»c_Ën
))->
Çme


	)

763 
	$do_ext_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

764 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

766 
šode
 * 
Şd_šode
, * 
Ãw_šode
;

767 
bufãr_h—d
 * 
Şd_bh
, * 
Ãw_bh
, * 
dœ_bh
;

768 
ext_dœ_’Œy
 * 
Şd_de
, * 
Ãw_de
, * 
pde
, * 
nde
;

769 
»tv®
;

771 
¡¬t_up
;

772 
Œy_agaš
:

773 
	`b»l£
(
Şd_bh
);

774 
	`b»l£
(
Ãw_bh
);

775 
	`b»l£
(
dœ_bh
);

776 
	`ut
(
Şd_šode
);

777 
	`ut
(
Ãw_šode
);

778 
cu¼’t
->
couÁ”
 = 0;

779 
	`scheduË
();

780 
¡¬t_up
:

781 
Şd_šode
 = 
Ãw_šode
 = 
NULL
;

782 
Şd_bh
 = 
Ãw_bh
 = 
dœ_bh
 = 
NULL
;

783 
Şd_bh
 = 
	`ext_fšd_’Œy
(
Şd_dœ
,
Şd_Çme
,
Şd_Ën
,&
Şd_de
,&
pde
,&
nde
);

784 
»tv®
 = -
ENOENT
;

785 ià(!
Şd_bh
)

786 
’d_»Çme
;

787 
Şd_šode
 = 
	`__ig‘
(
Şd_dœ
->
i_sb
, 
Şd_de
->
šode
,0);

788 ià(!
Şd_šode
)

789 
’d_»Çme
;

790 
»tv®
 = -
EPERM
;

791 ià((
Şd_dœ
->
i_mode
 & 
S_ISVTX
) &&

792 
cu¼’t
->
euid
 !ğ
Şd_šode
->
i_uid
 &&

793 
cu¼’t
->
euid
 !ğ
Şd_dœ
->
i_uid
 && !
	`su£r
())

794 
’d_»Çme
;

795 
Ãw_bh
 = 
	`ext_fšd_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_de
,
NULL
,NULL);

796 ià(
Ãw_bh
) {

797 
Ãw_šode
 = 
	`__ig‘
(
Ãw_dœ
->
i_sb
, 
Ãw_de
->
šode
,0);

798 ià(!
Ãw_šode
) {

799 
	`b»l£
(
Ãw_bh
);

800 
Ãw_bh
 = 
NULL
;

803 ià(
Ãw_šode
 =ğ
Şd_šode
) {

804 
»tv®
 = 0;

805 
’d_»Çme
;

807 ià(
Ãw_šode
 && 
	`S_ISDIR
Òew_šode->
i_mode
)) {

808 
»tv®
 = -
EEXIST
;

809 
’d_»Çme
;

811 
»tv®
 = -
EPERM
;

812 ià(
Ãw_šode
 && (
Ãw_dœ
->
i_mode
 & 
S_ISVTX
) &&

813 
cu¼’t
->
euid
 !ğ
Ãw_šode
->
i_uid
 &&

814 
cu¼’t
->
euid
 !ğ
Ãw_dœ
->
i_uid
 && !
	`su£r
())

815 
’d_»Çme
;

816 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

817 
»tv®
 = -
EEXIST
;

818 ià(
Ãw_bh
)

819 
’d_»Çme
;

820 
»tv®
 = -
EACCES
;

821 ià(!
	`³rmissiÚ
(
Şd_šode
, 
MAY_WRITE
))

822 
’d_»Çme
;

823 
»tv®
 = -
EINVAL
;

824 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

825 
’d_»Çme
;

826 
»tv®
 = -
EIO
;

827 
dœ_bh
 = 
	`ext_b»ad
(
Şd_šode
,0,0);

828 ià(!
dœ_bh
)

829 
’d_»Çme
;

830 ià(
	`PARENT_INO
(
dœ_bh
->
b_d©a
è!ğ
Şd_dœ
->
i_šo
)

831 
’d_»Çme
;

833 ià(!
Ãw_bh
)

834 
Ãw_bh
 = 
	`ext_add_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_de
);

835 
»tv®
 = -
ENOSPC
;

836 ià(!
Ãw_bh
)

837 
’d_»Çme
;

839 ià(
Ãw_šode
 && (
Ãw_de
->
šode
 !ğÃw_šode->
i_šo
))

840 
Œy_agaš
;

841 ià(
Ãw_de
->
šode
 && !
Ãw_šode
)

842 
Œy_agaš
;

843 ià(
Şd_de
->
šode
 !ğ
Şd_šode
->
i_šo
)

844 
Œy_agaš
;

846 
Şd_de
->
šode
 = 0;

847 
Şd_de
->
Çme_Ën
 = 0;

848 
Ãw_de
->
šode
 = 
Şd_šode
->
i_šo
;

849 
	`ext_m”ge_’Œ›s
 (
Şd_de
, 
pde
, 
nde
);

850 ià(
Ãw_šode
) {

851 
Ãw_šode
->
i_Æšk
--;

852 
Ãw_šode
->
i_dœt
 = 1;

854 
Şd_bh
->
b_dœt
 = 1;

855 
Ãw_bh
->
b_dœt
 = 1;

856 ià(
dœ_bh
) {

857 
	`PARENT_INO
(
dœ_bh
->
b_d©a
èğ
Ãw_dœ
->
i_šo
;

858 
dœ_bh
->
b_dœt
 = 1;

859 
Şd_dœ
->
i_Æšk
--;

860 
Ãw_dœ
->
i_Æšk
++;

861 
Şd_dœ
->
i_dœt
 = 1;

862 
Ãw_dœ
->
i_dœt
 = 1;

864 
»tv®
 = 0;

865 
’d_»Çme
:

866 
	`b»l£
(
dœ_bh
);

867 
	`b»l£
(
Şd_bh
);

868 
	`b»l£
(
Ãw_bh
);

869 
	`ut
(
Şd_šode
);

870 
	`ut
(
Ãw_šode
);

871 
	`ut
(
Şd_dœ
);

872 
	`ut
(
Ãw_dœ
);

873  
»tv®
;

874 
	}
}

885 
	$ext_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

886 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

888 
wa™_queue
 * 
wa™
 = 
NULL
;

889 
lock
 = 0;

890 
»suÉ
;

892 
lock
)

893 
	`¦“p_Ú
(&
wa™
);

894 
lock
 = 1;

895 
»suÉ
 = 
	`do_ext_»Çme
(
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
,

896 
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
);

897 
lock
 = 0;

898 
	`wake_up
(&
wa™
);

899  
»suÉ
;

900 
	}
}

	@fs/ext/symlink.c

15 
	~<asm/£gm’t.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/sched.h
>

19 
	~<lšux/fs.h
>

20 
	~<lšux/ext_fs.h
>

21 
	~<lšux/¡©.h
>

23 
ext_»adlšk
(
šode
 *, *, );

24 
ext_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

29 
šode_İ”©iÚs
 
	gext_symlšk_šode_İ”©iÚs
 = {

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
ext_»adlšk
,

41 
ext_fŞlow_lšk
,

42 
NULL
,

43 
NULL
,

44 
NULL


47 
	$ext_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

48 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

50 
”rÜ
;

51 
bufãr_h—d
 * 
bh
;

53 *
»s_šode
 = 
NULL
;

54 ià(!
dœ
) {

55 
dœ
 = 
cu¼’t
->
roÙ
;

56 
dœ
->
i_couÁ
++;

58 ià(!
šode
) {

59 
	`ut
(
dœ
);

60  -
ENOENT
;

62 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

63 
	`ut
(
dœ
);

64 *
»s_šode
 = 
šode
;

67 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

68 
	`ut
(
dœ
);

69 
	`ut
(
šode
);

70  -
ELOOP
;

72 ià(!(
bh
 = 
	`ext_b»ad
(
šode
, 0, 0))) {

73 
	`ut
(
šode
);

74 
	`ut
(
dœ
);

75  -
EIO
;

77 
	`ut
(
šode
);

78 
cu¼’t
->
lšk_couÁ
++;

79 
”rÜ
 = 
	`İ’_Çmei
(
bh
->
b_d©a
,
æag
,
mode
,
»s_šode
,
dœ
);

80 
cu¼’t
->
lšk_couÁ
--;

81 
	`b»l£
(
bh
);

82  
”rÜ
;

83 
	}
}

85 
	$ext_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

87 
bufãr_h—d
 * 
bh
;

88 
i
;

89 
c
;

91 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

92 
	`ut
(
šode
);

93  -
EINVAL
;

95 ià(
buæ’
 > 1023)

96 
buæ’
 = 1023;

97 
bh
 = 
	`ext_b»ad
(
šode
, 0, 0);

98 
	`ut
(
šode
);

99 ià(!
bh
)

101 
i
 = 0;

102 
i
<
buæ’
 && (
c
 = 
bh
->
b_d©a
[i])) {

103 
i
++;

104 
	`put_fs_by‹
(
c
,
bufãr
++);

106 
	`b»l£
(
bh
);

107  
i
;

108 
	}
}

	@fs/ext/truncate.c

13 
	~<lšux/sched.h
>

14 
	~<lšux/ext_fs.h
>

15 
	~<lšux/¡©.h
>

16 
	~<lšux/fú.h
>

17 
	~<lšux/”ºo.h
>

32 
	$Œunc_dœeù
(
šode
 * inode)

34 
i
, 
tmp
;

35 * 
p
;

36 
bufãr_h—d
 * 
bh
;

37 
»Œy
 = 0;

38 
	#DIRECT_BLOCK
 ((
šode
->
i_size
 + 1023è>> 10)

	)

40 
»³©
:

41 
i
 = 
DIRECT_BLOCK
 ; i < 9 ; i++) {

42 
p
 = 
šode
->
u
.
ext_i
.
i_d©a
+
i
;

43 ià(!(
tmp
 = *
p
))

45 
bh
 = 
	`g‘blk
(
šode
->
i_dev
,
tmp
,
BLOCK_SIZE
);

46 ià(
i
 < 
DIRECT_BLOCK
) {

47 
	`b»l£
(
bh
);

48 
»³©
;

50 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
p
) {

51 
»Œy
 = 1;

52 
	`b»l£
(
bh
);

55 *
p
 = 0;

56 
šode
->
i_dœt
 = 1;

57 
	`b»l£
(
bh
);

58 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

60  
»Œy
;

61 
	}
}

63 
	$Œunc_šdœeù
(
šode
 * inode, 
off£t
, * 
p
)

65 
i
, 
tmp
;

66 
bufãr_h—d
 * 
bh
;

67 
bufãr_h—d
 * 
šd_bh
;

68 * 
šd
;

69 
»Œy
 = 0;

70 
	#INDIRECT_BLOCK
 (
DIRECT_BLOCK
-
off£t
)

	)

72 
tmp
 = *
p
;

73 ià(!
tmp
)

75 
šd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

76 ià(
tmp
 !ğ*
p
) {

77 
	`b»l£
(
šd_bh
);

80 ià(!
šd_bh
) {

81 *
p
 = 0;

84 
»³©
:

85 
i
 = 
INDIRECT_BLOCK
 ; i < 256 ; i++) {

86 ià(
i
 < 0)

87 
i
 = 0;

88 ià(
i
 < 
INDIRECT_BLOCK
)

89 
»³©
;

90 
šd
 = 
i
+(*è
šd_bh
->
b_d©a
;

91 
tmp
 = *
šd
;

92 ià(!
tmp
)

94 
bh
 = 
	`g‘blk
(
šode
->
i_dev
,
tmp
,
BLOCK_SIZE
);

95 ià(
i
 < 
INDIRECT_BLOCK
) {

96 
	`b»l£
(
bh
);

97 
»³©
;

99 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
šd
) {

100 
»Œy
 = 1;

101 
	`b»l£
(
bh
);

104 *
šd
 = 0;

105 
šd_bh
->
b_dœt
 = 1;

106 
	`b»l£
(
bh
);

107 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

109 
šd
 = (*è
šd_bh
->
b_d©a
;

110 
i
 = 0; i < 256; i++)

111 ià(*(
šd
++))

113 ià(
i
 >= 256)

114 ià(
šd_bh
->
b_couÁ
 != 1)

115 
»Œy
 = 1;

117 
tmp
 = *
p
;

118 *
p
 = 0;

119 
šode
->
i_dœt
 = 1;

120 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

122 
	`b»l£
(
šd_bh
);

123  
»Œy
;

124 
	}
}

126 
	$Œunc_dšdœeù
(
šode
 * inode, 
off£t
, * 
p
)

128 
i
,
tmp
;

129 
bufãr_h—d
 * 
dšd_bh
;

130 * 
dšd
;

131 
»Œy
 = 0;

132 
	#DINDIRECT_BLOCK
 ((
DIRECT_BLOCK
-
off£t
)>>8)

	)

134 
tmp
 = *
p
;

135 ià(!
tmp
)

137 
dšd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

138 ià(
tmp
 !ğ*
p
) {

139 
	`b»l£
(
dšd_bh
);

142 ià(!
dšd_bh
) {

143 *
p
 = 0;

146 
»³©
:

147 
i
 = 
DINDIRECT_BLOCK
 ; i < 256 ; i ++) {

148 ià(
i
 < 0)

149 
i
 = 0;

150 ià(
i
 < 
DINDIRECT_BLOCK
)

151 
»³©
;

152 
dšd
 = 
i
+(*è
dšd_bh
->
b_d©a
;

153 
tmp
 = *
dšd
;

154 ià(!
tmp
)

156 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,
off£t
+(
i
<<8),
dšd
);

157 
dšd_bh
->
b_dœt
 = 1;

159 
dšd
 = (*è
dšd_bh
->
b_d©a
;

160 
i
 = 0; i < 256; i++)

161 ià(*(
dšd
++))

163 ià(
i
 >= 256)

164 ià(
dšd_bh
->
b_couÁ
 != 1)

165 
»Œy
 = 1;

167 
tmp
 = *
p
;

168 *
p
 = 0;

169 
šode
->
i_dœt
 = 1;

170 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

172 
	`b»l£
(
dšd_bh
);

173  
»Œy
;

174 
	}
}

176 
	$Œunc_tšdœeù
(
šode
 * inode)

178 
i
,
tmp
;

179 
bufãr_h—d
 * 
tšd_bh
;

180 * 
tšd
, * 
p
;

181 
»Œy
 = 0;

182 
	#TINDIRECT_BLOCK
 ((
DIRECT_BLOCK
-(256*256+256+9))>>16)

	)

184 
p
 = 
šode
->
u
.
ext_i
.
i_d©a
+11;

185 ià(!(
tmp
 = *
p
))

187 
tšd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

188 ià(
tmp
 !ğ*
p
) {

189 
	`b»l£
(
tšd_bh
);

192 ià(!
tšd_bh
) {

193 *
p
 = 0;

196 
»³©
:

197 
i
 = 
TINDIRECT_BLOCK
 ; i < 256 ; i ++) {

198 ià(
i
 < 0)

199 
i
 = 0;

200 ià(
i
 < 
TINDIRECT_BLOCK
)

201 
»³©
;

202 
tšd
 = 
i
+(*è
tšd_bh
->
b_d©a
;

203 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
,9+256+256*256+(
i
<<16),
tšd
);

204 
tšd_bh
->
b_dœt
 = 1;

206 
tšd
 = (*è
tšd_bh
->
b_d©a
;

207 
i
 = 0; i < 256; i++)

208 ià(*(
tšd
++))

210 ià(
i
 >= 256)

211 ià(
tšd_bh
->
b_couÁ
 != 1)

212 
»Œy
 = 1;

214 
tmp
 = *
p
;

215 *
p
 = 0;

216 
šode
->
i_dœt
 = 1;

217 
	`ext_ä“_block
(
šode
->
i_sb
,
tmp
);

219 
	`b»l£
(
tšd_bh
);

220  
»Œy
;

221 
	}
}

223 
	$ext_Œunÿ‹
(
šode
 * inode)

225 
»Œy
;

227 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

228 
	`S_ISLNK
(
šode
->
i_mode
)))

231 
»Œy
 = 
	`Œunc_dœeù
(
šode
);

232 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,9,šode->
u
.
ext_i
.
i_d©a
+9);

233 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
,9+256,šode->
u
.
ext_i
.
i_d©a
+10);

234 
»Œy
 |ğ
	`Œunc_tšdœeù
(
šode
);

235 ià(!
»Œy
)

237 
cu¼’t
->
couÁ”
 = 0;

238 
	`scheduË
();

240 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

241 
šode
->
i_dœt
 = 1;

242 
	}
}

249 
	$ext_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

251 
	`´štk
("ext_release‚ot implemented\n");

252 
	}
}

	@fs/ext2/acl.c

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/fs.h
>

16 
	~<lšux/ext2_fs.h
>

17 
	~<lšux/sched.h
>

18 
	~<lšux/¡©.h
>

25 
	$ext2_³rmissiÚ
 (
šode
 * inode, 
mask
)

27 
mode
 = 
šode
->
i_mode
;

32 ià(
	`su£r
 ())

37 ià(
cu¼’t
->
euid
 =ğ
šode
->
i_uid
)

38 
mode
 >>= 6;

39 ià(
	`š_group_p
 (
šode
->
i_gid
))

40 
mode
 >>= 3;

41 ià(((
mode
 & 
mask
 & 
S_IRWXO
) == mask))

45 
	}
}

	@fs/ext2/balloc.c

26 
	~<lšux/fs.h
>

27 
	~<lšux/ext2_fs.h
>

28 
	~<lšux/¡©.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/locks.h
>

33 
	~<asm/b™İs.h
>

35 
	#ş—r_block
(
addr
,
size
) \

36 
	`__asm__
("cld\n\t" \

40 :"a" (0), "c" (
size
 / 4), "D" ((è(
addr
)) \

41 :"cx", "di")

	)

43 
	#š_¿nge
(
b
, 
fœ¡
, 
Ën
è((bè>ğ(fœ¡è&& (bè<ğ(fœ¡è+ (Ënè- 1)

	)

45 
šlše
 
	$fšd_fœ¡_z”o_b™
 (* 
addr
, 
size
)

47 
»s
;

49 ià(!
size
)

51 
	`__asm__
("

52 
şd


53 
movl
 
$
-1,%%
—x


54 
»³
; 
sÿ¦


55 
je
 1f

56 
subl
 
$4
,%%
edi


57 
	`movl
 (%%
edi
),%%
—x


58 
nÙl
 %%
—x


59 
bsæ
 %%
—x
,%%
edx


60 
jmp
 2f

61 1: 
xÜl
 %%
edx
,%%edx

62 2: 
subl
 %%
ebx
,%%
edi


63 
shÎ
 
$3
,%%
edi


64 
addl
 %%
edi
,%%
edx
"

65 :"=d" (
»s
)

66 :"c" ((
size
 + 31è>> 5), "D" (
addr
), "b" (addr)

68  
»s
;

69 
	}
}

71 
šlše
 
	$fšd_Ãxt_z”o_b™
 (* 
addr
, 
size
,

72 
off£t
)

74 * 
p
 = ((*è
addr
è+ (
off£t
 >> 5);

75 
£t
 = 0, 
b™
 = 
off£t
 & 31, 
»s
;

77 ià(
b™
) {

81 
	`__asm__
("

82 
bsæ
 %1,%0

83 
jÃ
 1f

84 
movl
 
$32
, %0

86 : "ô" (
£t
)

87 : "r" (~(*
p
 >> 
b™
)));

88 ià(
£t
 < (32 - 
b™
))

89  
£t
 + 
off£t
;

90 
£t
 = 32 - 
b™
;

91 
p
++;

96 
»s
 = 
	`fšd_fœ¡_z”o_b™
 (
p
, 
size
 - 32 * (°- 
addr
));

97  (
off£t
 + 
£t
 + 
»s
);

98 
	}
}

100 
šlše
 * 
	$fšd_fœ¡_z”o_by‹
 (* 
addr
, 
size
)

102 *
»s
;

104 ià(!
size
)

106 
	`__asm__
("

107 
şd


108 
mov
 
$0
,%%
—x


109 
»²z
; 
sÿsb


110 
jnz
 1f

111 
dec
 %%
edi


113 : "=D" (
»s
)

114 : "0" (
addr
), "c" (
size
)

116  
»s
;

117 
	}
}

119 
ext2_group_desc
 * 
	$g‘_group_desc
 (
su³r_block
 * 
sb
,

120 
block_group
,

121 
bufãr_h—d
 ** 
bh
)

123 
group_desc
;

124 
desc
;

125 
ext2_group_desc
 * 
gdp
;

127 ià(
block_group
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

128 
	`ext2_·nic
 (
sb
, "get_group_desc",

131 
block_group
, 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
);

133 
group_desc
 = 
block_group
 / 
	`EXT2_DESC_PER_BLOCK
(
sb
);

134 
desc
 = 
block_group
 % 
	`EXT2_DESC_PER_BLOCK
(
sb
);

135 ià(!
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
])

136 
	`ext2_·nic
 (
sb
, "get_group_desc",

139 
block_group
, 
group_desc
, 
desc
);

140 
gdp
 = (
ext2_group_desc
 *)

141 
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
]->
b_d©a
;

142 ià(
bh
)

143 *
bh
 = 
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
];

144  
gdp
 + 
desc
;

145 
	}
}

147 
	$»ad_block_b™m­
 (
su³r_block
 * 
sb
,

148 
block_group
,

149 
b™m­_Ä
)

151 
ext2_group_desc
 * 
gdp
;

152 
bufãr_h—d
 * 
bh
;

154 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
block_group
, 
NULL
);

155 
bh
 = 
	`b»ad
 (
sb
->
s_dev
, 
gdp
->
bg_block_b™m­
, sb->
s_blocksize
);

156 ià(!
bh
)

157 
	`ext2_·nic
 (
sb
, "read_block_bitmap",

160 
block_group
, 
gdp
->
bg_block_b™m­
);

161 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
b™m­_Ä
] = 
block_group
;

162 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
] = 
bh
;

163 
	}
}

176 
	$lßd__block_b™m­
 (
su³r_block
 * 
sb
,

177 
block_group
)

179 
i
, 
j
;

180 
block_b™m­_numb”
;

181 
bufãr_h—d
 * 
block_b™m­
;

183 ià(
block_group
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

184 
	`ext2_·nic
 (
sb
, "load_block_bitmap",

187 
block_group
, 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
);

189 ià(
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 <ğ
EXT2_MAX_GROUP_LOADED
) {

190 ià(
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
block_group
]) {

191 ià(
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
block_group
] !=

192 
block_group
)

193 
	`ext2_·nic
 (
sb
, "load_block_bitmap",

196  
block_group
;

198 
	`»ad_block_b™m­
 (
sb
, 
block_group
, block_group);

199  
block_group
;

203 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 &&

204 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
i
] !ğ
block_group
; i++)

206 ià(
i
 < 
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 &&

207 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
i
] =ğ
block_group
) {

208 
block_b™m­_numb”
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
i
];

209 
block_b™m­
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
i
];

210 
j
 = 
i
; j > 0; j--) {

211 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
j
] =

212 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
j
 - 1];

213 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
j
] =

214 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
j
 - 1];

216 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[0] = 
block_b™m­_numb”
;

217 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[0] = 
block_b™m­
;

219 ià(
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 < 
EXT2_MAX_GROUP_LOADED
)

220 
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
++;

222 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
EXT2_MAX_GROUP_LOADED
 - 1]);

223 
j
 = 
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 - 1; j > 0; j--) {

224 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
j
] =

225 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
j
 - 1];

226 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
j
] =

227 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
j
 - 1];

229 
	`»ad_block_b™m­
 (
sb
, 
block_group
, 0);

232 
	}
}

234 
šlše
 
	$lßd_block_b™m­
 (
su³r_block
 * 
sb
,

235 
block_group
)

237 ià(
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 > 0 &&

238 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[0] =ğ
block_group
)

241 ià(
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 <ğ
EXT2_MAX_GROUP_LOADED
 &&

242 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
block_group
] == block_group &&

243 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
block_group
])

244  
block_group
;

246  
	`lßd__block_b™m­
 (
sb
, 
block_group
);

247 
	}
}

249 
	$ext2_ä“_blocks
 (
su³r_block
 * 
sb
, 
block
,

250 
couÁ
)

252 
bufãr_h—d
 * 
bh
;

253 
bufãr_h—d
 * 
bh2
;

254 
block_group
;

255 
b™
;

256 
i
;

257 
b™m­_Ä
;

258 
ext2_group_desc
 * 
gdp
;

259 
ext2_su³r_block
 * 
es
;

261 ià(!
sb
) {

262 
	`´štk
 ("ext2_free_blocks:‚onexistent device");

265 
	`lock_su³r
 (
sb
);

266 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

267 ià(
block
 < 
es
->
s_fœ¡_d©a_block
 ||

268 (
block
 + 
couÁ
è> 
es
->
s_blocks_couÁ
) {

269 
	`ext2_”rÜ
 (
sb
, "ext2_free_blocks",

271 "block = %lu, couÁ = %lu", 
block
, 
couÁ
);

272 
	`uÆock_su³r
 (
sb
);

276 
	`ext2_debug
 ("ä“šg block %lu\n", 
block
);

278 
block_group
 = (
block
 - 
es
->
s_fœ¡_d©a_block
) /

279 
	`EXT2_BLOCKS_PER_GROUP
(
sb
);

280 
b™
 = (
block
 - 
es
->
s_fœ¡_d©a_block
è% 
	`EXT2_BLOCKS_PER_GROUP
(
sb
);

281 ià(
b™
 + 
couÁ
 > 
	`EXT2_BLOCKS_PER_GROUP
(
sb
))

282 
	`ext2_·nic
 (
sb
, "ext2_free_blocks",

285 
block
, 
couÁ
);

286 
b™m­_Ä
 = 
	`lßd_block_b™m­
 (
sb
, 
block_group
);

287 
bh
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
];

288 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
block_group
, &
bh2
);

290 ià(
	`‹¡_İt
 (
sb
, 
CHECK_STRICT
) &&

291 (
	`š_¿nge
 (
gdp
->
bg_block_b™m­
, 
block
, 
couÁ
) ||

292 
	`š_¿nge
 (
gdp
->
bg_šode_b™m­
, 
block
, 
couÁ
) ||

293 
	`š_¿nge
 (
block
, 
gdp
->
bg_šode_bË
,

294 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
) ||

295 
	`š_¿nge
 (
block
 + 
couÁ
 - 1, 
gdp
->
bg_šode_bË
,

296 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
)))

297 
	`ext2_·nic
 (
sb
, "ext2_free_blocks",

300 
block
, 
couÁ
);

302 
i
 = 0; i < 
couÁ
; i++) {

303 ià(!
	`ş—r_b™
 (
b™
 + 
i
, 
bh
->
b_d©a
))

304 
	`ext2_w¬nšg
 (
sb
, "ext2_free_blocks",

306 
block
);

308 
gdp
->
bg_ä“_blocks_couÁ
++;

309 
es
->
s_ä“_blocks_couÁ
++;

313 
bh2
->
b_dœt
 = 1;

314 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

316 
bh
->
b_dœt
 = 1;

317 ià(
sb
->
s_æags
 & 
MS_SYNC
) {

318 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

319 
	`wa™_Ú_bufãr
 (
bh
);

321 
sb
->
s_dœt
 = 1;

322 
	`uÆock_su³r
 (
sb
);

324 
	}
}

333 
	$ext2_Ãw_block
 (
su³r_block
 * 
sb
, 
gßl
,

334 * 
´—Îoc_couÁ
,

335 * 
´—Îoc_block
)

337 
bufãr_h—d
 * 
bh
;

338 
bufãr_h—d
 * 
bh2
;

339 * 
p
, * 
r
;

340 
i
, 
j
, 
k
, 
tmp
;

341 
lm­
;

342 
b™m­_Ä
;

343 
ext2_group_desc
 * 
gdp
;

344 
ext2_su³r_block
 * 
es
;

346 #ifdeà
EXT2FS_DEBUG


347 
gßl_h™s
 = 0, 
gßl_©‹m±s
 = 0;

349 ià(!
sb
) {

350 
	`´štk
 ("ext2_new_block:‚onexistent device");

353 
	`lock_su³r
 (
sb
);

354 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

355 ià(
es
->
s_ä“_blocks_couÁ
 <ğes->
s_r_blocks_couÁ
 && !
	`su£r
()) {

356 
	`uÆock_su³r
 (
sb
);

360 
	`ext2_debug
 ("gßl=%lu.\n", 
gßl
);

362 
»³©
:

366 ià(
gßl
 < 
es
->
s_fœ¡_d©a_block
 || gßÈ>ğes->
s_blocks_couÁ
)

367 
gßl
 = 
es
->
s_fœ¡_d©a_block
;

368 
i
 = (
gßl
 - 
es
->
s_fœ¡_d©a_block
è/ 
	`EXT2_BLOCKS_PER_GROUP
(
sb
);

369 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, &
bh2
);

370 ià(
gdp
->
bg_ä“_blocks_couÁ
 > 0) {

371 
j
 = ((
gßl
 - 
es
->
s_fœ¡_d©a_block
è% 
	`EXT2_BLOCKS_PER_GROUP
(
sb
));

372 #ifdeà
EXT2FS_DEBUG


373 ià(
j
)

374 
gßl_©‹m±s
++;

376 
b™m­_Ä
 = 
	`lßd_block_b™m­
 (
sb
, 
i
);

377 
bh
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
];

379 
	`ext2_debug
 ("gßÈi © %d:%d.\n", 
i
, 
j
);

381 ià(!
	`‹¡_b™
(
j
, 
bh
->
b_d©a
)) {

382 #ifdeà
EXT2FS_DEBUG


383 
gßl_h™s
++;

384 
	`ext2_debug
 ("goal bit‡llocated.\n");

386 
gÙ_block
;

388 ià(
j
) {

393 
lm­
 = ((((*è
bh
->
b_d©a
)[
j
 >> 5]) >>

394 ((
j
 & 31) + 1));

395 ià(
j
 < 
	`EXT2_BLOCKS_PER_GROUP
(
sb
) - 32)

396 
lm­
 |ğ(((*è
bh
->
b_d©a
)[(
j
 >> 5) + 1]) <<

397 (31 - (
j
 & 31));

399 
lm­
 |ğ0xfffffffà<< (31 - (
j
 & 31));

400 ià(
lm­
 != 0xffffffffl) {

401 
	`__asm__
 ("bsfl %1,%0"

402 : "ô" (
k
)

403 : "r" (~
lm­
));

404 
k
++;

405 ià((
j
 + 
k
è< 
	`EXT2_BLOCKS_PER_GROUP
(
sb
)) {

406 
j
 +ğ
k
;

407 
gÙ_block
;

412 
	`ext2_debug
 ("Bit‚ot found‚ear goal\n");

423 
p
 = ((*è
bh
->
b_d©a
è+ (
j
 >> 3);

424 
r
 = 
	`fšd_fœ¡_z”o_by‹
 (
p
,

425 (
	`EXT2_BLOCKS_PER_GROUP
(
sb
è- 
j
 + 7) >> 3);

426 
k
 = (
r
 - ((*è
bh
->
b_d©a
)) << 3;

427 ià(
k
 < 
	`EXT2_BLOCKS_PER_GROUP
(
sb
)) {

428 
j
 = 
k
;

429 
£¬ch_back
;

431 
k
 = 
	`fšd_Ãxt_z”o_b™
 ((*è
bh
->
b_d©a
,

432 
	`EXT2_BLOCKS_PER_GROUP
(
sb
),

433 
j
);

434 ià(
k
 < 
	`EXT2_BLOCKS_PER_GROUP
(
sb
)) {

435 
j
 = 
k
;

436 
gÙ_block
;

440 
	`ext2_debug
 ("B™‚Ù found iÀblock grou°%d.\n", 
i
);

446 
k
 = 0; k < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; k++) {

447 
i
++;

448 ià(
i
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

449 
i
 = 0;

450 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, &
bh2
);

451 ià(
gdp
->
bg_ä“_blocks_couÁ
 > 0)

454 ià(
k
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
) {

455 
	`uÆock_su³r
 (
sb
);

458 
b™m­_Ä
 = 
	`lßd_block_b™m­
 (
sb
, 
i
);

459 
bh
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
];

460 
r
 = 
	`fšd_fœ¡_z”o_by‹
 (
bh
->
b_d©a
,

461 
	`EXT2_BLOCKS_PER_GROUP
(
sb
) >> 3);

462 
j
 = (
r
 - 
bh
->
b_d©a
) << 3;

463 ià(
j
 < 
	`EXT2_BLOCKS_PER_GROUP
(
sb
))

464 
£¬ch_back
;

466 
j
 = 
	`fšd_fœ¡_z”o_b™
 ((*è
bh
->
b_d©a
,

467 
	`EXT2_BLOCKS_PER_GROUP
(
sb
));

468 ià(
j
 >ğ
	`EXT2_BLOCKS_PER_GROUP
(
sb
)) {

469 
	`ext2_”rÜ
 (
sb
, "ext2_new_block",

470 "F»block couÁ cÜru±ed fÜ block grou°%d", 
i
);

471 
	`uÆock_su³r
 (
sb
);

475 
£¬ch_back
:

481 
k
 = 0; k < 7 && 
j
 > 0 && !
	`‹¡_b™
 (j - 1, 
bh
->
b_d©a
); k++, j--);

483 
gÙ_block
:

485 
	`ext2_debug
 ("usšg block grou°%d(%d)\n", 
i
, 
gdp
->
bg_ä“_blocks_couÁ
);

487 
tmp
 = 
j
 + 
i
 * 
	`EXT2_BLOCKS_PER_GROUP
(
sb
è+ 
es
->
s_fœ¡_d©a_block
;

489 ià(
	`‹¡_İt
 (
sb
, 
CHECK_STRICT
) &&

490 (
tmp
 =ğ
gdp
->
bg_block_b™m­
 ||

491 
tmp
 =ğ
gdp
->
bg_šode_b™m­
 ||

492 
	`š_¿nge
 (
tmp
, 
gdp
->
bg_šode_bË
, 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
)))

493 
	`ext2_·nic
 (
sb
, "ext2_new_block",

495 "block = %u", 
tmp
);

497 ià(
	`£t_b™
 (
j
, 
bh
->
b_d©a
)) {

498 
	`ext2_w¬nšg
 (
sb
, "ext2_new_block",

499 "b™‡Ì—dy s‘ fÜ block %d", 
j
);

500 
»³©
;

503 
	`ext2_debug
 ("found b™ %d\n", 
j
);

508 #ifdeà
EXT2_PREALLOCATE


509 ià(
´—Îoc_block
) {

510 *
´—Îoc_couÁ
 = 0;

511 *
´—Îoc_block
 = 
tmp
 + 1;

512 
k
 = 1;

513 
k
 < 8 && (
j
 + kè< 
	`EXT2_BLOCKS_PER_GROUP
(
sb
); k++) {

514 ià(
	`£t_b™
 (
j
 + 
k
, 
bh
->
b_d©a
))

516 (*
´—Îoc_couÁ
)++;

518 
gdp
->
bg_ä“_blocks_couÁ
 -ğ*
´—Îoc_couÁ
;

519 
es
->
s_ä“_blocks_couÁ
 -ğ*
´—Îoc_couÁ
;

520 
	`ext2_debug
 ("Preallocated‡ further %lu bits.\n",

521 *
´—Îoc_couÁ
);

525 
j
 = 
tmp
;

527 
bh
->
b_dœt
 = 1;

528 ià(
sb
->
s_æags
 & 
MS_SYNC
) {

529 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

530 
	`wa™_Ú_bufãr
 (
bh
);

533 ià(
j
 >ğ
es
->
s_blocks_couÁ
) {

534 
	`ext2_”rÜ
 (
sb
, "ext2_new_block",

536 "block_grou°ğ%d, block=%d", 
i
, 
j
);

537 
	`uÆock_su³r
 (
sb
);

540 ià(!(
bh
 = 
	`g‘blk
 (
sb
->
s_dev
, 
j
, sb->
s_blocksize
))) {

541 
	`ext2_”rÜ
 (
sb
, "ext2_Ãw_block", "ÿÂÙ g‘ block %d", 
j
);

542 
	`uÆock_su³r
 (
sb
);

545 
	`ş—r_block
 (
bh
->
b_d©a
, 
sb
->
s_blocksize
);

546 
bh
->
b_u±od©e
 = 1;

547 
bh
->
b_dœt
 = 1;

548 
	`b»l£
 (
bh
);

550 
	`ext2_debug
 ("allocating block %d. "

551 "GßÈh™ %d oà%d.\n", 
j
, 
gßl_h™s
, 
gßl_©‹m±s
);

553 
gdp
->
bg_ä“_blocks_couÁ
--;

554 
bh2
->
b_dœt
 = 1;

555 
es
->
s_ä“_blocks_couÁ
--;

556 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

557 
sb
->
s_dœt
 = 1;

558 
	`uÆock_su³r
 (
sb
);

559  
j
;

560 
	}
}

562 
	$ext2_couÁ_ä“_blocks
 (
su³r_block
 * 
sb
)

564 #ifdeà
EXT2FS_DEBUG


565 
ext2_su³r_block
 * 
es
;

566 
desc_couÁ
, 
b™m­_couÁ
, 
x
;

567 
b™m­_Ä
;

568 
ext2_group_desc
 * 
gdp
;

569 
i
;

571 
	`lock_su³r
 (
sb
);

572 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

573 
desc_couÁ
 = 0;

574 
b™m­_couÁ
 = 0;

575 
gdp
 = 
NULL
;

576 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; i++) {

577 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, 
NULL
);

578 
desc_couÁ
 +ğ
gdp
->
bg_ä“_blocks_couÁ
;

579 
b™m­_Ä
 = 
	`lßd_block_b™m­
 (
sb
, 
i
);

580 
x
 = 
	`ext2_couÁ_ä“
 (
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
],

581 
sb
->
s_blocksize
);

582 
	`´štk
 ("group %d: stored = %d, counted = %lu\n",

583 
i
, 
gdp
->
bg_ä“_blocks_couÁ
, 
x
);

584 
b™m­_couÁ
 +ğ
x
;

586 
	`´štk
("ext2_count_free_blocks: stored = %lu, computed = %lu, %lu\n",

587 
es
->
s_ä“_blocks_couÁ
, 
desc_couÁ
, 
b™m­_couÁ
);

588 
	`uÆock_su³r
 (
sb
);

589  
b™m­_couÁ
;

591  
sb
->
u
.
ext2_sb
.
s_es
->
s_ä“_blocks_couÁ
;

593 
	}
}

595 
šlše
 
	$block_š_u£
 (
block
,

596 
su³r_block
 * 
sb
,

597 * 
m­
)

599  
	`‹¡_b™
 ((
block
 - 
sb
->
u
.
ext2_sb
.
s_es
->
s_fœ¡_d©a_block
) %

600 
	`EXT2_BLOCKS_PER_GROUP
(
sb
), 
m­
);

601 
	}
}

603 
	$ext2_check_blocks_b™m­
 (
su³r_block
 * 
sb
)

605 
bufãr_h—d
 * 
bh
;

606 
ext2_su³r_block
 * 
es
;

607 
desc_couÁ
, 
b™m­_couÁ
, 
x
;

608 
desc_blocks
;

609 
b™m­_Ä
;

610 
ext2_group_desc
 * 
gdp
;

611 
i
, 
j
;

613 
	`lock_su³r
 (
sb
);

614 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

615 
desc_couÁ
 = 0;

616 
b™m­_couÁ
 = 0;

617 
gdp
 = 
NULL
;

618 
desc_blocks
 = (
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 + 
	`EXT2_DESC_PER_BLOCK
(sb) - 1) /

619 
	`EXT2_DESC_PER_BLOCK
(
sb
);

620 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; i++) {

621 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, 
NULL
);

622 
desc_couÁ
 +ğ
gdp
->
bg_ä“_blocks_couÁ
;

623 
b™m­_Ä
 = 
	`lßd_block_b™m­
 (
sb
, 
i
);

624 
bh
 = 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
b™m­_Ä
];

626 ià(!
	`‹¡_b™
 (0, 
bh
->
b_d©a
))

627 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

628 "Su³rblock iÀgrou°%d i m¬ked f»e", 
i
);

630 
j
 = 0; j < 
desc_blocks
; j++)

631 ià(!
	`‹¡_b™
 (
j
 + 1, 
bh
->
b_d©a
))

632 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

634 "%d i m¬ked f»e", 
j
, 
i
);

636 ià(!
	`block_š_u£
 (
gdp
->
bg_block_b™m­
, 
sb
, 
bh
->
b_d©a
))

637 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

639 
i
);

641 ià(!
	`block_š_u£
 (
gdp
->
bg_šode_b™m­
, 
sb
, 
bh
->
b_d©a
))

642 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

644 
i
);

646 
j
 = 0; j < 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
; j++)

647 ià(!
	`block_š_u£
 (
gdp
->
bg_šode_bË
 + 
j
, 
sb
, 
bh
->
b_d©a
))

648 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

650 "grou°%d i m¬ked f»e", 
j
, 
i
);

652 
x
 = 
	`ext2_couÁ_ä“
 (
bh
, 
sb
->
s_blocksize
);

653 ià(
gdp
->
bg_ä“_blocks_couÁ
 !ğ
x
)

654 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

656 "¡Üed = %d, couÁed = %lu", 
i
,

657 
gdp
->
bg_ä“_blocks_couÁ
, 
x
);

658 
b™m­_couÁ
 +ğ
x
;

660 ià(
es
->
s_ä“_blocks_couÁ
 !ğ
b™m­_couÁ
)

661 
	`ext2_”rÜ
 (
sb
, "ext2_check_blocks_bitmap",

664 
es
->
s_ä“_blocks_couÁ
, 
b™m­_couÁ
);

665 
	`uÆock_su³r
 (
sb
);

666 
	}
}

	@fs/ext2/bitmap.c

9 
	~<lšux/fs.h
>

10 
	~<lšux/ext2_fs.h
>

12 
	gnibbËm­
[] = {4, 3, 3, 2, 3, 2, 2, 1, 3, 2, 2, 1, 2, 1, 1, 0};

14 
	$ext2_couÁ_ä“
 (
bufãr_h—d
 * 
m­
, 
numch¬s
)

16 
i
;

17 
sum
 = 0;

19 ià(!
m­
)

21 
i
 = 0; i < 
numch¬s
; i++)

22 
sum
 +ğ
nibbËm­
[
m­
->
b_d©a
[
i
] & 0xf] +

23 
nibbËm­
[(
m­
->
b_d©a
[
i
] >> 4) & 0xf];

24  (
sum
);

25 
	}
}

	@fs/ext2/dcache.c

15 
	~<asm/£gm’t.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/ext2_fs.h
>

19 
	~<lšux/¡ršg.h
>

21 #iâdeà
DONT_USE_DCACHE


23 
	#DCACHE_NAME_LEN
 32

	)

25 
	sdœ_ÿche_’Œy
 {

26 
	mdev
;

27 
	mdœ
;

28 
	mšo
;

29 
	mÇme
[
DCACHE_NAME_LEN
 + 1];

30 
	mËn
;

31 
dœ_ÿche_’Œy
 * 
	mqueue_´ev
;

32 
dœ_ÿche_’Œy
 * 
	mqueue_Ãxt
;

33 
dœ_ÿche_’Œy
 * 
	m´ev
;

34 
dœ_ÿche_’Œy
 * 
	mÃxt
;

37 
dœ_ÿche_’Œy
 * 
	gfœ¡
 = 
NULL
;

38 
dœ_ÿche_’Œy
 * 
	gÏ¡
 = 
NULL
;

39 
dœ_ÿche_’Œy
 * 
	gfœ¡_ä“
 = 
NULL
;

40 
	gÿche_š™Ÿlized
 = 0;

41 #ifdeà
EXT2FS_DEBUG_CACHE


42 
	gh™s
 = 0;

43 
	gmis£s
 = 0;

46 
	#CACHE_SIZE
 128

	)

48 
dœ_ÿche_’Œy
 
	gdÿche
[
CACHE_SIZE
];

50 
	#HASH_QUEUES
 16

	)

52 
dœ_ÿche_’Œy
 * 
	gqueue_h—d
[
HASH_QUEUES
];

53 
dœ_ÿche_’Œy
 * 
	gqueue_
[
HASH_QUEUES
];

55 
	#hash
(
dev
,
dœ
è((dev ^ dœè% 
HASH_QUEUES
)

	)

60 
	$š™_ÿche
 ()

62 
i
;

64 
dÿche
[0].
´ev
 = 
NULL
;

65 
dÿche
[0].
Ãxt
 = &dcache[1];

66 
dÿche
[0].
queue_Ãxt
 = dÿche[0].
queue_´ev
 = 
NULL
;

67 
i
 = 1; i < 
CACHE_SIZE
 - 1; i++) {

68 
dÿche
[
i
].
´ev
 = &dcache[i - 1];

69 
dÿche
[
i
].
Ãxt
 = &dcache[i + 1];

70 
dÿche
[
i
].
queue_Ãxt
 = dÿche[i].
queue_´ev
 = 
NULL
;

72 
dÿche
[
i
].
´ev
 = &dcache[i - 1];

73 
dÿche
[
i
].
Ãxt
 = 
NULL
;

74 
dÿche
[
i
].
queue_Ãxt
 = dÿche[i].
queue_´ev
 = 
NULL
;

75 
fœ¡_ä“
 = &
dÿche
[0];

76 
i
 = 0; i < 
HASH_QUEUES
; i++)

77 
queue_
[
i
] = 
queue_h—d
[i] = 
NULL
;

78 
ÿche_š™Ÿlized
 = 1;

79 
	}
}

84 
dœ_ÿche_’Œy
 * 
	$fšd_Çme
 (
queue
, 
dev
,

85 
dœ
,

86 cÚ¡ * 
Çme
, 
Ën
)

88 
dœ_ÿche_’Œy
 * 
p
;

90 
p
 = 
queue_h—d
[
queue
];… !ğ
NULL
 && (p->
dev
 != dev ||

91 
p
->
dœ
 !ğdœ ||…->
Ën
 !=†en ||

92 
	`¡ºcmp
 (
Çme
, 
p
->Çme,…->
Ën
) != 0);

93 
p
 =…->
queue_Ãxt
)

95  
p
;

96 
	}
}

98 #ifdeà
EXT2FS_DEBUG_CACHE


102 
	$show_ÿche
 (cÚ¡ * 
func_Çme
)

104 
dœ_ÿche_’Œy
 * 
p
;

106 
	`´štk
 ("%s: cach¡©us\n", 
func_Çme
);

107 
p
 = 
fœ¡
;… !ğ
NULL
;… =…->
Ãxt
)

108 
	`´štk
 ("dev:%04x, dir=%4lu,‚ame=%s\n",

109 
p
->
dev
,…->
dœ
,…->
Çme
);

110 
	}
}

116 
	$add_to_ÿche
 (
dœ_ÿche_’Œy
 * 
p
)

118 
p
->
´ev
 = 
NULL
;

119 
p
->
Ãxt
 = 
fœ¡
;

120 ià(
fœ¡
)

121 
fœ¡
->
´ev
 = 
p
;

122 ià(!
Ï¡
)

123 
Ï¡
 = 
p
;

124 
fœ¡
 = 
p
;

125 
	}
}

130 
	$add_to_queue
 (
queue
, 
dœ_ÿche_’Œy
 * 
p
)

132 
p
->
queue_´ev
 = 
NULL
;

133 
p
->
queue_Ãxt
 = 
queue_h—d
[
queue
];

134 ià(
queue_h—d
[
queue
])

135 
queue_h—d
[
queue
]->
queue_´ev
 = 
p
;

136 ià(!
queue_
[
queue
])

137 
queue_
[
queue
] = 
p
;

138 
queue_h—d
[
queue
] = 
p
;

139 
	}
}

144 
	$»move_äom_ÿche
 (
dœ_ÿche_’Œy
 * 
p
)

146 ià(
p
->
´ev
)

147 
p
->
´ev
->
Ãxt
 =…->next;

149 
fœ¡
 = 
p
->
Ãxt
;

150 ià(
p
->
Ãxt
)

151 
p
->
Ãxt
->
´ev
 =…->prev;

153 
Ï¡
 = 
p
->
´ev
;

154 
p
->
´ev
 = 
NULL
;

155 
p
->
Ãxt
 = 
NULL
;

156 
	}
}

161 
	$»move_äom_queue
 (
queue
, 
dœ_ÿche_’Œy
 * 
p
)

163 ià(
p
->
queue_´ev
)

164 
p
->
queue_´ev
->
queue_Ãxt
 =…->queue_next;

166 
queue_h—d
[
queue
] = 
p
->
queue_Ãxt
;

167 ià(
p
->
queue_Ãxt
)

168 
p
->
queue_Ãxt
->
queue_´ev
 =…->queue_prev;

170 
queue_
[
queue
] = 
p
->
queue_´ev
;

171 
p
->
queue_´ev
 = 
NULL
;

172 
p
->
queue_Ãxt
 = 
NULL
;

173 
	}
}

179 
	$ext2_dÿche_šv®id©e
 (
dev
)

181 
dœ_ÿche_’Œy
 * 
p
;

182 
dœ_ÿche_’Œy
 * 
p2
;

184 ià(!
ÿche_š™Ÿlized
)

185 
	`š™_ÿche
 ();

186 
p
 = 
fœ¡
;… !ğ
NULL
;… = 
p2
) {

187 
p2
 = 
p
->
Ãxt
;

188 ià(
p
->
dev
 == dev) {

189 
	`»move_äom_ÿche
 (
p
);

190 
	`»move_äom_queue
 (
	`hash
 (
p
->
dev
,…->
dœ
),…);

191 
p
->
Ãxt
 = 
fœ¡_ä“
;

192 
fœ¡_ä“
 = 
p
;

195 #ifdeà
EXT2FS_DEBUG_CACHE


196 
	`show_ÿche
 ("dcache_invalidate");

198 
	}
}

203 
	$ext2_dÿche_lookup
 (
dev
, 
dœ
,

204 cÚ¡ * 
Çme
, 
Ën
)

206 
our_Çme
[
EXT2_NAME_LEN
];

207 
queue
;

208 
dœ_ÿche_’Œy
 * 
p
;

210 ià(!
ÿche_š™Ÿlized
)

211 
	`š™_ÿche
 ();

212 ià(
Ën
 > 
DCACHE_NAME_LEN
)

214 
	`memıy
 (
our_Çme
, (*è
Çme
, 
Ën
);

215 
our_Çme
[
Ën
] = '\0';

216 #ifdeà
EXT2FS_DEBUG_CACHE


217 
	`´štk
 ("dÿche_looku°(%04x, %lu, %s, %d)\n", 
dev
, 
dœ
, 
our_Çme
, 
Ën
);

219 
queue
 = 
	`hash
 (
dev
, 
dœ
);

220 ià((
p
 = 
	`fšd_Çme
 (
queue
, 
dev
, 
dœ
, 
our_Çme
, 
Ën
))) {

221 ià(
p
 !ğ
fœ¡
) {

222 
	`»move_äom_ÿche
 (
p
);

223 
	`add_to_ÿche
 (
p
);

225 ià(
p
 !ğ
queue_h—d
[
queue
]) {

226 
	`»move_äom_queue
 (
queue
, 
p
);

227 
	`add_to_queue
 (
queue
, 
p
);

229 #ifdeà
EXT2FS_DEBUG_CACHE


230 
h™s
++;

231 
	`´štk
 ("dcache_lookup: %s,hit,inode=%lu,hits=%d,misses=%d\n",

232 
our_Çme
, 
p
->
šo
, 
h™s
, 
mis£s
);

233 
	`show_ÿche
 ("dcache_lookup");

235  
p
->
šo
;

237 #ifdeà
EXT2FS_DEBUG_CACHE


238 
mis£s
++;

239 
	`´štk
 ("dcache_lookup: %s,miss,hits=%d,misses=%d\n",

240 
our_Çme
, 
h™s
, 
mis£s
);

241 
	`show_ÿche
 ("dcache_lookup");

245 
	}
}

253 
	$ext2_dÿche_add
 (
dev
, 
dœ
, cÚ¡ * 
Çme
,

254 
Ën
, 
šo
)

256 
dœ_ÿche_’Œy
 * 
p
;

257 
queue
;

259 ià(!
ÿche_š™Ÿlized
)

260 
	`š™_ÿche
 ();

261 #ifdeà
EXT2FS_DEBUG_CACHE


262 
	`´štk
 ("dcache_add (%04x, %lu, %s, %d, %lu)\n",

263 
dev
, 
dœ
, 
Çme
, 
Ën
, 
šo
);

265 ià(
Ën
 > 
DCACHE_NAME_LEN
)

267 
queue
 = 
	`hash
 (
dev
, 
dœ
);

268 ià((
p
 = 
	`fšd_Çme
 (
queue
, 
dev
, 
dœ
, 
Çme
, 
Ën
))) {

269 
p
->
dœ
 = dir;

270 
p
->
šo
 = ino;

271 ià(
p
 !ğ
fœ¡
) {

272 
	`»move_äom_ÿche
 (
p
);

273 
	`add_to_ÿche
 (
p
);

275 ià(
p
 !ğ
queue_h—d
[
queue
]) {

276 
	`»move_äom_queue
 (
queue
, 
p
);

277 
	`add_to_queue
 (
queue
, 
p
);

280 ià(
fœ¡_ä“
) {

281 
p
 = 
fœ¡_ä“
;

282 
fœ¡_ä“
 = 
p
->
Ãxt
;

284 ià(!
Ï¡
)

285 
	`·nic
 ("dcache_add:†ast == NULL\n");

287 
p
 = 
Ï¡
;

288 
Ï¡
 = 
p
->
´ev
;

289 ià(
Ï¡
)

290 
Ï¡
->
Ãxt
 = 
NULL
;

291 
	`»move_äom_queue
 (
	`hash
 (
p
->
dev
,…->
dœ
),…);

294 
p
->
dev
 = dev;

295 
p
->
dœ
 = dir;

296 
p
->
šo
 = ino;

297 
	`¡ºıy
 (
p
->
Çme
,‚ame, 
Ën
);

298 
p
->
Ën
 =†en;

299 
p
->
Çme
[
Ën
] = '\0';

300 
	`add_to_ÿche
 (
p
);

301 
	`add_to_queue
 (
queue
, 
p
);

303 #ifdeà
EXT2FS_DEBUG_CACHE


304 
	`show_ÿche
 ("dcache_add");

306 
	}
}

313 
	$ext2_dÿche_»move
 (
dev
, 
dœ
,

314 cÚ¡ * 
Çme
, 
Ën
)

316 
dœ_ÿche_’Œy
 * 
p
;

317 
queue
;

319 ià(!
ÿche_š™Ÿlized
)

320 
	`š™_ÿche
 ();

321 #ifdeà
EXT2FS_DEBUG_CACHE


322 
	`´štk
 ("dÿche_»mov(%04x, %lu, %s, %d)\n", 
dev
, 
dœ
, 
Çme
, 
Ën
);

324 ià(
Ën
 > 
DCACHE_NAME_LEN
)

326 
queue
 = 
	`hash
 (
dev
, 
dœ
);

327 ià((
p
 = 
	`fšd_Çme
 (
queue
, 
dev
, 
dœ
, 
Çme
, 
Ën
))) {

328 
	`»move_äom_ÿche
 (
p
);

329 
	`»move_äom_queue
 (
queue
, 
p
);

330 
p
->
Ãxt
 = 
fœ¡_ä“
;

331 
fœ¡_ä“
 = 
p
;

333 #ifdeà
EXT2FS_DEBUG_CACHE


334 
	`show_ÿche
 ("dcache_remove");

336 
	}
}

	@fs/ext2/dir.c

17 
	~<asm/£gm’t.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/ext2_fs.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/¡©.h
>

25 
	$ext2_dœ_»ad
 (
šode
 * inode, 
fe
 * 
fp
,

26 * 
buf
, 
couÁ
)

28  -
EISDIR
;

29 
	}
}

31 
ext2_»addœ
 (
šode
 *, 
fe
 *, 
dœ’t
 *, );

33 
fe_İ”©iÚs
 
	gext2_dœ_İ”©iÚs
 = {

34 
NULL
,

35 
ext2_dœ_»ad
,

36 
NULL
,

37 
ext2_»addœ
,

38 
NULL
,

39 
ext2_ioùl
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
fe_fsync


49 
šode_İ”©iÚs
 
	gext2_dœ_šode_İ”©iÚs
 = {

50 &
ext2_dœ_İ”©iÚs
,

51 
ext2_ü—‹
,

52 
ext2_lookup
,

53 
ext2_lšk
,

54 
ext2_uÆšk
,

55 
ext2_symlšk
,

56 
ext2_mkdœ
,

57 
ext2_rmdœ
,

58 
ext2_mknod
,

59 
ext2_»Çme
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
ext2_Œunÿ‹
,

64 
ext2_³rmissiÚ


67 
	$ext2_check_dœ_’Œy
 (* 
funùiÚ
, 
šode
 * 
dœ
,

68 
ext2_dœ_’Œy
 * 
de
, 
bufãr_h—d
 * 
bh
,

69 
off£t
)

71 * 
”rÜ_msg
 = 
NULL
;

73 ià(
de
->
»c_Ën
 < 
	`EXT2_DIR_REC_LEN
(1))

74 
”rÜ_msg
 = "rec_len is smallerhan minimal";

75 ià(
de
->
»c_Ën
 % 4 != 0)

76 
”rÜ_msg
 = "rec_len % 4 != 0";

77 ià(
de
->
»c_Ën
 < 
	`EXT2_DIR_REC_LEN
(de->
Çme_Ën
))

78 
”rÜ_msg
 = "rec_len isoo small for‚ame_len";

79 ià(
dœ
 && ((*è
de
 - 
bh
->
b_d©a
è+ de->
»c_Ën
 >

80 
dœ
->
i_sb
->
s_blocksize
)

81 
”rÜ_msg
 = "directoryƒntry‡cross blocks";

83 ià(
”rÜ_msg
 !ğ
NULL
)

84 
	`ext2_”rÜ
 (
dœ
->
i_sb
, 
funùiÚ
, "bad directoryƒntry: %s\n"

86 
”rÜ_msg
, 
off£t
, 
de
->
šode
, de->
»c_Ën
,

87 
de
->
Çme_Ën
);

88  
”rÜ_msg
 =ğ
NULL
 ? 1 : 0;

89 
	}
}

91 
	$ext2_»addœ
 (
šode
 * inode, 
fe
 * 
fp
,

92 
dœ’t
 * dœ’t, 
couÁ
)

94 
off£t
, 
blk
;

95 
i
, 
num
;

96 
bufãr_h—d
 * 
bh
, * 
tmp
, * 
bha
[16];

97 
ext2_dœ_’Œy
 * 
de
;

98 
su³r_block
 * 
sb
;

99 
”r
;

101 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

102  -
EBADF
;

103 
sb
 = 
šode
->
i_sb
;

104 
fp
->
f_pos
 < 
šode
->
i_size
) {

105 
off£t
 = 
fp
->
f_pos
 & (
sb
->
s_blocksize
 - 1);

106 
blk
 = (
fp
->
f_pos
è>> 
	`EXT2_BLOCK_SIZE_BITS
(
sb
);

107 
bh
 = 
	`ext2_b»ad
 (
šode
, 
blk
, 0, &
”r
);

108 ià(!
bh
) {

109 
fp
->
f_pos
 +ğ
sb
->
s_blocksize
 - 
off£t
;

116 ià(!
off£t
) {

117 
i
 = 16 >> (
	`EXT2_BLOCK_SIZE_BITS
(
sb
è- 9), 
num
 = 0;

118 
i
 > 0; i--) {

119 
tmp
 = 
	`ext2_g‘blk
 (
šode
, ++
blk
, 0, &
”r
);

120 ià(
tmp
 && !tmp->
b_u±od©e
 && !tmp->
b_lock
)

121 
bha
[
num
++] = 
tmp
;

123 
	`b»l£
 (
tmp
);

125 ià(
num
) {

126 
	`Î_rw_block
 (
READA
, 
num
, 
bha
);

127 
i
 = 0; i < 
num
; i++)

128 
	`b»l£
 (
bha
[
i
]);

132 
de
 = (
ext2_dœ_’Œy
 *è(
off£t
 + 
bh
->
b_d©a
);

133 
off£t
 < 
sb
->
s_blocksize
 && 
fp
->
f_pos
 < 
šode
->
i_size
) {

134 ià(!
	`ext2_check_dœ_’Œy
 ("ext2_»addœ", 
šode
, 
de
,

135 
bh
, 
off£t
)) {

136 
	`b»l£
 (
bh
);

139 
off£t
 +ğ
de
->
»c_Ën
;

140 
fp
->
f_pos
 +ğ
de
->
»c_Ën
;

141 ià(
de
->
šode
) {

142 
	`memıy_tofs
 (
dœ’t
->
d_Çme
, 
de
->
Çme
,

143 
de
->
Çme_Ën
);

144 
	`put_fs_lÚg
 (
de
->
šode
, &
dœ’t
->
d_šo
);

145 
	`put_fs_by‹
 (0, 
de
->
Çme_Ën
 + 
dœ’t
->
d_Çme
);

146 
	`put_fs_wÜd
 (
de
->
Çme_Ën
, &
dœ’t
->
d_»ş’
);

147 #iâdeà
DONT_USE_DCACHE


148 
	`ext2_dÿche_add
 (
šode
->
i_dev
, inode->
i_šo
,

149 
de
->
Çme
, de->
Çme_Ën
,

150 
de
->
šode
);

152 
i
 = 
de
->
Çme_Ën
;

153 
	`b»l£
 (
bh
);

154 ià(!
	`IS_RDONLY
(
šode
)) {

155 
šode
->
i_©ime
 = 
CURRENT_TIME
;

156 
šode
->
i_dœt
 = 1;

158  
i
;

160 
de
 = (
ext2_dœ_’Œy
 *) ((*) de +

161 
de
->
»c_Ën
);

163 
	`b»l£
 (
bh
);

165 ià(!
	`IS_RDONLY
(
šode
)) {

166 
šode
->
i_©ime
 = 
CURRENT_TIME
;

167 
šode
->
i_dœt
 = 1;

170 
	}
}

	@fs/ext2/file.c

17 
	~<asm/£gm’t.h
>

18 
	~<asm/sy¡em.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/ext2_fs.h
>

23 
	~<lšux/fú.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/¡©.h
>

26 
	~<lšux/locks.h
>

28 
	#NBUF
 32

	)

30 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

31 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

33 
	~<lšux/fs.h
>

34 
	~<lšux/ext2_fs.h
>

36 
ext2_fe_»ad
 (
šode
 *, 
fe
 *, *, );

37 
ext2_fe_wr™e
 (
šode
 *, 
fe
 *, *, );

38 
ext2_»Ëa£_fe
 (
šode
 *, 
fe
 *);

44 
fe_İ”©iÚs
 
	gext2_fe_İ”©iÚs
 = {

45 
NULL
,

46 
ext2_fe_»ad
,

47 
ext2_fe_wr™e
,

48 
NULL
,

49 
NULL
,

50 
ext2_ioùl
,

51 
g’”ic_mm­
,

52 
NULL
,

53 
ext2_»Ëa£_fe
,

54 
ext2_sync_fe


57 
šode_İ”©iÚs
 
	gext2_fe_šode_İ”©iÚs
 = {

58 &
ext2_fe_İ”©iÚs
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
ext2_bm­
,

71 
ext2_Œunÿ‹
,

72 
ext2_³rmissiÚ


75 
	$ext2_fe_»ad
 (
šode
 * inode, 
fe
 * 
fp
,

76 * 
buf
, 
couÁ
)

78 
»ad
, 
Ëá
, 
ch¬s
;

79 
block
, 
blocks
, 
off£t
;

80 
bh»que¡
, 
u±od©e
;

81 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

82 
bufãr_h—d
 * 
bh»q
[
NBUF
];

83 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

84 
su³r_block
 * 
sb
;

85 
size
;

86 
”r
;

88 ià(!
šode
) {

89 
	`´štk
 ("ext2_file_read: inode = NULL\n");

90  -
EINVAL
;

92 
sb
 = 
šode
->
i_sb
;

93 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

94 
	`ext2_w¬nšg
 (
sb
, "ext2_file_read", "mode = %07o",

95 
šode
->
i_mode
);

96  -
EINVAL
;

98 
off£t
 = 
fp
->
f_pos
;

99 
size
 = 
šode
->
i_size
;

100 ià(
off£t
 > 
size
)

101 
Ëá
 = 0;

103 
Ëá
 = 
size
 - 
off£t
;

104 ià(
Ëá
 > 
couÁ
)

105 
Ëá
 = 
couÁ
;

106 ià(
Ëá
 <= 0)

108 
»ad
 = 0;

109 
block
 = 
off£t
 >> 
	`EXT2_BLOCK_SIZE_BITS
(
sb
);

110 
off£t
 &ğ(
sb
->
s_blocksize
 - 1);

111 
size
 = (siz+ 
sb
->
s_blocksize
 - 1è>> 
	`EXT2_BLOCK_SIZE_BITS
(sb);

112 
blocks
 = (
Ëá
 + 
off£t
 + 
sb
->
s_blocksize
 - 1è>> 
	`EXT2_BLOCK_SIZE_BITS
(sb);

113 
bhb
 = 
bhe
 = 
buæi¡
;

114 ià(
fp
->
f_»ada
) {

115 
blocks
 +ğ
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] >>

116 (
	`EXT2_BLOCK_SIZE_BITS
(
sb
) - 9);

117 ià(
block
 + 
blocks
 > 
size
)

118 
blocks
 = 
size
 - 
block
;

134 
bh»que¡
 = 0;

135 
u±od©e
 = 1;

136 
blocks
) {

137 --
blocks
;

138 *
bhb
 = 
	`ext2_g‘blk
 (
šode
, 
block
++, 0, &
”r
);

139 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

140 
u±od©e
 = 0;

141 
bh»q
[
bh»que¡
++] = *
bhb
;

144 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

145 
bhb
 = 
buæi¡
;

151 ià(
u±od©e
)

154 ià(
bhb
 =ğ
bhe
)

161 ià(
bh»que¡
)

162 
	`Î_rw_block
 (
READ
, 
bh»que¡
, 
bh»q
);

168 ià(*
bhe
) {

169 
	`wa™_Ú_bufãr
 (*
bhe
);

170 ià(!(*
bhe
)->
b_u±od©e
) {

171 
	`b»l£
(*
bhe
);

172 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

173 
bhe
 = 
buæi¡
;

174 
Ëá
 = 0;

178 ià(
Ëá
 < 
sb
->
s_blocksize
 - 
off£t
)

179 
ch¬s
 = 
Ëá
;

181 
ch¬s
 = 
sb
->
s_blocksize
 - 
off£t
;

182 
fp
->
f_pos
 +ğ
ch¬s
;

183 
Ëá
 -ğ
ch¬s
;

184 
»ad
 +ğ
ch¬s
;

185 ià(*
bhe
) {

186 
	`memıy_tofs
 (
buf
, 
off£t
 + (*
bhe
)->
b_d©a
,

187 
ch¬s
);

188 
	`b»l£
 (*
bhe
);

189 
buf
 +ğ
ch¬s
;

191 
ch¬s
-- > 0)

192 
	`put_fs_by‹
 (0, 
buf
++);

194 
off£t
 = 0;

195 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

196 
bhe
 = 
buæi¡
;

197 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!*bh|| !(*bhe)->
b_lock
));

198 } 
Ëá
 > 0);

203 
bhe
 !ğ
bhb
) {

204 
	`b»l£
 (*
bhe
);

205 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

206 
bhe
 = 
buæi¡
;

208 ià(!
»ad
)

209  -
EIO
;

210 
fp
->
f_»ada
 = 1;

211 ià(!
	`IS_RDONLY
(
šode
)) {

212 
šode
->
i_©ime
 = 
CURRENT_TIME
;

213 
šode
->
i_dœt
 = 1;

215  
»ad
;

216 
	}
}

218 
	$ext2_fe_wr™e
 (
šode
 * inode, 
fe
 * 
fp
,

219 * 
buf
, 
couÁ
)

221 
off_t
 
pos
;

222 
wr™‹n
, 
c
;

223 
bufãr_h—d
 * 
bh
;

224 * 
p
;

225 
su³r_block
 * 
sb
;

226 
”r
;

228 ià(!
šode
) {

229 
	`´štk
("ext2_file_write: inode = NULL\n");

230  -
EINVAL
;

232 
sb
 = 
šode
->
i_sb
;

233 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

237  -
ENOSPC
;

239 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

240 
	`ext2_w¬nšg
 (
sb
, "ext2_file_write", "mode = %07o\n",

241 
šode
->
i_mode
);

242  -
EINVAL
;

248 ià(
fp
->
f_æags
 & 
O_APPEND
)

249 
pos
 = 
šode
->
i_size
;

251 
pos
 = 
fp
->
f_pos
;

252 
wr™‹n
 = 0;

253 
wr™‹n
 < 
couÁ
) {

254 
bh
 = 
	`ext2_g‘blk
 (
šode
, 
pos
 / 
sb
->
s_blocksize
, 1, &
”r
);

255 ià(!
bh
) {

256 ià(!
wr™‹n
)

257 
wr™‹n
 = 
”r
;

260 
c
 = 
sb
->
s_blocksize
 - (
pos
 % sb->s_blocksize);

261 ià(
c
 > 
couÁ
-
wr™‹n
)

262 
c
 = 
couÁ
 - 
wr™‹n
;

263 ià(
c
 !ğ
sb
->
s_blocksize
 && !
bh
->
b_u±od©e
) {

264 
	`Î_rw_block
 (
READ
, 1, &
bh
);

265 
	`wa™_Ú_bufãr
 (
bh
);

266 ià(!
bh
->
b_u±od©e
) {

267 
	`b»l£
 (
bh
);

268 ià(!
wr™‹n
)

269 
wr™‹n
 = -
EIO
;

273 
p
 = (
pos
 % 
sb
->
s_blocksize
è+ 
bh
->
b_d©a
;

274 
pos
 +ğ
c
;

275 ià(
pos
 > 
šode
->
i_size
) {

276 
šode
->
i_size
 = 
pos
;

277 
šode
->
i_dœt
 = 1;

279 
wr™‹n
 +ğ
c
;

280 
	`memıy_äomfs
 (
p
, 
buf
, 
c
);

281 
buf
 +ğ
c
;

282 
bh
->
b_u±od©e
 = 1;

283 
bh
->
b_dœt
 = 1;

284 
	`b»l£
 (
bh
);

286 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME
;

287 
fp
->
f_pos
 = 
pos
;

288 
šode
->
i_dœt
 = 1;

289  
wr™‹n
;

290 
	}
}

297 
	$ext2_»Ëa£_fe
 (
šode
 * inode, 
fe
 * 
fp
)

299 ià(
fp
->
f_mode
 & 2)

300 
	`ext2_disÿrd_´—Îoc
 (
šode
);

301 
	}
}

	@fs/ext2/fsync.c

15 
	~<asm/£gm’t.h
>

16 
	~<asm/sy¡em.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/fs.h
>

20 
	~<lšux/ext2_fs.h
>

21 
	~<lšux/fú.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/¡©.h
>

24 
	~<lšux/locks.h
>

27 
	#blocksize
 (
	`EXT2_BLOCK_SIZE
(
šode
->
i_sb
))

	)

28 
	#addr_³r_block
 (
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
))

	)

30 
	$sync_block
 (
šode
 * inode, * 
block
, 
wa™
)

32 
bufãr_h—d
 * 
bh
;

33 
tmp
;

35 ià(!*
block
)

37 
tmp
 = *
block
;

38 
bh
 = 
	`g‘_hash_bË
 (
šode
->
i_dev
, *
block
, 
blocksize
);

39 ià(!
bh
)

41 ià(*
block
 !ğ
tmp
) {

42 
	`b»l£
 (
bh
);

45 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_u±od©e
) {

46 
	`b»l£
 (
bh
);

49 ià(
wa™
 || !
bh
->
b_u±od©e
 || !bh->
b_dœt
) {

50 
	`b»l£
 (
bh
);

53 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

54 
bh
->
b_couÁ
--;

56 
	}
}

58 
	$sync_iblock
 (
šode
 * inode, * 
iblock
,

59 
bufãr_h—d
 ** 
bh
, 
wa™
)

61 
rc
, 
tmp
;

63 *
bh
 = 
NULL
;

64 
tmp
 = *
iblock
;

65 ià(!
tmp
)

67 
rc
 = 
	`sync_block
 (
šode
, 
iblock
, 
wa™
);

68 ià(
rc
)

69  
rc
;

70 *
bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
tmp
, 
blocksize
);

71 ià(
tmp
 !ğ*
iblock
) {

72 
	`b»l£
 (*
bh
);

73 *
bh
 = 
NULL
;

76 ià(!*
bh
)

79 
	}
}

82 
	$sync_dœeù
 (
šode
 * inode, 
wa™
)

84 
i
;

85 
rc
, 
”r
 = 0;

87 
i
 = 0; i < 
EXT2_NDIR_BLOCKS
; i++) {

88 
rc
 = 
	`sync_block
 (
šode
, inode->
u
.
ext2_i
.
i_d©a
 + 
i
, 
wa™
);

89 ià(
rc
 > 0)

91 ià(
rc
)

92 
”r
 = 
rc
;

94  
”r
;

95 
	}
}

97 
	$sync_šdœeù
 (
šode
 * inode, * 
iblock
,

98 
wa™
)

100 
i
;

101 
bufãr_h—d
 * 
šd_bh
;

102 
rc
, 
”r
 = 0;

104 
rc
 = 
	`sync_iblock
 (
šode
, 
iblock
, &
šd_bh
, 
wa™
);

105 ià(
rc
 || !
šd_bh
)

106  
rc
;

108 
i
 = 0; i < 
addr_³r_block
; i++) {

109 
rc
 = 
	`sync_block
 (
šode
,

110 ((*è
šd_bh
->
b_d©a
è+ 
i
,

111 
wa™
);

112 ià(
rc
 > 0)

114 ià(
rc
)

115 
”r
 = 
rc
;

117 
	`b»l£
 (
šd_bh
);

118  
”r
;

119 
	}
}

121 
	$sync_dšdœeù
 (
šode
 * inode, * 
diblock
,

122 
wa™
)

124 
i
;

125 
bufãr_h—d
 * 
dšd_bh
;

126 
rc
, 
”r
 = 0;

128 
rc
 = 
	`sync_iblock
 (
šode
, 
diblock
, &
dšd_bh
, 
wa™
);

129 ià(
rc
 || !
dšd_bh
)

130  
rc
;

132 
i
 = 0; i < 
addr_³r_block
; i++) {

133 
rc
 = 
	`sync_šdœeù
 (
šode
,

134 ((*è
dšd_bh
->
b_d©a
è+ 
i
,

135 
wa™
);

136 ià(
rc
 > 0)

138 ià(
rc
)

139 
”r
 = 
rc
;

141 
	`b»l£
 (
dšd_bh
);

142  
”r
;

143 
	}
}

145 
	$sync_tšdœeù
 (
šode
 * inode, * 
tiblock
,

146 
wa™
)

148 
i
;

149 
bufãr_h—d
 * 
tšd_bh
;

150 
rc
, 
”r
 = 0;

152 
rc
 = 
	`sync_iblock
 (
šode
, 
tiblock
, &
tšd_bh
, 
wa™
);

153 ià(
rc
 || !
tšd_bh
)

154  
rc
;

156 
i
 = 0; i < 
addr_³r_block
; i++) {

157 
rc
 = 
	`sync_dšdœeù
 (
šode
,

158 ((*è
tšd_bh
->
b_d©a
è+ 
i
,

159 
wa™
);

160 ià(
rc
 > 0)

162 ià(
rc
)

163 
”r
 = 
rc
;

165 
	`b»l£
 (
tšd_bh
);

166  
”r
;

167 
	}
}

169 
	$ext2_sync_fe
 (
šode
 * inode, 
fe
 * file)

171 
wa™
, 
”r
 = 0;

173 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

174 
	`S_ISLNK
(
šode
->
i_mode
)))

175  -
EINVAL
;

176 ià(
	`S_ISLNK
(
šode
->
i_mode
è&& !(šode->
i_blocks
))

180 
sk
;

182 
wa™
=0; wait<=1; wait++)

184 
”r
 |ğ
	`sync_dœeù
 (
šode
, 
wa™
);

185 
”r
 |ğ
	`sync_šdœeù
 (
šode
,

186 
šode
->
u
.
ext2_i
.
i_d©a
+
EXT2_IND_BLOCK
,

187 
wa™
);

188 
”r
 |ğ
	`sync_dšdœeù
 (
šode
,

189 
šode
->
u
.
ext2_i
.
i_d©a
+
EXT2_DIND_BLOCK
,

190 
wa™
);

191 
”r
 |ğ
	`sync_tšdœeù
 (
šode
,

192 
šode
->
u
.
ext2_i
.
i_d©a
+
EXT2_TIND_BLOCK
,

193 
wa™
);

195 
sk
:

196 
”r
 |ğ
	`ext2_sync_šode
 (
šode
);

197  (
”r
 < 0è? -
EIO
 : 0;

198 
	}
}

	@fs/ext2/ialloc.c

27 
	~<lšux/fs.h
>

28 
	~<lšux/ext2_fs.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/¡©.h
>

31 
	~<lšux/¡ršg.h
>

32 
	~<lšux/locks.h
>

34 
	~<asm/b™İs.h
>

36 
šlše
 
	$fšd_fœ¡_z”o_b™
 (* 
addr
, 
size
)

38 
»s
;

40 ià(!
size
)

42 
	`__asm__
("

43 
şd


44 
movl
 
$
-1,%%
—x


45 
»³
; 
sÿ¦


46 
je
 1f

47 
subl
 
$4
,%%
edi


48 
	`movl
 (%%
edi
),%%
—x


49 
nÙl
 %%
—x


50 
bsæ
 %%
—x
,%%
edx


51 
jmp
 2f

52 1: 
xÜl
 %%
edx
,%%edx

53 2: 
subl
 %%
ebx
,%%
edi


54 
shÎ
 
$3
,%%
edi


55 
addl
 %%
edi
,%%
edx
"

56 : "=d" (
»s
)

57 : "c" ((
size
 + 31è>> 5), "D" (
addr
), "b" (addr)

59  
»s
;

60 
	}
}

62 
ext2_group_desc
 * 
	$g‘_group_desc
 (
su³r_block
 * 
sb
,

63 
block_group
,

64 
bufãr_h—d
 ** 
bh
)

66 
group_desc
;

67 
desc
;

68 
ext2_group_desc
 * 
gdp
;

70 ià(
block_group
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

71 
	`ext2_·nic
 (
sb
, "get_group_desc",

74 
block_group
, 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
);

76 
group_desc
 = 
block_group
 / 
	`EXT2_DESC_PER_BLOCK
(
sb
);

77 
desc
 = 
block_group
 % 
	`EXT2_DESC_PER_BLOCK
(
sb
);

78 ià(!
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
])

79 
	`ext2_·nic
 (
sb
, "get_group_desc",

82 
block_group
, 
group_desc
, 
desc
);

83 
gdp
 = (
ext2_group_desc
 *)

84 
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
]->
b_d©a
;

85 ià(
bh
)

86 *
bh
 = 
sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
];

87  
gdp
 + 
desc
;

88 
	}
}

90 
	$»ad_šode_b™m­
 (
su³r_block
 * 
sb
,

91 
block_group
,

92 
b™m­_Ä
)

94 
ext2_group_desc
 * 
gdp
;

95 
bufãr_h—d
 * 
bh
;

97 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
block_group
, 
NULL
);

98 
bh
 = 
	`b»ad
 (
sb
->
s_dev
, 
gdp
->
bg_šode_b™m­
, sb->
s_blocksize
);

99 ià(!
bh
)

100 
	`ext2_·nic
 (
sb
, "read_inode_bitmap", "Cannot„ead inode bitmap\n"

102 
block_group
, 
gdp
->
bg_šode_b™m­
);

103 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
b™m­_Ä
] = 
block_group
;

104 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
b™m­_Ä
] = 
bh
;

105 
	}
}

118 
	$lßd_šode_b™m­
 (
su³r_block
 * 
sb
,

119 
block_group
)

121 
i
, 
j
;

122 
šode_b™m­_numb”
;

123 
bufãr_h—d
 * 
šode_b™m­
;

125 ià(
block_group
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

126 
	`ext2_·nic
 (
sb
, "load_inode_bitmap",

129 
block_group
, 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
);

130 ià(
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 > 0 &&

131 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[0] =ğ
block_group
)

133 ià(
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 <ğ
EXT2_MAX_GROUP_LOADED
) {

134 ià(
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
block_group
]) {

135 ià(
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
block_group
] != block_group)

136 
	`ext2_·nic
 (
sb
, "load_inode_bitmap",

139  
block_group
;

141 
	`»ad_šode_b™m­
 (
sb
, 
block_group
, block_group);

142  
block_group
;

146 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 &&

147 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
i
] !ğ
block_group
;

148 
i
++)

150 ià(
i
 < 
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 &&

151 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
i
] =ğ
block_group
) {

152 
šode_b™m­_numb”
 = 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
i
];

153 
šode_b™m­
 = 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
i
];

154 
j
 = 
i
; j > 0; j--) {

155 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
j
] =

156 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
j
 - 1];

157 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
j
] =

158 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
j
 - 1];

160 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[0] = 
šode_b™m­_numb”
;

161 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[0] = 
šode_b™m­
;

163 ià(
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 < 
EXT2_MAX_GROUP_LOADED
)

164 
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
++;

166 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
EXT2_MAX_GROUP_LOADED
 - 1]);

167 
j
 = 
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 - 1; j > 0; j--) {

168 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
j
] =

169 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
j
 - 1];

170 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
j
] =

171 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
j
 - 1];

173 
	`»ad_šode_b™m­
 (
sb
, 
block_group
, 0);

176 
	}
}

183 
	$£t_šode_dtime
 (
šode
 * inode,

184 
ext2_group_desc
 * 
gdp
)

186 
šode_block
;

187 
bufãr_h—d
 * 
bh
;

188 
ext2_šode
 * 
¿w_šode
;

190 
šode_block
 = 
gdp
->
bg_šode_bË
 + (((
šode
->
i_šo
 - 1) %

191 
	`EXT2_INODES_PER_GROUP
(
šode
->
i_sb
)) /

192 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

193 
bh
 = 
	`b»ad
 (
šode
->
i_sb
->
s_dev
, 
šode_block
, inode->i_sb->
s_blocksize
);

194 ià(!
bh
)

195 
	`ext2_·nic
 (
šode
->
i_sb
, "set_inode_dtime",

198 
šode
->
i_šo
, 
šode_block
);

199 
¿w_šode
 = ((
ext2_šode
 *è
bh
->
b_d©a
) +

200 (((
šode
->
i_šo
 - 1) %

201 
	`EXT2_INODES_PER_GROUP
(
šode
->
i_sb
)) %

202 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

203 
¿w_šode
->
i_lšks_couÁ
 = 0;

204 
¿w_šode
->
i_dtime
 = 
CURRENT_TIME
;

205 
bh
->
b_dœt
 = 1;

206 ià(
	`IS_SYNC
(
šode
)) {

207 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

208 
	`wa™_Ú_bufãr
 (
bh
);

210 
	`b»l£
 (
bh
);

211 
	}
}

213 
	$ext2_ä“_šode
 (
šode
 * inode)

215 
su³r_block
 * 
sb
;

216 
bufãr_h—d
 * 
bh
;

217 
bufãr_h—d
 * 
bh2
;

218 
block_group
;

219 
b™
;

220 
b™m­_Ä
;

221 
ext2_group_desc
 * 
gdp
;

222 
ext2_su³r_block
 * 
es
;

224 ià(!
šode
)

226 ià(!
šode
->
i_dev
) {

227 
	`´štk
 ("ext2_free_inode: inode has‚o device\n");

230 ià(
šode
->
i_couÁ
 > 1) {

231 
	`´štk
 ("ext2_free_inode: inode has count=%d\n",

232 
šode
->
i_couÁ
);

235 ià(
šode
->
i_Æšk
) {

236 
	`´štk
 ("ext2_free_inode: inode has‚link=%d\n",

237 
šode
->
i_Æšk
);

240 ià(!
šode
->
i_sb
) {

241 
	`´štk
("ext2_free_inode: inode on‚onexistent device\n");

245 
	`ext2_debug
 ("ä“šg inod%lu\n", 
šode
->
i_šo
);

247 
sb
 = 
šode
->
i_sb
;

248 
	`lock_su³r
 (
sb
);

249 ià(
šode
->
i_šo
 < 
EXT2_FIRST_INO
 ||

250 
šode
->
i_šo
 > 
sb
->
u
.
ext2_sb
.
s_es
->
s_šodes_couÁ
) {

251 
	`ext2_”rÜ
 (
sb
, "free_inode",

253 
	`uÆock_su³r
 (
sb
);

256 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

257 
block_group
 = (
šode
->
i_šo
 - 1è/ 
	`EXT2_INODES_PER_GROUP
(
sb
);

258 
b™
 = (
šode
->
i_šo
 - 1è% 
	`EXT2_INODES_PER_GROUP
(
sb
);

259 
b™m­_Ä
 = 
	`lßd_šode_b™m­
 (
sb
, 
block_group
);

260 
bh
 = 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
b™m­_Ä
];

261 ià(!
	`ş—r_b™
 (
b™
, 
bh
->
b_d©a
))

262 
	`ext2_w¬nšg
 (
sb
, "ext2_free_inode",

263 "b™‡Ì—dy cË¬ed fÜ inod%lu", 
šode
->
i_šo
);

265 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
block_group
, &
bh2
);

266 
gdp
->
bg_ä“_šodes_couÁ
++;

267 ià(
	`S_ISDIR
(
šode
->
i_mode
))

268 
gdp
->
bg_u£d_dœs_couÁ
--;

269 
bh2
->
b_dœt
 = 1;

270 
es
->
s_ä“_šodes_couÁ
++;

271 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

272 
	`£t_šode_dtime
 (
šode
, 
gdp
);

274 
bh
->
b_dœt
 = 1;

275 ià(
sb
->
s_æags
 & 
MS_SYNC
) {

276 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

277 
	`wa™_Ú_bufãr
 (
bh
);

280 
sb
->
s_dœt
 = 1;

281 
	`ş—r_šode
 (
šode
);

282 
	`uÆock_su³r
 (
sb
);

283 
	}
}

290 
	$šc_šode_v”siÚ
 (
šode
 * inode,

291 
ext2_group_desc
 *
gdp
,

292 
mode
)

294 
šode_block
;

295 
bufãr_h—d
 * 
bh
;

296 
ext2_šode
 * 
¿w_šode
;

298 
šode_block
 = 
gdp
->
bg_šode_bË
 + (((
šode
->
i_šo
 - 1) %

299 
	`EXT2_INODES_PER_GROUP
(
šode
->
i_sb
)) /

300 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

301 
bh
 = 
	`b»ad
 (
šode
->
i_sb
->
s_dev
, 
šode_block
, inode->i_sb->
s_blocksize
);

302 ià(!
bh
) {

303 
	`ext2_”rÜ
 (
šode
->
i_sb
, "inc_inode_version",

306 
šode
->
i_šo
, 
šode_block
);

307 
šode
->
u
.
ext2_i
.
i_v”siÚ
 = 1;

310 
¿w_šode
 = ((
ext2_šode
 *è
bh
->
b_d©a
) +

311 (((
šode
->
i_šo
 - 1) %

312 
	`EXT2_INODES_PER_GROUP
(
šode
->
i_sb
)) %

313 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

314 
¿w_šode
->
i_v”siÚ
++;

315 
šode
->
u
.
ext2_i
.
i_v”siÚ
 = 
¿w_šode
->i_version;

316 
bh
->
b_dœt
 = 1;

317 
	`b»l£
 (
bh
);

318 
	}
}

330 
šode
 * 
	$ext2_Ãw_šode
 (cÚ¡ 
šode
 * 
dœ
, 
mode
)

332 
su³r_block
 * 
sb
;

333 
bufãr_h—d
 * 
bh
;

334 
bufãr_h—d
 * 
bh2
;

335 
i
, 
j
, 
aveä“i
;

336 
šode
 * inode;

337 
b™m­_Ä
;

338 
ext2_group_desc
 * 
gdp
;

339 
ext2_group_desc
 * 
tmp
;

340 
ext2_su³r_block
 * 
es
;

342 ià(!
dœ
 || !(
šode
 = 
	`g‘_em±y_šode
 ()))

343  
NULL
;

344 
sb
 = 
dœ
->
i_sb
;

345 
šode
->
i_sb
 = 
sb
;

346 
šode
->
i_æags
 = 
sb
->
s_æags
;

347 
	`lock_su³r
 (
sb
);

348 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

349 
»³©
:

350 
gdp
 = 
NULL
; 
i
=0;

352 ià(
	`S_ISDIR
(
mode
)) {

353 
aveä“i
 = 
es
->
s_ä“_šodes_couÁ
 /

354 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
;

368 ià(!
gdp
) {

369 
j
 = 0; j < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; j++) {

370 
tmp
 = 
	`g‘_group_desc
 (
sb
, 
j
, &
bh2
);

371 ià(
tmp
->
bg_ä“_šodes_couÁ
 &&

372 
tmp
->
bg_ä“_šodes_couÁ
 >ğ
aveä“i
) {

373 ià(!
gdp
 ||

374 (
tmp
->
bg_ä“_blocks_couÁ
 >

375 
gdp
->
bg_ä“_blocks_couÁ
)) {

376 
i
 = 
j
;

377 
gdp
 = 
tmp
;

388 
i
 = 
dœ
->
u
.
ext2_i
.
i_block_group
;

389 
tmp
 = 
	`g‘_group_desc
 (
sb
, 
i
, &
bh2
);

390 ià(
tmp
->
bg_ä“_šodes_couÁ
)

391 
gdp
 = 
tmp
;

398 
j
 = 1; j < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; j <<= 1) {

399 
i
 +ğ
j
;

400 ià(
i
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

401 
i
 -ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
;

402 
tmp
 = 
	`g‘_group_desc
 (
sb
, 
i
, &
bh2
);

403 ià(
tmp
->
bg_ä“_šodes_couÁ
) {

404 
gdp
 = 
tmp
;

409 ià(!
gdp
) {

413 
i
 = 
dœ
->
u
.
ext2_i
.
i_block_group
 + 1;

414 
j
 = 2; j < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; j++) {

415 ià(++
i
 >ğ
sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

416 
i
 = 0;

417 
tmp
 = 
	`g‘_group_desc
 (
sb
, 
i
, &
bh2
);

418 ià(
tmp
->
bg_ä“_šodes_couÁ
) {

419 
gdp
 = 
tmp
;

426 ià(!
gdp
) {

427 
	`uÆock_su³r
 (
sb
);

428 
	`ut
(
šode
);

429  
NULL
;

431 
b™m­_Ä
 = 
	`lßd_šode_b™m­
 (
sb
, 
i
);

432 
bh
 = 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
b™m­_Ä
];

433 ià((
j
 = 
	`fšd_fœ¡_z”o_b™
 ((*è
bh
->
b_d©a
,

434 
	`EXT2_INODES_PER_GROUP
(
sb
))) <

435 
	`EXT2_INODES_PER_GROUP
(
sb
)) {

436 ià(
	`£t_b™
 (
j
, 
bh
->
b_d©a
)) {

437 
	`ext2_w¬nšg
 (
sb
, "ext2_new_inode",

438 "b™‡Ì—dy s‘ fÜ inod%d", 
j
);

439 
»³©
;

441 
bh
->
b_dœt
 = 1;

442 ià(
sb
->
s_æags
 & 
MS_SYNC
) {

443 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

444 
	`wa™_Ú_bufãr
 (
bh
);

447 ià(
gdp
->
bg_ä“_šodes_couÁ
 != 0) {

448 
	`ext2_”rÜ
 (
sb
, "ext2_new_inode",

450 
i
);

451 
	`uÆock_su³r
 (
sb
);

452 
	`ut
 (
šode
);

453  
NULL
;

455 
»³©
;

457 
j
 +ğ
i
 * 
	`EXT2_INODES_PER_GROUP
(
sb
) + 1;

458 ià(
j
 < 
EXT2_FIRST_INO
 || j > 
es
->
s_šodes_couÁ
) {

459 
	`ext2_”rÜ
 (
sb
, "ext2_new_inode",

461 "block_grou°ğ%d,šode=%d", 
i
, 
j
);

462 
	`uÆock_su³r
 (
sb
);

463 
	`ut
 (
šode
);

464  
NULL
;

466 
gdp
->
bg_ä“_šodes_couÁ
--;

467 ià(
	`S_ISDIR
(
mode
))

468 
gdp
->
bg_u£d_dœs_couÁ
++;

469 
bh2
->
b_dœt
 = 1;

470 
es
->
s_ä“_šodes_couÁ
--;

471 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

472 
sb
->
s_dœt
 = 1;

473 
šode
->
i_mode
 = 
mode
;

474 
šode
->
i_sb
 = 
sb
;

475 
šode
->
i_couÁ
 = 1;

476 
šode
->
i_Æšk
 = 1;

477 
šode
->
i_dev
 = 
sb
->
s_dev
;

478 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

479 ià(
	`‹¡_İt
 (
sb
, 
GRPID
))

480 
šode
->
i_gid
 = 
dœ
->i_gid;

481 ià(
dœ
->
i_mode
 & 
S_ISGID
) {

482 
šode
->
i_gid
 = 
dœ
->i_gid;

483 ià(
	`S_ISDIR
(
mode
))

484 
mode
 |ğ
S_ISGID
;

486 
šode
->
i_gid
 = 
cu¼’t
->
egid
;

487 
šode
->
i_dœt
 = 1;

488 
šode
->
i_šo
 = 
j
;

489 
šode
->
i_blksize
 = 
sb
->
s_blocksize
;

490 
šode
->
i_blocks
 = 0;

491 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

492 
šode
->
u
.
ext2_i
.
i_æags
 = 
dœ
->u.ext2_i.i_flags;

493 
šode
->
u
.
ext2_i
.
i_çddr
 = 0;

494 
šode
->
u
.
ext2_i
.
i_äag
 = 0;

495 
šode
->
u
.
ext2_i
.
i_fsize
 = 0;

496 
šode
->
u
.
ext2_i
.
i_fe_aş
 = 0;

497 
šode
->
u
.
ext2_i
.
i_dœ_aş
 = 0;

498 
šode
->
u
.
ext2_i
.
i_dtime
 = 0;

499 
šode
->
u
.
ext2_i
.
i_block_group
 = 
i
;

500 
šode
->
i_İ
 = 
NULL
;

501 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SYNC_FL
)

502 
šode
->
i_æags
 |ğ
MS_SYNC
;

503 
	`š£¹_šode_hash
(
šode
);

504 
	`šc_šode_v”siÚ
 (
šode
, 
gdp
, 
mode
);

506 
	`ext2_debug
 ("®loÿtšg inod%lu\n", 
šode
->
i_šo
);

508 
	`uÆock_su³r
 (
sb
);

509  
šode
;

510 
	}
}

512 
	$ext2_couÁ_ä“_šodes
 (
su³r_block
 * 
sb
)

514 #ifdeà
EXT2FS_DEBUG


515 
ext2_su³r_block
 * 
es
;

516 
desc_couÁ
, 
b™m­_couÁ
, 
x
;

517 
b™m­_Ä
;

518 
ext2_group_desc
 * 
gdp
;

519 
i
;

521 
	`lock_su³r
 (
sb
);

522 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

523 
desc_couÁ
 = 0;

524 
b™m­_couÁ
 = 0;

525 
gdp
 = 
NULL
;

526 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; i++) {

527 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, 
NULL
);

528 
desc_couÁ
 +ğ
gdp
->
bg_ä“_šodes_couÁ
;

529 
b™m­_Ä
 = 
	`lßd_šode_b™m­
 (
sb
, 
i
);

530 
x
 = 
	`ext2_couÁ_ä“
 (
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
b™m­_Ä
],

531 
	`EXT2_INODES_PER_GROUP
(
sb
) / 8);

532 
	`´štk
 ("group %d: stored = %d, counted = %lu\n",

533 
i
, 
gdp
->
bg_ä“_šodes_couÁ
, 
x
);

534 
b™m­_couÁ
 +ğ
x
;

536 
	`´štk
("ext2_count_free_inodes: stored = %lu, computed = %lu, %lu\n",

537 
es
->
s_ä“_šodes_couÁ
, 
desc_couÁ
, 
b™m­_couÁ
);

538 
	`uÆock_su³r
 (
sb
);

539  
desc_couÁ
;

541  
sb
->
u
.
ext2_sb
.
s_es
->
s_ä“_šodes_couÁ
;

543 
	}
}

545 
	$ext2_check_šodes_b™m­
 (
su³r_block
 * 
sb
)

547 
ext2_su³r_block
 * 
es
;

548 
desc_couÁ
, 
b™m­_couÁ
, 
x
;

549 
b™m­_Ä
;

550 
ext2_group_desc
 * 
gdp
;

551 
i
;

553 
	`lock_su³r
 (
sb
);

554 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

555 
desc_couÁ
 = 0;

556 
b™m­_couÁ
 = 0;

557 
gdp
 = 
NULL
;

558 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; i++) {

559 
gdp
 = 
	`g‘_group_desc
 (
sb
, 
i
, 
NULL
);

560 
desc_couÁ
 +ğ
gdp
->
bg_ä“_šodes_couÁ
;

561 
b™m­_Ä
 = 
	`lßd_šode_b™m­
 (
sb
, 
i
);

562 
x
 = 
	`ext2_couÁ_ä“
 (
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
b™m­_Ä
],

563 
	`EXT2_INODES_PER_GROUP
(
sb
) / 8);

564 ià(
gdp
->
bg_ä“_šodes_couÁ
 !ğ
x
)

565 
	`ext2_”rÜ
 (
sb
, "ext2_check_inodes_bitmap",

567 "¡Üed = %d, couÁed = %lu", 
i
,

568 
gdp
->
bg_ä“_šodes_couÁ
, 
x
);

569 
b™m­_couÁ
 +ğ
x
;

571 ià(
es
->
s_ä“_šodes_couÁ
 !ğ
b™m­_couÁ
)

572 
	`ext2_”rÜ
 (
sb
, "ext2_check_inodes_bitmap",

575 
es
->
s_ä“_šodes_couÁ
, 
b™m­_couÁ
);

576 
	`uÆock_su³r
 (
sb
);

577 
	}
}

	@fs/ext2/inode.c

17 
	~<asm/£gm’t.h
>

18 
	~<asm/sy¡em.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/ext2_fs.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/¡©.h
>

25 
	~<lšux/¡ršg.h
>

26 
	~<lšux/locks.h
>

28 
	#ş—r_block
(
addr
,
size
) \

29 
	`__asm__
("cld\n\t" \

33 :"a" (0), "c" (
size
 / 4), "D" ((è(
addr
)) \

34 :"cx", "di")

	)

36 
	$ext2_put_šode
 (
šode
 * inode)

38 
	`ext2_disÿrd_´—Îoc
 (
šode
);

39 ià(
šode
->
i_Æšk
 || inode->
i_šo
 =ğ
EXT2_ACL_IDX_INO
 ||

40 
šode
->
i_šo
 =ğ
EXT2_ACL_DATA_INO
)

42 
šode
->
i_size
 = 0;

43 ià(
šode
->
i_blocks
)

44 
	`ext2_Œunÿ‹
 (
šode
);

45 
	`ext2_ä“_šode
 (
šode
);

46 
	}
}

48 
	#šode_bm­
(
šode
, 
Ä
è((šode)->
u
.
ext2_i
.
i_d©a
[Òr)])

	)

50 
	$block_bm­
 (
bufãr_h—d
 * 
bh
, 
Ä
)

52 
tmp
;

54 ià(!
bh
)

56 
tmp
 = ((*è
bh
->
b_d©a
)[
Ä
];

57 
	`b»l£
 (
bh
);

58  
tmp
;

59 
	}
}

68 
	$ext2_disÿrd_´—Îoc
 (
šode
 * inode)

70 #ifdeà
EXT2_PREALLOCATE


71 ià(
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
) {

72 
i
 = 
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
;

73 
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
 = 0;

74 
	`ext2_ä“_blocks
 (
šode
->
i_sb
,

75 
šode
->
u
.
ext2_i
.
i_´—Îoc_block
,

76 
i
);

79 
	}
}

81 
	$ext2_®loc_block
 (
šode
 * inode, 
gßl
)

83 #ifdeà
EXT2FS_DEBUG


84 
®loc_h™s
 = 0, 
®loc_©‹m±s
 = 0;

86 
»suÉ
;

87 
bufãr_h—d
 * 
bh
;

89 
	`wa™_Ú_su³r
 (
šode
->
i_sb
);

91 #ifdeà
EXT2_PREALLOCATE


92 ià(
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
 &&

93 (
gßl
 =ğ
šode
->
u
.
ext2_i
.
i_´—Îoc_block
 ||

94 
gßl
 + 1 =ğ
šode
->
u
.
ext2_i
.
i_´—Îoc_block
))

96 
»suÉ
 = 
šode
->
u
.
ext2_i
.
i_´—Îoc_block
++;

97 
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
--;

98 
	`ext2_debug
 ("preallocation hit (%lu/%lu).\n",

99 ++
®loc_h™s
, ++
®loc_©‹m±s
);

104 ià(!(
bh
 = 
	`g‘blk
 (
šode
->
i_sb
->
s_dev
, 
»suÉ
,

105 
šode
->
i_sb
->
s_blocksize
))) {

106 
	`ext2_”rÜ
 (
šode
->
i_sb
, "ext2_alloc_block",

107 "ÿÂÙ g‘ block %lu", 
»suÉ
);

110 
	`ş—r_block
 (
bh
->
b_d©a
, 
šode
->
i_sb
->
s_blocksize
);

111 
bh
->
b_u±od©e
 = 1;

112 
bh
->
b_dœt
 = 1;

113 
	`b»l£
 (
bh
);

115 
	`ext2_disÿrd_´—Îoc
 (
šode
);

116 
	`ext2_debug
 ("preallocation miss (%lu/%lu).\n",

117 
®loc_h™s
, ++
®loc_©‹m±s
);

118 ià(
	`S_ISREG
(
šode
->
i_mode
))

119 
»suÉ
 = 
ext2_Ãw_block


120 (
šode
->
i_sb
, 
gßl
,

121 &
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
,

122 &
šode
->
u
.
ext2_i
.
i_´—Îoc_block
);

124 
»suÉ
 = 
	`ext2_Ãw_block
 (
šode
->
i_sb
, 
gßl
, 0, 0);

127 
»suÉ
 = 
	`ext2_Ãw_block
 (
šode
->
i_sb
, 
gßl
, 0, 0);

130  
»suÉ
;

131 
	}
}

134 
	$ext2_bm­
 (
šode
 * inode, 
block
)

136 
i
;

137 
addr_³r_block
 = 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
);

139 ià(
block
 < 0) {

140 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_bmap", "block < 0");

143 ià(
block
 >ğ
EXT2_NDIR_BLOCKS
 + 
addr_³r_block
 +

144 
addr_³r_block
 *‡ddr_per_block +

145 
addr_³r_block
 *‡ddr_per_block *‡ddr_per_block) {

146 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_bmap", "block > big");

149 ià(
block
 < 
EXT2_NDIR_BLOCKS
)

150  
	`šode_bm­
 (
šode
, 
block
);

151 
block
 -ğ
EXT2_NDIR_BLOCKS
;

152 ià(
block
 < 
addr_³r_block
) {

153 
i
 = 
	`šode_bm­
 (
šode
, 
EXT2_IND_BLOCK
);

154 ià(!
i
)

156  
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, 
i
,

157 
šode
->
i_sb
->
s_blocksize
), 
block
);

159 
block
 -ğ
addr_³r_block
;

160 ià(
block
 < 
addr_³r_block
 *‡ddr_per_block) {

161 
i
 = 
	`šode_bm­
 (
šode
, 
EXT2_DIND_BLOCK
);

162 ià(!
i
)

164 
i
 = 
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, i,

165 
šode
->
i_sb
->
s_blocksize
),

166 
block
 / 
addr_³r_block
);

167 ià(!
i
)

169  
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, 
i
,

170 
šode
->
i_sb
->
s_blocksize
),

171 
block
 & (
addr_³r_block
 - 1));

173 
block
 -ğ
addr_³r_block
 *‡ddr_per_block;

174 
i
 = 
	`šode_bm­
 (
šode
, 
EXT2_TIND_BLOCK
);

175 ià(!
i
)

177 
i
 = 
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, i, inode->
i_sb
->
s_blocksize
),

178 
block
 / (
addr_³r_block
 *‡ddr_per_block));

179 ià(!
i
)

181 
i
 = 
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, i, inode->
i_sb
->
s_blocksize
),

182 (
block
 / 
addr_³r_block
) & (addr_per_block - 1));

183 ià(!
i
)

185  
	`block_bm­
 (
	`b»ad
 (
šode
->
i_dev
, 
i
, inode->
i_sb
->
s_blocksize
),

186 
block
 & (
addr_³r_block
 - 1));

187 
	}
}

189 
bufãr_h—d
 * 
	$šode_g‘blk
 (
šode
 * inode, 
Ä
,

190 
ü—‹
, 
Ãw_block
, * 
”r
)

192 
tmp
, 
gßl
 = 0;

193 * 
p
;

194 
bufãr_h—d
 * 
»suÉ
;

195 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

197 
p
 = 
šode
->
u
.
ext2_i
.
i_d©a
 + 
Ä
;

198 
»³©
:

199 
tmp
 = *
p
;

200 ià(
tmp
) {

201 
»suÉ
 = 
	`g‘blk
 (
šode
->
i_dev
, 
tmp
, inode->
i_sb
->
s_blocksize
);

202 ià(
tmp
 =ğ*
p
)

203  
»suÉ
;

204 
	`b»l£
 (
»suÉ
);

205 
»³©
;

207 ià(!
ü—‹
 || 
Ãw_block
 >=

208 (
cu¼’t
->
¾im
[
RLIMIT_FSIZE
].
¾im_cur
 >>

209 
	`EXT2_BLOCK_SIZE_BITS
(
šode
->
i_sb
))) {

210 *
”r
 = -
EFBIG
;

211  
NULL
;

213 ià(
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 =ğ
Ãw_block
)

214 
gßl
 = 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
;

216 
	`ext2_debug
 ("hšˆğ%d,", 
gßl
);

218 ià(!
gßl
) {

219 
tmp
 = 
Ä
 - 1;mp >= 0;mp--) {

220 ià(
šode
->
u
.
ext2_i
.
i_d©a
[
tmp
]) {

221 
gßl
 = 
šode
->
u
.
ext2_i
.
i_d©a
[
tmp
];

225 ià(!
gßl
)

226 
gßl
 = (
šode
->
u
.
ext2_i
.
i_block_group
 *

227 
	`EXT2_BLOCKS_PER_GROUP
(
šode
->
i_sb
)) +

228 
šode
->
i_sb
->
u
.
ext2_sb
.
s_es
->
s_fœ¡_d©a_block
;

231 
	`ext2_debug
 ("gßÈğ%d.\n", 
gßl
);

233 
tmp
 = 
	`ext2_®loc_block
 (
šode
, 
gßl
);

234 ià(!
tmp
)

235  
NULL
;

236 
»suÉ
 = 
	`g‘blk
 (
šode
->
i_dev
, 
tmp
, inode->
i_sb
->
s_blocksize
);

237 ià(*
p
) {

238 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
tmp
, 1);

239 
	`b»l£
 (
»suÉ
);

240 
»³©
;

242 *
p
 = 
tmp
;

243 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 = 
Ãw_block
;

244 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
 = 
tmp
;

245 
šode
->
i_ùime
 = 
CURRENT_TIME
;

246 
šode
->
i_blocks
 +ğ
blocks
;

247 ià(
	`IS_SYNC
(
šode
))

248 
	`ext2_sync_šode
 (
šode
);

250 
šode
->
i_dœt
 = 1;

251  
»suÉ
;

252 
	}
}

254 
bufãr_h—d
 * 
	$block_g‘blk
 (
šode
 * inode,

255 
bufãr_h—d
 * 
bh
, 
Ä
,

256 
ü—‹
, 
blocksize
,

257 
Ãw_block
, * 
”r
)

259 
tmp
, 
gßl
 = 0;

260 * 
p
;

261 
bufãr_h—d
 * 
»suÉ
;

262 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

264 ià(!
bh
)

265  
NULL
;

266 ià(!
bh
->
b_u±od©e
) {

267 
	`Î_rw_block
 (
READ
, 1, &
bh
);

268 
	`wa™_Ú_bufãr
 (
bh
);

269 ià(!
bh
->
b_u±od©e
) {

270 
	`b»l£
 (
bh
);

271  
NULL
;

274 
p
 = (*è
bh
->
b_d©a
 + 
Ä
;

275 
»³©
:

276 
tmp
 = *
p
;

277 ià(
tmp
) {

278 
»suÉ
 = 
	`g‘blk
 (
bh
->
b_dev
, 
tmp
, 
blocksize
);

279 ià(
tmp
 =ğ*
p
) {

280 
	`b»l£
 (
bh
);

281  
»suÉ
;

283 
	`b»l£
 (
»suÉ
);

284 
»³©
;

286 ià(!
ü—‹
 || 
Ãw_block
 >=

287 (
cu¼’t
->
¾im
[
RLIMIT_FSIZE
].
¾im_cur
 >>

288 
	`EXT2_BLOCK_SIZE_BITS
(
šode
->
i_sb
))) {

289 
	`b»l£
 (
bh
);

290 *
”r
 = -
EFBIG
;

291  
NULL
;

293 ià(
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 =ğ
Ãw_block
)

294 
gßl
 = 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
;

295 ià(!
gßl
) {

296 
tmp
 = 
Ä
 - 1;mp >= 0;mp--) {

297 ià(((*è
bh
->
b_d©a
)[
tmp
]) {

298 
gßl
 = ((*)
bh
->
b_d©a
)[
tmp
];

302 ià(!
gßl
)

303 
gßl
 = 
bh
->
b_blockÄ
;

305 
tmp
 = 
	`ext2_®loc_block
 (
šode
, 
gßl
);

306 ià(!
tmp
) {

307 
	`b»l£
 (
bh
);

308  
NULL
;

310 
»suÉ
 = 
	`g‘blk
 (
bh
->
b_dev
, 
tmp
, 
blocksize
);

311 ià(*
p
) {

312 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
tmp
, 1);

313 
	`b»l£
 (
»suÉ
);

314 
»³©
;

316 *
p
 = 
tmp
;

317 
bh
->
b_dœt
 = 1;

318 ià(
	`IS_SYNC
(
šode
)) {

319 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

320 
	`wa™_Ú_bufãr
 (
bh
);

322 
šode
->
i_ùime
 = 
CURRENT_TIME
;

323 
šode
->
i_blocks
 +ğ
blocks
;

324 
šode
->
i_dœt
 = 1;

325 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 = 
Ãw_block
;

326 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
 = 
tmp
;

327 
	`b»l£
 (
bh
);

328  
»suÉ
;

329 
	}
}

331 
bufãr_h—d
 * 
	$ext2_g‘blk
 (
šode
 * inode, 
block
,

332 
ü—‹
, * 
”r
)

334 
bufãr_h—d
 * 
bh
;

335 
b
;

336 
addr_³r_block
 = 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
);

338 *
”r
 = -
EIO
;

339 ià(
block
 < 0) {

340 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_getblk", "block < 0");

341  
NULL
;

343 ià(
block
 > 
EXT2_NDIR_BLOCKS
 + 
addr_³r_block
 +

344 
addr_³r_block
 *‡ddr_per_block +

345 
addr_³r_block
 *‡ddr_per_block *‡ddr_per_block) {

346 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_getblk", "block > big");

347  
NULL
;

355 
	`ext2_debug
 ("block %lu,‚exˆ%lu, gßÈ%lu.\n", 
block
,

356 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
,

357 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
);

359 ià(
block
 =ğ
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 + 1) {

360 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
++;

361 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
++;

364 *
”r
 = -
ENOSPC
;

365 
b
 = 
block
;

366 ià(
block
 < 
EXT2_NDIR_BLOCKS
)

367  
	`šode_g‘blk
 (
šode
, 
block
, 
ü—‹
, 
b
, 
”r
);

368 
block
 -ğ
EXT2_NDIR_BLOCKS
;

369 ià(
block
 < 
addr_³r_block
) {

370 
bh
 = 
	`šode_g‘blk
 (
šode
, 
EXT2_IND_BLOCK
, 
ü—‹
, 
b
, 
”r
);

371  
	`block_g‘blk
 (
šode
, 
bh
, 
block
, 
ü—‹
,

372 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

374 
block
 -ğ
addr_³r_block
;

375 ià(
block
 < 
addr_³r_block
 *‡ddr_per_block) {

376 
bh
 = 
	`šode_g‘blk
 (
šode
, 
EXT2_DIND_BLOCK
, 
ü—‹
, 
b
, 
”r
);

377 
bh
 = 
	`block_g‘blk
 (
šode
, bh, 
block
 / 
addr_³r_block
, 
ü—‹
,

378 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

379  
	`block_g‘blk
 (
šode
, 
bh
, 
block
 & (
addr_³r_block
 - 1),

380 
ü—‹
, 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

382 
block
 -ğ
addr_³r_block
 *‡ddr_per_block;

383 
bh
 = 
	`šode_g‘blk
 (
šode
, 
EXT2_TIND_BLOCK
, 
ü—‹
, 
b
, 
”r
);

384 
bh
 = 
	`block_g‘blk
 (
šode
, bh, 
block
/(
addr_³r_block
 *‡ddr_per_block),

385 
ü—‹
, 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

386 
bh
 = 
	`block_g‘blk
 (
šode
, bh, (
block
/
addr_³r_block
) & (addr_per_block - 1),

387 
ü—‹
, 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

388  
	`block_g‘blk
 (
šode
, 
bh
, 
block
 & (
addr_³r_block
 - 1), 
ü—‹
,

389 
šode
->
i_sb
->
s_blocksize
, 
b
, 
”r
);

390 
	}
}

392 
bufãr_h—d
 * 
	$ext2_b»ad
 (
šode
 * inode, 
block
,

393 
ü—‹
, *
”r
)

395 
bufãr_h—d
 * 
bh
;

397 
bh
 = 
	`ext2_g‘blk
 (
šode
, 
block
, 
ü—‹
, 
”r
);

398 ià(!
bh
 || bh->
b_u±od©e
)

399  
bh
;

400 
	`Î_rw_block
 (
READ
, 1, &
bh
);

401 
	`wa™_Ú_bufãr
 (
bh
);

402 ià(
bh
->
b_u±od©e
)

403  
bh
;

404 
	`b»l£
 (
bh
);

405 *
”r
 = -
EIO
;

406  
NULL
;

407 
	}
}

409 
	$ext2_»ad_šode
 (
šode
 * inode)

411 
bufãr_h—d
 * 
bh
;

412 
ext2_šode
 * 
¿w_šode
;

413 
block_group
;

414 
group_desc
;

415 
desc
;

416 
block
;

417 
ext2_group_desc
 * 
gdp
;

419 ià((
šode
->
i_šo
 !ğ
EXT2_ROOT_INO
 && inode->i_šØ!ğ
EXT2_ACL_IDX_INO
 &&

420 
šode
->
i_šo
 !ğ
EXT2_ACL_DATA_INO
 && inode->i_šØ< 
EXT2_FIRST_INO
) ||

421 
šode
->
i_šo
 > inode->
i_sb
->
u
.
ext2_sb
.
s_es
->
s_šodes_couÁ
) {

422 
	`ext2_”rÜ
 (
šode
->
i_sb
, "ext2_read_inode",

423 "bad inodnumb”: %lu", 
šode
->
i_šo
);

426 
block_group
 = (
šode
->
i_šo
 - 1è/ 
	`EXT2_INODES_PER_GROUP
(šode->
i_sb
);

427 ià(
block_group
 >ğ
šode
->
i_sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

428 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_read_inode",

430 
group_desc
 = 
block_group
 / 
	`EXT2_DESC_PER_BLOCK
(
šode
->
i_sb
);

431 
desc
 = 
block_group
 % 
	`EXT2_DESC_PER_BLOCK
(
šode
->
i_sb
);

432 
bh
 = 
šode
->
i_sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
];

433 ià(!
bh
)

434 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_read_inode",

436 
gdp
 = (
ext2_group_desc
 *è
bh
->
b_d©a
;

437 
block
 = 
gdp
[
desc
].
bg_šode_bË
 +

438 (((
šode
->
i_šo
 - 1è% 
	`EXT2_INODES_PER_GROUP
(šode->
i_sb
))

439 / 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

440 ià(!(
bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
block
, inode->
i_sb
->
s_blocksize
)))

441 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_read_inode",

443 "šode=%lu, block=%lu", 
šode
->
i_šo
, 
block
);

444 
¿w_šode
 = ((
ext2_šode
 *è
bh
->
b_d©a
) +

445 (
šode
->
i_šo
 - 1è% 
	`EXT2_INODES_PER_BLOCK
(šode->
i_sb
);

446 
šode
->
i_mode
 = 
¿w_šode
->i_mode;

447 
šode
->
i_uid
 = 
¿w_šode
->i_uid;

448 
šode
->
i_gid
 = 
¿w_šode
->i_gid;

449 
šode
->
i_Æšk
 = 
¿w_šode
->
i_lšks_couÁ
;

450 
šode
->
i_size
 = 
¿w_šode
->i_size;

451 
šode
->
i_©ime
 = 
¿w_šode
->i_atime;

452 
šode
->
i_ùime
 = 
¿w_šode
->i_ctime;

453 
šode
->
i_mtime
 = 
¿w_šode
->i_mtime;

454 
šode
->
u
.
ext2_i
.
i_dtime
 = 
¿w_šode
->i_dtime;

455 
šode
->
i_blksize
 = inode->
i_sb
->
s_blocksize
;

456 
šode
->
i_blocks
 = 
¿w_šode
->i_blocks;

457 
šode
->
u
.
ext2_i
.
i_æags
 = 
¿w_šode
->i_flags;

458 
šode
->
u
.
ext2_i
.
i_çddr
 = 
¿w_šode
->i_faddr;

459 
šode
->
u
.
ext2_i
.
i_äag
 = 
¿w_šode
->i_frag;

460 
šode
->
u
.
ext2_i
.
i_fsize
 = 
¿w_šode
->i_fsize;

461 
šode
->
u
.
ext2_i
.
i_fe_aş
 = 
¿w_šode
->i_file_acl;

462 
šode
->
u
.
ext2_i
.
i_dœ_aş
 = 
¿w_šode
->i_dir_acl;

463 
šode
->
u
.
ext2_i
.
i_v”siÚ
 = 
¿w_šode
->i_version;

464 
šode
->
u
.
ext2_i
.
i_block_group
 = 
block_group
;

465 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_block
 = 0;

466 
šode
->
u
.
ext2_i
.
i_Ãxt_®loc_gßl
 = 0;

467 ià(
šode
->
u
.
ext2_i
.
i_´—Îoc_couÁ
)

468 
	`ext2_”rÜ
 (
šode
->
i_sb
, "ext2_read_inode",

470 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

471 
šode
->
i_rdev
 = 
¿w_šode
->
i_block
[0];

472 
block
 = 0; block < 
EXT2_N_BLOCKS
; block++)

473 
šode
->
u
.
ext2_i
.
i_d©a
[
block
] = 
¿w_šode
->
i_block
[block];

474 
	`b»l£
 (
bh
);

475 
šode
->
i_İ
 = 
NULL
;

476 ià(
šode
->
i_šo
 =ğ
EXT2_ACL_IDX_INO
 ||

477 
šode
->
i_šo
 =ğ
EXT2_ACL_DATA_INO
)

479 ià(
	`S_ISREG
(
šode
->
i_mode
))

480 
šode
->
i_İ
 = &
ext2_fe_šode_İ”©iÚs
;

481 ià(
	`S_ISDIR
(
šode
->
i_mode
))

482 
šode
->
i_İ
 = &
ext2_dœ_šode_İ”©iÚs
;

483 ià(
	`S_ISLNK
(
šode
->
i_mode
))

484 
šode
->
i_İ
 = &
ext2_symlšk_šode_İ”©iÚs
;

485 ià(
	`S_ISCHR
(
šode
->
i_mode
))

486 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

487 ià(
	`S_ISBLK
(
šode
->
i_mode
))

488 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

489 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

490 
	`š™_fifo
(
šode
);

491 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SYNC_FL
)

492 
šode
->
i_æags
 |ğ
MS_SYNC
;

493 
	}
}

495 
bufãr_h—d
 * 
	$ext2_upd©e_šode
 (
šode
 * inode)

497 
bufãr_h—d
 * 
bh
;

498 
ext2_šode
 * 
¿w_šode
;

499 
block_group
;

500 
group_desc
;

501 
desc
;

502 
block
;

503 
ext2_group_desc
 * 
gdp
;

505 ià((
šode
->
i_šo
 !ğ
EXT2_ROOT_INO
 && inode->i_šØ< 
EXT2_FIRST_INO
) ||

506 
šode
->
i_šo
 > inode->
i_sb
->
u
.
ext2_sb
.
s_es
->
s_šodes_couÁ
) {

507 
	`ext2_”rÜ
 (
šode
->
i_sb
, "ext2_write_inode",

508 "bad inodnumb”: %lu", 
šode
->
i_šo
);

511 
block_group
 = (
šode
->
i_šo
 - 1è/ 
	`EXT2_INODES_PER_GROUP
(šode->
i_sb
);

512 ià(
block_group
 >ğ
šode
->
i_sb
->
u
.
ext2_sb
.
s_groups_couÁ
)

513 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_write_inode",

515 
group_desc
 = 
block_group
 / 
	`EXT2_DESC_PER_BLOCK
(
šode
->
i_sb
);

516 
desc
 = 
block_group
 % 
	`EXT2_DESC_PER_BLOCK
(
šode
->
i_sb
);

517 
bh
 = 
šode
->
i_sb
->
u
.
ext2_sb
.
s_group_desc
[
group_desc
];

518 ià(!
bh
)

519 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_write_inode",

521 
gdp
 = (
ext2_group_desc
 *è
bh
->
b_d©a
;

522 
block
 = 
gdp
[
desc
].
bg_šode_bË
 +

523 (((
šode
->
i_šo
 - 1è% 
	`EXT2_INODES_PER_GROUP
(šode->
i_sb
))

524 / 
	`EXT2_INODES_PER_BLOCK
(
šode
->
i_sb
));

525 ià(!(
bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
block
, inode->
i_sb
->
s_blocksize
)))

526 
	`ext2_·nic
 (
šode
->
i_sb
, "ext2_write_inode",

528 "šode=%lu, block=%lu", 
šode
->
i_šo
, 
block
);

529 
¿w_šode
 = ((
ext2_šode
 *)
bh
->
b_d©a
) +

530 (
šode
->
i_šo
 - 1è% 
	`EXT2_INODES_PER_BLOCK
(šode->
i_sb
);

531 
¿w_šode
->
i_mode
 = 
šode
->i_mode;

532 
¿w_šode
->
i_uid
 = 
šode
->i_uid;

533 
¿w_šode
->
i_gid
 = 
šode
->i_gid;

534 
¿w_šode
->
i_lšks_couÁ
 = 
šode
->
i_Æšk
;

535 
¿w_šode
->
i_size
 = 
šode
->i_size;

536 
¿w_šode
->
i_©ime
 = 
šode
->i_atime;

537 
¿w_šode
->
i_ùime
 = 
šode
->i_ctime;

538 
¿w_šode
->
i_mtime
 = 
šode
->i_mtime;

539 
¿w_šode
->
i_blocks
 = 
šode
->i_blocks;

540 
¿w_šode
->
i_dtime
 = 
šode
->
u
.
ext2_i
.i_dtime;

541 
¿w_šode
->
i_æags
 = 
šode
->
u
.
ext2_i
.i_flags;

542 
¿w_šode
->
i_çddr
 = 
šode
->
u
.
ext2_i
.i_faddr;

543 
¿w_šode
->
i_äag
 = 
šode
->
u
.
ext2_i
.i_frag;

544 
¿w_šode
->
i_fsize
 = 
šode
->
u
.
ext2_i
.i_fsize;

545 
¿w_šode
->
i_fe_aş
 = 
šode
->
u
.
ext2_i
.i_file_acl;

546 
¿w_šode
->
i_dœ_aş
 = 
šode
->
u
.
ext2_i
.i_dir_acl;

547 
¿w_šode
->
i_v”siÚ
 = 
šode
->
u
.
ext2_i
.i_version;

548 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

549 
¿w_šode
->
i_block
[0] = 
šode
->
i_rdev
;

550 
block
 = 0; block < 
EXT2_N_BLOCKS
; block++)

551 
¿w_šode
->
i_block
[
block
] = 
šode
->
u
.
ext2_i
.
i_d©a
[block];

552 
bh
->
b_dœt
 = 1;

553 
šode
->
i_dœt
 = 0;

554  
bh
;

555 
	}
}

557 
	$ext2_wr™e_šode
 (
šode
 * inode)

559 
bufãr_h—d
 * 
bh
;

560 
bh
 = 
	`ext2_upd©e_šode
 (
šode
);

561 
	`b»l£
 (
bh
);

562 
	}
}

564 
	$ext2_sync_šode
 (
šode
 *inode)

566 
”r
 = 0;

567 
bufãr_h—d
 *
bh
;

569 
bh
 = 
	`ext2_upd©e_šode
 (
šode
);

570 ià(
bh
 && bh->
b_dœt
)

572 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

573 
	`wa™_Ú_bufãr
 (
bh
);

574 ià(
bh
->
b_»q
 && !bh->
b_u±od©e
)

576 
	`´štk
 ("IOƒrror syncingƒxt2 inode [%04x:%08lx]\n",

577 
šode
->
i_dev
, inode->
i_šo
);

578 
”r
 = -1;

581 ià(!
bh
)

582 
”r
 = -1;

583 
	`b»l£
 (
bh
);

584  
”r
;

585 
	}
}

	@fs/ext2/ioctl.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/ext2_fs.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/sched.h
>

17 
	$ext2_ioùl
 (
šode
 * inode, 
fe
 * 
fp
, 
cmd
,

18 
¬g
)

21 
	`ext2_debug
 ("cmd = %u,‡rg = %lu\n", 
cmd
, 
¬g
);

23 
cmd
) {

24 
EXT2_IOC_GETFLAGS
:

25 
	`put_fs_lÚg
 (
šode
->
u
.
ext2_i
.
i_æags
, (*è
¬g
);

27 
EXT2_IOC_SETFLAGS
:

28 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
è&& !
	`su£r
())

29  -
EPERM
;

30 ià(
	`IS_RDONLY
(
šode
))

31  -
EROFS
;

32 
šode
->
u
.
ext2_i
.
i_æags
 = 
	`g‘_fs_lÚg
 ((*è
¬g
);

33 
šode
->
i_ùime
 = 
CURRENT_TIME
;

34 
šode
->
i_dœt
 = 1;

36 
EXT2_IOC_GETVERSION
:

37 
	`put_fs_lÚg
 (
šode
->
u
.
ext2_i
.
i_v”siÚ
, (*è
¬g
);

39 
EXT2_IOC_SETVERSION
:

40 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
è&& !
	`su£r
())

41  -
EPERM
;

42 ià(
	`IS_RDONLY
(
šode
))

43  -
EROFS
;

44 
šode
->
u
.
ext2_i
.
i_v”siÚ
 = 
	`g‘_fs_lÚg
 ((*è
¬g
);

45 
šode
->
i_ùime
 = 
CURRENT_TIME
;

46 
šode
->
i_dœt
 = 1;

49  -
EINVAL
;

51 
	}
}

	@fs/ext2/namei.c

15 
	~<asm/£gm’t.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/ext2_fs.h
>

20 
	~<lšux/fú.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/¡©.h
>

23 
	~<lšux/¡ršg.h
>

24 
	~<lšux/locks.h
>

35 
	#NAMEI_RA_CHUNKS
 2

	)

36 
	#NAMEI_RA_BLOCKS
 4

	)

37 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

38 
	#NAMEI_RA_INDEX
(
c
,
b
è(((cè* 
NAMEI_RA_BLOCKS
è+ (b))

	)

43 
	$ext2_m©ch
 (
Ën
, cÚ¡ * cÚ¡ 
Çme
,

44 
ext2_dœ_’Œy
 * 
de
)

46 
§me
;

48 ià(!
de
 || !de->
šode
 || 
Ën
 > 
EXT2_NAME_LEN
)

53 ià(!
Ën
 && 
de
->
Çme_Ën
 =ğ1 && (de->
Çme
[0] == '.') &&

54 (
de
->
Çme
[1] == '\0'))

56 ià(
Ën
 !ğ
de
->
Çme_Ën
)

58 
	`__asm__
("cld\n\t"

61 :"=q" (
§me
)

62 :"S" ((è
Çme
), "D" ((è
de
->Çme), "c" (
Ën
)

64  (è
§me
;

65 
	}
}

75 
bufãr_h—d
 * 
	$ext2_fšd_’Œy
 (
šode
 * 
dœ
,

76 cÚ¡ * cÚ¡ 
Çme
, 
Çm–’
,

77 
ext2_dœ_’Œy
 ** 
»s_dœ
)

79 
su³r_block
 * 
sb
;

80 
bufãr_h—d
 * 
bh_u£
[
NAMEI_RA_SIZE
];

81 
bufãr_h—d
 * 
bh_»ad
[
NAMEI_RA_SIZE
];

82 
off£t
;

83 
block
, 
tÜ—d
, 
i
, 
”r
;

85 *
»s_dœ
 = 
NULL
;

86 ià(!
dœ
)

87  
NULL
;

88 
sb
 = 
dœ
->
i_sb
;

90 #ifdeà
NO_TRUNCATE


91 ià(
Çm–’
 > 
EXT2_NAME_LEN
)

92  
NULL
;

94 ià(
Çm–’
 > 
EXT2_NAME_LEN
)

95 
Çm–’
 = 
EXT2_NAME_LEN
;

98 
	`mem£t
 (
bh_u£
, 0,  (bh_use));

99 
tÜ—d
 = 0;

100 
block
 = 0; block < 
NAMEI_RA_SIZE
; ++block) {

101 
bufãr_h—d
 * 
bh
;

103 ià((
block
 << 
	`EXT2_BLOCK_SIZE_BITS
 (
sb
)è>ğ
dœ
->
i_size
)

105 
bh
 = 
	`ext2_g‘blk
 (
dœ
, 
block
, 0, &
”r
);

106 
bh_u£
[
block
] = 
bh
;

107 ià(
bh
 && !bh->
b_u±od©e
)

108 
bh_»ad
[
tÜ—d
++] = 
bh
;

111 
block
 = 0;

112 
off£t
 = 0;

113 
off£t
 < 
dœ
->
i_size
) {

114 
bufãr_h—d
 * 
bh
;

115 
ext2_dœ_’Œy
 * 
de
;

116 * 
dlim™
;

118 ià((
block
 % 
NAMEI_RA_BLOCKS
è=ğ0 && 
tÜ—d
) {

119 
	`Î_rw_block
 (
READ
, 
tÜ—d
, 
bh_»ad
);

120 
tÜ—d
 = 0;

122 
bh
 = 
bh_u£
[
block
 % 
NAMEI_RA_SIZE
];

123 ià(!
bh
)

124 
	`ext2_·nic
 (
sb
, "ext2_find_entry",

126 
	`wa™_Ú_bufãr
 (
bh
);

127 ià(!
bh
->
b_u±od©e
) {

134 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

135 
dlim™
 = 
bh
->
b_d©a
 + 
sb
->
s_blocksize
;

136 (*è
de
 < 
dlim™
) {

137 ià(!
	`ext2_check_dœ_’Œy
 ("ext2_fšd_’Œy", 
dœ
,

138 
de
, 
bh
, 
off£t
))

139 
çu»
;

140 ià(
de
->
šode
 !ğ0 && 
	`ext2_m©ch
 (
Çm–’
, 
Çme
, de)) {

141 
i
 = 0; i < 
NAMEI_RA_SIZE
; ++i) {

142 ià(
bh_u£
[
i
] !ğ
bh
)

143 
	`b»l£
 (
bh_u£
[
i
]);

145 *
»s_dœ
 = 
de
;

146  
bh
;

148 
off£t
 +ğ
de
->
»c_Ën
;

149 
de
 = (
ext2_dœ_’Œy
 *)

150 ((*è
de
 + de->
»c_Ën
);

153 
	`b»l£
 (
bh
);

154 ià(((
block
 + 
NAMEI_RA_SIZE
è<< 
	`EXT2_BLOCK_SIZE_BITS
 (
sb
)) >=

155 
dœ
->
i_size
)

156 
bh
 = 
NULL
;

158 
bh
 = 
	`ext2_g‘blk
 (
dœ
, 
block
 + 
NAMEI_RA_SIZE
, 0, &
”r
);

159 
bh_u£
[
block
++ % 
NAMEI_RA_SIZE
] = 
bh
;

160 ià(
bh
 && !bh->
b_u±od©e
)

161 
bh_»ad
[
tÜ—d
++] = 
bh
;

164 
çu»
:

165 
i
 = 0; i < 
NAMEI_RA_SIZE
; ++i)

166 
	`b»l£
 (
bh_u£
[
i
]);

167  
NULL
;

168 
	}
}

170 
	$ext2_lookup
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
,

171 
šode
 ** 
»suÉ
)

173 
šo
;

174 
ext2_dœ_’Œy
 * 
de
;

175 
bufãr_h—d
 * 
bh
;

177 *
»suÉ
 = 
NULL
;

178 ià(!
dœ
)

179  -
ENOENT
;

180 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

181 
	`ut
 (
dœ
);

182  -
ENOENT
;

184 #iâdeà
DONT_USE_DCACHE


185 ià(!(
šo
 = 
	`ext2_dÿche_lookup
 (
dœ
->
i_dev
, dœ->
i_šo
, 
Çme
, 
Ën
))) {

187 ià(!(
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
))) {

188 
	`ut
 (
dœ
);

189  -
ENOENT
;

191 
šo
 = 
de
->
šode
;

192 #iâdeà
DONT_USE_DCACHE


193 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
,

194 
de
->
Çme_Ën
, 
šo
);

196 
	`b»l£
 (
bh
);

197 #iâdeà
DONT_USE_DCACHE


200 ià(!(*
»suÉ
 = 
	`ig‘
 (
dœ
->
i_sb
, 
šo
))) {

201 
	`ut
 (
dœ
);

202  -
EACCES
;

204 
	`ut
 (
dœ
);

206 
	}
}

218 
bufãr_h—d
 * 
	$ext2_add_’Œy
 (
šode
 * 
dœ
,

219 cÚ¡ * 
Çme
, 
Çm–’
,

220 
ext2_dœ_’Œy
 ** 
»s_dœ
,

221 *
”r
)

223 
off£t
;

224 
»c_Ën
;

225 
bufãr_h—d
 * 
bh
;

226 
ext2_dœ_’Œy
 * 
de
, * 
de1
;

227 
su³r_block
 * 
sb
;

229 *
”r
 = -
EINVAL
;

230 *
»s_dœ
 = 
NULL
;

231 ià(!
dœ
)

232  
NULL
;

233 
sb
 = 
dœ
->
i_sb
;

234 #ifdeà
NO_TRUNCATE


235 ià(
Çm–’
 > 
EXT2_NAME_LEN
)

236  
NULL
;

238 ià(
Çm–’
 > 
EXT2_NAME_LEN
)

239 
Çm–’
 = 
EXT2_NAME_LEN
;

241 ià(!
Çm–’
)

242  
NULL
;

246 ià(
dœ
->
i_size
 == 0)

248 *
”r
 = -
ENOENT
;

249  
NULL
;

251 
bh
 = 
	`ext2_b»ad
 (
dœ
, 0, 0, 
”r
);

252 ià(!
bh
)

253  
NULL
;

254 
»c_Ën
 = 
	`EXT2_DIR_REC_LEN
(
Çm–’
);

255 
off£t
 = 0;

256 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

257 *
”r
 = -
ENOSPC
;

259 ià((*)
de
 >ğ
sb
->
s_blocksize
 + 
bh
->
b_d©a
) {

260 
	`b»l£
 (
bh
);

261 
bh
 = 
NULL
;

262 
bh
 = 
	`ext2_b»ad
 (
dœ
, 
off£t
 >> 
	`EXT2_BLOCK_SIZE_BITS
(
sb
), 1, 
”r
);

263 ià(!
bh
)

264  
NULL
;

265 ià(
dœ
->
i_size
 <ğ
off£t
) {

266 ià(
dœ
->
i_size
 == 0) {

267 *
”r
 = -
ENOENT
;

268  
NULL
;

271 
	`ext2_debug
 ("creating‚ext block\n");

273 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

274 
de
->
šode
 = 0;

275 
de
->
»c_Ën
 = 
sb
->
s_blocksize
;

276 
dœ
->
i_size
 = 
off£t
 + 
sb
->
s_blocksize
;

277 
dœ
->
i_dœt
 = 1;

279 
dœ
->
i_ùime
 = 
CURRENT_TIME
;

283 
	`ext2_debug
 ("skippingo‚ext block\n");

285 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

288 ià(!
	`ext2_check_dœ_’Œy
 ("ext2_add_’Œy", 
dœ
, 
de
, 
bh
,

289 
off£t
)) {

290 *
”r
 = -
ENOENT
;

291 
	`b»l£
 (
bh
);

292  
NULL
;

294 ià(
de
->
šode
 !ğ0 && 
	`ext2_m©ch
 (
Çm–’
, 
Çme
, de)) {

295 *
”r
 = -
EEXIST
;

296 
	`b»l£
 (
bh
);

297  
NULL
;

299 ià((
de
->
šode
 =ğ0 && de->
»c_Ën
 >=„ec_len) ||

300 (
de
->
»c_Ën
 >ğ
	`EXT2_DIR_REC_LEN
(de->
Çme_Ën
) +„ec_len)) {

301 
off£t
 +ğ
de
->
»c_Ën
;

302 ià(
de
->
šode
) {

303 
de1
 = (
ext2_dœ_’Œy
 *è((*è
de
 +

304 
	`EXT2_DIR_REC_LEN
(
de
->
Çme_Ën
));

305 
de1
->
»c_Ën
 = 
de
->rec_len -

306 
	`EXT2_DIR_REC_LEN
(
de
->
Çme_Ën
);

307 
de
->
»c_Ën
 = 
	`EXT2_DIR_REC_LEN
(de->
Çme_Ën
);

308 
de
 = 
de1
;

310 
de
->
šode
 = 0;

311 
de
->
Çme_Ën
 = 
Çm–’
;

312 
	`memıy
 (
de
->
Çme
,‚ame, 
Çm–’
);

324 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

325 
dœ
->
i_dœt
 = 1;

326 
bh
->
b_dœt
 = 1;

327 *
»s_dœ
 = 
de
;

328 *
”r
 = 0;

329  
bh
;

331 
off£t
 +ğ
de
->
»c_Ën
;

332 
de
 = (
ext2_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

334 
	`b»l£
 (
bh
);

335  
NULL
;

336 
	}
}

342 
	$ext2_d–‘e_’Œy
 (
ext2_dœ_’Œy
 * 
dœ
,

343 
bufãr_h—d
 * 
bh
)

345 
ext2_dœ_’Œy
 * 
de
, * 
pde
;

346 
i
;

348 
i
 = 0;

349 
pde
 = 
NULL
;

350 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

351 
i
 < 
bh
->
b_size
) {

352 ià(!
	`ext2_check_dœ_’Œy
 ("ext2_d–‘e_’Œy", 
NULL
,

353 
de
, 
bh
, 
i
))

354  -
EIO
;

355 ià(
de
 =ğ
dœ
) {

356 ià(
pde
)

357 
pde
->
»c_Ën
 +ğ
dœ
->rec_len;

358 
dœ
->
šode
 = 0;

361 
i
 +ğ
de
->
»c_Ën
;

362 
pde
 = 
de
;

363 
de
 = (
ext2_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

365  -
ENOENT
;

366 
	}
}

368 
	$ext2_ü—‹
 (
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

369 
šode
 ** 
»suÉ
)

371 
šode
 * inode;

372 
bufãr_h—d
 * 
bh
;

373 
ext2_dœ_’Œy
 * 
de
;

374 
”r
;

376 *
»suÉ
 = 
NULL
;

377 ià(!
dœ
)

378  -
ENOENT
;

379 
šode
 = 
	`ext2_Ãw_šode
 (
dœ
, 
mode
);

380 ià(!
šode
) {

381 
	`ut
 (
dœ
);

382  -
ENOSPC
;

384 
šode
->
i_İ
 = &
ext2_fe_šode_İ”©iÚs
;

385 
šode
->
i_mode
 = 
mode
;

386 
šode
->
i_dœt
 = 1;

387 
bh
 = 
	`ext2_add_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
, &
”r
);

388 ià(!
bh
) {

389 
šode
->
i_Æšk
--;

390 
šode
->
i_dœt
 = 1;

391 
	`ut
 (
šode
);

392 
	`ut
 (
dœ
);

393  
”r
;

395 
de
->
šode
 = inode->
i_šo
;

396 #iâdeà
DONT_USE_DCACHE


397 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
,

398 
de
->
šode
);

400 
bh
->
b_dœt
 = 1;

401 ià(
	`IS_SYNC
(
dœ
)) {

402 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

403 
	`wa™_Ú_bufãr
 (
bh
);

405 
	`b»l£
 (
bh
);

406 
	`ut
 (
dœ
);

407 *
»suÉ
 = 
šode
;

409 
	}
}

411 
	$ext2_mknod
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
,

412 
rdev
)

414 
šode
 * inode;

415 
bufãr_h—d
 * 
bh
;

416 
ext2_dœ_’Œy
 * 
de
;

417 
”r
;

419 ià(!
dœ
)

420  -
ENOENT
;

421 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

422 ià(
bh
) {

423 
	`b»l£
 (
bh
);

424 
	`ut
 (
dœ
);

425  -
EEXIST
;

427 
šode
 = 
	`ext2_Ãw_šode
 (
dœ
, 
mode
);

428 ià(!
šode
) {

429 
	`ut
 (
dœ
);

430  -
ENOSPC
;

432 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

433 
šode
->
i_mode
 = 
mode
;

434 
šode
->
i_İ
 = 
NULL
;

435 ià(
	`S_ISREG
(
šode
->
i_mode
))

436 
šode
->
i_İ
 = &
ext2_fe_šode_İ”©iÚs
;

437 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

438 
šode
->
i_İ
 = &
ext2_dœ_šode_İ”©iÚs
;

439 ià(
dœ
->
i_mode
 & 
S_ISGID
)

440 
šode
->
i_mode
 |ğ
S_ISGID
;

442 ià(
	`S_ISLNK
(
šode
->
i_mode
))

443 
šode
->
i_İ
 = &
ext2_symlšk_šode_İ”©iÚs
;

444 ià(
	`S_ISCHR
(
šode
->
i_mode
))

445 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

446 ià(
	`S_ISBLK
(
šode
->
i_mode
))

447 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

448 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

449 
	`š™_fifo
(
šode
);

450 ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode))

451 
šode
->
i_rdev
 = 
rdev
;

458 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME
;

460 
šode
->
i_dœt
 = 1;

461 
bh
 = 
	`ext2_add_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
, &
”r
);

462 ià(!
bh
) {

463 
šode
->
i_Æšk
--;

464 
šode
->
i_dœt
 = 1;

465 
	`ut
 (
šode
);

466 
	`ut
 (
dœ
);

467  
”r
;

469 
de
->
šode
 = inode->
i_šo
;

470 #iâdeà
DONT_USE_DCACHE


471 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
,

472 
de
->
šode
);

474 
bh
->
b_dœt
 = 1;

475 ià(
	`IS_SYNC
(
dœ
)) {

476 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

477 
	`wa™_Ú_bufãr
 (
bh
);

479 
	`b»l£
 (
bh
);

480 
	`ut
 (
dœ
);

481 
	`ut
 (
šode
);

483 
	}
}

485 
	$ext2_mkdœ
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
)

487 
šode
 * inode;

488 
bufãr_h—d
 * 
bh
, * 
dœ_block
;

489 
ext2_dœ_’Œy
 * 
de
;

490 
”r
;

492 ià(!
dœ
)

493  -
ENOENT
;

494 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

495 ià(
bh
) {

496 
	`b»l£
 (
bh
);

497 
	`ut
 (
dœ
);

498  -
EEXIST
;

500 ià(
dœ
->
i_Æšk
 >ğ
EXT2_LINK_MAX
) {

501 
	`ut
 (
dœ
);

502  -
EMLINK
;

504 
šode
 = 
	`ext2_Ãw_šode
 (
dœ
, 
S_IFDIR
);

505 ià(!
šode
) {

506 
	`ut
 (
dœ
);

507  -
ENOSPC
;

509 
šode
->
i_İ
 = &
ext2_dœ_šode_İ”©iÚs
;

510 
šode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

512 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME
;

514 
dœ_block
 = 
	`ext2_b»ad
 (
šode
, 0, 1, &
”r
);

515 ià(!
dœ_block
) {

516 
	`ut
 (
dœ
);

517 
šode
->
i_Æšk
--;

518 
šode
->
i_dœt
 = 1;

519 
	`ut
 (
šode
);

520  
”r
;

522 
šode
->
i_blocks
 = inode->
i_sb
->
s_blocksize
 / 512;

523 
de
 = (
ext2_dœ_’Œy
 *è
dœ_block
->
b_d©a
;

524 
de
->
šode
 = inode->
i_šo
;

525 
de
->
Çme_Ën
 = 1;

526 
de
->
»c_Ën
 = 
	`EXT2_DIR_REC_LEN
(de->
Çme_Ën
);

527 
	`¡rıy
 (
de
->
Çme
, ".");

528 
de
 = (
ext2_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

529 
de
->
šode
 = 
dœ
->
i_šo
;

530 
de
->
»c_Ën
 = 
šode
->
i_sb
->
s_blocksize
 - 
	`EXT2_DIR_REC_LEN
(1);

531 
de
->
Çme_Ën
 = 2;

532 
	`¡rıy
 (
de
->
Çme
, "..");

533 
šode
->
i_Æšk
 = 2;

534 
dœ_block
->
b_dœt
 = 1;

535 
	`b»l£
 (
dœ_block
);

536 
šode
->
i_mode
 = 
S_IFDIR
 | (
mode
 & 
S_IRWXUGO
 & ~
cu¼’t
->
umask
);

537 ià(
dœ
->
i_mode
 & 
S_ISGID
)

538 
šode
->
i_mode
 |ğ
S_ISGID
;

539 
šode
->
i_dœt
 = 1;

540 
bh
 = 
	`ext2_add_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
, &
”r
);

541 ià(!
bh
) {

542 
	`ut
 (
dœ
);

543 
šode
->
i_Æšk
 = 0;

544 
šode
->
i_dœt
 = 1;

545 
	`ut
 (
šode
);

546  
”r
;

548 
de
->
šode
 = inode->
i_šo
;

549 #iâdeà
DONT_USE_DCACHE


550 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
,

551 
de
->
šode
);

553 
bh
->
b_dœt
 = 1;

554 ià(
	`IS_SYNC
(
dœ
)) {

555 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

556 
	`wa™_Ú_bufãr
 (
bh
);

558 
dœ
->
i_Æšk
++;

559 
dœ
->
i_dœt
 = 1;

560 
	`ut
 (
dœ
);

561 
	`ut
 (
šode
);

562 
	`b»l£
 (
bh
);

564 
	}
}

569 
	$em±y_dœ
 (
šode
 * inode)

571 
off£t
;

572 
bufãr_h—d
 * 
bh
;

573 
ext2_dœ_’Œy
 * 
de
, * 
de1
;

574 
su³r_block
 * 
sb
;

575 
”r
;

577 
sb
 = 
šode
->
i_sb
;

578 ià(
šode
->
i_size
 < 
	`EXT2_DIR_REC_LEN
(1) + EXT2_DIR_REC_LEN(2) ||

579 !(
bh
 = 
	`ext2_b»ad
 (
šode
, 0, 0, &
”r
))) {

580 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "empty_dir",

581 "bad dœeùÜy (dœ %lu)", 
šode
->
i_šo
);

584 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

585 
de1
 = (
ext2_dœ_’Œy
 *è((*è
de
 + de->
»c_Ën
);

586 ià(
de
->
šode
 !ğšode->
i_šo
 || !
de1
->inode ||

587 
	`¡rcmp
 (".", 
de
->
Çme
è|| sŒcm°("..", 
de1
->name)) {

588 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "empty_dir",

589 "bad dœeùÜy (dœ %lu)", 
šode
->
i_šo
);

592 
off£t
 = 
de
->
»c_Ën
 + 
de1
->rec_len;

593 
de
 = (
ext2_dœ_’Œy
 *è((*è
de1
 + de1->
»c_Ën
);

594 
off£t
 < 
šode
->
i_size
 ) {

595 ià((*è
de
 >ğ(*è(
bh
->
b_d©a
 + 
sb
->
s_blocksize
)) {

596 
	`b»l£
 (
bh
);

597 
bh
 = 
	`ext2_b»ad
 (
šode
, 
off£t
 >> 
	`EXT2_BLOCK_SIZE_BITS
(
sb
), 1, &
”r
);

598 ià(!
bh
) {

599 
off£t
 +ğ
sb
->
s_blocksize
;

602 
de
 = (
ext2_dœ_’Œy
 *è
bh
->
b_d©a
;

604 ià(!
	`ext2_check_dœ_’Œy
 ("em±y_dœ", 
šode
, 
de
, 
bh
,

605 
off£t
)) {

606 
	`b»l£
 (
bh
);

609 ià(
de
->
šode
) {

610 
	`b»l£
 (
bh
);

613 
off£t
 +ğ
de
->
»c_Ën
;

614 
de
 = (
ext2_dœ_’Œy
 *è((*èd+ de->
»c_Ën
);

616 
	`b»l£
 (
bh
);

618 
	}
}

620 
	$ext2_rmdœ
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

622 
»tv®
;

623 
šode
 * inode;

624 
bufãr_h—d
 * 
bh
;

625 
ext2_dœ_’Œy
 * 
de
;

627 
»³©
:

628 ià(!
dœ
)

629  -
ENOENT
;

630 
šode
 = 
NULL
;

631 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

632 
»tv®
 = -
ENOENT
;

633 ià(!
bh
)

634 
’d_rmdœ
;

635 
»tv®
 = -
EPERM
;

636 ià(!(
šode
 = 
	`ig‘
 (
dœ
->
i_sb
, 
de
->inode)))

637 
’d_rmdœ
;

638 ià(
šode
->
i_dev
 !ğ
dœ
->i_dev)

639 
’d_rmdœ
;

640 ià(
de
->
šode
 !ğšode->
i_šo
) {

641 
	`ut
(
šode
);

642 
	`b»l£
(
bh
);

643 
cu¼’t
->
couÁ”
 = 0;

644 
	`scheduË
();

645 
»³©
;

647 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& 
cu¼’t
->
euid
 &&

648 
šode
->
i_uid
 !ğ
cu¼’t
->
euid
)

649 
’d_rmdœ
;

650 ià(
šode
 =ğ
dœ
)

651 
’d_rmdœ
;

652 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

653 
»tv®
 = -
ENOTDIR
;

654 
’d_rmdœ
;

656 
	`down
(&
šode
->
i_£m
);

657 ià(!
	`em±y_dœ
 (
šode
))

658 
»tv®
 = -
ENOTEMPTY
;

659 ià(
de
->
šode
 !ğšode->
i_šo
)

660 
»tv®
 = -
ENOENT
;

662 ià(
šode
->
i_couÁ
 > 1) {

670 
šode
->
i_size
 = 0;

672 
»tv®
 = 
	`ext2_d–‘e_’Œy
 (
de
, 
bh
);

674 
	`up
(&
šode
->
i_£m
);

675 ià(
»tv®
)

676 
’d_rmdœ
;

677 
bh
->
b_dœt
 = 1;

678 ià(
	`IS_SYNC
(
dœ
)) {

679 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

680 
	`wa™_Ú_bufãr
 (
bh
);

682 #iâdeà
DONT_USE_DCACHE


683 
	`ext2_dÿche_»move
(
šode
->
i_dev
, inode->
i_šo
, ".", 1);

684 
	`ext2_dÿche_»move
(
šode
->
i_dev
, inode->
i_šo
, "..", 2);

686 ià(
šode
->
i_Æšk
 != 2)

687 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_rmdir",

689 
šode
->
i_Æšk
);

690 #iâdeà
DONT_USE_DCACHE


691 
	`ext2_dÿche_»move
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
);

693 
šode
->
i_Æšk
 = 0;

694 
šode
->
i_dœt
 = 1;

695 
dœ
->
i_Æšk
--;

696 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

697 
dœ
->
i_dœt
 = 1;

698 
’d_rmdœ
:

699 
	`ut
 (
dœ
);

700 
	`ut
 (
šode
);

701 
	`b»l£
 (
bh
);

702  
»tv®
;

703 
	}
}

705 
	$ext2_uÆšk
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

707 
»tv®
;

708 
šode
 * inode;

709 
bufãr_h—d
 * 
bh
;

710 
ext2_dœ_’Œy
 * 
de
;

712 
»³©
:

713 ià(!
dœ
)

714  -
ENOENT
;

715 
»tv®
 = -
ENOENT
;

716 
šode
 = 
NULL
;

717 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

718 ià(!
bh
)

719 
’d_uÆšk
;

720 ià(!(
šode
 = 
	`ig‘
 (
dœ
->
i_sb
, 
de
->inode)))

721 
’d_uÆšk
;

722 
»tv®
 = -
EPERM
;

723 ià(
	`S_ISDIR
(
šode
->
i_mode
))

724 
’d_uÆšk
;

725 ià(
de
->
šode
 !ğšode->
i_šo
) {

726 
	`ut
(
šode
);

727 
	`b»l£
(
bh
);

728 
cu¼’t
->
couÁ”
 = 0;

729 
	`scheduË
();

730 
»³©
;

732 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& !
	`su£r
() &&

733 
cu¼’t
->
euid
 !ğ
šode
->
i_uid
 &&

734 
cu¼’t
->
euid
 !ğ
dœ
->
i_uid
)

735 
’d_uÆšk
;

736 ià(!
šode
->
i_Æšk
) {

737 
	`ext2_w¬nšg
 (
šode
->
i_sb
, "ext2_unlink",

739 
šode
->
i_šo
, inode->
i_Æšk
);

740 
šode
->
i_Æšk
 = 1;

742 
»tv®
 = 
	`ext2_d–‘e_’Œy
 (
de
, 
bh
);

743 ià(
»tv®
)

744 
’d_uÆšk
;

745 
bh
->
b_dœt
 = 1;

746 ià(
	`IS_SYNC
(
dœ
)) {

747 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

748 
	`wa™_Ú_bufãr
 (
bh
);

750 #iâdeà
DONT_USE_DCACHE


751 
	`ext2_dÿche_»move
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
);

753 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

754 
dœ
->
i_dœt
 = 1;

755 
šode
->
i_Æšk
--;

756 
šode
->
i_dœt
 = 1;

757 
šode
->
i_ùime
 = 
dœ
->i_ctime;

758 
»tv®
 = 0;

759 
’d_uÆšk
:

760 
	`b»l£
 (
bh
);

761 
	`ut
 (
šode
);

762 
	`ut
 (
dœ
);

763  
»tv®
;

764 
	}
}

766 
	$ext2_symlšk
 (
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
,

767 cÚ¡ * 
symÇme
)

769 
ext2_dœ_’Œy
 * 
de
;

770 
šode
 * inodğ
NULL
;

771 
bufãr_h—d
 * 
bh
 = 
NULL
, * 
Çme_block
 = NULL;

772 * 
lšk
;

773 
i
, 
”r
;

774 
l
;

775 
c
;

777 ià(!(
šode
 = 
	`ext2_Ãw_šode
 (
dœ
, 
S_IFLNK
))) {

778 
	`ut
 (
dœ
);

779  -
ENOSPC
;

781 
šode
->
i_mode
 = 
S_IFLNK
 | 
S_IRWXUGO
;

782 
šode
->
i_İ
 = &
ext2_symlšk_šode_İ”©iÚs
;

783 
l
 = 0;† < 
šode
->
i_sb
->
s_blocksize
 - 1 &&

784 
symÇme
 [
l
];†++)

786 ià(
l
 >ğ
EXT2_N_BLOCKS
 *  ()) {

788 
	`ext2_debug
 ("l=%d,‚Üm® symlšk\n", 
l
);

790 
Çme_block
 = 
	`ext2_b»ad
 (
šode
, 0, 1, &
”r
);

791 ià(!
Çme_block
) {

792 
	`ut
 (
dœ
);

793 
šode
->
i_Æšk
--;

794 
šode
->
i_dœt
 = 1;

795 
	`ut
 (
šode
);

796  
”r
;

798 
lšk
 = 
Çme_block
->
b_d©a
;

800 
lšk
 = (*è
šode
->
u
.
ext2_i
.
i_d©a
;

802 
	`ext2_debug
 ("l=%d, fa¡ symlšk\n", 
l
);

805 
i
 = 0;

806 
i
 < 
šode
->
i_sb
->
s_blocksize
 - 1 && (
c
 = *(
symÇme
++)))

807 
lšk
[
i
++] = 
c
;

808 
lšk
[
i
] = 0;

809 ià(
Çme_block
) {

810 
Çme_block
->
b_dœt
 = 1;

811 
	`b»l£
 (
Çme_block
);

813 
šode
->
i_size
 = 
i
;

814 
šode
->
i_dœt
 = 1;

815 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

816 ià(
bh
) {

817 
šode
->
i_Æšk
--;

818 
šode
->
i_dœt
 = 1;

819 
	`ut
 (
šode
);

820 
	`b»l£
 (
bh
);

821 
	`ut
 (
dœ
);

822  -
EEXIST
;

824 
bh
 = 
	`ext2_add_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
, &
”r
);

825 ià(!
bh
) {

826 
šode
->
i_Æšk
--;

827 
šode
->
i_dœt
 = 1;

828 
	`ut
 (
šode
);

829 
	`ut
 (
dœ
);

830  
”r
;

832 
de
->
šode
 = inode->
i_šo
;

833 #iâdeà
DONT_USE_DCACHE


834 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
,

835 
de
->
šode
);

837 
bh
->
b_dœt
 = 1;

838 ià(
	`IS_SYNC
(
dœ
)) {

839 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

840 
	`wa™_Ú_bufãr
 (
bh
);

842 
	`b»l£
 (
bh
);

843 
	`ut
 (
dœ
);

844 
	`ut
 (
šode
);

846 
	}
}

848 
	$ext2_lšk
 (
šode
 * 
Şdšode
, šod* 
dœ
,

849 cÚ¡ * 
Çme
, 
Ën
)

851 
ext2_dœ_’Œy
 * 
de
;

852 
bufãr_h—d
 * 
bh
;

853 
”r
;

855 ià(
	`S_ISDIR
(
Şdšode
->
i_mode
)) {

856 
	`ut
 (
Şdšode
);

857 
	`ut
 (
dœ
);

858  -
EPERM
;

860 ià(
Şdšode
->
i_Æšk
 >ğ
EXT2_LINK_MAX
) {

861 
	`ut
 (
Şdšode
);

862 
	`ut
 (
dœ
);

863  -
EMLINK
;

865 
bh
 = 
	`ext2_fšd_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
);

866 ià(
bh
) {

867 
	`b»l£
 (
bh
);

868 
	`ut
 (
dœ
);

869 
	`ut
 (
Şdšode
);

870  -
EEXIST
;

872 
bh
 = 
	`ext2_add_’Œy
 (
dœ
, 
Çme
, 
Ën
, &
de
, &
”r
);

873 ià(!
bh
) {

874 
	`ut
 (
dœ
);

875 
	`ut
 (
Şdšode
);

876  
”r
;

878 
de
->
šode
 = 
Şdšode
->
i_šo
;

879 #iâdeà
DONT_USE_DCACHE


880 
	`ext2_dÿche_add
 (
dœ
->
i_dev
, dœ->
i_šo
, 
de
->
Çme
, de->
Çme_Ën
,

881 
de
->
šode
);

883 
bh
->
b_dœt
 = 1;

884 ià(
	`IS_SYNC
(
dœ
)) {

885 
	`Î_rw_block
 (
WRITE
, 1, &
bh
);

886 
	`wa™_Ú_bufãr
 (
bh
);

888 
	`b»l£
 (
bh
);

889 
	`ut
 (
dœ
);

890 
Şdšode
->
i_Æšk
++;

891 
Şdšode
->
i_ùime
 = 
CURRENT_TIME
;

892 
Şdšode
->
i_dœt
 = 1;

893 
	`ut
 (
Şdšode
);

895 
	}
}

897 
	$subdœ
 (
šode
 * 
Ãw_šode
, šod* 
Şd_šode
)

899 
šo
;

900 
»suÉ
;

902 
Ãw_šode
->
i_couÁ
++;

903 
»suÉ
 = 0;

905 ià(
Ãw_šode
 =ğ
Şd_šode
) {

906 
»suÉ
 = 1;

909 ià(
Ãw_šode
->
i_dev
 !ğ
Şd_šode
->i_dev)

911 
šo
 = 
Ãw_šode
->
i_šo
;

912 ià(
	`ext2_lookup
 (
Ãw_šode
, "..", 2, &new_inode))

914 ià(
Ãw_šode
->
i_šo
 =ğ
šo
)

917 
	`ut
 (
Ãw_šode
);

918  
»suÉ
;

919 
	}
}

921 
	#PARENT_INO
(
bufãr
) \

922 ((
ext2_dœ_’Œy
 *è((*è
bufãr
 + \

923 ((
ext2_dœ_’Œy
 *è
bufãr
)->
»c_Ën
))->
šode


	)

925 
	#PARENT_NAME
(
bufãr
) \

926 ((
ext2_dœ_’Œy
 *è((*è
bufãr
 + \

927 ((
ext2_dœ_’Œy
 *è
bufãr
)->
»c_Ën
))->
Çme


	)

940 
	$do_ext2_»Çme
 (
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
,

941 
Şd_Ën
, 
šode
 * 
Ãw_dœ
,

942 cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

944 
šode
 * 
Şd_šode
, * 
Ãw_šode
;

945 
bufãr_h—d
 * 
Şd_bh
, * 
Ãw_bh
, * 
dœ_bh
;

946 
ext2_dœ_’Œy
 * 
Şd_de
, * 
Ãw_de
;

947 
»tv®
;

949 
¡¬t_up
;

950 
Œy_agaš
:

951 ià(
Ãw_bh
 && 
Ãw_de
)

952 
	`ext2_d–‘e_’Œy
(
Ãw_de
, 
Ãw_bh
);

953 
	`b»l£
 (
Şd_bh
);

954 
	`b»l£
 (
Ãw_bh
);

955 
	`b»l£
 (
dœ_bh
);

956 
	`ut
 (
Şd_šode
);

957 
	`ut
 (
Ãw_šode
);

958 
cu¼’t
->
couÁ”
 = 0;

959 
	`scheduË
 ();

960 
¡¬t_up
:

961 
Şd_šode
 = 
Ãw_šode
 = 
NULL
;

962 
Şd_bh
 = 
Ãw_bh
 = 
dœ_bh
 = 
NULL
;

963 
Ãw_de
 = 
NULL
;

964 
Şd_bh
 = 
	`ext2_fšd_’Œy
 (
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
, &
Şd_de
);

965 
»tv®
 = -
ENOENT
;

966 ià(!
Şd_bh
)

967 
’d_»Çme
;

968 
Şd_šode
 = 
	`__ig‘
 (
Şd_dœ
->
i_sb
, 
Şd_de
->
šode
, 0);

969 ià(!
Şd_šode
)

970 
’d_»Çme
;

971 
»tv®
 = -
EPERM
;

972 ià((
Şd_dœ
->
i_mode
 & 
S_ISVTX
) &&

973 
cu¼’t
->
euid
 !ğ
Şd_šode
->
i_uid
 &&

974 
cu¼’t
->
euid
 !ğ
Şd_dœ
->
i_uid
 && !
	`su£r
())

975 
’d_»Çme
;

976 
Ãw_bh
 = 
	`ext2_fšd_’Œy
 (
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
, &
Ãw_de
);

977 ià(
Ãw_bh
) {

978 
Ãw_šode
 = 
	`__ig‘
 (
Ãw_dœ
->
i_sb
, 
Ãw_de
->
šode
, 0);

979 ià(!
Ãw_šode
) {

980 
	`b»l£
 (
Ãw_bh
);

981 
Ãw_bh
 = 
NULL
;

984 ià(
Ãw_šode
 =ğ
Şd_šode
) {

985 
»tv®
 = 0;

986 
’d_»Çme
;

988 ià(
Ãw_šode
 && 
	`S_ISDIR
Òew_šode->
i_mode
)) {

989 
»tv®
 = -
EISDIR
;

990 ià(!
	`S_ISDIR
(
Şd_šode
->
i_mode
))

991 
’d_»Çme
;

992 
»tv®
 = -
EINVAL
;

993 ià(
	`subdœ
 (
Ãw_dœ
, 
Şd_šode
))

994 
’d_»Çme
;

995 
»tv®
 = -
ENOTEMPTY
;

996 ià(!
	`em±y_dœ
 (
Ãw_šode
))

997 
’d_»Çme
;

998 
»tv®
 = -
EBUSY
;

999 ià(
Ãw_šode
->
i_couÁ
 > 1)

1000 
’d_»Çme
;

1002 
»tv®
 = -
EPERM
;

1003 ià(
Ãw_šode
 && (
Ãw_dœ
->
i_mode
 & 
S_ISVTX
) &&

1004 
cu¼’t
->
euid
 !ğ
Ãw_šode
->
i_uid
 &&

1005 
cu¼’t
->
euid
 !ğ
Ãw_dœ
->
i_uid
 && !
	`su£r
())

1006 
’d_»Çme
;

1007 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

1008 
»tv®
 = -
ENOTDIR
;

1009 ià(
Ãw_šode
 && !
	`S_ISDIR
Òew_šode->
i_mode
))

1010 
’d_»Çme
;

1011 
»tv®
 = -
EINVAL
;

1012 ià(
	`subdœ
 (
Ãw_dœ
, 
Şd_šode
))

1013 
’d_»Çme
;

1014 
dœ_bh
 = 
	`ext2_b»ad
 (
Şd_šode
, 0, 0, &
»tv®
);

1015 ià(!
dœ_bh
)

1016 
’d_»Çme
;

1017 ià(
	`PARENT_INO
(
dœ_bh
->
b_d©a
è!ğ
Şd_dœ
->
i_šo
)

1018 
’d_»Çme
;

1019 
»tv®
 = -
EMLINK
;

1020 ià(!
Ãw_šode
 && 
Ãw_dœ
->
i_Æšk
 >ğ
EXT2_LINK_MAX
)

1021 
’d_»Çme
;

1023 ià(!
Ãw_bh
)

1024 
Ãw_bh
 = 
	`ext2_add_’Œy
 (
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
, &
Ãw_de
,

1025 &
»tv®
);

1026 ià(!
Ãw_bh
)

1027 
’d_»Çme
;

1031 ià(
Ãw_šode
 && (
Ãw_de
->
šode
 !ğÃw_šode->
i_šo
))

1032 
Œy_agaš
;

1033 ià(
Ãw_de
->
šode
 && !
Ãw_šode
)

1034 
Œy_agaš
;

1035 ià(
Şd_de
->
šode
 !ğ
Şd_šode
->
i_šo
)

1036 
Œy_agaš
;

1040 
Ãw_de
->
šode
 = 
Şd_šode
->
i_šo
;

1041 #iâdeà
DONT_USE_DCACHE


1042 
	`ext2_dÿche_»move
 (
Şd_dœ
->
i_dev
, old_dœ->
i_šo
, 
Şd_de
->
Çme
,

1043 
Şd_de
->
Çme_Ën
);

1044 
	`ext2_dÿche_add
 (
Ãw_dœ
->
i_dev
,‚ew_dœ->
i_šo
, 
Ãw_de
->
Çme
,

1045 
Ãw_de
->
Çme_Ën
,‚ew_de->
šode
);

1047 
»tv®
 = 
	`ext2_d–‘e_’Œy
 (
Şd_de
, 
Şd_bh
);

1048 ià(
»tv®
 =ğ-
ENOENT
)

1049 
Œy_agaš
;

1050 ià(
»tv®
)

1051 
’d_»Çme
;

1052 ià(
Ãw_šode
) {

1053 
Ãw_šode
->
i_Æšk
--;

1054 
Ãw_šode
->
i_ùime
 = 
CURRENT_TIME
;

1055 
Ãw_šode
->
i_dœt
 = 1;

1057 
Şd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
CURRENT_TIME
;

1058 
Şd_dœ
->
i_dœt
 = 1;

1059 
Şd_bh
->
b_dœt
 = 1;

1060 ià(
	`IS_SYNC
(
Şd_dœ
)) {

1061 
	`Î_rw_block
 (
WRITE
, 1, &
Şd_bh
);

1062 
	`wa™_Ú_bufãr
 (
Şd_bh
);

1064 
Ãw_bh
->
b_dœt
 = 1;

1065 ià(
	`IS_SYNC
(
Ãw_dœ
)) {

1066 
	`Î_rw_block
 (
WRITE
, 1, &
Ãw_bh
);

1067 
	`wa™_Ú_bufãr
 (
Ãw_bh
);

1069 ià(
dœ_bh
) {

1070 
	`PARENT_INO
(
dœ_bh
->
b_d©a
èğ
Ãw_dœ
->
i_šo
;

1071 
dœ_bh
->
b_dœt
 = 1;

1072 
Şd_dœ
->
i_Æšk
--;

1073 
Şd_dœ
->
i_dœt
 = 1;

1074 ià(
Ãw_šode
) {

1075 
Ãw_šode
->
i_Æšk
--;

1076 
Ãw_šode
->
i_dœt
 = 1;

1078 
Ãw_dœ
->
i_Æšk
++;

1079 
Ãw_dœ
->
i_dœt
 = 1;

1082 
»tv®
 = 0;

1083 
’d_»Çme
:

1084 
	`b»l£
 (
dœ_bh
);

1085 
	`b»l£
 (
Şd_bh
);

1086 
	`b»l£
 (
Ãw_bh
);

1087 
	`ut
 (
Şd_šode
);

1088 
	`ut
 (
Ãw_šode
);

1089 
	`ut
 (
Şd_dœ
);

1090 
	`ut
 (
Ãw_dœ
);

1091  
»tv®
;

1092 
	}
}

1107 
	$ext2_»Çme
 (
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

1108 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

1110 
»suÉ
;

1112 
Şd_dœ
->
i_sb
->
u
.
ext2_sb
.
s_»Çme_lock
)

1113 
	`¦“p_Ú
 (&
Şd_dœ
->
i_sb
->
u
.
ext2_sb
.
s_»Çme_wa™
);

1114 
Şd_dœ
->
i_sb
->
u
.
ext2_sb
.
s_»Çme_lock
 = 1;

1115 
»suÉ
 = 
	`do_ext2_»Çme
 (
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
, 
Ãw_dœ
,

1116 
Ãw_Çme
, 
Ãw_Ën
);

1117 
Şd_dœ
->
i_sb
->
u
.
ext2_sb
.
s_»Çme_lock
 = 0;

1118 
	`wake_up
 (&
Şd_dœ
->
i_sb
->
u
.
ext2_sb
.
s_»Çme_wa™
);

1119  
»suÉ
;

1120 
	}
}

	@fs/ext2/super.c

15 
	~<¡d¬g.h
>

17 
	~<asm/£gm’t.h
>

18 
	~<asm/sy¡em.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/ext2_fs.h
>

23 
	~<lšux/sched.h
>

24 
	~<lšux/¡©.h
>

25 
	~<lšux/¡ršg.h
>

26 
	~<lšux/locks.h
>

28 
v¥rštf
 (*, cÚ¡ *, 
va_li¡
);

30 
	$ext2_”rÜ
 (
su³r_block
 * 
sb
, cÚ¡ * 
funùiÚ
,

31 cÚ¡ * 
fmt
, ...)

33 
buf
[1024];

34 
va_li¡
 
¬gs
;

36 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

37 
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 |ğ
EXT2_ERROR_FS
;

38 
sb
->
u
.
ext2_sb
.
s_es
->
s_¡©e
 |ğ
EXT2_ERROR_FS
;

39 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

40 
sb
->
s_dœt
 = 1;

42 
	`va_¡¬t
 (
¬gs
, 
fmt
);

43 
	`v¥rštf
 (
buf
, 
fmt
, 
¬gs
);

44 
	`va_’d
 (
¬gs
);

45 ià(
	`‹¡_İt
 (
sb
, 
ERRORS_PANIC
) ||

46 (
sb
->
u
.
ext2_sb
.
s_es
->
s_”rÜs
 =ğ
EXT2_ERRORS_PANIC
 &&

47 !
	`‹¡_İt
 (
sb
, 
ERRORS_CONT
è&& !‹¡_İˆ(sb, 
ERRORS_RO
)))

48 
	`·nic
 ("EXT2-fs…anic (device %d/%d): %s: %s\n",

49 
	`MAJOR
(
sb
->
s_dev
), 
	`MINOR
(sb->s_dev), 
funùiÚ
, 
buf
);

50 
	`´štk
 (
KERN_CRIT
 "EXT2-fsƒrror (device %d/%d): %s: %s\n",

51 
	`MAJOR
(
sb
->
s_dev
), 
	`MINOR
(sb->s_dev), 
funùiÚ
, 
buf
);

52 ià(
	`‹¡_İt
 (
sb
, 
ERRORS_RO
) ||

53 (
sb
->
u
.
ext2_sb
.
s_es
->
s_”rÜs
 =ğ
EXT2_ERRORS_RO
 &&

54 !
	`‹¡_İt
 (
sb
, 
ERRORS_CONT
è&& !‹¡_İˆ(sb, 
ERRORS_PANIC
))) {

55 
	`´štk
 ("Remounting filesystem„ead-only\n");

56 
sb
->
s_æags
 |ğ
MS_RDONLY
;

58 
	}
}

60 
NORET_TYPE
 
	$ext2_·nic
 (
su³r_block
 * 
sb
, cÚ¡ * 
funùiÚ
,

61 cÚ¡ * 
fmt
, ...)

63 
buf
[1024];

64 
va_li¡
 
¬gs
;

66 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

67 
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 |ğ
EXT2_ERROR_FS
;

68 
sb
->
u
.
ext2_sb
.
s_es
->
s_¡©e
 |ğ
EXT2_ERROR_FS
;

69 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

70 
sb
->
s_dœt
 = 1;

72 
	`va_¡¬t
 (
¬gs
, 
fmt
);

73 
	`v¥rštf
 (
buf
, 
fmt
, 
¬gs
);

74 
	`va_’d
 (
¬gs
);

75 
	`·nic
 ("EXT2-fs…anic (device %d/%d): %s: %s\n",

76 
	`MAJOR
(
sb
->
s_dev
), 
	`MINOR
(sb->s_dev), 
funùiÚ
, 
buf
);

77 
	}
}

79 
	$ext2_w¬nšg
 (
su³r_block
 * 
sb
, cÚ¡ * 
funùiÚ
,

80 cÚ¡ * 
fmt
, ...)

82 
buf
[1024];

83 
va_li¡
 
¬gs
;

85 
	`va_¡¬t
 (
¬gs
, 
fmt
);

86 
	`v¥rštf
 (
buf
, 
fmt
, 
¬gs
);

87 
	`va_’d
 (
¬gs
);

88 
	`´štk
 (
KERN_WARNING
 "EXT2-fs warning (device %d/%d): %s: %s\n",

89 
	`MAJOR
(
sb
->
s_dev
), 
	`MINOR
(sb->s_dev), 
funùiÚ
, 
buf
);

90 
	}
}

92 
	$ext2_put_su³r
 (
su³r_block
 * 
sb
)

94 
i
;

96 
	`lock_su³r
 (
sb
);

97 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

98 
sb
->
u
.
ext2_sb
.
s_es
->
s_¡©e
 = sb->u.ext2_sb.
s_mouÁ_¡©e
;

99 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

101 #iâdeà
DONT_USE_DCACHE


102 
	`ext2_dÿche_šv®id©e
 (
sb
->
s_dev
);

104 
sb
->
s_dev
 = 0;

105 
i
 = 0; i < 
EXT2_MAX_GROUP_DESC
; i++)

106 ià(
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
])

107 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
]);

108 
i
 = 0; i < 
EXT2_MAX_GROUP_LOADED
; i++)

109 ià(
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
i
])

110 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
i
]);

111 
i
 = 0; i < 
EXT2_MAX_GROUP_LOADED
; i++)

112 ià(
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
i
])

113 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
i
]);

114 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_sbh
);

115 
	`uÆock_su³r
 (
sb
);

117 
	}
}

119 
su³r_İ”©iÚs
 
	gext2_sİs
 = {

120 
ext2_»ad_šode
,

121 
NULL
,

122 
ext2_wr™e_šode
,

123 
ext2_put_šode
,

124 
ext2_put_su³r
,

125 
ext2_wr™e_su³r
,

126 
ext2_¡©fs
,

127 
ext2_»mouÁ


130 #ifdeà
EXT2FS_PRE_02B_COMPAT


132 
	$cÚv”t_´e_02b_fs
 (
su³r_block
 * 
sb
,

133 
bufãr_h—d
 * 
bh
)

135 
ext2_su³r_block
 * 
es
;

136 
ext2_Şd_group_desc
 
Şd_group_desc
 [
BLOCK_SIZE
 /  (ext2_old_group_desc)];

137 
ext2_group_desc
 * 
gdp
;

138 
bufãr_h—d
 * 
bh2
;

139 
groups_couÁ
;

140 
i
;

142 
es
 = (
ext2_su³r_block
 *è
bh
->
b_d©a
;

143 
bh2
 = 
	`b»ad
 (
sb
->
s_dev
, 2, 
BLOCK_SIZE
);

144 ià(!
bh2
) {

145 
	`´štk
 ("Cannot„ead descriptor blocks while converting !\n");

148 
	`memıy
 (
Şd_group_desc
, 
bh2
->
b_d©a
, 
BLOCK_SIZE
);

149 
groups_couÁ
 = (
sb
->
u
.
ext2_sb
.
s_blocks_couÁ
 -

150 
sb
->
u
.
ext2_sb
.
s_fœ¡_d©a_block
 +

151 (
	`EXT2_BLOCK_SIZE
(
sb
) * 8) - 1) /

152 (
	`EXT2_BLOCK_SIZE
(
sb
) * 8);

153 
	`mem£t
 (
bh2
->
b_d©a
, 0, 
BLOCK_SIZE
);

154 
gdp
 = (
ext2_group_desc
 *è
bh2
->
b_d©a
;

155 
i
 = 0; i < 
groups_couÁ
; i++) {

156 
gdp
[
i
].
bg_block_b™m­
 = 
Şd_group_desc
[i].bg_block_bitmap;

157 
gdp
[
i
].
bg_šode_b™m­
 = 
Şd_group_desc
[i].bg_inode_bitmap;

158 
gdp
[
i
].
bg_šode_bË
 = 
Şd_group_desc
[i].bg_inode_table;

159 
gdp
[
i
].
bg_ä“_blocks_couÁ
 = 
Şd_group_desc
[i].bg_free_blocks_count;

160 
gdp
[
i
].
bg_ä“_šodes_couÁ
 = 
Şd_group_desc
[i].bg_free_inodes_count;

162 
bh2
->
b_dœt
 = 1;

163 
	`b»l£
 (
bh2
);

164 
es
->
s_magic
 = 
EXT2_SUPER_MAGIC
;

165 
bh
->
b_dœt
 = 1;

166 
sb
->
s_magic
 = 
EXT2_SUPER_MAGIC
;

168 
	}
}

175 
	$·r£_İtiÚs
 (* 
İtiÚs
, * 
sb_block
,

176 * 
mouÁ_İtiÚs
)

178 * 
this_ch¬
;

179 * 
v®ue
;

181 ià(!
İtiÚs
)

183 
this_ch¬
 = 
	`¡¹ok
 (
İtiÚs
, ",");

184 
this_ch¬
 !ğ
NULL
;

185 
this_ch¬
 = 
	`¡¹ok
 (
NULL
, ",")) {

186 ià((
v®ue
 = 
	`¡rchr
 (
this_ch¬
, '=')è!ğ
NULL
)

187 *
v®ue
++ = 0;

188 ià(!
	`¡rcmp
 (
this_ch¬
, "check")) {

189 ià(!
v®ue
 || !*value)

190 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
CHECK_NORMAL
);

191 ià(!
	`¡rcmp
 (
v®ue
, "none")) {

192 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
CHECK_NORMAL
);

193 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
CHECK_STRICT
);

195 ià(
	`¡rcmp
 (
v®ue
, "normal"))

196 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
CHECK_NORMAL
);

197 ià(
	`¡rcmp
 (
v®ue
, "strict")) {

198 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
CHECK_NORMAL
);

199 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
CHECK_STRICT
);

202 
	`´štk
 ("EXT2-fs: Invalid check option: %s\n",

203 
v®ue
);

207 ià(!
	`¡rcmp
 (
this_ch¬
, "debug"))

208 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
DEBUG
);

209 ià(!
	`¡rcmp
 (
this_ch¬
, "errors")) {

210 ià(!
v®ue
 || !*value) {

211 
	`´štk
 ("EXT2-fs:heƒrrors option„equires "

215 ià(!
	`¡rcmp
 (
v®ue
, "continue")) {

216 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_RO
);

217 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_PANIC
);

218 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_CONT
);

220 ià(!
	`¡rcmp
 (
v®ue
, "remount-ro")) {

221 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_CONT
);

222 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_PANIC
);

223 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_RO
);

225 ià(!
	`¡rcmp
 (
v®ue
, "panic")) {

226 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_CONT
);

227 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_RO
);

228 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
ERRORS_PANIC
);

231 
	`´štk
 ("EXT2-fs: Invalidƒrrors option: %s\n",

232 
v®ue
);

236 ià(!
	`¡rcmp
 (
this_ch¬
, "grpid") ||

237 !
	`¡rcmp
 (
this_ch¬
, "bsdgroups"))

238 
	`£t_İt
 (*
mouÁ_İtiÚs
, 
GRPID
);

239 ià(!
	`¡rcmp
 (
this_ch¬
, "nocheck")) {

240 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
CHECK_NORMAL
);

241 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
CHECK_STRICT
);

243 ià(!
	`¡rcmp
 (
this_ch¬
, "nogrpid") ||

244 !
	`¡rcmp
 (
this_ch¬
, "sysvgroups"))

245 
	`ş—r_İt
 (*
mouÁ_İtiÚs
, 
GRPID
);

246 ià(!
	`¡rcmp
 (
this_ch¬
, "sb")) {

247 ià(!
v®ue
 || !*value) {

248 
	`´štk
 ("EXT2-fs:he sb option„equires "

252 *
sb_block
 = 
	`sim¶e_¡¹oul
 (
v®ue
, &value, 0);

253 ià(*
v®ue
) {

254 
	`´štk
 ("EXT2-fs: Invalid sb option: %s\n",

255 
v®ue
);

260 
	`´štk
 ("EXT2-fs: UÄecognized mouÁ o±iÚ %s\n", 
this_ch¬
);

265 
	}
}

267 
	$ext2_£tup_su³r
 (
su³r_block
 * 
sb
,

268 
ext2_su³r_block
 * 
es
)

270 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

271 ià(!(
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 & 
EXT2_VALID_FS
))

272 
	`´štk
 ("EXT2-fs warning: mounting unchecked fs, "

274 ià((
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 & 
EXT2_ERROR_FS
))

275 
	`´štk
 ("EXT2-fs warning: mounting fs withƒrrors, "

277 ià(
es
->
s_max_mÁ_couÁ
 >= 0 &&

278 
es
->
s_mÁ_couÁ
 >ğ(èes->
s_max_mÁ_couÁ
)

279 
	`´štk
 ("EXT2-fs warning: maximal mount count„eached, "

281 ià(
es
->
s_checkš‹rv®
 &&

282 (
es
->
s_Ï¡check
 +ƒs->
s_checkš‹rv®
 <ğ
CURRENT_TIME
))

283 
	`´štk
 ("EXT2-fs warning: checktime„eached, "

285 
es
->
s_¡©e
 &ğ~
EXT2_VALID_FS
;

286 ià(!
es
->
s_max_mÁ_couÁ
)

287 
es
->
s_max_mÁ_couÁ
 = 
EXT2_DFL_MAX_MNT_COUNT
;

288 
es
->
s_mÁ_couÁ
++;

289 
es
->
s_mtime
 = 
CURRENT_TIME
;

290 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

291 
sb
->
s_dœt
 = 1;

292 ià(
	`‹¡_İt
 (
sb
, 
DEBUG
))

293 
	`´štk
 ("[EXT II FS %s, %s, bs=%lu, fs=%lu, gc=%lu, "

295 
EXT2FS_VERSION
, 
EXT2FS_DATE
, 
sb
->
s_blocksize
,

296 
sb
->
u
.
ext2_sb
.
s_äag_size
,

297 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
,

298 
	`EXT2_BLOCKS_PER_GROUP
(
sb
),

299 
	`EXT2_INODES_PER_GROUP
(
sb
),

300 
sb
->
u
.
ext2_sb
.
s_mouÁ_İt
);

301 ià(
	`‹¡_İt
 (
sb
, 
CHECK
)) {

302 
	`ext2_check_blocks_b™m­
 (
sb
);

303 
	`ext2_check_šodes_b™m­
 (
sb
);

306 
	}
}

308 
	$ext2_check_desütÜs
 (
su³r_block
 * 
sb
)

310 
i
;

311 
desc_block
 = 0;

312 
block
 = 
sb
->
u
.
ext2_sb
.
s_es
->
s_fœ¡_d©a_block
;

313 
ext2_group_desc
 * 
gdp
 = 
NULL
;

315 
	`ext2_debug
 ("Checking group descriptors");

317 
i
 = 0; i < 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
; i++)

319 ià((
i
 % 
	`EXT2_DESC_PER_BLOCK
(
sb
)) == 0)

320 
gdp
 = (
ext2_group_desc
 *è
sb
->
u
.
ext2_sb
.
s_group_desc
[
desc_block
++]->
b_d©a
;

321 ià(
gdp
->
bg_block_b™m­
 < 
block
 ||

322 
gdp
->
bg_block_b™m­
 >ğ
block
 + 
	`EXT2_BLOCKS_PER_GROUP
(
sb
))

324 
	`ext2_”rÜ
 (
sb
, "ext2_check_desciptors",

327 
i
, 
gdp
->
bg_block_b™m­
);

330 ià(
gdp
->
bg_šode_b™m­
 < 
block
 ||

331 
gdp
->
bg_šode_b™m­
 >ğ
block
 + 
	`EXT2_BLOCKS_PER_GROUP
(
sb
))

333 
	`ext2_”rÜ
 (
sb
, "ext2_check_desciptors",

336 
i
, 
gdp
->
bg_šode_b™m­
);

339 ià(
gdp
->
bg_šode_bË
 < 
block
 ||

340 
gdp
->
bg_šode_bË
 + 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
 >=

341 
block
 + 
	`EXT2_BLOCKS_PER_GROUP
(
sb
))

343 
	`ext2_”rÜ
 (
sb
, "ext2_check_desciptors",

346 
i
, 
gdp
->
bg_šode_bË
);

349 
block
 +ğ
	`EXT2_BLOCKS_PER_GROUP
(
sb
);

350 
gdp
++;

353 
	}
}

355 
su³r_block
 * 
	$ext2_»ad_su³r
 (
su³r_block
 * 
sb
, * 
d©a
,

356 
s’t
)

358 
bufãr_h—d
 * 
bh
;

359 
ext2_su³r_block
 * 
es
;

360 
sb_block
 = 1;

361 
logic_sb_block
 = 1;

362 
dev
 = 
sb
->
s_dev
;

363 
bh_couÁ
;

364 
i
, 
j
;

365 #ifdeà
EXT2FS_PRE_02B_COMPAT


366 
fs_cÚv”‹d
 = 0;

369 
	`£t_İt
 (
sb
->
u
.
ext2_sb
.
s_mouÁ_İt
, 
CHECK_NORMAL
);

370 ià(!
	`·r£_İtiÚs
 ((*è
d©a
, &
sb_block
,

371 &
sb
->
u
.
ext2_sb
.
s_mouÁ_İt
)) {

372 
sb
->
s_dev
 = 0;

373  
NULL
;

376 
	`lock_su³r
 (
sb
);

377 
	`£t_blocksize
 (
dev
, 
BLOCK_SIZE
);

378 ià(!(
bh
 = 
	`b»ad
 (
dev
, 
sb_block
, 
BLOCK_SIZE
))) {

379 
sb
->
s_dev
 = 0;

380 
	`uÆock_su³r
 (
sb
);

381 
	`´štk
 ("EXT2-fs: unableo„ead superblock\n");

382  
NULL
;

388 
es
 = (
ext2_su³r_block
 *è
bh
->
b_d©a
;

389 
sb
->
u
.
ext2_sb
.
s_es
 = 
es
;

390 
sb
->
s_magic
 = 
es
->s_magic;

391 ià(
sb
->
s_magic
 !ğ
EXT2_SUPER_MAGIC


392 #ifdeà
EXT2FS_PRE_02B_COMPAT


393 && 
sb
->
s_magic
 !ğ
EXT2_PRE_02B_MAGIC


396 
sb
->
s_dev
 = 0;

397 
	`uÆock_su³r
 (
sb
);

398 
	`b»l£
 (
bh
);

399 ià(!
s’t
)

400 
	`´štk
 ("VFS: Can't find‡nƒxt2 filesystem on dev %d/%d.\n",

401 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

402  
NULL
;

404 
sb
->
s_blocksize
 = 
EXT2_MIN_BLOCK_SIZE
 << 
es
->
s_log_block_size
;

405 
sb
->
s_blocksize_b™s
 = 
	`EXT2_BLOCK_SIZE_BITS
(sb);

406 ià(
sb
->
s_blocksize
 !ğ
BLOCK_SIZE
 &&

407 (
sb
->
s_blocksize
 == 1024 || sb->s_blocksize == 2048 ||

408 
sb
->
s_blocksize
 == 4096)) {

409 
off£t
;

411 
	`b»l£
 (
bh
);

412 
	`£t_blocksize
 (
dev
, 
sb
->
s_blocksize
);

413 
logic_sb_block
 = 
sb_block
 / 
sb
->
s_blocksize
;

414 
off£t
 = 
sb_block
 % 
sb
->
s_blocksize
;

415 
bh
 = 
	`b»ad
 (
dev
, 
logic_sb_block
, 
sb
->
s_blocksize
);

416 if(!
bh
)

417  
NULL
;

418 
es
 = (
ext2_su³r_block
 *è(((*)
bh
->
b_d©a
è+ 
off£t
);

419 
sb
->
u
.
ext2_sb
.
s_es
 = 
es
;

420 ià(
es
->
s_magic
 !ğ
EXT2_SUPER_MAGIC
) {

421 
sb
->
s_dev
 = 0;

422 
	`uÆock_su³r
 (
sb
);

423 
	`b»l£
 (
bh
);

424 
	`´štk
 ("EXT2-fs: Magic mismatch, very weird !\n");

425  
NULL
;

428 
sb
->
u
.
ext2_sb
.
s_äag_size
 = 
EXT2_MIN_FRAG_SIZE
 <<

429 
es
->
s_log_äag_size
;

430 ià(
sb
->
u
.
ext2_sb
.
s_äag_size
)

431 
sb
->
u
.
ext2_sb
.
s_äags_³r_block
 = sb->
s_blocksize
 /

432 
sb
->
u
.
ext2_sb
.
s_äag_size
;

434 
sb
->
s_magic
 = 0;

435 
sb
->
u
.
ext2_sb
.
s_blocks_³r_group
 = 
es
->s_blocks_per_group;

436 
sb
->
u
.
ext2_sb
.
s_äags_³r_group
 = 
es
->s_frags_per_group;

437 
sb
->
u
.
ext2_sb
.
s_šodes_³r_group
 = 
es
->s_inodes_per_group;

438 
sb
->
u
.
ext2_sb
.
s_šodes_³r_block
 = sb->
s_blocksize
 /

439  (
ext2_šode
);

440 
sb
->
u
.
ext2_sb
.
s_™b_³r_group
 = sb->u.ext2_sb.
s_šodes_³r_group
 /

441 
sb
->
u
.
ext2_sb
.
s_šodes_³r_block
;

442 
sb
->
u
.
ext2_sb
.
s_desc_³r_block
 = sb->
s_blocksize
 /

443  (
ext2_group_desc
);

444 
sb
->
u
.
ext2_sb
.
s_sbh
 = 
bh
;

445 
sb
->
u
.
ext2_sb
.
s_es
 = 
es
;

446 
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 = 
es
->
s_¡©e
;

447 
sb
->
u
.
ext2_sb
.
s_»Çme_lock
 = 0;

448 
sb
->
u
.
ext2_sb
.
s_»Çme_wa™
 = 
NULL
;

449 #ifdeà
EXT2FS_PRE_02B_COMPAT


450 ià(
sb
->
s_magic
 =ğ
EXT2_PRE_02B_MAGIC
) {

451 ià(
es
->
s_blocks_couÁ
 > 262144) {

455 
sb
->
s_dev
 = 0;

456 
	`uÆock_su³r
 (
sb
);

457 
	`b»l£
 (
bh
);

458 
	`´štk
 ("EXT2-fs:ryingo mount‡…re-0.2b file"

460  
NULL
;

462 
	`´štk
 ("EXT2-fs: mounting‡…re 0.2b file system, "

464 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

465 
sb
->
s_dev
 = 0;

466 
	`uÆock_su³r
 (
sb
);

467 
	`b»l£
 (
bh
);

468 
	`´štk
 ("EXT2-fs: cannot convert‡„ead-only fs\n");

469  
NULL
;

471 ià(!
	`cÚv”t_´e_02b_fs
 (
sb
, 
bh
)) {

472 
sb
->
s_dev
 = 0;

473 
	`uÆock_su³r
 (
sb
);

474 
	`b»l£
 (
bh
);

475 
	`´štk
 ("EXT2-fs: conversion failed !!!\n");

476  
NULL
;

478 
	`´štk
 ("EXT2-fs: conversion succeeded !!!\n");

479 
fs_cÚv”‹d
 = 1;

482 ià(
sb
->
s_magic
 !ğ
EXT2_SUPER_MAGIC
) {

483 
sb
->
s_dev
 = 0;

484 
	`uÆock_su³r
 (
sb
);

485 
	`b»l£
 (
bh
);

486 ià(!
s’t
)

487 
	`´štk
 ("VFS: Can't find‡nƒxt2 filesystem on dev %d/%d.\n",

488 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

489  
NULL
;

491 ià(
sb
->
s_blocksize
 !ğ
bh
->
b_size
) {

492 
sb
->
s_dev
 = 0;

493 
	`uÆock_su³r
 (
sb
);

494 
	`b»l£
 (
bh
);

495 ià(!
s’t
)

496 
	`´štk
 ("VFS: Unsupported blocksize on dev 0x%04x.\n",

497 
dev
);

498  
NULL
;

501 ià(
sb
->
s_blocksize
 !ğsb->
u
.
ext2_sb
.
s_äag_size
) {

502 
sb
->
s_dev
 = 0;

503 
	`uÆock_su³r
 (
sb
);

504 
	`b»l£
 (
bh
);

505 
	`´štk
 ("EXT2-fs: fragsize %lu != blocksize %lu (not supported yet)\n",

506 
sb
->
u
.
ext2_sb
.
s_äag_size
, sb->
s_blocksize
);

507  
NULL
;

510 
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 = (
es
->
s_blocks_couÁ
 -

511 
es
->
s_fœ¡_d©a_block
 +

512 
	`EXT2_BLOCKS_PER_GROUP
(
sb
) - 1) /

513 
	`EXT2_BLOCKS_PER_GROUP
(
sb
);

514 
i
 = 0; i < 
EXT2_MAX_GROUP_DESC
; i++)

515 
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
] = 
NULL
;

516 
bh_couÁ
 = (
sb
->
u
.
ext2_sb
.
s_groups_couÁ
 + 
	`EXT2_DESC_PER_BLOCK
(sb) - 1) /

517 
	`EXT2_DESC_PER_BLOCK
(
sb
);

518 ià(
bh_couÁ
 > 
EXT2_MAX_GROUP_DESC
) {

519 
sb
->
s_dev
 = 0;

520 
	`uÆock_su³r
 (
sb
);

521 
	`b»l£
 (
bh
);

522 
	`´štk
 ("EXT2-fs: file system isoo big\n");

523  
NULL
;

525 
i
 = 0; i < 
bh_couÁ
; i++) {

526 
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
] = 
	`b»ad
 (
dev
, 
logic_sb_block
 + i + 1,

527 
sb
->
s_blocksize
);

528 ià(!
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
]) {

529 
sb
->
s_dev
 = 0;

530 
	`uÆock_su³r
 (
sb
);

531 
j
 = 0; j < 
i
; j++)

532 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_group_desc
[
j
]);

533 
	`b»l£
 (
bh
);

534 
	`´štk
 ("EXT2-fs: unableo„ead group descriptors\n");

535  
NULL
;

538 ià(!
	`ext2_check_desütÜs
 (
sb
)) {

539 
sb
->
s_dev
 = 0;

540 
	`uÆock_su³r
 (
sb
);

541 
j
 = 0; j < 
i
; j++)

542 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_group_desc
[
j
]);

543 
	`b»l£
 (
bh
);

544 
	`´štk
 ("EXT2-fs: group descriptors corrupted !\n");

545  
NULL
;

547 
i
 = 0; i < 
EXT2_MAX_GROUP_LOADED
; i++) {

548 
sb
->
u
.
ext2_sb
.
s_šode_b™m­_numb”
[
i
] = 0;

549 
sb
->
u
.
ext2_sb
.
s_šode_b™m­
[
i
] = 
NULL
;

550 
sb
->
u
.
ext2_sb
.
s_block_b™m­_numb”
[
i
] = 0;

551 
sb
->
u
.
ext2_sb
.
s_block_b™m­
[
i
] = 
NULL
;

553 
sb
->
u
.
ext2_sb
.
s_lßded_šode_b™m­s
 = 0;

554 
sb
->
u
.
ext2_sb
.
s_lßded_block_b™m­s
 = 0;

555 
	`uÆock_su³r
 (
sb
);

559 
sb
->
s_dev
 = 
dev
;

560 
sb
->
s_İ
 = &
ext2_sİs
;

561 ià(!(
sb
->
s_mouÁed
 = 
	`ig‘
 (sb, 
EXT2_ROOT_INO
))) {

562 
sb
->
s_dev
 = 0;

563 
i
 = 0; i < 
EXT2_MAX_GROUP_DESC
; i++)

564 ià(
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
])

565 
	`b»l£
 (
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
]);

566 
	`b»l£
 (
bh
);

567 
	`´štk
 ("EXT2-fs: get„oot inode failed\n");

568  
NULL
;

570 #ifdeà
EXT2FS_PRE_02B_COMPAT


571 ià(
fs_cÚv”‹d
) {

572 
i
 = 0; i < 
bh_couÁ
; i++)

573 
sb
->
u
.
ext2_sb
.
s_group_desc
[
i
]->
b_dœt
 = 1;

574 
sb
->
s_dœt
 = 1;

577 
	`ext2_£tup_su³r
 (
sb
, 
es
);

578  
sb
;

579 
	}
}

581 
	$ext2_comm™_su³r
 (
su³r_block
 * 
sb
,

582 
ext2_su³r_block
 * 
es
)

584 
es
->
s_wtime
 = 
CURRENT_TIME
;

585 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

586 
sb
->
s_dœt
 = 0;

587 
	}
}

600 
	$ext2_wr™e_su³r
 (
su³r_block
 * 
sb
)

602 
ext2_su³r_block
 * 
es
;

604 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

605 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

607 
	`ext2_debug
 ("setting valido 0\n");

609 ià(
es
->
s_¡©e
 & 
EXT2_VALID_FS
) {

610 
es
->
s_¡©e
 &ğ~
EXT2_VALID_FS
;

611 
es
->
s_mtime
 = 
CURRENT_TIME
;

613 
	`ext2_comm™_su³r
 (
sb
, 
es
);

615 
sb
->
s_dœt
 = 0;

616 
	}
}

618 
	$ext2_»mouÁ
 (
su³r_block
 * 
sb
, * 
æags
, * 
d©a
)

620 
ext2_su³r_block
 * 
es
;

621 
tmp
;

626 
	`£t_İt
 (
sb
->
u
.
ext2_sb
.
s_mouÁ_İt
, 
CHECK_NORMAL
);

627 
	`·r£_İtiÚs
 (
d©a
, &
tmp
, &
sb
->
u
.
ext2_sb
.
s_mouÁ_İt
);

629 
es
 = 
sb
->
u
.
ext2_sb
.
s_es
;

630 ià((*
æags
 & 
MS_RDONLY
è=ğ(
sb
->
s_æags
 & MS_RDONLY))

632 ià(*
æags
 & 
MS_RDONLY
) {

633 ià(
es
->
s_¡©e
 & 
EXT2_VALID_FS
 ||

634 !(
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 & 
EXT2_VALID_FS
))

640 
es
->
s_¡©e
 = 
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
;

641 
es
->
s_mtime
 = 
CURRENT_TIME
;

642 
sb
->
u
.
ext2_sb
.
s_sbh
->
b_dœt
 = 1;

643 
sb
->
s_dœt
 = 1;

644 
	`ext2_comm™_su³r
 (
sb
, 
es
);

652 
sb
->
u
.
ext2_sb
.
s_mouÁ_¡©e
 = 
es
->
s_¡©e
;

653 
sb
->
s_æags
 &ğ~
MS_RDONLY
;

654 
	`ext2_£tup_su³r
 (
sb
, 
es
);

657 
	}
}

659 
	$ext2_¡©fs
 (
su³r_block
 * 
sb
, 
¡©fs
 * 
buf
)

661 
tmp
;

663 
	`put_fs_lÚg
 (
EXT2_SUPER_MAGIC
, &
buf
->
f_ty³
);

664 
	`put_fs_lÚg
 (
sb
->
s_blocksize
, &
buf
->
f_bsize
);

665 
	`put_fs_lÚg
 (
sb
->
u
.
ext2_sb
.
s_es
->
s_blocks_couÁ
, &
buf
->
f_blocks
);

666 
tmp
 = 
	`ext2_couÁ_ä“_blocks
 (
sb
);

667 
	`put_fs_lÚg
 (
tmp
, &
buf
->
f_bä“
);

668 ià(
tmp
 >ğ
sb
->
u
.
ext2_sb
.
s_es
->
s_r_blocks_couÁ
)

669 
	`put_fs_lÚg
 (
tmp
 - 
sb
->
u
.
ext2_sb
.
s_es
->
s_r_blocks_couÁ
,

670 &
buf
->
f_bava
);

672 
	`put_fs_lÚg
 (0, &
buf
->
f_bava
);

673 
	`put_fs_lÚg
 (
sb
->
u
.
ext2_sb
.
s_es
->
s_šodes_couÁ
, &
buf
->
f_fes
);

674 
	`put_fs_lÚg
 (
	`ext2_couÁ_ä“_šodes
 (
sb
), &
buf
->
f_fä“
);

675 
	`put_fs_lÚg
 (
EXT2_NAME_LEN
, &
buf
->
f_Çm–’
);

677 
	}
}

	@fs/ext2/symlink.c

17 
	~<asm/£gm’t.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/ext2_fs.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/¡©.h
>

25 
ext2_»adlšk
 (
šode
 *, *, );

26 
ext2_fŞlow_lšk
 (
šode
 *, inode *, , ,

27 
šode
 **);

32 
šode_İ”©iÚs
 
	gext2_symlšk_šode_İ”©iÚs
 = {

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
ext2_»adlšk
,

44 
ext2_fŞlow_lšk
,

45 
NULL
,

46 
NULL
,

47 
NULL


50 
	$ext2_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

51 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

53 
”rÜ
;

54 
bufãr_h—d
 * 
bh
 = 
NULL
;

55 * 
lšk
;

57 *
»s_šode
 = 
NULL
;

58 ià(!
dœ
) {

59 
dœ
 = 
cu¼’t
->
roÙ
;

60 
dœ
->
i_couÁ
++;

62 ià(!
šode
) {

63 
	`ut
 (
dœ
);

64  -
ENOENT
;

66 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

67 
	`ut
 (
dœ
);

68 *
»s_šode
 = 
šode
;

71 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

72 
	`ut
 (
dœ
);

73 
	`ut
 (
šode
);

74  -
ELOOP
;

76 ià(
šode
->
i_blocks
) {

77 ià(!(
bh
 = 
	`ext2_b»ad
 (
šode
, 0, 0, &
”rÜ
))) {

78 
	`ut
 (
dœ
);

79 
	`ut
 (
šode
);

80  -
EIO
;

82 
lšk
 = 
bh
->
b_d©a
;

84 
lšk
 = (*è
šode
->
u
.
ext2_i
.
i_d©a
;

85 
cu¼’t
->
lšk_couÁ
++;

86 
”rÜ
 = 
	`İ’_Çmei
 (
lšk
, 
æag
, 
mode
, 
»s_šode
, 
dœ
);

87 
cu¼’t
->
lšk_couÁ
--;

88 
	`ut
 (
šode
);

89 ià(
bh
)

90 
	`b»l£
 (
bh
);

91  
”rÜ
;

92 
	}
}

94 
	$ext2_»adlšk
 (
šode
 * inode, * 
bufãr
, 
buæ’
)

96 
bufãr_h—d
 * 
bh
 = 
NULL
;

97 * 
lšk
;

98 
i
, 
”r
;

99 
c
;

101 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

102 
	`ut
 (
šode
);

103  -
EINVAL
;

105 ià(
buæ’
 > 
šode
->
i_sb
->
s_blocksize
 - 1)

106 
buæ’
 = 
šode
->
i_sb
->
s_blocksize
 - 1;

107 ià(
šode
->
i_blocks
) {

108 
bh
 = 
	`ext2_b»ad
 (
šode
, 0, 0, &
”r
);

109 ià(!
bh
) {

110 
	`ut
 (
šode
);

113 
lšk
 = 
bh
->
b_d©a
;

116 
lšk
 = (*è
šode
->
u
.
ext2_i
.
i_d©a
;

117 
i
 = 0;

118 
i
 < 
buæ’
 && (
c
 = 
lšk
[i])) {

119 
i
++;

120 
	`put_fs_by‹
 (
c
, 
bufãr
++);

122 
	`ut
 (
šode
);

123 ià(
bh
)

124 
	`b»l£
 (
bh
);

125  
i
;

126 
	}
}

	@fs/ext2/truncate.c

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/ext2_fs.h
>

23 
	~<lšux/fú.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/¡©.h
>

26 
	~<lšux/locks.h
>

28 
	#ş—r_block
(
addr
,
size
,
v®ue
) \

29 
	`__asm__
("cld\n\t" \

33 :"a" (
v®ue
), "c" (
size
 / 4), "D" ((è(
addr
)) \

34 :"cx", "di")

	)

36 
	gext2_£üm_£ed
 = 152;

38 
	#RANDOM_INT
 (
ext2_£üm_£ed
 =ƒxt2_£üm_£ed * 69069È+1)

	)

53 
	$Œunc_dœeù
 (
šode
 * inode)

55 
i
, 
tmp
;

56 * 
p
;

57 
bufãr_h—d
 * 
bh
;

58 
block_to_ä“
 = 0;

59 
ä“_couÁ
 = 0;

60 
»Œy
 = 0;

61 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

62 
	#DIRECT_BLOCK
 ((
šode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) / \

63 
šode
->
i_sb
->
s_blocksize
)

	)

64 
dœeù_block
 = 
DIRECT_BLOCK
;

66 
»³©
:

67 
i
 = 
dœeù_block
 ; i < 
EXT2_NDIR_BLOCKS
 ; i++) {

68 
p
 = 
šode
->
u
.
ext2_i
.
i_d©a
 + 
i
;

69 
tmp
 = *
p
;

70 ià(!
tmp
)

72 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SECRM_FL
)

73 
bh
 = 
	`g‘blk
 (
šode
->
i_dev
, 
tmp
,

74 
šode
->
i_sb
->
s_blocksize
);

76 
bh
 = 
	`g‘_hash_bË
 (
šode
->
i_dev
, 
tmp
,

77 
šode
->
i_sb
->
s_blocksize
);

78 ià(
i
 < 
dœeù_block
) {

79 
	`b»l£
 (
bh
);

80 
»³©
;

82 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
p
) {

83 
»Œy
 = 1;

84 
	`b»l£
 (
bh
);

87 *
p
 = 0;

88 
šode
->
i_blocks
 -ğ
blocks
;

89 
šode
->
i_dœt
 = 1;

90 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SECRM_FL
) {

91 
	`ş—r_block
 (
bh
->
b_d©a
, 
šode
->
i_sb
->
s_blocksize
,

92 
RANDOM_INT
);

93 
bh
->
b_dœt
 = 1;

95 
	`b»l£
 (
bh
);

96 ià(
ä“_couÁ
 == 0) {

97 
block_to_ä“
 = 
tmp
;

98 
ä“_couÁ
++;

99 } ià(
ä“_couÁ
 > 0 && 
block_to_ä“
 =ğ
tmp
 - free_count)

100 
ä“_couÁ
++;

102 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
block_to_ä“
, 
ä“_couÁ
);

103 
block_to_ä“
 = 
tmp
;

104 
ä“_couÁ
 = 1;

108 ià(
ä“_couÁ
 > 0)

109 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
block_to_ä“
, 
ä“_couÁ
);

110  
»Œy
;

111 
	}
}

113 
	$Œunc_šdœeù
 (
šode
 * inode, 
off£t
, * 
p
)

115 
i
, 
tmp
;

116 
bufãr_h—d
 * 
bh
;

117 
bufãr_h—d
 * 
šd_bh
;

118 * 
šd
;

119 
block_to_ä“
 = 0;

120 
ä“_couÁ
 = 0;

121 
»Œy
 = 0;

122 
addr_³r_block
 = 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
);

123 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

124 
	#INDIRECT_BLOCK
 (()
DIRECT_BLOCK
 - 
off£t
)

	)

125 
šdœeù_block
 = 
INDIRECT_BLOCK
;

127 
tmp
 = *
p
;

128 ià(!
tmp
)

130 
šd_bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
tmp
, inode->
i_sb
->
s_blocksize
);

131 ià(
tmp
 !ğ*
p
) {

132 
	`b»l£
 (
šd_bh
);

135 ià(!
šd_bh
) {

136 *
p
 = 0;

139 
»³©
:

140 
i
 = 
šdœeù_block
 ; i < 
addr_³r_block
 ; i++) {

141 ià(
i
 < 0)

142 
i
 = 0;

143 ià(
i
 < 
šdœeù_block
)

144 
»³©
;

145 
šd
 = 
i
 + (*è
šd_bh
->
b_d©a
;

146 
tmp
 = *
šd
;

147 ià(!
tmp
)

149 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SECRM_FL
)

150 
bh
 = 
	`g‘blk
 (
šode
->
i_dev
, 
tmp
,

151 
šode
->
i_sb
->
s_blocksize
);

153 
bh
 = 
	`g‘_hash_bË
 (
šode
->
i_dev
, 
tmp
,

154 
šode
->
i_sb
->
s_blocksize
);

155 ià(
i
 < 
šdœeù_block
) {

156 
	`b»l£
 (
bh
);

157 
»³©
;

159 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
šd
) {

160 
»Œy
 = 1;

161 
	`b»l£
 (
bh
);

164 *
šd
 = 0;

165 
šd_bh
->
b_dœt
 = 1;

166 ià(
šode
->
u
.
ext2_i
.
i_æags
 & 
EXT2_SECRM_FL
) {

167 
	`ş—r_block
 (
bh
->
b_d©a
, 
šode
->
i_sb
->
s_blocksize
,

168 
RANDOM_INT
);

169 
bh
->
b_dœt
 = 1;

171 
	`b»l£
 (
bh
);

172 ià(
ä“_couÁ
 == 0) {

173 
block_to_ä“
 = 
tmp
;

174 
ä“_couÁ
++;

175 } ià(
ä“_couÁ
 > 0 && 
block_to_ä“
 =ğ
tmp
 - free_count)

176 
ä“_couÁ
++;

178 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
block_to_ä“
, 
ä“_couÁ
);

179 
block_to_ä“
 = 
tmp
;

180 
ä“_couÁ
 = 1;

183 
šode
->
i_blocks
 -ğ
blocks
;

184 
šode
->
i_dœt
 = 1;

186 ià(
ä“_couÁ
 > 0)

187 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
block_to_ä“
, 
ä“_couÁ
);

188 
šd
 = (*è
šd_bh
->
b_d©a
;

189 
i
 = 0; i < 
addr_³r_block
; i++)

190 ià(*(
šd
++))

192 ià(
i
 >ğ
addr_³r_block
)

193 ià(
šd_bh
->
b_couÁ
 != 1)

194 
»Œy
 = 1;

196 
tmp
 = *
p
;

197 *
p
 = 0;

198 
šode
->
i_blocks
 -ğ
blocks
;

199 
šode
->
i_dœt
 = 1;

200 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
tmp
, 1);

202 ià(
	`IS_SYNC
(
šode
è&& 
šd_bh
->
b_dœt
) {

203 
	`Î_rw_block
 (
WRITE
, 1, &
šd_bh
);

204 
	`wa™_Ú_bufãr
 (
šd_bh
);

206 
	`b»l£
 (
šd_bh
);

207  
»Œy
;

208 
	}
}

210 
	$Œunc_dšdœeù
 (
šode
 * inode, 
off£t
,

211 * 
p
)

213 
i
, 
tmp
;

214 
bufãr_h—d
 * 
dšd_bh
;

215 * 
dšd
;

216 
»Œy
 = 0;

217 
addr_³r_block
 = 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
);

218 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

219 
	#DINDIRECT_BLOCK
 ((()
DIRECT_BLOCK
 - 
off£t
è/ 
addr_³r_block
)

	)

220 
dšdœeù_block
 = 
DINDIRECT_BLOCK
;

222 
tmp
 = *
p
;

223 ià(!
tmp
)

225 
dšd_bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
tmp
, inode->
i_sb
->
s_blocksize
);

226 ià(
tmp
 !ğ*
p
) {

227 
	`b»l£
 (
dšd_bh
);

230 ià(!
dšd_bh
) {

231 *
p
 = 0;

234 
»³©
:

235 
i
 = 
dšdœeù_block
 ; i < 
addr_³r_block
 ; i++) {

236 ià(
i
 < 0)

237 
i
 = 0;

238 ià(
i
 < 
dšdœeù_block
)

239 
»³©
;

240 
dšd
 = 
i
 + (*è
dšd_bh
->
b_d©a
;

241 
tmp
 = *
dšd
;

242 ià(!
tmp
)

244 
»Œy
 |ğ
	`Œunc_šdœeù
 (
šode
, 
off£t
 + (
i
 * 
addr_³r_block
),

245 
dšd
);

246 
dšd_bh
->
b_dœt
 = 1;

248 
dšd
 = (*è
dšd_bh
->
b_d©a
;

249 
i
 = 0; i < 
addr_³r_block
; i++)

250 ià(*(
dšd
++))

252 ià(
i
 >ğ
addr_³r_block
)

253 ià(
dšd_bh
->
b_couÁ
 != 1)

254 
»Œy
 = 1;

256 
tmp
 = *
p
;

257 *
p
 = 0;

258 
šode
->
i_blocks
 -ğ
blocks
;

259 
šode
->
i_dœt
 = 1;

260 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
tmp
, 1);

262 ià(
	`IS_SYNC
(
šode
è&& 
dšd_bh
->
b_dœt
) {

263 
	`Î_rw_block
 (
WRITE
, 1, &
dšd_bh
);

264 
	`wa™_Ú_bufãr
 (
dšd_bh
);

266 
	`b»l£
 (
dšd_bh
);

267  
»Œy
;

268 
	}
}

270 
	$Œunc_tšdœeù
 (
šode
 * inode)

272 
i
, 
tmp
;

273 
bufãr_h—d
 * 
tšd_bh
;

274 * 
tšd
, * 
p
;

275 
»Œy
 = 0;

276 
addr_³r_block
 = 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
);

277 
blocks
 = 
šode
->
i_sb
->
s_blocksize
 / 512;

278 
	#TINDIRECT_BLOCK
 ((()
DIRECT_BLOCK
 - (
addr_³r_block
 *‡ddr_per_block + \

279 
addr_³r_block
 + 
EXT2_NDIR_BLOCKS
)) / \

280 (
addr_³r_block
 *‡ddr_³r_block))

	)

281 
tšdœeù_block
 = 
TINDIRECT_BLOCK
;

283 
p
 = 
šode
->
u
.
ext2_i
.
i_d©a
 + 
EXT2_TIND_BLOCK
;

284 ià(!(
tmp
 = *
p
))

286 
tšd_bh
 = 
	`b»ad
 (
šode
->
i_dev
, 
tmp
, inode->
i_sb
->
s_blocksize
);

287 ià(
tmp
 !ğ*
p
) {

288 
	`b»l£
 (
tšd_bh
);

291 ià(!
tšd_bh
) {

292 *
p
 = 0;

295 
»³©
:

296 
i
 = 
tšdœeù_block
 ; i < 
addr_³r_block
 ; i++) {

297 ià(
i
 < 0)

298 
i
 = 0;

299 ià(
i
 < 
tšdœeù_block
)

300 
»³©
;

301 
tšd
 = 
i
 + (*è
tšd_bh
->
b_d©a
;

302 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
, 
EXT2_NDIR_BLOCKS
 +

303 
addr_³r_block
 + (
i
 + 1) *‡ddr_per_block *‡ddr_per_block,

304 
tšd
);

305 
tšd_bh
->
b_dœt
 = 1;

307 
tšd
 = (*è
tšd_bh
->
b_d©a
;

308 
i
 = 0; i < 
addr_³r_block
; i++)

309 ià(*(
tšd
++))

311 ià(
i
 >ğ
addr_³r_block
)

312 ià(
tšd_bh
->
b_couÁ
 != 1)

313 
»Œy
 = 1;

315 
tmp
 = *
p
;

316 *
p
 = 0;

317 
šode
->
i_blocks
 -ğ
blocks
;

318 
šode
->
i_dœt
 = 1;

319 
	`ext2_ä“_blocks
 (
šode
->
i_sb
, 
tmp
, 1);

321 ià(
	`IS_SYNC
(
šode
è&& 
tšd_bh
->
b_dœt
) {

322 
	`Î_rw_block
 (
WRITE
, 1, &
tšd_bh
);

323 
	`wa™_Ú_bufãr
 (
tšd_bh
);

325 
	`b»l£
 (
tšd_bh
);

326  
»Œy
;

327 
	}
}

329 
	$ext2_Œunÿ‹
 (
šode
 * inode)

331 
»Œy
;

333 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

334 
	`S_ISLNK
(
šode
->
i_mode
)))

336 
	`ext2_disÿrd_´—Îoc
(
šode
);

338 
»Œy
 = 
	`Œunc_dœeù
(
šode
);

339 
»Œy
 |ğ
	`Œunc_šdœeù
 (
šode
, 
EXT2_IND_BLOCK
,

340 (*è&
šode
->
u
.
ext2_i
.
i_d©a
[
EXT2_IND_BLOCK
]);

341 
»Œy
 |ğ
	`Œunc_dšdœeù
 (
šode
, 
EXT2_IND_BLOCK
 +

342 
	`EXT2_ADDR_PER_BLOCK
(
šode
->
i_sb
),

343 (*è&
šode
->
u
.
ext2_i
.
i_d©a
[
EXT2_DIND_BLOCK
]);

344 
»Œy
 |ğ
	`Œunc_tšdœeù
 (
šode
);

345 ià(!
»Œy
)

347 ià(
	`IS_SYNC
(
šode
è&& inode->
i_dœt
)

348 
	`ext2_sync_šode
 (
šode
);

349 
cu¼’t
->
couÁ”
 = 0;

350 
	`scheduË
 ();

352 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

353 
šode
->
i_dœt
 = 1;

354 
	}
}

	@fs/fcntl.c

7 
	~<asm/£gm’t.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/fú.h
>

14 
	~<lšux/¡ršg.h
>

16 
fú_g‘lk
(, 
æock
 *);

17 
fú_£k
(, , 
æock
 *);

18 
sock_fú
 (
fe
 *, 
cmd
, 
¬g
);

20 
	$dupfd
(
fd
, 
¬g
)

22 ià(
fd
 >ğ
NR_OPEN
 || !
cu¼’t
->
fp
[fd])

23  -
EBADF
;

24 ià(
¬g
 >ğ
NR_OPEN
)

25  -
EINVAL
;

26 
¬g
 < 
NR_OPEN
)

27 ià(
cu¼’t
->
fp
[
¬g
])

28 
¬g
++;

31 ià(
¬g
 >ğ
NR_OPEN
)

32  -
EMFILE
;

33 
	`FD_CLR
(
¬g
, &
cu¼’t
->
şo£_Ú_exec
);

34 (
cu¼’t
->
fp
[
¬g
] = cu¼’t->fp[
fd
])->
f_couÁ
++;

35  
¬g
;

36 
	}
}

38 
asmlškage
 
	$sys_dup2
(
Şdfd
, 
Ãwfd
)

40 ià(
Şdfd
 >ğ
NR_OPEN
 || !
cu¼’t
->
fp
[oldfd])

41  -
EBADF
;

42 ià(
Ãwfd
 =ğ
Şdfd
)

43  
Ãwfd
;

48 ià(
Ãwfd
 > 
NR_OPEN
)

49  -
EBADF
;

51 ià(
Ãwfd
 =ğ
NR_OPEN
)

52  -
EBADF
;

57 
	`sys_şo£
(
Ãwfd
);

58  
	`dupfd
(
Şdfd
,
Ãwfd
);

59 
	}
}

61 
asmlškage
 
	$sys_dup
(
fdes
)

63  
	`dupfd
(
fdes
,0);

64 
	}
}

66 
asmlškage
 
	$sys_fú
(
fd
, 
cmd
, 
¬g
)

68 
fe
 * 
fp
;

70 ià(
fd
 >ğ
NR_OPEN
 || !(
fp
 = 
cu¼’t
->filp[fd]))

71  -
EBADF
;

72 
cmd
) {

73 
F_DUPFD
:

74  
	`dupfd
(
fd
,
¬g
);

75 
F_GETFD
:

76  
	`FD_ISSET
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

77 
F_SETFD
:

78 ià(
¬g
&1)

79 
	`FD_SET
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

81 
	`FD_CLR
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

83 
F_GETFL
:

84  
fp
->
f_æags
;

85 
F_SETFL
:

86 
fp
->
f_æags
 &ğ~(
O_APPEND
 | 
O_NONBLOCK
);

87 
fp
->
f_æags
 |ğ
¬g
 & (
O_APPEND
 | 
O_NONBLOCK
);

89 
F_GETLK
:

90  
	`fú_g‘lk
(
fd
, (
æock
 *è
¬g
);

91 
F_SETLK
:

92  
	`fú_£k
(
fd
, 
cmd
, (
æock
 *è
¬g
);

93 
F_SETLKW
:

94  
	`fú_£k
(
fd
, 
cmd
, (
æock
 *è
¬g
);

97 ià(
	`S_ISSOCK
 (
fp
->
f_šode
->
i_mode
))

99  (
	`sock_fú
 (
fp
, 
cmd
, 
¬g
));

101  -
EINVAL
;

103 
	}
}

	@fs/fifo.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/fú.h
>

12 
	$fifo_İ’
(
šode
 * inode,
fe
 * 
fp
)

14 
»tv®
 = 0;

15 
·ge
;

17  
fp
->
f_mode
 ) {

25 
fp
->
f_İ
 = &
cÚÃùšg_fifo_fİs
;

26 ià(!
	`PIPE_READERS
(*
šode
)++)

27 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

28 ià(!(
fp
->
f_æags
 & 
O_NONBLOCK
è&& !
	`PIPE_WRITERS
(*
šode
)) {

29 
	`PIPE_RD_OPENERS
(*
šode
)++;

30 !
	`PIPE_WRITERS
(*
šode
)) {

31 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

32 
»tv®
 = -
ERESTARTSYS
;

35 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

37 ià(!--
	`PIPE_RD_OPENERS
(*
šode
))

38 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

40 
	`PIPE_WR_OPENERS
(*
šode
))

41 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

42 ià(
	`PIPE_WRITERS
(*
šode
))

43 
fp
->
f_İ
 = &
»ad_fifo_fİs
;

44 ià(
»tv®
 && !--
	`PIPE_READERS
(*
šode
))

45 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

54 ià((
fp
->
f_æags
 & 
O_NONBLOCK
è&& !
	`PIPE_READERS
(*
šode
)) {

55 
»tv®
 = -
ENXIO
;

58 
fp
->
f_İ
 = &
wr™e_fifo_fİs
;

59 ià(!
	`PIPE_WRITERS
(*
šode
)++)

60 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

61 ià(!
	`PIPE_READERS
(*
šode
)) {

62 
	`PIPE_WR_OPENERS
(*
šode
)++;

63 !
	`PIPE_READERS
(*
šode
)) {

64 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

65 
»tv®
 = -
ERESTARTSYS
;

68 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

70 ià(!--
	`PIPE_WR_OPENERS
(*
šode
))

71 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

73 
	`PIPE_RD_OPENERS
(*
šode
))

74 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

75 ià(
»tv®
 && !--
	`PIPE_WRITERS
(*
šode
))

76 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

86 
fp
->
f_İ
 = &
rdwr_fifo_fİs
;

87 ià(!
	`PIPE_READERS
(*
šode
)++)

88 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

89 
	`PIPE_WR_OPENERS
(*
šode
))

90 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

91 ià(!
	`PIPE_WRITERS
(*
šode
)++)

92 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

93 
	`PIPE_RD_OPENERS
(*
šode
))

94 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

98 
»tv®
 = -
EINVAL
;

100 ià(
»tv®
 || 
	`PIPE_BASE
(*
šode
))

101  
»tv®
;

102 
·ge
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

103 ià(
	`PIPE_BASE
(*
šode
)) {

104 
	`ä“_·ge
(
·ge
);

107 ià(!
·ge
)

108  -
ENOMEM
;

109 
	`PIPE_LOCK
(*
šode
) = 0;

110 
	`PIPE_START
(*
šode
èğ
	`PIPE_LEN
(*inode) = 0;

111 
	`PIPE_BASE
(*
šode
èğ(*è
·ge
;

113 
	}
}

120 
fe_İ”©iÚs
 
	gdef_fifo_fİs
 = {

121 
NULL
,

122 
NULL
,

123 
NULL
,

124 
NULL
,

125 
NULL
,

126 
NULL
,

127 
NULL
,

128 
fifo_İ’
,

129 
NULL
,

130 
NULL


133 
šode_İ”©iÚs
 
	gfifo_šode_İ”©iÚs
 = {

134 &
def_fifo_fİs
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NULL
,

139 
NULL
,

140 
NULL
,

141 
NULL
,

142 
NULL
,

143 
NULL
,

144 
NULL
,

145 
NULL
,

146 
NULL
,

147 
NULL
,

148 
NULL


151 
	$š™_fifo
(
šode
 * inode)

153 
šode
->
i_İ
 = &
fifo_šode_İ”©iÚs
;

154 
šode
->
i_pe
 = 1;

155 
	`PIPE_LOCK
(*
šode
) = 0;

156 
	`PIPE_BASE
(*
šode
èğ
NULL
;

157 
	`PIPE_START
(*
šode
èğ
	`PIPE_LEN
(*inode) = 0;

158 
	`PIPE_RD_OPENERS
(*
šode
èğ
	`PIPE_WR_OPENERS
(*inode) = 0;

159 
	`PIPE_WAIT
(*
šode
èğ
NULL
;

160 
	`PIPE_READERS
(*
šode
èğ
	`PIPE_WRITERS
(*inode) = 0;

161 
	}
}

	@fs/file_table.c

7 
	~<lšux/fs.h
>

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/mm.h
>

11 
fe
 * 
	gfœ¡_fe
;

12 
	gÄ_fes
 = 0;

14 
	$š£¹_fe_ä“
(
fe
 *file)

16 
fe
->
f_Ãxt
 = 
fœ¡_fe
;

17 
fe
->
f_´ev
 = 
fœ¡_fe
->f_prev;

18 
fe
->
f_Ãxt
->
f_´ev
 = file;

19 
fe
->
f_´ev
->
f_Ãxt
 = file;

20 
fœ¡_fe
 = 
fe
;

21 
	}
}

23 
	$»move_fe_ä“
(
fe
 *file)

25 ià(
fœ¡_fe
 =ğ
fe
)

26 
fœ¡_fe
 = fœ¡_fe->
f_Ãxt
;

27 ià(
fe
->
f_Ãxt
)

28 
fe
->
f_Ãxt
->
f_´ev
 = file->f_prev;

29 ià(
fe
->
f_´ev
)

30 
fe
->
f_´ev
->
f_Ãxt
 = file->f_next;

31 
fe
->
f_Ãxt
 = fe->
f_´ev
 = 
NULL
;

32 
	}
}

34 
	$put_Ï¡_ä“
(
fe
 *file)

36 
	`»move_fe_ä“
(
fe
);

37 
fe
->
f_´ev
 = 
fœ¡_fe
->f_prev;

38 
fe
->
f_´ev
->
f_Ãxt
 = file;

39 
fe
->
f_Ãxt
 = 
fœ¡_fe
;

40 
fe
->
f_Ãxt
->
f_´ev
 = file;

41 
	}
}

43 
	$grow_fes
()

45 
fe
 * file;

46 
i
;

48 
fe
 = (f*è
	`g‘_ä“_·ge
(
GFP_KERNEL
);

50 ià(!
fe
)

53 
Ä_fes
+=
i
ğ
PAGE_SIZE
/(
fe
);

55 ià(!
fœ¡_fe
)

56 
fe
->
f_Ãxt
 = fe->
f_´ev
 = 
fœ¡_fe
 = fe++, 
i
--;

58 ; 
i
 ; i--)

59 
	`š£¹_fe_ä“
(
fe
++);

60 
	}
}

62 
	$fe_bË_š™
(
¡¬t
, 
’d
)

64 
fœ¡_fe
 = 
NULL
;

65  
¡¬t
;

66 
	}
}

68 
fe
 * 
	$g‘_em±y_fp
()

70 
i
;

71 
fe
 * 
f
;

73 ià(!
fœ¡_fe
)

74 
	`grow_fes
();

75 
»³©
:

76 
f
 = 
fœ¡_fe
, 
i
=0; i < 
Ä_fes
; i++, f = f->
f_Ãxt
)

77 ià(!
f
->
f_couÁ
) {

78 
	`»move_fe_ä“
(
f
);

79 
	`mem£t
(
f
,0,(*f));

80 
	`put_Ï¡_ä“
(
f
);

81 
f
->
f_couÁ
 = 1;

82  
f
;

84 ià(
Ä_fes
 < 
NR_FILE
) {

85 
	`grow_fes
();

86 
»³©
;

88  
NULL
;

89 
	}
}

	@fs/filesystems.c

9 
	~<lšux/cÚfig.h
>

10 
	~<lšux/fs.h
>

11 #ifdeà
CONFIG_MINIX_FS


12 
	~<lšux/mšix_fs.h
>

14 #ifdeà
CONFIG_XIA_FS


15 
	~<lšux/xŸ_fs.h
>

17 #ifdeà
CONFIG_PROC_FS


18 
	~<lšux/´oc_fs.h
>

20 #ifdeà
CONFIG_EXT2_FS


21 
	~<lšux/ext2_fs.h
>

23 #ifdeà
CONFIG_EXT_FS


24 
	~<lšux/ext_fs.h
>

26 #ifdeà
CONFIG_MSDOS_FS


27 
	~<lšux/msdos_fs.h
>

29 #ifdeà
CONFIG_NFS_FS


30 
	~<lšux/nfs_fs.h
>

32 #ifdeà
CONFIG_ISO9660_FS


33 
	~<lšux/iso_fs.h
>

35 #ifdeà
CONFIG_HPFS_FS


36 
	~<lšux/hpfs_fs.h
>

38 #ifdeà
CONFIG_SYSV_FS


39 
	~<lšux/sysv_fs.h
>

42 
fe_sy¡em_ty³
 
	gfe_sy¡ems
[] = {

43 #ifdeà
CONFIG_MINIX_FS


44 {
mšix_»ad_su³r
, "minix", 1},

46 #ifdeà
CONFIG_EXT_FS


47 {
ext_»ad_su³r
, "ext", 1},

49 #ifdeà
CONFIG_EXT2_FS


50 {
ext2_»ad_su³r
, "ext2", 1},

52 #ifdeà
CONFIG_XIA_FS


53 {
xŸfs_»ad_su³r
, "xiafs", 1},

55 #ifdeà
CONFIG_MSDOS_FS


56 {
msdos_»ad_su³r
, "msdos", 1},

58 #ifdeà
CONFIG_PROC_FS


59 {
´oc_»ad_su³r
, "proc", 0},

61 #ifdeà
CONFIG_NFS_FS


62 {
nfs_»ad_su³r
, "nfs", 0},

64 #ifdeà
CONFIG_ISO9660_FS


65 {
isofs_»ad_su³r
, "iso9660", 1},

67 #ifdeà
CONFIG_SYSV_FS


68 {
sysv_»ad_su³r
, "xenix", 1},

69 {
sysv_»ad_su³r
, "sysv", 1},

70 {
sysv_»ad_su³r
, "coherent", 1},

72 #ifdeà
CONFIG_HPFS_FS


73 {
hpfs_»ad_su³r
, "hpfs", 1},

75 {
NULL
, NULL, 0}

	@fs/hpfs/hpfs.h

16 
	t£úo
;

18 
£úo
 
	tdnode_£úo
;

19 
£úo
 
	tâode_£úo
;

20 
£úo
 
	tªode_£úo
;

27 
	shpfs_boÙ_block


29 
	mjmp
[3];

30 
	mÛm_id
[8];

31 
	mby‹s_³r_£ùÜ
[2];

32 
	m£ùÜs_³r_şu¡”
;

33 
	mn_»£rved_£ùÜs
[2];

34 
	mn_çts
;

35 
	mn_roÙdœ_’Œ›s
[2];

36 
	mn_£ùÜs_s
[2];

37 
	mmedŸ_by‹
;

38 
	m£ùÜs_³r_çt
;

39 
	m£ùÜs_³r_Œack
;

40 
	mh—ds_³r_cyl
;

41 
	mn_hidd’_£ùÜs
;

42 
	mn_£ùÜs_l
;

43 
	mdrive_numb”
;

44 
	mmbz
;

45 
	msig_28h
;

46 
	mvŞ_£ºo
[4];

47 
	mvŞ_Ïb–
[11];

48 
	msig_hpfs
[8];

49 
	m·d
[448];

50 
	mmagic
;

58 
	#SB_MAGIC
 0xf995e849

	)

60 
	shpfs_su³r_block


62 
	mmagic
;

63 
	mmagic1
;

64 
	mhuh202
;

65 
âode_£úo
 
	mroÙ
;

66 
£úo
 
	mn_£ùÜs
;

67 
	mn_badblocks
;

68 
£úo
 
	mb™m­s
;

69 
	mz”o1
;

70 
£úo
 
	mbadblocks
;

71 
	mz”o3
;

72 
time_t
 
	mÏ¡_chkdsk
;

73 
	mz”o4
;

74 
£úo
 
	mn_dœ_bªd
;

75 
£úo
 
	mdœ_bªd_¡¬t
;

76 
£úo
 
	mdœ_bªd_’d
;

77 
£úo
 
	mdœ_bªd_b™m­
;

78 
	mz”o5
[8];

79 
£úo
 
	msü©ch_dnodes
;

81 
	mz”o6
[103];

89 
	#SP_MAGIC
 0xf9911849

	)

91 
	shpfs_¥¬e_block


93 
	mmagic
;

94 
	mmagic1
;

95 
	mdœty
;

97 
£úo
 
	mhÙfix_m­
;

98 
	mn_¥¬es_u£d
;

99 
	mn_¥¬es
;

100 
	mn_dnode_¥¬es_ä“
;

101 
	mn_dnode_¥¬es
;

103 
£úo
 
	mcode_·ge_dœ
;

104 
	mn_code_·ges
;

105 
	mÏrge_numb”s
[2];

106 
	mz”o1
[15];

107 
dnode_£úo
 
	m¥¬e_dnodes
[20];

108 
	mz”o2
[81];

115 
	#BAD_MAGIC
 0

	)

138 
	#CP_DIR_MAGIC
 0x494521f7

	)

140 
	scode_·ge_dœeùÜy


142 
	mmagic
;

143 
	mn_code_·ges
;

144 
	mz”o1
[2];

146 
	mix
;

147 
	mcode_·ge_numb”
;

148 
	mbounds
;

150 
£úo
 
	mcode_·ge_d©a
;

152 
	mšdex
;

153 } 
	m¬¿y
[31];

158 
	#CP_DATA_MAGIC
 0x894521f7

	)

160 
	scode_·ge_d©a


162 
	mmagic
;

163 
	mn_u£d
;

164 
	mbounds
[3];

167 
	moffs
[3];

170 
	mix
;

171 
	mcode_·ge_numb”
;

172 
	mz”o1
;

173 
	mm­
[128];

174 
	mz”o2
;

175 } 
	mcode_·ge
[3];

176 
	mšcogn™a
[78];

213 
	#DNODE_MAGIC
 0x77e40¯e

	)

215 
	sdnode
 {

216 
	mmagic
;

217 
	mfœ¡_ä“
;

219 
	mšüem’t_me
;

222 
£úo
 
	mup
;

224 
dnode_£úo
 
	m£lf
;

225 
	mdœ’t
[2028];

228 
	shpfs_dœ’t
 {

229 
	mËngth
;

230 
	mfœ¡
: 1;

231 
	mæag1
: 1;

232 
	mdown
: 1;

233 
	mÏ¡
: 1;

234 
	mæag4
: 1;

235 
	mæag5
: 1;

236 
	mæag6
: 1;

237 
	mhas_Ãed—
: 1;

240 
	m»ad_Úly
: 1;

241 
	mhidd’
: 1;

242 
	msy¡em
: 1;

243 
	mæag11
: 1;

244 
	mdœeùÜy
: 1;

245 
	m¬chive
: 1;

246 
	mnÙ_8x3
: 1;

247 
	mæag15
: 1;

248 
âode_£úo
 
	mâode
;

249 
time_t
 
	mwr™e_d©e
;

250 
	mfe_size
;

251 
time_t
 
	m»ad_d©e
;

252 
time_t
 
	mü—tiÚ_d©e
;

253 
	m—_size
;

254 
	mz”o1
;

255 
	mloÿl™y
;

256 
	mÇm–’
, 
	mÇme
[1];

264 
šlše
 
dnode_£úo
 
	$de_down_poš‹r
 (
hpfs_dœ’t
 *
de
)

266  *(
dnode_£úo
 *è((*è
de
 + de->
Ëngth
 - 4);

267 
	}
}

271 
šlše
 
hpfs_dœ’t
 *
	$dnode_fœ¡_de
 (
dnode
 *dnode)

273  (*è
dnode
->
dœ’t
;

274 
	}
}

278 
šlše
 
hpfs_dœ’t
 *
	$dnode_’d_de
 (
dnode
 *dnode)

280  (*è
dnode
 + dnode->
fœ¡_ä“
;

281 
	}
}

285 
šlše
 
hpfs_dœ’t
 *
	$de_Ãxt_de
 (
hpfs_dœ’t
 *
de
)

287  (*è
de
 + de->
Ëngth
;

288 
	}
}

302 
	sb¶us_Ëaf_node


304 
	mfe_£úo
;

305 
	mËngth
;

306 
£úo
 
	mdisk_£úo
;

309 
	sb¶us_š‹º®_node


311 
	mfe_£úo
;

312 
ªode_£úo
 
	mdown
;

315 
	sb¶us_h—d”


317 
	mæag0
: 1;

318 
	mæag1
: 1;

319 
	mæag2
: 1;

320 
	mæag3
: 1;

321 
	mæag4
: 1;

322 
	mâode_·»Á
: 1;

329 
	mæag6
: 1;

330 
	mš‹º®
: 1;

332 
	mfl
[3];

333 
	mn_ä“_nodes
;

334 
	mn_u£d_nodes
;

335 
	mfœ¡_ä“
;

338 
b¶us_š‹º®_node
 
	mš‹º®
[0];

340 
b¶us_Ëaf_node
 
	mex‹º®
[0];

342 } 
	mu
;

351 
	#FNODE_MAGIC
 0xf7e40¯e

	)

353 
	sâode


355 
	mmagic
;

356 
	mz”o1
[2];

357 
	mËn
, 
	mÇme
[15];

358 
âode_£úo
 
	mup
;

359 
	mz”o2
[3];

360 
	m—_size_l
;

361 
£úo
 
	m—_£úo
;

362 
	m—_size_s
;

364 
	mæag0
: 1;

365 
	m—_ªode
: 1;

366 
	mæag2
: 1;

367 
	mæag3
: 1;

368 
	mæag4
: 1;

369 
	mæag5
: 1;

370 
	mæag6
: 1;

371 
	mæag7
: 1;

372 
	mdœæag
: 1;

374 
	mæag9
: 1;

375 
	mæag10
: 1;

376 
	mæag11
: 1;

377 
	mæag12
: 1;

378 
	mæag13
: 1;

379 
	mæag14
: 1;

380 
	mæag15
: 1;

382 
b¶us_h—d”
 
	mbŒ“
;

384 
b¶us_Ëaf_node
 
	mex‹º®
[8];

385 
b¶us_š‹º®_node
 
	mš‹º®
[12];

386 } 
	mu
;

388 
	mfe_size
;

389 
	mn_Ãed—
;

390 
	mz”o4
[4];

391 
	m—_offs
;

393 
	mz”o5
[2];

394 
	m—
[316];

403 
	#ANODE_MAGIC
 0x37e40¯e

	)

405 
	sªode


407 
	mmagic
;

408 
ªode_£úo
 
	m£lf
;

409 
£úo
 
	mup
;

411 
b¶us_h—d”
 
	mbŒ“
;

413 
b¶us_Ëaf_node
 
	mex‹º®
[40];

414 
b¶us_š‹º®_node
 
	mš‹º®
[60];

415 } 
	mu
;

417 
	mfl
[3];

436 
	sex‹nded_©Œibu‹


438 
	mšdœeù
: 1;

440 
	mªode
: 1;

442 
	mæag2
: 1;

443 
	mæag3
: 1;

444 
	mæag4
: 1;

445 
	mæag5
: 1;

446 
	mæag6
: 1;

447 
	mÃed—
: 1;

448 
	mÇm–’
;

449 
	mv®u–’
;

462 
šlše
 *
	$—_Çme
 (
ex‹nded_©Œibu‹
 *
—
)

464  (*è
—
 +  *ea;

465 
	}
}

467 
šlše
 *
	$—_v®ue
 (
ex‹nded_©Œibu‹
 *
—
)

469  (*è
—
 +  *— +ƒa->
Çm–’
 + 1;

470 
	}
}

472 
šlše
 
ex‹nded_©Œibu‹
 *

473 
	$—_Ãxt_—
 (
ex‹nded_©Œibu‹
 *
—
)

475  (*è
—
 +  *— +ƒa->
Çm–’
 + 1 +ƒa->
v®u–’
;

476 
	}
}

478 
šlše
 
	$—_šdœeù_Ëngth
 (
ex‹nded_©Œibu‹
 *
—
)

480 *
v
 = (*è
	`—_v®ue
 (
—
);

481  
v
[0];

482 
	}
}

484 
šlše
 
£úo
 
	$—_šdœeù_£úo
 (
ex‹nded_©Œibu‹
 *
—
)

486 *
v
 = (*è
	`—_v®ue
 (
—
);

487  
v
[1];

488 
	}
}

	@fs/hpfs/hpfs_fs.c

15 
	~<lšux/fs.h
>

16 
	~<lšux/hpfs_fs.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/m®loc.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/locks.h
>

21 
	~<lšux/¡©.h
>

22 
	~<lšux/¡ršg.h
>

23 
	~<asm/b™İs.h
>

24 
	~<asm/£gm’t.h
>

26 
	~"hpfs.h
"

119 
	#l™e_ushÜt
(
x
è(*(*è&(x))

	)

120 
	tnÚcÚ¡
;

124 
hpfs_»ad_šode
(
šode
 *);

125 
hpfs_put_su³r
(
su³r_block
 *);

126 
hpfs_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

127 
hpfs_»mouÁ_fs
(
su³r_block
 *, *, *);

129 cÚ¡ 
su³r_İ”©iÚs
 
	ghpfs_sİs
 =

131 
hpfs_»ad_šode
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
hpfs_put_su³r
,

136 
NULL
,

137 
hpfs_¡©fs
,

138 
hpfs_»mouÁ_fs
,

143 
hpfs_fe_»ad
(
šode
 *, 
fe
 *, *, );

144 
£úo
 
hpfs_bm­
(
šode
 *, );

146 cÚ¡ 
fe_İ”©iÚs
 
	ghpfs_fe_İs
 =

148 
NULL
,

149 
hpfs_fe_»ad
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NULL
,

154 
g’”ic_mm­
,

155 
NULL
,

156 
NULL
,

157 
fe_fsync
,

160 cÚ¡ 
šode_İ”©iÚs
 
	ghpfs_fe_iİs
 =

162 (
nÚcÚ¡
 *è& 
hpfs_fe_İs
,

163 
NULL
,

164 
NULL
,

165 
NULL
,

166 
NULL
,

167 
NULL
,

168 
NULL
,

169 
NULL
,

170 
NULL
,

171 
NULL
,

172 
NULL
,

173 
NULL
,

174 ((*)(
šode
 *, ))

175 &
hpfs_bm­
,

176 
NULL
,

177 
NULL
,

182 
hpfs_dœ_»ad
(
šode
 *šode, 
fe
 *
fp
,

183 *
buf
, 
couÁ
);

184 
hpfs_»addœ
(
šode
 *šode, 
fe
 *
fp
,

185 
dœ’t
 *dœ’t, 
couÁ
);

186 
hpfs_lookup
(
šode
 *, const *, , inode **);

188 cÚ¡ 
fe_İ”©iÚs
 
	ghpfs_dœ_İs
 =

190 
NULL
,

191 
hpfs_dœ_»ad
,

192 
NULL
,

193 
hpfs_»addœ
,

194 
NULL
,

195 
NULL
,

196 
NULL
,

197 
NULL
,

198 
NULL
,

199 
fe_fsync
,

202 cÚ¡ 
šode_İ”©iÚs
 
	ghpfs_dœ_iİs
 =

204 (
nÚcÚ¡
 *è& 
hpfs_dœ_İs
,

205 
NULL
,

206 
hpfs_lookup
,

207 
NULL
,

208 
NULL
,

209 
NULL
,

210 
NULL
,

211 
NULL
,

212 
NULL
,

213 
NULL
,

214 
NULL
,

215 
NULL
,

216 
NULL
,

217 
NULL
,

218 
NULL
,

223 
	squad_bufãr_h—d
 {

224 
bufãr_h—d
 *
	mbh
[4];

225 *
	md©a
;

230 
·r£_İts
(*
İts
, 
uid_t
 *
uid
, 
gid_t
 *
gid
, 
umode_t
 *
umask
,

231 *
low”ÿ£
, *
cÚv
);

232 
check_w¬n
(
nÙ_ok
,

233 cÚ¡ *
p1
, cÚ¡ *
p2
, cÚ¡ *
p3
);

234 
z”İ
(*
addr
, 
Ën
);

235 
couÁ_dnodes
(
šode
 *šode, 
dnode_£úo
 
dno
,

236 *
n_dnodes
, *
n_subdœs
);

237 
couÁ_b™m­
(
su³r_block
 *
s
);

238 
couÁ_Úe_b™m­
(
dev_t
 
dev
, 
£úo
 secno);

239 
£úo
 
b¶us_lookup
(
šode
 *šode, 
b¶us_h—d”
 *
b
,

240 
£úo
 
fe_£úo
, 
bufãr_h—d
 **
bhp
);

241 
hpfs_dœ’t
 *
m­_dœ’t
(
šode
 *šode, 
dnode_£úo
 
dno
,

242 cÚ¡ *
Çme
, 
Ën
,

243 
quad_bufãr_h—d
 *
qbh
);

244 
hpfs_dœ’t
 *
m­_pos_dœ’t
(
šode
 *šode, 
off_t
 *
po¥
,

245 
quad_bufãr_h—d
 *
qbh
);

246 
wr™e_Úe_dœ’t
(
dœ’t
 *dœ’t, cÚ¡ *
Çme
,

247 
Çm–’
, 
šo_t
 
šo
, 
low”ÿ£
);

248 
dnode_£úo
 
dœ_subdno
(
šode
 *šode, 
pos
);

249 
hpfs_dœ’t
 *
m­_Áh_dœ’t
(
dev_t
 
dev
, 
dnode_£úo
 
dno
,

250 
n
,

251 
quad_bufãr_h—d
 *
qbh
);

252 
choo£_cÚv
(*
p
, 
Ën
);

253 
cÚvıy_tofs
(*
out
, *
š
,

254 
Ën
);

255 
dnode_£úo
 
âode_dno
(
dev_t
 
dev
, 
šo_t
 
šo
);

256 
âode
 *
m­_âode
(
dev_t
 
dev
, 
šo_t
 
šo
,

257 
bufãr_h—d
 **
bhp
);

258 
ªode
 *
m­_ªode
(
dev_t
 
dev
, 
£úo
,

259 
bufãr_h—d
 **
bhp
);

260 
dnode
 *
m­_dnode
(
dev_t
 
dev
, 
£úo
,

261 
quad_bufãr_h—d
 *
qbh
);

262 *
m­_£ùÜ
(
dev_t
 
dev
, 
£úo
, 
bufãr_h—d
 **
bhp
);

263 *
m­_4£ùÜs
(
dev_t
 
dev
, 
£úo
,

264 
quad_bufãr_h—d
 *
qbh
);

265 
b»l£4
(
quad_bufãr_h—d
 *
qbh
);

271 
šlše
 
šo_t
 
	$fe_šo
(
âode_£úo
 
£úo
)

273  
£úo
 << 1 | 1;

274 
	}
}

280 
šlše
 
šo_t
 
	$dœ_šo
(
âode_£úo
 
£úo
)

282  
£úo
 << 1;

283 
	}
}

289 
šlše
 
âode_£úo
 
	$šo_£úo
(
šo_t
 
šo
)

291  
šo
 >> 1;

292 
	}
}

298 
šlše
 
	$šo_is_dœ
(
šo_t
 
šo
)

300  (
šo
 & 1) == 0;

301 
	}
}

307 
	#CONV_BINARY
 0

	)

308 
	#CONV_TEXT
 1

	)

309 
	#CONV_AUTO
 2

	)

315 
šlše
 
time_t
 
	$loÿl_to_gmt
(
time_t
 
t
)

317 
timezÚe
 
sys_tz
;

318  
t
 + 
sys_tz
.
tz_mšu‹swe¡
 * 60;

319 
	}
}

328 
su³r_block
 *
	$hpfs_»ad_su³r
(
su³r_block
 *
s
,

329 *
İtiÚs
, 
s’t
)

331 
hpfs_boÙ_block
 *
boÙblock
;

332 
hpfs_su³r_block
 *
su³rblock
;

333 
hpfs_¥¬e_block
 *
¥¬eblock
;

334 
hpfs_dœ’t
 *
de
;

335 
bufãr_h—d
 *
bh0
, *
bh1
, *
bh2
;

336 
quad_bufãr_h—d
 
qbh
;

337 
dnode_£úo
 
roÙ_dno
;

338 
dev_t
 
dev
;

339 
uid_t
 
uid
;

340 
gid_t
 
gid
;

341 
umode_t
 
umask
;

342 
low”ÿ£
;

343 
cÚv
;

344 
dubious
;

350 ià(!
	`·r£_İts
(
İtiÚs
, &
uid
, &
gid
, &
umask
, &
low”ÿ£
, &
cÚv
)) {

351 
	`´štk
("HPFS: syntaxƒrror in mount options. Not mounted.\n");

352 
s
->
s_dev
 = 0;

360 
	`lock_su³r
(
s
);

361 
dev
 = 
s
->
s_dev
;

362 
	`£t_blocksize
(
dev
, 512);

368 
boÙblock
 = 
	`m­_£ùÜ
(
dev
, 0, &
bh0
);

369 ià(!
boÙblock
)

370 
ba
;

372 
su³rblock
 = 
	`m­_£ùÜ
(
dev
, 16, &
bh1
);

373 ià(!
su³rblock
)

374 
ba0
;

376 
¥¬eblock
 = 
	`m­_£ùÜ
(
dev
, 17, &
bh2
);

377 ià(!
¥¬eblock
)

378 
ba1
;

385 ià(
boÙblock
->
magic
 != 0xaa55

386 || 
su³rblock
->
magic
 !ğ
SB_MAGIC


387 || 
¥¬eblock
->
magic
 !ğ
SP_MAGIC


388 || 
boÙblock
->
sig_28h
 != 0x28

389 || 
	`memcmp
(&
boÙblock
->
sig_hpfs
, "HPFS ", 8)

390 || 
	`l™e_ushÜt
(
boÙblock
->
by‹s_³r_£ùÜ
) != 512) {

391 
	`´štk
("HPFS: hpfs_read_super: Not HPFS\n");

392 
ba2
;

400 
dubious
 = 0;

402 
dubious
 |ğ
	`check_w¬n
(
¥¬eblock
->
dœty
 != 0,

404 
dubious
 |ğ
	`check_w¬n
(
¥¬eblock
->
n_¥¬es_u£d
 != 0,

412 ià(
dubious
)

413 
ba2
;

415 
dubious
 |ğ
	`check_w¬n
((
¥¬eblock
->
n_dnode_¥¬es
 !=

416 
¥¬eblock
->
n_dnode_¥¬es_ä“
),

418 
dubious
 |ğ
	`check_w¬n
(
su³rblock
->
z”o1
 != 0,

420 
dubious
 |ğ
	`check_w¬n
(
su³rblock
->
z”o3
 != 0,

422 
dubious
 |ğ
	`check_w¬n
(
su³rblock
->
z”o4
 != 0,

424 
dubious
 |ğ
	`check_w¬n
(!
	`z”İ
(
su³rblock
->
z”o5
,

425  
su³rblock
->
z”o5
),

427 
dubious
 |ğ
	`check_w¬n
(!
	`z”İ
(
su³rblock
->
z”o6
,

428  
su³rblock
->
z”o6
),

431 ià(
dubious
)

432 
	`´štk
("HPFS: Proceeding, but operation may be unreliable\n");

438 
s
->
s_æags
 |ğ
MS_RDONLY
;

444 
s
->
s_magic
 = 
HPFS_SUPER_MAGIC
;

445 
s
->
s_blocksize
 = 512;

446 
s
->
s_blocksize_b™s
 = 9;

447 
s
->
s_İ
 = (
su³r_İ”©iÚs
 *è&
hpfs_sİs
;

453 
s
->
s_hpfs_roÙ
 = 
	`dœ_šo
(
su³rblock
->
roÙ
);

454 
s
->
s_hpfs_fs_size
 = 
su³rblock
->
n_£ùÜs
;

455 
s
->
s_hpfs_dœbªd_size
 = 
su³rblock
->
n_dœ_bªd
 / 4;

456 
s
->
s_hpfs_dm­
 = 
su³rblock
->
dœ_bªd_b™m­
;

457 
s
->
s_hpfs_b™m­s
 = 
su³rblock
->
b™m­s
;

458 
s
->
s_hpfs_uid
 = 
uid
;

459 
s
->
s_hpfs_gid
 = 
gid
;

460 
s
->
s_hpfs_mode
 = 0777 & ~
umask
;

461 
s
->
s_hpfs_n_ä“
 = -1;

462 
s
->
s_hpfs_n_ä“_dnodes
 = -1;

463 
s
->
s_hpfs_low”ÿ£
 = 
low”ÿ£
;

464 
s
->
s_hpfs_cÚv
 = 
cÚv
;

470 
	`b»l£
(
bh2
);

471 
	`b»l£
(
bh1
);

472 
	`b»l£
(
bh0
);

478 
s
->
s_mouÁed
 = 
	`ig‘
(s, s->
s_hpfs_roÙ
);

479 
	`uÆock_su³r
(
s
);

481 ià(!
s
->
s_mouÁed
) {

482 
	`´štk
("HPFS: hpfs_read_super: inode get failed\n");

483 
s
->
s_dev
 = 0;

491 
roÙ_dno
 = 
	`âode_dno
(
dev
, 
s
->
s_hpfs_roÙ
);

492 ià(
roÙ_dno
)

493 
de
 = 
	`m­_dœ’t
(
s
->
s_mouÁed
, 
roÙ_dno
, "\001\001", 2, &
qbh
);

494 ià(!
roÙ_dno
 || !
de
) {

495 
	`´štk
("HPFS: "

497 
s
->
s_dev
 = 0;

501 
s
->
s_mouÁed
->
i_©ime
 = 
	`loÿl_to_gmt
(
de
->
»ad_d©e
);

502 
s
->
s_mouÁed
->
i_mtime
 = 
	`loÿl_to_gmt
(
de
->
wr™e_d©e
);

503 
s
->
s_mouÁed
->
i_ùime
 = 
	`loÿl_to_gmt
(
de
->
ü—tiÚ_d©e
);

505 
	`b»l£4
(&
qbh
);

506  
s
;

508 
ba2
:

509 
	`b»l£
(
bh2
);

510 
ba1
:

511 
	`b»l£
(
bh1
);

512 
ba0
:

513 
	`b»l£
(
bh0
);

514 
ba
:

515 
s
->
s_dev
 = 0;

516 
	`uÆock_su³r
(
s
);

518 
	}
}

520 
	$check_w¬n
(
nÙ_ok
,

521 cÚ¡ *
p1
, cÚ¡ *
p2
, cÚ¡ *
p3
)

523 ià(
nÙ_ok
)

524 
	`´štk
("HPFS: % %s. PËa£ %s\n", 
p1
, 
p2
, 
p3
);

525  
nÙ_ok
;

526 
	}
}

528 
	$z”İ
(*
addr
, 
Ën
)

530 *
p
 = 
addr
;

531  
p
[0] =ğ0 && 
	`memcmp
Õ,… + 1, 
Ën
 - 1) == 0;

532 
	}
}

538 
	$·r£_İts
(*
İts
, 
uid_t
 *
uid
, 
gid_t
 *
gid
, 
umode_t
 *
umask
,

539 *
low”ÿ£
, *
cÚv
)

541 *
p
, *
rhs
;

543 *
uid
 = 
cu¼’t
->uid;

544 *
gid
 = 
cu¼’t
->gid;

545 *
umask
 = 
cu¼’t
->umask;

546 *
low”ÿ£
 = 1;

547 *
cÚv
 = 
CONV_BINARY
;

549 ià(!
İts
)

552 
p
 = 
	`¡¹ok
(
İts
, ",");… != 0;… = strtok(0, ",")) {

553 ià((
rhs
 = 
	`¡rchr
(
p
, '=')) != 0)

554 *
rhs
++ = '\0';

555 ià(!
	`¡rcmp
(
p
, "uid")) {

556 ià(!
rhs
 || !*rhs)

558 *
uid
 = 
	`sim¶e_¡¹oul
(
rhs
, &rhs, 0);

559 ià(*
rhs
)

562 ià(!
	`¡rcmp
(
p
, "gid")) {

563 ià(!
rhs
 || !*rhs)

565 *
gid
 = 
	`sim¶e_¡¹oul
(
rhs
, &rhs, 0);

566 ià(*
rhs
)

569 ià(!
	`¡rcmp
(
p
, "umask")) {

570 ià(!
rhs
 || !*rhs)

572 *
umask
 = 
	`sim¶e_¡¹oul
(
rhs
, &rhs, 8);

573 ià(*
rhs
)

576 ià(!
	`¡rcmp
(
p
, "case")) {

577 ià(!
	`¡rcmp
(
rhs
, "lower"))

578 *
low”ÿ£
 = 1;

579 ià(!
	`¡rcmp
(
rhs
, "asis"))

580 *
low”ÿ£
 = 0;

584 ià(!
	`¡rcmp
(
p
, "conv")) {

585 ià(!
	`¡rcmp
(
rhs
, "binary"))

586 *
cÚv
 = 
CONV_BINARY
;

587 ià(!
	`¡rcmp
(
rhs
, "text"))

588 *
cÚv
 = 
CONV_TEXT
;

589 ià(!
	`¡rcmp
(
rhs
, "auto"))

590 *
cÚv
 = 
CONV_AUTO
;

599 
	}
}

617 
	$hpfs_»ad_šode
(
šode
 *inode)

619 
su³r_block
 *
s
 = 
šode
->
i_sb
;

623 
šode
->
i_İ
 = 0;

624 
šode
->
i_mode
 = 0;

626 ià(
šode
->
i_šo
 == 0

627 || 
	`šo_£úo
(
šode
->
i_šo
è>ğšode->
i_sb
->
s_hpfs_fs_size
) {

628 
	`´štk
("HPFS:„ead_inode: bad ino\n");

636 
šode
->
i_uid
 = 
s
->
s_hpfs_uid
;

637 
šode
->
i_gid
 = 
s
->
s_hpfs_gid
;

638 
šode
->
i_mode
 = 
s
->
s_hpfs_mode
;

639 
šode
->
i_hpfs_cÚv
 = 
s
->
s_hpfs_cÚv
;

641 
šode
->
i_hpfs_dno
 = 0;

642 
šode
->
i_hpfs_n_£cs
 = 0;

643 
šode
->
i_hpfs_fe_£c
 = 0;

644 
šode
->
i_hpfs_disk_£c
 = 0;

645 
šode
->
i_hpfs_dpos
 = 0;

646 
šode
->
i_hpfs_dsubdno
 = 0;

652 ià(
	`šo_is_dœ
(
šode
->
i_šo
))

653 
šode
->
i_mode
 |ğ
S_IFDIR
;

655 
šode
->
i_mode
 |ğ
S_IFREG
;

656 
šode
->
i_mode
 &= ~0111;

665 
šode
->
i_©ime
 = 0;

666 
šode
->
i_mtime
 = 0;

667 
šode
->
i_ùime
 = 0;

668 
šode
->
i_size
 = 0;

674 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

676 
šode
->
i_İ
 = (
šode_İ”©iÚs
 *è&
hpfs_fe_iİs
;

677 
šode
->
i_Æšk
 = 1;

678 
šode
->
i_blksize
 = 512;

682 
n_dnodes
, 
n_subdœs
;

683 
bufãr_h—d
 *
bh0
;

684 
âode
 *âodğ
	`m­_âode
(
šode
->
i_dev
,

685 
šode
->
i_šo
, &
bh0
);

687 ià(!
âode
) {

688 
	`´štk
("HPFS:„ead_inode:‚o fnode\n");

689 
šode
->
i_mode
 = 0;

693 
šode
->
i_hpfs_·»Á_dœ
 = 
	`dœ_šo
(
âode
->
up
);

694 
šode
->
i_hpfs_dno
 = 
âode
->
u
.
ex‹º®
[0].
disk_£úo
;

696 
	`b»l£
(
bh0
);

698 
n_dnodes
 = 
n_subdœs
 = 0;

699 
	`couÁ_dnodes
(
šode
, inode->
i_hpfs_dno
, &
n_dnodes
, &
n_subdœs
);

701 
šode
->
i_İ
 = (
šode_İ”©iÚs
 *è&
hpfs_dœ_iİs
;

702 
šode
->
i_blksize
 = 512;

703 
šode
->
i_blocks
 = 4 * 
n_dnodes
;

704 
šode
->
i_size
 = 512 * inode->
i_blocks
;

705 
šode
->
i_Æšk
 = 2 + 
n_subdœs
;

707 
	}
}

713 
	$hpfs_put_su³r
(
su³r_block
 *
s
)

715 
	`lock_su³r
(
s
);

716 
s
->
s_dev
 = 0;

717 
	`uÆock_su³r
(
s
);

718 
	}
}

725 
	$hpfs_¡©fs
(
su³r_block
 *
s
, 
¡©fs
 *
buf
)

731 ià(
s
->
s_hpfs_n_ä“
 == -1) {

732 
s
->
s_hpfs_n_ä“
 = 
	`couÁ_b™m­
(s);

733 
s
->
s_hpfs_n_ä“_dnodes
 =

734 
	`couÁ_Úe_b™m­
(
s
->
s_dev
, s->
s_hpfs_dm­
);

741 
	`put_fs_lÚg
(
s
->
s_magic
, &
buf
->
f_ty³
);

742 
	`put_fs_lÚg
(512, &
buf
->
f_bsize
);

743 
	`put_fs_lÚg
(
s
->
s_hpfs_fs_size
, &
buf
->
f_blocks
);

744 
	`put_fs_lÚg
(
s
->
s_hpfs_n_ä“
, &
buf
->
f_bä“
);

745 
	`put_fs_lÚg
(
s
->
s_hpfs_n_ä“
, &
buf
->
f_bava
);

746 
	`put_fs_lÚg
(
s
->
s_hpfs_dœbªd_size
, &
buf
->
f_fes
);

747 
	`put_fs_lÚg
(
s
->
s_hpfs_n_ä“_dnodes
, &
buf
->
f_fä“
);

748 
	`put_fs_lÚg
(254, &
buf
->
f_Çm–’
);

749 
	}
}

755 
	$hpfs_»mouÁ_fs
(
su³r_block
 *
s
, *
æags
, *
d©a
)

757 ià(!(*
æags
 & 
MS_RDONLY
))

758  -
EINVAL
;

760 
	}
}

766 
	$couÁ_dnodes
(
šode
 *šode, 
dnode_£úo
 
dno
,

767 *
n_dnodes
, *
n_subdœs
)

769 
quad_bufãr_h—d
 
qbh
;

770 
dnode
 *dnode;

771 
hpfs_dœ’t
 *
de
;

772 
hpfs_dœ’t
 *
de_’d
;

774 
dnode
 = 
	`m­_dnode
(
šode
->
i_dev
, 
dno
, &
qbh
);

775 ià(!
dnode
)

777 
de
 = 
	`dnode_fœ¡_de
(
dnode
);

778 
de_’d
 = 
	`dnode_’d_de
(
dnode
);

780 (*
n_dnodes
)++;

782 ; 
de
 < 
de_’d
; dğ
	`de_Ãxt_de
(de)) {

783 ià(
de
->
down
)

784 
	`couÁ_dnodes
(
šode
, 
	`de_down_poš‹r
(
de
),

785 
n_dnodes
, 
n_subdœs
);

786 ià(
de
->
dœeùÜy
 && !de->
fœ¡
)

787 (*
n_subdœs
)++;

788 ià(
de
->
Ï¡
 || de->
Ëngth
 == 0)

792 
	`b»l£4
(&
qbh
);

793 
	}
}

799 
	$couÁ_b™m­
(
su³r_block
 *
s
)

801 
n
, 
couÁ
, 
n_bªds
;

802 
£úo
 *
b™m­s
;

803 
quad_bufãr_h—d
 
qbh
;

808 
n_bªds
 = (
s
->
s_hpfs_fs_size
 + 0x3fff) >> 14;

814 
b™m­s
 = 
	`m­_4£ùÜs
(
s
->
s_dev
, s->
s_hpfs_b™m­s
, &
qbh
);

815 ià(!
b™m­s
)

818 
couÁ
 = 0;

823 
n
 = 0;‚ < 
n_bªds
;‚++)

824 ià(
b™m­s
[
n
] == 0)

825 
	`´štk
("HPFS: bit map…ointer missing\n");

827 
couÁ
 +ğ
	`couÁ_Úe_b™m­
(
s
->
s_dev
, 
b™m­s
[
n
]);

829 
	`b»l£4
(&
qbh
);

830  
couÁ
;

831 
	}
}

837 
	$couÁ_Úe_b™m­
(
dev_t
 
dev
, 
£úo
 secno)

839 
quad_bufãr_h—d
 
qbh
;

840 *
b™s
;

841 
i
, 
couÁ
;

843 
b™s
 = 
	`m­_4£ùÜs
(
dev
, 
£úo
, &
qbh
);

844 ià(!
b™s
)

847 
couÁ
 = 0;

849 
i
 = 0; i < 8 * 2048; i++)

850 
couÁ
 +ğ(
	`‹¡_b™
(
i
, 
b™s
) != 0);

851 
	`b»l£4
(&
qbh
);

853  
couÁ
;

854 
	}
}

862 
	$hpfs_fe_»ad
(
šode
 *šode, 
fe
 *
fp
,

863 *
buf
, 
couÁ
)

865 
q
, 
r
, 
n
, 
n0
;

866 
bufãr_h—d
 *
bh
;

867 *
block
;

868 *
¡¬t
;

870 ià(
šode
 =ğ0 || !
	`S_ISREG
(šode->
i_mode
))

871  -
EINVAL
;

876 ià(
couÁ
 > 
šode
->
i_size
 - 
fp
->
f_pos
)

877 
couÁ
 = 
šode
->
i_size
 - 
fp
->
f_pos
;

879 
¡¬t
 = 
buf
;

880 
couÁ
 > 0) {

885 
q
 = 
fp
->
f_pos
 >> 9;

886 
r
 = 
fp
->
f_pos
 & 511;

887 
n
 = 512 - 
r
;

892 ià(
n
 > 
couÁ
)

893 
n
 = 
couÁ
;

898 
block
 = 
	`m­_£ùÜ
(
šode
->
i_dev
, 
	`hpfs_bm­
(šode, 
q
), &
bh
);

899 ià(!
block
)

900  -
EIO
;

906 ià(
šode
->
i_hpfs_cÚv
 =ğ
CONV_AUTO
)

907 
šode
->
i_hpfs_cÚv
 = 
	`choo£_cÚv
(
block
 + 
r
, 
n
);

909 ià(
šode
->
i_hpfs_cÚv
 =ğ
CONV_BINARY
) {

914 
	`memıy_tofs
(
buf
, 
block
 + 
r
, 
n
);

915 
n0
 = 
n
;

921 
n0
 = 
	`cÚvıy_tofs
(
buf
, 
block
 + 
r
, 
n
);

922 ià(
couÁ
 > 
šode
->
i_size
 - 
fp
->
f_pos
 - 
n
 + 
n0
)

923 
couÁ
 = 
šode
->
i_size
 - 
fp
->
f_pos
 - 
n
 + 
n0
;

926 
	`b»l£
(
bh
);

931 
fp
->
f_pos
 +ğ
n
;

932 
buf
 +ğ
n0
;

933 
couÁ
 -ğ
n0
;

936  
buf
 - 
¡¬t
;

937 
	}
}

943 
	$choo£_cÚv
(*
p
, 
Ën
)

945 
tvÙe
, 
bvÙe
;

946 
c
;

948 
tvÙe
 = 
bvÙe
 = 0;

950 
Ën
--) {

951 
c
 = *
p
++;

952 ià(
c
 < ' ')

953 ià(
c
 =ğ'\r' && 
Ën
 && *
p
 == '\n')

954 
tvÙe
 += 10;

955 ià(
c
 == '\t' || c == '\n');

957 
bvÙe
 += 5;

958 ià(
c
 < '\177')

959 
tvÙe
++;

961 
bvÙe
 += 5;

964 ià(
tvÙe
 > 
bvÙe
)

965  
CONV_TEXT
;

967  
CONV_BINARY
;

968 
	}
}

974 
	$cÚvıy_tofs
(*
out
, *
š
,

975 
Ën
)

977 *
¡¬t
 = 
out
;

979 
Ën
--) {

980 
c
 = *
š
++;

981 ià(
c
 =ğ'\r' && (
Ën
 =ğ0 || *
š
 == '\n'));

983 
	`put_fs_by‹
(
c
, 
out
++);

986  
out
 - 
¡¬t
;

987 
	}
}

993 
£úo
 
	$hpfs_bm­
(
šode
 *šode, 
fe_£úo
)

995 
n
, 
disk_£úo
;

996 
âode
 *fnode;

997 
bufãr_h—d
 *
bh
;

1004 
n
 = 
fe_£úo
 - 
šode
->
i_hpfs_fe_£c
;

1005 ià(
n
 < 
šode
->
i_hpfs_n_£cs
)

1006  
šode
->
i_hpfs_disk_£c
 + 
n
;

1013 
âode
 = 
	`m­_âode
(
šode
->
i_dev
, inode->
i_šo
, &
bh
);

1014 ià(!
âode
)

1016 
disk_£úo
 = 
	`b¶us_lookup
(
šode
, &
âode
->
bŒ“
,

1017 
fe_£úo
, &
bh
);

1018 
	`b»l£
(
bh
);

1019  
disk_£úo
;

1021 
	}
}

1030 
£úo
 
	$b¶us_lookup
(
šode
 *šode, 
b¶us_h—d”
 *
b
,

1031 
£úo
 
fe_£úo
, 
bufãr_h—d
 **
bhp
)

1033 
i
;

1041 ià(!
b
->
š‹º®
) {

1042 
b¶us_Ëaf_node
 *
n
 = 
b
->
u
.
ex‹º®
;

1043 
i
 = 0; i < 
b
->
n_u£d_nodes
; i++) {

1044 
t
 = 
fe_£úo
 - 
n
[
i
].file_secno;

1045 ià(
t
 < 
n
[
i
].
Ëngth
) {

1046 
šode
->
i_hpfs_fe_£c
 = 
n
[
i
].
fe_£úo
;

1047 
šode
->
i_hpfs_disk_£c
 = 
n
[
i
].
disk_£úo
;

1048 
šode
->
i_hpfs_n_£cs
 = 
n
[
i
].
Ëngth
;

1049  
n
[
i
].
disk_£úo
 + 
t
;

1060 
b¶us_š‹º®_node
 *
n
 = 
b
->
u
.
š‹º®
;

1061 
i
 = 0; i < 
b
->
n_u£d_nodes
; i++) {

1062 ià(
fe_£úo
 < 
n
[
i
].file_secno) {

1063 
ªode
 *anode;

1064 
ªode_£úo
 
ªo
 = 
n
[
i
].
down
;

1065 
	`b»l£
(*
bhp
);

1066 
ªode
 = 
	`m­_ªode
(
šode
->
i_dev
, 
ªo
, 
bhp
);

1067 ià(!
ªode
)

1069  
	`b¶us_lookup
(
šode
, &
ªode
->
bŒ“
,

1070 
fe_£úo
, 
bhp
);

1083 
	`´štk
("HPFS: bplus_lookup: sector‚ot found\n");

1085 
	}
}

1100 
	$hpfs_lookup
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

1101 
šode
 **
»suÉ
)

1103 
quad_bufãr_h—d
 
qbh
;

1104 
hpfs_dœ’t
 *
de
;

1105 
šode
 *inode;

1106 
šo_t
 
šo
;

1110 *
»suÉ
 = 0;

1111 ià(
dœ
 == 0)

1112  -
ENOENT
;

1113 ià(!
	`S_ISDIR
(
dœ
->
i_mode
))

1114 
ba
;

1121 ià(
Çme
[0] =ğ'.' && 
Ën
 == 1)

1122 
de
 = 
	`m­_dœ’t
(
dœ
, dœ->
i_hpfs_dno
, "\001\001", 2, &
qbh
);

1123 ià(
Çme
[0] =ğ'.' &&‚ame[1] =ğ'.' && 
Ën
 == 2)

1124 
de
 = 
	`m­_dœ’t
(
dœ
,

1125 
	`âode_dno
(
dœ
->
i_dev
, dœ->
i_hpfs_·»Á_dœ
),

1126 "\001\001", 2, &
qbh
);

1128 
de
 = 
	`m­_dœ’t
(
dœ
, dœ->
i_hpfs_dno
, 
Çme
, 
Ën
, &
qbh
);

1134 ià(!
de
)

1135 
ba
;

1141 ià(
de
->
dœeùÜy
)

1142 
šo
 = 
	`dœ_šo
(
de
->
âode
);

1144 
šo
 = 
	`fe_šo
(
de
->
âode
);

1150 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
šo
)))

1151 
ba1
;

1158 ià(!
šode
->
i_©ime
) {

1159 
šode
->
i_©ime
 = 
	`loÿl_to_gmt
(
de
->
»ad_d©e
);

1160 
šode
->
i_mtime
 = 
	`loÿl_to_gmt
(
de
->
wr™e_d©e
);

1161 
šode
->
i_ùime
 = 
	`loÿl_to_gmt
(
de
->
ü—tiÚ_d©e
);

1162 ià(
de
->
»ad_Úly
)

1163 
šode
->
i_mode
 &= ~0222;

1164 ià(!
de
->
dœeùÜy
) {

1165 
šode
->
i_size
 = 
de
->
fe_size
;

1172 
šode
->
i_blocks
 = 1 + ((šode->
i_size
 + 511) >> 9);

1176 
	`b»l£4
(&
qbh
);

1182 *
»suÉ
 = 
šode
;

1183 
	`ut
(
dœ
);

1189 
ba1
:

1190 
	`b»l£4
(&
qbh
);

1191 
ba
:

1192 
	`ut
(
dœ
);

1193  -
ENOENT
;

1194 
	}
}

1201 
šlše
 
	$memÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
,

1202 
n
)

1204 
t
;

1206 ià(
n
 != 0)

1208 
c1
 = *
s1
++;

1209 
c2
 = *
s2
++;

1210 ià(
c1
 - 'a' < 26)

1211 
c1
 -= 040;

1212 ià(
c2
 - 'a' < 26)

1213 
c2
 -= 040;

1214 ià((
t
 = 
c1
 - 
c2
) != 0)

1215  
t
;

1216 } --
n
 != 0);

1219 
	}
}

1226 
hpfs_dœ’t
 *
	$m­_dœ’t
(
šode
 *šode, 
dnode_£úo
 
dno
,

1227 cÚ¡ *
Çme
, 
Ën
,

1228 
quad_bufãr_h—d
 *
qbh
)

1230 
dnode
 *dnode;

1231 
hpfs_dœ’t
 *
de
;

1232 
hpfs_dœ’t
 *
de_’d
;

1233 
t
, 
l
;

1238 
dnode
 = 
	`m­_dnode
(
šode
->
i_dev
, 
dno
, 
qbh
);

1239 ià(!
dnode
)

1245 
de
 = 
	`dnode_fœ¡_de
(
dnode
);

1246 
de_’d
 = 
	`dnode_’d_de
(
dnode
);

1251  ; 
de
 < 
de_’d
; dğ
	`de_Ãxt_de
(de)) {

1256 
l
 = 
Ën
 < 
de
->
Çm–’
 ?†en : de->namelen;

1257 
t
 = 
	`memÿ£cmp
(
Çme
, 
de
->Çme, 
l
);

1262 ià(
t
 == 0) {

1263 
t
 = 
Ën
 - 
de
->
Çm–’
;

1265 ià(
t
 == 0)

1266  
de
;

1272 ià(
t
 < 0) {

1276 ià(
de
->
down
) {

1277 
dnode_£úo
 
sub_dno
 = 
	`de_down_poš‹r
(
de
);

1278 
	`b»l£4
(
qbh
);

1279  
	`m­_dœ’t
(
šode
, 
sub_dno
,

1280 
Çme
, 
Ën
, 
qbh
);

1292 ià(
de
->
Ï¡
 || de->
Ëngth
 == 0)

1301 
	}
}

1328 
	$hpfs_»addœ
(
šode
 *šode, 
fe
 *
fp
,

1329 
dœ’t
 *dœ’t, 
lik–y_¡Üy
)

1331 
quad_bufãr_h—d
 
qbh
;

1332 
hpfs_dœ’t
 *
de
;

1333 
Çm–’
, 
lc
;

1334 
šo_t
 
šo
;

1336 ià(
šode
 == 0

1337 || 
šode
->
i_sb
 == 0

1338 || !
	`S_ISDIR
(
šode
->
i_mode
))

1339  -
EBADF
;

1341 
lc
 = 
šode
->
i_sb
->
s_hpfs_low”ÿ£
;

1343 
fp
->
f_pos
) {

1345 
	`wr™e_Úe_dœ’t
(
dœ’t
, ".", 1, 
šode
->
i_šo
, 
lc
);

1346 
fp
->
f_pos
 = -1;

1350 
	`wr™e_Úe_dœ’t
(
dœ’t
, "..", 2,

1351 
šode
->
i_hpfs_·»Á_dœ
, 
lc
);

1352 
fp
->
f_pos
 = 1;

1359 
de
 = 
	`m­_pos_dœ’t
(
šode
, &
fp
->
f_pos
, &
qbh
);

1360 ià(!
de
) {

1361 
fp
->
f_pos
 = -2;

1365 
Çm–’
 = 
de
->namelen;

1366 ià(
de
->
dœeùÜy
)

1367 
šo
 = 
	`dœ_šo
(
de
->
âode
);

1369 
šo
 = 
	`fe_šo
(
de
->
âode
);

1370 
	`wr™e_Úe_dœ’t
(
dœ’t
, 
de
->
Çme
, 
Çm–’
, 
šo
, 
lc
);

1371 
	`b»l£4
(&
qbh
);

1373  
Çm–’
;

1375 
	}
}

1385 
	$wr™e_Úe_dœ’t
(
dœ’t
 *dœ’t, cÚ¡ *
Çme
,

1386 
Çm–’
, 
šo_t
 
šo
, 
low”ÿ£
)

1388 
n
;

1390 
	`put_fs_lÚg
(
šo
, &
dœ’t
->
d_šo
);

1391 
	`put_fs_wÜd
(
Çm–’
, &
dœ’t
->
d_»ş’
);

1393 ià(
low”ÿ£
)

1394 
n
 = 
Çm–’
;‚ != 0;) {

1395 
t
 = 
Çme
[--
n
];

1396 ià(
t
 - 'A' < 26)

1397 
t
 += 040;

1398 
	`put_fs_by‹
(
t
, &
dœ’t
->
d_Çme
[
n
]);

1401 
	`memıy_tofs
(
dœ’t
->
d_Çme
, 
Çme
, 
Çm–’
);

1403 
	`put_fs_by‹
(0, &
dœ’t
->
d_Çme
[
Çm–’
]);

1404 
	}
}

1411 
hpfs_dœ’t
 *
	$m­_pos_dœ’t
(
šode
 *šode, 
off_t
 *
po¥
,

1412 
quad_bufãr_h—d
 *
qbh
)

1414 
pos
, 
q
, 
r
;

1415 
dnode_£úo
 
dno
;

1416 
hpfs_dœ’t
 *
de
;

1422 
pos
 = *
po¥
;

1423 
q
 = 
pos
 >> 6;

1424 
r
 = 
pos
 & 077;

1431 
dno
 = 
	`dœ_subdno
(
šode
, 
q
);

1432 ià(!
dno
)

1439 
de
 = 
	`m­_Áh_dœ’t
(
šode
->
i_dev
, 
dno
, 
r
, 
qbh
);

1445 ià(!
de
) {

1446 ià(
q
 == 0)

1448 *
po¥
 = 
q
 + 1;

1449  
	`m­_pos_dœ’t
(
šode
, 
po¥
, 
qbh
);

1456 ià(
de
->
down
)

1457 *
po¥
 = 
pos
 << 6 | 1;

1459 *
po¥
 = 
pos
 + 1;

1465 ià(
de
->
fœ¡
 || de->
Ï¡
) {

1466 
	`b»l£4
(
qbh
);

1467  
	`m­_pos_dœ’t
(
šode
, 
po¥
, 
qbh
);

1470  
de
;

1471 
	}
}

1477 
dnode_£úo
 
	$dœ_subdno
(
šode
 *šode, 
pos
)

1479 
hpfs_dœ’t
 *
de
;

1480 
quad_bufãr_h—d
 
qbh
;

1486 ià(
pos
 == 0)

1487  
šode
->
i_hpfs_dno
;

1493 ià(
pos
 =ğ
šode
->
i_hpfs_dpos
)

1494  
šode
->
i_hpfs_dsubdno
;

1501 
q
 = 
pos
 >> 6;

1502 
r
 = 
pos
 & 077;

1503 
dnode_£úo
 
dno
;

1508 
dno
 = 
	`dœ_subdno
(
šode
, 
q
);

1509 ià(
dno
 == 0)

1515 
de
 = 
	`m­_Áh_dœ’t
(
šode
->
i_dev
, 
dno
, 
r
, &
qbh
);

1516 ià(!
de
 || !de->
down
)

1522 
dno
 = 
	`de_down_poš‹r
(
de
);

1523 
	`b»l£4
(&
qbh
);

1528 
šode
->
i_hpfs_dpos
 = 
pos
;

1529 
šode
->
i_hpfs_dsubdno
 = 
dno
;

1530  
dno
;

1532 
	}
}

1538 
hpfs_dœ’t
 *
	$m­_Áh_dœ’t
(
dev_t
 
dev
, 
dnode_£úo
 
dno
,

1539 
n
,

1540 
quad_bufãr_h—d
 *
qbh
)

1542 
i
;

1543 
hpfs_dœ’t
 *
de
, *
de_’d
;

1544 
dnode
 *dnodğ
	`m­_dnode
(
dev
, 
dno
, 
qbh
);

1546 
de
 = 
	`dnode_fœ¡_de
(
dnode
);

1547 
de_’d
 = 
	`dnode_’d_de
(
dnode
);

1549 
i
 = 1; 
de
 < 
de_’d
; i++, dğ
	`de_Ãxt_de
(de)) {

1550 ià(
i
 =ğ
n
)

1551  
de
;

1552 ià(
de
->
Ï¡
 || de->
Ëngth
 == 0)

1556 
	`b»l£4
(
qbh
);

1558 
	}
}

1560 
	$hpfs_dœ_»ad
(
šode
 *šode, 
fe
 *
fp
,

1561 *
buf
, 
couÁ
)

1563  -
EISDIR
;

1564 
	}
}

1568 
dnode_£úo
 
	$âode_dno
(
dev_t
 
dev
, 
šo_t
 
šo
)

1570 
bufãr_h—d
 *
bh
;

1571 
âode
 *fnode;

1572 
dnode_£úo
 
dno
;

1574 
âode
 = 
	`m­_âode
(
dev
, 
šo
, &
bh
);

1575 ià(!
âode
)

1578 
dno
 = 
âode
->
u
.
ex‹º®
[0].
disk_£úo
;

1579 
	`b»l£
(
bh
);

1580  
dno
;

1581 
	}
}

1585 
âode
 *
	$m­_âode
(
dev_t
 
dev
, 
šo_t
 
šo
, 
bufãr_h—d
 **
bhp
)

1587 
âode
 *fnode;

1589 ià(
šo
 == 0) {

1590 
	`´štk
("HPFS: missing fnode\n");

1594 
âode
 = 
	`m­_£ùÜ
(
dev
, 
	`šo_£úo
(
šo
), 
bhp
);

1595 ià(
âode
)

1596 ià(
âode
->
magic
 !ğ
FNODE_MAGIC
) {

1597 
	`´štk
("HPFS: map_fnode: bad fnode…ointer\n");

1598 
	`b»l£
(*
bhp
);

1601  
âode
;

1602 
	}
}

1606 
ªode
 *
	$m­_ªode
(
dev_t
 
dev
, 
£úo
,

1607 
bufãr_h—d
 **
bhp
)

1609 
ªode
 *anode;

1611 ià(
£úo
 == 0) {

1612 
	`´štk
("HPFS: missing‡node\n");

1616 
ªode
 = 
	`m­_£ùÜ
(
dev
, 
£úo
, 
bhp
);

1617 ià(
ªode
)

1618 ià(
ªode
->
magic
 !ğ
ANODE_MAGIC
 ||‡node->
£lf
 !ğ
£úo
) {

1619 
	`´štk
("HPFS: map_anode: bad‡node…ointer\n");

1620 
	`b»l£
(*
bhp
);

1623  
ªode
;

1624 
	}
}

1628 
dnode
 *
	$m­_dnode
(
dev_t
 
dev
, 
£úo
,

1629 
quad_bufãr_h—d
 *
qbh
)

1631 
dnode
 *dnode;

1633 ià(
£úo
 == 0) {

1634 
	`´štk
("HPFS: missing dnode\n");

1638 
dnode
 = 
	`m­_4£ùÜs
(
dev
, 
£úo
, 
qbh
);

1639 ià(
dnode
)

1640 ià(
dnode
->
magic
 !ğ
DNODE_MAGIC
 || dnode->
£lf
 !ğ
£úo
) {

1641 
	`´štk
("HPFS: map_dnode: bad dnode…ointer\n");

1642 
	`b»l£4
(
qbh
);

1645  
dnode
;

1646 
	}
}

1650 *
	$m­_£ùÜ
(
dev_t
 
dev
, 
£úo
, 
bufãr_h—d
 **
bhp
)

1652 
bufãr_h—d
 *
bh
;

1654 ià((*
bhp
 = 
bh
 = 
	`b»ad
(
dev
, 
£úo
, 512)) != 0)

1655  
bh
->
b_d©a
;

1657 
	`´štk
("HPFS: map_sector:„eadƒrror\n");

1660 
	}
}

1664 *
	$m­_4£ùÜs
(
dev_t
 
dev
, 
£úo
,

1665 
quad_bufãr_h—d
 *
qbh
)

1667 
bufãr_h—d
 *
bh
;

1668 *
d©a
;

1670 ià(
£úo
 & 3) {

1671 
	`´štk
("HPFS: map_4sectors: unaligned„ead\n");

1675 
qbh
->
d©a
 = d©¨ğ
	`km®loc
(2048, 
GFP_KERNEL
);

1676 ià(!
d©a
)

1677 
ba
;

1679 
qbh
->
bh
[0] = bh = 
	`b»ada
(
dev
,

1680 
£úo
, secno + 1, secno + 2, secno + 3, -1);

1681 ià(!
bh
)

1682 
ba0
;

1683 
	`memıy
(
d©a
, 
bh
->
b_d©a
, 512);

1685 
qbh
->
bh
[1] = bh = 
	`b»ad
(
dev
, 
£úo
 + 1, 512);

1686 ià(!
bh
)

1687 
ba1
;

1688 
	`memıy
(
d©a
 + 512, 
bh
->
b_d©a
, 512);

1690 
qbh
->
bh
[2] = bh = 
	`b»ad
(
dev
, 
£úo
 + 2, 512);

1691 ià(!
bh
)

1692 
ba2
;

1693 
	`memıy
(
d©a
 + 2 * 512, 
bh
->
b_d©a
, 512);

1695 
qbh
->
bh
[3] = bh = 
	`b»ad
(
dev
, 
£úo
 + 3, 512);

1696 ià(!
bh
)

1697 
ba3
;

1698 
	`memıy
(
d©a
 + 3 * 512, 
bh
->
b_d©a
, 512);

1700  
d©a
;

1702 
ba3
:

1703 
	`b»l£
(
qbh
->
bh
[2]);

1704 
ba2
:

1705 
	`b»l£
(
qbh
->
bh
[1]);

1706 
ba1
:

1707 
	`b»l£
(
qbh
->
bh
[0]);

1708 
ba0
:

1709 
	`kä“_s
(
d©a
, 2048);

1710 
ba
:

1711 
	`´štk
("HPFS: map_4sectors:„eadƒrror\n");

1713 
	}
}

1717 
	$b»l£4
(
quad_bufãr_h—d
 *
qbh
)

1719 
	`b»l£
(
qbh
->
bh
[3]);

1720 
	`b»l£
(
qbh
->
bh
[2]);

1721 
	`b»l£
(
qbh
->
bh
[1]);

1722 
	`b»l£
(
qbh
->
bh
[0]);

1723 
	`kä“_s
(
qbh
->
d©a
, 2048);

1724 
	}
}

	@fs/inode.c

7 
	~<lšux/¡©.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/mm.h
>

11 
	~<lšux/¡ršg.h
>

13 
	~<asm/sy¡em.h
>

15 
	sšode_hash_’Œy
 {

16 
šode
 * 
	mšode
;

17 
	mupd©šg
;

18 } 
	ghash_bË
[
NR_IHASH
];

20 
šode
 * 
	gfœ¡_šode
;

21 
wa™_queue
 * 
	gšode_wa™
 = 
NULL
;

22 
	gÄ_šodes
 = 0, 
	gÄ_ä“_šodes
 = 0;

24 
šlše
 cÚ¡ 
	$hashâ
(
dev_t
 
dev
, 
i
)

26  (
dev
 ^ 
i
è% 
NR_IHASH
;

27 
	}
}

29 
šlše
 
šode_hash_’Œy
 * cÚ¡ 
	$hash
(
dev_t
 
dev
, 
i
)

31  
hash_bË
 + 
	`hashâ
(
dev
, 
i
);

32 
	}
}

34 
	$š£¹_šode_ä“
(
šode
 *inode)

36 
šode
->
i_Ãxt
 = 
fœ¡_šode
;

37 
šode
->
i_´ev
 = 
fœ¡_šode
->i_prev;

38 
šode
->
i_Ãxt
->
i_´ev
 = inode;

39 
šode
->
i_´ev
->
i_Ãxt
 = inode;

40 
fœ¡_šode
 = 
šode
;

41 
	}
}

43 
	$»move_šode_ä“
(
šode
 *inode)

45 ià(
fœ¡_šode
 =ğ
šode
)

46 
fœ¡_šode
 = fœ¡_šode->
i_Ãxt
;

47 ià(
šode
->
i_Ãxt
)

48 
šode
->
i_Ãxt
->
i_´ev
 = inode->i_prev;

49 ià(
šode
->
i_´ev
)

50 
šode
->
i_´ev
->
i_Ãxt
 = inode->i_next;

51 
šode
->
i_Ãxt
 = inode->
i_´ev
 = 
NULL
;

52 
	}
}

54 
	$š£¹_šode_hash
(
šode
 *inode)

56 
šode_hash_’Œy
 *
h
;

57 
h
 = 
	`hash
(
šode
->
i_dev
, inode->
i_šo
);

59 
šode
->
i_hash_Ãxt
 = 
h
->inode;

60 
šode
->
i_hash_´ev
 = 
NULL
;

61 ià(
šode
->
i_hash_Ãxt
)

62 
šode
->
i_hash_Ãxt
->
i_hash_´ev
 = inode;

63 
h
->
šode
 = inode;

64 
	}
}

66 
	$»move_šode_hash
(
šode
 *inode)

68 
šode_hash_’Œy
 *
h
;

69 
h
 = 
	`hash
(
šode
->
i_dev
, inode->
i_šo
);

71 ià(
h
->
šode
 == inode)

72 
h
->
šode
 = inode->
i_hash_Ãxt
;

73 ià(
šode
->
i_hash_Ãxt
)

74 
šode
->
i_hash_Ãxt
->
i_hash_´ev
 = inode->i_hash_prev;

75 ià(
šode
->
i_hash_´ev
)

76 
šode
->
i_hash_´ev
->
i_hash_Ãxt
 = inode->i_hash_next;

77 
šode
->
i_hash_´ev
 = inode->
i_hash_Ãxt
 = 
NULL
;

78 
	}
}

80 
	$put_Ï¡_ä“
(
šode
 *inode)

82 
	`»move_šode_ä“
(
šode
);

83 
šode
->
i_´ev
 = 
fœ¡_šode
->i_prev;

84 
šode
->
i_´ev
->
i_Ãxt
 = inode;

85 
šode
->
i_Ãxt
 = 
fœ¡_šode
;

86 
šode
->
i_Ãxt
->
i_´ev
 = inode;

87 
	}
}

89 
	$grow_šodes
()

91 
šode
 * inode;

92 
i
;

94 ià(!(
šode
 = (šode*è
	`g‘_ä“_·ge
(
GFP_KERNEL
)))

97 
i
=
PAGE_SIZE
 / (
šode
);

98 
Ä_šodes
 +ğ
i
;

99 
Ä_ä“_šodes
 +ğ
i
;

101 ià(!
fœ¡_šode
)

102 
šode
->
i_Ãxt
 = inode->
i_´ev
 = 
fœ¡_šode
 = inode++, 
i
--;

104  ; 
i
 ; i-- )

105 
	`š£¹_šode_ä“
(
šode
++);

106 
	}
}

108 
	$šode_š™
(
¡¬t
, 
’d
)

110 
	`mem£t
(
hash_bË
, 0, (hash_table));

111 
fœ¡_šode
 = 
NULL
;

112  
¡¬t
;

113 
	}
}

115 
__wa™_Ú_šode
(
šode
 *);

117 
šlše
 
	$wa™_Ú_šode
(
šode
 * inode)

119 ià(
šode
->
i_lock
)

120 
	`__wa™_Ú_šode
(
šode
);

121 
	}
}

123 
šlše
 
	$lock_šode
(
šode
 * inode)

125 
	`wa™_Ú_šode
(
šode
);

126 
šode
->
i_lock
 = 1;

127 
	}
}

129 
šlše
 
	$uÆock_šode
(
šode
 * inode)

131 
šode
->
i_lock
 = 0;

132 
	`wake_up
(&
šode
->
i_wa™
);

133 
	}
}

147 
	$ş—r_šode
(
šode
 * inode)

149 
wa™_queue
 * 
wa™
;

151 
	`wa™_Ú_šode
(
šode
);

152 
	`»move_šode_hash
(
šode
);

153 
	`»move_šode_ä“
(
šode
);

154 
wa™
 = ((vŞ©
šode
 *èšode)->
i_wa™
;

155 ià(
šode
->
i_couÁ
)

156 
Ä_ä“_šodes
++;

157 
	`mem£t
(
šode
,0,(*inode));

158 ((vŞ©
šode
 *èšode)->
i_wa™
 = 
wa™
;

159 
	`š£¹_šode_ä“
(
šode
);

160 
	}
}

162 
	$fs_may_mouÁ
(
dev_t
 
dev
)

164 
šode
 * inode, * 
Ãxt
;

165 
i
;

167 
Ãxt
 = 
fœ¡_šode
;

168 
i
 = 
Ä_šodes
 ; i > 0 ; i--) {

169 
šode
 = 
Ãxt
;

170 
Ãxt
 = 
šode
->
i_Ãxt
;

171 ià(
šode
->
i_dev
 !ğ
dev
)

173 ià(
šode
->
i_couÁ
 || inode->
i_dœt
 || inode->
i_lock
)

175 
	`ş—r_šode
(
šode
);

178 
	}
}

180 
	$fs_may_umouÁ
(
dev_t
 
dev
, 
šode
 * 
mouÁ_roÙ
)

182 
šode
 * inode;

183 
i
;

185 
šode
 = 
fœ¡_šode
;

186 
i
=0 ; i < 
Ä_šodes
 ; i++, 
šode
 = inode->
i_Ãxt
) {

187 ià(
šode
->
i_dev
 !ğ
dev
 || !šode->
i_couÁ
)

189 ià(
šode
 =ğ
mouÁ_roÙ
 && inode->
i_couÁ
 == 1)

194 
	}
}

196 
	$fs_may_»mouÁ_ro
(
dev_t
 
dev
)

198 
fe
 * file;

199 
i
;

202 
fe
 = 
fœ¡_fe
, 
i
=0; i<
Ä_fes
; i++, fe=fe->
f_Ãxt
) {

203 ià(!
fe
->
f_couÁ
 || !fe->
f_šode
 ||

204 
fe
->
f_šode
->
i_dev
 !ğ
dev
)

206 ià(
	`S_ISREG
(
fe
->
f_šode
->
i_mode
è&& (fe->
f_mode
 & 2))

210 
	}
}

212 
	$wr™e_šode
(
šode
 * inode)

214 ià(!
šode
->
i_dœt
)

216 
	`wa™_Ú_šode
(
šode
);

217 ià(!
šode
->
i_dœt
)

219 ià(!
šode
->
i_sb
 || !šode->i_sb->
s_İ
 || !šode->i_sb->s_İ->
wr™e_šode
) {

220 
šode
->
i_dœt
 = 0;

223 
šode
->
i_lock
 = 1;

224 
šode
->
i_sb
->
s_İ
->
	`wr™e_šode
(inode);

225 
	`uÆock_šode
(
šode
);

226 
	}
}

228 
	$»ad_šode
(
šode
 * inode)

230 
	`lock_šode
(
šode
);

231 ià(
šode
->
i_sb
 && inode->i_sb->
s_İ
 && inode->i_sb->s_İ->
»ad_šode
)

232 
šode
->
i_sb
->
s_İ
->
	`»ad_šode
(inode);

233 
	`uÆock_šode
(
šode
);

234 
	}
}

244 
	$nÙify_chªge
(
æags
, 
šode
 * inode)

246 ià(
šode
->
i_sb
 && inode->i_sb->
s_İ
 &&

247 
šode
->
i_sb
->
s_İ
->
nÙify_chªge
)

248  
šode
->
i_sb
->
s_İ
->
	`nÙify_chªge
(
æags
, inode);

250 
	}
}

262 
	$bm­
(
šode
 * inode, 
block
)

264 ià(
šode
->
i_İ
 && inode->i_İ->
bm­
)

265  
šode
->
i_İ
->
	`bm­
(šode,
block
);

267 
	}
}

269 
	$šv®id©e_šodes
(
dev_t
 
dev
)

271 
šode
 * inode, * 
Ãxt
;

272 
i
;

274 
Ãxt
 = 
fœ¡_šode
;

275 
i
 = 
Ä_šodes
 ; i > 0 ; i--) {

276 
šode
 = 
Ãxt
;

277 
Ãxt
 = 
šode
->
i_Ãxt
;

278 ià(
šode
->
i_dev
 !ğ
dev
)

280 ià(
šode
->
i_couÁ
 || inode->
i_dœt
 || inode->
i_lock
) {

281 
	`´štk
("VFS: inodbusy oÀ»moved deviû %d/%d\n", 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

284 
	`ş—r_šode
(
šode
);

286 
	}
}

288 
	$sync_šodes
(
dev_t
 
dev
)

290 
i
;

291 
šode
 * inode;

293 
šode
 = 
fœ¡_šode
;

294 
i
 = 0; i < 
Ä_šodes
*2; i++, 
šode
 = inode->
i_Ãxt
) {

295 ià(
dev
 && 
šode
->
i_dev
 != dev)

297 
	`wa™_Ú_šode
(
šode
);

298 ià(
šode
->
i_dœt
)

299 
	`wr™e_šode
(
šode
);

301 
	}
}

303 
	$ut
(
šode
 * inode)

305 ià(!
šode
)

307 
	`wa™_Ú_šode
(
šode
);

308 ià(!
šode
->
i_couÁ
) {

309 
	`´štk
("VFS: iput:ryingo free free inode\n");

310 
	`´štk
("VFS: device %d/%d, inode %lu, mode=0%07o\n",

311 
	`MAJOR
(
šode
->
i_rdev
), 
	`MINOR
(inode->i_rdev),

312 
šode
->
i_šo
, inode->
i_mode
);

315 ià(
šode
->
i_pe
)

316 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

317 
»³©
:

318 ià(
šode
->
i_couÁ
>1) {

319 
šode
->
i_couÁ
--;

322 
	`wake_up
(&
šode_wa™
);

323 ià(
šode
->
i_pe
) {

324 
·ge
 = (è
	`PIPE_BASE
(*
šode
);

325 
	`PIPE_BASE
(*
šode
èğ
NULL
;

326 
	`ä“_·ge
(
·ge
);

328 ià(
šode
->
i_sb
 && inode->i_sb->
s_İ
 && inode->i_sb->s_İ->
put_šode
) {

329 
šode
->
i_sb
->
s_İ
->
	`put_šode
(inode);

330 ià(!
šode
->
i_Æšk
)

333 ià(
šode
->
i_dœt
) {

334 
	`wr™e_šode
(
šode
);

335 
	`wa™_Ú_šode
(
šode
);

336 
»³©
;

338 
šode
->
i_couÁ
--;

339 
Ä_ä“_šodes
++;

341 
	}
}

343 
šode
 * 
	$g‘_em±y_šode
()

345 
šode
 * inode, * 
be¡
;

346 
i
;

348 ià(
Ä_šodes
 < 
NR_INODE
 && 
Ä_ä“_šodes
 < (nr_inodes >> 2))

349 
	`grow_šodes
();

350 
»³©
:

351 
šode
 = 
fœ¡_šode
;

352 
be¡
 = 
NULL
;

353 
i
 = 0; i<
Ä_šodes
; 
šode
 = inode->
i_Ãxt
, i++) {

354 ià(!
šode
->
i_couÁ
) {

355 ià(!
be¡
)

356 
be¡
 = 
šode
;

357 ià(!
šode
->
i_dœt
 && !šode->
i_lock
) {

358 
be¡
 = 
šode
;

363 ià(!
be¡
 || be¡->
i_dœt
 || be¡->
i_lock
)

364 ià(
Ä_šodes
 < 
NR_INODE
) {

365 
	`grow_šodes
();

366 
»³©
;

368 
šode
 = 
be¡
;

369 ià(!
šode
) {

370 
	`´štk
("VFS: No free inodes - contact Linus\n");

371 
	`¦“p_Ú
(&
šode_wa™
);

372 
»³©
;

374 ià(
šode
->
i_lock
) {

375 
	`wa™_Ú_šode
(
šode
);

376 
»³©
;

378 ià(
šode
->
i_dœt
) {

379 
	`wr™e_šode
(
šode
);

380 
»³©
;

382 ià(
šode
->
i_couÁ
)

383 
»³©
;

384 
	`ş—r_šode
(
šode
);

385 
šode
->
i_couÁ
 = 1;

386 
šode
->
i_Æšk
 = 1;

387 
šode
->
i_£m
.
couÁ
 = 1;

388 
Ä_ä“_šodes
--;

389 ià(
Ä_ä“_šodes
 < 0) {

390 
	`´štk
 ("VFS: get_empty_inode: bad free inode count.\n");

391 
Ä_ä“_šodes
 = 0;

393  
šode
;

394 
	}
}

396 
šode
 * 
	$g‘_pe_šode
()

398 
šode
 * inode;

399 
šode_İ”©iÚs
 
pe_šode_İ”©iÚs
;

401 ià(!(
šode
 = 
	`g‘_em±y_šode
()))

402  
NULL
;

403 ià(!(
	`PIPE_BASE
(*
šode
èğ(*è
	`__g‘_ä“_·ge
(
GFP_USER
))) {

404 
	`ut
(
šode
);

405  
NULL
;

407 
šode
->
i_İ
 = &
pe_šode_İ”©iÚs
;

408 
šode
->
i_couÁ
 = 2;

409 
	`PIPE_WAIT
(*
šode
èğ
NULL
;

410 
	`PIPE_START
(*
šode
èğ
	`PIPE_LEN
(*inode) = 0;

411 
	`PIPE_RD_OPENERS
(*
šode
èğ
	`PIPE_WR_OPENERS
(*inode) = 0;

412 
	`PIPE_READERS
(*
šode
èğ
	`PIPE_WRITERS
(*inode) = 1;

413 
	`PIPE_LOCK
(*
šode
) = 0;

414 
šode
->
i_pe
 = 1;

415 
šode
->
i_mode
 |ğ
S_IFIFO
 | 
S_IRUSR
 | 
S_IWUSR
;

416 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

417 
šode
->
i_gid
 = 
cu¼’t
->
egid
;

418 
šode
->
i_©ime
 = inode->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

419  
šode
;

420 
	}
}

422 
šode
 * 
	$ig‘
(
su³r_block
 * 
sb
,
Ä
)

424  
	`__ig‘
(
sb
,
Ä
,1);

425 
	}
}

427 
šode
 * 
	$__ig‘
(
su³r_block
 * 
sb
, 
Ä
, 
üossmÁp
)

429 
wa™_queue
 * 
upd©e_wa™
 = 
NULL
;

430 
šode_hash_’Œy
 * 
h
;

431 
šode
 * inode;

432 
šode
 * 
em±y
 = 
NULL
;

434 ià(!
sb
)

435 
	`·nic
("VFS: iget with sb==NULL");

436 
h
 = 
	`hash
(
sb
->
s_dev
, 
Ä
);

437 
»³©
:

438 
šode
 = 
h
->šode; inod; inodğšode->
i_hash_Ãxt
)

439 ià(
šode
->
i_dev
 =ğ
sb
->
s_dev
 && inode->
i_šo
 =ğ
Ä
)

440 
found_™
;

441 ià(!
em±y
) {

442 
h
->
upd©šg
++;

443 
em±y
 = 
	`g‘_em±y_šode
();

444 ià(!--
h
->
upd©šg
)

445 
	`wake_up
(&
upd©e_wa™
);

446 ià(
em±y
)

447 
»³©
;

448  (
NULL
);

450 
šode
 = 
em±y
;

451 
šode
->
i_sb
 = 
sb
;

452 
šode
->
i_dev
 = 
sb
->
s_dev
;

453 
šode
->
i_šo
 = 
Ä
;

454 
šode
->
i_æags
 = 
sb
->
s_æags
;

455 
	`put_Ï¡_ä“
(
šode
);

456 
	`š£¹_šode_hash
(
šode
);

457 
	`»ad_šode
(
šode
);

458 
»tuº_™
;

460 
found_™
:

461 ià(!
šode
->
i_couÁ
)

462 
Ä_ä“_šodes
--;

463 
šode
->
i_couÁ
++;

464 
	`wa™_Ú_šode
(
šode
);

465 ià(
šode
->
i_dev
 !ğ
sb
->
s_dev
 || inode->
i_šo
 !ğ
Ä
) {

466 
	`´štk
("Whee.. inode changed from under us. Tell Linus\n");

467 
	`ut
(
šode
);

468 
»³©
;

470 ià(
üossmÁp
 && 
šode
->
i_mouÁ
) {

471 
šode
 * 
tmp
 = inode->
i_mouÁ
;

472 
tmp
->
i_couÁ
++;

473 
	`ut
(
šode
);

474 
šode
 = 
tmp
;

475 
	`wa™_Ú_šode
(
šode
);

477 ià(
em±y
)

478 
	`ut
(
em±y
);

480 
»tuº_™
:

481 
h
->
upd©šg
)

482 
	`¦“p_Ú
(&
upd©e_wa™
);

483  
šode
;

484 
	}
}

492 
	$__wa™_Ú_šode
(
šode
 * inode)

494 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

496 
	`add_wa™_queue
(&
šode
->
i_wa™
, &
wa™
);

497 
»³©
:

498 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

499 ià(
šode
->
i_lock
) {

500 
	`scheduË
();

501 
»³©
;

503 
	`»move_wa™_queue
(&
šode
->
i_wa™
, &
wa™
);

504 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

505 
	}
}

	@fs/ioctl.c

7 
	~<asm/£gm’t.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/‹rmios.h
>

14 
	~<lšux/fú.h
>

16 
	$fe_ioùl
(
fe
 *
fp
,
cmd
,
¬g
)

18 
”rÜ
;

19 
block
;

21 
cmd
) {

22 
FIBMAP
:

23 ià(
fp
->
f_šode
->
i_İ
 =ğ
NULL
)

24  -
EBADF
;

25 ià(
fp
->
f_šode
->
i_İ
->
bm­
 =ğ
NULL
)

26  -
EINVAL
;

27 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
,4);

28 ià(
”rÜ
)

29  
”rÜ
;

30 
block
 = 
	`g‘_fs_lÚg
((*è
¬g
);

31 
block
 = 
fp
->
f_šode
->
i_İ
->
	`bm­
(filp->f_inode,block);

32 
	`put_fs_lÚg
(
block
,(*è
¬g
);

34 
FIGETBSZ
:

35 ià(
fp
->
f_šode
->
i_sb
 =ğ
NULL
)

36  -
EBADF
;

37 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
,4);

38 ià(
”rÜ
)

39  
”rÜ
;

40 
	`put_fs_lÚg
(
fp
->
f_šode
->
i_sb
->
s_blocksize
,

41 (*è
¬g
);

43 
FIONREAD
:

44 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
,4);

45 ià(
”rÜ
)

46  
”rÜ
;

47 
	`put_fs_lÚg
(
fp
->
f_šode
->
i_size
 - fp->
f_pos
,

48 (*è
¬g
);

51 ià(
fp
->
f_İ
 && fp->f_İ->
ioùl
)

52  
fp
->
f_İ
->
	`ioùl
(fp->
f_šode
, fp, 
cmd
,
¬g
);

53  -
EINVAL
;

54 
	}
}

57 
asmlškage
 
	$sys_ioùl
(
fd
, 
cmd
, 
¬g
)

59 
fe
 * 
fp
;

60 
Ú
;

62 ià(
fd
 >ğ
NR_OPEN
 || !(
fp
 = 
cu¼’t
->filp[fd]))

63  -
EBADF
;

64 
cmd
) {

65 
FIOCLEX
:

66 
	`FD_SET
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

69 
FIONCLEX
:

70 
	`FD_CLR
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

73 
FIONBIO
:

74 
Ú
 = 
	`g‘_fs_lÚg
((*è
¬g
);

75 ià(
Ú
)

76 
fp
->
f_æags
 |ğ
O_NONBLOCK
;

78 
fp
->
f_æags
 &ğ~
O_NONBLOCK
;

81 
FIOASYNC
:

83 
Ú
 = 
	`g‘_fs_lÚg
 ((*è
¬g
);

84 ià(
Ú
)

85 
fp
->
f_æags
 |ğ
O_SYNC
;

87 
fp
->
f_æags
 &ğ~
O_SYNC
;

91 ià(
fp
->
f_šode
 && 
	`S_ISREG
(fp->f_šode->
i_mode
))

92  
	`fe_ioùl
(
fp
,
cmd
,
¬g
);

94 ià(
fp
->
f_İ
 && fp->f_İ->
ioùl
)

95  
fp
->
f_İ
->
	`ioùl
(fp->
f_šode
, fp, 
cmd
,
¬g
);

97  -
EINVAL
;

99 
	}
}

	@fs/isofs/dir.c

11 
	~<lšux/”ºo.h
>

13 
	~<asm/£gm’t.h
>

15 
	~<lšux/fs.h
>

16 
	~<lšux/iso_fs.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/¡©.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/mm.h
>

21 
	~<lšux/m®loc.h
>

23 
isofs_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

25 
fe_İ”©iÚs
 
	gisofs_dœ_İ”©iÚs
 = {

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
isofs_»addœ
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL


40 
šode_İ”©iÚs
 
	gisofs_dœ_šode_İ”©iÚs
 = {

41 &
isofs_dœ_İ”©iÚs
,

42 
NULL
,

43 
isofs_lookup
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
isofs_bm­
,

54 
NULL
,

55 
NULL


62 
lookup_ÿche
 
	gÿche
 = {0,};

64 
	$isofs_»addœ
(
šode
 * inode, 
fe
 * 
fp
,

65 
dœ’t
 * dœ’t, 
couÁ
)

67 
bufsize
 = 
	`ISOFS_BUFFER_SIZE
(
šode
);

68 
bufb™s
 = 
	`ISOFS_BUFFER_BITS
(
šode
);

69 
block
,
off£t
,
i
, 
j
;

70 
c
 = 0;

71 
šode_numb”
;

72 
bufãr_h—d
 * 
bh
;

73 * 
ıÁ
 = 
NULL
;

74 
Şd_off£t
;

75 
dËn
, 
¼æag
;

76 * 
d²t
;

77 
iso_dœeùÜy_»cÜd
 * 
de
;

79 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

80  -
EBADF
;

82 
off£t
 = 
fp
->
f_pos
 & (
bufsize
 - 1);

83 
block
 = 
	`isofs_bm­
(
šode
,
fp
->
f_pos
>>
bufb™s
);

84 ià(!
block
 || !(
bh
 = 
	`b»ad
(
šode
->
i_dev
,block,
bufsize
)))

87 
fp
->
f_pos
 < 
šode
->
i_size
) {

88 #ifdeà
DEBUG


89 
	`´štk
("Block, offset: %x %x %x\n",

90 
block
, 
off£t
, 
fp
->
f_pos
);

92 
de
 = (
iso_dœeùÜy_»cÜd
 *è(
bh
->
b_d©a
 + 
off£t
);

93 
šode_numb”
 = (
block
 << 
bufb™s
è+ (
off£t
 & (
bufsize
 - 1));

99 ià(*((*è
de
) == 0) {

100 
	`b»l£
(
bh
);

101 
off£t
 = 0;

102 
fp
->
f_pos
 = ((fp->f_po & ~(
ISOFS_BLOCK_SIZE
 - 1))

103 + 
ISOFS_BLOCK_SIZE
);

104 
block
 = 
	`isofs_bm­
(
šode
,(
fp
->
f_pos
)>>
bufb™s
);

105 ià(!
block


106 || !(
bh
 = 
	`b»ad
(
šode
->
i_dev
,
block
,
bufsize
)))

116 
Şd_off£t
 = 
off£t
;

117 
off£t
 +ğ*((*è
de
);

118 
fp
->
f_pos
 +ğ*((*è
de
);

120 ià(
off£t
 >ğ
bufsize
) {

121 
ıÁ
 = 
	`km®loc
(1 << 
ISOFS_BLOCK_BITS
, 
GFP_KERNEL
);

122 
	`memıy
(
ıÁ
, 
bh
->
b_d©a
, 
bufsize
);

123 
de
 = (
iso_dœeùÜy_»cÜd
 *)

124 ((*)
ıÁ
 + 
Şd_off£t
);

125 
	`b»l£
(
bh
);

126 
off£t
 = 
fp
->
f_pos
 & (
bufsize
 - 1);

127 
block
 = 
	`isofs_bm­
(
šode
,(
fp
->
f_pos
)>> 
bufb™s
);

128 ià(!
block


129 || !(
bh
 = 
	`b»ad
(
šode
->
i_dev
,
block
,
bufsize
))) {

130 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

133 
	`memıy
((*)
ıÁ
+
bufsize
, 
bh
->
b_d©a
, bufsize);

138 
¼æag
 = 0;

139 
i
 = 1;

140 ià(
de
->
Çme_Ën
[0] =ğ1 && de->
Çme
[0] == 0) {

141 
	`put_fs_by‹
('.',
dœ’t
->
d_Çme
);

142 
šode_numb”
 = 
šode
->
i_šo
;

143 
d²t
 = ".";

148 ià(
de
->
Çme_Ën
[0] =ğ1 && de->
Çme
[0] == 1) {

149 
	`put_fs_by‹
('.',
dœ’t
->
d_Çme
);

150 
	`put_fs_by‹
('.',
dœ’t
->
d_Çme
+1);

151 
i
 = 2;

152 
d²t
 = "..";

153 if((
šode
->
i_sb
->
u
.
isofs_sb
.
s_fœ¡d©azÚe


154 << 
bufb™s
è!ğ
šode
->
i_šo
)

155 
šode_numb”
 = 
šode
->
u
.
isofs_i
.
i_backlšk
;

157 
šode_numb”
 = 
šode
->
i_šo
;

160 if(
šode_numb”
 == -1) {

161 
šode_numb”
 =

162 
	`isofs_lookup_g¿nd·»Á
(
šode
,

163 
	`fšd_rock_ridge_»loÿtiÚ
(
de
, 
šode
));

164 if(
šode_numb”
 == -1){

165 
	`´štk
("Backlink‚ot…roperly set.\n");

166 
out
;

175 
dËn
 = 
de
->
Çme_Ën
[0];

176 
d²t
 = 
de
->
Çme
;

177 
i
 = 
dËn
;

178 
¼æag
 = 
	`g‘_rock_ridge_f’ame
(
de
, &
d²t
, &
dËn
, 
šode
);

179 ià(
¼æag
) {

180 ià(
¼æag
 == -1) {

181 ià(
ıÁ
) {

182 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

183 
ıÁ
 = 
NULL
;

187 
i
 = 
dËn
;

190 if(
šode
->
i_sb
->
u
.
isofs_sb
.
s_m­pšg
 == 'n')

191 
i
 = 0; i < 
dËn
 && i < 
NAME_MAX
; i++) {

192 ià(!(
c
 = 
d²t
[
i
])) ;

193 ià(
c
 >= 'A' && c <= 'Z') c |= 0x20;

194 ià(
c
 =ğ'.' && 
i
 =ğ
dËn
-3 && 
de
->
Çme
[i+1] == ';' && de->name[i+2] == '1')

196 ià(
c
 =ğ';' && 
i
 =ğ
dËn
-2 && 
de
->
Çme
[i+1] == '1')

198 ià(
c
 == ';') c = '.';

199 
d²t
[
i
] = 
c
;

202 
j
=0; j<
i
; j++)

203 
	`put_fs_by‹
(
d²t
[
j
],j+
dœ’t
->
d_Çme
);

206 
	`´štk
("Nch¬: %d\n",
i
);

209 ià(
i
 && i+1 < (
ÿche
.
f’ame
)) {

210 
ÿche
.
šo
 = 
šode_numb”
;

211 
ÿche
.
dœ
 = 
šode
->
i_šo
;

212 
ÿche
.
dev
 = 
šode
->
i_dev
;

213 
	`¡ºıy
(
ÿche
.
f’ame
, 
d²t
, 
i
);

214 
ÿche
.
dËn
 = dlen;

217 ià(
¼æag
è
	`kä“
(
d²t
);

218 ià(
ıÁ
) {

219 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

220 
ıÁ
 = 
NULL
;

223 ià(
i
) {

224 
	`put_fs_lÚg
(
šode_numb”
, &
dœ’t
->
d_šo
);

225 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

226 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

227 
	`b»l£
(
bh
);

228  
i
;

233 
out
:

234 ià(
ıÁ
)

235 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

236 
	`b»l£
(
bh
);

238 
	}
}

	@fs/isofs/file.c

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/iso_fs.h
>

16 
	~<lšux/fú.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/¡©.h
>

20 
	~<lšux/locks.h
>

22 
	~<lšux/dœ’t.h
>

24 
	#NBUF
 32

	)

26 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

27 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

29 
	~<lšux/fs.h
>

30 
	~<lšux/iso_fs.h
>

32 
isofs_fe_»ad
(
šode
 *, 
fe
 *, *, );

38 
fe_İ”©iÚs
 
	gisofs_fe_İ”©iÚs
 = {

39 
NULL
,

40 
isofs_fe_»ad
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
g’”ic_mm­
,

46 
NULL
,

47 
NULL
,

48 
NULL


51 
šode_İ”©iÚs
 
	gisofs_fe_šode_İ”©iÚs
 = {

52 &
isofs_fe_İ”©iÚs
,

53 
NULL
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
isofs_bm­
,

65 
NULL
,

66 
NULL


75 
šlše
 
	$unixify_‹xt_bufãr
(* 
bufãr
, 
ch¬s
, 
mode
)

77 
ch¬s
--){

78 if(*
bufãr
 == 0x1a) *buffer = 0x0a;

79 if(*
bufãr
 == 0x0d){

80 if(
mode
 =ğ
ISOFS_FILE_TEXT_M
è*
bufãr
 = 0x0a;

81 if(
mode
 =ğ
ISOFS_FILE_TEXT
è*
bufãr
 = ' ';

83 
bufãr
++;

85 
	}
}

89 
	$isofs_d‘”mše_f‘y³
(
šode
 * inode)

91 
block
;

92 
»suÉ
, 
i
;

93 
bufãr_h—d
 * 
bh
;

94 * 
²t
;

96 
block
 = 
	`isofs_bm­
(
šode
,0);

97 ià(
block
 && (
bh
 = 
	`b»ad
(
šode
->
i_dev
,block, 
	`ISOFS_BUFFER_SIZE
(inode)))) {

98 
²t
 = (*è
bh
->
b_d©a
;

99 
»suÉ
 = 
ISOFS_FILE_TEXT_M
;

100 
i
=0;i<(
šode
->
i_size
 < 
	`ISOFS_BUFFER_SIZE
(inode) ? inode->i_size : ISOFS_BUFFER_SIZE(inode));

101 
i
++,
²t
++){

102 if(*
²t
 & 0x80è{
»suÉ
 = 
ISOFS_FILE_BINARY
; ;};

103 if(*
²t
 >= 0x20 || *pnt == 0x1a) ;

104 if(*
²t
 =ğ0x0aè{
»suÉ
 = 
ISOFS_FILE_TEXT
; ;};

105 if(*
²t
 >= 0x9 && *pnt <= 0x0d) ;

106 
»suÉ
 = 
ISOFS_FILE_BINARY
;

109 
	`b»l£
(
bh
);

110 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 = 
»suÉ
;

112 
	}
}

114 
	$isofs_fe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

116 
»ad
,
Ëá
,
ch¬s
;

117 
block
, 
blocks
, 
off£t
;

118 
bh»que¡
;

119 
¿_blocks
, 
max_block
, 
Ãxtblock
;

120 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

121 
bufãr_h—d
 * 
bh»q
[
NBUF
];

122 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

124 ià(!
šode
) {

125 
	`´štk
("isofs_file_read: inode = NULL\n");

126  -
EINVAL
;

128 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode))) {

129 
	`´štk
("isofs_fe_»ad: modğ%07o\n",
šode
->
i_mode
);

130  -
EINVAL
;

132 ià(
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 =ğ
ISOFS_FILE_UNKNOWN
)

133 
	`isofs_d‘”mše_f‘y³
(
šode
);

134 ià(
fp
->
f_pos
 > 
šode
->
i_size
)

135 
Ëá
 = 0;

137 
Ëá
 = 
šode
->
i_size
 - 
fp
->
f_pos
;

138 ià(
Ëá
 > 
couÁ
)

139 
Ëá
 = 
couÁ
;

140 ià(
Ëá
 <= 0)

142 
»ad
 = 0;

143 
block
 = 
fp
->
f_pos
 >> 
	`ISOFS_BUFFER_BITS
(
šode
);

144 
off£t
 = 
fp
->
f_pos
 & (
	`ISOFS_BUFFER_SIZE
(
šode
)-1);

145 
blocks
 = (
Ëá
 + 
off£t
 + 
	`ISOFS_BUFFER_SIZE
(
šode
) - 1) / ISOFS_BUFFER_SIZE(inode);

146 
bhb
 = 
bhe
 = 
buæi¡
;

148 
¿_blocks
 = 
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] / (
BLOCK_SIZE
 >> 9);

149 
max_block
 = (
šode
->
i_size
 + 
BLOCK_SIZE
 - 1)/BLOCK_SIZE;

150 
Ãxtblock
 = -1;

163 
bh»que¡
 = 0;

164 
blocks
) {

165 
u±od©e
;

166 --
blocks
;

167 *
bhb
 = 
	`g‘blk
(
šode
->
i_dev
,
	`isofs_bm­
(šode, 
block
++), 
	`ISOFS_BUFFER_SIZE
(inode));

168 
u±od©e
 = 1;

169 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

170 
u±od©e
 = 0;

171 
bh»q
[
bh»que¡
++] = *
bhb
;

172 
Ãxtblock
 = (*
bhb
)->
b_blockÄ
 + 1;

175 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

176 
bhb
 = 
buæi¡
;

180 if(
bh»que¡
 =ğ0 && 
u±od©e
) ;

182 ià(
bhb
 =ğ
bhe
)

186 if(
blocks
 =ğ0 && 
bh»que¡
 && 
fp
->
f_»ada
 && 
bhb
 !ğ
bhe
) {

189 
¿_blocks
){

190 ià(
block
 >ğ
max_block
) ;

191 if(
bh»que¡
 =ğ
NBUF
) ;

192 --
¿_blocks
;

193 *
bhb
 = 
	`g‘blk
(
šode
->
i_dev
,
	`isofs_bm­
(šode, 
block
++), 
	`ISOFS_BUFFER_SIZE
(inode));

195 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

196 if((*
bhb
)->
b_blockÄ
 !ğ
Ãxtblock
) {

197 
	`b»l£
(*
bhb
);

200 
Ãxtblock
 = (*
bhb
)->
b_blockÄ
 + 1;

201 
bh»q
[
bh»que¡
++] = *
bhb
;

204 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

205 
bhb
 = 
buæi¡
;

207 ià(
bhb
 =ğ
bhe
)

212 ià(
bh»que¡
)

213 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

216 ià(*
bhe
) {

217 
	`wa™_Ú_bufãr
(*
bhe
);

218 ià(!(*
bhe
)->
b_u±od©e
) {

219 
	`b»l£
(*
bhe
);

220 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

221 
bhe
 = 
buæi¡
;

222 
Ëá
 = 0;

227 ià(
Ëá
 < 
	`ISOFS_BUFFER_SIZE
(
šode
è- 
off£t
)

228 
ch¬s
 = 
Ëá
;

230 
ch¬s
 = 
	`ISOFS_BUFFER_SIZE
(
šode
è- 
off£t
;

231 
fp
->
f_pos
 +ğ
ch¬s
;

232 
Ëá
 -ğ
ch¬s
;

233 
»ad
 +ğ
ch¬s
;

234 ià(*
bhe
) {

235 ià(
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 =ğ
ISOFS_FILE_TEXT
 ||

236 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 =ğ
ISOFS_FILE_TEXT_M
)

237 
	`unixify_‹xt_bufãr
(
off£t
+(*
bhe
)->
b_d©a
,

238 
ch¬s
, 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
);

239 
	`memıy_tofs
(
buf
,
off£t
+(*
bhe
)->
b_d©a
,
ch¬s
);

240 
	`b»l£
(*
bhe
);

241 
buf
 +ğ
ch¬s
;

243 
ch¬s
-->0)

244 
	`put_fs_by‹
(0,
buf
++);

246 
off£t
 = 0;

247 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

248 
bhe
 = 
buæi¡
;

249 }  
bhe
 !ğ
bhb
 && (*bh=ğ0 || !(*bhe)->
b_lock
) &&

250 (
Ëá
 > 0));

251 } 
Ëá
 > 0);

254 
bhe
 !ğ
bhb
) {

255 ià(*
bhe
è
	`b»l£
(*bhe);

256 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

257 
bhe
 = 
buæi¡
;

260 
fp
->
f_»ada
 = 1;

262 ià(!
»ad
)

263  -
EIO
;

264  
»ad
;

265 
	}
}

	@fs/isofs/inode.c

9 
	~<lšux/cÚfig.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/iso_fs.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/majÜ.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/locks.h
>

18 
	~<lšux/m®loc.h
>

19 
	~<lšux/”ºo.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/£gm’t.h
>

24 #ià
defšed
(
CONFIG_BLK_DEV_SR
)

25 
check_cdrom_medŸ_chªge
(, );

27 #ià
defšed
(
CONFIG_CDU31A
)

28 
check_cdu31a_medŸ_chªge
(, );

30 #ià
defšed
(
CONFIG_MCD
)

31 
check_mcd_medŸ_chªge
(, );

33 #ià
defšed
 (
CONFIG_SBPCD
)

34 
check_sbpcd_medŸ_chªge
(, );

37 #ifdeà
LEAK_CHECK


38 
	gcheck_m®loc
 = 0;

39 
	gcheck_b»ad
 = 0;

42 
	$isofs_put_su³r
(
su³r_block
 *
sb
)

44 
	`lock_su³r
(
sb
);

46 #ifdeà
LEAK_CHECK


47 
	`´štk
("Outstanding mallocs:%d, outstanding buffers: %d\n",

48 
check_m®loc
, 
check_b»ad
);

50 
sb
->
s_dev
 = 0;

51 
	`uÆock_su³r
(
sb
);

53 
	}
}

55 
su³r_İ”©iÚs
 
	gisofs_sİs
 = {

56 
isofs_»ad_šode
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
isofs_put_su³r
,

61 
NULL
,

62 
isofs_¡©fs
,

63 
NULL


68 
	$·r£_İtiÚs
(*
İtiÚs
,*
m­
,*
cÚv”siÚ
, * 
rock
, * 
üuá
, * 
blocksize
)

70 *
this_ch¬
,*
v®ue
;

72 *
m­
 = 'n';

73 *
rock
 = 'y';

74 *
üuá
 = 'n';

75 *
cÚv”siÚ
 = 'a';

76 *
blocksize
 = 1024;

77 ià(!
İtiÚs
)  1;

78 
this_ch¬
 = 
	`¡¹ok
(
İtiÚs
,",");his_ch¬;his_ch¬ = sŒtok(
NULL
,",")) {

79 ià(
	`¡ºcmp
(
this_ch¬
,"norock",6) == 0) {

80 *
rock
 = 'n';

83 ià(
	`¡ºcmp
(
this_ch¬
,"cruft",5) == 0) {

84 *
üuá
 = 'y';

87 ià((
v®ue
 = 
	`¡rchr
(
this_ch¬
,'=')è!ğ
NULL
)

88 *
v®ue
++ = 0;

89 ià(!
	`¡rcmp
(
this_ch¬
,"m­"è&& 
v®ue
) {

90 ià(
v®ue
[0] && !v®ue[1] && 
	`¡rchr
("on",*value))

91 *
m­
 = *
v®ue
;

92 ià(!
	`¡rcmp
(
v®ue
,"off")è*
m­
 = 'o';

93 ià(!
	`¡rcmp
(
v®ue
,"nÜm®")è*
m­
 = 'n';

96 ià(!
	`¡rcmp
(
this_ch¬
,"cÚv"è&& 
v®ue
) {

97 ià(
v®ue
[0] && !v®ue[1] && 
	`¡rchr
("bta",*value))

98 *
cÚv”siÚ
 = *
v®ue
;

99 ià(!
	`¡rcmp
(
v®ue
,"bš¬y")è*
cÚv”siÚ
 = 'b';

100 ià(!
	`¡rcmp
(
v®ue
,"‹xt")è*
cÚv”siÚ
 = 't';

101 ià(!
	`¡rcmp
(
v®ue
,"m‹xt")è*
cÚv”siÚ
 = 'm';

102 ià(!
	`¡rcmp
(
v®ue
,"auto")è*
cÚv”siÚ
 = 'a';

105 ià(!
	`¡rcmp
(
this_ch¬
,"block"è&& 
v®ue
) {

106 * 
v²t
 = 
v®ue
;

107 
iv®ue
;

108 
iv®ue
 = 0;

109 *
v²t
){

110 if(*
v²t
 < '0' || *vpnt > '9') ;

111 
iv®ue
 = iv®u* 10 + (*
v²t
 - '0');

112 
v²t
++;

114 ià(*
v²t
)  0;

115 ià(
iv®ue
 != 1024 && ivalue != 2048)  0;

116 *
blocksize
 = 
iv®ue
;

121 
	}
}

123 
su³r_block
 *
	$isofs_»ad_su³r
(
su³r_block
 *
s
,*
d©a
,

124 
s’t
)

126 
bufãr_h—d
 *
bh
;

127 
iso_blknum
;

128 
blocksize
, 
blocksize_b™s
;

129 
high_s›¼a
;

130 
dev
=
s
->
s_dev
;

131 
iso_vŞume_desütÜ
 *
vdp
;

132 
hs_vŞume_desütÜ
 *
hdp
;

134 
iso_´im¬y_desütÜ
 *
´i
 = 
NULL
;

135 
hs_´im¬y_desütÜ
 *
h_´i
 = 
NULL
;

137 
iso_dœeùÜy_»cÜd
 *
roÙp
;

139 
m­
, 
cÚv”siÚ
, 
rock
, 
üuá
;

141 ià(!
	`·r£_İtiÚs
((*è
d©a
,&
m­
,&
cÚv”siÚ
, &
rock
, &
üuá
, &
blocksize
)) {

142 
s
->
s_dev
 = 0;

143  
NULL
;

146 
blocksize_b™s
 = 0;

148 
i
 = 
blocksize
;

149 
i
 != 1){

150 
blocksize_b™s
++;

151 
i
 >>=1;

154 
	`£t_blocksize
(
dev
, 
blocksize
);

156 
	`lock_su³r
(
s
);

158 
s
->
u
.
isofs_sb
.
s_high_s›¼a
 = 
high_s›¼a
 = 0;

160 
iso_blknum
 = 16; iso_blknum < 100; iso_blknum++) {

161 ià(!(
bh
 = 
	`b»ad
(
dev
, 
iso_blknum
 << (
ISOFS_BLOCK_BITS
-
blocksize_b™s
), 
blocksize
))) {

162 
s
->
s_dev
=0;

163 
	`´štk
("isofs_read_super: bread failed, dev 0x%x iso_blknum %d\n",

164 
dev
, 
iso_blknum
);

165 
	`uÆock_su³r
(
s
);

166  
NULL
;

169 
vdp
 = (
iso_vŞume_desütÜ
 *)
bh
->
b_d©a
;

170 
hdp
 = (
hs_vŞume_desütÜ
 *)
bh
->
b_d©a
;

173 ià(
	`¡ºcmp
 (
hdp
->
id
, 
HS_STANDARD_ID
,  hdp->id) == 0) {

174 ià(
	`isÚum_711
 (
hdp
->
ty³
è!ğ
ISO_VD_PRIMARY
)

175 
out
;

176 ià(
	`isÚum_711
 (
hdp
->
ty³
è=ğ
ISO_VD_END
)

177 
out
;

179 
s
->
u
.
isofs_sb
.
s_high_s›¼a
 = 1;

180 
high_s›¼a
 = 1;

181 
rock
 = 'n';

182 
h_´i
 = (
hs_´im¬y_desütÜ
 *)
vdp
;

186 ià(
	`¡ºcmp
 (
vdp
->
id
, 
ISO_STANDARD_ID
,  vdp->id) == 0) {

187 ià(
	`isÚum_711
 (
vdp
->
ty³
è!ğ
ISO_VD_PRIMARY
)

188 
out
;

189 ià(
	`isÚum_711
 (
vdp
->
ty³
è=ğ
ISO_VD_END
)

190 
out
;

192 
´i
 = (
iso_´im¬y_desütÜ
 *)
vdp
;

196 
	`b»l£
(
bh
);

198 if(
iso_blknum
 == 100) {

199 ià(!
s’t
)

200 
	`´štk
("Unableo identify CD-ROM format.\n");

201 
s
->
s_dev
 = 0;

202 
	`uÆock_su³r
(
s
);

203  
NULL
;

207 if(
high_s›¼a
){

208 
roÙp
 = (
iso_dœeùÜy_»cÜd
 *è
h_´i
->
roÙ_dœeùÜy_»cÜd
;

209 ià(
	`isÚum_723
 (
h_´i
->
vŞume_£t_size
) != 1) {

210 
	`´štk
("Multi-volume disks‚ot (yet) supported.\n");

211 
out
;

213 
s
->
u
.
isofs_sb
.
s_nzÚes
 = 
	`isÚum_733
 (
h_´i
->
vŞume_¥aû_size
);

214 
s
->
u
.
isofs_sb
.
s_log_zÚe_size
 = 
	`isÚum_723
 (
h_´i
->
logiÿl_block_size
);

215 
s
->
u
.
isofs_sb
.
s_max_size
 = 
	`isÚum_733
(
h_´i
->
vŞume_¥aû_size
);

217 
roÙp
 = (
iso_dœeùÜy_»cÜd
 *è
´i
->
roÙ_dœeùÜy_»cÜd
;

218 ià(
	`isÚum_723
 (
´i
->
vŞume_£t_size
) != 1) {

219 
	`´štk
("Multi-volume disks‚ot (yet) supported.\n");

220 
out
;

222 
s
->
u
.
isofs_sb
.
s_nzÚes
 = 
	`isÚum_733
 (
´i
->
vŞume_¥aû_size
);

223 
s
->
u
.
isofs_sb
.
s_log_zÚe_size
 = 
	`isÚum_723
 (
´i
->
logiÿl_block_size
);

224 
s
->
u
.
isofs_sb
.
s_max_size
 = 
	`isÚum_733
(
´i
->
vŞume_¥aû_size
);

227 
s
->
u
.
isofs_sb
.
s_nšodes
 = 0;

229 
s
->
u
.
isofs_sb
.
s_fœ¡d©azÚe
 = 
	`isÚum_733
Ğ
roÙp
->
ex‹Á
) <<

230 (
ISOFS_BLOCK_BITS
 - 
blocksize_b™s
);

231 
s
->
s_magic
 = 
ISOFS_SUPER_MAGIC
;

238 
s
->
s_æags
 = 
MS_RDONLY
 ;

240 if(
s
->
u
.
isofs_sb
.
s_log_zÚe_size
 !ğ(1 << 
ISOFS_BLOCK_BITS
)) {

241 
	`´štk
("1 <<Block bits != Block size\n");

242 
out
;

245 
	`b»l£
(
bh
);

247 
	`´štk
("Max size:%ld Log zone size:%ld\n",

248 
s
->
u
.
isofs_sb
.
s_max_size
,

249 
s
->
u
.
isofs_sb
.
s_log_zÚe_size
);

250 
	`´štk
("First datazone:%ld Root inode‚umber %d\n",

251 
s
->
u
.
isofs_sb
.
s_fœ¡d©azÚe
,

252 
	`isÚum_733
 (
roÙp
->
ex‹Á
è<< 
ISOFS_BLOCK_BITS
);

253 if(
high_s›¼a
è
	`´štk
("Disc in High Sierra format.\n");

254 
	`uÆock_su³r
(
s
);

257 
s
->
s_dev
 = 
dev
;

258 
s
->
s_İ
 = &
isofs_sİs
;

259 
s
->
u
.
isofs_sb
.
s_m­pšg
 = 
m­
;

260 
s
->
u
.
isofs_sb
.
s_rock
 = (
rock
 == 'y' ? 1 : 0);

261 
s
->
u
.
isofs_sb
.
s_cÚv”siÚ
 = 
cÚv”siÚ
;

262 
s
->
u
.
isofs_sb
.
s_üuá
 = 
üuá
;

263 
s
->
s_blocksize
 = 
blocksize
;

264 
s
->
s_blocksize_b™s
 = 
blocksize_b™s
;

265 
s
->
s_mouÁed
 = 
	`ig‘
(s, 
	`isÚum_733
 (
roÙp
->
ex‹Á
è<< 
ISOFS_BLOCK_BITS
);

266 
	`uÆock_su³r
(
s
);

268 ià(!(
s
->
s_mouÁed
)) {

269 
s
->
s_dev
=0;

270 
	`´štk
("get„oot inode failed\n");

271  
NULL
;

273 #ià
	`defšed
(
CONFIG_BLK_DEV_SR
è&& defšed(
CONFIG_SCSI
)

274 ià(
	`MAJOR
(
s
->
s_dev
è=ğ
SCSI_CDROM_MAJOR
) {

276 if(
	`check_cdrom_medŸ_chªge
(
s
->
s_dev
, 0))

277 
out
;

280 #ià
	`defšed
(
CONFIG_CDU31A
)

281 ià(
	`MAJOR
(
s
->
s_dev
è=ğ
CDU31A_CDROM_MAJOR
) {

283 if(
	`check_cdu31a_medŸ_chªge
(
s
->
s_dev
, 0))

284 
out
;

287 #ià
	`defšed
(
CONFIG_MCD
)

288 ià(
	`MAJOR
(
s
->
s_dev
è=ğ
MITSUMI_CDROM_MAJOR
) {

290 if(
	`check_mcd_medŸ_chªge
(
s
->
s_dev
, 0))

291 
out
;

294 #ià
	`defšed
(
CONFIG_SBPCD
)

295 ià(
	`MAJOR
(
s
->
s_dev
è=ğ
MATSUSHITA_CDROM_MAJOR
) {

296 ià(
	`check_sbpcd_medŸ_chªge
(
s
->
s_dev
,0))

297 
out
;

301  
s
;

302 
out
:

303 
	`b»l£
(
bh
);

304 
s
->
s_dev
 = 0;

305 
	`uÆock_su³r
(
s
);

306  
NULL
;

307 
	}
}

309 
	$isofs_¡©fs
 (
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

311 
	`put_fs_lÚg
(
ISOFS_SUPER_MAGIC
, &
buf
->
f_ty³
);

312 
	`put_fs_lÚg
(1 << 
ISOFS_BLOCK_BITS
, &
buf
->
f_bsize
);

313 
	`put_fs_lÚg
(
sb
->
u
.
isofs_sb
.
s_nzÚes
, &
buf
->
f_blocks
);

314 
	`put_fs_lÚg
(0, &
buf
->
f_bä“
);

315 
	`put_fs_lÚg
(0, &
buf
->
f_bava
);

316 
	`put_fs_lÚg
(
sb
->
u
.
isofs_sb
.
s_nšodes
, &
buf
->
f_fes
);

317 
	`put_fs_lÚg
(0, &
buf
->
f_fä“
);

318 
	`put_fs_lÚg
(
NAME_MAX
, &
buf
->
f_Çm–’
);

320 
	}
}

322 
	$isofs_bm­
(
šode
 * inode,
block
)

325 ià(
block
<0) {

326 
	`´štk
("_isofs_bmap: block<0");

329  
šode
->
u
.
isofs_i
.
i_fœ¡_ex‹Á
 + 
block
;

330 
	}
}

332 
	$isofs_»ad_šode
(
šode
 * inode)

334 
bufsize
 = 
	`ISOFS_BUFFER_SIZE
(
šode
);

335 
bufãr_h—d
 * 
bh
;

336 
iso_dœeùÜy_»cÜd
 * 
¿w_šode
;

337 *
²t
 = 
NULL
;

338 *
ıÁ
 = 
NULL
;

339 
high_s›¼a
;

340 
block
;

341 
i
;

343 
block
 = 
šode
->
i_šo
 >> 
	`ISOFS_BUFFER_BITS
(inode);

344 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
,
block
, 
bufsize
))) {

345 
	`´štk
("unableo„ead i-node block");

346 
ç
;

349 
²t
 = ((*è
bh
->
b_d©a


350 + (
šode
->
i_šo
 & (
bufsize
 - 1)));

351 
¿w_šode
 = ((
iso_dœeùÜy_»cÜd
 *è
²t
);

352 
high_s›¼a
 = 
šode
->
i_sb
->
u
.
isofs_sb
.
s_high_s›¼a
;

354 ià((
šode
->
i_šo
 & (
bufsize
 - 1)è+ *
²t
 > bufsize){

355 
ıÁ
 = 
	`km®loc
(1 << 
ISOFS_BLOCK_BITS
, 
GFP_KERNEL
);

356 ià(
ıÁ
 =ğ
NULL
) {

357 
	`´štk
(
KERN_INFO
 "NoMem ISO inod%d\n",
šode
->
i_šo
);

358 
	`b»l£
(
bh
);

359 
ç
;

361 
	`memıy
(
ıÁ
, 
bh
->
b_d©a
, 
bufsize
);

362 
	`b»l£
(
bh
);

363 ià(!(
bh
 = 
	`b»ad
(
šode
->
i_dev
,++
block
, 
bufsize
))) {

364 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

365 
	`´štk
("unableo„ead i-node block");

366 
ç
;

368 
	`memıy
((*)
ıÁ
 + 
bufsize
, 
bh
->
b_d©a
, bufsize);

369 
²t
 = ((*è
ıÁ


370 + (
šode
->
i_šo
 & (
bufsize
 - 1)));

371 
¿w_šode
 = ((
iso_dœeùÜy_»cÜd
 *è
²t
);

374 
šode
->
i_mode
 = 
S_IRUGO
;

375 
šode
->
i_Æšk
 = 1;

377 ià(
¿w_šode
->
æags
[-
high_s›¼a
] & 2) {

378 
šode
->
i_mode
 = 
S_IRUGO
 | 
S_IXUGO
 | 
S_IFDIR
;

379 
šode
->
i_Æšk
 = 2;

382 
šode
->
i_mode
 = 
S_IRUGO
;

383 
šode
->
i_Æšk
 = 1;

384 
šode
->
i_mode
 |ğ
S_IFREG
;

386 
i
=0; i< 
¿w_šode
->
Çme_Ën
[0]; i++)

387 if(
¿w_šode
->
Çme
[
i
]=='.' ||„aw_inode->name[i]==';')

389 if(
i
 =ğ
¿w_šode
->
Çme_Ën
[0] ||„aw_šode->
Çme
[i] == ';')

390 
šode
->
i_mode
 |ğ
S_IXUGO
;

392 
šode
->
i_uid
 = 0;

393 
šode
->
i_gid
 = 0;

394 
šode
->
i_size
 = 
	`isÚum_733
 (
¿w_šode
->
size
);

398 if((
šode
->
i_size
 < 0 || inode->i_size > 700000000) &&

399 
šode
->
i_sb
->
u
.
isofs_sb
.
s_üuá
 == 'n') {

400 
	`´štk
("Warning: defective cdrom. Enabling \"cruft\" mount option.\n");

401 
šode
->
i_sb
->
u
.
isofs_sb
.
s_üuá
 = 'y';

408 if(
šode
->
i_sb
->
u
.
isofs_sb
.
s_üuá
 == 'y' &&

409 
šode
->
i_size
 & 0xff000000){

411 
šode
->
i_size
 &= 0x00ffffff;

414 ià(
¿w_šode
->
š‹¾—ve
[0]) {

415 
	`´štk
("Interleaved files‚ot (yet) supported.\n");

416 
šode
->
i_size
 = 0;

419 #ifdeà
DEBUG


422 if(
¿w_šode
->
ext_©Œ_Ëngth
[0] != 0){

423 
	`´štk
("Extended‡ttributes…resent for ISO file (%ld).\n",

424 
šode
->
i_šo
);

430 if(
¿w_šode
->
fe_un™_size
[0] != 0){

431 
	`´štk
("Fun™ siz!ğ0 fÜ ISO f(%ld).\n",
šode
->
i_šo
);

436 if((
¿w_šode
->
æags
[-
high_s›¼a
] & ~2)!= 0){

437 
	`´štk
("Unusual flag settings for ISO file (%ld %x).\n",

438 
šode
->
i_šo
, 
¿w_šode
->
æags
[-
high_s›¼a
]);

441 #ifdeà
DEBUG


442 
	`´štk
("G‘ inod%d: %d %d: %d\n",
šode
->
i_šo
, 
block
,

443 (()
²t
è& 0x3ff, 
šode
->
i_size
);

446 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 =

447 
	`iso_d©e
(
¿w_šode
->
d©e
, 
high_s›¼a
);

449 
šode
->
u
.
isofs_i
.
i_fœ¡_ex‹Á
 = 
	`isÚum_733
 (
¿w_šode
->
ex‹Á
) <<

450 (
ISOFS_BLOCK_BITS
 - 
	`ISOFS_BUFFER_BITS
(
šode
));

452 
šode
->
u
.
isofs_i
.
i_backlšk
 = 0xffffffff;

453 
šode
->
i_sb
->
u
.
isofs_sb
.
s_cÚv”siÚ
){

455 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 = 
ISOFS_FILE_UNKNOWN
;

458 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 = 
ISOFS_FILE_BINARY
;

461 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 = 
ISOFS_FILE_TEXT
;

464 
šode
->
u
.
isofs_i
.
i_fe_fÜm©
 = 
ISOFS_FILE_TEXT_M
;

471 ià(!
high_s›¼a
)

472 
	`·r£_rock_ridge_šode
(
¿w_šode
, 
šode
);

474 #ifdeà
DEBUG


475 
	`´štk
("Inode: %xƒx‹Á: %x\n",
šode
->
i_šo
, inode->
u
.
isofs_i
.
i_fœ¡_ex‹Á
);

477 
	`b»l£
(
bh
);

479 
šode
->
i_İ
 = 
NULL
;

480 ià(
šode
->
i_sb
->
u
.
isofs_sb
.
s_üuá
 != 'y' &&

481 
	`isÚum_723
 (
¿w_šode
->
vŞume_£qu’û_numb”
) != 1) {

482 
	`´štk
("Multi volume CD somehow got mounted.\n");

484 ià(
	`S_ISREG
(
šode
->
i_mode
))

485 
šode
->
i_İ
 = &
isofs_fe_šode_İ”©iÚs
;

486 ià(
	`S_ISDIR
(
šode
->
i_mode
))

487 
šode
->
i_İ
 = &
isofs_dœ_šode_İ”©iÚs
;

488 ià(
	`S_ISLNK
(
šode
->
i_mode
))

489 
šode
->
i_İ
 = &
isofs_symlšk_šode_İ”©iÚs
;

490 ià(
	`S_ISCHR
(
šode
->
i_mode
))

491 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

492 ià(
	`S_ISBLK
(
šode
->
i_mode
))

493 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

494 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

495 
	`š™_fifo
(
šode
);

497 ià(
ıÁ
) {

498 
	`kä“_s
 (
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

499 
ıÁ
 = 
NULL
;

502 
ç
:

504 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 0;

505 
šode
->
u
.
isofs_i
.
i_fœ¡_ex‹Á
 = 0;

506 
šode
->
u
.
isofs_i
.
i_backlšk
 = 0xffffffff;

507 
šode
->
i_size
 = 0;

508 
šode
->
i_Æšk
 = 1;

509 
šode
->
i_uid
 = inode->
i_gid
 = 0;

510 
šode
->
i_mode
 = 
S_IFREG
;

511 
šode
->
i_İ
 = 
NULL
;

513 
	}
}

534 
	$isofs_lookup_g¿nd·»Á
(
šode
 * 
·»Á
, 
ex‹Á
)

536 
bufsize
 = 
	`ISOFS_BUFFER_SIZE
(
·»Á
);

537 
bufb™s
 = 
	`ISOFS_BUFFER_BITS
(
·»Á
);

538 
block
,
off£t
;

539 
·»Á_dœ
, 
šode_numb”
;

540 
Şd_off£t
;

541 * 
ıÁ
 = 
NULL
;

542 
»suÉ
;

543 
bufãr_h—d
 * 
bh
;

544 
iso_dœeùÜy_»cÜd
 * 
de
;

546 
off£t
 = 0;

547 
block
 = 
ex‹Á
 << (
ISOFS_BLOCK_BITS
 - 
bufb™s
);

548 ià(!(
bh
 = 
	`b»ad
(
·»Á
->
i_dev
, 
block
, 
bufsize
)))  -1;

551 
de
 = (
iso_dœeùÜy_»cÜd
 *è(
bh
->
b_d©a
 + 
off£t
);

552 ià(*((*è
de
) == 0)

554 
	`b»l£
(
bh
);

558 
off£t
 +ğ*((*è
de
);

560 ià(
off£t
 >ğ
bufsize
)

562 
	`´štk
(".. Directory‚ot in first block"

564 
	`b»l£
(
bh
);

568 ià(
de
->
Çme_Ën
[0] =ğ1 && de->
Çme
[0] == 1)

570 
·»Á_dœ
 = 
	`fšd_rock_ridge_»loÿtiÚ
(
de
, 
·»Á
);

571 
	`b»l£
(
bh
);

575 #ifdeà
DEBUG


576 
	`´štk
("P¬’ˆdœ:%x\n",
·»Á_dœ
);

582 
»suÉ
 = -1;

584 
off£t
 = 0;

585 
block
 = 
·»Á_dœ
 << (
ISOFS_BLOCK_BITS
 - 
bufb™s
);

586 ià(!
block
 || !(
bh
 = 
	`b»ad
(
·»Á
->
i_dev
,block, 
bufsize
)))

591 
de
 = (
iso_dœeùÜy_»cÜd
 *è(
bh
->
b_d©a
 + 
off£t
);

592 
šode_numb”
 = (
block
 << 
bufb™s
)+(
off£t
 & (
bufsize
 - 1));

598 ià(*((*è
de
) == 0)

600 
	`b»l£
(
bh
);

601 
off£t
 = 0;

602 
block
++;

603 if(
block
 & 1)  -1;

604 ià(!
block


605 || !(
bh
 = 
	`b»ad
(
·»Á
->
i_dev
,
block
, 
bufsize
)))

614 
Şd_off£t
 = 
off£t
;

615 
off£t
 +ğ*((*è
de
);

617 ià(
off£t
 >ğ
bufsize
)

619 if((
block
 & 1) != 0)  -1;

620 
ıÁ
 = 
	`km®loc
(1<<
ISOFS_BLOCK_BITS
,
GFP_KERNEL
);

621 
	`memıy
(
ıÁ
, 
bh
->
b_d©a
, 
bufsize
);

622 
de
 = (
iso_dœeùÜy_»cÜd
 *)

623 ((*)
ıÁ
 + 
Şd_off£t
);

624 
	`b»l£
(
bh
);

625 
off£t
 -ğ
bufsize
;

626 
block
++;

627 ià(!(
bh
 = 
	`b»ad
(
·»Á
->
i_dev
,
block
,
bufsize
))) {

628 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

631 
	`memıy
((*)
ıÁ
+
bufsize
, 
bh
->
b_d©a
, bufsize);

634 ià(
	`fšd_rock_ridge_»loÿtiÚ
(
de
, 
·»Á
è=ğ
ex‹Á
){

635 
»suÉ
 = 
šode_numb”
;

636 
out
;

639 ià(
ıÁ
) {

640 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

641 
ıÁ
 = 
NULL
;

648 
out
:

649 ià(
ıÁ
) {

650 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

651 
ıÁ
 = 
NULL
;

653 
	`b»l£
(
bh
);

654 #ifdeà
DEBUG


655 
	`´štk
("ResuÉªˆInod%d\n",
»suÉ
);

657  
»suÉ
;

658 
	}
}

660 #ifdeà
LEAK_CHECK


661 #undeà
m®loc


662 #undeà
ä“_s


663 #undeà
b»ad


664 #undeà
b»l£


666 * 
	$Ëak_check_m®loc
(
size
){

667 * 
tmp
;

668 
check_m®loc
++;

669 
tmp
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

670  
tmp
;

671 
	}
}

673 
	$Ëak_check_ä“_s
(* 
obj
, 
size
){

674 
check_m®loc
--;

675  
	`kä“_s
(
obj
, 
size
);

676 
	}
}

678 
bufãr_h—d
 * 
	$Ëak_check_b»ad
(
dev
, 
block
, 
size
){

679 
check_b»ad
++;

680  
	`b»ad
(
dev
, 
block
, 
size
);

681 
	}
}

683 
	$Ëak_check_b»l£
(
bufãr_h—d
 * 
bh
){

684 
check_b»ad
--;

685  
	`b»l£
(
bh
);

686 
	}
}

	@fs/isofs/namei.c

9 
	~<lšux/sched.h
>

10 
	~<lšux/iso_fs.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/fú.h
>

15 
	~<asm/£gm’t.h
>

16 
	~<lšux/m®loc.h
>

18 
	~<lšux/”ºo.h
>

27 
	$isofs_m©ch
(
Ën
,cÚ¡ * 
Çme
, * 
com·»
, 
dËn
)

29 
§me
 
	`__asm__
("ax");

31 ià(!
com·»
)  0;

33 ià(!
Ën
 && (
com·»
[0]==0è&& (
dËn
==1))

36 ià(
com·»
[0]==0 && 
dËn
==1 && 
Ën
 == 1)

37 
com·»
 = ".";

38 ià(
com·»
[0]==1 && 
dËn
==1 && 
Ën
 == 2) {

39 
com·»
 = "..";

40 
dËn
 = 2;

43 ià(
Ën
 <ğ2è
	`´štk
("M©ch: %d %d % %d %d \n",Ën,
dËn
,
com·»
,
de
->
Çme
[0], dlen);

46 ià(
dËn
 !ğ
Ën
)

48 
	`__asm__
("cld\n\t"

51 :"÷" (
§me
)

52 :"0" (0),"S" ((è
Çme
),"D" ((è
com·»
),"c" (
Ën
)

54  
§me
;

55 
	}
}

65 
bufãr_h—d
 * 
	$isofs_fšd_’Œy
(
šode
 * 
dœ
,

66 cÚ¡ * 
Çme
, 
Çm–’
, * 
šo
, * 
šo_back
)

68 
bufsize
 = 
	`ISOFS_BUFFER_SIZE
(
dœ
);

69 
bufb™s
 = 
	`ISOFS_BUFFER_BITS
(
dœ
);

70 
block
, 
i
, 
f_pos
, 
off£t
, 
šode_numb”
;

71 
bufãr_h—d
 * 
bh
;

72 * 
ıÁ
 = 
NULL
;

73 
Şd_off£t
;

74 
backlšk
;

75 
dËn
, 
¼æag
, 
m©ch
;

76 * 
d²t
;

77 
iso_dœeùÜy_»cÜd
 * 
de
;

78 
c
;

80 *
šo
 = 0;

81 ià(!
dœ
è 
NULL
;

83 ià(!(
block
 = 
dœ
->
u
.
isofs_i
.
i_fœ¡_ex‹Á
)è 
NULL
;

85 
f_pos
 = 0;

87 
off£t
 = 
f_pos
 & (
bufsize
 - 1);

88 
block
 = 
	`isofs_bm­
(
dœ
,
f_pos
 >> 
bufb™s
);

90 ià(!
block
 || !(
bh
 = 
	`b»ad
(
dœ
->
i_dev
,block,
bufsize
))è 
NULL
;

92 
f_pos
 < 
dœ
->
i_size
) {

93 
de
 = (
iso_dœeùÜy_»cÜd
 *è(
bh
->
b_d©a
 + 
off£t
);

94 
backlšk
 = 
dœ
->
i_šo
;

95 
šode_numb”
 = (
block
 << 
bufb™s
è+ (
off£t
 & (
bufsize
 - 1));

100 ià(*((*è
de
) == 0) {

101 
	`b»l£
(
bh
);

102 
off£t
 = 0;

103 
f_pos
 = ((f_po & ~(
ISOFS_BLOCK_SIZE
 - 1))

104 + 
ISOFS_BLOCK_SIZE
);

105 
block
 = 
	`isofs_bm­
(
dœ
,
f_pos
>>
bufb™s
);

106 ià(!
block
 || !(
bh
 = 
	`b»ad
(
dœ
->
i_dev
,block,
bufsize
)))

111 
Şd_off£t
 = 
off£t
;

112 
off£t
 +ğ*((*è
de
);

113 
f_pos
 +ğ*((*è
de
);

117 ià(
off£t
 >ğ
bufsize
) {

118 
ıÁ
 = 
	`km®loc
(1 << 
ISOFS_BLOCK_BITS
, 
GFP_KERNEL
);

119 
	`memıy
(
ıÁ
, 
bh
->
b_d©a
, 
bufsize
);

120 
de
 = (
iso_dœeùÜy_»cÜd
 *)

121 ((*)
ıÁ
 + 
Şd_off£t
);

122 
	`b»l£
(
bh
);

123 
off£t
 = 
f_pos
 & (
bufsize
 - 1);

124 
block
 = 
	`isofs_bm­
(
dœ
,
f_pos
>>
bufb™s
);

125 ià(!
block
 || !(
bh
 = 
	`b»ad
(
dœ
->
i_dev
,block,
bufsize
))) {

126 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

129 
	`memıy
((*)
ıÁ
+
bufsize
,
bh
->
b_d©a
,bufsize);

134 ià(
de
->
Çme
[0]==0 && de->
Çme_Ën
[0]==1) {

135 
šode_numb”
 = 
dœ
->
i_šo
;

136 
backlšk
 = 0;

141 ià(
de
->
Çme
[0]==1 && de->
Çme_Ën
[0]==1) {

143 
	`´štk
("Doing .. (%d %d)",

144 
dœ
->
i_sb
->
s_fœ¡d©azÚe
 << 
bufb™s
,

145 
dœ
->
i_šo
);

147 if((
dœ
->
i_sb
->
u
.
isofs_sb
.
s_fœ¡d©azÚe


148 << 
bufb™s
è!ğ
dœ
->
i_šo
)

149 
šode_numb”
 = 
dœ
->
u
.
isofs_i
.
i_backlšk
;

151 
šode_numb”
 = 
dœ
->
i_šo
;

152 
backlšk
 = 0;

155 
dËn
 = 
de
->
Çme_Ën
[0];

156 
d²t
 = 
de
->
Çme
;

158 
¼æag
 = 
	`g‘_rock_ridge_f’ame
(
de
, &
d²t
, &
dËn
, 
dœ
);

159 ià(
¼æag
) {

160 ià(
¼æag
 =ğ-1è
out
;

162 if(
dœ
->
i_sb
->
u
.
isofs_sb
.
s_m­pšg
 == 'n') {

163 
i
 = 0; i < 
dËn
; i++) {

164 
c
 = 
d²t
[
i
];

165 ià(
c
 >= 'A' && c <= 'Z') c |= 0x20;

166 ià(
c
 =ğ';' && 
i
 =ğ
dËn
-2 && 
d²t
[i+1] == '1') {

167 
dËn
 -= 2;

170 ià(
c
 == ';') c = '.';

171 
de
->
Çme
[
i
] = 
c
;

175 if(
d²t
[
dËn
-1] =ğ'.' && 
Çm–’
 == dlen-1)

176 
dËn
--;

179 
m©ch
 = 
	`isofs_m©ch
(
Çm–’
,
Çme
,
d²t
,
dËn
);

180 ià(
ıÁ
) {

181 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

182 
ıÁ
 = 
NULL
;

185 if(
¼æag
è
	`kä“
(
d²t
);

186 ià(
m©ch
) {

187 if(
šode_numb”
 == -1) {

189 
šode_numb”
 =

190 
	`isofs_lookup_g¿nd·»Á
(
dœ
,

191 
	`fšd_rock_ridge_»loÿtiÚ
(
de
,
dœ
));

192 if(
šode_numb”
 == -1){

194 
	`´štk
("Backlink‚ot…roperly set.\n");

195 
out
;

198 *
šo
 = 
šode_numb”
;

199 *
šo_back
 = 
backlšk
;

200  
bh
;

203 
out
:

204 ià(
ıÁ
)

205 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

206 
	`b»l£
(
bh
);

207  
NULL
;

208 
	}
}

210 
	$isofs_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

211 
šode
 ** 
»suÉ
)

213 
šo
, 
šo_back
;

214 
bufãr_h—d
 * 
bh
;

216 #ifdeà
DEBUG


217 
	`´štk
("lookup: %x %d\n",
dœ
->
i_šo
, 
Ën
);

219 *
»suÉ
 = 
NULL
;

220 ià(!
dœ
)

221  -
ENOENT
;

223 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

224 
	`ut
(
dœ
);

225  -
ENOENT
;

228 
šo
 = 0;

229 ià(
dœ
->
i_dev
 =ğ
ÿche
.
dev
 &&

230 
dœ
->
i_šo
 =ğ
ÿche
.dir &&

231 
Ën
 =ğ
ÿche
.
dËn
 &&

232 
	`isofs_m©ch
(
Ën
, 
Çme
, 
ÿche
.
f’ame
, cache.
dËn
))

234 
šo
 = 
ÿche
.ino;

235 
šo_back
 = 
dœ
->
i_šo
;

238 ià(
ÿche
.
dËn
 =ğ1 && cache.
f’ame
[0] =ğ'.'è
šo
 = 0;

239 ià(
ÿche
.
dËn
 =ğ2 && cache.
f’ame
[0] == '.' &&

240 
ÿche
.
f’ame
[1] =ğ'.'è
šo
 = 0;

243 ià(!
šo
) {

244 ià(!(
bh
 = 
	`isofs_fšd_’Œy
(
dœ
,
Çme
,
Ën
, &
šo
, &
šo_back
))) {

245 
	`ut
(
dœ
);

246  -
ENOENT
;

248 
	`b»l£
(
bh
);

251 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

252 
	`ut
(
dœ
);

253  -
EACCES
;

262 ià(
šo_back
 && !(*
»suÉ
)->
i_pe
 && (*»suÉ)->
i_sb
 =ğ
dœ
->i_sb) {

263 (*
»suÉ
)->
u
.
isofs_i
.
i_backlšk
 = 
šo_back
;

266 
	`ut
(
dœ
);

268 
	}
}

	@fs/isofs/rock.c

8 
	~<lšux/cÚfig.h
>

9 
	~<lšux/¡©.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/iso_fs.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/mm.h
>

14 
	~<lšux/m®loc.h
>

16 
	~"rock.h
"

25 
	#SIG
(
A
,
B
è((A << 8è| B)

	)

30 
	#CHECK_SP
(
FAIL
) \

31 if(
¼
->
u
.
SP
.
magic
[0] !ğ0xbeè
FAIL
; \

32 if(
¼
->
u
.
SP
.
magic
[1] !ğ0xefè
FAIL
;

	)

38 
	#CONTINUE_DECLS
 \

39 
cÚt_ex‹Á
 = 0, 
cÚt_off£t
 = 0, 
cÚt_size
 = 0; \

40 * 
bufãr
 = 0

	)

42 
	#CHECK_CE
 \

43 {
cÚt_ex‹Á
 = 
	`isÚum_733
(
¼
->
u
.
CE
.
ex‹Á
); \

44 
cÚt_off£t
 = 
	`isÚum_733
(
¼
->
u
.
CE
.
off£t
); \

45 
cÚt_size
 = 
	`isÚum_733
(
¼
->
u
.
CE
.
size
);}

	)

47 
	#SETUP_ROCK_RIDGE
(
DE
,
CHR
,
LEN
) \

48 {
LEN
ğ(
iso_dœeùÜy_»cÜd
è+ 
DE
->
Çme_Ën
[0]; \

49 if(
LEN
 & 1) LEN++; \

50 
CHR
 = ((*è
DE
è+ 
LEN
; \

51 
LEN
 = *((*è
DE
è- LEN;}

	)

53 
	#MAYBE_CONTINUE
(
LABEL
,
DEV
) \

54 {ià(
bufãr
è
	`kä“
(buffer); \

55 ià(
cÚt_ex‹Á
){ \

56 
block
, 
off£t
, 
off£t1
; \

57 
bufãr_h—d
 * 
bh
; \

58 
bufãr
 = 
	`km®loc
(
cÚt_size
,
GFP_KERNEL
); \

59 
block
 = 
cÚt_ex‹Á
; \

60 
off£t
 = 
cÚt_off£t
; \

61 
off£t1
 = 0; \

62 if(
	`ISOFS_BUFFER_SIZE
(
DEV
) == 1024) { \

63 
block
 <<= 1; \

64 ià(
off£t
 >ğ1024è
block
++; \

65 
off£t
 &= 1023; \

66 if(
off£t
 + 
cÚt_size
 >= 1024) { \

67 
bh
 = 
	`b»ad
(
DEV
->
i_dev
, 
block
++, 
	`ISOFS_BUFFER_SIZE
(DEV)); \

68 
	`memıy
(
bufãr
, 
bh
->
b_d©a
 + 
off£t
, 1024 - offset); \

69 
	`b»l£
(
bh
); \

70 
off£t1
 = 1024 - 
off£t
; \

71 
off£t
 = 0; \

74 
bh
 = 
	`b»ad
(
DEV
->
i_dev
, 
block
, 
	`ISOFS_BUFFER_SIZE
(DEV)); \

75 if(
bh
){ \

76 
	`memıy
(
bufãr
 + 
off£t1
, 
bh
->
b_d©a
 + 
off£t
, 
cÚt_size
 - offset1); \

77 
	`b»l£
(
bh
); \

78 
chr
 = (*è
bufãr
; \

79 
Ën
 = 
cÚt_size
; \

80 
cÚt_ex‹Á
 = 0; \

81 
cÚt_size
 = 0; \

82 
cÚt_off£t
 = 0; \

83 
LABEL
; \

85 
	`´štk
("Unableo„ead„ock-ridge‡ttributes\n"); \

86 }}

	)

91 
	$fšd_rock_ridge_»loÿtiÚ
(
iso_dœeùÜy_»cÜd
 * 
de
,

92 
šode
 * inode) {

93 
æag
;

94 
Ën
;

95 
»tv®
;

96 * 
chr
;

97 
CONTINUE_DECLS
;

98 
æag
 = 0;

103 ià(
de
->
Çme
[0]==1 && de->
Çme_Ën
[0]==1è
æag
 = 1;

105 
»tv®
 = 
	`isÚum_733
 (
de
->
ex‹Á
);

107 ià(!
šode
->
i_sb
->
u
.
isofs_sb
.
s_rock
è 
»tv®
;

109 
	`SETUP_ROCK_RIDGE
(
de
, 
chr
, 
Ën
);

110 
»³©
:

112 
¼æag
, 
sig
;

113 
rock_ridge
 * 
¼
;

115 
Ën
 > 1){

116 
¼
 = (
rock_ridge
 *è
chr
;

117 ià(
¼
->
Ën
 =ğ0è
out
;

118 
sig
 = (
chr
[0] << 8) + chr[1];

119 
chr
 +ğ
¼
->
Ën
;

120 
Ën
 -ğ
¼
->len;

122 
sig
){

123 
	`SIG
('R','R'):

124 
¼æag
 = 
¼
->
u
.
RR
.
æags
[0];

125 ià(
æag
 && !(
¼æag
 & 
RR_PL
)è
out
;

126 ià(!
æag
 && !(
¼æag
 & 
RR_CL
)è
out
;

128 
	`SIG
('S','P'):

129 
	`CHECK_SP
(
out
);

131 
	`SIG
('C','L'):

132 #ifdeà
DEBUG


133 
	`´štk
("RR: CL\n");

135 ià(
æag
 == 0) {

136 
»tv®
 = 
	`isÚum_733
(
¼
->
u
.
CL
.
loÿtiÚ
);

137 
out
;

140 
	`SIG
('P','L'):

141 #ifdeà
DEBUG


142 
	`´štk
("RR: PL\n");

144 ià(
æag
 != 0) {

145 
»tv®
 = 
	`isÚum_733
(
¼
->
u
.
PL
.
loÿtiÚ
);

146 
out
;

149 
	`SIG
('C','E'):

150 
CHECK_CE
;

157 
	`MAYBE_CONTINUE
(
»³©
, 
šode
);

158  
»tv®
;

159 
out
:

160 if(
bufãr
è
	`kä“
(buffer);

161  
»tv®
;

162 
	}
}

164 
	$g‘_rock_ridge_f’ame
(
iso_dœeùÜy_»cÜd
 * 
de
,

165 ** 
Çme
, * 
ÇmËn
, 
šode
 * inode)

167 
Ën
;

168 * 
chr
;

169 
CONTINUE_DECLS
;

170 * 
»Šame
 = 
NULL
;

171 
»ŠamËn
 = 0, 
Œunÿ‹
=0;

173 ià(!
šode
->
i_sb
->
u
.
isofs_sb
.
s_rock
)  0;

175 
	`SETUP_ROCK_RIDGE
(
de
, 
chr
, 
Ën
);

176 
»³©
:

178 
rock_ridge
 * 
¼
;

179 
sig
;

181 
Ën
 > 1){

182 
¼
 = (
rock_ridge
 *è
chr
;

183 ià(
¼
->
Ën
 =ğ0è
out
;

184 
sig
 = (
chr
[0] << 8) + chr[1];

185 
chr
 +ğ
¼
->
Ën
;

186 
Ën
 -ğ
¼
->len;

188 
sig
){

189 
	`SIG
('R','R'):

190 if((
¼
->
u
.
RR
.
æags
[0] & 
RR_NM
è=ğ0è
out
;

192 
	`SIG
('S','P'):

193 
	`CHECK_SP
(
out
);

195 
	`SIG
('C','E'):

196 
CHECK_CE
;

198 
	`SIG
('N','M'):

199 ià(
Œunÿ‹
) ;

200 ià(
¼
->
u
.
NM
.
æags
 & ~1) {

201 
	`´štk
("UnsuµÜ‹d NM fÏg s‘tšg (%d)\n",
¼
->
u
.
NM
.
æags
);

204 ià(!
»Šame
){

205 
»Šame
 = (*è
	`km®loc
 (255,
GFP_KERNEL
);

212 *
»Šame
 = 0;

213 
»ŠamËn
 = 0;

215 if((
	`¡¾’
(
»Šame
è+ 
¼
->
Ën
 - 5) >= 254) {

216 
Œunÿ‹
 = 1;

219 
	`¡ºÿt
(
»Šame
, 
¼
->
u
.
NM
.
Çme
,„r->
Ën
 - 5);

220 
»ŠamËn
 +ğ
¼
->
Ën
 - 5;

222 
	`SIG
('R','E'):

223 #ifdeà
DEBUG


224 
	`´štk
("RR: RE (%x)\n", 
šode
->
i_šo
);

226 ià(
bufãr
è
	`kä“
(buffer);

227 ià(
»Šame
è
	`kä“
(retname);

234 
	`MAYBE_CONTINUE
(
»³©
,
šode
);

235 if(
»Šame
){

236 *
Çme
 = 
»Šame
;

237 *
ÇmËn
 = 
»ŠamËn
;

241 
out
:

242 if(
bufãr
è
	`kä“
(buffer);

243 ià(
»Šame
è
	`kä“
(retname);

245 
	}
}

247 
	$·r£_rock_ridge_šode
(
iso_dœeùÜy_»cÜd
 * 
de
,

248 
šode
 * inode){

249 
Ën
;

250 * 
chr
;

251 
CONTINUE_DECLS
;

253 ià(!
šode
->
i_sb
->
u
.
isofs_sb
.
s_rock
)  0;

255 
	`SETUP_ROCK_RIDGE
(
de
, 
chr
, 
Ën
);

256 
»³©
:

258 
út
, 
sig
;

259 
šode
 * 
»loc
;

260 
rock_ridge
 * 
¼
;

261 
roÙæag
;

263 
Ën
 > 1){

264 
¼
 = (
rock_ridge
 *è
chr
;

265 ià(
¼
->
Ën
 =ğ0è
out
;

266 
sig
 = (
chr
[0] << 8) + chr[1];

267 
chr
 +ğ
¼
->
Ën
;

268 
Ën
 -ğ
¼
->len;

270 
sig
){

271 
	`SIG
('R','R'):

272 if((
¼
->
u
.
RR
.
æags
[0] &

273 (
RR_PX
 | 
RR_TF
 | 
RR_SL
 | 
RR_CL
)è=ğ0è
out
;

275 
	`SIG
('S','P'):

276 
	`CHECK_SP
(
out
);

278 
	`SIG
('C','E'):

279 
CHECK_CE
;

281 
	`SIG
('E','R'):

282 
	`´štk
("ISO9660 Extensions: ");

283 { 
p
;

284 
p
=0;p<
¼
->
u
.
ER
.
Ën_id
;p++è
	`´štk
("%c",¼->u.ER.
d©a
[p]);

286 
	`´štk
("\n");

288 
	`SIG
('P','X'):

289 
šode
->
i_mode
 = 
	`isÚum_733
(
¼
->
u
.
PX
.
mode
);

290 
šode
->
i_Æšk
 = 
	`isÚum_733
(
¼
->
u
.
PX
.
n_lšks
);

291 
šode
->
i_uid
 = 
	`isÚum_733
(
¼
->
u
.
PX
.
uid
);

292 
šode
->
i_gid
 = 
	`isÚum_733
(
¼
->
u
.
PX
.
gid
);

294 
	`SIG
('P','N'):

295 { 
high
, 
low
;

296 
high
 = 
	`isÚum_733
(
¼
->
u
.
PN
.
dev_high
);

297 
low
 = 
	`isÚum_733
(
¼
->
u
.
PN
.
dev_low
);

298 
šode
->
i_rdev
 = ((
high
 << 8è| (
low
 & 0xff)) & 0xffff;

301 
	`SIG
('T','F'):

304 
út
 = 0;

305 if(
¼
->
u
.
TF
.
æags
 & 
TF_CREATE
)

306 
šode
->
i_ùime
 = 
	`iso_d©e
(
¼
->
u
.
TF
.
times
[
út
++].
time
, 0);

307 if(
¼
->
u
.
TF
.
æags
 & 
TF_MODIFY
)

308 
šode
->
i_mtime
 = 
	`iso_d©e
(
¼
->
u
.
TF
.
times
[
út
++].
time
, 0);

309 if(
¼
->
u
.
TF
.
æags
 & 
TF_ACCESS
)

310 
šode
->
i_©ime
 = 
	`iso_d©e
(
¼
->
u
.
TF
.
times
[
út
++].
time
, 0);

311 if(
¼
->
u
.
TF
.
æags
 & 
TF_ATTRIBUTES
)

312 
šode
->
i_ùime
 = 
	`iso_d©e
(
¼
->
u
.
TF
.
times
[
út
++].
time
, 0);

314 
	`SIG
('S','L'):

315 {
¦’
;

316 
SL_compÚ’t
 * 
¦p
;

317 
¦’
 = 
¼
->
Ën
 - 5;

318 
¦p
 = &
¼
->
u
.
SL
.
lšk
;

319 
šode
->
i_size
 = 0;

320 
¦’
 > 1){

321 
roÙæag
 = 0;

322 
¦p
->
æags
 &~1){

324 
šode
->
i_size
 +ğ
¦p
->
Ën
;

327 
šode
->
i_size
 += 1;

330 
šode
->
i_size
 += 2;

333 
roÙæag
 = 1;

334 
šode
->
i_size
 += 1;

337 
	`´štk
("Symlink component flag‚ot implemented\n");

339 
¦’
 -ğ
¦p
->
Ën
 + 2;

340 
¦p
 = (
SL_compÚ’t
 *è(((*è¦pè+ sÍ->
Ën
 + 2);

342 if(
¦’
 < 2) ;

343 if(!
roÙæag
è
šode
->
i_size
 += 1;

347 
	`SIG
('R','E'):

348 
	`´štk
("Attempto„ead inode for„elocated directory\n");

349 
out
;

350 
	`SIG
('C','L'):

351 #ifdeà
DEBUG


352 
	`´štk
("RR CL (%x)\n",
šode
->
i_šo
);

354 
šode
->
u
.
isofs_i
.
i_fœ¡_ex‹Á
 = 
	`isÚum_733
(
¼
->u.
CL
.
loÿtiÚ
) <<

355 (
ISOFS_BLOCK_BITS
 - 
	`ISOFS_BUFFER_BITS
(
šode
));

356 
»loc
 = 
	`ig‘
(
šode
->
i_sb
, inode->
u
.
isofs_i
.
i_fœ¡_ex‹Á
 << 
	`ISOFS_BUFFER_BITS
(inode));

357 
šode
->
i_mode
 = 
»loc
->i_mode;

358 
šode
->
i_Æšk
 = 
»loc
->i_nlink;

359 
šode
->
i_uid
 = 
»loc
->i_uid;

360 
šode
->
i_gid
 = 
»loc
->i_gid;

361 
šode
->
i_rdev
 = 
»loc
->i_rdev;

362 
šode
->
i_size
 = 
»loc
->i_size;

363 
šode
->
i_©ime
 = 
»loc
->i_atime;

364 
šode
->
i_ùime
 = 
»loc
->i_ctime;

365 
šode
->
i_mtime
 = 
»loc
->i_mtime;

366 
	`ut
(
»loc
);

373 
	`MAYBE_CONTINUE
(
»³©
,
šode
);

375 
out
:

376 if(
bufãr
è
	`kä“
(buffer);

378 
	}
}

384 * 
	$g‘_rock_ridge_symlšk
(
šode
 * inode)

386 
bufsize
 = 
	`ISOFS_BUFFER_SIZE
(
šode
);

387 
bufb™s
 = 
	`ISOFS_BUFFER_BITS
(
šode
);

388 
bufãr_h—d
 * 
bh
;

389 * 
²t
;

390 * 
ıÁ
 = 
NULL
;

391 * 
½Á
;

392 
iso_dœeùÜy_»cÜd
 * 
¿w_šode
;

393 
CONTINUE_DECLS
;

394 
block
;

395 
sig
;

396 
roÙæag
;

397 
Ën
;

398 * 
chr
;

399 
rock_ridge
 * 
¼
;

401 ià(!
šode
->
i_sb
->
u
.
isofs_sb
.
s_rock
)

402 
	`·nic
("Cannot have symlink with high sierra variant of iso filesystem\n");

404 
½Á
 = 0;

406 
block
 = 
šode
->
i_šo
 >> 
bufb™s
;

407 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
,
block
, 
bufsize
))) {

408 
	`´štk
("unableo„ead i-node block");

409  
NULL
;

412 
²t
 = ((*è
bh
->
b_d©a
è+ (
šode
->
i_šo
 & (
bufsize
 - 1));

414 
¿w_šode
 = ((
iso_dœeùÜy_»cÜd
 *è
²t
);

416 ià((
šode
->
i_šo
 & (
bufsize
 - 1)è+ *
²t
 > bufsize){

417 
ıÁ
 = 
	`km®loc
(1 << 
ISOFS_BLOCK_BITS
, 
GFP_KERNEL
);

418 
	`memıy
(
ıÁ
, 
bh
->
b_d©a
, 
bufsize
);

419 
	`b»l£
(
bh
);

420 ià(!(
bh
 = 
	`b»ad
(
šode
->
i_dev
,++
block
, 
bufsize
))) {

421 
	`kä“_s
(
ıÁ
, 1 << 
ISOFS_BLOCK_BITS
);

422 
	`´štk
("unableo„ead i-node block");

423  
NULL
;

425 
	`memıy
((*)
ıÁ
+
bufsize
, 
bh
->
b_d©a
, bufsize);

426 
²t
 = ((*è
ıÁ
è+ (
šode
->
i_šo
 & (
bufsize
 - 1));

427 
¿w_šode
 = ((
iso_dœeùÜy_»cÜd
 *è
²t
);

433 
	`SETUP_ROCK_RIDGE
(
¿w_šode
, 
chr
, 
Ën
);

435 
»³©
:

436 
Ën
 > 1){

437 ià(
½Á
) ;

438 
¼
 = (
rock_ridge
 *è
chr
;

439 ià(
¼
->
Ën
 =ğ0è
out
;

440 
sig
 = (
chr
[0] << 8) + chr[1];

441 
chr
 +ğ
¼
->
Ën
;

442 
Ën
 -ğ
¼
->len;

444 
sig
){

445 
	`SIG
('R','R'):

446 if((
¼
->
u
.
RR
.
æags
[0] & 
RR_SL
è=ğ0è
out
;

448 
	`SIG
('S','P'):

449 
	`CHECK_SP
(
out
);

451 
	`SIG
('S','L'):

452 {
¦’
;

453 
SL_compÚ’t
 * 
¦p
;

454 
¦’
 = 
¼
->
Ën
 - 5;

455 
¦p
 = &
¼
->
u
.
SL
.
lšk
;

456 
¦’
 > 1){

457 ià(!
½Á
){

458 
½Á
 = (*è
	`km®loc
 (
šode
->
i_size
 +1, 
GFP_KERNEL
);

459 *
½Á
 = 0;

461 
roÙæag
 = 0;

462 
¦p
->
æags
 &~1){

464 
	`¡ºÿt
(
½Á
,
¦p
->
‹xt
, sÍ->
Ën
);

467 
	`¡rÿt
(
½Á
,".");

470 
	`¡rÿt
(
½Á
,"..");

473 
roÙæag
 = 1;

474 
	`¡rÿt
(
½Á
,"/");

477 
	`´štk
("Symlšk compÚ’ˆæag‚Ù im¶em’‹d (%d)\n",
¦’
);

479 
¦’
 -ğ
¦p
->
Ën
 + 2;

480 
¦p
 = (
SL_compÚ’t
 *è(((*è¦pè+ sÍ->
Ën
 + 2);

482 if(
¦’
 < 2) ;

483 if(!
roÙæag
è
	`¡rÿt
(
½Á
,"/");

491 
	`MAYBE_CONTINUE
(
»³©
,
šode
);

492 
	`b»l£
(
bh
);

494 ià(
ıÁ
) {

495 
	`kä“
(
ıÁ
);

496 
ıÁ
 = 
NULL
;

499  
½Á
;

500 
out
:

501 if(
bufãr
è
	`kä“
(buffer);

503 
	}
}

	@fs/isofs/rock.h

6 
	sSU_SP
{

7 
	mmagic
[2];

8 
	msk
;

11 
	sSU_CE
{

12 
	mex‹Á
[8];

13 
	moff£t
[8];

14 
	msize
[8];

17 
	sSU_ER
{

18 
	mËn_id
;

19 
	mËn_des
;

20 
	mËn_¤c
;

21 
	mext_v”
;

22 
	md©a
[0];

25 
	sRR_RR
{

26 
	mæags
[1];

29 
	sRR_PX
{

30 
	mmode
[8];

31 
	mn_lšks
[8];

32 
	muid
[8];

33 
	mgid
[8];

36 
	sRR_PN
{

37 
	mdev_high
[8];

38 
	mdev_low
[8];

42 
	sSL_compÚ’t
{

43 
	mæags
;

44 
	mËn
;

45 
	m‹xt
[0];

48 
	sRR_SL
{

49 
	mæags
;

50 
SL_compÚ’t
 
	mlšk
;

53 
	sRR_NM
{

54 
	mæags
;

55 
	mÇme
[0];

58 
	sRR_CL
{

59 
	mloÿtiÚ
[8];

62 
	sRR_PL
{

63 
	mloÿtiÚ
[8];

66 
	s¡amp
{

67 
	mtime
[7];

70 
	sRR_TF
{

71 
	mæags
;

72 
¡amp
 
	mtimes
[0];

76 
	#TF_CREATE
 1

	)

77 
	#TF_MODIFY
 2

	)

78 
	#TF_ACCESS
 4

	)

79 
	#TF_ATTRIBUTES
 8

	)

80 
	#TF_BACKUP
 16

	)

81 
	#TF_EXPIRATION
 32

	)

82 
	#TF_EFFECTIVE
 64

	)

83 
	#TF_LONG_FORM
 128

	)

85 
	srock_ridge
{

86 
	msigÇtu»
[2];

87 
	mËn
;

88 
	mv”siÚ
;

90 
SU_SP
 
	mSP
;

91 
SU_CE
 
	mCE
;

92 
SU_ER
 
	mER
;

93 
RR_RR
 
	mRR
;

94 
RR_PX
 
	mPX
;

95 
RR_PN
 
	mPN
;

96 
RR_SL
 
	mSL
;

97 
RR_NM
 
	mNM
;

98 
RR_CL
 
	mCL
;

99 
RR_PL
 
	mPL
;

100 
RR_TF
 
	mTF
;

101 } 
	mu
;

104 
	#RR_PX
 1

	)

105 
	#RR_PN
 2

	)

106 
	#RR_SL
 4

	)

107 
	#RR_NM
 8

	)

108 
	#RR_CL
 16

	)

109 
	#RR_PL
 32

	)

110 
	#RR_RE
 64

	)

111 
	#RR_TF
 128

	)

	@fs/isofs/symlink.c

12 
	~<asm/£gm’t.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/iso_fs.h
>

18 
	~<lšux/¡©.h
>

19 
	~<lšux/m®loc.h
>

21 
isofs_»adlšk
(
šode
 *, *, );

22 
isofs_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

27 
šode_İ”©iÚs
 
	gisofs_symlšk_šode_İ”©iÚs
 = {

28 
NULL
,

29 
NULL
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
isofs_»adlšk
,

39 
isofs_fŞlow_lšk
,

40 
NULL
,

41 
NULL
,

42 
NULL


45 
	$isofs_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

46 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

48 
”rÜ
;

49 * 
²t
;

51 ià(!
dœ
) {

52 
dœ
 = 
cu¼’t
->
roÙ
;

53 
dœ
->
i_couÁ
++;

55 ià(!
šode
) {

56 
	`ut
(
dœ
);

57 *
»s_šode
 = 
NULL
;

58  -
ENOENT
;

60 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

61 
	`ut
(
dœ
);

62 *
»s_šode
 = 
šode
;

65 ià((
cu¼’t
->
lšk_couÁ
 > 5) ||

66 !(
²t
 = 
	`g‘_rock_ridge_symlšk
(
šode
))) {

67 
	`ut
(
dœ
);

68 
	`ut
(
šode
);

69 *
»s_šode
 = 
NULL
;

70  -
ELOOP
;

72 
	`ut
(
šode
);

73 
cu¼’t
->
lšk_couÁ
++;

74 
”rÜ
 = 
	`İ’_Çmei
(
²t
,
æag
,
mode
,
»s_šode
,
dœ
);

75 
cu¼’t
->
lšk_couÁ
--;

76 
	`kä“
(
²t
);

77  
”rÜ
;

78 
	}
}

80 
	$isofs_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

82 * 
²t
;

83 
i
;

84 
c
;

86 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

87 
	`ut
(
šode
);

88  -
EINVAL
;

91 ià(
buæ’
 > 1023)

92 
buæ’
 = 1023;

93 
²t
 = 
	`g‘_rock_ridge_symlšk
(
šode
);

95 
	`ut
(
šode
);

96 ià(!
²t
)

98 
i
 = 0;

100 
i
<
buæ’
 && (
c
 = 
²t
[i])) {

101 
i
++;

102 
	`put_fs_by‹
(
c
,
bufãr
++);

104 
	`kä“
(
²t
);

105  
i
;

106 
	}
}

	@fs/isofs/util.c

14 
	$isÚum_711
 (* 
p
)

16  (*
p
 & 0xff);

17 
	}
}

20 
	$isÚum_712
 (* 
p
)

22 
v®
;

24 
v®
 = *
p
;

25 ià(
v®
 & 0x80)

26 
v®
 |= 0xffffff00;

27  (
v®
);

28 
	}
}

31 
	$isÚum_721
 (* 
p
)

33  ((
p
[0] & 0xff) | ((p[1] & 0xff) << 8));

34 
	}
}

37 
	$isÚum_722
 (* 
p
)

39  (((
p
[0] & 0xff) << 8) | (p[1] & 0xff));

40 
	}
}

43 
	$isÚum_723
 (* 
p
)

46 ià(
p
[0] !=…[3] ||…[1] !=…[2]) {

47 
	`årštf
 (
¡d”r
, "invalid format 7.2.3‚umber\n");

48 
	`ex™
 (1);

51  (
	`isÚum_721
 (
p
));

52 
	}
}

55 
	$isÚum_731
 (* 
p
)

57  ((
p
[0] & 0xff)

58 | ((
p
[1] & 0xff) << 8)

59 | ((
p
[2] & 0xff) << 16)

60 | ((
p
[3] & 0xff) << 24));

61 
	}
}

64 
	$isÚum_732
 (* 
p
)

66  (((
p
[0] & 0xff) << 24)

67 | ((
p
[1] & 0xff) << 16)

68 | ((
p
[2] & 0xff) << 8)

69 | (
p
[3] & 0xff));

70 
	}
}

73 
	$isÚum_733
 (* 
p
)

76 
i
;

78 
i
 = 0; i < 4; i++) {

79 ià(
p
[
i
] !=…[7-i]) {

80 
	`årštf
 (
¡d”r
, "bad format 7.3.3‚umber\n");

81 
	`ex™
 (1);

85  (
	`isÚum_731
 (
p
));

86 
	}
}

92 
	$iso_d©e
(* 
p
, 
æag
)

94 
y—r
, 
mÚth
, 
day
, 
hour
 ,
mšu‹
, 
£cÚd
, 
tz
;

95 
ütime
, 
days
, 
i
;

97 
y—r
 = 
p
[0] - 70;

98 
mÚth
 = 
p
[1];

99 
day
 = 
p
[2];

100 
hour
 = 
p
[3];

101 
mšu‹
 = 
p
[4];

102 
£cÚd
 = 
p
[5];

103 ià(
æag
 =ğ0è
tz
 = 
p
[6];

104 
tz
 = 0;

106 ià(
y—r
 < 0) {

107 
ütime
 = 0;

109 
mÚËn
[12] = {31,28,31,30,31,30,31,31,30,31,30,31};

110 
days
 = 
y—r
 * 365;

111 ià(
y—r
 > 2)

112 
days
 +ğ(
y—r
+1) / 4;

113 
i
 = 1; i < 
mÚth
; i++)

114 
days
 +ğ
mÚËn
[
i
-1];

115 ià(((
y—r
+2è% 4è=ğ0 && 
mÚth
 > 2)

116 
days
++;

117 
days
 +ğ
day
 - 1;

118 
ütime
 = ((((
days
 * 24è+ 
hour
è* 60 + 
mšu‹
) * 60)

119 + 
£cÚd
;

122 ià(
tz
 & 0x80)

123 
tz
 |= (-1 << 8);

126 ià(-48 <ğ
tz
 &&z <= 52)

127 
ütime
 +ğ
tz
 * 15 * 60;

129  
ütime
;

130 
	}
}

	@fs/locks.c

15 
	~<asm/£gm’t.h
>

17 
	~<lšux/sched.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/¡©.h
>

21 
	~<lšux/fú.h
>

23 
	#OFFSET_MAX
 ((
off_t
)0x7fffffffè

	)

25 
cİy_æock
(
fe
 *
fp
, 
fe_lock
 *
æ
, 
æock
 *
l
,

26 
fd
);

27 
cÚæiù
(
fe_lock
 *
ÿÎ”_æ
, fe_lock *
sys_æ
);

28 
ov”Ïp
(
fe_lock
 *
æ1
, fe_lock *
æ2
);

29 
lock_™
(
fe
 *
fp
, 
fe_lock
 *
ÿÎ”
, 
fd
);

30 
fe_lock
 *
®loc_lock
(fe_lock **
pos
, fe_lock *
æ
,

31 
fd
);

32 
ä“_lock
(
fe_lock
 **
æ
);

34 
fe_lock
 
	gfe_lock_bË
[
NR_FILE_LOCKS
];

35 
fe_lock
 *
	gfe_lock_ä“_li¡
;

41 
	$fú_š™_locks
()

43 
fe_lock
 *
æ
;

45 
æ
 = &
fe_lock_bË
[0]; fÈ< fe_lock_bË + 
NR_FILE_LOCKS
 - 1; fl++) {

46 
æ
->
æ_Ãxt
 = fl + 1;

47 
æ
->
æ_owÃr
 = 
NULL
;

49 
fe_lock_bË
[
NR_FILE_LOCKS
 - 1].
æ_Ãxt
 = 
NULL
;

50 
fe_lock_bË
[
NR_FILE_LOCKS
 - 1].
æ_owÃr
 = 
NULL
;

51 
fe_lock_ä“_li¡
 = &
fe_lock_bË
[0];

52 
	}
}

54 
	$fú_g‘lk
(
fd
, 
æock
 *
l
)

56 
”rÜ
;

57 
æock
 flock;

58 
fe
 *
fp
;

59 
fe_lock
 *
æ
,file_lock;

61 ià(
fd
 >ğ
NR_OPEN
 || !(
fp
 = 
cu¼’t
->filp[fd]))

62  -
EBADF
;

63 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
l
, (*l));

64 ià(
”rÜ
)

65  
”rÜ
;

66 
	`memıy_äomfs
(&
æock
, 
l
, (flock));

67 ià(
æock
.
l_ty³
 =ğ
F_UNLCK
)

68  -
EINVAL
;

69 ià(!
	`cİy_æock
(
fp
, &
fe_lock
, &
æock
, 
fd
))

70  -
EINVAL
;

72 
æ
 = 
fp
->
f_šode
->
i_æock
; fÈ!ğ
NULL
; fÈğæ->
æ_Ãxt
) {

73 ià(
	`cÚæiù
(&
fe_lock
, 
æ
)) {

74 
æock
.
l_pid
 = 
æ
->
æ_owÃr
->
pid
;

75 
æock
.
l_¡¬t
 = 
æ
->
æ_¡¬t
;

76 
æock
.
l_Ën
 = 
æ
->
æ_’d
 =ğ
OFFSET_MAX
 ? 0 :

77 
æ
->
æ_’d
 - fl->
æ_¡¬t
 + 1;

78 
æock
.
l_wh’û
 = 
æ
->
æ_wh’û
;

79 
æock
.
l_ty³
 = 
æ
->
æ_ty³
;

80 
	`memıy_tofs
(
l
, &
æock
, (flock));

85 
æock
.
l_ty³
 = 
F_UNLCK
;

86 
	`memıy_tofs
(
l
, &
æock
, (flock));

88 
	}
}

94 
	$fú_£k
(
fd
, 
cmd
, 
æock
 *
l
)

96 
”rÜ
;

97 
fe
 *
fp
;

98 
fe_lock
 *
æ
,file_lock;

99 
æock
 flock;

105 ià(
fd
 >ğ
NR_OPEN
 || !(
fp
 = 
cu¼’t
->filp[fd]))

106  -
EBADF
;

107 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
l
, (*l));

108 ià(
”rÜ
)

109  
”rÜ
;

110 
	`memıy_äomfs
(&
æock
, 
l
, (flock));

111 ià(!
	`cİy_æock
(
fp
, &
fe_lock
, &
æock
, 
fd
))

112  -
EINVAL
;

113 
fe_lock
.
æ_ty³
) {

114 
F_RDLCK
 :

115 ià(!(
fp
->
f_mode
 & 1))

116  -
EBADF
;

118 
F_WRLCK
 :

119 ià(!(
fp
->
f_mode
 & 2))

120  -
EBADF
;

122 
F_SHLCK
 :

123 ià(!(
fp
->
f_mode
 & 3))

124  -
EBADF
;

125 
fe_lock
.
æ_ty³
 = 
F_RDLCK
;

127 
F_EXLCK
 :

128 ià(!(
fp
->
f_mode
 & 3))

129  -
EBADF
;

130 
fe_lock
.
æ_ty³
 = 
F_WRLCK
;

132 
F_UNLCK
 :

140 ià(
fe_lock
.
æ_ty³
 !ğ
F_UNLCK
) {

141 
»³©
:

142 
æ
 = 
fp
->
f_šode
->
i_æock
; fÈ!ğ
NULL
; fÈğæ->
æ_Ãxt
) {

143 ià(!
	`cÚæiù
(&
fe_lock
, 
æ
))

150 ià(
cmd
 =ğ
F_SETLKW
) {

151 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

152  -
ERESTARTSYS
;

153 
	`š‹¼u±ibË_¦“p_Ú
(&
æ
->
æ_wa™
);

154 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

155  -
ERESTARTSYS
;

156 
»³©
;

158  -
EAGAIN
;

166  
	`lock_™
(
fp
, &
fe_lock
, 
fd
);

167 
	}
}

173 
	$fú_»move_locks
(
sk_¡ruù
 *
sk
, 
fe
 *
fp
,

174 
fd
)

176 
fe_lock
 *
æ
;

177 
fe_lock
 **
befÜe
;

181 
befÜe
 = &
fp
->
f_šode
->
i_æock
;

182 (
æ
 = *
befÜe
è&& (
sk
 !ğæ->
æ_owÃr
 || 
fd
 !ğæ->
æ_fd
))

183 
befÜe
 = &
æ
->
æ_Ãxt
;

187 (
æ
 = *
befÜe
è&& 
sk
 =ğæ->
æ_owÃr
 && 
fd
 =ğæ->
æ_fd
)

188 
	`ä“_lock
(
befÜe
);

189 
	}
}

196 
	$cİy_æock
(
fe
 *
fp
, 
fe_lock
 *
æ
, 
æock
 *
l
,

197 
fd
)

199 
off_t
 
¡¬t
;

201 ià(!
fp
->
f_šode
)

203 ià(!
	`S_ISREG
(
fp
->
f_šode
->
i_mode
))

205 ià(
l
->
l_ty³
 !ğ
F_UNLCK
 &&†->l_ty³ !ğ
F_RDLCK
 &&†->l_ty³ !ğ
F_WRLCK


206 && 
l
->
l_ty³
 !ğ
F_SHLCK
 &&†->l_ty³ !ğ
F_EXLCK
)

208 
l
->
l_wh’û
) {

209 0 : 
¡¬t
 = 0; ;

210 1 : 
¡¬t
 = 
fp
->
f_pos
; ;

211 2 : 
¡¬t
 = 
fp
->
f_šode
->
i_size
; ;

214 ià((
¡¬t
 +ğ
l
->
l_¡¬t
è< 0 ||†->
l_Ën
 < 0)

216 
æ
->
æ_ty³
 = 
l
->
l_ty³
;

217 
æ
->
æ_¡¬t
 = 
¡¬t
;

218 
æ
->
æ_wh’û
 = 0;

219 ià(
l
->
l_Ën
 =ğ0 || (
æ
->
æ_’d
 = 
¡¬t
 +†->l_len - 1) < 0)

220 
æ
->
æ_’d
 = 
OFFSET_MAX
;

221 
æ
->
æ_owÃr
 = 
cu¼’t
;

222 
æ
->
æ_fd
 = 
fd
;

223 
æ
->
æ_wa™
 = 
NULL
;

225 
	}
}

231 
	$cÚæiù
(
fe_lock
 *
ÿÎ”_æ
, fe_lock *
sys_æ
)

233 iàĞ
ÿÎ”_æ
->
æ_owÃr
 =ğ
sys_æ
->fl_owner

234 && 
ÿÎ”_æ
->
æ_fd
 =ğ
sys_æ
->fl_fd)

236 ià(!
	`ov”Ïp
(
ÿÎ”_æ
, 
sys_æ
))

238 
ÿÎ”_æ
->
æ_ty³
) {

239 
F_RDLCK
 :

240  
sys_æ
->
æ_ty³
 !ğ
F_RDLCK
;

241 
F_WRLCK
 :

245 
	}
}

247 
	$ov”Ïp
(
fe_lock
 *
æ1
, fe_lock *
æ2
)

249  
æ1
->
æ_’d
 >ğ
æ2
->
æ_¡¬t
 && fl2->fl_end >= fl1->fl_start;

250 
	}
}

272 
	$lock_™
(
fe
 *
fp
, 
fe_lock
 *
ÿÎ”
, 
fd
)

274 
fe_lock
 *
æ
;

275 
fe_lock
 *
Ëá
 = 0;

276 
fe_lock
 *
right
 = 0;

277 
fe_lock
 **
befÜe
;

278 
added
 = 0;

284 
befÜe
 = &
fp
->
f_šode
->
i_æock
;

285 (
æ
 = *
befÜe
) &&

286 (
ÿÎ”
->
æ_owÃr
 !ğ
æ
->fl_owner ||

287 
ÿÎ”
->
æ_fd
 !ğ
æ
->fl_fd))

288 
befÜe
 = &
æ
->
æ_Ãxt
;

294  (
æ
 = *
befÜe
)

295 && 
ÿÎ”
->
æ_owÃr
 =ğ
æ
->fl_owner

296 && 
ÿÎ”
->
æ_fd
 =ğ
æ
->fl_fd) {

300 ià(
ÿÎ”
->
æ_ty³
 =ğ
æ
->fl_type) {

301 ià(
æ
->
æ_’d
 < 
ÿÎ”
->
æ_¡¬t
 - 1)

302 
Ãxt_lock
;

307 ià(
æ
->
æ_¡¬t
 > 
ÿÎ”
->
æ_’d
 + 1)

316 ià(
æ
->
æ_¡¬t
 > 
ÿÎ”
->fl_start)

317 
æ
->
æ_¡¬t
 = 
ÿÎ”
->fl_start;

319 
ÿÎ”
->
æ_¡¬t
 = 
æ
->fl_start;

320 ià(
æ
->
æ_’d
 < 
ÿÎ”
->fl_end)

321 
æ
->
æ_’d
 = 
ÿÎ”
->fl_end;

323 
ÿÎ”
->
æ_’d
 = 
æ
->fl_end;

324 ià(
added
) {

325 
	`ä“_lock
(
befÜe
);

328 
ÿÎ”
 = 
æ
;

329 
added
 = 1;

330 
Ãxt_lock
;

335 ià(
æ
->
æ_’d
 < 
ÿÎ”
->
æ_¡¬t
)

336 
Ãxt_lock
;

337 ià(
æ
->
æ_¡¬t
 > 
ÿÎ”
->
æ_’d
)

339 ià(
ÿÎ”
->
æ_ty³
 =ğ
F_UNLCK
)

340 
added
 = 1;

341 ià(
æ
->
æ_¡¬t
 < 
ÿÎ”
->fl_start)

342 
Ëá
 = 
æ
;

347 ià(
æ
->
æ_’d
 > 
ÿÎ”
->fl_end) {

348 
right
 = 
æ
;

351 ià(
æ
->
æ_¡¬t
 >ğ
ÿÎ”
->fl_start) {

356 ià(
added
) {

357 
	`ä“_lock
(
befÜe
);

365 
	`wake_up
(&
æ
->
æ_wa™
);

366 
æ
->
æ_¡¬t
 = 
ÿÎ”
->fl_start;

367 
æ
->
æ_’d
 = 
ÿÎ”
->fl_end;

368 
æ
->
æ_ty³
 = 
ÿÎ”
->fl_type;

369 
ÿÎ”
 = 
æ
;

370 
added
 = 1;

375 
Ãxt_lock
:

376 
befÜe
 = &(*befÜe)->
æ_Ãxt
;

379 ià(! 
added
) {

380 ià(
ÿÎ”
->
æ_ty³
 =ğ
F_UNLCK
)

381  -
EINVAL
;

382 ià(! (
ÿÎ”
 = 
	`®loc_lock
(
befÜe
, c®Ër, 
fd
)))

383  -
ENOLCK
;

385 ià(
right
) {

386 ià(
Ëá
 =ğ
right
) {

392 ià(! (
Ëá
 = 
	`®loc_lock
(
befÜe
, 
right
, 
fd
))) {

393 ià(! 
added
)

394 
	`ä“_lock
(
befÜe
);

395  -
ENOLCK
;

398 
right
->
æ_¡¬t
 = 
ÿÎ”
->
æ_’d
 + 1;

400 ià(
Ëá
)

401 
Ëá
->
æ_’d
 = 
ÿÎ”
->
æ_¡¬t
 - 1;

403 
	}
}

409 
fe_lock
 *
	$®loc_lock
(
fe_lock
 **
pos
,

410 
fe_lock
 *
æ
,

411 
fd
)

413 
fe_lock
 *
tmp
;

415 
tmp
 = 
fe_lock_ä“_li¡
;

416 ià(
tmp
 =ğ
NULL
)

417  
NULL
;

418 ià(
tmp
->
æ_owÃr
 !ğ
NULL
)

419 
	`·nic
("alloc_lock: broken free†ist\n");

422 
fe_lock_ä“_li¡
 = 
tmp
->
æ_Ãxt
;

424 *
tmp
 = *
æ
;

426 
tmp
->
æ_Ãxt
 = *
pos
;

427 *
pos
 = 
tmp
;

429 
tmp
->
æ_owÃr
 = 
cu¼’t
;

430 
tmp
->
æ_fd
 = 
fd
;

431 
tmp
->
æ_wa™
 = 
NULL
;

432  
tmp
;

433 
	}
}

439 
	$ä“_lock
(
fe_lock
 **
æ_p
)

441 
fe_lock
 *
æ
;

443 
æ
 = *
æ_p
;

444 ià(
æ
->
æ_owÃr
 =ğ
NULL
)

445 
	`·nic
("free_lock: broken†ock†ist\n");

447 *
æ_p
 = (*æ_p)->
æ_Ãxt
;

449 
æ
->
æ_Ãxt
 = 
fe_lock_ä“_li¡
;

450 
fe_lock_ä“_li¡
 = 
æ
;

451 
æ
->
æ_owÃr
 = 
NULL
;

453 
	`wake_up
(&
æ
->
æ_wa™
);

454 
	}
}

	@fs/minix/bitmap.c

9 
	~<lšux/sched.h
>

10 
	~<lšux/mšix_fs.h
>

11 
	~<lšux/¡©.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/¡ršg.h
>

15 
	~<asm/b™İs.h
>

17 
	#ş—r_block
(
addr
) \

18 
	`__asm__
("cld\n\t" \

22 :"a" (0),"c" (
BLOCK_SIZE
/4),"D" ((è(
addr
)):"cx","di")

	)

24 
	#fšd_fœ¡_z”o
(
addr
) ({ \

25 
__»s
; \

26 
	`__asm__
("cld\n" \

36 :"=c" (
__»s
):"0" (0),"S" (
addr
):"ax","dx","si"); \

37 
__»s
;})

	)

39 
	gnibbËm­
[] = { 0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4 };

41 
	$couÁ_u£d
(
bufãr_h—d
 *
m­
[], 
numblocks
,

42 
numb™s
)

44 
i
, 
j
, 
’d
, 
sum
 = 0;

45 
bufãr_h—d
 *
bh
;

47 
i
=0; (i<
numblocks
è&& 
numb™s
; i++) {

48 ià(!(
bh
=
m­
[
i
]))

50 ià(
numb™s
 >ğ(8*
BLOCK_SIZE
)) {

51 
’d
 = 
BLOCK_SIZE
;

52 
numb™s
 -ğ8*
BLOCK_SIZE
;

54 
tmp
;

55 
’d
 = 
numb™s
 >> 3;

56 
numb™s
 &= 0x7;

57 
tmp
 = 
bh
->
b_d©a
[
’d
] & ((1<<
numb™s
)-1);

58 
sum
 +ğ
nibbËm­
[
tmp
&0xf] +‚ibblemap[(tmp>>4)&0xf];

59 
numb™s
 = 0;

61 
j
=0; j<
’d
; j++)

62 
sum
 +ğ
nibbËm­
[
bh
->
b_d©a
[
j
] & 0xf]

63 + 
nibbËm­
[(
bh
->
b_d©a
[
j
]>>4)&0xf];

65 (
sum
);

66 
	}
}

68 
	$mšix_ä“_block
(
su³r_block
 * 
sb
, 
block
)

70 
bufãr_h—d
 * 
bh
;

71 
b™
,
zÚe
;

73 ià(!
sb
) {

74 
	`´štk
("tryingo free block on‚onexistent device\n");

77 ià(
block
 < 
sb
->
u
.
mšix_sb
.
s_fœ¡d©azÚe
 ||

78 
block
 >ğ
sb
->
u
.
mšix_sb
.
s_nzÚes
) {

79 
	`´štk
("tryingo free block‚ot in datazone\n");

82 
bh
 = 
	`g‘_hash_bË
(
sb
->
s_dev
,
block
,
BLOCK_SIZE
);

83 ià(
bh
)

84 
bh
->
b_dœt
=0;

85 
	`b»l£
(
bh
);

86 
zÚe
 = 
block
 - 
sb
->
u
.
mšix_sb
.
s_fœ¡d©azÚe
 + 1;

87 
b™
 = 
zÚe
 & 8191;

88 
zÚe
 >>= 13;

89 
bh
 = 
sb
->
u
.
mšix_sb
.
s_zm­
[
zÚe
];

90 ià(!
bh
) {

91 
	`´štk
("minix_free_block:‚onexistent bitmap buffer\n");

94 ià(!
	`ş—r_b™
(
b™
,
bh
->
b_d©a
))

95 
	`´štk
("ä“_block (%04x:%d): b™‡Ì—dy cË¬ed\n",
sb
->
s_dev
,
block
);

96 
bh
->
b_dœt
 = 1;

98 
	}
}

100 
	$mšix_Ãw_block
(
su³r_block
 * 
sb
)

102 
bufãr_h—d
 * 
bh
;

103 
i
,
j
;

105 ià(!
sb
) {

106 
	`´štk
("tryingo get‚ew block from‚onexistent device\n");

109 
»³©
:

110 
j
 = 8192;

111 
i
=0 ; i<8 ; i++)

112 ià((
bh
=
sb
->
u
.
mšix_sb
.
s_zm­
[
i
]è!ğ
NULL
)

113 ià((
j
=
	`fšd_fœ¡_z”o
(
bh
->
b_d©a
))<8192)

115 ià(
i
>=8 || !
bh
 || 
j
>=8192)

117 ià(
	`£t_b™
(
j
,
bh
->
b_d©a
)) {

118 
	`´štk
("new_block: bit‡lready set");

119 
»³©
;

121 
bh
->
b_dœt
 = 1;

122 
j
 +ğ
i
*8192 + 
sb
->
u
.
mšix_sb
.
s_fœ¡d©azÚe
-1;

123 ià(
j
 < 
sb
->
u
.
mšix_sb
.
s_fœ¡d©azÚe
 ||

124 
j
 >ğ
sb
->
u
.
mšix_sb
.
s_nzÚes
)

126 ià(!(
bh
 = 
	`g‘blk
(
sb
->
s_dev
,
j
,
BLOCK_SIZE
))) {

127 
	`´štk
("new_block: cannot get block");

130 
	`ş—r_block
(
bh
->
b_d©a
);

131 
bh
->
b_u±od©e
 = 1;

132 
bh
->
b_dœt
 = 1;

133 
	`b»l£
(
bh
);

134  
j
;

135 
	}
}

137 
	$mšix_couÁ_ä“_blocks
(
su³r_block
 *
sb
)

139  (
sb
->
u
.
mšix_sb
.
s_nzÚes
 - 
	`couÁ_u£d
(sb->u.mšix_sb.
s_zm­
,sb->u.mšix_sb.
s_zm­_blocks
,sb->u.minix_sb.s_nzones))

140 << 
sb
->
u
.
mšix_sb
.
s_log_zÚe_size
;

141 
	}
}

143 
	$mšix_ä“_šode
(
šode
 * inode)

145 
bufãr_h—d
 * 
bh
;

146 
šo
;

148 ià(!
šode
)

150 ià(!
šode
->
i_dev
) {

151 
	`´štk
("free_inode: inode has‚o device\n");

154 ià(
šode
->
i_couÁ
 != 1) {

155 
	`´štk
("ä“_šode: inodha couÁ=%d\n",
šode
->
i_couÁ
);

158 ià(
šode
->
i_Æšk
) {

159 
	`´štk
("ä“_šode: inodha Æšk=%d\n",
šode
->
i_Æšk
);

162 ià(!
šode
->
i_sb
) {

163 
	`´štk
("free_inode: inode on‚onexistent device\n");

166 ià(
šode
->
i_šo
 < 1 || inode->i_šØ>ğšode->
i_sb
->
u
.
mšix_sb
.
s_nšodes
) {

167 
	`´štk
("free_inode: inode 0 or‚onexistent inode\n");

170 
šo
 = 
šode
->
i_šo
;

171 ià(!(
bh
=
šode
->
i_sb
->
u
.
mšix_sb
.
s_im­
[
šo
 >> 13])) {

172 
	`´štk
("free_inode:‚onexistent imap in superblock\n");

175 
	`ş—r_šode
(
šode
);

176 ià(!
	`ş—r_b™
(
šo
 & 8191, 
bh
->
b_d©a
))

177 
	`´štk
("ä“_šode: b™ %lu‡Ì—dy cË¬ed.\n",
šo
);

178 
bh
->
b_dœt
 = 1;

179 
	}
}

181 
šode
 * 
	$mšix_Ãw_šode
(cÚ¡ 
šode
 * 
dœ
)

183 
su³r_block
 * 
sb
;

184 
šode
 * inode;

185 
bufãr_h—d
 * 
bh
;

186 
i
,
j
;

188 ià(!
dœ
 || !(
šode
 = 
	`g‘_em±y_šode
()))

189  
NULL
;

190 
sb
 = 
dœ
->
i_sb
;

191 
šode
->
i_sb
 = 
sb
;

192 
šode
->
i_æags
 = inode->
i_sb
->
s_æags
;

193 
j
 = 8192;

194 
i
=0 ; i<8 ; i++)

195 ià((
bh
 = 
šode
->
i_sb
->
u
.
mšix_sb
.
s_im­
[
i
]è!ğ
NULL
)

196 ià((
j
=
	`fšd_fœ¡_z”o
(
bh
->
b_d©a
))<8192)

198 ià(!
bh
 || 
j
 >= 8192) {

199 
	`ut
(
šode
);

200  
NULL
;

202 ià(
	`£t_b™
(
j
,
bh
->
b_d©a
)) {

203 
	`´štk
("new_inode: bit‡lready set");

204 
	`ut
(
šode
);

205  
NULL
;

207 
bh
->
b_dœt
 = 1;

208 
j
 +ğ
i
*8192;

209 ià(!
j
 || j >ğ
šode
->
i_sb
->
u
.
mšix_sb
.
s_nšodes
) {

210 
	`ut
(
šode
);

211  
NULL
;

213 
šode
->
i_couÁ
 = 1;

214 
šode
->
i_Æšk
 = 1;

215 
šode
->
i_dev
 = 
sb
->
s_dev
;

216 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

217 
šode
->
i_gid
 = (
dœ
->
i_mode
 & 
S_ISGID
è? dœ->i_gid : 
cu¼’t
->
egid
;

218 
šode
->
i_dœt
 = 1;

219 
šode
->
i_šo
 = 
j
;

220 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

221 
šode
->
i_İ
 = 
NULL
;

222 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

223 
	`š£¹_šode_hash
(
šode
);

224  
šode
;

225 
	}
}

227 
	$mšix_couÁ_ä“_šodes
(
su³r_block
 *
sb
)

229  
sb
->
u
.
mšix_sb
.
s_nšodes
 - 
	`couÁ_u£d
(sb->u.mšix_sb.
s_im­
,sb->u.mšix_sb.
s_im­_blocks
,sb->u.minix_sb.s_ninodes);

230 
	}
}

	@fs/minix/dir.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/mšix_fs.h
>

14 
	~<lšux/¡©.h
>

16 
	$mšix_dœ_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

18  -
EISDIR
;

19 
	}
}

21 
mšix_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

23 
fe_İ”©iÚs
 
	gmšix_dœ_İ”©iÚs
 = {

24 
NULL
,

25 
mšix_dœ_»ad
,

26 
NULL
,

27 
mšix_»addœ
,

28 
NULL
,

29 
NULL
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
fe_fsync


39 
šode_İ”©iÚs
 
	gmšix_dœ_šode_İ”©iÚs
 = {

40 &
mšix_dœ_İ”©iÚs
,

41 
mšix_ü—‹
,

42 
mšix_lookup
,

43 
mšix_lšk
,

44 
mšix_uÆšk
,

45 
mšix_symlšk
,

46 
mšix_mkdœ
,

47 
mšix_rmdœ
,

48 
mšix_mknod
,

49 
mšix_»Çme
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
mšix_Œunÿ‹
,

54 
NULL


57 
	$mšix_»addœ
(
šode
 * inode, 
fe
 * 
fp
,

58 
dœ’t
 * dœ’t, 
couÁ
)

60 
off£t
,
i
;

61 
c
;

62 
bufãr_h—d
 * 
bh
;

63 
mšix_dœ_’Œy
 * 
de
;

64 
mšix_sb_šfo
 * 
šfo
;

66 ià(!
šode
 || !šode->
i_sb
 || !
	`S_ISDIR
(šode->
i_mode
))

67  -
EBADF
;

68 
šfo
 = &
šode
->
i_sb
->
u
.
mšix_sb
;

69 ià(
fp
->
f_pos
 & (
šfo
->
s_dœsize
 - 1))

70  -
EBADF
;

71 
fp
->
f_pos
 < 
šode
->
i_size
) {

72 
off£t
 = 
fp
->
f_pos
 & 1023;

73 
bh
 = 
	`mšix_b»ad
(
šode
,(
fp
->
f_pos
)>>
BLOCK_SIZE_BITS
,0);

74 ià(!
bh
) {

75 
fp
->
f_pos
 +ğ1024-
off£t
;

78 
off£t
 < 1024 && 
fp
->
f_pos
 < 
šode
->
i_size
) {

79 
de
 = (
mšix_dœ_’Œy
 *è(
off£t
 + 
bh
->
b_d©a
);

80 
off£t
 +ğ
šfo
->
s_dœsize
;

81 
fp
->
f_pos
 +ğ
šfo
->
s_dœsize
;

82 ià(
de
->
šode
) {

83 
i
 = 0; i < 
šfo
->
s_Çm–’
; i++)

84 ià((
c
 = 
de
->
Çme
[
i
]) != 0)

85 
	`put_fs_by‹
(
c
,
i
+
dœ’t
->
d_Çme
);

88 ià(
i
) {

89 
	`put_fs_lÚg
(
de
->
šode
,&
dœ’t
->
d_šo
);

90 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

91 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

92 
	`b»l£
(
bh
);

93  
i
;

97 
	`b»l£
(
bh
);

100 
	}
}

	@fs/minix/file.c

9 
	~<asm/£gm’t.h
>

10 
	~<asm/sy¡em.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/mšix_fs.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/fú.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/locks.h
>

20 
	#NBUF
 32

	)

22 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

23 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

25 
	~<lšux/fs.h
>

26 
	~<lšux/mšix_fs.h
>

28 
mšix_fe_»ad
(
šode
 *, 
fe
 *, *, );

29 
mšix_fe_wr™e
(
šode
 *, 
fe
 *, *, );

35 
fe_İ”©iÚs
 
	gmšix_fe_İ”©iÚs
 = {

36 
NULL
,

37 
mšix_fe_»ad
,

38 
mšix_fe_wr™e
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
g’”ic_mm­
,

43 
NULL
,

44 
NULL
,

45 
mšix_sync_fe


48 
šode_İ”©iÚs
 
	gmšix_fe_šode_İ”©iÚs
 = {

49 &
mšix_fe_İ”©iÚs
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
NULL
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
mšix_bm­
,

62 
mšix_Œunÿ‹
,

63 
NULL


66 
	$mšix_fe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

68 
»ad
,
Ëá
,
ch¬s
;

69 
block
, 
blocks
, 
off£t
;

70 
bh»que¡
, 
u±od©e
;

71 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

72 
bufãr_h—d
 * 
bh»q
[
NBUF
];

73 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

74 
size
;

76 ià(!
šode
) {

77 
	`´štk
("minix_file_read: inode = NULL\n");

78  -
EINVAL
;

80 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

81 
	`´štk
("mšix_fe_»ad: modğ%07o\n",
šode
->
i_mode
);

82  -
EINVAL
;

84 
off£t
 = 
fp
->
f_pos
;

85 
size
 = 
šode
->
i_size
;

86 ià(
off£t
 > 
size
)

87 
Ëá
 = 0;

89 
Ëá
 = 
size
 - 
off£t
;

90 ià(
Ëá
 > 
couÁ
)

91 
Ëá
 = 
couÁ
;

92 ià(
Ëá
 <= 0)

94 
»ad
 = 0;

95 
block
 = 
off£t
 >> 
BLOCK_SIZE_BITS
;

96 
off£t
 &ğ
BLOCK_SIZE
-1;

97 
size
 = (siz+ (
BLOCK_SIZE
-1)è>> 
BLOCK_SIZE_BITS
;

98 
blocks
 = (
Ëá
 + 
off£t
 + 
BLOCK_SIZE
 - 1è>> 
BLOCK_SIZE_BITS
;

99 
bhb
 = 
bhe
 = 
buæi¡
;

100 ià(
fp
->
f_»ada
) {

101 
blocks
 +ğ
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] / (
BLOCK_SIZE
 >> 9);

102 ià(
block
 + 
blocks
 > 
size
)

103 
blocks
 = 
size
 - 
block
;

117 
bh»que¡
 = 0;

118 
u±od©e
 = 1;

119 
blocks
) {

120 --
blocks
;

121 *
bhb
 = 
	`mšix_g‘blk
(
šode
, 
block
++, 0);

122 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

123 
u±od©e
 = 0;

124 
bh»q
[
bh»que¡
++] = *
bhb
;

127 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

128 
bhb
 = 
buæi¡
;

132 ià(
u±od©e
)

134 ià(
bhb
 =ğ
bhe
)

139 ià(
bh»que¡
)

140 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

143 ià(*
bhe
) {

144 
	`wa™_Ú_bufãr
(*
bhe
);

145 ià(!(*
bhe
)->
b_u±od©e
) {

146 
	`b»l£
(*
bhe
);

147 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

148 
bhe
 = 
buæi¡
;

149 
Ëá
 = 0;

153 ià(
Ëá
 < 
BLOCK_SIZE
 - 
off£t
)

154 
ch¬s
 = 
Ëá
;

156 
ch¬s
 = 
BLOCK_SIZE
 - 
off£t
;

157 
fp
->
f_pos
 +ğ
ch¬s
;

158 
Ëá
 -ğ
ch¬s
;

159 
»ad
 +ğ
ch¬s
;

160 ià(*
bhe
) {

161 
	`memıy_tofs
(
buf
,
off£t
+(*
bhe
)->
b_d©a
,
ch¬s
);

162 
	`b»l£
(*
bhe
);

163 
buf
 +ğ
ch¬s
;

165 
ch¬s
-->0)

166 
	`put_fs_by‹
(0,
buf
++);

168 
off£t
 = 0;

169 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

170 
bhe
 = 
buæi¡
;

171 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!*bh|| !(*bhe)->
b_lock
));

172 } 
Ëá
 > 0);

175 
bhe
 !ğ
bhb
) {

176 
	`b»l£
(*
bhe
);

177 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

178 
bhe
 = 
buæi¡
;

180 ià(!
»ad
)

181  -
EIO
;

182 
fp
->
f_»ada
 = 1;

183 ià(!
	`IS_RDONLY
(
šode
))

184 
šode
->
i_©ime
 = 
CURRENT_TIME
;

185  
»ad
;

186 
	}
}

188 
	$mšix_fe_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

190 
off_t
 
pos
;

191 
wr™‹n
,
c
;

192 
bufãr_h—d
 * 
bh
;

193 * 
p
;

195 ià(!
šode
) {

196 
	`´štk
("minix_file_write: inode = NULL\n");

197  -
EINVAL
;

199 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

200 
	`´štk
("mšix_fe_wr™e: modğ%07o\n",
šode
->
i_mode
);

201  -
EINVAL
;

207 ià(
fp
->
f_æags
 & 
O_APPEND
)

208 
pos
 = 
šode
->
i_size
;

210 
pos
 = 
fp
->
f_pos
;

211 
wr™‹n
 = 0;

212 
wr™‹n
<
couÁ
) {

213 
bh
 = 
	`mšix_g‘blk
(
šode
,
pos
/
BLOCK_SIZE
,1);

214 ià(!
bh
) {

215 ià(!
wr™‹n
)

216 
wr™‹n
 = -
ENOSPC
;

219 
c
 = 
BLOCK_SIZE
 - (
pos
 % BLOCK_SIZE);

220 ià(
c
 > 
couÁ
-
wr™‹n
)

221 
c
 = 
couÁ
-
wr™‹n
;

222 ià(
c
 !ğ
BLOCK_SIZE
 && !
bh
->
b_u±od©e
) {

223 
	`Î_rw_block
(
READ
, 1, &
bh
);

224 
	`wa™_Ú_bufãr
(
bh
);

225 ià(!
bh
->
b_u±od©e
) {

226 
	`b»l£
(
bh
);

227 ià(!
wr™‹n
)

228 
wr™‹n
 = -
EIO
;

232 
p
 = (
pos
 % 
BLOCK_SIZE
è+ 
bh
->
b_d©a
;

233 
pos
 +ğ
c
;

234 ià(
pos
 > 
šode
->
i_size
) {

235 
šode
->
i_size
 = 
pos
;

236 
šode
->
i_dœt
 = 1;

238 
wr™‹n
 +ğ
c
;

239 
	`memıy_äomfs
(
p
,
buf
,
c
);

240 
buf
 +ğ
c
;

241 
bh
->
b_u±od©e
 = 1;

242 
bh
->
b_dœt
 = 1;

243 
	`b»l£
(
bh
);

245 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

246 
fp
->
f_pos
 = 
pos
;

247 
šode
->
i_dœt
 = 1;

248  
wr™‹n
;

249 
	}
}

	@fs/minix/fsync.c

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/¡©.h
>

17 
	~<lšux/fú.h
>

18 
	~<lšux/locks.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/mšix_fs.h
>

24 
	#blocksize
 
BLOCK_SIZE


	)

25 
	#addr_³r_block
 512

	)

27 
	$sync_block
 (
šode
 * inode, * 
block
, 
wa™
)

29 
bufãr_h—d
 * 
bh
;

30 
tmp
;

32 ià(!*
block
)

34 
tmp
 = *
block
;

35 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
, *
block
, 
blocksize
);

36 ià(!
bh
)

38 ià(*
block
 !ğ
tmp
) {

39 
	`b»l£
 (
bh
);

42 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_u±od©e
) {

43 
	`b»l£
(
bh
);

46 ià(
wa™
 || !
bh
->
b_u±od©e
 || !bh->
b_dœt
)

48 
	`b»l£
(
bh
);

51 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

52 
bh
->
b_couÁ
--;

54 
	}
}

56 
	$sync_iblock
 (
šode
 * inode, * 
iblock
,

57 
bufãr_h—d
 **
bh
, 
wa™
)

59 
rc
;

60 
tmp
;

62 *
bh
 = 
NULL
;

63 
tmp
 = *
iblock
;

64 ià(!
tmp
)

66 
rc
 = 
	`sync_block
 (
šode
, 
iblock
, 
wa™
);

67 ià(
rc
)

68  
rc
;

69 *
bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
blocksize
);

70 ià(
tmp
 !ğ*
iblock
) {

71 
	`b»l£
(*
bh
);

72 *
bh
 = 
NULL
;

75 ià(!*
bh
)

78 
	}
}

81 
	$sync_dœeù
(
šode
 *šode, 
wa™
)

83 
i
;

84 
rc
, 
”r
 = 0;

86 
i
 = 0; i < 7; i++) {

87 
rc
 = 
	`sync_block
 (
šode
, inode->
u
.
mšix_i
.
i_d©a
 + 
i
, 
wa™
);

88 ià(
rc
 > 0)

90 ià(
rc
)

91 
”r
 = 
rc
;

93  
”r
;

94 
	}
}

96 
	$sync_šdœeù
(
šode
 *šode, *
iblock
, 
wa™
)

98 
i
;

99 
bufãr_h—d
 * 
šd_bh
;

100 
rc
, 
”r
 = 0;

102 
rc
 = 
	`sync_iblock
 (
šode
, 
iblock
, &
šd_bh
, 
wa™
);

103 ià(
rc
 || !
šd_bh
)

104  
rc
;

106 
i
 = 0; i < 
addr_³r_block
; i++) {

107 
rc
 = 
	`sync_block
 (
šode
,

108 ((*è
šd_bh
->
b_d©a
è+ 
i
,

109 
wa™
);

110 ià(
rc
 > 0)

112 ià(
rc
)

113 
”r
 = 
rc
;

115 
	`b»l£
(
šd_bh
);

116  
”r
;

117 
	}
}

119 
	$sync_dšdœeù
(
šode
 *šode, *
diblock
,

120 
wa™
)

122 
i
;

123 
bufãr_h—d
 * 
dšd_bh
;

124 
rc
, 
”r
 = 0;

126 
rc
 = 
	`sync_iblock
 (
šode
, 
diblock
, &
dšd_bh
, 
wa™
);

127 ià(
rc
 || !
dšd_bh
)

128  
rc
;

130 
i
 = 0; i < 
addr_³r_block
; i++) {

131 
rc
 = 
	`sync_šdœeù
 (
šode
,

132 ((*è
dšd_bh
->
b_d©a
è+ 
i
,

133 
wa™
);

134 ià(
rc
 > 0)

136 ià(
rc
)

137 
”r
 = 
rc
;

139 
	`b»l£
(
dšd_bh
);

140  
”r
;

141 
	}
}

143 
	$mšix_sync_fe
(
šode
 * inode, 
fe
 * file)

145 
wa™
, 
”r
 = 0;

147 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

148 
	`S_ISLNK
(
šode
->
i_mode
)))

149  -
EINVAL
;

151 
wa™
=0; wait<=1; wait++)

153 
”r
 |ğ
	`sync_dœeù
(
šode
, 
wa™
);

154 
”r
 |ğ
	`sync_šdœeù
(
šode
, inode->
u
.
mšix_i
.
i_d©a
+7, 
wa™
);

155 
”r
 |ğ
	`sync_dšdœeù
(
šode
, inode->
u
.
mšix_i
.
i_d©a
+8, 
wa™
);

157 
”r
 |ğ
	`mšix_sync_šode
 (
šode
);

158  (
”r
 < 0è? -
EIO
 : 0;

159 
	}
}

	@fs/minix/inode.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/mšix_fs.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/mm.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/locks.h
>

15 
	~<asm/sy¡em.h
>

16 
	~<asm/£gm’t.h
>

17 
	~<asm/b™İs.h
>

19 
	$mšix_put_šode
(
šode
 *inode)

21 ià(
šode
->
i_Æšk
)

23 
šode
->
i_size
 = 0;

24 
	`mšix_Œunÿ‹
(
šode
);

25 
	`mšix_ä“_šode
(
šode
);

26 
	}
}

28 
	$mšix_comm™_su³r
 (
su³r_block
 * 
sb
,

29 
mšix_su³r_block
 * 
ms
)

31 
sb
->
u
.
mšix_sb
.
s_sbh
->
b_dœt
 = 1;

32 
sb
->
s_dœt
 = 0;

33 
	}
}

35 
	$mšix_wr™e_su³r
 (
su³r_block
 * 
sb
)

37 
mšix_su³r_block
 * 
ms
;

39 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

40 
ms
 = 
sb
->
u
.
mšix_sb
.
s_ms
;

42 ià(
ms
->
s_¡©e
 & 
MINIX_VALID_FS
)

43 
ms
->
s_¡©e
 &ğ~
MINIX_VALID_FS
;

44 
	`mšix_comm™_su³r
 (
sb
, 
ms
);

46 
sb
->
s_dœt
 = 0;

47 
	}
}

50 
	$mšix_put_su³r
(
su³r_block
 *
sb
)

52 
i
;

54 
	`lock_su³r
(
sb
);

55 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

56 
sb
->
u
.
mšix_sb
.
s_ms
->
s_¡©e
 = sb->u.mšix_sb.
s_mouÁ_¡©e
;

57 
sb
->
u
.
mšix_sb
.
s_sbh
->
b_dœt
 = 1;

59 
sb
->
s_dev
 = 0;

60 
i
 = 0 ; i < 
MINIX_I_MAP_SLOTS
 ; i++)

61 
	`b»l£
(
sb
->
u
.
mšix_sb
.
s_im­
[
i
]);

62 
i
 = 0 ; i < 
MINIX_Z_MAP_SLOTS
 ; i++)

63 
	`b»l£
(
sb
->
u
.
mšix_sb
.
s_zm­
[
i
]);

64 
	`b»l£
 (
sb
->
u
.
mšix_sb
.
s_sbh
);

65 
	`uÆock_su³r
(
sb
);

67 
	}
}

69 
su³r_İ”©iÚs
 
	gmšix_sİs
 = {

70 
mšix_»ad_šode
,

71 
NULL
,

72 
mšix_wr™e_šode
,

73 
mšix_put_šode
,

74 
mšix_put_su³r
,

75 
mšix_wr™e_su³r
,

76 
mšix_¡©fs
,

77 
mšix_»mouÁ


80 
	$mšix_»mouÁ
 (
su³r_block
 * 
sb
, * 
æags
, * 
d©a
)

82 
mšix_su³r_block
 * 
ms
;

84 
ms
 = 
sb
->
u
.
mšix_sb
.
s_ms
;

85 ià((*
æags
 & 
MS_RDONLY
è=ğ(
sb
->
s_æags
 & MS_RDONLY))

87 ià(*
æags
 & 
MS_RDONLY
) {

88 ià(
ms
->
s_¡©e
 & 
MINIX_VALID_FS
 ||

89 !(
sb
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 & 
MINIX_VALID_FS
))

92 
ms
->
s_¡©e
 = 
sb
->
u
.
mšix_sb
.
s_mouÁ_¡©e
;

93 
sb
->
u
.
mšix_sb
.
s_sbh
->
b_dœt
 = 1;

94 
sb
->
s_dœt
 = 1;

95 
	`mšix_comm™_su³r
 (
sb
, 
ms
);

99 
sb
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 = 
ms
->
s_¡©e
;

100 
ms
->
s_¡©e
 &ğ~
MINIX_VALID_FS
;

101 
sb
->
u
.
mšix_sb
.
s_sbh
->
b_dœt
 = 1;

102 
sb
->
s_dœt
 = 1;

104 ià(!(
sb
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 & 
MINIX_VALID_FS
))

105 
	`´štk
 ("MINIX-fs warning:„emounting unchecked fs, "

107 ià((
sb
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 & 
MINIX_ERROR_FS
))

108 
	`´štk
 ("MINIX-fs warning:„emounting fs withƒrrors, "

112 
	}
}

115 
su³r_block
 *
	$mšix_»ad_su³r
(
su³r_block
 *
s
,*
d©a
,

116 
s’t
)

118 
bufãr_h—d
 *
bh
;

119 
mšix_su³r_block
 *
ms
;

120 
i
,
dev
=
s
->
s_dev
,
block
;

122 ià(32 !ğ (
mšix_šode
))

123 
	`·nic
("bad i-node size");

124 
	`lock_su³r
(
s
);

125 ià(!(
bh
 = 
	`b»ad
(
dev
,1,
BLOCK_SIZE
))) {

126 
s
->
s_dev
=0;

127 
	`uÆock_su³r
(
s
);

128 
	`´štk
("MINIX-fs: unableo„ead superblock\n");

129  
NULL
;

131 
ms
 = (
mšix_su³r_block
 *è
bh
->
b_d©a
;

132 
s
->
u
.
mšix_sb
.
s_ms
 = 
ms
;

133 
s
->
u
.
mšix_sb
.
s_sbh
 = 
bh
;

134 
s
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 = 
ms
->
s_¡©e
;

135 
s
->
s_blocksize
 = 1024;

136 
s
->
s_blocksize_b™s
 = 10;

137 
s
->
u
.
mšix_sb
.
s_nšodes
 = 
ms
->s_ninodes;

138 
s
->
u
.
mšix_sb
.
s_nzÚes
 = 
ms
->s_nzones;

139 
s
->
u
.
mšix_sb
.
s_im­_blocks
 = 
ms
->s_imap_blocks;

140 
s
->
u
.
mšix_sb
.
s_zm­_blocks
 = 
ms
->s_zmap_blocks;

141 
s
->
u
.
mšix_sb
.
s_fœ¡d©azÚe
 = 
ms
->s_firstdatazone;

142 
s
->
u
.
mšix_sb
.
s_log_zÚe_size
 = 
ms
->s_log_zone_size;

143 
s
->
u
.
mšix_sb
.
s_max_size
 = 
ms
->s_max_size;

144 
s
->
s_magic
 = 
ms
->s_magic;

145 ià(
s
->
s_magic
 =ğ
MINIX_SUPER_MAGIC
) {

146 
s
->
u
.
mšix_sb
.
s_dœsize
 = 16;

147 
s
->
u
.
mšix_sb
.
s_Çm–’
 = 14;

148 } ià(
s
->
s_magic
 =ğ
MINIX_SUPER_MAGIC2
) {

149 
s
->
u
.
mšix_sb
.
s_dœsize
 = 32;

150 
s
->
u
.
mšix_sb
.
s_Çm–’
 = 30;

152 
s
->
s_dev
 = 0;

153 
	`uÆock_su³r
(
s
);

154 
	`b»l£
(
bh
);

155 ià(!
s’t
)

156 
	`´štk
("VFS: Cª'ˆfšd‡ mšix fesy¡em oÀdev 0x%04x.\n", 
dev
);

157  
NULL
;

159 
i
=0;˜< 
MINIX_I_MAP_SLOTS
;i++)

160 
s
->
u
.
mšix_sb
.
s_im­
[
i
] = 
NULL
;

161 
i
=0;˜< 
MINIX_Z_MAP_SLOTS
;i++)

162 
s
->
u
.
mšix_sb
.
s_zm­
[
i
] = 
NULL
;

163 
block
=2;

164 
i
=0 ; i < 
s
->
u
.
mšix_sb
.
s_im­_blocks
 ; i++)

165 ià((
s
->
u
.
mšix_sb
.
s_im­
[
i
]=
	`b»ad
(
dev
,
block
,
BLOCK_SIZE
)è!ğ
NULL
)

166 
block
++;

169 
i
=0 ; i < 
s
->
u
.
mšix_sb
.
s_zm­_blocks
 ; i++)

170 ià((
s
->
u
.
mšix_sb
.
s_zm­
[
i
]=
	`b»ad
(
dev
,
block
,
BLOCK_SIZE
)è!ğ
NULL
)

171 
block
++;

174 ià(
block
 !ğ2+
s
->
u
.
mšix_sb
.
s_im­_blocks
+s->u.mšix_sb.
s_zm­_blocks
) {

175 
i
=0;i<
MINIX_I_MAP_SLOTS
;i++)

176 
	`b»l£
(
s
->
u
.
mšix_sb
.
s_im­
[
i
]);

177 
i
=0;i<
MINIX_Z_MAP_SLOTS
;i++)

178 
	`b»l£
(
s
->
u
.
mšix_sb
.
s_zm­
[
i
]);

179 
s
->
s_dev
=0;

180 
	`uÆock_su³r
(
s
);

181 
	`b»l£
(
bh
);

182 
	`´štk
("MINIX-fs: bad superblock or unableo„ead bitmaps\n");

183  
NULL
;

185 
	`£t_b™
(0,
s
->
u
.
mšix_sb
.
s_im­
[0]->
b_d©a
);

186 
	`£t_b™
(0,
s
->
u
.
mšix_sb
.
s_zm­
[0]->
b_d©a
);

187 
	`uÆock_su³r
(
s
);

189 
s
->
s_dev
 = 
dev
;

190 
s
->
s_İ
 = &
mšix_sİs
;

191 
s
->
s_mouÁed
 = 
	`ig‘
(s,
MINIX_ROOT_INO
);

192 ià(!
s
->
s_mouÁed
) {

193 
s
->
s_dev
 = 0;

194 
	`b»l£
(
bh
);

195 
	`´štk
("MINIX-fs: get„oot inode failed\n");

196  
NULL
;

198 ià(!(
s
->
s_æags
 & 
MS_RDONLY
)) {

199 
ms
->
s_¡©e
 &ğ~
MINIX_VALID_FS
;

200 
bh
->
b_dœt
 = 1;

201 
s
->
s_dœt
 = 1;

203 ià(!(
s
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 & 
MINIX_VALID_FS
))

204 
	`´štk
 ("MINIX-fs: mounting unchecked file system, "

206 ià(
s
->
u
.
mšix_sb
.
s_mouÁ_¡©e
 & 
MINIX_ERROR_FS
)

207 
	`´štk
 ("MINIX-fs: mounting file system withƒrrors, "

209  
s
;

210 
	}
}

212 
	$mšix_¡©fs
(
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

214 
tmp
;

216 
	`put_fs_lÚg
(
MINIX_SUPER_MAGIC
, &
buf
->
f_ty³
);

217 
	`put_fs_lÚg
(1024, &
buf
->
f_bsize
);

218 
tmp
 = 
sb
->
u
.
mšix_sb
.
s_nzÚes
 - sb->u.mšix_sb.
s_fœ¡d©azÚe
;

219 
tmp
 <<ğ
sb
->
u
.
mšix_sb
.
s_log_zÚe_size
;

220 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_blocks
);

221 
tmp
 = 
	`mšix_couÁ_ä“_blocks
(
sb
);

222 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bä“
);

223 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bava
);

224 
	`put_fs_lÚg
(
sb
->
u
.
mšix_sb
.
s_nšodes
, &
buf
->
f_fes
);

225 
	`put_fs_lÚg
(
	`mšix_couÁ_ä“_šodes
(
sb
), &
buf
->
f_fä“
);

226 
	`put_fs_lÚg
(
sb
->
u
.
mšix_sb
.
s_Çm–’
, &
buf
->
f_Çm–’
);

228 
	}
}

230 
	#šode_bm­
(
šode
,
Ä
è((šode)->
u
.
mšix_i
.
i_d©a
[Òr)])

	)

232 
	$block_bm­
(
bufãr_h—d
 * 
bh
, 
Ä
)

234 
tmp
;

236 ià(!
bh
)

238 
tmp
 = ((*è
bh
->
b_d©a
)[
Ä
];

239 
	`b»l£
(
bh
);

240  
tmp
;

241 
	}
}

243 
	$mšix_bm­
(
šode
 * inode,
block
)

245 
i
;

247 ià(
block
<0) {

248 
	`´štk
("minix_bmap: block<0");

251 ià(
block
 >= 7+512+512*512) {

252 
	`´štk
("minix_bmap: block>big");

255 ià(
block
 < 7)

256  
	`šode_bm­
(
šode
,
block
);

257 
block
 -= 7;

258 ià(
block
 < 512) {

259 
i
 = 
	`šode_bm­
(
šode
,7);

260 ià(!
i
)

262  
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
),
block
);

264 
block
 -= 512;

265 
i
 = 
	`šode_bm­
(
šode
,8);

266 ià(!
i
)

268 
i
 = 
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,i,
BLOCK_SIZE
),
block
>>9);

269 ià(!
i
)

271  
	`block_bm­
(
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
),
block
 & 511);

272 
	}
}

274 
bufãr_h—d
 * 
	$šode_g‘blk
(
šode
 * inode, 
Ä
, 
ü—‹
)

276 
tmp
;

277 *
p
;

278 
bufãr_h—d
 * 
»suÉ
;

280 
p
 = 
šode
->
u
.
mšix_i
.
i_d©a
 + 
Ä
;

281 
»³©
:

282 
tmp
 = *
p
;

283 ià(
tmp
) {

284 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

285 ià(
tmp
 =ğ*
p
)

286  
»suÉ
;

287 
	`b»l£
(
»suÉ
);

288 
»³©
;

290 ià(!
ü—‹
)

291  
NULL
;

292 
tmp
 = 
	`mšix_Ãw_block
(
šode
->
i_sb
);

293 ià(!
tmp
)

294  
NULL
;

295 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

296 ià(*
p
) {

297 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

298 
	`b»l£
(
»suÉ
);

299 
»³©
;

301 *
p
 = 
tmp
;

302 
šode
->
i_ùime
 = 
CURRENT_TIME
;

303 
šode
->
i_dœt
 = 1;

304  
»suÉ
;

305 
	}
}

307 
bufãr_h—d
 * 
	$block_g‘blk
(
šode
 * inode,

308 
bufãr_h—d
 * 
bh
, 
Ä
, 
ü—‹
)

310 
tmp
;

311 *
p
;

312 
bufãr_h—d
 * 
»suÉ
;

314 ià(!
bh
)

315  
NULL
;

316 ià(!
bh
->
b_u±od©e
) {

317 
	`Î_rw_block
(
READ
, 1, &
bh
);

318 
	`wa™_Ú_bufãr
(
bh
);

319 ià(!
bh
->
b_u±od©e
) {

320 
	`b»l£
(
bh
);

321  
NULL
;

324 
p
 = 
Ä
 + (*è
bh
->
b_d©a
;

325 
»³©
:

326 
tmp
 = *
p
;

327 ià(
tmp
) {

328 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
BLOCK_SIZE
);

329 ià(
tmp
 =ğ*
p
) {

330 
	`b»l£
(
bh
);

331  
»suÉ
;

333 
	`b»l£
(
»suÉ
);

334 
»³©
;

336 ià(!
ü—‹
) {

337 
	`b»l£
(
bh
);

338  
NULL
;

340 
tmp
 = 
	`mšix_Ãw_block
(
šode
->
i_sb
);

341 ià(!
tmp
) {

342 
	`b»l£
(
bh
);

343  
NULL
;

345 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
BLOCK_SIZE
);

346 ià(*
p
) {

347 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

348 
	`b»l£
(
»suÉ
);

349 
»³©
;

351 *
p
 = 
tmp
;

352 
bh
->
b_dœt
 = 1;

353 
	`b»l£
(
bh
);

354  
»suÉ
;

355 
	}
}

357 
bufãr_h—d
 * 
	$mšix_g‘blk
(
šode
 * inode, 
block
, 
ü—‹
)

359 
bufãr_h—d
 * 
bh
;

361 ià(
block
<0) {

362 
	`´štk
("minix_getblk: block<0");

363  
NULL
;

365 ià(
block
 >= 7+512+512*512) {

366 
	`´štk
("minix_getblk: block>big");

367  
NULL
;

369 ià(
block
 < 7)

370  
	`šode_g‘blk
(
šode
,
block
,
ü—‹
);

371 
block
 -= 7;

372 ià(
block
 < 512) {

373 
bh
 = 
	`šode_g‘blk
(
šode
,7,
ü—‹
);

374  
	`block_g‘blk
(
šode
, 
bh
, 
block
, 
ü—‹
);

376 
block
 -= 512;

377 
bh
 = 
	`šode_g‘blk
(
šode
,8,
ü—‹
);

378 
bh
 = 
	`block_g‘blk
(
šode
, bh, 
block
>>9, 
ü—‹
);

379  
	`block_g‘blk
(
šode
, 
bh
, 
block
 & 511, 
ü—‹
);

380 
	}
}

382 
bufãr_h—d
 * 
	$mšix_b»ad
(
šode
 * inode, 
block
, 
ü—‹
)

384 
bufãr_h—d
 * 
bh
;

386 
bh
 = 
	`mšix_g‘blk
(
šode
,
block
,
ü—‹
);

387 ià(!
bh
 || bh->
b_u±od©e
)

388  
bh
;

389 
	`Î_rw_block
(
READ
, 1, &
bh
);

390 
	`wa™_Ú_bufãr
(
bh
);

391 ià(
bh
->
b_u±od©e
)

392  
bh
;

393 
	`b»l£
(
bh
);

394  
NULL
;

395 
	}
}

397 
	$mšix_»ad_šode
(
šode
 * inode)

399 
bufãr_h—d
 * 
bh
;

400 
mšix_šode
 * 
¿w_šode
;

401 
block
, 
šo
;

403 
šo
 = 
šode
->
i_šo
;

404 
šode
->
i_İ
 = 
NULL
;

405 
šode
->
i_mode
 = 0;

406 ià(!
šo
 || inØ>ğ
šode
->
i_sb
->
u
.
mšix_sb
.
s_nšodes
) {

407 
	`´štk
("Bad inode‚umber on dev 0x%04x: %d is out of„ange\n",

408 
šode
->
i_dev
, 
šo
);

411 
block
 = 2 + 
šode
->
i_sb
->
u
.
mšix_sb
.
s_im­_blocks
 +

412 
šode
->
i_sb
->
u
.
mšix_sb
.
s_zm­_blocks
 +

413 (
šo
-1)/
MINIX_INODES_PER_BLOCK
;

414 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
,
block
, 
BLOCK_SIZE
))) {

415 
	`´štk
("Major…roblem: unableo„ead inode from dev 0x%04x\n",

416 
šode
->
i_dev
);

419 
¿w_šode
 = ((
mšix_šode
 *è
bh
->
b_d©a
) +

420 (
šo
-1)%
MINIX_INODES_PER_BLOCK
;

421 
šode
->
i_mode
 = 
¿w_šode
->i_mode;

422 
šode
->
i_uid
 = 
¿w_šode
->i_uid;

423 
šode
->
i_gid
 = 
¿w_šode
->i_gid;

424 
šode
->
i_Æšk
 = 
¿w_šode
->
i_Æšks
;

425 
šode
->
i_size
 = 
¿w_šode
->i_size;

426 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
¿w_šode
->
i_time
;

427 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

428 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

429 
šode
->
i_rdev
 = 
¿w_šode
->
i_zÚe
[0];

430 
block
 = 0; block < 9; block++)

431 
šode
->
u
.
mšix_i
.
i_d©a
[
block
] = 
¿w_šode
->
i_zÚe
[block];

432 
	`b»l£
(
bh
);

433 ià(
	`S_ISREG
(
šode
->
i_mode
))

434 
šode
->
i_İ
 = &
mšix_fe_šode_İ”©iÚs
;

435 ià(
	`S_ISDIR
(
šode
->
i_mode
))

436 
šode
->
i_İ
 = &
mšix_dœ_šode_İ”©iÚs
;

437 ià(
	`S_ISLNK
(
šode
->
i_mode
))

438 
šode
->
i_İ
 = &
mšix_symlšk_šode_İ”©iÚs
;

439 ià(
	`S_ISCHR
(
šode
->
i_mode
))

440 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

441 ià(
	`S_ISBLK
(
šode
->
i_mode
))

442 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

443 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

444 
	`š™_fifo
(
šode
);

445 
	}
}

447 
bufãr_h—d
 * 
	$mšix_upd©e_šode
(
šode
 * inode)

449 
bufãr_h—d
 * 
bh
;

450 
mšix_šode
 * 
¿w_šode
;

451 
šo
, 
block
;

453 
šo
 = 
šode
->
i_šo
;

454 ià(!
šo
 || inØ>ğ
šode
->
i_sb
->
u
.
mšix_sb
.
s_nšodes
) {

455 
	`´štk
("Bad inode‚umber on dev 0x%04x: %d is out of„ange\n",

456 
šode
->
i_dev
, 
šo
);

457 
šode
->
i_dœt
 = 0;

460 
block
 = 2 + 
šode
->
i_sb
->
u
.
mšix_sb
.
s_im­_blocks
 + inode->i_sb->u.mšix_sb.
s_zm­_blocks
 +

461 (
šo
-1)/
MINIX_INODES_PER_BLOCK
;

462 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
, 
block
, 
BLOCK_SIZE
))) {

463 
	`´štk
("unableo„ead i-node block\n");

464 
šode
->
i_dœt
 = 0;

467 
¿w_šode
 = ((
mšix_šode
 *)
bh
->
b_d©a
) +

468 (
šo
-1)%
MINIX_INODES_PER_BLOCK
;

469 
¿w_šode
->
i_mode
 = 
šode
->i_mode;

470 
¿w_šode
->
i_uid
 = 
šode
->i_uid;

471 
¿w_šode
->
i_gid
 = 
šode
->i_gid;

472 
¿w_šode
->
i_Æšks
 = 
šode
->
i_Æšk
;

473 
¿w_šode
->
i_size
 = 
šode
->i_size;

474 
¿w_šode
->
i_time
 = 
šode
->
i_mtime
;

475 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

476 
¿w_šode
->
i_zÚe
[0] = 
šode
->
i_rdev
;

477 
block
 = 0; block < 9; block++)

478 
¿w_šode
->
i_zÚe
[
block
] = 
šode
->
u
.
mšix_i
.
i_d©a
[block];

479 
šode
->
i_dœt
=0;

480 
bh
->
b_dœt
=1;

481  
bh
;

482 
	}
}

484 
	$mšix_wr™e_šode
(
šode
 * inode)

486 
bufãr_h—d
 *
bh
;

487 
bh
 = 
	`mšix_upd©e_šode
(
šode
);

488 
	`b»l£
(
bh
);

489 
	}
}

491 
	$mšix_sync_šode
(
šode
 * inode)

493 
”r
 = 0;

494 
bufãr_h—d
 *
bh
;

496 
bh
 = 
	`mšix_upd©e_šode
(
šode
);

497 ià(
bh
 && bh->
b_dœt
)

499 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

500 
	`wa™_Ú_bufãr
(
bh
);

501 ià(
bh
->
b_»q
 && !bh->
b_u±od©e
)

503 
	`´štk
 ("IOƒrror syncing minix inode [%04x:%08lx]\n",

504 
šode
->
i_dev
, inode->
i_šo
);

505 
”r
 = -1;

508 ià(!
bh
)

509 
”r
 = -1;

510 
	`b»l£
 (
bh
);

511  
”r
;

512 
	}
}

	@fs/minix/namei.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/mšix_fs.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/¡ršg.h
>

11 
	~<lšux/¡©.h
>

12 
	~<lšux/fú.h
>

13 
	~<lšux/”ºo.h
>

15 
	~<asm/£gm’t.h
>

23 
šlše
 
	$Çmecom·»
(
Ën
, 
maxËn
,

24 cÚ¡ * 
Çme
, cÚ¡ * 
bufãr
)

26 ià(
Ën
 >ğ
maxËn
 || !
bufãr
[len]) {

27 
§me
;

28 
	`__asm__
("repe ; cmpsb ; setz %0"

29 :"=q" (
§me
)

30 :"S" ((è
Çme
),"D" ((è
bufãr
),"c" (
Ën
)

32  
§me
;

35 
	}
}

44 
	$mšix_m©ch
(
Ën
, cÚ¡ * 
Çme
,

45 
bufãr_h—d
 * 
bh
, * 
off£t
,

46 
mšix_sb_šfo
 * 
šfo
)

48 
mšix_dœ_’Œy
 * 
de
;

50 
de
 = (
mšix_dœ_’Œy
 *è(
bh
->
b_d©a
 + *
off£t
);

51 *
off£t
 +ğ
šfo
->
s_dœsize
;

52 ià(!
de
->
šode
 || 
Ën
 > 
šfo
->
s_Çm–’
)

55 ià(!
Ën
 && (
de
->
Çme
[0]=='.') && (de->name[1]=='\0'))

57  
	`Çmecom·»
(
Ën
,
šfo
->
s_Çm–’
,
Çme
,
de
->name);

58 
	}
}

68 
bufãr_h—d
 * 
	$mšix_fšd_’Œy
(
šode
 * 
dœ
,

69 cÚ¡ * 
Çme
, 
Çm–’
, 
mšix_dœ_’Œy
 ** 
»s_dœ
)

71 
block
, 
off£t
;

72 
bufãr_h—d
 * 
bh
;

73 
mšix_sb_šfo
 * 
šfo
;

75 *
»s_dœ
 = 
NULL
;

76 ià(!
dœ
 || !dœ->
i_sb
)

77  
NULL
;

78 
šfo
 = &
dœ
->
i_sb
->
u
.
mšix_sb
;

79 ià(
Çm–’
 > 
šfo
->
s_Çm–’
) {

80 #ifdeà
NO_TRUNCATE


81  
NULL
;

83 
Çm–’
 = 
šfo
->
s_Çm–’
;

86 
bh
 = 
NULL
;

87 
block
 = 
off£t
 = 0;

88 
block
*
BLOCK_SIZE
+
off£t
 < 
dœ
->
i_size
) {

89 ià(!
bh
) {

90 
bh
 = 
	`mšix_b»ad
(
dœ
,
block
,0);

91 ià(!
bh
) {

92 
block
++;

96 *
»s_dœ
 = (
mšix_dœ_’Œy
 *è(
bh
->
b_d©a
 + 
off£t
);

97 ià(
	`mšix_m©ch
(
Çm–’
,
Çme
,
bh
,&
off£t
,
šfo
))

98  
bh
;

99 ià(
off£t
 < 
bh
->
b_size
)

101 
	`b»l£
(
bh
);

102 
bh
 = 
NULL
;

103 
off£t
 = 0;

104 
block
++;

106 
	`b»l£
(
bh
);

107 *
»s_dœ
 = 
NULL
;

108  
NULL
;

109 
	}
}

111 
	$mšix_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

112 
šode
 ** 
»suÉ
)

114 
šo
;

115 
mšix_dœ_’Œy
 * 
de
;

116 
bufãr_h—d
 * 
bh
;

118 *
»suÉ
 = 
NULL
;

119 ià(!
dœ
)

120  -
ENOENT
;

121 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

122 
	`ut
(
dœ
);

123  -
ENOENT
;

125 ià(!(
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
))) {

126 
	`ut
(
dœ
);

127  -
ENOENT
;

129 
šo
 = 
de
->
šode
;

130 
	`b»l£
(
bh
);

131 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

132 
	`ut
(
dœ
);

133  -
EACCES
;

135 
	`ut
(
dœ
);

137 
	}
}

149 
	$mšix_add_’Œy
(
šode
 * 
dœ
,

150 cÚ¡ * 
Çme
, 
Çm–’
,

151 
bufãr_h—d
 ** 
»s_buf
,

152 
mšix_dœ_’Œy
 ** 
»s_dœ
)

154 
i
;

155 
block
, 
off£t
;

156 
bufãr_h—d
 * 
bh
;

157 
mšix_dœ_’Œy
 * 
de
;

158 
mšix_sb_šfo
 * 
šfo
;

160 *
»s_buf
 = 
NULL
;

161 *
»s_dœ
 = 
NULL
;

162 ià(!
dœ
 || !dœ->
i_sb
)

163  -
ENOENT
;

164 
šfo
 = &
dœ
->
i_sb
->
u
.
mšix_sb
;

165 ià(
Çm–’
 > 
šfo
->
s_Çm–’
) {

166 #ifdeà
NO_TRUNCATE


167  -
ENAMETOOLONG
;

169 
Çm–’
 = 
šfo
->
s_Çm–’
;

172 ià(!
Çm–’
)

173  -
ENOENT
;

174 
bh
 = 
NULL
;

175 
block
 = 
off£t
 = 0;

177 ià(!
bh
) {

178 
bh
 = 
	`mšix_b»ad
(
dœ
,
block
,1);

179 ià(!
bh
)

180  -
ENOSPC
;

182 
de
 = (
mšix_dœ_’Œy
 *è(
bh
->
b_d©a
 + 
off£t
);

183 
off£t
 +ğ
šfo
->
s_dœsize
;

184 ià(
block
*
bh
->
b_size
 + 
off£t
 > 
dœ
->
i_size
) {

185 
de
->
šode
 = 0;

186 
dœ
->
i_size
 = 
block
*
bh
->
b_size
 + 
off£t
;

187 
dœ
->
i_dœt
 = 1;

189 ià(
de
->
šode
) {

190 ià(
	`Çmecom·»
(
Çm–’
, 
šfo
->
s_Çm–’
, 
Çme
, 
de
->name)) {

191 
	`b»l£
(
bh
);

192  -
EEXIST
;

195 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

196 
i
 = 0; i < 
šfo
->
s_Çm–’
 ; i++)

197 
de
->
Çme
[
i
] = (˜< 
Çm–’
) ?‚ame[i] : 0;

198 
bh
->
b_dœt
 = 1;

199 *
»s_dœ
 = 
de
;

202 ià(
off£t
 < 
bh
->
b_size
)

204 
	`b»l£
(
bh
);

205 
bh
 = 
NULL
;

206 
off£t
 = 0;

207 
block
++;

209 *
»s_buf
 = 
bh
;

211 
	}
}

213 
	$mšix_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

214 
šode
 ** 
»suÉ
)

216 
”rÜ
;

217 
šode
 * inode;

218 
bufãr_h—d
 * 
bh
;

219 
mšix_dœ_’Œy
 * 
de
;

221 *
»suÉ
 = 
NULL
;

222 ià(!
dœ
)

223  -
ENOENT
;

224 
šode
 = 
	`mšix_Ãw_šode
(
dœ
);

225 ià(!
šode
) {

226 
	`ut
(
dœ
);

227  -
ENOSPC
;

229 
šode
->
i_İ
 = &
mšix_fe_šode_İ”©iÚs
;

230 
šode
->
i_mode
 = 
mode
;

231 
šode
->
i_dœt
 = 1;

232 
”rÜ
 = 
	`mšix_add_’Œy
(
dœ
,
Çme
,
Ën
, &
bh
 ,&
de
);

233 ià(
”rÜ
) {

234 
šode
->
i_Æšk
--;

235 
šode
->
i_dœt
 = 1;

236 
	`ut
(
šode
);

237 
	`ut
(
dœ
);

238  
”rÜ
;

240 
de
->
šode
 = inode->
i_šo
;

241 
bh
->
b_dœt
 = 1;

242 
	`b»l£
(
bh
);

243 
	`ut
(
dœ
);

244 *
»suÉ
 = 
šode
;

246 
	}
}

248 
	$mšix_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
)

250 
”rÜ
;

251 
šode
 * inode;

252 
bufãr_h—d
 * 
bh
;

253 
mšix_dœ_’Œy
 * 
de
;

255 ià(!
dœ
)

256  -
ENOENT
;

257 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

258 ià(
bh
) {

259 
	`b»l£
(
bh
);

260 
	`ut
(
dœ
);

261  -
EEXIST
;

263 
šode
 = 
	`mšix_Ãw_šode
(
dœ
);

264 ià(!
šode
) {

265 
	`ut
(
dœ
);

266  -
ENOSPC
;

268 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

269 
šode
->
i_mode
 = 
mode
;

270 
šode
->
i_İ
 = 
NULL
;

271 ià(
	`S_ISREG
(
šode
->
i_mode
))

272 
šode
->
i_İ
 = &
mšix_fe_šode_İ”©iÚs
;

273 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

274 
šode
->
i_İ
 = &
mšix_dœ_šode_İ”©iÚs
;

275 ià(
dœ
->
i_mode
 & 
S_ISGID
)

276 
šode
->
i_mode
 |ğ
S_ISGID
;

278 ià(
	`S_ISLNK
(
šode
->
i_mode
))

279 
šode
->
i_İ
 = &
mšix_symlšk_šode_İ”©iÚs
;

280 ià(
	`S_ISCHR
(
šode
->
i_mode
))

281 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

282 ià(
	`S_ISBLK
(
šode
->
i_mode
))

283 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

284 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

285 
	`š™_fifo
(
šode
);

286 ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode))

287 
šode
->
i_rdev
 = 
rdev
;

288 
šode
->
i_dœt
 = 1;

289 
”rÜ
 = 
	`mšix_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

290 ià(
”rÜ
) {

291 
šode
->
i_Æšk
--;

292 
šode
->
i_dœt
 = 1;

293 
	`ut
(
šode
);

294 
	`ut
(
dœ
);

295  
”rÜ
;

297 
de
->
šode
 = inode->
i_šo
;

298 
bh
->
b_dœt
 = 1;

299 
	`b»l£
(
bh
);

300 
	`ut
(
dœ
);

301 
	`ut
(
šode
);

303 
	}
}

305 
	$mšix_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
)

307 
”rÜ
;

308 
šode
 * inode;

309 
bufãr_h—d
 * 
bh
, *
dœ_block
;

310 
mšix_dœ_’Œy
 * 
de
;

311 
mšix_sb_šfo
 * 
šfo
;

313 ià(!
dœ
 || !dœ->
i_sb
) {

314 
	`ut
(
dœ
);

315  -
EINVAL
;

317 
šfo
 = &
dœ
->
i_sb
->
u
.
mšix_sb
;

318 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

319 ià(
bh
) {

320 
	`b»l£
(
bh
);

321 
	`ut
(
dœ
);

322  -
EEXIST
;

324 ià(
dœ
->
i_Æšk
 >ğ
MINIX_LINK_MAX
) {

325 
	`ut
(
dœ
);

326  -
EMLINK
;

328 
šode
 = 
	`mšix_Ãw_šode
(
dœ
);

329 ià(!
šode
) {

330 
	`ut
(
dœ
);

331  -
ENOSPC
;

333 
šode
->
i_İ
 = &
mšix_dœ_šode_İ”©iÚs
;

334 
šode
->
i_size
 = 2 * 
šfo
->
s_dœsize
;

335 
dœ_block
 = 
	`mšix_b»ad
(
šode
,0,1);

336 ià(!
dœ_block
) {

337 
	`ut
(
dœ
);

338 
šode
->
i_Æšk
--;

339 
šode
->
i_dœt
 = 1;

340 
	`ut
(
šode
);

341  -
ENOSPC
;

343 
de
 = (
mšix_dœ_’Œy
 *è
dœ_block
->
b_d©a
;

344 
de
->
šode
=šode->
i_šo
;

345 
	`¡rıy
(
de
->
Çme
,".");

346 
de
 = (
mšix_dœ_’Œy
 *è(
dœ_block
->
b_d©a
 + 
šfo
->
s_dœsize
);

347 
de
->
šode
 = 
dœ
->
i_šo
;

348 
	`¡rıy
(
de
->
Çme
,"..");

349 
šode
->
i_Æšk
 = 2;

350 
dœ_block
->
b_dœt
 = 1;

351 
	`b»l£
(
dœ_block
);

352 
šode
->
i_mode
 = 
S_IFDIR
 | (
mode
 & 0777 & ~
cu¼’t
->
umask
);

353 ià(
dœ
->
i_mode
 & 
S_ISGID
)

354 
šode
->
i_mode
 |ğ
S_ISGID
;

355 
šode
->
i_dœt
 = 1;

356 
”rÜ
 = 
	`mšix_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

357 ià(
”rÜ
) {

358 
	`ut
(
dœ
);

359 
šode
->
i_Æšk
=0;

360 
	`ut
(
šode
);

361  
”rÜ
;

363 
de
->
šode
 = inode->
i_šo
;

364 
bh
->
b_dœt
 = 1;

365 
dœ
->
i_Æšk
++;

366 
dœ
->
i_dœt
 = 1;

367 
	`ut
(
dœ
);

368 
	`ut
(
šode
);

369 
	`b»l£
(
bh
);

371 
	}
}

376 
	$em±y_dœ
(
šode
 * inode)

378 
block
, 
off£t
;

379 
bufãr_h—d
 * 
bh
;

380 
mšix_dœ_’Œy
 * 
de
;

381 
mšix_sb_šfo
 * 
šfo
;

383 ià(!
šode
 || !šode->
i_sb
)

385 
šfo
 = &
šode
->
i_sb
->
u
.
mšix_sb
;

386 
block
 = 0;

387 
bh
 = 
NULL
;

388 
off£t
 = 2*
šfo
->
s_dœsize
;

389 ià(
šode
->
i_size
 & (
šfo
->
s_dœsize
-1))

390 
bad_dœ
;

391 ià(
šode
->
i_size
 < 
off£t
)

392 
bad_dœ
;

393 
bh
 = 
	`mšix_b»ad
(
šode
,0,0);

394 ià(!
bh
)

395 
bad_dœ
;

396 
de
 = (
mšix_dœ_’Œy
 *è
bh
->
b_d©a
;

397 ià(!
de
->
šode
 || 
	`¡rcmp
(de->
Çme
,"."))

398 
bad_dœ
;

399 
de
 = (
mšix_dœ_’Œy
 *è(
bh
->
b_d©a
 + 
šfo
->
s_dœsize
);

400 ià(!
de
->
šode
 || 
	`¡rcmp
(de->
Çme
,".."))

401 
bad_dœ
;

402 
block
*
BLOCK_SIZE
+
off£t
 < 
šode
->
i_size
) {

403 ià(!
bh
) {

404 
bh
 = 
	`mšix_b»ad
(
šode
,
block
,0);

405 ià(!
bh
) {

406 
block
++;

410 
de
 = (
mšix_dœ_’Œy
 *è(
bh
->
b_d©a
 + 
off£t
);

411 
off£t
 +ğ
šfo
->
s_dœsize
;

412 ià(
de
->
šode
) {

413 
	`b»l£
(
bh
);

416 ià(
off£t
 < 
bh
->
b_size
)

418 
	`b»l£
(
bh
);

419 
bh
 = 
NULL
;

420 
off£t
 = 0;

421 
block
++;

423 
	`b»l£
(
bh
);

425 
bad_dœ
:

426 
	`b»l£
(
bh
);

427 
	`´štk
("Bad dœeùÜy oÀdeviû %04x\n",
šode
->
i_dev
);

429 
	}
}

431 
	$mšix_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

433 
»tv®
;

434 
šode
 * inode;

435 
bufãr_h—d
 * 
bh
;

436 
mšix_dœ_’Œy
 * 
de
;

438 
šode
 = 
NULL
;

439 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

440 
»tv®
 = -
ENOENT
;

441 ià(!
bh
)

442 
’d_rmdœ
;

443 
»tv®
 = -
EPERM
;

444 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

445 
’d_rmdœ
;

446 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& 
cu¼’t
->
euid
 &&

447 
šode
->
i_uid
 !ğ
cu¼’t
->
euid
)

448 
’d_rmdœ
;

449 ià(
šode
->
i_dev
 !ğ
dœ
->i_dev)

450 
’d_rmdœ
;

451 ià(
šode
 =ğ
dœ
)

452 
’d_rmdœ
;

453 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

454 
»tv®
 = -
ENOTDIR
;

455 
’d_rmdœ
;

457 ià(!
	`em±y_dœ
(
šode
)) {

458 
»tv®
 = -
ENOTEMPTY
;

459 
’d_rmdœ
;

461 ià(
de
->
šode
 !ğšode->
i_šo
) {

462 
»tv®
 = -
ENOENT
;

463 
’d_rmdœ
;

465 ià(
šode
->
i_couÁ
 > 1) {

466 
»tv®
 = -
EBUSY
;

467 
’d_rmdœ
;

469 ià(
šode
->
i_Æšk
 != 2)

470 
	`´štk
("em±y dœeùÜy ha Æšk!=2 (%d)\n",
šode
->
i_Æšk
);

471 
de
->
šode
 = 0;

472 
bh
->
b_dœt
 = 1;

473 
šode
->
i_Æšk
=0;

474 
šode
->
i_dœt
=1;

475 
dœ
->
i_Æšk
--;

476 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

477 
dœ
->
i_dœt
=1;

478 
»tv®
 = 0;

479 
’d_rmdœ
:

480 
	`ut
(
dœ
);

481 
	`ut
(
šode
);

482 
	`b»l£
(
bh
);

483  
»tv®
;

484 
	}
}

486 
	$mšix_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

488 
»tv®
;

489 
šode
 * inode;

490 
bufãr_h—d
 * 
bh
;

491 
mšix_dœ_’Œy
 * 
de
;

493 
»³©
:

494 
»tv®
 = -
ENOENT
;

495 
šode
 = 
NULL
;

496 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

497 ià(!
bh
)

498 
’d_uÆšk
;

499 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

500 
’d_uÆšk
;

501 
»tv®
 = -
EPERM
;

502 ià(
	`S_ISDIR
(
šode
->
i_mode
))

503 
’d_uÆšk
;

504 ià(
de
->
šode
 !ğšode->
i_šo
) {

505 
	`ut
(
šode
);

506 
	`b»l£
(
bh
);

507 
cu¼’t
->
couÁ”
 = 0;

508 
	`scheduË
();

509 
»³©
;

511 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& !
	`su£r
() &&

512 
cu¼’t
->
euid
 !ğ
šode
->
i_uid
 &&

513 
cu¼’t
->
euid
 !ğ
dœ
->
i_uid
)

514 
’d_uÆšk
;

515 ià(
de
->
šode
 !ğšode->
i_šo
) {

516 
»tv®
 = -
ENOENT
;

517 
’d_uÆšk
;

519 ià(!
šode
->
i_Æšk
) {

520 
	`´štk
("Deleting‚onexistent file (%04x:%lu), %d\n",

521 
šode
->
i_dev
,šode->
i_šo
,šode->
i_Æšk
);

522 
šode
->
i_Æšk
=1;

524 
de
->
šode
 = 0;

525 
bh
->
b_dœt
 = 1;

526 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

527 
dœ
->
i_dœt
 = 1;

528 
šode
->
i_Æšk
--;

529 
šode
->
i_ùime
 = 
dœ
->i_ctime;

530 
šode
->
i_dœt
 = 1;

531 
»tv®
 = 0;

532 
’d_uÆšk
:

533 
	`b»l£
(
bh
);

534 
	`ut
(
šode
);

535 
	`ut
(
dœ
);

536  
»tv®
;

537 
	}
}

539 
	$mšix_symlšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, cÚ¡ * 
symÇme
)

541 
mšix_dœ_’Œy
 * 
de
;

542 
šode
 * inodğ
NULL
;

543 
bufãr_h—d
 * 
bh
 = 
NULL
, * 
Çme_block
 = NULL;

544 
i
;

545 
c
;

547 ià(!(
šode
 = 
	`mšix_Ãw_šode
(
dœ
))) {

548 
	`ut
(
dœ
);

549  -
ENOSPC
;

551 
šode
->
i_mode
 = 
S_IFLNK
 | 0777;

552 
šode
->
i_İ
 = &
mšix_symlšk_šode_İ”©iÚs
;

553 
Çme_block
 = 
	`mšix_b»ad
(
šode
,0,1);

554 ià(!
Çme_block
) {

555 
	`ut
(
dœ
);

556 
šode
->
i_Æšk
--;

557 
šode
->
i_dœt
 = 1;

558 
	`ut
(
šode
);

559  -
ENOSPC
;

561 
i
 = 0;

562 
i
 < 1023 && (
c
=*(
symÇme
++)))

563 
Çme_block
->
b_d©a
[
i
++] = 
c
;

564 
Çme_block
->
b_d©a
[
i
] = 0;

565 
Çme_block
->
b_dœt
 = 1;

566 
	`b»l£
(
Çme_block
);

567 
šode
->
i_size
 = 
i
;

568 
šode
->
i_dœt
 = 1;

569 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

570 ià(
bh
) {

571 
šode
->
i_Æšk
--;

572 
šode
->
i_dœt
 = 1;

573 
	`ut
(
šode
);

574 
	`b»l£
(
bh
);

575 
	`ut
(
dœ
);

576  -
EEXIST
;

578 
i
 = 
	`mšix_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

579 ià(
i
) {

580 
šode
->
i_Æšk
--;

581 
šode
->
i_dœt
 = 1;

582 
	`ut
(
šode
);

583 
	`ut
(
dœ
);

584  
i
;

586 
de
->
šode
 = inode->
i_šo
;

587 
bh
->
b_dœt
 = 1;

588 
	`b»l£
(
bh
);

589 
	`ut
(
dœ
);

590 
	`ut
(
šode
);

592 
	}
}

594 
	$mšix_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

596 
”rÜ
;

597 
mšix_dœ_’Œy
 * 
de
;

598 
bufãr_h—d
 * 
bh
;

600 ià(
	`S_ISDIR
(
Şdšode
->
i_mode
)) {

601 
	`ut
(
Şdšode
);

602 
	`ut
(
dœ
);

603  -
EPERM
;

605 ià(
Şdšode
->
i_Æšk
 >ğ
MINIX_LINK_MAX
) {

606 
	`ut
(
Şdšode
);

607 
	`ut
(
dœ
);

608  -
EMLINK
;

610 
bh
 = 
	`mšix_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

611 ià(
bh
) {

612 
	`b»l£
(
bh
);

613 
	`ut
(
dœ
);

614 
	`ut
(
Şdšode
);

615  -
EEXIST
;

617 
”rÜ
 = 
	`mšix_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

618 ià(
”rÜ
) {

619 
	`ut
(
dœ
);

620 
	`ut
(
Şdšode
);

621  
”rÜ
;

623 
de
->
šode
 = 
Şdšode
->
i_šo
;

624 
bh
->
b_dœt
 = 1;

625 
	`b»l£
(
bh
);

626 
	`ut
(
dœ
);

627 
Şdšode
->
i_Æšk
++;

628 
Şdšode
->
i_ùime
 = 
CURRENT_TIME
;

629 
Şdšode
->
i_dœt
 = 1;

630 
	`ut
(
Şdšode
);

632 
	}
}

634 
	$subdœ
(
šode
 * 
Ãw_šode
, šod* 
Şd_šode
)

636 
šo
;

637 
»suÉ
;

639 
Ãw_šode
->
i_couÁ
++;

640 
»suÉ
 = 0;

642 ià(
Ãw_šode
 =ğ
Şd_šode
) {

643 
»suÉ
 = 1;

646 ià(
Ãw_šode
->
i_dev
 !ğ
Şd_šode
->i_dev)

648 
šo
 = 
Ãw_šode
->
i_šo
;

649 ià(
	`mšix_lookup
(
Ãw_šode
,"..",2,&new_inode))

651 ià(
Ãw_šode
->
i_šo
 =ğ
šo
)

654 
	`ut
(
Ãw_šode
);

655  
»suÉ
;

656 
	}
}

658 
	#PARENT_INO
(
bufãr
) \

659 (((
mšix_dœ_’Œy
 *è((
bufãr
)+
šfo
->
s_dœsize
))->
šode
)

	)

671 
	$do_mšix_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

672 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

674 
šode
 * 
Şd_šode
, * 
Ãw_šode
;

675 
bufãr_h—d
 * 
Şd_bh
, * 
Ãw_bh
, * 
dœ_bh
;

676 
mšix_dœ_’Œy
 * 
Şd_de
, * 
Ãw_de
;

677 
mšix_sb_šfo
 * 
šfo
;

678 
»tv®
;

680 
šfo
 = &
Şd_dœ
->
i_sb
->
u
.
mšix_sb
;

681 
¡¬t_up
;

682 
Œy_agaš
:

683 
	`b»l£
(
Şd_bh
);

684 
	`b»l£
(
Ãw_bh
);

685 
	`b»l£
(
dœ_bh
);

686 
	`ut
(
Şd_šode
);

687 
	`ut
(
Ãw_šode
);

688 
cu¼’t
->
couÁ”
 = 0;

689 
	`scheduË
();

690 
¡¬t_up
:

691 
Şd_šode
 = 
Ãw_šode
 = 
NULL
;

692 
Şd_bh
 = 
Ãw_bh
 = 
dœ_bh
 = 
NULL
;

693 
Şd_bh
 = 
	`mšix_fšd_’Œy
(
Şd_dœ
,
Şd_Çme
,
Şd_Ën
,&
Şd_de
);

694 
»tv®
 = -
ENOENT
;

695 ià(!
Şd_bh
)

696 
’d_»Çme
;

697 
Şd_šode
 = 
	`__ig‘
(
Şd_dœ
->
i_sb
, 
Şd_de
->
šode
,0);

698 ià(!
Şd_šode
)

699 
’d_»Çme
;

700 
»tv®
 = -
EPERM
;

701 ià((
Şd_dœ
->
i_mode
 & 
S_ISVTX
) &&

702 
cu¼’t
->
euid
 !ğ
Şd_šode
->
i_uid
 &&

703 
cu¼’t
->
euid
 !ğ
Şd_dœ
->
i_uid
 && !
	`su£r
())

704 
’d_»Çme
;

705 
Ãw_bh
 = 
	`mšix_fšd_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_de
);

706 ià(
Ãw_bh
) {

707 
Ãw_šode
 = 
	`__ig‘
(
Ãw_dœ
->
i_sb
, 
Ãw_de
->
šode
, 0);

708 ià(!
Ãw_šode
) {

709 
	`b»l£
(
Ãw_bh
);

710 
Ãw_bh
 = 
NULL
;

713 ià(
Ãw_šode
 =ğ
Şd_šode
) {

714 
»tv®
 = 0;

715 
’d_»Çme
;

717 ià(
Ãw_šode
 && 
	`S_ISDIR
Òew_šode->
i_mode
)) {

718 
»tv®
 = -
EISDIR
;

719 ià(!
	`S_ISDIR
(
Şd_šode
->
i_mode
))

720 
’d_»Çme
;

721 
»tv®
 = -
EINVAL
;

722 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

723 
’d_»Çme
;

724 
»tv®
 = -
ENOTEMPTY
;

725 ià(!
	`em±y_dœ
(
Ãw_šode
))

726 
’d_»Çme
;

727 
»tv®
 = -
EBUSY
;

728 ià(
Ãw_šode
->
i_couÁ
 > 1)

729 
’d_»Çme
;

731 
»tv®
 = -
EPERM
;

732 ià(
Ãw_šode
 && (
Ãw_dœ
->
i_mode
 & 
S_ISVTX
) &&

733 
cu¼’t
->
euid
 !ğ
Ãw_šode
->
i_uid
 &&

734 
cu¼’t
->
euid
 !ğ
Ãw_dœ
->
i_uid
 && !
	`su£r
())

735 
’d_»Çme
;

736 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

737 
»tv®
 = -
ENOTDIR
;

738 ià(
Ãw_šode
 && !
	`S_ISDIR
Òew_šode->
i_mode
))

739 
’d_»Çme
;

740 
»tv®
 = -
EINVAL
;

741 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

742 
’d_»Çme
;

743 
»tv®
 = -
EIO
;

744 
dœ_bh
 = 
	`mšix_b»ad
(
Şd_šode
,0,0);

745 ià(!
dœ_bh
)

746 
’d_»Çme
;

747 ià(
	`PARENT_INO
(
dœ_bh
->
b_d©a
è!ğ
Şd_dœ
->
i_šo
)

748 
’d_»Çme
;

749 
»tv®
 = -
EMLINK
;

750 ià(!
Ãw_šode
 && 
Ãw_dœ
->
i_Æšk
 >ğ
MINIX_LINK_MAX
)

751 
’d_»Çme
;

753 ià(!
Ãw_bh
) {

754 
»tv®
 = 
	`mšix_add_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_bh
,&
Ãw_de
);

755 ià(
»tv®
)

756 
’d_»Çme
;

759 ià(
Ãw_šode
 && (
Ãw_de
->
šode
 !ğÃw_šode->
i_šo
))

760 
Œy_agaš
;

761 ià(
Ãw_de
->
šode
 && !
Ãw_šode
)

762 
Œy_agaš
;

763 ià(
Şd_de
->
šode
 !ğ
Şd_šode
->
i_šo
)

764 
Œy_agaš
;

766 
Şd_de
->
šode
 = 0;

767 
Ãw_de
->
šode
 = 
Şd_šode
->
i_šo
;

768 
Şd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
CURRENT_TIME
;

769 
Şd_dœ
->
i_dœt
 = 1;

770 
Ãw_dœ
->
i_ùime
 =‚ew_dœ->
i_mtime
 = 
CURRENT_TIME
;

771 
Ãw_dœ
->
i_dœt
 = 1;

772 ià(
Ãw_šode
) {

773 
Ãw_šode
->
i_Æšk
--;

774 
Ãw_šode
->
i_ùime
 = 
CURRENT_TIME
;

775 
Ãw_šode
->
i_dœt
 = 1;

777 
Şd_bh
->
b_dœt
 = 1;

778 
Ãw_bh
->
b_dœt
 = 1;

779 ià(
dœ_bh
) {

780 
	`PARENT_INO
(
dœ_bh
->
b_d©a
èğ
Ãw_dœ
->
i_šo
;

781 
dœ_bh
->
b_dœt
 = 1;

782 
Şd_dœ
->
i_Æšk
--;

783 
Şd_dœ
->
i_dœt
 = 1;

784 ià(
Ãw_šode
) {

785 
Ãw_šode
->
i_Æšk
--;

786 
Ãw_šode
->
i_dœt
 = 1;

788 
Ãw_dœ
->
i_Æšk
++;

789 
Ãw_dœ
->
i_dœt
 = 1;

792 
»tv®
 = 0;

793 
’d_»Çme
:

794 
	`b»l£
(
dœ_bh
);

795 
	`b»l£
(
Şd_bh
);

796 
	`b»l£
(
Ãw_bh
);

797 
	`ut
(
Şd_šode
);

798 
	`ut
(
Ãw_šode
);

799 
	`ut
(
Şd_dœ
);

800 
	`ut
(
Ãw_dœ
);

801  
»tv®
;

802 
	}
}

813 
	$mšix_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

814 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

816 
wa™_queue
 * 
wa™
 = 
NULL
;

817 
lock
 = 0;

818 
»suÉ
;

820 
lock
)

821 
	`¦“p_Ú
(&
wa™
);

822 
lock
 = 1;

823 
»suÉ
 = 
	`do_mšix_»Çme
(
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
,

824 
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
);

825 
lock
 = 0;

826 
	`wake_up
(&
wa™
);

827  
»suÉ
;

828 
	}
}

	@fs/minix/symlink.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/mšix_fs.h
>

15 
	~<lšux/¡©.h
>

17 
mšix_»adlšk
(
šode
 *, *, );

18 
mšix_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

23 
šode_İ”©iÚs
 
	gmšix_symlšk_šode_İ”©iÚs
 = {

24 
NULL
,

25 
NULL
,

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
mšix_»adlšk
,

35 
mšix_fŞlow_lšk
,

36 
NULL
,

37 
NULL
,

38 
NULL


41 
	$mšix_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

42 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

44 
”rÜ
;

45 
bufãr_h—d
 * 
bh
;

47 *
»s_šode
 = 
NULL
;

48 ià(!
dœ
) {

49 
dœ
 = 
cu¼’t
->
roÙ
;

50 
dœ
->
i_couÁ
++;

52 ià(!
šode
) {

53 
	`ut
(
dœ
);

54  -
ENOENT
;

56 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

57 
	`ut
(
dœ
);

58 *
»s_šode
 = 
šode
;

61 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

62 
	`ut
(
šode
);

63 
	`ut
(
dœ
);

64  -
ELOOP
;

66 ià(!(
bh
 = 
	`mšix_b»ad
(
šode
, 0, 0))) {

67 
	`ut
(
šode
);

68 
	`ut
(
dœ
);

69  -
EIO
;

71 
	`ut
(
šode
);

72 
cu¼’t
->
lšk_couÁ
++;

73 
”rÜ
 = 
	`İ’_Çmei
(
bh
->
b_d©a
,
æag
,
mode
,
»s_šode
,
dœ
);

74 
cu¼’t
->
lšk_couÁ
--;

75 
	`b»l£
(
bh
);

76  
”rÜ
;

77 
	}
}

79 
	$mšix_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

81 
bufãr_h—d
 * 
bh
;

82 
i
;

83 
c
;

85 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

86 
	`ut
(
šode
);

87  -
EINVAL
;

89 ià(
buæ’
 > 1023)

90 
buæ’
 = 1023;

91 
bh
 = 
	`mšix_b»ad
(
šode
, 0, 0);

92 
	`ut
(
šode
);

93 ià(!
bh
)

95 
i
 = 0;

96 
i
<
buæ’
 && (
c
 = 
bh
->
b_d©a
[i])) {

97 
i
++;

98 
	`put_fs_by‹
(
c
,
bufãr
++);

100 
	`b»l£
(
bh
);

101  
i
;

102 
	}
}

	@fs/minix/truncate.c

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/mšix_fs.h
>

10 
	~<lšux/¡©.h
>

11 
	~<lšux/fú.h
>

26 
	$Œunc_dœeù
(
šode
 * inode)

28 * 
p
;

29 
bufãr_h—d
 * 
bh
;

30 
i
, 
tmp
;

31 
»Œy
 = 0;

32 
	#DIRECT_BLOCK
 ((
šode
->
i_size
 + 1023è>> 10)

	)

34 
»³©
:

35 
i
 = 
DIRECT_BLOCK
 ; i < 7 ; i++) {

36 
p
 = 
i
 + 
šode
->
u
.
mšix_i
.
i_d©a
;

37 ià(!(
tmp
 = *
p
))

39 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
,
tmp
,
BLOCK_SIZE
);

40 ià(
i
 < 
DIRECT_BLOCK
) {

41 
	`b»l£
(
bh
);

42 
»³©
;

44 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
p
) {

45 
»Œy
 = 1;

46 
	`b»l£
(
bh
);

49 *
p
 = 0;

50 
šode
->
i_dœt
 = 1;

51 
	`b»l£
(
bh
);

52 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

54  
»Œy
;

55 
	}
}

57 
	$Œunc_šdœeù
(
šode
 * inode, 
off£t
, * 
p
)

59 
bufãr_h—d
 * 
bh
;

60 
i
, 
tmp
;

61 
bufãr_h—d
 * 
šd_bh
;

62 * 
šd
;

63 
»Œy
 = 0;

64 
	#INDIRECT_BLOCK
 (
DIRECT_BLOCK
-
off£t
)

	)

66 
tmp
 = *
p
;

67 ià(!
tmp
)

69 
šd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

70 ià(
tmp
 !ğ*
p
) {

71 
	`b»l£
(
šd_bh
);

74 ià(!
šd_bh
) {

75 *
p
 = 0;

78 
»³©
:

79 
i
 = 
INDIRECT_BLOCK
 ; i < 512 ; i++) {

80 ià(
i
 < 0)

81 
i
 = 0;

82 ià(
i
 < 
INDIRECT_BLOCK
)

83 
»³©
;

84 
šd
 = 
i
+(*è
šd_bh
->
b_d©a
;

85 
tmp
 = *
šd
;

86 ià(!
tmp
)

88 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
,
tmp
,
BLOCK_SIZE
);

89 ià(
i
 < 
INDIRECT_BLOCK
) {

90 
	`b»l£
(
bh
);

91 
»³©
;

93 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
šd
) {

94 
»Œy
 = 1;

95 
	`b»l£
(
bh
);

98 *
šd
 = 0;

99 
šd_bh
->
b_dœt
 = 1;

100 
	`b»l£
(
bh
);

101 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

103 
šd
 = (*è
šd_bh
->
b_d©a
;

104 
i
 = 0; i < 512; i++)

105 ià(*(
šd
++))

107 ià(
i
 >= 512)

108 ià(
šd_bh
->
b_couÁ
 != 1)

109 
»Œy
 = 1;

111 
tmp
 = *
p
;

112 *
p
 = 0;

113 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

115 
	`b»l£
(
šd_bh
);

116  
»Œy
;

117 
	}
}

119 
	$Œunc_dšdœeù
(
šode
 * inode)

121 
i
, 
tmp
;

122 
bufãr_h—d
 * 
dšd_bh
;

123 * 
dšd
, * 
p
;

124 
»Œy
 = 0;

125 
	#DINDIRECT_BLOCK
 ((
DIRECT_BLOCK
-(512+7))>>9)

	)

127 
p
 = 8 + 
šode
->
u
.
mšix_i
.
i_d©a
;

128 ià(!(
tmp
 = *
p
))

130 
dšd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
BLOCK_SIZE
);

131 ià(
tmp
 !ğ*
p
) {

132 
	`b»l£
(
dšd_bh
);

135 ià(!
dšd_bh
) {

136 *
p
 = 0;

139 
»³©
:

140 
i
 = 
DINDIRECT_BLOCK
 ; i < 512 ; i ++) {

141 ià(
i
 < 0)

142 
i
 = 0;

143 ià(
i
 < 
DINDIRECT_BLOCK
)

144 
»³©
;

145 
dšd
 = 
i
+(*è
dšd_bh
->
b_d©a
;

146 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,7+512+(
i
<<9),
dšd
);

147 
dšd_bh
->
b_dœt
 = 1;

149 
dšd
 = (*è
dšd_bh
->
b_d©a
;

150 
i
 = 0; i < 512; i++)

151 ià(*(
dšd
++))

153 ià(
i
 >= 512)

154 ià(
dšd_bh
->
b_couÁ
 != 1)

155 
»Œy
 = 1;

157 
tmp
 = *
p
;

158 *
p
 = 0;

159 
šode
->
i_dœt
 = 1;

160 
	`mšix_ä“_block
(
šode
->
i_sb
,
tmp
);

162 
	`b»l£
(
dšd_bh
);

163  
»Œy
;

164 
	}
}

166 
	$mšix_Œunÿ‹
(
šode
 * inode)

168 
»Œy
;

170 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

171 
	`S_ISLNK
(
šode
->
i_mode
)))

174 
»Œy
 = 
	`Œunc_dœeù
(
šode
);

175 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,7,šode->
u
.
mšix_i
.
i_d©a
+7);

176 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
);

177 ià(!
»Œy
)

179 
cu¼’t
->
couÁ”
 = 0;

180 
	`scheduË
();

182 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

183 
šode
->
i_dœt
 = 1;

184 
	}
}

	@fs/msdos/dir.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/fs.h
>

12 
	~<lšux/msdos_fs.h
>

13 
	~<lšux/”ºo.h
>

14 
	~<lšux/¡©.h
>

17 
	$msdos_dœ_»ad
(
šode
 * inode,
fe
 * 
fp
, * 
buf
,
couÁ
)

19  -
EISDIR
;

20 
	}
}

22 
msdos_»addœ
(
šode
 *šode,
fe
 *
fp
,

23 
dœ’t
 *dœ’t,
couÁ
);

26 
fe_İ”©iÚs
 
	gmsdos_dœ_İ”©iÚs
 = {

27 
NULL
,

28 
msdos_dœ_»ad
,

29 
NULL
,

30 
msdos_»addœ
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
fe_fsync


39 
šode_İ”©iÚs
 
	gmsdos_dœ_šode_İ”©iÚs
 = {

40 &
msdos_dœ_İ”©iÚs
,

41 
msdos_ü—‹
,

42 
msdos_lookup
,

43 
NULL
,

44 
msdos_uÆšk
,

45 
NULL
,

46 
msdos_mkdœ
,

47 
msdos_rmdœ
,

48 
NULL
,

49 
msdos_»Çme
,

50 
NULL
,

51 
NULL
,

52 
msdos_bm­
,

53 
NULL
,

54 
NULL


57 
	$msdos_»addœ
(
šode
 *šode,
fe
 *
fp
,

58 
dœ’t
 *dœ’t,
couÁ
)

60 
šo
,
i
,
i2
,
Ï¡
;

61 
c
,*
w®k
;

62 
bufãr_h—d
 *
bh
;

63 
msdos_dœ_’Œy
 *
de
;

65 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
)è -
EBADF
;

66 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
) {

68 ià(
fp
->
f_pos
 == 2) filp->f_pos = 0;

69 ià(
fp
->
f_pos
 < 2) {

70 
w®k
 = 
fp
->
f_pos
++ ? ".." : ".";

71 
i
 = 0; *
w®k
; walk++)

72 
	`put_fs_by‹
(*
w®k
,
dœ’t
->
d_Çme
+
i
++);

73 
	`put_fs_lÚg
(
MSDOS_ROOT_INO
,&
dœ’t
->
d_šo
);

74 
	`put_fs_by‹
(0,
dœ’t
->
d_Çme
+
i
);

75 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

76  
i
;

79 ià(
fp
->
f_pos
 & ((
msdos_dœ_’Œy
)-1)è -
ENOENT
;

80 
bh
 = 
NULL
;

81 (
šo
 = 
	`msdos_g‘_’Œy
(
šode
,&
fp
->
f_pos
,&
bh
,&
de
)) > -1) {

82 ià(!
	`IS_FREE
(
de
->
Çme
è&& !(de->
©Œ
 & 
ATTR_VOLUME
)) {

83 
i
 = 
Ï¡
 = 0; i < 8; i++) {

84 ià(!(
c
 = 
de
->
Çme
[
i
])) ;

85 ià(
c
 >= 'A' && c <= 'Z') c += 32;

86 ià(
c
 !ğ' 'è
Ï¡
 = 
i
+1;

87 
	`put_fs_by‹
(
c
,
i
+
dœ’t
->
d_Çme
);

89 
i
 = 
Ï¡
;

90 
	`put_fs_by‹
('.',
i
+
dœ’t
->
d_Çme
);

91 
i
++;

92 
i2
 = 0; i2 < 3; i2++) {

93 ià(!(
c
 = 
de
->
ext
[
i2
])) ;

94 ià(
c
 >= 'A' && c <= 'Z') c += 32;

95 ià(
c
 !ğ' 'è
Ï¡
 = 
i
+1;

96 
	`put_fs_by‹
(
c
,
i
+
dœ’t
->
d_Çme
);

97 
i
++;

99 ià((
i
 = 
Ï¡
) != 0) {

100 ià(!
	`¡rcmp
(
de
->
Çme
,
MSDOS_DOT
))

101 
šo
 = 
šode
->
i_šo
;

102 ià(!
	`¡rcmp
(
de
->
Çme
,
MSDOS_DOTDOT
))

103 
šo
 = 
	`msdos_·»Á_šo
(
šode
,0);

104 
	`put_fs_lÚg
(
šo
,&
dœ’t
->
d_šo
);

105 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

106 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

107 
	`b»l£
(
bh
);

108  
i
;

112 ià(
bh
è
	`b»l£
(bh);

114 
	}
}

	@fs/msdos/fat.c

7 
	~<lšux/msdos_fs.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/¡©.h
>

13 
çt_ÿche
 *
	gçt_ÿche
,
	gÿche
[
FAT_CACHE
];

18 
	$çt_acûss
(
su³r_block
 *
sb
,
Ä
,
Ãw_v®ue
)

20 
bufãr_h—d
 *
bh
,*
bh2
,*
c_bh
,*
c_bh2
;

21 *
p_fœ¡
,*
p_Ï¡
;

22 *
d©a
,*
d©a2
,*
c_d©a
,*
c_d©a2
;

23 
fœ¡
,
Ï¡
,
Ãxt
,
cİy
;

25 ià((è(
Ä
-2è>ğ
	`MSDOS_SB
(
sb
)->
şu¡”s
)  0;

26 ià(
	`MSDOS_SB
(
sb
)->
çt_b™s
 =ğ16è
fœ¡
 = 
Ï¡
 = 
Ä
*2;

28 
fœ¡
 = 
Ä
*3/2;

29 
Ï¡
 = 
fœ¡
+1;

31 ià(!(
bh
 = 
	`msdos_¤—d
(
sb
->
s_dev
,
	`MSDOS_SB
(sb)->
çt_¡¬t
+(
fœ¡
 >>

32 
SECTOR_BITS
),&
d©a
))) {

33 
	`´štk
("bread in fat_access failed\n");

36 ià((
fœ¡
 >> 
SECTOR_BITS
è=ğ(
Ï¡
 >> SECTOR_BITS)) {

37 
bh2
 = 
bh
;

38 
d©a2
 = 
d©a
;

41 ià(!(
bh2
 = 
	`msdos_¤—d
(
sb
->
s_dev
,
	`MSDOS_SB
(sb)->
çt_¡¬t
+(
Ï¡


42 >> 
SECTOR_BITS
),&
d©a2
))) {

43 
	`b»l£
(
bh
);

44 
	`´štk
("bread in fat_access failed\n");

48 ià(
	`MSDOS_SB
(
sb
)->
çt_b™s
 == 16) {

49 
p_fœ¡
 = 
p_Ï¡
 = 
NULL
;

50 
Ãxt
 = 
	`CF_LE_W
(((*è
d©a
)[(
fœ¡
 &

51 (
SECTOR_SIZE
-1)) >> 1]);

52 ià(
Ãxt
 >= 0xfff7)‚ext = -1;

55 
p_fœ¡
 = &((*è
d©a
)[
fœ¡
 & (
SECTOR_SIZE
-1)];

56 
p_Ï¡
 = &((*è
d©a2
)[(
fœ¡
+1) &

57 (
SECTOR_SIZE
-1)];

58 ià(
Ä
 & 1è
Ãxt
 = ((*
p_fœ¡
 >> 4è| (*
p_Ï¡
 << 4)) & 0xfff;

59 
Ãxt
 = (*
p_fœ¡
+(*
p_Ï¡
 << 8)) & 0xfff;

60 ià(
Ãxt
 >= 0xff7)‚ext = -1;

62 ià(
Ãw_v®ue
 != -1) {

63 ià(
	`MSDOS_SB
(
sb
)->
çt_b™s
 == 16)

64 ((*è
d©a
)[(
fœ¡
 & (
SECTOR_SIZE
-1)) >>

65 1] = 
	`CT_LE_W
(
Ãw_v®ue
);

67 ià(
Ä
 & 1) {

68 *
p_fœ¡
 = (*p_fœ¡ & 0xfè| (
Ãw_v®ue
 << 4);

69 *
p_Ï¡
 = 
Ãw_v®ue
 >> 4;

72 *
p_fœ¡
 = 
Ãw_v®ue
 & 0xff;

73 *
p_Ï¡
 = (*p_Ï¡ & 0xf0è| (
Ãw_v®ue
 >> 8);

75 
bh2
->
b_dœt
 = 1;

77 
bh
->
b_dœt
 = 1;

78 
cİy
 = 1; cİy < 
	`MSDOS_SB
(
sb
)->
çts
; copy++) {

79 ià(!(
c_bh
 = 
	`msdos_¤—d
(
sb
->
s_dev
,
	`MSDOS_SB
(sb)->

80 
çt_¡¬t
+(
fœ¡
 >> 
SECTOR_BITS
)+
	`MSDOS_SB
(
sb
)->

81 
çt_Ëngth
*
cİy
,&
c_d©a
))) ;

82 
	`memıy
(
c_d©a
,
d©a
,
SECTOR_SIZE
);

83 
c_bh
->
b_dœt
 = 1;

84 ià(
d©a
 !ğ
d©a2
 || 
bh
 !ğ
bh2
) {

85 ià(!(
c_bh2
 = 
	`msdos_¤—d
(
sb
->
s_dev
,

86 
	`MSDOS_SB
(
sb
)->
çt_¡¬t
+(
fœ¡
 >>

87 
SECTOR_BITS
)+
	`MSDOS_SB
(
sb
)->
çt_Ëngth
*
cİy


88 +1,&
c_d©a2
))) {

89 
	`b»l£
(
c_bh
);

92 
	`memıy
(
c_d©a2
,
d©a2
,
SECTOR_SIZE
);

93 
	`b»l£
(
c_bh2
);

95 
	`b»l£
(
c_bh
);

98 
	`b»l£
(
bh
);

99 ià(
d©a
 !ğ
d©a2
è
	`b»l£
(
bh2
);

100  
Ãxt
;

101 
	}
}

104 
	$ÿche_š™
()

106 
š™Ÿlized
 = 0;

107 
couÁ
;

109 ià(
š™Ÿlized
) ;

110 
çt_ÿche
 = &
ÿche
[0];

111 
couÁ
 = 0; couÁ < 
FAT_CACHE
; count++) {

112 
ÿche
[
couÁ
].
deviû
 = 0;

113 
ÿche
[
couÁ
].
Ãxt
 = couÁ =ğ
FAT_CACHE
-1 ? 
NULL
 :

114 &
ÿche
[
couÁ
+1];

116 
š™Ÿlized
 = 1;

117 
	}
}

120 
	$ÿche_lookup
(
šode
 *šode,
şu¡”
,*
f_şu
,*
d_şu
)

122 
çt_ÿche
 *
w®k
;

124 #ifdeà
DEBUG


125 
	`´štk
("ÿchlookup: <%d,%d> %d (%d,%dè-> ",
šode
->
i_dev
,šode->
i_šo
,
şu¡”
,

126 *
f_şu
,*
d_şu
);

128 
w®k
 = 
çt_ÿche
; w®k; w®k = w®k->
Ãxt
)

129 ià(
šode
->
i_dev
 =ğ
w®k
->
deviû
 && w®k->
šo
 =ğšode->
i_šo
 &&

130 
w®k
->
fe_şu¡”
 <ğ
şu¡”
 && walk->file_cluster >

131 *
f_şu
) {

132 *
d_şu
 = 
w®k
->
disk_şu¡”
;

133 #ifdeà
DEBUG


134 
	`´štk
("ÿchh™: %d (%d)\n",
w®k
->
fe_şu¡”
,*
d_şu
);

136 ià((*
f_şu
 = 
w®k
->
fe_şu¡”
è=ğ
şu¡”
) ;

138 #ifdeà
DEBUG


139 
	`´štk
("cache miss\n");

141 
	}
}

144 #ifdeà
DEBUG


145 
	$li¡_ÿche
()

147 
çt_ÿche
 *
w®k
;

149 
w®k
 = 
çt_ÿche
; w®k; w®k = w®k->
Ãxt
) {

150 ià(
w®k
->
deviû
)

151 
	`´štk
("<%d,%d>(%d,%dè",
w®k
->
deviû
,w®k->
šo
,

152 
w®k
->
fe_şu¡”
,w®k->
disk_şu¡”
);

153 
	`´štk
("-- ");

155 
	`´štk
("\n");

156 
	}
}

160 
	$ÿche_add
(
šode
 *šode,
f_şu
,
d_şu
)

162 
çt_ÿche
 *
w®k
,*
Ï¡
;

164 #ifdeà
DEBUG


165 
	`´štk
("ÿchadd: <%d,%d> %d (%d)\n",
šode
->
i_dev
,šode->
i_šo
,
f_şu
,
d_şu
);

167 
Ï¡
 = 
NULL
;

168 
w®k
 = 
çt_ÿche
; w®k->
Ãxt
; w®k = (
Ï¡
 = walk)->next)

169 ià(
šode
->
i_dev
 =ğ
w®k
->
deviû
 && w®k->
šo
 =ğšode->
i_šo
 &&

170 
w®k
->
fe_şu¡”
 =ğ
f_şu
) {

171 ià(
w®k
->
disk_şu¡”
 !ğ
d_şu
) {

172 
	`´štk
("FAT cache corruption");

173 
	`ÿche_šv®_šode
(
šode
);

177 ià(
Ï¡
 =ğ
NULL
) ;

178 
Ï¡
->
Ãxt
 = 
w®k
->next;

179 
w®k
->
Ãxt
 = 
çt_ÿche
;

180 
çt_ÿche
 = 
w®k
;

181 #ifdeà
DEBUG


182 
	`li¡_ÿche
();

186 
w®k
->
deviû
 = 
šode
->
i_dev
;

187 
w®k
->
šo
 = 
šode
->
i_šo
;

188 
w®k
->
fe_şu¡”
 = 
f_şu
;

189 
w®k
->
disk_şu¡”
 = 
d_şu
;

190 
Ï¡
->
Ãxt
 = 
NULL
;

191 
w®k
->
Ãxt
 = 
çt_ÿche
;

192 
çt_ÿche
 = 
w®k
;

193 #ifdeà
DEBUG


194 
	`li¡_ÿche
();

196 
	}
}

202 
	$ÿche_šv®_šode
(
šode
 *inode)

204 
çt_ÿche
 *
w®k
;

206 
w®k
 = 
çt_ÿche
; w®k; w®k = w®k->
Ãxt
)

207 ià(
w®k
->
deviû
 =ğ
šode
->
i_dev
 && w®k->
šo
 =ğšode->
i_šo
)

208 
w®k
->
deviû
 = 0;

209 
	}
}

212 
	$ÿche_šv®_dev
(
deviû
)

214 
çt_ÿche
 *
w®k
;

216 
w®k
 = 
çt_ÿche
; w®k; w®k = w®k->
Ãxt
)

217 ià(
w®k
->
deviû
 == device) walk->device = 0;

218 
	}
}

221 
	$g‘_şu¡”
(
šode
 *šode,
şu¡”
)

223 
Ä
,
couÁ
;

225 ià(!(
Ä
 = 
	`MSDOS_I
(
šode
)->
i_¡¬t
))  0;

226 ià(!
şu¡”
è 
Ä
;

227 
couÁ
 = 0;

228 
	`ÿche_lookup
(
šode
,
şu¡”
,&
couÁ
,&
Ä
); count < cluster;

229 
couÁ
++) {

230 ià((
Ä
 = 
	`çt_acûss
(
šode
->
i_sb
,nr,-1)) == -1)  0;

231 ià(!
Ä
)  0;

233 
	`ÿche_add
(
šode
,
şu¡”
,
Ä
);

234  
Ä
;

235 
	}
}

238 
	$msdos_sm­
(
šode
 *šode,
£ùÜ
)

240 
msdos_sb_šfo
 *
sb
;

241 
şu¡”
,
off£t
;

243 
sb
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

244 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
 || (
	`S_ISDIR
(šode->
i_mode
) &&

245 !
	`MSDOS_I
(
šode
)->
i_¡¬t
)) {

246 ià(
£ùÜ
 >ğ
sb
->
dœ_’Œ›s
 >> 
MSDOS_DPS_BITS
)  0;

247  
£ùÜ
+
sb
->
dœ_¡¬t
;

249 
şu¡”
 = 
£ùÜ
/
sb
->
şu¡”_size
;

250 
off£t
 = 
£ùÜ
 % 
sb
->
şu¡”_size
;

251 ià(!(
şu¡”
 = 
	`g‘_şu¡”
(
šode
,cluster)))  0;

252  (
şu¡”
-2)*
sb
->
şu¡”_size
+sb->
d©a_¡¬t
+
off£t
;

253 
	}
}

259 
	$çt_ä“
(
šode
 *šode,
sk
)

261 
Ä
,
Ï¡
;

263 ià(!(
Ä
 = 
	`MSDOS_I
(
šode
)->
i_¡¬t
))  0;

264 
Ï¡
 = 0;

265 
sk
--) {

266 
Ï¡
 = 
Ä
;

267 ià((
Ä
 = 
	`çt_acûss
(
šode
->
i_sb
,nr,-1)) == -1)  0;

268 ià(!
Ä
) {

269 
	`´štk
("fat_free: skipped EOF\n");

270  -
EIO
;

273 ià(
Ï¡
)

274 
	`çt_acûss
(
šode
->
i_sb
,
Ï¡
,
	`MSDOS_SB
(šode->i_sb)->
çt_b™s
 ==

277 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 0;

278 
šode
->
i_dœt
 = 1;

280 
	`lock_çt
(
šode
->
i_sb
);

281 
Ä
 != -1) {

282 ià(!(
Ä
 = 
	`çt_acûss
(
šode
->
i_sb
,nr,0))) {

283 
	`fs_·nic
(
šode
->
i_sb
,"fat_free: deleting beyond EOF");

286 ià(
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
 != -1)

287 
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
++;

288 
šode
->
i_blocks
 -ğ
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
;

290 
	`uÆock_çt
(
šode
->
i_sb
);

291 
	`ÿche_šv®_šode
(
šode
);

293 
	}
}

	@fs/msdos/file.c

9 
	~<asm/£gm’t.h
>

10 
	~<asm/sy¡em.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/msdos_fs.h
>

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/fú.h
>

17 
	~<lšux/¡©.h
>

19 
	#MIN
(
a
,
b
è((×è< (b)è? (aè: (b))

	)

20 
	#MAX
(
a
,
b
è((×è> (b)è? (aè: (b))

	)

22 
msdos_fe_»ad
(
šode
 *šode,
fe
 *
fp
,*
buf
,

23 
couÁ
);

24 
msdos_fe_wr™e
(
šode
 *šode,
fe
 *
fp
,*
buf
,

25 
couÁ
);

28 
fe_İ”©iÚs
 
	gmsdos_fe_İ”©iÚs
 = {

29 
NULL
,

30 
msdos_fe_»ad
,

31 
msdos_fe_wr™e
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
fe_fsync


41 
šode_İ”©iÚs
 
	gmsdos_fe_šode_İ”©iÚs
 = {

42 &
msdos_fe_İ”©iÚs
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
NULL
,

54 
msdos_bm­
,

55 
msdos_Œunÿ‹
,

56 
NULL


61 
šode_İ”©iÚs
 
	gmsdos_fe_šode_İ”©iÚs_no_bm­
 = {

62 &
msdos_fe_İ”©iÚs
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
msdos_Œunÿ‹
,

76 
NULL


80 
	$msdos_fe_»ad
(
šode
 *šode,
fe
 *
fp
,*
buf
,

81 
couÁ
)

83 *
¡¬t
;

84 
Ëá
,
off£t
,
size
,
£ùÜ
,
út
;

85 
ch
;

86 
bufãr_h—d
 *
bh
;

87 *
d©a
;

90 ià(!
šode
) {

91 
	`´štk
("msdos_file_read: inode = NULL\n");

92  -
EINVAL
;

94 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

95 
	`´štk
("msdos_fe_»ad: modğ%07o\n",
šode
->
i_mode
);

96  -
EINVAL
;

98 ià(
fp
->
f_pos
 >ğ
šode
->
i_size
 || 
couÁ
 <= 0)  0;

99 
¡¬t
 = 
buf
;

100 (
Ëá
 = 
	`MIN
(
šode
->
i_size
-
fp
->
f_pos
,
couÁ
-(
buf
-
¡¬t
))) > 0){

101 ià(!(
£ùÜ
 = 
	`msdos_sm­
(
šode
,
fp
->
f_pos
 >> 
SECTOR_BITS
)))

103 
off£t
 = 
fp
->
f_pos
 & (
SECTOR_SIZE
-1);

104 ià(!(
bh
 = 
	`msdos_¤—d
(
šode
->
i_dev
,
£ùÜ
,&
d©a
))) ;

105 
fp
->
f_pos
 +ğ(
size
 = 
	`MIN
(
SECTOR_SIZE
-
off£t
,
Ëá
));

106 ià(
	`MSDOS_I
(
šode
)->
i_bš¬y
) {

107 
	`memıy_tofs
(
buf
,
d©a
+
off£t
,
size
);

108 
buf
 +ğ
size
;

110 
út
 = 
size
; cnt; cnt--) {

111 ià((
ch
 = *((*è
d©a
+
off£t
++)) == '\r')

112 
size
--;

114 ià(
ch
 !ğ26è
	`put_fs_by‹
(ch,
buf
++);

116 
fp
->
f_pos
 = 
šode
->
i_size
;

117 
	`b»l£
(
bh
);

118 ià(
¡¬t
 !ğ
buf


119 && !
	`IS_RDONLY
(
šode
))

120 
šode
->
i_©ime


121 ğ
CURRENT_TIME
;

122  
buf
-
¡¬t
;

126 
	`b»l£
(
bh
);

128 ià(
¡¬t
 =ğ
buf
è -
EIO
;

129 ià(!
	`IS_RDONLY
(
šode
))

130 
šode
->
i_©ime
 = 
CURRENT_TIME
;

131  
buf
-
¡¬t
;

132 
	}
}

135 
	$msdos_fe_wr™e
(
šode
 *šode,
fe
 *
fp
,*
buf
,

136 
couÁ
)

138 
£ùÜ
,
off£t
,
size
,
Ëá
,
wr™‹n
;

139 
”rÜ
,
ÿ¼y
;

140 *
¡¬t
,*
to
,
ch
;

141 
bufãr_h—d
 *
bh
;

142 *
d©a
;

144 ià(!
šode
) {

145 
	`´štk
("msdos_file_write: inode = NULL\n");

146  -
EINVAL
;

148 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

149 
	`´štk
("msdos_fe_wr™e: modğ%07o\n",
šode
->
i_mode
);

150  -
EINVAL
;

156 ià(
fp
->
f_æags
 & 
O_APPEND
èfp->
f_pos
 = 
šode
->
i_size
;

157 ià(
couÁ
 <= 0)  0;

158 
”rÜ
 = 
ÿ¼y
 = 0;

159 
¡¬t
 = 
buf
; 
couÁ
 || 
ÿ¼y
; couÁ -ğ
size
) {

160 !(
£ùÜ
 = 
	`msdos_sm­
(
šode
,
fp
->
f_pos
 >> 
SECTOR_BITS
)))

161 ià((
”rÜ
 = 
	`msdos_add_şu¡”
(
šode
)) < 0) ;

162 ià(
”rÜ
) {

163 
	`msdos_Œunÿ‹
(
šode
);

166 
off£t
 = 
fp
->
f_pos
 & (
SECTOR_SIZE
-1);

167 
size
 = 
	`MIN
(
SECTOR_SIZE
-
off£t
,
	`MAX
(
ÿ¼y
,
couÁ
));

168 ià(!(
bh
 = 
	`msdos_¤—d
(
šode
->
i_dev
,
£ùÜ
,&
d©a
))) {

169 
”rÜ
 = -
EIO
;

172 ià(
	`MSDOS_I
(
šode
)->
i_bš¬y
) {

173 
	`memıy_äomfs
(
d©a
+(
fp
->
f_pos
 & (
SECTOR_SIZE
-1)),

174 
buf
,
wr™‹n
 = 
size
);

175 
buf
 +ğ
size
;

178 
wr™‹n
 = 
Ëá
 = 
SECTOR_SIZE
-
off£t
;

179 
to
 = (*è
d©a
+(
fp
->
f_pos
 & (
SECTOR_SIZE
-1));

180 ià(
ÿ¼y
) {

181 *
to
++ = '\n';

182 
Ëá
--;

183 
ÿ¼y
 = 0;

185 
size
 = 0; siz< 
couÁ
 && 
Ëá
; size++) {

186 ià((
ch
 = 
	`g‘_fs_by‹
(
buf
++)) == '\n') {

187 *
to
++ = '\r';

188 
Ëá
--;

190 ià(!
Ëá
è
ÿ¼y
 = 1;

192 *
to
++ = 
ch
;

193 
Ëá
--;

196 
wr™‹n
 -ğ
Ëá
;

198 
fp
->
f_pos
 +ğ
wr™‹n
;

199 ià(
fp
->
f_pos
 > 
šode
->
i_size
) {

200 
šode
->
i_size
 = 
fp
->
f_pos
;

201 
šode
->
i_dœt
 = 1;

203 
bh
->
b_dœt
 = 1;

204 
	`b»l£
(
bh
);

206 ià(
¡¬t
 =ğ
buf
)

207  
”rÜ
;

208 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

209 
	`MSDOS_I
(
šode
)->
i_©Œs
 |ğ
ATTR_ARCH
;

210 
šode
->
i_dœt
 = 1;

211  
buf
-
¡¬t
;

212 
	}
}

215 
	$msdos_Œunÿ‹
(
šode
 *inode)

217 
şu¡”
;

219 
şu¡”
 = 
SECTOR_SIZE
*
	`MSDOS_SB
(
šode
->
i_sb
)->
şu¡”_size
;

220 (è
	`çt_ä“
(
šode
,(šode->
i_size
+(
şu¡”
-1))/cluster);

221 
	`MSDOS_I
(
šode
)->
i_©Œs
 |ğ
ATTR_ARCH
;

222 
šode
->
i_dœt
 = 1;

223 
	}
}

	@fs/msdos/inode.c

7 
	~<lšux/msdos_fs.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/ùy³.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/locks.h
>

16 
	~<asm/£gm’t.h
>

19 
	$msdos_put_šode
(
šode
 *inode)

21 
šode
 *
d•’d
;

22 
su³r_block
 *
sb
;

24 ià(
šode
->
i_Æšk
) {

25 ià(
	`MSDOS_I
(
šode
)->
i_busy
è
	`ÿche_šv®_šode
(inode);

28 
šode
->
i_size
 = 0;

29 
	`msdos_Œunÿ‹
(
šode
);

30 
d•’d
 = 
	`MSDOS_I
(
šode
)->
i_d•’d
;

31 
sb
 = 
šode
->
i_sb
;

32 
	`ş—r_šode
(
šode
);

33 ià(
d•’d
) {

34 ià(
	`MSDOS_I
(
d•’d
)->
i_Şd
 !ğ
šode
) {

35 
	`´štk
("Invalid†ink (0x%X):ƒxpected 0x%X, got 0x%X\n",

36 (è
d•’d
,(è
šode
,(è
	`MSDOS_I
(depend)->

37 
i_Şd
);

38 
	`fs_·nic
(
sb
,"...");

41 
	`MSDOS_I
(
d•’d
)->
i_Şd
 = 
NULL
;

42 
	`ut
(
d•’d
);

44 
	}
}

47 
	$msdos_put_su³r
(
su³r_block
 *
sb
)

49 
	`ÿche_šv®_dev
(
sb
->
s_dev
);

50 
	`lock_su³r
(
sb
);

51 
sb
->
s_dev
 = 0;

52 
	`uÆock_su³r
(
sb
);

54 
	}
}

57 
su³r_İ”©iÚs
 
	gmsdos_sİs
 = {

58 
msdos_»ad_šode
,

59 
msdos_nÙify_chªge
,

60 
msdos_wr™e_šode
,

61 
msdos_put_šode
,

62 
msdos_put_su³r
,

63 
NULL
,

64 
msdos_¡©fs
,

65 
NULL


69 
	$·r£_İtiÚs
(*
İtiÚs
,*
check
,*
cÚv”siÚ
,
uid_t
 *
uid
,

70 
gid_t
 *
gid
,*
umask
,*
debug
,*
çt
,*
qu›t
)

72 *
this_ch¬
,*
v®ue
;

74 *
check
 = 'n';

75 *
cÚv”siÚ
 = 'b';

76 *
uid
 = 
cu¼’t
->uid;

77 *
gid
 = 
cu¼’t
->gid;

78 *
umask
 = 
cu¼’t
->umask;

79 *
debug
 = *
çt
 = *
qu›t
 = 0;

80 ià(!
İtiÚs
)  1;

81 
this_ch¬
 = 
	`¡¹ok
(
İtiÚs
,",");his_ch¬;his_ch¬ = sŒtok(
NULL
,",")) {

82 ià((
v®ue
 = 
	`¡rchr
(
this_ch¬
,'=')è!ğ
NULL
)

83 *
v®ue
++ = 0;

84 ià(!
	`¡rcmp
(
this_ch¬
,"check"è&& 
v®ue
) {

85 ià(
v®ue
[0] && !v®ue[1] && 
	`¡rchr
("rns",*value))

86 *
check
 = *
v®ue
;

87 ià(!
	`¡rcmp
(
v®ue
,"»Ïxed")è*
check
 = 'r';

88 ià(!
	`¡rcmp
(
v®ue
,"nÜm®")è*
check
 = 'n';

89 ià(!
	`¡rcmp
(
v®ue
,"¡riù")è*
check
 = 's';

92 ià(!
	`¡rcmp
(
this_ch¬
,"cÚv"è&& 
v®ue
) {

93 ià(
v®ue
[0] && !v®ue[1] && 
	`¡rchr
("bta",*value))

94 *
cÚv”siÚ
 = *
v®ue
;

95 ià(!
	`¡rcmp
(
v®ue
,"bš¬y")è*
cÚv”siÚ
 = 'b';

96 ià(!
	`¡rcmp
(
v®ue
,"‹xt")è*
cÚv”siÚ
 = 't';

97 ià(!
	`¡rcmp
(
v®ue
,"auto")è*
cÚv”siÚ
 = 'a';

100 ià(!
	`¡rcmp
(
this_ch¬
,"uid")) {

101 ià(!
v®ue
 || !*value)

103 *
uid
 = 
	`sim¶e_¡¹oul
(
v®ue
,&value,0);

104 ià(*
v®ue
)

107 ià(!
	`¡rcmp
(
this_ch¬
,"gid")) {

108 ià(!
v®ue
 || !*value)

110 *
gid
 = 
	`sim¶e_¡¹oul
(
v®ue
,&value,0);

111 ià(*
v®ue
)

114 ià(!
	`¡rcmp
(
this_ch¬
,"umask")) {

115 ià(!
v®ue
 || !*value)

117 *
umask
 = 
	`sim¶e_¡¹oul
(
v®ue
,&value,8);

118 ià(*
v®ue
)

121 ià(!
	`¡rcmp
(
this_ch¬
,"debug")) {

122 ià(
v®ue
)  0;

123 *
debug
 = 1;

125 ià(!
	`¡rcmp
(
this_ch¬
,"fat")) {

126 ià(!
v®ue
 || !*value)

128 *
çt
 = 
	`sim¶e_¡¹oul
(
v®ue
,&value,0);

129 ià(*
v®ue
 || (*
çt
 != 12 && *fat != 16))

132 ià(!
	`¡rcmp
(
this_ch¬
,"quiet")) {

133 ià(
v®ue
)  0;

134 *
qu›t
 = 1;

139 
	}
}

144 
su³r_block
 *
	$msdos_»ad_su³r
(
su³r_block
 *
s
,*
d©a
,

145 
s’t
)

147 
bufãr_h—d
 *
bh
;

148 
msdos_boÙ_£ùÜ
 *
b
;

149 
d©a_£ùÜs
,
logiÿl_£ùÜ_size
,
£ùÜ_muÉ
;

150 
debug
,
”rÜ
,
çt
,
qu›t
;

151 
check
,
cÚv”siÚ
;

152 
uid_t
 
uid
;

153 
gid_t
 
gid
;

154 
umask
;

156 ià(!
	`·r£_İtiÚs
((*è
d©a
,&
check
,&
cÚv”siÚ
,&
uid
,&
gid
,&
umask
,

157 &
debug
,&
çt
,&
qu›t
)) {

158 
s
->
s_dev
 = 0;

159  
NULL
;

161 
	`ÿche_š™
();

162 
	`lock_su³r
(
s
);

163 
bh
 = 
	`b»ad
(
s
->
s_dev
, 0, 
BLOCK_SIZE
);

164 
	`uÆock_su³r
(
s
);

165 ià(
bh
 =ğ
NULL
) {

166 
s
->
s_dev
 = 0;

167 
	`´štk
("MSDOS bread failed\n");

168  
NULL
;

170 
b
 = (
msdos_boÙ_£ùÜ
 *è
bh
->
b_d©a
;

171 
s
->
s_blocksize
 = 1024;

172 
s
->
s_blocksize_b™s
 = 10;

189 
	#ROUND_TO_MULTIPLE
(
n
,
m
è(Òè&& (mè? (n)+(m)-1-(Ò)-1)%(mè: 0)

	)

192 
logiÿl_£ùÜ_size
 = 
	`CF_LE_W
(*(*è&
b
->
£ùÜ_size
);

193 
£ùÜ_muÉ
 = 
logiÿl_£ùÜ_size
 >> 
SECTOR_BITS
;

194 
	`MSDOS_SB
(
s
)->
şu¡”_size
 = 
b
->şu¡”_size*
£ùÜ_muÉ
;

195 
	`MSDOS_SB
(
s
)->
çts
 = 
b
->fats;

196 
	`MSDOS_SB
(
s
)->
çt_¡¬t
 = 
	`CF_LE_W
(
b
->
»£rved
)*
£ùÜ_muÉ
;

197 
	`MSDOS_SB
(
s
)->
çt_Ëngth
 = 
	`CF_LE_W
(
b
->çt_Ëngth)*
£ùÜ_muÉ
;

198 
	`MSDOS_SB
(
s
)->
dœ_¡¬t
 = (
	`CF_LE_W
(
b
->
»£rved
)+b->
çts
*CF_LE_W(

199 
b
->
çt_Ëngth
))*
£ùÜ_muÉ
;

200 
	`MSDOS_SB
(
s
)->
dœ_’Œ›s
 = 
	`CF_LE_W
(*((*è&
b
->dir_entries

202 
	`MSDOS_SB
(
s
)->
d©a_¡¬t
 = MSDOS_SB(s)->
dœ_¡¬t
+
	`ROUND_TO_MULTIPLE
((

203 
	`MSDOS_SB
(
s
)->
dœ_’Œ›s
 << 
MSDOS_DIR_BITS
è>> 
SECTOR_BITS
,

204 
£ùÜ_muÉ
);

205 
d©a_£ùÜs
 = (
	`CF_LE_W
(*((*è&
b
->
£ùÜs
)) ?

206 
	`CF_LE_W
(*((*è&
b
->
£ùÜs
)) :

207 
	`CF_LE_L
(
b
->
tÙ®_£ù
))*
£ùÜ_muÉ
-
	`MSDOS_SB
(
s
)->
d©a_¡¬t
;

208 
”rÜ
 = !
b
->
şu¡”_size
 || !
£ùÜ_muÉ
;

209 ià(!
”rÜ
) {

210 
	`MSDOS_SB
(
s
)->
şu¡”s
 = 
b
->
şu¡”_size
 ? 
d©a_£ùÜs
/

211 
b
->
şu¡”_size
/
£ùÜ_muÉ
 : 0;

212 
	`MSDOS_SB
(
s
)->
çt_b™s
 = 
çt
 ? f© : MSDOS_SB(s)->
şu¡”s
 >

213 
MSDOS_FAT12
 ? 16 : 12;

214 
”rÜ
 = !
	`MSDOS_SB
(
s
)->
çts
 || (MSDOS_SB(s)->
dœ_’Œ›s
 &

215 (
MSDOS_DPS
-1)è|| 
	`MSDOS_SB
(
s
)->
şu¡”s
+2 > MSDOS_SB(s)->

216 
çt_Ëngth
*
SECTOR_SIZE
*8/
	`MSDOS_SB
(
s
)->
çt_b™s
 ||

217 (
logiÿl_£ùÜ_size
 & (
SECTOR_SIZE
-1)è|| !
b
->
£cs_Œack
 ||

218 !
b
->
h—ds
;

220 
	`b»l£
(
bh
);

221 ià(
”rÜ
 || 
debug
) {

222 
	`´štk
("[MS-DOS FS Rel. 12,FAT %d,check=%c,conv=%c,"

223 "uid=%d,gid=%d,umask=%03o%s]\n",
	`MSDOS_SB
(
s
)->
çt_b™s
,
check
,

224 
cÚv”siÚ
,
uid
,
gid
,
umask
,
	`MSDOS_CAN_BMAP
(
	`MSDOS_SB
(
s
)) ?

226 
	`´štk
("[me=0x%x,cs=%d,#f=%d,fs=%d,fl=%d,ds=%d,de=%d,data=%d,"

227 "£=%d,ts=%ld,ls=%d]\n",
b
->
medŸ
,
	`MSDOS_SB
(
s
)->
şu¡”_size
,

228 
	`MSDOS_SB
(
s
)->
çts
,MSDOS_SB(s)->
çt_¡¬t
,MSDOS_SB(s)->

229 
çt_Ëngth
,
	`MSDOS_SB
(
s
)->
dœ_¡¬t
,MSDOS_SB(s)->
dœ_’Œ›s
,

230 
	`MSDOS_SB
(
s
)->
d©a_¡¬t
,
	`CF_LE_W
(*(*è&
b
->

231 
£ùÜs
),
b
->
tÙ®_£ù
,
logiÿl_£ùÜ_size
);

233 ià(
”rÜ
) {

234 ià(!
s’t
)

235 
	`´štk
("VFS: Can't find‡ valid MSDOS filesystem on dev 0x%04x.\n",

236 
s
->
s_dev
);

237 
s
->
s_dev
 = 0;

238  
NULL
;

240 
s
->
s_magic
 = 
MSDOS_SUPER_MAGIC
;

241 
	`MSDOS_SB
(
s
)->
Çme_check
 = 
check
;

242 
	`MSDOS_SB
(
s
)->
cÚv”siÚ
 = conversion;

244 
s
->
s_İ
 = &
msdos_sİs
;

245 
	`MSDOS_SB
(
s
)->
fs_uid
 = 
uid
;

246 
	`MSDOS_SB
(
s
)->
fs_gid
 = 
gid
;

247 
	`MSDOS_SB
(
s
)->
fs_umask
 = 
umask
;

248 
	`MSDOS_SB
(
s
)->
qu›t
 = quiet;

249 
	`MSDOS_SB
(
s
)->
ä“_şu¡”s
 = -1;

250 
	`MSDOS_SB
(
s
)->
çt_wa™
 = 
NULL
;

251 
	`MSDOS_SB
(
s
)->
çt_lock
 = 0;

252 
	`MSDOS_SB
(
s
)->
´ev_ä“
 = 0;

253 ià(!(
s
->
s_mouÁed
 = 
	`ig‘
(s,
MSDOS_ROOT_INO
))) {

254 
s
->
s_dev
 = 0;

255 
	`´štk
("get„oot inode failed\n");

256  
NULL
;

258  
s
;

259 
	}
}

262 
	$msdos_¡©fs
(
su³r_block
 *
sb
,
¡©fs
 *
buf
)

264 
ä“
,
Ä
;

266 
	`put_fs_lÚg
(
sb
->
s_magic
,&
buf
->
f_ty³
);

267 
	`put_fs_lÚg
(
	`MSDOS_SB
(
sb
)->
şu¡”_size
*
SECTOR_SIZE
,&
buf
->
f_bsize
);

268 
	`put_fs_lÚg
(
	`MSDOS_SB
(
sb
)->
şu¡”s
,&
buf
->
f_blocks
);

269 
	`lock_çt
(
sb
);

270 ià(
	`MSDOS_SB
(
sb
)->
ä“_şu¡”s
 != -1)

271 
ä“
 = 
	`MSDOS_SB
(
sb
)->
ä“_şu¡”s
;

273 
ä“
 = 0;

274 
Ä
 = 2;‚¸< 
	`MSDOS_SB
(
sb
)->
şu¡”s
+2;‚r++)

275 ià(!
	`çt_acûss
(
sb
,
Ä
,-1)è
ä“
++;

276 
	`MSDOS_SB
(
sb
)->
ä“_şu¡”s
 = 
ä“
;

278 
	`uÆock_çt
(
sb
);

279 
	`put_fs_lÚg
(
ä“
,&
buf
->
f_bä“
);

280 
	`put_fs_lÚg
(
ä“
,&
buf
->
f_bava
);

281 
	`put_fs_lÚg
(0,&
buf
->
f_fes
);

282 
	`put_fs_lÚg
(0,&
buf
->
f_fä“
);

283 
	`put_fs_lÚg
(12,&
buf
->
f_Çm–’
);

284 
	}
}

287 
	$msdos_bm­
(
šode
 *šode,
block
)

289 
msdos_sb_šfo
 *
sb
;

290 
şu¡”
,
off£t
;

292 
sb
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

293 ià((
sb
->
şu¡”_size
 & 1è|| (sb->
d©a_¡¬t
 & 1))  0;

294 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
) {

295 ià(
sb
->
dœ_¡¬t
 & 1)  0;

296  (
sb
->
dœ_¡¬t
 >> 1)+
block
;

298 
şu¡”
 = (
block
*2)/
sb
->
şu¡”_size
;

299 
off£t
 = (
block
*2è% 
sb
->
şu¡”_size
;

300 ià(!(
şu¡”
 = 
	`g‘_şu¡”
(
šode
,cluster)))  0;

301  ((
şu¡”
-2)*
sb
->
şu¡”_size
+sb->
d©a_¡¬t
+
off£t
) >> 1;

302 
	}
}

305 
	$msdos_»ad_šode
(
šode
 *inode)

307 
bufãr_h—d
 *
bh
;

308 
msdos_dœ_’Œy
 *
¿w_’Œy
;

309 
Ä
;

312 
	`MSDOS_I
(
šode
)->
i_busy
 = 0;

313 
	`MSDOS_I
(
šode
)->
i_d•’d
 = MSDOS_I(šode)->
i_Şd
 = 
NULL
;

314 
	`MSDOS_I
(
šode
)->
i_bš¬y
 = 1;

315 
šode
->
i_uid
 = 
	`MSDOS_SB
(šode->
i_sb
)->
fs_uid
;

316 
šode
->
i_gid
 = 
	`MSDOS_SB
(šode->
i_sb
)->
fs_gid
;

317 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
) {

318 
šode
->
i_mode
 = (
S_IRWXUGO
 & ~
	`MSDOS_SB
(šode->
i_sb
)->
fs_umask
) |

319 
S_IFDIR
;

320 
šode
->
i_İ
 = &
msdos_dœ_šode_İ”©iÚs
;

321 
šode
->
i_Æšk
 = 
	`msdos_subdœs
(inode)+2;

323 
šode
->
i_size
 = 
	`MSDOS_SB
(šode->
i_sb
)->
dœ_’Œ›s
*

324 (
msdos_dœ_’Œy
);

325 
šode
->
i_blksize
 = 
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
*

326 
SECTOR_SIZE
;

327 
šode
->
i_blocks
 = (šode->
i_size
+šode->
i_blksize
-1)/

328 
šode
->
i_blksize
*
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
;

329 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 0;

330 
	`MSDOS_I
(
šode
)->
i_©Œs
 = 0;

331 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 0;

334 ià(!(
bh
 = 
	`b»ad
(
šode
->
i_dev
,šode->
i_šo
 >> 
MSDOS_DPB_BITS
,

335 
BLOCK_SIZE
))) {

336 
	`´štk
("dev = 0x%04X, inØğ%ld\n",
šode
->
i_dev
,šode->
i_šo
);

337 
	`·nic
("msdos_read_inode: unableo„ead i-node block");

339 
¿w_’Œy
 = &((
msdos_dœ_’Œy
 *è(
bh
->
b_d©a
))

340 [
šode
->
i_šo
 & (
MSDOS_DPB
-1)];

341 ià((
¿w_’Œy
->
©Œ
 & 
ATTR_DIR
è&& !
	`IS_FREE
Ôaw_’Œy->
Çme
)) {

342 
šode
->
i_mode
 = 
	`MSDOS_MKMODE
(
¿w_’Œy
->
©Œ
,
S_IRWXUGO
 &

343 ~
	`MSDOS_SB
(
šode
->
i_sb
)->
fs_umask
è| 
S_IFDIR
;

344 
šode
->
i_İ
 = &
msdos_dœ_šode_İ”©iÚs
;

345 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
	`CF_LE_W
(
¿w_’Œy
->
¡¬t
);

346 
šode
->
i_Æšk
 = 
	`msdos_subdœs
(inode);

348 #ifdeà
DEBUG


349 ià(!
šode
->
i_Æšk
) {

350 
	`´štk
("dœeùÜy %d: i_Æšk =ğ0\n",
šode
->
i_šo
);

351 
šode
->
i_Æšk
 = 1;

354 
šode
->
i_size
 = 0;

355 ià((
Ä
 = 
	`CF_LE_W
(
¿w_’Œy
->
¡¬t
)) != 0)

356 
Ä
 != -1) {

357 
šode
->
i_size
 +ğ
SECTOR_SIZE
*
	`MSDOS_SB
(inode->

358 
i_sb
)->
şu¡”_size
;

359 ià(!(
Ä
 = 
	`çt_acûss
(
šode
->
i_sb
,nr,-1))) {

360 
	`´štk
("Directory %ld: bad FAT\n",

361 
šode
->
i_šo
);

367 
šode
->
i_mode
 = 
	`MSDOS_MKMODE
(
¿w_’Œy
->
©Œ
,(
	`IS_NOEXEC
(inode)

368 ? 
S_IRUGO
|
S_IWUGO
 : 
S_IRWXUGO
è& ~
	`MSDOS_SB
(
šode
->
i_sb
)->
fs_umask
) |

369 
S_IFREG
;

370 
šode
->
i_İ
 = 
	`MSDOS_CAN_BMAP
(
	`MSDOS_SB
(šode->
i_sb
)) ?

371 &
msdos_fe_šode_İ”©iÚs
 :

372 &
msdos_fe_šode_İ”©iÚs_no_bm­
;

373 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
	`CF_LE_W
(
¿w_’Œy
->
¡¬t
);

374 
šode
->
i_Æšk
 = 1;

375 
šode
->
i_size
 = 
	`CF_LE_L
(
¿w_’Œy
->
size
);

377 
	`MSDOS_I
(
šode
)->
i_bš¬y
 = 
	`is_bš¬y
(
	`MSDOS_SB
(šode->
i_sb
)->
cÚv”siÚ
,

378 
¿w_’Œy
->
ext
);

379 
	`MSDOS_I
(
šode
)->
i_©Œs
 = 
¿w_’Œy
->
©Œ
 & 
ATTR_UNUSED
;

381 
šode
->
i_blksize
 = 
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
*
SECTOR_SIZE
;

382 
šode
->
i_blocks
 = (šode->
i_size
+šode->
i_blksize
-1)/

383 
šode
->
i_blksize
*
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
;

384 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 =

385 
	`d©e_dos2unix
(
	`CF_LE_W
(
¿w_’Œy
->
time
),CF_LE_WÔaw_’Œy->
d©e
));

386 
	`b»l£
(
bh
);

387 
	}
}

390 
	$msdos_wr™e_šode
(
šode
 *inode)

392 
bufãr_h—d
 *
bh
;

393 
msdos_dœ_’Œy
 *
¿w_’Œy
;

395 
šode
->
i_dœt
 = 0;

396 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
 || !šode->
i_Æšk
) ;

397 ià(!(
bh
 = 
	`b»ad
(
šode
->
i_dev
,šode->
i_šo
 >> 
MSDOS_DPB_BITS
,

398 
BLOCK_SIZE
))) {

399 
	`´štk
("dev = 0x%04X, inØğ%ld\n",
šode
->
i_dev
,šode->
i_šo
);

400 
	`·nic
("msdos_write_inode: unableo„ead i-node block");

402 
¿w_’Œy
 = &((
msdos_dœ_’Œy
 *è(
bh
->
b_d©a
))

403 [
šode
->
i_šo
 & (
MSDOS_DPB
-1)];

404 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

405 
¿w_’Œy
->
©Œ
 = 
ATTR_DIR
;

406 
¿w_’Œy
->
size
 = 0;

409 
¿w_’Œy
->
©Œ
 = 
ATTR_NONE
;

410 
¿w_’Œy
->
size
 = 
	`CT_LE_L
(
šode
->
i_size
);

412 
¿w_’Œy
->
©Œ
 |ğ
	`MSDOS_MKATTR
(
šode
->
i_mode
) |

413 
	`MSDOS_I
(
šode
)->
i_©Œs
;

414 
¿w_’Œy
->
¡¬t
 = 
	`CT_LE_L
(
	`MSDOS_I
(
šode
)->
i_¡¬t
);

415 
	`d©e_unix2dos
(
šode
->
i_mtime
,&
¿w_’Œy
->
time
,&¿w_’Œy->
d©e
);

416 
¿w_’Œy
->
time
 = 
	`CT_LE_W
(raw_entry->time);

417 
¿w_’Œy
->
d©e
 = 
	`CT_LE_W
(raw_entry->date);

418 
bh
->
b_dœt
 = 1;

419 
	`b»l£
(
bh
);

420 
	}
}

423 
	$msdos_nÙify_chªge
(
æags
,
šode
 *inode)

425 
”rÜ
;

427 
”rÜ
 = 0;

428 ià((
æags
 & 
NOTIFY_UIDGID
è&& (
šode
->
i_uid
 !ğ
	`MSDOS_SB
(šode->
i_sb
)->

429 
fs_uid
 || 
šode
->
i_gid
 !ğ
	`MSDOS_SB
(šode->
i_sb
)->
fs_gid
)) {

430 
šode
->
i_uid
 = 
	`MSDOS_SB
(šode->
i_sb
)->
fs_uid
;

431 
šode
->
i_gid
 = 
	`MSDOS_SB
(šode->
i_sb
)->
fs_gid
;

432 
”rÜ
 = -
EPERM
;

434 ià(!(
æags
 & 
NOTIFY_MODE
))

435  
	`MSDOS_SB
(
šode
->
i_sb
)->
qu›t
 ? 0 : 
”rÜ
;

436 ià(
šode
->
i_mode
 & ~
MSDOS_VALID_MODE
) {

437 
šode
->
i_mode
 &ğ
MSDOS_VALID_MODE
;

438 
”rÜ
 = -
EPERM
;

440 ià(
	`IS_NOEXEC
(
šode
è&& !
	`S_ISDIR
(šode->
i_mode
))

441 
šode
->
i_mode
 &ğ
S_IFMT
 | 
S_IRUGO
 | 
S_IWUGO
;

442 
šode
->
i_mode
 |ğ
S_IXUGO
;

443 
šode
->
i_mode
 = ((šode->i_mod& 
S_IFMT
è| ((((šode->i_mod& 
S_IRWXU


444 & ~
	`MSDOS_SB
(
šode
->
i_sb
)->
fs_umask
è| 
S_IRUSR
è>> 6)*
S_IXUGO
)) &

445 ~
	`MSDOS_SB
(
šode
->
i_sb
)->
fs_umask
;

446  
	`MSDOS_SB
(
šode
->
i_sb
)->
qu›t
 ? 0 : 
”rÜ
;

447 
	}
}

	@fs/msdos/misc.c

7 
	~<lšux/fs.h
>

8 
	~<lšux/msdos_fs.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/¡©.h
>

17 
	gbš_ex‹nsiÚs
[] =

30 
	$fs_·nic
(
su³r_block
 *
s
,*
msg
)

32 
nÙ_ro
;

34 
nÙ_ro
 = !(
s
->
s_æags
 & 
MS_RDONLY
);

35 ià(
nÙ_ro
è
s
->
s_æags
 |ğ
MS_RDONLY
;

36 
	`´štk
("Filesystem…anic (dev 0x%04X, mounted on 0x%04X:%ld)\n %s\n",

37 
s
->
s_dev
,s->
s_cov”ed
->
i_dev
,s->s_cov”ed->
i_šo
,
msg
);

38 ià(
nÙ_ro
)

39 
	`´štk
(" File system has been set„ead-only\n");

40 
	}
}

48 
	$is_bš¬y
(
cÚv”siÚ
,*
ex‹nsiÚ
)

50 *
w®k
;

52 
cÚv”siÚ
) {

58 
w®k
 = 
bš_ex‹nsiÚs
; *walk; walk += 3)

59 ià(!
	`¡ºcmp
(
ex‹nsiÚ
,
w®k
,3))  1;

62 
	`´štk
("Invalid conversion mode - defaultingo "

66 
	}
}

72 
wa™_queue
 *
	gü—tiÚ_wa™
 = 
NULL
;

73 
	gü—tiÚ_lock
 = 0;

76 
	$lock_ü—tiÚ
()

78 
ü—tiÚ_lock
è
	`¦“p_Ú
(&
ü—tiÚ_wa™
);

79 
ü—tiÚ_lock
 = 1;

80 
	}
}

83 
	$uÆock_ü—tiÚ
()

85 
ü—tiÚ_lock
 = 0;

86 
	`wake_up
(&
ü—tiÚ_wa™
);

87 
	}
}

90 
	$lock_çt
(
su³r_block
 *
sb
)

92 
	`MSDOS_SB
(
sb
)->
çt_lock
è
	`¦“p_Ú
(&MSDOS_SB(sb)->
çt_wa™
);

93 
	`MSDOS_SB
(
sb
)->
çt_lock
 = 1;

94 
	}
}

97 
	$uÆock_çt
(
su³r_block
 *
sb
)

99 
	`MSDOS_SB
(
sb
)->
çt_lock
 = 0;

100 
	`wake_up
(&
	`MSDOS_SB
(
sb
)->
çt_wa™
);

101 
	}
}

109 
	$msdos_add_şu¡”
(
šode
 *inode)

111 
couÁ
,
Ä
,
lim™
,
Ï¡
,
cu¼’t
,
£ùÜ
;

112 *
d©a
;

113 
bufãr_h—d
 *
bh
;

115 ià(
šode
->
i_šo
 =ğ
MSDOS_ROOT_INO
è -
ENOSPC
;

116 ià(!
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
è -
ENOSPC
;

117 
	`lock_çt
(
šode
->
i_sb
);

118 
lim™
 = 
	`MSDOS_SB
(
šode
->
i_sb
)->
şu¡”s
;

119 
Ä
 = 
lim™
;

120 
couÁ
 = 0; couÁ < 
lim™
; count++) {

121 
Ä
 = ((
couÁ
+
	`MSDOS_SB
(
šode
->
i_sb
)->
´ev_ä“
è% 
lim™
)+2;

122 ià(
	`çt_acûss
(
šode
->
i_sb
,
Ä
,-1) == 0) ;

124 #ifdeà
DEBUG


125 
	`´štk
("ä“ clu¡”: %d\n",
Ä
);

127 
	`MSDOS_SB
(
šode
->
i_sb
)->
´ev_ä“
 = (
couÁ
+MSDOS_SB(inode->i_sb)->

128 
´ev_ä“
+1è% 
lim™
;

129 ià(
couÁ
 >ğ
lim™
) {

130 
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
 = 0;

131 
	`uÆock_çt
(
šode
->
i_sb
);

132  -
ENOSPC
;

134 
	`çt_acûss
(
šode
->
i_sb
,
Ä
,
	`MSDOS_SB
(šode->i_sb)->
çt_b™s
 == 12 ?

136 ià(
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
 != -1)

137 
	`MSDOS_SB
(
šode
->
i_sb
)->
ä“_şu¡”s
--;

138 
	`uÆock_çt
(
šode
->
i_sb
);

139 #ifdeà
DEBUG


140 
	`´štk
("£ˆtØ%x\n",
	`çt_acûss
(
šode
->
i_sb
,
Ä
,-1));

142 
Ï¡
 = 0;

143 ià((
cu¼’t
 = 
	`MSDOS_I
(
šode
)->
i_¡¬t
) != 0) {

144 
	`ÿche_lookup
(
šode
,
INT_MAX
,&
Ï¡
,&
cu¼’t
);

145 
cu¼’t
 && current != -1)

146 ià(!(
cu¼’t
 = 
	`çt_acûss
(
šode
->
i_sb
,

147 
Ï¡
 = 
cu¼’t
,-1))) {

148 
	`fs_·nic
(
šode
->
i_sb
,"File without EOF");

149  -
ENOSPC
;

152 #ifdeà
DEBUG


153 
	`´štk
("Ï¡ = %d\n",
Ï¡
);

155 ià(
Ï¡
è
	`çt_acûss
(
šode
->
i_sb
,Ï¡,
Ä
);

157 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ä
;

158 
šode
->
i_dœt
 = 1;

160 #ifdeà
DEBUG


161 ià(
Ï¡
è
	`´štk
("Ãxˆ£ˆtØ%d\n",
	`çt_acûss
(
šode
->
i_sb
,last,-1));

163 
cu¼’t
 = 0; cu¼’ˆ< 
	`MSDOS_SB
(
šode
->
i_sb
)->
şu¡”_size
;

164 
cu¼’t
++) {

165 
£ùÜ
 = 
	`MSDOS_SB
(
šode
->
i_sb
)->
d©a_¡¬t
+(
Ä
-2)*

166 
	`MSDOS_SB
(
šode
->
i_sb
)->
şu¡”_size
+
cu¼’t
;

167 #ifdeà
DEBUG


168 
	`´štk
("z”ošg seùÜ %d\n",
£ùÜ
);

170 ià(
cu¼’t
 < 
	`MSDOS_SB
(
šode
->
i_sb
)->
şu¡”_size
-1 &&

171 !(
£ùÜ
 & 1)) {

172 ià(!(
bh
 = 
	`g‘blk
(
šode
->
i_dev
,
£ùÜ
 >> 1,

173 
BLOCK_SIZE
)))

174 
	`´štk
("getblk failed\n");

176 
	`mem£t
(
bh
->
b_d©a
,0,
BLOCK_SIZE
);

177 
bh
->
b_u±od©e
 = 1;

179 
cu¼’t
++;

182 ià(!(
bh
 = 
	`msdos_¤—d
(
šode
->
i_dev
,
£ùÜ
,

183 &
d©a
)))

184 
	`´štk
("msdos_sread failed\n");

185 
	`mem£t
(
d©a
,0,
SECTOR_SIZE
);

187 ià(
bh
) {

188 
bh
->
b_dœt
 = 1;

189 
	`b»l£
(
bh
);

192 
šode
->
i_blocks
 +ğ
	`MSDOS_SB
(šode->
i_sb
)->
şu¡”_size
;

193 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

194 ià(
šode
->
i_size
 & (
SECTOR_SIZE
-1)) {

195 
	`fs_·nic
(
šode
->
i_sb
,"Odd directory size");

196 
šode
->
i_size
 = (šode->i_size+
SECTOR_SIZE
) &

197 ~(
SECTOR_SIZE
-1);

199 
šode
->
i_size
 +ğ
SECTOR_SIZE
*
	`MSDOS_SB
(šode->
i_sb
)->

200 
şu¡”_size
;

201 #ifdeà
DEBUG


202 
	`´štk
("sizi %d‚ow (%x)\n",
šode
->
i_size
,inode);

204 
šode
->
i_dœt
 = 1;

207 
	}
}

212 
	gday_n
[] = { 0,31,59,90,120,151,181,212,243,273,304,334,0,0,0,0 };

216 
timezÚe
 
sys_tz
;

221 
	$d©e_dos2unix
(
time
,
d©e
)

223 
mÚth
,
y—r
,
£cs
;

225 
mÚth
 = ((
d©e
 >> 5) & 15)-1;

226 
y—r
 = 
d©e
 >> 9;

227 
£cs
 = (
time
 & 31)*2+60*((time >> 5) & 63)+(time >> 11)*3600+86400*

228 ((
d©e
 & 31)-1+
day_n
[
mÚth
]+(
y—r
/4)+year*365-((year & 3) == 0 &&

229 
mÚth
 < 2 ? 1 : 0)+3653);

231 
£cs
 +ğ
sys_tz
.
tz_mšu‹swe¡
*60;

232  
£cs
;

233 
	}
}

238 
	$d©e_unix2dos
(
unix_d©e
,*
time
,

239 *
d©e
)

241 
day
,
y—r
,
Æ_day
,
mÚth
;

243 
unix_d©e
 -ğ
sys_tz
.
tz_mšu‹swe¡
*60;

244 *
time
 = (
unix_d©e
 % 60)/2+(((unix_date/60) % 60) << 5)+

245 (((
unix_d©e
/3600) % 24) << 11);

246 
day
 = 
unix_d©e
/86400-3652;

247 
y—r
 = 
day
/365;

248 ià((
y—r
+3)/4+365*y—¸> 
day
) year--;

249 
day
 -ğ(
y—r
+3)/4+365*year;

250 ià(
day
 =ğ59 && !(
y—r
 & 3)) {

251 
Æ_day
 = 
day
;

252 
mÚth
 = 2;

255 
Æ_day
 = (
y—r
 & 3è|| 
day
 <= 59 ? day : day-1;

256 
mÚth
 = 0; month < 12; month++)

257 ià(
day_n
[
mÚth
] > 
Æ_day
) ;

259 *
d©e
 = 
Æ_day
-
day_n
[
mÚth
-1]+1+(mÚth << 5)+(
y—r
 << 9);

260 
	}
}

267 
	$msdos_g‘_’Œy
(
šode
 *
dœ
, 
off_t
 *
pos
,
bufãr_h—d
 **
bh
,

268 
msdos_dœ_’Œy
 **
de
)

270 
£ùÜ
,
off£t
;

271 *
d©a
;

274 
off£t
 = *
pos
;

275 ià((
£ùÜ
 = 
	`msdos_sm­
(
dœ
,
off£t
 >> 
SECTOR_BITS
)) == -1)

277 ià(!
£ùÜ
)

279 *
pos
 +ğ(
msdos_dœ_’Œy
);

280 ià(*
bh
)

281 
	`b»l£
(*
bh
);

282 ià(!(*
bh
 = 
	`msdos_¤—d
(
dœ
->
i_dev
,
£ùÜ
,&
d©a
))) {

283 
	`´štk
("DœeùÜy s»ad (£ùÜ %dèçed\n",
£ùÜ
);

286 *
de
 = (
msdos_dœ_’Œy
 *è(
d©a
+(
off£t
 &

287 (
SECTOR_SIZE
-1)));

288  (
£ùÜ
 << 
MSDOS_DPS_BITS
)+((
off£t
 & (
SECTOR_SIZE
-1)) >>

289 
MSDOS_DIR_BITS
);

291 
	}
}

319 
	#RSS_NAME
 \

320 
dÚe
 = !
	`¡ºcmp
(
d©a
[
’Œy
].
Çme
,Çme,
MSDOS_NAME
) && \

321 !(
d©a
[
’Œy
].
©Œ
 & 
ATTR_VOLUME
);

	)

323 
	#RSS_START
 \

324 
dÚe
 = !
	`IS_FREE
(
d©a
[
’Œy
].
Çme
è&& 
	`CF_LE_W
(d©a[’Œy].
¡¬t
è=ğ*
numb”
;

	)

326 
	#RSS_FREE
 \

328 
dÚe
 = 
	`IS_FREE
(
d©a
[
’Œy
].
Çme
); \

329 ià(
dÚe
) { \

330 
šode
 = 
	`ig‘
(
sb
,
£ùÜ
*
MSDOS_DPS
+
’Œy
); \

331 ià(
šode
) { \

333 
dÚe
 = !
	`MSDOS_I
(
šode
)->
i_busy
; \

334 
	`ut
(
šode
); \

337 }

	)

339 
	#RSS_COUNT
 \

341 
dÚe
 = 0; \

342 ià(!
	`IS_FREE
(
d©a
[
’Œy
].
Çme
è&& (d©a[’Œy].
©Œ
 & 
ATTR_DIR
)) \

343 (*
numb”
)++; \

344 }

	)

346 
	$¿w_sÿn_£ùÜ
(
su³r_block
 *
sb
,
£ùÜ
,*
Çme
,

347 *
numb”
,*
šo
,
bufãr_h—d
 **
»s_bh
,

348 
msdos_dœ_’Œy
 **
»s_de
)

350 
bufãr_h—d
 *
bh
;

351 
msdos_dœ_’Œy
 *
d©a
;

352 
šode
 *inode;

353 
’Œy
,
¡¬t
,
dÚe
;

355 ià(!(
bh
 = 
	`msdos_¤—d
(
sb
->
s_dev
,
£ùÜ
,(**è&
d©a
))è -
EIO
;

356 
’Œy
 = 0;ƒÁry < 
MSDOS_DPS
;ƒntry++) {

357 ià(
Çme
è
RSS_NAME


359 ià(!
šo
è
RSS_COUNT


361 ià(
numb”
è
RSS_START


362 
RSS_FREE


365 ià(
dÚe
) {

366 ià(
šo
è*šØğ
£ùÜ
*
MSDOS_DPS
+
’Œy
;

367 
¡¬t
 = 
	`CF_LE_W
(
d©a
[
’Œy
].start);

368 ià(!
»s_bh
è
	`b»l£
(
bh
);

370 *
»s_bh
 = 
bh
;

371 *
»s_de
 = &
d©a
[
’Œy
];

373  
¡¬t
;

376 
	`b»l£
(
bh
);

377  -
ENOENT
;

378 
	}
}

386 
	$¿w_sÿn_roÙ
(
su³r_block
 *
sb
,*
Çme
,*
numb”
,*
šo
,

387 
bufãr_h—d
 **
»s_bh
,
msdos_dœ_’Œy
 **
»s_de
)

389 
couÁ
,
şu¡”
;

391 
couÁ
 = 0; couÁ < 
	`MSDOS_SB
(
sb
)->
dœ_’Œ›s
/
MSDOS_DPS
; count++) {

392 ià((
şu¡”
 = 
	`¿w_sÿn_£ùÜ
(
sb
,
	`MSDOS_SB
(sb)->
dœ_¡¬t
+
couÁ
,

393 
Çme
,
numb”
,
šo
,
»s_bh
,
»s_de
)è>ğ0è 
şu¡”
;

395  -
ENOENT
;

396 
	}
}

404 
	$¿w_sÿn_nÚroÙ
(
su³r_block
 *
sb
,
¡¬t
,*
Çme
,

405 *
numb”
,*
šo
,
bufãr_h—d
 **
»s_bh
,
msdos_dœ_’Œy


406 **
»s_de
)

408 
couÁ
,
şu¡”
;

410 #ifdeà
DEBUG


411 
	`´štk
("¿w_sÿn_nÚroÙ: s¹=%d\n",
¡¬t
);

414 
couÁ
 = 0; couÁ < 
	`MSDOS_SB
(
sb
)->
şu¡”_size
; count++) {

415 ià((
şu¡”
 = 
	`¿w_sÿn_£ùÜ
(
sb
,(
¡¬t
-2)*

416 
	`MSDOS_SB
(
sb
)->
şu¡”_size
+MSDOS_SB(sb)->
d©a_¡¬t
+

417 
couÁ
,
Çme
,
numb”
,
šo
,
»s_bh
,
»s_de
)) >= 0)

418  
şu¡”
;

420 ià(!(
¡¬t
 = 
	`çt_acûss
(
sb
,start,-1))) {

421 
	`fs_·nic
(
sb
,"FATƒrror");

424 #ifdeà
DEBUG


425 
	`´štk
("Ãxˆ¡¬t: %d\n",
¡¬t
);

428 
¡¬t
 != -1);

429  -
ENOENT
;

430 
	}
}

440 
	$¿w_sÿn
(
su³r_block
 *
sb
,
¡¬t
,*
Çme
,*
numb”
,

441 *
šo
,
bufãr_h—d
 **
»s_bh
,
msdos_dœ_’Œy
 **
»s_de
)

443 ià(
¡¬t
)

444  
	`¿w_sÿn_nÚroÙ
(
sb
,
¡¬t
,
Çme
,
numb”
,
šo
,
»s_bh
,
»s_de
);

445  
	`¿w_sÿn_roÙ
(
sb
,
Çme
,
numb”
,
šo
,
»s_bh
,
»s_de
);

446 
	}
}

455 
	$msdos_·»Á_šo
(
šode
 *
dœ
,
locked
)

457 
z”o
 = 0;

458 
”rÜ
,
cu¼’t
,
´ev
,
Ä
;

460 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)è
	`·nic
("Non-directory fedo m_p_i");

461 ià(
dœ
->
i_šo
 =ğ
MSDOS_ROOT_INO
)  dir->i_ino;

462 ià(!
locked
è
	`lock_ü—tiÚ
();

463 ià((
cu¼’t
 = 
	`¿w_sÿn
(
dœ
->
i_sb
,
	`MSDOS_I
(dœ)->
i_¡¬t
,
MSDOS_DOTDOT
,

464 &
z”o
,
NULL
,NULL,NULL)) < 0) {

465 ià(!
locked
è
	`uÆock_ü—tiÚ
();

466  
cu¼’t
;

468 ià(!
cu¼’t
è
Ä
 = 
MSDOS_ROOT_INO
;

470 ià((
´ev
 = 
	`¿w_sÿn
(
dœ
->
i_sb
,
cu¼’t
,
MSDOS_DOTDOT
,&
z”o
,
NULL
,

471 
NULL
,NULL)) < 0) {

472 ià(!
locked
è
	`uÆock_ü—tiÚ
();

473  
´ev
;

475 ià((
”rÜ
 = 
	`¿w_sÿn
(
dœ
->
i_sb
,
´ev
,
NULL
,&
cu¼’t
,&
Ä
,NULL,

476 
NULL
)) < 0) {

477 ià(!
locked
è
	`uÆock_ü—tiÚ
();

478  
”rÜ
;

481 ià(!
locked
è
	`uÆock_ü—tiÚ
();

482  
Ä
;

483 
	}
}

491 
	$msdos_subdœs
(
šode
 *
dœ
)

493 
couÁ
;

495 
couÁ
 = 0;

496 ià(
dœ
->
i_šo
 =ğ
MSDOS_ROOT_INO
)

497 (è
	`¿w_sÿn_roÙ
(
dœ
->
i_sb
,
NULL
,&
couÁ
,NULL,NULL,NULL);

499 ià(!
	`MSDOS_I
(
dœ
)->
i_¡¬t
)  0;

500 (è
	`¿w_sÿn_nÚroÙ
(
dœ
->
i_sb
,
	`MSDOS_I
(dœ)->
i_¡¬t
,

501 
NULL
,&
couÁ
,NULL,NULL,NULL);

503  
couÁ
;

504 
	}
}

512 
	$msdos_sÿn
(
šode
 *
dœ
,*
Çme
,
bufãr_h—d
 **
»s_bh
,

513 
msdos_dœ_’Œy
 **
»s_de
,*
šo
)

515 
»s
;

517 ià(
Çme
)

518 
»s
 = 
	`¿w_sÿn
(
dœ
->
i_sb
,
	`MSDOS_I
(dœ)->
i_¡¬t
,
Çme
,
NULL
,
šo
,

519 
»s_bh
,
»s_de
);

520 
»s
 = 
	`¿w_sÿn
(
dœ
->
i_sb
,
	`MSDOS_I
(dœ)->
i_¡¬t
,
NULL
,NULL,
šo
,

521 
»s_bh
,
»s_de
);

522  
»s
 < 0 ?„es : 0;

523 
	}
}

	@fs/msdos/namei.c

7 
	~<asm/£gm’t.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/msdos_fs.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/¡©.h
>

18 *
	g»£rved_Çmes
[] = {

22 
NULL
 };

27 
	gbad_ch¬s
[] = "*?<>|\"";

28 
	gbad_if_¡riù
[] = "+=,; ";

33 
	$msdos_fÜm©_Çme
(
cÚv
,cÚ¡ *
Çme
,
Ën
,*
»s
,

34 
dÙ_dœs
)

36 *
w®k
,**
»£rved
;

37 
c
;

38 
¥aû
;

40 ià(
	`IS_FREE
(
Çme
)è -
EINVAL
;

41 ià(
Çme
[0] =ğ'.' && (
Ën
 == 1 || (len == 2 &&‚ame[1] == '.'))) {

42 ià(!
dÙ_dœs
è -
EEXIST
;

43 
	`mem£t
(
»s
+1,' ',10);

44 
Ën
--è*
»s
++ = '.';

47 
¥aû
 = 1;

48 
c
 = 0;

49 
w®k
 = 
»s
; 
Ën
 && walk-res < 8; walk++) {

50 
c
 = *
Çme
++;

51 
Ën
--;

52 ià(
cÚv
 !ğ'r' && 
	`¡rchr
(
bad_ch¬s
,
c
)è -
EINVAL
;

53 ià(
cÚv
 =ğ's' && 
	`¡rchr
(
bad_if_¡riù
,
c
)è -
EINVAL
;

54 ià(
c
 >ğ'A' && c <ğ'Z' && 
cÚv
 =ğ's'è -
EINVAL
;

55 ià(
c
 < ' ' || c =ğ':' || c =ğ'\\'è -
EINVAL
;

56 ià(
c
 == '.') ;

57 
¥aû
 = 
c
 == ' ';

58 *
w®k
 = 
c
 >= 'a' && c <= 'z' ? c-32 : c;

60 ià(
¥aû
è -
EINVAL
;

61 ià(
cÚv
 =ğ's' && 
Ën
 && 
c
 != '.') {

62 
c
 = *
Çme
++;

63 
Ën
--;

64 ià(
c
 !ğ'.'è -
EINVAL
;

66 
c
 !ğ'.' && 
Ën
--èøğ*
Çme
++;

67 ià(
c
 == '.') {

68 
w®k
-
»s
 < 8) *walk++ = ' ';

69 
Ën
 > 0 && 
w®k
-
»s
 < 
MSDOS_NAME
) {

70 
c
 = *
Çme
++;

71 
Ën
--;

72 ià(
cÚv
 !ğ'r' && 
	`¡rchr
(
bad_ch¬s
,
c
)è -
EINVAL
;

73 ià(
cÚv
 =ğ's' && 
	`¡rchr
(
bad_if_¡riù
,
c
))

74  -
EINVAL
;

75 ià(
c
 < ' ' || c == ':' || c == '\\' || c == '.')

76  -
EINVAL
;

77 ià(
c
 >ğ'A' && c <ğ'Z' && 
cÚv
 =ğ's'è -
EINVAL
;

78 
¥aû
 = 
c
 == ' ';

79 *
w®k
++ = 
c
 >= 'a' && c <= 'z' ? c-32 : c;

81 ià(
¥aû
è -
EINVAL
;

82 ià(
cÚv
 =ğ's' && 
Ën
è -
EINVAL
;

84 
w®k
-
»s
 < 
MSDOS_NAME
) *walk++ = ' ';

85 
»£rved
 = 
»£rved_Çmes
; *reserved;„eserved++)

86 ià(!
	`¡ºcmp
(
»s
,*
»£rved
,8)è -
EINVAL
;

88 
	}
}

93 
	$msdos_fšd
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,

94 
bufãr_h—d
 **
bh
,
msdos_dœ_’Œy
 **
de
,*
šo
)

96 
msdos_Çme
[
MSDOS_NAME
];

97 
»s
;

99 ià((
»s
 = 
	`msdos_fÜm©_Çme
(
	`MSDOS_SB
(
dœ
->
i_sb
)->
Çme_check
,
Çme
,
Ën
,

100 
msdos_Çme
,1)è< 0è 
»s
;

101  
	`msdos_sÿn
(
dœ
,
msdos_Çme
,
bh
,
de
,
šo
);

102 
	}
}

105 
	$msdos_lookup
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,

106 
šode
 **
»suÉ
)

108 
šo
,
»s
;

109 
msdos_dœ_’Œy
 *
de
;

110 
bufãr_h—d
 *
bh
;

111 
šode
 *
Ãxt
;

113 *
»suÉ
 = 
NULL
;

114 ià(!
dœ
è -
ENOENT
;

115 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

116 
	`ut
(
dœ
);

117  -
ENOENT
;

119 ià(
Ën
 =ğ1 && 
Çme
[0] == '.') {

120 *
»suÉ
 = 
dœ
;

123 ià(
Ën
 =ğ2 && 
Çme
[0] == '.' &&‚ame[1] == '.') {

124 
šo
 = 
	`msdos_·»Á_šo
(
dœ
,0);

125 
	`ut
(
dœ
);

126 ià(
šo
 < 0)  ino;

127 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))è -
EACCES
;

130 ià((
»s
 = 
	`msdos_fšd
(
dœ
,
Çme
,
Ën
,&
bh
,&
de
,&
šo
)) < 0) {

131 
	`ut
(
dœ
);

132  
»s
;

134 ià(
bh
è
	`b»l£
(bh);

136 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

137 
	`ut
(
dœ
);

138  -
EACCES
;

140 ià(
	`MSDOS_I
(*
»suÉ
)->
i_busy
) {

141 
	`ut
(*
»suÉ
);

142 
	`ut
(
dœ
);

143  -
ENOENT
;

145 
	`MSDOS_I
(*
»suÉ
)->
i_Şd
) {

146 
Ãxt
 = 
	`MSDOS_I
(*
»suÉ
)->
i_Şd
;

147 
	`ut
(*
»suÉ
);

148 ià(!(*
»suÉ
 = 
	`ig‘
(
Ãxt
->
i_sb
,Ãxt->
i_šo
))) {

149 
	`fs_·nic
(
dœ
->
i_sb
,"msdos_lookup: Can't happen");

150 
	`ut
(
dœ
);

151  -
ENOENT
;

154 
	`ut
(
dœ
);

156 
	}
}

161 
	$msdos_ü—‹_’Œy
(
šode
 *
dœ
,*
Çme
,
is_dœ
,

162 
šode
 **
»suÉ
)

164 
bufãr_h—d
 *
bh
;

165 
msdos_dœ_’Œy
 *
de
;

166 
»s
,
šo
;

168 ià((
»s
 = 
	`msdos_sÿn
(
dœ
,
NULL
,&
bh
,&
de
,&
šo
)) < 0) {

169 ià(
»s
 !ğ-
ENOENT
) „es;

170 ià(
dœ
->
i_šo
 =ğ
MSDOS_ROOT_INO
è -
ENOSPC
;

171 ià((
»s
 = 
	`msdos_add_şu¡”
(
dœ
)) < 0) „es;

172 ià((
»s
 = 
	`msdos_sÿn
(
dœ
,
NULL
,&
bh
,&
de
,&
šo
)) < 0) „es;

177 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

178 
dœ
->
i_dœt
 = 1;

179 
	`memıy
(
de
->
Çme
,Çme,
MSDOS_NAME
);

180 
de
->
©Œ
 = 
is_dœ
 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

181 
de
->
¡¬t
 = 0;

182 
	`d©e_unix2dos
(
dœ
->
i_mtime
,&
de
->
time
,&de->
d©e
);

183 
de
->
size
 = 0;

184 
bh
->
b_dœt
 = 1;

185 ià((*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
)è!ğ
NULL
)

186 
	`msdos_»ad_šode
(*
»suÉ
);

187 
	`b»l£
(
bh
);

188 ià(!*
»suÉ
è -
EIO
;

189 (*
»suÉ
)->
i_mtime
 = (*»suÉ)->
i_©ime
 = (*»suÉ)->
i_ùime
 =

190 
CURRENT_TIME
;

191 (*
»suÉ
)->
i_dœt
 = 1;

193 
	}
}

196 
	$msdos_ü—‹
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,
mode
,

197 
šode
 **
»suÉ
)

199 
bufãr_h—d
 *
bh
;

200 
msdos_dœ_’Œy
 *
de
;

201 
msdos_Çme
[
MSDOS_NAME
];

202 
šo
,
»s
;

204 ià(!
dœ
è -
ENOENT
;

205 ià((
»s
 = 
	`msdos_fÜm©_Çme
(
	`MSDOS_SB
(
dœ
->
i_sb
)->
Çme_check
,
Çme
,
Ën
,

206 
msdos_Çme
,0)) < 0) {

207 
	`ut
(
dœ
);

208  
»s
;

210 
	`lock_ü—tiÚ
();

211 ià(
	`msdos_sÿn
(
dœ
,
msdos_Çme
,&
bh
,&
de
,&
šo
) >= 0) {

212 
	`uÆock_ü—tiÚ
();

213 
	`b»l£
(
bh
);

214 
	`ut
(
dœ
);

215  -
EEXIST
;

217 
»s
 = 
	`msdos_ü—‹_’Œy
(
dœ
,
msdos_Çme
,
	`S_ISDIR
(
mode
),
»suÉ
);

218 
	`uÆock_ü—tiÚ
();

219 
	`ut
(
dœ
);

220  
»s
;

221 
	}
}

224 #ifdeà
DEBUG


226 
	$dump_çt
(
su³r_block
 *
sb
,
¡¬t
)

228 
	`´štk
("[");

229 
¡¬t
) {

230 
	`´štk
("%d ",
¡¬t
);

231 
¡¬t
 = 
	`çt_acûss
(
sb
,start,-1);

232 ià(!
¡¬t
) {

233 
	`´štk
("ERROR");

236 ià(
¡¬t
 == -1) ;

238 
	`´štk
("]\n");

239 
	}
}

244 
	$msdos_mkdœ
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,
mode
)

246 
bufãr_h—d
 *
bh
;

247 
msdos_dœ_’Œy
 *
de
;

248 
šode
 *šode,*
dÙ
;

249 
msdos_Çme
[
MSDOS_NAME
];

250 
šo
,
»s
;

252 ià((
»s
 = 
	`msdos_fÜm©_Çme
(
	`MSDOS_SB
(
dœ
->
i_sb
)->
Çme_check
,
Çme
,
Ën
,

253 
msdos_Çme
,0)) < 0) {

254 
	`ut
(
dœ
);

255  
»s
;

257 
	`lock_ü—tiÚ
();

258 ià(
	`msdos_sÿn
(
dœ
,
msdos_Çme
,&
bh
,&
de
,&
šo
) >= 0) {

259 
	`uÆock_ü—tiÚ
();

260 
	`b»l£
(
bh
);

261 
	`ut
(
dœ
);

262  -
EEXIST
;

264 ià((
»s
 = 
	`msdos_ü—‹_’Œy
(
dœ
,
msdos_Çme
,1,&
šode
)) < 0) {

265 
	`uÆock_ü—tiÚ
();

266 
	`ut
(
dœ
);

267  
»s
;

269 
dœ
->
i_Æšk
++;

270 
šode
->
i_Æšk
 = 2;

271 
	`MSDOS_I
(
šode
)->
i_busy
 = 1;

272 ià((
»s
 = 
	`msdos_add_şu¡”
(
šode
)è< 0è
mkdœ_”rÜ
;

273 ià((
»s
 = 
	`msdos_ü—‹_’Œy
(
šode
,
MSDOS_DOT
,1,&
dÙ
)) < 0)

274 
mkdœ_”rÜ
;

275 
dÙ
->
i_size
 = 
šode
->i_size;

276 
	`MSDOS_I
(
dÙ
)->
i_¡¬t
 = MSDOS_I(
šode
)->i_start;

277 
dÙ
->
i_Æšk
 = 
šode
->i_nlink;

278 
dÙ
->
i_dœt
 = 1;

279 
	`ut
(
dÙ
);

280 ià((
»s
 = 
	`msdos_ü—‹_’Œy
(
šode
,
MSDOS_DOTDOT
,1,&
dÙ
)) < 0)

281 
mkdœ_”rÜ
;

282 
	`uÆock_ü—tiÚ
();

283 
dÙ
->
i_size
 = 
dœ
->i_size;

284 
	`MSDOS_I
(
dÙ
)->
i_¡¬t
 = MSDOS_I(
dœ
)->i_start;

285 
dÙ
->
i_Æšk
 = 
dœ
->i_nlink;

286 
dÙ
->
i_dœt
 = 1;

287 
	`MSDOS_I
(
šode
)->
i_busy
 = 0;

288 
	`ut
(
dÙ
);

289 
	`ut
(
šode
);

290 
	`ut
(
dœ
);

292 
mkdœ_”rÜ
:

293 
	`ut
(
šode
);

294 ià(
	`msdos_rmdœ
(
dœ
,
Çme
,
Ën
) < 0)

295 
	`fs_·nic
(
dœ
->
i_sb
,"rmdir in mkdir failed");

296 
	`uÆock_ü—tiÚ
();

297  
»s
;

298 
	}
}

301 
	$msdos_em±y
(
šode
 *
dœ
)

303 
off_t
 
pos
;

304 
bufãr_h—d
 *
bh
;

305 
msdos_dœ_’Œy
 *
de
;

307 ià(
dœ
->
i_couÁ
 > 1)

308  -
EBUSY
;

309 ià(
	`MSDOS_I
(
dœ
)->
i_¡¬t
) {

310 
pos
 = 0;

311 
bh
 = 
NULL
;

312 
	`msdos_g‘_’Œy
(
dœ
,&
pos
,&
bh
,&
de
) > -1)

313 ià(!
	`IS_FREE
(
de
->
Çme
è&& 
	`¡ºcmp
(de->Çme,
MSDOS_DOT
,

314 
MSDOS_NAME
è&& 
	`¡ºcmp
(
de
->
Çme
,
MSDOS_DOTDOT
,

315 
MSDOS_NAME
)) {

316 
	`b»l£
(
bh
);

317  -
ENOTEMPTY
;

319 ià(
bh
)

320 
	`b»l£
(
bh
);

323 
	}
}

326 
	$msdos_rmdœ
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
)

328 
»s
,
šo
;

329 
bufãr_h—d
 *
bh
;

330 
msdos_dœ_’Œy
 *
de
;

331 
šode
 *inode;

333 
bh
 = 
NULL
;

334 
šode
 = 
NULL
;

335 
»s
 = -
EPERM
;

336 ià(
Çme
[0] =ğ'.' && (
Ën
 == 1 || (len == 2 &&‚ame[1] == '.')))

337 
rmdœ_dÚe
;

338 ià((
»s
 = 
	`msdos_fšd
(
dœ
,
Çme
,
Ën
,&
bh
,&
de
,&
šo
)è< 0è
rmdœ_dÚe
;

339 
»s
 = -
ENOENT
;

340 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))è
rmdœ_dÚe
;

341 
»s
 = -
ENOTDIR
;

342 ià(!
	`S_ISDIR
(
šode
->
i_mode
)è
rmdœ_dÚe
;

343 
»s
 = -
EBUSY
;

344 ià(
dœ
->
i_dev
 !ğ
šode
->i_dev || dœ =ğšodeè
rmdœ_dÚe
;

345 
»s
 = 
	`msdos_em±y
(
šode
);

346 ià(
»s
)

347 
rmdœ_dÚe
;

348 
šode
->
i_Æšk
 = 0;

349 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

350 
dœ
->
i_Æšk
--;

351 
šode
->
i_dœt
 = 
dœ
->i_dirt = 1;

352 
de
->
Çme
[0] = 
DELETED_FLAG
;

353 
bh
->
b_dœt
 = 1;

354 
»s
 = 0;

355 
rmdœ_dÚe
:

356 
	`b»l£
(
bh
);

357 
	`ut
(
dœ
);

358 
	`ut
(
šode
);

359  
»s
;

360 
	}
}

363 
	$msdos_uÆšk
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
)

365 
»s
,
šo
;

366 
bufãr_h—d
 *
bh
;

367 
msdos_dœ_’Œy
 *
de
;

368 
šode
 *inode;

370 
bh
 = 
NULL
;

371 
šode
 = 
NULL
;

372 ià((
»s
 = 
	`msdos_fšd
(
dœ
,
Çme
,
Ën
,&
bh
,&
de
,&
šo
)) < 0)

373 
uÆšk_dÚe
;

374 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

375 
»s
 = -
ENOENT
;

376 
uÆšk_dÚe
;

378 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

379 
»s
 = -
EPERM
;

380 
uÆšk_dÚe
;

382 
šode
->
i_Æšk
 = 0;

383 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

384 
	`MSDOS_I
(
šode
)->
i_busy
 = 1;

385 
šode
->
i_dœt
 = 
dœ
->i_dirt = 1;

386 
de
->
Çme
[0] = 
DELETED_FLAG
;

387 
bh
->
b_dœt
 = 1;

388 
uÆšk_dÚe
:

389 
	`b»l£
(
bh
);

390 
	`ut
(
šode
);

391 
	`ut
(
dœ
);

392  
»s
;

393 
	}
}

396 
	$»Çme_§me_dœ
(
šode
 *
Şd_dœ
,*
Şd_Çme
,

397 
šode
 *
Ãw_dœ
,*
Ãw_Çme
,
bufãr_h—d
 *
Şd_bh
,

398 
msdos_dœ_’Œy
 *
Şd_de
,
Şd_šo
)

400 
bufãr_h—d
 *
Ãw_bh
;

401 
msdos_dœ_’Œy
 *
Ãw_de
;

402 
šode
 *
Ãw_šode
,*
Şd_šode
;

403 
Ãw_šo
,
exi¡s
,
”rÜ
;

405 ià(!
	`¡ºcmp
(
Şd_Çme
,
Ãw_Çme
,
MSDOS_NAME
))  0;

406 
exi¡s
 = 
	`msdos_sÿn
(
Ãw_dœ
,
Ãw_Çme
,&
Ãw_bh
,&
Ãw_de
,&
Ãw_šo
) >= 0;

407 ià(*(*è
Şd_de
->
Çme
 =ğ
DELETED_FLAG
) {

408 ià(
exi¡s
è
	`b»l£
(
Ãw_bh
);

409  -
ENOENT
;

411 ià(
exi¡s
) {

412 ià(!(
Ãw_šode
 = 
	`ig‘
(
Ãw_dœ
->
i_sb
,
Ãw_šo
))) {

413 
	`b»l£
(
Ãw_bh
);

414  -
EIO
;

416 
”rÜ
 = 
	`S_ISDIR
(
Ãw_šode
->
i_mode
è? (
Şd_de
->
©Œ
 & 
ATTR_DIR
) ?

417 
	`msdos_em±y
(
Ãw_šode
è: -
EPERM
 : (
Şd_de
->
©Œ
 & 
ATTR_DIR
)

418 ? -
EPERM
 : 0;

419 ià(
”rÜ
) {

420 
	`ut
(
Ãw_šode
);

421 
	`b»l£
(
Ãw_bh
);

422  
”rÜ
;

424 ià(
	`S_ISDIR
(
Ãw_šode
->
i_mode
)) {

425 
Ãw_dœ
->
i_Æšk
--;

426 
Ãw_dœ
->
i_dœt
 = 1;

428 
Ãw_šode
->
i_Æšk
 = 0;

429 
	`MSDOS_I
(
Ãw_šode
)->
i_busy
 = 1;

430 
Ãw_šode
->
i_dœt
 = 1;

431 
Ãw_de
->
Çme
[0] = 
DELETED_FLAG
;

432 
Ãw_bh
->
b_dœt
 = 1;

433 
	`ut
(
Ãw_šode
);

434 
	`b»l£
(
Ãw_bh
);

436 
	`memıy
(
Şd_de
->
Çme
,
Ãw_Çme
,
MSDOS_NAME
);

437 
Şd_bh
->
b_dœt
 = 1;

438 ià(
	`MSDOS_SB
(
Şd_dœ
->
i_sb
)->
cÚv”siÚ
 == 'a')

439 ià((
Şd_šode
 = 
	`ig‘
(
Şd_dœ
->
i_sb
,
Şd_šo
)è!ğ
NULL
) {

440 
	`msdos_»ad_šode
(
Şd_šode
);

441 
	`ut
(
Şd_šode
);

444 
	}
}

447 
	$»Çme_diff_dœ
(
šode
 *
Şd_dœ
,*
Şd_Çme
,

448 
šode
 *
Ãw_dœ
,*
Ãw_Çme
,
bufãr_h—d
 *
Şd_bh
,

449 
msdos_dœ_’Œy
 *
Şd_de
,
Şd_šo
)

451 
bufãr_h—d
 *
Ãw_bh
,*
ä“_bh
,*
dÙdÙ_bh
;

452 
msdos_dœ_’Œy
 *
Ãw_de
,*
ä“_de
,*
dÙdÙ_de
;

453 
šode
 *
Şd_šode
,*
Ãw_šode
,*
ä“_šode
,*
dÙdÙ_šode
,*
w®k
;

454 
Ãw_šo
,
ä“_šo
,
dÙdÙ_šo
;

455 
”rÜ
,
exi¡s
,
šo
;

457 ià(
Şd_dœ
->
i_dev
 !ğ
Ãw_dœ
->i_devè -
EINVAL
;

458 ià(
Şd_šo
 =ğ
Ãw_dœ
->
i_šo
è -
EINVAL
;

459 ià(!(
w®k
 = 
	`ig‘
(
Ãw_dœ
->
i_sb
,Ãw_dœ->
i_šo
))è -
EIO
;

460 
w®k
->
i_šo
 !ğ
MSDOS_ROOT_INO
) {

461 
šo
 = 
	`msdos_·»Á_šo
(
w®k
,1);

462 
	`ut
(
w®k
);

463 ià(
šo
 < 0)  ino;

464 ià(
šo
 =ğ
Şd_šo
è -
EINVAL
;

465 ià(!(
w®k
 = 
	`ig‘
(
Ãw_dœ
->
i_sb
,
šo
))è -
EIO
;

467 
	`ut
(
w®k
);

468 (
”rÜ
 = 
	`msdos_sÿn
(
Ãw_dœ
,
NULL
,&
ä“_bh
,&
ä“_de
,&
ä“_šo
)) <

470 ià(
”rÜ
 !ğ-
ENOENT
) ƒrror;

471 
”rÜ
 = 
	`msdos_add_şu¡”
(
Ãw_dœ
);

472 ià(
”rÜ
) ƒrror;

474 
exi¡s
 = 
	`msdos_sÿn
(
Ãw_dœ
,
Ãw_Çme
,&
Ãw_bh
,&
Ãw_de
,&
Ãw_šo
) >= 0;

475 ià(!(
Şd_šode
 = 
	`ig‘
(
Şd_dœ
->
i_sb
,
Şd_šo
))) {

476 
	`b»l£
(
ä“_bh
);

477 ià(
exi¡s
è
	`b»l£
(
Ãw_bh
);

478  -
EIO
;

480 ià(*(*è
Şd_de
->
Çme
 =ğ
DELETED_FLAG
) {

481 
	`ut
(
Şd_šode
);

482 
	`b»l£
(
ä“_bh
);

483 ià(
exi¡s
è
	`b»l£
(
Ãw_bh
);

484  -
ENOENT
;

486 
Ãw_šode
 = 
NULL
;

487 ià(
exi¡s
) {

488 ià(!(
Ãw_šode
 = 
	`ig‘
(
Ãw_dœ
->
i_sb
,
Ãw_šo
))) {

489 
	`ut
(
Şd_šode
);

490 
	`b»l£
(
Ãw_bh
);

491  -
EIO
;

493 
”rÜ
 = 
	`S_ISDIR
(
Ãw_šode
->
i_mode
è? (
Şd_de
->
©Œ
 & 
ATTR_DIR
) ?

494 
	`msdos_em±y
(
Ãw_šode
è: -
EPERM
 : (
Şd_de
->
©Œ
 & 
ATTR_DIR
)

495 ? -
EPERM
 : 0;

496 ià(
”rÜ
) {

497 
	`ut
(
Ãw_šode
);

498 
	`ut
(
Şd_šode
);

499 
	`b»l£
(
Ãw_bh
);

500  
”rÜ
;

502 
Ãw_šode
->
i_Æšk
 = 0;

503 
	`MSDOS_I
(
Ãw_šode
)->
i_busy
 = 1;

504 
Ãw_šode
->
i_dœt
 = 1;

505 
Ãw_de
->
Çme
[0] = 
DELETED_FLAG
;

506 
Ãw_bh
->
b_dœt
 = 1;

508 
	`memıy
(
ä“_de
,
Şd_de
,(
msdos_dœ_’Œy
));

509 
	`memıy
(
ä“_de
->
Çme
,
Ãw_Çme
,
MSDOS_NAME
);

510 ià(!(
ä“_šode
 = 
	`ig‘
(
Ãw_dœ
->
i_sb
,
ä“_šo
))) {

511 
ä“_de
->
Çme
[0] = 
DELETED_FLAG
;

513 
	`b»l£
(
ä“_bh
);

514 ià(
exi¡s
) {

515 
	`ut
(
Ãw_šode
);

516 
	`b»l£
(
Ãw_bh
);

518  -
EIO
;

520 ià(
exi¡s
 && 
	`S_ISDIR
(
Ãw_šode
->
i_mode
)) {

521 
Ãw_dœ
->
i_Æšk
--;

522 
Ãw_dœ
->
i_dœt
 = 1;

524 
	`msdos_»ad_šode
(
ä“_šode
);

525 
	`MSDOS_I
(
Şd_šode
)->
i_busy
 = 1;

526 
	`ÿche_šv®_šode
(
Şd_šode
);

527 
Şd_šode
->
i_dœt
 = 1;

528 
Şd_de
->
Çme
[0] = 
DELETED_FLAG
;

529 
Şd_bh
->
b_dœt
 = 1;

530 
ä“_bh
->
b_dœt
 = 1;

531 ià(!
exi¡s
è
	`ut
(
ä“_šode
);

533 
	`MSDOS_I
(
Ãw_šode
)->
i_d•’d
 = 
ä“_šode
;

534 
	`MSDOS_I
(
ä“_šode
)->
i_Şd
 = 
Ãw_šode
;

536 
	`ut
(
Ãw_šode
);

537 
	`b»l£
(
Ãw_bh
);

539 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

540 ià((
”rÜ
 = 
	`msdos_sÿn
(
Şd_šode
,
MSDOS_DOTDOT
,&
dÙdÙ_bh
,

541 &
dÙdÙ_de
,&
dÙdÙ_šo
)è< 0è
»Çme_dÚe
;

542 ià(!(
dÙdÙ_šode
 = 
	`ig‘
(
Şd_šode
->
i_sb
,
dÙdÙ_šo
))) {

543 
	`b»l£
(
dÙdÙ_bh
);

544 
”rÜ
 = -
EIO
;

545 
»Çme_dÚe
;

547 
dÙdÙ_de
->
¡¬t
 = 
	`MSDOS_I
(
dÙdÙ_šode
)->
i_¡¬t
 =

548 
	`MSDOS_I
(
Ãw_dœ
)->
i_¡¬t
;

549 
dÙdÙ_šode
->
i_dœt
 = 1;

550 
dÙdÙ_bh
->
b_dœt
 = 1;

551 
Şd_dœ
->
i_Æšk
--;

552 
Ãw_dœ
->
i_Æšk
++;

554 
dÙdÙ_šode
->
i_Æšk
 = 
Ãw_dœ
->i_nlink;

555 
	`ut
(
dÙdÙ_šode
);

556 
	`b»l£
(
dÙdÙ_bh
);

558 
”rÜ
 = 0;

559 
»Çme_dÚe
:

560 
	`b»l£
(
ä“_bh
);

561 
	`ut
(
Şd_šode
);

562  
”rÜ
;

563 
	}
}

566 
	$msdos_»Çme
(
šode
 *
Şd_dœ
,cÚ¡ *
Şd_Çme
,
Şd_Ën
,

567 
šode
 *
Ãw_dœ
,cÚ¡ *
Ãw_Çme
,
Ãw_Ën
)

569 
Şd_msdos_Çme
[
MSDOS_NAME
],
Ãw_msdos_Çme
[MSDOS_NAME];

570 
bufãr_h—d
 *
Şd_bh
;

571 
msdos_dœ_’Œy
 *
Şd_de
;

572 
Şd_šo
,
”rÜ
;

574 ià((
”rÜ
 = 
	`msdos_fÜm©_Çme
(
	`MSDOS_SB
(
Şd_dœ
->
i_sb
)->
Çme_check
,

575 
Şd_Çme
,
Şd_Ën
,
Şd_msdos_Çme
,1)è< 0è
»Çme_dÚe
;

576 ià((
”rÜ
 = 
	`msdos_fÜm©_Çme
(
	`MSDOS_SB
(
Ãw_dœ
->
i_sb
)->
Çme_check
,

577 
Ãw_Çme
,
Ãw_Ën
,
Ãw_msdos_Çme
,0)è< 0è
»Çme_dÚe
;

578 ià((
”rÜ
 = 
	`msdos_sÿn
(
Şd_dœ
,
Şd_msdos_Çme
,&
Şd_bh
,&
Şd_de
,

579 &
Şd_šo
)è< 0è
»Çme_dÚe
;

580 
	`lock_ü—tiÚ
();

581 ià(
Şd_dœ
 =ğ
Ãw_dœ
)

582 
”rÜ
 = 
	`»Çme_§me_dœ
(
Şd_dœ
,
Şd_msdos_Çme
,
Ãw_dœ
,

583 
Ãw_msdos_Çme
,
Şd_bh
,
Şd_de
,
Şd_šo
);

584 
”rÜ
 = 
	`»Çme_diff_dœ
(
Şd_dœ
,
Şd_msdos_Çme
,
Ãw_dœ
,

585 
Ãw_msdos_Çme
,
Şd_bh
,
Şd_de
,
Şd_šo
);

586 
	`uÆock_ü—tiÚ
();

587 
	`b»l£
(
Şd_bh
);

588 
»Çme_dÚe
:

589 
	`ut
(
Şd_dœ
);

590 
	`ut
(
Ãw_dœ
);

591  
”rÜ
;

592 
	}
}

	@fs/namei.c

11 
	~<asm/£gm’t.h
>

13 
	~<lšux/”ºo.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/fú.h
>

18 
	~<lšux/¡©.h
>

20 
	#ACC_MODE
(
x
è("\000\004\002\006"[(x)&
O_ACCMODE
])

	)

29 
	$g‘Çme
(cÚ¡ * 
f’ame
, **
»suÉ
)

31 
”rÜ
;

32 
i
, 
·ge
;

33 * 
tmp
, 
c
;

35 
i
 = (è
f’ame
;

36 ià(!
i
 || i >ğ
TASK_SIZE
)

37  -
EFAULT
;

38 
i
 = 
TASK_SIZE
 - i;

39 
”rÜ
 = -
EFAULT
;

40 ià(
i
 > 
PAGE_SIZE
) {

41 
i
 = 
PAGE_SIZE
;

42 
”rÜ
 = -
ENAMETOOLONG
;

44 
c
 = 
	`g‘_fs_by‹
(
f’ame
++);

45 ià(!
c
)

46  -
ENOENT
;

47 if(!(
·ge
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

48  -
ENOMEM
;

49 *
»suÉ
 = 
tmp
 = (*è
·ge
;

50 --
i
) {

51 *(
tmp
++èğ
c
;

52 
c
 = 
	`g‘_fs_by‹
(
f’ame
++);

53 ià(!
c
) {

54 *
tmp
 = '\0';

58 
	`ä“_·ge
(
·ge
);

59  
”rÜ
;

60 
	}
}

62 
	$puŠame
(* 
Çme
)

64 
	`ä“_·ge
((è
Çme
);

65 
	}
}

74 
	$³rmissiÚ
(
šode
 * inode,
mask
)

76 
mode
 = 
šode
->
i_mode
;

78 ià(
šode
->
i_İ
 && inode->i_İ->
³rmissiÚ
)

79  
šode
->
i_İ
->
	`³rmissiÚ
(šode, 
mask
);

80 ià(
cu¼’t
->
euid
 =ğ
šode
->
i_uid
)

81 
mode
 >>= 6;

82 ià(
	`š_group_p
(
šode
->
i_gid
))

83 
mode
 >>= 3;

84 ià(((
mode
 & 
mask
 & 0007è=ğmaskè|| 
	`su£r
())

87 
	}
}

94 
	$lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

95 
šode
 ** 
»suÉ
)

97 
su³r_block
 * 
sb
;

98 
³rm
;

100 *
»suÉ
 = 
NULL
;

101 ià(!
dœ
)

102  -
ENOENT
;

104 
³rm
 = 
	`³rmissiÚ
(
dœ
,
MAY_EXEC
);

105 ià(
Ën
==2 && 
Çme
[0] == '.' &&‚ame[1] == '.') {

106 ià(
dœ
 =ğ
cu¼’t
->
roÙ
) {

107 *
»suÉ
 = 
dœ
;

109 } ià((
sb
 = 
dœ
->
i_sb
è&& (dœ =ğsb->
s_mouÁed
)) {

110 
sb
 = 
dœ
->
i_sb
;

111 
	`ut
(
dœ
);

112 
dœ
 = 
sb
->
s_cov”ed
;

113 ià(!
dœ
)

114  -
ENOENT
;

115 
dœ
->
i_couÁ
++;

118 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
lookup
) {

119 
	`ut
(
dœ
);

120  -
ENOTDIR
;

122 ià(!
³rm
) {

123 
	`ut
(
dœ
);

124  -
EACCES
;

126 ià(!
Ën
) {

127 *
»suÉ
 = 
dœ
;

130  
dœ
->
i_İ
->
	`lookup
(dœ,
Çme
,
Ën
,
»suÉ
);

131 
	}
}

133 
	$fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

134 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

136 ià(!
dœ
 || !
šode
) {

137 
	`ut
(
dœ
);

138 
	`ut
(
šode
);

139 *
»s_šode
 = 
NULL
;

140  -
ENOENT
;

142 ià(!
šode
->
i_İ
 || !šode->i_İ->
fŞlow_lšk
) {

143 
	`ut
(
dœ
);

144 *
»s_šode
 = 
šode
;

147  
šode
->
i_İ
->
	`fŞlow_lšk
(
dœ
,šode,
æag
,
mode
,
»s_šode
);

148 
	}
}

156 
	$dœ_Çmei
(cÚ¡ * 
·thÇme
, * 
Çm–’
, cÚ¡ ** 
Çme
,

157 
šode
 * 
ba£
, šod** 
»s_šode
)

159 
c
;

160 cÚ¡ * 
thi¢ame
;

161 
Ën
,
”rÜ
;

162 
šode
 * inode;

164 *
»s_šode
 = 
NULL
;

165 ià(!
ba£
) {

166 
ba£
 = 
cu¼’t
->
pwd
;

167 
ba£
->
i_couÁ
++;

169 ià((
c
 = *
·thÇme
) == '/') {

170 
	`ut
(
ba£
);

171 
ba£
 = 
cu¼’t
->
roÙ
;

172 
·thÇme
++;

173 
ba£
->
i_couÁ
++;

176 
thi¢ame
 = 
·thÇme
;

177 
Ën
=0;(
c
 = *(
·thÇme
++))&&(c != '/');len++)

179 ià(!
c
)

181 
ba£
->
i_couÁ
++;

182 
”rÜ
 = 
	`lookup
(
ba£
,
thi¢ame
,
Ën
,&
šode
);

183 ià(
”rÜ
) {

184 
	`ut
(
ba£
);

185  
”rÜ
;

187 
”rÜ
 = 
	`fŞlow_lšk
(
ba£
,
šode
,0,0,&base);

188 ià(
”rÜ
)

189  
”rÜ
;

191 ià(!
ba£
->
i_İ
 || !ba£->i_İ->
lookup
) {

192 
	`ut
(
ba£
);

193  -
ENOTDIR
;

195 *
Çme
 = 
thi¢ame
;

196 *
Çm–’
 = 
Ën
;

197 *
»s_šode
 = 
ba£
;

199 
	}
}

201 
	$_Çmei
(cÚ¡ * 
·thÇme
, 
šode
 * 
ba£
,

202 
fŞlow_lšks
, 
šode
 ** 
»s_šode
)

204 cÚ¡ * 
ba£Çme
;

205 
Çm–’
,
”rÜ
;

206 
šode
 * inode;

208 *
»s_šode
 = 
NULL
;

209 
”rÜ
 = 
	`dœ_Çmei
(
·thÇme
,&
Çm–’
,&
ba£Çme
,
ba£
,&base);

210 ià(
”rÜ
)

211  
”rÜ
;

212 
ba£
->
i_couÁ
++;

213 
”rÜ
 = 
	`lookup
(
ba£
,
ba£Çme
,
Çm–’
,&
šode
);

214 ià(
”rÜ
) {

215 
	`ut
(
ba£
);

216  
”rÜ
;

218 ià(
fŞlow_lšks
) {

219 
”rÜ
 = 
	`fŞlow_lšk
(
ba£
,
šode
,0,0,&inode);

220 ià(
”rÜ
)

221  
”rÜ
;

223 
	`ut
(
ba£
);

224 *
»s_šode
 = 
šode
;

226 
	}
}

228 
	$Êamei
(cÚ¡ * 
·thÇme
, 
šode
 ** 
»s_šode
)

230 
”rÜ
;

231 * 
tmp
;

233 
”rÜ
 = 
	`g‘Çme
(
·thÇme
,&
tmp
);

234 ià(!
”rÜ
) {

235 
”rÜ
 = 
	`_Çmei
(
tmp
,
NULL
,0,
»s_šode
);

236 
	`puŠame
(
tmp
);

238  
”rÜ
;

239 
	}
}

248 
	$Çmei
(cÚ¡ * 
·thÇme
, 
šode
 ** 
»s_šode
)

250 
”rÜ
;

251 * 
tmp
;

253 
”rÜ
 = 
	`g‘Çme
(
·thÇme
,&
tmp
);

254 ià(!
”rÜ
) {

255 
”rÜ
 = 
	`_Çmei
(
tmp
,
NULL
,1,
»s_šode
);

256 
	`puŠame
(
tmp
);

258  
”rÜ
;

259 
	}
}

274 
	$İ’_Çmei
(cÚ¡ * 
·thÇme
, 
æag
, 
mode
,

275 
šode
 ** 
»s_šode
, šod* 
ba£
)

277 cÚ¡ * 
ba£Çme
;

278 
Çm–’
,
”rÜ
;

279 
šode
 * 
dœ
, *inode;

280 
sk_¡ruù
 ** 
p
;

282 
mode
 &ğ
S_IALLUGO
 & ~
cu¼’t
->
umask
;

283 
mode
 |ğ
S_IFREG
;

284 
”rÜ
 = 
	`dœ_Çmei
(
·thÇme
,&
Çm–’
,&
ba£Çme
,
ba£
,&
dœ
);

285 ià(
”rÜ
)

286  
”rÜ
;

287 ià(!
Çm–’
) {

288 ià(
æag
 & 2) {

289 
	`ut
(
dœ
);

290  -
EISDIR
;

293 ià(!
	`³rmissiÚ
(
dœ
,
	`ACC_MODE
(
æag
))) {

294 
	`ut
(
dœ
);

295  -
EACCES
;

297 *
»s_šode
=
dœ
;

300 
dœ
->
i_couÁ
++;

301 ià(
æag
 & 
O_CREAT
) {

302 
	`down
(&
dœ
->
i_£m
);

303 
”rÜ
 = 
	`lookup
(
dœ
,
ba£Çme
,
Çm–’
,&
šode
);

304 ià(!
”rÜ
) {

305 ià(
æag
 & 
O_EXCL
) {

306 
	`ut
(
šode
);

307 
”rÜ
 = -
EEXIST
;

309 } ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
))

310 
”rÜ
 = -
EACCES
;

311 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
ü—‹
)

312 
”rÜ
 = -
EACCES
;

313 ià(
	`IS_RDONLY
(
dœ
))

314 
”rÜ
 = -
EROFS
;

316 
dœ
->
i_couÁ
++;

317 
”rÜ
 = 
dœ
->
i_İ
->
	`ü—‹
(dœ,
ba£Çme
,
Çm–’
,
mode
,
»s_šode
);

318 
	`up
(&
dœ
->
i_£m
);

319 
	`ut
(
dœ
);

320  
”rÜ
;

322 
	`up
(&
dœ
->
i_£m
);

324 
”rÜ
 = 
	`lookup
(
dœ
,
ba£Çme
,
Çm–’
,&
šode
);

325 ià(
”rÜ
) {

326 
	`ut
(
dœ
);

327  
”rÜ
;

329 
”rÜ
 = 
	`fŞlow_lšk
(
dœ
,
šode
,
æag
,
mode
,&inode);

330 ià(
”rÜ
)

331  
”rÜ
;

332 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& (
æag
 & 2)) {

333 
	`ut
(
šode
);

334  -
EISDIR
;

336 ià(!
	`³rmissiÚ
(
šode
,
	`ACC_MODE
(
æag
))) {

337 
	`ut
(
šode
);

338  -
EACCES
;

340 ià(
	`S_ISBLK
(
šode
->
i_mode
è|| 
	`S_ISCHR
(inode->i_mode)) {

341 ià(
	`IS_NODEV
(
šode
)) {

342 
	`ut
(
šode
);

343  -
EACCES
;

346 ià(
	`IS_RDONLY
(
šode
è&& (
æag
 & 2)) {

347 
	`ut
(
šode
);

348  -
EROFS
;

351 ià((
šode
->
i_couÁ
 > 1è&& (
æag
 & 2)) {

352 
p
 = &
LAST_TASK
 ;… > &
FIRST_TASK
 ; --p) {

353 
vm_¬—_¡ruù
 * 
m²t
;

354 ià(!*
p
)

356 ià(
šode
 =ğ(*
p
)->
execubË
) {

357 
	`ut
(
šode
);

358  -
ETXTBSY
;

360 
m²t
 = (*
p
)->
mm­
; m²t; m²ˆğm²t->
vm_Ãxt
) {

361 ià(
m²t
->
vm_·ge_´Ù
 & 
PAGE_RW
)

363 ià(
šode
 =ğ
m²t
->
vm_šode
) {

364 
	`ut
(
šode
);

365  -
ETXTBSY
;

370 ià(
æag
 & 
O_TRUNC
) {

371 
šode
->
i_size
 = 0;

372 ià(
šode
->
i_İ
 && inode->i_İ->
Œunÿ‹
)

373 
šode
->
i_İ
->
	`Œunÿ‹
(inode);

374 ià((
”rÜ
 = 
	`nÙify_chªge
(
NOTIFY_SIZE
, 
šode
))) {

375 
	`ut
(
šode
);

376  
”rÜ
;

378 
šode
->
i_dœt
 = 1;

380 *
»s_šode
 = 
šode
;

382 
	}
}

384 
	$do_mknod
(cÚ¡ * 
f’ame
, 
mode
, 
dev_t
 
dev
)

386 cÚ¡ * 
ba£Çme
;

387 
Çm–’
, 
”rÜ
;

388 
šode
 * 
dœ
;

390 
mode
 &ğ~
cu¼’t
->
umask
;

391 
”rÜ
 = 
	`dœ_Çmei
(
f’ame
,&
Çm–’
,&
ba£Çme
, 
NULL
, &
dœ
);

392 ià(
”rÜ
)

393  
”rÜ
;

394 ià(!
Çm–’
) {

395 
	`ut
(
dœ
);

396  -
ENOENT
;

398 ià(
	`IS_RDONLY
(
dœ
)) {

399 
	`ut
(
dœ
);

400  -
EROFS
;

402 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

403 
	`ut
(
dœ
);

404  -
EACCES
;

406 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
mknod
) {

407 
	`ut
(
dœ
);

408  -
EPERM
;

410 
	`down
(&
dœ
->
i_£m
);

411 
”rÜ
 = 
dœ
->
i_İ
->
	`mknod
(dœ,
ba£Çme
,
Çm–’
,
mode
,
dev
);

412 
	`up
(&
dœ
->
i_£m
);

413  
”rÜ
;

414 
	}
}

416 
asmlškage
 
	$sys_mknod
(cÚ¡ * 
f’ame
, 
mode
, 
dev_t
 
dev
)

418 
”rÜ
;

419 * 
tmp
;

421 ià(
	`S_ISDIR
(
mode
è|| (!
	`S_ISFIFO
(modeè&& !
	`su£r
()))

422  -
EPERM
;

423 
mode
 & 
S_IFMT
) {

425 
mode
 |ğ
S_IFREG
;

427 
S_IFREG
: 
S_IFCHR
: 
S_IFBLK
: 
S_IFIFO
:

430  -
EINVAL
;

432 
”rÜ
 = 
	`g‘Çme
(
f’ame
,&
tmp
);

433 ià(!
”rÜ
) {

434 
”rÜ
 = 
	`do_mknod
(
tmp
,
mode
,
dev
);

435 
	`puŠame
(
tmp
);

437  
”rÜ
;

438 
	}
}

440 
	$do_mkdœ
(cÚ¡ * 
·thÇme
, 
mode
)

442 cÚ¡ * 
ba£Çme
;

443 
Çm–’
, 
”rÜ
;

444 
šode
 * 
dœ
;

446 
”rÜ
 = 
	`dœ_Çmei
(
·thÇme
,&
Çm–’
,&
ba£Çme
,
NULL
,&
dœ
);

447 ià(
”rÜ
)

448  
”rÜ
;

449 ià(!
Çm–’
) {

450 
	`ut
(
dœ
);

451  -
ENOENT
;

453 ià(
	`IS_RDONLY
(
dœ
)) {

454 
	`ut
(
dœ
);

455  -
EROFS
;

457 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

458 
	`ut
(
dœ
);

459  -
EACCES
;

461 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
mkdœ
) {

462 
	`ut
(
dœ
);

463  -
EPERM
;

465 
	`down
(&
dœ
->
i_£m
);

466 
”rÜ
 = 
dœ
->
i_İ
->
	`mkdœ
(dœ,
ba£Çme
,
Çm–’
,
mode
);

467 
	`up
(&
dœ
->
i_£m
);

468  
”rÜ
;

469 
	}
}

471 
asmlškage
 
	$sys_mkdœ
(cÚ¡ * 
·thÇme
, 
mode
)

473 
”rÜ
;

474 * 
tmp
;

476 
”rÜ
 = 
	`g‘Çme
(
·thÇme
,&
tmp
);

477 ià(!
”rÜ
) {

478 
”rÜ
 = 
	`do_mkdœ
(
tmp
,
mode
);

479 
	`puŠame
(
tmp
);

481  
”rÜ
;

482 
	}
}

484 
	$do_rmdœ
(cÚ¡ * 
Çme
)

486 cÚ¡ * 
ba£Çme
;

487 
Çm–’
, 
”rÜ
;

488 
šode
 * 
dœ
;

490 
”rÜ
 = 
	`dœ_Çmei
(
Çme
,&
Çm–’
,&
ba£Çme
,
NULL
,&
dœ
);

491 ià(
”rÜ
)

492  
”rÜ
;

493 ià(!
Çm–’
) {

494 
	`ut
(
dœ
);

495  -
ENOENT
;

497 ià(
	`IS_RDONLY
(
dœ
)) {

498 
	`ut
(
dœ
);

499  -
EROFS
;

501 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

502 
	`ut
(
dœ
);

503  -
EACCES
;

505 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
rmdœ
) {

506 
	`ut
(
dœ
);

507  -
EPERM
;

509  
dœ
->
i_İ
->
	`rmdœ
(dœ,
ba£Çme
,
Çm–’
);

510 
	}
}

512 
asmlškage
 
	$sys_rmdœ
(cÚ¡ * 
·thÇme
)

514 
”rÜ
;

515 * 
tmp
;

517 
”rÜ
 = 
	`g‘Çme
(
·thÇme
,&
tmp
);

518 ià(!
”rÜ
) {

519 
”rÜ
 = 
	`do_rmdœ
(
tmp
);

520 
	`puŠame
(
tmp
);

522  
”rÜ
;

523 
	}
}

525 
	$do_uÆšk
(cÚ¡ * 
Çme
)

527 cÚ¡ * 
ba£Çme
;

528 
Çm–’
, 
”rÜ
;

529 
šode
 * 
dœ
;

531 
”rÜ
 = 
	`dœ_Çmei
(
Çme
,&
Çm–’
,&
ba£Çme
,
NULL
,&
dœ
);

532 ià(
”rÜ
)

533  
”rÜ
;

534 ià(!
Çm–’
) {

535 
	`ut
(
dœ
);

536  -
EPERM
;

538 ià(
	`IS_RDONLY
(
dœ
)) {

539 
	`ut
(
dœ
);

540  -
EROFS
;

542 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

543 
	`ut
(
dœ
);

544  -
EACCES
;

546 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
uÆšk
) {

547 
	`ut
(
dœ
);

548  -
EPERM
;

550  
dœ
->
i_İ
->
	`uÆšk
(dœ,
ba£Çme
,
Çm–’
);

551 
	}
}

553 
asmlškage
 
	$sys_uÆšk
(cÚ¡ * 
·thÇme
)

555 
”rÜ
;

556 * 
tmp
;

558 
”rÜ
 = 
	`g‘Çme
(
·thÇme
,&
tmp
);

559 ià(!
”rÜ
) {

560 
”rÜ
 = 
	`do_uÆšk
(
tmp
);

561 
	`puŠame
(
tmp
);

563  
”rÜ
;

564 
	}
}

566 
	$do_symlšk
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
)

568 
šode
 * 
dœ
;

569 cÚ¡ * 
ba£Çme
;

570 
Çm–’
, 
”rÜ
;

572 
”rÜ
 = 
	`dœ_Çmei
(
ÃwÇme
,&
Çm–’
,&
ba£Çme
,
NULL
,&
dœ
);

573 ià(
”rÜ
)

574  
”rÜ
;

575 ià(!
Çm–’
) {

576 
	`ut
(
dœ
);

577  -
ENOENT
;

579 ià(
	`IS_RDONLY
(
dœ
)) {

580 
	`ut
(
dœ
);

581  -
EROFS
;

583 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

584 
	`ut
(
dœ
);

585  -
EACCES
;

587 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
symlšk
) {

588 
	`ut
(
dœ
);

589  -
EPERM
;

591 
	`down
(&
dœ
->
i_£m
);

592 
”rÜ
 = 
dœ
->
i_İ
->
	`symlšk
(dœ,
ba£Çme
,
Çm–’
,
ŞdÇme
);

593 
	`up
(&
dœ
->
i_£m
);

594  
”rÜ
;

595 
	}
}

597 
asmlškage
 
	$sys_symlšk
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
)

599 
”rÜ
;

600 * 
äom
, * 
to
;

602 
”rÜ
 = 
	`g‘Çme
(
ŞdÇme
,&
äom
);

603 ià(!
”rÜ
) {

604 
”rÜ
 = 
	`g‘Çme
(
ÃwÇme
,&
to
);

605 ià(!
”rÜ
) {

606 
”rÜ
 = 
	`do_symlšk
(
äom
,
to
);

607 
	`puŠame
(
to
);

609 
	`puŠame
(
äom
);

611  
”rÜ
;

612 
	}
}

614 
	$do_lšk
(
šode
 * 
Şdšode
, cÚ¡ * 
ÃwÇme
)

616 
šode
 * 
dœ
;

617 cÚ¡ * 
ba£Çme
;

618 
Çm–’
, 
”rÜ
;

620 
”rÜ
 = 
	`dœ_Çmei
(
ÃwÇme
,&
Çm–’
,&
ba£Çme
,
NULL
,&
dœ
);

621 ià(
”rÜ
) {

622 
	`ut
(
Şdšode
);

623  
”rÜ
;

625 ià(!
Çm–’
) {

626 
	`ut
(
Şdšode
);

627 
	`ut
(
dœ
);

628  -
EPERM
;

630 ià(
	`IS_RDONLY
(
dœ
)) {

631 
	`ut
(
Şdšode
);

632 
	`ut
(
dœ
);

633  -
EROFS
;

635 ià(
dœ
->
i_dev
 !ğ
Şdšode
->i_dev) {

636 
	`ut
(
dœ
);

637 
	`ut
(
Şdšode
);

638  -
EXDEV
;

640 ià(!
	`³rmissiÚ
(
dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

641 
	`ut
(
dœ
);

642 
	`ut
(
Şdšode
);

643  -
EACCES
;

645 ià(!
dœ
->
i_İ
 || !dœ->i_İ->
lšk
) {

646 
	`ut
(
dœ
);

647 
	`ut
(
Şdšode
);

648  -
EPERM
;

650 
	`down
(&
dœ
->
i_£m
);

651 
”rÜ
 = 
dœ
->
i_İ
->
	`lšk
(
Şdšode
, dœ, 
ba£Çme
, 
Çm–’
);

652 
	`up
(&
dœ
->
i_£m
);

653  
”rÜ
;

654 
	}
}

656 
asmlškage
 
	$sys_lšk
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
)

658 
”rÜ
;

659 * 
to
;

660 
šode
 * 
Şdšode
;

662 
”rÜ
 = 
	`Çmei
(
ŞdÇme
, &
Şdšode
);

663 ià(
”rÜ
)

664  
”rÜ
;

665 
”rÜ
 = 
	`g‘Çme
(
ÃwÇme
,&
to
);

666 ià(
”rÜ
) {

667 
	`ut
(
Şdšode
);

668  
”rÜ
;

670 
”rÜ
 = 
	`do_lšk
(
Şdšode
,
to
);

671 
	`puŠame
(
to
);

672  
”rÜ
;

673 
	}
}

675 
	$do_»Çme
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
)

677 
šode
 * 
Şd_dœ
, * 
Ãw_dœ
;

678 cÚ¡ * 
Şd_ba£
, * 
Ãw_ba£
;

679 
Şd_Ën
, 
Ãw_Ën
, 
”rÜ
;

681 
”rÜ
 = 
	`dœ_Çmei
(
ŞdÇme
,&
Şd_Ën
,&
Şd_ba£
,
NULL
,&
Şd_dœ
);

682 ià(
”rÜ
)

683  
”rÜ
;

684 ià(!
	`³rmissiÚ
(
Şd_dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

685 
	`ut
(
Şd_dœ
);

686  -
EACCES
;

688 ià(!
Şd_Ën
 || (
Şd_ba£
[0] == '.' &&

689 (
Şd_Ën
 =ğ1 || (
Şd_ba£
[1] == '.' &&

690 
Şd_Ën
 == 2)))) {

691 
	`ut
(
Şd_dœ
);

692  -
EPERM
;

694 
”rÜ
 = 
	`dœ_Çmei
(
ÃwÇme
,&
Ãw_Ën
,&
Ãw_ba£
,
NULL
,&
Ãw_dœ
);

695 ià(
”rÜ
) {

696 
	`ut
(
Şd_dœ
);

697  
”rÜ
;

699 ià(!
	`³rmissiÚ
(
Ãw_dœ
,
MAY_WRITE
 | 
MAY_EXEC
)) {

700 
	`ut
(
Şd_dœ
);

701 
	`ut
(
Ãw_dœ
);

702  -
EACCES
;

704 ià(!
Ãw_Ën
 || (
Ãw_ba£
[0] == '.' &&

705 (
Ãw_Ën
 =ğ1 || (
Ãw_ba£
[1] == '.' &&

706 
Ãw_Ën
 == 2)))) {

707 
	`ut
(
Şd_dœ
);

708 
	`ut
(
Ãw_dœ
);

709  -
EPERM
;

711 ià(
Ãw_dœ
->
i_dev
 !ğ
Şd_dœ
->i_dev) {

712 
	`ut
(
Şd_dœ
);

713 
	`ut
(
Ãw_dœ
);

714  -
EXDEV
;

716 ià(
	`IS_RDONLY
(
Ãw_dœ
è|| IS_RDONLY(
Şd_dœ
)) {

717 
	`ut
(
Şd_dœ
);

718 
	`ut
(
Ãw_dœ
);

719  -
EROFS
;

721 ià(!
Şd_dœ
->
i_İ
 || !Şd_dœ->i_İ->
»Çme
) {

722 
	`ut
(
Şd_dœ
);

723 
	`ut
(
Ãw_dœ
);

724  -
EPERM
;

726 
	`down
(&
Ãw_dœ
->
i_£m
);

727 
”rÜ
 = 
Şd_dœ
->
i_İ
->
	`»Çme
(Şd_dœ, 
Şd_ba£
, 
Şd_Ën
,

728 
Ãw_dœ
, 
Ãw_ba£
, 
Ãw_Ën
);

729 
	`up
(&
Ãw_dœ
->
i_£m
);

730  
”rÜ
;

731 
	}
}

733 
asmlškage
 
	$sys_»Çme
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
)

735 
”rÜ
;

736 * 
äom
, * 
to
;

738 
”rÜ
 = 
	`g‘Çme
(
ŞdÇme
,&
äom
);

739 ià(!
”rÜ
) {

740 
”rÜ
 = 
	`g‘Çme
(
ÃwÇme
,&
to
);

741 ià(!
”rÜ
) {

742 
”rÜ
 = 
	`do_»Çme
(
äom
,
to
);

743 
	`puŠame
(
to
);

745 
	`puŠame
(
äom
);

747  
”rÜ
;

748 
	}
}

	@fs/nfs/dir.c

9 
	~<lšux/sched.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/¡©.h
>

12 
	~<lšux/nfs_fs.h
>

13 
	~<lšux/fú.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/m®loc.h
>

17 
	~<lšux/mm.h
>

19 
	~<asm/£gm’t.h
>

21 
nfs_dœ_»ad
(
šode
 *, 
fe
 *
fp
, *
buf
,

22 
couÁ
);

23 
nfs_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

24 
nfs_lookup
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

25 
šode
 **
»suÉ
);

26 
nfs_ü—‹
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
,

27 
šode
 **
»suÉ
);

28 
nfs_mkdœ
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
);

29 
nfs_rmdœ
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
);

30 
nfs_uÆšk
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
);

31 
nfs_symlšk
(
šode
 *šode, cÚ¡ *
Çme
, 
Ën
,

32 cÚ¡ *
symÇme
);

33 
nfs_lšk
(
šode
 *
Şdšode
, šod*
dœ
,

34 cÚ¡ *
Çme
, 
Ën
);

35 
nfs_mknod
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
,

36 
rdev
);

37 
nfs_»Çme
(
šode
 *
Şd_dœ
, cÚ¡ *
Şd_Çme
,

38 
Şd_Ën
, 
šode
 *
Ãw_dœ
, cÚ¡ *
Ãw_Çme
,

39 
Ãw_Ën
);

41 
fe_İ”©iÚs
 
	gnfs_dœ_İ”©iÚs
 = {

42 
NULL
,

43 
nfs_dœ_»ad
,

44 
NULL
,

45 
nfs_»addœ
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL


54 
šode_İ”©iÚs
 
	gnfs_dœ_šode_İ”©iÚs
 = {

55 &
nfs_dœ_İ”©iÚs
,

56 
nfs_ü—‹
,

57 
nfs_lookup
,

58 
nfs_lšk
,

59 
nfs_uÆšk
,

60 
nfs_symlšk
,

61 
nfs_mkdœ
,

62 
nfs_rmdœ
,

63 
nfs_mknod
,

64 
nfs_»Çme
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL


72 
	$nfs_dœ_»ad
(
šode
 *šode, 
fe
 *
fp
, *
buf
,

73 
couÁ
)

75  -
EISDIR
;

76 
	}
}

86 
	$nfs_»addœ
(
šode
 *šode, 
fe
 *
fp
,

87 
dœ’t
 *dœ’t, 
couÁ
)

89 
c_dev
 = 0;

90 
c_šo
;

91 
c_size
;

92 
nfs_’Œy
 *
c_’Œy
 = 
NULL
;

94 
»suÉ
;

95 
i
;

96 
nfs_’Œy
 *
’Œy
;

98 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
)) {

99 
	`´štk
("nfs_readdir: inode is NULL or‚ot‡ directory\n");

100  -
EBADF
;

105 ià(
c_’Œy
 =ğ
NULL
) {

106 
i
 =  (
nfs_’Œy
)*
NFS_READDIR_CACHE_SIZE
;

107 
c_’Œy
 = (
nfs_’Œy
 *è
	`km®loc
(
i
, 
GFP_KERNEL
);

108 
i
 = 0; i < 
NFS_READDIR_CACHE_SIZE
; i++) {

109 
c_’Œy
[
i
].
Çme
 = (*è
	`km®loc
(
NFS_MAXNAMLEN
 + 1,

110 
GFP_KERNEL
);

113 
’Œy
 = 
NULL
;

117 ià(
šode
->
i_dev
 =ğ
c_dev
 && inode->
i_šo
 =ğ
c_šo
) {

118 
i
 = 0; i < 
c_size
; i++) {

119 ià(
fp
->
f_pos
 =ğ
c_’Œy
[
i
].
cook›
) {

120 ià(
i
 =ğ
c_size
 - 1) {

121 ià(
c_’Œy
[
i
].
eof
)

125 
’Œy
 = 
c_’Œy
 + 
i
 + 1;

133 ià(!
’Œy
) {

134 
»suÉ
 = 
	`nfs_´oc_»addœ
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(inode),

135 
fp
->
f_pos
, 
NFS_READDIR_CACHE_SIZE
, 
c_’Œy
);

136 ià(
»suÉ
 < 0) {

137 
c_dev
 = 0;

138  
»suÉ
;

140 ià(
»suÉ
 > 0) {

141 
c_dev
 = 
šode
->
i_dev
;

142 
c_šo
 = 
šode
->
i_šo
;

143 
c_size
 = 
»suÉ
;

144 
’Œy
 = 
c_’Œy
 + 0;

150 ià(
’Œy
) {

151 
i
 = 
	`¡¾’
(
’Œy
->
Çme
);

152 
	`memıy_tofs
(
dœ’t
->
d_Çme
, 
’Œy
->
Çme
, 
i
 + 1);

153 
	`put_fs_lÚg
(
’Œy
->
feid
, &
dœ’t
->
d_šo
);

154 
	`put_fs_wÜd
(
i
, &
dœ’t
->
d_»ş’
);

155 
fp
->
f_pos
 = 
’Œy
->
cook›
;

156  
i
;

159 
	}
}

174 
	snfs_lookup_ÿche_’Œy
 {

175 
	mdev
;

176 
	mšode
;

177 
	mf’ame
[
NFS_MAXNAMLEN
 + 1];

178 
nfs_fh
 
	mfhªdË
;

179 
nfs_ç‰r
 
	mç‰r
;

180 
	mexpœ©iÚ_d©e
;

181 } 
	gnfs_lookup_ÿche
[
NFS_LOOKUP_CACHE_SIZE
];

183 
nfs_lookup_ÿche_’Œy
 *
	$nfs_lookup_ÿche_šdex
(
šode
 *
dœ
,

184 cÚ¡ *
f’ame
)

186 
nfs_lookup_ÿche_’Œy
 *
’Œy
;

187 
i
;

189 
i
 = 0; i < 
NFS_LOOKUP_CACHE_SIZE
; i++) {

190 
’Œy
 = 
nfs_lookup_ÿche
 + 
i
;

191 ià(
’Œy
->
dev
 =ğ
dœ
->
i_dev
 &&ƒÁry->
šode
 =ğdœ->
i_šo


192 && !
	`¡ºcmp
(
f’ame
, 
’Œy
->f’ame, 
NFS_MAXNAMLEN
))

193  
’Œy
;

195  
NULL
;

196 
	}
}

198 
	$nfs_lookup_ÿche_lookup
(
šode
 *
dœ
, cÚ¡ *
f’ame
,

199 
nfs_fh
 *
fhªdË
,

200 
nfs_ç‰r
 *
ç‰r
)

202 
nfs_lookup_ÿche_š_u£
 = 0;

204 
nfs_lookup_ÿche_’Œy
 *
’Œy
;

206 ià(!
nfs_lookup_ÿche_š_u£
) {

207 
	`mem£t
(
nfs_lookup_ÿche
, 0, (nfs_lookup_cache));

208 
nfs_lookup_ÿche_š_u£
 = 1;

210 ià((
’Œy
 = 
	`nfs_lookup_ÿche_šdex
(
dœ
, 
f’ame
))) {

211 ià(
jiff›s
 > 
’Œy
->
expœ©iÚ_d©e
) {

212 
’Œy
->
dev
 = 0;

215 *
fhªdË
 = 
’Œy
->fhandle;

216 *
ç‰r
 = 
’Œy
->fattr;

220 
	}
}

222 
	$nfs_lookup_ÿche_add
(
šode
 *
dœ
, cÚ¡ *
f’ame
,

223 
nfs_fh
 *
fhªdË
,

224 
nfs_ç‰r
 *
ç‰r
)

226 
nfs_lookup_ÿche_pos
 = 0;

227 
nfs_lookup_ÿche_’Œy
 *
’Œy
;

230 ià(
ç‰r
->
size
 =ğ-1 || f©Œ->
uid
 =ğ-1 || f©Œ->
gid
 == -1

231 || 
ç‰r
->
©ime
.
£cÚds
 =ğ-1 || f©Œ->
mtime
.seconds == -1)

233 ià(!(
’Œy
 = 
	`nfs_lookup_ÿche_šdex
(
dœ
, 
f’ame
))) {

234 
’Œy
 = 
nfs_lookup_ÿche
 + 
nfs_lookup_ÿche_pos
++;

235 ià(
nfs_lookup_ÿche_pos
 =ğ
NFS_LOOKUP_CACHE_SIZE
)

236 
nfs_lookup_ÿche_pos
 = 0;

238 
’Œy
->
dev
 = 
dœ
->
i_dev
;

239 
’Œy
->
šode
 = 
dœ
->
i_šo
;

240 
	`¡rıy
(
’Œy
->
f’ame
, filename);

241 
’Œy
->
fhªdË
 = *fhandle;

242 
’Œy
->
ç‰r
 = *fattr;

243 
’Œy
->
expœ©iÚ_d©e
 = 
jiff›s
 + (
	`S_ISDIR
(
ç‰r
->
mode
)

244 ? 
	`NFS_SERVER
(
dœ
)->
acdœmax
 : NFS_SERVER(dœ)->
aüegmax
);

245 
	}
}

247 
	$nfs_lookup_ÿche_»move
(
šode
 *
dœ
, inode *inode,

248 cÚ¡ *
f’ame
)

250 
nfs_lookup_ÿche_’Œy
 *
’Œy
;

251 
dev
;

252 
feid
;

253 
i
;

255 ià(
šode
) {

256 
dev
 = 
šode
->
i_dev
;

257 
feid
 = 
šode
->
i_šo
;

259 ià((
’Œy
 = 
	`nfs_lookup_ÿche_šdex
(
dœ
, 
f’ame
))) {

260 
dev
 = 
’Œy
->dev;

261 
feid
 = 
’Œy
->
ç‰r
.fileid;

265 
i
 = 0; i < 
NFS_LOOKUP_CACHE_SIZE
; i++) {

266 
’Œy
 = 
nfs_lookup_ÿche
 + 
i
;

267 ià(
’Œy
->
dev
 =ğdev &&ƒÁry->
ç‰r
.
feid
 == fileid)

268 
’Œy
->
dev
 = 0;

270 
	}
}

272 
	$nfs_lookup_ÿche_»äesh
(
šode
 *
fe
,

273 
nfs_ç‰r
 *
ç‰r
)

275 
nfs_lookup_ÿche_’Œy
 *
’Œy
;

276 
dev
 = 
fe
->
i_dev
;

277 
feid
 = 
fe
->
i_šo
;

278 
i
;

280 
i
 = 0; i < 
NFS_LOOKUP_CACHE_SIZE
; i++) {

281 
’Œy
 = 
nfs_lookup_ÿche
 + 
i
;

282 ià(
’Œy
->
dev
 =ğdev &&ƒÁry->
ç‰r
.
feid
 == fileid)

283 
’Œy
->
ç‰r
 = *fattr;

285 
	}
}

287 
	$nfs_lookup
(
šode
 *
dœ
, cÚ¡ *
__Çme
, 
Ën
,

288 
šode
 **
»suÉ
)

290 
nfs_fh
 
fhªdË
;

291 
nfs_ç‰r
 
ç‰r
;

292 
Çme
[
Ën
 > 
NFS_MAXNAMLEN
? 1 :†en+1];

293 
”rÜ
;

295 *
»suÉ
 = 
NULL
;

296 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

297 
	`´štk
("nfs_lookup: inode is NULL or‚ot‡ directory\n");

298 
	`ut
(
dœ
);

299  -
ENOENT
;

301 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

302 
	`ut
(
dœ
);

303  -
ENAMETOOLONG
;

305 
	`memıy
(
Çme
,
__Çme
,
Ën
);

306 
Çme
[
Ën
] = '\0';

307 ià(
Ën
 =ğ1 && 
Çme
[0] == '.') {

308 *
»suÉ
 = 
dœ
;

311 ià((
	`NFS_SERVER
(
dœ
)->
æags
 & 
NFS_MOUNT_NOAC
)

312 || !
	`nfs_lookup_ÿche_lookup
(
dœ
, 
Çme
, &
fhªdË
, &
ç‰r
)) {

313 ià((
”rÜ
 = 
	`nfs_´oc_lookup
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dir),

314 
Çme
, &
fhªdË
, &
ç‰r
))) {

315 
	`ut
(
dœ
);

316  
”rÜ
;

318 
	`nfs_lookup_ÿche_add
(
dœ
, 
Çme
, &
fhªdË
, &
ç‰r
);

320 ià(!(*
»suÉ
 = 
	`nfs_fhg‘
(
dœ
->
i_sb
, &
fhªdË
, &
ç‰r
))) {

321 
	`ut
(
dœ
);

322  -
EACCES
;

324 
	`ut
(
dœ
);

326 
	}
}

328 
	$nfs_ü—‹
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
,

329 
šode
 **
»suÉ
)

331 
nfs_§‰r
 
§‰r
;

332 
nfs_ç‰r
 
ç‰r
;

333 
nfs_fh
 
fhªdË
;

334 
”rÜ
;

336 *
»suÉ
 = 
NULL
;

337 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

338 
	`´štk
("nfs_create: inode is NULL or‚ot‡ directory\n");

339 
	`ut
(
dœ
);

340  -
ENOENT
;

342 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

343 
	`ut
(
dœ
);

344  -
ENAMETOOLONG
;

346 
§‰r
.
mode
 = mode;

347 
§‰r
.
uid
 = s©Œ.
gid
 = s©Œ.
size
 = () -1;

348 
§‰r
.
©ime
.
£cÚds
 = s©Œ.
mtime
.seconds = () -1;

349 ià((
”rÜ
 = 
	`nfs_´oc_ü—‹
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dir),

350 
Çme
, &
§‰r
, &
fhªdË
, &
ç‰r
))) {

351 
	`ut
(
dœ
);

352  
”rÜ
;

354 ià(!(*
»suÉ
 = 
	`nfs_fhg‘
(
dœ
->
i_sb
, &
fhªdË
, &
ç‰r
))) {

355 
	`ut
(
dœ
);

356  -
EACCES
;

358 
	`nfs_lookup_ÿche_add
(
dœ
, 
Çme
, &
fhªdË
, &
ç‰r
);

359 
	`ut
(
dœ
);

361 
	}
}

363 
	$nfs_mknod
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

364 
mode
, 
rdev
)

366 
nfs_§‰r
 
§‰r
;

367 
nfs_ç‰r
 
ç‰r
;

368 
nfs_fh
 
fhªdË
;

369 
”rÜ
;

371 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

372 
	`´štk
("nfs_mknod: inode is NULL or‚ot‡ directory\n");

373 
	`ut
(
dœ
);

374  -
ENOENT
;

376 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

377 
	`ut
(
dœ
);

378  -
ENAMETOOLONG
;

380 
§‰r
.
mode
 = mode;

381 
§‰r
.
uid
 = s©Œ.
gid
 = () -1;

382 ià(
	`S_ISCHR
(
mode
è|| 
	`S_ISBLK
(mode))

383 
§‰r
.
size
 = 
rdev
;

385 
§‰r
.
size
 = () -1;

386 
§‰r
.
©ime
.
£cÚds
 = s©Œ.
mtime
.seconds = () -1;

387 
”rÜ
 = 
	`nfs_´oc_ü—‹
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dir),

388 
Çme
, &
§‰r
, &
fhªdË
, &
ç‰r
);

389 ià(!
”rÜ
)

390 
	`nfs_lookup_ÿche_add
(
dœ
, 
Çme
, &
fhªdË
, &
ç‰r
);

391 
	`ut
(
dœ
);

392  
”rÜ
;

393 
	}
}

395 
	$nfs_mkdœ
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
)

397 
nfs_§‰r
 
§‰r
;

398 
nfs_ç‰r
 
ç‰r
;

399 
nfs_fh
 
fhªdË
;

400 
”rÜ
;

402 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

403 
	`´štk
("nfs_mkdir: inode is NULL or‚ot‡ directory\n");

404 
	`ut
(
dœ
);

405  -
ENOENT
;

407 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

408 
	`ut
(
dœ
);

409  -
ENAMETOOLONG
;

411 
§‰r
.
mode
 = mode;

412 
§‰r
.
uid
 = s©Œ.
gid
 = s©Œ.
size
 = () -1;

413 
§‰r
.
©ime
.
£cÚds
 = s©Œ.
mtime
.seconds = () -1;

414 
”rÜ
 = 
	`nfs_´oc_mkdœ
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dir),

415 
Çme
, &
§‰r
, &
fhªdË
, &
ç‰r
);

416 ià(!
”rÜ
)

417 
	`nfs_lookup_ÿche_add
(
dœ
, 
Çme
, &
fhªdË
, &
ç‰r
);

418 
	`ut
(
dœ
);

419  
”rÜ
;

420 
	}
}

422 
	$nfs_rmdœ
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
)

424 
”rÜ
;

426 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

427 
	`´štk
("nfs_rmdir: inode is NULL or‚ot‡ directory\n");

428 
	`ut
(
dœ
);

429  -
ENOENT
;

431 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

432 
	`ut
(
dœ
);

433  -
ENAMETOOLONG
;

435 
”rÜ
 = 
	`nfs_´oc_rmdœ
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dœ), 
Çme
);

436 ià(!
”rÜ
)

437 
	`nfs_lookup_ÿche_»move
(
dœ
, 
NULL
, 
Çme
);

438 
	`ut
(
dœ
);

439  
”rÜ
;

440 
	}
}

442 
	$nfs_uÆšk
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
)

444 
”rÜ
;

446 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

447 
	`´štk
("nfs_unlink: inode is NULL or‚ot‡ directory\n");

448 
	`ut
(
dœ
);

449  -
ENOENT
;

451 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

452 
	`ut
(
dœ
);

453  -
ENAMETOOLONG
;

455 
”rÜ
 = 
	`nfs_´oc_»move
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dœ), 
Çme
);

456 ià(!
”rÜ
)

457 
	`nfs_lookup_ÿche_»move
(
dœ
, 
NULL
, 
Çme
);

458 
	`ut
(
dœ
);

459  
”rÜ
;

460 
	}
}

462 
	$nfs_symlšk
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

463 cÚ¡ *
symÇme
)

465 
nfs_§‰r
 
§‰r
;

466 
”rÜ
;

468 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

469 
	`´štk
("nfs_symlink: inode is NULL or‚ot‡ directory\n");

470 
	`ut
(
dœ
);

471  -
ENOENT
;

473 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

474 
	`ut
(
dœ
);

475  -
ENAMETOOLONG
;

477 ià(
	`¡¾’
(
symÇme
è> 
NFS_MAXPATHLEN
) {

478 
	`ut
(
dœ
);

479  -
ENAMETOOLONG
;

481 
§‰r
.
mode
 = 
S_IFLNK
 | 
S_IRWXUGO
;

482 
§‰r
.
uid
 = s©Œ.
gid
 = s©Œ.
size
 = () -1;

483 
§‰r
.
©ime
.
£cÚds
 = s©Œ.
mtime
.seconds = () -1;

484 
”rÜ
 = 
	`nfs_´oc_symlšk
(
	`NFS_SERVER
(
dœ
), 
	`NFS_FH
(dir),

485 
Çme
, 
symÇme
, &
§‰r
);

486 
	`ut
(
dœ
);

487  
”rÜ
;

488 
	}
}

490 
	$nfs_lšk
(
šode
 *
Şdšode
, šod*
dœ
,

491 cÚ¡ *
Çme
, 
Ën
)

493 
”rÜ
;

495 ià(!
Şdšode
) {

496 
	`´štk
("nfs_link: old inode is NULL\n");

497 
	`ut
(
Şdšode
);

498 
	`ut
(
dœ
);

499  -
ENOENT
;

501 ià(!
dœ
 || !
	`S_ISDIR
(dœ->
i_mode
)) {

502 
	`´štk
("nfs_link: dir is NULL or‚ot‡ directory\n");

503 
	`ut
(
Şdšode
);

504 
	`ut
(
dœ
);

505  -
ENOENT
;

507 ià(
Ën
 > 
NFS_MAXNAMLEN
) {

508 
	`ut
(
Şdšode
);

509 
	`ut
(
dœ
);

510  -
ENAMETOOLONG
;

512 
”rÜ
 = 
	`nfs_´oc_lšk
(
	`NFS_SERVER
(
Şdšode
), 
	`NFS_FH
(oldinode),

513 
	`NFS_FH
(
dœ
), 
Çme
);

514 ià(!
”rÜ
)

515 
	`nfs_lookup_ÿche_»move
(
dœ
, 
Şdšode
, 
NULL
);

516 
	`ut
(
Şdšode
);

517 
	`ut
(
dœ
);

518  
”rÜ
;

519 
	}
}

521 
	$nfs_»Çme
(
šode
 *
Şd_dœ
, cÚ¡ *
Şd_Çme
, 
Şd_Ën
,

522 
šode
 *
Ãw_dœ
, cÚ¡ *
Ãw_Çme
, 
Ãw_Ën
)

524 
”rÜ
;

526 ià(!
Şd_dœ
 || !
	`S_ISDIR
(Şd_dœ->
i_mode
)) {

527 
	`´štk
("nfs_rename: old inode is NULL or‚ot‡ directory\n");

528 
	`ut
(
Şd_dœ
);

529 
	`ut
(
Ãw_dœ
);

530  -
ENOENT
;

532 ià(!
Ãw_dœ
 || !
	`S_ISDIR
Òew_dœ->
i_mode
)) {

533 
	`´štk
("nfs_rename:‚ew inode is NULL or‚ot‡ directory\n");

534 
	`ut
(
Şd_dœ
);

535 
	`ut
(
Ãw_dœ
);

536  -
ENOENT
;

538 ià(
Şd_Ën
 > 
NFS_MAXNAMLEN
 || 
Ãw_Ën
 > NFS_MAXNAMLEN) {

539 
	`ut
(
Şd_dœ
);

540 
	`ut
(
Ãw_dœ
);

541  -
ENAMETOOLONG
;

543 
”rÜ
 = 
	`nfs_´oc_»Çme
(
	`NFS_SERVER
(
Şd_dœ
),

544 
	`NFS_FH
(
Şd_dœ
), 
Şd_Çme
,

545 
	`NFS_FH
(
Ãw_dœ
), 
Ãw_Çme
);

546 ià(!
”rÜ
) {

547 
	`nfs_lookup_ÿche_»move
(
Şd_dœ
, 
NULL
, 
Şd_Çme
);

548 
	`nfs_lookup_ÿche_»move
(
Ãw_dœ
, 
NULL
, 
Ãw_Çme
);

550 
	`ut
(
Şd_dœ
);

551 
	`ut
(
Ãw_dœ
);

552  
”rÜ
;

553 
	}
}

561 
	$nfs_»äesh_šode
(
šode
 *šode, 
nfs_ç‰r
 *
ç‰r
)

563 
was_em±y
;

565 ià(!
šode
 || !
ç‰r
) {

566 
	`´štk
("nfs_refresh_inode: inode or fattr is NULL\n");

569 ià(
šode
->
i_šo
 !ğ
ç‰r
->
feid
) {

570 
	`´štk
("nfs_refresh_inode: inode‚umber mismatch\n");

573 
was_em±y
 = 
šode
->
i_mode
 == 0;

574 
šode
->
i_mode
 = 
ç‰r
->
mode
;

575 
šode
->
i_Æšk
 = 
ç‰r
->
Æšk
;

576 
šode
->
i_uid
 = 
ç‰r
->
uid
;

577 
šode
->
i_gid
 = 
ç‰r
->
gid
;

578 
šode
->
i_size
 = 
ç‰r
->
size
;

579 
šode
->
i_blksize
 = 
ç‰r
->
blocksize
;

580 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

581 
šode
->
i_rdev
 = 
ç‰r
->
rdev
;

583 
šode
->
i_rdev
 = 0;

584 
šode
->
i_blocks
 = 
ç‰r
->
blocks
;

585 
šode
->
i_©ime
 = 
ç‰r
->
©ime
.
£cÚds
;

586 
šode
->
i_mtime
 = 
ç‰r
->
mtime
.
£cÚds
;

587 
šode
->
i_ùime
 = 
ç‰r
->
ùime
.
£cÚds
;

588 ià(
was_em±y
) {

589 ià(
	`S_ISREG
(
šode
->
i_mode
))

590 
šode
->
i_İ
 = &
nfs_fe_šode_İ”©iÚs
;

591 ià(
	`S_ISDIR
(
šode
->
i_mode
))

592 
šode
->
i_İ
 = &
nfs_dœ_šode_İ”©iÚs
;

593 ià(
	`S_ISLNK
(
šode
->
i_mode
))

594 
šode
->
i_İ
 = &
nfs_symlšk_šode_İ”©iÚs
;

595 ià(
	`S_ISCHR
(
šode
->
i_mode
))

596 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

597 ià(
	`S_ISBLK
(
šode
->
i_mode
))

598 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

599 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

600 
	`š™_fifo
(
šode
);

602 
šode
->
i_İ
 = 
NULL
;

604 
	`nfs_lookup_ÿche_»äesh
(
šode
, 
ç‰r
);

605 
	}
}

	@fs/nfs/file.c

9 
	~<asm/£gm’t.h
>

10 
	~<asm/sy¡em.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/fú.h
>

16 
	~<lšux/¡©.h
>

17 
	~<lšux/mm.h
>

18 
	~<lšux/nfs_fs.h
>

19 
	~<lšux/m®loc.h
>

21 
nfs_fe_»ad
(
šode
 *, 
fe
 *, *, );

22 
nfs_fe_wr™e
(
šode
 *, 
fe
 *, *, );

23 
nfs_fsync
(
šode
 *, 
fe
 *);

24 
nfs_mm­
(
šode
 * inode, 
fe
 * file,

25 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
);

27 
fe_İ”©iÚs
 
	gnfs_fe_İ”©iÚs
 = {

28 
NULL
,

29 
nfs_fe_»ad
,

30 
nfs_fe_wr™e
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
nfs_mm­
,

35 
NULL
,

36 
NULL
,

37 
nfs_fsync
,

40 
šode_İ”©iÚs
 
	gnfs_fe_šode_İ”©iÚs
 = {

41 &
nfs_fe_İ”©iÚs
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
NULL
,

53 
NULL
,

54 
NULL


57 
	$nfs_fsync
(
šode
 *šode, 
fe
 *file)

60 
	}
}

62 
	$nfs_fe_»ad
(
šode
 *šode, 
fe
 *fe, *
buf
,

63 
couÁ
)

65 
»suÉ
;

66 
hunk
;

67 
i
;

68 
n
;

69 
nfs_ç‰r
 
ç‰r
;

70 *
d©a
;

71 
off_t
 
pos
;

73 ià(!
šode
) {

74 
	`´štk
("nfs_file_read: inode = NULL\n");

75  -
EINVAL
;

77 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

78 
	`´štk
("nfs_file_read:„ead from‚on-file, mode %07o\n",

79 
šode
->
i_mode
);

80  -
EINVAL
;

82 
pos
 = 
fe
->
f_pos
;

83 ià(
fe
->
f_pos
 + 
couÁ
 > 
šode
->
i_size
)

84 
couÁ
 = 
šode
->
i_size
 - 
pos
;

85 ià(
couÁ
 <= 0)

87 
n
 = 
	`NFS_SERVER
(
šode
)->
rsize
;

88 
d©a
 = (*è
	`km®loc
(
n
, 
GFP_KERNEL
);

89 
i
 = 0; i < 
couÁ
; i +ğ
n
) {

90 
hunk
 = 
couÁ
 - 
i
;

91 ià(
hunk
 > 
n
)

92 
hunk
 = 
n
;

93 
»suÉ
 = 
	`nfs_´oc_»ad
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(inode),

94 
pos
, 
hunk
, 
d©a
, &
ç‰r
);

95 ià(
»suÉ
 < 0) {

96 
	`kä“_s
(
d©a
, 
n
);

97  
»suÉ
;

99 
	`memıy_tofs
(
buf
, 
d©a
, 
»suÉ
);

100 
pos
 +ğ
»suÉ
;

101 
buf
 +ğ
»suÉ
;

102 ià(
»suÉ
 < 
n
) {

103 
i
 +ğ
»suÉ
;

107 
fe
->
f_pos
 = 
pos
;

108 
	`kä“_s
(
d©a
, 
n
);

109 
	`nfs_»äesh_šode
(
šode
, &
ç‰r
);

110  
i
;

111 
	}
}

113 
	$nfs_fe_wr™e
(
šode
 *šode, 
fe
 *fe, *
buf
,

114 
couÁ
)

116 
»suÉ
;

117 
hunk
;

118 
i
;

119 
n
;

120 
nfs_ç‰r
 
ç‰r
;

121 *
d©a
;

122 
pos
;

124 ià(!
šode
) {

125 
	`´štk
("nfs_file_write: inode = NULL\n");

126  -
EINVAL
;

128 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

129 
	`´štk
("nfs_file_write: writeo‚on-file, mode %07o\n",

130 
šode
->
i_mode
);

131  -
EINVAL
;

133 ià(
couÁ
 <= 0)

135 
pos
 = 
fe
->
f_pos
;

136 ià(
fe
->
f_æags
 & 
O_APPEND
)

137 
pos
 = 
šode
->
i_size
;

138 
n
 = 
	`NFS_SERVER
(
šode
)->
wsize
;

139 
d©a
 = (*è
	`km®loc
(
n
, 
GFP_KERNEL
);

140 
i
 = 0; i < 
couÁ
; i +ğ
n
) {

141 
hunk
 = 
couÁ
 - 
i
;

142 ià(
hunk
 >ğ
n
)

143 
hunk
 = 
n
;

144 
	`memıy_äomfs
(
d©a
, 
buf
, 
hunk
);

145 
»suÉ
 = 
	`nfs_´oc_wr™e
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(inode),

146 
pos
, 
hunk
, 
d©a
, &
ç‰r
);

147 ià(
»suÉ
 < 0) {

148 
	`kä“_s
(
d©a
, 
n
);

149  
»suÉ
;

151 
pos
 +ğ
hunk
;

152 
buf
 +ğ
hunk
;

153 ià(
hunk
 < 
n
) {

154 
i
 +ğ
hunk
;

158 
fe
->
f_pos
 = 
pos
;

159 
	`kä“_s
(
d©a
, 
n
);

160 
	`nfs_»äesh_šode
(
šode
, &
ç‰r
);

161  
i
;

162 
	}
}

	@fs/nfs/inode.c

9 
	~<asm/sy¡em.h
>

10 
	~<asm/£gm’t.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/nfs_fs.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/locks.h
>

21 
şo£_å
(
fe
 *
fp
, 
fd
);

23 
nfs_nÙify_chªge
(, 
šode
 *);

24 
nfs_put_šode
(
šode
 *);

25 
nfs_put_su³r
(
su³r_block
 *);

26 
nfs_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

28 
su³r_İ”©iÚs
 
	gnfs_sİs
 = {

29 
NULL
,

30 
nfs_nÙify_chªge
,

31 
NULL
,

32 
nfs_put_šode
,

33 
nfs_put_su³r
,

34 
NULL
,

35 
nfs_¡©fs
,

36 
NULL


39 
	$nfs_put_šode
(
šode
 * inode)

41 
	`ş—r_šode
(
šode
);

42 
	}
}

44 
	$nfs_put_su³r
(
su³r_block
 *
sb
)

47 
	`şo£_å
(
sb
->
u
.
nfs_sb
.
s_£rv”
.
fe
, 0);

48 
	`lock_su³r
(
sb
);

49 
sb
->
s_dev
 = 0;

50 
	`uÆock_su³r
(
sb
);

51 
	}
}

61 
su³r_block
 *
	$nfs_»ad_su³r
(
su³r_block
 *
sb
, *
¿w_d©a
,

62 
s’t
)

64 
nfs_mouÁ_d©a
 *
d©a
 = (nfs_mouÁ_d©¨*è
¿w_d©a
;

65 
nfs_£rv”
 *
£rv”
;

66 
fd
;

67 
fe
 *
fp
;

68 
dev_t
 
dev
 = 
sb
->
s_dev
;

70 ià(!
d©a
) {

71 
	`´štk
("nfs_read_super: missing data‡rgument\n");

72 
sb
->
s_dev
 = 0;

73  
NULL
;

75 
fd
 = 
d©a
->fd;

76 ià(
d©a
->
v”siÚ
 !ğ
NFS_MOUNT_VERSION
) {

77 
	`´štk
("nfs warning: mount version %shan kernel\n",

78 
d©a
->
v”siÚ
 < 
NFS_MOUNT_VERSION
 ? "older" : "newer");

80 ià(
fd
 >ğ
NR_OPEN
 || !(
fp
 = 
cu¼’t
->filp[fd])) {

81 
	`´štk
("nfs_read_super: invalid file descriptor\n");

82 
sb
->
s_dev
 = 0;

83  
NULL
;

85 ià(!
	`S_ISSOCK
(
fp
->
f_šode
->
i_mode
)) {

86 
	`´štk
("nfs_read_super:‚ot‡ socket\n");

87 
sb
->
s_dev
 = 0;

88  
NULL
;

90 
fp
->
f_couÁ
++;

91 
	`lock_su³r
(
sb
);

92 
sb
->
s_blocksize
 = 1024;

93 
sb
->
s_blocksize_b™s
 = 10;

94 
sb
->
s_magic
 = 
NFS_SUPER_MAGIC
;

95 
sb
->
s_dev
 = 
dev
;

96 
sb
->
s_İ
 = &
nfs_sİs
;

97 
£rv”
 = &
sb
->
u
.
nfs_sb
.
s_£rv”
;

98 
£rv”
->
fe
 = 
fp
;

99 
£rv”
->
lock
 = 0;

100 
£rv”
->
wa™
 = 
NULL
;

101 
£rv”
->
æags
 = 
d©a
->flags;

102 
£rv”
->
rsize
 = 
d©a
->rsize;

103 ià(
£rv”
->
rsize
 <= 0)

104 
£rv”
->
rsize
 = 
NFS_DEF_FILE_IO_BUFFER_SIZE
;

105 ià(
£rv”
->
rsize
 >ğ
NFS_MAX_FILE_IO_BUFFER_SIZE
)

106 
£rv”
->
rsize
 = 
NFS_MAX_FILE_IO_BUFFER_SIZE
;

107 
£rv”
->
wsize
 = 
d©a
->wsize;

108 ià(
£rv”
->
wsize
 <= 0)

109 
£rv”
->
wsize
 = 
NFS_DEF_FILE_IO_BUFFER_SIZE
;

110 ià(
£rv”
->
wsize
 >ğ
NFS_MAX_FILE_IO_BUFFER_SIZE
)

111 
£rv”
->
wsize
 = 
NFS_MAX_FILE_IO_BUFFER_SIZE
;

112 
£rv”
->
timeo
 = 
d©a
->timeo*
HZ
/10;

113 
£rv”
->
»Œªs
 = 
d©a
->retrans;

114 
£rv”
->
aüegmš
 = 
d©a
->aüegmš*
HZ
;

115 
£rv”
->
aüegmax
 = 
d©a
->aüegmax*
HZ
;

116 
£rv”
->
acdœmš
 = 
d©a
->acdœmš*
HZ
;

117 
£rv”
->
acdœmax
 = 
d©a
->acdœmax*
HZ
;

118 
	`¡rıy
(
£rv”
->
ho¡Çme
, 
d©a
->hostname);

119 
sb
->
u
.
nfs_sb
.
s_roÙ
 = 
d©a
->
roÙ
;

120 
	`uÆock_su³r
(
sb
);

121 ià(!(
sb
->
s_mouÁed
 = 
	`nfs_fhg‘
(sb, &
d©a
->
roÙ
, 
NULL
))) {

122 
sb
->
s_dev
 = 0;

123 
	`´štk
("nfs_read_super: get„oot inode failed\n");

124  
NULL
;

126  
sb
;

127 
	}
}

129 
	$nfs_¡©fs
(
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

131 
”rÜ
;

132 
nfs_fsšfo
 
»s
;

134 
	`put_fs_lÚg
(
NFS_SUPER_MAGIC
, &
buf
->
f_ty³
);

135 
”rÜ
 = 
	`nfs_´oc_¡©fs
(&
sb
->
u
.
nfs_sb
.
s_£rv”
, &sb->u.nfs_sb.
s_roÙ
,

136 &
»s
);

137 ià(
”rÜ
) {

138 
	`´štk
("nfs_¡©fs: stf ”rÜ = %d\n", -
”rÜ
);

139 
»s
.
bsize
 =„es.
blocks
 =„es.
bä“
 =„es.
bava
 = 0;

141 
	`put_fs_lÚg
(
»s
.
bsize
, &
buf
->
f_bsize
);

142 
	`put_fs_lÚg
(
»s
.
blocks
, &
buf
->
f_blocks
);

143 
	`put_fs_lÚg
(
»s
.
bä“
, &
buf
->
f_bä“
);

144 
	`put_fs_lÚg
(
»s
.
bava
, &
buf
->
f_bava
);

145 
	`put_fs_lÚg
(0, &
buf
->
f_fes
);

146 
	`put_fs_lÚg
(0, &
buf
->
f_fä“
);

149 
	`put_fs_lÚg
(
NAME_MAX
, &
buf
->
f_Çm–’
);

150 
	}
}

161 
šode
 *
	$nfs_fhg‘
(
su³r_block
 *
sb
, 
nfs_fh
 *
fhªdË
,

162 
nfs_ç‰r
 *
ç‰r
)

164 
nfs_ç‰r
 
Ãwç‰r
;

165 
”rÜ
;

166 
šode
 *inode;

168 ià(!
sb
) {

169 
	`´štk
("nfs_fhget: super block is NULL\n");

170  
NULL
;

172 ià(!
ç‰r
) {

173 
”rÜ
 = 
	`nfs_´oc_g‘©Œ
(&
sb
->
u
.
nfs_sb
.
s_£rv”
, 
fhªdË
,

174 &
Ãwç‰r
);

175 ià(
”rÜ
) {

176 
	`´štk
("nfs_fhg‘: g‘©Œƒ¼Ü = %d\n", -
”rÜ
);

177  
NULL
;

179 
ç‰r
 = &
Ãwç‰r
;

181 ià(!(
šode
 = 
	`ig‘
(
sb
, 
ç‰r
->
feid
))) {

182 
	`´štk
("nfs_fhget: iget failed\n");

183  
NULL
;

185 ià(
šode
->
i_dev
 =ğ
sb
->
s_dev
) {

186 ià(
šode
->
i_šo
 !ğ
ç‰r
->
feid
) {

187 
	`´štk
("nfs_fhget: unexpected inode from iget\n");

188  
šode
;

190 *
	`NFS_FH
(
šode
èğ*
fhªdË
;

191 
	`nfs_»äesh_šode
(
šode
, 
ç‰r
);

193  
šode
;

194 
	}
}

196 
	$nfs_nÙify_chªge
(
æags
, 
šode
 *inode)

198 
nfs_§‰r
 
§‰r
;

199 
nfs_ç‰r
 
ç‰r
;

200 
”rÜ
;

202 ià(
æags
 & 
NOTIFY_MODE
)

203 
§‰r
.
mode
 = 
šode
->
i_mode
;

205 
§‰r
.
mode
 = () -1;

206 ià(
æags
 & 
NOTIFY_UIDGID
) {

207 
§‰r
.
uid
 = 
šode
->
i_uid
;

208 
§‰r
.
gid
 = 
šode
->
i_gid
;

211 
§‰r
.
uid
 = s©Œ.
gid
 = () -1;

212 ià(
æags
 & 
NOTIFY_SIZE
)

213 
§‰r
.
size
 = 
	`S_ISREG
(
šode
->
i_mode
è? inode->
i_size
 : -1;

215 
§‰r
.
size
 = () -1;

216 ià(
æags
 & 
NOTIFY_TIME
) {

217 
§‰r
.
mtime
.
£cÚds
 = 
šode
->
i_mtime
;

218 
§‰r
.
mtime
.
u£cÚds
 = 0;

219 
§‰r
.
©ime
.
£cÚds
 = 
šode
->
i_©ime
;

220 
§‰r
.
©ime
.
u£cÚds
 = 0;

223 
§‰r
.
mtime
.
£cÚds
 = s©Œ.mtime.
u£cÚds
 = () -1;

224 
§‰r
.
©ime
.
£cÚds
 = s©Œ.©ime.
u£cÚds
 = () -1;

226 
”rÜ
 = 
	`nfs_´oc_£‰r
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(inode),

227 &
§‰r
, &
ç‰r
);

228 ià(!
”rÜ
)

229 
	`nfs_»äesh_šode
(
šode
, &
ç‰r
);

230 
šode
->
i_dœt
 = 0;

231  
”rÜ
;

232 
	}
}

	@fs/nfs/mmap.c

12 
	~<lšux/¡©.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/shm.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/mmª.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/m®loc.h
>

21 
	~<lšux/nfs_fs.h
>

23 
	~<asm/£gm’t.h
>

24 
	~<asm/sy¡em.h
>

26 
sh¬e_·ge
(
vm_¬—_¡ruù
 * 
¬—
, 
sk_¡ruù
 * 
tsk
,

27 
šode
 * inode, 
add»ss
, 
”rÜ_code
,

28 
Ãw·ge
);

30 
put_·ge
(
sk_¡ruù
 * 
tsk
,
·ge
,

31 
add»ss
,
´Ù
);

33 
nfs_fe_mm­_nİage
(
”rÜ_code
, 
vm_¬—_¡ruù
 * 
¬—
,

34 
add»ss
);

36 
fe_mm­_ä“
(
vm_¬—_¡ruù
 * 
¬—
);

37 
fe_mm­_sh¬e
(
vm_¬—_¡ruù
 * 
äom
, vm_¬—_¡ruù * 
to
,

38 
add»ss
);

40 
vm_İ”©iÚs_¡ruù
 
	gnfs_fe_mm­
 = {

41 
NULL
,

42 
fe_mm­_ä“
,

43 
nfs_fe_mm­_nİage
,

44 
NULL
,

45 
fe_mm­_sh¬e
,

46 
NULL
,

51 
	$nfs_mm­
(
šode
 * inode, 
fe
 * file,

52 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
)

54 
vm_¬—_¡ruù
 * 
m²t
;

56 ià(
´Ù
 & 
PAGE_RW
)

57  -
EINVAL
;

58 ià(
off
 & (
šode
->
i_sb
->
s_blocksize
 - 1))

59  -
EINVAL
;

60 ià(!
šode
->
i_sb
 || !
	`S_ISREG
(šode->
i_mode
))

61  -
EACCES
;

62 ià(!
	`IS_RDONLY
(
šode
)) {

63 
šode
->
i_©ime
 = 
CURRENT_TIME
;

64 
šode
->
i_dœt
 = 1;

67 
m²t
 = (
vm_¬—_¡ruù
 * ) 
	`km®loc
((vm_¬—_¡ruù), 
GFP_KERNEL
);

68 ià(!
m²t
)

69  -
ENOMEM
;

71 
	`unm­_·ge_¿nge
(
addr
, 
Ën
);

72 
m²t
->
vm_sk
 = 
cu¼’t
;

73 
m²t
->
vm_¡¬t
 = 
addr
;

74 
m²t
->
vm_’d
 = 
addr
 + 
Ën
;

75 
m²t
->
vm_·ge_´Ù
 = 
´Ù
;

76 
m²t
->
vm_sh¬e
 = 
NULL
;

77 
m²t
->
vm_šode
 = 
šode
;

78 
šode
->
i_couÁ
++;

79 
m²t
->
vm_off£t
 = 
off
;

80 
m²t
->
vm_İs
 = &
nfs_fe_mm­
;

81 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

82 
	`m”ge_£gm’ts
(
cu¼’t
->
mm­
, 
NULL
, NULL);

84 
	}
}

87 
	$nfs_fe_mm­_nİage
(
”rÜ_code
, 
vm_¬—_¡ruù
 * 
¬—
,

88 
add»ss
)

90 
šode
 * inodğ
¬—
->
vm_šode
;

91 
ş—r
;

92 
·ge
;

93 
tmp
;

94 
n
;

95 
i
;

96 
pos
;

97 
nfs_ç‰r
 
ç‰r
;

99 
add»ss
 &ğ
PAGE_MASK
;

100 
pos
 = 
add»ss
 - 
¬—
->
vm_¡¬t
 +‡»a->
vm_off£t
;

102 
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

103 ià(
	`sh¬e_·ge
(
¬—
,‡»a->
vm_sk
, 
šode
, 
add»ss
, 
”rÜ_code
, 
·ge
)) {

104 ++
¬—
->
vm_sk
->
mš_æt
;

108 ++
¬—
->
vm_sk
->
maj_æt
;

109 ià(!
·ge
) {

110 
	`oom
(
cu¼’t
);

111 
	`put_·ge
(
¬—
->
vm_sk
, 
BAD_PAGE
, 
add»ss
, 
PAGE_PRIVATE
);

115 
ş—r
 = 0;

116 ià(
add»ss
 + 
PAGE_SIZE
 > 
¬—
->
vm_’d
) {

117 
ş—r
 = 
add»ss
 + 
PAGE_SIZE
 - 
¬—
->
vm_’d
;

120 
n
 = 
	`NFS_SERVER
(
šode
)->
rsize
;

122 
i
 = 0; i < (
PAGE_SIZE
 - 
ş—r
); i +ğ
n
) {

123 
hunk
, 
»suÉ
;

125 
hunk
 = 
PAGE_SIZE
 - 
i
;

126 ià(
hunk
 > 
n
)

127 
hunk
 = 
n
;

128 
»suÉ
 = 
	`nfs_´oc_»ad
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(inode),

129 
pos
, 
hunk
, (*è(
·ge
 + 
i
), &
ç‰r
);

130 ià(
»suÉ
 < 0)

132 
pos
 +ğ
»suÉ
;

133 ià(
»suÉ
 < 
n
) {

134 
i
 +ğ
»suÉ
;

139 #ifdeà
dow’“dthish”e


140 
	`nfs_»äesh_šode
(
šode
, &
ç‰r
);

143 ià(!(
”rÜ_code
 & 
PAGE_RW
)) {

144 ià(
	`sh¬e_·ge
(
¬—
,‡»a->
vm_sk
, 
šode
, 
add»ss
, 
”rÜ_code
, 
·ge
))

148 
tmp
 = 
·ge
 + 
PAGE_SIZE
;

149 
ş—r
--) {

150 *(*)--
tmp
 = 0;

152 ià(
	`put_·ge
(
¬—
->
vm_sk
,
·ge
,
add»ss
,¬—->
vm_·ge_´Ù
))

154 
	`ä“_·ge
(
·ge
);

155 
	`oom
(
cu¼’t
);

156 
	}
}

	@fs/nfs/proc.c

16 
	#NFS_PROC_DEBUG


	)

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/·¿m.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/mm.h
>

23 
	~<lšux/nfs_fs.h
>

24 
	~<lšux/ut¢ame.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/¡ršg.h
>

27 
	~<lšux/š.h
>

29 #ifdeà
NFS_PROC_DEBUG


31 
	g´oc_debug
 = 0;

32 
	#PRINTK
(
fÜm©
, 
¬gs
...) \

34 ià(
´oc_debug
) \

35 
	`´štk
(
fÜm©
 , ## 
¬gs
); \

36 } 0)

	)

40 
	#PRINTK
(
fÜm©
, 
¬gs
...èdØ; 0)

	)

44 *
nfs_½c_h—d”
(*
p
, 
´oûdu»
, 
ruid
);

45 *
nfs_½c_v”ify
(*
p
);

46 
nfs_¡©_to_”ºo
(
¡©
);

52 
šlše
 *
	$nfs_½c_®loc
()

54  (*è
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

55 
	}
}

57 
šlše
 
	$nfs_½c_ä“
(*
p
)

59 
	`ä“_·ge
((è
p
);

60 
	}
}

67 
šlše
 *
	$xdr_’code_fhªdË
(*
p
, 
nfs_fh
 *
fhªdË
)

69 *((
nfs_fh
 *è
p
èğ*
fhªdË
;

70 
p
 +ğ( (*
fhªdË
) + 3) >> 2;

71  
p
;

72 
	}
}

74 
šlše
 *
	$xdr_decode_fhªdË
(*
p
, 
nfs_fh
 *
fhªdË
)

76 *
fhªdË
 = *((
nfs_fh
 *è
p
);

77 
p
 +ğ( (*
fhªdË
) + 3) >> 2;

78  
p
;

79 
	}
}

81 
šlše
 *
	$xdr_’code_¡ršg
(*
p
, cÚ¡ *
¡ršg
)

83 
Ën
, 
quadËn
;

85 
Ën
 = 
	`¡¾’
(
¡ršg
);

86 
quadËn
 = (
Ën
 + 3) >> 2;

87 *
p
++ = 
	`htÚl
(
Ën
);

88 
	`memıy
((*è
p
, 
¡ršg
, 
Ën
);

89 
	`mem£t
(((*è
p
è+ 
Ën
, '\0', (
quadËn
 << 2) -†en);

90 
p
 +ğ
quadËn
;

91  
p
;

92 
	}
}

94 
šlše
 *
	$xdr_decode_¡ršg
(*
p
, *
¡ršg
, 
maxËn
)

96 
Ën
;

98 
Ën
 = 
	`Áohl
(*
p
++);

99 ià(
Ën
 > 
maxËn
)

100  
NULL
;

101 
	`memıy
(
¡ršg
, (*è
p
, 
Ën
);

102 
¡ršg
[
Ën
] = '\0';

103 
p
 +ğ(
Ën
 + 3) >> 2;

104  
p
;

105 
	}
}

107 
šlše
 *
	$xdr_’code_d©a
(*
p
, *
d©a
, 
Ën
)

109 
quadËn
;

111 
quadËn
 = (
Ën
 + 3) >> 2;

112 *
p
++ = 
	`htÚl
(
Ën
);

113 
	`memıy
((*è
p
, 
d©a
, 
Ën
);

114 
	`mem£t
(((*è
p
è+ 
Ën
, '\0', (
quadËn
 << 2) -†en);

115 
p
 +ğ
quadËn
;

116  
p
;

117 
	}
}

119 
šlše
 *
	$xdr_decode_d©a
(*
p
, *
d©a
, *
ËÅ
, 
maxËn
)

121 
Ën
;

123 
Ën
 = *
ËÅ
 = 
	`Áohl
(*
p
++);

124 ià(
Ën
 > 
maxËn
)

125  
NULL
;

126 
	`memıy
(
d©a
, (*è
p
, 
Ën
);

127 
p
 +ğ(
Ën
 + 3) >> 2;

128  
p
;

129 
	}
}

131 *
	$xdr_decode_ç‰r
(*
p
, 
nfs_ç‰r
 *
ç‰r
)

133 
ç‰r
->
ty³
 = (
nfs_áy³
è
	`Áohl
(*
p
++);

134 
ç‰r
->
mode
 = 
	`Áohl
(*
p
++);

135 
ç‰r
->
Æšk
 = 
	`Áohl
(*
p
++);

136 
ç‰r
->
uid
 = 
	`Áohl
(*
p
++);

137 
ç‰r
->
gid
 = 
	`Áohl
(*
p
++);

138 
ç‰r
->
size
 = 
	`Áohl
(*
p
++);

139 
ç‰r
->
blocksize
 = 
	`Áohl
(*
p
++);

140 
ç‰r
->
rdev
 = 
	`Áohl
(*
p
++);

141 
ç‰r
->
blocks
 = 
	`Áohl
(*
p
++);

142 
ç‰r
->
fsid
 = 
	`Áohl
(*
p
++);

143 
ç‰r
->
feid
 = 
	`Áohl
(*
p
++);

144 
ç‰r
->
©ime
.
£cÚds
 = 
	`Áohl
(*
p
++);

145 
ç‰r
->
©ime
.
u£cÚds
 = 
	`Áohl
(*
p
++);

146 
ç‰r
->
mtime
.
£cÚds
 = 
	`Áohl
(*
p
++);

147 
ç‰r
->
mtime
.
u£cÚds
 = 
	`Áohl
(*
p
++);

148 
ç‰r
->
ùime
.
£cÚds
 = 
	`Áohl
(*
p
++);

149 
ç‰r
->
ùime
.
u£cÚds
 = 
	`Áohl
(*
p
++);

150  
p
;

151 
	}
}

153 *
	$xdr_’code_§‰r
(*
p
, 
nfs_§‰r
 *
§‰r
)

155 *
p
++ = 
	`htÚl
(
§‰r
->
mode
);

156 *
p
++ = 
	`htÚl
(
§‰r
->
uid
);

157 *
p
++ = 
	`htÚl
(
§‰r
->
gid
);

158 *
p
++ = 
	`htÚl
(
§‰r
->
size
);

159 *
p
++ = 
	`htÚl
(
§‰r
->
©ime
.
£cÚds
);

160 *
p
++ = 
	`htÚl
(
§‰r
->
©ime
.
u£cÚds
);

161 *
p
++ = 
	`htÚl
(
§‰r
->
mtime
.
£cÚds
);

162 *
p
++ = 
	`htÚl
(
§‰r
->
mtime
.
u£cÚds
);

163  
p
;

164 
	}
}

166 *
	$xdr_decode_’Œy
(*
p
, 
nfs_’Œy
 *
’Œy
)

168 
’Œy
->
feid
 = 
	`Áohl
(*
p
++);

169 ià(!(
p
 = 
	`xdr_decode_¡ršg
Õ, 
’Œy
->
Çme
, 
NFS_MAXNAMLEN
)))

170  
NULL
;

171 
’Œy
->
cook›
 = 
	`Áohl
(*
p
++);

172 
’Œy
->
eof
 = 0;

173  
p
;

174 
	}
}

176 *
	$xdr_decode_fsšfo
(*
p
, 
nfs_fsšfo
 *
»s
)

178 
»s
->
tsize
 = 
	`Áohl
(*
p
++);

179 
»s
->
bsize
 = 
	`Áohl
(*
p
++);

180 
»s
->
blocks
 = 
	`Áohl
(*
p
++);

181 
»s
->
bä“
 = 
	`Áohl
(*
p
++);

182 
»s
->
bava
 = 
	`Áohl
(*
p
++);

183  
p
;

184 
	}
}

190 
	$nfs_´oc_g‘©Œ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

191 
nfs_ç‰r
 *
ç‰r
)

193 *
p
, *
p0
;

194 
¡©us
;

195 
ruid
 = 0;

197 
	`PRINTK
("NFS call getattr\n");

198 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

199  -
EIO
;

200 
»Œy
:

201 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_GETATTR
, 
ruid
);

202 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

203 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

204 
	`nfs_½c_ä“
(
p0
);

205  
¡©us
;

207 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

208 
¡©us
 = 
NFSERR_IO
;

209 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

210 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

211 
	`PRINTK
("NFS„eply getattr\n");

214 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

215 
ruid
 = 1;

216 
»Œy
;

218 
	`PRINTK
("NFS„•ly g‘©Œ faed = %d\n", 
¡©us
);

220 
	`nfs_½c_ä“
(
p0
);

221  -
	`nfs_¡©_to_”ºo
(
¡©us
);

222 
	}
}

224 
	$nfs_´oc_£‰r
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

225 
nfs_§‰r
 *
§‰r
, 
nfs_ç‰r
 *
ç‰r
)

227 *
p
, *
p0
;

228 
¡©us
;

229 
ruid
 = 0;

231 
	`PRINTK
("NFS call setattr\n");

232 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

233  -
EIO
;

234 
»Œy
:

235 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_SETATTR
, 
ruid
);

236 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

237 
p
 = 
	`xdr_’code_§‰r
Õ, 
§‰r
);

238 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

239 
	`nfs_½c_ä“
(
p0
);

240  
¡©us
;

242 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

243 
¡©us
 = 
NFSERR_IO
;

244 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

245 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

246 
	`PRINTK
("NFS„eply setattr\n");

249 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

250 
ruid
 = 1;

251 
»Œy
;

253 
	`PRINTK
("NFS„•ly s‘©Œ faed = %d\n", 
¡©us
);

255 
	`nfs_½c_ä“
(
p0
);

256  -
	`nfs_¡©_to_”ºo
(
¡©us
);

257 
	}
}

259 
	$nfs_´oc_lookup
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
, cÚ¡ *
Çme
,

260 
nfs_fh
 *
fhªdË
, 
nfs_ç‰r
 *
ç‰r
)

262 *
p
, *
p0
;

263 
¡©us
;

264 
ruid
 = 0;

266 
	`PRINTK
("NFS c®È†ooku°%s\n", 
Çme
);

267 #ifdeà
NFS_PROC_DEBUG


268 ià(!
	`¡rcmp
(
Çme
, "xyzzy"))

269 
´oc_debug
 = 1 -…roc_debug;

271 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

272  -
EIO
;

273 
»Œy
:

274 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_LOOKUP
, 
ruid
);

275 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

276 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

277 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

278 
	`nfs_½c_ä“
(
p0
);

279  
¡©us
;

281 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

282 
¡©us
 = 
NFSERR_IO
;

283 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

284 
p
 = 
	`xdr_decode_fhªdË
Õ, 
fhªdË
);

285 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

286 
	`PRINTK
("NFS„eply†ookup\n");

289 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

290 
ruid
 = 1;

291 
»Œy
;

293 
	`PRINTK
("NFS„•ly†ooku°çed = %d\n", 
¡©us
);

295 
	`nfs_½c_ä“
(
p0
);

296  -
	`nfs_¡©_to_”ºo
(
¡©us
);

297 
	}
}

299 
	$nfs_´oc_»adlšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

300 *
»s
)

302 *
p
, *
p0
;

303 
¡©us
;

304 
ruid
 = 0;

306 
	`PRINTK
("NFS call„eadlink\n");

307 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

308  -
EIO
;

309 
»Œy
:

310 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_READLINK
, 
ruid
);

311 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

312 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

313 
	`nfs_½c_ä“
(
p0
);

314  
¡©us
;

316 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

317 
¡©us
 = 
NFSERR_IO
;

318 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

319 ià(!(
p
 = 
	`xdr_decode_¡ršg
Õ, 
»s
, 
NFS_MAXPATHLEN
))) {

320 
	`´štk
("nfs_proc_readlink: giant…athname\n");

321 
¡©us
 = 
NFSERR_IO
;

324 
	`PRINTK
("NFS„•ly„—dlšk %s\n", 
»s
);

327 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

328 
ruid
 = 1;

329 
»Œy
;

331 
	`PRINTK
("NFS„•ly„—dlšk faed = %d\n", 
¡©us
);

333 
	`nfs_½c_ä“
(
p0
);

334  -
	`nfs_¡©_to_”ºo
(
¡©us
);

335 
	}
}

337 
	$nfs_´oc_»ad
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

338 
off£t
, 
couÁ
, *
d©a
, 
nfs_ç‰r
 *
ç‰r
)

340 *
p
, *
p0
;

341 
¡©us
;

342 
ruid
 = 0;

343 
Ën
 = 0;

345 
	`PRINTK
("NFS c®È„—d %d @ %d\n", 
couÁ
, 
off£t
);

346 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

347  -
EIO
;

348 
»Œy
:

349 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_READ
, 
ruid
);

350 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

351 *
p
++ = 
	`htÚl
(
off£t
);

352 *
p
++ = 
	`htÚl
(
couÁ
);

353 *
p
++ = 
	`htÚl
(
couÁ
);

354 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

355 
	`nfs_½c_ä“
(
p0
);

356  
¡©us
;

358 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

359 
¡©us
 = 
NFSERR_IO
;

360 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

361 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

362 ià(!(
p
 = 
	`xdr_decode_d©a
Õ, 
d©a
, &
Ën
, 
couÁ
))) {

363 
	`´štk
("nfs_proc_read: giant data size\n");

364 
¡©us
 = 
NFSERR_IO
;

367 
	`PRINTK
("NFS„•ly„—d %d\n", 
Ën
);

370 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

371 
ruid
 = 1;

372 
»Œy
;

374 
	`PRINTK
("NFS„•ly„—d faed = %d\n", 
¡©us
);

376 
	`nfs_½c_ä“
(
p0
);

377  (
¡©us
 =ğ
NFS_OK
è? 
Ën
 : -
	`nfs_¡©_to_”ºo
(status);

378 
	}
}

380 
	$nfs_´oc_wr™e
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

381 
off£t
, 
couÁ
, *
d©a
, 
nfs_ç‰r
 *
ç‰r
)

383 *
p
, *
p0
;

384 
¡©us
;

385 
ruid
 = 0;

387 
	`PRINTK
("NFS c®È wr™%d @ %d\n", 
couÁ
, 
off£t
);

388 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

389  -
EIO
;

390 
»Œy
:

391 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_WRITE
, 
ruid
);

392 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

393 *
p
++ = 
	`htÚl
(
off£t
);

394 *
p
++ = 
	`htÚl
(
off£t
);

395 *
p
++ = 
	`htÚl
(
couÁ
);

396 
p
 = 
	`xdr_’code_d©a
Õ, 
d©a
, 
couÁ
);

397 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

398 
	`nfs_½c_ä“
(
p0
);

399  
¡©us
;

401 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

402 
¡©us
 = 
NFSERR_IO
;

403 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

404 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

405 
	`PRINTK
("NFS„eply write\n");

408 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

409 
ruid
 = 1;

410 
»Œy
;

412 
	`PRINTK
("NFS„•ly wr™çed = %d\n", 
¡©us
);

414 
	`nfs_½c_ä“
(
p0
);

415  -
	`nfs_¡©_to_”ºo
(
¡©us
);

416 
	}
}

418 
	$nfs_´oc_ü—‹
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

419 cÚ¡ *
Çme
, 
nfs_§‰r
 *
§‰r
,

420 
nfs_fh
 *
fhªdË
, 
nfs_ç‰r
 *
ç‰r
)

422 *
p
, *
p0
;

423 
¡©us
;

424 
ruid
 = 0;

426 
	`PRINTK
("NFS c®È c»©%s\n", 
Çme
);

427 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

428  -
EIO
;

429 
»Œy
:

430 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_CREATE
, 
ruid
);

431 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

432 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

433 
p
 = 
	`xdr_’code_§‰r
Õ, 
§‰r
);

434 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

435 
	`nfs_½c_ä“
(
p0
);

436  
¡©us
;

438 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

439 
¡©us
 = 
NFSERR_IO
;

440 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

441 
p
 = 
	`xdr_decode_fhªdË
Õ, 
fhªdË
);

442 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

443 
	`PRINTK
("NFS„eply create\n");

446 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

447 
ruid
 = 1;

448 
»Œy
;

450 
	`PRINTK
("NFS„•ly c»©çed = %d\n", 
¡©us
);

452 
	`nfs_½c_ä“
(
p0
);

453  -
	`nfs_¡©_to_”ºo
(
¡©us
);

454 
	}
}

456 
	$nfs_´oc_»move
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
, cÚ¡ *
Çme
)

458 *
p
, *
p0
;

459 
¡©us
;

460 
ruid
 = 0;

462 
	`PRINTK
("NFS c®È„emov%s\n", 
Çme
);

463 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

464  -
EIO
;

465 
»Œy
:

466 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_REMOVE
, 
ruid
);

467 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

468 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

469 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

470 
	`nfs_½c_ä“
(
p0
);

471  
¡©us
;

473 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

474 
¡©us
 = 
NFSERR_IO
;

475 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

476 
	`PRINTK
("NFS„eply„emove\n");

479 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

480 
ruid
 = 1;

481 
»Œy
;

483 
	`PRINTK
("NFS„•ly„emovçed = %d\n", 
¡©us
);

485 
	`nfs_½c_ä“
(
p0
);

486  -
	`nfs_¡©_to_”ºo
(
¡©us
);

487 
	}
}

489 
	$nfs_´oc_»Çme
(
nfs_£rv”
 *
£rv”
,

490 
nfs_fh
 *
Şd_dœ
, cÚ¡ *
Şd_Çme
,

491 
nfs_fh
 *
Ãw_dœ
, cÚ¡ *
Ãw_Çme
)

493 *
p
, *
p0
;

494 
¡©us
;

495 
ruid
 = 0;

497 
	`PRINTK
("NFS c®È„’am% -> %s\n", 
Şd_Çme
, 
Ãw_Çme
);

498 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

499  -
EIO
;

500 
»Œy
:

501 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_RENAME
, 
ruid
);

502 
p
 = 
	`xdr_’code_fhªdË
Õ, 
Şd_dœ
);

503 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Şd_Çme
);

504 
p
 = 
	`xdr_’code_fhªdË
Õ, 
Ãw_dœ
);

505 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Ãw_Çme
);

506 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

507 
	`nfs_½c_ä“
(
p0
);

508  
¡©us
;

510 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

511 
¡©us
 = 
NFSERR_IO
;

512 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

513 
	`PRINTK
("NFS„eply„ename\n");

516 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

517 
ruid
 = 1;

518 
»Œy
;

520 
	`PRINTK
("NFS„•ly„’amçed = %d\n", 
¡©us
);

522 
	`nfs_½c_ä“
(
p0
);

523  -
	`nfs_¡©_to_”ºo
(
¡©us
);

524 
	}
}

526 
	$nfs_´oc_lšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

527 
nfs_fh
 *
dœ
, cÚ¡ *
Çme
)

529 *
p
, *
p0
;

530 
¡©us
;

531 
ruid
 = 0;

533 
	`PRINTK
("NFS c®È†šk %s\n", 
Çme
);

534 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

535  -
EIO
;

536 
»Œy
:

537 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_LINK
, 
ruid
);

538 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

539 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

540 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

541 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

542 
	`nfs_½c_ä“
(
p0
);

543  
¡©us
;

545 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

546 
¡©us
 = 
NFSERR_IO
;

547 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

548 
	`PRINTK
("NFS„eply†ink\n");

551 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

552 
ruid
 = 1;

553 
»Œy
;

555 
	`PRINTK
("NFS„•ly†šk faed = %d\n", 
¡©us
);

557 
	`nfs_½c_ä“
(
p0
);

558  -
	`nfs_¡©_to_”ºo
(
¡©us
);

559 
	}
}

561 
	$nfs_´oc_symlšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

562 cÚ¡ *
Çme
, cÚ¡ *
·th
, 
nfs_§‰r
 *
§‰r
)

564 *
p
, *
p0
;

565 
¡©us
;

566 
ruid
 = 0;

568 
	`PRINTK
("NFS c®È symlšk % -> %s\n", 
Çme
, 
·th
);

569 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

570  -
EIO
;

571 
»Œy
:

572 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_SYMLINK
, 
ruid
);

573 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

574 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

575 
p
 = 
	`xdr_’code_¡ršg
Õ, 
·th
);

576 
p
 = 
	`xdr_’code_§‰r
Õ, 
§‰r
);

577 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

578 
	`nfs_½c_ä“
(
p0
);

579  
¡©us
;

581 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

582 
¡©us
 = 
NFSERR_IO
;

583 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

584 
	`PRINTK
("NFS„eply symlink\n");

587 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

588 
ruid
 = 1;

589 
»Œy
;

591 
	`PRINTK
("NFS„•ly symlšk faed = %d\n", 
¡©us
);

593 
	`nfs_½c_ä“
(
p0
);

594  -
	`nfs_¡©_to_”ºo
(
¡©us
);

595 
	}
}

597 
	$nfs_´oc_mkdœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

598 cÚ¡ *
Çme
, 
nfs_§‰r
 *
§‰r
,

599 
nfs_fh
 *
fhªdË
, 
nfs_ç‰r
 *
ç‰r
)

601 *
p
, *
p0
;

602 
¡©us
;

603 
ruid
 = 0;

605 
	`PRINTK
("NFS c®È mkdœ %s\n", 
Çme
);

606 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

607  -
EIO
;

608 
»Œy
:

609 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_MKDIR
, 
ruid
);

610 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

611 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

612 
p
 = 
	`xdr_’code_§‰r
Õ, 
§‰r
);

613 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

614 
	`nfs_½c_ä“
(
p0
);

615  
¡©us
;

617 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

618 
¡©us
 = 
NFSERR_IO
;

619 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

620 
p
 = 
	`xdr_decode_fhªdË
Õ, 
fhªdË
);

621 
p
 = 
	`xdr_decode_ç‰r
Õ, 
ç‰r
);

622 
	`PRINTK
("NFS„eply mkdir\n");

625 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

626 
ruid
 = 1;

627 
»Œy
;

629 
	`PRINTK
("NFS„•ly mkdœ faed = %d\n", 
¡©us
);

631 
	`nfs_½c_ä“
(
p0
);

632  -
	`nfs_¡©_to_”ºo
(
¡©us
);

633 
	}
}

635 
	$nfs_´oc_rmdœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
, cÚ¡ *
Çme
)

637 *
p
, *
p0
;

638 
¡©us
;

639 
ruid
 = 0;

641 
	`PRINTK
("NFS c®È„mdœ %s\n", 
Çme
);

642 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

643  -
EIO
;

644 
»Œy
:

645 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_RMDIR
, 
ruid
);

646 
p
 = 
	`xdr_’code_fhªdË
Õ, 
dœ
);

647 
p
 = 
	`xdr_’code_¡ršg
Õ, 
Çme
);

648 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

649 
	`nfs_½c_ä“
(
p0
);

650  
¡©us
;

652 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

653 
¡©us
 = 
NFSERR_IO
;

654 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

655 
	`PRINTK
("NFS„eply„mdir\n");

658 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

659 
ruid
 = 1;

660 
»Œy
;

662 
	`PRINTK
("NFS„•ly„mdœ faed = %d\n", 
¡©us
);

664 
	`nfs_½c_ä“
(
p0
);

665  -
	`nfs_¡©_to_”ºo
(
¡©us
);

666 
	}
}

668 
	$nfs_´oc_»addœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

669 
cook›
, 
couÁ
, 
nfs_’Œy
 *
’Œy
)

671 *
p
, *
p0
;

672 
¡©us
;

673 
ruid
 = 0;

674 
i
 = 0;

675 
size
;

676 
eof
;

678 
	`PRINTK
("NFS c®È„—ddœ %d @ %d\n", 
couÁ
, 
cook›
);

679 
size
 = 
£rv”
->
rsize
;

680 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

681  -
EIO
;

682 
»Œy
:

683 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_READDIR
, 
ruid
);

684 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

685 *
p
++ = 
	`htÚl
(
cook›
);

686 *
p
++ = 
	`htÚl
(
size
);

687 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

688 
	`nfs_½c_ä“
(
p0
);

689  
¡©us
;

691 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

692 
¡©us
 = 
NFSERR_IO
;

693 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

694 
i
 = 0; i < 
couÁ
 && *
p
++; i++) {

695 ià(!(
p
 = 
	`xdr_decode_’Œy
Õ, 
’Œy
++)))

698 ià(!
p
) {

699 
	`´štk
("nfs_proc_readdir: giant filename\n");

700 
¡©us
 = 
NFSERR_IO
;

703 
eof
 = (
i
 =ğ
couÁ
 && !*
p
++ && *p++)

704 || (
i
 < 
couÁ
 && *
p
++);

705 ià(
eof
 && 
i
)

706 
’Œy
[-1].
eof
 = 1;

707 
	`PRINTK
("NFS„•ly„—ddœ %d %s\n", 
i
,

708 
eof
 ? "eof" : "");

712 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

713 
ruid
 = 1;

714 
»Œy
;

716 
	`PRINTK
("NFS„•ly„—ddœ faed = %d\n", 
¡©us
);

718 
	`nfs_½c_ä“
(
p0
);

719  (
¡©us
 =ğ
NFS_OK
è? 
i
 : -
	`nfs_¡©_to_”ºo
(status);

720 
	}
}

722 
	$nfs_´oc_¡©fs
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

723 
nfs_fsšfo
 *
»s
)

725 *
p
, *
p0
;

726 
¡©us
;

727 
ruid
 = 0;

729 
	`PRINTK
("NFS call statfs\n");

730 ià(!(
p0
 = 
	`nfs_½c_®loc
()))

731  -
EIO
;

732 
»Œy
:

733 
p
 = 
	`nfs_½c_h—d”
(
p0
, 
NFSPROC_STATFS
, 
ruid
);

734 
p
 = 
	`xdr_’code_fhªdË
Õ, 
fhªdË
);

735 ià((
¡©us
 = 
	`nfs_½c_ÿÎ
(
£rv”
, 
p0
, 
p
)) < 0) {

736 
	`nfs_½c_ä“
(
p0
);

737  
¡©us
;

739 ià(!(
p
 = 
	`nfs_½c_v”ify
(
p0
)))

740 
¡©us
 = 
NFSERR_IO
;

741 ià((
¡©us
 = 
	`Áohl
(*
p
++)è=ğ
NFS_OK
) {

742 
p
 = 
	`xdr_decode_fsšfo
Õ, 
»s
);

743 
	`PRINTK
("NFS„eply statfs\n");

746 ià(!
ruid
 && 
cu¼’t
->
euid
 =ğ0 && cu¼’t->
uid
 != 0) {

747 
ruid
 = 1;

748 
»Œy
;

750 
	`PRINTK
("NFS„•ly stf çed = %d\n", 
¡©us
);

752 
	`nfs_½c_ä“
(
p0
);

753  -
	`nfs_¡©_to_”ºo
(
¡©us
);

754 
	}
}

760 *
	$nfs_½c_h—d”
(*
p
, 
´oûdu»
, 
ruid
)

762 *
p1
, *
p2
;

763 
i
;

764 
xid
 = 0;

765 *
sys
 = (*è
sy¡em_ut¢ame
.
nod’ame
;

767 ià(
xid
 == 0) {

768 
xid
 = 
CURRENT_TIME
;

769 
xid
 ^ğ(
sys
[3]<<24) | (sys[2]<<16) | (sys[1]<<8) | sys[0];

771 *
p
++ = 
	`htÚl
(++
xid
);

772 *
p
++ = 
	`htÚl
(
RPC_CALL
);

773 *
p
++ = 
	`htÚl
(
RPC_VERSION
);

774 *
p
++ = 
	`htÚl
(
NFS_PROGRAM
);

775 *
p
++ = 
	`htÚl
(
NFS_VERSION
);

776 *
p
++ = 
	`htÚl
(
´oûdu»
);

777 *
p
++ = 
	`htÚl
(
RPC_AUTH_UNIX
);

778 
p1
 = 
p
++;

779 *
p
++ = 
	`htÚl
(
CURRENT_TIME
);

780 
p
 = 
	`xdr_’code_¡ršg
Õ, (*è
sys
);

781 *
p
++ = 
	`htÚl
(
ruid
 ? 
cu¼’t
->
uid
 : cu¼’t->
euid
);

782 *
p
++ = 
	`htÚl
(
cu¼’t
->
egid
);

783 
p2
 = 
p
++;

784 
i
 = 0; i < 16 && i < 
NGROUPS
 && 
cu¼’t
->
groups
[i] !ğ
NOGROUP
; i++)

785 *
p
++ = 
	`htÚl
(
cu¼’t
->
groups
[
i
]);

786 *
p2
 = 
	`htÚl
(
i
);

787 *
p1
 = 
	`htÚl
((
p
 - (p1 + 1)) << 2);

788 *
p
++ = 
	`htÚl
(
RPC_AUTH_NULL
);

789 *
p
++ = 
	`htÚl
(0);

790  
p
;

791 
	}
}

793 *
	$nfs_½c_v”ify
(*
p
)

795 
n
;

797 
p
++;

798 ià((
n
 = 
	`Áohl
(*
p
++)è!ğ
RPC_REPLY
) {

799 
	`´štk
("nfs_½c_v”ify:‚Ù‡ÀRPC„•ly: %d\n", 
n
);

800  
NULL
;

802 ià((
n
 = 
	`Áohl
(*
p
++)è!ğ
RPC_MSG_ACCEPTED
) {

803 
	`´štk
("nfs_½c_v”ify: RPC c®È»jeùed: %d\n", 
n
);

804  
NULL
;

806 
n
 = 
	`Áohl
(*
p
++)) {

807 
RPC_AUTH_NULL
: 
RPC_AUTH_UNIX
: 
RPC_AUTH_SHORT
:

810 
	`´štk
("nfs_½c_v”ify: bad RPC‡uth’tiÿtiÚy³: %d\n", 
n
);

811  
NULL
;

813 ià((
n
 = 
	`Áohl
(*
p
++)) > 400) {

814 
	`´štk
("nfs_rpc_verify: giant‡uth size\n");

815  
NULL
;

817 
p
 +ğ(
n
 + 3) >> 2;

818 ià((
n
 = 
	`Áohl
(*
p
++)è!ğ
RPC_SUCCESS
) {

819 
	`´štk
("nfs_½c_v”ify: RPC c®Èçed: %d\n", 
n
);

820  
NULL
;

822  
p
;

823 
	}
}

830 #iâdeà
EDQUOT


831 
	#EDQUOT
 
ENOSPC


	)

835 
	m¡©
;

836 
	m”ºo
;

837 } 
	gnfs_”¹bl
[] = {

838 { 
NFS_OK
, 0 },

839 { 
NFSERR_PERM
, 
EPERM
 },

840 { 
NFSERR_NOENT
, 
ENOENT
 },

841 { 
NFSERR_IO
, 
EIO
 },

842 { 
NFSERR_NXIO
, 
ENXIO
 },

843 { 
NFSERR_ACCES
, 
EACCES
 },

844 { 
NFSERR_EXIST
, 
EEXIST
 },

845 { 
NFSERR_NODEV
, 
ENODEV
 },

846 { 
NFSERR_NOTDIR
, 
ENOTDIR
 },

847 { 
NFSERR_ISDIR
, 
EISDIR
 },

848 { 
NFSERR_INVAL
, 
EINVAL
 },

849 { 
NFSERR_FBIG
, 
EFBIG
 },

850 { 
NFSERR_NOSPC
, 
ENOSPC
 },

851 { 
NFSERR_ROFS
, 
EROFS
 },

852 { 
NFSERR_NAMETOOLONG
, 
ENAMETOOLONG
 },

853 { 
NFSERR_NOTEMPTY
, 
ENOTEMPTY
 },

854 { 
NFSERR_DQUOT
, 
EDQUOT
 },

855 { 
NFSERR_STALE
, 
ESTALE
 },

856 #ifdeà
EWFLUSH


857 { 
NFSERR_WFLUSH
, 
EWFLUSH
 },

859 { -1, 
EIO
 }

862 
	$nfs_¡©_to_”ºo
(
¡©
)

864 
i
;

866 
i
 = 0; 
nfs_”¹bl
[i].
¡©
 != -1; i++) {

867 ià(
nfs_”¹bl
[
i
].
¡©
 == stat)

868  
nfs_”¹bl
[
i
].
”ºo
;

870 
	`´štk
("nfs_¡©_to_”ºo: bad‚f ¡©u »tuº v®ue: %d\n", 
¡©
);

871  
nfs_”¹bl
[
i
].
”ºo
;

872 
	}
}

	@fs/nfs/sock.c

9 
	~<lšux/cÚfig.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/nfs_fs.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/sock‘.h
>

14 
	~<lšux/fú.h
>

15 
	~<asm/£gm’t.h
>

16 
	~<lšux/š.h
>

17 
	~<lšux/Ãt.h
>

20 
sock‘
 *
socki_lookup
(
šode
 *inode);

22 
	#_S
(
Ä
è(1<<(Òr)-1))

	)

34 
	$do_nfs_½c_ÿÎ
(
nfs_£rv”
 *
£rv”
, *
¡¬t
, *
’d
)

36 
fe
 *file;

37 
šode
 *inode;

38 
sock‘
 *
sock
;

39 
fs
;

40 
»suÉ
;

41 
xid
;

42 
Ën
;

43 
£Ëù_bË
 
wa™_bË
;

44 
£Ëù_bË_’Œy
 
’Œy
;

45 (*
£Ëù
è(
šode
 *, 
fe
 *, , 
£Ëù_bË
 *);

46 
š™_timeout
, 
max_timeout
;

47 
timeout
;

48 
»Œªs
;

49 
majÜ_timeout_£’
;

50 *
£rv”_Çme
;

51 
n
;

52 
add¾’
;

53 
Şd_mask
;

55 
xid
 = 
¡¬t
[0];

56 
Ën
 = ((*è
’d
è- ((*è
¡¬t
);

57 
fe
 = 
£rv”
->file;

58 
šode
 = 
fe
->
f_šode
;

59 
£Ëù
 = 
fe
->
f_İ
->select;

60 
sock
 = 
	`socki_lookup
(
šode
);

61 ià(!
sock
) {

62 
	`´štk
("nfs_rpc_call: socki_lookup failed\n");

63  -
EBADF
;

65 
š™_timeout
 = 
£rv”
->
timeo
;

66 
max_timeout
 = 
NFS_MAX_RPC_TIMEOUT
*
HZ
/10;

67 
»Œªs
 = 
£rv”
->retrans;

68 
majÜ_timeout_£’
 = 0;

69 
£rv”_Çme
 = 
£rv”
->
ho¡Çme
;

70 
Şd_mask
 = 
cu¼’t
->
blocked
;

71 
cu¼’t
->
blocked
 |ğ~(
	`_S
(
SIGKILL
)

73 | 
	`_S
(
SIGSTOP
)

75 | ((
£rv”
->
æags
 & 
NFS_MOUNT_INTR
)

76 ? ((
cu¼’t
->
sigaùiÚ
[
SIGINT
 - 1].
§_hªdËr
 =ğ
SIG_DFL


77 ? 
	`_S
(
SIGINT
) : 0)

78 | (
cu¼’t
->
sigaùiÚ
[
SIGQUIT
 - 1].
§_hªdËr
 =ğ
SIG_DFL


79 ? 
	`_S
(
SIGQUIT
) : 0))

81 
fs
 = 
	`g‘_fs
();

82 
	`£t_fs
(
	`g‘_ds
());

83 
n
 = 0, 
timeout
 = 
š™_timeout
; ;‚++,imeout <<= 1) {

84 
»suÉ
 = 
sock
->
İs
->
	`£nd
(sock, (*è
¡¬t
, 
Ën
, 0, 0);

85 ià(
»suÉ
 < 0) {

86 
	`´štk
("nfs_½c_ÿÎ: s’dƒ¼Ü = %d\n", 
»suÉ
);

89 
»_£Ëù
:

90 
wa™_bË
.
Ä
 = 0;

91 
wa™_bË
.
’Œy
 = &entry;

92 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

93 ià(!
	`£Ëù
(
šode
, 
fe
, 
SEL_IN
, &
wa™_bË
)

94 && !
	`£Ëù
(
šode
, 
fe
, 
SEL_IN
, 
NULL
)) {

95 ià(
timeout
 > 
max_timeout
)

96 
timeout
 = 
max_timeout
;

97 
cu¼’t
->
timeout
 = 
jiff›s
 +imeout;

98 
	`scheduË
();

99 
	`»move_wa™_queue
(
’Œy
.
wa™_add»ss
, &’Œy.
wa™
);

100 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

101 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

102 
cu¼’t
->
timeout
 = 0;

103 
»suÉ
 = -
ERESTARTSYS
;

106 ià(!
cu¼’t
->
timeout
) {

107 ià(
n
 < 
»Œªs
)

109 ià(
£rv”
->
æags
 & 
NFS_MOUNT_SOFT
) {

110 
	`´štk
("NFS server %s‚ot„esponding, "

111 "timed out\n", 
£rv”_Çme
);

112 
»suÉ
 = -
EIO
;

115 
n
 = 0;

116 
timeout
 = 
š™_timeout
;

117 
š™_timeout
 <<= 1;

118 ià(!
majÜ_timeout_£’
) {

119 
	`´štk
("NFS server %s‚ot„esponding, "

120 "¡ÈŒyšg\n", 
£rv”_Çme
);

122 
majÜ_timeout_£’
 = 1;

126 
cu¼’t
->
timeout
 = 0;

128 ià(
wa™_bË
.
Ä
)

129 
	`»move_wa™_queue
(
’Œy
.
wa™_add»ss
, &’Œy.
wa™
);

130 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

131 
add¾’
 = 0;

132 
»suÉ
 = 
sock
->
İs
->
	`»cväom
(sock, (*è
¡¬t
, 
PAGE_SIZE
, 1, 0,

133 
NULL
, &
add¾’
);

134 ià(
»suÉ
 < 0) {

135 ià(
»suÉ
 =ğ-
EAGAIN
) {

137 
	`´štk
("nfs_rpc_call: bad select„eady\n");

139 
»_£Ëù
;

141 ià(
»suÉ
 =ğ-
ECONNREFUSED
) {

143 
	`´štk
("nfs_rpc_call: server…laying coy\n");

145 
»_£Ëù
;

147 ià(
»suÉ
 !ğ-
ERESTARTSYS
) {

148 
	`´štk
("nfs_rpc_call:„ecvƒrror = %d\n",

149 -
»suÉ
);

153 ià(*
¡¬t
 =ğ
xid
) {

154 ià(
majÜ_timeout_£’
)

155 
	`´štk
("NFS s”v” % OK\n", 
£rv”_Çme
);

159 
	`´štk
("nfs_rpc_call: XID mismatch\n");

162 
cu¼’t
->
blocked
 = 
Şd_mask
;

163 
	`£t_fs
(
fs
);

164  
»suÉ
;

165 
	}
}

173 
	$nfs_½c_ÿÎ
(
nfs_£rv”
 *
£rv”
, *
¡¬t
, *
’d
)

175 
»suÉ
;

177 
£rv”
->
lock
)

178 
	`¦“p_Ú
(&
£rv”
->
wa™
);

179 
£rv”
->
lock
 = 1;

180 
»suÉ
 = 
	`do_nfs_½c_ÿÎ
(
£rv”
, 
¡¬t
, 
’d
);

181 
£rv”
->
lock
 = 0;

182 
	`wake_up
(&
£rv”
->
wa™
);

183  
»suÉ
;

184 
	}
}

	@fs/nfs/symlink.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/nfs_fs.h
>

14 
	~<lšux/¡©.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/m®loc.h
>

18 
nfs_»adlšk
(
šode
 *, *, );

19 
nfs_fŞlow_lšk
(
šode
 *, inode *, , ,

20 
šode
 **);

25 
šode_İ”©iÚs
 
	gnfs_symlšk_šode_İ”©iÚs
 = {

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
nfs_»adlšk
,

37 
nfs_fŞlow_lšk
,

38 
NULL
,

39 
NULL
,

40 
NULL


43 
	$nfs_fŞlow_lšk
(
šode
 *
dœ
, inode *inode,

44 
æag
, 
mode
, 
šode
 **
»s_šode
)

46 
”rÜ
;

47 *
»s
;

49 *
»s_šode
 = 
NULL
;

50 ià(!
dœ
) {

51 
dœ
 = 
cu¼’t
->
roÙ
;

52 
dœ
->
i_couÁ
++;

54 ià(!
šode
) {

55 
	`ut
(
dœ
);

56  -
ENOENT
;

58 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

59 
	`ut
(
dœ
);

60 *
»s_šode
 = 
šode
;

63 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

64 
	`ut
(
šode
);

65 
	`ut
(
dœ
);

66  -
ELOOP
;

68 
»s
 = (*è
	`km®loc
(
NFS_MAXPATHLEN
 + 1, 
GFP_KERNEL
);

69 
”rÜ
 = 
	`nfs_´oc_»adlšk
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(šode), 
»s
);

70 ià(
”rÜ
) {

71 
	`ut
(
šode
);

72 
	`ut
(
dœ
);

73 
	`kä“_s
(
»s
, 
NFS_MAXPATHLEN
 + 1);

74  
”rÜ
;

76 
	`ut
(
šode
);

77 
cu¼’t
->
lšk_couÁ
++;

78 
”rÜ
 = 
	`İ’_Çmei
(
»s
, 
æag
, 
mode
, 
»s_šode
, 
dœ
);

79 
cu¼’t
->
lšk_couÁ
--;

80 
	`kä“_s
(
»s
, 
NFS_MAXPATHLEN
 + 1);

81  
”rÜ
;

82 
	}
}

84 
	$nfs_»adlšk
(
šode
 *šode, *
bufãr
, 
buæ’
)

86 
i
;

87 
c
;

88 
”rÜ
;

89 *
»s
;

91 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

92 
	`ut
(
šode
);

93  -
EINVAL
;

95 ià(
buæ’
 > 
NFS_MAXPATHLEN
)

96 
buæ’
 = 
NFS_MAXPATHLEN
;

97 
»s
 = (*è
	`km®loc
(
buæ’
 + 1, 
GFP_KERNEL
);

98 
”rÜ
 = 
	`nfs_´oc_»adlšk
(
	`NFS_SERVER
(
šode
), 
	`NFS_FH
(šode), 
»s
);

99 
	`ut
(
šode
);

100 ià(
”rÜ
) {

101 
	`kä“_s
(
»s
, 
buæ’
 + 1);

102  
”rÜ
;

104 
i
 = 0; i < 
buæ’
 && (
c
 = 
»s
[i]); i++)

105 
	`put_fs_by‹
(
c
,
bufãr
++);

106 
	`kä“_s
(
»s
, 
buæ’
 + 1);

107  
i
;

108 
	}
}

	@fs/open.c

7 
	~<lšux/vfs.h
>

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/utime.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/fú.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/sigÇl.h
>

17 
	~<lšux/‰y.h
>

18 
	~<lšux/time.h
>

20 
	~<asm/£gm’t.h
>

22 
fú_»move_locks
(
sk_¡ruù
 *, 
fe
 *, 
fd
);

24 
asmlškage
 
	$sys_u¡©
(
dev
, 
u¡©
 * 
ubuf
)

26  -
ENOSYS
;

27 
	}
}

29 
asmlškage
 
	$sys_¡©fs
(cÚ¡ * 
·th
, 
¡©fs
 * 
buf
)

31 
šode
 * inode;

32 
”rÜ
;

34 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
buf
, (
¡©fs
));

35 ià(
”rÜ
)

36  
”rÜ
;

37 
”rÜ
 = 
	`Çmei
(
·th
,&
šode
);

38 ià(
”rÜ
)

39  
”rÜ
;

40 ià(!
šode
->
i_sb
->
s_İ
->
¡©fs
) {

41 
	`ut
(
šode
);

42  -
ENOSYS
;

44 
šode
->
i_sb
->
s_İ
->
	`¡©fs
(šode->i_sb, 
buf
);

45 
	`ut
(
šode
);

47 
	}
}

49 
asmlškage
 
	$sys_f¡©fs
(
fd
, 
¡©fs
 * 
buf
)

51 
šode
 * inode;

52 
fe
 * file;

53 
”rÜ
;

55 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
buf
, (
¡©fs
));

56 ià(
”rÜ
)

57  
”rÜ
;

58 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

59  -
EBADF
;

60 ià(!(
šode
 = 
fe
->
f_šode
))

61  -
ENOENT
;

62 ià(!
šode
->
i_sb
->
s_İ
->
¡©fs
)

63  -
ENOSYS
;

64 
šode
->
i_sb
->
s_İ
->
	`¡©fs
(šode->i_sb, 
buf
);

66 
	}
}

68 
asmlškage
 
	$sys_Œunÿ‹
(cÚ¡ * 
·th
, 
Ëngth
)

70 
šode
 * inode;

71 
”rÜ
;

73 
”rÜ
 = 
	`Çmei
(
·th
,&
šode
);

74 ià(
”rÜ
)

75  
”rÜ
;

76 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| !
	`³rmissiÚ
(šode,
MAY_WRITE
)) {

77 
	`ut
(
šode
);

78  -
EACCES
;

80 ià(
	`IS_RDONLY
(
šode
)) {

81 
	`ut
(
šode
);

82  -
EROFS
;

84 
šode
->
i_size
 = 
Ëngth
;

85 ià(
šode
->
i_İ
 && inode->i_İ->
Œunÿ‹
)

86 
šode
->
i_İ
->
	`Œunÿ‹
(inode);

87 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME
;

88 
šode
->
i_dœt
 = 1;

89 
”rÜ
 = 
	`nÙify_chªge
(
NOTIFY_SIZE
, 
šode
);

90 
	`ut
(
šode
);

91  
”rÜ
;

92 
	}
}

94 
asmlškage
 
	$sys_árunÿ‹
(
fd
, 
Ëngth
)

96 
šode
 * inode;

97 
fe
 * file;

99 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

100  -
EBADF
;

101 ià(!(
šode
 = 
fe
->
f_šode
))

102  -
ENOENT
;

103 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| !(
fe
->
f_mode
 & 2))

104  -
EACCES
;

105 
šode
->
i_size
 = 
Ëngth
;

106 ià(
šode
->
i_İ
 && inode->i_İ->
Œunÿ‹
)

107 
šode
->
i_İ
->
	`Œunÿ‹
(inode);

108 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME
;

109 
šode
->
i_dœt
 = 1;

110  
	`nÙify_chªge
(
NOTIFY_SIZE
, 
šode
);

111 
	}
}

117 
asmlškage
 
	$sys_utime
(* 
f’ame
, 
utimbuf
 * 
times
)

119 
šode
 * inode;

120 
aùime
,
modtime
;

121 
”rÜ
;

123 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

124 ià(
”rÜ
)

125  
”rÜ
;

126 ià(
	`IS_RDONLY
(
šode
)) {

127 
	`ut
(
šode
);

128  -
EROFS
;

130 ià(
times
) {

131 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
è&& !
	`su£r
()) {

132 
	`ut
(
šode
);

133  -
EPERM
;

135 
aùime
 = 
	`g‘_fs_lÚg
((*è&
times
->actime);

136 
modtime
 = 
	`g‘_fs_lÚg
((*è&
times
->modtime);

137 
šode
->
i_ùime
 = 
CURRENT_TIME
;

139 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
) &&

140 !
	`³rmissiÚ
(
šode
,
MAY_WRITE
)) {

141 
	`ut
(
šode
);

142  -
EACCES
;

144 
aùime
 = 
modtime
 = 
šode
->
i_ùime
 = 
CURRENT_TIME
;

146 
šode
->
i_©ime
 = 
aùime
;

147 
šode
->
i_mtime
 = 
modtime
;

148 
šode
->
i_dœt
 = 1;

149 
”rÜ
 = 
	`nÙify_chªge
(
NOTIFY_TIME
, 
šode
);

150 
	`ut
(
šode
);

151  
”rÜ
;

152 
	}
}

158 
asmlškage
 
	$sys_acûss
(cÚ¡ * 
f’ame
,
mode
)

160 
šode
 * inode;

161 
»s
, 
i_mode
;

163 ià(
mode
 !ğ(mod& 
S_IRWXO
))

164  -
EINVAL
;

165 
»s
 = 
	`Çmei
(
f’ame
,&
šode
);

166 ià(
»s
)

167  
»s
;

168 
i_mode
 = 
šode
->i_mode;

169 
»s
 = 
i_mode
 & 
S_IRWXUGO
;

170 ià(
cu¼’t
->
uid
 =ğ
šode
->
i_uid
)

171 
»s
 >>= 6;

172 ià(
	`š_group_p
(
šode
->
i_gid
))

173 
»s
 >>= 3;

174 
	`ut
(
šode
);

175 ià((
»s
 & 
mode
) == mode)

186 ià((!
cu¼’t
->
uid
) &&

187 (
	`S_ISDIR
(
i_mode
è|| !(
mode
 & 
S_IXOTH
è|| (i_mod& 
S_IXUGO
)))

189  -
EACCES
;

190 
	}
}

192 
asmlškage
 
	$sys_chdœ
(cÚ¡ * 
f’ame
)

194 
šode
 * inode;

195 
”rÜ
;

197 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

198 ià(
”rÜ
)

199  
”rÜ
;

200 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

201 
	`ut
(
šode
);

202  -
ENOTDIR
;

204 ià(!
	`³rmissiÚ
(
šode
,
MAY_EXEC
)) {

205 
	`ut
(
šode
);

206  -
EACCES
;

208 
	`ut
(
cu¼’t
->
pwd
);

209 
cu¼’t
->
pwd
 = 
šode
;

211 
	}
}

213 
asmlškage
 
	$sys_fchdœ
(
fd
)

215 
šode
 * inode;

216 
fe
 * file;

218 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

219  -
EBADF
;

220 ià(!(
šode
 = 
fe
->
f_šode
))

221  -
ENOENT
;

222 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

223  -
ENOTDIR
;

224 ià(!
	`³rmissiÚ
(
šode
,
MAY_EXEC
))

225  -
EACCES
;

226 
	`ut
(
cu¼’t
->
pwd
);

227 
cu¼’t
->
pwd
 = 
šode
;

228 
šode
->
i_couÁ
++;

230 
	}
}

232 
asmlškage
 
	$sys_chroÙ
(cÚ¡ * 
f’ame
)

234 
šode
 * inode;

235 
”rÜ
;

237 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

238 ià(
”rÜ
)

239  
”rÜ
;

240 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

241 
	`ut
(
šode
);

242  -
ENOTDIR
;

244 ià(!
	`su£r
()) {

245 
	`ut
(
šode
);

246  -
EPERM
;

248 
	`ut
(
cu¼’t
->
roÙ
);

249 
cu¼’t
->
roÙ
 = 
šode
;

251 
	}
}

253 
asmlškage
 
	$sys_fchmod
(
fd
, 
mode_t
 
mode
)

255 
šode
 * inode;

256 
fe
 * file;

258 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

259  -
EBADF
;

260 ià(!(
šode
 = 
fe
->
f_šode
))

261  -
ENOENT
;

262 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
è&& !
	`su£r
())

263  -
EPERM
;

264 ià(
	`IS_RDONLY
(
šode
))

265  -
EROFS
;

266 ià(
mode
 =ğ(
mode_t
) -1)

267 
mode
 = 
šode
->
i_mode
;

268 
šode
->
i_mode
 = (
mode
 & 
S_IALLUGO
) | (inode->i_mode & ~S_IALLUGO);

269 ià(!
	`su£r
(è&& !
	`š_group_p
(
šode
->
i_gid
))

270 
šode
->
i_mode
 &ğ~
S_ISGID
;

271 
šode
->
i_ùime
 = 
CURRENT_TIME
;

272 
šode
->
i_dœt
 = 1;

273  
	`nÙify_chªge
(
NOTIFY_MODE
, 
šode
);

274 
	}
}

276 
asmlškage
 
	$sys_chmod
(cÚ¡ * 
f’ame
, 
mode_t
 
mode
)

278 
šode
 * inode;

279 
”rÜ
;

281 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

282 ià(
”rÜ
)

283  
”rÜ
;

284 ià((
cu¼’t
->
euid
 !ğ
šode
->
i_uid
è&& !
	`su£r
()) {

285 
	`ut
(
šode
);

286  -
EPERM
;

288 ià(
	`IS_RDONLY
(
šode
)) {

289 
	`ut
(
šode
);

290  -
EROFS
;

292 ià(
mode
 =ğ(
mode_t
) -1)

293 
mode
 = 
šode
->
i_mode
;

294 
šode
->
i_mode
 = (
mode
 & 
S_IALLUGO
) | (inode->i_mode & ~S_IALLUGO);

295 ià(!
	`su£r
(è&& !
	`š_group_p
(
šode
->
i_gid
))

296 
šode
->
i_mode
 &ğ~
S_ISGID
;

297 
šode
->
i_ùime
 = 
CURRENT_TIME
;

298 
šode
->
i_dœt
 = 1;

299 
”rÜ
 = 
	`nÙify_chªge
(
NOTIFY_MODE
, 
šode
);

300 
	`ut
(
šode
);

301  
”rÜ
;

302 
	}
}

304 
asmlškage
 
	$sys_fchown
(
fd
, 
uid_t
 
u£r
, 
gid_t
 
group
)

306 
šode
 * inode;

307 
fe
 * file;

309 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

310  -
EBADF
;

311 ià(!(
šode
 = 
fe
->
f_šode
))

312  -
ENOENT
;

313 ià(
	`IS_RDONLY
(
šode
))

314  -
EROFS
;

315 ià(
u£r
 =ğ(
uid_t
) -1)

316 
u£r
 = 
šode
->
i_uid
;

317 ià(
group
 =ğ(
gid_t
) -1)

318 
group
 = 
šode
->
i_gid
;

319 ià((
cu¼’t
->
euid
 =ğ
šode
->
i_uid
 && 
u£r
 == inode->i_uid &&

320 (
	`š_group_p
(
group
è|| grou°=ğ
šode
->
i_gid
)) ||

321 
	`su£r
()) {

322 
šode
->
i_uid
 = 
u£r
;

323 
šode
->
i_gid
 = 
group
;

324 
šode
->
i_ùime
 = 
CURRENT_TIME
;

325 
šode
->
i_dœt
 = 1;

326  
	`nÙify_chªge
(
NOTIFY_UIDGID
, 
šode
);

328  -
EPERM
;

329 
	}
}

331 
asmlškage
 
	$sys_chown
(cÚ¡ * 
f’ame
, 
uid_t
 
u£r
, 
gid_t
 
group
)

333 
šode
 * inode;

334 
”rÜ
;

336 
”rÜ
 = 
	`Êamei
(
f’ame
,&
šode
);

337 ià(
”rÜ
)

338  
”rÜ
;

339 ià(
	`IS_RDONLY
(
šode
)) {

340 
	`ut
(
šode
);

341  -
EROFS
;

343 ià(
u£r
 =ğ(
uid_t
) -1)

344 
u£r
 = 
šode
->
i_uid
;

345 ià(
group
 =ğ(
gid_t
) -1)

346 
group
 = 
šode
->
i_gid
;

347 ià((
cu¼’t
->
euid
 =ğ
šode
->
i_uid
 && 
u£r
 == inode->i_uid &&

348 (
	`š_group_p
(
group
è|| grou°=ğ
šode
->
i_gid
)) ||

349 
	`su£r
()) {

350 
šode
->
i_uid
 = 
u£r
;

351 
šode
->
i_gid
 = 
group
;

352 
šode
->
i_ùime
 = 
CURRENT_TIME
;

353 
šode
->
i_dœt
 = 1;

354 
”rÜ
 = 
	`nÙify_chªge
(
NOTIFY_UIDGID
, 
šode
);

355 
	`ut
(
šode
);

356  
”rÜ
;

358 
	`ut
(
šode
);

359  -
EPERM
;

360 
	}
}

376 
	$do_İ’
(cÚ¡ * 
f’ame
,
æags
,
mode
)

378 
šode
 * inode;

379 
fe
 * 
f
;

380 
æag
,
”rÜ
,
fd
;

382 
fd
=0 ; fd<
NR_OPEN
 ; fd++)

383 ià(!
cu¼’t
->
fp
[
fd
])

385 ià(
fd
>=
NR_OPEN
)

386  -
EMFILE
;

387 
	`FD_CLR
(
fd
,&
cu¼’t
->
şo£_Ú_exec
);

388 
f
 = 
	`g‘_em±y_fp
();

389 ià(!
f
)

390  -
ENFILE
;

391 
cu¼’t
->
fp
[
fd
] = 
f
;

392 
f
->
f_æags
 = 
æag
 = 
æags
;

393 
f
->
f_mode
 = (
æag
+1è& 
O_ACCMODE
;

394 ià(
f
->
f_mode
)

395 
æag
++;

396 ià(
æag
 & (
O_TRUNC
 | 
O_CREAT
))

397 
æag
 |= 2;

398 
”rÜ
 = 
	`İ’_Çmei
(
f’ame
,
æag
,
mode
,&
šode
,
NULL
);

399 ià(
”rÜ
) {

400 
cu¼’t
->
fp
[
fd
]=
NULL
;

401 
f
->
f_couÁ
--;

402  
”rÜ
;

405 
f
->
f_šode
 = 
šode
;

406 
f
->
f_pos
 = 0;

407 
f
->
f_»ada
 = 0;

408 
f
->
f_İ
 = 
NULL
;

409 ià(
šode
->
i_İ
)

410 
f
->
f_İ
 = 
šode
->
i_İ
->
deçuÉ_fe_İs
;

411 ià(
f
->
f_İ
 && f->f_İ->
İ’
) {

412 
”rÜ
 = 
f
->
f_İ
->
	`İ’
(
šode
,f);

413 ià(
”rÜ
) {

414 
	`ut
(
šode
);

415 
f
->
f_couÁ
--;

416 
cu¼’t
->
fp
[
fd
]=
NULL
;

417  
”rÜ
;

420 
f
->
f_æags
 &ğ~(
O_CREAT
 | 
O_EXCL
 | 
O_NOCTTY
 | 
O_TRUNC
);

421  (
fd
);

422 
	}
}

424 
asmlškage
 
	$sys_İ’
(cÚ¡ * 
f’ame
,
æags
,
mode
)

426 * 
tmp
;

427 
”rÜ
;

429 
”rÜ
 = 
	`g‘Çme
(
f’ame
, &
tmp
);

430 ià(
”rÜ
)

431  
”rÜ
;

432 
”rÜ
 = 
	`do_İ’
(
tmp
,
æags
,
mode
);

433 
	`puŠame
(
tmp
);

434  
”rÜ
;

435 
	}
}

437 
asmlškage
 
	$sys_ü—t
(cÚ¡ * 
·thÇme
, 
mode
)

439  
	`sys_İ’
(
·thÇme
, 
O_CREAT
 | 
O_WRONLY
 | 
O_TRUNC
, 
mode
);

440 
	}
}

442 
	$şo£_å
(
fe
 *
fp
, 
fd
)

444 
šode
 *inode;

446 ià(
fp
->
f_couÁ
 == 0) {

447 
	`´štk
("VFS: Close: file count is 0\n");

450 
šode
 = 
fp
->
f_šode
;

451 ià(
šode
 && 
	`S_ISREG
(šode->
i_mode
))

452 
	`fú_»move_locks
(
cu¼’t
, 
fp
, 
fd
);

453 ià(
fp
->
f_couÁ
 > 1) {

454 
fp
->
f_couÁ
--;

457 ià(
fp
->
f_İ
 && fp->f_İ->
»Ëa£
)

458 
fp
->
f_İ
->
	`»Ëa£
(
šode
,filp);

459 
fp
->
f_couÁ
--;

460 
fp
->
f_šode
 = 
NULL
;

461 
	`ut
(
šode
);

463 
	}
}

465 
asmlškage
 
	$sys_şo£
(
fd
)

467 
fe
 * 
fp
;

469 ià(
fd
 >ğ
NR_OPEN
)

470  -
EBADF
;

471 
	`FD_CLR
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

472 ià(!(
fp
 = 
cu¼’t
->fp[
fd
]))

473  -
EBADF
;

474 
cu¼’t
->
fp
[
fd
] = 
NULL
;

475  (
	`şo£_å
 (
fp
, 
fd
));

476 
	}
}

482 
asmlškage
 
	$sys_vhªgup
()

484 
‰y_¡ruù
 *
‰y
;

486 ià(!
	`su£r
())

487  -
EPERM
;

489 ià(
cu¼’t
->
‰y
 < 0)

491 
‰y
 = 
	`TTY_TABLE
(
	`MINOR
(
cu¼’t
->tty));

492 
	`‰y_vhªgup
(
‰y
);

494 
	}
}

	@fs/pipe.c

7 
	~<asm/£gm’t.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sigÇl.h
>

13 
	~<lšux/fú.h
>

14 
	~<lšux/‹rmios.h
>

24 
	$pe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

26 
ch¬s
 = 0, 
size
 = 0, 
»ad
 = 0;

27 *
pebuf
;

29 ià(
fp
->
f_æags
 & 
O_NONBLOCK
) {

30 ià(
	`PIPE_LOCK
(*
šode
))

31  -
EAGAIN
;

32 ià(
	`PIPE_EMPTY
(*
šode
))

33 ià(
	`PIPE_WRITERS
(*
šode
))

34  -
EAGAIN
;

37 } 
	`PIPE_EMPTY
(*
šode
è|| 
	`PIPE_LOCK
(*inode)) {

38 ià(
	`PIPE_EMPTY
(*
šode
)) {

39 ià(!
	`PIPE_WRITERS
(*
šode
))

42 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

43  -
ERESTARTSYS
;

44 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

46 
	`PIPE_LOCK
(*
šode
)++;

47 
couÁ
>0 && (
size
 = 
	`PIPE_SIZE
(*
šode
))) {

48 
ch¬s
 = 
	`PIPE_MAX_RCHUNK
(*
šode
);

49 ià(
ch¬s
 > 
couÁ
)

50 
ch¬s
 = 
couÁ
;

51 ià(
ch¬s
 > 
size
)

52 
ch¬s
 = 
size
;

53 
»ad
 +ğ
ch¬s
;

54 
pebuf
 = 
	`PIPE_BASE
(*
šode
)+
	`PIPE_START
(*inode);

55 
	`PIPE_START
(*
šode
è+ğ
ch¬s
;

56 
	`PIPE_START
(*
šode
è&ğ(
PIPE_BUF
-1);

57 
	`PIPE_LEN
(*
šode
è-ğ
ch¬s
;

58 
couÁ
 -ğ
ch¬s
;

59 
	`memıy_tofs
(
buf
, 
pebuf
, 
ch¬s
 );

60 
buf
 +ğ
ch¬s
;

62 
	`PIPE_LOCK
(*
šode
)--;

63 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

64 ià(
»ad
)

65  
»ad
;

66 ià(
	`PIPE_WRITERS
(*
šode
))

67  -
EAGAIN
;

69 
	}
}

71 
	$pe_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

73 
ch¬s
 = 0, 
ä“
 = 0, 
wr™‹n
 = 0;

74 *
pebuf
;

76 ià(!
	`PIPE_READERS
(*
šode
)) {

77 
	`£nd_sig
(
SIGPIPE
,
cu¼’t
,0);

78  -
EPIPE
;

81 ià(
couÁ
 <ğ
PIPE_BUF
)

82 
ä“
 = 
couÁ
;

84 
ä“
 = 1;

85 
couÁ
>0) {

86 (
	`PIPE_FREE
(*
šode
è< 
ä“
è|| 
	`PIPE_LOCK
(*inode)) {

87 ià(!
	`PIPE_READERS
(*
šode
)) {

88 
	`£nd_sig
(
SIGPIPE
,
cu¼’t
,0);

89  
wr™‹n
? :-
EPIPE
;

91 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

92  
wr™‹n
? :-
ERESTARTSYS
;

93 ià(
fp
->
f_æags
 & 
O_NONBLOCK
)

94  
wr™‹n
? :-
EAGAIN
;

95 
	`š‹¼u±ibË_¦“p_Ú
(&
	`PIPE_WAIT
(*
šode
));

97 
	`PIPE_LOCK
(*
šode
)++;

98 
couÁ
>0 && (
ä“
 = 
	`PIPE_FREE
(*
šode
))) {

99 
ch¬s
 = 
	`PIPE_MAX_WCHUNK
(*
šode
);

100 ià(
ch¬s
 > 
couÁ
)

101 
ch¬s
 = 
couÁ
;

102 ià(
ch¬s
 > 
ä“
)

103 
ch¬s
 = 
ä“
;

104 
pebuf
 = 
	`PIPE_BASE
(*
šode
)+
	`PIPE_END
(*inode);

105 
wr™‹n
 +ğ
ch¬s
;

106 
	`PIPE_LEN
(*
šode
è+ğ
ch¬s
;

107 
couÁ
 -ğ
ch¬s
;

108 
	`memıy_äomfs
(
pebuf
, 
buf
, 
ch¬s
 );

109 
buf
 +ğ
ch¬s
;

111 
	`PIPE_LOCK
(*
šode
)--;

112 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

113 
ä“
 = 1;

115  
wr™‹n
;

116 
	}
}

118 
	$pe_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üig
)

120  -
ESPIPE
;

121 
	}
}

123 
	$pe_»addœ
(
šode
 * inode, 
fe
 * fe, 
dœ’t
 * 
de
, 
couÁ
)

125  -
ENOTDIR
;

126 
	}
}

128 
	$bad_pe_rw
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

130  -
EBADF
;

131 
	}
}

133 
	$pe_ioùl
(
šode
 *
pšo
, 
fe
 * 
fp
,

134 
cmd
, 
¬g
)

136 
”rÜ
;

138 
cmd
) {

139 
FIONREAD
:

140 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
¬g
,4);

141 ià(!
”rÜ
)

142 
	`put_fs_lÚg
(
	`PIPE_SIZE
(*
pšo
),(*è
¬g
);

143  
”rÜ
;

145  -
EINVAL
;

147 
	}
}

149 
	$pe_£Ëù
(
šode
 * inode, 
fe
 * 
fp
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

151 
£l_ty³
) {

152 
SEL_IN
:

153 ià(!
	`PIPE_EMPTY
(*
šode
è|| !
	`PIPE_WRITERS
(*inode))

155 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

157 
SEL_OUT
:

158 ià(!
	`PIPE_FULL
(*
šode
è|| !
	`PIPE_READERS
(*inode))

160 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

162 
SEL_EX
:

163 ià(!
	`PIPE_READERS
(*
šode
è|| !
	`PIPE_WRITERS
(*inode))

165 
	`£Ëù_wa™
(&
šode
->
i_wa™
,
wa™
);

169 
	}
}

175 
	$fifo_£Ëù
(
šode
 * inode, 
fe
 * 
fp
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

177 
£l_ty³
) {

178 
SEL_IN
:

179 ià(!
	`PIPE_EMPTY
(*
šode
))

181 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

183 
SEL_OUT
:

184 ià(!
	`PIPE_FULL
(*
šode
è|| !
	`PIPE_READERS
(*inode))

186 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

188 
SEL_EX
:

189 ià(!
	`PIPE_READERS
(*
šode
è|| !
	`PIPE_WRITERS
(*inode))

191 
	`£Ëù_wa™
(&
šode
->
i_wa™
,
wa™
);

195 
	}
}

202 
	$cÚÃù_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

204 !
	`PIPE_SIZE
(*
šode
)) {

205 ià(
	`PIPE_WRITERS
(*
šode
))

207 ià(
fp
->
f_æags
 & 
O_NONBLOCK
)

208  -
EAGAIN
;

209 
	`wake_up_š‹¼u±ibË
(& 
	`PIPE_WAIT
(*
šode
));

210 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

211  -
ERESTARTSYS
;

212 
	`š‹¼u±ibË_¦“p_Ú
(& 
	`PIPE_WAIT
(*
šode
));

214 
fp
->
f_İ
 = &
»ad_fifo_fİs
;

215  
	`pe_»ad
(
šode
,
fp
,
buf
,
couÁ
);

216 
	}
}

218 
	$cÚÃù_£Ëù
(
šode
 * inode, 
fe
 * 
fp
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

220 
£l_ty³
) {

221 
SEL_IN
:

222 ià(!
	`PIPE_EMPTY
(*
šode
)) {

223 
fp
->
f_İ
 = &
»ad_fifo_fİs
;

226 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

228 
SEL_OUT
:

229 ià(!
	`PIPE_FULL
(*
šode
))

231 
	`£Ëù_wa™
(&
	`PIPE_WAIT
(*
šode
), 
wa™
);

233 
SEL_EX
:

234 ià(!
	`PIPE_READERS
(*
šode
è|| !
	`PIPE_WRITERS
(*inode))

236 
	`£Ëù_wa™
(&
šode
->
i_wa™
,
wa™
);

240 
	}
}

246 
	$pe_»ad_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

248 
	`PIPE_READERS
(*
šode
)--;

249 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

250 
	}
}

252 
	$pe_wr™e_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

254 
	`PIPE_WRITERS
(*
šode
)--;

255 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

256 
	}
}

258 
	$pe_rdwr_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
)

260 
	`PIPE_READERS
(*
šode
)--;

261 
	`PIPE_WRITERS
(*
šode
)--;

262 
	`wake_up_š‹¼u±ibË
(&
	`PIPE_WAIT
(*
šode
));

263 
	}
}

269 
fe_İ”©iÚs
 
	gcÚÃùšg_fifo_fİs
 = {

270 
pe_l£ek
,

271 
cÚÃù_»ad
,

272 
bad_pe_rw
,

273 
pe_»addœ
,

274 
cÚÃù_£Ëù
,

275 
pe_ioùl
,

276 
NULL
,

277 
NULL
,

278 
pe_»ad_»Ëa£
,

279 
NULL


282 
fe_İ”©iÚs
 
	g»ad_fifo_fİs
 = {

283 
pe_l£ek
,

284 
pe_»ad
,

285 
bad_pe_rw
,

286 
pe_»addœ
,

287 
fifo_£Ëù
,

288 
pe_ioùl
,

289 
NULL
,

290 
NULL
,

291 
pe_»ad_»Ëa£
,

292 
NULL


295 
fe_İ”©iÚs
 
	gwr™e_fifo_fİs
 = {

296 
pe_l£ek
,

297 
bad_pe_rw
,

298 
pe_wr™e
,

299 
pe_»addœ
,

300 
fifo_£Ëù
,

301 
pe_ioùl
,

302 
NULL
,

303 
NULL
,

304 
pe_wr™e_»Ëa£
,

305 
NULL


308 
fe_İ”©iÚs
 
	grdwr_fifo_fİs
 = {

309 
pe_l£ek
,

310 
pe_»ad
,

311 
pe_wr™e
,

312 
pe_»addœ
,

313 
fifo_£Ëù
,

314 
pe_ioùl
,

315 
NULL
,

316 
NULL
,

317 
pe_rdwr_»Ëa£
,

318 
NULL


321 
fe_İ”©iÚs
 
	g»ad_pe_fİs
 = {

322 
pe_l£ek
,

323 
pe_»ad
,

324 
bad_pe_rw
,

325 
pe_»addœ
,

326 
pe_£Ëù
,

327 
pe_ioùl
,

328 
NULL
,

329 
NULL
,

330 
pe_»ad_»Ëa£
,

331 
NULL


334 
fe_İ”©iÚs
 
	gwr™e_pe_fİs
 = {

335 
pe_l£ek
,

336 
bad_pe_rw
,

337 
pe_wr™e
,

338 
pe_»addœ
,

339 
pe_£Ëù
,

340 
pe_ioùl
,

341 
NULL
,

342 
NULL
,

343 
pe_wr™e_»Ëa£
,

344 
NULL


347 
fe_İ”©iÚs
 
	grdwr_pe_fİs
 = {

348 
pe_l£ek
,

349 
pe_»ad
,

350 
pe_wr™e
,

351 
pe_»addœ
,

352 
pe_£Ëù
,

353 
pe_ioùl
,

354 
NULL
,

355 
NULL
,

356 
pe_rdwr_»Ëa£
,

357 
NULL


360 
šode_İ”©iÚs
 
	gpe_šode_İ”©iÚs
 = {

361 &
rdwr_pe_fİs
,

362 
NULL
,

363 
NULL
,

364 
NULL
,

365 
NULL
,

366 
NULL
,

367 
NULL
,

368 
NULL
,

369 
NULL
,

370 
NULL
,

371 
NULL
,

372 
NULL
,

373 
NULL
,

374 
NULL
,

375 
NULL


378 
asmlškage
 
	$sys_pe
(* 
fdes
)

380 
šode
 * inode;

381 
fe
 * 
f
[2];

382 
fd
[2];

383 
i
,
j
;

385 
j
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
fdes
,8);

386 ià(
j
)

387  
j
;

388 
j
=0 ; j<2 ; j++)

389 ià(!(
f
[
j
] = 
	`g‘_em±y_fp
()))

391 ià(
j
==1)

392 
f
[0]->
f_couÁ
--;

393 ià(
j
<2)

394  -
ENFILE
;

395 
j
=0;

396 
i
=0;
j
<2 && i<
NR_OPEN
;i++)

397 ià(!
cu¼’t
->
fp
[
i
]) {

398 
cu¼’t
->
fp
[ 
fd
[
j
]=
i
 ] = 
f
[j];

399 
j
++;

401 ià(
j
==1)

402 
cu¼’t
->
fp
[
fd
[0]]=
NULL
;

403 ià(
j
<2) {

404 
f
[0]->
f_couÁ
--;

405 
f
[1]->
f_couÁ
--;

406  -
EMFILE
;

408 ià(!(
šode
=
	`g‘_pe_šode
())) {

409 
cu¼’t
->
fp
[
fd
[0]] = 
NULL
;

410 
cu¼’t
->
fp
[
fd
[1]] = 
NULL
;

411 
f
[0]->
f_couÁ
--;

412 
f
[1]->
f_couÁ
--;

413  -
ENFILE
;

415 
f
[0]->
f_šode
 = f[1]->f_šodğ
šode
;

416 
f
[0]->
f_pos
 = f[1]->f_pos = 0;

417 
f
[0]->
f_æags
 = 
O_RDONLY
;

418 
f
[0]->
f_İ
 = &
»ad_pe_fİs
;

419 
f
[0]->
f_mode
 = 1;

420 
f
[1]->
f_æags
 = 
O_WRONLY
;

421 
f
[1]->
f_İ
 = &
wr™e_pe_fİs
;

422 
f
[1]->
f_mode
 = 2;

423 
	`put_fs_lÚg
(
fd
[0],0+
fdes
);

424 
	`put_fs_lÚg
(
fd
[1],1+
fdes
);

426 
	}
}

	@fs/proc/array.c

10 
	~<lšux/ty³s.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/k”Ãl_¡©.h
>

15 
	~<lšux/‰y.h
>

16 
	~<lšux/u£r.h
>

17 
	~<lšux/a.out.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/mmª.h
>

21 
	~<asm/£gm’t.h
>

22 
	~<asm/io.h
>

24 
	#LOAD_INT
(
x
è((xè>> 
FSHIFT
)

	)

25 
	#LOAD_FRAC
(
x
è
	`LOAD_INT
(((xè& (
FIXED_1
-1)è* 100)

	)

27 #ifdeà
CONFIG_DEBUG_MALLOC


28 
g‘_m®loc
(* 
bufãr
);

31 
	$»ad_cÜe
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

33 
p
 = 
fe
->
f_pos
;

34 
»ad
;

35 
couÁ1
;

36 * 
²t
;

37 
u£r
 
dump
;

39 
	`mem£t
(&
dump
, 0, (
u£r
));

40 
dump
.
magic
 = 
CMAGIC
;

41 
dump
.
u_dsize
 = 
high_memÜy
 >> 12;

43 ià(
couÁ
 < 0)

44  -
EINVAL
;

45 ià(
p
 >ğ
high_memÜy
 + 
PAGE_SIZE
)

47 ià(
couÁ
 > 
high_memÜy
 + 
PAGE_SIZE
 - 
p
)

48 
couÁ
 = 
high_memÜy
 + 
PAGE_SIZE
 - 
p
;

49 
»ad
 = 0;

51 ià(
p
 < (
u£r
è&& 
couÁ
 > 0) {

52 
couÁ1
 = 
couÁ
;

53 ià(
p
 + 
couÁ1
 > (
u£r
))

54 
couÁ1
 = (
u£r
)-
p
;

55 
²t
 = (*è&
dump
 + 
p
;

56 
	`memıy_tofs
(
buf
,(*è
²t
, 
couÁ1
);

57 
buf
 +ğ
couÁ1
;

58 
p
 +ğ
couÁ1
;

59 
couÁ
 -ğ
couÁ1
;

60 
»ad
 +ğ
couÁ1
;

63 
p
 < 2*
PAGE_SIZE
 && 
couÁ
 > 0) {

64 
	`put_fs_by‹
(0,
buf
);

65 
buf
++;

66 
p
++;

67 
couÁ
--;

68 
»ad
++;

70 
	`memıy_tofs
(
buf
,(*è(
p
 - 
PAGE_SIZE
),
couÁ
);

71 
»ad
 +ğ
couÁ
;

72 
fe
->
f_pos
 +ğ
»ad
;

73  
»ad
;

74 
	}
}

76 
	$g‘_lßdavg
(* 
bufãr
)

78 
a
, 
b
, 
c
;

80 
a
 = 
av’run
[0] + (
FIXED_1
/200);

81 
b
 = 
av’run
[1] + (
FIXED_1
/200);

82 
c
 = 
av’run
[2] + (
FIXED_1
/200);

83  
	`¥rštf
(
bufãr
,"%d.%02d %d.%02d %d.%02d\n",

84 
	`LOAD_INT
(
a
), 
	`LOAD_FRAC
(a),

85 
	`LOAD_INT
(
b
), 
	`LOAD_FRAC
(b),

86 
	`LOAD_INT
(
c
), 
	`LOAD_FRAC
(c));

87 
	}
}

89 
	$g‘_k¡©
(* 
bufãr
)

91  
	`¥rštf
(
bufãr
, "cpu %u %u %u %lu\n"

98 
k¡©
.
ıu_u£r
,

99 
k¡©
.
ıu_niû
,

100 
k¡©
.
ıu_sy¡em
,

101 
jiff›s
 - (
k¡©
.
ıu_u£r
 + k¡©.
ıu_niû
 + k¡©.
ıu_sy¡em
),

102 
k¡©
.
dk_drive
[0],

103 
k¡©
.
dk_drive
[1],

104 
k¡©
.
dk_drive
[2],

105 
k¡©
.
dk_drive
[3],

106 
k¡©
.
pgpgš
,

107 
k¡©
.
pgpgout
,

108 
k¡©
.
pswpš
,

109 
k¡©
.
pswpout
,

110 
k¡©
.
š‹¼u±s
,

111 
k¡©
.
cÚ‹xt_swtch
,

112 
xtime
.
tv_£c
 - 
jiff›s
 / 
HZ
);

113 
	}
}

116 
	$g‘_u±ime
(* 
bufãr
)

118 
u±ime
;

119 
idË
;

121 
u±ime
 = 
jiff›s
;

122 
idË
 = 
sk
[0]->
utime
 +ask[0]->
¡ime
;

123  
	`¥rštf
(
bufãr
,"%lu.%02lu %lu.%02lu\n",

124 
u±ime
 / 
HZ
,

125 
u±ime
 % 
HZ
,

126 
idË
 / 
HZ
,

127 
idË
 % 
HZ
);

128 
	}
}

130 
	$g‘_memšfo
(* 
bufãr
)

132 
sysšfo
 
i
;

134 
	`si_memšfo
(&
i
);

135 
	`si_sw­šfo
(&
i
);

136  
	`¥rštf
(
bufãr
, "otal: used: free: shared: buffers:\n"

139 
i
.
tÙ®¿m
, i.tÙ®¿m-i.
ä“¿m
, i.ä“¿m, i.
sh¬ed¿m
, i.
bufã¼am
,

140 
i
.
tÙ®sw­
, i.tÙ®sw­-i.
ä“sw­
, i.freeswap);

141 
	}
}

143 
	$g‘_v”siÚ
(* 
bufãr
)

145 *
lšux_bªÃr
;

147 
	`¡rıy
(
bufãr
, 
lšux_bªÃr
);

148  
	`¡¾’
(
bufãr
);

149 
	}
}

151 
sk_¡ruù
 ** 
	$g‘_sk
(
pid_t
 
pid
)

153 
sk_¡ruù
 ** 
p
;

155 
p
 = 
sk
;

156 ++
p
 < 
sk
+
NR_TASKS
) {

157 ià(*
p
 && (*p)->
pid
 ==…id)

158  
p
;

160  
NULL
;

161 
	}
}

163 
	$g‘_phys_addr
(
sk_¡ruù
 ** 
p
, 
±r
)

165 
·ge
;

167 ià(!
p
 || !*°|| 
±r
 >ğ
TASK_SIZE
)

169 
·ge
 = *
	`PAGE_DIR_OFFSET
((*
p
)->
tss
.
ü3
,
±r
);

170 ià(!(
·ge
 & 1))

172 
·ge
 &ğ
PAGE_MASK
;

173 
·ge
 +ğ
	`PAGE_PTR
(
±r
);

174 
·ge
 = *(*)…age;

175 ià(!(
·ge
 & 1))

177 
·ge
 &ğ
PAGE_MASK
;

178 
·ge
 +ğ
±r
 & ~
PAGE_MASK
;

179  
·ge
;

180 
	}
}

182 
	$g‘_¬¿y
(
sk_¡ruù
 ** 
p
, 
¡¬t
, 
’d
, * 
bufãr
)

184 
addr
;

185 
size
 = 0, 
»suÉ
 = 0;

186 
c
;

188 ià(
¡¬t
 >ğ
’d
)

189  
»suÉ
;

191 
addr
 = 
	`g‘_phys_addr
(
p
, 
¡¬t
);

192 ià(!
addr
)

193  
»suÉ
;

195 
c
 = *(*è
addr
;

196 ià(!
c
)

197 
»suÉ
 = 
size
;

198 ià(
size
 < 
PAGE_SIZE
)

199 
bufãr
[
size
++] = 
c
;

201  
»suÉ
;

202 
addr
++;

203 
¡¬t
++;

204 ià(
¡¬t
 >ğ
’d
)

205  
»suÉ
;

206 } !(
addr
 & ~
PAGE_MASK
));

208 
	}
}

210 
	$g‘_’v
(
pid
, * 
bufãr
)

212 
sk_¡ruù
 ** 
p
 = 
	`g‘_sk
(
pid
);

214 ià(!
p
 || !*p)

216  
	`g‘_¬¿y
(
p
, (*p)->
’v_¡¬t
, (*p)->
’v_’d
, 
bufãr
);

217 
	}
}

219 
	$g‘_¬g
(
pid
, * 
bufãr
)

221 
sk_¡ruù
 ** 
p
 = 
	`g‘_sk
(
pid
);

223 ià(!
p
 || !*p)

225  
	`g‘_¬¿y
(
p
, (*p)->
¬g_¡¬t
, (*p)->
¬g_’d
, 
bufãr
);

226 
	}
}

228 
	$g‘_wchª
(
sk_¡ruù
 *
p
)

230 
ebp
, 
e
;

231 
¡ack_·ge
;

232 
couÁ
 = 0;

234 ià(!
p
 ||… =ğ
cu¼’t
 ||…->
¡©e
 =ğ
TASK_RUNNING
)

236 
¡ack_·ge
 = 
p
->
k”Ãl_¡ack_·ge
;

237 ià(!
¡ack_·ge
)

239 
ebp
 = 
p
->
tss
.ebp;

241 ià(
ebp
 < 
¡ack_·ge
 ||ƒbp >= 4092+stack_page)

243 
e
 = *(*è(
ebp
+4);

244 ià((*)
e
 !ğ
¦“p_Ú
 &&

245 (*)
e
 !ğ
š‹¼u±ibË_¦“p_Ú
)

246  
e
;

247 
ebp
 = *(*)ƒbp;

248 } 
couÁ
++ < 16);

250 
	}
}

252 
	#KSTK_EIP
(
¡ack
è(((*)¡ack)[1019])

	)

253 
	#KSTK_ESP
(
¡ack
è(((*)¡ack)[1022])

	)

255 
	$g‘_¡©
(
pid
, * 
bufãr
)

257 
sk_¡ruù
 ** 
p
 = 
	`g‘_sk
(
pid
);

258 
sigignÜe
=0, 
sigÿtch
=0, 
b™
=1, 
wchª
;

259 
vsize
, 
e
, 
e¥
;

260 
i
,
‰y_pg½
;

261 
¡©e
;

263 ià(!
p
 || !*p)

265 ià((*
p
)->
¡©e
 < 0 || (*p)->state > 5)

266 
¡©e
 = '.';

268 
¡©e
 = "RSDZTD"[(*
p
)->state];

269 
e
 = 
e¥
 = 0;

270 
vsize
 = (*
p
)->
k”Ãl_¡ack_·ge
;

271 ià(
vsize
) {

272 
e
 = 
	`KSTK_EIP
(
vsize
);

273 
e¥
 = 
	`KSTK_ESP
(
vsize
);

274 
vsize
 = (*
p
)->
brk
 - (*p)->
¡¬t_code
 + 
PAGE_SIZE
-1;

275 ià(
e¥
)

276 
vsize
 +ğ
TASK_SIZE
 - 
e¥
;

278 
wchª
 = 
	`g‘_wchª
(*
p
);

279 
i
=0; i<32; ++i) {

280 (è(*
p
)->
sigaùiÚ
[
i
].
§_hªdËr
) {

281 1: 
sigignÜe
 |ğ
b™
; ;

283 : 
sigÿtch
 |ğ
b™
;

284 } 
b™
 <<= 1;

286 
‰y_pg½
 = (*
p
)->
‰y
;

287 ià(
‰y_pg½
 > 0 && 
‰y_bË
[tty_pgrp])

288 
‰y_pg½
 = 
‰y_bË
[‰y_pg½]->
pg½
;

290 
‰y_pg½
 = -1;

291  
	`¥rštf
(
bufãr
,"%d (%s) %c %d %d %d %d %d %lu %lu \
%lu %lu %lu %ld %ld %ld %ld %ld %ld %lu %lu %ld %lu %u %u %lu %lu %lu %lu %lu %lu \
%lu %lu %lu %lu\n",

294 
pid
,

295 (*
p
)->
comm
,

296 
¡©e
,

297 (*
p
)->
p_µŒ
->
pid
,

298 (*
p
)->
pg½
,

299 (*
p
)->
£ssiÚ
,

300 (*
p
)->
‰y
,

301 
‰y_pg½
,

302 (*
p
)->
æags
,

303 (*
p
)->
mš_æt
,

304 (*
p
)->
cmš_æt
,

305 (*
p
)->
maj_æt
,

306 (*
p
)->
cmaj_æt
,

307 (*
p
)->
utime
,

308 (*
p
)->
¡ime
,

309 (*
p
)->
cutime
,

310 (*
p
)->
c¡ime
,

311 (*
p
)->
couÁ”
,

313 (*
p
)->
´iÜ™y
,

315 (*
p
)->
timeout
,

316 (*
p
)->
™_»®_v®ue
,

317 (*
p
)->
¡¬t_time
,

318 
vsize
,

319 (*
p
)->
rss
,

320 (*
p
)->
¾im
[
RLIMIT_RSS
].
¾im_cur
,

321 (*
p
)->
¡¬t_code
,

322 (*
p
)->
’d_code
,

323 (*
p
)->
¡¬t_¡ack
,

324 
e¥
,

325 
e
,

326 (*
p
)->
sigÇl
,

327 (*
p
)->
blocked
,

328 
sigignÜe
,

329 
sigÿtch
,

330 
wchª
);

331 
	}
}

333 
	$g‘_¡©m
(
pid
, * 
bufãr
)

335 
sk_¡ruù
 ** 
p
 = 
	`g‘_sk
(
pid
);

336 
i
, 
ag
;

337 
size
=0, 
»sid’t
=0, 
sh¬e
=0, 
Œs
=0, 
Ìs
=0, 
drs
=0, 
dt
=0;

338 
±bl
, *
buf
, *
±e
, *
·gedœ
, 
m­_Ä
;

340 ià(!
p
 || !*p)

342 
ag
 = (*
p
)->
’d_code
 / 
PAGE_SIZE
;

343 ià((*
p
)->
¡©e
 !ğ
TASK_ZOMBIE
) {

344 
·gedœ
 = (*è(*
p
)->
tss
.
ü3
;

345 
i
 = 0; i < 0x300; ++i) {

346 ià((
±bl
 = 
·gedœ
[
i
]) == 0) {

347 
ag
 -ğ
PTRS_PER_PAGE
;

350 
buf
 = (*)(
±bl
 & 
PAGE_MASK
);

351 
±e
 = 
buf
;…‹ < (buà+ 
PTRS_PER_PAGE
); ++pte) {

352 ià(*
±e
 != 0) {

353 ++
size
;

354 ià(*
±e
 & 1) {

355 ++
»sid’t
;

356 ià(
ag
 > 0)

357 ++
Œs
;

359 ++
drs
;

360 ià(
i
 >= 15 && i < 0x2f0) {

361 ++
Ìs
;

362 ià(*
±e
 & 0x40)

363 ++
dt
;

365 --
drs
;

367 
m­_Ä
 = 
	`MAP_NR
(*
±e
);

368 ià(
m­_Ä
 < (
high_memÜy
 / 
PAGE_SIZE
è&& 
mem_m­
[map_nr] > 1)

369 ++
sh¬e
;

372 --
ag
;

376  
	`¥rštf
(
bufãr
,"%d %d %d %d %d %d %d\n",

377 
size
, 
»sid’t
, 
sh¬e
, 
Œs
, 
Ìs
, 
drs
, 
dt
);

378 
	}
}

380 
	$g‘_m­s
(
pid
, *
buf
)

382 
sz
 = 0;

383 
sk_¡ruù
 **
p
 = 
	`g‘_sk
(
pid
);

384 
vm_¬—_¡ruù
 *
m­
;

386 ià(!
p
 || !*p)

389 
m­
 = (*
p
)->
mm­
; m­ !ğ
NULL
; m­ = m­->
vm_Ãxt
) {

390 
¡r
[7], *
ı
 = str;

391 
´Ù
 = 
m­
->
vm_·ge_´Ù
;

392 
³rms
, 
æags
;

393 
’d
 = 
sz
 + 80;

394 
dev_t
 
dev
;

395 
šo
;

403 
æags
 = 
³rms
 = 0;

405 ià((
´Ù
 & 
PAGE_READONLY
) == PAGE_READONLY)

406 
³rms
 |ğ
PROT_READ
 | 
PROT_EXEC
;

407 ià(
´Ù
 & (
PAGE_COW
|
PAGE_RW
)) {

408 
³rms
 |ğ
PROT_WRITE
 | 
PROT_READ
;

409 
æags
 = 
´Ù
 & 
PAGE_COW
 ? 
MAP_PRIVATE
 : 
MAP_SHARED
;

412 *
ı
++ = 
³rms
 & 
PROT_READ
 ? 'r' : '-';

413 *
ı
++ = 
³rms
 & 
PROT_WRITE
 ? 'w' : '-';

414 *
ı
++ = 
³rms
 & 
PROT_EXEC
 ? 'x' : '-';

415 *
ı
++ = 
æags
 & 
MAP_SHARED
 ? 's' : '-';

416 *
ı
++ = 
æags
 & 
MAP_PRIVATE
 ? 'p' : '-';

417 *
ı
++ = 0;

419 ià(
’d
 >ğ
PAGE_SIZE
) {

420 
	`¥rštf
(
buf
+
sz
, "...\n");

424 ià(
m­
->
vm_šode
 !ğ
NULL
) {

425 
dev
 = 
m­
->
vm_šode
->
i_dev
;

426 
šo
 = 
m­
->
vm_šode
->
i_šo
;

428 
dev
 = 0;

429 
šo
 = 0;

432 
sz
 +ğ
	`¥rštf
(
buf
+sz, "%08lx-%08lx %s %08lx %02x:%02x %lu\n",

433 
m­
->
vm_¡¬t
, m­->
vm_’d
, 
¡r
, m­->
vm_off£t
,

434 
	`MAJOR
(
dev
),
	`MINOR
(dev), 
šo
);

435 ià(
sz
 > 
’d
) {

436 
	`´štk
("g‘_m­s:ƒnd(%dè< sz(%d)\n", 
’d
, 
sz
);

441  
sz
;

442 
	}
}

444 
g‘_moduË_li¡
(*);

446 
	$¬¿y_»ad
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

448 * 
·ge
;

449 
Ëngth
;

450 
’d
;

451 
ty³
, 
pid
;

453 ià(
couÁ
 < 0)

454  -
EINVAL
;

455 ià(!(
·ge
 = (*è
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

456  -
ENOMEM
;

457 
ty³
 = 
šode
->
i_šo
;

458 
pid
 = 
ty³
 >> 16;

459 
ty³
 &= 0x0000ffff;

460 
ty³
) {

462 
Ëngth
 = 
	`g‘_lßdavg
(
·ge
);

465 
Ëngth
 = 
	`g‘_u±ime
(
·ge
);

468 
Ëngth
 = 
	`g‘_memšfo
(
·ge
);

471 
Ëngth
 = 
	`g‘_v”siÚ
(
·ge
);

474 
Ëngth
 = 
	`g‘_’v
(
pid
, 
·ge
);

477 
Ëngth
 = 
	`g‘_¬g
(
pid
, 
·ge
);

480 
Ëngth
 = 
	`g‘_¡©
(
pid
, 
·ge
);

483 
Ëngth
 = 
	`g‘_¡©m
(
pid
, 
·ge
);

485 #ifdeà
CONFIG_DEBUG_MALLOC


487 
Ëngth
 = 
	`g‘_m®loc
(
·ge
);

491 
	`ä“_·ge
((è
·ge
);

492  
	`»ad_cÜe
(
šode
, 
fe
, 
buf
, 
couÁ
);

494 
Ëngth
 = 
	`g‘_m­s
(
pid
, 
·ge
);

497 
Ëngth
 = 
	`g‘_moduË_li¡
(
·ge
);

500 
Ëngth
 = 
	`g‘_k¡©
(
·ge
);

503 
	`ä“_·ge
((è
·ge
);

504  -
EBADF
;

506 ià(
fe
->
f_pos
 >ğ
Ëngth
) {

507 
	`ä“_·ge
((è
·ge
);

510 ià(
couÁ
 + 
fe
->
f_pos
 > 
Ëngth
)

511 
couÁ
 = 
Ëngth
 - 
fe
->
f_pos
;

512 
’d
 = 
couÁ
 + 
fe
->
f_pos
;

513 
	`memıy_tofs
(
buf
, 
·ge
 + 
fe
->
f_pos
, 
couÁ
);

514 
	`ä“_·ge
((è
·ge
);

515 
fe
->
f_pos
 = 
’d
;

516  
couÁ
;

517 
	}
}

519 
fe_İ”©iÚs
 
	g´oc_¬¿y_İ”©iÚs
 = {

520 
NULL
,

521 
¬¿y_»ad
,

522 
NULL
,

523 
NULL
,

524 
NULL
,

525 
NULL
,

526 
NULL
,

527 
NULL
,

528 
NULL
,

529 
NULL


532 
šode_İ”©iÚs
 
	g´oc_¬¿y_šode_İ”©iÚs
 = {

533 &
´oc_¬¿y_İ”©iÚs
,

534 
NULL
,

535 
NULL
,

536 
NULL
,

537 
NULL
,

538 
NULL
,

539 
NULL
,

540 
NULL
,

541 
NULL
,

542 
NULL
,

543 
NULL
,

544 
NULL
,

545 
NULL
,

546 
NULL
,

547 
NULL


	@fs/proc/base.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/´oc_fs.h
>

14 
	~<lšux/¡©.h
>

16 
´oc_»adba£
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

17 
´oc_lookupba£
(
šode
 *,const *,,inode **);

19 
fe_İ”©iÚs
 
	g´oc_ba£_İ”©iÚs
 = {

20 
NULL
,

21 
NULL
,

22 
NULL
,

23 
´oc_»adba£
,

24 
NULL
,

25 
NULL
,

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL


35 
šode_İ”©iÚs
 
	g´oc_ba£_šode_İ”©iÚs
 = {

36 &
´oc_ba£_İ”©iÚs
,

37 
NULL
,

38 
´oc_lookupba£
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL


53 
´oc_dœ_’Œy
 
	gba£_dœ
[] = {

69 
	#NR_BASE_DIRENTRY
 (( (
ba£_dœ
))/( (ba£_dœ[0])))

	)

71 
	$´oc_m©ch
(
Ën
,cÚ¡ * 
Çme
,
´oc_dœ_’Œy
 * 
de
)

73 
§me
 
	`__asm__
("ax");

75 ià(!
de
 || !de->
low_šo
)

78 ià(!
Ën
 && (
de
->
Çme
[0]=='.') && (de->name[1]=='\0'))

80 ià(
de
->
Çm–’
 !ğ
Ën
)

82 
	`__asm__
("cld\n\t"

85 :"÷" (
§me
)

86 :"0" (0),"S" ((è
Çme
),"D" ((è
de
->Çme),"c" (
Ën
)

88  
§me
;

89 
	}
}

91 
	$´oc_lookupba£
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

92 
šode
 ** 
»suÉ
)

94 
pid
, 
šo
;

95 
i
;

97 *
»suÉ
 = 
NULL
;

98 ià(!
dœ
)

99  -
ENOENT
;

100 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

101 
	`ut
(
dœ
);

102  -
ENOENT
;

104 
šo
 = 
dœ
->
i_šo
;

105 
pid
 = 
šo
 >> 16;

106 
i
 = 
NR_BASE_DIRENTRY
;

107 
i
-- > 0 && !
	`´oc_m©ch
(
Ën
,
Çme
,
ba£_dœ
+i))

109 ià(
i
 < 0) {

110 
	`ut
(
dœ
);

111  -
ENOENT
;

113 ià(
ba£_dœ
[
i
].
low_šo
 == 1)

114 
šo
 = 1;

116 
šo
 = (
pid
 << 16è+ 
ba£_dœ
[
i
].
low_šo
;

117 
i
 = 0 ; i < 
NR_TASKS
 ; i++)

118 ià(
sk
[
i
] &&ask[i]->
pid
 ==…id)

120 ià(!
pid
 || 
i
 >ğ
NR_TASKS
) {

121 
	`ut
(
dœ
);

122  -
ENOENT
;

124 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

125 
	`ut
(
dœ
);

126  -
ENOENT
;

128 
	`ut
(
dœ
);

130 
	}
}

132 
	$´oc_»adba£
(
šode
 * inode, 
fe
 * 
fp
,

133 
dœ’t
 * dœ’t, 
couÁ
)

135 
´oc_dœ_’Œy
 * 
de
;

136 
pid
, 
šo
;

137 
i
,
j
;

139 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

140  -
EBADF
;

141 
šo
 = 
šode
->
i_šo
;

142 
pid
 = 
šo
 >> 16;

143 
i
 = 0 ; i < 
NR_TASKS
 ; i++)

144 ià(
sk
[
i
] &&ask[i]->
pid
 ==…id)

146 ià(!
pid
 || 
i
 >ğ
NR_TASKS
)

148 ià(((è
fp
->
f_pos
è< 
NR_BASE_DIRENTRY
) {

149 
de
 = 
ba£_dœ
 + 
fp
->
f_pos
;

150 
fp
->
f_pos
++;

151 
i
 = 
de
->
Çm–’
;

152 
šo
 = 
de
->
low_šo
;

153 ià(
šo
 != 1)

154 
šo
 |ğ(
pid
 << 16);

155 
	`put_fs_lÚg
(
šo
, &
dœ’t
->
d_šo
);

156 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

157 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

158 
j
 = 
i
;

159 
i
--)

160 
	`put_fs_by‹
(
de
->
Çme
[
i
], i+
dœ’t
->
d_Çme
);

161  
j
;

164 
	}
}

	@fs/proc/fd.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/´oc_fs.h
>

14 
	~<lšux/¡©.h
>

16 
´oc_»adfd
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

17 
´oc_lookupfd
(
šode
 *,const *,,inode **);

19 
fe_İ”©iÚs
 
	g´oc_fd_İ”©iÚs
 = {

20 
NULL
,

21 
NULL
,

22 
NULL
,

23 
´oc_»adfd
,

24 
NULL
,

25 
NULL
,

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL


35 
šode_İ”©iÚs
 
	g´oc_fd_šode_İ”©iÚs
 = {

36 &
´oc_fd_İ”©iÚs
,

37 
NULL
,

38 
´oc_lookupfd
,

39 
NULL
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL


53 
	$´oc_lookupfd
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

54 
šode
 ** 
»suÉ
)

56 
šo
, 
pid
, 
fd
, 
c
;

57 
sk_¡ruù
 * 
p
;

58 
su³r_block
 * 
sb
;

59 
i
;

61 *
»suÉ
 = 
NULL
;

62 
šo
 = 
dœ
->
i_šo
;

63 
pid
 = 
šo
 >> 16;

64 
šo
 &= 0x0000ffff;

65 
šo
 -= 7;

66 ià(!
dœ
)

67  -
ENOENT
;

68 
sb
 = 
dœ
->
i_sb
;

69 ià(!
pid
 || 
šo
 > 1 || !
	`S_ISDIR
(
dœ
->
i_mode
)) {

70 
	`ut
(
dœ
);

71  -
ENOENT
;

73 ià(!
Ën
 || (
Çme
[0] == '.' && (len == 1 ||

74 (
Çme
[1] =ğ'.' && 
Ën
 == 2)))) {

75 ià(
Ën
 < 2) {

76 *
»suÉ
 = 
dœ
;

79 ià(!(*
»suÉ
 = 
	`ig‘
(
sb
,(
pid
 << 16)+2))) {

80 
	`ut
(
dœ
);

81  -
ENOENT
;

83 
	`ut
(
dœ
);

86 
	`ut
(
dœ
);

87 
fd
 = 0;

88 
Ën
-- > 0) {

89 
c
 = *
Çme
 - '0';

90 
Çme
++;

91 ià(
c
 > 9) {

92 
fd
 = 0xfffff;

95 
fd
 *= 10;

96 
fd
 +ğ
c
;

97 ià(
fd
 & 0xffff0000) {

98 
fd
 = 0xfffff;

102 
i
 = 0 ; i < 
NR_TASKS
 ; i++)

103 ià((
p
 = 
sk
[
i
]è&&…->
pid
 ==…id)

105 ià(!
pid
 || 
i
 >ğ
NR_TASKS
)

106  -
ENOENT
;

107 ià(!
šo
) {

108 ià(
fd
 >ğ
NR_OPEN
 || !
p
->
fp
[fd] || !p->fp[fd]->
f_šode
)

109  -
ENOENT
;

110 
šo
 = (
pid
 << 16è+ 0x100 + 
fd
;

112 
j
 = 0;

113 
vm_¬—_¡ruù
 * 
m²t
;

114 
m²t
 = 
p
->
mm­
; m²t; m²ˆğm²t->
vm_Ãxt
)

115 ià(
m²t
->
vm_šode
)

116 
j
++;

117 ià(
fd
 >ğ
j
)

118  -
ENOENT
;

119 
šo
 = (
pid
 << 16è+ 0x200 + 
fd
;

121 ià(!(*
»suÉ
 = 
	`ig‘
(
sb
,
šo
)))

122  -
ENOENT
;

124 
	}
}

126 
	$´oc_»adfd
(
šode
 * inode, 
fe
 * 
fp
,

127 
dœ’t
 * dœ’t, 
couÁ
)

129 
sk_¡ruù
 * 
p
;

130 
fd
, 
pid
, 
šo
;

131 
i
,
j
;

133 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

134  -
EBADF
;

135 
šo
 = 
šode
->
i_šo
;

136 
pid
 = 
šo
 >> 16;

137 
šo
 &= 0x0000ffff;

138 
šo
 -= 7;

139 ià(
šo
 > 1)

142 
fd
 = 
fp
->
f_pos
;

143 
fp
->
f_pos
++;

144 ià(
fd
 < 2) {

145 
i
 = 
j
 = 
fd
+1;

146 ià(!
fd
)

147 
fd
 = 
šode
->
i_šo
;

149 
fd
 = (
šode
->
i_šo
 & 0xffff0000) | 2;

150 
	`put_fs_lÚg
(
fd
, &
dœ’t
->
d_šo
);

151 
	`put_fs_wÜd
(
i
, &
dœ’t
->
d_»ş’
);

152 
	`put_fs_by‹
(0, 
i
+
dœ’t
->
d_Çme
);

153 
i
--)

154 
	`put_fs_by‹
('.', 
i
+
dœ’t
->
d_Çme
);

155  
j
;

157 
fd
 -= 2;

158 
i
 = 1 ; i < 
NR_TASKS
 ; i++)

159 ià((
p
 = 
sk
[
i
]è&&…->
pid
 ==…id)

161 ià(
i
 >ğ
NR_TASKS
)

163 ià(!
šo
) {

164 ià(
fd
 >ğ
NR_OPEN
)

166 ià(!
p
->
fp
[
fd
] || !p->fp[fd]->
f_šode
)

169 
j
 = 0;

170 
vm_¬—_¡ruù
 * 
m²t
;

171 
m²t
 = 
p
->
mm­
 ; m²ˆ; m²ˆğm²t->
vm_Ãxt
)

172 ià(
m²t
->
vm_šode
)

173 
j
++;

174 ià(
fd
 >ğ
j
)

177 
j
 = 10;

178 
i
 = 1;

179 
fd
 >ğ
j
) {

180 
j
 *= 10;

181 
i
++;

183 
j
 = 
i
;

184 ià(!
šo
)

185 
šo
 = (
pid
 << 16è+ 0x100 + 
fd
;

187 
šo
 = (
pid
 << 16è+ 0x200 + 
fd
;

188 
	`put_fs_lÚg
(
šo
, &
dœ’t
->
d_šo
);

189 
	`put_fs_wÜd
(
i
, &
dœ’t
->
d_»ş’
);

190 
	`put_fs_by‹
(0, 
i
+
dœ’t
->
d_Çme
);

191 
i
--) {

192 
	`put_fs_by‹
('0'+(
fd
 % 10), 
i
+
dœ’t
->
d_Çme
);

193 
fd
 /= 10;

195  
j
;

198 
	}
}

	@fs/proc/inode.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/´oc_fs.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/mm.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/locks.h
>

14 
	~<lšux/lim™s.h
>

16 
	~<asm/sy¡em.h
>

17 
	~<asm/£gm’t.h
>

19 
	$´oc_put_šode
(
šode
 *inode)

21 ià(
šode
->
i_Æšk
)

23 
šode
->
i_size
 = 0;

24 
	}
}

26 
	$´oc_put_su³r
(
su³r_block
 *
sb
)

28 
	`lock_su³r
(
sb
);

29 
sb
->
s_dev
 = 0;

30 
	`uÆock_su³r
(
sb
);

31 
	}
}

33 
su³r_İ”©iÚs
 
	g´oc_sİs
 = {

34 
´oc_»ad_šode
,

35 
NULL
,

36 
´oc_wr™e_šode
,

37 
´oc_put_šode
,

38 
´oc_put_su³r
,

39 
NULL
,

40 
´oc_¡©fs
,

41 
NULL


44 
su³r_block
 *
	$´oc_»ad_su³r
(
su³r_block
 *
s
,*
d©a
,

45 
s’t
)

47 
	`lock_su³r
(
s
);

48 
s
->
s_blocksize
 = 1024;

49 
s
->
s_blocksize_b™s
 = 10;

50 
s
->
s_magic
 = 
PROC_SUPER_MAGIC
;

51 
s
->
s_İ
 = &
´oc_sİs
;

52 
	`uÆock_su³r
(
s
);

53 ià(!(
s
->
s_mouÁed
 = 
	`ig‘
(s,
PROC_ROOT_INO
))) {

54 
s
->
s_dev
 = 0;

55 
	`´štk
("get„oot inode failed\n");

56  
NULL
;

58  
s
;

59 
	}
}

61 
	$´oc_¡©fs
(
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

63 
	`put_fs_lÚg
(
PROC_SUPER_MAGIC
, &
buf
->
f_ty³
);

64 
	`put_fs_lÚg
(
PAGE_SIZE
/(), &
buf
->
f_bsize
);

65 
	`put_fs_lÚg
(0, &
buf
->
f_blocks
);

66 
	`put_fs_lÚg
(0, &
buf
->
f_bä“
);

67 
	`put_fs_lÚg
(0, &
buf
->
f_bava
);

68 
	`put_fs_lÚg
(0, &
buf
->
f_fes
);

69 
	`put_fs_lÚg
(0, &
buf
->
f_fä“
);

70 
	`put_fs_lÚg
(
NAME_MAX
, &
buf
->
f_Çm–’
);

72 
	}
}

74 
	$´oc_»ad_šode
(
šode
 * inode)

76 
šo
, 
pid
;

77 
sk_¡ruù
 * 
p
;

78 
i
;

80 
šode
->
i_İ
 = 
NULL
;

81 
šode
->
i_mode
 = 0;

82 
šode
->
i_uid
 = 0;

83 
šode
->
i_gid
 = 0;

84 
šode
->
i_Æšk
 = 1;

85 
šode
->
i_size
 = 0;

86 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

87 
šode
->
i_blocks
 = 0;

88 
šode
->
i_blksize
 = 1024;

89 
šo
 = 
šode
->
i_šo
;

90 
pid
 = 
šo
 >> 16;

91 
p
 = 
sk
[0];

92 
i
 = 0; i < 
NR_TASKS
 ; i++)

93 ià((
p
 = 
sk
[
i
]è&& (p->
pid
 ==…id))

95 ià(!
p
 || 
i
 >ğ
NR_TASKS
)

97 ià(
šo
 =ğ
PROC_ROOT_INO
) {

98 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IXUGO
;

99 
šode
->
i_Æšk
 = 2;

100 
i
 = 1 ; i < 
NR_TASKS
 ; i++)

101 ià(
sk
[
i
])

102 
šode
->
i_Æšk
++;

103 
šode
->
i_İ
 = &
´oc_roÙ_šode_İ”©iÚs
;

106 ià((
šo
 >= 128) && (ino <= 160)) {

107 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUGO
;

108 
šode
->
i_İ
 = &
´oc_Ãt_šode_İ”©iÚs
;

111 ià(!
pid
) {

112 
šo
) {

114 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUGO
;

115 
šode
->
i_İ
 = &
´oc_kmsg_šode_İ”©iÚs
;

118 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IXUGO
;

119 
šode
->
i_Æšk
 = 2;

120 
šode
->
i_İ
 = &
´oc_Ãt_šode_İ”©iÚs
;

123 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUSR
;

124 
šode
->
i_İ
 = &
´oc_¬¿y_šode_İ”©iÚs
;

125 
šode
->
i_size
 = 
high_memÜy
 + 
PAGE_SIZE
;

128 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUGO
;

129 
šode
->
i_İ
 = &
´oc_¬¿y_šode_İ”©iÚs
;

134 
šo
 &= 0x0000ffff;

135 
šode
->
i_uid
 = 
p
->
euid
;

136 
šode
->
i_gid
 = 
p
->
egid
;

137 
šo
) {

139 
šode
->
i_Æšk
 = 4;

140 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IXUGO
;

141 
šode
->
i_İ
 = &
´oc_ba£_šode_İ”©iÚs
;

144 
šode
->
i_İ
 = &
´oc_mem_šode_İ”©iÚs
;

145 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUSR
 | 
S_IWUSR
;

150 
šode
->
i_İ
 = &
´oc_lšk_šode_İ”©iÚs
;

151 
šode
->
i_size
 = 64;

152 
šode
->
i_mode
 = 
S_IFLNK
 | 
S_IRWXU
;

156 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUSR
 | 
S_IXUSR
;

157 
šode
->
i_İ
 = &
´oc_fd_šode_İ”©iÚs
;

158 
šode
->
i_Æšk
 = 2;

165 
šode
->
i_mode
 = 
S_IFREG
 | 
S_IRUGO
;

166 
šode
->
i_İ
 = &
´oc_¬¿y_šode_İ”©iÚs
;

169 
šo
 >> 8) {

171 
šo
 &= 0xff;

172 ià(
šo
 >ğ
NR_OPEN
 || !
p
->
fp
[ino])

174 
šode
->
i_İ
 = &
´oc_lšk_šode_İ”©iÚs
;

175 
šode
->
i_size
 = 64;

176 
šode
->
i_mode
 = 
S_IFLNK
 | 
S_IRWXU
;

179 
šo
 &= 0xff;

181 
j
 = 0;

182 
vm_¬—_¡ruù
 * 
m²t
;

183 
m²t
 = 
p
->
mm­
 ; m²ˆ; m²ˆğm²t->
vm_Ãxt
)

184 if(
m²t
->
vm_šode
)

185 
j
++;

186 ià(
šo
 >ğ
j
)

189 
šode
->
i_İ
 = &
´oc_lšk_šode_İ”©iÚs
;

190 
šode
->
i_size
 = 64;

191 
šode
->
i_mode
 = 
S_IFLNK
 | 
S_IRWXU
;

195 
	}
}

197 
	$´oc_wr™e_šode
(
šode
 * inode)

199 
šode
->
i_dœt
=0;

200 
	}
}

	@fs/proc/kmsg.c

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

13 
	~<asm/£gm’t.h
>

14 
	~<asm/io.h
>

16 
log_size
;

17 
wa™_queue
 * 
log_wa™
;

19 
asmlškage
 
sys_sy¦og
(
ty³
, * 
bug
, 
couÁ
);

21 
	$kmsg_İ’
(
šode
 * inode, 
fe
 * file)

23  
	`sys_sy¦og
(1,
NULL
,0);

24 
	}
}

26 
	$kmsg_»Ëa£
(
šode
 * inode, 
fe
 * file)

28 (è
	`sys_sy¦og
(0,
NULL
,0);

29 
	}
}

31 
	$kmsg_»ad
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

33  
	`sys_sy¦og
(2,
buf
,
couÁ
);

34 
	}
}

36 
	$kmsg_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

38 ià(
£l_ty³
 !ğ
SEL_IN
)

40 ià(
log_size
)

42 
	`£Ëù_wa™
(&
log_wa™
, 
wa™
);

44 
	}
}

47 
fe_İ”©iÚs
 
	g´oc_kmsg_İ”©iÚs
 = {

48 
NULL
,

49 
kmsg_»ad
,

50 
NULL
,

51 
NULL
,

52 
kmsg_£Ëù
,

53 
NULL
,

54 
NULL
,

55 
kmsg_İ’
,

56 
kmsg_»Ëa£
,

57 
NULL


60 
šode_İ”©iÚs
 
	g´oc_kmsg_šode_İ”©iÚs
 = {

61 &
´oc_kmsg_İ”©iÚs
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL


	@fs/proc/link.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/fs.h
>

14 
	~<lšux/mšix_fs.h
>

15 
	~<lšux/¡©.h
>

17 
´oc_»adlšk
(
šode
 *, *, );

18 
´oc_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

23 
šode_İ”©iÚs
 
	g´oc_lšk_šode_İ”©iÚs
 = {

24 
NULL
,

25 
NULL
,

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
´oc_»adlšk
,

35 
´oc_fŞlow_lšk
,

36 
NULL
,

37 
NULL
,

38 
NULL


41 
	$´oc_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

42 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

44 
pid
, 
šo
;

45 
sk_¡ruù
 * 
p
;

46 
i
;

48 *
»s_šode
 = 
NULL
;

49 ià(
dœ
)

50 
	`ut
(
dœ
);

51 ià(!
šode
)

52  -
ENOENT
;

53 ià(!
	`³rmissiÚ
(
šode
, 
MAY_EXEC
)) {

54 
	`ut
(
šode
);

55  -
EACCES
;

57 
šo
 = 
šode
->
i_šo
;

58 
pid
 = 
šo
 >> 16;

59 
šo
 &= 0x0000ffff;

60 
	`ut
(
šode
);

61 
i
 = 0 ; i < 
NR_TASKS
 ; i++)

62 ià((
p
 = 
sk
[
i
]è&&…->
pid
 ==…id)

64 ià(
i
 >ğ
NR_TASKS
)

65  -
ENOENT
;

66 
šode
 = 
NULL
;

67 
šo
) {

69 
šode
 = 
p
->
pwd
;

72 
šode
 = 
p
->
roÙ
;

75 
šode
 = 
p
->
execubË
;

78 
šo
 >> 8) {

80 
šo
 &= 0xff;

81 ià(
šo
 < 
NR_OPEN
 && 
p
->
fp
[ino])

82 
šode
 = 
p
->
fp
[
šo
]->
f_šode
;

85 
šo
 &= 0xff;

86 { 
j
 = 
šo
;

87 
vm_¬—_¡ruù
 * 
m²t
;

88 
m²t
 = 
p
->
mm­
; m²ˆ&& 
j
 >= 0;

89 
m²t
 = m²t->
vm_Ãxt
){

90 if(
m²t
->
vm_šode
) {

91 if(
j
 == 0) {

92 
šode
 = 
m²t
->
vm_šode
;

95 
j
--;

101 ià(!
šode
)

102  -
ENOENT
;

103 *
»s_šode
 = 
šode
;

104 
šode
->
i_couÁ
++;

106 
	}
}

108 
	$´oc_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

110 
i
;

111 
dev
,
šo
;

112 
buf
[64];

114 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

115 
	`ut
(
šode
);

116  -
EINVAL
;

118 
i
 = 
	`´oc_fŞlow_lšk
(
NULL
, 
šode
, 0, 0, &inode);

119 ià(
i
)

120  
i
;

121 ià(!
šode
)

122  -
EIO
;

123 
dev
 = 
šode
->
i_dev
;

124 
šo
 = 
šode
->
i_šo
;

125 
	`ut
(
šode
);

126 
i
 = 
	`¥rštf
(
buf
,"[%04x]:%u", 
dev
, 
šo
);

127 ià(
buæ’
 > 
i
)

128 
buæ’
 = 
i
;

129 
i
 = 0;

130 
i
 < 
buæ’
)

131 
	`put_fs_by‹
(
buf
[
i
++],
bufãr
++);

132  
i
;

133 
	}
}

	@fs/proc/mem.c

7 
	~<lšux/ty³s.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

12 
	~<asm/£gm’t.h
>

13 
	~<asm/io.h
>

21 
	#mem_wr™e
 
NULL


	)

23 
	$mem_»ad
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

25 
addr
, 
pid
, 
ü3
;

26 *
tmp
;

27 
±e
, 
·ge
;

28 
i
;

30 ià(
couÁ
 < 0)

31  -
EINVAL
;

32 
pid
 = 
šode
->
i_šo
;

33 
pid
 >>= 16;

34 
ü3
 = 0;

35 
i
 = 1 ; i < 
NR_TASKS
 ; i++)

36 ià(
sk
[
i
] &&ask[i]->
pid
 ==…id) {

37 
ü3
 = 
sk
[
i
]->
tss
.cr3;

40 ià(!
ü3
)

41  -
EACCES
;

42 
addr
 = 
fe
->
f_pos
;

43 
tmp
 = 
buf
;

44 
couÁ
 > 0) {

45 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

47 
±e
 = *
	`PAGE_DIR_OFFSET
(
ü3
,
addr
);

48 ià(!(
±e
 & 
PAGE_PRESENT
))

50 
±e
 &ğ
PAGE_MASK
;

51 
±e
 +ğ
	`PAGE_PTR
(
addr
);

52 
·ge
 = *(*è
±e
;

53 ià(!(
·ge
 & 1))

55 
·ge
 &ğ
PAGE_MASK
;

56 
·ge
 +ğ
addr
 & ~
PAGE_MASK
;

57 
i
 = 
PAGE_SIZE
-(
addr
 & ~
PAGE_MASK
);

58 ià(
i
 > 
couÁ
)

59 
i
 = 
couÁ
;

60 
	`memıy_tofs
(
tmp
,(*è
·ge
,
i
);

61 
addr
 +ğ
i
;

62 
tmp
 +ğ
i
;

63 
couÁ
 -ğ
i
;

65 
fe
->
f_pos
 = 
addr
;

66  
tmp
-
buf
;

67 
	}
}

69 #iâdeà
mem_wr™e


71 
	$mem_wr™e
(
šode
 * inode, 
fe
 * fe,* 
buf
, 
couÁ
)

73 
addr
, 
pid
, 
ü3
;

74 *
tmp
;

75 
±e
, 
·ge
;

76 
i
;

78 ià(
couÁ
 < 0)

79  -
EINVAL
;

80 
addr
 = 
fe
->
f_pos
;

81 
pid
 = 
šode
->
i_šo
;

82 
pid
 >>= 16;

83 
ü3
 = 0;

84 
i
 = 1 ; i < 
NR_TASKS
 ; i++)

85 ià(
sk
[
i
] &&ask[i]->
pid
 ==…id) {

86 
ü3
 = 
sk
[
i
]->
tss
.cr3;

89 ià(!
ü3
)

90  -
EACCES
;

91 
tmp
 = 
buf
;

92 
couÁ
 > 0) {

93 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

95 
±e
 = *
	`PAGE_DIR_OFFSET
(
ü3
,
addr
);

96 ià(!(
±e
 & 
PAGE_PRESENT
))

98 
±e
 &ğ
PAGE_MASK
;

99 
±e
 +ğ
	`PAGE_PTR
(
addr
);

100 
·ge
 = *(*è
±e
;

101 ià(!(
·ge
 & 
PAGE_PRESENT
))

103 ià(!(
·ge
 & 2)) {

104 
	`do_wp_·ge
(0,
addr
,
cu¼’t
,0);

107 
·ge
 &ğ
PAGE_MASK
;

108 
·ge
 +ğ
addr
 & ~
PAGE_MASK
;

109 
i
 = 
PAGE_SIZE
-(
addr
 & ~
PAGE_MASK
);

110 ià(
i
 > 
couÁ
)

111 
i
 = 
couÁ
;

112 
	`memıy_äomfs
((*è
·ge
,
tmp
,
i
);

113 
addr
 +ğ
i
;

114 
tmp
 +ğ
i
;

115 
couÁ
 -ğ
i
;

117 
fe
->
f_pos
 = 
addr
;

118 ià(
tmp
 !ğ
buf
)

119  
tmp
-
buf
;

120 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

121  -
ERESTARTSYS
;

123 
	}
}

127 
	$mem_l£ek
(
šode
 * inode, 
fe
 * fe, 
off_t
 
off£t
, 
Üig
)

129 
Üig
) {

131 
fe
->
f_pos
 = 
off£t
;

132  
fe
->
f_pos
;

134 
fe
->
f_pos
 +ğ
off£t
;

135  
fe
->
f_pos
;

137  -
EINVAL
;

139 
	}
}

141 
fe_İ”©iÚs
 
	g´oc_mem_İ”©iÚs
 = {

142 
mem_l£ek
,

143 
mem_»ad
,

144 
mem_wr™e
,

145 
NULL
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL


154 
šode_İ”©iÚs
 
	g´oc_mem_šode_İ”©iÚs
 = {

155 &
´oc_mem_İ”©iÚs
,

156 
NULL
,

157 
NULL
,

158 
NULL
,

159 
NULL
,

160 
NULL
,

161 
NULL
,

162 
NULL
,

163 
NULL
,

164 
NULL
,

165 
NULL
,

166 
NULL
,

167 
NULL
,

168 
NULL
,

169 
NULL


	@fs/proc/net.c

21 
	~<lšux/autocÚf.h
>

23 
	~<asm/£gm’t.h
>

25 
	~<lšux/”ºo.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/´oc_fs.h
>

28 
	~<lšux/¡©.h
>

31 
´oc_»adÃt
(
šode
 * inode, 
fe
 * file,

32 * 
buf
, 
couÁ
);

33 
´oc_»adÃtdœ
(
šode
 *, 
fe
 *,

34 
dœ’t
 *, );

35 
´oc_looku²‘
(
šode
 *,const *,,inode **);

39 
unix_g‘_šfo
(*);

40 #ifdeà
CONFIG_INET


41 
tı_g‘_šfo
(*);

42 
udp_g‘_šfo
(*);

43 
¿w_g‘_šfo
(*);

44 
¬p_g‘_šfo
(*);

45 
dev_g‘_šfo
(*);

46 
¹_g‘_šfo
(*);

50 
fe_İ”©iÚs
 
	g´oc_Ãt_İ”©iÚs
 = {

51 
NULL
,

52 
´oc_»adÃt
,

53 
NULL
,

54 
´oc_»adÃtdœ
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL


66 
šode_İ”©iÚs
 
	g´oc_Ãt_šode_İ”©iÚs
 = {

67 &
´oc_Ãt_İ”©iÚs
,

68 
NULL
,

69 
´oc_looku²‘
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 
NULL
,

79 
NULL
,

80 
NULL
,

81 
NULL


84 
´oc_dœ_’Œy
 
	gÃt_dœ
[] = {

88 #ifdeà
CONFIG_INET


98 
	#NR_NET_DIRENTRY
 (( (
Ãt_dœ
))/( (Ãt_dœ[0])))

	)

101 
	$´oc_looku²‘
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

102 
šode
 ** 
»suÉ
)

104 
šo
;

105 
i
;

107 *
»suÉ
 = 
NULL
;

108 ià(!
dœ
)

109  -
ENOENT
;

110 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

111 
	`ut
(
dœ
);

112  -
ENOENT
;

114 
i
 = 
NR_NET_DIRENTRY
;

115 
i
-- > 0 && !
	`´oc_m©ch
(
Ën
,
Çme
,
Ãt_dœ
+i))

117 ià(
i
 < 0) {

118 
	`ut
(
dœ
);

119  -
ENOENT
;

121 
šo
 = 
Ãt_dœ
[
i
].
low_šo
;

122 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

123 
	`ut
(
dœ
);

124  -
ENOENT
;

126 
	`ut
(
dœ
);

128 
	}
}

130 
	$´oc_»adÃtdœ
(
šode
 * inode, 
fe
 * 
fp
,

131 
dœ’t
 * dœ’t, 
couÁ
)

133 
´oc_dœ_’Œy
 * 
de
;

134 
šo
;

135 
i
,
j
;

137 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

138  -
EBADF
;

139 
šo
 = 
šode
->
i_šo
;

140 ià(((è
fp
->
f_pos
è< 
NR_NET_DIRENTRY
) {

141 
de
 = 
Ãt_dœ
 + 
fp
->
f_pos
;

142 
fp
->
f_pos
++;

143 
i
 = 
de
->
Çm–’
;

144 
šo
 = 
de
->
low_šo
;

145 
	`put_fs_lÚg
(
šo
, &
dœ’t
->
d_šo
);

146 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

147 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

148 
j
 = 
i
;

149 
i
--)

150 
	`put_fs_by‹
(
de
->
Çme
[
i
], i+
dœ’t
->
d_Çme
);

151  
j
;

154 
	}
}

157 
	$´oc_»adÃt
(
šode
 * inode, 
fe
 * file,

158 * 
buf
, 
couÁ
)

160 * 
·ge
;

161 
Ëngth
;

162 
’d
;

163 
šo
;

165 ià(
couÁ
 < 0)

166  -
EINVAL
;

167 ià(!(
·ge
 = (*è
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

168  -
ENOMEM
;

169 
šo
 = 
šode
->
i_šo
;

170 
šo
) {

171 #ifdeà
CONFIG_INET


173 
Ëngth
 = 
	`unix_g‘_šfo
(
·ge
);

176 
Ëngth
 = 
	`¬p_g‘_šfo
(
·ge
);

179 
Ëngth
 = 
	`¹_g‘_šfo
(
·ge
);

182 
Ëngth
 = 
	`dev_g‘_šfo
(
·ge
);

185 
Ëngth
 = 
	`¿w_g‘_šfo
(
·ge
);

188 
Ëngth
 = 
	`tı_g‘_šfo
(
·ge
);

191 
Ëngth
 = 
	`udp_g‘_šfo
(
·ge
);

195 
	`ä“_·ge
((è
·ge
);

196  -
EBADF
;

198 ià(
fe
->
f_pos
 >ğ
Ëngth
) {

199 
	`ä“_·ge
((è
·ge
);

202 ià(
couÁ
 + 
fe
->
f_pos
 > 
Ëngth
)

203 
couÁ
 = 
Ëngth
 - 
fe
->
f_pos
;

204 
’d
 = 
couÁ
 + 
fe
->
f_pos
;

205 
	`memıy_tofs
(
buf
, 
·ge
 + 
fe
->
f_pos
, 
couÁ
);

206 
	`ä“_·ge
((è
·ge
);

207 
fe
->
f_pos
 = 
’d
;

208  
couÁ
;

210 
	}
}

	@fs/proc/root.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/´oc_fs.h
>

14 
	~<lšux/¡©.h
>

15 
	~<lšux/cÚfig.h
>

17 
´oc_»adroÙ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

18 
´oc_looku´oÙ
(
šode
 *,const *,,inode **);

20 
fe_İ”©iÚs
 
	g´oc_roÙ_İ”©iÚs
 = {

21 
NULL
,

22 
NULL
,

23 
NULL
,

24 
´oc_»adroÙ
,

25 
NULL
,

26 
NULL
,

27 
NULL
,

28 
NULL
,

29 
NULL
,

30 
NULL


36 
šode_İ”©iÚs
 
	g´oc_roÙ_šode_İ”©iÚs
 = {

37 &
´oc_roÙ_İ”©iÚs
,

38 
NULL
,

39 
´oc_looku´oÙ
,

40 
NULL
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL


54 
´oc_dœ_’Œy
 
	groÙ_dœ
[] = {

64 #ifdeà
CONFIG_DEBUG_MALLOC


72 
	#NR_ROOT_DIRENTRY
 (( (
roÙ_dœ
))/( (roÙ_dœ[0])))

	)

74 
	$´oc_looku´oÙ
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

75 
šode
 ** 
»suÉ
)

77 
pid
, 
c
;

78 
i
, 
šo
;

80 *
»suÉ
 = 
NULL
;

81 ià(!
dœ
)

82  -
ENOENT
;

83 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

84 
	`ut
(
dœ
);

85  -
ENOENT
;

87 
i
 = 
NR_ROOT_DIRENTRY
;

88 
i
-- > 0 && !
	`´oc_m©ch
(
Ën
,
Çme
,
roÙ_dœ
+i))

90 ià(
i
 >= 0) {

91 
šo
 = 
roÙ_dœ
[
i
].
low_šo
;

92 ià(
šo
 == 1) {

93 *
»suÉ
 = 
dœ
;

96 ià(
šo
 == 7)

97 
šo
 = (
cu¼’t
->
pid
 << 16) + 2;

99 
pid
 = 0;

100 
Ën
-- > 0) {

101 
c
 = *
Çme
 - '0';

102 
Çme
++;

103 ià(
c
 > 9) {

104 
pid
 = 0;

107 
pid
 *= 10;

108 
pid
 +ğ
c
;

109 ià(
pid
 & 0xffff0000) {

110 
pid
 = 0;

114 
i
 = 0 ; i < 
NR_TASKS
 ; i++)

115 ià(
sk
[
i
] &&ask[i]->
pid
 ==…id)

117 ià(!
pid
 || 
i
 >ğ
NR_TASKS
) {

118 
	`ut
(
dœ
);

119  -
ENOENT
;

121 
šo
 = (
pid
 << 16) + 2;

123 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

124 
	`ut
(
dœ
);

125  -
ENOENT
;

127 
	`ut
(
dœ
);

129 
	}
}

131 
	$´oc_»adroÙ
(
šode
 * inode, 
fe
 * 
fp
,

132 
dœ’t
 * dœ’t, 
couÁ
)

134 
sk_¡ruù
 * 
p
;

135 
Ä
,
pid
;

136 
i
,
j
;

138 ià(!
šode
 || !
	`S_ISDIR
(šode->
i_mode
))

139  -
EBADF
;

140 
»³©
:

141 
Ä
 = 
fp
->
f_pos
;

142 ià(
Ä
 < 
NR_ROOT_DIRENTRY
) {

143 
´oc_dœ_’Œy
 * 
de
 = 
roÙ_dœ
 + 
Ä
;

145 
fp
->
f_pos
++;

146 
i
 = 
de
->
Çm–’
;

147 
	`put_fs_lÚg
(
de
->
low_šo
, &
dœ’t
->
d_šo
);

148 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

149 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

150 
j
 = 
i
;

151 
i
--)

152 
	`put_fs_by‹
(
de
->
Çme
[
i
], i+
dœ’t
->
d_Çme
);

153  
j
;

155 
Ä
 -ğ
NR_ROOT_DIRENTRY
;

156 ià(
Ä
 >ğ
NR_TASKS
)

158 
fp
->
f_pos
++;

159 
p
 = 
sk
[
Ä
];

160 ià(!
p
 || !(
pid
 =…->pid))

161 
»³©
;

162 ià(
pid
 & 0xffff0000)

163 
»³©
;

164 
j
 = 10;

165 
i
 = 1;

166 
pid
 >ğ
j
) {

167 
j
 *= 10;

168 
i
++;

170 
j
 = 
i
;

171 
	`put_fs_lÚg
((
pid
 << 16)+2, &
dœ’t
->
d_šo
);

172 
	`put_fs_wÜd
(
i
, &
dœ’t
->
d_»ş’
);

173 
	`put_fs_by‹
(0, 
i
+
dœ’t
->
d_Çme
);

174 
i
--) {

175 
	`put_fs_by‹
('0'+(
pid
 % 10), 
i
+
dœ’t
->
d_Çme
);

176 
pid
 /= 10;

178  
j
;

179 
	}
}

	@fs/read_write.c

7 
	~<lšux/ty³s.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/¡©.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/sched.h
>

13 
	~<asm/£gm’t.h
>

19 
asmlškage
 
	$sys_»addœ
(
fd
, 
dœ’t
 * dœ’t, 
couÁ
)

21 
”rÜ
;

22 
fe
 * file;

23 
šode
 * inode;

25 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]) ||

26 !(
šode
 = 
fe
->
f_šode
))

27  -
EBADF
;

28 
”rÜ
 = -
ENOTDIR
;

29 ià(
fe
->
f_İ
 && fe->f_İ->
»addœ
) {

30 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
dœ’t
,  (*dirent));

31 ià(!
”rÜ
)

32 
”rÜ
 = 
fe
->
f_İ
->
	`»addœ
(
šode
,fe,
dœ’t
,
couÁ
);

34  
”rÜ
;

35 
	}
}

37 
asmlškage
 
	$sys_l£ek
(
fd
, 
off_t
 
off£t
, 
Üigš
)

39 
fe
 * file;

40 
tmp
 = -1;

42 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
=
cu¼’t
->
fp
[fd]è|| !(fe->
f_šode
))

43  -
EBADF
;

44 ià(
Üigš
 > 2)

45  -
EINVAL
;

46 ià(
fe
->
f_İ
 && fe->f_İ->
l£ek
)

47  
fe
->
f_İ
->
	`l£ek
(fe->
f_šode
,fe,
off£t
,
Üigš
);

50 
Üigš
) {

52 
tmp
 = 
off£t
;

55 
tmp
 = 
fe
->
f_pos
 + 
off£t
;

58 ià(!
fe
->
f_šode
)

59  -
EINVAL
;

60 
tmp
 = 
fe
->
f_šode
->
i_size
 + 
off£t
;

63 ià(
tmp
 < 0)

64  -
EINVAL
;

65 
fe
->
f_pos
 = 
tmp
;

66 
fe
->
f_»ada
 = 0;

67  
fe
->
f_pos
;

68 
	}
}

70 
asmlškage
 
	$sys_»ad
(
fd
,* 
buf
,
couÁ
)

72 
”rÜ
;

73 
fe
 * file;

74 
šode
 * inode;

76 ià(
fd
>=
NR_OPEN
 || !(
fe
=
cu¼’t
->
fp
[fd]è|| !(
šode
=fe->
f_šode
))

77  -
EBADF
;

78 ià(!(
fe
->
f_mode
 & 1))

79  -
EBADF
;

80 ià(!
fe
->
f_İ
 || !fe->f_İ->
»ad
)

81  -
EINVAL
;

82 ià(!
couÁ
)

84 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
buf
,
couÁ
);

85 ià(
”rÜ
)

86  
”rÜ
;

87  
fe
->
f_İ
->
	`»ad
(
šode
,fe,
buf
,
couÁ
);

88 
	}
}

90 
asmlškage
 
	$sys_wr™e
(
fd
,* 
buf
,
couÁ
)

92 
”rÜ
;

93 
fe
 * file;

94 
šode
 * inode;

96 ià(
fd
>=
NR_OPEN
 || !(
fe
=
cu¼’t
->
fp
[fd]è|| !(
šode
=fe->
f_šode
))

97  -
EBADF
;

98 ià(!(
fe
->
f_mode
 & 2))

99  -
EBADF
;

100 ià(!
fe
->
f_İ
 || !fe->f_İ->
wr™e
)

101  -
EINVAL
;

102 ià(!
couÁ
)

104 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
,
buf
,
couÁ
);

105 ià(
”rÜ
)

106  
”rÜ
;

107  
fe
->
f_İ
->
	`wr™e
(
šode
,fe,
buf
,
couÁ
);

108 
	}
}

	@fs/select.c

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/time.h
>

10 
	~<lšux/fs.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/¡©.h
>

15 
	~<lšux/sigÇl.h
>

16 
	~<lšux/”ºo.h
>

18 
	~<asm/£gm’t.h
>

19 
	~<asm/sy¡em.h
>

21 
	#ROUND_UP
(
x
,
y
è(((x)+(y)-1)/(y))

	)

41 
	$ä“_wa™
(
£Ëù_bË
 * 
p
)

43 
£Ëù_bË_’Œy
 * 
’Œy
 = 
p
->’Œy +…->
Ä
;

45 
p
->
Ä
 > 0) {

46 
p
->
Ä
--;

47 
’Œy
--;

48 
	`»move_wa™_queue
(
’Œy
->
wa™_add»ss
,&’Œy->
wa™
);

50 
	}
}

63 
	$check
(
æag
, 
£Ëù_bË
 * 
wa™
, 
fe
 * file)

65 
šode
 * inode;

66 
fe_İ”©iÚs
 *
fİs
;

67 (*
£Ëù
è(
šode
 *, 
fe
 *, , 
£Ëù_bË
 *);

69 
šode
 = 
fe
->
f_šode
;

70 ià((
fİs
 = 
fe
->
f_İ
è&& (
£Ëù
 = fops->select))

71  
	`£Ëù
(
šode
, 
fe
, 
æag
, 
wa™
)

72 || (
wa™
 && 
	`£Ëù
(
šode
, 
fe
, 
æag
, 
NULL
));

73 ià(
	`S_ISREG
(
šode
->
i_mode
))

76 
	}
}

78 
	$do_£Ëù
(
n
, 
fd_£t
 *
š
, fd_£ˆ*
out
, fd_£ˆ*
ex
,

79 
fd_£t
 *
»s_š
, fd_£ˆ*
»s_out
, fd_£ˆ*
»s_ex
)

81 
couÁ
;

82 
£Ëù_bË
 
wa™_bË
, *
wa™
;

83 
£Ëù_bË_’Œy
 *
’Œy
;

84 
£t
;

85 
i
,
j
;

86 
max
 = -1;

88 
j
 = 0 ; j < 
__FDSET_LONGS
 ; j++) {

89 
i
 = 
j
 << 5;

90 ià(
i
 >ğ
n
)

92 
£t
 = 
š
->
fds_b™s
[
j
] | 
out
->fds_b™s[j] | 
ex
->fds_bits[j];

93  ; 
£t
 ; 
i
++,set >>= 1) {

94 ià(
i
 >ğ
n
)

95 
’d_check
;

96 ià(!(
£t
 & 1))

98 ià(!
cu¼’t
->
fp
[
i
])

99  -
EBADF
;

100 ià(!
cu¼’t
->
fp
[
i
]->
f_šode
)

101  -
EBADF
;

102 
max
 = 
i
;

105 
’d_check
:

106 
n
 = 
max
 + 1;

107 if(!(
’Œy
 = (
£Ëù_bË_’Œy
*è
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

108  -
ENOMEM
;

109 
	`FD_ZERO
(
»s_š
);

110 
	`FD_ZERO
(
»s_out
);

111 
	`FD_ZERO
(
»s_ex
);

112 
couÁ
 = 0;

113 
wa™_bË
.
Ä
 = 0;

114 
wa™_bË
.
’Œy
 =ƒntry;

115 
wa™
 = &
wa™_bË
;

116 
»³©
:

117 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

118 
i
 = 0 ; i < 
n
 ; i++) {

119 ià(
	`FD_ISSET
(
i
,
š
è&& 
	`check
(
SEL_IN
,
wa™
,
cu¼’t
->
fp
[i])) {

120 
	`FD_SET
(
i
, 
»s_š
);

121 
couÁ
++;

122 
wa™
 = 
NULL
;

124 ià(
	`FD_ISSET
(
i
,
out
è&& 
	`check
(
SEL_OUT
,
wa™
,
cu¼’t
->
fp
[i])) {

125 
	`FD_SET
(
i
, 
»s_out
);

126 
couÁ
++;

127 
wa™
 = 
NULL
;

129 ià(
	`FD_ISSET
(
i
,
ex
è&& 
	`check
(
SEL_EX
,
wa™
,
cu¼’t
->
fp
[i])) {

130 
	`FD_SET
(
i
, 
»s_ex
);

131 
couÁ
++;

132 
wa™
 = 
NULL
;

135 
wa™
 = 
NULL
;

136 ià(!
couÁ
 && 
cu¼’t
->
timeout
 && !(cu¼’t->
sigÇl
 & ~cu¼’t->
blocked
)) {

137 
	`scheduË
();

138 
»³©
;

140 
	`ä“_wa™
(&
wa™_bË
);

141 
	`ä“_·ge
((è
’Œy
);

142 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

143  
couÁ
;

144 
	}
}

150 
	$__g‘_fd_£t
(
Ä
, * 
fs_poš‹r
, * 
fd£t
)

152 
”rÜ
;

154 
	`FD_ZERO
(
fd£t
);

155 ià(!
fs_poš‹r
)

157 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
fs_poš‹r
,(
fd_£t
));

158 ià(
”rÜ
)

159  
”rÜ
;

160 
Ä
 > 0) {

161 *
fd£t
 = 
	`g‘_fs_lÚg
(
fs_poš‹r
);

162 
fd£t
++;

163 
fs_poš‹r
++;

164 
Ä
 -= 32;

167 
	}
}

169 
	$__£t_fd_£t
(
Ä
, * 
fs_poš‹r
, * 
fd£t
)

171 ià(!
fs_poš‹r
)

173 
Ä
 > 0) {

174 
	`put_fs_lÚg
(*
fd£t
, 
fs_poš‹r
);

175 
fd£t
++;

176 
fs_poš‹r
++;

177 
Ä
 -= 32;

179 
	}
}

181 
	#g‘_fd_£t
(
Ä
,
f¥
,
fdp
) \

182 
	`__g‘_fd_£t
(
Ä
, (*è(
f¥
), (*è(
fdp
))

	)

184 
	#£t_fd_£t
(
Ä
,
f¥
,
fdp
) \

185 
	`__£t_fd_£t
(
Ä
, (*è(
f¥
), (*è(
fdp
))

	)

195 
asmlškage
 
	$sys_£Ëù
Ğ*
bufãr
 )

198 
i
;

199 
fd_£t
 
»s_š
, 
š
, *
šp
;

200 
fd_£t
 
»s_out
, 
out
, *
ou
;

201 
fd_£t
 
»s_ex
, 
ex
, *
exp
;

202 
n
;

203 
timev®
 *
tvp
;

204 
timeout
;

206 
i
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
bufãr
, 20);

207 ià(
i
)

208  
i
;

209 
n
 = 
	`g‘_fs_lÚg
(
bufãr
++);

210 ià(
n
 < 0)

211  -
EINVAL
;

212 ià(
n
 > 
NR_OPEN
)

213 
n
 = 
NR_OPEN
;

214 
šp
 = (
fd_£t
 *è
	`g‘_fs_lÚg
(
bufãr
++);

215 
ou
 = (
fd_£t
 *è
	`g‘_fs_lÚg
(
bufãr
++);

216 
exp
 = (
fd_£t
 *è
	`g‘_fs_lÚg
(
bufãr
++);

217 
tvp
 = (
timev®
 *è
	`g‘_fs_lÚg
(
bufãr
);

218 ià((
i
 = 
	`g‘_fd_£t
(
n
, 
šp
, &
š
)) ||

219 (
i
 = 
	`g‘_fd_£t
(
n
, 
ou
, &
out
)) ||

220 (
i
 = 
	`g‘_fd_£t
(
n
, 
exp
, &
ex
)))  i;

221 
timeout
 = ~0UL;

222 ià(
tvp
) {

223 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
tvp
, (*tvp));

224 ià(
i
)

225  
i
;

226 
timeout
 = 
	`ROUND_UP
(
	`g‘_fs_lÚg
((*)&
tvp
->
tv_u£c
),(1000000/
HZ
));

227 
timeout
 +ğ
	`g‘_fs_lÚg
((*)&
tvp
->
tv_£c
è* 
HZ
;

228 ià(
timeout
)

229 
timeout
 +ğ
jiff›s
 + 1;

231 
cu¼’t
->
timeout
 =imeout;

232 
i
 = 
	`do_£Ëù
(
n
, &
š
, &
out
, &
ex
, &
»s_š
, &
»s_out
, &
»s_ex
);

233 ià(
cu¼’t
->
timeout
 > 
jiff›s
)

234 
timeout
 = 
cu¼’t
->timeouˆ- 
jiff›s
;

236 
timeout
 = 0;

237 
cu¼’t
->
timeout
 = 0;

238 ià(
tvp
) {

239 
	`put_fs_lÚg
(
timeout
/
HZ
, (*è&
tvp
->
tv_£c
);

240 
timeout
 %ğ
HZ
;

241 
timeout
 *ğ(1000000/
HZ
);

242 
	`put_fs_lÚg
(
timeout
, (*è&
tvp
->
tv_u£c
);

244 ià(
i
 < 0)

245  
i
;

246 ià(!
i
 && (
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
))

247  -
ERESTARTNOHAND
;

248 
	`£t_fd_£t
(
n
, 
šp
, &
»s_š
);

249 
	`£t_fd_£t
(
n
, 
ou
, &
»s_out
);

250 
	`£t_fd_£t
(
n
, 
exp
, &
»s_ex
);

251  
i
;

252 
	}
}

	@fs/stat.c

7 
	~<lšux/”ºo.h
>

8 
	~<lšux/¡©.h
>

9 
	~<lšux/fs.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/k”Ãl.h
>

12 
	~<asm/£gm’t.h
>

14 
	$ı_Şd_¡©
(
šode
 * inode, 
Şd_¡©
 * 
¡©buf
)

16 
Şd_¡©
 
tmp
;

18 
	`´štk
("VFS: Warning: %s using old stat() call. Recompile your binary.\n",

19 
cu¼’t
->
comm
);

20 
tmp
.
¡_dev
 = 
šode
->
i_dev
;

21 
tmp
.
¡_šo
 = 
šode
->
i_šo
;

22 
tmp
.
¡_mode
 = 
šode
->
i_mode
;

23 
tmp
.
¡_Æšk
 = 
šode
->
i_Æšk
;

24 
tmp
.
¡_uid
 = 
šode
->
i_uid
;

25 
tmp
.
¡_gid
 = 
šode
->
i_gid
;

26 
tmp
.
¡_rdev
 = 
šode
->
i_rdev
;

27 
tmp
.
¡_size
 = 
šode
->
i_size
;

28 
tmp
.
¡_©ime
 = 
šode
->
i_©ime
;

29 
tmp
.
¡_mtime
 = 
šode
->
i_mtime
;

30 
tmp
.
¡_ùime
 = 
šode
->
i_ùime
;

31 
	`memıy_tofs
(
¡©buf
,&
tmp
,(tmp));

32 
	}
}

34 
	$ı_Ãw_¡©
(
šode
 * inode, 
Ãw_¡©
 * 
¡©buf
)

36 
Ãw_¡©
 
tmp
 = {0, };

37 
blocks
, 
šdœeù
;

39 
tmp
.
¡_dev
 = 
šode
->
i_dev
;

40 
tmp
.
¡_šo
 = 
šode
->
i_šo
;

41 
tmp
.
¡_mode
 = 
šode
->
i_mode
;

42 
tmp
.
¡_Æšk
 = 
šode
->
i_Æšk
;

43 
tmp
.
¡_uid
 = 
šode
->
i_uid
;

44 
tmp
.
¡_gid
 = 
šode
->
i_gid
;

45 
tmp
.
¡_rdev
 = 
šode
->
i_rdev
;

46 
tmp
.
¡_size
 = 
šode
->
i_size
;

47 
tmp
.
¡_©ime
 = 
šode
->
i_©ime
;

48 
tmp
.
¡_mtime
 = 
šode
->
i_mtime
;

49 
tmp
.
¡_ùime
 = 
šode
->
i_ùime
;

65 
	#D_B
 7

	)

66 
	#I_B
 (
BLOCK_SIZE
 / ())

	)

68 ià(!
šode
->
i_blksize
) {

69 
blocks
 = (
tmp
.
¡_size
 + 
BLOCK_SIZE
 - 1) / BLOCK_SIZE;

70 ià(
blocks
 > 
D_B
) {

71 
šdœeù
 = (
blocks
 - 
D_B
 + 
I_B
 - 1) / I_B;

72 
blocks
 +ğ
šdœeù
;

73 ià(
šdœeù
 > 1) {

74 
šdœeù
 = (šdœeù - 1 + 
I_B
 - 1) / I_B;

75 
blocks
 +ğ
šdœeù
;

76 ià(
šdœeù
 > 1)

77 
blocks
++;

80 
tmp
.
¡_blocks
 = (
BLOCK_SIZE
 / 512è* 
blocks
;

81 
tmp
.
¡_blksize
 = 
BLOCK_SIZE
;

83 
tmp
.
¡_blocks
 = 
šode
->
i_blocks
;

84 
tmp
.
¡_blksize
 = 
šode
->
i_blksize
;

86 
	`memıy_tofs
(
¡©buf
,&
tmp
,(tmp));

87 
	}
}

89 
asmlškage
 
	$sys_¡©
(* 
f’ame
, 
Şd_¡©
 * 
¡©buf
)

91 
šode
 * inode;

92 
”rÜ
;

94 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

95 ià(
”rÜ
)

96  
”rÜ
;

97 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

98 ià(
”rÜ
)

99  
”rÜ
;

100 
	`ı_Şd_¡©
(
šode
,
¡©buf
);

101 
	`ut
(
šode
);

103 
	}
}

105 
asmlškage
 
	$sys_Ãw¡©
(* 
f’ame
, 
Ãw_¡©
 * 
¡©buf
)

107 
šode
 * inode;

108 
”rÜ
;

110 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

111 ià(
”rÜ
)

112  
”rÜ
;

113 
”rÜ
 = 
	`Çmei
(
f’ame
,&
šode
);

114 ià(
”rÜ
)

115  
”rÜ
;

116 
	`ı_Ãw_¡©
(
šode
,
¡©buf
);

117 
	`ut
(
šode
);

119 
	}
}

121 
asmlškage
 
	$sys_l¡©
(* 
f’ame
, 
Şd_¡©
 * 
¡©buf
)

123 
šode
 * inode;

124 
”rÜ
;

126 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

127 ià(
”rÜ
)

128  
”rÜ
;

129 
”rÜ
 = 
	`Êamei
(
f’ame
,&
šode
);

130 ià(
”rÜ
)

131  
”rÜ
;

132 
	`ı_Şd_¡©
(
šode
,
¡©buf
);

133 
	`ut
(
šode
);

135 
	}
}

137 
asmlškage
 
	$sys_Ãwl¡©
(* 
f’ame
, 
Ãw_¡©
 * 
¡©buf
)

139 
šode
 * inode;

140 
”rÜ
;

142 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

143 ià(
”rÜ
)

144  
”rÜ
;

145 
”rÜ
 = 
	`Êamei
(
f’ame
,&
šode
);

146 ià(
”rÜ
)

147  
”rÜ
;

148 
	`ı_Ãw_¡©
(
šode
,
¡©buf
);

149 
	`ut
(
šode
);

151 
	}
}

153 
asmlškage
 
	$sys_f¡©
(
fd
, 
Şd_¡©
 * 
¡©buf
)

155 
fe
 * 
f
;

156 
šode
 * inode;

157 
”rÜ
;

159 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

160 ià(
”rÜ
)

161  
”rÜ
;

162 ià(
fd
 >ğ
NR_OPEN
 || !(
f
=
cu¼’t
->
fp
[fd]è|| !(
šode
=f->
f_šode
))

163  -
EBADF
;

164 
	`ı_Şd_¡©
(
šode
,
¡©buf
);

166 
	}
}

168 
asmlškage
 
	$sys_Ãwf¡©
(
fd
, 
Ãw_¡©
 * 
¡©buf
)

170 
fe
 * 
f
;

171 
šode
 * inode;

172 
”rÜ
;

174 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¡©buf
, (*statbuf));

175 ià(
”rÜ
)

176  
”rÜ
;

177 ià(
fd
 >ğ
NR_OPEN
 || !(
f
=
cu¼’t
->
fp
[fd]è|| !(
šode
=f->
f_šode
))

178  -
EBADF
;

179 
	`ı_Ãw_¡©
(
šode
,
¡©buf
);

181 
	}
}

183 
asmlškage
 
	$sys_»adlšk
(cÚ¡ * 
·th
, * 
buf
, 
bufsiz
)

185 
šode
 * inode;

186 
”rÜ
;

188 ià(
bufsiz
 <= 0)

189  -
EINVAL
;

190 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
buf
,
bufsiz
);

191 ià(
”rÜ
)

192  
”rÜ
;

193 
”rÜ
 = 
	`Êamei
(
·th
,&
šode
);

194 ià(
”rÜ
)

195  
”rÜ
;

196 ià(!
šode
->
i_İ
 || !šode->i_İ->
»adlšk
) {

197 
	`ut
(
šode
);

198  -
EINVAL
;

200  
šode
->
i_İ
->
	`»adlšk
(šode,
buf
,
bufsiz
);

201 
	}
}

	@fs/super.c

10 
	~<lšux/cÚfig.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/majÜ.h
>

14 
	~<lšux/¡©.h
>

15 
	~<lšux/”ºo.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/locks.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/£gm’t.h
>

28 
fe_sy¡em_ty³
 
fe_sy¡ems
[];

29 
fe_İ”©iÚs
 * 
g‘_blkfİs
();

30 
fe_İ”©iÚs
 * 
g‘_chrfİs
();

32 
wa™_fÜ_key´ess
();

33 
fú_š™_locks
();

35 
roÙ_mouÁæags
;

37 
su³r_block
 
	gsu³r_blocks
[
NR_SUPER
];

39 
do_»mouÁ_sb
(
su³r_block
 *
sb
, 
æags
, * 
d©a
);

42 
dev_t
 
	gROOT_DEV
 = 0;

44 
fe_sy¡em_ty³
 *
	$g‘_fs_ty³
(*
Çme
)

46 
a
;

48 ià(!
Çme
)

49  &
fe_sy¡ems
[0];

50 
a
 = 0 ; 
fe_sy¡ems
[a].
»ad_su³r
 ;‡++)

51 ià(!
	`¡rcmp
(
Çme
,
fe_sy¡ems
[
a
].name))

52 (&
fe_sy¡ems
[
a
]);

53  
NULL
;

54 
	}
}

56 
	$__wa™_Ú_su³r
(
su³r_block
 * 
sb
)

58 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

60 
	`add_wa™_queue
(&
sb
->
s_wa™
, &
wa™
);

61 
»³©
:

62 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

63 ià(
sb
->
s_lock
) {

64 
	`scheduË
();

65 
»³©
;

67 
	`»move_wa™_queue
(&
sb
->
s_wa™
, &
wa™
);

68 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

69 
	}
}

71 
	$sync_su³rs
(
dev_t
 
dev
)

73 
su³r_block
 * 
sb
;

75 
sb
 = 
su³r_blocks
 + 0 ; sb < su³r_block + 
NR_SUPER
 ; sb++) {

76 ià(!
sb
->
s_dev
)

78 ià(
dev
 && 
sb
->
s_dev
 != dev)

80 
	`wa™_Ú_su³r
(
sb
);

81 ià(!
sb
->
s_dev
 || !sb->
s_dœt
)

83 ià(
dev
 && (dev !ğ
sb
->
s_dev
))

85 ià(
sb
->
s_İ
 && sb->s_İ->
wr™e_su³r
)

86 
sb
->
s_İ
->
	`wr™e_su³r
(sb);

88 
	}
}

90 
su³r_block
 * 
	$g‘_su³r
(
dev_t
 
dev
)

92 
su³r_block
 * 
s
;

94 ià(!
dev
)

95  
NULL
;

96 
s
 = 0+
su³r_blocks
;

97 
s
 < 
NR_SUPER
+
su³r_blocks
)

98 ià(
s
->
s_dev
 =ğ
dev
) {

99 
	`wa™_Ú_su³r
(
s
);

100 ià(
s
->
s_dev
 =ğ
dev
)

101  
s
;

102 
s
 = 0+
su³r_blocks
;

104 
s
++;

105  
NULL
;

106 
	}
}

108 
	$put_su³r
(
dev_t
 
dev
)

110 
su³r_block
 * 
sb
;

112 ià(
dev
 =ğ
ROOT_DEV
) {

113 
	`´štk
("VFS: Root device %d/%d:…repare for‡rmageddon\n",

114 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

117 ià(!(
sb
 = 
	`g‘_su³r
(
dev
)))

119 ià(
sb
->
s_cov”ed
) {

120 
	`´štk
("VFS: Mounted device %d/%d -ssk,ssk\n",

121 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

124 ià(
sb
->
s_İ
 && sb->s_İ->
put_su³r
)

125 
sb
->
s_İ
->
	`put_su³r
(sb);

126 
	}
}

128 
su³r_block
 * 
	$»ad_su³r
(
dev_t
 
dev
,*
Çme
,
æags
,

129 *
d©a
, 
s’t
)

131 
su³r_block
 * 
s
;

132 
fe_sy¡em_ty³
 *
ty³
;

134 ià(!
dev
)

135  
NULL
;

136 
	`check_disk_chªge
(
dev
);

137 
s
 = 
	`g‘_su³r
(
dev
);

138 ià(
s
)

139  
s
;

140 ià(!(
ty³
 = 
	`g‘_fs_ty³
(
Çme
))) {

141 
	`´štk
("VFS: on device %d/%d: get_fs_type(%s) failed\n",

142 
	`MAJOR
(
dev
), 
	`MINOR
(dev), 
Çme
);

143  
NULL
;

145 
s
 = 0+
su³r_blocks
 ;; s++) {

146 ià(
s
 >ğ
NR_SUPER
+
su³r_blocks
)

147  
NULL
;

148 ià(!
s
->
s_dev
)

151 
s
->
s_dev
 = 
dev
;

152 
s
->
s_æags
 = 
æags
;

153 ià(!
ty³
->
	`»ad_su³r
(
s
,
d©a
, 
s’t
)) {

154 
s
->
s_dev
 = 0;

155  
NULL
;

157 
s
->
s_dev
 = 
dev
;

158 
s
->
s_cov”ed
 = 
NULL
;

159 
s
->
s_rd_Úly
 = 0;

160 
s
->
s_dœt
 = 0;

161  
s
;

162 
	}
}

169 
	guÂamed_dev_š_u£
[256];

171 
dev_t
 
	$g‘_uÂamed_dev
()

173 
fœ¡_u£
 = 0;

174 
i
;

176 ià(
fœ¡_u£
 == 0) {

177 
fœ¡_u£
 = 1;

178 
	`mem£t
(
uÂamed_dev_š_u£
, 0, (unnamed_dev_in_use));

179 
uÂamed_dev_š_u£
[0] = 1;

181 
i
 = 0; i <  
uÂamed_dev_š_u£
/ unnamed_dev_in_use[0]; i++) {

182 ià(!
uÂamed_dev_š_u£
[
i
]) {

183 
uÂamed_dev_š_u£
[
i
] = 1;

184  (
UNNAMED_MAJOR
 << 8è| 
i
;

188 
	}
}

190 
	$put_uÂamed_dev
(
dev_t
 
dev
)

192 ià(!
dev
)

194 ià(!
uÂamed_dev_š_u£
[
dev
]) {

195 
	`´štk
("VFS:…ut_unnamed_dev: freeing unused device %d/%d\n",

196 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

199 
uÂamed_dev_š_u£
[
dev
] = 0;

200 
	}
}

202 
	$do_umouÁ
(
dev_t
 
dev
)

204 
su³r_block
 * 
sb
;

205 
»tv®
;

207 ià(
dev
==
ROOT_DEV
) {

210 ià(!(
sb
=
	`g‘_su³r
(
dev
)))

211  -
ENOENT
;

212 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

213 
	`fsync_dev
(
dev
);

214 
»tv®
 = 
	`do_»mouÁ_sb
(
sb
, 
MS_RDONLY
, 0);

215 ià(
»tv®
)

216  
»tv®
;

220 ià(!(
sb
=
	`g‘_su³r
(
dev
)è|| !(sb->
s_cov”ed
))

221  -
ENOENT
;

222 ià(!
sb
->
s_cov”ed
->
i_mouÁ
)

223 
	`´štk
("VFS: umount(%d/%d): mounted inode has i_mount=NULL\n",

224 
	`MAJOR
(
dev
), 
	`MINOR
(dev));

225 ià(!
	`fs_may_umouÁ
(
dev
, 
sb
->
s_mouÁed
))

226  -
EBUSY
;

227 
sb
->
s_cov”ed
->
i_mouÁ
 = 
NULL
;

228 
	`ut
(
sb
->
s_cov”ed
);

229 
sb
->
s_cov”ed
 = 
NULL
;

230 
	`ut
(
sb
->
s_mouÁed
);

231 
sb
->
s_mouÁed
 = 
NULL
;

232 ià(
sb
->
s_İ
 && sb->s_İ->
wr™e_su³r
 && sb->
s_dœt
)

233 
sb
->
s_İ
->
	`wr™e_su³r
(sb);

234 
	`put_su³r
(
dev
);

236 
	}
}

249 
asmlškage
 
	$sys_umouÁ
(* 
Çme
)

251 
šode
 * inode;

252 
dev_t
 
dev
;

253 
»tv®
;

254 
šode
 
dummy_šode
;

255 
fe_İ”©iÚs
 * 
fİs
;

257 ià(!
	`su£r
())

258  -
EPERM
;

259 
»tv®
 = 
	`Çmei
(
Çme
,&
šode
);

260 ià(
»tv®
) {

261 
»tv®
 = 
	`Êamei
(
Çme
,&
šode
);

262 ià(
»tv®
)

263  
»tv®
;

265 ià(
	`S_ISBLK
(
šode
->
i_mode
)) {

266 
dev
 = 
šode
->
i_rdev
;

267 ià(
	`IS_NODEV
(
šode
)) {

268 
	`ut
(
šode
);

269  -
EACCES
;

272 ià(!
šode
 || !šode->
i_sb
 || inod!ğšode->i_sb->
s_mouÁed
) {

273 
	`ut
(
šode
);

274  -
EINVAL
;

276 
dev
 = 
šode
->
i_sb
->
s_dev
;

277 
	`ut
(
šode
);

278 
	`mem£t
(&
dummy_šode
, 0, (dummy_inode));

279 
dummy_šode
.
i_rdev
 = 
dev
;

280 
šode
 = &
dummy_šode
;

282 ià(
	`MAJOR
(
dev
è>ğ
MAX_BLKDEV
) {

283 
	`ut
(
šode
);

284  -
ENXIO
;

286 ià(!(
»tv®
 = 
	`do_umouÁ
(
dev
)è&& dev !ğ
ROOT_DEV
) {

287 
fİs
 = 
	`g‘_blkfİs
(
	`MAJOR
(
dev
));

288 ià(
fİs
 && fİs->
»Ëa£
)

289 
fİs
->
	`»Ëa£
(
šode
,
NULL
);

290 ià(
	`MAJOR
(
dev
è=ğ
UNNAMED_MAJOR
)

291 
	`put_uÂamed_dev
(
dev
);

293 ià(
šode
 !ğ&
dummy_šode
)

294 
	`ut
(
šode
);

295 ià(
»tv®
)

296  
»tv®
;

297 
	`fsync_dev
(
dev
);

299 
	}
}

310 
	$do_mouÁ
(
dev_t
 
dev
, cÚ¡ * 
dœ
, * 
ty³
, 
æags
, * 
d©a
)

312 
šode
 * 
dœ_i
;

313 
su³r_block
 * 
sb
;

314 
”rÜ
;

316 
”rÜ
 = 
	`Çmei
(
dœ
,&
dœ_i
);

317 ià(
”rÜ
)

318  
”rÜ
;

319 ià(
dœ_i
->
i_couÁ
 !ğ1 || dœ_i->
i_mouÁ
) {

320 
	`ut
(
dœ_i
);

321  -
EBUSY
;

323 ià(!
	`S_ISDIR
(
dœ_i
->
i_mode
)) {

324 
	`ut
(
dœ_i
);

325  -
EPERM
;

327 ià(!
	`fs_may_mouÁ
(
dev
)) {

328 
	`ut
(
dœ_i
);

329  -
EBUSY
;

331 
sb
 = 
	`»ad_su³r
(
dev
,
ty³
,
æags
,
d©a
,0);

332 ià(!
sb
 || sb->
s_cov”ed
) {

333 
	`ut
(
dœ_i
);

334  -
EBUSY
;

336 
sb
->
s_cov”ed
 = 
dœ_i
;

337 
dœ_i
->
i_mouÁ
 = 
sb
->
s_mouÁed
;

339 
	}
}

348 
	$do_»mouÁ_sb
(
su³r_block
 *
sb
, 
æags
, *
d©a
)

350 
»tv®
;

353 ià((
æags
 & 
MS_RDONLY
è&& !(
sb
->
s_æags
 & MS_RDONLY))

354 ià(!
	`fs_may_»mouÁ_ro
(
sb
->
s_dev
))

355  -
EBUSY
;

356 ià(
sb
->
s_İ
 && sb->s_İ->
»mouÁ_fs
) {

357 
»tv®
 = 
sb
->
s_İ
->
	`»mouÁ_fs
(sb, &
æags
, 
d©a
);

358 ià(
»tv®
)

359  
»tv®
;

361 
sb
->
s_æags
 = (sb->s_æag & ~
MS_RMT_MASK
) |

362 (
æags
 & 
MS_RMT_MASK
);

364 
	}
}

366 
	$do_»mouÁ
(cÚ¡ *
dœ
,
æags
,*
d©a
)

368 
šode
 *
dœ_i
;

369 
»tv®
;

371 
»tv®
 = 
	`Çmei
(
dœ
,&
dœ_i
);

372 ià(
»tv®
)

373  
»tv®
;

374 ià(
dœ_i
 !ğdœ_i->
i_sb
->
s_mouÁed
) {

375 
	`ut
(
dœ_i
);

376  -
EINVAL
;

378 
»tv®
 = 
	`do_»mouÁ_sb
(
dœ_i
->
i_sb
, 
æags
, 
d©a
);

379 
	`ut
(
dœ_i
);

380  
»tv®
;

381 
	}
}

383 
	$cİy_mouÁ_İtiÚs
 (cÚ¡ * 
d©a
, *
wh”e
)

385 
i
;

386 
·ge
;

387 
vm_¬—_¡ruù
 * 
vma
;

389 *
wh”e
 = 0;

390 ià(!
d©a
)

393 
vma
 = 
cu¼’t
->
mm­
 ; ; ) {

394 ià(!
vma
 ||

395 (è
d©a
 < 
vma
->
vm_¡¬t
) {

396  -
EFAULT
;

398 ià((è
d©a
 < 
vma
->
vm_’d
)

400 
vma
 = vma->
vm_Ãxt
;

402 
i
 = 
vma
->
vm_’d
 - (è
d©a
;

403 ià(
PAGE_SIZE
 <ğ(è
i
)

404 
i
 = 
PAGE_SIZE
-1;

405 ià(!(
·ge
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
))) {

406  -
ENOMEM
;

408 
	`memıy_äomfs
((*è
·ge
,
d©a
,
i
);

409 *
wh”e
 = 
·ge
;

411 
	}
}

427 
asmlškage
 
	$sys_mouÁ
(* 
dev_Çme
, * 
dœ_Çme
, * 
ty³
,

428 
Ãw_æags
, * 
d©a
)

430 
fe_sy¡em_ty³
 * 
f¡y³
;

431 
šode
 * inode;

432 
fe_İ”©iÚs
 * 
fİs
;

433 
dev_t
 
dev
;

434 
»tv®
;

435 * 
t
;

436 
æags
 = 0;

437 
·ge
 = 0;

439 ià(!
	`su£r
())

440  -
EPERM
;

441 ià((
Ãw_æags
 &

442 (
MS_MGC_MSK
 | 
MS_REMOUNT
)è=ğ(
MS_MGC_VAL
 | MS_REMOUNT)) {

443 
»tv®
 = 
	`cİy_mouÁ_İtiÚs
 (
d©a
, &
·ge
);

444 ià(
»tv®
 < 0)

445  
»tv®
;

446 
»tv®
 = 
	`do_»mouÁ
(
dœ_Çme
,

447 
Ãw_æags
 & ~
MS_MGC_MSK
 & ~
MS_REMOUNT
,

448 (*è
·ge
);

449 
	`ä“_·ge
(
·ge
);

450  
»tv®
;

452 
»tv®
 = 
	`cİy_mouÁ_İtiÚs
 (
ty³
, &
·ge
);

453 ià(
»tv®
 < 0)

454  
»tv®
;

455 
f¡y³
 = 
	`g‘_fs_ty³
((*è
·ge
);

456 
	`ä“_·ge
(
·ge
);

457 ià(!
f¡y³
)

458  -
ENODEV
;

459 
t
 = 
f¡y³
->
Çme
;

460 ià(
f¡y³
->
»quœes_dev
) {

461 
»tv®
 = 
	`Çmei
(
dev_Çme
,&
šode
);

462 ià(
»tv®
)

463  
»tv®
;

464 ià(!
	`S_ISBLK
(
šode
->
i_mode
)) {

465 
	`ut
(
šode
);

466  -
ENOTBLK
;

468 ià(
	`IS_NODEV
(
šode
)) {

469 
	`ut
(
šode
);

470  -
EACCES
;

472 
dev
 = 
šode
->
i_rdev
;

473 ià(
	`MAJOR
(
dev
è>ğ
MAX_BLKDEV
) {

474 
	`ut
(
šode
);

475  -
ENXIO
;

478 ià(!(
dev
 = 
	`g‘_uÂamed_dev
()))

479  -
EMFILE
;

480 
šode
 = 
NULL
;

482 
fİs
 = 
	`g‘_blkfİs
(
	`MAJOR
(
dev
));

483 ià(
fİs
 && fİs->
İ’
) {

484 
»tv®
 = 
fİs
->
	`İ’
(
šode
,
NULL
);

485 ià(
»tv®
) {

486 
	`ut
(
šode
);

487  
»tv®
;

490 
·ge
 = 0;

491 ià((
Ãw_æags
 & 
MS_MGC_MSK
è=ğ
MS_MGC_VAL
) {

492 
æags
 = 
Ãw_æags
 & ~
MS_MGC_MSK
;

493 
»tv®
 = 
	`cİy_mouÁ_İtiÚs
(
d©a
, &
·ge
);

494 ià(
»tv®
 < 0) {

495 
	`ut
(
šode
);

496  
»tv®
;

499 
»tv®
 = 
	`do_mouÁ
(
dev
,
dœ_Çme
,
t
,
æags
,(*è
·ge
);

500 
	`ä“_·ge
(
·ge
);

501 ià(
»tv®
 && 
fİs
 && fİs->
»Ëa£
)

502 
fİs
->
	`»Ëa£
(
šode
,
NULL
);

503 
	`ut
(
šode
);

504  
»tv®
;

505 
	}
}

507 
	$mouÁ_roÙ
()

509 
fe_sy¡em_ty³
 * 
fs_ty³
;

510 
su³r_block
 * 
sb
;

511 
šode
 * inode;

513 
	`mem£t
(
su³r_blocks
, 0, (super_blocks));

514 
	`fú_š™_locks
();

515 ià(
	`MAJOR
(
ROOT_DEV
è=ğ
FLOPPY_MAJOR
) {

516 
	`´štk
(
KERN_NOTICE
 "VFS: Insert„oot floppy‡nd…ress ENTER\n");

517 
	`wa™_fÜ_key´ess
();

519 
fs_ty³
 = 
fe_sy¡ems
; fs_ty³->
»ad_su³r
; fs_type++) {

520 ià(!
fs_ty³
->
»quœes_dev
)

522 
sb
 = 
	`»ad_su³r
(
ROOT_DEV
,
fs_ty³
->
Çme
,
roÙ_mouÁæags
,
NULL
,1);

523 ià(
sb
) {

524 
šode
 = 
sb
->
s_mouÁed
;

525 
šode
->
i_couÁ
 += 3 ;

526 
sb
->
s_cov”ed
 = 
šode
;

527 
sb
->
s_æags
 = 
roÙ_mouÁæags
;

528 
cu¼’t
->
pwd
 = 
šode
;

529 
cu¼’t
->
roÙ
 = 
šode
;

530 
	`´štk
 ("VFS: Mounted„oot (%s filesystem)%s.\n",

531 
fs_ty³
->
Çme
,

532 (
sb
->
s_æags
 & 
MS_RDONLY
) ? "„eadonly" : "");

536 
	`·nic
("VFS: Unableo mount„oot");

537 
	}
}

	@fs/sysv/balloc.c

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/sysv_fs.h
>

25 
	~<lšux/¡ršg.h
>

26 
	~<lšux/locks.h
>

32 
šlše
 
	$memz”o
 (* 
s
, 
size_t
 
couÁ
)

34 
	`__asm__
("cld\n\t"

38 :"a" (0),"D" (
s
),"c" (
couÁ
/4)

40 
	}
}

42 
	$sysv_ä“_block
(
su³r_block
 * 
sb
, 
block
)

44 
bufãr_h—d
 * 
bh
;

45 * 
bh_d©a
;

47 ià(!
sb
) {

48 
	`´štk
("sysv_free_block:ryingo free block on‚onexistent device\n");

51 ià(
block
 < 
sb
->
sv_fœ¡d©azÚe
 || block >ğsb->
sv_nzÚes
) {

52 
	`´štk
("sysv_free_block:ryingo free block‚ot in datazone\n");

55 
	`lock_su³r
(
sb
);

56 ià(*
sb
->
sv_sb_æc_couÁ
 > sb->
sv_æc_size
) {

57 
	`´štk
("sysv_free_block: flc_count > flc_size\n");

58 
	`uÆock_su³r
(
sb
);

64 ià(*
sb
->
sv_sb_æc_couÁ
 =ğsb->
sv_æc_size
) {

65 * 
æc_couÁ
;

66 * 
æc_blocks
;

68 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

69 
bh
 = 
	`b»ad
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

71 
bh
 = 
	`g‘blk
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

72 ià(!
bh
) {

73 
	`´štk
("sysv_free_block: getblk() or bread() failed\n");

74 
	`uÆock_su³r
(
sb
);

77 
bh_d©a
 = 
bh
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

78 
sb
->
sv_ty³
) {

79 
FSTYPE_XENIX
:

80 
æc_couÁ
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

81 
æc_blocks
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

83 
FSTYPE_SYSV4
:

84 
æc_couÁ
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

85 
æc_blocks
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

87 
FSTYPE_SYSV2
:

88 
æc_couÁ
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

89 
æc_blocks
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

91 
FSTYPE_COH
:

92 
æc_couÁ
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

93 
æc_blocks
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

95 : 
	`·nic
("sysv_free_block: invalid fsype\n");

97 *
æc_couÁ
 = *
sb
->
sv_sb_æc_couÁ
;

98 
	`memıy
(
æc_blocks
, 
sb
->
sv_sb_æc_blocks
, *
æc_couÁ
 * (
sysv_zÚe_t
));

99 
bh
->
b_dœt
 = 1;

100 
bh
->
b_u±od©e
 = 1;

101 
	`b»l£
(
bh
);

102 *
sb
->
sv_sb_æc_couÁ
 = 0;

107 ià(*
sb
->
sv_sb_æc_couÁ
 == 0) {

108 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

109 
bh
 = 
	`b»ad
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

111 
bh
 = 
	`g‘blk
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

112 ià(!
bh
) {

113 
	`´štk
("sysv_free_block: getblk() or bread() failed\n");

114 
	`uÆock_su³r
(
sb
);

117 
bh_d©a
 = 
bh
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

118 
	`memz”o
(
bh_d©a
, 
sb
->
sv_block_size
);

120 
bh
->
b_dœt
 = 1;

121 
bh
->
b_u±od©e
 = 1;

122 
	`b»l£
(
bh
);

125 ià(
sb
->
sv_block_size_¿tio_b™s
 == 0) {

127 
bh
 = 
	`g‘_hash_bË
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

128 ià(
bh
)

129 
bh
->
b_dœt
 = 0;

130 
	`b»l£
(
bh
);

133 ià(
sb
->
sv_cÚv”t
)

134 
block
 = 
	`to_coh_ulÚg
(block);

135 
sb
->
sv_sb_æc_blocks
[(*sb->
sv_sb_æc_couÁ
)++] = 
block
;

136 ià(
sb
->
sv_cÚv”t
)

137 *
sb
->
sv_sb_tÙ®_ä“_blocks
 =

138 
	`to_coh_ulÚg
(
	`äom_coh_ulÚg
(*
sb
->
sv_sb_tÙ®_ä“_blocks
) + 1);

140 *
sb
->
sv_sb_tÙ®_ä“_blocks
 = *sb->sv_sb_total_free_blocks + 1;

141 
sb
->
sv_bh
->
b_dœt
 = 1;

142 
sb
->
s_dœt
 = 1;

143 
	`uÆock_su³r
(
sb
);

144 
	}
}

146 
	$sysv_Ãw_block
(
su³r_block
 * 
sb
)

148 
block
;

149 
bufãr_h—d
 * 
bh
;

150 * 
bh_d©a
;

152 ià(!
sb
) {

153 
	`´štk
("sysv_new_block:ryingo get‚ew block from‚onexistent device\n");

156 
	`lock_su³r
(
sb
);

157 ià(*
sb
->
sv_sb_æc_couÁ
 == 0) {

158 
	`uÆock_su³r
(
sb
);

161 
block
 = 
sb
->
sv_sb_æc_blocks
[(*sb->
sv_sb_æc_couÁ
)-1];

162 ià(
sb
->
sv_cÚv”t
)

163 
block
 = 
	`äom_coh_ulÚg
(block);

164 ià(
block
 == 0) {

165 
	`uÆock_su³r
(
sb
);

168 (*
sb
->
sv_sb_æc_couÁ
)--;

169 ià(
block
 < 
sb
->
sv_fœ¡d©azÚe
 || block >ğsb->
sv_nzÚes
) {

170 
	`´štk
("sysv_Ãw_block:‚ew block %d i nÙ iÀd©¨zÚe\n",
block
);

171 
	`uÆock_su³r
(
sb
);

174 ià(*
sb
->
sv_sb_æc_couÁ
 == 0) {

175 * 
æc_couÁ
;

176 * 
æc_blocks
;

178 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
, sb->
s_dev
, 
block
, &
bh_d©a
))) {

179 
	`´štk
("sysv_new_block: cannot„ead free-list block\n");

181 (*
sb
->
sv_sb_æc_couÁ
)++;

182 
	`uÆock_su³r
(
sb
);

185 
sb
->
sv_ty³
) {

186 
FSTYPE_XENIX
:

187 
æc_couÁ
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

188 
æc_blocks
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

190 
FSTYPE_SYSV4
:

191 
æc_couÁ
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

192 
æc_blocks
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

194 
FSTYPE_SYSV2
:

195 
æc_couÁ
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

196 
æc_blocks
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

198 
FSTYPE_COH
:

199 
æc_couÁ
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

200 
æc_blocks
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

202 : 
	`·nic
("sysv_new_block: invalid fsype\n");

204 ià(*
æc_couÁ
 > 
sb
->
sv_æc_size
) {

205 
	`´štk
("sysv_new_block: free-list block with >flc_sizeƒntries\n");

206 
	`b»l£
(
bh
);

207 
	`uÆock_su³r
(
sb
);

210 *
sb
->
sv_sb_æc_couÁ
 = *
æc_couÁ
;

211 
	`memıy
(
sb
->
sv_sb_æc_blocks
, 
æc_blocks
, *
æc_couÁ
 * (
sysv_zÚe_t
));

212 
	`b»l£
(
bh
);

215 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

216 
bh
 = 
	`b»ad
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

218 
bh
 = 
	`g‘blk
(
sb
->
s_dev
, (
block
 >> sb->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

219 ià(!
bh
) {

220 
	`´štk
("sysv_new_block: getblk() or bread() failed\n");

221 
	`uÆock_su³r
(
sb
);

224 
bh_d©a
 = 
bh
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

225 ià(
sb
->
sv_block_size_¿tio_b™s
 == 0)

226 ià(
bh
->
b_couÁ
 != 1) {

227 
	`´štk
("sysv_new_block: block‡lready in use\n");

228 
	`uÆock_su³r
(
sb
);

231 
	`memz”o
(
bh_d©a
,
sb
->
sv_block_size
);

232 
bh
->
b_dœt
 = 1;

233 
bh
->
b_u±od©e
 = 1;

234 
	`b»l£
(
bh
);

235 ià(
sb
->
sv_cÚv”t
)

236 *
sb
->
sv_sb_tÙ®_ä“_blocks
 =

237 
	`to_coh_ulÚg
(
	`äom_coh_ulÚg
(*
sb
->
sv_sb_tÙ®_ä“_blocks
) - 1);

239 *
sb
->
sv_sb_tÙ®_ä“_blocks
 = *sb->sv_sb_total_free_blocks - 1;

240 
sb
->
sv_bh
->
b_dœt
 = 1;

241 
sb
->
s_dœt
 = 1;

242 
	`uÆock_su³r
(
sb
);

243  
block
;

244 
	}
}

246 
	$sysv_couÁ_ä“_blocks
(
su³r_block
 * 
sb
)

249 
couÁ
, 
Şd_couÁ
;

250 
block
;

251 
bufãr_h—d
 * 
bh
;

252 * 
bh_d©a
;

253 
i
;

256 
couÁ
 = 0;

257 
	`lock_su³r
(
sb
);

258 ià(*
sb
->
sv_sb_æc_couÁ
 > 0) {

259 
i
 = *
sb
->
sv_sb_æc_couÁ
 ; ; ) {

260 
block
 = 
sb
->
sv_sb_æc_blocks
[--
i
];

261 ià(
sb
->
sv_cÚv”t
)

262 
block
 = 
	`äom_coh_ulÚg
(block);

263 ià(
block
 == 0)

264 
dÚe
;

265 
couÁ
++;

266 ià(
i
 == 0)

271 * 
æc_couÁ
;

272 * 
æc_blocks
;

274 ià(
block
 < 
sb
->
sv_fœ¡d©azÚe
 || block >ğsb->
sv_nzÚes
) {

275 
	`´štk
("sysv_couÁ_ä“_blocks:‚ew block %d i nÙ iÀd©¨zÚe\n",
block
);

278 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
, sb->
s_dev
, 
block
, &
bh_d©a
))) {

279 
	`´štk
("sysv_count_free_blocks: cannot„ead free-list block\n");

282 
sb
->
sv_ty³
) {

283 
FSTYPE_XENIX
:

284 
æc_couÁ
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

285 
æc_blocks
 = &((
x’ix_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

287 
FSTYPE_SYSV4
:

288 
æc_couÁ
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

289 
æc_blocks
 = &((
sysv4_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

291 
FSTYPE_SYSV2
:

292 
æc_couÁ
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

293 
æc_blocks
 = &((
sysv2_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

295 
FSTYPE_COH
:

296 
æc_couÁ
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_nä“
;

297 
æc_blocks
 = &((
coh_ä“li¡_chunk
 *è
bh_d©a
)->
æ_ä“
[0];

299 : 
	`·nic
("sysv_count_free_blocks: invalid fsype\n");

301 ià(*
æc_couÁ
 > 
sb
->
sv_æc_size
) {

302 
	`´štk
("sysv_count_free_blocks: free-list block with >flc_sizeƒntries\n");

303 
	`b»l£
(
bh
);

306 ià(*
æc_couÁ
 == 0) {

307 
	`b»l£
(
bh
);

310 
i
 = *
æc_couÁ
 ; ; ) {

311 
block
 = 
æc_blocks
[--
i
];

312 ià(
sb
->
sv_cÚv”t
)

313 
block
 = 
	`äom_coh_ulÚg
(block);

314 ià(
block
 == 0)

316 
couÁ
++;

317 ià(
i
 == 0)

321 
	`b»l£
(
bh
);

322 ià(
block
 == 0)

325 
dÚe
: ;

327 
Şd_couÁ
 = *
sb
->
sv_sb_tÙ®_ä“_blocks
;

328 ià(
sb
->
sv_cÚv”t
)

329 
Şd_couÁ
 = 
	`äom_coh_ulÚg
(old_count);

330 ià(
couÁ
 !ğ
Şd_couÁ
) {

331 
	`´štk
("sysv_couÁ_ä“_blocks: f»block couÁ wa %d, cÜ»ùšgØ%d\n",
Şd_couÁ
,
couÁ
);

332 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

333 *
sb
->
sv_sb_tÙ®_ä“_blocks
 = (sb->
sv_cÚv”t
 ? 
	`to_coh_ulÚg
(
couÁ
) : count);

334 
sb
->
sv_bh
->
b_dœt
 = 1;

335 
sb
->
s_dœt
 = 1;

338 
	`uÆock_su³r
(
sb
);

339  
couÁ
;

341 
couÁ
;

343 
couÁ
 = *
sb
->
sv_sb_tÙ®_ä“_blocks
;

344 ià(
sb
->
sv_cÚv”t
)

345 
couÁ
 = 
	`äom_coh_ulÚg
(count);

346  
couÁ
;

348 
	}
}

	@fs/sysv/dir.c

16 
	~<asm/£gm’t.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/fs.h
>

20 
	~<lšux/sysv_fs.h
>

21 
	~<lšux/¡©.h
>

23 
	$sysv_dœ_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

25  -
EISDIR
;

26 
	}
}

28 
sysv_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

30 
fe_İ”©iÚs
 
	gsysv_dœ_İ”©iÚs
 = {

31 
NULL
,

32 
sysv_dœ_»ad
,

33 
NULL
,

34 
sysv_»addœ
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
fe_fsync


46 
šode_İ”©iÚs
 
	gsysv_dœ_šode_İ”©iÚs
 = {

47 &
sysv_dœ_İ”©iÚs
,

48 
sysv_ü—‹
,

49 
sysv_lookup
,

50 
sysv_lšk
,

51 
sysv_uÆšk
,

52 
sysv_symlšk
,

53 
sysv_mkdœ
,

54 
sysv_rmdœ
,

55 
sysv_mknod
,

56 
sysv_»Çme
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
sysv_Œunÿ‹
,

61 
NULL


64 
	$sysv_»addœ
(
šode
 * inode, 
fe
 * 
fp
,

65 
dœ’t
 * dœ’t, 
couÁ
)

67 
su³r_block
 * 
sb
;

68 
off£t
,
i
;

69 
c
;

70 
bufãr_h—d
 * 
bh
;

71 * 
bh_d©a
;

72 
sysv_dœ_’Œy
 * 
de
;

74 ià(!
šode
 || !(
sb
 = inode->
i_sb
è|| !
	`S_ISDIR
(šode->
i_mode
))

75  -
EBADF
;

76 ià(()(
fp
->
f_pos
è% 
SYSV_DIRSIZE
)

77  -
EBADF
;

78 
fp
->
f_pos
 < 
šode
->
i_size
) {

79 
off£t
 = 
fp
->
f_pos
 & 
sb
->
sv_block_size_1
;

80 
bh
 = 
	`sysv_fe_b»ad
(
šode
, 
fp
->
f_pos
 >> 
sb
->
sv_block_size_b™s
, 0, &
bh_d©a
);

81 ià(!
bh
) {

82 
fp
->
f_pos
 +ğ
sb
->
sv_block_size
 - 
off£t
;

85 
off£t
 < 
sb
->
sv_block_size
 && 
fp
->
f_pos
 < 
šode
->
i_size
) {

86 
de
 = (
sysv_dœ_’Œy
 *è(
off£t
 + 
bh_d©a
);

87 
off£t
 +ğ
SYSV_DIRSIZE
;

88 
fp
->
f_pos
 +ğ
SYSV_DIRSIZE
;

89 ià(
de
->
šode
) {

90 
i
 = 0; i < 
SYSV_NAMELEN
; i++)

91 ià((
c
 = 
de
->
Çme
[
i
]) != 0)

92 
	`put_fs_by‹
(
c
,
i
+
dœ’t
->
d_Çme
);

95 ià(
i
) {

96 ià(
de
->
šode
 > inode->
i_sb
->
sv_nšodes
)

97 
	`´štk
("sysv_readdir: Bad inode‚umber on dev 0x%04x, ino %ld, offset 0x%04lx: %d is out of„ange\n",

98 
šode
->
i_dev
, inode->
i_šo
, 
fp
->
f_pos
 - 
SYSV_DIRSIZE
, 
de
->inode);

99 
	`put_fs_lÚg
(
de
->
šode
,&
dœ’t
->
d_šo
);

100 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

101 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

102 
	`b»l£
(
bh
);

103  
i
;

107 
	`b»l£
(
bh
);

110 
	}
}

	@fs/sysv/file.c

16 
	~<asm/£gm’t.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/fs.h
>

20 
	~<lšux/sysv_fs.h
>

21 
	~<lšux/”ºo.h
>

22 
	~<lšux/fú.h
>

23 
	~<lšux/¡©.h
>

24 
	~<lšux/¡ršg.h
>

25 
	~<lšux/locks.h
>

27 
	#NBUF
 32

	)

29 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

30 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

32 
	~<lšux/fs.h
>

33 
	~<lšux/sysv_fs.h
>

35 
sysv_fe_»ad
(
šode
 *, 
fe
 *, *, );

36 
sysv_fe_wr™e
(
šode
 *, 
fe
 *, *, );

42 
fe_İ”©iÚs
 
	gsysv_fe_İ”©iÚs
 = {

43 
NULL
,

44 
sysv_fe_»ad
,

45 
sysv_fe_wr™e
,

46 
NULL
,

47 
NULL
,

48 
NULL
,

49 
NULL
,

50 
NULL
,

51 
NULL
,

52 
sysv_sync_fe


55 
fe_İ”©iÚs
 
	gsysv_fe_İ”©iÚs_w™h_bm­
 = {

56 
NULL
,

57 
sysv_fe_»ad
,

58 
sysv_fe_wr™e
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
g’”ic_mm­
,

63 
NULL
,

64 
NULL
,

65 
sysv_sync_fe


68 
šode_İ”©iÚs
 
	gsysv_fe_šode_İ”©iÚs
 = {

69 &
sysv_fe_İ”©iÚs
,

70 
NULL
,

71 
NULL
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 
NULL
,

79 
NULL
,

80 
NULL
,

81 
NULL
,

82 
sysv_Œunÿ‹
,

83 
NULL


86 
šode_İ”©iÚs
 
	gsysv_fe_šode_İ”©iÚs_w™h_bm­
 = {

87 &
sysv_fe_İ”©iÚs_w™h_bm­
,

88 
NULL
,

89 
NULL
,

90 
NULL
,

91 
NULL
,

92 
NULL
,

93 
NULL
,

94 
NULL
,

95 
NULL
,

96 
NULL
,

97 
NULL
,

98 
NULL
,

99 
sysv_bm­
,

100 
sysv_Œunÿ‹
,

101 
NULL


104 
	ssysv_bufãr
 {

105 
bufãr_h—d
 * 
	mbh
;

106 * 
	mbh_d©a
;

109 
	$sysv_fe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

111 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

112 
»ad
,
Ëá
,
ch¬s
;

113 
block
;

114 
blocks
, 
off£t
;

115 
bh»que¡
, 
bh»qi
, 
u±od©e
;

116 
sysv_bufãr
 * 
bhb
, * 
bhe
;

117 
bufãr_h—d
 * 
bh»q
[
NBUF
];

118 
sysv_bufãr
 
buæi¡
[
NBUF
];

119 
size
;

121 ià(!
šode
) {

122 
	`´štk
("sysv_file_read: inode = NULL\n");

123  -
EINVAL
;

125 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

126 
	`´štk
("sysv_fe_»ad: modğ%07o\n",
šode
->
i_mode
);

127  -
EINVAL
;

129 
off£t
 = 
fp
->
f_pos
;

130 
size
 = 
šode
->
i_size
;

131 ià(
off£t
 > 
size
)

132 
Ëá
 = 0;

134 
Ëá
 = 
size
 - 
off£t
;

135 ià(
Ëá
 > 
couÁ
)

136 
Ëá
 = 
couÁ
;

137 ià(
Ëá
 <= 0)

139 
»ad
 = 0;

140 
block
 = 
off£t
 >> 
sb
->
sv_block_size_b™s
;

141 
off£t
 &ğ
sb
->
sv_block_size_1
;

142 
size
 = (siz+ 
sb
->
sv_block_size_1
è>> sb->
sv_block_size_b™s
;

143 
blocks
 = (
Ëá
 + 
off£t
 + 
sb
->
sv_block_size_1
è>> sb->
sv_block_size_b™s
;

144 
bhb
 = 
bhe
 = 
buæi¡
;

145 ià(
fp
->
f_»ada
) {

146 
blocks
 +ğ
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] >> (
sb
->
sv_block_size_b™s
 - 9);

147 ià(
block
 + 
blocks
 > 
size
)

148 
blocks
 = 
size
 - 
block
;

166 
bh»que¡
 = 0;

167 
u±od©e
 = 1;

168 
blocks
) {

169 --
blocks
;

170 
bhb
->
bh
 = 
	`sysv_g‘blk
(
šode
, 
block
++, 0, &bhb->
bh_d©a
);

171 ià(
bhb
->
bh
 && !bhb->bh->
b_u±od©e
) {

172 
u±od©e
 = 0;

173 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

174 
bh»qi
 = 0; bh»q˜< 
bh»que¡
; bhreqi++)

175 ià(
bh»q
[
bh»qi
] =ğ
bhb
->
bh
)

176 
nÙ»q
;

177 
bh»q
[
bh»que¡
++] = 
bhb
->
bh
;

178 
nÙ»q
: ;

181 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

182 
bhb
 = 
buæi¡
;

186 ià(
u±od©e
)

188 ià(
bhb
 =ğ
bhe
)

193 ià(
bh»que¡
)

194 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

197 ià(
bhe
->
bh
) {

198 
	`wa™_Ú_bufãr
(
bhe
->
bh
);

199 ià(!
bhe
->
bh
->
b_u±od©e
) {

200 
	`b»l£
(
bhe
->
bh
);

201 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

202 
bhe
 = 
buæi¡
;

203 
Ëá
 = 0;

207 ià(
Ëá
 < 
sb
->
sv_block_size
 - 
off£t
)

208 
ch¬s
 = 
Ëá
;

210 
ch¬s
 = 
sb
->
sv_block_size
 - 
off£t
;

211 
fp
->
f_pos
 +ğ
ch¬s
;

212 
Ëá
 -ğ
ch¬s
;

213 
»ad
 +ğ
ch¬s
;

214 ià(
bhe
->
bh
) {

215 
	`memıy_tofs
(
buf
,
off£t
+
bhe
->
bh_d©a
,
ch¬s
);

216 
	`b»l£
(
bhe
->
bh
);

217 
buf
 +ğ
ch¬s
;

219 
ch¬s
-- > 0)

220 
	`put_fs_by‹
(0,
buf
++);

222 
off£t
 = 0;

223 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

224 
bhe
 = 
buæi¡
;

225 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!bhe->
bh
 || !bhe->bh->
b_lock
));

226 } 
Ëá
 > 0);

229 
bhe
 !ğ
bhb
) {

230 
	`b»l£
(
bhe
->
bh
);

231 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

232 
bhe
 = 
buæi¡
;

234 ià(!
»ad
)

235  -
EIO
;

236 
fp
->
f_»ada
 = 1;

237 ià(!
	`IS_RDONLY
(
šode
))

238 
šode
->
i_©ime
 = 
CURRENT_TIME
;

239  
»ad
;

240 
	}
}

242 
	$sysv_fe_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

244 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

245 
off_t
 
pos
;

246 
wr™‹n
,
c
;

247 
bufãr_h—d
 * 
bh
;

248 * 
bh_d©a
;

249 * 
p
;

251 ià(!
šode
) {

252 
	`´štk
("sysv_file_write: inode = NULL\n");

253  -
EINVAL
;

255 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

256 
	`´štk
("sysv_fe_wr™e: modğ%07o\n",
šode
->
i_mode
);

257  -
EINVAL
;

266 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

267 
	`coh_lock_šode
(
šode
);

268 ià(
fp
->
f_æags
 & 
O_APPEND
)

269 
pos
 = 
šode
->
i_size
;

271 
pos
 = 
fp
->
f_pos
;

272 
wr™‹n
 = 0;

273 
wr™‹n
<
couÁ
) {

274 
bh
 = 
	`sysv_g‘blk
 (
šode
, 
pos
 >> 
sb
->
sv_block_size_b™s
, 1, &
bh_d©a
);

275 ià(!
bh
) {

276 ià(!
wr™‹n
)

277 
wr™‹n
 = -
ENOSPC
;

280 
c
 = 
sb
->
sv_block_size
 - (
pos
 & sb->
sv_block_size_1
);

281 ià(
c
 > 
couÁ
-
wr™‹n
)

282 
c
 = 
couÁ
-
wr™‹n
;

283 ià(
c
 !ğ
BLOCK_SIZE
 && !
bh
->
b_u±od©e
) {

284 
	`Î_rw_block
(
READ
, 1, &
bh
);

285 
	`wa™_Ú_bufãr
(
bh
);

286 ià(!
bh
->
b_u±od©e
) {

287 
	`b»l£
(
bh
);

288 ià(!
wr™‹n
)

289 
wr™‹n
 = -
EIO
;

294 
p
 = (
pos
 & 
sb
->
sv_block_size_1
è+ 
bh_d©a
;

295 
pos
 +ğ
c
;

296 ià(
pos
 > 
šode
->
i_size
) {

297 
šode
->
i_size
 = 
pos
;

298 
šode
->
i_dœt
 = 1;

300 
wr™‹n
 +ğ
c
;

301 
	`memıy_äomfs
(
p
,
buf
,
c
);

302 
buf
 +ğ
c
;

303 
bh
->
b_u±od©e
 = 1;

304 
bh
->
b_dœt
 = 1;

305 
	`b»l£
(
bh
);

307 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

308 
fp
->
f_pos
 = 
pos
;

309 
šode
->
i_dœt
 = 1;

310 ià(
sb
->
sv_block_size_¿tio_b™s
 > 0)

311 
	`coh_uÆock_šode
(
šode
);

312  
wr™‹n
;

313 
	}
}

	@fs/sysv/fsync.c

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/¡©.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/sysv_fs.h
>

29 
	$sync_block
 (
šode
 * inode, * 
blockp
, 
cÚv”t
, 
wa™
)

31 
bufãr_h—d
 * 
bh
;

32 
tmp
, 
block
;

33 
su³r_block
 * 
sb
;

35 
block
 = 
tmp
 = *
blockp
;

36 ià(
cÚv”t
)

37 
block
 = 
	`äom_coh_ulÚg
(block);

38 ià(!
block
)

40 
sb
 = 
šode
->
i_sb
;

41 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
, (
block
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

42 ià(!
bh
)

44 ià(*
blockp
 !ğ
tmp
) {

45 
	`b»l£
 (
bh
);

48 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_u±od©e
) {

49 
	`b»l£
(
bh
);

52 ià(
wa™
 || !
bh
->
b_u±od©e
 || !bh->
b_dœt
) {

53 
	`b»l£
(
bh
);

56 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

57 
bh
->
b_couÁ
--;

59 
	}
}

62 
	$sync_iblock
 (
šode
 * inode, * 
iblockp
, 
cÚv”t
,

63 
bufãr_h—d
 * *
bh
, * *
bh_d©a
, 
wa™
)

65 
rc
;

66 
tmp
, 
block
;

68 *
bh
 = 
NULL
;

69 
block
 = 
tmp
 = *
iblockp
;

70 ià(
cÚv”t
)

71 
block
 = 
	`äom_coh_ulÚg
(block);

72 ià(!
block
)

74 
rc
 = 
	`sync_block
 (
šode
, 
iblockp
, 
cÚv”t
, 
wa™
);

75 ià(
rc
)

76  
rc
;

77 *
bh
 = 
	`sysv_b»ad
(
šode
->
i_sb
, inode->
i_dev
, 
block
, 
bh_d©a
);

78 ià(
tmp
 !ğ*
iblockp
) {

79 
	`b»l£
(*
bh
);

80 *
bh
 = 
NULL
;

83 ià(!*
bh
)

86 
	}
}

89 
	$sync_dœeù
(
šode
 *šode, 
wa™
)

91 
i
;

92 
rc
, 
”r
 = 0;

94 
i
 = 0; i < 10; i++) {

95 
rc
 = 
	`sync_block
 (
šode
, inode->
u
.
sysv_i
.
i_d©a
 + 
i
, 0, 
wa™
);

96 ià(
rc
 > 0)

98 ià(
rc
)

99 
”r
 = 
rc
;

101  
”r
;

102 
	}
}

104 
	$sync_šdœeù
(
šode
 *šode, *
iblockp
, 
cÚv”t
, 
wa™
)

106 
i
;

107 
bufãr_h—d
 * 
šd_bh
;

108 * 
šd_bh_d©a
;

109 
rc
, 
”r
 = 0;

110 
su³r_block
 * 
sb
;

112 
rc
 = 
	`sync_iblock
 (
šode
, 
iblockp
, 
cÚv”t
, &
šd_bh
, &
šd_bh_d©a
, 
wa™
);

113 ià(
rc
 || !
šd_bh
)

114  
rc
;

116 
sb
 = 
šode
->
i_sb
;

117 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++) {

118 
rc
 = 
	`sync_block
 (
šode
,

119 ((*è
šd_bh_d©a
è+ 
i
, 
sb
->
sv_cÚv”t
,

120 
wa™
);

121 ià(
rc
 > 0)

123 ià(
rc
)

124 
”r
 = 
rc
;

126 
	`b»l£
(
šd_bh
);

127  
”r
;

128 
	}
}

130 
	$sync_dšdœeù
(
šode
 *šode, *
diblockp
, 
cÚv”t
,

131 
wa™
)

133 
i
;

134 
bufãr_h—d
 * 
dšd_bh
;

135 * 
dšd_bh_d©a
;

136 
rc
, 
”r
 = 0;

137 
su³r_block
 * 
sb
;

139 
rc
 = 
	`sync_iblock
 (
šode
, 
diblockp
, 
cÚv”t
, &
dšd_bh
, &
dšd_bh_d©a
, 
wa™
);

140 ià(
rc
 || !
dšd_bh
)

141  
rc
;

143 
sb
 = 
šode
->
i_sb
;

144 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++) {

145 
rc
 = 
	`sync_šdœeù
 (
šode
,

146 ((*è
dšd_bh_d©a
è+ 
i
, 
sb
->
sv_cÚv”t
,

147 
wa™
);

148 ià(
rc
 > 0)

150 ià(
rc
)

151 
”r
 = 
rc
;

153 
	`b»l£
(
dšd_bh
);

154  
”r
;

155 
	}
}

157 
	$sync_tšdœeù
(
šode
 *šode, *
tiblockp
, 
cÚv”t
,

158 
wa™
)

160 
i
;

161 
bufãr_h—d
 * 
tšd_bh
;

162 * 
tšd_bh_d©a
;

163 
rc
, 
”r
 = 0;

164 
su³r_block
 * 
sb
;

166 
rc
 = 
	`sync_iblock
 (
šode
, 
tiblockp
, 
cÚv”t
, &
tšd_bh
, &
tšd_bh_d©a
, 
wa™
);

167 ià(
rc
 || !
tšd_bh
)

168  
rc
;

170 
sb
 = 
šode
->
i_sb
;

171 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++) {

172 
rc
 = 
	`sync_dšdœeù
 (
šode
,

173 ((*è
tšd_bh_d©a
è+ 
i
, 
sb
->
sv_cÚv”t
,

174 
wa™
);

175 ià(
rc
 > 0)

177 ià(
rc
)

178 
”r
 = 
rc
;

180 
	`b»l£
(
tšd_bh
);

181  
”r
;

182 
	}
}

184 
	$sysv_sync_fe
(
šode
 * inode, 
fe
 * file)

186 
wa™
, 
”r
 = 0;

188 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

189 
	`S_ISLNK
(
šode
->
i_mode
)))

190  -
EINVAL
;

192 
wa™
=0; wait<=1; wait++) {

193 
”r
 |ğ
	`sync_dœeù
(
šode
, 
wa™
);

194 
”r
 |ğ
	`sync_šdœeù
(
šode
, inode->
u
.
sysv_i
.
i_d©a
+10, 0, 
wa™
);

195 
”r
 |ğ
	`sync_dšdœeù
(
šode
, inode->
u
.
sysv_i
.
i_d©a
+11, 0, 
wa™
);

196 
”r
 |ğ
	`sync_tšdœeù
(
šode
, inode->
u
.
sysv_i
.
i_d©a
+12, 0, 
wa™
);

198 
”r
 |ğ
	`sysv_sync_šode
 (
šode
);

199  (
”r
 < 0è? -
EIO
 : 0;

200 
	}
}

	@fs/sysv/ialloc.c

22 
	~<lšux/sched.h
>

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/sysv_fs.h
>

26 
	~<lšux/¡©.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/locks.h
>

36 
	$sysv_ä“_šode
(
šode
 * inode)

38 
su³r_block
 * 
sb
;

39 
šo
;

40 
bufãr_h—d
 * 
bh
;

41 * 
bh_d©a
;

42 
sysv_šode
 * 
¿w_šode
;

44 ià(!
šode
)

46 ià(!
šode
->
i_dev
) {

47 
	`´štk
("sysv_free_inode: inode has‚o device\n");

50 ià(
šode
->
i_couÁ
 != 1) {

51 
	`´štk
("sysv_ä“_šode: inodha couÁ=%d\n", 
šode
->
i_couÁ
);

54 ià(
šode
->
i_Æšk
) {

55 
	`´štk
("sysv_ä“_šode: inodha Æšk=%d\n", 
šode
->
i_Æšk
);

58 ià(!(
sb
 = 
šode
->
i_sb
)) {

59 
	`´štk
("sysv_free_inode: inode on‚onexistent device\n");

62 
šo
 = 
šode
->
i_šo
;

63 ià(
šo
 <ğ
SYSV_ROOT_INO
 || inØ> 
sb
->
sv_nšodes
) {

64 
	`´štk
("sysv_free_inode: inode 0,1,2 or‚onexistent inode\n");

67 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
, 
šode
->
i_dev
, sb->
sv_fœ¡šodezÚe
 + ((
šo
-1è>> sb->
sv_šodes_³r_block_b™s
), &
bh_d©a
))) {

68 
	`´štk
("sysv_ä“_šode: uÇbËØ»ad inodblock oÀdeviû %d/%d\n",
	`MAJOR
(
šode
->
i_dev
),
	`MINOR
(inode->i_dev));

69 
	`ş—r_šode
(
šode
);

72 
¿w_šode
 = (
sysv_šode
 *è
bh_d©a
 + ((
šo
-1è& 
sb
->
sv_šodes_³r_block_1
);

73 
	`lock_su³r
(
sb
);

74 ià(*
sb
->
sv_sb_fic_couÁ
 < sb->
sv_fic_size
)

75 
sb
->
sv_sb_fic_šodes
[(*sb->
sv_sb_fic_couÁ
)++] = 
šo
;

76 (*
sb
->
sv_sb_tÙ®_ä“_šodes
)++;

77 
sb
->
sv_bh
->
b_dœt
 = 1;

78 
sb
->
s_dœt
 = 1;

79 
	`mem£t
(
¿w_šode
, 0, (
sysv_šode
));

80 
bh
->
b_dœt
 = 1;

81 
	`uÆock_su³r
(
sb
);

82 
	`b»l£
(
bh
);

83 
	`ş—r_šode
(
šode
);

84 
	}
}

86 
šode
 * 
	$sysv_Ãw_šode
(cÚ¡ 
šode
 * 
dœ
)

88 
šode
 * inode;

89 
su³r_block
 * 
sb
;

90 
bufãr_h—d
 * 
bh
;

91 * 
bh_d©a
;

92 
sysv_šode
 * 
¿w_šode
;

93 
i
,
j
,
šo
,
block
;

95 ià(!
dœ
 || !(
šode
 = 
	`g‘_em±y_šode
()))

96  
NULL
;

97 
sb
 = 
dœ
->
i_sb
;

98 
šode
->
i_sb
 = 
sb
;

99 
šode
->
i_æags
 = inode->
i_sb
->
s_æags
;

100 
	`lock_su³r
(
sb
);

101 ià((*
sb
->
sv_sb_fic_couÁ
 == 0)

102 || (
sb
->
sv_sb_fic_šodes
[(*sb->
sv_sb_fic_couÁ
)-1] == 0)

111 
i
 = 0, 
šo
 = 
SYSV_ROOT_INO
+1, 
block
 = 
sb
->
sv_fœ¡šodezÚe
, 
j
 = SYSV_ROOT_INO ; i < sb->
sv_fic_size
 && block < sb->
sv_fœ¡d©azÚe
 ; block++, j = 0) {

112 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
, sb->
s_dev
, 
block
, &
bh_d©a
))) {

113 
	`´štk
("sysv_new_inode: unableo„ead inodeable\n");

117 
¿w_šode
 = (
sysv_šode
 *è
bh_d©a
 + 
j
;

118 ; 
j
 < 
sb
->
sv_šodes_³r_block
 && 
i
 < sb->
sv_fic_size
; 
šo
++, j++, 
¿w_šode
++) {

119 ià(
¿w_šode
->
i_mode
 =ğ0 &&„aw_šode->
i_Æšk
 == 0)

120 
sb
->
sv_sb_fic_šodes
[
i
++] = 
šo
;

122 
	`b»l£
(
bh
);

124 ià(
i
 == 0) {

125 
	`ut
(
šode
);

126 
	`uÆock_su³r
(
sb
);

127  
NULL
;

129 *
sb
->
sv_sb_fic_couÁ
 = 
i
;

132 
šo
 = 
sb
->
sv_sb_fic_šodes
[--(*sb->
sv_sb_fic_couÁ
)];

133 
sb
->
sv_bh
->
b_dœt
 = 1;

134 
sb
->
s_dœt
 = 1;

135 
šode
->
i_couÁ
 = 1;

136 
šode
->
i_Æšk
 = 1;

137 
šode
->
i_dev
 = 
sb
->
s_dev
;

138 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

139 
šode
->
i_gid
 = (
dœ
->
i_mode
 & 
S_ISGID
è? dœ->i_gid : 
cu¼’t
->
egid
;

140 
šode
->
i_dœt
 = 1;

141 
šode
->
i_šo
 = 
šo
;

142 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

143 
šode
->
i_İ
 = 
NULL
;

144 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

145 
šode
->
u
.
sysv_i
.
i_lock
 = 0; inode->u.sysv_i.
i_wa™
 = 
NULL
;

146 
	`š£¹_šode_hash
(
šode
);

148 
šode
->
i_mode
 = 0;

149 
šode
->
i_size
 = 0;

150 
	`sysv_wr™e_šode
(
šode
);

152 
šode
->
i_dœt
 = 1;

154 (*
sb
->
sv_sb_tÙ®_ä“_šodes
)--;

155 
sb
->
sv_bh
->
b_dœt
 = 1;

156 
sb
->
s_dœt
 = 1;

157 
	`uÆock_su³r
(
sb
);

158  
šode
;

159 
	}
}

161 
	$sysv_couÁ_ä“_šodes
(
su³r_block
 * 
sb
)

164 
bufãr_h—d
 * 
bh
;

165 * 
bh_d©a
;

166 
sysv_šode
 * 
¿w_šode
;

167 
j
,
block
,
couÁ
;

170 
couÁ
 = 0;

171 
	`lock_su³r
(
sb
);

178 
block
 = 
sb
->
sv_fœ¡šodezÚe
, 
j
 = 
SYSV_ROOT_INO
 ; block < sb->
sv_fœ¡d©azÚe
 ; block++, j = 0) {

179 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
, sb->
s_dev
, 
block
, &
bh_d©a
))) {

180 
	`´štk
("sysv_count_free_inodes: unableo„ead inodeable\n");

184 
¿w_šode
 = (
sysv_šode
 *è
bh_d©a
 + 
j
;

185 ; 
j
 < 
sb
->
sv_šodes_³r_block
 ; j++, 
¿w_šode
++)

186 ià(
¿w_šode
->
i_mode
 =ğ0 &&„aw_šode->
i_Æšk
 == 0)

187 
couÁ
++;

188 
	`b»l£
(
bh
);

190 ià(
couÁ
 !ğ*
sb
->
sv_sb_tÙ®_ä“_šodes
) {

191 
	`´štk
("sysv_couÁ_ä“_šodes: f»šodcouÁ wa %d, cÜ»ùšgØ%d\n",()(*
sb
->
sv_sb_tÙ®_ä“_šodes
),
couÁ
);

192 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

193 *
sb
->
sv_sb_tÙ®_ä“_šodes
 = 
couÁ
;

194 
sb
->
sv_bh
->
b_dœt
 = 1;

195 
sb
->
s_dœt
 = 1;

198 
	`uÆock_su³r
(
sb
);

199  
couÁ
;

201  *
sb
->
sv_sb_tÙ®_ä“_šodes
;

203 
	}
}

	@fs/sysv/inode.c

23 
	~<lšux/sched.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~<lšux/fs.h
>

26 
	~<lšux/sysv_fs.h
>

27 
	~<lšux/¡©.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/locks.h
>

31 
	~<asm/£gm’t.h
>

33 
	$_coh_wa™_Ú_šode
 (
šode
 * inode)

35 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

37 
	`add_wa™_queue
(&
šode
->
u
.
sysv_i
.
i_wa™
, &
wa™
);

38 
»³©
:

39 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

40 ià(
šode
->
u
.
sysv_i
.
i_lock
) {

41 
	`scheduË
();

42 
»³©
;

44 
	`»move_wa™_queue
(&
šode
->
u
.
sysv_i
.
i_wa™
, &
wa™
);

45 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

46 
	}
}

48 
	$sysv_put_šode
(
šode
 *inode)

50 ià(
šode
->
i_Æšk
)

52 
šode
->
i_size
 = 0;

53 
	`sysv_Œunÿ‹
(
šode
);

54 
	`sysv_ä“_šode
(
šode
);

55 
	}
}

58 
su³r_İ”©iÚs
 
	gsysv_sİs
 = {

59 
sysv_»ad_šode
,

60 
sysv_nÙify_chªge
,

61 
sysv_wr™e_šode
,

62 
sysv_put_šode
,

63 
sysv_put_su³r
,

64 
sysv_wr™e_su³r
,

65 
sysv_¡©fs
,

66 
NULL


78 
	$d‘eùed_bs512
 (
su³r_block
 *
sb
)

80 
sb
->
sv_block_size
 = 512;

81 
sb
->
sv_block_size_1
 = 512-1;

82 
sb
->
sv_block_size_b™s
 = 9;

83 
sb
->
sv_block_size_¿tio
 = 2;

84 
sb
->
sv_block_size_¿tio_1
 = 2-1;

85 
sb
->
sv_block_size_¿tio_b™s
 = 1;

86 
sb
->
sv_šodes_³r_block
 = 512/64;

87 
sb
->
sv_šodes_³r_block_1
 = 512/64-1;

88 
sb
->
sv_šodes_³r_block_b™s
 = 9-6;

89 
sb
->
sv_toobig_block
 = 10 +

90 (
sb
->
sv_šd_³r_block
 = 512/4) +

91 (
sb
->
sv_šd_³r_block_2
 = (512/4)*(512/4)) +

92 (
sb
->
sv_šd_³r_block_3
 = (512/4)*(512/4)*(512/4));

93 
sb
->
sv_šd_³r_block_1
 = 512/4-1;

94 
sb
->
sv_šd_³r_block_2_1
 = (512/4)*(512/4)-1;

95 
sb
->
sv_šd_³r_block_2_b™s
 = 2 *

96 (
sb
->
sv_šd_³r_block_b™s
 = 9-2);

97 
	}
}

99 
	$d‘eùed_bs1024
 (
su³r_block
 *
sb
)

101 
sb
->
sv_block_size
 = 1024;

102 
sb
->
sv_block_size_1
 = 1024-1;

103 
sb
->
sv_block_size_b™s
 = 10;

104 
sb
->
sv_block_size_¿tio
 = 1;

105 
sb
->
sv_block_size_¿tio_1
 = 1-1;

106 
sb
->
sv_block_size_¿tio_b™s
 = 0;

107 
sb
->
sv_šodes_³r_block
 = 1024/64;

108 
sb
->
sv_šodes_³r_block_1
 = 1024/64-1;

109 
sb
->
sv_šodes_³r_block_b™s
 = 10-6;

110 
sb
->
sv_toobig_block
 = 10 +

111 (
sb
->
sv_šd_³r_block
 = 1024/4) +

112 (
sb
->
sv_šd_³r_block_2
 = (1024/4)*(1024/4)) +

113 (
sb
->
sv_šd_³r_block_3
 = (1024/4)*(1024/4)*(1024/4));

114 
sb
->
sv_šd_³r_block_1
 = 1024/4-1;

115 
sb
->
sv_šd_³r_block_2_1
 = (1024/4)*(1024/4)-1;

116 
sb
->
sv_šd_³r_block_2_b™s
 = 2 *

117 (
sb
->
sv_šd_³r_block_b™s
 = 10-2);

118 
	}
}

120 cÚ¡ * 
	$d‘eù_x’ix
 (
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

122 
x’ix_su³r_block
 * 
sbd
;

124 
sbd
 = (
x’ix_su³r_block
 *è
bh
->
b_d©a
;

125 ià(
sbd
->
s_magic
 != 0x2b5544)

126  
NULL
;

127 
sb
->
sv_ty³
 = 
FSTYPE_XENIX
;

128 
sb
->
sv_cÚv”t
 = 0;

129 
sb
->
sv_kludge_symlšks
 = 1;

130 
sb
->
sv_Œunÿ‹
 = 1;

131 
sb
->
sv_lšk_max
 = 
XENIX_LINK_MAX
;

132 
sb
->
sv_fic_size
 = 
XENIX_NICINOD
;

133 
sb
->
sv_æc_size
 = 
XENIX_NICFREE
;

134 
sb
->
sv_bh
 = 
bh
;

135 
sb
->
sv_sbd
 = (*è
sbd
;

136 
sb
->
sv_sb_fic_couÁ
 = &
sbd
->
s_nšode
;

137 
sb
->
sv_sb_fic_šodes
 = &
sbd
->
s_šode
[0];

138 
sb
->
sv_sb_tÙ®_ä“_šodes
 = &
sbd
->
s_tšode
;

139 
sb
->
sv_sb_æc_couÁ
 = &
sbd
->
s_nä“
;

140 
sb
->
sv_sb_æc_blocks
 = &
sbd
->
s_ä“
[0];

141 
sb
->
sv_sb_tÙ®_ä“_blocks
 = &
sbd
->
s_tä“
;

142 
sb
->
sv_sb_time
 = &
sbd
->
s_time
;

143 
sb
->
sv_block_ba£
 = 0;

144 
sb
->
sv_fœ¡šodezÚe
 = 2;

145 
sb
->
sv_fœ¡d©azÚe
 = 
sbd
->
s_isize
;

146 
sb
->
sv_nzÚes
 = 
sbd
->
s_fsize
;

147 
sb
->
sv_nd©azÚes
 = sb->
sv_nzÚes
 - sb->
sv_fœ¡d©azÚe
;

148 
sbd
->
s_ty³
) {

149 1: 
	`d‘eùed_bs512
(
sb
); ;

150 2: 
	`d‘eùed_bs1024
(
sb
); ;

151 :  
NULL
;

154 
	}
}

156 cÚ¡ * 
	$d‘eù_sysv4
 (
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

158 
sysv4_su³r_block
 * 
sbd
;

160 
sbd
 = (
sysv4_su³r_block
 *è(
bh
->
b_d©a
 + 
BLOCK_SIZE
/2);

161 ià(
sbd
->
s_magic
 != 0xfd187e20)

162  
NULL
;

163 ià(
sbd
->
s_time
 < 315532800)

164  
NULL
;

165 
sb
->
sv_ty³
 = 
FSTYPE_SYSV4
;

166 
sb
->
sv_cÚv”t
 = 0;

167 
sb
->
sv_kludge_symlšks
 = 0;

168 
sb
->
sv_Œunÿ‹
 = 1;

169 
sb
->
sv_lšk_max
 = 
SYSV_LINK_MAX
;

170 
sb
->
sv_fic_size
 = 
SYSV_NICINOD
;

171 
sb
->
sv_æc_size
 = 
SYSV_NICFREE
;

172 
sb
->
sv_bh
 = 
bh
;

173 
sb
->
sv_sbd
 = (*è
sbd
;

174 
sb
->
sv_sb_fic_couÁ
 = &
sbd
->
s_nšode
;

175 
sb
->
sv_sb_fic_šodes
 = &
sbd
->
s_šode
[0];

176 
sb
->
sv_sb_tÙ®_ä“_šodes
 = &
sbd
->
s_tšode
;

177 
sb
->
sv_sb_æc_couÁ
 = &
sbd
->
s_nä“
;

178 
sb
->
sv_sb_æc_blocks
 = &
sbd
->
s_ä“
[0];

179 
sb
->
sv_sb_tÙ®_ä“_blocks
 = &
sbd
->
s_tä“
;

180 
sb
->
sv_sb_time
 = &
sbd
->
s_time
;

181 
sb
->
sv_block_ba£
 = 0;

182 
sb
->
sv_fœ¡šodezÚe
 = 2;

183 
sb
->
sv_fœ¡d©azÚe
 = 
sbd
->
s_isize
;

184 
sb
->
sv_nzÚes
 = 
sbd
->
s_fsize
;

185 
sb
->
sv_nd©azÚes
 = sb->
sv_nzÚes
 - sb->
sv_fœ¡d©azÚe
;

186 
sbd
->
s_ty³
) {

187 1: 
	`d‘eùed_bs512
(
sb
); ;

188 2: 
	`d‘eùed_bs1024
(
sb
); ;

189 :  
NULL
;

192 
	}
}

194 cÚ¡ * 
	$d‘eù_sysv2
 (
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

196 
sysv2_su³r_block
 * 
sbd
;

198 
sbd
 = (
sysv2_su³r_block
 *è(
bh
->
b_d©a
 + 
BLOCK_SIZE
/2);

199 ià(
sbd
->
s_magic
 != 0xfd187e20)

200  
NULL
;

201 ià(
sbd
->
s_time
 < 315532800)

202  
NULL
;

203 
sb
->
sv_ty³
 = 
FSTYPE_SYSV2
;

204 
sb
->
sv_cÚv”t
 = 0;

205 
sb
->
sv_kludge_symlšks
 = 0;

206 
sb
->
sv_Œunÿ‹
 = 1;

207 
sb
->
sv_lšk_max
 = 
SYSV_LINK_MAX
;

208 
sb
->
sv_fic_size
 = 
SYSV_NICINOD
;

209 
sb
->
sv_æc_size
 = 
SYSV_NICFREE
;

210 
sb
->
sv_bh
 = 
bh
;

211 
sb
->
sv_sbd
 = (*è
sbd
;

212 
sb
->
sv_sb_fic_couÁ
 = &
sbd
->
s_nšode
;

213 
sb
->
sv_sb_fic_šodes
 = &
sbd
->
s_šode
[0];

214 
sb
->
sv_sb_tÙ®_ä“_šodes
 = &
sbd
->
s_tšode
;

215 
sb
->
sv_sb_æc_couÁ
 = &
sbd
->
s_nä“
;

216 
sb
->
sv_sb_æc_blocks
 = &
sbd
->
s_ä“
[0];

217 
sb
->
sv_sb_tÙ®_ä“_blocks
 = &
sbd
->
s_tä“
;

218 
sb
->
sv_sb_time
 = &
sbd
->
s_time
;

219 
sb
->
sv_block_ba£
 = 0;

220 
sb
->
sv_fœ¡šodezÚe
 = 2;

221 
sb
->
sv_fœ¡d©azÚe
 = 
sbd
->
s_isize
;

222 
sb
->
sv_nzÚes
 = 
sbd
->
s_fsize
;

223 
sb
->
sv_nd©azÚes
 = sb->
sv_nzÚes
 - sb->
sv_fœ¡d©azÚe
;

224 
sbd
->
s_ty³
) {

225 1: 
	`d‘eùed_bs512
(
sb
); ;

226 2: 
	`d‘eùed_bs1024
(
sb
); ;

227 :  
NULL
;

230 
	}
}

232 cÚ¡ * 
	$d‘eù_coh”’t
 (
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

234 
coh_su³r_block
 * 
sbd
;

236 
sbd
 = (
coh_su³r_block
 *è(
bh
->
b_d©a
 + 
BLOCK_SIZE
/2);

237 ià((
	`memcmp
(
sbd
->
s_âame
,"noname",6) && memcmp(sbd->s_fname,"xxxxx ",6))

238 || (
	`memcmp
(
sbd
->
s_åack
,"nopack",6) && memcmp(sbd->s_fpack,"xxxxx\n",6)))

239  
NULL
;

240 
sb
->
sv_ty³
 = 
FSTYPE_COH
;

241 
sb
->
sv_cÚv”t
 = 1;

242 
sb
->
sv_kludge_symlšks
 = 1;

243 
sb
->
sv_Œunÿ‹
 = 1;

244 
sb
->
sv_lšk_max
 = 
COH_LINK_MAX
;

245 
sb
->
sv_fic_size
 = 
COH_NICINOD
;

246 
sb
->
sv_æc_size
 = 
COH_NICFREE
;

247 
sb
->
sv_bh
 = 
bh
;

248 
sb
->
sv_sbd
 = (*è
sbd
;

249 
sb
->
sv_sb_fic_couÁ
 = &
sbd
->
s_nšode
;

250 
sb
->
sv_sb_fic_šodes
 = &
sbd
->
s_šode
[0];

251 
sb
->
sv_sb_tÙ®_ä“_šodes
 = &
sbd
->
s_tšode
;

252 
sb
->
sv_sb_æc_couÁ
 = &
sbd
->
s_nä“
;

253 
sb
->
sv_sb_æc_blocks
 = &
sbd
->
s_ä“
[0];

254 
sb
->
sv_sb_tÙ®_ä“_blocks
 = &
sbd
->
s_tä“
;

255 
sb
->
sv_sb_time
 = &
sbd
->
s_time
;

256 
sb
->
sv_block_ba£
 = 0;

257 
sb
->
sv_fœ¡šodezÚe
 = 2;

258 
sb
->
sv_fœ¡d©azÚe
 = 
sbd
->
s_isize
;

259 
sb
->
sv_nzÚes
 = 
	`äom_coh_ulÚg
(
sbd
->
s_fsize
);

260 
sb
->
sv_nd©azÚes
 = sb->
sv_nzÚes
 - sb->
sv_fœ¡d©azÚe
;

261 
	`d‘eùed_bs512
(
sb
);

263 
	}
}

265 
su³r_block
 *
	$sysv_»ad_su³r
(
su³r_block
 *
sb
,*
d©a
,

266 
s’t
)

268 
bufãr_h—d
 *
bh
;

269 cÚ¡ *
found
;

270 
dev
 = 
sb
->
s_dev
;

272 ià(1024 !ğ (
x’ix_su³r_block
))

273 
	`·nic
("Xenix FS: bad super-block size");

274 ià((512 !ğ (
sysv4_su³r_block
))

275 || (512 !ğ (
sysv2_su³r_block
)))

276 
	`·nic
("SystemV FS: bad super-block size");

277 ià(500 !ğ (
coh_su³r_block
))

278 
	`·nic
("Coherent FS: bad super-block size");

279 ià(64 !ğ (
sysv_šode
))

280 
	`·nic
("sysv fs: bad i-node size");

281 
	`lock_su³r
(
sb
);

282 
sb
->
s_blocksize
 = 
BLOCK_SIZE
;

283 
sb
->
s_blocksize_b™s
 = 
BLOCK_SIZE_BITS
;

286 ià((
bh
 = 
	`b»ad
(
dev
, 1, 
BLOCK_SIZE
)è!ğ
NULL
) {

287 ià((
found
 = 
	`d‘eù_x’ix
(
sb
,
bh
)è!ğ
NULL
)

288 
ok
;

289 
	`b»l£
(
bh
);

291 ià((
bh
 = 
	`b»ad
(
dev
, 0, 
BLOCK_SIZE
)è!ğ
NULL
) {

293 ià((
found
 = 
	`d‘eù_sysv4
(
sb
,
bh
)è!ğ
NULL
)

294 
ok
;

295 ià((
found
 = 
	`d‘eù_sysv2
(
sb
,
bh
)è!ğ
NULL
)

296 
ok
;

298 ià((
found
 = 
	`d‘eù_coh”’t
(
sb
,
bh
)è!ğ
NULL
)

299 
ok
;

300 
	`b»l£
(
bh
);

304 { 
off£ts
[] = { 9, 15, 18, };

305 
i
;

306 
i
 = 0; i < (
off£ts
)/(offsets[0]); i++)

307 ià((
bh
 = 
	`b»ad
(
dev
, 
off£ts
[
i
], 
BLOCK_SIZE
)è!ğ
NULL
) {

309 ià((
found
 = 
	`d‘eù_sysv2
(
sb
,
bh
)è!ğ
NULL
) {

310 
sb
->
sv_block_ba£
 = 
off£ts
[
i
];

311 
ok
;

313 
	`b»l£
(
bh
);

316 
sb
->
s_dev
=0;

317 
	`uÆock_su³r
(
sb
);

318 ià(!
s’t
)

319 
	`´štk
("VFS: uÇbËØ»ad X’ix/Sy¡emV/Coh”’ˆsu³rblock oÀdeviû %d/%d\n",
	`MAJOR
(
dev
),
	`MINOR
(dev));

320  
NULL
;

322 
ok
:

323 
sb
->
sv_nšodes
 = (sb->
sv_fœ¡d©azÚe
 - sb->
sv_fœ¡šodezÚe
è<< sb->
sv_šodes_³r_block_b™s
;

324 ià(!
s’t
)

325 
	`´štk
("VFS: Found‡ % FS (block sizğ%dèÚ deviû %d/%d\n",
found
,
sb
->
sv_block_size
,
	`MAJOR
(
dev
),
	`MINOR
(dev));

326 
sb
->
s_magic
 = 
SYSV_MAGIC_BASE
 + sb->
sv_ty³
;

328 
sb
->
s_dev
 = 
dev
;

329 
sb
->
s_İ
 = &
sysv_sİs
;

330 
sb
->
s_mouÁed
 = 
	`ig‘
(sb,
SYSV_ROOT_INO
);

331 
	`uÆock_su³r
(
sb
);

332 ià(!
sb
->
s_mouÁed
) {

333 
	`b»l£
(
bh
);

334 
sb
->
s_dev
 = 0;

335 
	`´štk
("SysV FS: get„oot inode failed\n");

336  
NULL
;

338 
sb
->
s_dœt
 = 1;

339  
sb
;

340 
	}
}

343 
	$sysv_wr™e_su³r
 (
su³r_block
 *
sb
)

345 
	`lock_su³r
(
sb
);

346 ià(
sb
->
sv_bh
->
b_dœt
) {

349 
time
 = 
CURRENT_TIME
;

350 ià(
sb
->
sv_cÚv”t
)

351 
time
 = 
	`to_coh_ulÚg
(time);

352 *
sb
->
sv_sb_time
 = 
time
;

354 
sb
->
s_dœt
 = 0;

355 
	`uÆock_su³r
(
sb
);

356 
	}
}

358 
	$sysv_put_su³r
(
su³r_block
 *
sb
)

361 
	`lock_su³r
(
sb
);

362 
	`b»l£
(
sb
->
sv_bh
);

363 
sb
->
s_dev
 = 0;

364 
	`uÆock_su³r
(
sb
);

365 
	}
}

367 
	$sysv_¡©fs
(
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

369 
tmp
;

371 
	`put_fs_lÚg
(
sb
->
s_magic
, &
buf
->
f_ty³
);

372 
	`put_fs_lÚg
(
sb
->
sv_block_size
, &
buf
->
f_bsize
);

373 
	`put_fs_lÚg
(
sb
->
sv_nd©azÚes
, &
buf
->
f_blocks
);

374 
tmp
 = 
	`sysv_couÁ_ä“_blocks
(
sb
);

375 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bä“
);

376 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bava
);

377 
	`put_fs_lÚg
(
sb
->
sv_nšodes
, &
buf
->
f_fes
);

378 
	`put_fs_lÚg
(
	`sysv_couÁ_ä“_šodes
(
sb
), &
buf
->
f_fä“
);

379 
	`put_fs_lÚg
(
SYSV_NAMELEN
, &
buf
->
f_Çm–’
);

381 
	}
}

387 
	#IND_PER_BLOCK
 (
BLOCK_SIZE
 / (
sysv_zÚe_t
))

	)

389 
šlše
 
	$šode_bm­
(
su³r_block
 * 
sb
, 
šode
 * inode, 
Ä
)

391 
tmp
 = 
šode
->
u
.
sysv_i
.
i_d©a
[
Ä
];

392 ià(!
tmp
)

394  
tmp
 + 
sb
->
sv_block_ba£
;

395 
	}
}

397 
	$block_bm­
(
su³r_block
 * 
sb
, 
bufãr_h—d
 * 
bh
, 
Ä
, 
cÚv”t
)

399 
tmp
;

401 ià(!
bh
)

403 
tmp
 = ((
sysv_zÚe_t
 *è
bh
->
b_d©a
è[
Ä
];

404 ià(
cÚv”t
)

405 
tmp
 = 
	`äom_coh_ulÚg
(tmp);

406 
	`b»l£
(
bh
);

407 ià(!
tmp
)

409  
tmp
 + 
sb
->
sv_block_ba£
;

410 
	}
}

412 
	$sysv_bm­
(
šode
 * inode,
block_Ä
)

414 
block
 = 
block_Ä
;

415 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

416 
cÚv”t
;

417 
i
;

418 
bufãr_h—d
 * 
bh
;

420 ià(
block
 < 10)

421  
	`šode_bm­
(
sb
,
šode
,
block
);

422 
block
 -= 10;

423 
cÚv”t
 = 
sb
->
sv_cÚv”t
;

424 ià(
block
 < 
IND_PER_BLOCK
) {

425 
i
 = 
	`šode_bm­
(
sb
,
šode
,10);

426 ià(!
i
)

428 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

429  
	`block_bm­
(
sb
,
bh
,
block
,
cÚv”t
);

431 
block
 -ğ
IND_PER_BLOCK
;

432 ià(
block
 < 
IND_PER_BLOCK
*IND_PER_BLOCK) {

433 
i
 = 
	`šode_bm­
(
sb
,
šode
,11);

434 ià(!
i
)

436 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

437 
i
 = 
	`block_bm­
(
sb
,
bh
,
block
/
IND_PER_BLOCK
,
cÚv”t
);

438 ià(!
i
)

440 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

441  
	`block_bm­
(
sb
,
bh
,
block
%
IND_PER_BLOCK
,
cÚv”t
);

443 
block
 -ğ
IND_PER_BLOCK
*IND_PER_BLOCK;

444 ià(
block
 < 
IND_PER_BLOCK
*IND_PER_BLOCK*IND_PER_BLOCK) {

445 
i
 = 
	`šode_bm­
(
sb
,
šode
,12);

446 ià(!
i
)

448 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

449 
i
 = 
	`block_bm­
(
sb
,
bh
,
block
/(
IND_PER_BLOCK
*IND_PER_BLOCK),
cÚv”t
);

450 ià(!
i
)

452 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

453 
i
 = 
	`block_bm­
(
sb
,
bh
,(
block
/
IND_PER_BLOCK
)%IND_PER_BLOCK,
cÚv”t
);

454 ià(!
i
)

456 
bh
 = 
	`b»ad
(
šode
->
i_dev
,
i
,
BLOCK_SIZE
);

457  
	`block_bm­
(
sb
,
bh
,
block
%
IND_PER_BLOCK
,
cÚv”t
);

459 ià(()
block
<0) {

460 
	`´štk
("sysv_bmap: block<0");

463 
	`´štk
("sysv_bmap: block>big");

465 
	}
}

472 
bufãr_h—d
 * 
	$šode_g‘blk
(
šode
 * inode, 
Ä
, 
ü—‹
, * *
¡¬t
)

474 
su³r_block
 *
sb
;

475 
tmp
;

476 *
p
;

477 
bufãr_h—d
 * 
»suÉ
;

479 
sb
 = 
šode
->
i_sb
;

480 
p
 = 
šode
->
u
.
sysv_i
.
i_d©a
 + 
Ä
;

481 
»³©
:

482 
tmp
 = *
p
;

483 ià(
tmp
) {

484 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, (
tmp
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

485 ià(
tmp
 =ğ*
p
) {

486 *
¡¬t
 = 
»suÉ
->
b_d©a
 + ((
tmp
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

487  
»suÉ
;

489 
	`b»l£
(
»suÉ
);

490 
»³©
;

492 ià(!
ü—‹
)

493  
NULL
;

494 
tmp
 = 
	`sysv_Ãw_block
(
sb
);

495 ià(!
tmp
)

496  
NULL
;

497 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, (
tmp
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

498 ià(*
p
) {

499 
	`sysv_ä“_block
(
sb
,
tmp
);

500 
	`b»l£
(
»suÉ
);

501 
»³©
;

503 *
p
 = 
tmp
;

504 
šode
->
i_ùime
 = 
CURRENT_TIME
;

505 
šode
->
i_dœt
 = 1;

506 *
¡¬t
 = 
»suÉ
->
b_d©a
 + ((
tmp
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

507  
»suÉ
;

508 
	}
}

510 
bufãr_h—d
 * 
	$block_g‘blk
(
šode
 * inode,

511 
bufãr_h—d
 * 
bh
, 
Ä
, 
ü—‹
, * *
¡¬t
)

513 
su³r_block
 *
sb
;

514 
tmp
, 
block
;

515 
sysv_zÚe_t
 *
p
;

516 
bufãr_h—d
 * 
»suÉ
;

518 ià(!
bh
)

519  
NULL
;

520 ià(!
bh
->
b_u±od©e
) {

521 
	`Î_rw_block
(
READ
, 1, &
bh
);

522 
	`wa™_Ú_bufãr
(
bh
);

523 ià(!
bh
->
b_u±od©e
) {

524 
	`b»l£
(
bh
);

525  
NULL
;

528 
sb
 = 
šode
->
i_sb
;

529 
p
 = 
Ä
 + (
sysv_zÚe_t
 *è*
¡¬t
;

530 
»³©
:

531 
block
 = 
tmp
 = *
p
;

532 ià(
sb
->
sv_cÚv”t
)

533 
block
 = 
	`äom_coh_ulÚg
(block);

534 ià(
tmp
) {

535 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, (
block
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

536 ià(
tmp
 =ğ*
p
) {

537 
	`b»l£
(
bh
);

538 *
¡¬t
 = 
»suÉ
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

539  
»suÉ
;

541 
	`b»l£
(
»suÉ
);

542 
»³©
;

544 ià(!
ü—‹
) {

545 
	`b»l£
(
bh
);

546  
NULL
;

548 
block
 = 
	`sysv_Ãw_block
(
sb
);

549 ià(!
block
) {

550 
	`b»l£
(
bh
);

551  
NULL
;

553 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, (
block
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
);

554 ià(*
p
) {

555 
	`sysv_ä“_block
(
sb
,
block
);

556 
	`b»l£
(
»suÉ
);

557 
»³©
;

559 *
p
 = (
sb
->
sv_cÚv”t
 ? 
	`to_coh_ulÚg
(
block
) : block);

560 
bh
->
b_dœt
 = 1;

561 
	`b»l£
(
bh
);

562 *
¡¬t
 = 
»suÉ
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

563  
»suÉ
;

564 
	}
}

566 
bufãr_h—d
 * 
	$sysv_g‘blk
(
šode
 * inode, 
block
,

567 
ü—‹
, * *
¡¬t
)

569 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

570 
bufãr_h—d
 * 
bh
;

572 ià(
block
 < 10)

573  
	`šode_g‘blk
(
šode
,
block
,
ü—‹
,
¡¬t
);

574 
block
 -= 10;

575 ià(
block
 < 
sb
->
sv_šd_³r_block
) {

576 
bh
 = 
	`šode_g‘blk
(
šode
,10,
ü—‹
,
¡¬t
);

577  
	`block_g‘blk
(
šode
, 
bh
, 
block
, 
ü—‹
, 
¡¬t
);

579 
block
 -ğ
sb
->
sv_šd_³r_block
;

580 ià(
block
 < 
sb
->
sv_šd_³r_block_2
) {

581 
bh
 = 
	`šode_g‘blk
(
šode
,11,
ü—‹
,
¡¬t
);

582 
bh
 = 
	`block_g‘blk
(
šode
, bh, 
block
 >> 
sb
->
sv_šd_³r_block_b™s
, 
ü—‹
, 
¡¬t
);

583  
	`block_g‘blk
(
šode
, 
bh
, 
block
 & 
sb
->
sv_šd_³r_block_1
, 
ü—‹
, 
¡¬t
);

585 
block
 -ğ
sb
->
sv_šd_³r_block_2
;

586 ià(
block
 < 
sb
->
sv_šd_³r_block_3
) {

587 
bh
 = 
	`šode_g‘blk
(
šode
,12,
ü—‹
,
¡¬t
);

588 
bh
 = 
	`block_g‘blk
(
šode
, bh, 
block
 >> 
sb
->
sv_šd_³r_block_2_b™s
, 
ü—‹
, 
¡¬t
);

589 
bh
 = 
	`block_g‘blk
(
šode
, bh, (
block
 >> 
sb
->
sv_šd_³r_block_b™s
è& sb->
sv_šd_³r_block_1
, 
ü—‹
, 
¡¬t
);

590  
	`block_g‘blk
(
šode
, 
bh
, 
block
 & 
sb
->
sv_šd_³r_block_1
, 
ü—‹
, 
¡¬t
);

592 ià(()
block
<0) {

593 
	`´štk
("sysv_getblk: block<0");

594  
NULL
;

596 
	`´štk
("sysv_getblk: block>big");

597  
NULL
;

598 
	}
}

600 
bufãr_h—d
 * 
	$sysv_fe_b»ad
(
šode
 * inode, 
block
, 
ü—‹
, * *
¡¬t
)

602 
bufãr_h—d
 * 
bh
;

604 
bh
 = 
	`sysv_g‘blk
(
šode
,
block
,
ü—‹
,
¡¬t
);

605 ià(!
bh
 || bh->
b_u±od©e
)

606  
bh
;

607 
	`Î_rw_block
(
READ
, 1, &
bh
);

608 
	`wa™_Ú_bufãr
(
bh
);

609 ià(
bh
->
b_u±od©e
)

610  
bh
;

611 
	`b»l£
(
bh
);

612  
NULL
;

613 
	}
}

616 
šlše
 
	$»ad3by‹
 (* 
p
)

618  ()(*(*)
p
)

619 | ()(*(*)(
p
+2)) << 16;

620 
	}
}

622 
šlše
 
	$wr™e3by‹
 (* 
p
, 
v®
)

624 *(*)
p
 = (è
v®
;

625 *(*)(
p
+2èğ
v®
 >> 16;

626 
	}
}

628 
šlše
 
	$coh_»ad3by‹
 (* 
p
)

630  ()(*(*)
p
) << 16

631 | ()(*(*)(
p
+1));

632 
	}
}

634 
šlše
 
	$coh_wr™e3by‹
 (* 
p
, 
v®
)

636 *(*)
p
 = 
v®
 >> 16;

637 *(*)(
p
+1èğ(è
v®
;

638 
	}
}

640 
	$sysv_»ad_šode
(
šode
 * inode)

642 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

643 
bufãr_h—d
 * 
bh
;

644 * 
bh_d©a
;

645 
sysv_šode
 * 
¿w_šode
;

646 
block
, 
šo
;

647 
umode_t
 
mode
;

649 
šo
 = 
šode
->
i_šo
;

650 
šode
->
i_İ
 = 
NULL
;

651 
šode
->
i_mode
 = 0;

652 ià(!
šo
 || inØ> 
sb
->
sv_nšodes
) {

653 
	`´štk
("Bad inode‚umber on dev 0x%04x: %d is out of„ange\n",

654 
šode
->
i_dev
, 
šo
);

657 
block
 = 
sb
->
sv_fœ¡šodezÚe
 + ((
šo
-1è>> sb->
sv_šodes_³r_block_b™s
);

658 ià(!(
bh
=
	`sysv_b»ad
(
sb
,
šode
->
i_dev
,
block
,&
bh_d©a
))) {

659 
	`´štk
("Major…roblem: unableo„ead inode from dev 0x%04x\n",

660 
šode
->
i_dev
);

663 
¿w_šode
 = (
sysv_šode
 *è
bh_d©a
 + ((
šo
-1è& 
sb
->
sv_šodes_³r_block_1
);

664 
mode
 = 
¿w_šode
->
i_mode
;

665 ià(
sb
->
sv_kludge_symlšks
)

666 
mode
 = 
	`äom_coh_imode
(mode);

668 
šode
->
i_mode
 = 
mode
;

669 
šode
->
i_uid
 = 
¿w_šode
->i_uid;

670 
šode
->
i_gid
 = 
¿w_šode
->i_gid;

671 
šode
->
i_Æšk
 = 
¿w_šode
->i_nlink;

672 ià(
sb
->
sv_cÚv”t
) {

673 
šode
->
i_size
 = 
	`äom_coh_ulÚg
(
¿w_šode
->i_size);

674 
šode
->
i_©ime
 = 
	`äom_coh_ulÚg
(
¿w_šode
->i_atime);

675 
šode
->
i_mtime
 = 
	`äom_coh_ulÚg
(
¿w_šode
->i_mtime);

676 
šode
->
i_ùime
 = 
	`äom_coh_ulÚg
(
¿w_šode
->i_ctime);

678 
šode
->
i_size
 = 
¿w_šode
->i_size;

679 
šode
->
i_©ime
 = 
¿w_šode
->i_atime;

680 
šode
->
i_mtime
 = 
¿w_šode
->i_mtime;

681 
šode
->
i_ùime
 = 
¿w_šode
->i_ctime;

683 
šode
->
i_blocks
 = inode->
i_blksize
 = 0;

684 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

685 
šode
->
i_rdev
 = 
¿w_šode
->
i_a
.i_rdev;

687 ià(
sb
->
sv_cÚv”t
)

688 
block
 = 0; block < 10+1+1+1; block++)

689 
šode
->
u
.
sysv_i
.
i_d©a
[
block
] =

690 
	`coh_»ad3by‹
(&
¿w_šode
->
i_a
.
i_addb
[3*
block
]);

692 
block
 = 0; block < 10+1+1+1; block++)

693 
šode
->
u
.
sysv_i
.
i_d©a
[
block
] =

694 
	`»ad3by‹
(&
¿w_šode
->
i_a
.
i_addb
[3*
block
]);

695 
	`b»l£
(
bh
);

696 ià(
	`S_ISREG
(
šode
->
i_mode
))

697 ià(
sb
->
sv_block_size_¿tio_b™s
 == 0)

698 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs_w™h_bm­
;

700 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs
;

701 ià(
	`S_ISDIR
(
šode
->
i_mode
))

702 
šode
->
i_İ
 = &
sysv_dœ_šode_İ”©iÚs
;

703 ià(
	`S_ISLNK
(
šode
->
i_mode
))

704 
šode
->
i_İ
 = &
sysv_symlšk_šode_İ”©iÚs
;

705 ià(
	`S_ISCHR
(
šode
->
i_mode
))

706 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

707 ià(
	`S_ISBLK
(
šode
->
i_mode
))

708 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

709 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

710 
	`š™_fifo
(
šode
);

711 
	}
}

714 
	$sysv_nÙify_chªge
(
æags
, 
šode
 *inode)

716 ià(
æags
 & 
NOTIFY_MODE
)

717 ià(
šode
->
i_sb
->
sv_kludge_symlšks
)

718 ià(
šode
->
i_mode
 =ğ
COH_KLUDGE_SYMLINK_MODE
) {

719 
šode
->
i_mode
 = 
COH_KLUDGE_NOT_SYMLINK
;

720 
šode
->
i_dœt
 = 1;

723 
	}
}

725 
bufãr_h—d
 * 
	$sysv_upd©e_šode
(
šode
 * inode)

727 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

728 
bufãr_h—d
 * 
bh
;

729 * 
bh_d©a
;

730 
sysv_šode
 * 
¿w_šode
;

731 
šo
, 
block
;

732 
umode_t
 
mode
;

734 
šo
 = 
šode
->
i_šo
;

735 ià(!
šo
 || inØ> 
sb
->
sv_nšodes
) {

736 
	`´štk
("Bad inode‚umber on dev 0x%04x: %d is out of„ange\n",

737 
šode
->
i_dev
, 
šo
);

738 
šode
->
i_dœt
 = 0;

741 
block
 = 
sb
->
sv_fœ¡šodezÚe
 + ((
šo
-1è>> sb->
sv_šodes_³r_block_b™s
);

742 ià(!(
bh
 = 
	`sysv_b»ad
(
sb
,
šode
->
i_dev
,
block
,&
bh_d©a
))) {

743 
	`´štk
("unableo„ead i-node block\n");

744 
šode
->
i_dœt
 = 0;

747 
¿w_šode
 = (
sysv_šode
 *è
bh_d©a
 + ((
šo
-1è& 
sb
->
sv_šodes_³r_block_1
);

748 
mode
 = 
šode
->
i_mode
;

749 ià(
sb
->
sv_kludge_symlšks
)

750 
mode
 = 
	`to_coh_imode
(mode);

751 
¿w_šode
->
i_mode
 = 
mode
;

752 
¿w_šode
->
i_uid
 = 
šode
->i_uid;

753 
¿w_šode
->
i_gid
 = 
šode
->i_gid;

754 
¿w_šode
->
i_Æšk
 = 
šode
->i_nlink;

755 ià(
sb
->
sv_cÚv”t
) {

756 
¿w_šode
->
i_size
 = 
	`to_coh_ulÚg
(
šode
->i_size);

757 
¿w_šode
->
i_©ime
 = 
	`to_coh_ulÚg
(
šode
->i_atime);

758 
¿w_šode
->
i_mtime
 = 
	`to_coh_ulÚg
(
šode
->i_mtime);

759 
¿w_šode
->
i_ùime
 = 
	`to_coh_ulÚg
(
šode
->i_ctime);

761 
¿w_šode
->
i_size
 = 
šode
->i_size;

762 
¿w_šode
->
i_©ime
 = 
šode
->i_atime;

763 
¿w_šode
->
i_mtime
 = 
šode
->i_mtime;

764 
¿w_šode
->
i_ùime
 = 
šode
->i_ctime;

766 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

767 
¿w_šode
->
i_a
.
i_rdev
 = 
šode
->i_rdev;

769 ià(
sb
->
sv_cÚv”t
)

770 
block
 = 0; block < 10+1+1+1; block++)

771 
	`coh_wr™e3by‹
(&
¿w_šode
->
i_a
.
i_addb
[3*
block
],
šode
->
u
.
sysv_i
.
i_d©a
[block]);

773 
block
 = 0; block < 10+1+1+1; block++)

774 
	`wr™e3by‹
(&
¿w_šode
->
i_a
.
i_addb
[3*
block
],
šode
->
u
.
sysv_i
.
i_d©a
[block]);

775 
šode
->
i_dœt
=0;

776 
bh
->
b_dœt
=1;

777  
bh
;

778 
	}
}

780 
	$sysv_wr™e_šode
(
šode
 * inode)

782 
bufãr_h—d
 *
bh
;

783 
bh
 = 
	`sysv_upd©e_šode
(
šode
);

784 
	`b»l£
(
bh
);

785 
	}
}

787 
	$sysv_sync_šode
(
šode
 * inode)

789 
”r
 = 0;

790 
bufãr_h—d
 *
bh
;

792 
bh
 = 
	`sysv_upd©e_šode
(
šode
);

793 ià(
bh
 && bh->
b_dœt
) {

794 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

795 
	`wa™_Ú_bufãr
(
bh
);

796 ià(
bh
->
b_»q
 && !bh->
b_u±od©e
)

798 
	`´štk
 ("IOƒrror syncing sysv inode [%04x:%08lx]\n",

799 
šode
->
i_dev
, inode->
i_šo
);

800 
”r
 = -1;

803 ià(!
bh
)

804 
”r
 = -1;

805 
	`b»l£
 (
bh
);

806  
”r
;

807 
	}
}

	@fs/sysv/namei.c

14 
	~<lšux/sched.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/sysv_fs.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/¡©.h
>

20 
	~<lšux/”ºo.h
>

25 
šlše
 
	$Çmecom·»
(
Ën
, 
maxËn
,

26 cÚ¡ * 
Çme
, cÚ¡ * 
bufãr
)

28 ià(
Ën
 >ğ
maxËn
 || !
bufãr
[len]) {

29 
§me
;

30 
	`__asm__
("repe ; cmpsb ; setz %0"

31 :"=q" (
§me
)

32 :"S" ((è
Çme
),"D" ((è
bufãr
),"c" (
Ën
)

34  
§me
;

38 
	}
}

47 
	$sysv_m©ch
(
Ën
, cÚ¡ * 
Çme
, 
sysv_dœ_’Œy
 * 
de
)

49 ià(!
de
->
šode
 || 
Ën
 > 
SYSV_NAMELEN
)

52 ià(!
Ën
 && (
de
->
Çme
[0]=='.') && (de->name[1]=='\0'))

54  
	`Çmecom·»
(
Ën
,
SYSV_NAMELEN
,
Çme
,
de
->name);

55 
	}
}

65 
bufãr_h—d
 * 
	$sysv_fšd_’Œy
(
šode
 * 
dœ
,

66 cÚ¡ * 
Çme
, 
Çm–’
, 
sysv_dœ_’Œy
 ** 
»s_dœ
)

68 
su³r_block
 * 
sb
;

69 
pos
, 
block
, 
off£t
;

70 
bufãr_h—d
 * 
bh
;

71 * 
bh_d©a
;

73 *
»s_dœ
 = 
NULL
;

74 ià(!
dœ
)

75  
NULL
;

76 
sb
 = 
dœ
->
i_sb
;

77 ià(
Çm–’
 > 
SYSV_NAMELEN
)

78 ià(
sb
->
sv_Œunÿ‹
)

79 
Çm–’
 = 
SYSV_NAMELEN
;

81  
NULL
;

82 
bh
 = 
NULL
;

83 
pos
 = 
block
 = 
off£t
 = 0;

84 
pos
 < 
dœ
->
i_size
) {

85 ià(!
bh
) {

86 
bh
 = 
	`sysv_fe_b»ad
(
dœ
,
block
,0,&
bh_d©a
);

87 ià(!
bh
) {

88  
block
++;

89 
pos
 +ğ
sb
->
sv_block_size
;

93 ià(
	`sysv_m©ch
(
Çm–’
, 
Çme
,

94 *
»s_dœ
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 
off£t
) ))

95  
bh
;

96 
pos
 +ğ
SYSV_DIRSIZE
;

97 
off£t
 +ğ
SYSV_DIRSIZE
;

98 ià(
off£t
 < 
sb
->
sv_block_size
)

100 
	`b»l£
(
bh
);

101 
bh
 = 
NULL
;

102 
off£t
 = 0; 
block
++;

104 
	`b»l£
(
bh
);

105 *
»s_dœ
 = 
NULL
;

106  
NULL
;

107 
	}
}

109 
	$sysv_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

110 
šode
 ** 
»suÉ
)

112 
šo
;

113 
sysv_dœ_’Œy
 * 
de
;

114 
bufãr_h—d
 * 
bh
;

116 *
»suÉ
 = 
NULL
;

117 ià(!
dœ
)

118  -
ENOENT
;

119 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

120 
	`ut
(
dœ
);

121  -
ENOENT
;

123 ià(!(
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
))) {

124 
	`ut
(
dœ
);

125  -
ENOENT
;

127 
šo
 = 
de
->
šode
;

128 
	`b»l£
(
bh
);

129 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
,
šo
))) {

130 
	`ut
(
dœ
);

131  -
EACCES
;

133 
	`ut
(
dœ
);

135 
	}
}

147 
	$sysv_add_’Œy
(
šode
 * 
dœ
,

148 cÚ¡ * 
Çme
, 
Çm–’
,

149 
bufãr_h—d
 ** 
»s_buf
,

150 
sysv_dœ_’Œy
 ** 
»s_dœ
)

152 
su³r_block
 * 
sb
;

153 
i
;

154 
pos
, 
block
, 
off£t
;

155 
bufãr_h—d
 * 
bh
;

156 * 
bh_d©a
;

157 
sysv_dœ_’Œy
 * 
de
;

159 *
»s_buf
 = 
NULL
;

160 *
»s_dœ
 = 
NULL
;

161 ià(!
dœ
)

162  -
ENOENT
;

163 
sb
 = 
dœ
->
i_sb
;

164 ià(
Çm–’
 > 
SYSV_NAMELEN
)

165 ià(
sb
->
sv_Œunÿ‹
)

166 
Çm–’
 = 
SYSV_NAMELEN
;

168  -
ENAMETOOLONG
;

169 ià(!
Çm–’
)

170  -
ENOENT
;

171 
bh
 = 
NULL
;

172 
pos
 = 
block
 = 
off£t
 = 0;

174 ià(!
bh
) {

175 
bh
 = 
	`sysv_fe_b»ad
(
dœ
,
block
,1,&
bh_d©a
);

176 ià(!
bh
)

177  -
ENOSPC
;

179 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 
off£t
);

180 
pos
 +ğ
SYSV_DIRSIZE
;

181 
off£t
 +ğ
SYSV_DIRSIZE
;

182 ià(
pos
 > 
dœ
->
i_size
) {

183 
de
->
šode
 = 0;

184 
dœ
->
i_size
 = 
pos
;

185 
dœ
->
i_dœt
 = 1;

187 ià(
de
->
šode
) {

188 ià(
	`Çmecom·»
(
Çm–’
, 
SYSV_NAMELEN
, 
Çme
, 
de
->name)) {

189 
	`b»l£
(
bh
);

190  -
EEXIST
;

193 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
CURRENT_TIME
;

194 
i
 = 0; i < 
SYSV_NAMELEN
 ; i++)

195 
de
->
Çme
[
i
] = (˜< 
Çm–’
) ?‚ame[i] : 0;

196 
bh
->
b_dœt
 = 1;

197 *
»s_dœ
 = 
de
;

200 ià(
off£t
 < 
sb
->
sv_block_size
)

202 
	`b»l£
(
bh
);

203 
bh
 = 
NULL
;

204 
off£t
 = 0; 
block
++;

206 *
»s_buf
 = 
bh
;

208 
	}
}

210 
	$sysv_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

211 
šode
 ** 
»suÉ
)

213 
”rÜ
;

214 
šode
 * inode;

215 
bufãr_h—d
 * 
bh
;

216 
sysv_dœ_’Œy
 * 
de
;

218 *
»suÉ
 = 
NULL
;

219 ià(!
dœ
)

220  -
ENOENT
;

221 
šode
 = 
	`sysv_Ãw_šode
(
dœ
);

222 ià(!
šode
) {

223 
	`ut
(
dœ
);

224  -
ENOSPC
;

226 ià(
šode
->
i_sb
->
sv_block_size_¿tio_b™s
 == 0)

227 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs_w™h_bm­
;

229 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs
;

230 
šode
->
i_mode
 = 
mode
;

231 
šode
->
i_dœt
 = 1;

232 
”rÜ
 = 
	`sysv_add_’Œy
(
dœ
,
Çme
,
Ën
, &
bh
 ,&
de
);

233 ià(
”rÜ
) {

234 
šode
->
i_Æšk
--;

235 
šode
->
i_dœt
 = 1;

236 
	`ut
(
šode
);

237 
	`ut
(
dœ
);

238  
”rÜ
;

240 
de
->
šode
 = inode->
i_šo
;

241 
bh
->
b_dœt
 = 1;

242 
	`b»l£
(
bh
);

243 
	`ut
(
dœ
);

244 *
»suÉ
 = 
šode
;

246 
	}
}

248 
	$sysv_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
)

250 
”rÜ
;

251 
šode
 * inode;

252 
bufãr_h—d
 * 
bh
;

253 
sysv_dœ_’Œy
 * 
de
;

255 ià(!
dœ
)

256  -
ENOENT
;

257 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

258 ià(
bh
) {

259 
	`b»l£
(
bh
);

260 
	`ut
(
dœ
);

261  -
EEXIST
;

263 
šode
 = 
	`sysv_Ãw_šode
(
dœ
);

264 ià(!
šode
) {

265 
	`ut
(
dœ
);

266  -
ENOSPC
;

268 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

269 
šode
->
i_mode
 = 
mode
;

270 
šode
->
i_İ
 = 
NULL
;

271 ià(
	`S_ISREG
(
šode
->
i_mode
))

272 ià(
šode
->
i_sb
->
sv_block_size_¿tio_b™s
 == 0)

273 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs_w™h_bm­
;

275 
šode
->
i_İ
 = &
sysv_fe_šode_İ”©iÚs
;

276 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

277 
šode
->
i_İ
 = &
sysv_dœ_šode_İ”©iÚs
;

278 ià(
dœ
->
i_mode
 & 
S_ISGID
)

279 
šode
->
i_mode
 |ğ
S_ISGID
;

281 ià(
	`S_ISLNK
(
šode
->
i_mode
))

282 
šode
->
i_İ
 = &
sysv_symlšk_šode_İ”©iÚs
;

283 ià(
	`S_ISCHR
(
šode
->
i_mode
))

284 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

285 ià(
	`S_ISBLK
(
šode
->
i_mode
))

286 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

287 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

288 
	`š™_fifo
(
šode
);

289 ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode))

290 
šode
->
i_rdev
 = 
rdev
;

291 
šode
->
i_dœt
 = 1;

292 
”rÜ
 = 
	`sysv_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

293 ià(
”rÜ
) {

294 
šode
->
i_Æšk
--;

295 
šode
->
i_dœt
 = 1;

296 
	`ut
(
šode
);

297 
	`ut
(
dœ
);

298  
”rÜ
;

300 
de
->
šode
 = inode->
i_šo
;

301 
bh
->
b_dœt
 = 1;

302 
	`b»l£
(
bh
);

303 
	`ut
(
dœ
);

304 
	`ut
(
šode
);

306 
	}
}

308 
	$sysv_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
)

310 
”rÜ
;

311 
šode
 * inode;

312 
bufãr_h—d
 * 
bh
, *
dœ_block
;

313 * 
bh_d©a
;

314 
sysv_dœ_’Œy
 * 
de
;

316 ià(!
dœ
) {

317 
	`ut
(
dœ
);

318  -
EINVAL
;

320 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

321 ià(
bh
) {

322 
	`b»l£
(
bh
);

323 
	`ut
(
dœ
);

324  -
EEXIST
;

326 ià(
dœ
->
i_Æšk
 >ğdœ->
i_sb
->
sv_lšk_max
) {

327 
	`ut
(
dœ
);

328  -
EMLINK
;

330 
šode
 = 
	`sysv_Ãw_šode
(
dœ
);

331 ià(!
šode
) {

332 
	`ut
(
dœ
);

333  -
ENOSPC
;

335 
šode
->
i_İ
 = &
sysv_dœ_šode_İ”©iÚs
;

336 
šode
->
i_size
 = 2 * 
SYSV_DIRSIZE
;

337 
dœ_block
 = 
	`sysv_fe_b»ad
(
šode
,0,1,&
bh_d©a
);

338 ià(!
dœ_block
) {

339 
	`ut
(
dœ
);

340 
šode
->
i_Æšk
--;

341 
šode
->
i_dœt
 = 1;

342 
	`ut
(
šode
);

343  -
ENOSPC
;

345 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 0*
SYSV_DIRSIZE
);

346 
de
->
šode
 = inode->
i_šo
;

347 
	`¡rıy
(
de
->
Çme
,".");

348 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 1*
SYSV_DIRSIZE
);

349 
de
->
šode
 = 
dœ
->
i_šo
;

350 
	`¡rıy
(
de
->
Çme
,"..");

351 
šode
->
i_Æšk
 = 2;

352 
dœ_block
->
b_dœt
 = 1;

353 
	`b»l£
(
dœ_block
);

354 
šode
->
i_mode
 = 
S_IFDIR
 | (
mode
 & 0777 & ~
cu¼’t
->
umask
);

355 ià(
dœ
->
i_mode
 & 
S_ISGID
)

356 
šode
->
i_mode
 |ğ
S_ISGID
;

357 
šode
->
i_dœt
 = 1;

358 
”rÜ
 = 
	`sysv_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

359 ià(
”rÜ
) {

360 
	`ut
(
dœ
);

361 
šode
->
i_Æšk
=0;

362 
	`ut
(
šode
);

363  
”rÜ
;

365 
de
->
šode
 = inode->
i_šo
;

366 
bh
->
b_dœt
 = 1;

367 
dœ
->
i_Æšk
++;

368 
dœ
->
i_dœt
 = 1;

369 
	`ut
(
dœ
);

370 
	`ut
(
šode
);

371 
	`b»l£
(
bh
);

373 
	}
}

378 
	$em±y_dœ
(
šode
 * inode)

380 
su³r_block
 * 
sb
;

381 
pos
, 
block
, 
off£t
;

382 
bufãr_h—d
 * 
bh
;

383 * 
bh_d©a
;

384 
sysv_dœ_’Œy
 * 
de
;

386 ià(!
šode
)

388 
block
 = 0;

389 
bh
 = 
NULL
;

390 
pos
 = 
off£t
 = 2*
SYSV_DIRSIZE
;

391 ià(
šode
->
i_size
 % 
SYSV_DIRSIZE
)

392 
bad_dœ
;

393 ià(
šode
->
i_size
 < 
pos
)

394 
bad_dœ
;

395 
bh
 = 
	`sysv_fe_b»ad
(
šode
,0,0,&
bh_d©a
);

396 ià(!
bh
)

397 
bad_dœ
;

398 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 0*
SYSV_DIRSIZE
);

399 ià(!
de
->
šode
 || 
	`¡rcmp
(de->
Çme
,"."))

400 
bad_dœ
;

401 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 1*
SYSV_DIRSIZE
);

402 ià(!
de
->
šode
 || 
	`¡rcmp
(de->
Çme
,".."))

403 
bad_dœ
;

404 
sb
 = 
šode
->
i_sb
;

405 
pos
 < 
šode
->
i_size
) {

406 ià(!
bh
) {

407 
bh
 = 
	`sysv_fe_b»ad
(
šode
,
block
,0,&
bh_d©a
);

408 ià(!
bh
) {

409  
block
++;

410 
pos
 +ğ
sb
->
sv_block_size
;

414 
de
 = (
sysv_dœ_’Œy
 *è(
bh_d©a
 + 
off£t
);

415 
pos
 +ğ
SYSV_DIRSIZE
;

416 
off£t
 +ğ
SYSV_DIRSIZE
;

417 ià(
de
->
šode
) {

418 
	`b»l£
(
bh
);

421 ià(
off£t
 < 
sb
->
sv_block_size
)

423 
	`b»l£
(
bh
);

424 
bh
 = 
NULL
;

425 
off£t
 = 0; 
block
++;

427 
	`b»l£
(
bh
);

429 
bad_dœ
:

430 
	`b»l£
(
bh
);

431 
	`´štk
("Bad dœeùÜy oÀdeviû %04x\n",
šode
->
i_dev
);

433 
	}
}

435 
	$sysv_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

437 
»tv®
;

438 
šode
 * inode;

439 
bufãr_h—d
 * 
bh
;

440 
sysv_dœ_’Œy
 * 
de
;

442 
šode
 = 
NULL
;

443 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

444 
»tv®
 = -
ENOENT
;

445 ià(!
bh
)

446 
’d_rmdœ
;

447 
»tv®
 = -
EPERM
;

448 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

449 
’d_rmdœ
;

450 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& 
cu¼’t
->
euid
 &&

451 
šode
->
i_uid
 !ğ
cu¼’t
->
euid
)

452 
’d_rmdœ
;

453 ià(
šode
->
i_dev
 !ğ
dœ
->i_dev)

454 
’d_rmdœ
;

455 ià(
šode
 =ğ
dœ
)

456 
’d_rmdœ
;

457 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

458 
»tv®
 = -
ENOTDIR
;

459 
’d_rmdœ
;

461 ià(!
	`em±y_dœ
(
šode
)) {

462 
»tv®
 = -
ENOTEMPTY
;

463 
’d_rmdœ
;

465 ià(
de
->
šode
 !ğšode->
i_šo
) {

466 
»tv®
 = -
ENOENT
;

467 
’d_rmdœ
;

469 ià(
šode
->
i_couÁ
 > 1) {

470 
»tv®
 = -
EBUSY
;

471 
’d_rmdœ
;

473 ià(
šode
->
i_Æšk
 != 2)

474 
	`´štk
("em±y dœeùÜy ha Æšk!=2 (%d)\n",
šode
->
i_Æšk
);

475 
de
->
šode
 = 0;

476 
bh
->
b_dœt
 = 1;

477 
šode
->
i_Æšk
=0;

478 
šode
->
i_dœt
=1;

479 
dœ
->
i_Æšk
--;

480 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

481 
dœ
->
i_dœt
=1;

482 
»tv®
 = 0;

483 
’d_rmdœ
:

484 
	`ut
(
dœ
);

485 
	`ut
(
šode
);

486 
	`b»l£
(
bh
);

487  
»tv®
;

488 
	}
}

490 
	$sysv_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

492 
»tv®
;

493 
šode
 * inode;

494 
bufãr_h—d
 * 
bh
;

495 
sysv_dœ_’Œy
 * 
de
;

497 
»³©
:

498 
»tv®
 = -
ENOENT
;

499 
šode
 = 
NULL
;

500 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

501 ià(!
bh
)

502 
’d_uÆšk
;

503 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->inode)))

504 
’d_uÆšk
;

505 
»tv®
 = -
EPERM
;

506 ià(
	`S_ISDIR
(
šode
->
i_mode
))

507 
’d_uÆšk
;

508 ià(
de
->
šode
 !ğšode->
i_šo
) {

509 
	`ut
(
šode
);

510 
	`b»l£
(
bh
);

511 
cu¼’t
->
couÁ”
 = 0;

512 
	`scheduË
();

513 
»³©
;

515 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& !
	`su£r
() &&

516 
cu¼’t
->
euid
 !ğ
šode
->
i_uid
 &&

517 
cu¼’t
->
euid
 !ğ
dœ
->
i_uid
)

518 
’d_uÆšk
;

519 ià(
de
->
šode
 !ğšode->
i_šo
) {

520 
»tv®
 = -
ENOENT
;

521 
’d_uÆšk
;

523 ià(!
šode
->
i_Æšk
) {

524 
	`´štk
("Deleting‚onexistent file (%04x:%lu), %d\n",

525 
šode
->
i_dev
,šode->
i_šo
,šode->
i_Æšk
);

526 
šode
->
i_Æšk
=1;

528 
de
->
šode
 = 0;

529 
bh
->
b_dœt
 = 1;

530 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

531 
dœ
->
i_dœt
 = 1;

532 
šode
->
i_Æšk
--;

533 
šode
->
i_ùime
 = 
dœ
->i_ctime;

534 
šode
->
i_dœt
 = 1;

535 
»tv®
 = 0;

536 
’d_uÆšk
:

537 
	`b»l£
(
bh
);

538 
	`ut
(
šode
);

539 
	`ut
(
dœ
);

540  
»tv®
;

541 
	}
}

543 
	$sysv_symlšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, cÚ¡ * 
symÇme
)

545 
sysv_dœ_’Œy
 * 
de
;

546 
šode
 * inode;

547 
bufãr_h—d
 * 
Çme_block
;

548 * 
Çme_block_d©a
;

549 
su³r_block
 * 
sb
;

550 
i
;

551 
c
;

552 
bufãr_h—d
 * 
bh
;

554 ià(!(
šode
 = 
	`sysv_Ãw_šode
(
dœ
))) {

555 
	`ut
(
dœ
);

556  -
ENOSPC
;

558 
šode
->
i_mode
 = 
S_IFLNK
 | 0777;

559 
šode
->
i_İ
 = &
sysv_symlšk_šode_İ”©iÚs
;

560 
Çme_block
 = 
	`sysv_fe_b»ad
(
šode
,0,1,&
Çme_block_d©a
);

561 ià(!
Çme_block
) {

562 
	`ut
(
dœ
);

563 
šode
->
i_Æšk
--;

564 
šode
->
i_dœt
 = 1;

565 
	`ut
(
šode
);

566  -
ENOSPC
;

568 
sb
 = 
šode
->
i_sb
;

569 
i
 = 0;

570 
i
 < 
sb
->
sv_block_size_1
 && (
c
 = *(
symÇme
++)))

571 
Çme_block_d©a
[
i
++] = 
c
;

572 
Çme_block_d©a
[
i
] = 0;

573 
Çme_block
->
b_dœt
 = 1;

574 
	`b»l£
(
Çme_block
);

575 
šode
->
i_size
 = 
i
;

576 
šode
->
i_dœt
 = 1;

577 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

578 ià(
bh
) {

579 
šode
->
i_Æšk
--;

580 
šode
->
i_dœt
 = 1;

581 
	`ut
(
šode
);

582 
	`b»l£
(
bh
);

583 
	`ut
(
dœ
);

584  -
EEXIST
;

586 
i
 = 
	`sysv_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

587 ià(
i
) {

588 
šode
->
i_Æšk
--;

589 
šode
->
i_dœt
 = 1;

590 
	`ut
(
šode
);

591 
	`ut
(
dœ
);

592  
i
;

594 
de
->
šode
 = inode->
i_šo
;

595 
bh
->
b_dœt
 = 1;

596 
	`b»l£
(
bh
);

597 
	`ut
(
dœ
);

598 
	`ut
(
šode
);

600 
	}
}

602 
	$sysv_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

604 
”rÜ
;

605 
sysv_dœ_’Œy
 * 
de
;

606 
bufãr_h—d
 * 
bh
;

608 ià(
	`S_ISDIR
(
Şdšode
->
i_mode
)) {

609 
	`ut
(
Şdšode
);

610 
	`ut
(
dœ
);

611  -
EPERM
;

613 ià(
Şdšode
->
i_Æšk
 >ğŞdšode->
i_sb
->
sv_lšk_max
) {

614 
	`ut
(
Şdšode
);

615 
	`ut
(
dœ
);

616  -
EMLINK
;

618 
bh
 = 
	`sysv_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
);

619 ià(
bh
) {

620 
	`b»l£
(
bh
);

621 
	`ut
(
dœ
);

622 
	`ut
(
Şdšode
);

623  -
EEXIST
;

625 
”rÜ
 = 
	`sysv_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
bh
, &
de
);

626 ià(
”rÜ
) {

627 
	`ut
(
dœ
);

628 
	`ut
(
Şdšode
);

629  
”rÜ
;

631 
de
->
šode
 = 
Şdšode
->
i_šo
;

632 
bh
->
b_dœt
 = 1;

633 
	`b»l£
(
bh
);

634 
	`ut
(
dœ
);

635 
Şdšode
->
i_Æšk
++;

636 
Şdšode
->
i_ùime
 = 
CURRENT_TIME
;

637 
Şdšode
->
i_dœt
 = 1;

638 
	`ut
(
Şdšode
);

640 
	}
}

643 
	$subdœ
(
šode
 * 
Ãw_šode
, šod* 
Şd_šode
)

645 
šo
;

646 
»suÉ
;

648 
Ãw_šode
->
i_couÁ
++;

649 
»suÉ
 = 0;

651 ià(
Ãw_šode
 =ğ
Şd_šode
) {

652 
»suÉ
 = 1;

655 ià(
Ãw_šode
->
i_dev
 !ğ
Şd_šode
->i_dev)

657 
šo
 = 
Ãw_šode
->
i_šo
;

658 ià(
	`sysv_lookup
(
Ãw_šode
,"..",2,&new_inode))

660 ià(
Ãw_šode
->
i_šo
 =ğ
šo
)

663 
	`ut
(
Ãw_šode
);

664  
»suÉ
;

665 
	}
}

667 
	#PARENT_INO
(
bufãr
) \

668 (((
sysv_dœ_’Œy
 *è((
bufãr
è+ 1*
SYSV_DIRSIZE
))->
šode
)

	)

680 
	$do_sysv_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

681 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

683 
šode
 * 
Şd_šode
, * 
Ãw_šode
;

684 
bufãr_h—d
 * 
Şd_bh
, * 
Ãw_bh
, * 
dœ_bh
;

685 * 
dœ_bh_d©a
;

686 
sysv_dœ_’Œy
 * 
Şd_de
, * 
Ãw_de
;

687 
»tv®
;

689 
¡¬t_up
;

690 
Œy_agaš
:

691 
	`b»l£
(
Şd_bh
);

692 
	`b»l£
(
Ãw_bh
);

693 
	`b»l£
(
dœ_bh
);

694 
	`ut
(
Şd_šode
);

695 
	`ut
(
Ãw_šode
);

696 
cu¼’t
->
couÁ”
 = 0;

697 
	`scheduË
();

698 
¡¬t_up
:

699 
Şd_šode
 = 
Ãw_šode
 = 
NULL
;

700 
Şd_bh
 = 
Ãw_bh
 = 
dœ_bh
 = 
NULL
;

701 
Şd_bh
 = 
	`sysv_fšd_’Œy
(
Şd_dœ
,
Şd_Çme
,
Şd_Ën
,&
Şd_de
);

702 
»tv®
 = -
ENOENT
;

703 ià(!
Şd_bh
)

704 
’d_»Çme
;

705 
Şd_šode
 = 
	`__ig‘
(
Şd_dœ
->
i_sb
, 
Şd_de
->
šode
, 0);

706 ià(!
Şd_šode
)

707 
’d_»Çme
;

708 
»tv®
 = -
EPERM
;

709 ià((
Şd_dœ
->
i_mode
 & 
S_ISVTX
) &&

710 
cu¼’t
->
euid
 !ğ
Şd_šode
->
i_uid
 &&

711 
cu¼’t
->
euid
 !ğ
Şd_dœ
->
i_uid
 && !
	`su£r
())

712 
’d_»Çme
;

713 
Ãw_bh
 = 
	`sysv_fšd_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_de
);

714 ià(
Ãw_bh
) {

715 
Ãw_šode
 = 
	`__ig‘
(
Ãw_dœ
->
i_sb
, 
Ãw_de
->
šode
, 0);

716 ià(!
Ãw_šode
) {

717 
	`b»l£
(
Ãw_bh
);

718 
Ãw_bh
 = 
NULL
;

721 ià(
Ãw_šode
 =ğ
Şd_šode
) {

722 
»tv®
 = 0;

723 
’d_»Çme
;

725 ià(
Ãw_šode
 && 
	`S_ISDIR
Òew_šode->
i_mode
)) {

726 
»tv®
 = -
EISDIR
;

727 ià(!
	`S_ISDIR
(
Şd_šode
->
i_mode
))

728 
’d_»Çme
;

729 
»tv®
 = -
EINVAL
;

730 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

731 
’d_»Çme
;

732 
»tv®
 = -
ENOTEMPTY
;

733 ià(!
	`em±y_dœ
(
Ãw_šode
))

734 
’d_»Çme
;

735 
»tv®
 = -
EBUSY
;

736 ià(
Ãw_šode
->
i_couÁ
 > 1)

737 
’d_»Çme
;

739 
»tv®
 = -
EPERM
;

740 ià(
Ãw_šode
 && (
Ãw_dœ
->
i_mode
 & 
S_ISVTX
) &&

741 
cu¼’t
->
euid
 !ğ
Ãw_šode
->
i_uid
 &&

742 
cu¼’t
->
euid
 !ğ
Ãw_dœ
->
i_uid
 && !
	`su£r
())

743 
’d_»Çme
;

744 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

745 
»tv®
 = -
ENOTDIR
;

746 ià(
Ãw_šode
 && !
	`S_ISDIR
Òew_šode->
i_mode
))

747 
’d_»Çme
;

748 
»tv®
 = -
EINVAL
;

749 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

750 
’d_»Çme
;

751 
»tv®
 = -
EIO
;

752 
dœ_bh
 = 
	`sysv_fe_b»ad
(
Şd_šode
,0,0,&
dœ_bh_d©a
);

753 ià(!
dœ_bh
)

754 
’d_»Çme
;

755 ià(
	`PARENT_INO
(
dœ_bh_d©a
è!ğ
Şd_dœ
->
i_šo
)

756 
’d_»Çme
;

757 
»tv®
 = -
EMLINK
;

758 ià(!
Ãw_šode
 && 
Ãw_dœ
->
i_Æšk
 >ğÃw_dœ->
i_sb
->
sv_lšk_max
)

759 
’d_»Çme
;

761 ià(!
Ãw_bh
) {

762 
»tv®
 = 
	`sysv_add_’Œy
(
Ãw_dœ
,
Ãw_Çme
,
Ãw_Ën
,&
Ãw_bh
,&
Ãw_de
);

763 ià(
»tv®
)

764 
’d_»Çme
;

767 ià(
Ãw_šode
 && (
Ãw_de
->
šode
 !ğÃw_šode->
i_šo
))

768 
Œy_agaš
;

769 ià(
Ãw_de
->
šode
 && !
Ãw_šode
)

770 
Œy_agaš
;

771 ià(
Şd_de
->
šode
 !ğ
Şd_šode
->
i_šo
)

772 
Œy_agaš
;

774 
Şd_de
->
šode
 = 0;

775 
Ãw_de
->
šode
 = 
Şd_šode
->
i_šo
;

776 
Şd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
CURRENT_TIME
;

777 
Şd_dœ
->
i_dœt
 = 1;

778 
Ãw_dœ
->
i_ùime
 =‚ew_dœ->
i_mtime
 = 
CURRENT_TIME
;

779 
Ãw_dœ
->
i_dœt
 = 1;

780 ià(
Ãw_šode
) {

781 
Ãw_šode
->
i_Æšk
--;

782 
Ãw_šode
->
i_ùime
 = 
CURRENT_TIME
;

783 
Ãw_šode
->
i_dœt
 = 1;

785 
Şd_bh
->
b_dœt
 = 1;

786 
Ãw_bh
->
b_dœt
 = 1;

787 ià(
dœ_bh
) {

788 
	`PARENT_INO
(
dœ_bh_d©a
èğ
Ãw_dœ
->
i_šo
;

789 
dœ_bh
->
b_dœt
 = 1;

790 
Şd_dœ
->
i_Æšk
--;

791 
Şd_dœ
->
i_dœt
 = 1;

792 ià(
Ãw_šode
) {

793 
Ãw_šode
->
i_Æšk
--;

794 
Ãw_šode
->
i_dœt
 = 1;

796 
Ãw_dœ
->
i_Æšk
++;

797 
Ãw_dœ
->
i_dœt
 = 1;

800 
»tv®
 = 0;

801 
’d_»Çme
:

802 
	`b»l£
(
dœ_bh
);

803 
	`b»l£
(
Şd_bh
);

804 
	`b»l£
(
Ãw_bh
);

805 
	`ut
(
Şd_šode
);

806 
	`ut
(
Ãw_šode
);

807 
	`ut
(
Şd_dœ
);

808 
	`ut
(
Ãw_dœ
);

809  
»tv®
;

810 
	}
}

821 
	$sysv_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

822 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

824 
wa™_queue
 * 
wa™
 = 
NULL
;

825 
lock
 = 0;

826 
»suÉ
;

828 
lock
)

829 
	`¦“p_Ú
(&
wa™
);

830 
lock
 = 1;

831 
»suÉ
 = 
	`do_sysv_»Çme
(
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
,

832 
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
);

833 
lock
 = 0;

834 
	`wake_up
(&
wa™
);

835  
»suÉ
;

836 
	}
}

	@fs/sysv/symlink.c

16 
	~<asm/£gm’t.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<lšux/sched.h
>

20 
	~<lšux/sysv_fs.h
>

21 
	~<lšux/¡©.h
>

23 
sysv_»adlšk
(
šode
 *, *, );

24 
sysv_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

29 
šode_İ”©iÚs
 
	gsysv_symlšk_šode_İ”©iÚs
 = {

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
sysv_»adlšk
,

41 
sysv_fŞlow_lšk
,

42 
NULL
,

43 
NULL
,

44 
NULL


47 
	$sysv_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

48 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

50 
”rÜ
;

51 
bufãr_h—d
 * 
bh
;

52 * 
bh_d©a
;

54 *
»s_šode
 = 
NULL
;

55 ià(!
dœ
) {

56 
dœ
 = 
cu¼’t
->
roÙ
;

57 
dœ
->
i_couÁ
++;

59 ià(!
šode
) {

60 
	`ut
(
dœ
);

61  -
ENOENT
;

63 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

64 
	`ut
(
dœ
);

65 *
»s_šode
 = 
šode
;

68 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

69 
	`ut
(
šode
);

70 
	`ut
(
dœ
);

71  -
ELOOP
;

73 ià(!(
bh
 = 
	`sysv_fe_b»ad
(
šode
, 0, 0, &
bh_d©a
))) {

74 
	`ut
(
šode
);

75 
	`ut
(
dœ
);

76  -
EIO
;

78 
	`ut
(
šode
);

79 
cu¼’t
->
lšk_couÁ
++;

80 
”rÜ
 = 
	`İ’_Çmei
(
bh_d©a
,
æag
,
mode
,
»s_šode
,
dœ
);

81 
cu¼’t
->
lšk_couÁ
--;

82 
	`b»l£
(
bh
);

83  
”rÜ
;

84 
	}
}

86 
	$sysv_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

88 
bufãr_h—d
 * 
bh
;

89 * 
bh_d©a
;

90 
i
;

91 
c
;

93 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

94 
	`ut
(
šode
);

95  -
EINVAL
;

97 ià(
buæ’
 > 
šode
->
i_sb
->
sv_block_size_1
)

98 
buæ’
 = 
šode
->
i_sb
->
sv_block_size_1
;

99 
bh
 = 
	`sysv_fe_b»ad
(
šode
, 0, 0, &
bh_d©a
);

100 
	`ut
(
šode
);

101 ià(!
bh
)

103 
i
 = 0;

104 
i
<
buæ’
 && (
c
 = 
bh_d©a
[i])) {

105 
i
++;

106 
	`put_fs_by‹
(
c
,
bufãr
++);

108 
	`b»l£
(
bh
);

109  
i
;

110 
	}
}

	@fs/sysv/truncate.c

14 
	~<lšux/sched.h
>

15 
	~<lšux/fs.h
>

16 
	~<lšux/sysv_fs.h
>

17 
	~<lšux/¡©.h
>

32 
	$coh_Œunc_dœeù
 (
šode
 * inode, 
blocks
)

34 
i
;

35 * 
p
;

36 
block
;

38 
i
 = 
blocks
; i < 10 ; i++) {

39 
p
 = &
šode
->
u
.
sysv_i
.
i_d©a
[
i
];

40 
block
 = *
p
;

41 ià(!
block
)

43 *
p
 = 0;

44 
šode
->
i_dœt
 = 1;

45 
	`sysv_ä“_block
(
šode
->
i_sb
,
block
);

48 
	}
}

53 
	$coh_Œunc_šdœeù
 (
šode
 * inode, 
blocks
, * 
p
, 
cÚv”t
, * 
dœt
)

55 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

56 
tmp
, 
block
, 
šdblock
;

57 
bufãr_h—d
 * 
bh
;

58 * 
bh_d©a
;

59 
i
;

60 
sysv_zÚe_t
 * 
šd
;

62 ià(
blocks
 >ğ
sb
->
sv_šd_³r_block
)

64 
block
 = 
tmp
 = *
p
;

65 ià(
cÚv”t
)

66 
block
 = 
	`äom_coh_ulÚg
(block);

67 ià(!
block
)

69 
bh
 = 
	`sysv_b»ad
(
sb
,
šode
->
i_dev
,
block
,&
bh_d©a
);

70 ià(
tmp
 !ğ*
p
) {

71 
	`b»l£
(
bh
);

74 ià(!
bh
) {

75 *
p
 = 0;

76 *
dœt
 = 1;

79 
i
 = 
blocks
; i < 
sb
->
sv_šd_³r_block
; i++) {

80 
šd
 = &((
sysv_zÚe_t
 *è
bh_d©a
)[
i
];

81 
šdblock
 = *
šd
;

82 ià(
sb
->
sv_cÚv”t
)

83 
šdblock
 = 
	`äom_coh_ulÚg
(indblock);

84 ià(!
šdblock
)

86 *
šd
 = 0;

87 
bh
->
b_dœt
 = 1;

88 
	`sysv_ä“_block
(
sb
,
šdblock
);

90 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++)

91 ià(((
sysv_zÚe_t
 *è
bh_d©a
)[
i
])

92 
dÚe
;

93 ià(
tmp
 !ğ*
p
) {

94 
	`b»l£
(
bh
);

97 *
p
 = 0;

98 *
dœt
 = 1;

99 
	`sysv_ä“_block
(
sb
,
block
);

100 
dÚe
:

101 
	`b»l£
(
bh
);

103 
	}
}

108 
	$coh_Œunc_dšdœeù
 (
šode
 * inode, 
blocks
, * 
p
, 
cÚv”t
, * 
dœt
)

110 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

111 
tmp
, 
block
, 
dšdblock
;

112 
bufãr_h—d
 * 
bh
;

113 * 
bh_d©a
;

114 
i
, 
j
;

115 
sysv_zÚe_t
 * 
dšd
;

116 
»Œy
 = 0;

118 ià(
blocks
 >ğ
sb
->
sv_šd_³r_block_2
)

120 
block
 = 
tmp
 = *
p
;

121 ià(
cÚv”t
)

122 
block
 = 
	`äom_coh_ulÚg
(block);

123 ià(!
block
)

125 
bh
 = 
	`sysv_b»ad
(
sb
,
šode
->
i_dev
,
block
,&
bh_d©a
);

126 ià(
tmp
 !ğ*
p
) {

127 
	`b»l£
(
bh
);

130 ià(!
bh
) {

131 *
p
 = 0;

132 *
dœt
 = 1;

135 
i
 = 
blocks
 >> 
sb
->
sv_šd_³r_block_b™s
, 
j
 = block & sb->
sv_šd_³r_block_1
;

136 
i
 < 
sb
->
sv_šd_³r_block
;

137 
i
++, 
j
 = 0) {

139 
dšd
 = &((
sysv_zÚe_t
 *è
bh_d©a
)[
i
];

140 
dšdblock
 = *
dšd
;

141 ià(
sb
->
sv_cÚv”t
)

142 
dšdblock
 = 
	`äom_coh_ulÚg
(dindblock);

143 ià(!
dšdblock
)

145 
»Œy
 |ğ
	`coh_Œunc_šdœeù
(
šode
,
j
,
dšd
,
sb
->
sv_cÚv”t
,&
bh
->
b_dœt
);

147 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++)

148 ià(((
sysv_zÚe_t
 *è
bh_d©a
)[
i
])

149 
dÚe
;

150 ià(
tmp
 !ğ*
p
) {

151 
	`b»l£
(
bh
);

154 *
p
 = 0;

155 *
dœt
 = 1;

156 
	`sysv_ä“_block
(
sb
,
block
);

157 
dÚe
:

158 
	`b»l£
(
bh
);

159  
»Œy
;

160 
	}
}

165 
	$coh_Œunc_tšdœeù
 (
šode
 * inode, 
blocks
, * 
p
)

167 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

168 
block
, 
tšdblock
;

169 
bufãr_h—d
 * 
bh
;

170 * 
bh_d©a
;

171 
i
, 
j
;

172 
sysv_zÚe_t
 * 
tšd
;

173 
»Œy
 = 0;

175 ià(
blocks
 >ğ
sb
->
sv_šd_³r_block_3
)

177 
block
 = *
p
;

178 ià(!
block
)

180 
bh
 = 
	`sysv_b»ad
(
sb
,
šode
->
i_dev
,
block
,&
bh_d©a
);

181 ià(
block
 !ğ*
p
) {

182 
	`b»l£
(
bh
);

185 ià(!
bh
) {

186 *
p
 = 0;

187 
šode
->
i_dœt
 = 1;

190 
i
 = 
blocks
 >> 
sb
->
sv_šd_³r_block_2_b™s
, 
j
 = block & sb->
sv_šd_³r_block_2_1
;

191 
i
 < 
sb
->
sv_šd_³r_block
;

192 
i
++, 
j
 = 0) {

194 
tšd
 = &((
sysv_zÚe_t
 *è
bh_d©a
)[
i
];

195 
tšdblock
 = *
tšd
;

196 ià(
sb
->
sv_cÚv”t
)

197 
tšdblock
 = 
	`äom_coh_ulÚg
(tindblock);

198 ià(!
tšdblock
)

200 
»Œy
 |ğ
	`coh_Œunc_dšdœeù
(
šode
,
j
,
tšd
,
sb
->
sv_cÚv”t
,&
bh
->
b_dœt
);

202 
i
 = 0; i < 
sb
->
sv_šd_³r_block
; i++)

203 ià(((
sysv_zÚe_t
 *è
bh_d©a
)[
i
])

204 
dÚe
;

205 ià(
block
 !ğ*
p
) {

206 
	`b»l£
(
bh
);

209 *
p
 = 0;

210 
šode
->
i_dœt
 = 1;

211 
	`sysv_ä“_block
(
sb
,
block
);

212 
dÚe
:

213 
	`b»l£
(
bh
);

214  
»Œy
;

215 
	}
}

217 
	$coh_Œunc_®l
(
šode
 * inode)

219 
su³r_block
 * 
sb
 = 
šode
->
i_sb
;

220 
blocks
;

221 
»Œy
;

223 
blocks
 = (
šode
->
i_size
 + 
sb
->
sv_block_size_1
è>> sb->
sv_block_size_b™s
;

224 
»Œy
 = 
	`coh_Œunc_dœeù
(
šode
,
blocks
);

225 
blocks
 -= 10;

226 ià(
blocks
 < 0) blocks = 0;

227 
»Œy
 |ğ
	`coh_Œunc_šdœeù
(
šode
,
blocks
,&šode->
u
.
sysv_i
.
i_d©a
[10],0,&šode->
i_dœt
);

228 
blocks
 -ğ
sb
->
sv_šd_³r_block
;

229 ià(
blocks
 < 0) blocks = 0;

230 
»Œy
 |ğ
	`coh_Œunc_dšdœeù
(
šode
,
blocks
,&šode->
u
.
sysv_i
.
i_d©a
[11],0,&šode->
i_dœt
);

231 
blocks
 -ğ
sb
->
sv_šd_³r_block_2
;

232 ià(
blocks
 < 0) blocks = 0;

233 
»Œy
 |ğ
	`coh_Œunc_tšdœeù
(
šode
,
blocks
,&šode->
u
.
sysv_i
.
i_d©a
[12]);

234  
»Œy
;

235 
	}
}

255 
	$Œunc_dœeù
(
šode
 * inode)

257 
su³r_block
 * 
sb
;

258 
i
;

259 * 
p
;

260 
block
;

261 
bufãr_h—d
 * 
bh
;

262 
»Œy
 = 0;

264 
sb
 = 
šode
->
i_sb
;

265 
»³©
:

266 
i
 = ((è
šode
->
i_size
 + 
BLOCK_SIZE
-1) / BLOCK_SIZE; i < 10; i++) {

267 
p
 = 
šode
->
u
.
sysv_i
.
i_d©a
 + 
i
;

268 
block
 = *
p
;

269 ià(!
block
)

271 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
,
block
+
sb
->
sv_block_ba£
,
BLOCK_SIZE
);

272 ià(
i
*
BLOCK_SIZE
 < 
šode
->
i_size
) {

273 
	`b»l£
(
bh
);

274 
»³©
;

276 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| (
block
 !ğ*
p
)) {

277 
»Œy
 = 1;

278 
	`b»l£
(
bh
);

281 *
p
 = 0;

282 
šode
->
i_dœt
 = 1;

283 
	`b»l£
(
bh
);

284 
	`sysv_ä“_block
(
sb
,
block
);

286  
»Œy
;

287 
	}
}

289 
	#IND_PER_BLOCK
 (
BLOCK_SIZE
 / (
sysv_zÚe_t
))

	)

291 
	$Œunc_šdœeù
(
šode
 * inode, 
off£t
, * 
p
, 
cÚv”t
, * 
dœt
)

293 
šdtmp
, 
šdblock
;

294 
su³r_block
 * 
sb
;

295 
bufãr_h—d
 * 
šdbh
;

296 
i
;

297 
sysv_zÚe_t
 * 
šd
;

298 
tmp
, 
block
;

299 
bufãr_h—d
 * 
bh
;

300 
»Œy
 = 0;

302 
šdblock
 = 
šdtmp
 = *
p
;

303 ià(
cÚv”t
)

304 
šdblock
 = 
	`äom_coh_ulÚg
(indblock);

305 ià(!
šdblock
)

307 
sb
 = 
šode
->
i_sb
;

308 
šdbh
 = 
	`b»ad
(
šode
->
i_dev
,
šdblock
+
sb
->
sv_block_ba£
,
BLOCK_SIZE
);

309 ià(
šdtmp
 !ğ*
p
) {

310 
	`b»l£
(
šdbh
);

313 ià(!
šdbh
) {

314 *
p
 = 0;

315 *
dœt
 = 1;

318 
»³©
:

319 ià(
šode
->
i_size
 < 
off£t
)

320 
i
 = 0;

322 
i
 = (
šode
->
i_size
 - 
off£t
 + 
BLOCK_SIZE
-1) / BLOCK_SIZE;

323 ; 
i
 < 
IND_PER_BLOCK
; i++) {

324 
šd
 = ((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
è+ 
i
;

325 
block
 = 
tmp
 = *
šd
;

326 ià(
sb
->
sv_cÚv”t
)

327 
block
 = 
	`äom_coh_ulÚg
(block);

328 ià(!
block
)

330 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
,
block
+
sb
->
sv_block_ba£
,
BLOCK_SIZE
);

331 ià(
i
*
BLOCK_SIZE
 + 
off£t
 < 
šode
->
i_size
) {

332 
	`b»l£
(
bh
);

333 
»³©
;

335 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| (
tmp
 !ğ*
šd
)) {

336 
»Œy
 = 1;

337 
	`b»l£
(
bh
);

340 *
šd
 = 0;

341 
šdbh
->
b_dœt
 = 1;

342 
	`b»l£
(
bh
);

343 
	`sysv_ä“_block
(
sb
,
block
);

345 
i
 = 0; i < 
IND_PER_BLOCK
; i++)

346 ià(((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
)[
i
])

347 
dÚe
;

348 ià((
šdbh
->
b_couÁ
 !ğ1è|| (
šdtmp
 !ğ*
p
)) {

349 
	`b»l£
(
šdbh
);

352 *
p
 = 0;

353 *
dœt
 = 1;

354 
	`sysv_ä“_block
(
sb
,
šdblock
);

355 
dÚe
:

356 
	`b»l£
(
šdbh
);

357  
»Œy
;

358 
	}
}

360 
	$Œunc_dšdœeù
(
šode
 * inode, 
off£t
, * 
p
, 
cÚv”t
, * 
dœt
)

362 
šdtmp
, 
šdblock
;

363 
su³r_block
 * 
sb
;

364 
bufãr_h—d
 * 
šdbh
;

365 
i
;

366 
sysv_zÚe_t
 * 
šd
;

367 
tmp
, 
block
;

368 
»Œy
 = 0;

370 
šdblock
 = 
šdtmp
 = *
p
;

371 ià(
cÚv”t
)

372 
šdblock
 = 
	`äom_coh_ulÚg
(indblock);

373 ià(!
šdblock
)

375 
sb
 = 
šode
->
i_sb
;

376 
šdbh
 = 
	`b»ad
(
šode
->
i_dev
,
šdblock
+
sb
->
sv_block_ba£
,
BLOCK_SIZE
);

377 ià(
šdtmp
 !ğ*
p
) {

378 
	`b»l£
(
šdbh
);

381 ià(!
šdbh
) {

382 *
p
 = 0;

383 *
dœt
 = 1;

386 ià(
šode
->
i_size
 < 
off£t
)

387 
i
 = 0;

389 
i
 = (
šode
->
i_size
 - 
off£t
 + 
IND_PER_BLOCK
*
BLOCK_SIZE
-1) / (IND_PER_BLOCK*BLOCK_SIZE);

390 ; 
i
 < 
IND_PER_BLOCK
; i++) {

391 
šd
 = ((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
è+ 
i
;

392 
block
 = 
tmp
 = *
šd
;

393 ià(
sb
->
sv_cÚv”t
)

394 
block
 = 
	`äom_coh_ulÚg
(block);

395 ià(!
block
)

397 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,
off£t
+
i
*
IND_PER_BLOCK
,
šd
,
sb
->
sv_cÚv”t
,&
šdbh
->
b_dœt
);

399 
i
 = 0; i < 
IND_PER_BLOCK
; i++)

400 ià(((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
)[
i
])

401 
dÚe
;

402 ià((
šdbh
->
b_couÁ
 !ğ1è|| (
šdtmp
 !ğ*
p
)) {

403 
	`b»l£
(
šdbh
);

406 *
p
 = 0;

407 *
dœt
 = 1;

408 
	`sysv_ä“_block
(
sb
,
šdblock
);

409 
dÚe
:

410 
	`b»l£
(
šdbh
);

411  
»Œy
;

412 
	}
}

414 
	$Œunc_tšdœeù
(
šode
 * inode, 
off£t
, * 
p
, 
cÚv”t
, * 
dœt
)

416 
šdtmp
, 
šdblock
;

417 
su³r_block
 * 
sb
;

418 
bufãr_h—d
 * 
šdbh
;

419 
i
;

420 
sysv_zÚe_t
 * 
šd
;

421 
tmp
, 
block
;

422 
»Œy
 = 0;

424 
šdblock
 = 
šdtmp
 = *
p
;

425 ià(
cÚv”t
)

426 
šdblock
 = 
	`äom_coh_ulÚg
(indblock);

427 ià(!
šdblock
)

429 
sb
 = 
šode
->
i_sb
;

430 
šdbh
 = 
	`b»ad
(
šode
->
i_dev
,
šdblock
+
sb
->
sv_block_ba£
,
BLOCK_SIZE
);

431 ià(
šdtmp
 !ğ*
p
) {

432 
	`b»l£
(
šdbh
);

435 ià(!
šdbh
) {

436 *
p
 = 0;

437 *
dœt
 = 1;

440 ià(
šode
->
i_size
 < 
off£t
)

441 
i
 = 0;

443 
i
 = (
šode
->
i_size
 - 
off£t
 + 
IND_PER_BLOCK
*IND_PER_BLOCK*
BLOCK_SIZE
-1) / (IND_PER_BLOCK*IND_PER_BLOCK*BLOCK_SIZE);

444 ; 
i
 < 
IND_PER_BLOCK
; i++) {

445 
šd
 = ((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
è+ 
i
;

446 
block
 = 
tmp
 = *
šd
;

447 ià(
sb
->
sv_cÚv”t
)

448 
block
 = 
	`äom_coh_ulÚg
(block);

449 ià(!
block
)

451 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
,
off£t
+
i
*
IND_PER_BLOCK
*IND_PER_BLOCK,
šd
,
sb
->
sv_cÚv”t
,&
šdbh
->
b_dœt
);

453 
i
 = 0; i < 
IND_PER_BLOCK
; i++)

454 ià(((
sysv_zÚe_t
 *è
šdbh
->
b_d©a
)[
i
])

455 
dÚe
;

456 ià((
šdbh
->
b_couÁ
 !ğ1è|| (
šdtmp
 !ğ*
p
)) {

457 
	`b»l£
(
šdbh
);

460 *
p
 = 0;

461 *
dœt
 = 1;

462 
	`sysv_ä“_block
(
sb
,
šdblock
);

463 
dÚe
:

464 
	`b»l£
(
šdbh
);

465  
»Œy
;

466 
	}
}

468 
	$Œunc_®l
(
šode
 * inode)

470  
	`Œunc_dœeù
(
šode
)

471 | 
	`Œunc_šdœeù
(
šode
,10*
BLOCK_SIZE
,&šode->
u
.
sysv_i
.
i_d©a
[10],0,&šode->
i_dœt
)

472 | 
	`Œunc_dšdœeù
(
šode
,(10+
IND_PER_BLOCK
)*
BLOCK_SIZE
,&šode->
u
.
sysv_i
.
i_d©a
[11],0,&šode->
i_dœt
)

473 | 
	`Œunc_tšdœeù
(
šode
,(10+
IND_PER_BLOCK
+IND_PER_BLOCK*IND_PER_BLOCK)*
BLOCK_SIZE
,&šode->
u
.
sysv_i
.
i_d©a
[12],0,&šode->
i_dœt
);

474 
	}
}

477 
	$sysv_Œunÿ‹
(
šode
 * inode)

487 ià(
	`S_ISLNK
(
šode
->
i_mode
))

488 
	`´štk
("sysv_truncate:runcating symbolic†ink\n");

489 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode)))

491 ià(
šode
->
i_sb
->
sv_block_size_¿tio_b™s
 > 0) {

492 
	`coh_lock_šode
(
šode
);

493 
	`coh_Œunc_®l
(
šode
)) {

494 
cu¼’t
->
couÁ”
 = 0;

495 
	`scheduË
();

497 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

498 
šode
->
i_dœt
 = 1;

499 
	`coh_uÆock_šode
(
šode
);

501 
	`Œunc_®l
(
šode
)) {

502 
cu¼’t
->
couÁ”
 = 0;

503 
	`scheduË
();

505 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

506 
šode
->
i_dœt
 = 1;

508 
	}
}

	@fs/xiafs/bitmap.c

14 
	~<lšux/sched.h
>

15 
	~<lšux/locks.h
>

16 
	~<lšux/xŸ_fs.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/¡ršg.h
>

21 
	~"xŸfs_mac.h
"

24 
	#ş—r_b™
(
Ä
,
addr
) ({\

25 
»s
; \

26 
__asm__
 
	`__vŞ©e__
("btrl %1,%2\n\tsetnb %0": \

27 "=q" (
»s
):"r" (
Ä
),"m" (*(
addr
))); \

28 
»s
;})

	)

30 
	gš‹º®_”rÜ_mes§ge
[]="XIA-FS: internalƒrror %s %d\n";

32 
	$fšd_fœ¡_z”o
(
bufãr_h—d
 *
bh
, 
¡¬t_b™
, 
’d_b™
)

40 
’d
, 
i
, 
j
, 
tmp
;

41 
u_lÚg
 *
bm­
;

42 
»s
;

44 
bm­
=(
u_lÚg
 *)
bh
->
b_d©a
;

45 
’d
 = 
’d_b™
 >> 5;

47 
»³©
:

48 
i
=
¡¬t_b™
 >> 5;

49 iàĞ(
tmp
=(~
bm­
[
i
]è& (0xfffffffà<< (
¡¬t_b™
 & 31))) )

50 
zÚe_found
;

51 ++
i
 < 
’d
)

52 ià(~
bm­
[
i
]) {

53 
tmp
=~
bm­
[
i
];

54 
zÚe_found
;

56 iàĞ!(
tmp
=~
bm­
[
i
] & ((1 << (
’d_b™
 & 31)) -1)) )

58 
zÚe_found
:

59 
j
=0; j < 32; j++)

60 ià(
tmp
 & (1 << 
j
))

62 
	`__asm__
 ("btsl %1,%2\n\tsetb %0": \

63 "=q" (
»s
):"r" (
j
),"m" (
bm­
[
i
]));

64 ià(
»s
) {

65 
¡¬t_b™
=
j
 + (
i
 << 5) + 1;

66 
»³©
;

68 
bh
->
b_dœt
=1;

69  
j
 + (
i
 << 5);

70 
	}
}

72 
	$ş—r_buf
(
bufãr_h—d
 * 
bh
)

74 
i
;

75 * 
Í
;

77 
Í
=(*)
bh
->
b_d©a
;

78 
i
ğ
bh
->
b_size
 >> 2; i-- > 0; )

79 *
Í
++=0;

80 
	}
}

82 
	$que
(
bufãr_h—d
 * 
bm­
[], 
bzÄ
[], 
pos
)

84 
bufãr_h—d
 * 
tbh
;

85 
tmp
;

86 
i
;

88 
tbh
=
bm­
[
pos
];

89 
tmp
=
bzÄ
[
pos
];

90 
i
=
pos
; i > 0; i--) {

91 
bm­
[
i
]=bmap[i-1];

92 
bzÄ
[
i
]=bznr[i-1];

94 
bm­
[0]=
tbh
;

95 
bzÄ
[0]=
tmp
;

96 
	}
}

98 
	#g‘_im­_zÚe
(
sb
, 
b™_Ä
, 
nÙ_que
) \

99 
	`g‘__m­_zÚe
((
sb
), (sb)->
u
.
xŸfs_sb
.
s_im­_buf
, \

100 (
sb
)->
u
.
xŸfs_sb
.
s_im­_izÄ
, \

101 (
sb
)->
u
.
xŸfs_sb
.
s_im­_ÿched
, 1, \

102 (
sb
)->
u
.
xŸfs_sb
.
s_im­_zÚes
, 
_XIAFS_IMAP_SLOTS
, \

103 
b™_Ä
, 
nÙ_que
)

	)

105 
	#g‘_zm­_zÚe
(
sb
, 
b™_Ä
, 
nÙ_que
) \

106 
	`g‘__m­_zÚe
((
sb
), (sb)->
u
.
xŸfs_sb
.
s_zm­_buf
, \

107 (
sb
)->
u
.
xŸfs_sb
.
s_zm­_zzÄ
, \

108 (
sb
)->
u
.
xŸfs_sb
.
s_zm­_ÿched
, \

109 1+(
sb
)->
u
.
xŸfs_sb
.
s_im­_zÚes
, \

110 (
sb
)->
u
.
xŸfs_sb
.
s_zm­_zÚes
, 
_XIAFS_ZMAP_SLOTS
, \

111 
b™_Ä
, 
nÙ_que
)

	)

113 
bufãr_h—d
 *

114 
	$g‘__m­_zÚe
(
su³r_block
 *
sb
, 
bufãr_h—d
 * 
bm­_buf
[],

115 
bzÄ
[], 
u_ch¬
 
ÿche
, 
fœ¡_zÚe
,

116 
bm­_zÚes
, 
¦Ùs
, 
u_lÚg
 
b™_Ä
, * 
nÙ_que
)

118 
bufãr_h—d
 * 
tmp_bh
;

119 
z_Ä
, 
i
;

121 
z_Ä
 = 
b™_Ä
 >> 
	`XIAFS_BITS_PER_Z_BITS
(
sb
);

122 ià(
z_Ä
 >ğ
bm­_zÚes
) {

123 
	`´štk
("XIA-FS: bad inode/zÚnumb” (% %d)\n", 
WHERE_ERR
);

124  
NULL
;

126 ià(!
ÿche
)

127  
bm­_buf
[
z_Ä
];

128 
	`lock_su³r
(
sb
);

129 
i
=0; i < 
¦Ùs
; i++)

130 ià(
bzÄ
[
i
]==
z_Ä
)

132 ià(
i
 < 
¦Ùs
) {

133 ià(
nÙ_que
) {

134 *
nÙ_que
=
i
;

135  
bm­_buf
[
i
];

137 
	`que
(
bm­_buf
, 
bzÄ
, 
i
);

138  
bm­_buf
[0];

141 
tmp_bh
=
	`b»ad
(
sb
->
s_dev
, 
z_Ä
+
fœ¡_zÚe
, 
	`XIAFS_ZSIZE
(sb));

142 ià(!
tmp_bh
) {

143 
	`´štk
("XIA-FS:„—d b™m­ faed (% %d)\n", 
WHERE_ERR
);

144 
	`uÆock_su³r
(
sb
);

145  
NULL
;

147 
	`b»l£
(
bm­_buf
[
¦Ùs
-1]);

148 
bm­_buf
[
¦Ùs
-1]=
tmp_bh
;

149 
bzÄ
[
¦Ùs
-1]=
z_Ä
;

150 ià(
nÙ_que
)

151 *
nÙ_que
=
¦Ùs
-1;

153 
	`que
(
bm­_buf
, 
bzÄ
, 
¦Ùs
-1);

154  
tmp_bh
;

155 
	}
}

157 
	#xŸfs_uÆock_su³r
(
sb
, 
ÿche
èià(ÿcheè
	`uÆock_su³r
(sb);

	)

159 
	#g‘_ä“_ib™
(
sb
, 
´ev_b™
) \

160 
	`g‘_ä“__b™
(
sb
, sb->
u
.
xŸfs_sb
.
s_im­_buf
, \

161 
sb
->
u
.
xŸfs_sb
.
s_im­_izÄ
, \

162 
sb
->
u
.
xŸfs_sb
.
s_im­_ÿched
, \

163 1, 
sb
->
u
.
xŸfs_sb
.
s_im­_zÚes
, \

164 
_XIAFS_IMAP_SLOTS
, 
´ev_b™
);

	)

166 
	#g‘_ä“_zb™
(
sb
, 
´ev_b™
) \

167 
	`g‘_ä“__b™
(
sb
, sb->
u
.
xŸfs_sb
.
s_zm­_buf
, \

168 
sb
->
u
.
xŸfs_sb
.
s_zm­_zzÄ
, \

169 
sb
->
u
.
xŸfs_sb
.
s_zm­_ÿched
, \

170 1 + 
sb
->
u
.
xŸfs_sb
.
s_im­_zÚes
, \

171 
sb
->
u
.
xŸfs_sb
.
s_zm­_zÚes
, \

172 
_XIAFS_ZMAP_SLOTS
, 
´ev_b™
);

	)

174 
u_lÚg


175 
	$g‘_ä“__b™
(
su³r_block
 *
sb
, 
bufãr_h—d
 * 
bm­_buf
[],

176 
bzÄ
[], 
u_ch¬
 
ÿche
, 
fœ¡_zÚe
, 
bm­_zÚes
,

177 
¦Ùs
, 
u_lÚg
 
´ev_b™
)

179 
bufãr_h—d
 * 
bh
;

180 
nÙ_dÚe
=0;

181 
u_lÚg
 
pos
, 
¡¬t_b™
, 
’d_b™
, 
tÙ®_b™s
;

182 
z_Ä
, 
tmp
;

184 
tÙ®_b™s
=
bm­_zÚes
 << 
	`XIAFS_BITS_PER_Z_BITS
(
sb
);

185 ià(
´ev_b™
 >ğ
tÙ®_b™s
)

186 
´ev_b™
=0;

187 
pos
=
´ev_b™
+1;

188 
’d_b™
=
	`XIAFS_BITS_PER_Z
(
sb
);

191 ià(
pos
 >ğ
tÙ®_b™s
)

192 
pos
=0;

193 ià(!
nÙ_dÚe
) {

194 
nÙ_dÚe
=1;

195 
¡¬t_b™
ğ
pos
 & (
’d_b™
-1);

197 
¡¬t_b™
=0;

198 iàĞ
pos
 < 
´ev_b™
 &&…os+
’d_b™
 >=…rev_bit) {

199 
nÙ_dÚe
=0;

200 
’d_b™
=
´ev_b™
 & (end_bit-1);

202 
bh
 = 
	`g‘__m­_zÚe
(
sb
, 
bm­_buf
, 
bzÄ
, 
ÿche
, 
fœ¡_zÚe
,

203 
bm­_zÚes
, 
¦Ùs
, 
pos
, &
z_Ä
);

204 ià(!
bh
)

206 
tmp
=
	`fšd_fœ¡_z”o
(
bh
, 
¡¬t_b™
, 
’d_b™
);

207 ià(
tmp
 >= 0)

209 
	`xŸfs_uÆock_su³r
(
sb
, sb->
u
.
xŸfs_sb
.
s_zm­_ÿched
);

210 
pos
=Õo & ~(
’d_b™
-1))+end_bit;

211 } 
nÙ_dÚe
);

213 ià(
tmp
 < 0)

215 ià(
ÿche
)

216 
	`que
(
bm­_buf
, 
bzÄ
, 
z_Ä
);

217 
	`xŸfs_uÆock_su³r
(
sb
, 
ÿche
);

218  (
pos
 & ~(
	`XIAFS_BITS_PER_Z
(
sb
)-1))+
tmp
;

219 
	}
}

221 
	$xŸfs_ä“_zÚe
(
su³r_block
 * 
sb
, 
d_addr
)

223 
bufãr_h—d
 * 
bh
;

224 
b™
, 
off£t
;

226 ià(!
sb
) {

227 
	`´štk
(
INTERN_ERR
);

230 ià(
d_addr
 < 
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
 ||

231 
d_addr
 >ğ
sb
->
u
.
xŸfs_sb
.
s_nzÚes
) {

232 
	`´štk
("XIA-FS: bad zÚnumb” (% %d)\n", 
WHERE_ERR
);

235 
bh
 = 
	`g‘_hash_bË
(
sb
->
s_dev
, 
d_addr
, 
	`XIAFS_ZSIZE
(sb));

236 ià(
bh
)

237 
bh
->
b_dœt
=0;

238 
	`b»l£
(
bh
);

239 
b™
=
d_addr
 - 
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
 + 1;

240 
bh
 = 
	`g‘_zm­_zÚe
(
sb
, 
b™
, 
NULL
);

241 ià(!
bh
)

243 
off£t
 = 
b™
 & (
	`XIAFS_BITS_PER_Z
(
sb
) -1);

244 ià(
	`ş—r_b™
(
off£t
, 
bh
->
b_d©a
))

245 
	`´štk
("XIA-FS: dev %04x"

247 
sb
->
s_dev
, 
b™
, b™, 
WHERE_ERR
);

248 
bh
->
b_dœt
 = 1;

249 
	`xŸfs_uÆock_su³r
(
sb
, sb->
u
.
xŸfs_sb
.
s_zm­_ÿched
);

250 
	}
}

252 
	$xŸfs_Ãw_zÚe
(
su³r_block
 * 
sb
, 
u_lÚg
 
´ev_addr
)

254 
bufãr_h—d
 * 
bh
;

255 
´ev_zÄ
, 
tmp
;

257 ià(!
sb
) {

258 
	`´štk
(
INTERN_ERR
);

261 ià(
´ev_addr
 < 
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
 ||

262 
´ev_addr
 >ğ
sb
->
u
.
xŸfs_sb
.
s_nzÚes
) {

263 
´ev_addr
=
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
;

265 
´ev_zÄ
=
´ev_addr
-
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
+1;

266 
tmp
=
	`g‘_ä“_zb™
(
sb
, 
´ev_zÄ
);

267 ià(!
tmp
)

269 
tmp
 +ğ
sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
 -1;

270 ià(!(
bh
 = 
	`g‘blk
(
sb
->
s_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(sb)))) {

271 
	`´štk
("XIA-FS: I/Oƒ¼Ü (% %d)\n", 
WHERE_ERR
);

274 ià(
bh
->
b_couÁ
 != 1) {

275 
	`´štk
(
INTERN_ERR
);

278 
	`ş—r_buf
(
bh
);

279 
bh
->
b_u±od©e
 = 1;

280 
bh
->
b_dœt
 = 1;

281 
	`b»l£
(
bh
);

282  
tmp
;

283 
	}
}

285 
	$xŸfs_ä“_šode
(
šode
 * inode)

287 
bufãr_h—d
 * 
bh
;

288 
su³r_block
 * 
sb
;

289 
šo
;

291 ià(!
šode
)

293 ià(!
šode
->
i_dev
 || inode->
i_couÁ
!=1 || inode->
i_Æšk
 || !šode->
i_sb
 ||

294 
šode
->
i_šo
 < 3 || inode->i_šØ> inode->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
) {

295 
	`´štk
("XIA-FS: bad inod(% %d)\n", 
WHERE_ERR
);

298 
sb
 = 
šode
->
i_sb
;

299 
šo
 = 
šode
->
i_šo
;

300 
bh
 = 
	`g‘_im­_zÚe
(
sb
, 
šo
, 
NULL
);

301 ià(!
bh
)

303 
	`ş—r_šode
(
šode
);

304 ià(
	`ş—r_b™
(
šo
 & (
	`XIAFS_BITS_PER_Z
(
sb
)-1), 
bh
->
b_d©a
))

305 
	`´štk
("XIA-FS: dev %04x"

307 
šode
->
i_dev
, 
šo
, ino, 
WHERE_ERR
);

308 
bh
->
b_dœt
 = 1;

309 
	`xŸfs_uÆock_su³r
(
sb
, sb->
u
.
xŸfs_sb
.
s_im­_ÿched
);

310 
	}
}

312 
šode
 * 
	$xŸfs_Ãw_šode
(
šode
 * 
dœ
)

314 
su³r_block
 * 
sb
;

315 
šode
 * inode;

316 
šo_t
 
tmp
;

318 
sb
 = 
dœ
->
i_sb
;

319 ià(!
dœ
 || !(
šode
 = 
	`g‘_em±y_šode
()))

320  
NULL
;

321 
šode
->
i_sb
 = 
sb
;

322 
šode
->
i_æags
 = inode->
i_sb
->
s_æags
;

324 
tmp
=
	`g‘_ä“_ib™
(
sb
, 
dœ
->
i_šo
);

325 ià(!
tmp
) {

326 
	`ut
(
šode
);

327  
NULL
;

329 
šode
->
i_couÁ
 = 1;

330 
šode
->
i_Æšk
 = 1;

331 
šode
->
i_dev
 = 
sb
->
s_dev
;

332 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

333 
šode
->
i_gid
 = (
dœ
->
i_mode
 & 
S_ISGID
è? dœ->i_gid : 
cu¼’t
->
egid
;

334 
šode
->
i_dœt
 = 1;

335 
šode
->
i_šo
 = 
tmp
;

336 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

337 
šode
->
i_İ
 = 
NULL
;

338 
šode
->
i_blocks
 = 0;

339 
šode
->
i_blksize
 = 
	`XIAFS_ZSIZE
(šode->
i_sb
);

340 
	`š£¹_šode_hash
(
šode
);

341  
šode
;

342 
	}
}

344 
	gnibbËm­
[] = { 0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4 };

346 
u_lÚg
 
	$couÁ_zÚe
(
bufãr_h—d
 * 
bh
)

348 
i
, 
tmp
;

349 
u_lÚg
 
sum
;

351 
sum
=0;

352 
i
=
bh
->
b_size
; i-- > 0; ) {

353 
tmp
=
bh
->
b_d©a
[
i
];

354 
sum
 +ğ
nibbËm­
[
tmp
 & 0xf] +‚ibblemap[(tmp & 0xff) >> 4];

356  
sum
;

357 
	}
}

359 
	$xŸfs_couÁ_ä“_šodes
(
su³r_block
 *
sb
)

361 
bufãr_h—d
 * 
bh
;

362 
izÚes
, 
i
, 
nÙ_que
;

363 
u_lÚg
 
sum
;

365 
sum
=0;

366 
izÚes
=
sb
->
u
.
xŸfs_sb
.
s_im­_zÚes
;

367 
i
=0; i < 
izÚes
; i++) {

368 
bh
=
	`g‘_im­_zÚe
(
sb
, 
i
 << 
	`XIAFS_BITS_PER_Z_BITS
(sb), &
nÙ_que
);

369 ià(
bh
) {

370 
sum
 +ğ
	`couÁ_zÚe
(
bh
);

371 
	`xŸfs_uÆock_su³r
(
sb
, sb->
u
.
xŸfs_sb
.
s_im­_ÿched
);

374 
i
=
izÚes
 << 
	`XIAFS_BITS_PER_Z_BITS
(
sb
);

375  
i
 - 
sum
;

376 
	}
}

378 
	$xŸfs_couÁ_ä“_zÚes
(
su³r_block
 *
sb
)

380 
bufãr_h—d
 * 
bh
;

381 
zzÚes
, 
i
, 
nÙ_que
;

382 
u_lÚg
 
sum
;

384 
sum
=0;

385 
zzÚes
=
sb
->
u
.
xŸfs_sb
.
s_zm­_zÚes
;

386 
i
=0; i < 
zzÚes
; i++) {

387 
bh
=
	`g‘_zm­_zÚe
(
sb
, 
i
 << 
	`XIAFS_BITS_PER_Z_BITS
(sb), &
nÙ_que
);

388 ià(
bh
) {

389 
sum
 +ğ
	`couÁ_zÚe
(
bh
);

390 
	`xŸfs_uÆock_su³r
(
sb
, sb->
u
.
xŸfs_sb
.
s_zm­_ÿched
);

393 
i
=
zzÚes
 << 
	`XIAFS_BITS_PER_Z_BITS
(
sb
);

394  
i
 - 
sum
;

395 
	}
}

	@fs/xiafs/dir.c

12 
	~<asm/£gm’t.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/xŸ_fs.h
>

18 
	~<lšux/¡©.h
>

20 
	~"xŸfs_mac.h
"

22 
xŸfs_dœ_»ad
(
šode
 *, 
fe
 *, *, );

23 
xŸfs_»addœ
(
šode
 *, 
fe
 *, 
dœ’t
 *, );

25 
fe_İ”©iÚs
 
	gxŸfs_dœ_İ”©iÚs
 = {

26 
NULL
,

27 
xŸfs_dœ_»ad
,

28 
NULL
,

29 
xŸfs_»addœ
,

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
fe_fsync


41 
šode_İ”©iÚs
 
	gxŸfs_dœ_šode_İ”©iÚs
 = {

42 &
xŸfs_dœ_İ”©iÚs
,

43 
xŸfs_ü—‹
,

44 
xŸfs_lookup
,

45 
xŸfs_lšk
,

46 
xŸfs_uÆšk
,

47 
xŸfs_symlšk
,

48 
xŸfs_mkdœ
,

49 
xŸfs_rmdœ
,

50 
xŸfs_mknod
,

51 
xŸfs_»Çme
,

52 
NULL
,

53 
NULL
,

54 
NULL
,

55 
xŸfs_Œunÿ‹
,

56 
NULL


59 
	$xŸfs_dœ_»ad
(
šode
 * inode,

60 
fe
 * 
fp
, * 
buf
, 
couÁ
)

62  -
EISDIR
;

63 
	}
}

65 
	$xŸfs_»addœ
(
šode
 * inode,

66 
fe
 * 
fp
, 
dœ’t
 * dœ’t, 
couÁ
)

68 
u_št
 
off£t
, 
i
;

69 
bufãr_h—d
 * 
bh
;

70 
xŸfs_dœeù
 * 
de
;

72 ià(!
šode
 || !šode->
i_sb
 || !
	`S_ISDIR
(šode->
i_mode
))

73  -
EBADF
;

74 ià(
šode
->
i_size
 & (
	`XIAFS_ZSIZE
(šode->
i_sb
) - 1) )

75  -
EBADF
;

76 
fp
->
f_pos
 < 
šode
->
i_size
) {

77 
off£t
 = 
fp
->
f_pos
 & (
	`XIAFS_ZSIZE
(
šode
->
i_sb
) - 1);

78 
bh
 = 
	`xŸfs_b»ad
(
šode
, 
fp
->
f_pos
 >> 
	`XIAFS_ZSIZE_BITS
(šode->
i_sb
),0);

79 ià(!
bh
) {

80 
fp
->
f_pos
 +ğ
	`XIAFS_ZSIZE
(
šode
->
i_sb
)-
off£t
;

83 
de
 = (
xŸfs_dœeù
 *è(
off£t
 + 
bh
->
b_d©a
);

84 
off£t
 < 
	`XIAFS_ZSIZE
(
šode
->
i_sb
è&& 
fp
->
f_pos
 < inode->
i_size
) {

85 ià(
de
->
d_šo
 > 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
 ||

86 
de
->
d_»c_Ën
 < 12 ||

87 (*)
de
+de->
d_»c_Ën
 > 
	`XIAFS_ZSIZE
(
šode
->
i_sb
)+
bh
->
b_d©a
 ||

88 
de
->
d_Çme_Ën
 < 1 || de->d_Çme_ËÀ+ 8 > de->
d_»c_Ën
 ||

89 
de
->
d_Çme_Ën
 > 
_XIAFS_NAME_LEN
 ||

90 
de
->
d_Çme
[de->
d_Çme_Ën
] ) {

91 
	`´štk
("XIA-FS: bad dœeùÜyƒÁry (% %d)\n", 
WHERE_ERR
);

92 
	`b»l£
(
bh
);

95 
off£t
 +ğ
de
->
d_»c_Ën
;

96 
fp
->
f_pos
 +ğ
de
->
d_»c_Ën
;

97 ià(
de
->
d_šo
) {

98 
i
 = 0; i < 
de
->
d_Çme_Ën
 ; i++)

99 
	`put_fs_by‹
(
de
->
d_Çme
[
i
],i+
dœ’t
->d_name);

100 
	`put_fs_by‹
(0,
i
+
dœ’t
->
d_Çme
);

101 
	`put_fs_lÚg
(
de
->
d_šo
,&
dœ’t
->d_ino);

102 
	`put_fs_wÜd
(
i
,&
dœ’t
->
d_»ş’
);

103 
	`b»l£
(
bh
);

104 ià(!
	`IS_RDONLY
 (
šode
)) {

105 
šode
->
i_©ime
=
CURRENT_TIME
;

106 
šode
->
i_dœt
=1;

108  
i
;

110 
de
 = (
xŸfs_dœeù
 *è(
off£t
 + 
bh
->
b_d©a
);

112 
	`b»l£
(
bh
);

113 ià(
off£t
 > 
	`XIAFS_ZSIZE
(
šode
->
i_sb
)) {

114 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

118 ià(!
	`IS_RDONLY
 (
šode
)) {

119 
šode
->
i_©ime
=
CURRENT_TIME
;

120 
šode
->
i_dœt
=1;

123 
	}
}

	@fs/xiafs/file.c

12 
	~<asm/£gm’t.h
>

13 
	~<asm/sy¡em.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/xŸ_fs.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/fú.h
>

21 
	~<lšux/¡©.h
>

22 
	~<lšux/locks.h
>

24 
	~"xŸfs_mac.h
"

26 
	#NBUF
 32

	)

28 
	#MIN
(
a
,
b
è((×)<(b))?×):(b))

	)

29 
	#MAX
(
a
,
b
è((×)>(b))?×):(b))

	)

31 
xŸfs_fe_»ad
(
šode
 *, 
fe
 *, *, );

32 
xŸfs_fe_wr™e
(
šode
 *, 
fe
 *, *, );

38 
fe_İ”©iÚs
 
	gxŸfs_fe_İ”©iÚs
 = {

39 
NULL
,

40 
xŸfs_fe_»ad
,

41 
xŸfs_fe_wr™e
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
g’”ic_mm­
,

46 
NULL
,

47 
NULL
,

48 
xŸfs_sync_fe


51 
šode_İ”©iÚs
 
	gxŸfs_fe_šode_İ”©iÚs
 = {

52 &
xŸfs_fe_İ”©iÚs
,

53 
NULL
,

54 
NULL
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NULL
,

63 
NULL
,

64 
xŸfs_bm­
,

65 
xŸfs_Œunÿ‹
,

66 
NULL


70 
	$xŸfs_fe_»ad
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

72 
»ad
, 
Ëá
, 
ch¬s
;

73 
zÚe_Ä
, 
zÚes
, 
f_zÚes
, 
off£t
;

74 
bh»que¡
, 
u±od©e
;

75 
bufãr_h—d
 ** 
bhb
, ** 
bhe
;

76 
bufãr_h—d
 * 
bh»q
[
NBUF
];

77 
bufãr_h—d
 * 
buæi¡
[
NBUF
];

79 ià(!
šode
) {

80 
	`´štk
("XIA-FS: inodğNULL (% %d)\n", 
WHERE_ERR
);

81  -
EINVAL
;

83 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

84 
	`´štk
("XIA-FS: mod!ğ»guÏ¸(% %d)\n", 
WHERE_ERR
);

85  -
EINVAL
;

87 
off£t
 = 
fp
->
f_pos
;

88 
Ëá
 = 
šode
->
i_size
 - 
off£t
;

89 ià(
Ëá
 > 
couÁ
)

90 
Ëá
 = 
couÁ
;

91 ià(
Ëá
 <= 0)

93 
»ad
 = 0;

94 
zÚe_Ä
 = 
off£t
 >> 
	`XIAFS_ZSIZE_BITS
(
šode
->
i_sb
);

95 
off£t
 &ğ
	`XIAFS_ZSIZE
(
šode
->
i_sb
) -1 ;

96 
f_zÚes
 =(
šode
->
i_size
+
	`XIAFS_ZSIZE
(šode->
i_sb
)-1)>>
	`XIAFS_ZSIZE_BITS
(inode->i_sb);

97 
zÚes
 = (
Ëá
+
off£t
+
	`XIAFS_ZSIZE
(
šode
->
i_sb
)-1è>> 
	`XIAFS_ZSIZE_BITS
(inode->i_sb);

98 
bhb
 = 
bhe
 = 
buæi¡
;

99 ià(
fp
->
f_»ada
) {

100 
zÚes
 +ğ
»ad_ah—d
[
	`MAJOR
(
šode
->
i_dev
)] >> (1+
	`XIAFS_ZSHIFT
(šode->
i_sb
));

101 ià(
zÚe_Ä
 + 
zÚes
 > 
f_zÚes
)

102 
zÚes
 = 
f_zÚes
 - 
zÚe_Ä
;

116 
bh»que¡
 = 0;

117 
u±od©e
 = 1;

118 
zÚes
--) {

119 *
bhb
 = 
	`xŸfs_g‘blk
(
šode
, 
zÚe_Ä
++, 0);

120 ià(*
bhb
 && !(*bhb)->
b_u±od©e
) {

121 
u±od©e
 = 0;

122 
bh»q
[
bh»que¡
++] = *
bhb
;

125 ià(++
bhb
 =ğ&
buæi¡
[
NBUF
])

126 
bhb
 = 
buæi¡
;

130 ià(
u±od©e
)

132 ià(
bhb
 =ğ
bhe
)

137 ià(
bh»que¡
)

138 
	`Î_rw_block
(
READ
, 
bh»que¡
, 
bh»q
);

141 ià(*
bhe
) {

142 
	`wa™_Ú_bufãr
(*
bhe
);

143 ià(!(*
bhe
)->
b_u±od©e
) {

144 
	`b»l£
(*
bhe
);

145 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

146 
bhe
 = 
buæi¡
;

147 
Ëá
 = 0;

151 ià(
Ëá
 < 
	`XIAFS_ZSIZE
(
šode
->
i_sb
è- 
off£t
)

152 
ch¬s
 = 
Ëá
;

154 
ch¬s
 = 
	`XIAFS_ZSIZE
(
šode
->
i_sb
è- 
off£t
;

155 
fp
->
f_pos
 +ğ
ch¬s
;

156 
Ëá
 -ğ
ch¬s
;

157 
»ad
 +ğ
ch¬s
;

158 ià(*
bhe
) {

159 
	`memıy_tofs
(
buf
,
off£t
+(*
bhe
)->
b_d©a
,
ch¬s
);

160 
	`b»l£
(*
bhe
);

161 
buf
 +ğ
ch¬s
;

163 
ch¬s
-->0)

164 
	`put_fs_by‹
(0,
buf
++);

166 
off£t
 = 0;

167 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

168 
bhe
 = 
buæi¡
;

169 } 
Ëá
 > 0 && 
bhe
 !ğ
bhb
 && (!*bh|| !(*bhe)->
b_lock
));

170 } 
Ëá
 > 0);

173 
bhe
 !ğ
bhb
) {

174 
	`b»l£
(*
bhe
);

175 ià(++
bhe
 =ğ&
buæi¡
[
NBUF
])

176 
bhe
 = 
buæi¡
;

178 ià(!
»ad
)

179  -
EIO
;

180 
fp
->
f_»ada
 = 1;

181 ià(!
	`IS_RDONLY
 (
šode
)) {

182 
šode
->
i_©ime
 = 
CURRENT_TIME
;

183 
šode
->
i_dœt
 = 1;

185  
»ad
;

186 
	}
}

189 
	$xŸfs_fe_wr™e
(
šode
 * inode, 
fe
 * 
fp
, * 
buf
, 
couÁ
)

191 
off_t
 
pos
;

192 
wr™‹n
, 
c
;

193 
bufãr_h—d
 * 
bh
;

194 * 
ı
;

196 ià(!
šode
) {

197 
	`´štk
("XIA-FS: inodğNULL (% %d)\n", 
WHERE_ERR
);

198  -
EINVAL
;

200 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

201 
	`´štk
("XIA-FS: mod!ğ»guÏ¸(% %d)\n", 
WHERE_ERR
);

202  -
EINVAL
;

208 ià(
fp
->
f_æags
 & 
O_APPEND
)

209 
pos
 = 
šode
->
i_size
;

211 
pos
 = 
fp
->
f_pos
;

212 
wr™‹n
 = 0;

213 
wr™‹n
 < 
couÁ
) {

214 
bh
 = 
	`xŸfs_g‘blk
(
šode
, 
pos
 >> 
	`XIAFS_ZSIZE_BITS
(šode->
i_sb
), 1);

215 ià(!
bh
) {

216 ià(!
wr™‹n
)

217 
wr™‹n
 = -
ENOSPC
;

220 
c
 = 
	`XIAFS_ZSIZE
(
šode
->
i_sb
è- (
pos
 & (XIAFS_ZSIZE(inode->i_sb) - 1));

221 ià(
c
 > 
couÁ
-
wr™‹n
)

222 
c
 = 
couÁ
-
wr™‹n
;

223 ià(
c
 !ğ
	`XIAFS_ZSIZE
(
šode
->
i_sb
è&& !
bh
->
b_u±od©e
) {

224 
	`Î_rw_block
(
READ
, 1, &
bh
);

225 
	`wa™_Ú_bufãr
(
bh
);

226 ià(!
bh
->
b_u±od©e
) {

227 
	`b»l£
(
bh
);

228 ià(!
wr™‹n
)

229 
wr™‹n
 = -
EIO
;

233 
ı
 = (
pos
 & (
	`XIAFS_ZSIZE
(
šode
->
i_sb
)-1)è+ 
bh
->
b_d©a
;

234 
pos
 +ğ
c
;

235 ià(
pos
 > 
šode
->
i_size
) {

236 
šode
->
i_size
 = 
pos
;

237 
šode
->
i_dœt
 = 1;

239 
wr™‹n
 +ğ
c
;

240 
	`memıy_äomfs
(
ı
,
buf
,
c
);

241 
buf
 +ğ
c
;

242 
bh
->
b_u±od©e
 = 1;

243 
bh
->
b_dœt
 = 1;

244 
	`b»l£
(
bh
);

246 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME
;

247 
fp
->
f_pos
 = 
pos
;

248 
šode
->
i_dœt
 = 1;

250  
wr™‹n
;

251 
	}
}

	@fs/xiafs/fsync.c

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/¡©.h
>

17 
	~<lšux/fú.h
>

18 
	~<lšux/locks.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/xŸ_fs.h
>

23 
	~"xŸfs_mac.h
"

26 
	#blocksize
 (
	`XIAFS_ZSIZE
(
šode
->
i_sb
))

	)

27 
	#addr_³r_block
 (
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
))

	)

29 
	$sync_block
 (
šode
 * inode, * 
block
, 
wa™
)

31 
bufãr_h—d
 * 
bh
;

32 
tmp
;

34 ià(!*
block
)

36 
tmp
 = *
block
;

37 
bh
 = 
	`g‘_hash_bË
(
šode
->
i_dev
, *
block
, 
blocksize
);

38 ià(!
bh
)

40 ià(*
block
 !ğ
tmp
) {

41 
	`b»l£
 (
bh
);

44 ià(
wa™
 && 
bh
->
b_»q
 && !bh->
b_u±od©e
) {

45 
	`b»l£
(
bh
);

48 ià(
wa™
 || !
bh
->
b_u±od©e
 || !bh->
b_dœt
)

50 
	`b»l£
(
bh
);

53 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

54 
bh
->
b_couÁ
--;

56 
	}
}

58 
	$sync_iblock
 (
šode
 * inode, * 
iblock
,

59 
bufãr_h—d
 **
bh
, 
wa™
)

61 
rc
, 
tmp
;

63 *
bh
 = 
NULL
;

64 
tmp
 = *
iblock
;

65 ià(!
tmp
)

67 
rc
 = 
	`sync_block
 (
šode
, 
iblock
, 
wa™
);

68 ià(
rc
)

69  
rc
;

70 *
bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
blocksize
);

71 ià(
tmp
 !ğ*
iblock
) {

72 
	`b»l£
(*
bh
);

73 *
bh
 = 
NULL
;

76 ià(!*
bh
)

79 
	}
}

82 
	$sync_dœeù
(
šode
 *šode, 
wa™
)

84 
i
;

85 
rc
, 
”r
 = 0;

87 
i
 = 0; i < 8; i++) {

88 
rc
 = 
	`sync_block
 (
šode
, inode->
u
.
ext_i
.
i_d©a
 + 
i
, 
wa™
);

89 ià(
rc
 > 0)

91 ià(
rc
)

92 
”r
 = 
rc
;

94  
”r
;

95 
	}
}

97 
	$sync_šdœeù
(
šode
 *šode, *
iblock
, 
wa™
)

99 
i
;

100 
bufãr_h—d
 * 
šd_bh
;

101 
rc
, 
”r
 = 0;

103 
rc
 = 
	`sync_iblock
 (
šode
, 
iblock
, &
šd_bh
, 
wa™
);

104 ià(
rc
 || !
šd_bh
)

105  
rc
;

107 
i
 = 0; i < 
addr_³r_block
; i++) {

108 
rc
 = 
	`sync_block
 (
šode
,

109 ((*è
šd_bh
->
b_d©a
è+ 
i
,

110 
wa™
);

111 ià(
rc
 > 0)

113 ià(
rc
)

114 
”r
 = 
rc
;

116 
	`b»l£
(
šd_bh
);

117  
”r
;

118 
	}
}

120 
	$sync_dšdœeù
(
šode
 *šode, *
diblock
,

121 
wa™
)

123 
i
;

124 
bufãr_h—d
 * 
dšd_bh
;

125 
rc
, 
”r
 = 0;

127 
rc
 = 
	`sync_iblock
 (
šode
, 
diblock
, &
dšd_bh
, 
wa™
);

128 ià(
rc
 || !
dšd_bh
)

129  
rc
;

131 
i
 = 0; i < 
addr_³r_block
; i++) {

132 
rc
 = 
	`sync_šdœeù
 (
šode
,

133 ((*è
dšd_bh
->
b_d©a
è+ 
i
,

134 
wa™
);

135 ià(
rc
 > 0)

137 ià(
rc
)

138 
”r
 = 
rc
;

140 
	`b»l£
(
dšd_bh
);

141  
”r
;

142 
	}
}

144 
	$xŸfs_sync_fe
(
šode
 * inode, 
fe
 * file)

146 
wa™
, 
”r
 = 0;

148 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

149 
	`S_ISLNK
(
šode
->
i_mode
)))

150  -
EINVAL
;

151 
wa™
=0; wait<=1; wait++)

153 
”r
 |ğ
	`sync_dœeù
(
šode
, 
wa™
);

154 
”r
 |ğ
	`sync_šdœeù
(
šode
, &šode->
u
.
xŸfs_i
.
i_šd_zÚe
, 
wa™
);

155 
”r
 |ğ
	`sync_dšdœeù
(
šode
, &šode->
u
.
xŸfs_i
.
i_dšd_zÚe
, 
wa™
);

157 
”r
 |ğ
	`xŸfs_sync_šode
 (
šode
);

158  (
”r
 < 0è? -
EIO
 : 0;

159 
	}
}

	@fs/xiafs/inode.c

12 
	~<lšux/sched.h
>

13 
	~<lšux/xŸ_fs.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/locks.h
>

19 
	~<asm/sy¡em.h
>

20 
	~<asm/£gm’t.h
>

22 
	~"xŸfs_mac.h
"

24 
u_lÚg
 
	g¿ndom_Ä
;

26 
	$xŸfs_put_šode
(
šode
 *inode)

28 ià(
šode
->
i_Æšk
)

30 
šode
->
i_size
 = 0;

31 
	`xŸfs_Œunÿ‹
(
šode
);

32 
	`xŸfs_ä“_šode
(
šode
);

33 
	}
}

35 
	$xŸfs_put_su³r
(
su³r_block
 *
sb
)

37 
i
;

39 
	`lock_su³r
(
sb
);

40 
sb
->
s_dev
 = 0;

41 
i
 = 0 ; i < 
_XIAFS_IMAP_SLOTS
 ; i++)

42 
	`b»l£
(
sb
->
u
.
xŸfs_sb
.
s_im­_buf
[
i
]);

43 
i
 = 0 ; i < 
_XIAFS_ZMAP_SLOTS
 ; i++)

44 
	`b»l£
(
sb
->
u
.
xŸfs_sb
.
s_zm­_buf
[
i
]);

45 
	`uÆock_su³r
(
sb
);

46 
	}
}

48 
su³r_İ”©iÚs
 
	gxŸfs_sİs
 = {

49 
xŸfs_»ad_šode
,

50 
NULL
,

51 
xŸfs_wr™e_šode
,

52 
xŸfs_put_šode
,

53 
xŸfs_put_su³r
,

54 
NULL
,

55 
xŸfs_¡©fs
,

56 
NULL


59 
su³r_block
 *
	$xŸfs_»ad_su³r
(
su³r_block
 *
s
, *
d©a
,

60 
s’t
)

62 
bufãr_h—d
 *
bh
;

63 
xŸfs_su³r_block
 *
¥
;

64 
i
, 
z
, 
dev
;

66 
dev
=
s
->
s_dev
;

67 
	`lock_su³r
(
s
);

69 
	`£t_blocksize
(
dev
, 
BLOCK_SIZE
);

71 ià(!(
bh
 = 
	`b»ad
(
dev
, 0, 
BLOCK_SIZE
))) {

72 
s
->
s_dev
=0;

73 
	`uÆock_su³r
(
s
);

74 
	`´štk
("XIA-FS:„—d su³r_block faed (% %d)\n", 
WHERE_ERR
);

75  
NULL
;

77 
¥
 = (
xŸfs_su³r_block
 *è
bh
->
b_d©a
;

78 
s
->
s_magic
 = 
¥
->s_magic;

79 ià(
s
->
s_magic
 !ğ
_XIAFS_SUPER_MAGIC
) {

80 
s
->
s_dev
 = 0;

81 
	`uÆock_su³r
(
s
);

82 
	`b»l£
(
bh
);

83 ià(!
s’t
)

84 
	`´štk
("VFS: Can't find‡ xiafs filesystem on dev 0x%04x.\n",

85 
dev
);

86  
NULL
;

88 
s
->
s_blocksize
 = 
¥
->
s_zÚe_size
;

89 
s
->
s_blocksize_b™s
 = 10 + 
¥
->
s_zÚe_shiá
;

90 ià(
s
->
s_blocksize
 !ğ
BLOCK_SIZE
 &&

91 (
s
->
s_blocksize
 == 1024 || s->s_blocksize == 2048 ||

92 
s
->
s_blocksize
 == 4096)) {

93 
	`b»l£
(
bh
);

94 
	`£t_blocksize
(
dev
, 
s
->
s_blocksize
);

95 
bh
 = 
	`b»ad
 (
dev
, 0, 
s
->
s_blocksize
);

96 if(!
bh
è 
NULL
;

97 
¥
 = (
xŸfs_su³r_block
 *è(((*)
bh
->
b_d©a
è+ 
BLOCK_SIZE
) ;

99 
s
->
u
.
xŸfs_sb
.
s_nzÚes
 = 
¥
->s_nzones;

100 
s
->
u
.
xŸfs_sb
.
s_nšodes
 = 
¥
->s_ninodes;

101 
s
->
u
.
xŸfs_sb
.
s_nd©azÚes
 = 
¥
->s_ndatazones;

102 
s
->
u
.
xŸfs_sb
.
s_im­_zÚes
 = 
¥
->s_imap_zones;

103 
s
->
u
.
xŸfs_sb
.
s_zm­_zÚes
 = 
¥
->s_zmap_zones;

104 
s
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
 = 
¥
->s_firstdatazone;

105 
s
->
u
.
xŸfs_sb
.
s_zÚe_shiá
 = 
¥
->s_zone_shift;

106 
s
->
u
.
xŸfs_sb
.
s_max_size
 = 
¥
->s_max_size;

107 
	`b»l£
(
bh
);

108 
i
=0;˜< 
_XIAFS_IMAP_SLOTS
;i++) {

109 
s
->
u
.
xŸfs_sb
.
s_im­_buf
[
i
] = 
NULL
;

110 
s
->
u
.
xŸfs_sb
.
s_im­_izÄ
[
i
] = -1;

112 
i
=0;˜< 
_XIAFS_ZMAP_SLOTS
;i++) {

113 
s
->
u
.
xŸfs_sb
.
s_zm­_buf
[
i
] = 
NULL
;

114 
s
->
u
.
xŸfs_sb
.
s_zm­_zzÄ
[
i
] = -1;

116 
z
=1;

117 iàĞ
s
->
u
.
xŸfs_sb
.
s_im­_zÚes
 > 
_XIAFS_IMAP_SLOTS
 )

118 
s
->
u
.
xŸfs_sb
.
s_im­_ÿched
=1;

120 
s
->
u
.
xŸfs_sb
.
s_im­_ÿched
=0;

121 
i
=0 ; i < 
s
->
u
.
xŸfs_sb
.
s_im­_zÚes
 ; i++) {

122 ià(!(
s
->
u
.
xŸfs_sb
.
s_im­_buf
[
i
]=
	`b»ad
(
dev
, 
z
++, 
	`XIAFS_ZSIZE
(s))))

123 
xŸfs_»ad_su³r_ç
;

124 
s
->
u
.
xŸfs_sb
.
s_im­_izÄ
[
i
]=i;

127 iàĞ
s
->
u
.
xŸfs_sb
.
s_zm­_zÚes
 > 
_XIAFS_ZMAP_SLOTS
 )

128 
s
->
u
.
xŸfs_sb
.
s_zm­_ÿched
=1;

130 
s
->
u
.
xŸfs_sb
.
s_zm­_ÿched
=0;

131 
i
=0 ; i < 
s
->
u
.
xŸfs_sb
.
s_zm­_zÚes
 ; i++) {

132 ià(!(
s
->
u
.
xŸfs_sb
.
s_zm­_buf
[
i
]=
	`b»ad
(
dev
, 
z
++, 
	`XIAFS_ZSIZE
(s))))

133 
xŸfs_»ad_su³r_ç
;

134 
s
->
u
.
xŸfs_sb
.
s_zm­_zzÄ
[
i
]=i;

138 
s
->
s_dev
 = 
dev
;

139 
s
->
s_İ
 = &
xŸfs_sİs
;

140 
s
->
s_mouÁed
 = 
	`ig‘
(s, 
_XIAFS_ROOT_INO
);

141 ià(!
s
->
s_mouÁed
)

142 
xŸfs_»ad_su³r_ç
;

143 
	`uÆock_su³r
(
s
);

144 
¿ndom_Ä
=
CURRENT_TIME
;

145  
s
;

147 
xŸfs_»ad_su³r_ç
:

148 
i
=0; i < 
_XIAFS_IMAP_SLOTS
; i++)

149 
	`b»l£
(
s
->
u
.
xŸfs_sb
.
s_im­_buf
[
i
]);

150 
i
=0; i < 
_XIAFS_ZMAP_SLOTS
; i++)

151 
	`b»l£
(
s
->
u
.
xŸfs_sb
.
s_zm­_buf
[
i
]);

152 
s
->
s_dev
=0;

153 
	`uÆock_su³r
(
s
);

154 
	`´štk
("XIA-FS:„—d b™m­ çed (% %d)\n", 
WHERE_ERR
);

155  
NULL
;

156 
	}
}

158 
	$xŸfs_¡©fs
(
su³r_block
 *
sb
, 
¡©fs
 *
buf
)

160 
tmp
;

162 
	`put_fs_lÚg
(
_XIAFS_SUPER_MAGIC
, &
buf
->
f_ty³
);

163 
	`put_fs_lÚg
(
	`XIAFS_ZSIZE
(
sb
), &
buf
->
f_bsize
);

164 
	`put_fs_lÚg
(
sb
->
u
.
xŸfs_sb
.
s_nd©azÚes
, &
buf
->
f_blocks
);

165 
tmp
 = 
	`xŸfs_couÁ_ä“_zÚes
(
sb
);

166 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bä“
);

167 
	`put_fs_lÚg
(
tmp
, &
buf
->
f_bava
);

168 
	`put_fs_lÚg
(
sb
->
u
.
xŸfs_sb
.
s_nšodes
, &
buf
->
f_fes
);

169 
	`put_fs_lÚg
(
	`xŸfs_couÁ_ä“_šodes
(
sb
), &
buf
->
f_fä“
);

170 
	`put_fs_lÚg
(
_XIAFS_NAME_LEN
, &
buf
->
f_Çm–’
);

172 
	}
}

174 
	$zÚe_bm­
(
bufãr_h—d
 * 
bh
, 
Ä
)

176 
tmp
;

178 ià(!
bh
)

180 
tmp
 = ((
u_lÚg
 *è
bh
->
b_d©a
)[
Ä
];

181 
	`b»l£
(
bh
);

182  
tmp
;

183 
	}
}

185 
	$xŸfs_bm­
(
šode
 * inode,
zÚe
)

187 
i
;

189 ià(
zÚe
 < 0) {

190 
	`´štk
("XIA-FS: block < 0 (% %d)\n", 
WHERE_ERR
);

193 ià(
zÚe
 >ğ8+(1+
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
))*XIAFS_ADDRS_PER_Z(inode->i_sb)) {

194 
	`´štk
("XIA-FS: zÚ> big (% %d)\n", 
WHERE_ERR
);

197 ià(!
	`IS_RDONLY
 (
šode
)) {

198 
šode
->
i_©ime
 = 
CURRENT_TIME
;

199 
šode
->
i_dœt
 = 1;

201 ià(
zÚe
 < 8)

202  
šode
->
u
.
xŸfs_i
.
i_zÚe
[
zÚe
];

203 
zÚe
 -= 8;

204 ià(
zÚe
 < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)) {

205 
i
 = 
šode
->
u
.
xŸfs_i
.
i_šd_zÚe
;

206 ià(
i
)

207 
i
 = 
	`zÚe_bm­
(
	`b»ad
(
šode
->
i_dev
, i, 
	`XIAFS_ZSIZE
(šode->
i_sb
)), 
zÚe
);

208  
i
;

210 
zÚe
 -ğ
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
);

211 
i
 = 
šode
->
u
.
xŸfs_i
.
i_dšd_zÚe
;

212 ià(
i
)

213 
i
 = 
	`zÚe_bm­
(
	`b»ad
(
šode
->
i_dev
, i, 
	`XIAFS_ZSIZE
(šode->
i_sb
)),

214 
zÚe
 >> 
	`XIAFS_ADDRS_PER_Z_BITS
(
šode
->
i_sb
));

215 ià(
i
)

216 
i
ğ
	`zÚe_bm­
(
	`b»ad
(
šode
->
i_dev
,i, 
	`XIAFS_ZSIZE
(šode->
i_sb
)),

217 
zÚe
 & (
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)-1));

218  
i
;

219 
	}
}

221 
u_lÚg
 
	$g‘_´ev_addr
(
šode
 * inode, 
zÚe
)

223 
u_lÚg
 
tmp
;

225 ià(
zÚe
 > 0)

226 --
zÚe
 >= 0)

227 ià((
tmp
=
	`xŸfs_bm­
(
šode
, 
zÚe
)))

228  
tmp
;

229 
¿ndom_Ä
=Ôªdom_Ä+23)%
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nd©azÚes
;

230  
¿ndom_Ä
 + 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_fœ¡d©azÚe
;

231 
	}
}

233 
bufãr_h—d
 *

234 
	$dt_g‘blk
(
šode
 * inode, 
u_lÚg
 *
Í
, 
ü—‹
, u_lÚg 
´ev_addr
)

236 
tmp
;

237 
bufãr_h—d
 * 
»suÉ
;

239 
»³©
:

240 ià((
tmp
=*
Í
)) {

241 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

242 ià(
tmp
 =ğ*
Í
)

243  
»suÉ
;

244 
	`b»l£
(
»suÉ
);

245 
»³©
;

247 ià(!
ü—‹
)

248  
NULL
;

249 
tmp
 = 
	`xŸfs_Ãw_zÚe
(
šode
->
i_sb
, 
´ev_addr
);

250 ià(!
tmp
)

251  
NULL
;

252 
»suÉ
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

253 ià(*
Í
) {

254 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

255 
	`b»l£
(
»suÉ
);

256 
»³©
;

258 *
Í
 = 
tmp
;

259 
šode
->
i_blocks
+=2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

260  
»suÉ
;

261 
	}
}

263 
bufãr_h—d
 *

264 
	$šdt_g‘blk
(
šode
 * inode, 
bufãr_h—d
 * 
bh
,

265 
Ä
, 
ü—‹
, 
u_lÚg
 
´ev_addr
)

267 
tmp
;

268 
u_lÚg
 *
Í
;

269 
bufãr_h—d
 * 
»suÉ
;

271 ià(!
bh
)

272  
NULL
;

273 ià(!
bh
->
b_u±od©e
) {

274 
	`Î_rw_block
(
READ
, 1, &
bh
);

275 
	`wa™_Ú_bufãr
(
bh
);

276 ià(!
bh
->
b_u±od©e
) {

277 
	`b»l£
(
bh
);

278  
NULL
;

281 
Í
 = 
Ä
 + (
u_lÚg
 *è
bh
->
b_d©a
;

282 
»³©
:

283 ià((
tmp
=*
Í
)) {

284 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(
šode
->
i_sb
));

285 ià(
tmp
 =ğ*
Í
) {

286 
	`b»l£
(
bh
);

287  
»suÉ
;

289 
	`b»l£
(
»suÉ
);

290 
»³©
;

292 ià(!
ü—‹
) {

293 
	`b»l£
(
bh
);

294  
NULL
;

296 
tmp
 = 
	`xŸfs_Ãw_zÚe
(
šode
->
i_sb
, 
´ev_addr
);

297 ià(!
tmp
) {

298 
	`b»l£
(
bh
);

299  
NULL
;

301 
»suÉ
 = 
	`g‘blk
(
bh
->
b_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(
šode
->
i_sb
));

302 ià(*
Í
) {

303 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

304 
	`b»l£
(
»suÉ
);

305 
»³©
;

307 *
Í
 = 
tmp
;

308 
šode
->
i_blocks
+=2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

309 
bh
->
b_dœt
 = 1;

310 
	`b»l£
(
bh
);

311  
»suÉ
;

312 
	}
}

314 
bufãr_h—d
 * 
	$xŸfs_g‘blk
(
šode
 * inode, 
zÚe
, 
ü—‹
)

316 
bufãr_h—d
 * 
bh
;

317 
u_lÚg
 
´ev_addr
=0;

319 ià(
zÚe
<0) {

320 
	`´štk
("XIA-FS: zÚ< 0 (% %d)\n", 
WHERE_ERR
);

321  
NULL
;

323 ià(
zÚe
 >ğ8+(1+
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
))*XIAFS_ADDRS_PER_Z(inode->i_sb)) {

324 ià(!
ü—‹
)

325 
	`´štk
("XIA-FS: zÚ> big (% %d)\n", 
WHERE_ERR
);

326  
NULL
;

328 ià(
ü—‹
)

329 
´ev_addr
=
	`g‘_´ev_addr
(
šode
, 
zÚe
);

330 ià(
zÚe
 < 8)

331  
	`dt_g‘blk
(
šode
, 
zÚe
+šode->
u
.
xŸfs_i
.
i_zÚe
, 
ü—‹
, 
´ev_addr
);

332 
zÚe
 -= 8;

333 ià(
zÚe
 < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)) {

334 
bh
 = 
	`dt_g‘blk
(
šode
, &(šode->
u
.
xŸfs_i
.
i_šd_zÚe
), 
ü—‹
, 
´ev_addr
);

335 
bh
 = 
	`šdt_g‘blk
(
šode
, bh, 
zÚe
, 
ü—‹
, 
´ev_addr
);

336  
bh
;

338 
zÚe
 -ğ
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
);

339 
bh
 = 
	`dt_g‘blk
(
šode
, &(šode->
u
.
xŸfs_i
.
i_dšd_zÚe
), 
ü—‹
, 
´ev_addr
);

340 
bh
 = 
	`šdt_g‘blk
(
šode
, bh, 
zÚe
>>
	`XIAFS_ADDRS_PER_Z_BITS
(šode->
i_sb
),

341 
ü—‹
, 
´ev_addr
);

342 
bh
 = 
	`šdt_g‘blk
(
šode
, bh, 
zÚe
&(
	`XIAFS_ADDRS_PER_Z
(šode->
i_sb
)-1),

343 
ü—‹
, 
´ev_addr
);

344  
bh
;

345 
	}
}

347 
bufãr_h—d
 * 
	$xŸfs_b»ad
(
šode
 * inode, 
zÚe
, 
ü—‹
)

349 
bufãr_h—d
 * 
bh
;

351 
bh
 = 
	`xŸfs_g‘blk
(
šode
, 
zÚe
, 
ü—‹
);

352 ià(!
bh
 || bh->
b_u±od©e
)

353  
bh
;

354 
	`Î_rw_block
(
READ
, 1, &
bh
);

355 
	`wa™_Ú_bufãr
(
bh
);

356 ià(
bh
->
b_u±od©e
)

357  
bh
;

358 
	`b»l£
(
bh
);

359  
NULL
;

360 
	}
}

362 
	$xŸfs_»ad_šode
(
šode
 * inode)

364 
bufãr_h—d
 * 
bh
;

365 
xŸfs_šode
 * 
¿w_šode
;

366 
zÚe
;

367 
šo_t
 
šo
;

369 
šo
 = 
šode
->
i_šo
;

370 
šode
->
i_İ
 = 
NULL
;

371 
šode
->
i_mode
=0;

372 ià(!
šo
 || inØ> 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
) {

373 
	`´štk
("XIA-FS: bad inodnumb” (% %d)\n", 
WHERE_ERR
);

376 
zÚe
 = 1 + 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_im­_zÚes
 +

377 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_zm­_zÚes
 +

378 (
šo
-1)/ 
	`XIAFS_INODES_PER_Z
(
šode
->
i_sb
);

379 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
, 
zÚe
, 
	`XIAFS_ZSIZE
(šode->
i_sb
)))) {

380 
	`´štk
("XIA-FS:„—d i-nodzÚçed (% %d)\n", 
WHERE_ERR
);

383 
¿w_šode
 = ((
xŸfs_šode
 *è
bh
->
b_d©a
) +

384 ((
šo
-1è& (
	`XIAFS_INODES_PER_Z
(
šode
->
i_sb
) - 1));

385 
šode
->
i_mode
 = 
¿w_šode
->i_mode;

386 
šode
->
i_uid
 = 
¿w_šode
->i_uid;

387 
šode
->
i_gid
 = 
¿w_šode
->i_gid;

388 
šode
->
i_Æšk
 = 
¿w_šode
->
i_Æšks
;

389 
šode
->
i_size
 = 
¿w_šode
->i_size;

390 
šode
->
i_mtime
 = 
¿w_šode
->i_mtime;

391 
šode
->
i_©ime
 = 
¿w_šode
->i_atime;

392 
šode
->
i_ùime
 = 
¿w_šode
->i_ctime;

393 
šode
->
i_blksize
 = 
	`XIAFS_ZSIZE
(šode->
i_sb
);

394 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

395 
šode
->
i_blocks
=0;

396 
šode
->
i_rdev
 = 
¿w_šode
->
i_zÚe
[0];

398 
	`XIAFS_GET_BLOCKS
(
¿w_šode
, 
šode
->
i_blocks
);

399 
zÚe
 = 0; zone < 8; zone++)

400 
šode
->
u
.
xŸfs_i
.
i_zÚe
[
zÚe
] = 
¿w_šode
->i_zone[zone] & 0xffffff;

401 
šode
->
u
.
xŸfs_i
.
i_šd_zÚe
 = 
¿w_šode
->i_ind_zone & 0xffffff;

402 
šode
->
u
.
xŸfs_i
.
i_dšd_zÚe
 = 
¿w_šode
->i_dind_zone & 0xffffff;

404 
	`b»l£
(
bh
);

405 ià(
	`S_ISREG
(
šode
->
i_mode
))

406 
šode
->
i_İ
 = &
xŸfs_fe_šode_İ”©iÚs
;

407 ià(
	`S_ISDIR
(
šode
->
i_mode
))

408 
šode
->
i_İ
 = &
xŸfs_dœ_šode_İ”©iÚs
;

409 ià(
	`S_ISLNK
(
šode
->
i_mode
))

410 
šode
->
i_İ
 = &
xŸfs_symlšk_šode_İ”©iÚs
;

411 ià(
	`S_ISCHR
(
šode
->
i_mode
))

412 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

413 ià(
	`S_ISBLK
(
šode
->
i_mode
))

414 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

415 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

416 
	`š™_fifo
(
šode
);

417 
	}
}

419 
bufãr_h—d
 * 
	$xŸfs_upd©e_šode
(
šode
 * inode)

421 
bufãr_h—d
 * 
bh
;

422 
xŸfs_šode
 * 
¿w_šode
;

423 
zÚe
;

424 
šo_t
 
šo
;

426 ià(
	`IS_RDONLY
 (
šode
)) {

427 
	`´štk
("XIA-FS: wr™e_šodÚ‡„—d-Úly fesy¡em (% %d)\n", 
WHERE_ERR
);

428 
šode
->
i_dœt
 = 0;

432 
šo
 = 
šode
->
i_šo
;

433 ià(!
šo
 || inØ> 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
) {

434 
	`´štk
("XIA-FS: bad inodnumb” (% %d)\n", 
WHERE_ERR
);

435 
šode
->
i_dœt
=0;

438 
zÚe
 = 1 + 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_im­_zÚes
 +

439 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_zm­_zÚes
 +

440 (
šo
-1è/ 
	`XIAFS_INODES_PER_Z
(
šode
->
i_sb
);

441 ià(!(
bh
=
	`b»ad
(
šode
->
i_dev
, 
zÚe
, 
	`XIAFS_ZSIZE
(šode->
i_sb
)))) {

442 
	`´štk
("XIA-FS:„—d i-nodzÚçed (% %d)\n", 
WHERE_ERR
);

443 
šode
->
i_dœt
=0;

446 
¿w_šode
 = ((
xŸfs_šode
 *)
bh
->
b_d©a
) +

447 ((
šo
-1è& (
	`XIAFS_INODES_PER_Z
(
šode
->
i_sb
) -1));

448 
¿w_šode
->
i_mode
 = 
šode
->i_mode;

449 
¿w_šode
->
i_uid
 = 
šode
->i_uid;

450 
¿w_šode
->
i_gid
 = 
šode
->i_gid;

451 
¿w_šode
->
i_Æšks
 = 
šode
->
i_Æšk
;

452 
¿w_šode
->
i_size
 = 
šode
->i_size;

453 
¿w_šode
->
i_©ime
 = 
šode
->i_atime;

454 
¿w_šode
->
i_ùime
 = 
šode
->i_ctime;

455 
¿w_šode
->
i_mtime
 = 
šode
->i_mtime;

456 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode))

457 
¿w_šode
->
i_zÚe
[0] = 
šode
->
i_rdev
;

459 
	`XIAFS_PUT_BLOCKS
(
¿w_šode
, 
šode
->
i_blocks
);

460 
zÚe
 = 0; zone < 8; zone++)

461 
¿w_šode
->
i_zÚe
[
zÚe
] = (raw_inode->i_zone[zone] & 0xff000000)

462 | (
šode
->
u
.
xŸfs_i
.
i_zÚe
[
zÚe
] & 0xffffff);

463 
¿w_šode
->
i_šd_zÚe
 = (raw_inode->i_ind_zone & 0xff000000)

464 | (
šode
->
u
.
xŸfs_i
.
i_šd_zÚe
 & 0xffffff);

465 
¿w_šode
->
i_dšd_zÚe
 = (raw_inode->i_dind_zone & 0xff000000)

466 | (
šode
->
u
.
xŸfs_i
.
i_dšd_zÚe
 & 0xffffff);

468 
šode
->
i_dœt
=0;

469 
bh
->
b_dœt
=1;

470  
bh
;

471 
	}
}

474 
	$xŸfs_wr™e_šode
(
šode
 * inode)

476 
bufãr_h—d
 * 
bh
;

477 
bh
 = 
	`xŸfs_upd©e_šode
(
šode
);

478 
	`b»l£
 (
bh
);

479 
	}
}

481 
	$xŸfs_sync_šode
 (
šode
 *inode)

483 
”r
 = 0;

484 
bufãr_h—d
 *
bh
;

486 
bh
 = 
	`xŸfs_upd©e_šode
(
šode
);

487 ià(
bh
 && bh->
b_dœt
)

489 
	`Î_rw_block
(
WRITE
, 1, &
bh
);

490 
	`wa™_Ú_bufãr
(
bh
);

491 ià(
bh
->
b_»q
 && !bh->
b_u±od©e
)

493 
	`´štk
 ("IOƒrror syncing xiafs inode [%04X:%lu]\n",

494 
šode
->
i_dev
, inode->
i_šo
);

495 
”r
 = -1;

498 ià(!
bh
)

499 
”r
 = -1;

500 
	`b»l£
 (
bh
);

501  
”r
;

502 
	}
}

	@fs/xiafs/namei.c

12 
	~<lšux/sched.h
>

13 
	~<lšux/xŸ_fs.h
>

14 
	~<lšux/k”Ãl.h
>

15 
	~<lšux/¡ršg.h
>

16 
	~<lšux/¡©.h
>

17 
	~<lšux/fú.h
>

18 
	~<lšux/”ºo.h
>

19 
	~<asm/£gm’t.h
>

21 
	~"xŸfs_mac.h
"

23 
	#RNDUP4
(
x
è((3+(
u_lÚg
)(x)è& ~3)

	)

31 
	$xŸfs_m©ch
(
Ën
, cÚ¡ * 
Çme
, 
xŸfs_dœeù
 * 
d•
)

33 
i
;

35 ià(!
d•
 || !d•->
d_šo
 || 
Ën
 > 
_XIAFS_NAME_LEN
)

38 ià(!
Ën
 && (
d•
->
d_Çme
[0]=='.') && (dep->d_name[1]=='\0'))

40 ià(
Ën
 !ğ
d•
->
d_Çme_Ën
)

42 
i
=0; i < 
Ën
; i++)

43 ià(*
Çme
++ !ğ
d•
->
d_Çme
[
i
])

46 
	}
}

56 
bufãr_h—d
 *

57 
	$xŸfs_fšd_’Œy
(
šode
 * inode, cÚ¡ * 
Çme
, 
Çm–’
,

58 
xŸfs_dœeù
 ** 
»s_dœ
, xŸfs_dœeù ** 
»s_´e
)

60 
i
, 
zÚes
, 
pos
;

61 
bufãr_h—d
 * 
bh
;

62 
xŸfs_dœeù
 * 
d•
, * 
d•_´e
;

64 *
»s_dœ
 = 
NULL
;

65 ià(!
šode
)

66  
NULL
;

67 ià(
Çm–’
 > 
_XIAFS_NAME_LEN
)

68  
NULL
;

70 ià(
šode
->
i_size
 & (
	`XIAFS_ZSIZE
(šode->
i_sb
) - 1)) {

71 
	`´štk
("XIA-FS: bad dœ siz(% %d)\n", 
WHERE_ERR
);

72  
NULL
;

74 
zÚes
=
šode
->
i_size
 >> 
	`XIAFS_ZSIZE_BITS
(šode->
i_sb
);

75 
i
=0; i < 
zÚes
; i++ ) {

76 
bh
 = 
	`xŸfs_b»ad
(
šode
, 
i
, 0);

77 ià(!
bh
)

79 
d•_´e
=
d•
=(
xŸfs_dœeù
 *)
bh
->
b_d©a
;

80 ià(!
i
 && (
d•
->
d_»c_Ën
 !ğ12 || !d•->
d_šo
 ||

81 
d•
->
d_Çme_Ën
 !ğ1 || 
	`¡rcmp
(d•->
d_Çme
, "."))) {

82 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

83 
	`b»l£
(
bh
);

84  
NULL
;

86 
pos
 = 0;

87  
pos
 < 
	`XIAFS_ZSIZE
(
šode
->
i_sb
) ) {

88 ià(
d•
->
d_šo
 > 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
 ||

89 
d•
->
d_»c_Ën
 < 12 ||

90 
d•
->
d_»c_Ën
+(*)d• > 
bh
->
b_d©a
+
	`XIAFS_ZSIZE
(
šode
->
i_sb
) ||

91 
d•
->
d_Çme_Ën
 + 8 > d•->
d_»c_Ën
 || dep->d_name_len <= 0 ||

92 
d•
->
d_Çme
[d•->
d_Çme_Ën
] ) {

93 
	`b»l£
(
bh
);

94  
NULL
;

96 ià(
	`xŸfs_m©ch
(
Çm–’
, 
Çme
, 
d•
)) {

97 *
»s_dœ
=
d•
;

98 ià(
»s_´e
)

99 *
»s_´e
=
d•_´e
;

100  
bh
;

102 
pos
 +ğ
d•
->
d_»c_Ën
;

103 
d•_´e
=
d•
;

104 
d•
=(
xŸfs_dœeù
 *)(
bh
->
b_d©a
 + 
pos
);

106 
	`b»l£
(
bh
);

107 ià(
pos
 > 
	`XIAFS_ZSIZE
(
šode
->
i_sb
)) {

108 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

109  
NULL
;

112  
NULL
;

113 
	}
}

115 
	$xŸfs_lookup
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
,

116 
šode
 ** 
»suÉ
)

118 
šo
;

119 
xŸfs_dœeù
 * 
d•
;

120 
bufãr_h—d
 * 
bh
;

122 *
»suÉ
 = 
NULL
;

123 ià(!
dœ
)

124  -
ENOENT
;

125 ià(!
	`S_ISDIR
(
dœ
->
i_mode
)) {

126 
	`ut
(
dœ
);

127  -
ENOENT
;

129 ià(!(
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
, 
Çme
, 
Ën
, &
d•
, 
NULL
))) {

130 
	`ut
(
dœ
);

131  -
ENOENT
;

133 
šo
 = 
d•
->
d_šo
;

134 
	`b»l£
(
bh
);

135 ià(!(*
»suÉ
 = 
	`ig‘
(
dœ
->
i_sb
, 
šo
))) {

136 
	`ut
(
dœ
);

137  -
EACCES
;

139 
	`ut
(
dœ
);

141 
	}
}

153 
bufãr_h—d
 * 
	$xŸfs_add_’Œy
(
šode
 * 
dœ
,

154 cÚ¡ * 
Çme
, 
Çm–’
, 
xŸfs_dœeù
 ** 
»s_dœ
,

155 
xŸfs_dœeù
 ** 
»s_´e
)

157 
i
, 
pos
, 
off£t
;

158 
bufãr_h—d
 * 
bh
;

159 
xŸfs_dœeù
 * 
de
, * 
de_´e
;

161 *
»s_dœ
 = 
NULL
;

162 ià(!
dœ
 || !
Çm–’
 ||‚am–’ > 
_XIAFS_NAME_LEN
)

163  
NULL
;

165 ià(
dœ
->
i_size
 & (
	`XIAFS_ZSIZE
(dœ->
i_sb
) - 1)) {

166 
	`´štk
("XIA-FS: bad dœ siz(% %d)\n", 
WHERE_ERR
);

167  
NULL
;

169 
pos
=0;

171 
bh
 = 
	`xŸfs_b»ad
(
dœ
, 
pos
 >> 
	`XIAFS_ZSIZE_BITS
(dœ->
i_sb
),…os ? 1:0);

172 ià(!
bh
)

173  
NULL
;

174 
de_´e
=
de
=(
xŸfs_dœeù
 *)
bh
->
b_d©a
;

175 ià(!
pos
) {

176 ià(
de
->
d_»c_Ën
 !ğ12 || !de->
d_šo
 || de->
d_Çme_Ën
 != 1 ||

177 
	`¡rcmp
(
de
->
d_Çme
, ".")) {

178 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

179 
	`b»l£
(
bh
);

180  
NULL
;

182 
off£t
 = 12;

183 
de_´e
=
de
=(
xŸfs_dœeù
 *)(
bh
->
b_d©a
+12);

185 
off£t
 = 0;

186 
off£t
 < 
	`XIAFS_ZSIZE
(
dœ
->
i_sb
)) {

187 ià(
pos
 >ğ
dœ
->
i_size
) {

188 
de
->
d_šo
=0;

189 
de
->
d_Çme_Ën
=0;

190 
de
->
d_Çme
[0]=0;

191 
de
->
d_»c_Ën
=
	`XIAFS_ZSIZE
(
dœ
->
i_sb
);

192 
dœ
->
i_size
 +ğ
	`XIAFS_ZSIZE
(dœ->
i_sb
);

193 
dœ
->
i_dœt
 = 1;

195 ià(
de
->
d_šo
 > 
dœ
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
 ||

196 
de
->
d_»c_Ën
 < 12 ||

197 (*)
de
+de->
d_»c_Ën
 > 
bh
->
b_d©a
+
	`XIAFS_ZSIZE
(
dœ
->
i_sb
) ||

198 
de
->
d_Çme_Ën
 + 8 > de->
d_»c_Ën
 ||

199 
de
->
d_Çme
[de->
d_Çme_Ën
]) {

200 
	`´štk
("XIA-FS: bad dœeùÜyƒÁry (% %d)\n", 
WHERE_ERR
);

201 
	`b»l£
(
bh
);

202  
NULL
;

204 ià(
de
->
d_šo
 &&

205 
	`RNDUP4
(
de
->
d_Çme_Ën
)+RNDUP4(
Çm–’
)+16<=de->
d_»c_Ën
) {

206 
i
=
	`RNDUP4
(
de
->
d_Çme_Ën
)+8;

207 
de_´e
=
de
;

208 
de
=(
xŸfs_dœeù
 *)(
i
+(
u_ch¬
 *)
de_´e
);

209 
de
->
d_šo
=0;

210 
de
->
d_»c_Ën
=
de_´e
->d_»c_Ën-
i
;

211 
de_´e
->
d_»c_Ën
=
i
;

214 ià(!
de
->
d_šo
 && 
	`RNDUP4
(
Çm–’
)+8 <ğde->
d_»c_Ën
) {

219 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
CURRENT_TIME
;

220 
dœ
->
i_dœt
 = 1;

221 
	`memıy
(
de
->
d_Çme
, 
Çme
, 
Çm–’
);

222 
de
->
d_Çme
[
Çm–’
]=0;

223 
de
->
d_Çme_Ën
=
Çm–’
;

224 
bh
->
b_dœt
 = 1;

225 *
»s_dœ
 = 
de
;

226 ià(
»s_´e
)

227 *
»s_´e
 = 
de_´e
;

228  
bh
;

230 
off£t
+=
de
->
d_»c_Ën
;

231 
de_´e
=
de
;

232 
de
=(
xŸfs_dœeù
 *)(
bh
->
b_d©a
+
off£t
);

234 
	`b»l£
(
bh
);

235 ià(
off£t
 > 
	`XIAFS_ZSIZE
(
dœ
->
i_sb
)) {

236 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

237  
NULL
;

239 
pos
+=
	`XIAFS_ZSIZE
(
dœ
->
i_sb
);

241  
NULL
;

242 
	}
}

244 
	$xŸfs_ü—‹
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
,

245 
šode
 ** 
»suÉ
)

247 
šode
 * inode;

248 
bufãr_h—d
 * 
bh
;

249 
xŸfs_dœeù
 * 
de
;

251 *
»suÉ
 = 
NULL
;

252 ià(!
dœ
)

253  -
ENOENT
;

254 
šode
 = 
	`xŸfs_Ãw_šode
(
dœ
);

255 ià(!
šode
) {

256 
	`ut
(
dœ
);

257  -
ENOSPC
;

259 
šode
->
i_İ
 = &
xŸfs_fe_šode_İ”©iÚs
;

260 
šode
->
i_mode
 = 
mode
;

261 
šode
->
i_dœt
 = 1;

262 
bh
 = 
	`xŸfs_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

263 ià(!
bh
) {

264 
šode
->
i_Æšk
--;

265 
šode
->
i_dœt
 = 1;

266 
	`ut
(
šode
);

267 
	`ut
(
dœ
);

268  -
ENOSPC
;

270 
de
->
d_šo
 = 
šode
->
i_šo
;

271 
bh
->
b_dœt
 = 1;

272 
	`b»l£
(
bh
);

273 
	`ut
(
dœ
);

274 *
»suÉ
 = 
šode
;

276 
	}
}

278 
	$xŸfs_mknod
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
, 
mode
, 
rdev
)

280 
šode
 * inode;

281 
bufãr_h—d
 * 
bh
;

282 
xŸfs_dœeù
 * 
de
;

284 ià(!
dœ
)

285  -
ENOENT
;

286 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
, 
NULL
);

287 ià(
bh
) {

288 
	`b»l£
(
bh
);

289 
	`ut
(
dœ
);

290  -
EEXIST
;

292 
šode
 = 
	`xŸfs_Ãw_šode
(
dœ
);

293 ià(!
šode
) {

294 
	`ut
(
dœ
);

295  -
ENOSPC
;

297 
šode
->
i_uid
 = 
cu¼’t
->
euid
;

298 
šode
->
i_mode
 = 
mode
;

299 
šode
->
i_İ
 = 
NULL
;

300 ià(
	`S_ISREG
(
šode
->
i_mode
))

301 
šode
->
i_İ
 = &
xŸfs_fe_šode_İ”©iÚs
;

302 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

303 
šode
->
i_İ
 = &
xŸfs_dœ_šode_İ”©iÚs
;

304 ià(
dœ
->
i_mode
 & 
S_ISGID
)

305 
šode
->
i_mode
 |ğ
S_ISGID
;

307 ià(
	`S_ISLNK
(
šode
->
i_mode
))

308 
šode
->
i_İ
 = &
xŸfs_symlšk_šode_İ”©iÚs
;

309 ià(
	`S_ISCHR
(
šode
->
i_mode
))

310 
šode
->
i_İ
 = &
chrdev_šode_İ”©iÚs
;

311 ià(
	`S_ISBLK
(
šode
->
i_mode
))

312 
šode
->
i_İ
 = &
blkdev_šode_İ”©iÚs
;

313 ià(
	`S_ISFIFO
(
šode
->
i_mode
))

314 
	`š™_fifo
(
šode
);

315 ià(
	`S_ISBLK
(
mode
è|| 
	`S_ISCHR
(mode))

316 
šode
->
i_rdev
 = 
rdev
;

317 
šode
->
i_©ime
 = inode->
i_ùime
 = inode->i_©imğ
CURRENT_TIME
;

318 
šode
->
i_dœt
 = 1;

319 
bh
 = 
	`xŸfs_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

320 ià(!
bh
) {

321 
šode
->
i_Æšk
--;

322 
šode
->
i_dœt
 = 1;

323 
	`ut
(
šode
);

324 
	`ut
(
dœ
);

325  -
ENOSPC
;

327 
de
->
d_šo
 = 
šode
->
i_šo
;

328 
bh
->
b_dœt
 = 1;

329 
	`b»l£
(
bh
);

330 
	`ut
(
dœ
);

331 
	`ut
(
šode
);

333 
	}
}

335 
	$xŸfs_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
)

337 
šode
 * inode;

338 
bufãr_h—d
 * 
bh
, *
dœ_block
;

339 
xŸfs_dœeù
 * 
de
;

341 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
,
Çme
,
Ën
,&
de
, 
NULL
);

342 ià(
bh
) {

343 
	`b»l£
(
bh
);

344 
	`ut
(
dœ
);

345  -
EEXIST
;

347 ià(
dœ
->
i_Æšk
 > 64000) {

348 
	`ut
(
dœ
);

349  -
EMLINK
;

351 
šode
 = 
	`xŸfs_Ãw_šode
(
dœ
);

352 ià(!
šode
) {

353 
	`ut
(
dœ
);

354  -
ENOSPC
;

356 
šode
->
i_İ
 = &
xŸfs_dœ_šode_İ”©iÚs
;

357 
šode
->
i_size
 = 
	`XIAFS_ZSIZE
(
dœ
->
i_sb
);

358 
šode
->
i_©ime
 = inode->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME
;

359 
dœ_block
 = 
	`xŸfs_b»ad
(
šode
,0,1);

360 ià(!
dœ_block
) {

361 
	`ut
(
dœ
);

362 
šode
->
i_Æšk
--;

363 
šode
->
i_dœt
 = 1;

364 
	`ut
(
šode
);

365  -
ENOSPC
;

367 
de
 = (
xŸfs_dœeù
 *è
dœ_block
->
b_d©a
;

368 
de
->
d_šo
=
šode
->
i_šo
;

369 
	`¡rıy
(
de
->
d_Çme
,".");

370 
de
->
d_Çme_Ën
=1;

371 
de
->
d_»c_Ën
=12;

372 
de
 =(
xŸfs_dœeù
 *)(12 + 
dœ_block
->
b_d©a
);

373 
de
->
d_šo
 = 
dœ
->
i_šo
;

374 
	`¡rıy
(
de
->
d_Çme
,"..");

375 
de
->
d_Çme_Ën
=2;

376 
de
->
d_»c_Ën
=
	`XIAFS_ZSIZE
(
dœ
->
i_sb
)-12;

377 
šode
->
i_Æšk
 = 2;

378 
dœ_block
->
b_dœt
 = 1;

379 
	`b»l£
(
dœ_block
);

380 
šode
->
i_mode
 = 
S_IFDIR
 | (
mode
 & 
S_IRWXUGO
 & ~
cu¼’t
->
umask
);

381 ià(
dœ
->
i_mode
 & 
S_ISGID
)

382 
šode
->
i_mode
 |ğ
S_ISGID
;

383 
šode
->
i_dœt
 = 1;

384 
bh
 = 
	`xŸfs_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

385 ià(!
bh
) {

386 
	`ut
(
dœ
);

387 
šode
->
i_Æšk
=0;

388 
	`ut
(
šode
);

389  -
ENOSPC
;

391 
de
->
d_šo
 = 
šode
->
i_šo
;

392 
bh
->
b_dœt
 = 1;

393 
dœ
->
i_Æšk
++;

394 
dœ
->
i_dœt
 = 1;

395 
	`ut
(
dœ
);

396 
	`ut
(
šode
);

397 
	`b»l£
(
bh
);

399 
	}
}

404 
	$em±y_dœ
(
šode
 * inode)

406 
i
, 
zÚes
, 
off£t
;

407 
bufãr_h—d
 * 
bh
;

408 
xŸfs_dœeù
 * 
de
;

410 ià(
šode
->
i_size
 & (
	`XIAFS_ZSIZE
(šode->
i_sb
)-1) ) {

411 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

415 
zÚes
=
šode
->
i_size
 >> 
	`XIAFS_ZSIZE_BITS
(šode->
i_sb
);

416 
i
=0; i < 
zÚes
; i++) {

417 
bh
 = 
	`xŸfs_b»ad
(
šode
, 
i
, 0);

418 ià(!
i
) {

419 ià(!
bh
) {

420 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

423 
de
=(
xŸfs_dœeù
 *)
bh
->
b_d©a
;

424 ià(
de
->
d_šo
 !ğ
šode
->
i_šo
 || 
	`¡rcmp
(".", de->
d_Çme
) ||

425 
de
->
d_»c_Ën
 != 12 ) {

426 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

427 
	`b»l£
(
bh
);

430 
de
=(
xŸfs_dœeù
 *)(12 + 
bh
->
b_d©a
);

431 ià(!
de
->
d_šo
 || 
	`¡rcmp
("..", de->
d_Çme
)) {

432 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

433 
	`b»l£
(
bh
);

436 
off£t
=
de
->
d_»c_Ën
+12;

439 
off£t
 = 0;

440 ià(!
bh
)

442 
off£t
 < 
	`XIAFS_ZSIZE
(
šode
->
i_sb
)) {

443 
de
=(
xŸfs_dœeù
 *)(
bh
->
b_d©a
+
off£t
);

444 ià(
de
->
d_šo
 > 
šode
->
i_sb
->
u
.
xŸfs_sb
.
s_nšodes
 ||

445 
de
->
d_»c_Ën
 < 12 ||

446 (*)
de
+de->
d_»c_Ën
 > 
bh
->
b_d©a
+
	`XIAFS_ZSIZE
(
šode
->
i_sb
) ||

447 
de
->
d_Çme_Ën
 + 8 > de->
d_»c_Ën
 ||

448 
de
->
d_Çme
[de->
d_Çme_Ën
]) {

449 
	`´štk
("XIA-FS: bad dœeùÜy (% %d)\n", 
WHERE_ERR
);

450 
	`b»l£
(
bh
);

453 ià(
de
->
d_šo
) {

454 
	`b»l£
(
bh
);

457 
off£t
+=
de
->
d_»c_Ën
;

459 
	`b»l£
(
bh
);

462 
	}
}

464 
	$xŸfs_rm_’Œy
(
xŸfs_dœeù
 *
de
, xŸfs_dœeù * 
de_´e
)

466 ià(
de
==
de_´e
) {

467 
de
->
d_šo
=0;

470 
de_´e
->
d_»c_Ën
+(
u_ch¬
 *)de_´< (u_ch¬ *)
de
) {

471 ià(
de_´e
->
d_»c_Ën
 < 12) {

472 
	`´štk
("XIA-FS: bad dœeùÜyƒÁry (% %d)\n", 
WHERE_ERR
);

475 
de_´e
=(
xŸfs_dœeù
 *)(de_´e->
d_»c_Ën
+(
u_ch¬
 *)de_pre);

477 ià(
de_´e
->
d_»c_Ën
+(
u_ch¬
 *)de_´> (u_ch¬ *)
de
) {

478 
	`´štk
("XIA-FS: bad dœeùÜyƒÁry (% %d)\n", 
WHERE_ERR
);

481 
de_´e
->
d_»c_Ën
+=
de
->d_rec_len;

482 
	}
}

484 
	$xŸfs_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

486 
»tv®
;

487 
šode
 * inode;

488 
bufãr_h—d
 * 
bh
;

489 
xŸfs_dœeù
 * 
de
, * 
de_´e
;

491 
šode
 = 
NULL
;

492 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, &
de_´e
);

493 
»tv®
 = -
ENOENT
;

494 ià(!
bh
)

495 
’d_rmdœ
;

496 
»tv®
 = -
EPERM
;

497 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->
d_šo
)))

498 
’d_rmdœ
;

499 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& 
cu¼’t
->
euid
 &&

500 
šode
->
i_uid
 !ğ
cu¼’t
->
euid
)

501 
’d_rmdœ
;

502 ià(
šode
->
i_dev
 !ğ
dœ
->i_dev)

503 
’d_rmdœ
;

504 ià(
šode
 =ğ
dœ
)

505 
’d_rmdœ
;

506 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

507 
»tv®
 = -
ENOTDIR
;

508 
’d_rmdœ
;

510 ià(!
	`em±y_dœ
(
šode
)) {

511 
»tv®
 = -
ENOTEMPTY
;

512 
’d_rmdœ
;

514 ià(
šode
->
i_couÁ
 > 1) {

515 
»tv®
 = -
EBUSY
;

516 
’d_rmdœ
;

518 ià(
šode
->
i_Æšk
 != 2)

519 
	`´štk
("XIA-FS:ƒm±y dœeùÜy ha Æšk!=2 (% %d)\n", 
WHERE_ERR
);

520 
	`xŸfs_rm_’Œy
(
de
, 
de_´e
);

521 
bh
->
b_dœt
 = 1;

522 
šode
->
i_Æšk
=0;

523 
šode
->
i_dœt
=1;

524 
dœ
->
i_Æšk
--;

525 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

526 
dœ
->
i_dœt
=1;

527 
»tv®
 = 0;

528 
’d_rmdœ
:

529 
	`ut
(
dœ
);

530 
	`ut
(
šode
);

531 
	`b»l£
(
bh
);

532  
»tv®
;

533 
	}
}

535 
	$xŸfs_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
)

537 
»tv®
;

538 
šode
 * inode;

539 
bufãr_h—d
 * 
bh
;

540 
xŸfs_dœeù
 * 
de
, * 
de_´e
;

542 
»³©
:

543 
»tv®
 = -
ENOENT
;

544 
šode
 = 
NULL
;

545 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, &
de_´e
);

546 ià(!
bh
)

547 
’d_uÆšk
;

548 ià(!(
šode
 = 
	`ig‘
(
dœ
->
i_sb
, 
de
->
d_šo
)))

549 
’d_uÆšk
;

550 
»tv®
 = -
EPERM
;

551 ià(
	`S_ISDIR
(
šode
->
i_mode
))

552 
’d_uÆšk
;

553 ià(
de
->
d_šo
 !ğ
šode
->
i_šo
) {

554 
	`ut
(
šode
);

555 
	`b»l£
(
bh
);

556 
cu¼’t
->
couÁ”
 = 0;

557 
	`scheduË
();

558 
»³©
;

560 ià((
dœ
->
i_mode
 & 
S_ISVTX
è&& !
	`su£r
() &&

561 
cu¼’t
->
euid
 !ğ
šode
->
i_uid
 &&

562 
cu¼’t
->
euid
 !ğ
dœ
->
i_uid
)

563 
’d_uÆšk
;

564 ià(!
šode
->
i_Æšk
) {

565 
	`´štk
("XIA-FS: D–‘šg‚Úexi¡’ˆf(% %d)\n", 
WHERE_ERR
);

566 
šode
->
i_Æšk
=1;

568 
	`xŸfs_rm_’Œy
(
de
, 
de_´e
);

569 
bh
->
b_dœt
 = 1;

570 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
CURRENT_TIME
;

571 
dœ
->
i_dœt
 = 1;

572 
šode
->
i_Æšk
--;

573 
šode
->
i_dœt
 = 1;

574 
»tv®
 = 0;

575 
’d_uÆšk
:

576 
	`b»l£
(
bh
);

577 
	`ut
(
šode
);

578 
	`ut
(
dœ
);

579  
»tv®
;

580 
	}
}

582 
	$xŸfs_symlšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
,

583 
Ën
, cÚ¡ * 
symÇme
)

585 
xŸfs_dœeù
 * 
de
;

586 
šode
 * inodğ
NULL
;

587 
bufãr_h—d
 * 
bh
 = 
NULL
, * 
Çme_block
 = NULL;

588 
i
;

589 
c
;

591 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
,
Çme
,
Ën
, &
de
, 
NULL
);

592 ià(
bh
) {

593 
	`b»l£
(
bh
);

594 
	`ut
(
dœ
);

595  -
EEXIST
;

597 ià(!(
šode
 = 
	`xŸfs_Ãw_šode
(
dœ
))) {

598 
	`ut
(
dœ
);

599  -
ENOSPC
;

601 
šode
->
i_mode
 = 
S_IFLNK
 | 
S_IRWXUGO
;

602 
šode
->
i_İ
 = &
xŸfs_symlšk_šode_İ”©iÚs
;

603 
Çme_block
 = 
	`xŸfs_b»ad
(
šode
,0,1);

604 ià(!
Çme_block
) {

605 
	`ut
(
dœ
);

606 
šode
->
i_Æšk
--;

607 
šode
->
i_dœt
 = 1;

608 
	`ut
(
šode
);

609  -
ENOSPC
;

611 
i
 = 0; i < 
BLOCK_SIZE
-1 && (
c
=*
symÇme
++); i++)

612 
Çme_block
->
b_d©a
[
i
] = 
c
;

613 
Çme_block
->
b_d©a
[
i
] = 0;

614 
Çme_block
->
b_dœt
 = 1;

615 
	`b»l£
(
Çme_block
);

616 
šode
->
i_size
 = 
i
;

617 
šode
->
i_dœt
 = 1;

618 
bh
 = 
	`xŸfs_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

619 ià(!
bh
) {

620 
šode
->
i_Æšk
--;

621 
šode
->
i_dœt
 = 1;

622 
	`ut
(
šode
);

623 
	`ut
(
dœ
);

624  -
ENOSPC
;

626 
de
->
d_šo
 = 
šode
->
i_šo
;

627 
bh
->
b_dœt
 = 1;

628 
	`b»l£
(
bh
);

629 
	`ut
(
dœ
);

630 
	`ut
(
šode
);

632 
	}
}

634 
	$xŸfs_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
,

635 cÚ¡ * 
Çme
, 
Ën
)

637 
xŸfs_dœeù
 * 
de
;

638 
bufãr_h—d
 * 
bh
;

640 ià(
	`S_ISDIR
(
Şdšode
->
i_mode
)) {

641 
	`ut
(
Şdšode
);

642 
	`ut
(
dœ
);

643  -
EPERM
;

645 ià(
Şdšode
->
i_Æšk
 > 64000) {

646 
	`ut
(
Şdšode
);

647 
	`ut
(
dœ
);

648  -
EMLINK
;

650 
bh
 = 
	`xŸfs_fšd_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

651 ià(
bh
) {

652 
	`b»l£
(
bh
);

653 
	`ut
(
dœ
);

654 
	`ut
(
Şdšode
);

655  -
EEXIST
;

657 
bh
 = 
	`xŸfs_add_’Œy
(
dœ
, 
Çme
, 
Ën
, &
de
, 
NULL
);

658 ià(!
bh
) {

659 
	`ut
(
dœ
);

660 
	`ut
(
Şdšode
);

661  -
ENOSPC
;

663 
de
->
d_šo
 = 
Şdšode
->
i_šo
;

664 
bh
->
b_dœt
 = 1;

665 
	`b»l£
(
bh
);

666 
	`ut
(
dœ
);

667 
Şdšode
->
i_Æšk
++;

668 
Şdšode
->
i_ùime
 = 
CURRENT_TIME
;

669 
Şdšode
->
i_dœt
 = 1;

670 
	`ut
(
Şdšode
);

672 
	}
}

674 
	$subdœ
(
šode
 * 
Ãw_šode
, šod* 
Şd_šode
)

676 
šo
;

677 
»suÉ
;

679 
Ãw_šode
->
i_couÁ
++;

680 
»suÉ
 = 0;

682 ià(
Ãw_šode
 =ğ
Şd_šode
) {

683 
»suÉ
 = 1;

686 ià(
Ãw_šode
->
i_dev
 !ğ
Şd_šode
->i_dev)

688 
šo
 = 
Ãw_šode
->
i_šo
;

689 ià(
	`xŸfs_lookup
(
Ãw_šode
,"..",2,&new_inode))

691 ià(
Ãw_šode
->
i_šo
 =ğ
šo
)

694 
	`ut
(
Ãw_šode
);

695  
»suÉ
;

696 
	}
}

698 
	#PARENT_INO
(
bufãr
) \

699 (((
xŸfs_dœeù
 *è((
u_ch¬
 *)(
bufãr
è+ 12))->
d_šo
)

	)

711 
	$do_xŸfs_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
,

712 
Şd_Ën
, 
šode
 * 
Ãw_dœ
,

713 cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

715 
šode
 * 
Şd_šode
, * 
Ãw_šode
;

716 
bufãr_h—d
 * 
Şd_bh
, * 
Ãw_bh
, * 
dœ_bh
;

717 
xŸfs_dœeù
 * 
Şd_de
, * 
Şd_de_´e
, * 
Ãw_de
, * 
Ãw_de_´e
;

718 
»tv®
;

720 
Œy_agaš
:

721 
Şd_šode
 = 
Ãw_šode
 = 
NULL
;

722 
Şd_bh
 = 
Ãw_bh
 = 
dœ_bh
 = 
NULL
;

723 
Şd_bh
 = 
	`xŸfs_fšd_’Œy
(
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
, &
Şd_de
, &
Şd_de_´e
);

724 
»tv®
 = -
ENOENT
;

725 ià(!
Şd_bh
)

726 
’d_»Çme
;

727 
Şd_šode
 = 
	`__ig‘
(
Şd_dœ
->
i_sb
, 
Şd_de
->
d_šo
, 0);

728 ià(!
Şd_šode
)

729 
’d_»Çme
;

730 
»tv®
 = -
EPERM
;

731 ià((
Şd_dœ
->
i_mode
 & 
S_ISVTX
) &&

732 
cu¼’t
->
euid
 !ğ
Şd_šode
->
i_uid
 &&

733 
cu¼’t
->
euid
 !ğ
Şd_dœ
->
i_uid
 && !
	`su£r
())

734 
’d_»Çme
;

735 
Ãw_bh
 = 
	`xŸfs_fšd_’Œy
(
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
, &
Ãw_de
, 
NULL
);

736 ià(
Ãw_bh
) {

737 
Ãw_šode
 = 
	`__ig‘
(
Ãw_dœ
->
i_sb
, 
Ãw_de
->
d_šo
, 0);

738 ià(!
Ãw_šode
) {

739 
	`b»l£
(
Ãw_bh
);

740 
Ãw_bh
 = 
NULL
;

743 ià(
Ãw_šode
 =ğ
Şd_šode
) {

744 
»tv®
 = 0;

745 
’d_»Çme
;

747 ià(
Ãw_šode
 && 
	`S_ISDIR
Òew_šode->
i_mode
)) {

748 
»tv®
 = -
EEXIST
;

749 
’d_»Çme
;

751 
»tv®
 = -
EPERM
;

752 ià(
Ãw_šode
 && (
Ãw_dœ
->
i_mode
 & 
S_ISVTX
) &&

753 
cu¼’t
->
euid
 !ğ
Ãw_šode
->
i_uid
 &&

754 
cu¼’t
->
euid
 !ğ
Ãw_dœ
->
i_uid
 && !
	`su£r
())

755 
’d_»Çme
;

756 ià(
	`S_ISDIR
(
Şd_šode
->
i_mode
)) {

757 
»tv®
 = -
EEXIST
;

758 ià(
Ãw_bh
)

759 
’d_»Çme
;

760 
»tv®
 = -
EACCES
;

761 ià(!
	`³rmissiÚ
(
Şd_šode
, 
MAY_WRITE
))

762 
’d_»Çme
;

763 
»tv®
 = -
EINVAL
;

764 ià(
	`subdœ
(
Ãw_dœ
, 
Şd_šode
))

765 
’d_»Çme
;

766 
»tv®
 = -
EIO
;

767 
dœ_bh
 = 
	`xŸfs_b»ad
(
Şd_šode
,0,0);

768 ià(!
dœ_bh
)

769 
’d_»Çme
;

770 ià(
	`PARENT_INO
(
dœ_bh
->
b_d©a
è!ğ
Şd_dœ
->
i_šo
)

771 
’d_»Çme
;

772 
»tv®
 = -
EMLINK
;

773 ià(
Ãw_dœ
->
i_Æšk
 > 64000)

774 
’d_»Çme
;

776 ià(!
Ãw_bh
)

777 
Ãw_bh
 = 
	`xŸfs_add_’Œy
(
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
, &
Ãw_de
, &
Ãw_de_´e
);

778 
»tv®
 = -
ENOSPC
;

779 ià(!
Ãw_bh
)

780 
’d_»Çme
;

782 iàĞ(
Ãw_šode
 && (
Ãw_de
->
d_šo
 !ğÃw_šode->
i_šo
))

783 || (
Ãw_de
->
d_šo
 && !
Ãw_šode
)

784 || (
Şd_de
->
d_šo
 !ğ
Şd_šode
->
i_šo
)) {

785 
	`xŸfs_rm_’Œy
(
Ãw_de
, 
Ãw_de_´e
);

786 
	`b»l£
(
Şd_bh
);

787 
	`b»l£
(
Ãw_bh
);

788 
	`b»l£
(
dœ_bh
);

789 
	`ut
(
Şd_šode
);

790 
	`ut
(
Ãw_šode
);

791 
cu¼’t
->
couÁ”
=0;

792 
	`scheduË
();

793 
Œy_agaš
;

795 
	`xŸfs_rm_’Œy
(
Şd_de
, 
Şd_de_´e
);

796 
Ãw_de
->
d_šo
 = 
Şd_šode
->
i_šo
;

797 ià(
Ãw_šode
) {

798 
Ãw_šode
->
i_Æšk
--;

799 
Ãw_šode
->
i_dœt
 = 1;

801 
Şd_bh
->
b_dœt
 = 1;

802 
Ãw_bh
->
b_dœt
 = 1;

803 ià(
dœ_bh
) {

804 
	`PARENT_INO
(
dœ_bh
->
b_d©a
èğ
Ãw_dœ
->
i_šo
;

805 
dœ_bh
->
b_dœt
 = 1;

806 
Şd_dœ
->
i_Æšk
--;

807 
Ãw_dœ
->
i_Æšk
++;

808 
Şd_dœ
->
i_dœt
 = 1;

809 
Ãw_dœ
->
i_dœt
 = 1;

811 
»tv®
 = 0;

812 
’d_»Çme
:

813 
	`b»l£
(
dœ_bh
);

814 
	`b»l£
(
Şd_bh
);

815 
	`b»l£
(
Ãw_bh
);

816 
	`ut
(
Şd_šode
);

817 
	`ut
(
Ãw_šode
);

818 
	`ut
(
Şd_dœ
);

819 
	`ut
(
Ãw_dœ
);

820  
»tv®
;

821 
	}
}

832 
	$xŸfs_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

833 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
)

835 
wa™_queue
 * 
wa™
 = 
NULL
;

836 
lock
 = 0;

837 
»suÉ
;

839 
lock
)

840 
	`¦“p_Ú
(&
wa™
);

841 
lock
 = 1;

842 
»suÉ
 = 
	`do_xŸfs_»Çme
(
Şd_dœ
, 
Şd_Çme
, 
Şd_Ën
,

843 
Ãw_dœ
, 
Ãw_Çme
, 
Ãw_Ën
);

844 
lock
 = 0;

845 
	`wake_up
(&
wa™
);

846  
»suÉ
;

847 
	}
}

	@fs/xiafs/symlink.c

12 
	~<asm/£gm’t.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/xŸ_fs.h
>

18 
	~<lšux/¡©.h
>

21 
xŸfs_»adlšk
(
šode
 *, *, );

24 
xŸfs_fŞlow_lšk
(
šode
 *, inode *, , , inode **);

29 
šode_İ”©iÚs
 
	gxŸfs_symlšk_šode_İ”©iÚs
 = {

30 
NULL
,

31 
NULL
,

32 
NULL
,

33 
NULL
,

34 
NULL
,

35 
NULL
,

36 
NULL
,

37 
NULL
,

38 
NULL
,

39 
NULL
,

40 
xŸfs_»adlšk
,

41 
xŸfs_fŞlow_lšk
,

42 
NULL
,

43 
NULL
,

44 
NULL


47 
	$xŸfs_»adlšk
(
šode
 * inode, * 
bufãr
, 
buæ’
)

49 
bufãr_h—d
 * 
bh
;

50 
i
;

51 
c
;

53 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

54 
	`ut
(
šode
);

55  -
EINVAL
;

57 ià(
buæ’
 > 
BLOCK_SIZE
)

58 
buæ’
 = 
BLOCK_SIZE
;

59 
bh
 = 
	`xŸfs_b»ad
(
šode
, 0, 0);

60 ià(!
	`IS_RDONLY
 (
šode
)) {

61 
šode
->
i_©ime
=
CURRENT_TIME
;

62 
šode
->
i_dœt
=1;

64 
	`ut
(
šode
);

65 ià(!
bh
)

67 
i
=0; i < 
buæ’
 && (
c
=
bh
->
b_d©a
[i]); i++)

68 
	`put_fs_by‹
(
c
, 
bufãr
++);

69 ià(
i
 < 
buæ’
-1)

70 
	`put_fs_by‹
(()0, 
bufãr
);

71 
	`b»l£
(
bh
);

72  
i
;

73 
	}
}

75 
	$xŸfs_fŞlow_lšk
(
šode
 * 
dœ
, inode * inode,

76 
æag
, 
mode
, 
šode
 ** 
»s_šode
)

78 
”rÜ
;

79 
bufãr_h—d
 * 
bh
;

81 *
»s_šode
 = 
NULL
;

82 ià(!
dœ
) {

83 
dœ
 = 
cu¼’t
->
roÙ
;

84 
dœ
->
i_couÁ
++;

86 ià(!
šode
) {

87 
	`ut
(
dœ
);

88  -
ENOENT
;

90 ià(!
	`S_ISLNK
(
šode
->
i_mode
)) {

91 
	`ut
(
dœ
);

92 *
»s_šode
 = 
šode
;

95 ià(!
	`IS_RDONLY
 (
šode
)) {

96 
šode
->
i_©ime
=
CURRENT_TIME
;

97 
šode
->
i_dœt
=1;

99 ià(
cu¼’t
->
lšk_couÁ
 > 5) {

100 
	`ut
(
šode
);

101 
	`ut
(
dœ
);

102  -
ELOOP
;

104 ià(!(
bh
 = 
	`xŸfs_b»ad
(
šode
, 0, 0))) {

105 
	`ut
(
šode
);

106 
	`ut
(
dœ
);

107  -
EIO
;

109 
	`ut
(
šode
);

110 
cu¼’t
->
lšk_couÁ
++;

111 
”rÜ
 = 
	`İ’_Çmei
(
bh
->
b_d©a
,
æag
,
mode
,
»s_šode
,
dœ
);

112 
cu¼’t
->
lšk_couÁ
--;

113 
	`b»l£
(
bh
);

114  
”rÜ
;

115 
	}
}

	@fs/xiafs/truncate.c

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/xŸ_fs.h
>

15 
	~<lšux/¡©.h
>

16 
	~<lšux/fú.h
>

18 
	~"xŸfs_mac.h
"

35 
	#DT_ZONE
 ((
šode
->
i_size
 + 
	`XIAFS_ZSIZE
(šode->
i_sb
) - 1) \

36 >> 
	`XIAFS_ZSIZE_BITS
(
šode
->
i_sb
è)

	)

38 
	$Œunc_dœeù
(
šode
 * inode)

40 
u_lÚg
 * 
Í
;

41 
bufãr_h—d
 * 
bh
;

42 
i
, 
tmp
;

43 
»Œy
 = 0;

45 
»³©
:

46 
i
 = 
DT_ZONE
 ; i < 8 ; i++) {

47 ià(
i
 < 
DT_ZONE
)

48 
»³©
;

49 
Í
=
i
 + 
šode
->
u
.
xŸfs_i
.
i_zÚe
;

50 ià(!(
tmp
 = *
Í
))

52 
bh
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

53 ià(
i
 < 
DT_ZONE
) {

54 
	`b»l£
(
bh
);

55 
»³©
;

57 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
Í
)

58 
»Œy
 = 1;

60 *
Í
 = 0;

61 
šode
->
i_dœt
 = 1;

62 
šode
->
i_blocks
-=2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

63 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

65 
	`b»l£
(
bh
);

67  
»Œy
;

68 
	}
}

70 
	$Œunc_šdœeù
(
šode
 * inode, 
addr_off
, 
u_lÚg
 * 
Í
)

73 
	#INDT_ZONE
 (
DT_ZONE
 - 
addr_off
)

	)

75 
bufãr_h—d
 * 
bh
, * 
šd_bh
;

76 
i
, 
tmp
;

77 
u_lÚg
 * 
šdp
;

78 
»Œy
 = 0;

80 iàĞ!(
tmp
=*
Í
) )

82 
šd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

83 ià(
tmp
 !ğ*
Í
) {

84 
	`b»l£
(
šd_bh
);

87 ià(!
šd_bh
) {

88 *
Í
 = 0;

91 
»³©
:

92 
i
 = 
INDT_ZONE
<0?0:INDT_ZONE; i < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
); i++) {

93 ià(
i
 < 
INDT_ZONE
)

94 
»³©
;

95 
šdp
 = 
i
+(
u_lÚg
 *è
šd_bh
->
b_d©a
;

96 ià(!(
tmp
=*
šdp
))

98 
bh
 = 
	`g‘blk
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

99 ià(
i
 < 
INDT_ZONE
) {

100 
	`b»l£
(
bh
);

101 
»³©
;

103 ià((
bh
 && bh->
b_couÁ
 !ğ1è|| 
tmp
 !ğ*
šdp
)

104 
»Œy
 = 1;

106 *
šdp
 = 0;

107 
šd_bh
->
b_dœt
 = 1;

108 
šode
->
i_blocks
-ğ2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

109 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

111 
	`b»l£
(
bh
);

113 
šdp
 = (
u_lÚg
 *è
šd_bh
->
b_d©a
;

114 
i
 = 0; i < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
è&& !(*
šdp
++); i++) ;

115 ià(
i
 >ğ
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)) {

116 ià(
šd_bh
->
b_couÁ
 != 1)

117 
»Œy
 = 1;

119 
tmp
 = *
Í
;

120 *
Í
 = 0;

121 
šode
->
i_blocks
-ğ2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

122 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

125 
	`b»l£
(
šd_bh
);

126  
»Œy
;

127 
	}
}

129 
	$Œunc_dšdœeù
(
šode
 * inode)

132 
	#DINDT_ZONE
 \

133 ((
DT_ZONE
-
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)-8)>>
	`XIAFS_ADDRS_PER_Z_BITS
(šode->i_sb))

	)

135 
i
, 
tmp
;

136 
bufãr_h—d
 * 
dšd_bh
;

137 
u_lÚg
 * 
dšdp
, * 
Í
;

138 
»Œy
 = 0;

140 
Í
 = &(
šode
->
u
.
xŸfs_i
.
i_dšd_zÚe
);

141 ià(!(
tmp
 = *
Í
))

143 
dšd_bh
 = 
	`b»ad
(
šode
->
i_dev
, 
tmp
, 
	`XIAFS_ZSIZE
(šode->
i_sb
));

144 ià(
tmp
 !ğ*
Í
) {

145 
	`b»l£
(
dšd_bh
);

148 ià(!
dšd_bh
) {

149 *
Í
 = 0;

152 
»³©
:

153 
i
=
DINDT_ZONE
<0?0:DINDT_ZONE ; i < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
) ; i ++) {

154 ià(
i
 < 
DINDT_ZONE
)

155 
»³©
;

156 
dšdp
 = 
i
+(
u_lÚg
 *è
dšd_bh
->
b_d©a
;

157 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
,

158 8+((1+
i
)<<
	`XIAFS_ADDRS_PER_Z_BITS
(
šode
->
i_sb
)),

159 
dšdp
);

160 
dšd_bh
->
b_dœt
 = 1;

162 
dšdp
 = (
u_lÚg
 *è
dšd_bh
->
b_d©a
;

163 
i
 = 0; i < 
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
è&& !(*
dšdp
++); i++);

164 ià(
i
 >ğ
	`XIAFS_ADDRS_PER_Z
(
šode
->
i_sb
)) {

165 ià(
dšd_bh
->
b_couÁ
 != 1)

166 
»Œy
 = 1;

168 
tmp
 = *
Í
;

169 *
Í
 = 0;

170 
šode
->
i_dœt
 = 1;

171 
šode
->
i_blocks
-=2 << 
	`XIAFS_ZSHIFT
(šode->
i_sb
);

172 
	`xŸfs_ä“_zÚe
(
šode
->
i_sb
, 
tmp
);

175 
	`b»l£
(
dšd_bh
);

176  
»Œy
;

177 
	}
}

179 
	$xŸfs_Œunÿ‹
(
šode
 * inode)

181 
»Œy
;

183 ià(!(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

184 
	`S_ISLNK
(
šode
->
i_mode
)))

187 
»Œy
 = 
	`Œunc_dœeù
(
šode
);

188 
»Œy
 |ğ
	`Œunc_šdœeù
(
šode
, 8, &(šode->
u
.
xŸfs_i
.
i_šd_zÚe
));

189 
»Œy
 |ğ
	`Œunc_dšdœeù
(
šode
);

190 ià(!
»Œy
)

192 
cu¼’t
->
couÁ”
 = 0;

193 
	`scheduË
();

195 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME
;

196 
šode
->
i_dœt
 = 1;

197 
	}
}

	@fs/xiafs/xiafs_mac.h

7 
š‹º®_”rÜ_mes§ge
[];

8 
	#INTERN_ERR
 
š‹º®_”rÜ_mes§ge
, 
__FILE__
, 
__LINE__


	)

9 
	#WHERE_ERR
 
__FILE__
, 
__LINE__


	)

11 
	#XIAFS_ZSHIFT
(
¥
è((¥)->
u
.
xŸfs_sb
.
s_zÚe_shiá
)

	)

12 
	#XIAFS_ZSIZE
(
¥
è(
BLOCK_SIZE
 << 
	`XIAFS_ZSHIFT
(¥))

	)

13 
	#XIAFS_ZSIZE_BITS
(
¥
è(
BLOCK_SIZE_BITS
 + 
	`XIAFS_ZSHIFT
(¥))

	)

14 
	#XIAFS_ADDRS_PER_Z
(
¥
è(
BLOCK_SIZE
 >> (2 - 
	`XIAFS_ZSHIFT
(¥)))

	)

15 
	#XIAFS_ADDRS_PER_Z_BITS
(
¥
è(
BLOCK_SIZE_BITS
 - 2 + 
	`XIAFS_ZSHIFT
(¥))

	)

16 
	#XIAFS_BITS_PER_Z
(
¥
è(
BLOCK_SIZE
 << (3 + 
	`XIAFS_ZSHIFT
(¥)))

	)

17 
	#XIAFS_BITS_PER_Z_BITS
(
¥
è(
BLOCK_SIZE_BITS
 + 3 + 
	`XIAFS_ZSHIFT
(¥))

	)

18 
	#XIAFS_INODES_PER_Z
(
¥
è(
_XIAFS_INODES_PER_BLOCK
 << 
	`XIAFS_ZSHIFT
(¥))

	)

23 
	#XIAFS_GET_BLOCKS
(
row_
, 
blocks
) \

24 
blocks
=((((
row_
)->
i_zÚe
[0] >> 24) & 0xff )|\

25 (((
row_
)->
i_zÚe
[1] >> 16) & 0xff00 )|\

26 (((
row_
)->
i_zÚe
[2] >> 8è& 0xff0000 ) )

	)

29 
	#XIAFS_PUT_BLOCKS
(
row_
, 
blocks
) \

30 (
row_
)->
i_zÚe
[2]=((
blocks
)<< 8) & 0xff000000;\

31 (
row_
)->
i_zÚe
[1]=((
blocks
)<<16) & 0xff000000;\

32 (
row_
)->
i_zÚe
[0]=((
blocks
)<<24è& 0xff000000

	)

	@ibcs/emulate.c

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/mm.h
>

15 
	~<lšux/¡ddef.h
>

16 
	~<lšux/uni¡d.h
>

17 
	~<lšux/£gm’t.h
>

18 
	~<lšux/±¿û.h
>

20 
	~<asm/£gm’t.h
>

21 
	~<asm/sy¡em.h
>

23 
asmlškage
 
	$iABI_emuÏ‹
(
±_»gs
 * 
»gs
)

25 
	`´štk
("iBCS2 binaries‚ot supported yet\n");

26 
	`do_ex™
(
SIGSEGV
);

27 
	}
}

	@include/asm/bitops.h

1 #iâdeà
_ASM_BITOPS_H


2 
	#_ASM_BITOPS_H


	)

7 #ifdeà
i386


19 
	s__dummy
 { 
	ma
[100]; };

20 
	#ADDR
 (*(
__dummy
 *è
addr
)

	)

22 
__šlše__
 
	$£t_b™
(
Ä
, * 
addr
)

24 
Şdb™
;

26 
__asm__
 
	`__vŞ©e__
("btsl %2,%1\n\tsbbl %0,%0"

27 :"ô" (
Şdb™
),"=m" (
ADDR
)

28 :"r" (
Ä
));

29  
Şdb™
;

30 
	}
}

32 
__šlše__
 
	$ş—r_b™
(
Ä
, * 
addr
)

34 
Şdb™
;

36 
__asm__
 
	`__vŞ©e__
("btrl %2,%1\n\tsbbl %0,%0"

37 :"ô" (
Şdb™
),"=m" (
ADDR
)

38 :"r" (
Ä
));

39  
Şdb™
;

40 
	}
}

46 
__šlše__
 
	$‹¡_b™
(
Ä
, * 
addr
)

48 
Şdb™
;

50 
__asm__
 
	`__vŞ©e__
("btl %2,%1\n\tsbbl %0,%0"

51 :"ô" (
Şdb™
)

52 :"m" (
ADDR
),"r" (
Ä
));

53  
Şdb™
;

54 
	}
}

72 
__šlše__
 
	$£t_b™
(
Ä
,* 
addr
)

74 
mask
, 
»tv®
;

76 
addr
 +ğ
Ä
 >> 5;

77 
mask
 = 1 << (
Ä
 & 0x1f);

78 
	`şi
();

79 
»tv®
 = (
mask
 & *
addr
) != 0;

80 *
addr
 |ğ
mask
;

81 
	`¡i
();

82  
»tv®
;

83 
	}
}

85 
__šlše__
 
	$ş—r_b™
(
Ä
, * 
addr
)

87 
mask
, 
»tv®
;

89 
addr
 +ğ
Ä
 >> 5;

90 
mask
 = 1 << (
Ä
 & 0x1f);

91 
	`şi
();

92 
»tv®
 = (
mask
 & *
addr
) != 0;

93 *
addr
 &ğ~
mask
;

94 
	`¡i
();

95  
»tv®
;

96 
	}
}

98 
__šlše__
 
	$‹¡_b™
(
Ä
, * 
addr
)

100 
mask
;

102 
addr
 +ğ
Ä
 >> 5;

103 
mask
 = 1 << (
Ä
 & 0x1f);

104  ((
mask
 & *
addr
) != 0);

105 
	}
}

	@include/asm/dma.h

8 #iâdeà
_ASM_DMA_H


9 
	#_ASM_DMA_H


	)

11 
	~<asm/io.h
>

14 #ifdeà
HAVE_REALLY_SLOW_DMA_CONTROLLER


15 
	#outb
 
outb_p


	)

66 
	#MAX_DMA_CHANNELS
 8

	)

69 
	#IO_DMA1_BASE
 0x00

	)

70 
	#IO_DMA2_BASE
 0xC0

	)

73 
	#DMA1_CMD_REG
 0x08

	)

74 
	#DMA1_STAT_REG
 0x08

	)

75 
	#DMA1_REQ_REG
 0x09

	)

76 
	#DMA1_MASK_REG
 0x0A

	)

77 
	#DMA1_MODE_REG
 0x0B

	)

78 
	#DMA1_CLEAR_FF_REG
 0x0C

	)

79 
	#DMA1_TEMP_REG
 0x0D

	)

80 
	#DMA1_RESET_REG
 0x0D

	)

81 
	#DMA1_CLR_MASK_REG
 0x0E

	)

82 
	#DMA1_MASK_ALL_REG
 0x0F

	)

84 
	#DMA2_CMD_REG
 0xD0

	)

85 
	#DMA2_STAT_REG
 0xD0

	)

86 
	#DMA2_REQ_REG
 0xD2

	)

87 
	#DMA2_MASK_REG
 0xD4

	)

88 
	#DMA2_MODE_REG
 0xD6

	)

89 
	#DMA2_CLEAR_FF_REG
 0xD8

	)

90 
	#DMA2_TEMP_REG
 0xDA

	)

91 
	#DMA2_RESET_REG
 0xDA

	)

92 
	#DMA2_CLR_MASK_REG
 0xDC

	)

93 
	#DMA2_MASK_ALL_REG
 0xDE

	)

95 
	#DMA_ADDR_0
 0x00

	)

96 
	#DMA_ADDR_1
 0x02

	)

97 
	#DMA_ADDR_2
 0x04

	)

98 
	#DMA_ADDR_3
 0x06

	)

99 
	#DMA_ADDR_4
 0xC0

	)

100 
	#DMA_ADDR_5
 0xC4

	)

101 
	#DMA_ADDR_6
 0xC8

	)

102 
	#DMA_ADDR_7
 0xCC

	)

104 
	#DMA_CNT_0
 0x01

	)

105 
	#DMA_CNT_1
 0x03

	)

106 
	#DMA_CNT_2
 0x05

	)

107 
	#DMA_CNT_3
 0x07

	)

108 
	#DMA_CNT_4
 0xC2

	)

109 
	#DMA_CNT_5
 0xC6

	)

110 
	#DMA_CNT_6
 0xCA

	)

111 
	#DMA_CNT_7
 0xCE

	)

113 
	#DMA_PAGE_0
 0x87

	)

114 
	#DMA_PAGE_1
 0x83

	)

115 
	#DMA_PAGE_2
 0x81

	)

116 
	#DMA_PAGE_3
 0x82

	)

117 
	#DMA_PAGE_5
 0x8B

	)

118 
	#DMA_PAGE_6
 0x89

	)

119 
	#DMA_PAGE_7
 0x8A

	)

121 
	#DMA_MODE_READ
 0x44

	)

122 
	#DMA_MODE_WRITE
 0x48

	)

123 
	#DMA_MODE_CASCADE
 0xC0

	)

126 
__šlše__
 
	$’abË_dma
(
dmªr
)

128 ià(
dmªr
<=3)

129 
	`outb
(
dmªr
, 
DMA1_MASK_REG
);

131 
	`outb
(
dmªr
 & 3, 
DMA2_MASK_REG
);

132 
	}
}

134 
__šlše__
 
	$di§bË_dma
(
dmªr
)

136 ià(
dmªr
<=3)

137 
	`outb
(
dmªr
 | 4, 
DMA1_MASK_REG
);

139 
	`outb
((
dmªr
 & 3è| 4, 
DMA2_MASK_REG
);

140 
	}
}

149 
__šlše__
 
	$ş—r_dma_ff
(
dmªr
)

151 ià(
dmªr
<=3)

152 
	`outb
(0, 
DMA1_CLEAR_FF_REG
);

154 
	`outb
(0, 
DMA2_CLEAR_FF_REG
);

155 
	}
}

158 
__šlše__
 
	$£t_dma_mode
(
dmªr
, 
mode
)

160 ià(
dmªr
<=3)

161 
	`outb
(
mode
 | 
dmªr
, 
DMA1_MODE_REG
);

163 
	`outb
(
mode
 | (
dmªr
&3), 
DMA2_MODE_REG
);

164 
	}
}

171 
__šlše__
 
	$£t_dma_·ge
(
dmªr
, 
·g’r
)

173 
dmªr
) {

175 
	`outb
(
·g’r
, 
DMA_PAGE_0
);

178 
	`outb
(
·g’r
, 
DMA_PAGE_1
);

181 
	`outb
(
·g’r
, 
DMA_PAGE_2
);

184 
	`outb
(
·g’r
, 
DMA_PAGE_3
);

187 
	`outb
(
·g’r
 & 0xã, 
DMA_PAGE_5
);

190 
	`outb
(
·g’r
 & 0xã, 
DMA_PAGE_6
);

193 
	`outb
(
·g’r
 & 0xã, 
DMA_PAGE_7
);

196 
	}
}

202 
__šlše__
 
	$£t_dma_addr
(
dmªr
, 
a
)

204 
	`£t_dma_·ge
(
dmªr
, 
a
>>16);

205 ià(
dmªr
 <= 3) {

206 
	`outb
Ğ
a
 & 0xff, ((
dmªr
&3)<<1è+ 
IO_DMA1_BASE
 );

207 
	`outb
Ğ(
a
>>8è& 0xff, ((
dmªr
&3)<<1è+ 
IO_DMA1_BASE
 );

209 
	`outb
Ğ(
a
>>1è& 0xff, ((
dmªr
&3)<<2è+ 
IO_DMA2_BASE
 );

210 
	`outb
Ğ(
a
>>9è& 0xff, ((
dmªr
&3)<<2è+ 
IO_DMA2_BASE
 );

212 
	}
}

223 
__šlše__
 
	$£t_dma_couÁ
(
dmªr
, 
couÁ
)

225 
couÁ
--;

226 ià(
dmªr
 <= 3) {

227 
	`outb
Ğ
couÁ
 & 0xff, ((
dmªr
&3)<<1è+ 1 + 
IO_DMA1_BASE
 );

228 
	`outb
Ğ(
couÁ
>>8è& 0xff, ((
dmªr
&3)<<1è+ 1 + 
IO_DMA1_BASE
 );

230 
	`outb
Ğ(
couÁ
>>1è& 0xff, ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
 );

231 
	`outb
Ğ(
couÁ
>>9è& 0xff, ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
 );

233 
	}
}

244 
__šlše__
 
	$g‘_dma_»sidue
(
dmªr
)

246 
io_pÜt
 = (
dmªr
<=3)? ((dmªr&3)<<1è+ 1 + 
IO_DMA1_BASE


247 : ((
dmªr
&3)<<2è+ 2 + 
IO_DMA2_BASE
;

250 
couÁ
;

252 
couÁ
 = 1 + 
	`šb
(
io_pÜt
);

253 
couÁ
 +ğ
	`šb
(
io_pÜt
) << 8;

255  (
dmªr
<=3)? 
couÁ
 : (count<<1);

256 
	}
}

260 
»que¡_dma
(
dmªr
);

261 
ä“_dma
(
dmªr
);

	@include/asm/io.h

1 #iâdeà
_ASM_IO_H


2 
	#_ASM_IO_H


	)

28 #ifdeà
SLOW_IO_BY_JUMPING


29 
	#__SLOW_DOWN_IO
 
__asm__
 
	`__vŞ©e__
("jm°1f\n1:\tjm°1f\n1:")

	)

31 
	#__SLOW_DOWN_IO
 
__asm__
 
	`__vŞ©e__
("outb %®,$0x80")

	)

34 #ifdeà
REALLY_SLOW_IO


35 
	#SLOW_DOWN_IO
 { 
__SLOW_DOWN_IO
; __SLOW_DOWN_IO; __SLOW_DOWN_IO; __SLOW_DOWN_IO; }

	)

37 
	#SLOW_DOWN_IO
 
__SLOW_DOWN_IO


	)

44 
	#__OUT1
(
s
,
x
) \

45 
šlše
 
__out
##
	`s
(
x
 
v®ue
, 
pÜt
è{

	)

47 
	#__OUT2
(
s
,
s1
,
s2
) \

48 
__asm__
 
	`__vŞ©e__
 ("out" # " %" 
s1
 "0,%" 
s2
 "1"

	)

50 
	#__OUT
(
s
,
s1
,
x
) \

51 
	`__OUT1
(
s
,
x
è
	`__OUT2
(s,
s1
,"w"è: : "a" (
v®ue
), "d" (
pÜt
)); } \

52 
	`__OUT1
(
s
##
c
,
x
è
	`__OUT2
(s,
s1
,""è: : "a" (
v®ue
), "i" (
pÜt
)); } \

53 
	`__OUT1
(
s
##
_p
,
x
è
	`__OUT2
(s,
s1
,"w"è: : "a" (
v®ue
), "d" (
pÜt
)); 
SLOW_DOWN_IO
; } \

54 
	`__OUT1
(
s
##
c_p
,
x
è
	`__OUT2
(s,
s1
,""è: : "a" (
v®ue
), "i" (
pÜt
)); 
SLOW_DOWN_IO
; }

	)

56 
	#__IN1
(
s
) \

57 
šlše
 
__š
##
	`s
(
pÜt
è{ 
_v
;

	)

59 
	#__IN2
(
s
,
s1
,
s2
) \

60 
__asm__
 
	`__vŞ©e__
 ("š" # " %" 
s2
 "1,%" 
s1
 "0"

	)

62 
	#__IN
(
s
,
s1
,
i
...) \

63 
	`__IN1
(
s
è
	`__IN2
(s,
s1
,"w"è: "÷" (
_v
è: "d" (
pÜt
è,##
i
 );  _v; } \

64 
	`__IN1
(
s
##
c
è
	`__IN2
(s,
s1
,""è: "÷" (
_v
è: "i" (
pÜt
è,##
i
 );  _v; } \

65 
	`__IN1
(
s
##
_p
è
	`__IN2
(s,
s1
,"w"è: "÷" (
_v
è: "d" (
pÜt
è,##
i
 ); 
SLOW_DOWN_IO
;  _v; } \

66 
	`__IN1
(
s
##
c_p
è
	`__IN2
(s,
s1
,""è: "÷" (
_v
è: "i" (
pÜt
è,##
i
 ); 
SLOW_DOWN_IO
;  _v; }

	)

68 
	#__INS
(
s
) \

69 
šlše
 
šs
##
	`s
(
pÜt
, * 
addr
, 
couÁ
) \

70 { 
__asm__
 
	`__vŞ©e__
 ("cld ;„ep ; ins" #s \

71 : "=D" (
addr
), "=c" (
couÁ
è: "d" (
pÜt
),"0" (addr),"1" (couÁ)); }

	)

73 
	#__OUTS
(
s
) \

74 
šlše
 
outs
##
	`s
(
pÜt
, cÚ¡ * 
addr
, 
couÁ
) \

75 { 
__asm__
 
	`__vŞ©e__
 ("cld ;„ep ; outs" #s \

76 : "=S" (
addr
), "=c" (
couÁ
è: "d" (
pÜt
),"0" (addr),"1" (couÁ)); }

	)

78 
__IN
(
b
,"b","0" (0))

79 
__IN
(
w
,"w","0" (0))

80 
__IN
(
l
,"")

82 
__OUT
(
b
,"b",)

83 
__OUT
(
w
,"w",)

84 
	$__OUT
(
l
,,)

86 
	$__INS
(
b
)

87 
	$__INS
(
w
)

88 
	$__INS
(
l
)

90 
	$__OUTS
(
b
)

91 
	$__OUTS
(
w
)

92 
	$__OUTS
(
l
)

99 
	#outb
(
v®
,
pÜt
) \

100 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

101 
	`__outbc
((
v®
),(
pÜt
)) : \

102 
	`__outb
((
v®
),(
pÜt
)))

	)

104 
	#šb
(
pÜt
) \

105 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

106 
	`__šbc
(
pÜt
) : \

107 
	`__šb
(
pÜt
))

	)

109 
	#outb_p
(
v®
,
pÜt
) \

110 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

111 
	`__outbc_p
((
v®
),(
pÜt
)) : \

112 
	`__outb_p
((
v®
),(
pÜt
)))

	)

114 
	#šb_p
(
pÜt
) \

115 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

116 
	`__šbc_p
(
pÜt
) : \

117 
	`__šb_p
(
pÜt
))

	)

119 
	#outw
(
v®
,
pÜt
) \

120 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

121 
	`__outwc
((
v®
),(
pÜt
)) : \

122 
	`__outw
((
v®
),(
pÜt
)))

	)

124 
	#šw
(
pÜt
) \

125 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

126 
	`__šwc
(
pÜt
) : \

127 
	`__šw
(
pÜt
))

	)

129 
	#outw_p
(
v®
,
pÜt
) \

130 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

131 
	`__outwc_p
((
v®
),(
pÜt
)) : \

132 
	`__outw_p
((
v®
),(
pÜt
)))

	)

134 
	#šw_p
(
pÜt
) \

135 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

136 
	`__šwc_p
(
pÜt
) : \

137 
	`__šw_p
(
pÜt
))

	)

139 
	#ou
(
v®
,
pÜt
) \

140 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

141 
	`__ouc
((
v®
),(
pÜt
)) : \

142 
	`__ou
((
v®
),(
pÜt
)))

	)

144 
	#šl
(
pÜt
) \

145 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

146 
	`__šlc
(
pÜt
) : \

147 
	`__šl
(
pÜt
))

	)

149 
	#ou_p
(
v®
,
pÜt
) \

150 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

151 
	`__ouc_p
((
v®
),(
pÜt
)) : \

152 
	`__ou_p
((
v®
),(
pÜt
)))

	)

154 
	#šl_p
(
pÜt
) \

155 ((
	`__butš_cÚ¡ªt_p
((
pÜt
)) && (port) < 256) ? \

156 
	`__šlc_p
(
pÜt
) : \

157 
	`__šl_p
(
pÜt
))

	)

	@include/asm/irq.h

1 #iâdeà
_ASM_IRQ_H


2 
	#_ASM_IRQ_H


	)

10 
	~<lšux/£gm’t.h
>

11 
	~<lšux/lškage.h
>

13 
di§bË_œq
();

14 
’abË_œq
();

16 
	#__STR
(
x
è#x

	)

17 
	#STR
(
x
è
	`__STR
(x)

	)

19 
	#SAVE_ALL
 \

32 "movÈ$" 
	`STR
(
KERNEL_DS
) ",%edx\n\t" \

35 "movÈ$" 
	`STR
(
USER_DS
) ",%edx\n\t" \

38 "movÈ%edx,%db7\n\t"

	)

54 
	#SAVE_MOST
 \

61 "movÈ$" 
	`STR
(
KERNEL_DS
) ",%edx\n\t" \

63 "mov %dx,%es\n\t"

	)

65 
	#RESTORE_MOST
 \

71 "œ‘"

	)

78 
	#ACK_FIRST
(
mask
) \

88 "outb %®,$0x20\n\t"

	)

90 
	#ACK_SECOND
(
mask
) \

103 "1:\toutb %®,$0x20\n\t"

	)

105 
	#UNBLK_FIRST
(
mask
) \

111 "outb %®,$0x21\n\t"

	)

113 
	#UNBLK_SECOND
(
mask
) \

119 "outb %®,$0xA1\n\t"

	)

121 
	#IRQ_NAME2
(
Ä
èÄ##
	`_š‹¼u±
()

	)

122 
	#IRQ_NAME
(
Ä
è
	`IRQ_NAME2
(
IRQ
##Ä)

	)

123 
	#FAST_IRQ_NAME
(
Ä
è
	`IRQ_NAME2
(
ç¡_IRQ
##Ä)

	)

124 
	#BAD_IRQ_NAME
(
Ä
è
	`IRQ_NAME2
(
bad_IRQ
##Ä)

	)

126 
	#BUILD_IRQ
(
ch
,
Ä
,
mask
) \

127 
asmlškage
 
	`IRQ_NAME
(
Ä
); \

128 
asmlškage
 
	`FAST_IRQ_NAME
(
Ä
); \

129 
asmlškage
 
	`BAD_IRQ_NAME
(
Ä
); \

130 
	`__asm__
( \

134 
SAVE_ALL
 \

135 
ACK_
##
	`ch
(
mask
) \

144 
UNBLK_
##
	`ch
(
mask
) \

149 
SAVE_MOST
 \

150 
ACK_
##
	`ch
(
mask
) \

156 
UNBLK_
##
	`ch
(
mask
) \

158 
RESTORE_MOST
 \

161 
SAVE_MOST
 \

162 
ACK_
##
	`ch
(
mask
) \

163 
RESTORE_MOST
);

	)

	@include/asm/segment.h

1 #iâdeà
_ASM_SEGMENT_H


2 
	#_ASM_SEGMENT_H


	)

4 
šlše
 
	$g‘_u£r_by‹
(cÚ¡ * 
addr
)

6 
_v
;

8 
	`__asm__
 ("movb %%fs:%1,%0":"=q" (
_v
):"m" (*
addr
));

9  
_v
;

10 
	}
}

12 
	#g‘_fs_by‹
(
addr
è
	`g‘_u£r_by‹
((*)×ddr))

	)

14 
šlše
 
	$g‘_u£r_wÜd
(cÚ¡ *
addr
)

16 
_v
;

18 
	`__asm__
 ("movw %%fs:%1,%0":"ô" (
_v
):"m" (*
addr
));

19  
_v
;

20 
	}
}

22 
	#g‘_fs_wÜd
(
addr
è
	`g‘_u£r_wÜd
((*)×ddr))

	)

24 
šlše
 
	$g‘_u£r_lÚg
(cÚ¡ *
addr
)

26 
_v
;

28 
	`__asm__
 ("movÈ%%fs:%1,%0":"ô" (
_v
):"m" (*
addr
)); \

29  
_v
;

30 
	}
}

32 
	#g‘_fs_lÚg
(
addr
è
	`g‘_u£r_lÚg
((*)×ddr))

	)

34 
šlše
 
	$put_u£r_by‹
(
v®
,*
addr
)

36 
	`__asm__
 ("movb %0,%%fs:%1": :"iq" (
v®
),"m" (*
addr
));

37 
	}
}

39 
	#put_fs_by‹
(
x
,
addr
è
	`put_u£r_by‹
((x),(*)×ddr))

	)

41 
šlše
 
	$put_u£r_wÜd
(
v®
,* 
addr
)

43 
	`__asm__
 ("movw %0,%%fs:%1": :"œ" (
v®
),"m" (*
addr
));

44 
	}
}

46 
	#put_fs_wÜd
(
x
,
addr
è
	`put_u£r_wÜd
((x),(*)×ddr))

	)

48 
šlše
 
	$put_u£r_lÚg
(
v®
,* 
addr
)

50 
	`__asm__
 ("movÈ%0,%%fs:%1": :"œ" (
v®
),"m" (*
addr
));

51 
	}
}

53 
	#put_fs_lÚg
(
x
,
addr
è
	`put_u£r_lÚg
((x),(*)×ddr))

	)

55 
šlše
 
	$__g’”ic_memıy_tofs
(* 
to
, cÚ¡ * 
äom
, 
n
)

57 
	`__asm__
("cld\n\t"

71 :"c" (
n
),"D" ((è
to
),"S" ((è
äom
)

73 
	}
}

75 
šlše
 
	$__cÚ¡ªt_memıy_tofs
(* 
to
, cÚ¡ * 
äom
, 
n
)

77 
n
) {

81 
	`put_u£r_by‹
(*(cÚ¡ *è
äom
, (*è
to
);

84 
	`put_u£r_wÜd
(*(cÚ¡ *è
äom
, (*è
to
);

87 
	`put_u£r_wÜd
(*(cÚ¡ *è
äom
, (*è
to
);

88 
	`put_u£r_by‹
(*(2+(cÚ¡ *è
äom
), 2+(*è
to
);

91 
	`put_u£r_lÚg
(*(cÚ¡ *è
äom
, (*è
to
);

94 
	#COMMON
(
x
) \

95 
	`__asm__
("cld\n\t" \

100 
x
 \

103 :"c" (
n
/4),"D" ((è
to
),"S" ((è
äom
) \

104 :"cx","di","si")

	)

106 
n
 % 4) {

108 
	`COMMON
("");

111 
	`COMMON
("movsb\n\t");

114 
	`COMMON
("movsw\n\t");

117 
	`COMMON
("movsw\n\tmovsb\n\t");

120 #undeà
COMMON


121 
	}
}

123 
šlše
 
	$__g’”ic_memıy_äomfs
(* 
to
, cÚ¡ * 
äom
, 
n
)

125 
	`__asm__
("cld\n\t"

135 :"c" (
n
),"D" ((è
to
),"S" ((è
äom
)

137 
	}
}

139 
šlše
 
	$__cÚ¡ªt_memıy_äomfs
(* 
to
, cÚ¡ * 
äom
, 
n
)

141 
n
) {

145 *(*)
to
 = 
	`g‘_u£r_by‹
((cÚ¡ *è
äom
);

148 *(*)
to
 = 
	`g‘_u£r_wÜd
((cÚ¡ *è
äom
);

151 *(*è
to
 = 
	`g‘_u£r_wÜd
((cÚ¡ *è
äom
);

152 *(*è
to
 = 
	`g‘_u£r_by‹
(2+(cÚ¡ *è
äom
);

155 *(*è
to
 = 
	`g‘_u£r_lÚg
((cÚ¡ *è
äom
);

158 
	#COMMON
(
x
) \

159 
	`__asm__
("cld\n\t" \

161 
x
 \

163 :"c" (
n
/4),"D" ((è
to
),"S" ((è
äom
) \

164 :"cx","di","si","memÜy")

	)

166 
n
 % 4) {

168 
	`COMMON
("");

171 
	`COMMON
("fs ; movsb");

174 
	`COMMON
("fs ; movsw");

177 
	`COMMON
("fs ; movsw\n\tfs ; movsb");

180 #undeà
COMMON


181 
	}
}

183 
	#memıy_äomfs
(
to
, 
äom
, 
n
) \

184 (
	`__butš_cÚ¡ªt_p
(
n
) ? \

185 
	`__cÚ¡ªt_memıy_äomfs
((
to
),(
äom
),(
n
)) : \

186 
	`__g’”ic_memıy_äomfs
((
to
),(
äom
),(
n
)))

	)

188 
	#memıy_tofs
(
to
, 
äom
, 
n
) \

189 (
	`__butš_cÚ¡ªt_p
(
n
) ? \

190 
	`__cÚ¡ªt_memıy_tofs
((
to
),(
äom
),(
n
)) : \

191 
	`__g’”ic_memıy_tofs
((
to
),(
äom
),(
n
)))

	)

200 
šlše
 
	$g‘_fs
()

202 
_v
;

203 
	`__asm__
("mov %%fs,%w0":"ô" (
_v
):"0" (0));

204  
_v
;

205 
	}
}

207 
šlše
 
	$g‘_ds
()

209 
_v
;

210 
	`__asm__
("mov %%ds,%w0":"ô" (
_v
):"0" (0));

211  
_v
;

212 
	}
}

214 
šlše
 
	$£t_fs
(
v®
)

216 
__asm__
 
	`__vŞ©e__
("mov %w0,%%fs": :"r" (
v®
));

217 
	}
}

	@include/asm/system.h

1 #iâdeà
__ASM_SYSTEM_H


2 
	#__ASM_SYSTEM_H


	)

4 
	~<lšux/£gm’t.h
>

6 
	#move_to_u£r_mode
() \

7 
__asm__
 
	`__vŞ©e__
 ("movl %%esp,%%eax\n\t" \

19 : :"i" (
USER_DS
), "i" (
USER_CS
):"ax")

	)

21 
	#¡i
(è
__asm__
 
	`__vŞ©e__
 ("¡i": : :"memÜy")

	)

22 
	#şi
(è
__asm__
 
	`__vŞ©e__
 ("şi": : :"memÜy")

	)

23 
	#nİ
(è
__asm__
 
	`__vŞ©e__
 ("nİ")

	)

28 
	#şts
(è
__asm__
 
	`__vŞ©e__
 ("şts")

	)

29 
	#¡ts
() \

30 
__asm__
 
	`__vŞ©e__
 ( \

36 :"ax")

	)

39 
šlše
 
	$s
(* 
m
)

41 
»s
;

43 
	`__asm__
("xchgb %0,%1":"=q" (
»s
),"=m" (*
m
):"0" (0x1));

44  
»s
;

45 
	}
}

47 
	#§ve_æags
(
x
) \

48 
__asm__
 
	`__vŞ©e__
("pushæ ;…İÈ%0":"ô" (
x
): :"memÜy")

	)

50 
	#»¡Üe_æags
(
x
) \

51 
__asm__
 
	`__vŞ©e__
("pushÈ%0 ;…İæ": :"r" (
x
):"memÜy")

	)

53 
	#œ‘
(è
__asm__
 
	`__vŞ©e__
 ("œ‘": : :"memÜy")

	)

55 
	#_£t_g©e
(
g©e_addr
,
ty³
,
d¶
,
addr
) \

56 
__asm__
 
	`__vŞ©e__
 ("movw %%dx,%%ax\n\t" \

60 :"=m" (*((*è(
g©e_addr
))), \

61 "=m" (*(1+(*è(
g©e_addr
))) \

62 :"i" ((è(0x8000+(
d¶
<<13)+(
ty³
<<8))), \

63 "d" ((*è(
addr
)),"a" (
KERNEL_CS
 << 16) \

64 :"ax","dx")

	)

66 
	#£t_šŒ_g©e
(
n
,
addr
) \

67 
	`_£t_g©e
(&
idt
[
n
],14,0,
addr
)

	)

69 
	#£t_Œ­_g©e
(
n
,
addr
) \

70 
	`_£t_g©e
(&
idt
[
n
],15,0,
addr
)

	)

72 
	#£t_sy¡em_g©e
(
n
,
addr
) \

73 
	`_£t_g©e
(&
idt
[
n
],15,3,
addr
)

	)

75 
	#£t_ÿÎ_g©e
(
a
,
addr
) \

76 
	`_£t_g©e
(
a
,12,3,
addr
)

	)

78 
	#_£t_£g_desc
(
g©e_addr
,
ty³
,
d¶
,
ba£
,
lim™
) {\

79 *((
g©e_addr
)+1èğ((
ba£
) & 0xff000000) | \

80 (((
ba£
) & 0x00ff0000)>>16) | \

81 ((
lim™
) & 0xf0000) | \

82 ((
d¶
)<<13) | \

84 ((
ty³
)<<8); \

85 *(
g©e_addr
èğ(((
ba£
) & 0x0000ffff)<<16) | \

86 ((
lim™
è& 0x0ffff); }

	)

88 
	#_£t_ts¦dt_desc
(
n
,
addr
,
lim™
,
ty³
) \

89 
__asm__
 
	`__vŞ©e__
 ("movw $" #limit ",%1\n\t" \

93 "movb $" 
ty³
 ",%4\n\t" \

98 :"a" (
addr
+0xc0000000), "m" (*(
n
)), "m" (*(n+2)), "m" (*(n+4)), \

99 "m" (*(
n
+5)), "m" (*(n+6)), "m" (*(n+7)) \

100 )

	)

102 
	#£t_tss_desc
(
n
,
addr
è
	`_£t_ts¦dt_desc
(((*èÒ)),(()×ddr)),235,"0x89")

	)

103 
	#£t_ldt_desc
(
n
,
addr
,
size
) \

104 
	`_£t_ts¦dt_desc
(((*è(
n
)),(()(
addr
)),((
size
 << 3è- 1),"0x82")

	)

	@include/linux/a.out.h

1 #iâdeà
__A_OUT_GNU_H__


2 
	#__A_OUT_GNU_H__


	)

4 
	#__GNU_EXEC_MACROS__


	)

6 #iâdeà
__STRUCT_EXEC_OVERRIDE__


8 
	sexec


10 
	ma_šfo
;

11 
	ma_‹xt
;

12 
	ma_d©a
;

13 
	ma_bss
;

14 
	ma_syms
;

15 
	ma_’Œy
;

16 
	ma_Œsize
;

17 
	ma_drsize
;

23 
	emachše_ty³
 {

24 #ià
defšed
 (
M_OLDSUN2
)

25 
	mM__OLDSUN2
 = 
M_OLDSUN2
,

27 
	mM_OLDSUN2
 = 0,

29 #ià
defšed
 (
M_68010
)

30 
	mM__68010
 = 
M_68010
,

32 
	mM_68010
 = 1,

34 #ià
defšed
 (
M_68020
)

35 
	mM__68020
 = 
M_68020
,

37 
	mM_68020
 = 2,

39 #ià
defšed
 (
M_SPARC
)

40 
	mM__SPARC
 = 
M_SPARC
,

42 
	mM_SPARC
 = 3,

45 
	mM_386
 = 100,

48 #ià!
defšed
 (
N_MAGIC
)

49 
	#N_MAGIC
(
exec
è(Óxec).
a_šfo
 & 0xffff)

	)

51 
	#N_MACHTYPE
(
exec
è((
machše_ty³
)((Óxec).
a_šfo
 >> 16è& 0xff))

	)

52 
	#N_FLAGS
(
exec
è((Óxec).
a_šfo
 >> 24è& 0xff)

	)

53 
	#N_SET_INFO
(
exec
, 
magic
, 
ty³
, 
æags
) \

54 ((
exec
).
a_šfo
 = ((
magic
) & 0xffff) \

55 | ((()(
ty³
) & 0xff) << 16) \

56 | (((
æags
è& 0xffè<< 24))

	)

57 
	#N_SET_MAGIC
(
exec
, 
magic
) \

58 ((
exec
).
a_šfo
 = ((Óxec).a_šfØ& 0xffff0000è| ((
magic
è& 0xffff)))

	)

60 
	#N_SET_MACHTYPE
(
exec
, 
machty³
) \

61 ((
exec
).
a_šfo
 = \

62 ((
exec
).
a_šfo
&0xff00ffffè| (((()(
machty³
))&0xffè<< 16))

	)

64 
	#N_SET_FLAGS
(
exec
, 
æags
) \

65 ((
exec
).
a_šfo
 = \

66 ((
exec
).
a_šfo
&0x00ffffffè| (((
æags
è& 0xffè<< 24))

	)

69 
	#OMAGIC
 0407

	)

71 
	#NMAGIC
 0410

	)

73 
	#ZMAGIC
 0413

	)

76 
	#QMAGIC
 0314

	)

79 
	#CMAGIC
 0421

	)

81 #ià!
defšed
 (
N_BADMAG
)

82 
	#N_BADMAG
(
x
è(
	`N_MAGIC
(xè!ğ
OMAGIC
 \

83 && 
	`N_MAGIC
(
x
è!ğ
NMAGIC
 \

84 && 
	`N_MAGIC
(
x
è!ğ
ZMAGIC
 \

85 && 
	`N_MAGIC
(
x
è!ğ
QMAGIC
)

	)

88 
	#_N_HDROFF
(
x
è(1024 -  (
exec
))

	)

90 #ià!
defšed
 (
N_TXTOFF
)

91 
	#N_TXTOFF
(
x
) \

92 (
	`N_MAGIC
(
x
è=ğ
ZMAGIC
 ? 
	`_N_HDROFF
((x)è+  (
exec
) : \

93 (
	`N_MAGIC
(
x
è=ğ
QMAGIC
 ? 0 :  (
exec
)))

	)

96 #ià!
defšed
 (
N_DATOFF
)

97 
	#N_DATOFF
(
x
è(
	`N_TXTOFF
(xè+ (x).
a_‹xt
)

	)

100 #ià!
defšed
 (
N_TRELOFF
)

101 
	#N_TRELOFF
(
x
è(
	`N_DATOFF
(xè+ (x).
a_d©a
)

	)

104 #ià!
defšed
 (
N_DRELOFF
)

105 
	#N_DRELOFF
(
x
è(
	`N_TRELOFF
(xè+ (x).
a_Œsize
)

	)

108 #ià!
defšed
 (
N_SYMOFF
)

109 
	#N_SYMOFF
(
x
è(
	`N_DRELOFF
(xè+ (x).
a_drsize
)

	)

112 #ià!
defšed
 (
N_STROFF
)

113 
	#N_STROFF
(
x
è(
	`N_SYMOFF
(xè+ (x).
a_syms
)

	)

117 #ià!
defšed
 (
N_TXTADDR
)

118 
	#N_TXTADDR
(
x
è(
	`N_MAGIC
(xè=ğ
QMAGIC
 ? 
PAGE_SIZE
 : 0)

	)

124 #ià
defšed
(
vax
è|| defšed(
hp300
è|| defšed(
pyr
)

125 
	#SEGMENT_SIZE
 
·ge_size


	)

127 #ifdef 
sÚy


128 
	#SEGMENT_SIZE
 0x2000

	)

130 #ifdeà
is68k


131 
	#SEGMENT_SIZE
 0x20000

	)

133 #ià
defšed
(
m68k
è&& defšed(
PORTAR
)

134 
	#PAGE_SIZE
 0x400

	)

135 
	#SEGMENT_SIZE
 
PAGE_SIZE


	)

138 #ifdeà
lšux


139 
	~<lšux/·ge.h
>

140 
	#SEGMENT_SIZE
 1024

	)

143 
	#_N_SEGMENT_ROUND
(
x
è(((xè+ 
SEGMENT_SIZE
 - 1è& ~(SEGMENT_SIZE - 1))

	)

145 
	#_N_TXTENDADDR
(
x
è(
	`N_TXTADDR
(x)+(x).
a_‹xt
)

	)

147 #iâdeà
N_DATADDR


148 
	#N_DATADDR
(
x
) \

149 (
	`N_MAGIC
(
x
)==
OMAGIC
? (
	`_N_TXTENDADDR
(x)) \

150 : (
	`_N_SEGMENT_ROUND
 (
	`_N_TXTENDADDR
(
x
))))

	)

154 #ià!
defšed
 (
N_BSSADDR
)

155 
	#N_BSSADDR
(
x
è(
	`N_DATADDR
(xè+ (x).
a_d©a
)

	)

158 #ià!
defšed
 (
N_NLIST_DECLARED
)

159 
	sÆi¡
 {

161 *
	mn_Çme
;

162 
Æi¡
 *
	mn_Ãxt
;

163 
	mn_¡rx
;

164 } 
	mn_un
;

165 
	mn_ty³
;

166 
	mn_Ùh”
;

167 
	mn_desc
;

168 
	mn_v®ue
;

172 #ià!
defšed
 (
N_UNDF
)

173 
	#N_UNDF
 0

	)

175 #ià!
defšed
 (
N_ABS
)

176 
	#N_ABS
 2

	)

178 #ià!
defšed
 (
N_TEXT
)

179 
	#N_TEXT
 4

	)

181 #ià!
defšed
 (
N_DATA
)

182 
	#N_DATA
 6

	)

184 #ià!
defšed
 (
N_BSS
)

185 
	#N_BSS
 8

	)

187 #ià!
defšed
 (
N_FN
)

188 
	#N_FN
 15

	)

191 #ià!
defšed
 (
N_EXT
)

192 
	#N_EXT
 1

	)

194 #ià!
defšed
 (
N_TYPE
)

195 
	#N_TYPE
 036

	)

197 #ià!
defšed
 (
N_STAB
)

198 
	#N_STAB
 0340

	)

209 
	#N_INDR
 0xa

	)

223 
	#N_SETA
 0x14

	)

224 
	#N_SETT
 0x16

	)

225 
	#N_SETD
 0x18

	)

226 
	#N_SETB
 0x1A

	)

229 
	#N_SETV
 0x1C

	)

231 #ià!
defšed
 (
N_RELOCATION_INFO_DECLARED
)

237 
	s»loÿtiÚ_šfo


240 
	mr_add»ss
;

242 
	mr_symbŞnum
:24;

246 
	mr_pü–
:1;

249 
	mr_Ëngth
:2;

256 
	mr_ex‹º
:1;

259 #ifdeà
NS32K


260 
	mr_b¤
:1;

261 
	mr_di¥
:1;

262 
	mr_·d
:2;

264 
	mr_·d
:4;

	@include/linux/binfmts.h

1 #iâdeà
_LINUX_BINFMTS_H


2 
	#_LINUX_BINFMTS_H


	)

4 
	~<lšux/±¿û.h
>

11 
	#MAX_ARG_PAGES
 32

	)

16 
	slšux_bš´m
{

17 
	mbuf
[128];

18 
	m·ge
[
MAX_ARG_PAGES
];

19 
	mp
;

20 
	msh_bªg
;

21 
šode
 * 
	mšode
;

22 
	me_uid
, 
	me_gid
;

23 
	m¬gc
, 
	m’vc
;

24 * 
	mf’ame
;

30 
	slšux_bšfmt
{

31 (*
	mlßd_bš¬y
)(
	mlšux_bš´m
 *, 
±_»gs
 * 
	m»gs
);

32 (*
	mlßd_shlib
)(
	mfd
);

35 
lšux_bšfmt
 
fÜm©s
[];

37 
»ad_exec
(
šode
 *šode, 
off£t
,

38 * 
addr
, 
couÁ
);

40 
İ’_šode
(
šode
 * inode, 
mode
);

42 
æush_Şd_exec
(
lšux_bš´m
 * 
b´m
);

43 
chªge_ldt
(
‹xt_size
,* 
·ge
);

44 * 
ü—‹_bËs
(* 
p
,
¬gc
,
’vc
,
ibcs
);

45 
cİy_¡ršgs
(
¬gc
,** 
¬gv
,*
·ge
,

46 
p
, 
äom_kmem
);

	@include/linux/busmouse.h

1 #iâdeà
_LINUX_BUSMOUSE_H


2 
	#_LINUX_BUSMOUSE_H


	)

30 
	#MOUSE_IRQ
 5

	)

31 
	#LOGITECH_BUSMOUSE
 0

	)

32 
	#MICROSOFT_BUSMOUSE
 2

	)

36 
	#MSE_DATA_PORT
 0x23c

	)

37 
	#MSE_SIGNATURE_PORT
 0x23d

	)

38 
	#MSE_CONTROL_PORT
 0x23e

	)

39 
	#MSE_INTERRUPT_PORT
 0x23e

	)

40 
	#MSE_CONFIG_PORT
 0x23f

	)

42 
	#MSE_ENABLE_INTERRUPTS
 0x00

	)

43 
	#MSE_DISABLE_INTERRUPTS
 0x10

	)

45 
	#MSE_READ_X_LOW
 0x80

	)

46 
	#MSE_READ_X_HIGH
 0xa0

	)

47 
	#MSE_READ_Y_LOW
 0xc0

	)

48 
	#MSE_READ_Y_HIGH
 0xe0

	)

51 
	#MSE_CONFIG_BYTE
 0x91

	)

52 
	#MSE_DEFAULT_MODE
 0x90

	)

53 
	#MSE_SIGNATURE_BYTE
 0xa5

	)

57 
	#MSE_INT_OFF
(è
	`outb
(
MSE_DISABLE_INTERRUPTS
, 
MSE_CONTROL_PORT
)

	)

58 
	#MSE_INT_ON
(è
	`outb
(
MSE_ENABLE_INTERRUPTS
, 
MSE_CONTROL_PORT
)

	)

62 
	#MS_MSE_DATA_PORT
 0x23d

	)

63 
	#MS_MSE_SIGNATURE_PORT
 0x23e

	)

64 
	#MS_MSE_CONTROL_PORT
 0x23c

	)

65 
	#MS_MSE_CONFIG_PORT
 0x23f

	)

67 
	#MS_MSE_ENABLE_INTERRUPTS
 0x11

	)

68 
	#MS_MSE_DISABLE_INTERRUPTS
 0x10

	)

70 
	#MS_MSE_READ_BUTTONS
 0x00

	)

71 
	#MS_MSE_READ_X
 0x01

	)

72 
	#MS_MSE_READ_Y
 0x02

	)

74 
	#MS_MSE_START
 0x80

	)

75 
	#MS_MSE_COMMAND_MODE
 0x07

	)

79 
	#MS_MSE_INT_OFF
(è{
	`outb
(
MS_MSE_COMMAND_MODE
, 
MS_MSE_CONTROL_PORT
); \

80 
	`outb
(
MS_MSE_DISABLE_INTERRUPTS
, 
MS_MSE_DATA_PORT
);}

	)

81 
	#MS_MSE_INT_ON
(è{
	`outb
(
MS_MSE_COMMAND_MODE
, 
MS_MSE_CONTROL_PORT
); \

82 
	`outb
(
MS_MSE_ENABLE_INTERRUPTS
, 
MS_MSE_DATA_PORT
);}

	)

85 
	smou£_¡©us
 {

86 
	mbu‰Ús
;

87 
	mÏtch_bu‰Ús
;

88 
	mdx
;

89 
	mdy
;

90 
	m´e£Á
;

91 
	m»ady
;

92 
	maùive
;

93 
wa™_queue
 *
	mwa™
;

97 
mou£_š™
();

	@include/linux/cdrom.h

10 #iâdef 
_LINUX_CDROM_H


11 
	#_LINUX_CDROM_H


	)

27 
	#SCMD_READ_TOC
 0x43

	)

28 
	#SCMD_PLAYAUDIO_MSF
 0x47

	)

29 
	#SCMD_PLAYAUDIO_TI
 0x48

	)

30 
	#SCMD_PAUSE_RESUME
 0x4B

	)

31 
	#SCMD_READ_SUBCHANNEL
 0x42

	)

32 
	#SCMD_PLAYAUDIO10
 0x45

	)

33 
	#SCMD_READ_HEADER
 0x44

	)

39 
	#SCMD_PLAYAUDIO12
 0xA5

	)

40 
	#SCMD_PLAYTRACK_REL12
 0xA9

	)

46 
	#SCMD_CD_PLAYBACK_CONTROL
 0xC9

	)

47 
	#SCMD_CD_PLAYBACK_STATUS
 0xC4

	)

53 
	sscsi_ÿ·c™y


55 
u_lÚg
 
	mÿ·c™y
;

56 
u_lÚg
 
	mlbasize
;

63 
	#ERR_RECOVERY_PARMS
 0x01

	)

64 
	#DISCO_RECO_PARMS
 0x02

	)

65 
	#FORMAT_PARMS
 0x03

	)

66 
	#GEOMETRY_PARMS
 0x04

	)

67 
	#CERTIFICATION_PARMS
 0x06

	)

68 
	#CACHE_PARMS
 0x38

	)

74 
	sccs_mode£l_h—d


76 
u_ch¬
 
	m_r1
;

77 
u_ch¬
 
	mmedium
;

78 
u_ch¬
 
	m_r2
;

79 
u_ch¬
 
	mblock_desc_Ëngth
;

80 
u_ch¬
 
	md’s™y
;

81 
u_ch¬
 
	mnumb”_blocks_hi
;

82 
u_ch¬
 
	mnumb”_blocks_med
;

83 
u_ch¬
 
	mnumb”_blocks_lo
;

84 
u_ch¬
 
	m_r3
;

85 
u_ch¬
 
	mblock_Ëngth_hi
;

86 
u_shÜt
 
	mblock_Ëngth
;

93 
	sccs_”r_»cov”y


95 
u_ch¬
 
	m_r1
 : 2;

96 
u_ch¬
 
	m·ge_code
 : 6;

97 
u_ch¬
 
	m·ge_Ëngth
;

98 
u_ch¬
 
	maw»
 : 1;

99 
u_ch¬
 
	m¬»
 : 1;

100 
u_ch¬
 
	mtb
 : 1;

101 
u_ch¬
 
	mrc
 : 1;

102 
u_ch¬
 
	m“c
 : 1;

103 
u_ch¬
 
	m³r
 : 1;

104 
u_ch¬
 
	md‹
 : 1;

105 
u_ch¬
 
	mdü
 : 1;

106 
u_ch¬
 
	m»Œy_couÁ
;

107 
u_ch¬
 
	mcÜ»ùiÚ_¥ª
;

108 
u_ch¬
 
	mh—d_off£t_couÁ
;

109 
u_ch¬
 
	m¡robe_off£t_couÁ
;

110 
u_ch¬
 
	m»cov”y_time_lim™
;

117 
	sccs_disco_»co


119 
u_ch¬
 
	m_r1
 : 2;

120 
u_ch¬
 
	m·ge_code
 : 6;

121 
u_ch¬
 
	m·ge_Ëngth
;

122 
u_ch¬
 
	mbufãr_fuÎ_¿tio
;

123 
u_ch¬
 
	mbufãr_em±y_¿tio
;

124 
u_shÜt
 
	mbus_šaùiv™y_lim™
;

125 
u_shÜt
 
	mdiscÚÃù_time_lim™
;

126 
u_shÜt
 
	mcÚÃù_time_lim™
;

127 
u_shÜt
 
	m_r2
;

134 
	sccs_geom‘ry


136 
u_ch¬
 
	m_r1
 : 2;

137 
u_ch¬
 
	m·ge_code
 : 6;

138 
u_ch¬
 
	m·ge_Ëngth
;

139 
u_ch¬
 
	mcyl_ub
;

140 
u_ch¬
 
	mcyl_mb
;

141 
u_ch¬
 
	mcyl_lb
;

142 
u_ch¬
 
	mh—ds
;

143 
u_ch¬
 
	m´ecomp_cyl_ub
;

144 
u_ch¬
 
	m´ecomp_cyl_mb
;

145 
u_ch¬
 
	m´ecomp_cyl_lb
;

146 
u_ch¬
 
	mcu¼’t_cyl_ub
;

147 
u_ch¬
 
	mcu¼’t_cyl_mb
;

148 
u_ch¬
 
	mcu¼’t_cyl_lb
;

149 
u_shÜt
 
	m¡•_¿‹
;

150 
u_ch¬
 
	mÏndšg_cyl_ub
;

151 
u_ch¬
 
	mÏndšg_cyl_mb
;

152 
u_ch¬
 
	mÏndšg_cyl_lb
;

153 
u_ch¬
 
	m_r2
;

154 
u_ch¬
 
	m_r3
;

155 
u_ch¬
 
	m_r4
;

162 
	sccs_ÿche


164 
u_ch¬
 
	m_r1
 : 2;

165 
u_ch¬
 
	m·ge_code
 : 6;

166 
u_ch¬
 
	m·ge_Ëngth
;

167 
u_ch¬
 
	mmode
;

168 
u_ch¬
 
	mth»shŞd
;

169 
u_ch¬
 
	mmax_´eãtch
;

170 
u_ch¬
 
	mmax_muÉl›r
;

171 
u_ch¬
 
	mmš_´eãtch
;

172 
u_ch¬
 
	mmš_muÉl›r
;

173 
u_ch¬
 
	m_r2
[8];

180 
	scdrom_msf


182 
u_ch¬
 
	mcdmsf_mš0
;

183 
u_ch¬
 
	mcdmsf_£c0
;

184 
u_ch¬
 
	mcdmsf_äame0
;

185 
u_ch¬
 
	mcdmsf_mš1
;

186 
u_ch¬
 
	mcdmsf_£c1
;

187 
u_ch¬
 
	mcdmsf_äame1
;

190 
	scdrom_ti


192 
u_ch¬
 
	mcdti_Œk0
;

193 
u_ch¬
 
	mcdti_šd0
;

194 
u_ch¬
 
	mcdti_Œk1
;

195 
u_ch¬
 
	mcdti_šd1
;

198 
	scdrom_tochdr


200 
u_ch¬
 
	mcdth_Œk0
;

201 
u_ch¬
 
	mcdth_Œk1
;

204 
	scdrom_toûÁry


206 
u_ch¬
 
	mcd‹_Œack
;

207 
u_ch¬
 
	mcd‹_adr
 :4;

208 
u_ch¬
 
	mcd‹_ù¾
 :4;

209 
u_ch¬
 
	mcd‹_fÜm©
;

214 
u_ch¬
 
	mmšu‹
;

215 
u_ch¬
 
	m£cÚd
;

216 
u_ch¬
 
	mäame
;

217 } 
	mmsf
;

218 
	mlba
;

219 } 
	mcd‹_addr
;

220 
u_ch¬
 
	mcd‹_d©amode
;

227 
	#CDROM_LBA
 0x01

	)

228 
	#CDROM_MSF
 0x02

	)

234 
	#CDROM_DATA_TRACK
 0x04

	)

240 
	#CDROM_LEADOUT
 0xAA

	)

242 
	scdrom_subchÆ


244 
u_ch¬
 
	mcdsc_fÜm©
;

245 
u_ch¬
 
	mcdsc_audio¡©us
;

246 
u_ch¬
 
	mcdsc_adr
: 4;

247 
u_ch¬
 
	mcdsc_ù¾
: 4;

248 
u_ch¬
 
	mcdsc_Œk
;

249 
u_ch¬
 
	mcdsc_šd
;

254 
u_ch¬
 
	mmšu‹
;

255 
u_ch¬
 
	m£cÚd
;

256 
u_ch¬
 
	mäame
;

257 } 
	mmsf
;

258 
	mlba
;

259 } 
	mcdsc_ab§ddr
;

264 
u_ch¬
 
	mmšu‹
;

265 
u_ch¬
 
	m£cÚd
;

266 
u_ch¬
 
	mäame
;

267 } 
	mmsf
;

268 
	mlba
;

269 } 
	mcdsc_»Ïddr
;

276 
	#CDROM_AUDIO_INVALID
 0x00

	)

277 
	#CDROM_AUDIO_PLAY
 0x11

	)

278 
	#CDROM_AUDIO_PAUSED
 0x12

	)

279 
	#CDROM_AUDIO_COMPLETED
 0x13

	)

280 
	#CDROM_AUDIO_ERROR
 0x14

	)

281 
	#CDROM_AUDIO_NO_STATUS
 0x15

	)

283 
	scdrom_vŞù¾


285 
u_ch¬
 
	mchªÃl0
;

286 
u_ch¬
 
	mchªÃl1
;

287 
u_ch¬
 
	mchªÃl2
;

288 
u_ch¬
 
	mchªÃl3
;

291 
	scdrom_»ad


293 
	mcd»ad_lba
;

294 
ÿddr_t
 
	mcd»ad_buçddr
;

295 
	mcd»ad_buæ’
;

298 #ifdeà
FIVETWELVE


299 
	#CDROM_MODE1_SIZE
 512

	)

301 
	#CDROM_MODE1_SIZE
 2048

	)

303 
	#CDROM_MODE2_SIZE
 2336

	)

309 
	#CDROMPAUSE
 0x5301

	)

310 
	#CDROMRESUME
 0x5302

	)

312 
	#CDROMPLAYMSF
 0x5303

	)

315 
	#CDROMPLAYTRKIND
 0x5304

	)

318 
	#CDROMREADTOCHDR
 0x5305

	)

320 
	#CDROMREADTOCENTRY
 0x5306

	)

323 
	#CDROMSTOP
 0x5307

	)

324 
	#CDROMSTART
 0x5308

	)

326 
	#CDROMEJECT
 0x5309

	)

328 
	#CDROMVOLCTRL
 0x530¨

	)

331 
	#CDROMSUBCHNL
 0x530b

	)

334 
	#CDROMREADMODE2
 0x530ø

	)

337 
	#CDROMREADMODE1
 0x530d

	)

	@include/linux/cdu31a.h

28 
	#SONY_CMD_REG_OFFSET
 0

	)

29 
	#SONY_PARAM_REG_OFFSET
 1

	)

30 
	#SONY_WRITE_REG_OFFSET
 2

	)

31 
	#SONY_CONTROL_REG_OFFSET
 3

	)

32 
	#SONY_ATTN_CLR_BIT
 0x01

	)

33 
	#SONY_RES_RDY_CLR_BIT
 0x02

	)

34 
	#SONY_DATA_RDY_CLR_BIT
 0x04

	)

35 
	#SONY_ATTN_INT_EN_BIT
 0x08

	)

36 
	#SONY_RES_RDY_INT_EN_BIT
 0x10

	)

37 
	#SONY_DATA_RDY_INT_EN_BIT
 0x20

	)

38 
	#SONY_PARAM_CLR_BIT
 0x40

	)

39 
	#SONY_DRIVE_RESET_BIT
 0x80

	)

45 
	#SONY_STATUS_REG_OFFSET
 0

	)

46 
	#SONY_ATTN_BIT
 0x01

	)

47 
	#SONY_RES_RDY_BIT
 0x02

	)

48 
	#SONY_DATA_RDY_BIT
 0x04

	)

49 
	#SONY_ATTN_INT_ST_BIT
 0x08

	)

50 
	#SONY_RES_RDY_INT_ST_BIT
 0x10

	)

51 
	#SONY_DATA_RDY_INT_ST_BIT
 0x20

	)

52 
	#SONY_DATA_REQUEST_BIT
 0x40

	)

53 
	#SONY_BUSY_BIT
 0x80

	)

54 
	#SONY_RESULT_REG_OFFSET
 1

	)

55 
	#SONY_READ_REG_OFFSET
 2

	)

56 
	#SONY_FIFOST_REG_OFFSET
 3

	)

57 
	#SONY_PARAM_WRITE_RDY_BIT
 0x01

	)

58 
	#SONY_PARAM_REG_EMPTY_BIT
 0x02

	)

59 
	#SONY_RES_REG_NOT_EMP_BIT
 0x04

	)

60 
	#SONY_RES_REG_FULL_BIT
 0x08

	)

62 
	#LOG_START_OFFSET
 150

	)

64 
	#SONY_DETECT_TIMEOUT
 80

	)

70 
	#SONY_JIFFIES_TIMEOUT
 500

	)

73 
	#SONY_RESET_TIMEOUT
 100

	)

76 
	#SONY_READY_RETRIES
 20000

	)

80 
	#MAX_CDU31A_RETRIES
 3

	)

84 
	#SONY_REQ_DRIVE_CONFIG_CMD
 0x00

	)

85 
	#SONY_REQ_DRIVE_MODE_CMD
 0x01

	)

86 
	#SONY_REQ_DRIVE_PARAM_CMD
 0x02

	)

87 
	#SONY_REQ_MECH_STATUS_CMD
 0x03

	)

88 
	#SONY_REQ_AUDIO_STATUS_CMD
 0x04

	)

89 
	#SONY_SET_DRIVE_PARAM_CMD
 0x10

	)

90 
	#SONY_REQ_TOC_DATA_CMD
 0x20

	)

91 
	#SONY_REQ_SUBCODE_ADDRESS_CMD
 0x21

	)

92 
	#SONY_REQ_UPC_EAN_CMD
 0x22

	)

93 
	#SONY_REQ_ISRC_CMD
 0x23

	)

94 
	#SONY_REQ_TOC_DATA_SPEC_CMD
 0x24

	)

97 
	#SONY_READ_TOC_CMD
 0x30

	)

98 
	#SONY_SEEK_CMD
 0x31

	)

99 
	#SONY_READ_CMD
 0x32

	)

100 
	#SONY_READ_BLKERR_STAT_CMD
 0x34

	)

101 
	#SONY_ABORT_CMD
 0x35

	)

102 
	#SONY_READ_TOC_SPEC_CMD
 0x36

	)

105 
	#SONY_AUDIO_PLAYBACK_CMD
 0x40

	)

106 
	#SONY_AUDIO_STOP_CMD
 0x41

	)

107 
	#SONY_AUDIO_SCAN_CMD
 0x42

	)

110 
	#SONY_EJECT_CMD
 0x50

	)

111 
	#SONY_SPIN_UP_CMD
 0x51

	)

112 
	#SONY_SPIN_DOWN_CMD
 0x52

	)

115 
	#SONY_WRITE_BUFFER_CMD
 0x60

	)

116 
	#SONY_READ_BUFFER_CMD
 0x61

	)

117 
	#SONY_DIAGNOSTICS_CMD
 0x62

	)

123 
	#SONY_SD_DECODE_PARAM
 0x00

	)

124 
	#SONY_SD_INTERFACE_PARAM
 0x01

	)

125 
	#SONY_SD_BUFFERING_PARAM
 0x02

	)

126 
	#SONY_SD_AUDIO_PARAM
 0x03

	)

127 
	#SONY_SD_AUDIO_VOLUME
 0x04

	)

128 
	#SONY_SD_MECH_CONTROL
 0x05

	)

129 
	#SONY_SD_AUTO_SPIN_DOWN_TIME
 0x06

	)

135 
	#SONY_HWC_GET_LOAD_MECH
(
c
è(c.
hw_cÚfig
[0] & 0x03)

	)

136 
	#SONY_HWC_EJECT
(
c
è(c.
hw_cÚfig
[0] & 0x04)

	)

137 
	#SONY_HWC_LED_SUPPORT
(
c
è(c.
hw_cÚfig
[0] & 0x08)

	)

138 
	#SONY_HWC_GET_BUF_MEM_SIZE
(
c
è((c.
hw_cÚfig
[0] & 0xc0è>> 6)

	)

139 
	#SONY_HWC_AUDIO_PLAYBACK
(
c
è(c.
hw_cÚfig
[1] & 0x01)

	)

140 
	#SONY_HWC_ELECTRIC_VOLUME
(
c
è(c.
hw_cÚfig
[1] & 0x02)

	)

141 
	#SONY_HWC_ELECTRIC_VOLUME_CTL
(
c
è(c.
hw_cÚfig
[1] & 0x04)

	)

143 
	#SONY_HWC_CADDY_LOAD_MECH
 0x00

	)

144 
	#SONY_HWC_TRAY_LOAD_MECH
 0x01

	)

145 
	#SONY_HWC_POPUP_LOAD_MECH
 0x02

	)

146 
	#SONY_HWC_UNKWN_LOAD_MECH
 0x03

	)

148 
	#SONY_HWC_8KB_BUFFER
 0x00

	)

149 
	#SONY_HWC_32KB_BUFFER
 0x01

	)

150 
	#SONY_HWC_64KB_BUFFER
 0x02

	)

151 
	#SONY_HWC_UNKWN_BUFFER
 0x03

	)

157 
	ss_sÚy_drive_cÚfig


159 
	mexec_¡©us
[2];

160 
	mv’dÜ_id
[8];

161 
	m´oduù_id
[16];

162 
	m´oduù_»v_Ëv–
[8];

163 
	mhw_cÚfig
[2];

167 
	ss_sÚy_subcode


169 
	mexec_¡©us
[2];

170 
	madd»ss
 :4;

171 
	mcÚŒŞ
 :4;

172 
	mŒack_num
;

173 
	mšdex_num
;

174 
	m»l_msf
[3];

175 
	m»£rved1
;

176 
	mabs_msf
[3];

183 
	ss_sÚy_toc


185 
	mexec_¡©us
[2];

186 
	madd»ss0
 :4;

187 
	mcÚŒŞ0
 :4;

188 
	mpošt0
;

189 
	mfœ¡_Œack_num
;

190 
	mdisk_ty³
;

191 
	mdummy0
;

192 
	madd»ss1
 :4;

193 
	mcÚŒŞ1
 :4;

194 
	mpošt1
;

195 
	mÏ¡_Œack_num
;

196 
	mdummy1
;

197 
	mdummy2
;

198 
	madd»ss2
 :4;

199 
	mcÚŒŞ2
 :4;

200 
	mpošt2
;

201 
	mËad_out_¡¬t_msf
[3];

204 
	madd»ss
 :4;

205 
	mcÚŒŞ
 :4;

206 
	mŒack
;

207 
	mŒack_¡¬t_msf
[3];

208 } 
	mŒacks
[100];

210 
	mËad_out_¡¬t_lba
;

219 
	#SONY_ILL_CMD_ERR
 0x10

	)

220 
	#SONY_ILL_PARAM_ERR
 0x11

	)

223 
	#SONY_NOT_LOAD_ERR
 0x20

	)

224 
	#SONY_NO_DISK_ERR
 0x21

	)

225 
	#SONY_NOT_SPIN_ERR
 0x22

	)

226 
	#SONY_SPIN_ERR
 0x23

	)

227 
	#SONY_SPINDLE_SERVO_ERR
 0x25

	)

228 
	#SONY_FOCUS_SERVO_ERR
 0x26

	)

229 
	#SONY_EJECT_MECH_ERR
 0x29

	)

230 
	#SONY_AUDIO_PLAYING_ERR
 0x2a

	)

231 
	#SONY_EMERGENCY_EJECT_ERR
 0x2c

	)

234 
	#SONY_FOCUS_ERR
 0x30

	)

235 
	#SONY_FRAME_SYNC_ERR
 0x31

	)

236 
	#SONY_SUBCODE_ADDR_ERR
 0x32

	)

237 
	#SONY_BLOCK_SYNC_ERR
 0x33

	)

238 
	#SONY_HEADER_ADDR_ERR
 0x34

	)

241 
	#SONY_ILL_TRACK_R_ERR
 0x40

	)

242 
	#SONY_MODE_0_R_ERR
 0x41

	)

243 
	#SONY_ILL_MODE_R_ERR
 0x42

	)

244 
	#SONY_ILL_BLOCK_SIZE_R_ERR
 0x43

	)

245 
	#SONY_MODE_R_ERR
 0x44

	)

246 
	#SONY_FORM_R_ERR
 0x45

	)

247 
	#SONY_LEAD_OUT_R_ERR
 0x46

	)

248 
	#SONY_BUFFER_OVERRUN_R_ERR
 0x47

	)

251 
	#SONY_UNREC_CIRC_ERR
 0x53

	)

252 
	#SONY_UNREC_LECC_ERR
 0x57

	)

255 
	#SONY_NO_TOC_ERR
 0x60

	)

256 
	#SONY_SUBCODE_DATA_NVAL_ERR
 0x61

	)

257 
	#SONY_FOCUS_ON_TOC_READ_ERR
 0x63

	)

258 
	#SONY_FRAME_SYNC_ON_TOC_READ_ERR
 0x64

	)

259 
	#SONY_TOC_DATA_ERR
 0x65

	)

262 
	#SONY_HW_FAILURE_ERR
 0x70

	)

263 
	#SONY_LEAD_IN_A_ERR
 0x91

	)

264 
	#SONY_LEAD_OUT_A_ERR
 0x92

	)

265 
	#SONY_DATA_TRACK_A_ERR
 0x93

	)

272 
	#SONY_NO_CIRC_ERR_BLK_STAT
 0x50

	)

273 
	#SONY_NO_LECC_ERR_BLK_STAT
 0x54

	)

274 
	#SONY_RECOV_LECC_ERR_BLK_STAT
 0x55

	)

275 
	#SONY_NO_ERR_DETECTION_STAT
 0x59

	)

281 
	#SONY_TIMEOUT_OP_ERR
 0x01

	)

282 
	#SONY_SIGNAL_OP_ERR
 0x02

	)

290 
	#SONY_EMER_EJECT_ATTN
 0x2c

	)

291 
	#SONY_HW_FAILURE_ATTN
 0x70

	)

292 
	#SONY_MECH_LOADED_ATTN
 0x80

	)

293 
	#SONY_EJECT_PUSHED_ATTN
 0x81

	)

296 
	#SONY_AUDIO_PLAY_DONE_ATTN
 0x90

	)

297 
	#SONY_LEAD_IN_ERR_ATTN
 0x91

	)

298 
	#SONY_LEAD_OUT_ERR_ATTN
 0x92

	)

299 
	#SONY_DATA_TRACK_ERR_ATTN
 0x93

	)

300 
	#SONY_AUDIO_PLAYBACK_ERR_ATTN
 0x94

	)

303 
	#SONY_SPIN_UP_COMPLETE_ATTN
 0x24

	)

304 
	#SONY_SPINDLE_SERVO_ERR_ATTN
 0x25

	)

305 
	#SONY_FOCUS_SERVO_ERR_ATTN
 0x26

	)

306 
	#SONY_TOC_READ_DONE_ATTN
 0x62

	)

307 
	#SONY_FOCUS_ON_TOC_READ_ERR_ATTN
 0x63

	)

308 
	#SONY_SYNC_ON_TOC_READ_ERR_ATTN
 0x65

	)

311 
	#SONY_SPIN_DOWN_COMPLETE_ATTN
 0x27

	)

312 
	#SONY_EJECT_COMPLETE_ATTN
 0x28

	)

313 
	#SONY_EJECT_MECH_ERR_ATTN
 0x29

	)

	@include/linux/coff.h

13 
	#E_SYMNMLEN
 8

	)

14 
	#E_FILNMLEN
 14

	)

15 
	#E_DIMNUM
 4

	)

25 
	#COFF_SHORT_L
(
ps
) (()((()(()ps[1])<<8)|\

26 (()(()
ps
[0]))))

	)

29 
	#COFF_LONG_L
(
ps
) ((()((()(()ps[3])<<24) |\

30 (()(()
ps
[2])<<16) |\

31 (()(()
ps
[1])<<8) |\

32 (()(()
ps
[0])))))

	)

35 
	#COFF_SHORT_H
(
ps
) (()((()(()ps[0])<<8)|\

36 (()(()
ps
[1]))))

	)

39 
	#COFF_LONG_H
(
ps
) ((()((()(()ps[0])<<24) |\

40 (()(()
ps
[1])<<16) |\

41 (()(()
ps
[2])<<8) |\

42 (()(()
ps
[3])))))

	)

49 
	#COFF_LONG
(
v
è
	`COFF_LONG_L
(v)

	)

50 
	#COFF_SHORT
(
v
è
	`COFF_SHORT_L
(v)

	)

56 
	sCOFF_fehdr
 {

57 
	mf_magic
[2];

58 
	mf_nsús
[2];

59 
	mf_timd©
[4];

60 
	mf_sym±r
[4];

61 
	mf_nsyms
[4];

62 
	mf_İthdr
[2];

63 
	mf_æags
[2];

88 
	#COFF_F_RELFLG
 0000001

	)

89 
	#COFF_F_EXEC
 0000002

	)

90 
	#COFF_F_LNNO
 0000004

	)

91 
	#COFF_F_LSYMS
 0000010

	)

92 
	#COFF_F_MINMAL
 0000020

	)

93 
	#COFF_F_UPDATE
 0000040

	)

94 
	#COFF_F_SWABD
 0000100

	)

95 
	#COFF_F_AR16WR
 0000200

	)

96 
	#COFF_F_AR32WR
 0000400

	)

97 
	#COFF_F_AR32W
 0001000

	)

98 
	#COFF_F_PATCH
 0002000

	)

99 
	#COFF_F_NODF
 0002000

	)

101 
	#COFF_I386MAGIC
 0x14ø

	)

104 
	#COFF_I386PTXMAGIC
 0x154

	)

105 
	#COFF_I386AIXMAGIC
 0x175

	)

106 
	#COFF_I386BADMAG
(
x
è((
	`COFF_SHORT
((x).
f_magic
è!ğ
COFF_I386MAGIC
) \

107 && 
	`COFF_SHORT
((
x
).
f_magic
è!ğ
COFF_I386PTXMAGIC
 \

108 && 
	`COFF_SHORT
((
x
).
f_magic
è!ğ
COFF_I386AIXMAGIC
)

	)

110 
	#COFF_I386BADMAG
(
x
è(
	`COFF_SHORT
((x).
f_magic
è!ğ
COFF_I386MAGIC
)

	)

113 
	#COFF_FILHDR
 
COFF_fehdr


	)

114 
	#COFF_FILHSZ
 (
COFF_FILHDR
)

	)

131 
	mmagic
[2];

132 
	mv¡amp
[2];

133 
	mtsize
[4];

134 
	mdsize
[4];

135 
	mbsize
[4];

136 
	m’Œy
[4];

137 
	m‹xt_¡¬t
[4];

138 
	md©a_¡¬t
[4];

140 
	tCOFF_AOUTHDR
;

142 
	#COFF_AOUTSZ
 ((
COFF_AOUTHDR
))

	)

144 
	#COFF_STMAGIC
 0401

	)

145 
	#COFF_OMAGIC
 0404

	)

146 
	#COFF_JMAGIC
 0407

	)

147 
	#COFF_DMAGIC
 0410

	)

148 
	#COFF_ZMAGIC
 0413

	)

149 
	#COFF_SHMAGIC
 0443

	)

153 
	sCOFF_súhdr
 {

154 
	ms_Çme
[8];

155 
	ms_·ddr
[4];

156 
	ms_vaddr
[4];

157 
	ms_size
[4];

158 
	ms_sú±r
[4];

159 
	ms_»ÍŒ
[4];

160 
	ms_ÊnİŒ
[4];

161 
	ms_Ä–oc
[2];

162 
	ms_ÆÂo
[2];

163 
	ms_æags
[4];

166 
	#COFF_SCNHDR
 
COFF_súhdr


	)

167 
	#COFF_SCNHSZ
 (
COFF_SCNHDR
)

	)

173 
	#COFF_TEXT
 ".‹xt"

	)

174 
	#COFF_DATA
 ".d©a"

	)

175 
	#COFF_BSS
 ".bss"

	)

176 
	#COFF_COMMENT
 ".comm’t"

	)

177 
	#COFF_LIB
 ".lib"

	)

179 
	#COFF_SECT_TEXT
 0

	)

180 
	#COFF_SECT_DATA
 1

	)

181 
	#COFF_SECT_BSS
 2

	)

182 
	#COFF_SECT_REQD
 3

	)

184 
	#COFF_STYP_REG
 0x00

	)

185 
	#COFF_STYP_DSECT
 0x01

	)

186 
	#COFF_STYP_NOLOAD
 0x02

	)

187 
	#COFF_STYP_GROUP
 0x04

	)

188 
	#COFF_STYP_PAD
 0x08

	)

189 
	#COFF_STYP_COPY
 0x10

	)

190 
	#COFF_STYP_TEXT
 0x20

	)

191 
	#COFF_STYP_DATA
 0x40

	)

192 
	#COFF_STYP_BSS
 0x80

	)

193 
	#COFF_STYP_INFO
 0x200

	)

194 
	#COFF_STYP_OVER
 0x400

	)

195 
	#COFF_STYP_LIB
 0x800

	)

202 
	sCOFF_¦ib
 {

203 
	m¦_’tsz
[4];

204 
	m¦_·thndx
[4];

207 
	#COFF_SLIBHD
 
COFF_¦ib


	)

208 
	#COFF_SLIBSZ
 (
COFF_SLIBHD
)

	)

218 
	sCOFF_lš’o
 {

220 
	ml_symndx
[4];

221 
	ml_·ddr
[4];

222 } 
	ml_addr
;

223 
	ml_Êno
[2];

226 
	#COFF_LINENO
 
COFF_lš’o


	)

227 
	#COFF_LINESZ
 6

	)

231 
	#COFF_E_SYMNMLEN
 8

	)

232 
	#COFF_E_FILNMLEN
 14

	)

233 
	#COFF_E_DIMNUM
 4

	)

239 
	sCOFF_sym’t


242 
	me_Çme
[
E_SYMNMLEN
];

244 
	me_z”Ûs
[4];

245 
	me_off£t
[4];

246 } 
	me
;

247 } 
	me
;

249 
	me_v®ue
[4];

250 
	me_súum
[2];

251 
	me_ty³
[2];

252 
	me_sşass
[1];

253 
	me_numaux
[1];

256 
	#COFF_N_BTMASK
 (0xfè

	)

257 
	#COFF_N_TMASK
 (0x30è

	)

258 
	#COFF_N_BTSHFT
 (4è

	)

259 
	#COFF_N_TSHIFT
 (2è

	)

265 
	uCOFF_aux’t
 {

272 
	mx_gndx
[4];

275 
	mx_Êno
[2];

276 
	mx_size
[2];

277 } 
	mx_Êsz
;

278 
	mx_fsize
[4];

279 } 
	mx_misc
;

283 
	mx_ÊnİŒ
[4];

284 
	mx_’dndx
[4];

285 } 
	mx_fú
;

288 
	mx_dim’
[
E_DIMNUM
][2];

289 } 
	mx_¬y
;

290 } 
	mx_fú¬y
;

292 
	mx_tvndx
[2];

293 } 
	mx_sym
;

300 
	mx_âame
[
E_FILNMLEN
];

302 
	mx_z”Ûs
[4];

303 
	mx_off£t
[4];

304 } 
	mx_n
;

305 } 
	mx_fe
;

312 
	mx_súËn
[4];

313 
	mx_Ä–oc
[2];

314 
	mx_Æšno
[2];

315 } 
	mx_sú
;

322 
	mx_tvfl
[4];

323 
	mx_tvËn
[2];

324 
	mx_tv¿n
[2][2];

325 } 
	mx_tv
;

328 
	#COFF_SYMENT
 
COFF_sym’t


	)

329 
	#COFF_SYMESZ
 18

	)

330 
	#COFF_AUXENT
 
COFF_aux’t


	)

331 
	#COFF_AUXESZ
 18

	)

333 
	#COFF_ETEXT
 "‘ext"

	)

337 
	sCOFF_»loc
 {

338 
	mr_vaddr
[4];

339 
	mr_symndx
[4];

340 
	mr_ty³
[2];

343 
	#COFF_RELOC
 
COFF_»loc


	)

344 
	#COFF_RELSZ
 10

	)

346 
	#COFF_DEF_DATA_SECTION_ALIGNMENT
 4

	)

347 
	#COFF_DEF_BSS_SECTION_ALIGNMENT
 4

	)

348 
	#COFF_DEF_TEXT_SECTION_ALIGNMENT
 4

	)

351 
	#COFF_DEF_SECTION_ALIGNMENT
 4

	)

	@include/linux/config.h

1 #iâdeà
_LINUX_CONFIG_H


2 
	#_LINUX_CONFIG_H


	)

4 
	~<lšux/autocÚf.h
>

9 #iâdeà
UTS_SYSNAME


10 
	#UTS_SYSNAME
 "Lšux"

	)

12 #iâdeà
UTS_NODENAME


13 
	#UTS_NODENAME
 "ÒÚe)"

	)

16 #iâdeà
UTS_MACHINE


17 
	#UTS_MACHINE
 "i386"

	)

20 #iâdeà
UTS_DOMAINNAME


21 
	#UTS_DOMAINNAME
 "ÒÚe)"

	)

30 
	#DEF_INITSEG
 0x9000

	)

31 
	#DEF_SYSSEG
 0x1000

	)

32 
	#DEF_SETUPSEG
 0x9020

	)

33 
	#DEF_SYSSIZE
 0x7F00

	)

36 
	#NORMAL_VGA
 0xfffà

	)

37 
	#EXTENDED_VGA
 0xffã

	)

38 
	#ASK_VGA
 0xfffd

	)

76 #undeà
HD_TYPE


82 #ifdeà
ASM_SRC


85 #ifdeà
C_SRC


88 #ifdeà
MAKE


	@include/linux/ctype.h

1 #iâdeà
_LINUX_CTYPE_H


2 
	#_LINUX_CTYPE_H


	)

4 
	#_U
 0x01

	)

5 
	#_L
 0x02

	)

6 
	#_D
 0x04

	)

7 
	#_C
 0x08

	)

8 
	#_P
 0x10

	)

9 
	#_S
 0x20

	)

10 
	#_X
 0x40

	)

11 
	#_SP
 0x80

	)

13 
_ùy³
[];

14 
_ùmp
;

16 
	#i§Êum
(
c
è((
_ùy³
+1)[c]&(
_U
|
_L
|
_D
))

	)

17 
	#i§Íha
(
c
è((
_ùy³
+1)[c]&(
_U
|
_L
))

	)

18 
	#isúŒl
(
c
è((
_ùy³
+1)[c]&(
_C
))

	)

19 
	#isdig™
(
c
è((
_ùy³
+1)[c]&(
_D
))

	)

20 
	#isg¿ph
(
c
è((
_ùy³
+1)[c]&(
_P
|
_U
|
_L
|
_D
))

	)

21 
	#i¦ow”
(
c
è((
_ùy³
+1)[c]&(
_L
))

	)

22 
	#i¥ršt
(
c
è((
_ùy³
+1)[c]&(
_P
|
_U
|
_L
|
_D
|
_SP
))

	)

23 
	#i¥unù
(
c
è((
_ùy³
+1)[c]&(
_P
))

	)

24 
	#is¥aû
(
c
è((
_ùy³
+1)[c]&(
_S
))

	)

25 
	#isuµ”
(
c
è((
_ùy³
+1)[c]&(
_U
))

	)

26 
	#isxdig™
(
c
è((
_ùy³
+1)[c]&(
_D
|
_X
))

	)

28 
	#i§scii
(
c
è(((èc)<=0x7f)

	)

29 
	#tßscii
(
c
è(((èc)&0x7f)

	)

31 
	#tŞow”
(
c
è(
_ùmp
=c,
	`isuµ”
(_ùmp)?_ùmp-('A'-'a'):_ùmp)

	)

32 
	#touµ”
(
c
è(
_ùmp
=c,
	`i¦ow”
(_ùmp)?_ùmp-('a'-'A'):_ùmp)

	)

	@include/linux/ddi.h

11 #iâdeà
_LINUX_DDI_H


12 
	#_LINUX_DDI_H


	)

16 
	#DDI_FREADY
 0x10000000

	)

17 
	#DDI_FPRESENT
 0x20000000

	)

18 
	#DDI_FBLKDEV
 0x00000001

	)

19 
	#DDI_FCHRDEV
 0x00000002

	)

22 
	#DDI_MAXNAME
 16

	)

26 
	sddcÚf
 {

27 
	mißddr
;

28 
	mißux
;

29 
	mœq
;

30 
	mdma
;

31 
	mmemsize
;

32 
	mmemaddr
;

37 
	sddi_deviû
 {

38 *
	mt™Ë
;

39 
	mÇme
[
DDI_MAXNAME
];

40 
	mun™
;

41 
	mnun™s
;

42 (*
	mš™
)(
	mddi_deviû
 *);

43 (*
	mhªdËr
)(, ...);

44 
	mmajÜ
;

45 
	mmšÜ
;

46 
	mæags
;

47 
ddcÚf
 
	mcÚfig
;

52 
	sddi_´Ùo
 {

53 *
	mÇme
;

54 (*
	mš™
)(
	mddi_´Ùo
 *);

59 
	siæšk
 {

60 
	mid
[
DDI_MAXNAME
];

61 
	m¡»am
[
DDI_MAXNAME
];

62 
	mçmy
;

63 
	mæags
;

68 
	#DDIOCSDBG
 0x9000

	)

69 
	#DDIOCGNAME
 0x9001

	)

70 
	#DDIOCGCONF
 0x9002

	)

71 
	#DDIOCSCONF
 0x9003

	)

75 
ddi_š™
();

76 
ddi_deviû
 *
ddi_m­
(cÚ¡ *
id
);

	@include/linux/debugreg.h

1 #iâdeà
_LINUX_DEBUGREG_H


2 
	#_LINUX_DEBUGREG_H


	)

7 
	#DR_FIRSTADDR
 0

	)

8 
	#DR_LASTADDR
 3

	)

10 
	#DR_STATUS
 6

	)

11 
	#DR_CONTROL
 7

	)

17 
	#DR_TRAP0
 (0x1è

	)

18 
	#DR_TRAP1
 (0x2è

	)

19 
	#DR_TRAP2
 (0x4è

	)

20 
	#DR_TRAP3
 (0x8è

	)

28 
	#DR_CONTROL_SHIFT
 16

	)

29 
	#DR_CONTROL_SIZE
 4

	)

31 
	#DR_RW_EXECUTE
 (0x0è

	)

32 
	#DR_RW_WRITE
 (0x1)

	)

33 
	#DR_RW_READ
 (0x3)

	)

35 
	#DR_LEN_1
 (0x0è

	)

36 
	#DR_LEN_2
 (0x4)

	)

37 
	#DR_LEN_4
 (0xC)

	)

46 
	#DR_LOCAL_ENABLE_SHIFT
 0

	)

47 
	#DR_GLOBAL_ENABLE_SHIFT
 1

	)

48 
	#DR_ENABLE_SIZE
 2

	)

50 
	#DR_LOCAL_ENABLE_MASK
 (0x55è

	)

51 
	#DR_GLOBAL_ENABLE_MASK
 (0xAAè

	)

57 
	#DR_CONTROL_RESERVED
 (0xFC00è

	)

58 
	#DR_LOCAL_SLOWDOWN
 (0x100è

	)

59 
	#DR_GLOBAL_SLOWDOWN
 (0x200è

	)

	@include/linux/delay.h

1 #iâdeà
_LINUX_DELAY_H


2 
	#_LINUX_DELAY_H


	)

10 
loİs_³r_£c
;

12 
__šlše__
 
	$__d–ay
(
loİs
)

14 
	`__asm__
(".®igÀ2,0x90\n1:\tdeş %0\n\tjn 1b": :"a" (
loİs
):"ax");

15 
	}
}

27 
__šlše__
 
	$ud–ay
(
u£cs
)

29 
u£cs
 *= 0x000010c6;

30 
	`__asm__
("mull %0"

31 :"=d" (
u£cs
)

32 :"a" (
u£cs
),"0" (
loİs_³r_£c
)

34 
	`__d–ay
(
u£cs
);

35 
	}
}

	@include/linux/dirent.h

1 #iâdeà
_LINUX_DIRENT_H


2 
	#_LINUX_DIRENT_H


	)

4 
	~<lšux/lim™s.h
>

6 
	sdœ’t
 {

7 
	md_šo
;

8 
off_t
 
	md_off
;

9 
	md_»ş’
;

10 
	md_Çme
[
NAME_MAX
+1];

	@include/linux/elf.h

1 #iâdeà
_ELF_H


2 
	#_ELF_H


	)

5 
	#PT_NULL
 0

	)

6 
	#PT_LOAD
 1

	)

7 
	#PT_DYNAMIC
 2

	)

8 
	#PT_INTERP
 3

	)

9 
	#PT_NOTE
 4

	)

10 
	#PT_SHLIB
 5

	)

11 
	#PT_PHDR
 6

	)

12 
	#PT_LOPROC
 0x70000000

	)

13 
	#PT_HIPROC
 0x7fffffff

	)

16 
	#ET_NONE
 0

	)

17 
	#ET_REL
 1

	)

18 
	#ET_EXEC
 2

	)

19 
	#ET_DYN
 3

	)

20 
	#ET_CORE
 4

	)

21 
	#ET_LOPROC
 5

	)

22 
	#ET_HIPROC
 6

	)

25 
	#EM_NONE
 0

	)

26 
	#EM_M32
 1

	)

27 
	#EM_SPARC
 2

	)

28 
	#EM_386
 3

	)

29 
	#EM_68K
 4

	)

30 
	#EM_88K
 5

	)

31 
	#EM_486
 6

	)

32 
	#EM_860
 7

	)

35 
	#DT_NULL
 0

	)

36 
	#DT_NEEDED
 1

	)

37 
	#DT_PLTRELSZ
 2

	)

38 
	#DT_PLTGOT
 3

	)

39 
	#DT_HASH
 4

	)

40 
	#DT_STRTAB
 5

	)

41 
	#DT_SYMTAB
 6

	)

42 
	#DT_RELA
 7

	)

43 
	#DT_RELASZ
 8

	)

44 
	#DT_RELAENT
 9

	)

45 
	#DT_STRSZ
 10

	)

46 
	#DT_SYMENT
 11

	)

47 
	#DT_INIT
 12

	)

48 
	#DT_FINI
 13

	)

49 
	#DT_SONAME
 14

	)

50 
	#DT_RPATH
 15

	)

51 
	#DT_SYMBOLIC
 16

	)

52 
	#DT_REL
 17

	)

53 
	#DT_RELSZ
 18

	)

54 
	#DT_RELENT
 19

	)

55 
	#DT_PLTREL
 20

	)

56 
	#DT_DEBUG
 21

	)

57 
	#DT_TEXTREL
 22

	)

58 
	#DT_JMPREL
 23

	)

59 
	#DT_LOPROC
 0x70000000

	)

60 
	#DT_HIPROC
 0x7fffffff

	)

63 
	#STB_LOCAL
 0

	)

64 
	#STB_GLOBAL
 1

	)

65 
	#STB_WEAK
 2

	)

67 
	#STT_NOTYPE
 0

	)

68 
	#STT_OBJECT
 1

	)

69 
	#STT_FUNC
 2

	)

70 
	#STT_SECTION
 3

	)

71 
	#STT_FILE
 4

	)

73 
	#ELF32_ST_BIND
(
x
è((xè>> 4)

	)

74 
	#ELF32_ST_TYPE
(
x
è(((èxè& 0xf)

	)

78 
	sdyÇmic
{

79 
	md_g
;

81 
	md_v®
;

82 * 
	md_±r
;

83 } 
	md_un
;

87 
	#ELF32_R_SYM
(
x
è((xè>> 8)

	)

88 
	#ELF32_R_TYPE
(
x
è((xè& 0xff)

	)

90 
	#R_386_NONE
 0

	)

91 
	#R_386_32
 1

	)

92 
	#R_386_PC32
 2

	)

93 
	#R_386_GOT32
 3

	)

94 
	#R_386_PLT32
 4

	)

95 
	#R_386_COPY
 5

	)

96 
	#R_386_GLOB_DAT
 6

	)

97 
	#R_386_JMP_SLOT
 7

	)

98 
	#R_386_RELATIVE
 8

	)

99 
	#R_386_GOTOFF
 9

	)

100 
	#R_386_GOTPC
 10

	)

101 
	#R_386_NUM
 11

	)

103 
	sElf32_R–
{

104 * 
	moff£t
;

105 
	mšfo
;

108 
	sElf32_R–a
{

109 * 
	moff£t
;

110 
	mšfo
;

111 
	madd’d
;

114 
	sElf32_Sym
{

115 
	m¡_Çme
;

116 
	m¡_v®ue
;

117 
	m¡_size
;

118 
	m¡_šfo
;

119 
	m¡_Ùh”
;

120 
	m¡_shndx
;

123 
	s–fhdr
{

124 
	me_id’t
[16];

125 
	me_ty³
;

126 
	me_machše
;

127 
	me_v”siÚ
;

128 *
	me_’Œy
;

129 
	me_phoff
;

130 
	me_shoff
;

131 
	me_æags
;

132 
	me_ehsize
;

133 
	me_ph’tsize
;

134 
	me_phnum
;

135 
	me_sh’tsize
;

136 
	me_shnum
;

137 
	me_sh¡ºdx
;

140 
	s–f_phdr
{

141 
	mp_ty³
;

142 
	mp_off£t
;

143 
	mp_vaddr
;

144 
	mp_·ddr
;

145 
	mp_fesz
;

146 
	mp_memsz
;

147 
	mp_æags
;

148 
	mp_®ign
;

151 
	#ELF_START_MMAP
 0x80000000

	)

	@include/linux/errno.h

1 #iâdeà
_LINUX_ERRNO_H


2 
	#_LINUX_ERRNO_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

38 
	#EDEADLK
 35

	)

39 
	#ENAMETOOLONG
 36

	)

40 
	#ENOLCK
 37

	)

41 
	#ENOSYS
 38

	)

42 
	#ENOTEMPTY
 39

	)

43 
	#ELOOP
 40

	)

44 
	#EWOULDBLOCK
 
EAGAIN


	)

45 
	#ENOMSG
 42

	)

46 
	#EIDRM
 43

	)

47 
	#ECHRNG
 44

	)

48 
	#EL2NSYNC
 45

	)

49 
	#EL3HLT
 46

	)

50 
	#EL3RST
 47

	)

51 
	#ELNRNG
 48

	)

52 
	#EUNATCH
 49

	)

53 
	#ENOCSI
 50

	)

54 
	#EL2HLT
 51

	)

55 
	#EBADE
 52

	)

56 
	#EBADR
 53

	)

57 
	#EXFULL
 54

	)

58 
	#ENOANO
 55

	)

59 
	#EBADRQC
 56

	)

60 
	#EBADSLT
 57

	)

61 
	#EDEADLOCK
 58

	)

62 
	#EBFONT
 59

	)

63 
	#ENOSTR
 60

	)

64 
	#ENODATA
 61

	)

65 
	#ETIME
 62

	)

66 
	#ENOSR
 63

	)

67 
	#ENONET
 64

	)

68 
	#ENOPKG
 65

	)

69 
	#EREMOTE
 66

	)

70 
	#ENOLINK
 67

	)

71 
	#EADV
 68

	)

72 
	#ESRMNT
 69

	)

73 
	#ECOMM
 70

	)

74 
	#EPROTO
 71

	)

75 
	#EMULTIHOP
 72

	)

76 
	#EDOTDOT
 73

	)

77 
	#EBADMSG
 74

	)

78 
	#EOVERFLOW
 75

	)

79 
	#ENOTUNIQ
 76

	)

80 
	#EBADFD
 77

	)

81 
	#EREMCHG
 78

	)

82 
	#ELIBACC
 79

	)

83 
	#ELIBBAD
 80

	)

84 
	#ELIBSCN
 81

	)

85 
	#ELIBMAX
 82

	)

86 
	#ELIBEXEC
 83

	)

87 
	#EILSEQ
 84

	)

88 
	#ERESTART
 85

	)

89 
	#ESTRPIPE
 86

	)

90 
	#EUSERS
 87

	)

91 
	#ENOTSOCK
 88

	)

92 
	#EDESTADDRREQ
 89

	)

93 
	#EMSGSIZE
 90

	)

94 
	#EPROTOTYPE
 91

	)

95 
	#ENOPROTOOPT
 92

	)

96 
	#EPROTONOSUPPORT
 93

	)

97 
	#ESOCKTNOSUPPORT
 94

	)

98 
	#EOPNOTSUPP
 95

	)

99 
	#EPFNOSUPPORT
 96

	)

100 
	#EAFNOSUPPORT
 97

	)

101 
	#EADDRINUSE
 98

	)

102 
	#EADDRNOTAVAIL
 99

	)

103 
	#ENETDOWN
 100

	)

104 
	#ENETUNREACH
 101

	)

105 
	#ENETRESET
 102

	)

106 
	#ECONNABORTED
 103

	)

107 
	#ECONNRESET
 104

	)

108 
	#ENOBUFS
 105

	)

109 
	#EISCONN
 106

	)

110 
	#ENOTCONN
 107

	)

111 
	#ESHUTDOWN
 108

	)

112 
	#ETOOMANYREFS
 109

	)

113 
	#ETIMEDOUT
 110

	)

114 
	#ECONNREFUSED
 111

	)

115 
	#EHOSTDOWN
 112

	)

116 
	#EHOSTUNREACH
 113

	)

117 
	#EALREADY
 114

	)

118 
	#EINPROGRESS
 115

	)

119 
	#ESTALE
 116

	)

120 
	#EUCLEAN
 117

	)

121 
	#ENOTNAM
 118

	)

122 
	#ENAVAIL
 119

	)

123 
	#EISNAM
 120

	)

124 
	#EREMOTEIO
 121

	)

125 
	#EDQUOT
 122

	)

128 
	#ERESTARTSYS
 512

	)

129 
	#ERESTARTNOINTR
 513

	)

130 
	#ERESTARTNOHAND
 514

	)

	@include/linux/ext2_fs.h

15 #iâdeà
_LINUX_EXT2_FS_H


16 
	#_LINUX_EXT2_FS_H


	)

25 #undeà
EXT2FS_DEBUG


30 #undeà
EXT2FS_DEBUG_CACHE


35 #undeà
EXT2FS_CHECK_CACHE


40 #undeà
EXT2FS_PRE_02B_COMPAT


45 
	#DONT_USE_DCACHE


	)

50 
	#EXT2_PREALLOCATE


	)

55 
	#EXT2FS_DATE
 "94/03/10"

	)

56 
	#EXT2FS_VERSION
 "0.5"

	)

61 #ifdeà
EXT2FS_DEBUG


62 
	#ext2_debug
(
f
, 
a
...) { \

63 
	`´štk
 ("EXT2-fs DEBUG (%s, %d): %s:", \

64 
__FILE__
, 
__LINE__
, 
__FUNCTION__
); \

65 
	`´štk
 (
f
, ## 
a
); \

66 }

	)

68 
	#ext2_debug
(
f
, 
a
...è

	)

74 
	#EXT2_BAD_INO
 1

	)

75 
	#EXT2_ROOT_INO
 2

	)

76 
	#EXT2_ACL_IDX_INO
 3

	)

77 
	#EXT2_ACL_DATA_INO
 4

	)

78 
	#EXT2_BOOT_LOADER_INO
 5

	)

79 
	#EXT2_UNDEL_DIR_INO
 6

	)

80 
	#EXT2_FIRST_INO
 11

	)

85 
	#EXT2_PRE_02B_MAGIC
 0xEF51

	)

86 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

91 
	#EXT2_LINK_MAX
 32000

	)

96 
	#EXT2_MIN_BLOCK_SIZE
 1024

	)

97 
	#EXT2_MAX_BLOCK_SIZE
 4096

	)

98 
	#EXT2_MIN_BLOCK_LOG_SIZE
 10

	)

99 #ifdeà
__KERNEL__


100 
	#EXT2_BLOCK_SIZE
(
s
è((s)->
s_blocksize
)

	)

102 
	#EXT2_BLOCK_SIZE
(
s
è(
EXT2_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

104 
	#EXT2_ACLE_PER_BLOCK
(
s
è(
	`EXT2_BLOCK_SIZE
(sè/  (
ext2_aş_’Œy
))

	)

105 
	#EXT2_ADDR_PER_BLOCK
(
s
è(
	`EXT2_BLOCK_SIZE
(sè/  ())

	)

106 #ifdeà
__KERNEL__


107 
	#EXT2_BLOCK_SIZE_BITS
(
s
è((s)->
u
.
ext2_sb
.
s_es
->
s_log_block_size
 + 10)

	)

109 
	#EXT2_BLOCK_SIZE_BITS
(
s
è((s)->
s_log_block_size
 + 10)

	)

111 
	#EXT2_INODES_PER_BLOCK
(
s
è(
	`EXT2_BLOCK_SIZE
(sè/  (
ext2_šode
))

	)

116 
	#EXT2_MIN_FRAG_SIZE
 1024

	)

117 
	#EXT2_MAX_FRAG_SIZE
 4096

	)

118 
	#EXT2_MIN_FRAG_LOG_SIZE
 10

	)

119 #ifdeà
__KERNEL__


120 
	#EXT2_FRAG_SIZE
(
s
è((s)->
u
.
ext2_sb
.
s_äag_size
)

	)

121 
	#EXT2_FRAGS_PER_BLOCK
(
s
è((s)->
u
.
ext2_sb
.
s_äags_³r_block
)

	)

123 
	#EXT2_FRAG_SIZE
(
s
è(
EXT2_MIN_FRAG_SIZE
 << (s)->
s_log_äag_size
)

	)

124 
	#EXT2_FRAGS_PER_BLOCK
(
s
è(
	`EXT2_BLOCK_SIZE
(sè/ 
	`EXT2_FRAG_SIZE
(s))

	)

130 
	sext2_aş_h—d”


132 
	maşh_size
;

133 
	maşh_fe_couÁ
;

134 
	maşh_aşe_couÁ
;

135 
	maşh_fœ¡_aşe
;

138 
	sext2_aş_’Œy


140 
	maşe_size
;

141 
	maşe_³rms
;

142 
	maşe_ty³
;

143 
	maşe_g
;

144 
	maşe_·d1
;

145 
	maşe_Ãxt
;

152 
	sext2_Şd_group_desc


154 
	mbg_block_b™m­
;

155 
	mbg_šode_b™m­
;

156 
	mbg_šode_bË
;

157 
	mbg_ä“_blocks_couÁ
;

158 
	mbg_ä“_šodes_couÁ
;

161 
	sext2_group_desc


163 
	mbg_block_b™m­
;

164 
	mbg_šode_b™m­
;

165 
	mbg_šode_bË
;

166 
	mbg_ä“_blocks_couÁ
;

167 
	mbg_ä“_šodes_couÁ
;

168 
	mbg_u£d_dœs_couÁ
;

169 
	mbg_·d
;

170 
	mbg_»£rved
[3];

176 #ifdeà
__KERNEL__


177 
	#EXT2_BLOCKS_PER_GROUP
(
s
è((s)->
u
.
ext2_sb
.
s_blocks_³r_group
)

	)

178 
	#EXT2_DESC_PER_BLOCK
(
s
è((s)->
u
.
ext2_sb
.
s_desc_³r_block
)

	)

179 
	#EXT2_INODES_PER_GROUP
(
s
è((s)->
u
.
ext2_sb
.
s_šodes_³r_group
)

	)

181 
	#EXT2_BLOCKS_PER_GROUP
(
s
è((s)->
s_blocks_³r_group
)

	)

182 
	#EXT2_DESC_PER_BLOCK
(
s
è(
	`EXT2_BLOCK_SIZE
(sè/  (
ext2_group_desc
))

	)

183 
	#EXT2_INODES_PER_GROUP
(
s
è((s)->
s_šodes_³r_group
)

	)

189 
	#EXT2_NDIR_BLOCKS
 12

	)

190 
	#EXT2_IND_BLOCK
 
EXT2_NDIR_BLOCKS


	)

191 
	#EXT2_DIND_BLOCK
 (
EXT2_IND_BLOCK
 + 1)

	)

192 
	#EXT2_TIND_BLOCK
 (
EXT2_DIND_BLOCK
 + 1)

	)

193 
	#EXT2_N_BLOCKS
 (
EXT2_TIND_BLOCK
 + 1)

	)

198 
	#EXT2_SECRM_FL
 0x0001

	)

199 
	#EXT2_UNRM_FL
 0x0002

	)

200 
	#EXT2_COMPR_FL
 0x0004

	)

201 
	#EXT2_SYNC_FL
 0x0008

	)

206 
	#EXT2_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#EXT2_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#EXT2_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#EXT2_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

214 
	sext2_šode
 {

215 
	mi_mode
;

216 
	mi_uid
;

217 
	mi_size
;

218 
	mi_©ime
;

219 
	mi_ùime
;

220 
	mi_mtime
;

221 
	mi_dtime
;

222 
	mi_gid
;

223 
	mi_lšks_couÁ
;

224 
	mi_blocks
;

225 
	mi_æags
;

226 
	mi_»£rved1
;

227 
	mi_block
[
EXT2_N_BLOCKS
];

228 
	mi_v”siÚ
;

229 
	mi_fe_aş
;

230 
	mi_dœ_aş
;

231 
	mi_çddr
;

232 
	mi_äag
;

233 
	mi_fsize
;

234 
	mi_·d1
;

235 
	mi_»£rved2
[2];

241 
	#EXT2_VALID_FS
 0x0001

	)

242 
	#EXT2_ERROR_FS
 0x0002

	)

247 
	#EXT2_MOUNT_CHECK_NORMAL
 0x0001

	)

248 
	#EXT2_MOUNT_CHECK_STRICT
 0x0002

	)

249 
	#EXT2_MOUNT_CHECK
 (
EXT2_MOUNT_CHECK_NORMAL
 | \

250 
EXT2_MOUNT_CHECK_STRICT
)

	)

251 
	#EXT2_MOUNT_GRPID
 0x0004

	)

252 
	#EXT2_MOUNT_DEBUG
 0x0008

	)

253 
	#EXT2_MOUNT_ERRORS_CONT
 0x0010

	)

254 
	#EXT2_MOUNT_ERRORS_RO
 0x0020

	)

255 
	#EXT2_MOUNT_ERRORS_PANIC
 0x0040

	)

257 
	#ş—r_İt
(
o
, 
İt
èØ&ğ~
EXT2_MOUNT_
##
	)
opt

258 
	#£t_İt
(
o
, 
İt
èØ|ğ
EXT2_MOUNT_
##
	)
opt

259 
	#‹¡_İt
(
sb
, 
İt
è((sb)->
u
.
ext2_sb
.
s_mouÁ_İt
 & \

260 
EXT2_MOUNT_
##
İt
)

	)

264 
	#EXT2_DFL_MAX_MNT_COUNT
 20

	)

265 
	#EXT2_DFL_CHECKINTERVAL
 0

	)

270 
	#EXT2_ERRORS_CONTINUE
 1

	)

271 
	#EXT2_ERRORS_RO
 2

	)

272 
	#EXT2_ERRORS_PANIC
 3

	)

273 
	#EXT2_ERRORS_DEFAULT
 
EXT2_ERRORS_CONTINUE


	)

278 
	sext2_su³r_block
 {

279 
	ms_šodes_couÁ
;

280 
	ms_blocks_couÁ
;

281 
	ms_r_blocks_couÁ
;

282 
	ms_ä“_blocks_couÁ
;

283 
	ms_ä“_šodes_couÁ
;

284 
	ms_fœ¡_d©a_block
;

285 
	ms_log_block_size
;

286 
	ms_log_äag_size
;

287 
	ms_blocks_³r_group
;

288 
	ms_äags_³r_group
;

289 
	ms_šodes_³r_group
;

290 
	ms_mtime
;

291 
	ms_wtime
;

292 
	ms_mÁ_couÁ
;

293 
	ms_max_mÁ_couÁ
;

294 
	ms_magic
;

295 
	ms_¡©e
;

296 
	ms_”rÜs
;

297 
	ms_·d
;

298 
	ms_Ï¡check
;

299 
	ms_checkš‹rv®
;

300 
	ms_»£rved
[238];

306 
	#EXT2_NAME_LEN
 255

	)

308 
	sext2_dœ_’Œy
 {

309 
	mšode
;

310 
	m»c_Ën
;

311 
	mÇme_Ën
;

312 
	mÇme
[
EXT2_NAME_LEN
];

320 
	#EXT2_DIR_PAD
 4

	)

321 
	#EXT2_DIR_ROUND
 (
EXT2_DIR_PAD
 - 1)

	)

322 
	#EXT2_DIR_REC_LEN
(
Çme_Ën
è((Òame_Ënè+ 8 + 
EXT2_DIR_ROUND
) & \

323 ~
EXT2_DIR_ROUND
)

	)

325 #ifdeà
__KERNEL__


334 #ià
__GNUC__
 < 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 < 5)

335 
	#NORET_TYPE
 
__vŞ©e__


	)

336 
	#ATTRIB_NORET


	)

337 
	#NORET_AND


	)

339 
	#NORET_TYPE


	)

340 
	#ATTRIB_NORET
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

341 
	#NORET_AND
 
nÜ‘uº
,

	)

345 
ext2_³rmissiÚ
 (
šode
 *, );

348 
ext2_Ãw_block
 (
su³r_block
 *, ,

350 
ext2_ä“_blocks
 (
su³r_block
 *, ,

352 
ext2_couÁ_ä“_blocks
 (
su³r_block
 *);

353 
ext2_check_blocks_b™m­
 (
su³r_block
 *);

356 
ext2_couÁ_ä“
 (
bufãr_h—d
 *, );

358 #iâdeà
DONT_USE_DCACHE


360 
ext2_dÿche_šv®id©e
 ();

361 
ext2_dÿche_lookup
 (, ,

363 
ext2_dÿche_add
 (, , const *,

365 
ext2_dÿche_»move
 (, , const *,

370 
ext2_check_dœ_’Œy
 (*, 
šode
 *,

371 
ext2_dœ_’Œy
 *, 
bufãr_h—d
 *,

375 
ext2_»ad
 (
šode
 *, 
fe
 *, *, );

376 
ext2_wr™e
 (
šode
 *, 
fe
 *, *, );

379 
ext2_sync_fe
 (
šode
 *, 
fe
 *);

382 
šode
 * 
ext2_Ãw_šode
 (const inode *, );

383 
ext2_ä“_šode
 (
šode
 *);

384 
ext2_couÁ_ä“_šodes
 (
su³r_block
 *);

385 
ext2_check_šodes_b™m­
 (
su³r_block
 *);

388 
ext2_bm­
 (
šode
 *, );

390 
bufãr_h—d
 * 
ext2_g‘blk
 (
šode
 *, , , *);

391 
bufãr_h—d
 * 
ext2_b»ad
 (
šode
 *, , , *);

393 
ext2_»ad_šode
 (
šode
 *);

394 
ext2_wr™e_šode
 (
šode
 *);

395 
ext2_put_šode
 (
šode
 *);

396 
ext2_sync_šode
 (
šode
 *);

397 
ext2_disÿrd_´—Îoc
 (
šode
 *);

400 
ext2_ioùl
 (
šode
 *, 
fe
 *, ,

404 
ext2_İ’
 (
šode
 *, 
fe
 *);

405 
ext2_»Ëa£
 (
šode
 *, 
fe
 *);

406 
ext2_lookup
 (
šode
 *,const *, , inode **);

407 
ext2_ü—‹
 (
šode
 *,const *, , ,

408 
šode
 **);

409 
ext2_mkdœ
 (
šode
 *, const *, , );

410 
ext2_rmdœ
 (
šode
 *, const *, );

411 
ext2_uÆšk
 (
šode
 *, const *, );

412 
ext2_symlšk
 (
šode
 *, const *, , const *);

413 
ext2_lšk
 (
šode
 *, inode *, const *, );

414 
ext2_mknod
 (
šode
 *, const *, , , );

415 
ext2_»Çme
 (
šode
 *, const *, ,

416 
šode
 *, const *, );

419 
	$ext2_”rÜ
 (
su³r_block
 *, const *, const *, ...)

420 
	`__©Œibu‹__
 ((
	`fÜm©
 (
´štf
, 3, 4)));

421 
NORET_TYPE
 
	$ext2_·nic
 (
su³r_block
 *, const *,

423 
	`__©Œibu‹__
 ((
NORET_AND
 
	`fÜm©
 (
´štf
, 3, 4)));

424 
	$ext2_w¬nšg
 (
su³r_block
 *, const *, const *, ...)

425 
	`__©Œibu‹__
 ((
	`fÜm©
 (
´štf
, 3, 4)));

426 
	`ext2_put_su³r
 (
su³r_block
 *);

427 
	`ext2_wr™e_su³r
 (
su³r_block
 *);

428 
	`ext2_»mouÁ
 (
su³r_block
 *, *, *);

429 
su³r_block
 * 
	`ext2_»ad_su³r
 (super_block *,*,);

430 
	`ext2_¡©fs
 (
su³r_block
 *, 
¡©fs
 *);

433 
	`ext2_Œunÿ‹
 (
šode
 *);

440 
šode_İ”©iÚs
 
ext2_dœ_šode_İ”©iÚs
;

443 
šode_İ”©iÚs
 
ext2_fe_šode_İ”©iÚs
;

446 
šode_İ”©iÚs
 
ext2_symlšk_šode_İ”©iÚs
;

	@include/linux/ext2_fs_i.h

15 #iâdeà
_LINUX_EXT2_FS_I


16 
	#_LINUX_EXT2_FS_I


	)

21 
	sext2_šode_šfo
 {

22 
	mi_d©a
[15];

23 
	mi_æags
;

24 
	mi_çddr
;

25 
	mi_äag
;

26 
	mi_fsize
;

27 
	mi_·d1
;

28 
	mi_fe_aş
;

29 
	mi_dœ_aş
;

30 
	mi_dtime
;

31 
	mi_v”siÚ
;

32 
	mi_block_group
;

33 
	mi_Ãxt_®loc_block
;

34 
	mi_Ãxt_®loc_gßl
;

35 
	mi_´—Îoc_block
;

36 
	mi_´—Îoc_couÁ
;

	@include/linux/ext2_fs_sb.h

15 #iâdeà
_LINUX_EXT2_FS_SB


16 
	#_LINUX_EXT2_FS_SB


	)

18 
	#EXT2_MAX_GROUP_DESC
 8

	)

19 
	#EXT2_MAX_GROUP_LOADED
 8

	)

24 
	sext2_sb_šfo
 {

25 
	ms_äag_size
;

26 
	ms_äags_³r_block
;

27 
	ms_šodes_³r_block
;

28 
	ms_äags_³r_group
;

29 
	ms_blocks_³r_group
;

30 
	ms_šodes_³r_group
;

31 
	ms_™b_³r_group
;

32 
	ms_desc_³r_block
;

33 
	ms_groups_couÁ
;

34 
bufãr_h—d
 * 
	ms_sbh
;

35 
ext2_su³r_block
 * 
	ms_es
;

36 
bufãr_h—d
 * 
	ms_group_desc
[
EXT2_MAX_GROUP_DESC
];

37 
	ms_lßded_šode_b™m­s
;

38 
	ms_lßded_block_b™m­s
;

39 
	ms_šode_b™m­_numb”
[
EXT2_MAX_GROUP_LOADED
];

40 
bufãr_h—d
 * 
	ms_šode_b™m­
[
EXT2_MAX_GROUP_LOADED
];

41 
	ms_block_b™m­_numb”
[
EXT2_MAX_GROUP_LOADED
];

42 
bufãr_h—d
 * 
	ms_block_b™m­
[
EXT2_MAX_GROUP_LOADED
];

43 
	ms_»Çme_lock
;

44 
wa™_queue
 * 
	ms_»Çme_wa™
;

45 
	ms_mouÁ_İt
;

46 
	ms_mouÁ_¡©e
;

	@include/linux/ext_fs.h

1 #iâdeà
_LINUX_EXT_FS_H


2 
	#_LINUX_EXT_FS_H


	)

8 
	#EXT_NAME_LEN
 255

	)

9 
	#EXT_ROOT_INO
 1

	)

11 
	#EXT_SUPER_MAGIC
 0x137D

	)

13 
	#EXT_INODES_PER_BLOCK
 ((
BLOCK_SIZE
)/( (
ext_šode
)))

	)

15 
	sext_šode
 {

16 
	mi_mode
;

17 
	mi_uid
;

18 
	mi_size
;

19 
	mi_time
;

20 
	mi_gid
;

21 
	mi_Æšks
;

22 
	mi_zÚe
[12];

25 
	sext_ä“_šode
 {

26 
	mcouÁ
;

27 
	mä“
[14];

28 
	mÃxt
;

31 
	sext_ä“_block
 {

32 
	mcouÁ
;

33 
	mä“
[254];

34 
	mÃxt
;

37 
	sext_su³r_block
 {

38 
	ms_nšodes
;

39 
	ms_nzÚes
;

40 
	ms_fœ¡ä“block
;

41 
	ms_ä“blockscouÁ
;

42 
	ms_fœ¡ä“šode
;

43 
	ms_ä“šodescouÁ
;

44 
	ms_fœ¡d©azÚe
;

45 
	ms_log_zÚe_size
;

46 
	ms_max_size
;

47 
	ms_»£rved1
;

48 
	ms_»£rved2
;

49 
	ms_»£rved3
;

50 
	ms_»£rved4
;

51 
	ms_»£rved5
;

52 
	ms_magic
;

55 
	sext_dœ_’Œy
 {

56 
	mšode
;

57 
	m»c_Ën
;

58 
	mÇme_Ën
;

59 
	mÇme
[
EXT_NAME_LEN
];

62 
ext_İ’
(
šode
 * inode, 
fe
 * 
fp
);

63 
ext_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
);

64 
ext_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

65 
šode
 ** 
»suÉ
);

66 
ext_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

67 
šode
 ** 
»suÉ
);

68 
ext_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
);

69 
ext_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

70 
ext_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

71 
ext_symlšk
(
šode
 * inode, cÚ¡ * 
Çme
, 
Ën
,

72 cÚ¡ * 
symÇme
);

73 
ext_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

74 
ext_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
);

75 
ext_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

76 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
);

77 
šode
 * 
ext_Ãw_šode
(cÚ¡ šod* 
dœ
);

78 
ext_ä“_šode
(
šode
 * inode);

79 
ext_couÁ_ä“_šodes
(
su³r_block
 *
sb
);

80 
ext_Ãw_block
(
su³r_block
 * 
sb
);

81 
ext_ä“_block
(
su³r_block
 * 
sb
, 
block
);

82 
ext_couÁ_ä“_blocks
(
su³r_block
 *
sb
);

84 
ext_bm­
(
šode
 *,);

86 
bufãr_h—d
 * 
ext_g‘blk
(
šode
 *, , );

87 
bufãr_h—d
 * 
ext_b»ad
(
šode
 *, , );

89 
ext_Œunÿ‹
(
šode
 *);

90 
ext_put_su³r
(
su³r_block
 *);

91 
ext_wr™e_su³r
(
su³r_block
 *);

92 
su³r_block
 *
ext_»ad_su³r
(super_block *,*,);

93 
ext_»ad_šode
(
šode
 *);

94 
ext_wr™e_šode
(
šode
 *);

95 
ext_put_šode
(
šode
 *);

96 
ext_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

97 
ext_sync_šode
(
šode
 *);

98 
ext_sync_fe
(
šode
 *, 
fe
 *);

100 
ext_l£ek
(
šode
 *, 
fe
 *, 
off_t
, );

101 
ext_»ad
(
šode
 *, 
fe
 *, *, );

102 
ext_wr™e
(
šode
 *, 
fe
 *, *, );

104 
šode_İ”©iÚs
 
ext_fe_šode_İ”©iÚs
;

105 
šode_İ”©iÚs
 
ext_dœ_šode_İ”©iÚs
;

106 
šode_İ”©iÚs
 
ext_symlšk_šode_İ”©iÚs
;

	@include/linux/ext_fs_i.h

1 #iâdeà
_EXT_FS_I


2 
	#_EXT_FS_I


	)

7 
	sext_šode_šfo
 {

8 
	mi_d©a
[16];

	@include/linux/ext_fs_sb.h

1 #iâdeà
_EXT_FS_SB


2 
	#_EXT_FS_SB


	)

7 
	sext_sb_šfo
 {

8 
	ms_nšodes
;

9 
	ms_nzÚes
;

10 
	ms_fœ¡d©azÚe
;

11 
	ms_log_zÚe_size
;

12 
	ms_max_size
;

13 
	ms_fœ¡ä“blocknumb”
;

14 
	ms_ä“blockscouÁ
;

15 
bufãr_h—d
 * 
	ms_fœ¡ä“block
;

16 
	ms_fœ¡ä“šod’umb”
;

17 
	ms_ä“šodescouÁ
;

18 
bufãr_h—d
 * 
	ms_fœ¡ä“šodeblock
;

	@include/linux/fcntl.h

1 #iâdeà
_LINUX_FCNTL_H


2 
	#_LINUX_FCNTL_H


	)

5 
	#O_ACCMODE
 0003

	)

6 
	#O_RDONLY
 00

	)

7 
	#O_WRONLY
 01

	)

8 
	#O_RDWR
 02

	)

9 
	#O_CREAT
 0100

	)

10 
	#O_EXCL
 0200

	)

11 
	#O_NOCTTY
 0400

	)

12 
	#O_TRUNC
 01000

	)

13 
	#O_APPEND
 02000

	)

14 
	#O_NONBLOCK
 04000

	)

15 
	#O_NDELAY
 
O_NONBLOCK


	)

16 
	#O_SYNC
 010000

	)

18 
	#F_DUPFD
 0

	)

19 
	#F_GETFD
 1

	)

20 
	#F_SETFD
 2

	)

21 
	#F_GETFL
 3

	)

22 
	#F_SETFL
 4

	)

23 
	#F_GETLK
 5

	)

24 
	#F_SETLK
 6

	)

25 
	#F_SETLKW
 7

	)

27 
	#F_SETOWN
 8

	)

28 
	#F_GETOWN
 9

	)

31 
	#FD_CLOEXEC
 1

	)

33 
	#F_RDLCK
 0

	)

34 
	#F_WRLCK
 1

	)

35 
	#F_UNLCK
 2

	)

38 
	#F_EXLCK
 4

	)

39 
	#F_SHLCK
 8

	)

41 
	sæock
 {

42 
	ml_ty³
;

43 
	ml_wh’û
;

44 
off_t
 
	ml_¡¬t
;

45 
off_t
 
	ml_Ën
;

46 
pid_t
 
	ml_pid
;

	@include/linux/fd.h

1 #iâdeà
_LINUX_FD_H


2 
	#_LINUX_FD_H


	)

4 
	#FDCLRPRM
 0

	)

5 
	#FDSETPRM
 1

	)

6 
	#FDDEFPRM
 2

	)

7 
	#FDGETPRM
 3

	)

8 
	#FDMSGON
 4

	)

9 
	#FDMSGOFF
 5

	)

10 
	#FDFMTBEG
 6

	)

11 
	#FDFMTTRK
 7

	)

12 
	#FDFMTEND
 8

	)

13 
	#FDSETEMSGTRESH
 10

	)

14 
	#FDFLUSH
 11

	)

18 
	#FD_FILL_BYTE
 0xF6

	)

20 
	#FORMAT_NONE
 0

	)

21 
	#FORMAT_WAIT
 1

	)

22 
	#FORMAT_BUSY
 2

	)

23 
	#FORMAT_OKAY
 3

	)

24 
	#FORMAT_ERROR
 4

	)

26 
	sæİpy_¡ruù
 {

27 
	msize
,

28 
	m£ù
,

29 
	mh—d
,

30 
	mŒack
,

31 
	m¡»tch
;

32 
	mg­
,

33 
	m¿‹
,

34 
	m¥ec1
,

35 
	mfmt_g­
;

36 * 
	mÇme
;

39 
	sfÜm©_desü
 {

40 
	mdeviû
,
	mh—d
,
	mŒack
;

	@include/linux/fdreg.h

1 #iâdeà
_LINUX_FDREG_H


2 
	#_LINUX_FDREG_H


	)

10 
	#FD_STATUS
 0x3f4

	)

11 
	#FD_DATA
 0x3f5

	)

12 
	#FD_DOR
 0x3f2

	)

13 
	#FD_DIR
 0x3f7

	)

14 
	#FD_DCR
 0x3f7

	)

17 
	#STATUS_BUSYMASK
 0x0F

	)

18 
	#STATUS_BUSY
 0x10

	)

19 
	#STATUS_DMA
 0x20

	)

20 
	#STATUS_DIR
 0x40

	)

21 
	#STATUS_READY
 0x80

	)

24 
	#ST0_DS
 0x03

	)

25 
	#ST0_HA
 0x04

	)

26 
	#ST0_NR
 0x08

	)

27 
	#ST0_ECE
 0x10

	)

28 
	#ST0_SE
 0x20

	)

29 
	#ST0_INTR
 0xC0

	)

32 
	#ST1_MAM
 0x01

	)

33 
	#ST1_WP
 0x02

	)

34 
	#ST1_ND
 0x04

	)

35 
	#ST1_OR
 0x10

	)

36 
	#ST1_CRC
 0x20

	)

37 
	#ST1_EOC
 0x80

	)

40 
	#ST2_MAM
 0x01

	)

41 
	#ST2_BC
 0x02

	)

42 
	#ST2_SNS
 0x04

	)

43 
	#ST2_SEH
 0x08

	)

44 
	#ST2_WC
 0x10

	)

45 
	#ST2_CRC
 0x20

	)

46 
	#ST2_CM
 0x40

	)

49 
	#ST3_HA
 0x04

	)

50 
	#ST3_TZ
 0x10

	)

51 
	#ST3_WP
 0x40

	)

54 
	#FD_RECALIBRATE
 0x07

	)

55 
	#FD_SEEK
 0x0F

	)

56 
	#FD_READ
 0xE6

	)

57 
	#FD_WRITE
 0xC5

	)

58 
	#FD_SENSEI
 0x08

	)

59 
	#FD_SPECIFY
 0x03

	)

60 
	#FD_FORMAT
 0x4D

	)

61 
	#FD_VERSION
 0x10

	)

62 
	#FD_CONFIGURE
 0x13

	)

63 
	#FD_PERPENDICULAR
 0x12

	)

66 
	#DMA_READ
 0x46

	)

67 
	#DMA_WRITE
 0x4A

	)

70 
	#FDC_TYPE_STD
 0x80

	)

71 
	#FDC_TYPE_82077
 0x90

	)

	@include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lškage.h
>

10 
	~<lšux/lim™s.h
>

11 
	~<lšux/wa™.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/dœ’t.h
>

14 
	~<lšux/vfs.h
>

15 
	~<lšux/Ãt.h
>

25 #undeà
NR_OPEN


26 
	#NR_OPEN
 256

	)

28 
	#NR_INODE
 2048

	)

29 
	#NR_FILE
 1024

	)

30 
	#NR_SUPER
 32

	)

31 
	#NR_HASH
 997

	)

32 
	#NR_IHASH
 131

	)

33 
	#NR_FILE_LOCKS
 64

	)

34 
	#BLOCK_SIZE
 1024

	)

35 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#MAY_EXEC
 1

	)

38 
	#MAY_WRITE
 2

	)

39 
	#MAY_READ
 4

	)

41 
	#READ
 0

	)

42 
	#WRITE
 1

	)

43 
	#READA
 2

	)

44 
	#WRITEA
 3

	)

46 
bufãr_š™
();

47 
šode_š™
(
¡¬t
, 
’d
);

48 
fe_bË_š™
(
¡¬t
, 
’d
);

50 
	#MAJOR
(
a
è()(()×è>> 8)

	)

51 
	#MINOR
(
a
è()(()×è& 0xFF)

	)

52 
	#MKDEV
(
a
,
b
è(()(((×è& 0xffè<< 8è| ((bè& 0xff)))

	)

54 #iâdeà
NULL


55 
	#NULL
 ((*è0)

	)

58 
	#NIL_FILP
 ((
fe
 *)0)

	)

59 
	#SEL_IN
 1

	)

60 
	#SEL_OUT
 2

	)

61 
	#SEL_EX
 4

	)

66 
	#MS_RDONLY
 1

	)

67 
	#MS_NOSUID
 2

	)

68 
	#MS_NODEV
 4

	)

69 
	#MS_NOEXEC
 8

	)

70 
	#MS_SYNC
 16

	)

71 
	#MS_REMOUNT
 32

	)

76 
	#MS_RMT_MASK
 (
MS_RDONLY
)

	)

81 
	#MS_MGC_VAL
 0xC0ED0000

	)

82 
	#MS_MGC_MSK
 0xffff0000

	)

92 
	#IS_RDONLY
(
šode
è(((šode)->
i_sb
è&& ((šode)->i_sb->
s_æags
 & 
MS_RDONLY
))

	)

93 
	#IS_NOSUID
(
šode
è((šode)->
i_æags
 & 
MS_NOSUID
)

	)

94 
	#IS_NODEV
(
šode
è((šode)->
i_æags
 & 
MS_NODEV
)

	)

95 
	#IS_NOEXEC
(
šode
è((šode)->
i_æags
 & 
MS_NOEXEC
)

	)

96 
	#IS_SYNC
(
šode
è((šode)->
i_æags
 & 
MS_SYNC
)

	)

101 
	#BLKROSET
 4701

	)

102 
	#BLKROGET
 4702

	)

103 
	#BLKRRPART
 4703

	)

104 
	#BLKGETSIZE
 4704

	)

105 
	#BLKFLSBUF
 4705

	)

109 
	#SCSI_IOCTL_GET_IDLUN
 0x5382

	)

113 
	#SCSI_IOCTL_TAGGED_ENABLE
 0x5383

	)

114 
	#SCSI_IOCTL_TAGGED_DISABLE
 0x5384

	)

117 
	#BMAP_IOCTL
 1

	)

118 
	#FIBMAP
 1

	)

119 
	#FIGETBSZ
 2

	)

123 
	#NOTIFY_SIZE
 1

	)

124 
	#NOTIFY_MODE
 2

	)

125 
	#NOTIFY_TIME
 4

	)

126 
	#NOTIFY_UIDGID
 8

	)

128 
	tbufãr_block
[
BLOCK_SIZE
];

130 
	sbufãr_h—d
 {

131 * 
	mb_d©a
;

132 
	mb_size
;

133 
	mb_blockÄ
;

134 
dev_t
 
	mb_dev
;

135 
	mb_couÁ
;

136 
	mb_u±od©e
;

137 
	mb_dœt
;

138 
	mb_lock
;

139 
	mb_»q
;

140 
wa™_queue
 * 
	mb_wa™
;

141 
bufãr_h—d
 * 
	mb_´ev
;

142 
bufãr_h—d
 * 
	mb_Ãxt
;

143 
bufãr_h—d
 * 
	mb_´ev_ä“
;

144 
bufãr_h—d
 * 
	mb_Ãxt_ä“
;

145 
bufãr_h—d
 * 
	mb_this_·ge
;

146 
bufãr_h—d
 * 
	mb_»qÃxt
;

149 
	~<lšux/pe_fs_i.h
>

150 
	~<lšux/mšix_fs_i.h
>

151 
	~<lšux/ext_fs_i.h
>

152 
	~<lšux/ext2_fs_i.h
>

153 
	~<lšux/hpfs_fs_i.h
>

154 
	~<lšux/msdos_fs_i.h
>

155 
	~<lšux/iso_fs_i.h
>

156 
	~<lšux/nfs_fs_i.h
>

157 
	~<lšux/xŸ_fs_i.h
>

158 
	~<lšux/sysv_fs_i.h
>

160 
	sšode
 {

161 
dev_t
 
	mi_dev
;

162 
	mi_šo
;

163 
umode_t
 
	mi_mode
;

164 
Æšk_t
 
	mi_Æšk
;

165 
uid_t
 
	mi_uid
;

166 
gid_t
 
	mi_gid
;

167 
dev_t
 
	mi_rdev
;

168 
off_t
 
	mi_size
;

169 
time_t
 
	mi_©ime
;

170 
time_t
 
	mi_mtime
;

171 
time_t
 
	mi_ùime
;

172 
	mi_blksize
;

173 
	mi_blocks
;

174 
£m­hÜe
 
	mi_£m
;

175 
šode_İ”©iÚs
 * 
	mi_İ
;

176 
su³r_block
 * 
	mi_sb
;

177 
wa™_queue
 * 
	mi_wa™
;

178 
fe_lock
 * 
	mi_æock
;

179 
vm_¬—_¡ruù
 * 
	mi_mm­
;

180 
šode
 * 
	mi_Ãxt
, * 
	mi_´ev
;

181 
šode
 * 
	mi_hash_Ãxt
, * 
	mi_hash_´ev
;

182 
šode
 * 
	mi_bound_to
, * 
	mi_bound_by
;

183 
šode
 * 
	mi_mouÁ
;

184 
sock‘
 * 
	mi_sock‘
;

185 
	mi_couÁ
;

186 
	mi_æags
;

187 
	mi_lock
;

188 
	mi_dœt
;

189 
	mi_pe
;

190 
	mi_£ek
;

191 
	mi_upd©e
;

193 
pe_šode_šfo
 
	mpe_i
;

194 
mšix_šode_šfo
 
	mmšix_i
;

195 
ext_šode_šfo
 
	mext_i
;

196 
ext2_šode_šfo
 
	mext2_i
;

197 
hpfs_šode_šfo
 
	mhpfs_i
;

198 
msdos_šode_šfo
 
	mmsdos_i
;

199 
iso_šode_šfo
 
	misofs_i
;

200 
nfs_šode_šfo
 
	mnfs_i
;

201 
xŸfs_šode_šfo
 
	mxŸfs_i
;

202 
sysv_šode_šfo
 
	msysv_i
;

203 } 
	mu
;

206 
	sfe
 {

207 
mode_t
 
	mf_mode
;

208 
dev_t
 
	mf_rdev
;

209 
off_t
 
	mf_pos
;

210 
	mf_æags
;

211 
	mf_couÁ
;

212 
	mf_»ada
;

213 
fe
 *
	mf_Ãxt
, *
	mf_´ev
;

214 
šode
 * 
	mf_šode
;

215 
fe_İ”©iÚs
 * 
	mf_İ
;

218 
	sfe_lock
 {

219 
fe_lock
 *
	mæ_Ãxt
;

220 
sk_¡ruù
 *
	mæ_owÃr
;

221 
	mæ_fd
;

222 
wa™_queue
 *
	mæ_wa™
;

223 
	mæ_ty³
;

224 
	mæ_wh’û
;

225 
off_t
 
	mæ_¡¬t
;

226 
off_t
 
	mæ_’d
;

229 
	~<lšux/mšix_fs_sb.h
>

230 
	~<lšux/ext_fs_sb.h
>

231 
	~<lšux/ext2_fs_sb.h
>

232 
	~<lšux/hpfs_fs_sb.h
>

233 
	~<lšux/msdos_fs_sb.h
>

234 
	~<lšux/iso_fs_sb.h
>

235 
	~<lšux/nfs_fs_sb.h
>

236 
	~<lšux/xŸ_fs_sb.h
>

237 
	~<lšux/sysv_fs_sb.h
>

239 
	ssu³r_block
 {

240 
dev_t
 
	ms_dev
;

241 
	ms_blocksize
;

242 
	ms_blocksize_b™s
;

243 
	ms_lock
;

244 
	ms_rd_Úly
;

245 
	ms_dœt
;

246 
su³r_İ”©iÚs
 *
	ms_İ
;

247 
	ms_æags
;

248 
	ms_magic
;

249 
	ms_time
;

250 
šode
 * 
	ms_cov”ed
;

251 
šode
 * 
	ms_mouÁed
;

252 
wa™_queue
 * 
	ms_wa™
;

254 
mšix_sb_šfo
 
	mmšix_sb
;

255 
ext_sb_šfo
 
	mext_sb
;

256 
ext2_sb_šfo
 
	mext2_sb
;

257 
hpfs_sb_šfo
 
	mhpfs_sb
;

258 
msdos_sb_šfo
 
	mmsdos_sb
;

259 
isofs_sb_šfo
 
	misofs_sb
;

260 
nfs_sb_šfo
 
	mnfs_sb
;

261 
xŸfs_sb_šfo
 
	mxŸfs_sb
;

262 
sysv_sb_šfo
 
	msysv_sb
;

263 } 
	mu
;

266 
	sfe_İ”©iÚs
 {

267 (*
	ml£ek
è(
	mšode
 *, 
	mfe
 *, 
	moff_t
, );

268 (*
	m»ad
è(
	mšode
 *, 
	mfe
 *, *, );

269 (*
	mwr™e
è(
	mšode
 *, 
	mfe
 *, *, );

270 (*
	m»addœ
è(
	mšode
 *, 
	mfe
 *, 
	mdœ’t
 *, );

271 (*
	m£Ëù
è(
	mšode
 *, 
	mfe
 *, , 
	m£Ëù_bË
 *);

272 (*
	mioùl
è(
	mšode
 *, 
	mfe
 *, , );

273 (*
	mmm­
è(
	mšode
 *, 
	mfe
 *, , 
	msize_t
, , );

274 (*
	mİ’
è(
	mšode
 *, 
	mfe
 *);

275 (*
	m»Ëa£
è(
	mšode
 *, 
	mfe
 *);

276 (*
	mfsync
è(
	mšode
 *, 
	mfe
 *);

279 
	sšode_İ”©iÚs
 {

280 
fe_İ”©iÚs
 * 
	mdeçuÉ_fe_İs
;

281 (*
	mü—‹
è(
	mšode
 *,const *,,,inode **);

282 (*
	mlookup
è(
	mšode
 *,const *,,inode **);

283 (*
	mlšk
è(
	mšode
 *,inode *,const *,);

284 (*
	muÆšk
è(
	mšode
 *,const *,);

285 (*
	msymlšk
è(
	mšode
 *,const *,,const *);

286 (*
	mmkdœ
è(
	mšode
 *,const *,,);

287 (*
	mrmdœ
è(
	mšode
 *,const *,);

288 (*
	mmknod
è(
	mšode
 *,const *,,,);

289 (*
	m»Çme
è(
	mšode
 *,const *,,inode *,const *,);

290 (*
	m»adlšk
è(
	mšode
 *,*,);

291 (*
	mfŞlow_lšk
è(
	mšode
 *,inode *,,,inode **);

292 (*
	mbm­
è(
	mšode
 *,);

293 (*
	mŒunÿ‹
è(
	mšode
 *);

294 (*
	m³rmissiÚ
è(
	mšode
 *, );

297 
	ssu³r_İ”©iÚs
 {

298 (*
	m»ad_šode
è(
	mšode
 *);

299 (*
	mnÙify_chªge
è(
	mæags
, 
	mšode
 *);

300 (*
	mwr™e_šode
è(
	mšode
 *);

301 (*
	mput_šode
è(
	mšode
 *);

302 (*
	mput_su³r
è(
	msu³r_block
 *);

303 (*
	mwr™e_su³r
è(
	msu³r_block
 *);

304 (*
	m¡©fs
è(
	msu³r_block
 *, statfs *);

305 (*
	m»mouÁ_fs
è(
	msu³r_block
 *, *, *);

308 
	sfe_sy¡em_ty³
 {

309 
	msu³r_block
 *(*
	m»ad_su³r
) (super_block *, *, );

310 *
	mÇme
;

311 
	m»quœes_dev
;

314 #ifdeà
__KERNEL__


316 
asmlškage
 
sys_İ’
(const *, , );

317 
asmlškage
 
sys_şo£
();

319 
g‘Çme
(cÚ¡ * 
f’ame
, **
»suÉ
);

320 
puŠame
(* 
Çme
);

322 
»gi¡”_blkdev
(, cÚ¡ *, 
fe_İ”©iÚs
 *);

323 
uÄegi¡”_blkdev
(
majÜ
, cÚ¡ * 
Çme
);

324 
blkdev_İ’
(
šode
 * inode, 
fe
 * 
fp
);

325 
fe_İ”©iÚs
 
def_blk_fİs
;

326 
šode_İ”©iÚs
 
blkdev_šode_İ”©iÚs
;

328 
»gi¡”_chrdev
(, cÚ¡ *, 
fe_İ”©iÚs
 *);

329 
uÄegi¡”_chrdev
(
majÜ
, cÚ¡ * 
Çme
);

330 
chrdev_İ’
(
šode
 * inode, 
fe
 * 
fp
);

331 
fe_İ”©iÚs
 
def_chr_fİs
;

332 
šode_İ”©iÚs
 
chrdev_šode_İ”©iÚs
;

334 
š™_fifo
(
šode
 * inode);

336 
fe_İ”©iÚs
 
cÚÃùšg_fifo_fİs
;

337 
fe_İ”©iÚs
 
»ad_fifo_fİs
;

338 
fe_İ”©iÚs
 
wr™e_fifo_fİs
;

339 
fe_İ”©iÚs
 
rdwr_fifo_fİs
;

340 
fe_İ”©iÚs
 
»ad_pe_fİs
;

341 
fe_İ”©iÚs
 
wr™e_pe_fİs
;

342 
fe_İ”©iÚs
 
rdwr_pe_fİs
;

344 
fe_sy¡em_ty³
 *
g‘_fs_ty³
(*
Çme
);

346 
fs_may_mouÁ
(
dev_t
 
dev
);

347 
fs_may_umouÁ
(
dev_t
 
dev
, 
šode
 * 
mouÁ_roÙ
);

348 
fs_may_»mouÁ_ro
(
dev_t
 
dev
);

350 
fe
 *
fœ¡_fe
;

351 
Ä_fes
;

352 
su³r_block
 
su³r_blocks
[
NR_SUPER
];

354 
shršk_bufãrs
(
´iÜ™y
);

356 
Ä_bufãrs
;

357 
bufãrmem
;

358 
Ä_bufãr_h—ds
;

360 
check_disk_chªge
(
dev_t
 
dev
);

361 
šv®id©e_šodes
(
dev_t
 
dev
);

362 
šv®id©e_bufãrs
(
dev_t
 
dev
);

363 
æİpy_chªge
(
bufãr_h—d
 * 
fœ¡_block
);

364 
sync_šodes
(
dev_t
 
dev
);

365 
sync_dev
(
dev_t
 
dev
);

366 
fsync_dev
(
dev_t
 
dev
);

367 
sync_su³rs
(
dev_t
 
dev
);

368 
bm­
(
šode
 * inode,
block
);

369 
nÙify_chªge
(
æags
, 
šode
 * inode);

370 
Çmei
(cÚ¡ * 
·thÇme
, 
šode
 ** 
»s_šode
);

371 
Êamei
(cÚ¡ * 
·thÇme
, 
šode
 ** 
»s_šode
);

372 
³rmissiÚ
(
šode
 * inode,
mask
);

373 
İ’_Çmei
(cÚ¡ * 
·thÇme
, 
æag
, 
mode
,

374 
šode
 ** 
»s_šode
, šod* 
ba£
);

375 
do_mknod
(cÚ¡ * 
f’ame
, 
mode
, 
dev_t
 
dev
);

376 
ut
(
šode
 * inode);

377 
šode
 * 
__ig‘
(
su³r_block
 * 
sb
,
Ä
,
üsmÁ
);

378 
šode
 * 
ig‘
(
su³r_block
 * 
sb
,
Ä
);

379 
šode
 * 
g‘_em±y_šode
();

380 
š£¹_šode_hash
(
šode
 *);

381 
ş—r_šode
(
šode
 *);

382 
šode
 * 
g‘_pe_šode
();

383 
fe
 * 
g‘_em±y_fp
();

384 
bufãr_h—d
 * 
g‘_hash_bË
(
dev_t
 
dev
, 
block
, 
size
);

385 
bufãr_h—d
 * 
g‘blk
(
dev_t
 
dev
, 
block
, 
size
);

386 
Î_rw_block
(
rw
, 
Ä
, 
bufãr_h—d
 * 
bh
[]);

387 
Î_rw_·ge
(
rw
, 
dev
, 
Ä
, * 
bufãr
);

388 
Î_rw_sw­_fe
(
rw
, 
dev
, *
b
, 
nb
, *
bufãr
);

389 
b»l£
(
bufãr_h—d
 * 
buf
);

390 
£t_blocksize
(
dev_t
 
dev
, 
size
);

391 
bufãr_h—d
 * 
b»ad
(
dev_t
 
dev
, 
block
, 
size
);

392 
b»ad_·ge
(
addr
,
dev_t
 
dev
,
b
[],
size
,
´Ù
);

393 
bufãr_h—d
 * 
b»ada
(
dev_t
 
dev
,
block
,...);

394 
put_su³r
(
dev_t
 
dev
);

395 
dev_t
 
ROOT_DEV
;

397 
show_bufãrs
();

398 
mouÁ_roÙ
();

400 
ch¬_»ad
(
šode
 *, 
fe
 *, *, );

401 
block_»ad
(
šode
 *, 
fe
 *, *, );

402 
»ad_ah—d
[];

404 
ch¬_wr™e
(
šode
 *, 
fe
 *, *, );

405 
block_wr™e
(
šode
 *, 
fe
 *, *, );

407 
g’”ic_mm­
(
šode
 *, 
fe
 *, , 
size_t
, , );

409 
block_fsync
(
šode
 *, 
fe
 *);

410 
fe_fsync
(
šode
 *, 
fe
 *);

	@include/linux/genhd.h

1 #iâdeà
_LINUX_GENHD_H


2 
	#_LINUX_GENHD_H


	)

12 
	#EXTENDED_PARTITION
 5

	)

14 
	s·¹™iÚ
 {

15 
	mboÙ_šd
;

16 
	mh—d
;

17 
	m£ùÜ
;

18 
	mcyl
;

19 
	msys_šd
;

20 
	m’d_h—d
;

21 
	m’d_£ùÜ
;

22 
	m’d_cyl
;

23 
	m¡¬t_£ù
;

24 
	mÄ_£ùs
;

27 
	shd_¡ruù
 {

28 
	m¡¬t_£ù
;

29 
	mÄ_£ùs
;

32 
	sg’disk
 {

33 
	mmajÜ
;

34 *
	mmajÜ_Çme
;

35 
	mmšÜ_shiá
;

37 
	mmax_p
;

38 
	mmax_Ä
;

40 (*
	mš™
)();

41 
hd_¡ruù
 *
	m·¹
;

42 *
	msizes
;

43 
	mÄ_»®
;

45 *
	m»®_deviûs
;

46 
g’disk
 *
	mÃxt
;

49 
NR_GENDISKS
;

50 
g’disk
 *
g’disk_h—d
;

	@include/linux/hdreg.h

1 #iâdeà
_LINUX_HDREG_H


2 
	#_LINUX_HDREG_H


	)

11 
	#HD_DATA
 0x1f0

	)

12 
	#HD_ERROR
 0x1f1

	)

13 
	#HD_NSECTOR
 0x1f2

	)

14 
	#HD_SECTOR
 0x1f3

	)

15 
	#HD_LCYL
 0x1f4

	)

16 
	#HD_HCYL
 0x1f5

	)

17 
	#HD_CURRENT
 0x1f6

	)

18 
	#HD_STATUS
 0x1f7

	)

19 
	#HD_PRECOMP
 
HD_ERROR


	)

20 
	#HD_COMMAND
 
HD_STATUS


	)

22 
	#HD_CMD
 0x3f6

	)

25 
	#ERR_STAT
 0x01

	)

26 
	#INDEX_STAT
 0x02

	)

27 
	#ECC_STAT
 0x04

	)

28 
	#DRQ_STAT
 0x08

	)

29 
	#SEEK_STAT
 0x10

	)

30 
	#WRERR_STAT
 0x20

	)

31 
	#READY_STAT
 0x40

	)

32 
	#BUSY_STAT
 0x80

	)

35 
	#WIN_RESTORE
 0x10

	)

36 
	#WIN_READ
 0x20

	)

37 
	#WIN_WRITE
 0x30

	)

38 
	#WIN_VERIFY
 0x40

	)

39 
	#WIN_FORMAT
 0x50

	)

40 
	#WIN_INIT
 0x60

	)

41 
	#WIN_SEEK
 0x70

	)

42 
	#WIN_DIAGNOSE
 0x90

	)

43 
	#WIN_SPECIFY
 0x91

	)

46 
	#MARK_ERR
 0x01

	)

47 
	#TRK0_ERR
 0x02

	)

48 
	#ABRT_ERR
 0x04

	)

49 
	#ID_ERR
 0x10

	)

50 
	#ECC_ERR
 0x40

	)

51 
	#BBD_ERR
 0x80

	)

56 
	#HDIO_REQ
 0x301

	)

57 
	#HDIO_GETGEO
 0x301

	)

58 
	shd_geom‘ry
 {

59 
	mh—ds
;

60 
	m£ùÜs
;

61 
	mcylšd”s
;

62 
	m¡¬t
;

	@include/linux/head.h

1 #iâdeà
_LINUX_HEAD_H


2 
	#_LINUX_HEAD_H


	)

4 
	sdesc_¡ruù
 {

5 
	ma
,
	mb
;

6 } 
	tdesc_bË
[256];

8 
sw­³r_pg_dœ
[1024];

9 
desc_bË
 
idt
,
gdt
;

11 
	#GDT_NUL
 0

	)

12 
	#GDT_CODE
 1

	)

13 
	#GDT_DATA
 2

	)

14 
	#GDT_TMP
 3

	)

16 
	#LDT_NUL
 0

	)

17 
	#LDT_CODE
 1

	)

18 
	#LDT_DATA
 2

	)

	@include/linux/hpfs_fs.h

1 #iâdeà
_LINUX_HPFS_FS_H


2 
	#_LINUX_HPFS_FS_H


	)

6 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

10 
su³r_block
 *
hpfs_»ad_su³r
 (super_block *, *, );

	@include/linux/hpfs_fs_i.h

1 #iâdeà
_HPFS_FS_I


2 
	#_HPFS_FS_I


	)

4 
	shpfs_šode_šfo
 {

5 
šo_t
 
	mi_·»Á_dœ
;

6 
	mi_dno
;

7 
	mi_dpos
;

8 
	mi_dsubdno
;

9 
	mi_fe_£c
;

10 
	mi_disk_£c
;

11 
	mi_n_£cs
;

12 
	mi_cÚv
 : 2;

15 
	#i_hpfs_dno
 
u
.
hpfs_i
.
i_dno


	)

16 
	#i_hpfs_·»Á_dœ
 
u
.
hpfs_i
.
i_·»Á_dœ


	)

17 
	#i_hpfs_n_£cs
 
u
.
hpfs_i
.
i_n_£cs


	)

18 
	#i_hpfs_fe_£c
 
u
.
hpfs_i
.
i_fe_£c


	)

19 
	#i_hpfs_disk_£c
 
u
.
hpfs_i
.
i_disk_£c


	)

20 
	#i_hpfs_dpos
 
u
.
hpfs_i
.
i_dpos


	)

21 
	#i_hpfs_dsubdno
 
u
.
hpfs_i
.
i_dsubdno


	)

22 
	#i_hpfs_cÚv
 
u
.
hpfs_i
.
i_cÚv


	)

	@include/linux/hpfs_fs_sb.h

1 #iâdeà
_HPFS_FS_SB


2 
	#_HPFS_FS_SB


	)

4 
	shpfs_sb_šfo
 {

5 
šo_t
 
	msb_roÙ
;

6 
	msb_fs_size
;

7 
	msb_b™m­s
;

8 
	msb_dœbªd_size
;

9 
	msb_dm­
;

10 
	msb_n_ä“
;

11 
	msb_n_ä“_dnodes
;

12 
uid_t
 
	msb_uid
;

13 
gid_t
 
	msb_gid
;

14 
umode_t
 
	msb_mode
;

15 
	msb_low”ÿ£
 : 1;

16 
	msb_cÚv
 : 2;

19 
	#s_hpfs_roÙ
 
u
.
hpfs_sb
.
sb_roÙ


	)

20 
	#s_hpfs_fs_size
 
u
.
hpfs_sb
.
sb_fs_size


	)

21 
	#s_hpfs_b™m­s
 
u
.
hpfs_sb
.
sb_b™m­s


	)

22 
	#s_hpfs_dœbªd_size
 
u
.
hpfs_sb
.
sb_dœbªd_size


	)

23 
	#s_hpfs_dm­
 
u
.
hpfs_sb
.
sb_dm­


	)

24 
	#s_hpfs_uid
 
u
.
hpfs_sb
.
sb_uid


	)

25 
	#s_hpfs_gid
 
u
.
hpfs_sb
.
sb_gid


	)

26 
	#s_hpfs_mode
 
u
.
hpfs_sb
.
sb_mode


	)

27 
	#s_hpfs_n_ä“
 
u
.
hpfs_sb
.
sb_n_ä“


	)

28 
	#s_hpfs_n_ä“_dnodes
 
u
.
hpfs_sb
.
sb_n_ä“_dnodes


	)

29 
	#s_hpfs_low”ÿ£
 
u
.
hpfs_sb
.
sb_low”ÿ£


	)

30 
	#s_hpfs_cÚv
 
u
.
hpfs_sb
.
sb_cÚv


	)

	@include/linux/icmp.h

17 #iâdeà
_LINUX_ICMP_H


18 
	#_LINUX_ICMP_H


	)

20 
	#ICMP_ECHOREPLY
 0

	)

21 
	#ICMP_DEST_UNREACH
 3

	)

22 
	#ICMP_SOURCE_QUENCH
 4

	)

23 
	#ICMP_REDIRECT
 5

	)

24 
	#ICMP_ECHO
 8

	)

25 
	#ICMP_TIME_EXCEEDED
 11

	)

26 
	#ICMP_PARAMETERPROB
 12

	)

27 
	#ICMP_TIMESTAMP
 13

	)

28 
	#ICMP_TIMESTAMPREPLY
 14

	)

29 
	#ICMP_INFO_REQUEST
 15

	)

30 
	#ICMP_INFO_REPLY
 16

	)

31 
	#ICMP_ADDRESS
 17

	)

32 
	#ICMP_ADDRESSREPLY
 18

	)

36 
	#ICMP_NET_UNREACH
 0

	)

37 
	#ICMP_HOST_UNREACH
 1

	)

38 
	#ICMP_PROT_UNREACH
 2

	)

39 
	#ICMP_PORT_UNREACH
 3

	)

40 
	#ICMP_FRAG_NEEDED
 4

	)

41 
	#ICMP_SR_FAILED
 5

	)

42 
	#ICMP_NET_UNKNOWN
 6

	)

43 
	#ICMP_HOST_UNKNOWN
 7

	)

44 
	#ICMP_HOST_ISOLATED
 8

	)

45 
	#ICMP_NET_ANO
 9

	)

46 
	#ICMP_HOST_ANO
 10

	)

47 
	#ICMP_NET_UNR_TOS
 11

	)

48 
	#ICMP_HOST_UNR_TOS
 12

	)

51 
	#ICMP_REDIR_NET
 0

	)

52 
	#ICMP_REDIR_HOST
 1

	)

53 
	#ICMP_REDIR_NETTOS
 2

	)

54 
	#ICMP_REDIR_HOSTTOS
 3

	)

57 
	#ICMP_EXC_TTL
 0

	)

58 
	#ICMP_EXC_FRAGTIME
 1

	)

61 
	sicmphdr
 {

62 
	mty³
;

63 
	mcode
;

64 
	mchecksum
;

67 
	mid
;

68 
	m£qu’û
;

69 } 
	mecho
;

70 
	mg©eway
;

71 } 
	mun
;

75 
	sicmp_”r
 {

76 
	m”ºo
;

77 
	mçl
:1;

	@include/linux/if.h

19 #iâdeà
_LINUX_IF_H


20 
	#_LINUX_IF_H


	)

22 
	~<lšux/ty³s.h
>

23 
	~<lšux/sock‘.h
>

27 
	siâ‘
 {

28 *
	mif_Çme
;

29 
	mif_un™
;

30 
	mif_mtu
;

31 
	mif_æags
;

32 
	mif_tim”
;

33 
	mif_m‘ric
;

34 
içddr
 *
	mif_add¾i¡
;

35 
	sifqueue
 {

36 #ifdeà
nÙ_y‘_š_lšux


37 
mbuf
 *
	mifq_h—d
;

38 
mbuf
 *
	mifq_
;

39 
	mifq_Ën
;

40 
	mifq_maxËn
;

41 
	mifq_drİs
;

43 } 
	mif_¢d
;

46 (*
	mif_š™
)();

47 (*
	mif_ouut
)();

48 (*
	mif_ioùl
)();

49 (*
	mif_»£t
)();

50 (*
	mif_w©chdog
)();

53 
	mif_ack‘s
;

54 
	mif_›¼Üs
;

55 
	mif_İack‘s
;

56 
	mif_Û¼Üs
;

57 
	mif_cŞlisiÚs
;

60 
iâ‘
 *
	mif_Ãxt
;

64 
	#IFF_UP
 0x1

	)

65 
	#IFF_BROADCAST
 0x2

	)

66 
	#IFF_DEBUG
 0x4

	)

67 
	#IFF_LOOPBACK
 0x8

	)

68 
	#IFF_POINTOPOINT
 0x10

	)

69 
	#IFF_NOTRAILERS
 0x20

	)

70 
	#IFF_RUNNING
 0x40

	)

71 
	#IFF_NOARP
 0x80

	)

74 
	#IFF_PROMISC
 0x100

	)

75 
	#IFF_ALLMULTI
 0x200

	)

85 
	siçddr
 {

86 
sockaddr
 
	miç_addr
;

88 
sockaddr
 
	mifu_brßdaddr
;

89 
sockaddr
 
	mifu_d¡addr
;

90 } 
	miç_ifu
;

91 
içû
 *
	miç_iå
;

92 
içddr
 *
	miç_Ãxt
;

94 
	#iç_brßdaddr
 
iç_ifu
.
ifu_brßdaddr


	)

95 
	#iç_d¡addr
 
iç_ifu
.
ifu_d¡addr


	)

103 
	siäeq
 {

104 
	#IFHWADDRLEN
 6

	)

105 
	#IFNAMSIZ
 16

	)

108 
	miän_Çme
[
IFNAMSIZ
];

109 
	miän_hwaddr
[
IFHWADDRLEN
];

110 } 
	miä_iän
;

113 
sockaddr
 
	miäu_addr
;

114 
sockaddr
 
	miäu_d¡addr
;

115 
sockaddr
 
	miäu_brßdaddr
;

116 
sockaddr
 
	miäu_Ãtmask
;

117 
	miäu_æags
;

118 
	miäu_m‘ric
;

119 
	miäu_mtu
;

120 
ÿddr_t
 
	miäu_d©a
;

121 } 
	miä_iäu
;

124 
	#iä_Çme
 
iä_iän
.
iän_Çme


	)

125 
	#iä_hwaddr
 
iä_iän
.
iän_hwaddr


	)

126 
	#iä_addr
 
iä_iäu
.
iäu_addr


	)

127 
	#iä_d¡addr
 
iä_iäu
.
iäu_d¡addr


	)

128 
	#iä_brßdaddr
 
iä_iäu
.
iäu_brßdaddr


	)

129 
	#iä_Ãtmask
 
iä_iäu
.
iäu_Ãtmask


	)

130 
	#iä_æags
 
iä_iäu
.
iäu_æags


	)

131 
	#iä_m‘ric
 
iä_iäu
.
iäu_m‘ric


	)

132 
	#iä_mtu
 
iä_iäu
.
iäu_mtu


	)

133 
	#iä_d©a
 
iä_iäu
.
iäu_d©a


	)

141 
	sifcÚf
 {

142 
	mifc_Ën
;

144 
ÿddr_t
 
	mifcu_buf
;

145 
iäeq
 *
	mifcu_»q
;

146 } 
	mifc_ifcu
;

148 
	#ifc_buf
 
ifc_ifcu
.
ifcu_buf


	)

149 
	#ifc_»q
 
ifc_ifcu
.
ifcu_»q


	)

153 
	~<lšux/if_¬p.h
>

154 
	~<lšux/rou‹.h
>

	@include/linux/if_arp.h

20 #iâdeà
_LINUX_IF_ARP_H


21 
	#_LINUX_IF_ARP_H


	)

24 
	#ARPHRD_NETROM
 0

	)

25 
	#ARPHRD_ETHER
 1

	)

26 
	#ARPHRD_EETHER
 2

	)

27 
	#ARPHRD_AX25
 3

	)

28 
	#ARPHRD_PRONET
 4

	)

29 
	#ARPHRD_CHAOS
 5

	)

30 
	#ARPHRD_IEEE802
 6

	)

31 
	#ARPHRD_ARCNET
 7

	)

32 
	#ARPHRD_APPLETLK
 8

	)

35 
	#ARPOP_REQUEST
 1

	)

36 
	#ARPOP_REPLY
 2

	)

37 
	#ARPOP_RREQUEST
 3

	)

38 
	#ARPOP_RREPLY
 4

	)

51 
	s¬phdr
 {

52 
	m¬_hrd
;

53 
	m¬_´o
;

54 
	m¬_hÊ
;

55 
	m¬_¶n
;

56 
	m¬_İ
;

60 
	m¬_sha
[];

61 
	m¬_¥a
[];

62 
	m¬_tha
[];

63 
	m¬_a
[];

69 
	s¬´eq
 {

70 
sockaddr
 
	m¬p_·
;

71 
sockaddr
 
	m¬p_ha
;

72 
	m¬p_æags
;

76 
	#ATF_INUSE
 0x01

	)

77 
	#ATF_COM
 0x02

	)

78 
	#ATF_PERM
 0x04

	)

79 
	#ATF_PUBL
 0x08

	)

80 
	#ATF_USETRAILERS
 0x10

	)

	@include/linux/if_ether.h

18 #iâdeà
_LINUX_IF_ETHER_H


19 
	#_LINUX_IF_ETHER_H


	)

24 
	#ETH_ALEN
 6

	)

25 
	#ETH_HLEN
 14

	)

26 
	#ETH_ZLEN
 60

	)

27 
	#ETH_DATA_LEN
 1500

	)

28 
	#ETH_FRAME_LEN
 1514

	)

32 
	#ETH_P_LOOP
 0x0060

	)

33 
	#ETH_P_ECHO
 0x0200

	)

34 
	#ETH_P_PUP
 0x0400

	)

35 
	#ETH_P_IP
 0x0800

	)

36 
	#ETH_P_ARP
 0x0806

	)

37 
	#ETH_P_RARP
 0x8035

	)

38 
	#ETH_P_X25
 0x0805

	)

39 
	#ETH_P_IPX
 0x8137

	)

40 
	#ETH_P_802_3
 0x0001

	)

41 
	#ETH_P_AX25
 0x0002

	)

42 
	#ETH_P_ALL
 0x0003

	)

45 
	s‘hhdr
 {

46 
	mh_de¡
[
ETH_ALEN
];

47 
	mh_sourû
[
ETH_ALEN
];

48 
	mh_´Ùo
;

52 
	s’‘_¡©i¡ics
{

53 
	mrx_·ck‘s
;

54 
	mtx_·ck‘s
;

55 
	mrx_”rÜs
;

56 
	mtx_”rÜs
;

57 
	mrx_drİ³d
;

58 
	mtx_drİ³d
;

59 
	mmuÉiÿ¡
;

60 
	mcŞlisiÚs
;

63 
	mrx_Ëngth_”rÜs
;

64 
	mrx_ov”_”rÜs
;

65 
	mrx_üc_”rÜs
;

66 
	mrx_äame_”rÜs
;

67 
	mrx_fifo_”rÜs
;

68 
	mrx_mis£d_”rÜs
;

71 
	mtx_abÜ‹d_”rÜs
;

72 
	mtx_ÿ¼›r_”rÜs
;

73 
	mtx_fifo_”rÜs
;

74 
	mtx_h—¹b—t_”rÜs
;

75 
	mtx_wšdow_”rÜs
;

	@include/linux/in.h

18 #iâdeà
_LINUX_IN_H


19 
	#_LINUX_IN_H


	)

24 
	mIPPROTO_IP
 = 0,

25 
	mIPPROTO_ICMP
 = 1,

26 
	mIPPROTO_GGP
 = 2,

27 
	mIPPROTO_TCP
 = 6,

28 
	mIPPROTO_EGP
 = 8,

29 
	mIPPROTO_PUP
 = 12,

30 
	mIPPROTO_UDP
 = 17,

31 
	mIPPROTO_IDP
 = 22,

33 
	mIPPROTO_RAW
 = 255,

34 
	mIPPROTO_MAX


39 
	sš_addr
 {

40 
	ms_addr
;

45 
	#__SOCK_SIZE__
 16

	)

46 
	ssockaddr_š
 {

47 
	msš_çmy
;

48 
	msš_pÜt
;

49 
š_addr
 
	msš_addr
;

52 
	m__·d
[
__SOCK_SIZE__
 - () -

53 (è- (
š_addr
)];

55 
	#sš_z”o
 
__·d


	)

63 
	#IN_CLASSA
(
a
è((((è×)è& 0x80000000è=ğ0)

	)

64 
	#IN_CLASSA_NET
 0xff000000

	)

65 
	#IN_CLASSA_NSHIFT
 24

	)

66 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

67 
	#IN_CLASSA_MAX
 128

	)

69 
	#IN_CLASSB
(
a
è((((è×)è& 0xc0000000è=ğ0x80000000)

	)

70 
	#IN_CLASSB_NET
 0xffff0000

	)

71 
	#IN_CLASSB_NSHIFT
 16

	)

72 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

73 
	#IN_CLASSB_MAX
 65536

	)

75 
	#IN_CLASSC
(
a
è((((è×)è& 0xc0000000è=ğ0xc0000000)

	)

76 
	#IN_CLASSC_NET
 0xffffff00

	)

77 
	#IN_CLASSC_NSHIFT
 8

	)

78 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

80 
	#IN_CLASSD
(
a
è((((è×)è& 0xf0000000è=ğ0xe0000000)

	)

81 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

83 
	#IN_EXPERIMENTAL
(
a
è((((è×)è& 0xe0000000è=ğ0xe0000000)

	)

84 
	#IN_BADCLASS
(
a
è((((è×)è& 0xf0000000è=ğ0xf0000000)

	)

87 
	#INADDR_ANY
 ((è0x00000000)

	)

90 
	#INADDR_BROADCAST
 ((è0xffffffff)

	)

93 
	#INADDR_NONE
 0xffffffff

	)

96 
	#IN_LOOPBACKNET
 127

	)

99 
	#INADDR_LOOPBACK
 0x7f000001

	)

108 
	#IP_OPTIONS
 1

	)

110 
	#IP_HDRINCL
 2

	)

114 #undeà
Áohl


115 #undeà
Áohs


116 #undeà
htÚl


117 #undeà
htÚs


119 
Áohl
();

120 
Áohs
();

121 
htÚl
();

122 
htÚs
();

124 
__šlše__
 

125 
	$__Áohl
(
x
)

127 
	`__asm__
("xchgb %b0,%h0\n\t"

130 :"=q" (
x
)

131 : "0" (
x
));

132  
x
;

133 
	}
}

135 
__šlše__
 

136 
	$__cÚ¡ªt_Áohl
(
x
)

138  (((
x
 & 0x000000ff) << 24) |

139 ((
x
 & 0x0000ff00) << 8) |

140 ((
x
 & 0x00ff0000) >> 8) |

141 ((
x
 & 0xff000000) >> 24));

142 
	}
}

144 
__šlše__
 

145 
	$__Áohs
(
x
)

147 
	`__asm__
("xchgb %b0,%h0"

148 : "=q" (
x
)

149 : "0" (
x
));

150  
x
;

151 
	}
}

153 
__šlše__
 

154 
	$__cÚ¡ªt_Áohs
(
x
)

156  (((
x
 & 0x00ff) << 8) |

157 ((
x
 & 0xff00) >> 8));

158 
	}
}

160 
	#__htÚl
(
x
è
	`__Áohl
(x)

	)

161 
	#__htÚs
(
x
è
	`__Áohs
(x)

	)

162 
	#__cÚ¡ªt_htÚl
(
x
è
	`__cÚ¡ªt_Áohl
(x)

	)

163 
	#__cÚ¡ªt_htÚs
(
x
è
	`__cÚ¡ªt_Áohs
(x)

	)

165 #ifdeà 
__OPTIMIZE__


166 
	#Áohl
(
x
) \

167 (
	`__butš_cÚ¡ªt_p
((
x
)) ? \

168 
	`__cÚ¡ªt_Áohl
((
x
)) : \

169 
	`__Áohl
((
x
)))

	)

170 
	#Áohs
(
x
) \

171 (
	`__butš_cÚ¡ªt_p
((
x
)) ? \

172 
	`__cÚ¡ªt_Áohs
((
x
)) : \

173 
	`__Áohs
((
x
)))

	)

174 
	#htÚl
(
x
) \

175 (
	`__butš_cÚ¡ªt_p
((
x
)) ? \

176 
	`__cÚ¡ªt_htÚl
((
x
)) : \

177 
	`__htÚl
((
x
)))

	)

178 
	#htÚs
(
x
) \

179 (
	`__butš_cÚ¡ªt_p
((
x
)) ? \

180 
	`__cÚ¡ªt_htÚs
((
x
)) : \

181 
	`__htÚs
((
x
)))

	)

	@include/linux/in_systm.h

18 #iâdeà
_LINUX_IN_SYSTM_H


19 
	#_LINUX_IN_SYSTM_H


	)

28 
u_shÜt
 
	tn_shÜt
;

29 
u_lÚg
 
	tn_lÚg
;

30 
u_lÚg
 
	tn_time
;

	@include/linux/interrupt.h

2 #iâdeà
_LINUX_INTERRUPT_H


3 
	#_LINUX_INTERRUPT_H


	)

5 
	sbh_¡ruù
 {

6 (*
	mroutše
)(*);

7 *
	md©a
;

10 
bh_aùive
;

11 
bh_mask
;

12 
bh_¡ruù
 
bh_ba£
[32];

17 
	mTIMER_BH
 = 0,

18 
	mCONSOLE_BH
,

19 
	mSERIAL_BH
,

20 
	mTTY_BH
,

21 
	mINET_BH
,

22 
	mKEYBOARD_BH


25 
šlše
 
	$m¬k_bh
(
Ä
)

27 
__asm__
 
	`__vŞ©e__
("ÜÈ%1,%0":"=m" (
bh_aùive
):"œ" (1<<
Ä
));

28 
	}
}

30 
šlše
 
	$di§bË_bh
(
Ä
)

32 
__asm__
 
	`__vŞ©e__
("ªdÈ%1,%0":"=m" (
bh_mask
):"œ" (~(1<<
Ä
)));

33 
	}
}

35 
šlše
 
	$’abË_bh
(
Ä
)

37 
__asm__
 
	`__vŞ©e__
("ÜÈ%1,%0":"=m" (
bh_mask
):"œ" (1<<
Ä
));

38 
	}
}

	@include/linux/ioctl.h

6 #iâdeà
_LINUX_IOCTL_H


7 
	#_LINUX_IOCTL_H


	)

20 
	#IOC_VOID
 0x00000000

	)

21 
	#IOC_IN
 0x40000000

	)

22 
	#IOC_OUT
 0x80000000

	)

23 
	#IOC_INOUT
 (
IOC_IN
 | 
IOC_OUT
è

	)

24 
	#IOCSIZE_MASK
 0x3fff0000

	)

25 
	#IOCSIZE_SHIFT
 16

	)

26 
	#IOCCMD_MASK
 0x0000fffà

	)

27 
	#IOCCMD_SHIFT
 0

	)

33 
	#_IO
(
c
,
d
è(
IOC_VOID
 | ((c)<<8è| (d)è

	)

38 
	#_IOW
(
c
,
d
,
t
è(
IOC_IN
 | ((Ñ)<<16è& 
IOCSIZE_MASK
) | \

39 ((
c
)<<8è| (
d
))

	)

40 
	#_IOR
(
c
,
d
,
t
è(
IOC_OUT
 | ((Ñ)<<16è& 
IOCSIZE_MASK
) | \

41 ((
c
)<<8è| (
d
))

	)

43 
	#_IOWR
(
c
,
d
,
t
è(
IOC_INOUT
 | ((Ñ)<<16è& 
IOCSIZE_MASK
) | \

44 ((
c
)<<8è| (
d
))

	)

	@include/linux/ioport.h

10 #iâdeà
_LINUX_PORTIO_H


11 
	#_LINUX_PORTIO_H


	)

13 
	#HAVE_PORTRESERVE


	)

18 
»£rve_£tup
(*
¡r
, *
šts
);

19 
check_»giÚ
(
äom
, 
ex‹Á
);

20 
¢¬f_»giÚ
(
äom
, 
ex‹Á
);

23 
	#HAVE_AUTOIRQ


	)

24 *
œq2dev_m­
[16];

25 
autoœq_£tup
(
wa™time
);

26 
autoœq_»pÜt
(
wa™time
);

	@include/linux/ip.h

17 #iâdeà
_LINUX_IP_H


18 
	#_LINUX_IP_H


	)

21 
	#IPOPT_END
 0

	)

22 
	#IPOPT_NOOP
 1

	)

23 
	#IPOPT_SEC
 130

	)

24 
	#IPOPT_LSRR
 131

	)

25 
	#IPOPT_SSRR
 137

	)

26 
	#IPOPT_RR
 7

	)

27 
	#IPOPT_SID
 136

	)

28 
	#IPOPT_TIMESTAMP
 68

	)

31 
	stime¡amp
 {

32 
	mËn
;

33 
	m±r
;

35 
	mæags
:4,

36 
	mov”æow
:4;

37 
	mfuÎ_ch¬
;

38 } 
	mx
;

39 
	md©a
[9];

43 
	#MAX_ROUTE
 16

	)

45 
	srou‹
 {

46 
	mrou‹_size
;

47 
	mpoš‹r
;

48 
	mrou‹
[
MAX_ROUTE
];

52 
	sİtiÚs
 {

53 
rou‹
 
	m»cÜd_rou‹
;

54 
rou‹
 
	mloo£_rou‹
;

55 
rou‹
 
	m¡riù_rou‹
;

56 
time¡amp
 
	mt¡amp
;

57 
	m£cur™y
;

58 
	mcom·¹m’t
;

59 
	mhªdlšg
;

60 
	m¡»am
;

61 
	mtcc
;

65 
	shdr
 {

66 
	mihl
:4,

67 
	mv”siÚ
:4;

68 
	mtos
;

69 
	mtÙ_Ën
;

70 
	mid
;

71 
	mäag_off
;

72 
	m‰l
;

73 
	m´ÙocŞ
;

74 
	mcheck
;

75 
	m§ddr
;

76 
	mdaddr
;

	@include/linux/ipc.h

1 #iâdeà
_LINUX_IPC_H


2 
	#_LINUX_IPC_H


	)

3 
	~<lšux/ty³s.h
>

5 
	tkey_t
;

6 
	#IPC_PRIVATE
 ((
key_t
è0)

	)

8 
	sc_³rm


10 
key_t
 
	mkey
;

11 
ushÜt
 
	muid
;

12 
ushÜt
 
	mgid
;

13 
ushÜt
 
	mcuid
;

14 
ushÜt
 
	mcgid
;

15 
ushÜt
 
	mmode
;

16 
ushÜt
 
	m£q
;

21 
	#IPC_CREAT
 00001000

	)

22 
	#IPC_EXCL
 00002000

	)

23 
	#IPC_NOWAIT
 00004000

	)

30 
	#IPC_RMID
 0

	)

31 
	#IPC_SET
 1

	)

32 
	#IPC_STAT
 2

	)

33 
	#IPC_INFO
 3

	)

35 #ifdeà
__KERNEL__


38 
	#IPC_UNUSED
 ((*è-1)

	)

39 
	#IPC_NOID
 ((*è-2è

	)

44 
	sc_kludge
 {

45 
msgbuf
 *
	mmsgp
;

46 
	mmsgtyp
;

49 
	#SEMOP
 1

	)

50 
	#SEMGET
 2

	)

51 
	#SEMCTL
 3

	)

52 
	#MSGSND
 11

	)

53 
	#MSGRCV
 12

	)

54 
	#MSGGET
 13

	)

55 
	#MSGCTL
 14

	)

56 
	#SHMAT
 21

	)

57 
	#SHMDT
 22

	)

58 
	#SHMGET
 23

	)

59 
	#SHMCTL
 24

	)

	@include/linux/iso_fs.h

2 #iâdeà
_ISOFS_FS_H


3 
	#_ISOFS_FS_H


	)

5 
	~<lšux/ty³s.h
>

11 
	#ISODCL
(
äom
, 
to
èÑØ- from + 1)

	)

13 
	siso_vŞume_desütÜ
 {

14 
	mty³
[
ISODCL
(1,1)];

15 
	mid
[
ISODCL
(2,6)];

16 
	mv”siÚ
[
ISODCL
(7,7)];

17 
	md©a
[
ISODCL
(8,2048)];

21 
	#ISO_VD_PRIMARY
 1

	)

22 
	#ISO_VD_END
 255

	)

24 
	#ISO_STANDARD_ID
 "CD001"

	)

26 
	siso_´im¬y_desütÜ
 {

27 
	mty³
 [
ISODCL
 ( 1, 1)];

28 
	mid
 [
ISODCL
 ( 2, 6)];

29 
	mv”siÚ
 [
ISODCL
 ( 7, 7)];

30 
	munu£d1
 [
ISODCL
 ( 8, 8)];

31 
	msy¡em_id
 [
ISODCL
 ( 9, 40)];

32 
	mvŞume_id
 [
ISODCL
 ( 41, 72)];

33 
	munu£d2
 [
ISODCL
 ( 73, 80)];

34 
	mvŞume_¥aû_size
 [
ISODCL
 ( 81, 88)];

35 
	munu£d3
 [
ISODCL
 ( 89, 120)];

36 
	mvŞume_£t_size
 [
ISODCL
 (121, 124)];

37 
	mvŞume_£qu’û_numb”
 [
ISODCL
 (125, 128)];

38 
	mlogiÿl_block_size
 [
ISODCL
 (129, 132)];

39 
	m·th_bË_size
 [
ISODCL
 (133, 140)];

40 
	mty³_l_·th_bË
 [
ISODCL
 (141, 144)];

41 
	mİt_ty³_l_·th_bË
 [
ISODCL
 (145, 148)];

42 
	mty³_m_·th_bË
 [
ISODCL
 (149, 152)];

43 
	mİt_ty³_m_·th_bË
 [
ISODCL
 (153, 156)];

44 
	mroÙ_dœeùÜy_»cÜd
 [
ISODCL
 (157, 190)];

45 
	mvŞume_£t_id
 [
ISODCL
 (191, 318)];

46 
	mpublish”_id
 [
ISODCL
 (319, 446)];

47 
	m´•¬”_id
 [
ISODCL
 (447, 574)];

48 
	m­¶iÿtiÚ_id
 [
ISODCL
 (575, 702)];

49 
	mcİyright_fe_id
 [
ISODCL
 (703, 739)];

50 
	mab¡¿ù_fe_id
 [
ISODCL
 (740, 776)];

51 
	mbibliog¿phic_fe_id
 [
ISODCL
 (777, 813)];

52 
	mü—tiÚ_d©e
 [
ISODCL
 (814, 830)];

53 
	mmodifiÿtiÚ_d©e
 [
ISODCL
 (831, 847)];

54 
	mexpœ©iÚ_d©e
 [
ISODCL
 (848, 864)];

55 
	mefãùive_d©e
 [
ISODCL
 (865, 881)];

56 
	mfe_¡ruùu»_v”siÚ
 [
ISODCL
 (882, 882)];

57 
	munu£d4
 [
ISODCL
 (883, 883)];

58 
	m­¶iÿtiÚ_d©a
 [
ISODCL
 (884, 1395)];

59 
	munu£d5
 [
ISODCL
 (1396, 2048)];

63 
	#HS_STANDARD_ID
 "CDROM"

	)

65 
	shs_vŞume_desütÜ
 {

66 
	mfoo
 [
ISODCL
 ( 1, 8)];

67 
	mty³
 [
ISODCL
 ( 9, 9)];

68 
	mid
 [
ISODCL
 ( 10, 14)];

69 
	mv”siÚ
 [
ISODCL
 ( 15, 15)];

70 
	md©a
[
ISODCL
(16,2048)];

74 
	shs_´im¬y_desütÜ
 {

75 
	mfoo
 [
ISODCL
 ( 1, 8)];

76 
	mty³
 [
ISODCL
 ( 9, 9)];

77 
	mid
 [
ISODCL
 ( 10, 14)];

78 
	mv”siÚ
 [
ISODCL
 ( 15, 15)];

79 
	munu£d1
 [
ISODCL
 ( 16, 16)];

80 
	msy¡em_id
 [
ISODCL
 ( 17, 48)];

81 
	mvŞume_id
 [
ISODCL
 ( 49, 80)];

82 
	munu£d2
 [
ISODCL
 ( 81, 88)];

83 
	mvŞume_¥aû_size
 [
ISODCL
 ( 89, 96)];

84 
	munu£d3
 [
ISODCL
 ( 97, 128)];

85 
	mvŞume_£t_size
 [
ISODCL
 (129, 132)];

86 
	mvŞume_£qu’û_numb”
 [
ISODCL
 (133, 136)];

87 
	mlogiÿl_block_size
 [
ISODCL
 (137, 140)];

88 
	m·th_bË_size
 [
ISODCL
 (141, 148)];

89 
	mty³_l_·th_bË
 [
ISODCL
 (149, 152)];

90 
	munu£d4
 [
ISODCL
 (153, 180)];

91 
	mroÙ_dœeùÜy_»cÜd
 [
ISODCL
 (181, 214)];

96 
	siso_·th_bË
{

97 
	mÇme_Ën
[2];

98 
	mex‹Á
[4];

99 
	m·»Á
[2];

100 
	mÇme
[0];

106 
	siso_dœeùÜy_»cÜd
 {

107 
	mËngth
 [
ISODCL
 (1, 1)];

108 
	mext_©Œ_Ëngth
 [
ISODCL
 (2, 2)];

109 
	mex‹Á
 [
ISODCL
 (3, 10)];

110 
	msize
 [
ISODCL
 (11, 18)];

111 
	md©e
 [
ISODCL
 (19, 25)];

112 
	mæags
 [
ISODCL
 (26, 26)];

113 
	mfe_un™_size
 [
ISODCL
 (27, 27)];

114 
	mš‹¾—ve
 [
ISODCL
 (28, 28)];

115 
	mvŞume_£qu’û_numb”
 [
ISODCL
 (29, 32)];

116 
	mÇme_Ën
 [
ISODCL
 (33, 33)];

117 
	mÇme
 [0];

120 
isÚum_711
(*);

121 
isÚum_712
(*);

122 
isÚum_721
(*);

123 
isÚum_722
(*);

124 
isÚum_723
(*);

125 
isÚum_731
(*);

126 
isÚum_732
(*);

127 
isÚum_733
(*);

128 
iso_d©e
(*, );

130 
·r£_rock_ridge_šode
(
iso_dœeùÜy_»cÜd
 *, 
šode
 *);

131 
g‘_rock_ridge_f’ame
(
iso_dœeùÜy_»cÜd
 *, ** 
Çme
, * 
Ën
, 
šode
 *);

133 * 
g‘_rock_ridge_symlšk
(
šode
 *);

134 
fšd_rock_ridge_»loÿtiÚ
(
iso_dœeùÜy_»cÜd
 *, 
šode
 *);

136 
	#ISOFS_BLOCK_BITS
 11

	)

137 
	#ISOFS_BLOCK_SIZE
 2048

	)

139 
	#ISOFS_BUFFER_SIZE
(
INODE
è((INODE)->
i_sb
->
s_blocksize
)

	)

140 
	#ISOFS_BUFFER_BITS
(
INODE
è((INODE)->
i_sb
->
s_blocksize_b™s
)

	)

143 #ifdeà
ISOFS_FIXED_BLOCKSIZE


145 
	#ISOFS_BUFFER_BITS
 10

	)

146 
	#ISOFS_BUFFER_SIZE
 1024

	)

148 
	#ISOFS_BLOCK_NUMBER
(
X
è(X<<1)

	)

150 
	#ISOFS_BUFFER_BITS
 11

	)

151 
	#ISOFS_BUFFER_SIZE
 2048

	)

153 
	#ISOFS_BLOCK_NUMBER
(
X
è(X)

	)

157 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

158 
	#ISOFS_FILE_UNKNOWN
 0

	)

159 
	#ISOFS_FILE_TEXT
 1

	)

160 
	#ISOFS_FILE_BINARY
 2

	)

161 
	#ISOFS_FILE_TEXT_M
 3

	)

167 
isofs_İ’
(
šode
 * inode, 
fe
 * 
fp
);

168 
isofs_»Ëa£
(
šode
 * inode, 
fe
 * 
fp
);

169 
isofs_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

170 
šode
 ** 
»suÉ
);

171 
isofs_couÁ_ä“_šodes
(
su³r_block
 *
sb
);

172 
isofs_Ãw_block
(
dev
);

173 
isofs_ä“_block
(
dev
, 
block
);

174 
isofs_bm­
(
šode
 *,);

176 
isofs_put_su³r
(
su³r_block
 *);

177 
su³r_block
 *
isofs_»ad_su³r
(super_block *,*,);

178 
isofs_»ad_šode
(
šode
 *);

179 
isofs_put_šode
(
šode
 *);

180 
isofs_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

182 
isofs_l£ek
(
šode
 *, 
fe
 *, 
off_t
, );

183 
isofs_»ad
(
šode
 *, 
fe
 *, *, );

184 
isofs_lookup_g¿nd·»Á
(
šode
 *, );

186 
šode_İ”©iÚs
 
isofs_fe_šode_İ”©iÚs
;

187 
šode_İ”©iÚs
 
isofs_dœ_šode_İ”©iÚs
;

188 
šode_İ”©iÚs
 
isofs_symlšk_šode_İ”©iÚs
;

189 
šode_İ”©iÚs
 
isofs_chrdev_šode_İ”©iÚs
;

190 
šode_İ”©iÚs
 
isofs_blkdev_šode_İ”©iÚs
;

191 
šode_İ”©iÚs
 
isofs_fifo_šode_İ”©iÚs
;

193 
	slookup_ÿche
{

194 
	mdœ
;

195 
dev_t
 
	mdev
;

196 
	mdËn
;

197 
	mf’ame
[256];

198 
	mšo
;

201 
lookup_ÿche
 
ÿche
;

204 #ifdeà
LEAK_CHECK


205 
	#ä“_s
 
Ëak_check_ä“_s


	)

206 
	#m®loc
 
Ëak_check_m®loc


	)

207 
	#b»ad
 
Ëak_check_b»ad


	)

208 
	#b»l£
 
Ëak_check_b»l£


	)

209 * 
Ëak_check_m®loc
(
size
);

210 
Ëak_check_ä“_s
(* 
obj
, 
size
);

211 
bufãr_h—d
 * 
Ëak_check_b»ad
(
dev
, 
block
, 
size
);

212 
Ëak_check_b»l£
(
bufãr_h—d
 * 
bh
);

	@include/linux/iso_fs_i.h

1 #iâdeà
_ISO_FS_I


2 
	#_ISO_FS_I


	)

7 
	siso_šode_šfo
 {

8 
	mi_fœ¡_ex‹Á
;

9 
	mi_backlšk
;

10 
	mi_fe_fÜm©
;

	@include/linux/iso_fs_sb.h

1 #iâdeà
_ISOFS_FS_SB


2 
	#_ISOFS_FS_SB


	)

7 
	sisofs_sb_šfo
 {

8 
	ms_nšodes
;

9 
	ms_nzÚes
;

10 
	ms_fœ¡d©azÚe
;

11 
	ms_log_zÚe_size
;

12 
	ms_max_size
;

14 
	ms_high_s›¼a
;

15 
	ms_m­pšg
;

16 
	ms_cÚv”siÚ
;

17 
	ms_rock
;

18 
	ms_üuá
;

	@include/linux/kd.h

1 #iâdeà
_LINUX_KD_H


2 
	#_LINUX_KD_H


	)

6 
	#SWAPMONO
 0x4B00

	)

7 
	#SWAPCGA
 0x4B01

	)

8 
	#SWAPEGA
 0x4B02

	)

9 
	#SWAPVGA
 0x4B03

	)

10 
	#CONS_CURRENT
 0x4B04

	)

11 
	#MONO
 0x01

	)

12 
	#CGA
 0x02

	)

13 
	#EGA
 0x03

	)

15 
	#SW_B40x25
 0x4B05

	)

16 
	#SW_C40x25
 0x4B06

	)

17 
	#SW_B80x25
 0x4B07

	)

18 
	#SW_C80x25
 0x4B08

	)

19 
	#SW_BG320
 0x4B09

	)

20 
	#SW_CG320
 0x4B0A

	)

21 
	#SW_BG640
 0x4B0B

	)

22 
	#SW_CG320_D
 0x4B0C

	)

23 
	#SW_CG640_E
 0x4B0D

	)

24 
	#SW_EGAMONOAPA
 0x4B0E

	)

25 
	#SW_ENH_MONOAPA2
 0x4B0F

	)

26 
	#SW_CG640x350
 0x4B10

	)

27 
	#SW_ENH_CG640
 0x4B11

	)

28 
	#SW_EGAMONO80x25
 0x4B12

	)

29 
	#SW_ENHB40x25
 0x4B13

	)

30 
	#SW_ENHC40x25
 0x4B14

	)

31 
	#SW_ENHB80x25
 0x4B15

	)

32 
	#SW_ENHC80x25
 0x4B16

	)

33 
	#SW_ENHB80x43
 0x4B17

	)

34 
	#SW_ENHC80x43
 0x4B18

	)

35 
	#SW_MCAMODE
 0x4B19

	)

36 
	#SW_ATT640
 0x4B1A

	)

39 
	#CONS_GET
 0x4B1B

	)

40 
	#M_B40x25
 0

	)

41 
	#M_C40x25
 1

	)

42 
	#M_B80x25
 2

	)

43 
	#M_C80x25
 3

	)

44 
	#M_BG320
 4

	)

45 
	#M_CG320
 5

	)

46 
	#M_BG640
 6

	)

47 
	#M_EGAMONO80x25
 7

	)

48 
	#M_CG320_D
 13

	)

49 
	#M_CG640_E
 14

	)

50 
	#M_EFAMONOAPA
 15

	)

51 
	#M_CG640x350
 16

	)

52 
	#M_ENHMONOAPA2
 17

	)

53 
	#M_ENH_CG640
 18

	)

54 
	#M_ENH_B40x25
 19

	)

55 
	#M_ENH_C40x25
 20

	)

56 
	#M_ENH_B80x25
 21

	)

57 
	#M_ENH_C80x25
 22

	)

58 
	#M_ENH_B80x43
 0x70

	)

59 
	#M_ENH_C80x43
 0x71

	)

60 
	#M_MCA_MODE
 0xfà

	)

61 
	#MCA_GET
 0x4B1C

	)

62 
	#CGA_GET
 0x4B1D

	)

63 
	#EGA_GET
 0x4B1E

	)

65 
	#MAPCONS
 0x4B1F

	)

66 
	#MAPMONO
 0x4B20

	)

67 
	#MAPCGA
 0x4B21

	)

68 
	#MAPEGA
 0x4B22

	)

69 
	#MAPVGA
 0x4B23

	)

71 
	spÜt_io_¡ruc
 {

72 
	mdœ
;

73 
	mpÜt
;

74 
	md©a
;

76 
	#IN_ON_PORT
 0x00

	)

77 
	#OUT_ON_PORT
 0x01

	)

78 
	spÜt_io_¬g
 {

79 
pÜt_io_¡ruc
 
	m¬gs
[4];

81 
	#MCAIO
 0x4B24

	)

82 
	#CGAIO
 0x4B25

	)

83 
	#EGAIO
 0x4B26

	)

84 
	#VGAIO
 0x4B27

	)

86 
	#GIO_FONT8x8
 0x4B28

	)

87 
	#PIO_FONT8x8
 0x4B29

	)

88 
	#GIO_FONT8x14
 0x4B2A

	)

89 
	#PIO_FONT8x14
 0x4B2B

	)

90 
	#GIO_FONT8x16
 0x4B2C

	)

91 
	#PIO_FONT8x16
 0x4B2D

	)

93 
	#GIO_FONT
 0x4B60

	)

94 
	#PIO_FONT
 0x4B61

	)

96 
	#MKDIOADDR
 32

	)

97 
	skd_di¥¬am
 {

98 
	mty³
;

99 *
	maddr
;

100 
ushÜt
 
	mißddr
[
MKDIOADDR
];

102 
	#KDDISPTYPE
 0x4B2E

	)

103 
	#KD_MONO
 0x01

	)

104 
	#KD_HERCULES
 0x02

	)

105 
	#KD_CGA
 0x03

	)

106 
	#KD_EGA
 0x04

	)

108 
	#KIOCSOUND
 0x4B2F

	)

109 
	#KDMKTONE
 0x4B30

	)

111 
	#KDGETLED
 0x4B31

	)

112 
	#KDSETLED
 0x4B32

	)

113 
	#LED_SCR
 0x01

	)

114 
	#LED_CAP
 0x04

	)

115 
	#LED_NUM
 0x02

	)

117 
	#KDGKBTYPE
 0x4B33

	)

118 
	#KB_84
 0x01

	)

119 
	#KB_101
 0x02

	)

120 
	#KB_OTHER
 0x03

	)

122 
	#KDADDIO
 0x4B34

	)

123 
	#KDDELIO
 0x4B35

	)

124 
	#KDENABIO
 0x4B36

	)

125 
	#KDDISABIO
 0x4B37

	)

127 
	skd_quemode
 {

128 
	mqsize
;

129 
	msigno
;

130 *
	mqaddr
;

132 
	#KDQUEMODE
 0x4B38

	)

134 
	#KDSBORDER
 0x4B39

	)

136 
	#KDSETMODE
 0x4B3A

	)

137 
	#KD_TEXT
 0x00

	)

138 
	#KD_GRAPHICS
 0x01

	)

139 
	#KD_TEXT0
 0x02

	)

140 
	#KD_TEXT1
 0x03

	)

141 
	#KDGETMODE
 0x4B3B

	)

143 
	skd_memloc
 {

144 *
	mvaddr
;

145 *
	mphy§ddr
;

146 
	mËngth
;

147 
	mioæg
;

149 
	#KDMAPDISP
 0x4B3C

	)

150 
	#KDUNMAPDISP
 0x4B3D

	)

152 
	#KDVDCTYPE
 0x4B3E

	)

154 
	#KIOCINFO
 0x4B3F

	)

156 
	tsünm­_t
;

157 
	#E_TABSZ
 256

	)

158 
	#GIO_SCRNMAP
 0x4B40

	)

159 
	#PIO_SCRNMAP
 0x4B41

	)

161 
	#GIO_ATTR
 0x4B42

	)

162 
	#GIO_COLOR
 0x4B43

	)

164 
	#K_RAW
 0x00

	)

165 
	#K_XLATE
 0x01

	)

166 
	#K_MEDIUMRAW
 0x02

	)

167 
	#KDGKBMODE
 0x4B44

	)

168 
	#KDSKBMODE
 0x4B45

	)

171 
	#K_METABIT
 0x03

	)

172 
	#K_ESCPREFIX
 0x04

	)

173 
	#KDGKBMETA
 0x4B62

	)

174 
	#KDSKBMETA
 0x4B63

	)

176 
	skb’Œy
 {

177 
u_ch¬
 
	mkb_bË
;

178 
u_ch¬
 
	mkb_šdex
;

179 
u_shÜt
 
	mkb_v®ue
;

181 
	#K_NORMTAB
 0x00

	)

182 
	#K_SHIFTTAB
 0x01

	)

183 
	#K_ALTTAB
 0x02

	)

184 
	#K_ALTSHIFTTAB
 0x03

	)

185 
	#K_SRQTAB
 0x04

	)

186 
	#KDGKBENT
 0x4B46

	)

187 
	#KDSKBENT
 0x4B47

	)

189 
	skb£Áry
 {

190 
u_ch¬
 
	mkb_func
;

191 
u_ch¬
 
	mkb_¡ršg
[512];

193 
	#KDGKBSENT
 0x4B48

	)

194 
	#KDSKBSENT
 0x4B49

	)

196 
	skbdŸü
 {

197 
u_ch¬
 
	mdŸü
, 
	mba£
, 
	m»suÉ
;

199 
	skbdŸüs
 {

200 
	mkb_út
;

201 
kbdŸü
 
	mkbdŸü
[256];

203 
	#KDGKBDIACR
 0x4B4A

	)

204 
	#KDSKBDIACR
 0x4B4B

	)

	@include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

8 #ifdeà
__KERNEL__


10 
	~<lšux/lškage.h
>

12 
	#INT_MAX
 (()(~0U>>1))

	)

13 
	#UINT_MAX
 (~0U)

	)

14 
	#LONG_MAX
 (()(~0UL>>1))

	)

15 
	#ULONG_MAX
 (~0UL)

	)

17 
	#KERN_EMERG
 "<0>"

	)

18 
	#KERN_ALERT
 "<1>"

	)

19 
	#KERN_CRIT
 "<2>"

	)

20 
	#KERN_ERR
 "<3>"

	)

21 
	#KERN_WARNING
 "<4>"

	)

22 
	#KERN_NOTICE
 "<5>"

	)

23 
	#KERN_INFO
 "<6>"

	)

24 
	#KERN_DEBUG
 "<7>"

	)

26 #ià
__GNUC__
 < 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 < 5)

27 
	#NORET_TYPE
 
__vŞ©e__


	)

28 
	#ATTRIB_NORET


	)

29 
	#NORET_AND


	)

31 
	#NORET_TYPE


	)

32 
	#ATTRIB_NORET
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

33 
	#NORET_AND
 
nÜ‘uº
,

	)

36 
m©h_”rÜ
();

37 
NORET_TYPE
 
	$·nic
(cÚ¡ * 
fmt
, ...)

38 
	`__©Œibu‹__
 ((
NORET_AND
 
	`fÜm©
 (
´štf
, 1, 2)));

39 
NORET_TYPE
 
	$do_ex™
(
”rÜ_code
)

40 
ATTRIB_NORET
;

41 
	`sim¶e_¡¹oul
(const *,**,);

42 
	`¥rštf
(* 
buf
, cÚ¡ * 
fmt
, ...);

44 
	`£ssiÚ_of_pg½
(
pg½
);

46 
	`kl_´oc
(
pid
, 
sig
, 
´iv
);

47 
	`kl_pg
(
pg½
, 
sig
, 
´iv
);

48 
	`kl_¦
(
£ss
, 
sig
, 
´iv
);

50 
asmlškage
 
	$´štk
(cÚ¡ * 
fmt
, ...)

51 
	`__©Œibu‹__
 ((
	`fÜm©
 (
´štf
, 1, 2)));

60 
	#su£r
(è(
cu¼’t
->
euid
 =ğ0)

	)

64 
	#SI_LOAD_SHIFT
 16

	)

65 
	ssysšfo
 {

66 
u±ime
;

67 
lßds
[3];

68 
tÙ®¿m
;

69 
ä“¿m
;

70 
sh¬ed¿m
;

71 
bufã¼am
;

72 
tÙ®sw­
;

73 
ä“sw­
;

74 
´ocs
;

75 
_f
[22];

	@include/linux/kernel_stat.h

1 #iâdeà
_LINUX_KERNEL_STAT_H


2 
	#_LINUX_KERNEL_STAT_H


	)

10 
	#DK_NDRIVE
 4

	)

12 
	sk”Ãl_¡©
 {

13 
	mıu_u£r
, 
	mıu_niû
, 
	mıu_sy¡em
;

14 
	mdk_drive
[
DK_NDRIVE
];

15 
	mpgpgš
, 
	mpgpgout
;

16 
	mpswpš
, 
	mpswpout
;

17 
	mš‹¼u±s
;

18 
	mack‘s
, 
	mİack‘s
;

19 
	m›¼Üs
, 
	mÛ¼Üs
;

20 
	mcŞlisiÚs
;

21 
	mcÚ‹xt_swtch
;

24 
k”Ãl_¡©
 
k¡©
;

	@include/linux/keyboard.h

1 #iâdeà
__LINUX_KEYBOARD_H


2 
	#__LINUX_KEYBOARD_H


	)

4 
	#KG_SHIFT
 0

	)

5 
	#KG_CTRL
 2

	)

6 
	#KG_ALT
 3

	)

7 
	#KG_ALTGR
 1

	)

8 
	#KG_SHIFTL
 4

	)

9 
	#KG_SHIFTR
 5

	)

10 
	#KG_CTRLL
 6

	)

11 
	#KG_CTRLR
 7

	)

13 
	#NR_KEYS
 128

	)

14 
	#NR_KEYMAPS
 16

	)

15 cÚ¡ 
NR_TYPES
;

16 cÚ¡ 
max_v®s
[];

17 
key_m­
[
NR_KEYMAPS
][
NR_KEYS
];

19 
	#NR_FUNC
 36

	)

20 
	#FUNC_BUFSIZE
 512

	)

21 
func_buf
[
FUNC_BUFSIZE
];

22 *
func_bË
[
NR_FUNC
];

24 
	#KT_LATIN
 0

	)

25 
	#KT_LETTER
 11

	)

26 
	#KT_FN
 1

	)

27 
	#KT_SPEC
 2

	)

28 
	#KT_PAD
 3

	)

29 
	#KT_DEAD
 4

	)

30 
	#KT_CONS
 5

	)

31 
	#KT_CUR
 6

	)

32 
	#KT_SHIFT
 7

	)

33 
	#KT_META
 8

	)

34 
	#KT_ASCII
 9

	)

35 
	#KT_LOCK
 10

	)

37 
	#K
(
t
,
v
è((Ñ)<<8)|(v))

	)

38 
	#KTYP
(
x
è((xè>> 8)

	)

39 
	#KVAL
(
x
è((xè& 0xff)

	)

41 
	#K_F1
 
	`K
(
KT_FN
,0)

	)

42 
	#K_F2
 
	`K
(
KT_FN
,1)

	)

43 
	#K_F3
 
	`K
(
KT_FN
,2)

	)

44 
	#K_F4
 
	`K
(
KT_FN
,3)

	)

45 
	#K_F5
 
	`K
(
KT_FN
,4)

	)

46 
	#K_F6
 
	`K
(
KT_FN
,5)

	)

47 
	#K_F7
 
	`K
(
KT_FN
,6)

	)

48 
	#K_F8
 
	`K
(
KT_FN
,7)

	)

49 
	#K_F9
 
	`K
(
KT_FN
,8)

	)

50 
	#K_F10
 
	`K
(
KT_FN
,9)

	)

51 
	#K_F11
 
	`K
(
KT_FN
,10)

	)

52 
	#K_F12
 
	`K
(
KT_FN
,11)

	)

53 
	#K_F13
 
	`K
(
KT_FN
,12)

	)

54 
	#K_F14
 
	`K
(
KT_FN
,13)

	)

55 
	#K_F15
 
	`K
(
KT_FN
,14)

	)

56 
	#K_F16
 
	`K
(
KT_FN
,15)

	)

57 
	#K_F17
 
	`K
(
KT_FN
,16)

	)

58 
	#K_F18
 
	`K
(
KT_FN
,17)

	)

59 
	#K_F19
 
	`K
(
KT_FN
,18)

	)

60 
	#K_F20
 
	`K
(
KT_FN
,19)

	)

61 
	#K_FIND
 
	`K
(
KT_FN
,20)

	)

62 
	#K_INSERT
 
	`K
(
KT_FN
,21)

	)

63 
	#K_REMOVE
 
	`K
(
KT_FN
,22)

	)

64 
	#K_SELECT
 
	`K
(
KT_FN
,23)

	)

65 
	#K_PGUP
 
	`K
(
KT_FN
,24)

	)

66 
	#K_PGDN
 
	`K
(
KT_FN
,25)

	)

67 
	#K_MACRO
 
	`K
(
KT_FN
,26)

	)

68 
	#K_HELP
 
	`K
(
KT_FN
,27)

	)

69 
	#K_DO
 
	`K
(
KT_FN
,28)

	)

70 
	#K_PAUSE
 
	`K
(
KT_FN
,29)

	)

72 
	#K_HOLE
 
	`K
(
KT_SPEC
,0)

	)

73 
	#K_ENTER
 
	`K
(
KT_SPEC
,1)

	)

74 
	#K_SH_REGS
 
	`K
(
KT_SPEC
,2)

	)

75 
	#K_SH_MEM
 
	`K
(
KT_SPEC
,3)

	)

76 
	#K_SH_STAT
 
	`K
(
KT_SPEC
,4)

	)

77 
	#K_BREAK
 
	`K
(
KT_SPEC
,5)

	)

78 
	#K_CONS
 
	`K
(
KT_SPEC
,6)

	)

79 
	#K_CAPS
 
	`K
(
KT_SPEC
,7)

	)

80 
	#K_NUM
 
	`K
(
KT_SPEC
,8)

	)

81 
	#K_HOLD
 
	`K
(
KT_SPEC
,9)

	)

82 
	#K_SCROLLFORW
 
	`K
(
KT_SPEC
,10)

	)

83 
	#K_SCROLLBACK
 
	`K
(
KT_SPEC
,11)

	)

84 
	#K_BOOT
 
	`K
(
KT_SPEC
,12)

	)

85 
	#K_CAPSON
 
	`K
(
KT_SPEC
,13)

	)

86 
	#K_COMPOSE
 
	`K
(
KT_SPEC
,14)

	)

88 
	#K_P0
 
	`K
(
KT_PAD
,0)

	)

89 
	#K_P1
 
	`K
(
KT_PAD
,1)

	)

90 
	#K_P2
 
	`K
(
KT_PAD
,2)

	)

91 
	#K_P3
 
	`K
(
KT_PAD
,3)

	)

92 
	#K_P4
 
	`K
(
KT_PAD
,4)

	)

93 
	#K_P5
 
	`K
(
KT_PAD
,5)

	)

94 
	#K_P6
 
	`K
(
KT_PAD
,6)

	)

95 
	#K_P7
 
	`K
(
KT_PAD
,7)

	)

96 
	#K_P8
 
	`K
(
KT_PAD
,8)

	)

97 
	#K_P9
 
	`K
(
KT_PAD
,9)

	)

98 
	#K_PPLUS
 
	`K
(
KT_PAD
,10è

	)

99 
	#K_PMINUS
 
	`K
(
KT_PAD
,11è

	)

100 
	#K_PSTAR
 
	`K
(
KT_PAD
,12è

	)

101 
	#K_PSLASH
 
	`K
(
KT_PAD
,13è

	)

102 
	#K_PENTER
 
	`K
(
KT_PAD
,14è

	)

103 
	#K_PCOMMA
 
	`K
(
KT_PAD
,15è

	)

104 
	#K_PDOT
 
	`K
(
KT_PAD
,16è

	)

105 
	#K_PPLUSMINUS
 
	`K
(
KT_PAD
,17è

	)

107 
	#K_DGRAVE
 
	`K
(
KT_DEAD
,0)

	)

108 
	#K_DACUTE
 
	`K
(
KT_DEAD
,1)

	)

109 
	#K_DCIRCM
 
	`K
(
KT_DEAD
,2)

	)

110 
	#K_DTILDE
 
	`K
(
KT_DEAD
,3)

	)

111 
	#K_DDIERE
 
	`K
(
KT_DEAD
,4)

	)

113 
	#K_DOWN
 
	`K
(
KT_CUR
,0)

	)

114 
	#K_LEFT
 
	`K
(
KT_CUR
,1)

	)

115 
	#K_RIGHT
 
	`K
(
KT_CUR
,2)

	)

116 
	#K_UP
 
	`K
(
KT_CUR
,3)

	)

118 
	#K_SHIFT
 
	`K
(
KT_SHIFT
,
KG_SHIFT
)

	)

119 
	#K_CTRL
 
	`K
(
KT_SHIFT
,
KG_CTRL
)

	)

120 
	#K_ALT
 
	`K
(
KT_SHIFT
,
KG_ALT
)

	)

121 
	#K_ALTGR
 
	`K
(
KT_SHIFT
,
KG_ALTGR
)

	)

122 
	#K_SHIFTL
 
	`K
(
KT_SHIFT
,
KG_SHIFTL
)

	)

123 
	#K_SHIFTR
 
	`K
(
KT_SHIFT
,
KG_SHIFTR
)

	)

124 
	#K_CTRLL
 
	`K
(
KT_SHIFT
,
KG_CTRLL
)

	)

125 
	#K_CTRLR
 
	`K
(
KT_SHIFT
,
KG_CTRLR
)

	)

127 
	#NR_SHIFT
 4

	)

129 
	#K_CAPSSHIFT
 
	`K
(
KT_SHIFT
,
NR_SHIFT
)

	)

131 
	#K_ASC0
 
	`K
(
KT_ASCII
,0)

	)

132 
	#K_ASC1
 
	`K
(
KT_ASCII
,1)

	)

133 
	#K_ASC2
 
	`K
(
KT_ASCII
,2)

	)

134 
	#K_ASC3
 
	`K
(
KT_ASCII
,3)

	)

135 
	#K_ASC4
 
	`K
(
KT_ASCII
,4)

	)

136 
	#K_ASC5
 
	`K
(
KT_ASCII
,5)

	)

137 
	#K_ASC6
 
	`K
(
KT_ASCII
,6)

	)

138 
	#K_ASC7
 
	`K
(
KT_ASCII
,7)

	)

139 
	#K_ASC8
 
	`K
(
KT_ASCII
,8)

	)

140 
	#K_ASC9
 
	`K
(
KT_ASCII
,9)

	)

142 
	#K_SHIFTLOCK
 
	`K
(
KT_LOCK
,
KG_SHIFT
)

	)

143 
	#K_CTRLLOCK
 
	`K
(
KT_LOCK
,
KG_CTRL
)

	)

144 
	#K_ALTLOCK
 
	`K
(
KT_LOCK
,
KG_ALT
)

	)

145 
	#K_ALTGRLOCK
 
	`K
(
KT_LOCK
,
KG_ALTGR
)

	)

147 
	#MAX_DIACR
 256

	)

	@include/linux/ldt.h

6 #iâdeà
_LINUX_LDT_H


7 
	#_LINUX_LDT_H


	)

10 
	#LDT_ENTRIES
 8192

	)

12 
	#LDT_ENTRY_SIZE
 8

	)

14 
	smodify_ldt_ldt_s
 {

15 
	m’Œy_numb”
;

16 
	mba£_addr
;

17 
	mlim™
;

18 
	m£g_32b™
:1;

19 
	mcÚ‹Ás
:2;

20 
	m»ad_exec_Úly
:1;

21 
	mlim™_š_·ges
:1;

24 
	#MODIFY_LDT_CONTENTS_DATA
 0

	)

25 
	#MODIFY_LDT_CONTENTS_STACK
 1

	)

26 
	#MODIFY_LDT_CONTENTS_CODE
 2

	)

28 
g‘_ldt
(*
bufãr
);

29 
£t_ldt_’Œy
(
’Œy
, 
ba£
, 
lim™
,

30 
£g_32b™_æag
, 
cÚ‹Ás
, 
»ad_Úly_æag
,

31 
lim™_š_·ges_æag
);

	@include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 256

	)

6 
	#NGROUPS_MAX
 32

	)

7 
	#ARG_MAX
 131072

	)

8 
	#CHILD_MAX
 999

	)

9 
	#OPEN_MAX
 256

	)

10 
	#LINK_MAX
 127

	)

11 
	#MAX_CANON
 255

	)

12 
	#MAX_INPUT
 255

	)

13 
	#NAME_MAX
 255

	)

14 
	#PATH_MAX
 1024

	)

15 
	#PIPE_BUF
 4096

	)

	@include/linux/linkage.h

1 #iâdeà
_LINUX_LINKAGE_H


2 
	#_LINUX_LINKAGE_H


	)

4 #ifdeà
__ılu¥lus


5 
	#asmlškage
 "C"

	)

7 
	#asmlškage


	)

	@include/linux/locks.h

1 #iâdeà
_LINUX_LOCKS_H


2 
	#_LINUX_LOCKS_H


	)

8 
__wa™_Ú_bufãr
(
bufãr_h—d
 *);

10 
šlše
 
	$wa™_Ú_bufãr
(
bufãr_h—d
 * 
bh
)

12 ià(
bh
->
b_lock
)

13 
	`__wa™_Ú_bufãr
(
bh
);

14 
	}
}

16 
šlše
 
	$lock_bufãr
(
bufãr_h—d
 * 
bh
)

18 ià(
bh
->
b_lock
)

19 
	`__wa™_Ú_bufãr
(
bh
);

20 
bh
->
b_lock
 = 1;

21 
	}
}

23 
šlše
 
	$uÆock_bufãr
(
bufãr_h—d
 * 
bh
)

25 
bh
->
b_lock
 = 0;

26 
	`wake_up
(&
bh
->
b_wa™
);

27 
	}
}

34 
__wa™_Ú_su³r
(
su³r_block
 *);

36 
šlše
 
	$wa™_Ú_su³r
(
su³r_block
 * 
sb
)

38 ià(
sb
->
s_lock
)

39 
	`__wa™_Ú_su³r
(
sb
);

40 
	}
}

42 
šlše
 
	$lock_su³r
(
su³r_block
 * 
sb
)

44 ià(
sb
->
s_lock
)

45 
	`__wa™_Ú_su³r
(
sb
);

46 
sb
->
s_lock
 = 1;

47 
	}
}

49 
šlše
 
	$uÆock_su³r
(
su³r_block
 * 
sb
)

51 
sb
->
s_lock
 = 0;

52 
	`wake_up
(&
sb
->
s_wa™
);

53 
	}
}

	@include/linux/lp.h

1 #iâdeà
_LINUX_LP_H


2 
	#_LINUX_LP_H


	)

14 
	#LP_EXIST
 0x0001

	)

15 
	#LP_SELEC
 0x0002

	)

16 
	#LP_BUSY
 0x0004

	)

17 
	#LP_OFFL
 0x0008

	)

18 
	#LP_NOPA
 0x0010

	)

19 
	#LP_ERR
 0x0020

	)

20 
	#LP_ABORT
 0x0040

	)

30 
	#LP_INIT_CHAR
 1000

	)

39 
	#LP_INIT_WAIT
 0

	)

51 
	#LP_INIT_TIME
 2

	)

54 
	#LPCHAR
 0x0001

	)

55 
	#LPTIME
 0x0002

	)

56 
	#LPABORT
 0x0004

	)

58 
	#LPSETIRQ
 0x0005

	)

60 
	#LPGETIRQ
 0x0006

	)

61 
	#LPWAIT
 0x0008

	)

67 
	#LP_TIMEOUT_INTERRUPT
 (60 * 
HZ
)

	)

68 
	#LP_TIMEOUT_POLLED
 (10 * 
HZ
)

	)

70 
	#LP_B
(
mšÜ
è
Í_bË
[(mšÜ)].
ba£


	)

71 
	#LP_F
(
mšÜ
è
Í_bË
[(mšÜ)].
æags


	)

72 
	#LP_S
(
mšÜ
è
	`šb_p
(
	`LP_B
((mšÜ)è+ 1è

	)

73 
	#LP_C
(
mšÜ
è(
Í_bË
[(mšÜ)].
ba£
 + 2è

	)

74 
	#LP_CHAR
(
mšÜ
è
Í_bË
[(mšÜ)].
ch¬s


	)

75 
	#LP_TIME
(
mšÜ
è
Í_bË
[(mšÜ)].
time


	)

76 
	#LP_WAIT
(
mšÜ
è
Í_bË
[(mšÜ)].
wa™


	)

77 
	#LP_IRQ
(
mšÜ
è
Í_bË
[(mšÜ)].
œq


	)

80 
	#LP_BUFFER_SIZE
 256

	)

82 
	sÍ_¡ruù
 {

83 
	mba£
;

84 
	mœq
;

85 
	mæags
;

86 
	mch¬s
;

87 
	mtime
;

88 
	mwa™
;

89 
wa™_queue
 *
	mÍ_wa™_q
;

90 *
	mÍ_bufãr
;

99 
Í_¡ruù
 
	gÍ_bË
[] = {

100 { 0x3bc, 0, 0, 
LP_INIT_CHAR
, 
LP_INIT_TIME
, 
LP_INIT_WAIT
, 
NULL
, NULL, },

101 { 0x378, 0, 0, 
LP_INIT_CHAR
, 
LP_INIT_TIME
, 
LP_INIT_WAIT
, 
NULL
, NULL, },

102 { 0x278, 0, 0, 
LP_INIT_CHAR
, 
LP_INIT_TIME
, 
LP_INIT_WAIT
, 
NULL
, NULL, },

104 
	#LP_NO
 3

	)

111 
	#LP_PBUSY
 0x80

	)

112 
	#LP_PACK
 0x40

	)

113 
	#LP_POUTPA
 0x20

	)

114 
	#LP_PSELECD
 0x10

	)

115 
	#LP_PERRORP
 0x08

	)

122 
	#LP_PINTEN
 0x10

	)

123 
	#LP_PSELECP
 0x08

	)

124 
	#LP_PINITP
 0x04

	)

125 
	#LP_PAUTOLF
 0x02

	)

126 
	#LP_PSTROBE
 0x01

	)

133 
	#LP_DUMMY
 0x00

	)

139 
	#LP_DELAY
 150000

	)

145 
Í_š™
();

	@include/linux/major.h

1 #iâdeà
_LINUX_MAJOR_H


2 
	#_LINUX_MAJOR_H


	)

10 
	#MAX_CHRDEV
 32

	)

11 
	#MAX_BLKDEV
 32

	)

50 
	#UNNAMED_MAJOR
 0

	)

51 
	#MEM_MAJOR
 1

	)

52 
	#FLOPPY_MAJOR
 2

	)

53 
	#HD_MAJOR
 3

	)

54 
	#TTY_MAJOR
 4

	)

55 
	#TTYAUX_MAJOR
 5

	)

56 
	#LP_MAJOR
 6

	)

58 
	#SCSI_DISK_MAJOR
 8

	)

59 
	#SCSI_TAPE_MAJOR
 9

	)

60 
	#MOUSE_MAJOR
 10

	)

61 
	#SCSI_CDROM_MAJOR
 11

	)

62 
	#QIC02_TAPE_MAJOR
 12

	)

63 
	#XT_DISK_MAJOR
 13

	)

64 
	#SOUND_MAJOR
 14

	)

65 
	#CDU31A_CDROM_MAJOR
 15

	)

66 
	#SOCKET_MAJOR
 16

	)

67 
	#AF_UNIX_MAJOR
 17

	)

68 
	#AF_INET_MAJOR
 18

	)

70 
	#SCSI_GENERIC_MAJOR
 21

	)

72 
	#MITSUMI_CDROM_MAJOR
 23

	)

73 
	#CDU535_CDROM_MAJOR
 24

	)

74 
	#MATSUSHITA_CDROM_MAJOR
 25

	)

75 
	#QIC117_TAPE_MAJOR
 27

	)

81 
	#SCSI_MAJOR
(
M
) \

82 ((
M
è=ğ
SCSI_DISK_MAJOR
 \

83 || (
M
è=ğ
SCSI_TAPE_MAJOR
 \

84 || (
M
è=ğ
SCSI_CDROM_MAJOR
 \

85 || (
M
è=ğ
SCSI_GENERIC_MAJOR
)

	)

87 
šlše
 
	$scsi_majÜ
(
m
) {

88  
	`SCSI_MAJOR
(
m
);

89 
	}
}

	@include/linux/malloc.h

1 #iâdeà
_LINUX_MALLOC_H


2 
	#_LINUX_MALLOC_H


	)

4 
	~<lšux/cÚfig.h
>

6 #ifdeà
CONFIG_DEBUG_MALLOC


7 
	#km®loc
(
a
,
b
è
	`deb_km®loc
(
__FILE__
,
__LINE__
,a,b)

	)

8 
	#kä“_s
(
a
,
b
è
	`deb_kä“_s
(
__FILE__
,
__LINE__
,a,b)

	)

10 *
deb_km®loc
(cÚ¡ *
deb_fe
, 
deb_lše
,
size
, 
´iÜ™y
);

11 
deb_kä“_s
 (cÚ¡ *
deb_fe
, 
deb_lše
,* 
obj
, 
size
);

12 
deb_kcheck_s
(cÚ¡ *
deb_fe
, 
deb_lše
,* 
obj
, 
size
);

14 
	#kä“
(
a
è
	`deb_kä“_s
(
__FILE__
,
__LINE__
,‡,0)

	)

15 
	#kcheck
(
a
è
	`deb_kcheck_s
(
__FILE__
,
__LINE__
,‡,0)

	)

16 
	#kcheck_s
(
a
,
b
è
	`deb_kcheck_s
(
__FILE__
,
__LINE__
,‡,b)

	)

20 * 
km®loc
(
size
, 
´iÜ™y
);

21 
kä“_s
(* 
obj
, 
size
);

23 
	#kcheck_s
(
a
,
b
è0

	)

25 
	#kä“
(
x
è
	`kä“_s
((x), 0)

	)

26 
	#kcheck
(
x
è
	`kcheck_s
((x), 0)

	)

	@include/linux/math_emu.h

1 #iâdeà
_LINUX_MATH_EMU_H


2 
	#_LINUX_MATH_EMU_H


	)

4 
	såu_»g
 {

5 
	msign
;

6 
	mg
;

7 
	mexp
;

8 
	msigl
;

9 
	msigh
;

17 
	sšfo
 {

18 
	m___Üig_e
;

19 
	m___»t_äom_sy¡em_ÿÎ
;

20 
	m___ebx
;

21 
	m___ecx
;

22 
	m___edx
;

23 
	m___esi
;

24 
	m___edi
;

25 
	m___ebp
;

26 
	m___—x
;

27 
	m___ds
;

28 
	m___es
;

29 
	m___fs
;

30 
	m___gs
;

31 
	m___Üig_—x
;

32 
	m___e
;

33 
	m___cs
;

34 
	m___eæags
;

35 
	m___e¥
;

36 
	m___ss
;

37 
	m___vm86_es
;

38 
	m___vm86_ds
;

39 
	m___vm86_fs
;

40 
	m___vm86_gs
;

	@include/linux/mc146818rtc.h

11 #iâdeà
_MC146818RTC_H


12 
	#_MC146818RTC_H


	)

13 
	~<asm/io.h
>

15 
	#CMOS_READ
(
addr
) ({ \

16 
	`outb_p
(
addr
|0x80,0x70); \

17 
	`šb_p
(0x71); \

18 })

	)

19 
	#CMOS_WRITE
(
v®
, 
addr
) ({ \

20 
	`outb_p
(
addr
|0x80,0x70); \

21 
	`outb_p
(
v®
,0x71); \

22 })

	)

27 
	#RTC_SECONDS
 0

	)

28 
	#RTC_SECONDS_ALARM
 1

	)

29 
	#RTC_MINUTES
 2

	)

30 
	#RTC_MINUTES_ALARM
 3

	)

31 
	#RTC_HOURS
 4

	)

32 
	#RTC_HOURS_ALARM
 5

	)

34 
	#RTC_ALARM_DONT_CARE
 0xC0

	)

36 
	#RTC_DAY_OF_WEEK
 6

	)

37 
	#RTC_DAY_OF_MONTH
 7

	)

38 
	#RTC_MONTH
 8

	)

39 
	#RTC_YEAR
 9

	)

43 
	#RTC_REG_A
 10

	)

44 
	#RTC_REG_B
 11

	)

45 
	#RTC_REG_C
 12

	)

46 
	#RTC_REG_D
 13

	)

51 
	#RTC_FREQ_SELECT
 
RTC_REG_A


	)

57 
	#RTC_UIP
 0x80

	)

58 
	#RTC_DIV_CTL
 0x70

	)

60 
	#RTC_REF_CLCK_4MHZ
 0x00

	)

61 
	#RTC_REF_CLCK_1MHZ
 0x10

	)

62 
	#RTC_REF_CLCK_32KHZ
 0x20

	)

64 
	#RTC_DIV_RESET1
 0x60

	)

65 
	#RTC_DIV_RESET2
 0x70

	)

67 
	#RTC_RATE_SELECT
 0x0F

	)

70 
	#RTC_CONTROL
 
RTC_REG_B


	)

71 
	#RTC_SET
 0x80

	)

72 
	#RTC_PIE
 0x40

	)

73 
	#RTC_AIE
 0x20

	)

74 
	#RTC_UIE
 0x10

	)

75 
	#RTC_SQWE
 0x08

	)

76 
	#RTC_DM_BINARY
 0x04

	)

77 
	#RTC_24H
 0x02

	)

78 
	#RTC_DST_EN
 0x01

	)

81 
	#RTC_INTR_FLAGS
 
RTC_REG_C


	)

83 
	#RTC_IRQF
 0x80

	)

84 
	#RTC_PF
 0x40

	)

85 
	#RTC_AF
 0x20

	)

86 
	#RTC_UF
 0x10

	)

89 
	#RTC_VALID
 
RTC_REG_D


	)

90 
	#RTC_VRT
 0x80

	)

96 #iâdeà
BCD_TO_BIN


97 
	#BCD_TO_BIN
(
v®
è((v®)=((v®)&15è+ ((v®)>>4)*10)

	)

100 #iâdeà
BIN_TO_BCD


101 
	#BIN_TO_BCD
(
v®
è((v®)=(((v®)/10)<<4è+ (v®)%10)

	)

	@include/linux/mcd.h

25 
	#MCD_BASE_ADDR
 0x300

	)

28 
	#MCD_INTR_NR
 11

	)

31 
	#MCD_STATUS_DELAY
 100

	)

34 
	#MCD_RETRY_ATTEMPTS
 3

	)

37 
	#MCDPORT
(
x
è(
mcd_pÜt
 + (x))

	)

41 
	#MST_CMD_CHECK
 0x01

	)

42 
	#MST_BUSY
 0x02

	)

43 
	#MST_READ_ERR
 0x04

	)

44 
	#MST_DSK_TYPE
 0x08

	)

45 
	#MST_SERVO_CHECK
 0x10

	)

46 
	#MST_DSK_CHG
 0x20

	)

47 
	#MST_READY
 0x40

	)

48 
	#MST_DOOR_OPEN
 0x80

	)

52 
	#MFL_DATA
 0x02

	)

53 
	#MFL_STATUS
 0x04

	)

57 
	#MCMD_GET_DISK_INFO
 0x10

	)

58 
	#MCMD_GET_Q_CHANNEL
 0x20

	)

59 
	#MCMD_GET_STATUS
 0x40

	)

60 
	#MCMD_SET_MODE
 0x50

	)

61 
	#MCMD_SOFT_RESET
 0x60

	)

62 
	#MCMD_STOP
 0x70

	)

63 
	#MCMD_CONFIG_DRIVE
 0x90

	)

64 
	#MCMD_SET_VOLUME
 0xAE

	)

65 
	#MCMD_PLAY_READ
 0xC0

	)

66 
	#MCMD_GET_VERSION
 0xDC

	)

70 
	#READ_DATA
(
pÜt
, 
buf
, 
Ä
) \

71 
	`šsb
(
pÜt
, 
buf
, 
Ä
)

	)

73 
	#SET_TIMER
(
func
, 
jifs
) \

74 ((
tim”_bË
[
MCD_TIMER
].
expœes
 = 
jiff›s
 + 
jifs
), \

75 (
tim”_bË
[
MCD_TIMER
].
â
 = 
func
), \

76 (
tim”_aùive
 |ğ1<<
MCD_TIMER
))

	)

78 
	#CLEAR_TIMER
 
tim”_aùive
 &ğ~(1<<
MCD_TIMER
)

	)

80 
	#MAX_TRACKS
 104

	)

82 
	smsf
 {

83 
	mmš
;

84 
	m£c
;

85 
	mäame
;

88 
	smcd_PÏy_msf
 {

89 
msf
 
	m¡¬t
;

90 
msf
 
	m’d
;

93 
	smcd_DiskInfo
 {

94 
	mfœ¡
;

95 
	mÏ¡
;

96 
msf
 
	mdiskL’gth
;

97 
msf
 
	mfœ¡T¿ck
;

100 
	smcd_Toc
 {

101 
	mù¾_addr
;

102 
	mŒack
;

103 
	mpoštIndex
;

104 
msf
 
	mŒackTime
;

105 
msf
 
	mdiskTime
;

	@include/linux/minix_fs.h

1 #iâdeà
_LINUX_MINIX_FS_H


2 
	#_LINUX_MINIX_FS_H


	)

15 
	#MINIX_ROOT_INO
 1

	)

18 
	#MINIX_LINK_MAX
 250

	)

20 
	#MINIX_I_MAP_SLOTS
 8

	)

21 
	#MINIX_Z_MAP_SLOTS
 8

	)

22 
	#MINIX_SUPER_MAGIC
 0x137F

	)

23 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

24 
	#NEW_MINIX_SUPER_MAGIC
 0x2468

	)

25 
	#MINIX_VALID_FS
 0x0001

	)

26 
	#MINIX_ERROR_FS
 0x0002

	)

28 
	#MINIX_INODES_PER_BLOCK
 ((
BLOCK_SIZE
)/( (
mšix_šode
)))

	)

30 
	smšix_šode
 {

31 
	mi_mode
;

32 
	mi_uid
;

33 
	mi_size
;

34 
	mi_time
;

35 
	mi_gid
;

36 
	mi_Æšks
;

37 
	mi_zÚe
[9];

46 
	sÃw_mšix_šode
 {

47 
	mi_mode
;

48 
	mi_Æšks
;

49 
	mi_uid
;

50 
	mi_gid
;

51 
	mi_size
;

52 
	mi_©ime
;

53 
	mi_mtime
;

54 
	mi_ùime
;

55 
	mi_zÚe
[10];

61 
	smšix_su³r_block
 {

62 
	ms_nšodes
;

63 
	ms_nzÚes
;

64 
	ms_im­_blocks
;

65 
	ms_zm­_blocks
;

66 
	ms_fœ¡d©azÚe
;

67 
	ms_log_zÚe_size
;

68 
	ms_max_size
;

69 
	ms_magic
;

70 
	ms_¡©e
;

73 
	smšix_dœ_’Œy
 {

74 
	mšode
;

75 
	mÇme
[0];

78 
mšix_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

79 
šode
 ** 
»suÉ
);

80 
mšix_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

81 
šode
 ** 
»suÉ
);

82 
mšix_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
);

83 
mšix_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

84 
mšix_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

85 
mšix_symlšk
(
šode
 * inode, cÚ¡ * 
Çme
, 
Ën
,

86 cÚ¡ * 
symÇme
);

87 
mšix_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

88 
mšix_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
);

89 
mšix_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

90 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
);

91 
šode
 * 
mšix_Ãw_šode
(cÚ¡ šod* 
dœ
);

92 
mšix_ä“_šode
(
šode
 * inode);

93 
mšix_couÁ_ä“_šodes
(
su³r_block
 *
sb
);

94 
mšix_Ãw_block
(
su³r_block
 * 
sb
);

95 
mšix_ä“_block
(
su³r_block
 * 
sb
, 
block
);

96 
mšix_couÁ_ä“_blocks
(
su³r_block
 *
sb
);

98 
mšix_bm­
(
šode
 *,);

100 
bufãr_h—d
 * 
mšix_g‘blk
(
šode
 *, , );

101 
bufãr_h—d
 * 
mšix_b»ad
(
šode
 *, , );

103 
mšix_Œunÿ‹
(
šode
 *);

104 
mšix_put_su³r
(
su³r_block
 *);

105 
su³r_block
 *
mšix_»ad_su³r
(super_block *,*,);

106 
mšix_wr™e_su³r
(
su³r_block
 *);

107 
mšix_»mouÁ
 (
su³r_block
 * 
sb
, * 
æags
, * 
d©a
);

108 
mšix_»ad_šode
(
šode
 *);

109 
mšix_wr™e_šode
(
šode
 *);

110 
mšix_put_šode
(
šode
 *);

111 
mšix_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

112 
mšix_sync_šode
(
šode
 *);

113 
mšix_sync_fe
(
šode
 *, 
fe
 *);

115 
šode_İ”©iÚs
 
mšix_fe_šode_İ”©iÚs
;

116 
šode_İ”©iÚs
 
mšix_dœ_šode_İ”©iÚs
;

117 
šode_İ”©iÚs
 
mšix_symlšk_šode_İ”©iÚs
;

	@include/linux/minix_fs_i.h

1 #iâdeà
_MINIX_FS_I


2 
	#_MINIX_FS_I


	)

7 
	smšix_šode_šfo
 {

8 
	mi_d©a
[16];

	@include/linux/minix_fs_sb.h

1 #iâdeà
_MINIX_FS_SB


2 
	#_MINIX_FS_SB


	)

7 
	smšix_sb_šfo
 {

8 
	ms_nšodes
;

9 
	ms_nzÚes
;

10 
	ms_im­_blocks
;

11 
	ms_zm­_blocks
;

12 
	ms_fœ¡d©azÚe
;

13 
	ms_log_zÚe_size
;

14 
	ms_max_size
;

15 
bufãr_h—d
 * 
	ms_im­
[8];

16 
bufãr_h—d
 * 
	ms_zm­
[8];

17 
	ms_dœsize
;

18 
	ms_Çm–’
;

19 
bufãr_h—d
 * 
	ms_sbh
;

20 
mšix_su³r_block
 * 
	ms_ms
;

21 
	ms_mouÁ_¡©e
;

	@include/linux/mktime.h

1 #iâdeà
_LINUX_MKTIME_H


2 
	#_LINUX_MKTIME_H


	)

4 
	smktime
 {

5 
	m£c
;

6 
	mmš
;

7 
	mhour
;

8 
	mday
;

9 
	mmÚ
;

10 
	my—r
;

	@include/linux/mm.h

1 #iâdeà
_LINUX_MM_H


2 
	#_LINUX_MM_H


	)

4 
	~<lšux/·ge.h
>

5 
	~<lšux/sched.h
>

6 
	~<lšux/”ºo.h
>

7 
	~<lšux/k”Ãl.h
>

9 
	#VERIFY_READ
 0

	)

10 
	#VERIFY_WRITE
 1

	)

12 
__v”ify_wr™e
(
addr
, 
couÁ
);

14 
šlše
 
	$v”ify_¬—
(
ty³
, cÚ¡ * 
addr
, 
size
)

16 ià(
TASK_SIZE
 <ğ(è
addr
)

17  -
EFAULT
;

18 ià(
size
 > 
TASK_SIZE
 - (è
addr
)

19  -
EFAULT
;

20 ià(
wp_wÜks_ok
 || 
ty³
 =ğ
VERIFY_READ
 || !
size
)

22  
	`__v”ify_wr™e
((è
addr
,
size
);

23 
	}
}

40 
	svm_¬—_¡ruù
 {

41 
sk_¡ruù
 * 
vm_sk
;

42 
vm_¡¬t
;

43 
vm_’d
;

44 
vm_·ge_´Ù
;

45 
vm_¬—_¡ruù
 * 
vm_Ãxt
;

46 
vm_¬—_¡ruù
 * 
vm_sh¬e
;

47 
šode
 * 
vm_šode
;

48 
vm_off£t
;

49 
vm_İ”©iÚs_¡ruù
 * 
vm_İs
;

58 
	svm_İ”©iÚs_¡ruù
 {

59 (*
	mİ’
)(
vm_¬—_¡ruù
 * 
	m¬—
);

60 (*
	mşo£
)(
vm_¬—_¡ruù
 * 
	m¬—
);

61 (*
	mnİage
)(
	m”rÜ_code
,

62 
vm_¬—_¡ruù
 * 
	m¬—
, 
	madd»ss
);

63 (*
	mwµage
)(
vm_¬—_¡ruù
 * 
	m¬—
, 
	madd»ss
);

64 (*
	msh¬e
)(
vm_¬—_¡ruù
 * 
	mäom
, vm_¬—_¡ruù * 
	mto
, 
	madd»ss
);

65 (*
	munm­
)(
vm_¬—_¡ruù
 *
	m¬—
, , 
	msize_t
);

68 
__bad_·ge
();

69 
__bad_·g‘abË
();

70 
__z”o_·ge
();

72 
	#BAD_PAGETABLE
 
	`__bad_·g‘abË
()

	)

73 
	#BAD_PAGE
 
	`__bad_·ge
()

	)

74 
	#ZERO_PAGE
 
	`__z”o_·ge
()

	)

76 vŞ©
ä“_·ge_±r
;

78 
Ä_sw­_·ges
;

79 
Ä_ä“_·ges
;

80 
ä“_·ge_li¡
;

81 
Ä_£cÚd¬y_·ges
;

82 
£cÚd¬y_·ge_li¡
;

84 
	#MAX_SECONDARY_PAGES
 20

	)

91 
__g‘_ä“_·ge
(
´iÜ™y
);

92 
šlše
 
	$g‘_ä“_·ge
(
´iÜ™y
)

94 
·ge
;

96 
·ge
 = 
	`__g‘_ä“_·ge
(
´iÜ™y
);

97 ià(
·ge
)

98 
__asm__
 
	`__vŞ©e__
("rep ; stosl"

100 :"a" (0),"c" (1024),"D" (
·ge
)

102  
·ge
;

103 
	}
}

107 
ä“_·ge
(
addr
);

108 
put_dœty_·ge
(
sk_¡ruù
 * 
tsk
,
·ge
,

109 
add»ss
);

110 
ä“_·ge_bËs
(
sk_¡ruù
 * 
tsk
);

111 
ş—r_·ge_bËs
(
sk_¡ruù
 * 
tsk
);

112 
cİy_·ge_bËs
(
sk_¡ruù
 * 
to
);

113 
şÚe_·ge_bËs
(
sk_¡ruù
 * 
to
);

114 
unm­_·ge_¿nge
(
äom
, 
size
);

115 
»m­_·ge_¿nge
(
äom
, 
to
, 
size
, 
mask
);

116 
z”om­_·ge_¿nge
(
äom
, 
size
, 
mask
);

118 
do_wp_·ge
(
”rÜ_code
, 
add»ss
,

119 
sk_¡ruù
 *
tsk
, 
u£r_e¥
);

120 
do_no_·ge
(
”rÜ_code
, 
add»ss
,

121 
sk_¡ruù
 *
tsk
, 
u£r_e¥
);

123 
·gšg_š™
(
¡¬t_mem
, 
’d_mem
);

124 
mem_š™
(
low_¡¬t_mem
,

125 
¡¬t_mem
, 
’d_mem
);

126 
show_mem
();

127 
oom
(
sk_¡ruù
 * 
sk
);

128 
si_memšfo
(
sysšfo
 * 
v®
);

132 * 
vm®loc
(
size
);

133 
vä“
(* 
addr
);

134 
v»ad
(*
buf
, *
addr
, 
couÁ
);

138 
sw­_ä“
(
·ge_Ä
);

139 
sw­_du¶iÿ‹
(
·ge_Ä
);

140 
sw­_š
(*
bË_±r
);

141 
si_sw­šfo
(
sysšfo
 * 
v®
);

142 
rw_sw­_·ge
(
rw
, 
Ä
, * 
buf
);

145 
do_mm­
(
fe
 * fe, 
addr
, 
Ën
,

146 
´Ù
, 
æags
, 
off
);

147 (*
	tm­_m”g•_âp
)(cÚ¡ 
	tvm_¬—_¡ruù
 *,

148 cÚ¡ 
	tvm_¬—_¡ruù
 *, *);

149 
	`m”ge_£gm’ts
(
vm_¬—_¡ruù
 *, 
m­_m”g•_âp
, *);

150 
	`š£¹_vm_¡ruù
(
sk_¡ruù
 *, 
vm_¬—_¡ruù
 *);

151 
	`ignoff_m”g•
(cÚ¡ 
vm_¬—_¡ruù
 *,

152 cÚ¡ 
vm_¬—_¡ruù
 *, *);

153 
	`do_munm­
(, 
size_t
);

155 
	#»ad_sw­_·ge
(
Ä
,
buf
) \

156 
	`rw_sw­_·ge
(
READ
,(
Ä
),(
buf
))

	)

157 
	#wr™e_sw­_·ge
(
Ä
,
buf
) \

158 
	`rw_sw­_·ge
(
WRITE
,(
Ä
),(
buf
))

	)

160 
	#šv®id©e
() \

161 
__asm__
 
	`__vŞ©e__
("movÈ%%ü3,%%—x\n\tmovÈ%%—x,%%ü3": : :"ax")

	)

163 
high_memÜy
;

165 
	#MAP_NR
(
addr
è(×ddrè>> 
PAGE_SHIFT
)

	)

166 
	#MAP_PAGE_RESERVED
 (1<<15)

	)

168 * 
mem_m­
;

170 
	#PAGE_PRESENT
 0x001

	)

171 
	#PAGE_RW
 0x002

	)

172 
	#PAGE_USER
 0x004

	)

173 
	#PAGE_PWT
 0x008

	)

174 
	#PAGE_PCD
 0x010

	)

175 
	#PAGE_ACCESSED
 0x020

	)

176 
	#PAGE_DIRTY
 0x040

	)

177 
	#PAGE_COW
 0x200

	)

179 
	#PAGE_PRIVATE
 (
PAGE_PRESENT
 | 
PAGE_RW
 | 
PAGE_USER
 | 
PAGE_ACCESSED
 | 
PAGE_COW
)

	)

180 
	#PAGE_SHARED
 (
PAGE_PRESENT
 | 
PAGE_RW
 | 
PAGE_USER
 | 
PAGE_ACCESSED
)

	)

181 
	#PAGE_COPY
 (
PAGE_PRESENT
 | 
PAGE_USER
 | 
PAGE_ACCESSED
 | 
PAGE_COW
)

	)

182 
	#PAGE_READONLY
 (
PAGE_PRESENT
 | 
PAGE_USER
 | 
PAGE_ACCESSED
)

	)

183 
	#PAGE_TABLE
 (
PAGE_PRESENT
 | 
PAGE_RW
 | 
PAGE_USER
 | 
PAGE_ACCESSED
)

	)

185 
	#GFP_BUFFER
 0x00

	)

186 
	#GFP_ATOMIC
 0x01

	)

187 
	#GFP_USER
 0x02

	)

188 
	#GFP_KERNEL
 0x03

	)

192 
	#SHM_SWP_TYPE
 0x41

	)

193 
	`shm_no_·ge
 (
ulÚg
 *);

	@include/linux/mman.h

1 #iâdeà
_LINUX_MMAN_H


2 
	#_LINUX_MMAN_H


	)

4 
	#PROT_READ
 0x1

	)

5 
	#PROT_WRITE
 0x2

	)

6 
	#PROT_EXEC
 0x4

	)

7 
	#PROT_NONE
 0x0

	)

9 
	#MAP_SHARED
 1

	)

10 
	#MAP_PRIVATE
 2

	)

11 
	#MAP_TYPE
 0xà

	)

12 
	#MAP_FIXED
 0x10

	)

13 
	#MAP_ANONYMOUS
 0x20

	)

	@include/linux/module.h

5 #iâdeà
_LINUX_MODULE_H


6 
	#_LINUX_MODULE_H


	)

9 
	#MOD_UNINITIALIZED
 0

	)

10 
	#MOD_RUNNING
 1

	)

11 
	#MOD_DELETED
 2

	)

14 
	#MOD_MAX_NAME
 64

	)

17 
	#SYM_MAX_NAME
 60

	)

20 
	smoduË
 {

21 
moduË
 *
	mÃxt
;

22 *
	mÇme
;

23 
	msize
;

24 * 
	maddr
;

25 
	m¡©e
;

26 (*
	mş—nup
)();

30 
	smod_routšes
 {

31 (*
	mš™
)();

32 (*
	mş—nup
)();

36 
	sk”Ãl_sym
 {

37 
	mv®ue
;

38 
	mÇme
[
SYM_MAX_NAME
];

41 
moduË
 *
moduË_li¡
;

47 
	#GET_USE_COUNT
(
moduË
è(* (*è(moduË)->
addr
)

	)

52 
mod_u£_couÁ_
;

54 
	#MOD_INC_USE_COUNT
 
mod_u£_couÁ_
++

	)

55 
	#MOD_DEC_USE_COUNT
 
mod_u£_couÁ_
--

	)

56 
	#MOD_IN_USE
 (
mod_u£_couÁ_
 !ğ0)

	)

	@include/linux/mouse.h

1 #iâdeà
_LINUX_MOUSE_H


2 
	#_LINUX_MOUSE_H


	)

4 
	#BUSMOUSE_MINOR
 0

	)

5 
	#PSMOUSE_MINOR
 1

	)

6 
	#MS_BUSMOUSE_MINOR
 2

	)

7 
	#ATIXL_BUSMOUSE_MINOR
 3

	)

9 
mou£_š™
();

	@include/linux/msdos_fs.h

1 #iâdeà
_LINUX_MSDOS_FS_H


2 
	#_LINUX_MSDOS_FS_H


	)

8 
	~<lšux/fs.h
>

9 
	~<lšux/¡©.h
>

10 
	~<lšux/fd.h
>

12 
	#MSDOS_ROOT_INO
 1

	)

13 
	#SECTOR_SIZE
 512

	)

14 
	#SECTOR_BITS
 9

	)

15 
	#MSDOS_DPB
 (
MSDOS_DPS
*2è

	)

16 
	#MSDOS_DPB_BITS
 5

	)

17 
	#MSDOS_DPS
 (
SECTOR_SIZE
/(
msdos_dœ_’Œy
))

	)

18 
	#MSDOS_DPS_BITS
 4

	)

19 
	#MSDOS_DIR_BITS
 5

	)

21 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

23 
	#FAT_CACHE
 8

	)

25 
	#ATTR_RO
 1

	)

26 
	#ATTR_HIDDEN
 2

	)

27 
	#ATTR_SYS
 4

	)

28 
	#ATTR_VOLUME
 8

	)

29 
	#ATTR_DIR
 16

	)

30 
	#ATTR_ARCH
 32

	)

32 
	#ATTR_NONE
 0

	)

33 
	#ATTR_UNUSED
 (
ATTR_VOLUME
 | 
ATTR_ARCH
 | 
ATTR_SYS
 | 
ATTR_HIDDEN
)

	)

36 
	#DELETED_FLAG
 0xe5

	)

37 
	#IS_FREE
(
n
è(!*Òè|| *(*èÒè=ğ
DELETED_FLAG
 || \

38 *(*è(
n
è=ğ
FD_FILL_BYTE
)

	)

40 
	#MSDOS_VALID_MODE
 (
S_IFREG
 | 
S_IFDIR
 | 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
)

	)

43 
	#MSDOS_SB
(
s
è(&((s)->
u
.
msdos_sb
))

	)

44 
	#MSDOS_I
(
i
è(&((i)->
u
.
msdos_i
))

	)

46 
	#MSDOS_NAME
 11

	)

47 
	#MSDOS_DOT
 ". "

	)

48 
	#MSDOS_DOTDOT
 ".. "

	)

50 
	#MSDOS_FAT12
 4078

	)

59 
	#CF_LE_W
(
v
è(v)

	)

60 
	#CF_LE_L
(
v
è(v)

	)

61 
	#CT_LE_W
(
v
è(v)

	)

62 
	#CT_LE_L
(
v
è(v)

	)

65 
	smsdos_boÙ_£ùÜ
 {

66 
	mignÜed
[3];

67 
	msy¡em_id
[8];

69 
	m£ùÜ_size
[2];

70 
	mşu¡”_size
;

71 
	m»£rved
;

72 
	mçts
;

73 
	mdœ_’Œ›s
[2];

74 
	m£ùÜs
[2];

75 
	mmedŸ
;

76 
	mçt_Ëngth
;

77 
	m£cs_Œack
;

78 
	mh—ds
;

79 
	mhidd’
;

80 
	mtÙ®_£ù
;

83 
	smsdos_dœ_’Œy
 {

84 
	mÇme
[8],
	mext
[3];

85 
	m©Œ
;

86 
	munu£d
[10];

87 
	mtime
,
	md©e
,
	m¡¬t
;

88 
	msize
;

91 
	sçt_ÿche
 {

92 
	mdeviû
;

93 
	mšo
;

94 
	mfe_şu¡”
;

95 
	mdisk_şu¡”
;

96 
çt_ÿche
 *
	mÃxt
;

101 
	#MSDOS_CAN_BMAP
(
mib
è(!(((mib)->
şu¡”_size
 & 1) || \

102 ((
mib
)->
d©a_¡¬t
 & 1)))

	)

106 
	#MSDOS_MKMODE
(
a
,
m
è(m & (¨& 
ATTR_RO
 ? 
S_IRUGO
|
S_IXUGO
 : 
S_IRWXUGO
))

	)

110 
	#MSDOS_MKATTR
(
m
è((m & 
S_IWUGO
è? 
ATTR_NONE
 : 
ATTR_RO
)

	)

113 
šlše
 
bufãr_h—d
 *
	$msdos_¤—d
(
dev
,
£ùÜ
,**
¡¬t
)

115 
bufãr_h—d
 *
bh
;

117 ià(!(
bh
 = 
	`b»ad
(
dev
,
£ùÜ
 >> 1, 1024)))

118  
NULL
;

119 *
¡¬t
 = 
bh
->
b_d©a
+((
£ùÜ
 & 1è<< 
SECTOR_BITS
);

120  
bh
;

121 
	}
}

126 
fs_·nic
(
su³r_block
 *
s
,*
msg
);

127 
is_bš¬y
(
cÚv”siÚ
,*
ex‹nsiÚ
);

128 
lock_ü—tiÚ
();

129 
uÆock_ü—tiÚ
();

130 
lock_çt
(
su³r_block
 *
sb
);

131 
uÆock_çt
(
su³r_block
 *
sb
);

132 
msdos_add_şu¡”
(
šode
 *inode);

133 
d©e_dos2unix
(
time
,
d©e
);

134 
d©e_unix2dos
(
unix_d©e
,*
time
,

135 *
d©e
);

136 
msdos_g‘_’Œy
(
šode
 *
dœ
,
off_t
 *
pos
,
bufãr_h—d
 **
bh
,

137 
msdos_dœ_’Œy
 **
de
);

138 
msdos_sÿn
(
šode
 *
dœ
,*
Çme
,
bufãr_h—d
 **
»s_bh
,

139 
msdos_dœ_’Œy
 **
»s_de
,*
šo
);

140 
msdos_·»Á_šo
(
šode
 *
dœ
,
locked
);

141 
msdos_subdœs
(
šode
 *
dœ
);

145 
çt_acûss
(
su³r_block
 *
sb
,
Ä
,
Ãw_v®ue
);

146 
msdos_sm­
(
šode
 *šode,
£ùÜ
);

147 
çt_ä“
(
šode
 *šode,
sk
);

148 
ÿche_š™
();

149 
ÿche_lookup
(
šode
 *šode,
şu¡”
,*
f_şu
,*
d_şu
);

150 
ÿche_add
(
šode
 *šode,
f_şu
,
d_şu
);

151 
ÿche_šv®_šode
(
šode
 *inode);

152 
ÿche_šv®_dev
(
deviû
);

153 
g‘_şu¡”
(
šode
 *šode,
şu¡”
);

157 
msdos_lookup
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,

158 
šode
 **
»suÉ
);

159 
msdos_ü—‹
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,
mode
,

160 
šode
 **
»suÉ
);

161 
msdos_mkdœ
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
,
mode
);

162 
msdos_rmdœ
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
);

163 
msdos_uÆšk
(
šode
 *
dœ
,cÚ¡ *
Çme
,
Ën
);

164 
msdos_»Çme
(
šode
 *
Şd_dœ
,cÚ¡ *
Şd_Çme
,
Şd_Ën
,

165 
šode
 *
Ãw_dœ
,cÚ¡ *
Ãw_Çme
,
Ãw_Ën
);

169 
msdos_put_šode
(
šode
 *inode);

170 
msdos_put_su³r
(
su³r_block
 *
sb
);

171 
su³r_block
 *
msdos_»ad_su³r
(su³r_block *
s
,

172 *
d©a
,);

173 
msdos_¡©fs
(
su³r_block
 *
sb
,
¡©fs
 *
buf
);

174 
msdos_bm­
(
šode
 *šode,
block
);

175 
msdos_»ad_šode
(
šode
 *inode);

176 
msdos_wr™e_šode
(
šode
 *inode);

177 
msdos_nÙify_chªge
(
æags
,
šode
 *inode);

181 
šode_İ”©iÚs
 
msdos_dœ_šode_İ”©iÚs
;

185 
šode_İ”©iÚs
 
msdos_fe_šode_İ”©iÚs
;

186 
šode_İ”©iÚs
 
msdos_fe_šode_İ”©iÚs_no_bm­
;

188 
msdos_Œunÿ‹
(
šode
 *inode);

	@include/linux/msdos_fs_i.h

1 #iâdeà
_MSDOS_FS_I


2 
	#_MSDOS_FS_I


	)

8 
	smsdos_šode_šfo
 {

9 
	mi_¡¬t
;

10 
	mi_©Œs
;

11 
	mi_busy
;

13 
šode
 *
	mi_d•’d
;

15 
šode
 *
	mi_Şd
;

17 
	mi_bš¬y
;

	@include/linux/msdos_fs_sb.h

1 #iâdeà
_MSDOS_FS_SB


2 
	#_MSDOS_FS_SB


	)

8 
	smsdos_sb_šfo
 {

9 
	mşu¡”_size
;

10 
	mçts
,
	mçt_b™s
;

11 
	mçt_¡¬t
,
	mçt_Ëngth
;

12 
	mdœ_¡¬t
,
	mdœ_’Œ›s
;

13 
	md©a_¡¬t
;

14 
	mşu¡”s
;

15 
uid_t
 
	mfs_uid
;

16 
gid_t
 
	mfs_gid
;

17 
	mqu›t
;

18 
	mfs_umask
;

19 
	mÇme_check
;

20 
	mcÚv”siÚ
;

21 
wa™_queue
 *
	mçt_wa™
;

22 
	mçt_lock
;

23 
	m´ev_ä“
;

24 
	mä“_şu¡”s
;

	@include/linux/msg.h

1 #iâdeà
_LINUX_MSG_H


2 
	#_LINUX_MSG_H


	)

3 
	~<lšux/c.h
>

6 
	#MSG_NOERROR
 010000

	)

7 
	#MSG_EXCEPT
 020000

	)

11 
	smsg
 {

12 
msg
 *
	mmsg_Ãxt
;

13 
	mmsg_ty³
;

14 *
	mmsg_¥Ù
;

15 
	mmsg_ts
;

19 
	smsqid_ds
 {

20 
c_³rm
 
	mmsg_³rm
;

21 
msg
 *
	mmsg_fœ¡
;

22 
msg
 *
	mmsg_Ï¡
;

23 
time_t
 
	mmsg_¡ime
;

24 
time_t
 
	mmsg_¹ime
;

25 
time_t
 
	mmsg_ùime
;

26 
wa™_queue
 *
	mwwa™
;

27 
wa™_queue
 *
	mrwa™
;

28 
ushÜt
 
	mmsg_cby‹s
;

29 
ushÜt
 
	mmsg_qnum
;

30 
ushÜt
 
	mmsg_qby‹s
;

31 
ushÜt
 
	mmsg_l¥id
;

32 
ushÜt
 
	mmsg_Ìpid
;

37 
	smsgbuf
 {

38 
	mmty³
;

39 
	mm‹xt
[1];

43 
	smsgšfo
 {

44 
	mmsgpoŞ
;

45 
	mmsgm­
;

46 
	mmsgmax
;

47 
	mmsgmnb
;

48 
	mmsgmni
;

49 
	mmsgssz
;

50 
	mmsgtql
;

51 
ushÜt
 
	mmsg£g
;

54 
	#MSGMNI
 128

	)

55 
	#MSGMAX
 4056

	)

56 
	#MSGMNB
 16384

	)

59 
	#MSGPOOL
 (
MSGMNI
*
MSGMNB
/1024è

	)

60 
	#MSGTQL
 
MSGMNB


	)

61 
	#MSGMAP
 
MSGMNB


	)

62 
	#MSGSSZ
 16

	)

63 
	#__MSGSEG
 ((
MSGPOOL
*1024)/ 
MSGSSZ
è

	)

64 
	#MSGSEG
 (
__MSGSEG
 <ğ0xfffà? __MSGSEG : 0xffff)

	)

66 #ifdeà
__KERNEL__


69 
	#MSG_STAT
 11

	)

70 
	#MSG_INFO
 12

	)

	@include/linux/mtio.h

6 #iâdeà
_LINUX_MTIO_H


7 
	#_LINUX_MTIO_H


	)

9 
	~<lšux/ioùl.h
>

16 
	smtİ
 {

17 
	mmt_İ
;

18 
	mmt_couÁ
;

22 
	#MTRESET
 0

	)

23 
	#MTFSF
 1

	)

26 
	#MTBSF
 2

	)

27 
	#MTFSR
 3

	)

28 
	#MTBSR
 4

	)

29 
	#MTWEOF
 5

	)

30 
	#MTREW
 6

	)

31 
	#MTOFFL
 7

	)

32 
	#MTNOP
 8

	)

33 
	#MTRETEN
 9

	)

34 
	#MTBSFM
 10

	)

35 
	#MTFSFM
 11

	)

36 
	#MTEOM
 12

	)

40 
	#MTERASE
 13

	)

42 
	#MTRAS1
 14

	)

43 
	#MTRAS2
 15

	)

44 
	#MTRAS3
 16

	)

47 
	#MTSETBLK
 20

	)

48 
	#MTSETDENSITY
 21

	)

49 
	#MTSEEK
 22

	)

50 
	#MTTELL
 23

	)

51 
	#MTSETDRVBUFFER
 24

	)

57 
	smtg‘
 {

58 
	mmt_ty³
;

59 
	mmt_»sid
;

65 
	mmt_d¤eg
;

66 
	mmt_g¡©
;

67 
	mmt_”»g
;

69 
daddr_t
 
	mmt_f’o
;

70 
daddr_t
 
	mmt_blkno
;

76 
	#MT_ISUNKNOWN
 0x01

	)

77 
	#MT_ISQIC02
 0x02

	)

78 
	#MT_ISWT5150
 0x03

	)

79 
	#MT_ISARCHIVE_5945L2
 0x04

	)

80 
	#MT_ISCMSJ500
 0x05

	)

81 
	#MT_ISTDC3610
 0x06

	)

82 
	#MT_ISARCHIVE_VP60I
 0x07

	)

83 
	#MT_ISARCHIVE_2150L
 0x08

	)

84 
	#MT_ISARCHIVE_2060L
 0x09

	)

85 
	#MT_ISQIC02_ALL_FEATURES
 0x0F

	)

86 
	#MT_ISWT5099EEN24
 0x11

	)

87 
	#MT_ISEVEREX_FT40A
 0x32

	)

88 
	#MT_ISDDS1
 0x51

	)

89 
	#MT_ISDDS2
 0x52

	)

90 
	#MT_ISSCSI1
 0x71

	)

92 
	smt_³_šfo
 {

93 
	mt_ty³
;

94 *
	mt_Çme
;

96 
	#MT_TAPE_INFO
 { \

97 {
MT_ISUNKNOWN
, "Unknownype ofape device"}, \

98 {
MT_ISQIC02
, "Generic QIC-02ape streamer"}, \

99 {
MT_ISWT5150
, "Wangtek 5150, QIC-150"}, \

100 {
MT_ISARCHIVE_5945L2
, "Archive 5945L-2"}, \

101 {
MT_ISCMSJ500
, "CMS Jumbo 500"}, \

102 {
MT_ISTDC3610
, "Tandberg TDC 3610, QIC-24"}, \

103 {
MT_ISARCHIVE_VP60I
, "Archive VP60i, QIC-02"}, \

104 {
MT_ISARCHIVE_2150L
, "Archive Viper 2150L"}, \

105 {
MT_ISARCHIVE_2060L
, "Archive Viper 2060L"}, \

106 {
MT_ISWT5099EEN24
, "Wangtek 5099-een24, 60MB"}, \

107 {
MT_ISEVEREX_FT40A
, "Everex FT40A, QIC-40"}, \

108 {
MT_ISSCSI1
, "Generic SCSI-1ape"}, \

109 {0, 
NULL
} \

110 }

	)

115 
	smos
 {

116 
	mmt_blkno
;

121 
	#MTIOCTOP
 
	`_IOW
('m', 1, 
mtİ
è

	)

122 
	#MTIOCGET
 
	`_IOR
('m', 2, 
mtg‘
è

	)

123 
	#MTIOCPOS
 
	`_IOR
('m', 3, 
mos
è

	)

132 
	#GMT_EOF
(
x
è((xè& 0x80000000)

	)

133 
	#GMT_BOT
(
x
è((xè& 0x40000000)

	)

134 
	#GMT_EOT
(
x
è((xè& 0x20000000)

	)

135 
	#GMT_SM
(
x
è((xè& 0x10000000è

	)

136 
	#GMT_EOD
(
x
è((xè& 0x08000000è

	)

137 
	#GMT_WR_PROT
(
x
è((xè& 0x04000000)

	)

139 
	#GMT_ONLINE
(
x
è((xè& 0x01000000)

	)

140 
	#GMT_D_6250
(
x
è((xè& 0x00800000)

	)

141 
	#GMT_D_1600
(
x
è((xè& 0x00400000)

	)

142 
	#GMT_D_800
(
x
è((xè& 0x00200000)

	)

145 
	#GMT_DR_OPEN
(
x
è((xè& 0x00040000è

	)

147 
	#GMT_IM_REP_EN
(
x
è((xè& 0x00010000è

	)

	@include/linux/net.h

18 #iâdeà
_LINUX_NET_H


19 
	#_LINUX_NET_H


	)

22 
	~<lšux/wa™.h
>

23 
	~<lšux/sock‘.h
>

26 
	#NSOCKETS
 128

	)

27 
	#NPROTO
 16

	)

30 
	#SYS_SOCKET
 1

	)

31 
	#SYS_BIND
 2

	)

32 
	#SYS_CONNECT
 3

	)

33 
	#SYS_LISTEN
 4

	)

34 
	#SYS_ACCEPT
 5

	)

35 
	#SYS_GETSOCKNAME
 6

	)

36 
	#SYS_GETPEERNAME
 7

	)

37 
	#SYS_SOCKETPAIR
 8

	)

38 
	#SYS_SEND
 9

	)

39 
	#SYS_RECV
 10

	)

40 
	#SYS_SENDTO
 11

	)

41 
	#SYS_RECVFROM
 12

	)

42 
	#SYS_SHUTDOWN
 13

	)

43 
	#SYS_SETSOCKOPT
 14

	)

44 
	#SYS_GETSOCKOPT
 15

	)

48 
	mSS_FREE
 = 0,

49 
	mSS_UNCONNECTED
,

50 
	mSS_CONNECTING
,

51 
	mSS_CONNECTED
,

52 
	mSS_DISCONNECTING


53 } 
	tsock‘_¡©e
;

55 
	#SO_ACCEPTCON
 (1<<16è

	)

69 
	ssock‘
 {

70 
	mty³
;

71 
sock‘_¡©e
 
	m¡©e
;

72 
	mæags
;

73 
´Ùo_İs
 *
	mİs
;

74 *
	md©a
;

75 
sock‘
 *
	mcÚn
;

76 
sock‘
 *
	micÚn
;

77 
sock‘
 *
	mÃxt
;

78 
wa™_queue
 **
	mwa™
;

79 
šode
 *
	mšode
;

82 
	#SOCK_INODE
(
S
è((S)->
šode
)

	)

84 
	s´Ùo_İs
 {

85 
	mçmy
;

87 (*
	mü—‹
è(
sock‘
 *
	msock
, 
	m´ÙocŞ
);

88 (*
	mdup
è(
sock‘
 *
	mÃwsock
, sock‘ *
	mŞdsock
);

89 (*
	m»Ëa£
è(
sock‘
 *
	msock
, sock‘ *
	m³”
);

90 (*
	mbšd
è(
sock‘
 *
	msock
, 
sockaddr
 *
	mumyaddr
,

91 
	msockaddr_Ën
);

92 (*
	mcÚÃù
è(
sock‘
 *
	msock
, 
sockaddr
 *
	mu£rvaddr
,

93 
	msockaddr_Ën
, 
	mæags
);

94 (*
	msock‘·œ
è(
sock‘
 *
	msock1
, sock‘ *
	msock2
);

95 (*
	macû±
è(
sock‘
 *
	msock
, sock‘ *
	mÃwsock
,

96 
	mæags
);

97 (*
	mg‘Çme
è(
sock‘
 *
	msock
, 
sockaddr
 *
	muaddr
,

98 *
	musockaddr_Ën
, 
	m³”
);

99 (*
	m»ad
è(
sock‘
 *
	msock
, *
	mubuf
, 
	msize
,

100 
	mnÚblock
);

101 (*
	mwr™e
è(
sock‘
 *
	msock
, *
	mubuf
, 
	msize
,

102 
	mnÚblock
);

103 (*
	m£Ëù
è(
sock‘
 *
	msock
, 
	m£l_ty³
,

104 
£Ëù_bË
 *
	mwa™
);

105 (*
	mioùl
è(
sock‘
 *
	msock
, 
	mcmd
,

106 
	m¬g
);

107 (*
	mli¡’
è(
sock‘
 *
	msock
, 
	mËn
);

108 (*
	m£nd
è(
sock‘
 *
	msock
, *
	mbuff
, 
	mËn
, 
	mnÚblock
,

109 
	mæags
);

110 (*
	m»cv
è(
sock‘
 *
	msock
, *
	mbuff
, 
	mËn
, 
	mnÚblock
,

111 
	mæags
);

112 (*
	m£ndto
è(
sock‘
 *
	msock
, *
	mbuff
, 
	mËn
, 
	mnÚblock
,

113 
	mæags
, 
	msockaddr
 *, 
	maddr_Ën
);

114 (*
	m»cväom
è(
sock‘
 *
	msock
, *
	mbuff
, 
	mËn
, 
	mnÚblock
,

115 
	mæags
, 
	msockaddr
 *, *
	maddr_Ën
);

116 (*
	mshutdown
è(
sock‘
 *
	msock
, 
	mæags
);

117 (*
	m£tsockİt
è(
sock‘
 *
	msock
, 
	mËv–
, 
	mİŠame
,

118 *
	mİtv®
, 
	mİ’
);

119 (*
	mg‘sockİt
è(
sock‘
 *
	msock
, 
	mËv–
, 
	mİŠame
,

120 *
	mİtv®
, *
	mİ’
);

121 (*
	mfú
è(
sock‘
 *
	msock
, 
	mcmd
,

122 
	m¬g
);

126 
sock_awa™cÚn
(
sock‘
 *
mysock
, sock‘ *
£rvsock
);

127 
sock_»gi¡”
(
çmy
, 
´Ùo_İs
 *
İs
);

	@include/linux/nfs.h

1 #iâdeà
_LINUX_NFS_H


2 
	#_LINUX_NFS_H


	)

4 
	#NFS_PORT
 2049

	)

5 
	#NFS_MAXDATA
 8192

	)

6 
	#NFS_MAXPATHLEN
 1024

	)

7 
	#NFS_MAXNAMLEN
 255

	)

8 
	#NFS_MAXGROUPS
 16

	)

9 
	#NFS_FHSIZE
 32

	)

10 
	#NFS_COOKIESIZE
 4

	)

11 
	#NFS_FIFO_DEV
 (-1)

	)

12 
	#NFSMODE_FMT
 0170000

	)

13 
	#NFSMODE_DIR
 0040000

	)

14 
	#NFSMODE_CHR
 0020000

	)

15 
	#NFSMODE_BLK
 0060000

	)

16 
	#NFSMODE_REG
 0100000

	)

17 
	#NFSMODE_LNK
 0120000

	)

18 
	#NFSMODE_SOCK
 0140000

	)

19 
	#NFSMODE_FIFO
 0010000

	)

21 #ifdeà
__KERNEL__


23 
	#RPC_VERSION
 2

	)

25 
	e½c_auth_æavÜ
 {

26 
	mRPC_AUTH_NULL
 = 0,

27 
	mRPC_AUTH_UNIX
 = 1,

28 
	mRPC_AUTH_SHORT
 = 2

31 
	e½c_msg_ty³
 {

32 
	mRPC_CALL
 = 0,

33 
	mRPC_REPLY
 = 1

36 
	e½c_»¶y_¡©
 {

37 
	mRPC_MSG_ACCEPTED
 = 0,

38 
	mRPC_MSG_DENIED
 = 1

41 
	e½c_acû±_¡©
 {

42 
	mRPC_SUCCESS
 = 0,

43 
	mRPC_PROG_UNAVAIL
 = 1,

44 
	mRPC_PROG_MISMATCH
 = 2,

45 
	mRPC_PROC_UNAVAIL
 = 3,

46 
	mRPC_GARBAGE_ARGS
 = 4

49 
	e½c_»jeù_¡©
 {

50 
	mRPC_MISMATCH
 = 0,

51 
	mRPC_AUTH_ERROR
 = 1

54 
	e½c_auth_¡©
 {

55 
	mRPC_AUTH_BADCRED
 = 1,

56 
	mRPC_AUTH_REJECTEDCRED
 = 2,

57 
	mRPC_AUTH_BADVERF
 = 3,

58 
	mRPC_AUTH_REJECTEDVERF
 = 4,

59 
	mRPC_AUTH_TOOWEAK
 = 5

64 
	enfs_¡©
 {

65 
	mNFS_OK
 = 0,

66 
	mNFSERR_PERM
 = 1,

67 
	mNFSERR_NOENT
 = 2,

68 
	mNFSERR_IO
 = 5,

69 
	mNFSERR_NXIO
 = 6,

70 
	mNFSERR_ACCES
 = 13,

71 
	mNFSERR_EXIST
 = 17,

72 
	mNFSERR_NODEV
 = 19,

73 
	mNFSERR_NOTDIR
 = 20,

74 
	mNFSERR_ISDIR
 = 21,

75 
	mNFSERR_INVAL
 = 22,

76 
	mNFSERR_FBIG
 = 27,

77 
	mNFSERR_NOSPC
 = 28,

78 
	mNFSERR_ROFS
 = 30,

79 
	mNFSERR_NAMETOOLONG
 = 63,

80 
	mNFSERR_NOTEMPTY
 = 66,

81 
	mNFSERR_DQUOT
 = 69,

82 
	mNFSERR_STALE
 = 70,

83 
	mNFSERR_WFLUSH
 = 99

86 
	enfs_áy³
 {

87 
	mNFNON
 = 0,

88 
	mNFREG
 = 1,

89 
	mNFDIR
 = 2,

90 
	mNFBLK
 = 3,

91 
	mNFCHR
 = 4,

92 
	mNFLNK
 = 5,

93 
	mNFSOCK
 = 6,

94 
	mNFBAD
 = 7,

95 
	mNFFIFO
 = 8

98 
	#NFS_PROGRAM
 100003

	)

99 
	#NFS_VERSION
 2

	)

100 
	#NFSPROC_NULL
 0

	)

101 
	#NFSPROC_GETATTR
 1

	)

102 
	#NFSPROC_SETATTR
 2

	)

103 
	#NFSPROC_ROOT
 3

	)

104 
	#NFSPROC_LOOKUP
 4

	)

105 
	#NFSPROC_READLINK
 5

	)

106 
	#NFSPROC_READ
 6

	)

107 
	#NFSPROC_WRITECACHE
 7

	)

108 
	#NFSPROC_WRITE
 8

	)

109 
	#NFSPROC_CREATE
 9

	)

110 
	#NFSPROC_REMOVE
 10

	)

111 
	#NFSPROC_RENAME
 11

	)

112 
	#NFSPROC_LINK
 12

	)

113 
	#NFSPROC_SYMLINK
 13

	)

114 
	#NFSPROC_MKDIR
 14

	)

115 
	#NFSPROC_RMDIR
 15

	)

116 
	#NFSPROC_READDIR
 16

	)

117 
	#NFSPROC_STATFS
 17

	)

119 
	snfs_fh
 {

120 
	md©a
[
NFS_FHSIZE
];

123 
	snfs_time
 {

124 
u_št
 
	m£cÚds
;

125 
u_št
 
	mu£cÚds
;

128 
	snfs_ç‰r
 {

129 
nfs_áy³
 
	mty³
;

130 
u_št
 
	mmode
;

131 
u_št
 
	mÆšk
;

132 
u_št
 
	muid
;

133 
u_št
 
	mgid
;

134 
u_št
 
	msize
;

135 
u_št
 
	mblocksize
;

136 
u_št
 
	mrdev
;

137 
u_št
 
	mblocks
;

138 
u_št
 
	mfsid
;

139 
u_št
 
	mfeid
;

140 
nfs_time
 
	m©ime
;

141 
nfs_time
 
	mmtime
;

142 
nfs_time
 
	mùime
;

145 
	snfs_§‰r
 {

146 
u_št
 
	mmode
;

147 
u_št
 
	muid
;

148 
u_št
 
	mgid
;

149 
u_št
 
	msize
;

150 
nfs_time
 
	m©ime
;

151 
nfs_time
 
	mmtime
;

154 
	snfs_’Œy
 {

155 
u_št
 
	mfeid
;

156 *
	mÇme
;

157 
	mcook›
;

158 
	meof
;

161 
	snfs_fsšfo
 {

162 
u_št
 
	mtsize
;

163 
u_št
 
	mbsize
;

164 
u_št
 
	mblocks
;

165 
u_št
 
	mbä“
;

166 
u_št
 
	mbava
;

	@include/linux/nfs_fs.h

1 #iâdeà
_LINUX_NFS_FS_H


2 
	#_LINUX_NFS_FS_H


	)

12 
	~<lšux/nfs.h
>

14 
	~<lšux/š.h
>

15 
	~<lšux/nfs_mouÁ.h
>

23 
	#NFS_READDIR_CACHE_SIZE
 64

	)

33 
	#NFS_MAX_FILE_IO_BUFFER_SIZE
 (7*512)

	)

34 
	#NFS_DEF_FILE_IO_BUFFER_SIZE
 1024

	)

41 
	#NFS_MAX_RPC_TIMEOUT
 600

	)

49 
	#NFS_LOOKUP_CACHE_SIZE
 64

	)

51 
	#NFS_SUPER_MAGIC
 0x6969

	)

53 
	#NFS_SERVER
(
šode
è(&(šode)->
i_sb
->
u
.
nfs_sb
.
s_£rv”
)

	)

54 
	#NFS_FH
(
šode
è(&(šode)->
u
.
nfs_i
.
fhªdË
)

	)

58 
nfs_´oc_g‘©Œ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

59 
nfs_ç‰r
 *
ç‰r
);

60 
nfs_´oc_£‰r
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

61 
nfs_§‰r
 *
§‰r
, 
nfs_ç‰r
 *
ç‰r
);

62 
nfs_´oc_lookup
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

63 cÚ¡ *
Çme
, 
nfs_fh
 *
fhªdË
,

64 
nfs_ç‰r
 *
ç‰r
);

65 
nfs_´oc_»adlšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

66 *
»s
);

67 
nfs_´oc_»ad
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

68 
off£t
, 
couÁ
, *
d©a
,

69 
nfs_ç‰r
 *
ç‰r
);

70 
nfs_´oc_wr™e
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

71 
off£t
, 
couÁ
, *
d©a
,

72 
nfs_ç‰r
 *
ç‰r
);

73 
nfs_´oc_ü—‹
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

74 cÚ¡ *
Çme
, 
nfs_§‰r
 *
§‰r
,

75 
nfs_fh
 *
fhªdË
, 
nfs_ç‰r
 *
ç‰r
);

76 
nfs_´oc_»move
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

77 cÚ¡ *
Çme
);

78 
nfs_´oc_»Çme
(
nfs_£rv”
 *
£rv”
,

79 
nfs_fh
 *
Şd_dœ
, cÚ¡ *
Şd_Çme
,

80 
nfs_fh
 *
Ãw_dœ
, cÚ¡ *
Ãw_Çme
);

81 
nfs_´oc_lšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

82 
nfs_fh
 *
dœ
, cÚ¡ *
Çme
);

83 
nfs_´oc_symlšk
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

84 cÚ¡ *
Çme
, cÚ¡ *
·th
, 
nfs_§‰r
 *
§‰r
);

85 
nfs_´oc_mkdœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

86 cÚ¡ *
Çme
, 
nfs_§‰r
 *
§‰r
,

87 
nfs_fh
 *
fhªdË
, 
nfs_ç‰r
 *
ç‰r
);

88 
nfs_´oc_rmdœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
dœ
,

89 cÚ¡ *
Çme
);

90 
nfs_´oc_»addœ
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

91 
cook›
, 
couÁ
, 
nfs_’Œy
 *
’Œy
);

92 
nfs_´oc_¡©fs
(
nfs_£rv”
 *
£rv”
, 
nfs_fh
 *
fhªdË
,

93 
nfs_fsšfo
 *
»s
);

97 
nfs_½c_ÿÎ
(
nfs_£rv”
 *
£rv”
, *
¡¬t
, *
’d
);

101 
su³r_block
 *
nfs_»ad_su³r
(su³r_block *
sb
,

102 *
d©a
,);

103 
šode
 *
nfs_fhg‘
(
su³r_block
 *
sb
, 
nfs_fh
 *
fhªdË
,

104 
nfs_ç‰r
 *
ç‰r
);

105 
nfs_»äesh_šode
(
šode
 *šode, 
nfs_ç‰r
 *
ç‰r
);

109 
šode_İ”©iÚs
 
nfs_fe_šode_İ”©iÚs
;

113 
šode_İ”©iÚs
 
nfs_dœ_šode_İ”©iÚs
;

117 
šode_İ”©iÚs
 
nfs_symlšk_šode_İ”©iÚs
;

121 
nfs_mm­
(
šode
 * inode, 
fe
 * file,

122 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
);

	@include/linux/nfs_fs_i.h

1 #iâdeà
_NFS_FS_I


2 
	#_NFS_FS_I


	)

4 
	~<lšux/nfs.h
>

9 
	snfs_šode_šfo
 {

10 
nfs_fh
 
	mfhªdË
;

	@include/linux/nfs_fs_sb.h

1 #iâdeà
_NFS_FS_SB


2 
	#_NFS_FS_SB


	)

4 
	~<lšux/nfs.h
>

6 
	snfs_£rv”
 {

7 
fe
 *
	mfe
;

8 
	mlock
;

9 
wa™_queue
 *
	mwa™
;

10 
	mæags
;

11 
	mrsize
;

12 
	mwsize
;

13 
	mtimeo
;

14 
	m»Œªs
;

15 
	maüegmš
;

16 
	maüegmax
;

17 
	macdœmš
;

18 
	macdœmax
;

19 
	mho¡Çme
[256];

26 
	snfs_sb_šfo
 {

27 
nfs_£rv”
 
	ms_£rv”
;

28 
nfs_fh
 
	ms_roÙ
;

	@include/linux/nfs_mount.h

1 #iâdeà
_LINUX_NFS_MOUNT_H


2 
	#_LINUX_NFS_MOUNT_H


	)

20 
	#NFS_MOUNT_VERSION
 1

	)

22 
	snfs_mouÁ_d©a
 {

23 
	mv”siÚ
;

24 
	mfd
;

25 
nfs_fh
 
	mroÙ
;

26 
	mæags
;

27 
	mrsize
;

28 
	mwsize
;

29 
	mtimeo
;

30 
	m»Œªs
;

31 
	maüegmš
;

32 
	maüegmax
;

33 
	macdœmš
;

34 
	macdœmax
;

35 
sockaddr_š
 
	maddr
;

36 
	mho¡Çme
[256];

41 
	#NFS_MOUNT_SOFT
 0x0001

	)

42 
	#NFS_MOUNT_INTR
 0x0002

	)

43 
	#NFS_MOUNT_SECURE
 0x0004

	)

44 
	#NFS_MOUNT_POSIX
 0x0008

	)

45 
	#NFS_MOUNT_NOCTO
 0x0010

	)

46 
	#NFS_MOUNT_NOAC
 0x0020

	)

	@include/linux/page.h

1 #iâdeà
_LINUX_PAGE_H


2 
	#_LINUX_PAGE_H


	)

5 
	#PAGE_SHIFT
 12

	)

6 
	#PAGE_SIZE
 (()1<<
PAGE_SHIFT
)

	)

8 #ifdeà
__KERNEL__


11 
	#BITS_PER_PTR
 (8*())

	)

13 
	#PAGE_MASK
 (~(
PAGE_SIZE
-1))

	)

15 
	#PAGE_ALIGN
(
addr
è((×ddr)+
PAGE_SIZE
-1)&
PAGE_MASK
)

	)

17 
	#PTR_MASK
 (~((*)-1))

	)

21 
	#SIZEOF_PTR_LOG2
 2

	)

24 
	#PAGE_DIR_OFFSET
(
ba£
,
add»ss
) ((*)((base)+\

25 (()(
add»ss
)>>(
PAGE_SHIFT
-
SIZEOF_PTR_LOG2
)*2&
PTR_MASK
&~
PAGE_MASK
)))

	)

27 
	#PAGE_PTR
(
add»ss
) \

28 (()(
add»ss
)>>(
PAGE_SHIFT
-
SIZEOF_PTR_LOG2
)&
PTR_MASK
&~
PAGE_MASK
)

	)

30 
	#PTRS_PER_PAGE
 (
PAGE_SIZE
/(*))

	)

	@include/linux/param.h

1 #iâdeà
_LINUX_PARAM_H


2 
	#_LINUX_PARAM_H


	)

4 #iâdeà
HZ


5 
	#HZ
 100

	)

8 
	#EXEC_PAGESIZE
 4096

	)

10 #iâdeà
NGROUPS


11 
	#NGROUPS
 32

	)

14 #iâdeà
NOGROUP


15 
	#NOGROUP
 (-1)

	)

18 
	#MAXHOSTNAMELEN
 64

	)

	@include/linux/pipe_fs_i.h

1 #iâdeà
_LINUX_PIPE_FS_I_H


2 
	#_LINUX_PIPE_FS_I_H


	)

4 
	spe_šode_šfo
 {

5 
wa™_queue
 * 
	mwa™
;

6 * 
	mba£
;

7 
	m¡¬t
;

8 
	mËn
;

9 
	mlock
;

10 
	mrd_İ’”s
;

11 
	mwr_İ’”s
;

12 
	m»ad”s
;

13 
	mwr™”s
;

16 
	#PIPE_WAIT
(
šode
è((šode).
u
.
pe_i
.
wa™
)

	)

17 
	#PIPE_BASE
(
šode
è((šode).
u
.
pe_i
.
ba£
)

	)

18 
	#PIPE_START
(
šode
è((šode).
u
.
pe_i
.
¡¬t
)

	)

19 
	#PIPE_LEN
(
šode
è((šode).
u
.
pe_i
.
Ën
)

	)

20 
	#PIPE_RD_OPENERS
(
šode
è((šode).
u
.
pe_i
.
rd_İ’”s
)

	)

21 
	#PIPE_WR_OPENERS
(
šode
è((šode).
u
.
pe_i
.
wr_İ’”s
)

	)

22 
	#PIPE_READERS
(
šode
è((šode).
u
.
pe_i
.
»ad”s
)

	)

23 
	#PIPE_WRITERS
(
šode
è((šode).
u
.
pe_i
.
wr™”s
)

	)

24 
	#PIPE_LOCK
(
šode
è((šode).
u
.
pe_i
.
lock
)

	)

25 
	#PIPE_SIZE
(
šode
è
	`PIPE_LEN
(šode)

	)

27 
	#PIPE_EMPTY
(
šode
è(
	`PIPE_SIZE
(šode)==0)

	)

28 
	#PIPE_FULL
(
šode
è(
	`PIPE_SIZE
(šode)==
PIPE_BUF
)

	)

29 
	#PIPE_FREE
(
šode
è(
PIPE_BUF
 - 
	`PIPE_LEN
(šode))

	)

30 
	#PIPE_END
(
šode
è((
	`PIPE_START
(šode)+
	`PIPE_LEN
(inode))&\

31 (
PIPE_BUF
-1))

	)

32 
	#PIPE_MAX_RCHUNK
(
šode
è(
PIPE_BUF
 - 
	`PIPE_START
(šode))

	)

33 
	#PIPE_MAX_WCHUNK
(
šode
è(
PIPE_BUF
 - 
	`PIPE_END
(šode))

	)

	@include/linux/proc_fs.h

1 #iâdeà
_LINUX_PROC_FS_H


2 
	#_LINUX_PROC_FS_H


	)

8 
	#PROC_ROOT_INO
 1

	)

10 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

12 
	s´oc_dœ_’Œy
 {

13 
	mlow_šo
;

14 
	mÇm–’
;

15 * 
	mÇme
;

18 
su³r_block
 *
´oc_»ad_su³r
(super_block *,*,);

19 
´oc_put_šode
(
šode
 *);

20 
´oc_put_su³r
(
su³r_block
 *);

21 
´oc_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

22 
´oc_»ad_šode
(
šode
 *);

23 
´oc_wr™e_šode
(
šode
 *);

24 
´oc_m©ch
(, cÚ¡ *, 
´oc_dœ_’Œy
 *);

26 
šode_İ”©iÚs
 
´oc_roÙ_šode_İ”©iÚs
;

27 
šode_İ”©iÚs
 
´oc_ba£_šode_İ”©iÚs
;

28 
šode_İ”©iÚs
 
´oc_Ãt_šode_İ”©iÚs
;

29 
šode_İ”©iÚs
 
´oc_mem_šode_İ”©iÚs
;

30 
šode_İ”©iÚs
 
´oc_¬¿y_šode_İ”©iÚs
;

31 
šode_İ”©iÚs
 
´oc_kmsg_šode_İ”©iÚs
;

32 
šode_İ”©iÚs
 
´oc_lšk_šode_İ”©iÚs
;

33 
šode_İ”©iÚs
 
´oc_fd_šode_İ”©iÚs
;

34 
šode_İ”©iÚs
 
´oc_Ãt_šode_İ”©iÚs
;

	@include/linux/ptrace.h

1 #iâdeà
_LINUX_PTRACE_H


2 
	#_LINUX_PTRACE_H


	)

8 
	#PTRACE_TRACEME
 0

	)

9 
	#PTRACE_PEEKTEXT
 1

	)

10 
	#PTRACE_PEEKDATA
 2

	)

11 
	#PTRACE_PEEKUSR
 3

	)

12 
	#PTRACE_POKETEXT
 4

	)

13 
	#PTRACE_POKEDATA
 5

	)

14 
	#PTRACE_POKEUSR
 6

	)

15 
	#PTRACE_CONT
 7

	)

16 
	#PTRACE_KILL
 8

	)

17 
	#PTRACE_SINGLESTEP
 9

	)

19 
	#PTRACE_ATTACH
 0x10

	)

20 
	#PTRACE_DETACH
 0x11

	)

22 
	#PTRACE_SYSCALL
 24

	)

27 
	#EBX
 0

	)

28 
	#ECX
 1

	)

29 
	#EDX
 2

	)

30 
	#ESI
 3

	)

31 
	#EDI
 4

	)

32 
	#EBP
 5

	)

33 
	#EAX
 6

	)

34 
	#DS
 7

	)

35 
	#ES
 8

	)

36 
	#FS
 9

	)

37 
	#GS
 10

	)

38 
	#ORIG_EAX
 11

	)

39 
	#EIP
 12

	)

40 
	#CS
 13

	)

41 
	#EFL
 14

	)

42 
	#UESP
 15

	)

43 
	#SS
 16

	)

49 
	s±_»gs
 {

50 
	mebx
;

51 
	mecx
;

52 
	medx
;

53 
	mesi
;

54 
	medi
;

55 
	mebp
;

56 
	m—x
;

57 
	mds
, 
	m__dsu
;

58 
	mes
, 
	m__esu
;

59 
	mfs
, 
	m__fsu
;

60 
	mgs
, 
	m__gsu
;

61 
	mÜig_—x
;

62 
	me
;

63 
	mcs
, 
	m__csu
;

64 
	meæags
;

65 
	me¥
;

66 
	mss
, 
	m__ssu
;

	@include/linux/resource.h

1 #iâdeà
_LINUX_RESOURCE_H


2 
	#_LINUX_RESOURCE_H


	)

15 
	#RUSAGE_SELF
 0

	)

16 
	#RUSAGE_CHILDREN
 (-1)

	)

17 
	#RUSAGE_BOTH
 (-2è

	)

19 
	sru§ge
 {

20 
timev®
 
	mru_utime
;

21 
timev®
 
	mru_¡ime
;

22 
	mru_maxrss
;

23 
	mru_ixrss
;

24 
	mru_idrss
;

25 
	mru_i¤ss
;

26 
	mru_mšæt
;

27 
	mru_majæt
;

28 
	mru_nsw­
;

29 
	mru_šblock
;

30 
	mru_oublock
;

31 
	mru_msg¢d
;

32 
	mru_msgrcv
;

33 
	mru_nsigÇls
;

34 
	mru_nvcsw
;

35 
	mru_nivcsw
;

42 
	#RLIMIT_CPU
 0

	)

43 
	#RLIMIT_FSIZE
 1

	)

44 
	#RLIMIT_DATA
 2

	)

45 
	#RLIMIT_STACK
 3

	)

46 
	#RLIMIT_CORE
 4

	)

47 
	#RLIMIT_RSS
 5

	)

49 #ifdeà
nÙdef


50 
	#RLIMIT_MEMLOCK
 6

	)

51 
	#RLIMIT_NPROC
 7

	)

52 
	#RLIMIT_OFILE
 8

	)

55 
	#RLIM_NLIMITS
 6

	)

57 
	#RLIM_INFINITY
 0x7FFFFFFF

	)

59 
	s¾im™
 {

60 
	m¾im_cur
;

61 
	m¾im_max
;

64 
	#PRIO_MIN
 (-99)

	)

65 
	#PRIO_MAX
 14

	)

67 
	#PRIO_PROCESS
 0

	)

68 
	#PRIO_PGRP
 1

	)

69 
	#PRIO_USER
 2

	)

	@include/linux/route.h

18 #iâdeà
_LINUX_ROUTE_H


19 
	#_LINUX_ROUTE_H


	)

21 
	~<lšux/if.h
>

25 
	sŞd_¹’Œy
 {

26 
	m¹_g’mask
;

27 
sockaddr
 
	m¹_d¡
;

28 
sockaddr
 
	m¹_g©eway
;

29 
	m¹_æags
;

30 
	m¹_»fút
;

31 
	m¹_u£
;

32 *
	m¹_dev
;

36 
	s¹’Œy
 {

37 
	m¹_hash
;

38 
sockaddr
 
	m¹_d¡
;

39 
sockaddr
 
	m¹_g©eway
;

40 
sockaddr
 
	m¹_g’mask
;

41 
	m¹_æags
;

42 
	m¹_»fút
;

43 
	m¹_u£
;

44 
iâ‘
 *
	m¹_iå
;

45 
	m¹_m‘ric
;

46 *
	m¹_dev
;

50 
	#RTF_UP
 0x0001

	)

51 
	#RTF_GATEWAY
 0x0002

	)

52 
	#RTF_HOST
 0x0004

	)

53 
	#RTF_REINSTATE
 0x0008

	)

54 
	#RTF_DYNAMIC
 0x0010

	)

55 
	#RTF_MODIFIED
 0x0020

	)

	@include/linux/sbpcd.h

30 
	#SBPRO
 1

	)

41 
	#CDROM_PORT
 0x0230

	)

54 
	#DBG_INF
 1

	)

55 
	#DBG_IRQ
 2

	)

56 
	#DBG_REA
 3

	)

57 
	#DBG_CHK
 4

	)

58 
	#DBG_TIM
 5

	)

59 
	#DBG_INI
 6

	)

60 
	#DBG_TOC
 7

	)

61 
	#DBG_IOC
 8

	)

62 
	#DBG_STA
 9

	)

63 
	#DBG_ERR
 10

	)

64 
	#DBG_CMD
 11

	)

65 
	#DBG_WRN
 12

	)

66 
	#DBG_MUL
 13

	)

67 
	#DBG_ID
 14

	)

68 
	#DBG_IOX
 15

	)

69 
	#DBG_DID
 16

	)

70 
	#DBG_RES
 17

	)

71 
	#DBG_SPI
 18

	)

72 
	#DBG_IOS
 19

	)

73 
	#DBG_IO2
 20

	)

74 
	#DBG_000
 21

	)

82 
	#f_»¥o3
 0x100

	)

83 
	#f_putcmd
 0x80

	)

84 
	#f_»¥o2
 0x40

	)

85 
	#f_lİ¡a
 0x20

	)

86 
	#f_g‘¡a
 0x10

	)

87 
	#f_Re¥Ú£Stus
 0x08

	)

88 
	#f_obey_p_check
 0x04

	)

89 
	#f_b™1
 0x02

	)

90 
	#f_wa™_if_busy
 0x01

	)

95 
	#upc_b™
 0x40

	)

96 
	#vŞume_b™
 0x20

	)

97 
	#toc_b™
 0x10

	)

98 
	#muÉi£ssiÚ_b™
 0x08

	)

99 
	#cd_size_b™
 0x04

	)

100 
	#subq_b™
 0x02

	)

101 
	#äame_size_b™
 0x01

	)

106 
	#upc_v®id
 (
DS
[
d
].
disk¡©e_æags
&
upc_b™
)

	)

107 
	#vŞume_v®id
 (
DS
[
d
].
disk¡©e_æags
&
vŞume_b™
)

	)

108 
	#toc_v®id
 (
DS
[
d
].
disk¡©e_æags
&
toc_b™
)

	)

109 
	#muÉi£ssiÚ_v®id
 (
DS
[
d
].
disk¡©e_æags
&
muÉi£ssiÚ_b™
)

	)

110 
	#cd_size_v®id
 (
DS
[
d
].
disk¡©e_æags
&
cd_size_b™
)

	)

111 
	#subq_v®id
 (
DS
[
d
].
disk¡©e_æags
&
subq_b™
)

	)

112 
	#äame_size_v®id
 (
DS
[
d
].
disk¡©e_æags
&
äame_size_b™
)

	)

118 
	#p_doÜ_şo£d
 0x80

	)

119 
	#p_ÿddy_š
 0x40

	)

120 
	#p_¥šnšg
 0x20

	)

121 
	#p_check
 0x10

	)

122 
	#p_busy_Ãw
 0x08

	)

123 
	#p_doÜ_locked
 0x04

	)

124 
	#p_b™_1
 0x02

	)

125 
	#p_disk_ok
 0x01

	)

129 
	#p_ÿddš_Şd
 0x40

	)

130 
	#p_sucûss_Şd
 0x08

	)

131 
	#p_busy_Şd
 0x04

	)

136 
	#¡_doÜ_şo£d
 (
DS
[
d
].
¡©us_by‹
&
p_doÜ_şo£d
)

	)

137 
	#¡_ÿddy_š
 (
DS
[
d
].
¡©us_by‹
&
p_ÿddy_š
)

	)

138 
	#¡_¥šnšg
 (
DS
[
d
].
¡©us_by‹
&
p_¥šnšg
)

	)

139 
	#¡_check
 (
DS
[
d
].
¡©us_by‹
&
p_check
)

	)

140 
	#¡_busy
 (
DS
[
d
].
¡©us_by‹
&
p_busy_Ãw
)

	)

141 
	#¡_doÜ_locked
 (
DS
[
d
].
¡©us_by‹
&
p_doÜ_locked
)

	)

142 
	#¡_diskok
 (
DS
[
d
].
¡©us_by‹
&
p_disk_ok
)

	)

147 
	#s_nÙ_»suÉ_»ady
 0x04

	)

148 
	#s_nÙ_d©a_»ady
 0x02

	)

149 
	#s_©‹ÁiÚ
 0x01

	)

153 
	#DRV_ATTN
 ((
	`šb
(
CDi_¡©us
)&
s_©‹ÁiÚ
)!=0)

	)

154 
	#DATA_READY
 ((
	`šb
(
CDi_¡©us
)&
s_nÙ_d©a_»ady
)==0)

	)

155 
	#RESULT_READY
 ((
	`šb
(
CDi_¡©us
)&
s_nÙ_»suÉ_»ady
)==0)

	)

160 
	#drv_199
 0

	)

161 
	#drv_200
 1

	)

162 
	#drv_201
 2

	)

163 
	#drv_210
 3

	)

164 
	#drv_211
 4

	)

165 
	#drv_300
 5

	)

166 
	#drv_099
 0x10

	)

167 
	#drv_100
 0x11

	)

168 
	#drv_Ãw
 0x10

	)

169 
	#drv_Şd
 0x00

	)

174 
	#Ãw_drive
 (
DS
[
d
].
drv_ty³
&0x10)

	)

179 
	#audio_¶ayšg
 2

	)

180 
	#audio_·usšg
 1

	)

185 
	#¥“d_auto
 0x80

	)

186 
	#¥“d_300
 0x40

	)

187 
	#¥“d_150
 0x20

	)

188 
	#§x_a
 0x04

	)

189 
	#§x_xn2
 0x02

	)

190 
	#§x_xn1
 0x01

	)

195 
	#cmd_ty³_READ_M1
 0x01

	)

196 
	#cmd_ty³_READ_M2
 0x02

	)

197 
	#cmd_ty³_READ_SC
 0x04

	)

209 
	#CD_MINS
 75

	)

210 
	#CD_SECS
 60

	)

211 
	#CD_FRAMES
 75

	)

212 
	#CD_FRAMESIZE
 2048

	)

213 
	#CD_FRAMESIZE_XA
 2340

	)

214 
	#CD_FRAMESIZE_RAW
 2352

	)

215 
	#CD_BLOCK_OFFSET
 150

	)

219 
	#aud_00
 0x00

	)

220 
	#audx11
 0x0b

	)

221 
	#audx12
 0x0ø

	)

222 
	#audx13
 0x0d

	)

223 
	#audx14
 0x0

	)

224 
	#audx15
 0x0à

	)

227 
	#aud_11
 0x11

	)

228 
	#aud_12
 0x12

	)

229 
	#aud_13
 0x13

	)

230 
	#aud_14
 0x14

	)

231 
	#aud_15
 0x15

	)

391 
	#NR_SBPCD
 4

	)

396 
	#SBPCD_DIS_IRQ
 0

	)

401 
	#SBPCD_USE_IRQ
 0

	)

407 
	#SBPCD_INTR_NR
 7

	)

412 
	#OUT
(
x
,
y
è
	`outb
(y,x)

	)

415 
	#MIXER_CD_VŞume
 0x28

	)

421 
	#READ_DATA
(
pÜt
, 
buf
, 
Ä
è
	`šsb
ÕÜt, buf,‚r)

	)

428 
	#SET_TIMER
(
func
, 
jifs
) \

429 ((
tim”_bË
[
SBPCD_TIMER
].
expœes
 = 
jiff›s
 + 
jifs
), \

430 (
tim”_bË
[
SBPCD_TIMER
].
â
 = 
func
), \

431 (
tim”_aùive
 |ğ1<<
SBPCD_TIMER
))

	)

433 
	#CLEAR_TIMER
 
tim”_aùive
 &ğ~(1<<
SBPCD_TIMER
)

	)

439 
	#MAX_TRACKS
 120

	)

446 
	u_msf


448 
u_št
 
	mn
;

449 
u_ch¬
 
	mc
[4];

451 
	tMSF
;

453 
	u_blk


455 
u_št
 
	mn
;

456 
u_ch¬
 
	mc
[4];

458 
	tBLK
;

	@include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

4 
	#NEW_SWAP


	)

14 
	#HZ
 100

	)

19 
h¬d_m©h
;

20 
x86
;

21 
ignÜe_œq13
;

22 
wp_wÜks_ok
;

28 
EISA_bus
;

29 
	#MCA_bus
 0

	)

31 
	~<lšux/sks.h
>

32 
	~<asm/sy¡em.h
>

38 
	#TASK_SIZE
 0xc0000000

	)

43 
	#IO_BITMAP_SIZE
 32

	)

55 
av’run
[];

57 
	#FSHIFT
 11

	)

58 
	#FIXED_1
 (1<<
FSHIFT
è

	)

59 
	#LOAD_FREQ
 (5*
HZ
è

	)

60 
	#EXP_1
 1884

	)

61 
	#EXP_5
 2014

	)

62 
	#EXP_15
 2037

	)

64 
	#CALC_LOAD
(
lßd
,
exp
,
n
) \

65 
lßd
 *ğ
exp
; \

66 
lßd
 +ğ
n
*(
FIXED_1
-
exp
); \

67 
lßd
 >>ğ
FSHIFT
;

	)

69 
	#CT_TO_SECS
(
x
è((xè/ 
HZ
)

	)

70 
	#CT_TO_USECS
(
x
è(((xè% 
HZ
è* 1000000/HZ)

	)

72 
	#FIRST_TASK
 
sk
[0]

	)

73 
	#LAST_TASK
 
sk
[
NR_TASKS
-1]

	)

75 
	~<lšux/h—d.h
>

76 
	~<lšux/fs.h
>

77 
	~<lšux/mm.h
>

78 
	~<lšux/sigÇl.h
>

79 
	~<lšux/time.h
>

80 
	~<lšux/·¿m.h
>

81 
	~<lšux/»sourû.h
>

82 
	~<lšux/vm86.h
>

83 
	~<lšux/m©h_emu.h
>

85 
	#TASK_RUNNING
 0

	)

86 
	#TASK_INTERRUPTIBLE
 1

	)

87 
	#TASK_UNINTERRUPTIBLE
 2

	)

88 
	#TASK_ZOMBIE
 3

	)

89 
	#TASK_STOPPED
 4

	)

90 
	#TASK_SWAPPING
 5

	)

92 #iâdeà
NULL


93 
	#NULL
 ((*è0)

	)

96 #ifdeà
__KERNEL__


98 
sched_š™
();

99 
show_¡©e
();

100 
Œ­_š™
();

102 
asmlškage
 
scheduË
();

106 
	si387_h¬d_¡ruù
 {

107 
	mcwd
;

108 
	mswd
;

109 
	mtwd
;

110 
	mf
;

111 
	mfcs
;

112 
	mfoo
;

113 
	mfos
;

114 
	m¡_¥aû
[20];

117 
	si387_soá_¡ruù
 {

118 
	mcwd
;

119 
	mswd
;

120 
	mtwd
;

121 
	mf
;

122 
	mfcs
;

123 
	mfoo
;

124 
	mfos
;

125 
	mtİ
;

126 
åu_»g
 
	m»gs
[8];

127 
	mlookah—d
;

128 
šfo
 *
	mšfo
;

129 
	m’Œy_e
;

132 
	ui387_uniÚ
 {

133 
i387_h¬d_¡ruù
 
	mh¬d
;

134 
i387_soá_¡ruù
 
	msoá
;

137 
	stss_¡ruù
 {

138 
	mback_lšk
,
	m__blh
;

139 
	me¥0
;

140 
	mss0
,
	m__ss0h
;

141 
	me¥1
;

142 
	mss1
,
	m__ss1h
;

143 
	me¥2
;

144 
	mss2
,
	m__ss2h
;

145 
	mü3
;

146 
	me
;

147 
	meæags
;

148 
	m—x
,
	mecx
,
	medx
,
	mebx
;

149 
	me¥
;

150 
	mebp
;

151 
	mesi
;

152 
	medi
;

153 
	mes
, 
	m__esh
;

154 
	mcs
, 
	m__csh
;

155 
	mss
, 
	m__ssh
;

156 
	mds
, 
	m__dsh
;

157 
	mfs
, 
	m__fsh
;

158 
	mgs
, 
	m__gsh
;

159 
	mldt
, 
	m__ldth
;

160 
	mŒaû
, 
	mb™m­
;

161 
	mio_b™m­
[
IO_BITMAP_SIZE
+1];

162 
	mŒ
;

163 
	mü2
, 
	mŒ­_no
, 
	m”rÜ_code
;

164 
i387_uniÚ
 
	mi387
;

167 
	ssk_¡ruù
 {

169 vŞ©
	m¡©e
;

170 
	mcouÁ”
;

171 
	m´iÜ™y
;

172 
	msigÇl
;

173 
	mblocked
;

174 
	mæags
;

175 
	m”ºo
;

176 
	mdebug»g
[8];

178 
sk_¡ruù
 *
	mÃxt_sk
, *
	m´ev_sk
;

179 
sigaùiÚ
 
	msigaùiÚ
[32];

180 
	m§ved_k”Ãl_¡ack
;

181 
	mk”Ãl_¡ack_·ge
;

182 
	mex™_code
, 
	mex™_sigÇl
;

183 
	m–f_execubË
:1;

184 
	mdum·bË
:1;

185 
	msw­·bË
:1;

186 
	mdid_exec
:1;

187 
	m¡¬t_code
,
	m’d_code
,
	m’d_d©a
,
	m¡¬t_brk
,
	mbrk
,
	m¡¬t_¡ack
,
	m¡¬t_mm­
;

188 
	m¬g_¡¬t
, 
	m¬g_’d
, 
	m’v_¡¬t
, 
	m’v_’d
;

189 
	mpid
,
	mpg½
,
	m£ssiÚ
,
	mËad”
;

190 
	mgroups
[
NGROUPS
];

196 
sk_¡ruù
 *
	mp_İ±r
,*
	mp_µŒ
, *
	mp_ıŒ
, *
	mp_y¥Œ
, *
	mp_o¥Œ
;

197 
wa™_queue
 *
	mwa™_chldex™
;

202 
	muid
,
	meuid
,
	msuid
;

203 
	mgid
,
	megid
,
	msgid
;

204 
	mtimeout
;

205 
	m™_»®_v®ue
, 
	m™_´of_v®ue
, 
	m™_vœt_v®ue
;

206 
	m™_»®_šü
, 
	m™_´of_šü
, 
	m™_vœt_šü
;

207 
	mutime
,
	m¡ime
,
	mcutime
,
	mc¡ime
,
	m¡¬t_time
;

208 
	mmš_æt
, 
	mmaj_æt
;

209 
	mcmš_æt
, 
	mcmaj_æt
;

210 
¾im™
 
	m¾im
[
RLIM_NLIMITS
];

211 
	mu£d_m©h
;

212 
	mrss
;

213 
	mcomm
[16];

214 
vm86_¡ruù
 * 
	mvm86_šfo
;

215 
	msü“n_b™m­
;

217 
	mlšk_couÁ
;

218 
	m‰y
;

219 
	mumask
;

220 
šode
 * 
	mpwd
;

221 
šode
 * 
	mroÙ
;

222 
šode
 * 
	mexecubË
;

223 
vm_¬—_¡ruù
 * 
	mmm­
;

224 
shm_desc
 *
	mshm
;

225 
£m_undo
 *
	m£mun
;

226 
fe
 * 
	mfp
[
NR_OPEN
];

227 
fd_£t
 
	mşo£_Ú_exec
;

229 
desc_¡ruù
 *
	mldt
;

231 
tss_¡ruù
 
	mtss
;

232 #ifdeà
NEW_SWAP


233 
	mŞd_maj_æt
;

234 
	mdec_æt
;

235 
	msw­_út
;

236 
	msw­_bË
;

237 
	msw­_·ge
;

239 
vm_¬—_¡ruù
 *
	m¡k_vma
;

245 
	#PF_ALIGNWARN
 0x00000001

	)

247 
	#PF_PTRACED
 0x00000010

	)

248 
	#PF_TRACESYS
 0x00000020

	)

253 
	#CSIGNAL
 0x000000fà

	)

254 
	#COPYVM
 0x00000100

	)

255 
	#COPYFD
 0x00000200

	)

261 
	#INIT_TASK
 \

264  &
š™_sk
,&init_task, \

266  0,(è&
š™_k”Ãl_¡ack
, \

270  {
NOGROUP
,}, \

271  &
š™_sk
,&š™_sk,
NULL
,NULL,NULL,NULL, \

275  { {
LONG_MAX
, LONG_MAX}, {LONG_MAX, LONG_MAX}, \

276 {
LONG_MAX
, LONG_MAX}, {LONG_MAX, LONG_MAX}, \

277 { 0, 
LONG_MAX
}, {LONG_MAX, LONG_MAX}}, \

281  
NULL
, 0, \

282  0,-1,0022,
NULL
,NULL,NULL,NULL, \

283  
NULL
, NULL, \

284  {
NULL
,}, \

286  
NULL
, \

288 (
š™_k”Ãl_¡ack
è+ (è&š™_k”Ãl_¡ack, 
KERNEL_DS
, 0, \

290 (è&
sw­³r_pg_dœ
, \

292 
USER_DS
,0,USER_DS,0,USER_DS,0,USER_DS,0,USER_DS,0,USER_DS,0, \

293 
	`_LDT
(0),0, \

296 
	`_TSS
(0), 0, 0,0, \

299 }

	)

301 
sk_¡ruù
 
š™_sk
;

302 
sk_¡ruù
 *
sk
[
NR_TASKS
];

303 
sk_¡ruù
 *
Ï¡_sk_u£d_m©h
;

304 
sk_¡ruù
 *
cu¼’t
;

305 vŞ©
jiff›s
;

306 
™im”_ticks
;

307 
™im”_Ãxt
;

308 
timev®
 
xtime
;

309 
Ãed_»sched
;

311 
	#CURRENT_TIME
 (
xtime
.
tv_£c
)

	)

313 
¦“p_Ú
(
wa™_queue
 ** 
p
);

314 
š‹¼u±ibË_¦“p_Ú
(
wa™_queue
 ** 
p
);

315 
wake_up
(
wa™_queue
 ** 
p
);

316 
wake_up_š‹¼u±ibË
(
wa™_queue
 ** 
p
);

318 
nÙify_·»Á
(
sk_¡ruù
 * 
tsk
);

319 
£nd_sig
(
sig
,
sk_¡ruù
 * 
p
,
´iv
);

320 
š_group_p
(
gid_t
 
g½
);

322 
»que¡_œq
(
œq
,(*
hªdËr
)());

323 
	`ä“_œq
(
œq
);

324 
	`œqaùiÚ
(
œq
,
sigaùiÚ
 * 
§
);

339 
	#FIRST_TSS_ENTRY
 8

	)

340 
	#FIRST_LDT_ENTRY
 (
FIRST_TSS_ENTRY
+1)

	)

341 
	#_TSS
(
n
è((((èn)<<4)+(
FIRST_TSS_ENTRY
<<3))

	)

342 
	#_LDT
(
n
è((((èn)<<4)+(
FIRST_LDT_ENTRY
<<3))

	)

343 
	#lßd_TR
(
n
è
	`__asm__
("É¸%%ax": :"a" (
	`_TSS
Ò)))

	)

344 
	#lßd_ldt
(
n
è
	`__asm__
("Îdˆ%%ax": :"a" (
	`_LDT
Ò)))

	)

345 
	#¡Üe_TR
(
n
) \

346 
	`__asm__
("str %%ax\n\t" \

349 :"÷" (
n
) \

350 :"0" (0),"i" (
FIRST_TSS_ENTRY
<<3))

	)

357 
	#sw™ch_to
(
tsk
) \

358 
	`__asm__
("cmpl %%ecx,_current\n\t" \

369 :"m" (*(((*)&
tsk
->
tss
.
Œ
)-4)), \

370 "c" (
tsk
) \

371 :"cx")

	)

373 
	#_£t_ba£
(
addr
,
ba£
) \

374 
	`__asm__
("movw %%dx,%0\n\t" \

379 :"m" (*((
addr
)+2)), \

380 "m" (*((
addr
)+4)), \

381 "m" (*((
addr
)+7)), \

382 "d" (
ba£
) \

383 :"dx")

	)

385 
	#_£t_lim™
(
addr
,
lim™
) \

386 
	`__asm__
("movw %%dx,%0\n\t" \

393 :"m" (*(
addr
)), \

394 "m" (*((
addr
)+6)), \

395 "d" (
lim™
) \

396 :"dx")

	)

398 
	#£t_ba£
(
ldt
,
ba£
è
	`_£t_ba£
Ğ((*)&Ödt)è, ba£ )

	)

399 
	#£t_lim™
(
ldt
,
lim™
è
	`_£t_lim™
Ğ((*)&Ödt)è, (lim™-1)>>12 )

	)

406 
šlše
 
	$add_wa™_queue
(
wa™_queue
 ** 
p
, wa™_queu* 
wa™
)

408 
æags
;

410 #ifdeà
DEBUG


411 ià(
wa™
->
Ãxt
) {

412 
pc
;

413 
__asm__
 
	`__vŞ©e__
("call 1f\n"

414 "1:\İÈ%0":"ô" (
pc
));

415 
	`´štk
("add_wa™_queu(%08x): wa™->Ãxˆğ%08x\n",
pc
,(è
wa™
->
Ãxt
);

418 
	`§ve_æags
(
æags
);

419 
	`şi
();

420 ià(!*
p
) {

421 
wa™
->
Ãxt
 = wait;

422 *
p
 = 
wa™
;

424 
wa™
->
Ãxt
 = (*
p
)->next;

425 (*
p
)->
Ãxt
 = 
wa™
;

427 
	`»¡Üe_æags
(
æags
);

428 
	}
}

430 
šlše
 
	$»move_wa™_queue
(
wa™_queue
 ** 
p
, wa™_queu* 
wa™
)

432 
æags
;

433 
wa™_queue
 * 
tmp
;

434 #ifdeà
DEBUG


435 
ok
 = 0;

438 
	`§ve_æags
(
æags
);

439 
	`şi
();

440 ià((*
p
 =ğ
wa™
) &&

441 #ifdeà
DEBUG


442 (
ok
 = 1) &&

444 ((*
p
 = 
wa™
->
Ãxt
) == wait)) {

445 *
p
 = 
NULL
;

447 
tmp
 = 
wa™
;

448 
tmp
->
Ãxt
 !ğ
wa™
) {

449 
tmp
 =mp->
Ãxt
;

450 #ifdeà
DEBUG


451 ià(
tmp
 =ğ*
p
)

452 
ok
 = 1;

455 
tmp
->
Ãxt
 = 
wa™
->next;

457 
wa™
->
Ãxt
 = 
NULL
;

458 
	`»¡Üe_æags
(
æags
);

459 #ifdeà
DEBUG


460 ià(!
ok
) {

461 
	`´štk
("removed wait_queue‚ot on†ist.\n");

462 
	`´štk
("li¡ = %08x, queuğ%08x\n",(è
p
, (è
wa™
);

463 
	`__asm__
("ÿÎ 1f\n1:\İÈ%0":"ô" (
ok
));

464 
	`´štk
("e = %08x\n",
ok
);

467 
	}
}

469 
šlše
 
	$£Ëù_wa™
(
wa™_queue
 ** 
wa™_add»ss
, 
£Ëù_bË
 * 
p
)

471 
£Ëù_bË_’Œy
 * 
’Œy
;

473 ià(!
p
 || !
wa™_add»ss
)

475 ià(
p
->
Ä
 >ğ
__MAX_SELECT_TABLE_ENTRIES
)

477 
’Œy
 = 
p
->’Œy +…->
Ä
;

478 
’Œy
->
wa™_add»ss
 = wait_address;

479 
’Œy
->
wa™
.
sk
 = 
cu¼’t
;

480 
’Œy
->
wa™
.
Ãxt
 = 
NULL
;

481 
	`add_wa™_queue
(
wa™_add»ss
,&
’Œy
->
wa™
);

482 
p
->
Ä
++;

483 
	}
}

485 
__down
(
£m­hÜe
 * 
£m
);

487 
šlše
 
	$down
(
£m­hÜe
 * 
£m
)

489 ià(
£m
->
couÁ
 <= 0)

490 
	`__down
(
£m
);

491 
£m
->
couÁ
--;

492 
	}
}

494 
šlše
 
	$up
(
£m­hÜe
 * 
£m
)

496 
£m
->
couÁ
++;

497 
	`wake_up
(&
£m
->
wa™
);

498 
	}
}

500 
šlše
 
	$_g‘_ba£
(* 
addr
)

502 
__ba£
;

503 
	`__asm__
("movb %3,%%dh\n\t"

507 :"=&d" (
__ba£
)

508 :"m" (*((
addr
)+2)),

509 "m" (*((
addr
)+4)),

510 "m" (*((
addr
)+7)));

511  
__ba£
;

512 
	}
}

514 
	#g‘_ba£
(
ldt
è
	`_g‘_ba£
Ğ((*)&Ödt)è)

	)

516 
šlše
 
	$g‘_lim™
(
£gm’t
)

518 
__lim™
;

519 
	`__asm__
("lsll %1,%0"

520 :"ô" (
__lim™
):"r" (
£gm’t
));

521  
__lim™
+1;

522 
	}
}

524 
	#REMOVE_LINKS
(
p
èdØ{ 
æags
; \

525 
	`§ve_æags
(
æags
è; 
	`şi
(); \

526 (
p
)->
Ãxt_sk
->
´ev_sk
 = (p)->prev_task; \

527 (
p
)->
´ev_sk
->
Ãxt_sk
 = (p)->next_task; \

528 
	`»¡Üe_æags
(
æags
); \

529 ià((
p
)->
p_o¥Œ
) \

530 (
p
)->
p_o¥Œ
->
p_y¥Œ
 = (p)->p_ysptr; \

531 ià((
p
)->
p_y¥Œ
) \

532 (
p
)->
p_y¥Œ
->
p_o¥Œ
 = (p)->p_osptr; \

534 (
p
)->
p_µŒ
->
p_ıŒ
 = (p)->
p_o¥Œ
; \

535 } 0)

	)

537 
	#SET_LINKS
(
p
èdØ{ 
æags
; \

538 
	`§ve_æags
(
æags
); 
	`şi
(); \

539 (
p
)->
Ãxt_sk
 = &
š™_sk
; \

540 (
p
)->
´ev_sk
 = 
š™_sk
.prev_task; \

541 
š™_sk
.
´ev_sk
->
Ãxt_sk
 = (
p
); \

542 
š™_sk
.
´ev_sk
 = (
p
); \

543 
	`»¡Üe_æags
(
æags
); \

544 (
p
)->
p_y¥Œ
 = 
NULL
; \

545 ià(((
p
)->
p_o¥Œ
 = (p)->
p_µŒ
->
p_ıŒ
è!ğ
NULL
) \

546 (
p
)->
p_o¥Œ
->
p_y¥Œ
 =…; \

547 (
p
)->
p_µŒ
->
p_ıŒ
 =…; \

548 } 0)

	)

550 
	#fÜ_—ch_sk
(
p
) \

551 
p
 = &
š™_sk
 ; (°ğp->
Ãxt_sk
è!ğ&š™_sk ; )

	)

557 
desc_¡ruù
 
deçuÉ_ldt
;

561 
	#lßddebug
() \

562 
	`__asm__
("movl %0,%%edx\n\t" \

565 :"m" (
cu¼’t
->
debug»g
[]) \

566 :"dx");

	)

	@include/linux/segment.h

1 #iâdeà
_LINUX_SEGMENT_H


2 
	#_LINUX_SEGMENT_H


	)

4 
	#KERNEL_CS
 0x10

	)

5 
	#KERNEL_DS
 0x18

	)

7 
	#USER_CS
 0x23

	)

8 
	#USER_DS
 0x2B

	)

	@include/linux/sem.h

1 #iâdeà
_LINUX_SEM_H


2 
	#_LINUX_SEM_H


	)

3 
	~<lšux/c.h
>

6 
	#SEM_UNDO
 010000

	)

9 
	#GETPID
 11

	)

10 
	#GETVAL
 12

	)

11 
	#GETALL
 13

	)

12 
	#GETNCNT
 14

	)

13 
	#GETZCNT
 15

	)

14 
	#SETVAL
 16

	)

15 
	#SETALL
 17

	)

18 
	s£mid_ds
 {

19 
c_³rm
 
	m£m_³rm
;

20 
time_t
 
	m£m_Ùime
;

21 
time_t
 
	m£m_ùime
;

22 
£m
 *
	m£m_ba£
;

23 
wa™_queue
 *
	mev’Š
;

24 
wa™_queue
 *
	mev’tz
;

25 
£m_undo
 *
	mundo
;

26 
ushÜt
 
	m£m_n£ms
;

31 
	s£m
 {

32 
	m£mpid
;

33 
ushÜt
 
	m£mv®
;

34 
ushÜt
 
	m£mnút
;

35 
ushÜt
 
	m£mzút
;

39 
	s£mbuf
 {

40 
ushÜt
 
	m£m_num
;

41 
	m£m_İ
;

42 
	m£m_æg
;

46 
	u£mun
 {

47 
	mv®
;

48 
£mid_ds
 *
	mbuf
;

49 
ushÜt
 *
	m¬¿y
;

53 
	s£mšfo
 {

54 
	m£mm­
;

55 
	m£mmni
;

56 
	m£mmns
;

57 
	m£mmnu
;

58 
	m£mm¦
;

59 
	m£mİm
;

60 
	m£mume
;

61 
	m£musz
;

62 
	m£mvmx
;

63 
	m£m«m
;

66 
	#SEMMNI
 128

	)

67 
	#SEMMSL
 32

	)

68 
	#SEMMNS
 (
SEMMNI
*
SEMMSL
è

	)

69 
	#SEMOPM
 32

	)

70 
	#SEMVMX
 32767

	)

73 
	#SEMUME
 
SEMOPM


	)

74 
	#SEMMNU
 
SEMMNS


	)

75 
	#SEMAEM
 (
SEMVMX
 >> 1è

	)

76 
	#SEMMAP
 
SEMMNS


	)

77 
	#SEMUSZ
 20

	)

79 #ifdeà
__KERNEL__


81 
	#SEM_STAT
 18

	)

82 
	#SEM_INFO
 19

	)

86 
	s£m_undo
 {

87 
£m_undo
 *
	m´oc_Ãxt
;

88 
£m_undo
 *
	mid_Ãxt
;

89 
	m£mid
;

90 
	m£madj
;

91 
ushÜt
 
	m£m_num
;

	@include/linux/serial.h

18 #iâdeà
_LINUX_SERIAL_H


19 
	#_LINUX_SERIAL_H


	)

21 
	sasync_¡ruù
 {

22 
	mbaud_ba£
;

23 
	mpÜt
;

24 
	mœq
;

25 
	mæags
;

26 
	mhub6
;

27 
	mty³
;

28 
‰y_¡ruù
 *
	m‰y
;

29 
	m»ad_¡©us_mask
;

30 
	mtimeout
;

31 
	mxm™_fifo_size
;

32 
	mcu¡om_divisÜ
;

33 
	mx_ch¬
;

34 
	mşo£_d–ay
;

35 
	mIER
;

36 
	mev’t
;

37 
	mlše
;

38 
	mcouÁ
;

39 
	mblocked_İ’
;

40 
	m£ssiÚ
;

41 
	mpg½
;

42 
‹rmios
 
	mnÜm®_‹rmios
;

43 
‹rmios
 
	mÿÎout_‹rmios
;

44 
wa™_queue
 *
	mİ’_wa™
;

45 
wa™_queue
 *
	mşo£_wa™
;

46 
wa™_queue
 *
	mxm™_wa™
;

47 
async_¡ruù
 *
	mÃxt_pÜt
;

48 
async_¡ruù
 *
	m´ev_pÜt
;

55 
	#RS_EVENT_READ_PROCESS
 0

	)

56 
	#RS_EVENT_WRITE_WAKEUP
 1

	)

57 
	#RS_EVENT_HANGUP
 2

	)

58 
	#RS_EVENT_BREAK
 3

	)

59 
	#RS_EVENT_OPEN_WAKEUP
 4

	)

66 
	#UART_RX
 0

	)

67 
	#UART_TX
 0

	)

68 
	#UART_DLL
 0

	)

69 
	#UART_DLM
 1

	)

70 
	#UART_IER
 1

	)

71 
	#UART_IIR
 2

	)

72 
	#UART_FCR
 2

	)

73 
	#UART_LCR
 3

	)

74 
	#UART_MCR
 4

	)

75 
	#UART_LSR
 5

	)

76 
	#UART_MSR
 6

	)

77 
	#UART_SCR
 7

	)

82 
	#UART_FCR_ENABLE_FIFO
 0x01

	)

83 
	#UART_FCR_CLEAR_RCVR
 0x02

	)

84 
	#UART_FCR_CLEAR_XMIT
 0x04

	)

85 
	#UART_FCR_DMA_SELECT
 0x08

	)

86 
	#UART_FCR_TRIGGER_MASK
 0xC0

	)

87 
	#UART_FCR_TRIGGER_1
 0x00

	)

88 
	#UART_FCR_TRIGGER_4
 0x40

	)

89 
	#UART_FCR_TRIGGER_8
 0x80

	)

90 
	#UART_FCR_TRIGGER_14
 0xC0

	)

98 
	#UART_LCR_DLAB
 0x80

	)

99 
	#UART_LCR_SBC
 0x40

	)

100 
	#UART_LCR_SPAR
 0x20

	)

101 
	#UART_LCR_EPAR
 0x10

	)

102 
	#UART_LCR_PARITY
 0x08

	)

103 
	#UART_LCR_STOP
 0x04

	)

104 
	#UART_LCR_WLEN5
 0x00

	)

105 
	#UART_LCR_WLEN6
 0x01

	)

106 
	#UART_LCR_WLEN7
 0x02

	)

107 
	#UART_LCR_WLEN8
 0x03

	)

112 
	#UART_LSR_TEMT
 0x40

	)

113 
	#UART_LSR_THRE
 0x20

	)

114 
	#UART_LSR_BI
 0x10

	)

115 
	#UART_LSR_FE
 0x08

	)

116 
	#UART_LSR_PE
 0x04

	)

117 
	#UART_LSR_OE
 0x02

	)

118 
	#UART_LSR_DR
 0x01

	)

123 
	#UART_IIR_NO_INT
 0x01

	)

124 
	#UART_IIR_ID
 0x06

	)

126 
	#UART_IIR_MSI
 0x00

	)

127 
	#UART_IIR_THRI
 0x02

	)

128 
	#UART_IIR_RDI
 0x04

	)

129 
	#UART_IIR_RLSI
 0x06

	)

134 
	#UART_IER_MSI
 0x08

	)

135 
	#UART_IER_RLSI
 0x04

	)

136 
	#UART_IER_THRI
 0x02

	)

137 
	#UART_IER_RDI
 0x01

	)

142 
	#UART_MCR_LOOP
 0x10

	)

143 
	#UART_MCR_OUT2
 0x08

	)

144 
	#UART_MCR_OUT1
 0x04

	)

145 
	#UART_MCR_RTS
 0x02

	)

146 
	#UART_MCR_DTR
 0x01

	)

151 
	#UART_MSR_DCD
 0x80

	)

152 
	#UART_MSR_RI
 0x40

	)

153 
	#UART_MSR_DSR
 0x20

	)

154 
	#UART_MSR_CTS
 0x10

	)

155 
	#UART_MSR_DDCD
 0x08

	)

156 
	#UART_MSR_TERI
 0x04

	)

157 
	#UART_MSR_DDSR
 0x02

	)

158 
	#UART_MSR_DCTS
 0x01

	)

159 
	#UART_MSR_ANY_DELTA
 0x0F

	)

	@include/linux/shm.h

1 #iâdeà
_LINUX_SHM_H_


2 
	#_LINUX_SHM_H_


	)

3 
	~<lšux/c.h
>

5 
	sshmid_ds
 {

6 
c_³rm
 
	mshm_³rm
;

7 
	mshm_£gsz
;

8 
time_t
 
	mshm_©ime
;

9 
time_t
 
	mshm_dtime
;

10 
time_t
 
	mshm_ùime
;

11 
	mshm_ıid
;

12 
	mshm_Íid
;

13 
	mshm_Ç‰ch
;

15 
	mshm_Åages
;

16 *
	mshm_·ges
;

17 
shm_desc
 *
	m©ches
;

21 
	#SHM_RDONLY
 010000

	)

22 
	#SHM_RND
 020000

	)

23 
	#SHM_REMAP
 040000

	)

26 
	#SHM_LOCK
 11

	)

27 
	#SHM_UNLOCK
 12

	)

29 
	sshmšfo
 {

30 
	mshmmax
;

31 
	mshmmš
;

32 
	mshmmni
;

33 
	mshm£g
;

34 
	mshm®l
;

37 
	#SHM_RANGE_START
 0x40000000

	)

38 
	#SHM_RANGE_END
 0x60000000

	)

44 
	#_SHM_ID_BITS
 7

	)

48 
	#__SHM_IDX_BITS
 (
BITS_PER_PTR
-2-
SHM_IDX_SHIFT
)

	)

56 
	#_SHM_IDX_BITS
 (
__SHM_IDX_BITS
+
PAGE_SHIFT
>=
BITS_PER_PTR
?\

57 
BITS_PER_PTR
-
PAGE_SHIFT
-1:
__SHM_IDX_BITS
è

	)

60 
	#SHM_ID_SHIFT
 8

	)

61 
	#SHM_ID_MASK
 ((1<<
_SHM_ID_BITS
)-1)

	)

62 
	#SHM_IDX_SHIFT
 (
SHM_ID_SHIFT
+
_SHM_ID_BITS
)

	)

63 
	#SHM_IDX_MASK
 ((1<<
_SHM_IDX_BITS
)-1)

	)

64 
	#SHM_READ_ONLY
 (1<<(
BITS_PER_PTR
-1))

	)

66 
	#SHMMAX
 0x3ç000

	)

67 
	#SHMMIN
 1

	)

68 
	#SHMMNI
 (1<<
_SHM_ID_BITS
è

	)

69 
	#SHMALL
 (1<<(
_SHM_IDX_BITS
+
_SHM_ID_BITS
))

	)

70 
	#SHMLBA
 0x1000

	)

71 
	#SHMSEG
 
SHMMNI


	)

73 #ifdeà
__KERNEL__


76 
	#SHM_DEST
 01000

	)

77 
	#SHM_LOCKED
 02000

	)

80 
	#SHM_STAT
 13

	)

81 
	#SHM_INFO
 14

	)

82 
	sshm_šfo
 {

83 
	mu£d_ids
;

84 
ulÚg
 
	mshm_tÙ
;

85 
ulÚg
 
	mshm_rss
;

86 
ulÚg
 
	mshm_swp
;

87 
ulÚg
 
	msw­_©‹m±s
;

88 
ulÚg
 
	msw­_sucûs£s
;

96 
	sshm_desc
 {

97 
sk_¡ruù
 *
	msk
;

98 
	mshm_sgn
;

99 
	m¡¬t
;

100 
	m’d
;

101 
shm_desc
 *
	msk_Ãxt
;

102 
shm_desc
 *
	m£g_Ãxt
;

	@include/linux/signal.h

1 #iâdeà
_LINUX_SIGNAL_H


2 
	#_LINUX_SIGNAL_H


	)

4 
	tsig£t_t
;

6 
	#_NSIG
 32

	)

7 
	#NSIG
 
_NSIG


	)

9 
	#SIGHUP
 1

	)

10 
	#SIGINT
 2

	)

11 
	#SIGQUIT
 3

	)

12 
	#SIGILL
 4

	)

13 
	#SIGTRAP
 5

	)

14 
	#SIGABRT
 6

	)

15 
	#SIGIOT
 6

	)

16 
	#SIGUNUSED
 7

	)

17 
	#SIGFPE
 8

	)

18 
	#SIGKILL
 9

	)

19 
	#SIGUSR1
 10

	)

20 
	#SIGSEGV
 11

	)

21 
	#SIGUSR2
 12

	)

22 
	#SIGPIPE
 13

	)

23 
	#SIGALRM
 14

	)

24 
	#SIGTERM
 15

	)

25 
	#SIGSTKFLT
 16

	)

26 
	#SIGCHLD
 17

	)

27 
	#SIGCONT
 18

	)

28 
	#SIGSTOP
 19

	)

29 
	#SIGTSTP
 20

	)

30 
	#SIGTTIN
 21

	)

31 
	#SIGTTOU
 22

	)

39 
	#SIGIO
 23

	)

40 
	#SIGPOLL
 
SIGIO


	)

41 
	#SIGURG
 
SIGIO


	)

42 
	#SIGXCPU
 24

	)

43 
	#SIGXFSZ
 25

	)

46 
	#SIGVTALRM
 26

	)

47 
	#SIGPROF
 27

	)

49 
	#SIGWINCH
 28

	)

54 
	#SIGPWR
 30

	)

57 
	#SIGBUS
 
SIGUNUSED


	)

67 
	#SA_NOCLDSTOP
 1

	)

68 
	#SA_STACK
 0x08000000

	)

69 
	#SA_RESTART
 0x10000000

	)

70 
	#SA_INTERRUPT
 0x20000000

	)

71 
	#SA_NOMASK
 0x40000000

	)

72 
	#SA_ONESHOT
 0x80000000

	)

74 
	#SIG_BLOCK
 0

	)

75 
	#SIG_UNBLOCK
 1

	)

76 
	#SIG_SETMASK
 2

	)

79 (*
	t__sighªdËr_t
)();

81 
	#SIG_DFL
 ((
__sighªdËr_t
)0è

	)

82 
	#SIG_IGN
 ((
__sighªdËr_t
)1è

	)

83 
	#SIG_ERR
 ((
__sighªdËr_t
)-1è

	)

85 
	ssigaùiÚ
 {

86 
__sighªdËr_t
 
§_hªdËr
;

87 
sig£t_t
 
§_mask
;

88 
§_æags
;

89 (*
§_»¡Ü”
)();

	@include/linux/socket.h

1 #iâdeà
_LINUX_SOCKET_H


2 
	#_LINUX_SOCKET_H


	)

4 
	~<lšux/sockios.h
>

7 
	ssockaddr
 {

8 
	m§_çmy
;

9 
	m§_d©a
[14];

12 
	slšg”
 {

13 
	ml_Úoff
;

14 
	ml_lšg”
;

18 
	#SOCK_STREAM
 1

	)

19 
	#SOCK_DGRAM
 2

	)

20 
	#SOCK_RAW
 3

	)

21 
	#SOCK_RDM
 4

	)

22 
	#SOCK_SEQPACKET
 5

	)

23 
	#SOCK_PACKET
 10

	)

30 
	#AF_UNSPEC
 0

	)

31 
	#AF_UNIX
 1

	)

32 
	#AF_INET
 2

	)

33 
	#AF_AX25
 3

	)

34 
	#AF_IPX
 4

	)

37 
	#PF_UNIX
 
AF_UNIX


	)

38 
	#PF_INET
 
AF_INET


	)

39 
	#PF_AX25
 
AF_AX25


	)

40 
	#PF_IPX
 
AF_IPX


	)

43 
	#MSG_OOB
 1

	)

44 
	#MSG_PEEK
 2

	)

47 
	#SOL_SOCKET
 1

	)

48 
	#SOL_IP
 0

	)

49 
	#SOL_IPX
 256

	)

50 
	#SOL_AX25
 257

	)

51 
	#SOL_TCP
 6

	)

52 
	#SOL_UDP
 17

	)

55 
	#SO_DEBUG
 1

	)

56 
	#SO_REUSEADDR
 2

	)

57 
	#SO_TYPE
 3

	)

58 
	#SO_ERROR
 4

	)

59 
	#SO_DONTROUTE
 5

	)

60 
	#SO_BROADCAST
 6

	)

61 
	#SO_SNDBUF
 7

	)

62 
	#SO_RCVBUF
 8

	)

63 
	#SO_KEEPALIVE
 9

	)

64 
	#SO_OOBINLINE
 10

	)

65 
	#SO_NO_CHECK
 11

	)

66 
	#SO_PRIORITY
 12

	)

67 
	#SO_LINGER
 13

	)

70 
	#IP_TOS
 1

	)

71 
	#IPTOS_LOWDELAY
 0x10

	)

72 
	#IPTOS_THROUGHPUT
 0x08

	)

73 
	#IPTOS_RELIABILITY
 0x04

	)

74 
	#IP_TTL
 2

	)

77 
	#IPX_TYPE
 1

	)

80 
	#AX25_WINDOW
 1

	)

83 
	#TCP_NODELAY
 1

	)

84 
	#TCP_MAXSEG
 2

	)

87 
	#SOPRI_INTERACTIVE
 0

	)

88 
	#SOPRI_NORMAL
 1

	)

89 
	#SOPRI_BACKGROUND
 2

	)

	@include/linux/sockios.h

18 #iâdeà
_LINUX_SOCKIOS_H


19 
	#_LINUX_SOCKIOS_H


	)

23 
	#MAX_IP_NAME
 20

	)

24 
	#IP_SET_DEV
 0x2401

	)

26 
	s_cÚfig
 {

27 
	mÇme
[
MAX_IP_NAME
];

28 
	m·ddr
;

29 
	mrou‹r
;

30 
	mÃt
;

31 
	mup
:1,
	mde¡roy
:1;

36 
	#FIOSETOWN
 0x8901

	)

37 
	#SIOCSPGRP
 0x8902

	)

38 
	#FIOGETOWN
 0x8903

	)

39 
	#SIOCGPGRP
 0x8904

	)

40 
	#SIOCATMARK
 0x8905

	)

43 
	#SIOCADDRT
 0x890B

	)

44 
	#SIOCDELRT
 0x890C

	)

47 
	#SIOCGIFNAME
 0x8910

	)

48 
	#SIOCSIFLINK
 0x8911

	)

49 
	#SIOCGIFCONF
 0x8912

	)

50 
	#SIOCGIFFLAGS
 0x8913

	)

51 
	#SIOCSIFFLAGS
 0x8914

	)

52 
	#SIOCGIFADDR
 0x8915

	)

53 
	#SIOCSIFADDR
 0x8916

	)

54 
	#SIOCGIFDSTADDR
 0x8917

	)

55 
	#SIOCSIFDSTADDR
 0x8918

	)

56 
	#SIOCGIFBRDADDR
 0x8919

	)

57 
	#SIOCSIFBRDADDR
 0x891¨

	)

58 
	#SIOCGIFNETMASK
 0x891b

	)

59 
	#SIOCSIFNETMASK
 0x891ø

	)

60 
	#SIOCGIFMETRIC
 0x891d

	)

61 
	#SIOCSIFMETRIC
 0x891

	)

62 
	#SIOCGIFMEM
 0x891à

	)

63 
	#SIOCSIFMEM
 0x8920

	)

64 
	#SIOCGIFMTU
 0x8921

	)

65 
	#SIOCSIFMTU
 0x8922

	)

66 
	#SIOCGIFHWADDR
 0x8923

	)

67 
	#SIOCSIFHWADDR
 0x8924

	)

68 
	#SIOCGIFENCAP
 0x8925

	)

69 
	#SIOCSIFENCAP
 0x8926

	)

72 
	#SIOCADDRTOLD
 0x8940

	)

73 
	#SIOCDELRTOLD
 0x8941

	)

76 
	#SIOCDARP
 0x8950

	)

77 
	#SIOCGARP
 0x8951

	)

78 
	#SIOCSARP
 0x8952

	)

	@include/linux/soundcard.h

1 #iâdeà
SOUNDCARD_H


2 
	#SOUNDCARD_H


	)

40 
	#SOUND_VERSION
 203

	)

41 
	#VOXWARE


	)

43 
	~<sys/ioùl.h
>

49 
	#SNDCARD_ADLIB
 1

	)

50 
	#SNDCARD_SB
 2

	)

51 
	#SNDCARD_PAS
 3

	)

52 
	#SNDCARD_GUS
 4

	)

53 
	#SNDCARD_MPU401
 5

	)

54 
	#SNDCARD_SB16
 6

	)

55 
	#SNDCARD_SB16MIDI
 7

	)

61 #iâdeà
_IOWR


71 
	#IOCPARM_MASK
 0x7à

	)

72 
	#IOC_VOID
 0x00000000

	)

73 
	#IOC_OUT
 0x20000000

	)

74 
	#IOC_IN
 0x40000000

	)

75 
	#IOC_INOUT
 (
IOC_IN
|
IOC_OUT
)

	)

77 
	#_IO
(
x
,
y
è(()(
IOC_VOID
|(x<<8)|y))

	)

78 
	#_IOR
(
x
,
y
,
t
è(()(
IOC_OUT
|((Ñ)&
IOCPARM_MASK
)<<16)|(x<<8)|y))

	)

79 
	#_IOW
(
x
,
y
,
t
è(()(
IOC_IN
|((Ñ)&
IOCPARM_MASK
)<<16)|(x<<8)|y))

	)

81 
	#_IOWR
(
x
,
y
,
t
è(()(
IOC_INOUT
|((Ñ)&
IOCPARM_MASK
)<<16)|(x<<8)|y))

	)

84 
	#SNDCTL_SEQ_RESET
 
	`_IO
 ('Q', 0)

	)

85 
	#SNDCTL_SEQ_SYNC
 
	`_IO
 ('Q', 1)

	)

86 
	#SNDCTL_SYNTH_INFO
 
	`_IOWR
('Q', 2, 
syÁh_šfo
)

	)

87 
	#SNDCTL_SEQ_CTRLRATE
 
	`_IOWR
('Q', 3, è

	)

88 
	#SNDCTL_SEQ_GETOUTCOUNT
 
	`_IOR
 ('Q', 4, )

	)

89 
	#SNDCTL_SEQ_GETINCOUNT
 
	`_IOR
 ('Q', 5, )

	)

90 
	#SNDCTL_SEQ_PERCMODE
 
	`_IOW
 ('Q', 6, )

	)

91 
	#SNDCTL_FM_LOAD_INSTR
 
	`_IOW
 ('Q', 7, 
sbi_š¡rum’t
è

	)

92 
	#SNDCTL_SEQ_TESTMIDI
 
	`_IOW
 ('Q', 8, )

	)

93 
	#SNDCTL_SEQ_RESETSAMPLES
 
	`_IOW
 ('Q', 9, )

	)

94 
	#SNDCTL_SEQ_NRSYNTHS
 
	`_IOR
 ('Q',10, )

	)

95 
	#SNDCTL_SEQ_NRMIDIS
 
	`_IOR
 ('Q',11, )

	)

96 
	#SNDCTL_MIDI_INFO
 
	`_IOWR
('Q',12, 
midi_šfo
)

	)

97 
	#SNDCTL_SEQ_TRESHOLD
 
	`_IOW
 ('Q',13, )

	)

98 
	#SNDCTL_SYNTH_MEMAVL
 
	`_IOWR
('Q',14, è

	)

99 
	#SNDCTL_FM_4OP_ENABLE
 
	`_IOW
 ('Q',15, è

	)

100 
	#SNDCTL_PMGR_ACCESS
 
	`_IOWR
('Q',16, 
·tmgr_šfo
)

	)

109 
	s·tch_šfo
 {

110 
	mkey
;

111 
	#GUS_PATCH
 0x04fd

	)

112 
	#OBSOLETE_GUS_PATCH
 0x02fd

	)

113 
	mdeviû_no
;

114 
	mš¡r_no
;

116 
	mmode
;

121 
	#WAVE_16_BITS
 0x01

	)

122 
	#WAVE_UNSIGNED
 0x02

	)

123 
	#WAVE_LOOPING
 0x04

	)

124 
	#WAVE_BIDIR_LOOP
 0x08

	)

125 
	#WAVE_LOOP_BACK
 0x10

	)

126 
	#WAVE_SUSTAIN_ON
 0x20

	)

127 
	#WAVE_ENVELOPES
 0x40

	)

130 
	#WAVE_VIBRATO
 0x00010000

	)

131 
	#WAVE_TREMOLO
 0x00020000

	)

132 
	#WAVE_SCALE
 0x00040000

	)

135 
	mËn
;

136 
	mloİ_¡¬t
, 
	mloİ_’d
;

154 
	mba£_äeq
;

155 
	mba£_nÙe
;

156 
	mhigh_nÙe
;

157 
	mlow_nÙe
;

158 
	m·Âšg
;

159 
	md‘unšg
;

164 
	m’v_¿‹
[ 6 ];

165 
	m’v_off£t
[ 6 ];

173 
	mŒemŞo_sw“p
;

174 
	mŒemŞo_¿‹
;

175 
	mŒemŞo_d•th
;

177 
	mvib¿to_sw“p
;

178 
	mvib¿to_¿‹
;

179 
	mvib¿to_d•th
;

181 
	msÿË_äequ’cy
;

182 
	msÿË_çùÜ
;

184 
	mvŞume
;

185 
	m¥¬e
[4];

186 
	md©a
[1];

196 
	#PS_NO_PATCHES
 0

	)

197 
	#PS_MGR_NOT_OK
 1

	)

198 
	#PS_MGR_OK
 2

	)

199 
	#PS_MANAGED
 3

	)

201 
	#SNDCTL_PMGR_IFACE
 
	`_IOWR
('P', 1, 
·tmgr_šfo
)

	)

216 
	s·tmgr_šfo
 {

217 
	mkey
;

219 
	#PM_K_EVENT
 1

	)

220 
	#PM_K_COMMAND
 2

	)

221 
	#PM_K_RESPONSE
 3

	)

222 
	#PM_ERROR
 4

	)

223 
	mdeviû
;

224 
	mcommªd
;

229 
	#PM_GET_DEVTYPE
 1

	)

230 
	#PMTYPE_FM2
 1

	)

231 
	#PMTYPE_FM4
 2

	)

232 
	#PMTYPE_WAVE
 3

	)

233 
	#PM_GET_NRPGM
 2

	)

234 
	#PM_GET_PGMMAP
 3

	)

235 
	#PM_GET_PGM_PATCHES
 4

	)

236 
	#PM_GET_PATCH
 5

	)

237 
	#PM_SET_PATCH
 6

	)

238 
	#PM_READ_PATCH
 7

	)

239 
	#PM_WRITE_PATCH
 8

	)

245 
	#_PM_LOAD_PATCH
 0x100

	)

251 
	m·rm1
;

252 
	m·rm2
;

253 
	m·rm3
;

256 
	md©a8
[4000];

257 
	md©a16
[2000];

258 
	md©a32
[1000];

259 
·tch_šfo
 
	m·tch
;

260 } 
	md©a
;

269 
	#PM_E_OPENED
 1

	)

270 
	#PM_E_CLOSED
 2

	)

271 
	#PM_E_PATCH_RESET
 3

	)

272 
	#PM_E_PATCH_LOADED
 4

	)

294 
	#SEQ_NOTEOFF
 0

	)

295 
	#SEQ_FMNOTEOFF
 
SEQ_NOTEOFF


	)

296 
	#SEQ_NOTEON
 1

	)

297 
	#SEQ_FMNOTEON
 
SEQ_NOTEON


	)

298 
	#SEQ_WAIT
 2

	)

299 
	#SEQ_PGMCHANGE
 3

	)

300 
	#SEQ_FMPGMCHANGE
 
SEQ_PGMCHANGE


	)

301 
	#SEQ_SYNCTIMER
 4

	)

302 
	#SEQ_MIDIPUTC
 5

	)

303 
	#SEQ_DRUMON
 6

	)

304 
	#SEQ_DRUMOFF
 7

	)

305 
	#SEQ_ECHO
 8

	)

306 
	#SEQ_AFTERTOUCH
 9

	)

307 
	#SEQ_CONTROLLER
 10

	)

308 
	#CTRL_PITCH_BENDER
 255

	)

309 
	#CTRL_PITCH_BENDER_RANGE
 254

	)

310 
	#CTRL_EXPRESSION
 253

	)

311 
	#CTRL_MAIN_VOLUME
 252

	)

312 
	#SEQ_BALANCE
 11

	)

323 
	#SEQ_FULLSIZE
 0xfd

	)

344 
	#SEQ_PRIVATE
 0xã

	)

345 
	#SEQ_EXTENDED
 0xfà

	)

370 
	tsbi_š¡r_d©a
[32];

372 
	ssbi_š¡rum’t
 {

373 
	mkey
;

374 
	#FM_PATCH
 0x01fd

	)

375 
	#OPL3_PATCH
 0x03fd

	)

376 
	mdeviû
;

377 
	mchªÃl
;

378 
sbi_š¡r_d©a
 
	mİ”©Üs
;

381 
	ssyÁh_šfo
 {

382 
	mÇme
[30];

383 
	mdeviû
;

384 
	msyÁh_ty³
;

385 
	#SYNTH_TYPE_FM
 0

	)

386 
	#SYNTH_TYPE_SAMPLE
 1

	)

388 
	msyÁh_subty³
;

389 
	#FM_TYPE_ADLIB
 0x00

	)

390 
	#FM_TYPE_OPL3
 0x01

	)

392 
	#SAMPLE_TYPE_GUS
 0x10

	)

394 
	m³rc_mode
;

395 
	mÄ_voiûs
;

396 
	mÄ_drums
;

397 
	mš¡r_bªk_size
;

398 
	mÿ·b™›s
;

399 
	#SYNTH_CAP_PERCMODE
 0x00000001

	)

400 
	#SYNTH_CAP_OPL3
 0x00000002

	)

401 
	mdumm›s
[19];

404 
	smidi_šfo
 {

405 
	mÇme
[30];

406 
	mdeviû
;

407 
	mÿ·b™›s
;

408 
	mdev_ty³
;

409 
	mdumm›s
[18];

416 
	#SNDCTL_DSP_RESET
 
	`_IO
 ('P', 0)

	)

417 
	#SNDCTL_DSP_SYNC
 
	`_IO
 ('P', 1)

	)

418 
	#SNDCTL_DSP_SPEED
 
	`_IOWR
('P', 2, )

	)

419 
	#SNDCTL_DSP_STEREO
 
	`_IOWR
('P', 3, )

	)

420 
	#SNDCTL_DSP_GETBLKSIZE
 
	`_IOWR
('P', 4, )

	)

421 
	#SNDCTL_DSP_SAMPLESIZE
 
	`_IOWR
('P', 5, è

	)

422 
	#SOUND_PCM_WRITE_CHANNELS
 
	`_IOWR
('P', 6, )

	)

423 
	#SOUND_PCM_WRITE_FILTER
 
	`_IOWR
('P', 7, )

	)

424 
	#SNDCTL_DSP_POST
 
	`_IO
 ('P', 8)

	)

425 
	#SNDCTL_DSP_SUBDIVIDE
 
	`_IOWR
('P', 9, )

	)

427 
	#SOUND_PCM_READ_RATE
 
	`_IOR
 ('P', 2, )

	)

428 
	#SOUND_PCM_READ_CHANNELS
 
	`_IOR
 ('P', 6, )

	)

429 
	#SOUND_PCM_READ_BITS
 
	`_IOR
 ('P', 5, )

	)

430 
	#SOUND_PCM_READ_FILTER
 
	`_IOR
 ('P', 7, )

	)

433 
	#SOUND_PCM_WRITE_BITS
 
SNDCTL_DSP_SAMPLESIZE


	)

434 
	#SOUND_PCM_WRITE_RATE
 
SNDCTL_DSP_SPEED


	)

435 
	#SOUND_PCM_POST
 
SNDCTL_DSP_POST


	)

436 
	#SOUND_PCM_RESET
 
SNDCTL_DSP_RESET


	)

437 
	#SOUND_PCM_SYNC
 
SNDCTL_DSP_SYNC


	)

438 
	#SOUND_PCM_SUBDIVIDE
 
SNDCTL_DSP_SUBDIVIDE


	)

453 
	#SOUND_MIXER_NRDEVICES
 12

	)

454 
	#SOUND_MIXER_VOLUME
 0

	)

455 
	#SOUND_MIXER_BASS
 1

	)

456 
	#SOUND_MIXER_TREBLE
 2

	)

457 
	#SOUND_MIXER_SYNTH
 3

	)

458 
	#SOUND_MIXER_PCM
 4

	)

459 
	#SOUND_MIXER_SPEAKER
 5

	)

460 
	#SOUND_MIXER_LINE
 6

	)

461 
	#SOUND_MIXER_MIC
 7

	)

462 
	#SOUND_MIXER_CD
 8

	)

463 
	#SOUND_MIXER_IMIX
 9

	)

464 
	#SOUND_MIXER_ALTPCM
 10

	)

465 
	#SOUND_MIXER_RECLEV
 11

	)

469 
	#SOUND_ONOFF_MIN
 28

	)

470 
	#SOUND_ONOFF_MAX
 30

	)

471 
	#SOUND_MIXER_MUTE
 28

	)

472 
	#SOUND_MIXER_ENHANCE
 29

	)

473 
	#SOUND_MIXER_LOUD
 30

	)

477 
	#SOUND_DEVICE_LABELS
 {"Vol ", "Bass ", "Trebl", "Synth", "Pcm ", "Spkr ", "Line ", \

478 "Miø ", "CD ", "Mix ", "Pcm2 ", "»c"}

	)

480 
	#SOUND_DEVICE_NAMES
 {"vol", "bass", "treble", "synth", "pcm", "speaker", "line", \

481 "mic", "cd", "mix", "pcm2", "»c"}

	)

485 
	#SOUND_MIXER_RECSRC
 0xfà

	)

486 
	#SOUND_MIXER_DEVMASK
 0xã

	)

487 
	#SOUND_MIXER_RECMASK
 0xfd

	)

488 
	#SOUND_MIXER_CAPS
 0xfc

	)

489 
	#SOUND_CAP_EXCL_INPUT
 0x00000001

	)

490 
	#SOUND_MIXER_STEREODEVS
 0xfb

	)

494 
	#SOUND_MASK_VOLUME
 (1 << 
SOUND_MIXER_VOLUME
)

	)

495 
	#SOUND_MASK_BASS
 (1 << 
SOUND_MIXER_BASS
)

	)

496 
	#SOUND_MASK_TREBLE
 (1 << 
SOUND_MIXER_TREBLE
)

	)

497 
	#SOUND_MASK_SYNTH
 (1 << 
SOUND_MIXER_SYNTH
)

	)

498 
	#SOUND_MASK_PCM
 (1 << 
SOUND_MIXER_PCM
)

	)

499 
	#SOUND_MASK_SPEAKER
 (1 << 
SOUND_MIXER_SPEAKER
)

	)

500 
	#SOUND_MASK_LINE
 (1 << 
SOUND_MIXER_LINE
)

	)

501 
	#SOUND_MASK_MIC
 (1 << 
SOUND_MIXER_MIC
)

	)

502 
	#SOUND_MASK_CD
 (1 << 
SOUND_MIXER_CD
)

	)

503 
	#SOUND_MASK_IMIX
 (1 << 
SOUND_MIXER_IMIX
)

	)

504 
	#SOUND_MASK_ALTPCM
 (1 << 
SOUND_MIXER_ALTPCM
)

	)

505 
	#SOUND_MASK_RECLEV
 (1 << 
SOUND_MIXER_RECLEV
)

	)

507 
	#SOUND_MASK_MUTE
 (1 << 
SOUND_MIXER_MUTE
)

	)

508 
	#SOUND_MASK_ENHANCE
 (1 << 
SOUND_MIXER_ENHANCE
)

	)

509 
	#SOUND_MASK_LOUD
 (1 << 
SOUND_MIXER_LOUD
)

	)

511 
	#MIXER_READ
(
dev
è
	`_IOR
('M', dev, )

	)

512 
	#SOUND_MIXER_READ_VOLUME
 
	`MIXER_READ
(
SOUND_MIXER_VOLUME
)

	)

513 
	#SOUND_MIXER_READ_BASS
 
	`MIXER_READ
(
SOUND_MIXER_BASS
)

	)

514 
	#SOUND_MIXER_READ_TREBLE
 
	`MIXER_READ
(
SOUND_MIXER_TREBLE
)

	)

515 
	#SOUND_MIXER_READ_SYNTH
 
	`MIXER_READ
(
SOUND_MIXER_SYNTH
)

	)

516 
	#SOUND_MIXER_READ_PCM
 
	`MIXER_READ
(
SOUND_MIXER_PCM
)

	)

517 
	#SOUND_MIXER_READ_SPEAKER
 
	`MIXER_READ
(
SOUND_MIXER_SPEAKER
)

	)

518 
	#SOUND_MIXER_READ_LINE
 
	`MIXER_READ
(
SOUND_MIXER_LINE
)

	)

519 
	#SOUND_MIXER_READ_MIC
 
	`MIXER_READ
(
SOUND_MIXER_MIC
)

	)

520 
	#SOUND_MIXER_READ_CD
 
	`MIXER_READ
(
SOUND_MIXER_CD
)

	)

521 
	#SOUND_MIXER_READ_IMIX
 
	`MIXER_READ
(
SOUND_MIXER_IMIX
)

	)

522 
	#SOUND_MIXER_READ_ALTPCM
 
	`MIXER_READ
(
SOUND_MIXER_ALTPCM
)

	)

523 
	#SOUND_MIXER_READ_RECLEV
 
	`MIXER_READ
(
SOUND_MIXER_RECLEV
)

	)

524 
	#SOUND_MIXER_READ_MUTE
 
	`MIXER_READ
(
SOUND_MIXER_MUTE
)

	)

525 
	#SOUND_MIXER_READ_ENHANCE
 
	`MIXER_READ
(
SOUND_MIXER_ENHANCE
)

	)

526 
	#SOUND_MIXER_READ_LOUD
 
	`MIXER_READ
(
SOUND_MIXER_LOUD
)

	)

528 
	#SOUND_MIXER_READ_RECSRC
 
	`MIXER_READ
(
SOUND_MIXER_RECSRC
)

	)

529 
	#SOUND_MIXER_READ_DEVMASK
 
	`MIXER_READ
(
SOUND_MIXER_DEVMASK
)

	)

530 
	#SOUND_MIXER_READ_RECMASK
 
	`MIXER_READ
(
SOUND_MIXER_RECMASK
)

	)

531 
	#SOUND_MIXER_READ_STEREODEVS
 
	`MIXER_READ
(
SOUND_MIXER_STEREODEVS
)

	)

532 
	#SOUND_MIXER_READ_CAPS
 
	`MIXER_READ
(
SOUND_MIXER_CAPS
)

	)

534 
	#MIXER_WRITE
(
dev
è
	`_IOWR
('M', dev, )

	)

535 
	#SOUND_MIXER_WRITE_VOLUME
 
	`MIXER_WRITE
(
SOUND_MIXER_VOLUME
)

	)

536 
	#SOUND_MIXER_WRITE_BASS
 
	`MIXER_WRITE
(
SOUND_MIXER_BASS
)

	)

537 
	#SOUND_MIXER_WRITE_TREBLE
 
	`MIXER_WRITE
(
SOUND_MIXER_TREBLE
)

	)

538 
	#SOUND_MIXER_WRITE_SYNTH
 
	`MIXER_WRITE
(
SOUND_MIXER_SYNTH
)

	)

539 
	#SOUND_MIXER_WRITE_PCM
 
	`MIXER_WRITE
(
SOUND_MIXER_PCM
)

	)

540 
	#SOUND_MIXER_WRITE_SPEAKER
 
	`MIXER_WRITE
(
SOUND_MIXER_SPEAKER
)

	)

541 
	#SOUND_MIXER_WRITE_LINE
 
	`MIXER_WRITE
(
SOUND_MIXER_LINE
)

	)

542 
	#SOUND_MIXER_WRITE_MIC
 
	`MIXER_WRITE
(
SOUND_MIXER_MIC
)

	)

543 
	#SOUND_MIXER_WRITE_CD
 
	`MIXER_WRITE
(
SOUND_MIXER_CD
)

	)

544 
	#SOUND_MIXER_WRITE_IMIX
 
	`MIXER_WRITE
(
SOUND_MIXER_IMIX
)

	)

545 
	#SOUND_MIXER_WRITE_ALTPCM
 
	`MIXER_WRITE
(
SOUND_MIXER_ALTPCM
)

	)

546 
	#SOUND_MIXER_WRITE_RECLEV
 
	`MIXER_WRITE
(
SOUND_MIXER_RECLEV
)

	)

547 
	#SOUND_MIXER_WRITE_MUTE
 
	`MIXER_WRITE
(
SOUND_MIXER_MUTE
)

	)

548 
	#SOUND_MIXER_WRITE_ENHANCE
 
	`MIXER_WRITE
(
SOUND_MIXER_ENHANCE
)

	)

549 
	#SOUND_MIXER_WRITE_LOUD
 
	`MIXER_WRITE
(
SOUND_MIXER_LOUD
)

	)

551 
	#SOUND_MIXER_WRITE_RECSRC
 
	`MIXER_WRITE
(
SOUND_MIXER_RECSRC
)

	)

561 
	tS_BYTE
;

562 
	tS_FLAG
;

563 
	s¡”eo_vŞ


565 
S_BYTE
 
	ml
;

566 
S_BYTE
 
	mr
;

569 
	#MIXER_IOCTL_SET_LEVELS
 
	`_IOW
 ('s', 20, 
sb_mix”_Ëv–s
)

	)

570 
	#MIXER_IOCTL_SET_PARAMS
 
	`_IOW
 ('s', 21, 
sb_mix”_·¿ms
)

	)

571 
	#MIXER_IOCTL_READ_LEVELS
 
	`_IOR
 ('s', 22, 
sb_mix”_Ëv–s
)

	)

572 
	#MIXER_IOCTL_READ_PARAMS
 
	`_IOR
 ('s', 23, 
sb_mix”_·¿ms
)

	)

573 
	#MIXER_IOCTL_RESET
 
	`_IO
 ('s', 24)

	)

578 
	ssb_mix”_Ëv–s


580 
¡”eo_vŞ
 
	mma¡”
;

581 
¡”eo_vŞ
 
	mvoc
;

582 
¡”eo_vŞ
 
	mfm
;

583 
¡”eo_vŞ
 
	mlše
;

584 
¡”eo_vŞ
 
	mcd
;

585 
S_BYTE
 
	mmic
;

591 
	ssb_mix”_·¿ms


593 
S_BYTE
 
	m»cÜd_sourû
;

594 
S_FLAG
 
	mhiäeq_f‹r
;

595 
S_FLAG
 
	mf‹r_šput
;

596 
S_FLAG
 
	mf‹r_ouut
;

597 
S_FLAG
 
	md¥_¡”eo
;

600 
	#SRC_MIC
 1

	)

601 
	#SRC_CD
 3

	)

602 
	#SRC_LINE
 7

	)

604 #ià!
defšed
(
KERNEL
è&& !defšed(
INKERNEL
)

612 
£qbuf_dump
();

633 
	#SEQ_DEFINEBUF
(
Ën
è
_£qbuf
[Ën]; 
_£qbuæ’
 =†’, 
_£qbuåŒ
 = 0

	)

634 
	#SEQ_PM_DEFINES
 
·tmgr_šfo
 
_pm_šfo


	)

635 
	#_SEQ_NEEDBUF
(
Ën
èià((
_£qbuåŒ
+Ö’)è> 
_£qbuæ’
è
	`£qbuf_dump
()

	)

636 
	#_SEQ_ADVBUF
(
Ën
è
_£qbuåŒ
 +ğ
	)
len

637 
	#SEQ_DUMPBUF
 
£qbuf_dump


	)

638 
	#PM_LOAD_PATCH
(
dev
, 
bªk
, 
pgm
è(
	`SEQ_DUMPBUF
(), 
_pm_šfo
.
commªd
 = 
_PM_LOAD_PATCH
, \

639 
_pm_šfo
.
deviû
=
dev
, _pm_šfo.
d©a
.
d©a8
[0]=
pgm
, \

640 
_pm_šfo
.
·rm1
 = 
bªk
, _pm_šfo.
·rm2
 = 1, \

641 
	`ioùl
(
£qfd
, 
SNDCTL_PMGR_ACCESS
, &
_pm_šfo
))

	)

642 
	#PM_LOAD_PATCHES
(
dev
, 
bªk
, 
pgm
è(
	`SEQ_DUMPBUF
(), 
_pm_šfo
.
commªd
 = 
_PM_LOAD_PATCH
, \

643 
_pm_šfo
.
deviû
=
dev
, 
	`memıy
(_pm_šfo.
d©a
.
d©a8
, 
pgm
, 128), \

644 
_pm_šfo
.
·rm1
 = 
bªk
, _pm_šfo.
·rm2
 = 128, \

645 
	`ioùl
(
£qfd
, 
SNDCTL_PMGR_ACCESS
, &
_pm_šfo
))

	)

647 
	#SEQ_START_NOTE
(
dev
, 
voiû
, 
nÙe
, 
vŞ
è{
	`_SEQ_NEEDBUF
(8);\

648 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

649 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_NOTEON
;\

650 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

651 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

652 
_£qbuf
[
_£qbuåŒ
+4] = (
nÙe
);\

653 
_£qbuf
[
_£qbuåŒ
+5] = (
vŞ
);\

654 
_£qbuf
[
_£qbuåŒ
+6] = 0;\

655 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

656 
	`_SEQ_ADVBUF
(8);}

	)

658 
	#SEQ_STOP_NOTE
(
dev
, 
voiû
, 
nÙe
, 
vŞ
è{
	`_SEQ_NEEDBUF
(8);\

659 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

660 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_NOTEOFF
;\

661 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

662 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

663 
_£qbuf
[
_£qbuåŒ
+4] = (
nÙe
);\

664 
_£qbuf
[
_£qbuåŒ
+5] = (
vŞ
);\

665 
_£qbuf
[
_£qbuåŒ
+6] = 0;\

666 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

667 
	`_SEQ_ADVBUF
(8);}

	)

669 
	#SEQ_CHN_PRESSURE
(
dev
, 
voiû
, 
´essu»
è{
	`_SEQ_NEEDBUF
(8);\

670 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

671 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_AFTERTOUCH
;\

672 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

673 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

674 
_£qbuf
[
_£qbuåŒ
+4] = (
´essu»
);\

675 
_£qbuf
[
_£qbuåŒ
+5] = 0;\

676 
_£qbuf
[
_£qbuåŒ
+6] = 0;\

677 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

678 
	`_SEQ_ADVBUF
(8);}

	)

680 
	#SEQ_PANNING
(
dev
, 
voiû
, 
pos
è{
	`_SEQ_NEEDBUF
(8);\

681 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

682 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_BALANCE
;\

683 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

684 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

685 ()
_£qbuf
[
_£qbuåŒ
+4] = (
pos
);\

686 
_£qbuf
[
_£qbuåŒ
+5] = 0;\

687 
_£qbuf
[
_£qbuåŒ
+6] = 0;\

688 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

689 
	`_SEQ_ADVBUF
(8);}

	)

691 
	#SEQ_CONTROL
(
dev
, 
voiû
, 
cÚŒŞËr
, 
v®ue
è{
	`_SEQ_NEEDBUF
(8);\

692 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

693 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_CONTROLLER
;\

694 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

695 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

696 
_£qbuf
[
_£qbuåŒ
+4] = (
cÚŒŞËr
);\

697 *(*)&
_£qbuf
[
_£qbuåŒ
+5] = (
v®ue
);\

698 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

699 
	`_SEQ_ADVBUF
(8);}

	)

701 
	#SEQ_PITCHBEND
(
dev
, 
voiû
, 
v®ue
è
	`SEQ_CONTROL
(dev, voiû, 
CTRL_PITCH_BENDER
, v®ue)

	)

702 
	#SEQ_BENDER_RANGE
(
dev
, 
voiû
, 
v®ue
è
	`SEQ_CONTROL
(dev, voiû, 
CTRL_PITCH_BENDER_RANGE
, v®ue)

	)

703 
	#SEQ_EXPRESSION
(
dev
, 
voiû
, 
v®ue
è
	`SEQ_CONTROL
(dev, voiû, 
CTRL_EXPRESSION
, v®ue)

	)

704 
	#SEQ_MAIN_VOLUME
(
dev
, 
voiû
, 
v®ue
è
	`SEQ_CONTROL
(dev, voiû, 
CTRL_MAIN_VOLUME
, v®ue)

	)

706 
	#SEQ_START_TIMER
(è{
	`_SEQ_NEEDBUF
(4);\

707 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_SYNCTIMER
;\

708 
_£qbuf
[
_£qbuåŒ
+1] = 0;\

709 
_£qbuf
[
_£qbuåŒ
+2] = 0;\

710 
_£qbuf
[
_£qbuåŒ
+3] = 0;\

711 
	`_SEQ_ADVBUF
(4);}

	)

712 
	#SEQ_SET_PATCH
(
dev
, 
voiû
, 
·tch
è{
	`_SEQ_NEEDBUF
(8);\

713 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_EXTENDED
;\

714 
_£qbuf
[
_£qbuåŒ
+1] = 
SEQ_PGMCHANGE
;\

715 
_£qbuf
[
_£qbuåŒ
+2] = (
dev
);\

716 
_£qbuf
[
_£qbuåŒ
+3] = (
voiû
);\

717 
_£qbuf
[
_£qbuåŒ
+4] = (
·tch
);\

718 
_£qbuf
[
_£qbuåŒ
+5] = 0;\

719 
_£qbuf
[
_£qbuåŒ
+6] = 0;\

720 
_£qbuf
[
_£qbuåŒ
+7] = 0;\

721 
	`_SEQ_ADVBUF
(8);}

	)

723 
	#SEQ_WAIT_TIME
(
ticks
è{
	`_SEQ_NEEDBUF
(4);\

724 *(*)&
_£qbuf
[
_£qbuåŒ
] = 
SEQ_WAIT
 | ((
ticks
) << 8);\

725 
	`_SEQ_ADVBUF
(4);}

	)

727 
	#SEQ_ECHO_BACK
(
key
è{
	`_SEQ_NEEDBUF
(4);\

728 *(*)&
_£qbuf
[
_£qbuåŒ
] = 
SEQ_ECHO
 | ((
key
) << 8);\

729 
	`_SEQ_ADVBUF
(4);}

	)

731 
	#SEQ_MIDIOUT
(
deviû
, 
by‹
è{
	`_SEQ_NEEDBUF
(4);\

732 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_MIDIPUTC
;\

733 
_£qbuf
[
_£qbuåŒ
+1] = (
by‹
);\

734 
_£qbuf
[
_£qbuåŒ
+2] = (
deviû
);\

735 
_£qbuf
[
_£qbuåŒ
+3] = 0;\

736 
	`_SEQ_ADVBUF
(4);}

	)

737 
	#SEQ_WRPATCH
(
·tch
, 
Ën
è{ià(
_£qbuåŒ
è
	`£qbuf_dump
();\

738 ià(
	`wr™e
(
£qfd
, (*)(
·tch
), 
Ën
)==-1) \

739 
	`³¼Ü
("Wr™·tch: /dev/£qu’ûr");}

	)

742 
soundÿrd_š™
(
mem_¡¬t
);

	@include/linux/stat.h

1 #iâdeà
_LINUX_STAT_H


2 
	#_LINUX_STAT_H


	)

4 #ifdeà
__KERNEL__


6 
	sŞd_¡©
 {

7 
	m¡_dev
;

8 
	m¡_šo
;

9 
	m¡_mode
;

10 
	m¡_Æšk
;

11 
	m¡_uid
;

12 
	m¡_gid
;

13 
	m¡_rdev
;

14 
	m¡_size
;

15 
	m¡_©ime
;

16 
	m¡_mtime
;

17 
	m¡_ùime
;

20 
	sÃw_¡©
 {

21 
	m¡_dev
;

22 
	m__·d1
;

23 
	m¡_šo
;

24 
	m¡_mode
;

25 
	m¡_Æšk
;

26 
	m¡_uid
;

27 
	m¡_gid
;

28 
	m¡_rdev
;

29 
	m__·d2
;

30 
	m¡_size
;

31 
	m¡_blksize
;

32 
	m¡_blocks
;

33 
	m¡_©ime
;

34 
	m__unu£d1
;

35 
	m¡_mtime
;

36 
	m__unu£d2
;

37 
	m¡_ùime
;

38 
	m__unu£d3
;

39 
	m__unu£d4
;

40 
	m__unu£d5
;

45 
	#S_IFMT
 00170000

	)

46 
	#S_IFSOCK
 0140000

	)

47 
	#S_IFLNK
 0120000

	)

48 
	#S_IFREG
 0100000

	)

49 
	#S_IFBLK
 0060000

	)

50 
	#S_IFDIR
 0040000

	)

51 
	#S_IFCHR
 0020000

	)

52 
	#S_IFIFO
 0010000

	)

53 
	#S_ISUID
 0004000

	)

54 
	#S_ISGID
 0002000

	)

55 
	#S_ISVTX
 0001000

	)

57 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

58 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFREG
)

	)

59 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

60 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

61 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFBLK
)

	)

62 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

63 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

65 
	#S_IRWXU
 00700

	)

66 
	#S_IRUSR
 00400

	)

67 
	#S_IWUSR
 00200

	)

68 
	#S_IXUSR
 00100

	)

70 
	#S_IRWXG
 00070

	)

71 
	#S_IRGRP
 00040

	)

72 
	#S_IWGRP
 00020

	)

73 
	#S_IXGRP
 00010

	)

75 
	#S_IRWXO
 00007

	)

76 
	#S_IROTH
 00004

	)

77 
	#S_IWOTH
 00002

	)

78 
	#S_IXOTH
 00001

	)

80 #ifdeà
__KERNEL__


81 
	#S_IRWXUGO
 (
S_IRWXU
|
S_IRWXG
|
S_IRWXO
)

	)

82 
	#S_IALLUGO
 (
S_ISUID
|
S_ISGID
|
S_ISVTX
|
S_IRWXUGO
)

	)

83 
	#S_IRUGO
 (
S_IRUSR
|
S_IRGRP
|
S_IROTH
)

	)

84 
	#S_IWUGO
 (
S_IWUSR
|
S_IWGRP
|
S_IWOTH
)

	)

85 
	#S_IXUGO
 (
S_IXUSR
|
S_IXGRP
|
S_IXOTH
)

	)

	@include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

4 #iâdeà
_SIZE_T


5 
	#_SIZE_T


	)

6 
	tsize_t
;

9 #undeà
NULL


10 
	#NULL
 ((*)0)

	)

12 #undeà
off£tof


13 
	#off£tof
(
TYPE
, 
MEMBER
è((
size_t
è&((TYPE *)0)->MEMBER)

	)

	@include/linux/string.h

1 #iâdeà
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

4 
	~<lšux/ty³s.h
>

6 #iâdeà
NULL


7 
	#NULL
 ((*è0)

	)

22 
šlše
 * 
	$¡rıy
(* 
de¡
,cÚ¡ *
¤c
)

24 
	`__asm__
("cld\n"

30 :"S" (
¤c
),"D" (
de¡
):"si","di","ax","memory");

31  
de¡
;

32 
	}
}

34 
šlše
 * 
	$¡ºıy
(* 
de¡
,cÚ¡ *
¤c
,
size_t
 
couÁ
)

36 
	`__asm__
("cld\n"

47 :"S" (
¤c
),"D" (
de¡
),"c" (
couÁ
):"si","di","ax","cx","memory");

48  
de¡
;

49 
	}
}

51 
šlše
 * 
	$¡rÿt
(* 
de¡
,cÚ¡ * 
¤c
)

53 
	`__asm__
("cld\n\t"

62 :"S" (
¤c
),"D" (
de¡
),"a" (0),"c" (0xffffffff):"si","di","ax","cx");

63  
de¡
;

64 
	}
}

66 
šlše
 * 
	$¡ºÿt
(* 
de¡
,cÚ¡ * 
¤c
,
size_t
 
couÁ
)

68 
	`__asm__
("cld\n\t"

82 :"S" (
¤c
),"D" (
de¡
),"a" (0),"c" (0xffffffff),"g" (
couÁ
)

84  
de¡
;

85 
	}
}

87 
šlše
 
	$¡rcmp
(cÚ¡ * 
cs
,cÚ¡ * 
ù
)

89 
__»s
 
	`__asm__
("ax");

90 
	`__asm__
("cld\n"

102 :"÷" (
__»s
):"D" (
cs
),"S" (
ù
):"si","di");

103  
__»s
;

104 
	}
}

106 
šlše
 
	$¡ºcmp
(cÚ¡ * 
cs
,cÚ¡ * 
ù
,
size_t
 
couÁ
)

108 
__»s
 
	`__asm__
("ax");

109 
	`__asm__
("cld\n"

123 :"÷" (
__»s
):"D" (
cs
),"S" (
ù
),"c" (
couÁ
):"si","di","cx");

124  
__»s
;

125 
	}
}

127 
šlše
 * 
	$¡rchr
(cÚ¡ * 
s
,
c
)

129 * 
__»s
 
	`__asm__
("ax");

130 
	`__asm__
("cld\n\t"

140 :"÷" (
__»s
):"S" (
s
),"0" (
c
):"si");

141  
__»s
;

142 
	}
}

144 
šlše
 * 
	$¡¼chr
(cÚ¡ * 
s
,
c
)

146 * 
__»s
 
	`__asm__
("dx");

147 
	`__asm__
("cld\n\t"

156 :"=d" (
__»s
):"0" (0),"S" (
s
),"a" (
c
):"ax","si");

157  
__»s
;

158 
	}
}

160 
šlše
 
size_t
 
	$¡r¥n
(cÚ¡ * 
cs
, cÚ¡ * 
ù
)

162 * 
__»s
 
	`__asm__
("si");

163 
	`__asm__
("cld\n\t"

179 :"=S" (
__»s
):"a" (0),"c" (0xffffffff),"0" (
cs
),"g" (
ù
)

181  
__»s
-
cs
;

182 
	}
}

184 
šlše
 
size_t
 
	$¡rc¥n
(cÚ¡ * 
cs
, cÚ¡ * 
ù
)

186 * 
__»s
 
	`__asm__
("si");

187 
	`__asm__
("cld\n\t"

203 :"=S" (
__»s
):"a" (0),"c" (0xffffffff),"0" (
cs
),"g" (
ù
)

205  
__»s
-
cs
;

206 
	}
}

208 
šlše
 * 
	$¡½brk
(cÚ¡ * 
cs
,cÚ¡ * 
ù
)

210 * 
__»s
 
	`__asm__
("si");

211 
	`__asm__
("cld\n\t"

230 :"=S" (
__»s
):"a" (0),"c" (0xffffffff),"0" (
cs
),"g" (
ù
)

232  
__»s
;

233 
	}
}

235 
šlše
 * 
	$¡r¡r
(cÚ¡ * 
cs
,cÚ¡ * 
ù
)

237 * 
__»s
 
	`__asm__
("ax");

238 
	`__asm__
("cld\n\t" \

257 :"÷" (
__»s
):"0" (0),"c" (0xffffffff),"S" (
cs
),"g" (
ù
)

259  
__»s
;

260 
	}
}

262 
šlše
 
size_t
 
	$¡¾’
(cÚ¡ * 
s
)

264 
__»s
 
	`__asm__
("cx");

265 
	`__asm__
("cld\n\t"

270 :"=c" (
__»s
):"D" (
s
),"a" (0),"0" (0xffffffff):"di");

271  
__»s
;

272 
	}
}

274 * 
___¡¹ok
;

276 
šlše
 * 
	$¡¹ok
(* 
s
,cÚ¡ * 
ù
)

278 * 
__»s
;

279 
	`__asm__
("testl %1,%1\n\t"

329 :"=b" (
__»s
),"=S" (
___¡¹ok
)

330 :"0" (
___¡¹ok
),"1" (
s
),"g" (
ù
)

332  
__»s
;

333 
	}
}

335 
šlše
 * 
	$memıy
(* 
to
, cÚ¡ * 
äom
, 
size_t
 
n
)

337 
	`__asm__
("cld\n\t"

349 :"d" (
n
),"D" ((è
to
),"S" ((è
äom
)

351  (
to
);

352 
	}
}

354 
šlše
 * 
	$memmove
(* 
de¡
,cÚ¡ * 
¤c
, 
size_t
 
n
)

356 ià(
de¡
<
¤c
)

357 
	`__asm__
("cld\n\t"

361 :"c" (
n
),"S" (
¤c
),"D" (
de¡
)

364 
	`__asm__
("std\n\t"

369 :"c" (
n
),

370 "S" (
n
-1+(cÚ¡ *)
¤c
),

371 "D" (
n
-1+(*)
de¡
)

373  
de¡
;

374 
	}
}

376 
šlše
 
	$memcmp
(cÚ¡ * 
cs
,cÚ¡ * 
ù
,
size_t
 
couÁ
)

378 
__»s
 
	`__asm__
("ax");

379 
	`__asm__
("cld\n\t"

387 :"÷" (
__»s
):"0" (0),"D" (
cs
),"S" (
ù
),"c" (
couÁ
)

389  
__»s
;

390 
	}
}

392 
šlše
 * 
	$memchr
(cÚ¡ * 
cs
,
c
,
size_t
 
couÁ
)

394 * 
__»s
 
	`__asm__
("di");

395 ià(!
couÁ
)

396  
NULL
;

397 
	`__asm__
("cld\n\t"

403 :"=D" (
__»s
):"a" (
c
),"D" (
cs
),"c" (
couÁ
)

405  
__»s
;

406 
	}
}

408 
šlše
 * 
	$mem£t
(* 
s
,
c
,
size_t
 
couÁ
)

410 
	`__asm__
("cld\n\t"

414 :"a" (
c
),"D" (
s
),"c" (
couÁ
)

416  
s
;

417 
	}
}

	@include/linux/sys.h

1 #iâdeà
_LINUX_SYS_H


2 
	#_LINUX_SYS_H


	)

7 
	#sys_şÚe
 
sys_fÜk


	)

9 #ifdeà
__ılu¥lus


13 
sys_£tup
();

14 
sys_ex™
();

15 
sys_fÜk
();

16 
sys_»ad
();

17 
sys_wr™e
();

18 
sys_İ’
();

19 
sys_şo£
();

20 
sys_wa™pid
();

21 
sys_ü—t
();

22 
sys_lšk
();

23 
sys_uÆšk
();

24 
sys_execve
();

25 
sys_chdœ
();

26 
sys_time
();

27 
sys_mknod
();

28 
sys_chmod
();

29 
sys_chown
();

30 
sys_b»ak
();

31 
sys_¡©
();

32 
sys_l£ek
();

33 
sys_g‘pid
();

34 
sys_mouÁ
();

35 
sys_umouÁ
();

36 
sys_£tuid
();

37 
sys_g‘uid
();

38 
sys_¡ime
();

39 
sys_±¿û
();

40 
sys_®¬m
();

41 
sys_f¡©
();

42 
sys_·u£
();

43 
sys_utime
();

44 
sys_¡ty
();

45 
sys_g‰y
();

46 
sys_acûss
();

47 
sys_niû
();

48 
sys_áime
();

49 
sys_sync
();

50 
sys_kl
();

51 
sys_»Çme
();

52 
sys_mkdœ
();

53 
sys_rmdœ
();

54 
sys_dup
();

55 
sys_pe
();

56 
sys_times
();

57 
sys_´of
();

58 
sys_brk
();

59 
sys_£tgid
();

60 
sys_g‘gid
();

61 
sys_sigÇl
();

62 
sys_g‘euid
();

63 
sys_g‘egid
();

64 
sys_acù
();

65 
sys_phys
();

66 
sys_lock
();

67 
sys_ioùl
();

68 
sys_fú
();

69 
sys_mpx
();

70 
sys_£gid
();

71 
sys_ulim™
();

72 
sys_uÇme
();

73 
sys_umask
();

74 
sys_chroÙ
();

75 
sys_u¡©
();

76 
sys_dup2
();

77 
sys_g‘µid
();

78 
sys_g‘pg½
();

79 
sys_£tsid
();

80 
sys_sigaùiÚ
();

81 
sys_sg‘mask
();

82 
sys_s£tmask
();

83 
sys_£Œeuid
();

84 
sys_£Œegid
();

85 
sys_sig³ndšg
();

86 
sys_sigsu¥’d
();

87 
sys_£tho¡Çme
();

88 
sys_£Œlim™
();

89 
sys_g‘¾im™
();

90 
sys_g‘ru§ge
();

91 
sys_g‘timeofday
();

92 
sys_£‰imeofday
();

93 
sys_g‘groups
();

94 
sys_£tgroups
();

95 
sys_£Ëù
();

96 
sys_symlšk
();

97 
sys_l¡©
();

98 
sys_»adlšk
();

99 
sys_u£lib
();

100 
sys_sw­Ú
();

101 
sys_»boÙ
();

102 
sys_»addœ
();

103 
sys_mm­
();

104 
sys_munm­
();

105 
sys_Œunÿ‹
();

106 
sys_árunÿ‹
();

107 
sys_fchmod
();

108 
sys_fchown
();

109 
sys_g‘´iÜ™y
();

110 
sys_£riÜ™y
();

111 
sys_´of
();

112 
sys_¡©fs
();

113 
sys_f¡©fs
();

114 
sys_iİ”m
();

115 
sys_sock‘ÿÎ
();

116 
sys_sy¦og
();

117 
sys_g‘™im”
();

118 
sys_£t™im”
();

119 
sys_Ãw¡©
();

120 
sys_Ãwl¡©
();

121 
sys_Ãwf¡©
();

122 
sys_ÃwuÇme
();

123 
sys_iİl
();

124 
sys_vhªgup
();

125 
sys_idË
();

126 
sys_vm86
();

127 
sys_wa™4
();

128 
sys_sw­off
();

129 
sys_sysšfo
();

130 
sys_c
();

131 
sys_fsync
();

132 
sys_sig»tuº
();

133 
sys_£tdomašÇme
();

134 
sys_ŞduÇme
();

135 
sys_Şd_sysÿÎ
();

136 
sys_modify_ldt
();

137 
sys_adjtimex
();

138 
sys_m´Ùeù
();

139 
sys_sig´ocmask
();

140 
sys_ü—‹_moduË
();

141 
sys_š™_moduË
();

142 
sys_d–‘e_moduË
();

143 
sys_g‘_k”Ãl_syms
();

144 
sys_quÙaùl
();

145 
sys_g‘pgid
();

146 
sys_fchdœ
();

147 
sys_bdæush
();

153 #ifdeà
nÙdef


154 
	#sys_wa™pid
 
sys_Şd_sysÿÎ


	)

155 
	#sys_ŞduÇme
 
sys_Şd_sysÿÎ


	)

156 
	#sys_uÇme
 
sys_Şd_sysÿÎ


	)

157 
	#sys_¡©
 
sys_Şd_sysÿÎ


	)

158 
	#sys_f¡©
 
sys_Şd_sysÿÎ


	)

159 
	#sys_l¡©
 
sys_Şd_sysÿÎ


	)

160 
	#sys_sigÇl
 
sys_Şd_sysÿÎ


	)

161 
	#sys_sg‘mask
 
sys_Şd_sysÿÎ


	)

162 
	#sys_s£tmask
 
sys_Şd_sysÿÎ


	)

170 
	#sys_quÙaùl
 
sys_ni_sysÿÎ


	)

171 
	#sys_bdæush
 
sys_ni_sysÿÎ


	)

173 (*
	gâ_±r
)();

175 #ifdeà
__ılu¥lus


	@include/linux/sysv_fs.h

1 #iâdeà
_LINUX_SYSV_FS_H


2 
	#_LINUX_SYSV_FS_H


	)

15 #ifdeà
__GNUC__


16 
	#__·cked2__
 
	`__©Œibu‹__
 ((
·cked
, 
	`®igÃd
(2)))

	)

18 #”rÜ 
I
 
wªt
 
gcc
!

21 
	~<lšux/¡©.h
>

22 
	~<lšux/sched.h
>

23 
	~<lšux/sysv_fs_sb.h
>

40 
	tcoh_ulÚg
;

42 
šlše
 
coh_ulÚg
 
	$to_coh_ulÚg
 (
x
)

44  ((
x
 & 0xffff) << 16) | ((x & 0xffff0000) >> 16);

45 
	}
}

47 
šlše
 
	$äom_coh_ulÚg
 (
coh_ulÚg
 
x
)

49  ((
x
 & 0xffff) << 16) | ((x & 0xffff0000) >> 16);

50 
	}
}

54 
	tsysv_šo_t
;

61 
	tsysv_zÚe_t
;

70 
	#SYSV_BADBL_INO
 1

	)

71 
	#SYSV_ROOT_INO
 2

	)

75 
	#XENIX_NICINOD
 100

	)

76 
	#XENIX_NICFREE
 100

	)

77 
	sx’ix_su³r_block
 {

78 
	ms_isize
;

79 
s_fsize
 
	m__·cked2__
;

81 
	ms_nä“
;

82 
	ms_ä“
[
XENIX_NICFREE
];

84 
	ms_nšode
;

85 
sysv_šo_t
 
	ms_šode
[
XENIX_NICINOD
];

87 
	ms_æock
;

88 
	ms_ock
;

89 
	ms_fmod
;

90 
	ms_rÚly
;

91 
s_time
 
	m__·cked2__
;

92 
s_tä“
 
	m__·cked2__
;

93 
	ms_tšode
;

94 
	ms_dšfo
[4];

95 
	ms_âame
[6];

96 
	ms_åack
[6];

97 
	ms_ş—n
;

98 
	ms_fl
[371];

99 
	ms_magic
;

100 
	ms_ty³
;

105 
	sx’ix_ä“li¡_chunk
 {

106 
	mæ_nä“
;

107 
	mæ_ä“
[
XENIX_NICFREE
] 
	m__·cked2__
;

114 
	#SYSV_NICINOD
 100

	)

115 
	#SYSV_NICFREE
 50

	)

118 
	ssysv4_su³r_block
 {

119 
	ms_isize
;

120 
	ms_fsize
;

122 
	ms_nä“
;

123 
	ms_ä“
[
SYSV_NICFREE
];

125 
	ms_nšode
;

126 
sysv_šo_t
 
	ms_šode
[
SYSV_NICINOD
];

128 
	ms_æock
;

129 
	ms_ock
;

130 
	ms_fmod
;

131 
	ms_rÚly
;

132 
	ms_time
;

133 
	ms_dšfo
[4];

134 
	ms_tä“
;

135 
	ms_tšode
;

136 
	ms_âame
[6];

137 
	ms_åack
[6];

138 
	ms_fl
[12];

139 
	ms_¡©e
;

140 
	ms_magic
;

141 
	ms_ty³
;

146 
	ssysv4_ä“li¡_chunk
 {

147 
	mæ_nä“
;

148 
	mæ_ä“
[
SYSV_NICFREE
];

152 
	ssysv2_su³r_block
 {

153 
	ms_isize
;

154 
s_fsize
 
	m__·cked2__
;

156 
	ms_nä“
;

157 
	ms_ä“
[
SYSV_NICFREE
];

159 
	ms_nšode
;

160 
sysv_šo_t
 
	ms_šode
[
SYSV_NICINOD
];

162 
	ms_æock
;

163 
	ms_ock
;

164 
	ms_fmod
;

165 
	ms_rÚly
;

166 
s_time
 
	m__·cked2__
;

167 
	ms_dšfo
[4];

168 
s_tä“
 
	m__·cked2__
;

169 
	ms_tšode
;

170 
	ms_âame
[6];

171 
	ms_åack
[6];

172 
	ms_fl
[14];

173 
	ms_¡©e
;

174 
	ms_magic
;

175 
	ms_ty³
;

180 
	ssysv2_ä“li¡_chunk
 {

181 
	mæ_nä“
;

182 
	mæ_ä“
[
SYSV_NICFREE
] 
	m__·cked2__
;

186 
	#COH_NICINOD
 100

	)

187 
	#COH_NICFREE
 64

	)

188 
	scoh_su³r_block
 {

189 
	ms_isize
;

190 
coh_ulÚg
 
s_fsize
 
	m__·cked2__
;

192 
	ms_nä“
;

193 
coh_ulÚg
 
	ms_ä“
[
COH_NICFREE
] 
	m__·cked2__
;

195 
	ms_nšode
;

196 
sysv_šo_t
 
	ms_šode
[
COH_NICINOD
];

198 
	ms_æock
;

199 
	ms_ock
;

200 
	ms_fmod
;

201 
	ms_rÚly
;

202 
coh_ulÚg
 
s_time
 
	m__·cked2__
;

203 
coh_ulÚg
 
s_tä“
 
	m__·cked2__
;

204 
	ms_tšode
;

205 
	ms_š‹¾—ve_m
;

206 
	ms_š‹¾—ve_n
;

207 
	ms_âame
[6];

208 
	ms_åack
[6];

209 
	ms_unique
;

213 
	scoh_ä“li¡_chunk
 {

214 
	mæ_nä“
;

215 
	mæ_ä“
[
COH_NICFREE
] 
	m__·cked2__
;

221 
	ssysv_šode
 {

222 
	mi_mode
;

223 
	mi_Æšk
;

224 
	mi_uid
;

225 
	mi_gid
;

226 
	mi_size
;

228 
	mi_addb
[3*(10+1+1+1)+1];

235 
dev_t
 
	mi_rdev
;

238 
	mp_addp
[30];

239 
	mp_²c
;

240 
	mp_´x
;

241 
	mp_pwx
;

242 } 
	mi_p
;

243 } 
	mi_a
;

244 
	mi_©ime
;

245 
	mi_mtime
;

246 
	mi_ùime
;

277 
	#COH_KLUDGE_SYMLINK_MODE
 (
S_IFREG
 | 
S_ISVTX
)

	)

278 
	#COH_KLUDGE_NOT_SYMLINK
 (
S_IFREG
 | 
S_ISVTX
 | 
S_IRUSR
è

	)

279 
šlše
 
mode_t
 
	$äom_coh_imode
(
mode
)

281 ià(
mode
 =ğ
COH_KLUDGE_SYMLINK_MODE
)

282  (
S_IFLNK
 | 0777);

284  
mode
;

285 
	}
}

286 
šlše
 
	$to_coh_imode
(
mode_t
 
mode
)

288 ià(
	`S_ISLNK
(
mode
))

289  
COH_KLUDGE_SYMLINK_MODE
;

290 ià(
mode
 =ğ
COH_KLUDGE_SYMLINK_MODE
)

291  
COH_KLUDGE_NOT_SYMLINK
;

293  
mode
;

294 
	}
}

297 
	#XENIX_LINK_MAX
 126

	)

298 
	#SYSV_LINK_MAX
 126

	)

299 
	#COH_LINK_MAX
 10000

	)

309 
	#SYSV_NAMELEN
 14

	)

311 
	ssysv_dœ_’Œy
 {

312 
sysv_šo_t
 
šode
;

313 
Çme
[
SYSV_NAMELEN
];

316 
	#SYSV_DIRSIZE
 (
sysv_dœ_’Œy
è

	)

324 
	#FSTYPE_XENIX
 1

	)

325 
	#FSTYPE_SYSV4
 2

	)

326 
	#FSTYPE_SYSV2
 3

	)

327 
	#FSTYPE_COH
 4

	)

329 
	#SYSV_MAGIC_BASE
 0x012FF7B3

	)

331 
	#XENIX_SUPER_MAGIC
 (
SYSV_MAGIC_BASE
+
FSTYPE_XENIX
)

	)

332 
	#SYSV4_SUPER_MAGIC
 (
SYSV_MAGIC_BASE
+
FSTYPE_SYSV4
)

	)

333 
	#SYSV2_SUPER_MAGIC
 (
SYSV_MAGIC_BASE
+
FSTYPE_SYSV2
)

	)

334 
	#COH_SUPER_MAGIC
 (
SYSV_MAGIC_BASE
+
FSTYPE_COH
)

	)

341 
	sbh_d©a
 {

342 
bufãr_h—d
 * 
	mbh
;

343 * 
	mbh_d©a
;

351 
šlše
 
bufãr_h—d
 *

352 
	$sysv_b»ad
 (
su³r_block
 *
sb
, 
dev
, 
block
, * * 
d©a
)

354 
bufãr_h—d
 *
bh
;

356 ià(!(
bh
 = 
	`b»ad
 (
dev
, (
block
 >> 
sb
->
sv_block_size_¿tio_b™s
è+ sb->
sv_block_ba£
, 
BLOCK_SIZE
)))

357  
NULL
;

358 *
d©a
 = 
bh
->
b_d©a
 + ((
block
 & 
sb
->
sv_block_size_¿tio_1
è<< sb->
sv_block_size_b™s
);

359  
bh
;

360 
	}
}

365 
_coh_wa™_Ú_šode
 (
šode
 * inode);

367 
šlše
 
	$coh_wa™_Ú_šode
 (
šode
 * inode)

369 ià(
šode
->
u
.
sysv_i
.
i_lock
)

370 
	`_coh_wa™_Ú_šode
(
šode
);

371 
	}
}

373 
šlše
 
	$coh_lock_šode
 (
šode
 * inode)

375 ià(
šode
->
u
.
sysv_i
.
i_lock
)

376 
	`_coh_wa™_Ú_šode
(
šode
);

377 
šode
->
u
.
sysv_i
.
i_lock
 = 1;

378 
	}
}

380 
šlše
 
	$coh_uÆock_šode
 (
šode
 * inode)

382 
šode
->
u
.
sysv_i
.
i_lock
 = 0;

383 
	`wake_up
(&
šode
->
u
.
sysv_i
.
i_wa™
);

384 
	}
}

391 
sysv_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

392 
šode
 ** 
»suÉ
);

393 
sysv_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

394 
šode
 ** 
»suÉ
);

395 
sysv_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
);

396 
sysv_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

397 
sysv_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

398 
sysv_symlšk
(
šode
 * inode, cÚ¡ * 
Çme
, 
Ën
,

399 cÚ¡ * 
symÇme
);

400 
sysv_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

401 
sysv_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
, 
rdev
);

402 
sysv_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
, 
Şd_Ën
,

403 
šode
 * 
Ãw_dœ
, cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
);

404 
šode
 * 
sysv_Ãw_šode
(cÚ¡ šod* 
dœ
);

405 
sysv_ä“_šode
(
šode
 * inode);

406 
sysv_couÁ_ä“_šodes
(
su³r_block
 *
sb
);

407 
sysv_Ãw_block
(
su³r_block
 * 
sb
);

408 
sysv_ä“_block
(
su³r_block
 * 
sb
, 
block
);

409 
sysv_couÁ_ä“_blocks
(
su³r_block
 *
sb
);

411 
sysv_bm­
(
šode
 *,);

413 
bufãr_h—d
 * 
sysv_g‘blk
(
šode
 *, , , * *);

414 
bufãr_h—d
 * 
sysv_fe_b»ad
(
šode
 *, , , * *);

416 
sysv_Œunÿ‹
(
šode
 *);

417 
sysv_put_su³r
(
su³r_block
 *);

418 
su³r_block
 *
sysv_»ad_su³r
(super_block *,*,);

419 
sysv_wr™e_su³r
(
su³r_block
 *);

420 
sysv_»ad_šode
(
šode
 *);

421 
sysv_nÙify_chªge
(,
šode
 *);

422 
sysv_wr™e_šode
(
šode
 *);

423 
sysv_put_šode
(
šode
 *);

424 
sysv_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

425 
sysv_sync_šode
(
šode
 *);

426 
sysv_sync_fe
(
šode
 *, 
fe
 *);

428 
sysv_mm­
(
šode
 *, 
fe
 *, , 
size_t
, , );

431 
šode_İ”©iÚs
 
sysv_fe_šode_İ”©iÚs
;

432 
šode_İ”©iÚs
 
sysv_fe_šode_İ”©iÚs_w™h_bm­
;

433 
šode_İ”©iÚs
 
sysv_dœ_šode_İ”©iÚs
;

434 
šode_İ”©iÚs
 
sysv_symlšk_šode_İ”©iÚs
;

	@include/linux/sysv_fs_i.h

1 #iâdeà
_SYSV_FS_I


2 
	#_SYSV_FS_I


	)

7 
	ssysv_šode_šfo
 {

8 
	mi_d©a
[10+1+1+1];

14 
	mi_lock
;

15 
wa™_queue
 * 
	mi_wa™
;

	@include/linux/sysv_fs_sb.h

1 #iâdeà
_SYSV_FS_SB


2 
	#_SYSV_FS_SB


	)

13 
	ssysv_sb_šfo
 {

14 
	ms_ty³
;

15 
	ms_block_size
;

16 
	ms_block_size_1
;

17 
	ms_block_size_b™s
;

18 
	ms_block_size_¿tio
;

19 
	ms_block_size_¿tio_1
;

20 
	ms_block_size_¿tio_b™s
;

21 
	ms_cÚv”t
;

22 
	ms_kludge_symlšks
;

23 
	ms_Œunÿ‹
;

25 
Æšk_t
 
	ms_lšk_max
;

26 
	ms_šodes_³r_block
;

27 
	ms_šodes_³r_block_1
;

28 
	ms_šodes_³r_block_b™s
;

29 
	ms_šd_³r_block
;

30 
	ms_šd_³r_block_1
;

31 
	ms_šd_³r_block_b™s
;

32 
	ms_šd_³r_block_2
;

33 
	ms_šd_³r_block_2_1
;

34 
	ms_šd_³r_block_2_b™s
;

35 
	ms_šd_³r_block_3
;

36 
	ms_toobig_block
;

37 
	ms_block_ba£
;

38 
	ms_fic_size
;

39 
	ms_æc_size
;

41 
bufãr_h—d
 *
	ms_bh
;

44 * 
	ms_sbd
;

45 *
	ms_sb_fic_couÁ
;

46 *
	ms_sb_fic_šodes
;

47 *
	ms_sb_tÙ®_ä“_šodes
;

48 *
	ms_sb_æc_couÁ
;

49 *
	ms_sb_æc_blocks
;

50 *
	ms_sb_tÙ®_ä“_blocks
;

51 *
	ms_sb_time
;

54 
	ms_fœ¡šodezÚe
;

55 
	ms_fœ¡d©azÚe
;

56 
	ms_nšodes
;

57 
	ms_nd©azÚes
;

58 
	ms_nzÚes
;

63 
	#sv_ty³
 
u
.
sysv_sb
.
s_ty³


	)

64 
	#sv_block_size
 
u
.
sysv_sb
.
s_block_size


	)

65 
	#sv_block_size_1
 
u
.
sysv_sb
.
s_block_size_1


	)

66 
	#sv_block_size_b™s
 
u
.
sysv_sb
.
s_block_size_b™s


	)

67 
	#sv_block_size_¿tio
 
u
.
sysv_sb
.
s_block_size_¿tio


	)

68 
	#sv_block_size_¿tio_1
 
u
.
sysv_sb
.
s_block_size_¿tio_1


	)

69 
	#sv_block_size_¿tio_b™s
 
u
.
sysv_sb
.
s_block_size_¿tio_b™s


	)

70 
	#sv_cÚv”t
 
u
.
sysv_sb
.
s_cÚv”t


	)

71 
	#sv_kludge_symlšks
 
u
.
sysv_sb
.
s_kludge_symlšks


	)

72 
	#sv_Œunÿ‹
 
u
.
sysv_sb
.
s_Œunÿ‹


	)

73 
	#sv_lšk_max
 
u
.
sysv_sb
.
s_lšk_max


	)

74 
	#sv_šodes_³r_block
 
u
.
sysv_sb
.
s_šodes_³r_block


	)

75 
	#sv_šodes_³r_block_1
 
u
.
sysv_sb
.
s_šodes_³r_block_1


	)

76 
	#sv_šodes_³r_block_b™s
 
u
.
sysv_sb
.
s_šodes_³r_block_b™s


	)

77 
	#sv_šd_³r_block
 
u
.
sysv_sb
.
s_šd_³r_block


	)

78 
	#sv_šd_³r_block_1
 
u
.
sysv_sb
.
s_šd_³r_block_1


	)

79 
	#sv_šd_³r_block_b™s
 
u
.
sysv_sb
.
s_šd_³r_block_b™s


	)

80 
	#sv_šd_³r_block_2
 
u
.
sysv_sb
.
s_šd_³r_block_2


	)

81 
	#sv_šd_³r_block_2_1
 
u
.
sysv_sb
.
s_šd_³r_block_2_1


	)

82 
	#sv_šd_³r_block_2_b™s
 
u
.
sysv_sb
.
s_šd_³r_block_2_b™s


	)

83 
	#sv_šd_³r_block_3
 
u
.
sysv_sb
.
s_šd_³r_block_3


	)

84 
	#sv_toobig_block
 
u
.
sysv_sb
.
s_toobig_block


	)

85 
	#sv_block_ba£
 
u
.
sysv_sb
.
s_block_ba£


	)

86 
	#sv_fic_size
 
u
.
sysv_sb
.
s_fic_size


	)

87 
	#sv_æc_size
 
u
.
sysv_sb
.
s_æc_size


	)

88 
	#sv_bh
 
u
.
sysv_sb
.
s_bh


	)

89 
	#sv_sbd
 
u
.
sysv_sb
.
s_sbd


	)

90 
	#sv_sb_fic_couÁ
 
u
.
sysv_sb
.
s_sb_fic_couÁ


	)

91 
	#sv_sb_fic_šodes
 
u
.
sysv_sb
.
s_sb_fic_šodes


	)

92 
	#sv_sb_tÙ®_ä“_šodes
 
u
.
sysv_sb
.
s_sb_tÙ®_ä“_šodes


	)

93 
	#sv_sb_æc_couÁ
 
u
.
sysv_sb
.
s_sb_æc_couÁ


	)

94 
	#sv_sb_æc_blocks
 
u
.
sysv_sb
.
s_sb_æc_blocks


	)

95 
	#sv_sb_tÙ®_ä“_blocks
 
u
.
sysv_sb
.
s_sb_tÙ®_ä“_blocks


	)

96 
	#sv_sb_time
 
u
.
sysv_sb
.
s_sb_time


	)

97 
	#sv_fœ¡šodezÚe
 
u
.
sysv_sb
.
s_fœ¡šodezÚe


	)

98 
	#sv_fœ¡d©azÚe
 
u
.
sysv_sb
.
s_fœ¡d©azÚe


	)

99 
	#sv_nšodes
 
u
.
sysv_sb
.
s_nšodes


	)

100 
	#sv_nd©azÚes
 
u
.
sysv_sb
.
s_nd©azÚes


	)

101 
	#sv_nzÚes
 
u
.
sysv_sb
.
s_nzÚes


	)

	@include/linux/tasks.h

1 #iâdeà
_LINUX_TASKS_H


2 
	#_LINUX_TASKS_H


	)

7 
	#NR_TASKS
 128

	)

	@include/linux/tcp.h

17 #iâdeà
_LINUX_TCP_H


18 
	#_LINUX_TCP_H


	)

21 
	#HEADER_SIZE
 64

	)

24 
	stıhdr
 {

25 
	msourû
;

26 
	mde¡
;

27 
	m£q
;

28 
	mack_£q
;

29 
	m»s1
:4,

30 
	mdoff
:4,

31 
	mfš
:1,

32 
	msyn
:1,

33 
	mr¡
:1,

34 
	mpsh
:1,

35 
	mack
:1,

36 
	murg
:1,

37 
	m»s2
:2;

38 
	mwšdow
;

39 
	mcheck
;

40 
	murg_±r
;

45 
	mTCP_ESTABLISHED
 = 1,

46 
	mTCP_SYN_SENT
,

47 
	mTCP_SYN_RECV
,

49 
	mTCP_CLOSING
,

52 
	mTCP_FIN_WAIT1
,

53 
	mTCP_FIN_WAIT2
,

54 
	mTCP_TIME_WAIT
,

55 
	mTCP_CLOSE
,

56 
	mTCP_CLOSE_WAIT
,

57 
	mTCP_LAST_ACK
,

58 
	mTCP_LISTEN


	@include/linux/termios.h

1 #iâdeà
_LINUX_TERMIOS_H


2 
	#_LINUX_TERMIOS_H


	)

6 
	#TCGETS
 0x5401

	)

7 
	#TCSETS
 0x5402

	)

8 
	#TCSETSW
 0x5403

	)

9 
	#TCSETSF
 0x5404

	)

10 
	#TCGETA
 0x5405

	)

11 
	#TCSETA
 0x5406

	)

12 
	#TCSETAW
 0x5407

	)

13 
	#TCSETAF
 0x5408

	)

14 
	#TCSBRK
 0x5409

	)

15 
	#TCXONC
 0x540A

	)

16 
	#TCFLSH
 0x540B

	)

17 
	#TIOCEXCL
 0x540C

	)

18 
	#TIOCNXCL
 0x540D

	)

19 
	#TIOCSCTTY
 0x540E

	)

20 
	#TIOCGPGRP
 0x540F

	)

21 
	#TIOCSPGRP
 0x5410

	)

22 
	#TIOCOUTQ
 0x5411

	)

23 
	#TIOCSTI
 0x5412

	)

24 
	#TIOCGWINSZ
 0x5413

	)

25 
	#TIOCSWINSZ
 0x5414

	)

26 
	#TIOCMGET
 0x5415

	)

27 
	#TIOCMBIS
 0x5416

	)

28 
	#TIOCMBIC
 0x5417

	)

29 
	#TIOCMSET
 0x5418

	)

30 
	#TIOCGSOFTCAR
 0x5419

	)

31 
	#TIOCSSOFTCAR
 0x541A

	)

32 
	#FIONREAD
 0x541B

	)

33 
	#TIOCINQ
 
FIONREAD


	)

34 
	#TIOCLINUX
 0x541C

	)

35 
	#TIOCCONS
 0x541D

	)

36 
	#TIOCGSERIAL
 0x541E

	)

37 
	#TIOCSSERIAL
 0x541F

	)

38 
	#TIOCPKT
 0x5420

	)

39 
	#FIONBIO
 0x5421

	)

40 
	#TIOCNOTTY
 0x5422

	)

41 
	#TIOCSETD
 0x5423

	)

42 
	#TIOCGETD
 0x5424

	)

43 
	#TCSBRKP
 0x5425

	)

44 
	#FIONCLEX
 0x5450

	)

45 
	#FIOCLEX
 0x5451

	)

46 
	#FIOASYNC
 0x5452

	)

47 
	#TIOCSERCONFIG
 0x5453

	)

48 
	#TIOCSERGWILD
 0x5454

	)

49 
	#TIOCSERSWILD
 0x5455

	)

50 
	#TIOCGLCKTRMIOS
 0x5456

	)

51 
	#TIOCSLCKTRMIOS
 0x5457

	)

54 
	#TIOCPKT_DATA
 0

	)

55 
	#TIOCPKT_FLUSHREAD
 1

	)

56 
	#TIOCPKT_FLUSHWRITE
 2

	)

57 
	#TIOCPKT_STOP
 4

	)

58 
	#TIOCPKT_START
 8

	)

59 
	#TIOCPKT_NOSTOP
 16

	)

60 
	#TIOCPKT_DOSTOP
 32

	)

62 
	swšsize
 {

63 
	mws_row
;

64 
	mws_cŞ
;

65 
	mws_xpix–
;

66 
	mws_ypix–
;

69 
	#NCC
 8

	)

70 
	s‹rmio
 {

71 
	mc_iæag
;

72 
	mc_oæag
;

73 
	mc_cæag
;

74 
	mc_læag
;

75 
	mc_lše
;

76 
	mc_cc
[
NCC
];

79 
	#NCCS
 19

	)

80 
	s‹rmios
 {

81 
tcæag_t
 
	mc_iæag
;

82 
tcæag_t
 
	mc_oæag
;

83 
tcæag_t
 
	mc_cæag
;

84 
tcæag_t
 
	mc_læag
;

85 
cc_t
 
	mc_lše
;

86 
cc_t
 
	mc_cc
[
NCCS
];

90 
	#VINTR
 0

	)

91 
	#VQUIT
 1

	)

92 
	#VERASE
 2

	)

93 
	#VKILL
 3

	)

94 
	#VEOF
 4

	)

95 
	#VTIME
 5

	)

96 
	#VMIN
 6

	)

97 
	#VSWTC
 7

	)

98 
	#VSTART
 8

	)

99 
	#VSTOP
 9

	)

100 
	#VSUSP
 10

	)

101 
	#VEOL
 11

	)

102 
	#VREPRINT
 12

	)

103 
	#VDISCARD
 13

	)

104 
	#VWERASE
 14

	)

105 
	#VLNEXT
 15

	)

106 
	#VEOL2
 16

	)

109 
	#IGNBRK
 0000001

	)

110 
	#BRKINT
 0000002

	)

111 
	#IGNPAR
 0000004

	)

112 
	#PARMRK
 0000010

	)

113 
	#INPCK
 0000020

	)

114 
	#ISTRIP
 0000040

	)

115 
	#INLCR
 0000100

	)

116 
	#IGNCR
 0000200

	)

117 
	#ICRNL
 0000400

	)

118 
	#IUCLC
 0001000

	)

119 
	#IXON
 0002000

	)

120 
	#IXANY
 0004000

	)

121 
	#IXOFF
 0010000

	)

122 
	#IMAXBEL
 0020000

	)

125 
	#OPOST
 0000001

	)

126 
	#OLCUC
 0000002

	)

127 
	#ONLCR
 0000004

	)

128 
	#OCRNL
 0000010

	)

129 
	#ONOCR
 0000020

	)

130 
	#ONLRET
 0000040

	)

131 
	#OFILL
 0000100

	)

132 
	#OFDEL
 0000200

	)

133 
	#NLDLY
 0000400

	)

134 
	#NL0
 0000000

	)

135 
	#NL1
 0000400

	)

136 
	#CRDLY
 0003000

	)

137 
	#CR0
 0000000

	)

138 
	#CR1
 0001000

	)

139 
	#CR2
 0002000

	)

140 
	#CR3
 0003000

	)

141 
	#TABDLY
 0014000

	)

142 
	#TAB0
 0000000

	)

143 
	#TAB1
 0004000

	)

144 
	#TAB2
 0010000

	)

145 
	#TAB3
 0014000

	)

146 
	#XTABS
 0014000

	)

147 
	#BSDLY
 0020000

	)

148 
	#BS0
 0000000

	)

149 
	#BS1
 0020000

	)

150 
	#VTDLY
 0040000

	)

151 
	#VT0
 0000000

	)

152 
	#VT1
 0040000

	)

153 
	#FFDLY
 0100000

	)

154 
	#FF0
 0000000

	)

155 
	#FF1
 0100000

	)

158 
	#CBAUD
 0000017

	)

159 
	#B0
 0000000

	)

160 
	#B50
 0000001

	)

161 
	#B75
 0000002

	)

162 
	#B110
 0000003

	)

163 
	#B134
 0000004

	)

164 
	#B150
 0000005

	)

165 
	#B200
 0000006

	)

166 
	#B300
 0000007

	)

167 
	#B600
 0000010

	)

168 
	#B1200
 0000011

	)

169 
	#B1800
 0000012

	)

170 
	#B2400
 0000013

	)

171 
	#B4800
 0000014

	)

172 
	#B9600
 0000015

	)

173 
	#B19200
 0000016

	)

174 
	#B38400
 0000017

	)

175 
	#EXTA
 
B19200


	)

176 
	#EXTB
 
B38400


	)

177 
	#CSIZE
 0000060

	)

178 
	#CS5
 0000000

	)

179 
	#CS6
 0000020

	)

180 
	#CS7
 0000040

	)

181 
	#CS8
 0000060

	)

182 
	#CSTOPB
 0000100

	)

183 
	#CREAD
 0000200

	)

184 
	#PARENB
 0000400

	)

185 
	#PARODD
 0001000

	)

186 
	#HUPCL
 0002000

	)

187 
	#CLOCAL
 0004000

	)

188 
	#CIBAUD
 03600000

	)

189 
	#CRTSCTS
 020000000000

	)

192 
	#ISIG
 0000001

	)

193 
	#ICANON
 0000002

	)

194 
	#XCASE
 0000004

	)

195 
	#ECHO
 0000010

	)

196 
	#ECHOE
 0000020

	)

197 
	#ECHOK
 0000040

	)

198 
	#ECHONL
 0000100

	)

199 
	#NOFLSH
 0000200

	)

200 
	#TOSTOP
 0000400

	)

201 
	#ECHOCTL
 0001000

	)

202 
	#ECHOPRT
 0002000

	)

203 
	#ECHOKE
 0004000

	)

204 
	#FLUSHO
 0010000

	)

205 
	#PENDIN
 0040000

	)

206 
	#IEXTEN
 0100000

	)

209 
	#TIOCM_LE
 0x001

	)

210 
	#TIOCM_DTR
 0x002

	)

211 
	#TIOCM_RTS
 0x004

	)

212 
	#TIOCM_ST
 0x008

	)

213 
	#TIOCM_SR
 0x010

	)

214 
	#TIOCM_CTS
 0x020

	)

215 
	#TIOCM_CAR
 0x040

	)

216 
	#TIOCM_RNG
 0x080

	)

217 
	#TIOCM_DSR
 0x100

	)

218 
	#TIOCM_CD
 
TIOCM_CAR


	)

219 
	#TIOCM_RI
 
TIOCM_RNG


	)

222 
	#TCOOFF
 0

	)

223 
	#TCOON
 1

	)

224 
	#TCIOFF
 2

	)

225 
	#TCION
 3

	)

228 
	#TCIFLUSH
 0

	)

229 
	#TCOFLUSH
 1

	)

230 
	#TCIOFLUSH
 2

	)

233 
	#TCSANOW
 0

	)

234 
	#TCSADRAIN
 1

	)

235 
	#TCSAFLUSH
 2

	)

238 
	#N_TTY
 0

	)

239 
	#N_SLIP
 1

	)

240 
	#N_MOUSE
 2

	)

241 
	#N_PPP
 3

	)

	@include/linux/time.h

1 #iâdeà
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	stimev®
 {

5 
	mtv_£c
;

6 
	mtv_u£c
;

9 
	stimezÚe
 {

10 
	mtz_mšu‹swe¡
;

11 
	mtz_d¡time
;

14 
	#NFDBITS
 
__NFDBITS


	)

16 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

17 
	#FD_SET
(
fd
,
fd£
è
	`__FD_SET
(fd,fd£)

	)

18 
	#FD_CLR
(
fd
,
fd£
è
	`__FD_CLR
(fd,fd£)

	)

19 
	#FD_ISSET
(
fd
,
fd£
è
	`__FD_ISSET
(fd,fd£)

	)

20 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
(fd£)

	)

26 
	#ITIMER_REAL
 0

	)

27 
	#ITIMER_VIRTUAL
 1

	)

28 
	#ITIMER_PROF
 2

	)

30 
	s™im”v®
 {

31 
timev®
 
	m™_š‹rv®
;

32 
timev®
 
	m™_v®ue
;

	@include/linux/timer.h

1 #iâdeà
_LINUX_TIMER_H


2 
	#_LINUX_TIMER_H


	)

37 
	#BLANK_TIMER
 0

	)

38 
	#BEEP_TIMER
 1

	)

39 
	#RS_TIMER
 2

	)

41 
	#HD_TIMER
 16

	)

42 
	#FLOPPY_TIMER
 17

	)

43 
	#SCSI_TIMER
 18

	)

44 
	#NET_TIMER
 19

	)

45 
	#SOUND_TIMER
 20

	)

46 
	#COPRO_TIMER
 21

	)

48 
	#TAPE_QIC02_TIMER
 22

	)

49 
	#MCD_TIMER
 23

	)

51 
	#HD_TIMER2
 24

	)

53 
	#SBPCD_TIMER
 25

	)

55 
	stim”_¡ruù
 {

56 
	mexpœes
;

57 (*
	mâ
)();

60 
tim”_aùive
;

61 
tim”_¡ruù
 
tim”_bË
[32];

76 
	stim”_li¡
 {

77 
tim”_li¡
 *
	mÃxt
;

78 
tim”_li¡
 *
	m´ev
;

79 
	mexpœes
;

80 
	md©a
;

81 (*
	mfunùiÚ
)();

84 
add_tim”
(
tim”_li¡
 * 
tim”
);

85 
d–_tim”
(
tim”_li¡
 * 
tim”
);

	@include/linux/times.h

1 #iâdeà
_LINUX_TIMES_H


2 
	#_LINUX_TIMES_H


	)

4 
	stms
 {

5 
şock_t
 
	mtms_utime
;

6 
şock_t
 
	mtms_¡ime
;

7 
şock_t
 
	mtms_cutime
;

8 
şock_t
 
	mtms_c¡ime
;

	@include/linux/timex.h

25 #iâdeà
_LINUX_TIMEX_H


26 
	#_LINUX_TIMEX_H


	)

35 
	#SHIFT_HZ
 7

	)

44 
	#SHIFT_KG
 8

	)

45 
	#SHIFT_KF
 20

	)

46 
	#MAXTC
 6

	)

56 
	#SHIFT_SCALE
 24

	)

57 
	#SHIFT_UPDATE
 (
SHIFT_KG
 + 
MAXTC
è

	)

58 
	#FINEUSEC
 (1 << 
SHIFT_SCALE
è

	)

60 
	#MAXPHASE
 128000

	)

61 
	#MAXFREQ
 100

	)

62 
	#MINSEC
 16

	)

63 
	#MAXSEC
 1200

	)

65 
	#CLOCK_TICK_RATE
 1193180

	)

66 
	#CLOCK_TICK_FACTOR
 20

	)

67 
	#LATCH
 ((
CLOCK_TICK_RATE
 + 
HZ
/2è/ HZè

	)

69 
	#FINETUNE
 (((((
LATCH
 * 
HZ
 - 
CLOCK_TICK_RATE
è<< 
SHIFT_HZ
) * \

70 (1000000/
CLOCK_TICK_FACTOR
è/ (
CLOCK_TICK_RATE
/CLOCK_TICK_FACTOR)) \

71 << (
SHIFT_SCALE
-
SHIFT_HZ
)è/ 
HZ
)

	)

77 
	stimex
 {

78 
	mmode
;

79 
	moff£t
;

80 
	mäequ’cy
;

81 
	mmax”rÜ
;

82 
	me¡”rÜ
;

83 
	m¡©us
;

84 
	mtime_cÚ¡ªt
;

85 
	m´ecisiÚ
;

86 
	mtŞ”ªû
;

89 
timev®
 
	mtime
;

90 
	mtick
;

96 
	#ADJ_OFFSET
 0x0001

	)

97 
	#ADJ_FREQUENCY
 0x0002

	)

98 
	#ADJ_MAXERROR
 0x0004

	)

99 
	#ADJ_ESTERROR
 0x0008

	)

100 
	#ADJ_STATUS
 0x0010

	)

101 
	#ADJ_TIMECONST
 0x0020

	)

102 
	#ADJ_TICK
 0x4000

	)

103 
	#ADJ_OFFSET_SINGLESHOT
 0x8001

	)

108 
	#TIME_OK
 0

	)

109 
	#TIME_INS
 1

	)

110 
	#TIME_DEL
 2

	)

111 
	#TIME_OOP
 3

	)

112 
	#TIME_BAD
 4

	)

114 #ifdeà
__KERNEL__


118 
tick
;

119 
tickadj
;

120 vŞ©
timev®
 
xtime
;

125 
time_¡©us
;

126 
time_off£t
;

127 
time_cÚ¡ªt
;

128 
time_tŞ”ªû
;

129 
time_´ecisiÚ
;

130 
time_max”rÜ
;

131 
time_e¡”rÜ
;

132 
time_pha£
;

133 
time_äeq
;

134 
time_adj
;

135 
time_»áime
;

137 
time_adju¡
;

	@include/linux/tpqic02.h

10 #iâdeà
_LINUX_TPQIC02_H


11 
	#_LINUX_TPQIC02_H


	)

13 
	~<lšux/cÚfig.h
>

15 #ià
CONFIG_TAPE_QIC02


18 
	~<lšux/mtio.h
>

22 
	#WANGTEK
 1

	)

23 
	#EVEREX
 
WANGTEK


	)

24 
	#EVEREX_811V
 
EVEREX


	)

25 
	#EVEREX_831V
 
EVEREX


	)

26 
	#ARCHIVE
 3

	)

27 
	#ARCHIVE_SC400
 
ARCHIVE


	)

28 
	#ARCHIVE_SC402
 
ARCHIVE


	)

29 
	#ARCHIVE_SC499
 
ARCHIVE


	)

54 
	#TAPE_QIC02_DRIVE
 
MT_ISQIC02_ALL_FEATURES


	)

56 
	#TAPE_QIC02_IFC
 
WANGTEK


	)

58 
	#TAPE_QIC02_PORT
 0x300

	)

59 
	#TAPE_QIC02_IRQ
 5

	)

60 
	#TAPE_QIC02_DMA
 1

	)

70 #ià
TAPE_QIC02_DRIVE
 =ğ
MT_ISWT5150


71 
	#TP_HAVE_DENS


	)

72 
	#TP_HAVE_BSF


	)

73 
	#TP_HAVE_FSR


	)

74 
	#TP_HAVE_BSR


	)

75 
	#TP_HAVE_EOD


	)

76 
	#TP_HAVE_RAS1


	)

77 
	#TP_HAVE_RAS2


	)

79 #–ià
TAPE_QIC02_DRIVE
 =ğ
MT_ISARCHIVESC499


80 
	#TP_HAVE_DENS


	)

81 
	#TP_HAVE_FSR


	)

82 
	#TP_HAVE_BSR


	)

83 
	#TP_HAVE_EOD


	)

84 
	#TP_HAVE_RAS1


	)

85 
	#TP_HAVE_RAS2


	)

88 #–ià(
TAPE_QIC02_DRIVE
 =ğ
MT_ISARCHIVE_2060L
è|| (TAPE_QIC02_DRIVE =ğ
MT_ISARCHIVE_2150L
)

89 
	#TP_HAVE_DENS


	)

90 
	#TP_HAVE_FSR


	)

91 
	#TP_HAVE_BSR


	)

92 
	#TP_HAVE_EOD


	)

93 
	#TP_HAVE_TELL


	)

94 
	#TP_HAVE_SEEK


	)

95 
	#TP_HAVE_RAS1


	)

96 
	#TP_HAVE_RAS2


	)

99 #–ià
TAPE_QIC02_DRIVE
 =ğ
MT_ISQIC02_ALL_FEATURES


100 
	#TP_HAVE_DENS


	)

101 
	#TP_HAVE_BSF


	)

102 
	#TP_HAVE_FSR


	)

103 
	#TP_HAVE_BSR


	)

104 
	#TP_HAVE_EOD


	)

105 
	#TP_HAVE_SEEK


	)

106 
	#TP_HAVE_TELL


	)

107 
	#TP_HAVE_RAS1


	)

108 
	#TP_HAVE_RAS2


	)

113 #”rÜ 
No
 
QIC
-02 
³
 
drive
 
ty³
 
defšed
!

127 
	#NR_BLK_BUF
 20

	)

128 
	#TAPE_BLKSIZE
 512

	)

129 
	#TPQBUF_SIZE
 (
TAPE_BLKSIZE
*
NR_BLK_BUF
è

	)

132 
	#BLOCKS_BEYOND_EW
 2

	)

134 #ià
TAPE_QIC02_IFC
 =ğ
WANGTEK


136 
	#QIC_STAT_PORT
 
TAPE_QIC02_PORT


	)

137 
	#QIC_CTL_PORT
 
TAPE_QIC02_PORT


	)

138 
	#QIC_CMD_PORT
 (
TAPE_QIC02_PORT
+1)

	)

139 
	#QIC_DATA_PORT
 (
TAPE_QIC02_PORT
+1)

	)

142 
	#QIC_STAT_READY
 0x01

	)

143 
	#QIC_STAT_EXCEPTION
 0x02

	)

144 
	#QIC_STAT_MASK
 (
QIC_STAT_READY
|
QIC_STAT_EXCEPTION
)

	)

146 
	#QIC_STAT_RESETMASK
 0x07

	)

147 
	#QIC_STAT_RESETVAL
 (
QIC_STAT_RESETMASK
 & ~
QIC_STAT_EXCEPTION
)

	)

150 
	#WT_CTL_ONLINE
 0x01

	)

151 
	#QIC_CTL_RESET
 0x02

	)

152 
	#QIC_CTL_REQUEST
 0x04

	)

153 
	#WT_CTL_CMDOFF
 0xC0

	)

154 #ià
TAPE_QIC02_DMA
 == 3

155 
	#WT_CTL_DMA
 0x10

	)

156 #–ià
TAPE_QIC02_DMA
 == 1

157 
	#WT_CTL_DMA
 0x08

	)

159 #”rÜ 
UnsuµÜ‹d
 
Ü
 
šcÜ»ù
 
DMA
 
cÚfigu¿tiÚ
.

162 #–ià
TAPE_QIC02_IFC
 =ğ
ARCHIVE


164 
	#QIC_STAT_PORT
 (
TAPE_QIC02_PORT
+1)

	)

165 
	#QIC_CTL_PORT
 (
TAPE_QIC02_PORT
+1)

	)

166 
	#QIC_CMD_PORT
 (
TAPE_QIC02_PORT
)

	)

167 
	#QIC_DATA_PORT
 (
TAPE_QIC02_PORT
)

	)

168 
	#AR_START_DMA_PORT
 (
TAPE_QIC02_PORT
+2)

	)

169 
	#AR_RESET_DMA_PORT
 (
TAPE_QIC02_PORT
+3)

	)

172 
	#AR_STAT_IRQF
 0x80

	)

173 
	#QIC_STAT_READY
 0x40

	)

174 
	#QIC_STAT_EXCEPTION
 0x20

	)

175 
	#QIC_STAT_MASK
 (
QIC_STAT_READY
|
QIC_STAT_EXCEPTION
)

	)

176 
	#AR_STAT_DMADONE
 0x10

	)

177 
	#AR_STAT_DIRC
 0x08

	)

179 
	#QIC_STAT_RESETMASK
 0x70

	)

180 
	#QIC_STAT_RESETVAL
 ((
QIC_STAT_RESETMASK
 & ~
AR_STAT_IRQF
 & ~
QIC_STAT_EXCEPTION
è| 
AR_STAT_DMADONE
)

	)

183 
	#QIC_CTL_RESET
 0x80

	)

184 
	#QIC_CTL_REQUEST
 0x40

	)

185 
	#AR_CTL_IEN
 0x20

	)

186 
	#AR_CTL_DNIEN
 0x10

	)

192 #ià
TAPE_QIC02_DMA
 > 3

193 #”rÜ 
DMA
 
chªÃls
 
Ùh”
 
thª
 1 
ªd
 3 
¬e
 
nÙ
 
suµÜ‹d
.

197 #”rÜ 
No
 
v®id
 
š‹rçû
 
ÿrd
 
¥ecif›d
!

201 
	#QCMD_SEL_1
 0x01

	)

202 
	#QCMD_SEL_2
 0x02

	)

203 
	#QCMD_SEL_3
 0x04

	)

204 
	#QCMD_SEL_4
 0x08

	)

205 
	#QCMD_REWIND
 0x21

	)

206 
	#QCMD_ERASE
 0x22

	)

207 
	#QCMD_RETEN
 0x24

	)

208 
	#QCMD_WRT_DATA
 0x40

	)

209 
	#QCMD_WRT_FM
 0x60

	)

210 
	#QCMD_RD_DATA
 0x80

	)

211 
	#QCMD_RD_FM
 0xA0

	)

212 
	#QCMD_RD_STAT
 0xC0

	)

216 
	#QCMD_DENS_11
 0x26

	)

217 
	#QCMD_DENS_24
 0x27

	)

218 
	#QCMD_DENS_120
 0x28

	)

219 
	#QCMD_DENS_150
 0x29

	)

220 
	#QCMD_DENS_300
 0x2A

	)

221 
	#QCMD_DENS_600
 0x2B

	)

224 
	#QCMD_WRTNU_DATA
 0x40

	)

225 
	#QCMD_SPACE_FWD
 0x81

	)

226 
	#QCMD_SPACE_BCK
 0x89

	)

227 
	#QCMD_RD_FM_BCK
 0xA8

	)

228 
	#QCMD_SEEK_EOD
 0xA3

	)

229 
	#QCMD_RD_STAT_X1
 0xC1

	)

230 
	#QCMD_RD_STAT_X2
 0xC4

	)

231 
	#QCMD_RD_STAT_X3
 0xE0

	)

232 
	#QCMD_SELF_TST1
 0xC2

	)

233 
	#QCMD_SELF_TST2
 0xCA

	)

238 #ià
defšed
(
MT_ISARCHIVESC499
è|| defšed(
MT_ISARCHIVE_2150L
)

239 
	#QCMDV_TELL_BLK
 0xAE

	)

240 
	#QCMDV_SEEK_BLK
 0xAD

	)

241 
	#SEEK_BUF_SIZE
 3

	)

256 
	#QFA_ENABLE
 0x2D

	)

257 
	#QFA_DATA
 0x20

	)

258 
	#QFA_DIR
 0x23

	)

259 
	#QFA_RD_POS
 0xCF

	)

260 
	#QFA_SEEK_EOD
 0xA1

	)

261 
	#QFA_SEEK_BLK
 0xAF

	)

274 
	#TP_REWCLOSE
(
d
è((
	`MINOR
(d)&0x01è=ğ1è

	)

276 
	#TP_DENS
(
dev
è((
	`MINOR
(devè>> 1è& 0x07è

	)

277 
	#TP_UNIT
(
dev
è((
	`MINOR
(devè>> 4è& 0x07è

	)

278 
	#TP_DIAGS
(
dev
è(
	`MINOR
(devè& 0x80è

	)

282 
	s¡©us
 {

283 
	mexs
;

284 
	mdec
;

285 
	murc
;

287 
	#TPSTATSIZE
 (
¡©us
)

	)

291 
	#TP_POR
 0x100

	)

292 
	#TP_EOR
 0x200

	)

293 
	#TP_PAR
 0x400

	)

294 
	#TP_BOM
 0x800

	)

295 
	#TP_MBD
 0x1000

	)

296 
	#TP_NDT
 0x2000

	)

297 
	#TP_ILL
 0x4000

	)

298 
	#TP_ST1
 0x8000

	)

299 
	#TP_FIL
 0x01

	)

300 
	#TP_BNL
 0x02

	)

301 
	#TP_UDA
 0x04

	)

302 
	#TP_EOM
 0x08

	)

303 
	#TP_WRP
 0x10

	)

304 
	#TP_USL
 0x20

	)

305 
	#TP_CNI
 0x40

	)

306 
	#TP_ST0
 0x80

	)

308 
	#REPORT_ERR0
 (
TP_CNI
|
TP_USL
|
TP_WRP
|
TP_EOM
|
TP_UDA
|
TP_BNL
|
TP_FIL
)

	)

309 
	#REPORT_ERR1
 (
TP_ILL
|
TP_NDT
|
TP_MBD
|
TP_PAR
)

	)

312 
	#EXC_UNKNOWN
 0

	)

313 
	#EXC_NCART
 1

	)

314 
	#EXC_NDRV
 2

	)

315 
	#EXC_WP
 3

	)

316 
	#EXC_EOM
 4

	)

317 
	#EXC_RWA
 5

	)

318 
	#EXC_XBAD
 6

	)

319 
	#EXC_XFILLER
 7

	)

320 
	#EXC_NDT
 8

	)

321 
	#EXC_NDTEOM
 9

	)

322 
	#EXC_NDTBOM
 10

	)

323 
	#EXC_FM
 11

	)

324 
	#EXC_ILL
 12

	)

325 
	#EXC_POR
 13

	)

326 
	#EXC_MARGINAL
 14

	)

327 
	#EXC_EOR
 15

	)

328 
	#EXC_BOM
 16

	)

331 
	#TAPE_NOTIFY_TIMEOUT
 1000000

	)

334 
	#TE_OK
 0

	)

335 
	#TE_EX
 1

	)

336 
	#TE_ERR
 2

	)

337 
	#TE_NS
 3

	)

338 
	#TE_TIM
 4

	)

339 
	#TE_DEAD
 5

	)

340 
	#TE_END
 6

	)

343 
	#TIM_S
 (4*
HZ
è

	)

344 
	#TIM_M
 (30*
HZ
è

	)

345 
	#TIM_R
 (8*60*
HZ
è

	)

346 
	#TIM_F
 (2*3600*
HZ
è

	)

348 
	#TIMERON
(
t
è
tim”_bË
[
TAPE_QIC02_TIMER
].
expœes
 = 
jiff›s
 + (t); \

349 
tim”_aùive
 |ğ(1<<
TAPE_QIC02_TIMER
)

	)

350 
	#TIMEROFF
 
tim”_aùive
 &ğ~(1<<
TAPE_QIC02_TIMER
)

	)

351 
	#TIMERCONT
 
tim”_aùive
 |ğ(1<<
TAPE_QIC02_TIMER
)

	)

354 
	tæag
;

355 
	#NO
 0

	)

356 
	#YES
 1

	)

359 #ifdeà
TDEBUG


360 
	#TPQDEB
(
s
è
	)
s

361 
	#TPQPUTS
(
s
è
	`qputs
(s)

	)

363 
	#TPQDEB
(
s
)

	)

364 
	#TPQPUTS
(
s
)

	)

369 
³_qic02_š™
();

	@include/linux/tty.h

1 #iâdeà
_LINUX_TTY_H


2 
	#_LINUX_TTY_H


	)

8 
	~<lšux/‹rmios.h
>

10 
	~<asm/sy¡em.h
>

12 
	#NR_CONSOLES
 8

	)

13 
	#NR_LDISCS
 16

	)

19 
	ssü“n_šfo
 {

20 
	mÜig_x
;

21 
	mÜig_y
;

22 
	munu£d1
[2];

23 
	mÜig_video_·ge
;

24 
	mÜig_video_mode
;

25 
	mÜig_video_cŞs
;

26 
	mÜig_video_ega_ax
;

27 
	mÜig_video_ega_bx
;

28 
	mÜig_video_ega_cx
;

29 
	mÜig_video_lšes
;

32 
sü“n_šfo
 screen_info;

34 
	#ORIG_X
 (
sü“n_šfo
.
Üig_x
)

	)

35 
	#ORIG_Y
 (
sü“n_šfo
.
Üig_y
)

	)

36 
	#ORIG_VIDEO_PAGE
 (
sü“n_šfo
.
Üig_video_·ge
)

	)

37 
	#ORIG_VIDEO_MODE
 (
sü“n_šfo
.
Üig_video_mode
)

	)

38 
	#ORIG_VIDEO_COLS
 (
sü“n_šfo
.
Üig_video_cŞs
)

	)

39 
	#ORIG_VIDEO_EGA_AX
 (
sü“n_šfo
.
Üig_video_ega_ax
)

	)

40 
	#ORIG_VIDEO_EGA_BX
 (
sü“n_šfo
.
Üig_video_ega_bx
)

	)

41 
	#ORIG_VIDEO_EGA_CX
 (
sü“n_šfo
.
Üig_video_ega_cx
)

	)

42 
	#ORIG_VIDEO_LINES
 (
sü“n_šfo
.
Üig_video_lšes
)

	)

44 
	#VIDEO_TYPE_MDA
 0x10

	)

45 
	#VIDEO_TYPE_CGA
 0x11

	)

46 
	#VIDEO_TYPE_EGAM
 0x20

	)

47 
	#VIDEO_TYPE_EGAC
 0x21

	)

54 
	#__DISABLED_CHAR
 '\0'

	)

62 
	#TTY_BUF_SIZE
 1024

	)

64 
	s‰y_queue
 {

65 
	mh—d
;

66 
	m
;

67 
wa™_queue
 * 
	m´oc_li¡
;

68 
	mbuf
[
TTY_BUF_SIZE
];

71 
	s£rŸl_¡ruù
 {

72 
	mty³
;

73 
	mlše
;

74 
	mpÜt
;

75 
	mœq
;

76 
	mæags
;

77 
	mxm™_fifo_size
;

78 
	mcu¡om_divisÜ
;

79 
	mbaud_ba£
;

80 
	mşo£_d–ay
;

81 
	m»£rved_ch¬
[2];

82 
	mhub6
;

83 
	m»£rved
[5];

89 
	#PORT_UNKNOWN
 0

	)

90 
	#PORT_8250
 1

	)

91 
	#PORT_16450
 2

	)

92 
	#PORT_16550
 3

	)

93 
	#PORT_16550A
 4

	)

94 
	#PORT_MAX
 4

	)

99 
	#ASYNC_HUP_NOTIFY
 0x0001

	)

101 
	#ASYNC_FOURPORT
 0x0002

	)

102 
	#ASYNC_SAK
 0x0004

	)

103 
	#ASYNC_SPLIT_TERMIOS
 0x0008

	)

105 
	#ASYNC_SPD_MASK
 0x0030

	)

106 
	#ASYNC_SPD_HI
 0x0010

	)

107 
	#ASYNC_SPD_VHI
 0x0020

	)

108 
	#ASYNC_SPD_CUST
 0x0030

	)

110 
	#ASYNC_SKIP_TEST
 0x0040

	)

111 
	#ASYNC_AUTO_IRQ
 0x0080

	)

112 
	#ASYNC_SESSION_LOCKOUT
 0x0100

	)

113 
	#ASYNC_PGRP_LOCKOUT
 0x0200

	)

114 
	#ASYNC_CALLOUT_NOHUP
 0x0400

	)

116 
	#ASYNC_FLAGS
 0x0FFF

	)

117 
	#ASYNC_USR_MASK
 0x0430

	)

121 
	#ASYNC_INITIALIZED
 0x80000000

	)

122 
	#ASYNC_CALLOUT_ACTIVE
 0x40000000

	)

123 
	#ASYNC_NORMAL_ACTIVE
 0x20000000

	)

124 
	#ASYNC_BOOT_AUTOCONF
 0x10000000

	)

125 
	#ASYNC_CLOSING
 0x08000000

	)

127 
	#IS_A_CONSOLE
(
mš
è(((mšè& 0xC0è=ğ0x00)

	)

128 
	#IS_A_SERIAL
(
mš
è(((mšè& 0xC0è=ğ0x40)

	)

129 
	#IS_A_PTY
(
mš
è((mšè& 0x80)

	)

130 
	#IS_A_PTY_MASTER
(
mš
è(((mšè& 0xC0è=ğ0x80)

	)

131 
	#IS_A_PTY_SLAVE
(
mš
è(((mšè& 0xC0è=ğ0xC0)

	)

132 
	#PTY_OTHER
(
mš
è((mšè^ 0x40)

	)

134 
	#SL_TO_DEV
(
lše
è(Öšeè| 0x40)

	)

135 
	#DEV_TO_SL
(
mš
è((mšè& 0x3F)

	)

137 
	#INC
(
a
è(×èğ(×)+1è& (
TTY_BUF_SIZE
-1))

	)

138 
	#DEC
(
a
è(×èğ(×)-1è& (
TTY_BUF_SIZE
-1))

	)

139 
	#EMPTY
(
a
è(×)->
h—d
 =ğ×)->

)

	)

140 
	#LEFT
(
a
è((×)->

-×)->
h—d
-1)&(
TTY_BUF_SIZE
-1))

	)

141 
	#LAST
(
a
è(×)->
buf
[(
TTY_BUF_SIZE
-1)&(×)->
h—d
-1)])

	)

142 
	#FULL
(
a
è(!
	`LEFT
×))

	)

143 
	#CHARS
(
a
è((×)->
h—d
-×)->

)&(
TTY_BUF_SIZE
-1))

	)

145 
put_‰y_queue
(
c
, 
‰y_queue
 * 
queue
);

146 
g‘_‰y_queue
(
‰y_queue
 * 
queue
);

148 
	#INTR_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VINTR
])

	)

149 
	#QUIT_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VQUIT
])

	)

150 
	#ERASE_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VERASE
])

	)

151 
	#KILL_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VKILL
])

	)

152 
	#EOF_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VEOF
])

	)

153 
	#TIME_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VTIME
])

	)

154 
	#MIN_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VMIN
])

	)

155 
	#SWTC_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VSWTC
])

	)

156 
	#START_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VSTART
])

	)

157 
	#STOP_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VSTOP
])

	)

158 
	#SUSP_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VSUSP
])

	)

159 
	#EOL_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VEOL
])

	)

160 
	#REPRINT_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VREPRINT
])

	)

161 
	#DISCARD_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VDISCARD
])

	)

162 
	#WERASE_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VWERASE
])

	)

163 
	#LNEXT_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VLNEXT
])

	)

164 
	#EOL2_CHAR
(
‰y
è(Ñty)->
‹rmios
->
c_cc
[
VEOL2
])

	)

166 
	#_I_FLAG
(
‰y
,
f
è(Ñty)->
‹rmios
->
c_iæag
 & (f))

	)

167 
	#_O_FLAG
(
‰y
,
f
è(Ñty)->
‹rmios
->
c_oæag
 & (f))

	)

168 
	#_C_FLAG
(
‰y
,
f
è(Ñty)->
‹rmios
->
c_cæag
 & (f))

	)

169 
	#_L_FLAG
(
‰y
,
f
è(Ñty)->
‹rmios
->
c_læag
 & (f))

	)

171 
	#I_IGNBRK
(
‰y
è
	`_I_FLAG
(Ñty),
IGNBRK
)

	)

172 
	#I_BRKINT
(
‰y
è
	`_I_FLAG
(Ñty),
BRKINT
)

	)

173 
	#I_IGNPAR
(
‰y
è
	`_I_FLAG
(Ñty),
IGNPAR
)

	)

174 
	#I_PARMRK
(
‰y
è
	`_I_FLAG
(Ñty),
PARMRK
)

	)

175 
	#I_INPCK
(
‰y
è
	`_I_FLAG
(Ñty),
INPCK
)

	)

176 
	#I_ISTRIP
(
‰y
è
	`_I_FLAG
(Ñty),
ISTRIP
)

	)

177 
	#I_INLCR
(
‰y
è
	`_I_FLAG
(Ñty),
INLCR
)

	)

178 
	#I_IGNCR
(
‰y
è
	`_I_FLAG
(Ñty),
IGNCR
)

	)

179 
	#I_ICRNL
(
‰y
è
	`_I_FLAG
(Ñty),
ICRNL
)

	)

180 
	#I_IUCLC
(
‰y
è
	`_I_FLAG
(Ñty),
IUCLC
)

	)

181 
	#I_IXON
(
‰y
è
	`_I_FLAG
(Ñty),
IXON
)

	)

182 
	#I_IXANY
(
‰y
è
	`_I_FLAG
(Ñty),
IXANY
)

	)

183 
	#I_IXOFF
(
‰y
è
	`_I_FLAG
(Ñty),
IXOFF
)

	)

184 
	#I_IMAXBEL
(
‰y
è
	`_I_FLAG
(Ñty),
IMAXBEL
)

	)

186 
	#O_OPOST
(
‰y
è
	`_O_FLAG
(Ñty),
OPOST
)

	)

187 
	#O_OLCUC
(
‰y
è
	`_O_FLAG
(Ñty),
OLCUC
)

	)

188 
	#O_ONLCR
(
‰y
è
	`_O_FLAG
(Ñty),
ONLCR
)

	)

189 
	#O_OCRNL
(
‰y
è
	`_O_FLAG
(Ñty),
OCRNL
)

	)

190 
	#O_ONOCR
(
‰y
è
	`_O_FLAG
(Ñty),
ONOCR
)

	)

191 
	#O_ONLRET
(
‰y
è
	`_O_FLAG
(Ñty),
ONLRET
)

	)

192 
	#O_OFILL
(
‰y
è
	`_O_FLAG
(Ñty),
OFILL
)

	)

193 
	#O_OFDEL
(
‰y
è
	`_O_FLAG
(Ñty),
OFDEL
)

	)

194 
	#O_NLDLY
(
‰y
è
	`_O_FLAG
(Ñty),
NLDLY
)

	)

195 
	#O_CRDLY
(
‰y
è
	`_O_FLAG
(Ñty),
CRDLY
)

	)

196 
	#O_TABDLY
(
‰y
è
	`_O_FLAG
(Ñty),
TABDLY
)

	)

197 
	#O_BSDLY
(
‰y
è
	`_O_FLAG
(Ñty),
BSDLY
)

	)

198 
	#O_VTDLY
(
‰y
è
	`_O_FLAG
(Ñty),
VTDLY
)

	)

199 
	#O_FFDLY
(
‰y
è
	`_O_FLAG
(Ñty),
FFDLY
)

	)

201 
	#C_BAUD
(
‰y
è
	`_C_FLAG
(Ñty),
CBAUD
)

	)

202 
	#C_CSIZE
(
‰y
è
	`_C_FLAG
(Ñty),
CSIZE
)

	)

203 
	#C_CSTOPB
(
‰y
è
	`_C_FLAG
(Ñty),
CSTOPB
)

	)

204 
	#C_CREAD
(
‰y
è
	`_C_FLAG
(Ñty),
CREAD
)

	)

205 
	#C_PARENB
(
‰y
è
	`_C_FLAG
(Ñty),
PARENB
)

	)

206 
	#C_PARODD
(
‰y
è
	`_C_FLAG
(Ñty),
PARODD
)

	)

207 
	#C_HUPCL
(
‰y
è
	`_C_FLAG
(Ñty),
HUPCL
)

	)

208 
	#C_CLOCAL
(
‰y
è
	`_C_FLAG
(Ñty),
CLOCAL
)

	)

209 
	#C_CIBAUD
(
‰y
è
	`_C_FLAG
(Ñty),
CIBAUD
)

	)

210 
	#C_CRTSCTS
(
‰y
è
	`_C_FLAG
(Ñty),
CRTSCTS
)

	)

212 
	#L_ISIG
(
‰y
è
	`_L_FLAG
(Ñty),
ISIG
)

	)

213 
	#L_ICANON
(
‰y
è
	`_L_FLAG
(Ñty),
ICANON
)

	)

214 
	#L_XCASE
(
‰y
è
	`_L_FLAG
(Ñty),
XCASE
)

	)

215 
	#L_ECHO
(
‰y
è
	`_L_FLAG
(Ñty),
ECHO
)

	)

216 
	#L_ECHOE
(
‰y
è
	`_L_FLAG
(Ñty),
ECHOE
)

	)

217 
	#L_ECHOK
(
‰y
è
	`_L_FLAG
(Ñty),
ECHOK
)

	)

218 
	#L_ECHONL
(
‰y
è
	`_L_FLAG
(Ñty),
ECHONL
)

	)

219 
	#L_NOFLSH
(
‰y
è
	`_L_FLAG
(Ñty),
NOFLSH
)

	)

220 
	#L_TOSTOP
(
‰y
è
	`_L_FLAG
(Ñty),
TOSTOP
)

	)

221 
	#L_ECHOCTL
(
‰y
è
	`_L_FLAG
(Ñty),
ECHOCTL
)

	)

222 
	#L_ECHOPRT
(
‰y
è
	`_L_FLAG
(Ñty),
ECHOPRT
)

	)

223 
	#L_ECHOKE
(
‰y
è
	`_L_FLAG
(Ñty),
ECHOKE
)

	)

224 
	#L_FLUSHO
(
‰y
è
	`_L_FLAG
(Ñty),
FLUSHO
)

	)

225 
	#L_PENDIN
(
‰y
è
	`_L_FLAG
(Ñty),
PENDIN
)

	)

226 
	#L_IEXTEN
(
‰y
è
	`_L_FLAG
(Ñty),
IEXTEN
)

	)

242 
	s‰y_¡ruù
 {

243 
‹rmios
 *
	m‹rmios
;

244 
	mpg½
;

245 
	m£ssiÚ
;

246 
	m¡İ³d
:1, 
	mhw_¡İ³d
:1, 
	m·ck‘
:1, 
	mÊext
:1;

247 
	mch¬_”rÜ
:3;

248 
	m”asšg
:1;

249 
	mù¾_¡©us
;

250 
	mlše
;

251 
	mdisc
;

252 
	mæags
;

253 
	mcouÁ
;

254 
	mcŞumn
;

255 
wšsize
 
	mwšsize
;

256 (*
	mİ’
)(
‰y_¡ruù
 * 
	m‰y
, 
fe
 * 
	mfp
);

257 (*
	mşo£
)(
‰y_¡ruù
 * 
	m‰y
, 
fe
 * 
	mfp
);

258 (*
	mwr™e
)(
‰y_¡ruù
 * 
	m‰y
);

259 (*
	mioùl
)(
‰y_¡ruù
 *
	m‰y
, 
fe
 * 
	mfe
,

260 
	mcmd
, 
	m¬g
);

261 (*
	mthrÙe
)(
‰y_¡ruù
 * 
	m‰y
, 
	m¡©us
);

262 (*
	m£t_‹rmios
)(
‰y_¡ruù
 *
	m‰y
, 
‹rmios
 * 
	mŞd
);

263 (*
	m¡İ
)(
‰y_¡ruù
 *
	m‰y
);

264 (*
	m¡¬t
)(
‰y_¡ruù
 *
	m‰y
);

265 (*
	mhªgup
)(
‰y_¡ruù
 *
	m‰y
);

266 
‰y_¡ruù
 *
	mlšk
;

267 *
	mwr™e_d©a_±r
;

268 
	mwr™e_d©a_út
;

269 (*
	mwr™e_d©a_ÿÎback
)(* 
	md©a
);

270 * 
	mwr™e_d©a_¬g
;

271 
	m»adq_æags
[
TTY_BUF_SIZE
/32];

272 
	m£cÚd¬y_æags
[
TTY_BUF_SIZE
/32];

273 
	mÿnÚ_d©a
;

274 
	mÿnÚ_h—d
;

275 
	mÿnÚ_cŞumn
;

276 
‰y_queue
 
	m»ad_q
;

277 
‰y_queue
 
	mwr™e_q
;

278 
‰y_queue
 
	m£cÚd¬y
;

279 *
	mdisc_d©a
;

282 
	s‰y_ldisc
 {

283 
	mæags
;

287 (*
	mİ’
)(
	m‰y_¡ruù
 *);

288 (*
	mşo£
)(
	m‰y_¡ruù
 *);

289 (*
	m»ad
)(
‰y_¡ruù
 * 
	m‰y
, 
fe
 * 
	mfe
,

290 * 
	mbuf
, 
	mÄ
);

291 (*
	mwr™e
)(
‰y_¡ruù
 * 
	m‰y
, 
fe
 * 
	mfe
,

292 * 
	mbuf
, 
	mÄ
);

293 (*
	mioùl
)(
‰y_¡ruù
 * 
	m‰y
, 
fe
 * 
	mfe
,

294 
	mcmd
, 
	m¬g
);

295 (*
	m£Ëù
)(
‰y_¡ruù
 * 
	m‰y
, 
šode
 * 
	mšode
,

296 
fe
 * 
	mfe
, 
	m£l_ty³
,

297 
£Ëù_bË_¡ruù
 *
	mwa™
);

301 (*
	mhªdËr
)(
	m‰y_¡ruù
 *);

304 
	#LDISC_FLAG_DEFINED
 0x00000001

	)

322 
	#TTY_THROTTLE_SQ_FULL
 1

	)

323 
	#TTY_THROTTLE_SQ_AVAIL
 2

	)

324 
	#TTY_THROTTLE_RQ_FULL
 3

	)

325 
	#TTY_THROTTLE_RQ_AVAIL
 4

	)

332 
	#SQ_THRESHOLD_LW
 16

	)

333 
	#SQ_THRESHOLD_HW
 768

	)

334 
	#RQ_THRESHOLD_LW
 16

	)

335 
	#RQ_THRESHOLD_HW
 768

	)

345 
	#TTY_WRITE_BUSY
 0

	)

346 
	#TTY_READ_BUSY
 1

	)

347 
	#TTY_SQ_THROTTLED
 2

	)

348 
	#TTY_RQ_THROTTLED
 3

	)

349 
	#TTY_IO_ERROR
 4

	)

350 
	#TTY_SLAVE_CLOSED
 5

	)

351 
	#TTY_EXCLUSIVE
 6

	)

358 
	#TTY_BREAK
 1

	)

359 
	#TTY_FRAME
 2

	)

360 
	#TTY_PARITY
 3

	)

361 
	#TTY_OVERRUN
 4

	)

363 
	#TTY_WRITE_FLUSH
(
‰y
è
	`‰y_wr™e_æush
(Ñty))

	)

364 
	#TTY_READ_FLUSH
(
‰y
è
	`‰y_»ad_æush
(Ñty))

	)

366 
‰y_wr™e_æush
(
‰y_¡ruù
 *);

367 
‰y_»ad_æush
(
‰y_¡ruù
 *);

371 
	#WAKEUP_CHARS
 (3*
TTY_BUF_SIZE
/4)

	)

373 
‰y_¡ruù
 *
‰y_bË
[];

374 
‹rmios
 *
‰y_‹rmios
[];

375 
‹rmios
 *
‹rmios_locked
[];

376 
‰y_check_wr™e
[];

377 
‰y_¡ruù
 * 
»dœeù
;

378 
‰y_ldisc
 
ldiscs
[];

379 
fg_cÚsŞe
;

380 
video_num_cŞumns
;

381 
video_num_lšes
;

382 
wa™_queue
 * 
key´ess_wa™
;

384 
	#TTY_TABLE_IDX
(
Ä
è(Òrè? (Äè: (
fg_cÚsŞe
+1))

	)

385 
	#TTY_TABLE
(
Ä
è(
‰y_bË
[
	`TTY_TABLE_IDX
Òr)])

	)

393 
	#INIT_C_CC
 "\003\034\177\025\004\0\1\0\021\023\032\0\022\017\027\026\0"

	)

395 
rs_š™
();

396 
Í_š™
();

397 
cÚ_š™
();

398 
‰y_š™
();

400 
æush_šput
(
‰y_¡ruù
 * 
‰y
);

401 
æush_ouut
(
‰y_¡ruù
 * 
‰y
);

402 
wa™_uÁ_£Á
(
‰y_¡ruù
 * 
‰y
, 
timeout
);

403 
check_chªge
(
‰y_¡ruù
 * 
‰y
, 
chªÃl
);

404 
¡İ_‰y
(
‰y_¡ruù
 * 
‰y
);

405 
¡¬t_‰y
(
‰y_¡ruù
 * 
‰y
);

406 
‰y_»gi¡”_ldisc
(
disc
, 
‰y_ldisc
 *
Ãw_ldisc
);

407 
‰y_»ad_¿w_d©a
(
‰y_¡ruù
 *
‰y
, *
buå
,

408 
buæ’
);

409 
‰y_wr™e_d©a
(
‰y_¡ruù
 *
‰y
, *
buå
, 
buæ’
,

410 (*
ÿÎback
)(* 
d©a
), * 
ÿÎ¬g
);

412 
	`‰y_ioùl
(
šode
 *, 
fe
 *, , );

413 
	`is_Üphªed_pg½
(
pg½
);

414 
	`is_ignÜed
(
sig
);

415 
	`‰y_sigÇl
(
sig
, 
‰y_¡ruù
 *
‰y
);

416 
	`‰y_hªgup
(
‰y_¡ruù
 * 
‰y
);

417 
	`‰y_vhªgup
(
‰y_¡ruù
 * 
‰y
);

418 
	`‰y_unhªgup
(
fe
 *
fp
);

419 
	`‰y_hung_up_p
(
fe
 * 
fp
);

420 
	`do_SAK
(
‰y_¡ruù
 *
‰y
);

421 
	`di§ssocŸ‹_ùty
(
´iv
);

425 
	`rs_wr™e
(
‰y_¡ruù
 * 
‰y
);

426 
	`cÚ_wr™e
(
‰y_¡ruù
 * 
‰y
);

430 
	`rs_İ’
(
‰y_¡ruù
 * 
‰y
, 
fe
 * 
fp
);

434 
	`±y_İ’
(
‰y_¡ruù
 * 
‰y
, 
fe
 * 
fp
);

438 
	`cÚ_İ’
(
‰y_¡ruù
 * 
‰y
, 
fe
 * 
fp
);

439 
	`upd©e_sü“n
(
Ãw_cÚsŞe
);

440 
	`bÏnk_sü“n
();

441 
	`unbÏnk_sü“n
();

445 
	`vt_ioùl
(
‰y_¡ruù
 *
‰y
, 
fe
 * file,

446 
cmd
, 
¬g
);

	@include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 #iâdeà
_SIZE_T


5 
	#_SIZE_T


	)

6 
	tsize_t
;

9 #iâdeà
_SSIZE_T


10 
	#_SSIZE_T


	)

11 
	tssize_t
;

14 #iâdeà
_TIME_T


15 
	#_TIME_T


	)

16 
	ttime_t
;

19 #iâdeà
_CLOCK_T


20 
	#_CLOCK_T


	)

21 
	tşock_t
;

24 #iâdeà
_PTRDIFF_T


25 
	#_PTRDIFF_T


	)

26 
	t±rdiff_t
;

29 #iâdeà
NULL


30 
	#NULL
 ((*è0)

	)

33 
	tpid_t
;

34 
	tuid_t
;

35 
	tgid_t
;

36 
	tdev_t
;

37 #ifdeà
OLD_LINUX


38 
	tšo_t
;

40 
	tšo_t
;

42 
	tmode_t
;

43 
	tumode_t
;

44 
	tÆšk_t
;

45 
	tdaddr_t
;

46 
	toff_t
;

49 
	tu_ch¬
;

50 
	tu_shÜt
;

51 
	tu_št
;

52 
	tu_lÚg
;

55 
	tunch¬
;

56 
	tushÜt
;

57 
	tušt
;

58 
	tulÚg
;

60 *
	tÿddr_t
;

62 
	tcc_t
;

63 
	t¥“d_t
;

64 
	ttcæag_t
;

81 #undeà
__FDSET_LONGS


82 
	#__FDSET_LONGS
 8

	)

84 
	sfd_£t
 {

85 
	mfds_b™s
 [
__FDSET_LONGS
];

86 } 
	tfd_£t
;

88 #undeà
__NFDBITS


89 
	#__NFDBITS
 (8 * ())

	)

91 #undeà
__FD_SETSIZE


92 
	#__FD_SETSIZE
 (
__FDSET_LONGS
*
__NFDBITS
)

	)

94 #undeà
__FD_SET


95 
	#__FD_SET
(
fd
,
fd£
) \

96 
__asm__
 
	`__vŞ©e__
("btsl %1,%0": \

97 "=m" (*(
fd_£t
 *è(
fd£
)):"r" ((è(
fd
)))

	)

99 #undeà
__FD_CLR


100 
	#__FD_CLR
(
fd
,
fd£
) \

101 
__asm__
 
	`__vŞ©e__
("btrl %1,%0": \

102 "=m" (*(
fd_£t
 *è(
fd£
)):"r" ((è(
fd
)))

	)

104 #undeà
__FD_ISSET


105 
	#__FD_ISSET
(
fd
,
fd£
è(
	`__ex‹nsiÚ__
 ({ \

106 
__»suÉ
; \

107 
__asm__
 
	`__vŞ©e__
("btl %1,%2 ; setb %0" \

108 :"=q" (
__»suÉ
è:"r" ((è(
fd
)), \

109 "m" (*(
fd_£t
 *è(
fd£
))); \

110 
__»suÉ
; }))

	)

112 #undeà
__FD_ZERO


113 
	#__FD_ZERO
(
fd£
) \

114 
__asm__
 
	`__vŞ©e__
("cld ;„ep ; stosl" \

115 :"=m" (*(
fd_£t
 *è(
fd£
)) \

116 :"a" (0), "c" (
__FDSET_LONGS
), \

117 "D" ((
fd_£t
 *è(
fd£
)è:"cx","di")

	)

119 
	su¡©
 {

120 
daddr_t
 
	mf_tä“
;

121 
šo_t
 
	mf_tšode
;

122 
	mf_âame
[6];

123 
	mf_åack
[6];

	@include/linux/udp.h

17 #iâdeà
_LINUX_UDP_H


18 
	#_LINUX_UDP_H


	)

21 
	sudphdr
 {

22 
	msourû
;

23 
	mde¡
;

24 
	mËn
;

25 
	mcheck
;

	@include/linux/ultrasound.h

1 #iâdeà
_ULTRASOUND_H_


2 
	#_ULTRASOUND_H_


	)

71 
	#_GUS_NUMVOICES
 0x00

	)

72 
	#_GUS_VOICESAMPLE
 0x01

	)

73 
	#_GUS_VOICEON
 0x02

	)

74 
	#_GUS_VOICEOFF
 0x03

	)

75 
	#_GUS_VOICEMODE
 0x04

	)

76 
	#_GUS_VOICEBALA
 0x05

	)

77 
	#_GUS_VOICEFREQ
 0x06

	)

78 
	#_GUS_VOICEVOL
 0x07

	)

79 
	#_GUS_RAMPRANGE
 0x08

	)

80 
	#_GUS_RAMPRATE
 0x09

	)

81 
	#_GUS_RAMPMODE
 0x0a

	)

82 
	#_GUS_RAMPON
 0x0b

	)

83 
	#_GUS_RAMPOFF
 0x0c

	)

84 
	#_GUS_VOICEFADE
 0x0d

	)

85 
	#_GUS_VOLUME_SCALE
 0x0e

	)

86 
	#_GUS_VOICEVOL2
 0x0f

	)

87 
	#_GUS_VOICE_POS
 0x10

	)

93 
	#_GUS_CMD
(
chn
, 
voiû
, 
cmd
, 
p1
, 
p2
) \

94 {
	`_SEQ_NEEDBUF
(8); 
_£qbuf
[
_£qbuåŒ
] = 
SEQ_PRIVATE
;\

95 
_£qbuf
[
_£qbuåŒ
+1] = (
chn
); _£qbuf[_£qbuåŒ+2] = 
cmd
;\

96 
_£qbuf
[
_£qbuåŒ
+3] = 
voiû
;\

97 *(*)&
_£qbuf
[
_£qbuåŒ
+4] = 
p1
;\

98 *(*)&
_£qbuf
[
_£qbuåŒ
+6] = 
p2
;\

99 
	`_SEQ_ADVBUF
(8);}

	)

101 
	#GUS_NUMVOICES
(
chn
, 
p1
è
	`_GUS_CMD
(chn, 0, 
_GUS_NUMVOICES
, (p1), 0)

	)

102 
	#GUS_VOICESAMPLE
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICESAMPLE
, (p1), 0è

	)

103 
	#GUS_VOICEON
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEON
, (p1), 0)

	)

104 
	#GUS_VOICEOFF
(
chn
, 
voiû
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEOFF
, 0, 0)

	)

105 
	#GUS_VOICEFADE
(
chn
, 
voiû
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEFADE
, 0, 0)

	)

106 
	#GUS_VOICEMODE
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEMODE
, (p1), 0)

	)

107 
	#GUS_VOICEBALA
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEBALA
, (p1), 0)

	)

108 
	#GUS_VOICEFREQ
(
chn
, 
voiû
, 
p
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEFREQ
, \

109 (
p
è& 0xffff, (Õè>> 16è& 0xffff)

	)

110 
	#GUS_VOICEVOL
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEVOL
, (p1), 0)

	)

111 
	#GUS_VOICEVOL2
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICEVOL2
, (p1), 0)

	)

112 
	#GUS_RAMPRANGE
(
chn
, 
voiû
, 
low
, 
high
è
	`_GUS_CMD
(chn, voiû, 
_GUS_RAMPRANGE
, (low), (high))

	)

113 
	#GUS_RAMPRATE
(
chn
, 
voiû
, 
p1
, 
p2
è
	`_GUS_CMD
(chn, voiû, 
_GUS_RAMPRATE
, (p1), (p2))

	)

114 
	#GUS_RAMPMODE
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_RAMPMODE
, (p1), 0)

	)

115 
	#GUS_RAMPON
(
chn
, 
voiû
, 
p1
è
	`_GUS_CMD
(chn, voiû, 
_GUS_RAMPON
, (p1), 0)

	)

116 
	#GUS_RAMPOFF
(
chn
, 
voiû
è
	`_GUS_CMD
(chn, voiû, 
_GUS_RAMPOFF
, 0, 0)

	)

117 
	#GUS_VOLUME_SCALE
(
chn
, 
voiû
, 
p1
, 
p2
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOLUME_SCALE
, (p1), (p2))

	)

118 
	#GUS_VOICE_POS
(
chn
, 
voiû
, 
p
è
	`_GUS_CMD
(chn, voiû, 
_GUS_VOICE_POS
, \

119 (
p
è& 0xffff, (Õè>> 16è& 0xffff)

	)

	@include/linux/un.h

1 #iâdeà
_LINUX_UN_H


2 
	#_LINUX_UN_H


	)

4 
	ssockaddr_un
 {

5 
	msun_çmy
;

6 
	msun_·th
[108];

	@include/linux/unistd.h

1 #iâdeà
_LINUX_UNISTD_H


2 
	#_LINUX_UNISTD_H


	)

9 
	#__NR_£tup
 0

	)

10 
	#__NR_ex™
 1

	)

11 
	#__NR_fÜk
 2

	)

12 
	#__NR_»ad
 3

	)

13 
	#__NR_wr™e
 4

	)

14 
	#__NR_İ’
 5

	)

15 
	#__NR_şo£
 6

	)

16 
	#__NR_wa™pid
 7

	)

17 
	#__NR_ü—t
 8

	)

18 
	#__NR_lšk
 9

	)

19 
	#__NR_uÆšk
 10

	)

20 
	#__NR_execve
 11

	)

21 
	#__NR_chdœ
 12

	)

22 
	#__NR_time
 13

	)

23 
	#__NR_mknod
 14

	)

24 
	#__NR_chmod
 15

	)

25 
	#__NR_chown
 16

	)

26 
	#__NR_b»ak
 17

	)

27 
	#__NR_Şd¡©
 18

	)

28 
	#__NR_l£ek
 19

	)

29 
	#__NR_g‘pid
 20

	)

30 
	#__NR_mouÁ
 21

	)

31 
	#__NR_umouÁ
 22

	)

32 
	#__NR_£tuid
 23

	)

33 
	#__NR_g‘uid
 24

	)

34 
	#__NR_¡ime
 25

	)

35 
	#__NR_±¿û
 26

	)

36 
	#__NR_®¬m
 27

	)

37 
	#__NR_Şdf¡©
 28

	)

38 
	#__NR_·u£
 29

	)

39 
	#__NR_utime
 30

	)

40 
	#__NR_¡ty
 31

	)

41 
	#__NR_g‰y
 32

	)

42 
	#__NR_acûss
 33

	)

43 
	#__NR_niû
 34

	)

44 
	#__NR_áime
 35

	)

45 
	#__NR_sync
 36

	)

46 
	#__NR_kl
 37

	)

47 
	#__NR_»Çme
 38

	)

48 
	#__NR_mkdœ
 39

	)

49 
	#__NR_rmdœ
 40

	)

50 
	#__NR_dup
 41

	)

51 
	#__NR_pe
 42

	)

52 
	#__NR_times
 43

	)

53 
	#__NR_´of
 44

	)

54 
	#__NR_brk
 45

	)

55 
	#__NR_£tgid
 46

	)

56 
	#__NR_g‘gid
 47

	)

57 
	#__NR_sigÇl
 48

	)

58 
	#__NR_g‘euid
 49

	)

59 
	#__NR_g‘egid
 50

	)

60 
	#__NR_acù
 51

	)

61 
	#__NR_phys
 52

	)

62 
	#__NR_lock
 53

	)

63 
	#__NR_ioùl
 54

	)

64 
	#__NR_fú
 55

	)

65 
	#__NR_mpx
 56

	)

66 
	#__NR_£gid
 57

	)

67 
	#__NR_ulim™
 58

	)

68 
	#__NR_ŞdŞduÇme
 59

	)

69 
	#__NR_umask
 60

	)

70 
	#__NR_chroÙ
 61

	)

71 
	#__NR_u¡©
 62

	)

72 
	#__NR_dup2
 63

	)

73 
	#__NR_g‘µid
 64

	)

74 
	#__NR_g‘pg½
 65

	)

75 
	#__NR_£tsid
 66

	)

76 
	#__NR_sigaùiÚ
 67

	)

77 
	#__NR_sg‘mask
 68

	)

78 
	#__NR_s£tmask
 69

	)

79 
	#__NR_£Œeuid
 70

	)

80 
	#__NR_£Œegid
 71

	)

81 
	#__NR_sigsu¥’d
 72

	)

82 
	#__NR_sig³ndšg
 73

	)

83 
	#__NR_£tho¡Çme
 74

	)

84 
	#__NR_£Œlim™
 75

	)

85 
	#__NR_g‘¾im™
 76

	)

86 
	#__NR_g‘ru§ge
 77

	)

87 
	#__NR_g‘timeofday
 78

	)

88 
	#__NR_£‰imeofday
 79

	)

89 
	#__NR_g‘groups
 80

	)

90 
	#__NR_£tgroups
 81

	)

91 
	#__NR_£Ëù
 82

	)

92 
	#__NR_symlšk
 83

	)

93 
	#__NR_Şdl¡©
 84

	)

94 
	#__NR_»adlšk
 85

	)

95 
	#__NR_u£lib
 86

	)

96 
	#__NR_sw­Ú
 87

	)

97 
	#__NR_»boÙ
 88

	)

98 
	#__NR_»addœ
 89

	)

99 
	#__NR_mm­
 90

	)

100 
	#__NR_munm­
 91

	)

101 
	#__NR_Œunÿ‹
 92

	)

102 
	#__NR_árunÿ‹
 93

	)

103 
	#__NR_fchmod
 94

	)

104 
	#__NR_fchown
 95

	)

105 
	#__NR_g‘´iÜ™y
 96

	)

106 
	#__NR_£riÜ™y
 97

	)

107 
	#__NR_´of
 98

	)

108 
	#__NR_¡©fs
 99

	)

109 
	#__NR_f¡©fs
 100

	)

110 
	#__NR_iİ”m
 101

	)

111 
	#__NR_sock‘ÿÎ
 102

	)

112 
	#__NR_sy¦og
 103

	)

113 
	#__NR_£t™im”
 104

	)

114 
	#__NR_g‘™im”
 105

	)

115 
	#__NR_¡©
 106

	)

116 
	#__NR_l¡©
 107

	)

117 
	#__NR_f¡©
 108

	)

118 
	#__NR_ŞduÇme
 109

	)

119 
	#__NR_iİl
 110

	)

120 
	#__NR_vhªgup
 111

	)

121 
	#__NR_idË
 112

	)

122 
	#__NR_vm86
 113

	)

123 
	#__NR_wa™4
 114

	)

124 
	#__NR_sw­off
 115

	)

125 
	#__NR_sysšfo
 116

	)

126 
	#__NR_c
 117

	)

127 
	#__NR_fsync
 118

	)

128 
	#__NR_sig»tuº
 119

	)

129 
	#__NR_şÚe
 120

	)

130 
	#__NR_£tdomašÇme
 121

	)

131 
	#__NR_uÇme
 122

	)

132 
	#__NR_modify_ldt
 123

	)

133 
	#__NR_adjtimex
 124

	)

134 
	#__NR_m´Ùeù
 125

	)

135 
	#__NR_sig´ocmask
 126

	)

136 
	#__NR_ü—‹_moduË
 127

	)

137 
	#__NR_š™_moduË
 128

	)

138 
	#__NR_d–‘e_moduË
 129

	)

139 
	#__NR_g‘_k”Ãl_syms
 130

	)

140 
	#__NR_quÙaùl
 131

	)

141 
	#__NR_g‘pgid
 132

	)

142 
	#__NR_fchdœ
 133

	)

143 
	#__NR_bdæush
 134

	)

145 
”ºo
;

148 
	#_sysÿÎ0
(
ty³
,
Çme
) \

149 
ty³
 
	`Çme
() \

151 
__»s
; \

152 
__asm__
 volatile ("int $0x80" \

153 : "÷" (
__»s
) \

154 : "0" (
__NR_
##
Çme
)); \

155 ià(
__»s
 >= 0) \

156  (
ty³
è
__»s
; \

157 
”ºo
 = -
__»s
; \

159 }

	)

161 
	#_sysÿÎ1
(
ty³
,
Çme
,
©y³
,
a
) \

162 
ty³
 
	`Çme
(
©y³
 
a
) \

164 
__»s
; \

165 
__asm__
 volatile ("int $0x80" \

166 : "÷" (
__»s
) \

167 : "0" (
__NR_
##
Çme
),"b" (()(
a
))); \

168 ià(
__»s
 >= 0) \

169  (
ty³
è
__»s
; \

170 
”ºo
 = -
__»s
; \

172 }

	)

174 
	#_sysÿÎ2
(
ty³
,
Çme
,
©y³
,
a
,
bty³
,
b
) \

175 
ty³
 
	`Çme
(
©y³
 
a
,
bty³
 
b
) \

177 
__»s
; \

178 
__asm__
 volatile ("int $0x80" \

179 : "÷" (
__»s
) \

180 : "0" (
__NR_
##
Çme
),"b" (()(
a
)),"c" (()(
b
))); \

181 ià(
__»s
 >= 0) \

182  (
ty³
è
__»s
; \

183 
”ºo
 = -
__»s
; \

185 }

	)

187 
	#_sysÿÎ3
(
ty³
,
Çme
,
©y³
,
a
,
bty³
,
b
,
ùy³
,
c
) \

188 
ty³
 
	`Çme
(
©y³
 
a
,
bty³
 
b
,
ùy³
 
c
) \

190 
__»s
; \

191 
__asm__
 volatile ("int $0x80" \

192 : "÷" (
__»s
) \

193 : "0" (
__NR_
##
Çme
),"b" (()(
a
)),"c" (()(
b
)),"d" (()(
c
))); \

194 ià(
__»s
>=0) \

195  (
ty³
è
__»s
; \

196 
”ºo
=-
__»s
; \

198 }

	)

200 
	#_sysÿÎ4
(
ty³
,
Çme
,
©y³
,
a
,
bty³
,
b
,
ùy³
,
c
,
dty³
,
d
) \

201 
ty³
 
	`Çme
 (
©y³
 
a
, 
bty³
 
b
, 
ùy³
 
c
, 
dty³
 
d
) \

203 
__»s
; \

204 
__asm__
 volatile ("int $0x80" \

205 : "÷" (
__»s
) \

206 : "0" (
__NR_
##
Çme
),"b" (()(
a
)),"c" (()(
b
)), \

207 "d" (()(
c
)),"S" (()(
d
))); \

208 ià(
__»s
>=0) \

209  (
ty³
è
__»s
; \

210 
”ºo
=-
__»s
; \

212 }

	)

214 
	#_sysÿÎ5
(
ty³
,
Çme
,
©y³
,
a
,
bty³
,
b
,
ùy³
,
c
,
dty³
,
d
,
‘y³
,
e
) \

215 
ty³
 
	`Çme
 (
©y³
 
a
,
bty³
 
b
,
ùy³
 
c
,
dty³
 
d
,
‘y³
 
e
) \

217 
__»s
; \

218 
__asm__
 volatile ("int $0x80" \

219 : "÷" (
__»s
) \

220 : "0" (
__NR_
##
Çme
),"b" (()(
a
)),"c" (()(
b
)), \

221 "d" (()(
c
)),"S" (()(
d
)),"D" (()(
e
))); \

222 ià(
__»s
>=0) \

223  (
ty³
è
__»s
; \

224 
”ºo
=-
__»s
; \

226 }

	)

	@include/linux/user.h

1 #iâdeà
_LINUX_USER_H


2 
	#_LINUX_USER_H


	)

4 
	~<lšux/±¿û.h
>

32 
	su£r_i387_¡ruù
 {

33 
	mcwd
;

34 
	mswd
;

35 
	mtwd
;

36 
	mf
;

37 
	mfcs
;

38 
	mfoo
;

39 
	mfos
;

40 
	m¡_¥aû
[20];

46 
	su£r
{

49 
±_»gs
 
	m»gs
;

51 
	mu_åv®id
;

53 
u£r_i387_¡ruù
 
	mi387
;

55 
	mu_tsize
;

56 
	mu_dsize
;

57 
	mu_ssize
;

58 
	m¡¬t_code
;

59 
	m¡¬t_¡ack
;

63 
	msigÇl
;

64 
	m»£rved
;

65 
±_»gs
 * 
	mu_¬0
;

67 
u£r_i387_¡ruù
* 
	mu_å¡©e
;

68 
	mmagic
;

69 
	mu_comm
[32];

70 
	mu_debug»g
[8];

72 
	#NBPG
 4096

	)

73 
	#UPAGES
 1

	)

74 
	#HOST_TEXT_START_ADDR
 (
u
.
¡¬t_code
)

	)

75 
	#HOST_STACK_END_ADDR
 (
u
.
¡¬t_¡ack
 + u.
u_ssize
 * 
NBPG
)

	)

	@include/linux/utime.h

1 #iâdeà
_LINUX_UTIME_H


2 
	#_LINUX_UTIME_H


	)

4 
	sutimbuf
 {

5 
time_t
 
	maùime
;

6 
time_t
 
	mmodtime
;

	@include/linux/utsname.h

1 #iâdeà
_LINUX_UTSNAME_H


2 
	#_LINUX_UTSNAME_H


	)

4 
	#__OLD_UTS_LEN
 8

	)

6 
	sŞdŞd_ut¢ame
 {

7 
	msy¢ame
[9];

8 
	mnod’ame
[9];

9 
	m»Ëa£
[9];

10 
	mv”siÚ
[9];

11 
	mmachše
[9];

14 
	#__NEW_UTS_LEN
 64

	)

16 
	sŞd_ut¢ame
 {

17 
	msy¢ame
[65];

18 
	mnod’ame
[65];

19 
	m»Ëa£
[65];

20 
	mv”siÚ
[65];

21 
	mmachše
[65];

24 
	sÃw_ut¢ame
 {

25 
	msy¢ame
[65];

26 
	mnod’ame
[65];

27 
	m»Ëa£
[65];

28 
	mv”siÚ
[65];

29 
	mmachše
[65];

30 
	mdomašÇme
[65];

33 
Ãw_ut¢ame
 
sy¡em_ut¢ame
;

	@include/linux/vfs.h

1 #iâdeà
_LINUX_VFS_H


2 
	#_LINUX_VFS_H


	)

5 
	mv®
[2];

6 } 
	tfsid_t
;

8 
	s¡©fs
 {

9 
	mf_ty³
;

10 
	mf_bsize
;

11 
	mf_blocks
;

12 
	mf_bä“
;

13 
	mf_bava
;

14 
	mf_fes
;

15 
	mf_fä“
;

16 
fsid_t
 
	mf_fsid
;

17 
	mf_Çm–’
;

18 
	mf_¥¬e
[6];

	@include/linux/vm86.h

1 #iâdeà
_LINUX_VM86_H


2 
	#_LINUX_VM86_H


	)

4 
	#VM_MASK
 0x00020000

	)

15 
	svm86_»gs
 {

19 
	mebx
;

20 
	mecx
;

21 
	medx
;

22 
	mesi
;

23 
	medi
;

24 
	mebp
;

25 
	m—x
;

26 
	m__nuÎ_ds
;

27 
	m__nuÎ_es
;

28 
	m__nuÎ_fs
;

29 
	m__nuÎ_gs
;

30 
	mÜig_—x
;

31 
	me
;

32 
	mcs
;

33 
	meæags
;

34 
	me¥
;

35 
	mss
;

39 
	mes
;

40 
	mds
;

41 
	mfs
;

42 
	mgs
;

45 
	svm86_¡ruù
 {

46 
vm86_»gs
 
	m»gs
;

47 
	mæags
;

48 
	msü“n_b™m­
;

54 
	#VM86_SCREEN_BITMAP
 1

	)

	@include/linux/vt.h

1 #iâdeà
_LINUX_VT_H


2 
	#_LINUX_VT_H


	)

6 
	#VT_OPENQRY
 0x5600

	)

8 
	svt_mode
 {

9 
	mmode
;

10 
	mwa™v
;

11 
	m»lsig
;

12 
	macqsig
;

13 
	mäsig
;

15 
	#VT_GETMODE
 0x5601

	)

16 
	#VT_SETMODE
 0x5602

	)

17 
	#VT_AUTO
 0x00

	)

18 
	#VT_PROCESS
 0x01

	)

19 
	#VT_ACKACQ
 0x02

	)

21 
	svt_¡©
 {

22 
ushÜt
 
	mv_aùive
;

23 
ushÜt
 
	mv_sigÇl
;

24 
ushÜt
 
	mv_¡©e
;

26 
	#VT_GETSTATE
 0x5603

	)

27 
	#VT_SENDSIG
 0x5604

	)

29 
	#VT_RELDISP
 0x5605

	)

31 
	#VT_ACTIVATE
 0x5606

	)

32 
	#VT_WAITACTIVE
 0x5607

	)

	@include/linux/wait.h

1 #iâdeà
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

7 
	#__WCLONE
 0x80000000

	)

9 
	swa™_queue
 {

10 
sk_¡ruù
 * 
	msk
;

11 
wa™_queue
 * 
	mÃxt
;

14 
	s£m­hÜe
 {

15 
	mcouÁ
;

16 
wa™_queue
 * 
	mwa™
;

19 
	#MUTEX
 ((
£m­hÜe
è{ 1, 
NULL
 })

	)

21 
	s£Ëù_bË_’Œy
 {

22 
wa™_queue
 
	mwa™
;

23 
wa™_queue
 ** 
	mwa™_add»ss
;

26 
	s£Ëù_bË_¡ruù
 {

27 
	mÄ
;

28 
£Ëù_bË_’Œy
 * 
	m’Œy
;

29 } 
	t£Ëù_bË
;

31 
	#__MAX_SELECT_TABLE_ENTRIES
 (4096 /  (
£Ëù_bË_’Œy
))

	)

	@include/linux/xd.h

1 #iâdeà
_LINUX_XD_H


2 
	#_LINUX_XD_H


	)

17 
	#XD_DATA
 (
xd_ioba£
 + 0x00è

	)

18 
	#XD_RESET
 (
xd_ioba£
 + 0x01è

	)

19 
	#XD_STATUS
 (
xd_ioba£
 + 0x01è

	)

20 
	#XD_SELECT
 (
xd_ioba£
 + 0x02è

	)

21 
	#XD_JUMPER
 (
xd_ioba£
 + 0x02è

	)

22 
	#XD_CONTROL
 (
xd_ioba£
 + 0x03è

	)

23 
	#XD_RESERVED
 (
xd_ioba£
 + 0x03è

	)

26 
	#CMD_TESTREADY
 0x00

	)

27 
	#CMD_RECALIBRATE
 0x01

	)

28 
	#CMD_SENSE
 0x03

	)

29 
	#CMD_FORMATDRV
 0x04

	)

30 
	#CMD_VERIFY
 0x05

	)

31 
	#CMD_FORMATTRK
 0x06

	)

32 
	#CMD_FORMATBAD
 0x07

	)

33 
	#CMD_READ
 0x08

	)

34 
	#CMD_WRITE
 0x0A

	)

35 
	#CMD_SEEK
 0x0B

	)

38 
	#CMD_DTCSETPARAM
 0x0C

	)

39 
	#CMD_DTCGETECC
 0x0D

	)

40 
	#CMD_DTCREADBUF
 0x0E

	)

41 
	#CMD_DTCWRITEBUF
 0x0F

	)

42 
	#CMD_DTCREMAPTRK
 0x11

	)

43 
	#CMD_DTCGETPARAM
 0xFB

	)

44 
	#CMD_DTCSETSTEP
 0xFC

	)

45 
	#CMD_DTCSETGEOM
 0xFE

	)

46 
	#CMD_DTCGETGEOM
 0xFF

	)

47 
	#CMD_ST11GETGEOM
 0xF8

	)

48 
	#CMD_WDSETPARAM
 0x0C

	)

51 
	#CSB_ERROR
 0x02

	)

52 
	#CSB_LUN
 0x20

	)

55 
	#STAT_READY
 0x01

	)

56 
	#STAT_INPUT
 0x02

	)

57 
	#STAT_COMMAND
 0x04

	)

58 
	#STAT_SELECT
 0x08

	)

59 
	#STAT_REQUEST
 0x10

	)

60 
	#STAT_INTERRUPT
 0x20

	)

63 
	#PIO_MODE
 0x00

	)

64 
	#DMA_MODE
 0x03

	)

66 
	#XD_MAXDRIVES
 2

	)

67 
	#XD_TIMEOUT
 100

	)

68 
	#XD_RETRIES
 4

	)

70 #undeà
DEBUG


72 #ifdeà
DEBUG


73 
	#DEBUG_STARTUP


	)

74 
	#DEBUG_OVERRIDE


	)

75 
	#DEBUG_READWRITE


	)

76 
	#DEBUG_OTHER


	)

77 
	#DEBUG_COMMAND


	)

82 
u_ch¬
 
	mh—ds
;

83 
u_shÜt
 
	mcylšd”s
;

84 
u_ch¬
 
	m£ùÜs
;

85 
u_ch¬
 
	mcÚŒŞ
;

86 } 
	tXD_INFO
;

88 
	#HDIO_GETGEO
 0x0301

	)

92 
u_ch¬
 
	mh—ds
;

93 
u_ch¬
 
	m£ùÜs
;

94 
u_shÜt
 
	mcylšd”s
;

95 
u_lÚg
 
	m¡¬t
;

96 } 
	tXD_GEOMETRY
;

100 
u_lÚg
 
	moff£t
;

101 *
	m¡ršg
;

102 (*
	mš™_cÚŒŞËr
)(
u_ch¬
 *
	madd»ss
);

103 (*
	mš™_drive
)(
u_ch¬
 
	mdrive
);

104 *
	mÇme
;

105 } 
	tXD_SIGNATURE
;

107 
u_lÚg
 
xd_š™
 (u_lÚg 
mem_¡¬t
,u_lÚg 
mem_’d
);

108 
xd_£tup
 (*
commªd
,*
š‹g”s
);

109 
u_ch¬
 
xd_d‘eù
 (u_ch¬ *
cÚŒŞËr
,u_ch¬ **
add»ss
);

110 
u_ch¬
 
xd_š™drives
 ((*
š™_drive
)(u_ch¬ 
drive
));

111 
	`xd_g’š™
 ();

113 
	`xd_İ’
 (
šode
 *šode,
fe
 *file);

114 
	`do_xd_»que¡
 ();

115 
	`xd_ioùl
 (
šode
 *šode,
fe
 *fe,
cmd
,
¬g
);

116 
	`xd_»Ëa£
 (
šode
 *šode,
fe
 *file);

117 
	`xd_»»ad_·¹™iÚs
 (
dev
);

118 
	`xd_»adwr™e
 (
u_ch¬
 
İ”©iÚ
,u_ch¬ 
drive
,*
bufãr
,
u_št
 
block
,u_šˆ
couÁ
);

119 
	`xd_»ÿlib¿‹
 (
u_ch¬
 
drive
);

121 
	`xd_š‹¼u±_hªdËr
 (
unu£d
);

122 
u_ch¬
 
	`xd_£tup_dma
 (u_ch¬ 
İcode
,u_ch¬ *
bufãr
,
u_št
 
couÁ
);

123 
u_ch¬
 *
	`xd_bud
 (u_ch¬ *
cmdblk
,u_ch¬ 
commªd
,u_ch¬ 
drive
,u_ch¬ 
h—d
,
u_shÜt
 
cylšd”
,u_ch¬ 
£ùÜ
,u_ch¬ 
couÁ
,u_ch¬ 
cÚŒŞ
);

124 
šlše
 
u_ch¬
 
	`xd_wa™pÜt
 (
u_shÜt
 
pÜt
,u_ch¬ 
æags
,u_ch¬ 
mask
,
u_lÚg
 
timeout
);

125 
u_št
 
	`xd_commªd
 (
u_ch¬
 *
commªd
,u_ch¬ 
mode
,u_ch¬ *
šd©a
,u_ch¬ *
outd©a
,u_ch¬ *
£n£
,
u_lÚg
 
timeout
);

128 
	`xd_dtc_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
);

129 
	`xd_dtc_š™_drive
 (
u_ch¬
 
drive
);

130 
	`xd_wd_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
);

131 
	`xd_wd_š™_drive
 (
u_ch¬
 
drive
);

132 
	`xd_£ag©e_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
);

133 
	`xd_£ag©e_š™_drive
 (
u_ch¬
 
drive
);

134 
	`xd_omti_š™_cÚŒŞËr
 (
u_ch¬
 *
add»ss
);

135 
	`xd_omti_š™_drive
 (
u_ch¬
 
drive
);

136 
	`xd_£¬am
 (
u_ch¬
 
commªd
,u_ch¬ 
drive
,u_ch¬ 
h—ds
,
u_shÜt
 
cylšd”s
,u_shÜˆ
rwr™e
,u_shÜˆ
w´ecomp
,u_ch¬ 
ecc
);

137 
	`xd_ov”ride_š™_drive
 (
u_ch¬
 
drive
);

	@include/linux/xia_fs.h

1 #iâdeà
_XIA_FS_H


2 
	#_XIA_FS_H


	)

13 
	#_XIAFS_SUPER_MAGIC
 0x012FD16D

	)

14 
	#_XIAFS_ROOT_INO
 1

	)

15 
	#_XIAFS_BAD_INO
 2

	)

17 
	#_XIAFS_NAME_LEN
 248

	)

19 
	#_XIAFS_INODES_PER_BLOCK
 ((
BLOCK_SIZE
)/((
xŸfs_šode
)))

	)

21 
	sxŸfs_šode
 {

22 
mode_t
 
	mi_mode
;

23 
Æšk_t
 
	mi_Æšks
;

24 
uid_t
 
	mi_uid
;

25 
gid_t
 
	mi_gid
;

26 
size_t
 
	mi_size
;

27 
time_t
 
	mi_ùime
;

28 
time_t
 
	mi_©ime
;

29 
time_t
 
	mi_mtime
;

30 
daddr_t
 
	mi_zÚe
[8];

31 
daddr_t
 
	mi_šd_zÚe
;

32 
daddr_t
 
	mi_dšd_zÚe
;

38 
	sxŸfs_su³r_block
 {

39 
u_ch¬
 
	ms_boÙ_£gm’t
[512];

40 
u_lÚg
 
	ms_zÚe_size
;

41 
u_lÚg
 
	ms_nzÚes
;

42 
u_lÚg
 
	ms_nšodes
;

43 
u_lÚg
 
	ms_nd©azÚes
;

44 
u_lÚg
 
	ms_im­_zÚes
;

45 
u_lÚg
 
	ms_zm­_zÚes
;

46 
u_lÚg
 
	ms_fœ¡d©azÚe
;

47 
u_lÚg
 
	ms_zÚe_shiá
;

48 
u_lÚg
 
	ms_max_size
;

49 
u_lÚg
 
	ms_»£rved0
;

50 
u_lÚg
 
	ms_»£rved1
;

51 
u_lÚg
 
	ms_»£rved2
;

52 
u_lÚg
 
	ms_»£rved3
;

53 
u_lÚg
 
	ms_fœ¡k”nzÚe
;

54 
u_lÚg
 
	ms_k”nzÚes
;

55 
u_lÚg
 
	ms_magic
;

58 
	sxŸfs_dœeù
 {

59 
šo_t
 
	md_šo
;

60 
u_shÜt
 
	md_»c_Ën
;

61 
u_ch¬
 
	md_Çme_Ën
;

62 
	md_Çme
[
_XIAFS_NAME_LEN
+1];

65 
xŸfs_lookup
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
,

66 
šode
 ** 
»suÉ
);

67 
xŸfs_ü—‹
(
šode
 * 
dœ
,cÚ¡ * 
Çme
, 
Ën
, 
mode
,

68 
šode
 ** 
»suÉ
);

69 
xŸfs_mkdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
, 
mode
);

70 
xŸfs_rmdœ
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

71 
xŸfs_uÆšk
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
);

72 
xŸfs_symlšk
(
šode
 * inode, cÚ¡ * 
Çme
, 
Ën
,

73 cÚ¡ * 
symÇme
);

74 
xŸfs_lšk
(
šode
 * 
Şdšode
, šod* 
dœ
,

75 cÚ¡ * 
Çme
, 
Ën
);

76 
xŸfs_mknod
(
šode
 * 
dœ
, cÚ¡ * 
Çme
, 
Ën
,

77 
mode
, 
rdev
);

78 
xŸfs_»Çme
(
šode
 * 
Şd_dœ
, cÚ¡ * 
Şd_Çme
,

79 
Şd_Ën
, 
šode
 * 
Ãw_dœ
,

80 cÚ¡ * 
Ãw_Çme
, 
Ãw_Ën
);

81 
šode
 * 
xŸfs_Ãw_šode
(šod* 
dœ
);

82 
xŸfs_ä“_šode
(
šode
 * inode);

83 
xŸfs_couÁ_ä“_šodes
(
su³r_block
 *
sb
);

84 
xŸfs_Ãw_zÚe
(
su³r_block
 * 
sb
, 
u_lÚg
 
´ev_addr
);

85 
xŸfs_ä“_zÚe
(
su³r_block
 * 
sb
, 
block
);

86 
xŸfs_couÁ_ä“_zÚes
(
su³r_block
 *
sb
);

88 
xŸfs_bm­
(
šode
 *,);

90 
bufãr_h—d
 * 
xŸfs_g‘blk
(
šode
 *, , );

91 
bufãr_h—d
 * 
xŸfs_b»ad
(
šode
 *, , );

93 
xŸfs_Œunÿ‹
(
šode
 *);

94 
xŸfs_put_su³r
(
su³r_block
 *);

95 
su³r_block
 *
xŸfs_»ad_su³r
(super_block *,*,);

96 
xŸfs_»ad_šode
(
šode
 *);

97 
xŸfs_wr™e_šode
(
šode
 *);

98 
xŸfs_put_šode
(
šode
 *);

99 
xŸfs_¡©fs
(
su³r_block
 *, 
¡©fs
 *);

100 
xŸfs_sync_šode
(
šode
 *);

101 
xŸfs_sync_fe
(
šode
 *, 
fe
 *);

103 
šode_İ”©iÚs
 
xŸfs_fe_šode_İ”©iÚs
;

104 
šode_İ”©iÚs
 
xŸfs_dœ_šode_İ”©iÚs
;

105 
šode_İ”©iÚs
 
xŸfs_symlšk_šode_İ”©iÚs
;

	@include/linux/xia_fs_i.h

1 #iâdeà
_XIA_FS_I_H


2 
	#_XIA_FS_I_H


	)

13 
	sxŸfs_šode_šfo
 {

14 
	mi_zÚe
[8];

15 
	mi_šd_zÚe
;

16 
	mi_dšd_zÚe
;

	@include/linux/xia_fs_sb.h

1 #iâdeà
_XIA_FS_SB_H


2 
	#_XIA_FS_SB_H


	)

13 
	#_XIAFS_IMAP_SLOTS
 8

	)

14 
	#_XIAFS_ZMAP_SLOTS
 32

	)

16 
	sxŸfs_sb_šfo
 {

17 
u_lÚg
 
	ms_nzÚes
;

18 
u_lÚg
 
	ms_nšodes
;

19 
u_lÚg
 
	ms_nd©azÚes
;

20 
u_lÚg
 
	ms_im­_zÚes
;

21 
u_lÚg
 
	ms_zm­_zÚes
;

22 
u_lÚg
 
	ms_fœ¡d©azÚe
;

23 
u_lÚg
 
	ms_zÚe_shiá
;

24 
u_lÚg
 
	ms_max_size
;

25 
bufãr_h—d
 * 
	ms_im­_buf
[
_XIAFS_IMAP_SLOTS
];

26 
bufãr_h—d
 * 
	ms_zm­_buf
[
_XIAFS_ZMAP_SLOTS
];

27 
	ms_im­_izÄ
[
_XIAFS_IMAP_SLOTS
];

28 
	ms_zm­_zzÄ
[
_XIAFS_ZMAP_SLOTS
];

29 
u_ch¬
 
	ms_im­_ÿched
;

30 
u_ch¬
 
	ms_zm­_ÿched
;

	@init/main.c

7 
	~<¡d¬g.h
>

9 
	~<asm/sy¡em.h
>

10 
	~<asm/io.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/fú.h
>

14 
	~<lšux/cÚfig.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/‰y.h
>

17 
	~<lšux/h—d.h
>

18 
	~<lšux/uni¡d.h
>

19 
	~<lšux/¡ršg.h
>

20 
	~<lšux/tim”.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/ùy³.h
>

23 
	~<lšux/d–ay.h
>

24 
	~<lšux/ut¢ame.h
>

25 
	~<lšux/iİÜt.h
>

27 * 
´of_bufãr
;

28 
´oãn
;

29 
ed©a
, 
’d
;

30 *
lšux_bªÃr
;

31 
asmlškage
 
lÿÎ7
();

32 
desc_¡ruù
 
	gdeçuÉ_ldt
;

46 
	#__NR__ex™
 
__NR_ex™


	)

47 
šlše
 
	$_sysÿÎ0
(,
idË
)

48 
šlše
 
	$_sysÿÎ0
(,
fÜk
)

49 
šlše
 
	$_sysÿÎ0
(,
·u£
)

50 
šlše
 
	$_sysÿÎ1
(,
£tup
,*,
BIOS
)

51 
šlše
 
	$_sysÿÎ0
(,
sync
)

52 
šlše
 
	$_sysÿÎ0
(
pid_t
,
£tsid
)

53 
šlše
 
	$_sysÿÎ3
(,
wr™e
,,
fd
,cÚ¡ *,
buf
,
off_t
,
couÁ
)

54 
šlše
 
	$_sysÿÎ1
(,
dup
,,
fd
)

55 
šlše
 
	$_sysÿÎ3
(,
execve
,cÚ¡ *,
fe
,**,
¬gv
,**,
’vp
)

56 
šlše
 
	$_sysÿÎ3
(,
İ’
,cÚ¡ *,
fe
,,
æag
,,
mode
)

57 
šlše
 
	$_sysÿÎ1
(,
şo£
,,
fd
)

58 
šlše
 
	$_sysÿÎ1
(,
_ex™
,,
ex™code
)

59 
šlše
 
	$_sysÿÎ3
(
pid_t
,
wa™pid
,pid_t,
pid
,*,
wa™_¡©
,,
İtiÚs
)

61 
šlše
 
pid_t
 
	$wa™
(* 
wa™_¡©
)

63  
	`wa™pid
(-1,
wa™_¡©
,0);

64 
	}
}

66 
	g´štbuf
[1024];

68 
cÚsŞe_logËv–
;

70 
em±y_z”o_·ge
[
PAGE_SIZE
];

71 
v¥rštf
(*,cÚ¡ *,
va_li¡
);

72 
š™
();

73 
š™_IRQ
();

74 
km®loc_š™
 (,);

75 
blk_dev_š™
(,);

76 
chr_dev_š™
(,);

77 
æİpy_š™
();

78 
sock_š™
();

79 
rd_š™
(
mem_¡¬t
, 
Ëngth
);

80 
Ãt_dev_š™
(, );

81 
sim¶e_¡¹oul
(const *,**,);

83 
hd_£tup
(*
¡r
, *
šts
);

84 
bmou£_£tup
(*
¡r
, *
šts
);

85 
‘h_£tup
(*
¡r
, *
šts
);

86 
xd_£tup
(*
¡r
, *
šts
);

87 
mcd_£tup
(*
¡r
, *
šts
);

88 
¡0x_£tup
(*
¡r
, *
šts
);

89 
tmc8xx_£tup
(*
¡r
, *
šts
);

90 
t128_£tup
(*
¡r
, *
šts
);

91 
g’”ic_NCR5380_£tup
(*
¡r
, *
šŒ
);

92 
aha152x_£tup
(*
¡r
, *
šts
);

93 
sound_£tup
(*
¡r
, *
šts
);

94 #ifdeà
CONFIG_SBPCD


95 
sbpcd_£tup
(*
¡r
, *
šts
);

98 #ifdeà
CONFIG_SYSVIPC


99 
c_š™
();

101 #ifdeà
CONFIG_SCSI


102 
scsi_dev_š™
(, );

108 
	#PARAM
 
em±y_z”o_·ge


	)

109 
	#EXT_MEM_K
 (*(*è(
PARAM
+2))

	)

110 
	#DRIVE_INFO
 (*(
drive_šfo_¡ruù
 *è(
PARAM
+0x80))

	)

111 
	#SCREEN_INFO
 (*(
sü“n_šfo
 *è(
PARAM
+0))

	)

112 
	#MOUNT_ROOT_RDONLY
 (*(*è(
PARAM
+0x1F2))

	)

113 
	#RAMDISK_SIZE
 (*(*è(
PARAM
+0x1F8))

	)

114 
	#ORIG_ROOT_DEV
 (*(*è(
PARAM
+0x1FC))

	)

115 
	#AUX_DEVICE_INFO
 (*(*è(
PARAM
+0x1FF))

	)

120 
	#MAX_INIT_ARGS
 8

	)

121 
	#MAX_INIT_ENVS
 8

	)

122 
	#COMMAND_LINE
 ((*è(
PARAM
+2048))

	)

124 
time_š™
();

126 
	gmemÜy_¡¬t
 = 0;

128 
	gmemÜy_’d
 = 0;

129 
	glow_memÜy_¡¬t
 = 0;

131 
	g‹rm
[21];

132 
	grows
, 
	gcŞs
;

134 * 
	g¬gv_š™
[
MAX_INIT_ARGS
+2] = { "š™", 
NULL
, };

135 * 
	g’vp_š™
[
MAX_INIT_ENVS
+2] = { "HOME=/", 
‹rm
, 
NULL
, };

137 * 
	g¬gv_rc
[] = { "/bš/sh", 
NULL
 };

138 * 
	g’vp_rc
[] = { "HOME=/", 
‹rm
, 
NULL
 };

140 * 
	g¬gv
[] = { "-/bš/sh",
NULL
 };

141 * 
	g’vp
[] = { "HOME=/u¤/roÙ", 
‹rm
, 
NULL
 };

143 
	sdrive_šfo_¡ruù
 { 
	mdummy
[32]; } 
	gdrive_šfo
;

144 
sü“n_šfo
 
	gsü“n_šfo
;

146 
	gaux_deviû_´e£Á
;

147 
	g¿mdisk_size
;

148 
	groÙ_mouÁæags
 = 0;

150 
	gåu_”rÜ
 = 0;

152 
	gcommªd_lše
[80] = { 0, };

154 *
	$g‘_İtiÚs
(*
¡r
, *
šts
)

156 *
cur
 = 
¡r
;

157 
i
=1;

159 
cur
 && 
	`isdig™
(*curè&& 
i
 <= 10) {

160 
šts
[
i
++] = 
	`sim¶e_¡¹oul
(
cur
,
NULL
,0);

161 ià((
cur
 = 
	`¡rchr
(cur,',')è!ğ
NULL
)

162 
cur
++;

164 
šts
[0] = 
i
-1;

165 (
cur
);

166 
	}
}

169 *
	m¡r
;

170 (*
	m£tup_func
)(*, *);

171 } 
	gboÙ£tups
[] = {

172 { "»£rve=", 
»£rve_£tup
 },

173 #ifdeà
CONFIG_INET


174 { "‘h”=", 
‘h_£tup
 },

176 #ifdeà
CONFIG_BLK_DEV_HD


177 { "hd=", 
hd_£tup
 },

179 #ifdeà
CONFIG_BUSMOUSE


180 { "bmou£=", 
bmou£_£tup
 },

182 #ifdeà
CONFIG_SCSI_SEAGATE


183 { "¡0x=", 
¡0x_£tup
 },

184 { "tmc8xx=", 
tmc8xx_£tup
 },

186 #ifdeà
CONFIG_SCSI_T128


187 { "t128=", 
t128_£tup
 },

189 #ifdeà
CONFIG_SCSI_GENERIC_NCR5380


190 { "nü5380=", 
g’”ic_NCR5380_£tup
 },

192 #ifdeà
CONFIG_SCSI_AHA152X


193 { "aha152x=", 
aha152x_£tup
},

195 #ifdeà
CONFIG_BLK_DEV_XD


196 { "xd=", 
xd_£tup
 },

198 #ifdeà
CONFIG_MCD


199 { "mcd=", 
mcd_£tup
 },

201 #ifdeà
CONFIG_SOUND


202 { "sound=", 
sound_£tup
 },

204 #ifdeà
CONFIG_SBPCD


205 { "sbpcd=", 
sbpcd_£tup
 },

210 
	$check£tup
(*
lše
)

212 
i
 = 0;

213 
šts
[11];

215 
boÙ£tups
[
i
].
¡r
) {

216 
n
 = 
	`¡¾’
(
boÙ£tups
[
i
].
¡r
);

217 ià(!
	`¡ºcmp
(
lše
,
boÙ£tups
[
i
].
¡r
,
n
)) {

218 
boÙ£tups
[
i
].
	`£tup_func
(
	`g‘_İtiÚs
(
lše
+
n
,
šts
), ints);

221 
i
++;

224 
	}
}

226 
	gloİs_³r_£c
 = 1;

228 
	$ÿlib¿‹_d–ay
()

230 
ticks
;

232 
	`´štk
("Calibrating delay†oop.. ");

233 
loİs_³r_£c
 <<= 1) {

234 
ticks
 = 
jiff›s
;

235 
	`__d–ay
(
loİs_³r_£c
);

236 
ticks
 = 
jiff›s
 -icks;

237 ià(
ticks
 >ğ
HZ
) {

238 
	`__asm__
("mull %1 ; divl %2"

239 :"÷" (
loİs_³r_£c
)

240 :"d" (
HZ
),

241 "r" (
ticks
),

242 "0" (
loİs_³r_£c
)

244 
	`´štk
("ok - %lu.%02lu BogoMips\n",

245 
loİs_³r_£c
/500000,

246 (
loİs_³r_£c
/5000) % 100);

250 
	`´štk
("failed\n");

251 
	}
}

265 
	$·r£_İtiÚs
(*
lše
)

267 *
Ãxt
;

268 *
devÇmes
[] = { "hda", "hdb", "sda", "sdb", "sdc", "sdd", "sde", "fd", "xda", "xdb", 
NULL
 };

269 
devnums
[] = { 0x300, 0x340, 0x800, 0x810, 0x820, 0x830, 0x840, 0x200, 0xC00, 0xC40, 0};

270 
¬gs
, 
’vs
;

272 ià(!*
lše
)

274 
¬gs
 = 0;

275 
’vs
 = 1;

276 
Ãxt
 = 
lše
;

277 (
lše
 = 
Ãxt
è!ğ
NULL
) {

278 ià((
Ãxt
 = 
	`¡rchr
(
lše
,' ')è!ğ
NULL
)

279 *
Ãxt
++ = 0;

283 ià(!
	`¡ºcmp
(
lše
,"root=",5)) {

284 
n
;

285 
lše
 += 5;

286 ià(
	`¡ºcmp
(
lše
,"/dev/",5)) {

287 
ROOT_DEV
 = 
	`sim¶e_¡¹oul
(
lše
,
NULL
,16);

290 
lše
 += 5;

291 
n
 = 0 ; 
devÇmes
[n] ;‚++) {

292 
Ën
 = 
	`¡¾’
(
devÇmes
[
n
]);

293 ià(!
	`¡ºcmp
(
lše
,
devÇmes
[
n
],
Ën
)) {

294 
ROOT_DEV
 = 
devnums
[
n
]+
	`sim¶e_¡¹oul
(
lše
+
Ën
,
NULL
,16);

298 } ià(!
	`¡rcmp
(
lše
,"ro"))

299 
roÙ_mouÁæags
 |ğ
MS_RDONLY
;

300 ià(!
	`¡rcmp
(
lše
,"rw"))

301 
roÙ_mouÁæags
 &ğ~
MS_RDONLY
;

302 ià(!
	`¡rcmp
(
lše
,"debug"))

303 
cÚsŞe_logËv–
 = 10;

304 ià(!
	`¡rcmp
(
lše
,"no387")) {

305 
h¬d_m©h
 = 0;

306 
	`__asm__
("movl %%cr0,%%eax\n\t"

310 
	`check£tup
(
lše
);

315 ià(
	`¡rchr
(
lše
,'=')) {

316 ià(
’vs
 >ğ
MAX_INIT_ENVS
)

318 
’vp_š™
[++
’vs
] = 
lše
;

320 ià(
¬gs
 >ğ
MAX_INIT_ARGS
)

322 
¬gv_š™
[++
¬gs
] = 
lše
;

325 
¬gv_š™
[
¬gs
+1] = 
NULL
;

326 
’vp_š™
[
’vs
+1] = 
NULL
;

327 
	}
}

329 
	$cİy_İtiÚs
(* 
to
, * 
äom
)

331 
c
 = ' ';

334 ià(
c
 =ğ' ' && !
	`memcmp
("mem=", 
äom
, 4))

335 
memÜy_’d
 = 
	`sim¶e_¡¹oul
(
äom
+4, &from, 0);

336 
c
 = *(
to
++èğ*(
äom
++);

337 } 
c
);

338 
	}
}

340 
	$cİro_timeout
()

342 
åu_”rÜ
 = 1;

343 
tim”_bË
[
COPRO_TIMER
].
expœes
 = 
jiff›s
+100;

344 
tim”_aùive
 |ğ1<<
COPRO_TIMER
;

345 
	`´štk
("387 failed:ryingo„eset\n");

346 
	`£nd_sig
(
SIGFPE
, 
Ï¡_sk_u£d_m©h
, 1);

347 
	`outb_p
(0,0xf1);

348 
	`outb_p
(0,0xf0);

349 
	}
}

351 
asmlškage
 
	$¡¬t_k”Ãl
()

357 
	`£t_ÿÎ_g©e
(&
deçuÉ_ldt
,
lÿÎ7
);

358 
ROOT_DEV
 = 
ORIG_ROOT_DEV
;

359 
drive_šfo
 = 
DRIVE_INFO
;

360 
sü“n_šfo
 = 
SCREEN_INFO
;

361 
aux_deviû_´e£Á
 = 
AUX_DEVICE_INFO
;

362 
memÜy_’d
 = (1<<20è+ (
EXT_MEM_K
<<10);

363 
memÜy_’d
 &ğ
PAGE_MASK
;

364 
¿mdisk_size
 = 
RAMDISK_SIZE
;

365 
	`cİy_İtiÚs
(
commªd_lše
,
COMMAND_LINE
);

366 #ifdeà
CONFIG_MAX_16M


367 ià(
memÜy_’d
 > 16*1024*1024)

368 
memÜy_’d
 = 16*1024*1024;

370 ià(
MOUNT_ROOT_RDONLY
)

371 
roÙ_mouÁæags
 |ğ
MS_RDONLY
;

372 ià(()&
’d
 >= (1024*1024)) {

373 
memÜy_¡¬t
 = (è&
’d
;

374 
low_memÜy_¡¬t
 = 
PAGE_SIZE
;

376 
memÜy_¡¬t
 = 1024*1024;

377 
low_memÜy_¡¬t
 = (è&
’d
;

379 
low_memÜy_¡¬t
 = 
	`PAGE_ALIGN
(low_memory_start);

380 
memÜy_¡¬t
 = 
	`·gšg_š™
(memÜy_¡¬t,
memÜy_’d
);

381 ià(
	`¡ºcmp
((*)0x0FFFD9, "EISA", 4) == 0)

382 
EISA_bus
 = 1;

383 
	`Œ­_š™
();

384 
	`š™_IRQ
();

385 
	`sched_š™
();

386 
	`·r£_İtiÚs
(
commªd_lše
);

387 #ifdeà
CONFIG_PROFILE


388 
´of_bufãr
 = (*è
memÜy_¡¬t
;

389 
´of_Ën
 = (è&
’d
;

390 
´of_Ën
 >>= 2;

391 
memÜy_¡¬t
 +ğ
´of_Ën
 * ();

393 
memÜy_¡¬t
 = 
	`km®loc_š™
(memÜy_¡¬t,
memÜy_’d
);

394 
memÜy_¡¬t
 = 
	`chr_dev_š™
(memÜy_¡¬t,
memÜy_’d
);

395 
memÜy_¡¬t
 = 
	`blk_dev_š™
(memÜy_¡¬t,
memÜy_’d
);

396 
	`¡i
();

397 
	`ÿlib¿‹_d–ay
();

398 #ifdeà
CONFIG_INET


399 
memÜy_¡¬t
 = 
	`Ãt_dev_š™
(memÜy_¡¬t,
memÜy_’d
);

401 #ifdeà
CONFIG_SCSI


402 
memÜy_¡¬t
 = 
	`scsi_dev_š™
(memÜy_¡¬t,
memÜy_’d
);

404 
memÜy_¡¬t
 = 
	`šode_š™
(memÜy_¡¬t,
memÜy_’d
);

405 
memÜy_¡¬t
 = 
	`fe_bË_š™
(memÜy_¡¬t,
memÜy_’d
);

406 
	`mem_š™
(
low_memÜy_¡¬t
,
memÜy_¡¬t
,
memÜy_’d
);

407 
	`bufãr_š™
();

408 
	`time_š™
();

409 
	`æİpy_š™
();

410 
	`sock_š™
();

411 #ifdeà
CONFIG_SYSVIPC


412 
	`c_š™
();

414 
	`¡i
();

425 ià(
h¬d_m©h
) {

426 
cÚŒŞ_wÜd
;

428 
	`´štk
("Checking 386/387 coupling... ");

429 
tim”_bË
[
COPRO_TIMER
].
expœes
 = 
jiff›s
+50;

430 
tim”_bË
[
COPRO_TIMER
].
â
 = 
cİro_timeout
;

431 
tim”_aùive
 |ğ1<<
COPRO_TIMER
;

432 
	`__asm__
("şt ; fnš™ ; fn¡cw %0 ; fwa™":"=m" (*&
cÚŒŞ_wÜd
));

433 
cÚŒŞ_wÜd
 &= 0xffc0;

434 
	`__asm__
("ædcw %0 ; fwa™": :"m" (*&
cÚŒŞ_wÜd
));

435 
	`outb_p
(
	`šb_p
(0x21) | (1 << 2), 0x21);

436 
	`__asm__
("fldz ; fld1 ; fdiv %st,%st(1) ; fwait");

437 
tim”_aùive
 &ğ~(1<<
COPRO_TIMER
);

438 ià(!
åu_”rÜ
)

439 
	`´štk
("Ok, fpu using %sƒrror„eporting.\n",

440 
ignÜe_œq13
?"exception 16":"irq13");

442 #iâdeà
CONFIG_MATH_EMULATION


444 
	`´štk
("No coprocessor found‡nd‚o mathƒmulation…resent.\n");

445 
	`´štk
("Giving up.\n");

450 
sy¡em_ut¢ame
.
machše
[1] = '0' + 
x86
;

451 
	`´štk
(
lšux_bªÃr
);

453 
	`move_to_u£r_mode
();

454 ià(!
	`fÜk
())

455 
	`š™
();

466 
	`idË
();

467 
	}
}

469 
	$´štf
(cÚ¡ *
fmt
, ...)

471 
va_li¡
 
¬gs
;

472 
i
;

474 
	`va_¡¬t
(
¬gs
, 
fmt
);

475 
	`wr™e
(1,
´štbuf
,
i
=
	`v¥rštf
Õrštbuf, 
fmt
, 
¬gs
));

476 
	`va_’d
(
¬gs
);

477  
i
;

478 
	}
}

480 
	$š™
()

482 
pid
,
i
;

484 
	`£tup
((*è&
drive_šfo
);

485 
	`¥rštf
(
‹rm
, "TERM=cÚ%dx%d", 
ORIG_VIDEO_COLS
, 
ORIG_VIDEO_LINES
);

486 (è
	`İ’
("/dev/‰y1",
O_RDWR
,0);

487 (è
	`dup
(0);

488 (è
	`dup
(0);

490 
	`execve
("/‘c/š™",
¬gv_š™
,
’vp_š™
);

491 
	`execve
("/bš/š™",
¬gv_š™
,
’vp_š™
);

492 
	`execve
("/sbš/š™",
¬gv_š™
,
’vp_š™
);

495 ià(!(
pid
=
	`fÜk
())) {

496 
	`şo£
(0);

497 ià(
	`İ’
("/‘c/rc",
O_RDONLY
,0))

498 
	`_ex™
(1);

499 
	`execve
("/bš/sh",
¬gv_rc
,
’vp_rc
);

500 
	`_ex™
(2);

502 ià(
pid
>0)

503 
pid
 !ğ
	`wa™
(&
i
))

506 ià((
pid
 = 
	`fÜk
()) < 0) {

507 
	`´štf
("Fork failed in init\n\r");

510 ià(!
pid
) {

511 
	`şo£
(0);close(1);close(2);

512 
	`£tsid
();

513 (è
	`İ’
("/dev/‰y1",
O_RDWR
,0);

514 (è
	`dup
(0);

515 (è
	`dup
(0);

516 
	`_ex™
(
	`execve
("/bš/sh",
¬gv
,
’vp
));

519 ià(
pid
 =ğ
	`wa™
(&
i
))

521 
	`´štf
("\n\rchd %d d›d w™h cod%04x\n\r",
pid
,
i
);

522 
	`sync
();

524 
	`_ex™
(0);

525 
	}
}

	@ipc/msg.c

6 
	~<lšux/”ºo.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/msg.h
>

9 
	~<lšux/¡©.h
>

10 
	~<lšux/m®loc.h
>

12 
	~<asm/£gm’t.h
>

14 
ı”ms
 (
c_³rm
 *
ı
, 
msgæg
);

16 
ä“que
 (
id
);

17 
Ãwque
 (
key_t
 
key
, 
msgæg
);

18 
fšdkey
 (
key_t
 
key
);

20 
msqid_ds
 *
	gmsgque
[
MSGMNI
];

21 
	gmsgby‹s
 = 0;

22 
	gmsghdrs
 = 0;

23 
	gmsg_£q
 = 0;

24 
	gu£d_queues
 = 0;

25 
	gmax_msqid
 = 0;

26 
wa™_queue
 *
	gmsg_lock
 = 
NULL
;

28 
	$msg_š™
 ()

30 
id
;

32 
id
=0; id < 
MSGMNI
; id++)

33 
msgque
[
id
] = (
msqid_ds
 *è
IPC_UNUSED
;

34 
msgby‹s
 = 
msghdrs
 = 
msg_£q
 = 
max_msqid
 = 
u£d_queues
 = 0;

35 
msg_lock
 = 
NULL
;

37 
	}
}

39 
	$sys_msg¢d
 (
msqid
, 
msgbuf
 *
msgp
, 
msgsz
, 
msgæg
)

41 
id
, 
”r
;

42 
msqid_ds
 *
msq
;

43 
c_³rm
 *
ı
;

44 
msg
 *
msgh
;

45 
mty³
;

47 ià(
msgsz
 > 
MSGMAX
 || msgsz < 0 || 
msqid
 < 0)

48  -
EINVAL
;

49 ià(!
msgp
)

50  -
EFAULT
;

51 
”r
 = 
	`v”ify_¬—
 (
VERIFY_READ
, 
msgp
->
m‹xt
, 
msgsz
);

52 ià(
”r
)

53  
”r
;

54 ià((
mty³
 = 
	`g‘_fs_lÚg
 (&
msgp
->mtype)) < 1)

55  -
EINVAL
;

56 
id
 = 
msqid
 % 
MSGMNI
;

57 
msq
 = 
msgque
 [
id
];

58 ià(
msq
 =ğ
IPC_UNUSED
 || msq =ğ
IPC_NOID
)

59  -
EINVAL
;

60 
ı
 = &
msq
->
msg_³rm
;

62 
¦•t
:

63 ià(
ı
->
£q
 !ğ(
msqid
 / 
MSGMNI
))

64  -
EIDRM
;

65 ià(
	`ı”ms
(
ı
, 
S_IWUGO
))

66  -
EACCES
;

68 ià(
msgsz
 + 
msq
->
msg_cby‹s
 > msq->
msg_qby‹s
) {

70 ià(
msgæg
 & 
IPC_NOWAIT
)

71  -
EAGAIN
;

72 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

73  -
EINTR
;

74 
	`š‹¼u±ibË_¦“p_Ú
 (&
msq
->
wwa™
);

75 
¦•t
;

79 
msgh
 = (
msg
 *è
	`km®loc
 ((*msghè+ 
msgsz
, 
GFP_USER
);

80 ià(!
msgh
)

81  -
ENOMEM
;

82 
msgh
->
msg_¥Ù
 = (*) (msgh + 1);

83 
	`memıy_äomfs
 (
msgh
->
msg_¥Ù
, 
msgp
->
m‹xt
, 
msgsz
);

85 ià(
msgque
[
id
] =ğ
IPC_UNUSED
 || msgque[id] =ğ
IPC_NOID


86 || 
ı
->
£q
 !ğ
msqid
 / 
MSGMNI
) {

87 
	`kä“_s
 (
msgh
, (*msghè+ 
msgsz
);

88  -
EIDRM
;

91 
msgh
->
msg_Ãxt
 = 
NULL
;

92 ià(!
msq
->
msg_fœ¡
)

93 
msq
->
msg_fœ¡
 = msq->
msg_Ï¡
 = 
msgh
;

95 
msq
->
msg_Ï¡
->
msg_Ãxt
 = 
msgh
;

96 
msq
->
msg_Ï¡
 = 
msgh
;

98 
msgh
->
msg_ts
 = 
msgsz
;

99 
msgh
->
msg_ty³
 = 
mty³
;

100 
msq
->
msg_cby‹s
 +ğ
msgsz
;

101 
msgby‹s
 +ğ
msgsz
;

102 
msghdrs
++;

103 
msq
->
msg_qnum
++;

104 
msq
->
msg_l¥id
 = 
cu¼’t
->
pid
;

105 
msq
->
msg_¡ime
 = 
CURRENT_TIME
;

106 ià(
msq
->
rwa™
)

107 
	`wake_up
 (&
msq
->
rwa™
);

108  
msgsz
;

109 
	}
}

111 
	$sys_msgrcv
 (
msqid
, 
msgbuf
 *
msgp
, 
msgsz
, 
msgtyp
,

112 
msgæg
)

114 
msqid_ds
 *
msq
;

115 
c_³rm
 *
ı
;

116 
msg
 *
tmsg
, *
Ëa¡p
 = 
NULL
;

117 
msg
 *
nmsg
 = 
NULL
;

118 
id
, 
”r
;

120 ià(
msqid
 < 0 || 
msgsz
 < 0)

121  -
EINVAL
;

122 ià(!
msgp
 || !msgp->
m‹xt
)

123  -
EFAULT
;

124 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
msgp
->
m‹xt
, 
msgsz
);

125 ià(
”r
)

126  
”r
;

128 
id
 = 
msqid
 % 
MSGMNI
;

129 
msq
 = 
msgque
 [
id
];

130 ià(
msq
 =ğ
IPC_NOID
 || msq =ğ
IPC_UNUSED
)

131  -
EINVAL
;

132 
ı
 = &
msq
->
msg_³rm
;

140 !
nmsg
) {

141 if(
ı
->
£q
 !ğ
msqid
 / 
MSGMNI
)

142  -
EIDRM
;

143 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

144  -
EACCES
;

145 ià(
msgtyp
 == 0)

146 
nmsg
 = 
msq
->
msg_fœ¡
;

147 ià(
msgtyp
 > 0) {

148 ià(
msgæg
 & 
MSG_EXCEPT
) {

149 
tmsg
 = 
msq
->
msg_fœ¡
;msg;

150 
tmsg
 =msg->
msg_Ãxt
)

151 ià(
tmsg
->
msg_ty³
 !ğ
msgtyp
)

153 
nmsg
 = 
tmsg
;

155 
tmsg
 = 
msq
->
msg_fœ¡
;msg;

156 
tmsg
 =msg->
msg_Ãxt
)

157 ià(
tmsg
->
msg_ty³
 =ğ
msgtyp
)

159 
nmsg
 = 
tmsg
;

162 
Ëa¡p
 = 
tmsg
 = 
msq
->
msg_fœ¡
;msg;

163 
tmsg
 =msg->
msg_Ãxt
)

164 ià(
tmsg
->
msg_ty³
 < 
Ëa¡p
->msg_type)

165 
Ëa¡p
 = 
tmsg
;

166 ià(
Ëa¡p
 &&†—¡p->
msg_ty³
 <ğ- 
msgtyp
)

167 
nmsg
 = 
Ëa¡p
;

170 ià(
nmsg
) {

171 ià((
msgsz
 < 
nmsg
->
msg_ts
è&& !(
msgæg
 & 
MSG_NOERROR
))

172  -
E2BIG
;

173 
msgsz
 = (msgsz > 
nmsg
->
msg_ts
)?‚msg->msg_ts : msgsz;

174 ià(
nmsg
 =ğ
msq
->
msg_fœ¡
)

175 
msq
->
msg_fœ¡
 = 
nmsg
->
msg_Ãxt
;

177 
tmsg
ğ
msq
->
msg_fœ¡
;msg;

178 
tmsg
 =msg->
msg_Ãxt
)

179 ià(
tmsg
->
msg_Ãxt
 =ğ
nmsg
)

181 
tmsg
->
msg_Ãxt
 = 
nmsg
->msg_next;

182 ià(
nmsg
 =ğ
msq
->
msg_Ï¡
)

183 
msq
->
msg_Ï¡
 = 
tmsg
;

185 ià(!(--
msq
->
msg_qnum
))

186 
msq
->
msg_Ï¡
 = msq->
msg_fœ¡
 = 
NULL
;

188 
msq
->
msg_¹ime
 = 
CURRENT_TIME
;

189 
msq
->
msg_Ìpid
 = 
cu¼’t
->
pid
;

190 
msgby‹s
 -ğ
nmsg
->
msg_ts
;

191 
msghdrs
--;

192 
msq
->
msg_cby‹s
 -ğ
nmsg
->
msg_ts
;

193 ià(
msq
->
wwa™
)

194 
	`wake_up
 (&
msq
->
wwa™
);

195 
	`put_fs_lÚg
 (
nmsg
->
msg_ty³
, &
msgp
->
mty³
);

196 
	`memıy_tofs
 (
msgp
->
m‹xt
, 
nmsg
->
msg_¥Ù
, 
msgsz
);

197 
	`kä“_s
 (
nmsg
, (*nmsgè+ 
msgsz
);

198  
msgsz
;

200 ià(
msgæg
 & 
IPC_NOWAIT
)

201  -
ENOMSG
;

202 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

203  -
EINTR
;

204 
	`š‹¼u±ibË_¦“p_Ú
 (&
msq
->
rwa™
);

208 
	}
}

211 
	$fšdkey
 (
key_t
 
key
)

213 
id
;

214 
msqid_ds
 *
msq
;

216 
id
=0; id <ğ
max_msqid
; id++) {

217 (
msq
 = 
msgque
[
id
]è=ğ
IPC_NOID
)

218 
	`š‹¼u±ibË_¦“p_Ú
 (&
msg_lock
);

219 ià(
msq
 =ğ
IPC_UNUSED
)

221 ià(
key
 =ğ
msq
->
msg_³rm
.key)

222  
id
;

225 
	}
}

227 
	$Ãwque
 (
key_t
 
key
, 
msgæg
)

229 
id
;

230 
msqid_ds
 *
msq
;

231 
c_³rm
 *
ı
;

233 
id
=0; id < 
MSGMNI
; id++)

234 ià(
msgque
[
id
] =ğ
IPC_UNUSED
) {

235 
msgque
[
id
] = (
msqid_ds
 *è
IPC_NOID
;

236 
found
;

238  -
ENOSPC
;

240 
found
:

241 
msq
 = (
msqid_ds
 *è
	`km®loc
 ( (*msq), 
GFP_KERNEL
);

242 ià(!
msq
) {

243 
msgque
[
id
] = (
msqid_ds
 *è
IPC_UNUSED
;

244 ià(
msg_lock
)

245 
	`wake_up
 (&
msg_lock
);

246  -
ENOMEM
;

248 
ı
 = &
msq
->
msg_³rm
;

249 
ı
->
mode
 = (
msgæg
 & 
S_IRWXUGO
);

250 
ı
->
key
 = key;

251 
ı
->
cuid
 = ipı->
uid
 = 
cu¼’t
->
euid
;

252 
ı
->
gid
 = ipı->
cgid
 = 
cu¼’t
->
egid
;

253 
ı
->
£q
 = 
msg_£q
;

254 
msq
->
msg_fœ¡
 = msq->
msg_Ï¡
 = 
NULL
;

255 
msq
->
rwa™
 = msq->
wwa™
 = 
NULL
;

256 
msq
->
msg_cby‹s
 = msq->
msg_qnum
 = 0;

257 
msq
->
msg_l¥id
 = msq->
msg_Ìpid
 = 0;

258 
msq
->
msg_¡ime
 = msq->
msg_¹ime
 = 0;

259 
msq
->
msg_qby‹s
 = 
MSGMNB
;

260 
msq
->
msg_ùime
 = 
CURRENT_TIME
;

261 ià(
id
 > 
max_msqid
)

262 
max_msqid
 = 
id
;

263 
msgque
[
id
] = 
msq
;

264 
u£d_queues
++;

265 ià(
msg_lock
)

266 
	`wake_up
 (&
msg_lock
);

267  (è
msg_£q
 * 
MSGMNI
 + 
id
;

268 
	}
}

270 
	$sys_msgg‘
 (
key_t
 
key
, 
msgæg
)

272 
id
;

273 
msqid_ds
 *
msq
;

275 ià(
key
 =ğ
IPC_PRIVATE
)

276  
	`Ãwque
(
key
, 
msgæg
);

277 ià((
id
 = 
	`fšdkey
 (
key
)) == -1) {

278 ià(!(
msgæg
 & 
IPC_CREAT
))

279  -
ENOENT
;

280  
	`Ãwque
(
key
, 
msgæg
);

282 ià(
msgæg
 & 
IPC_CREAT
 && msgæg & 
IPC_EXCL
)

283  -
EEXIST
;

284 
msq
 = 
msgque
[
id
];

285 ià(
msq
 =ğ
IPC_UNUSED
 || msq =ğ
IPC_NOID
)

286  -
EIDRM
;

287 ià(
	`ı”ms
(&
msq
->
msg_³rm
, 
msgæg
))

288  -
EACCES
;

289  
msq
->
msg_³rm
.
£q
 * 
MSGMNI
 +
id
;

290 
	}
}

292 
	$ä“que
 (
id
)

294 
msqid_ds
 *
msq
 = 
msgque
[
id
];

295 
msg
 *
msgp
, *
msgh
;

297 
msq
->
msg_³rm
.
£q
++;

298 
msg_£q
++;

299 
msgby‹s
 -ğ
msq
->
msg_cby‹s
;

300 ià(
id
 =ğ
max_msqid
)

301 
max_msqid
 && (
msgque
[--max_msqid] =ğ
IPC_UNUSED
));

302 
msgque
[
id
] = (
msqid_ds
 *è
IPC_UNUSED
;

303 
u£d_queues
--;

304 
msq
->
rwa™
 || msq->
wwa™
) {

305 ià(
msq
->
rwa™
)

306 
	`wake_up
 (&
msq
->
rwa™
);

307 ià(
msq
->
wwa™
)

308 
	`wake_up
 (&
msq
->
wwa™
);

309 
	`scheduË
();

311 
msgp
 = 
msq
->
msg_fœ¡
; msgp; msg°ğ
msgh
 ) {

312 
msgh
 = 
msgp
->
msg_Ãxt
;

313 
msghdrs
--;

314 
	`kä“_s
 (
msgp
, (*msgpè+ msgp->
msg_ts
);

316 
	`kä“_s
 (
msq
,  (*msq));

317 
	}
}

319 
	$sys_msgùl
 (
msqid
, 
cmd
, 
msqid_ds
 *
buf
)

321 
id
, 
”r
;

322 
msqid_ds
 *
msq
, 
tbuf
;

323 
c_³rm
 *
ı
;

325 ià(
msqid
 < 0 || 
cmd
 < 0)

326  -
EINVAL
;

327 
cmd
) {

328 
IPC_INFO
:

329 
MSG_INFO
:

330 ià(!
buf
)

331  -
EFAULT
;

333 
msgšfo
 msginfo;

334 
msgšfo
.
msgmni
 = 
MSGMNI
;

335 
msgšfo
.
msgmax
 = 
MSGMAX
;

336 
msgšfo
.
msgmnb
 = 
MSGMNB
;

337 
msgšfo
.
msgm­
 = 
MSGMAP
;

338 
msgšfo
.
msgpoŞ
 = 
MSGPOOL
;

339 
msgšfo
.
msgtql
 = 
MSGTQL
;

340 
msgšfo
.
msgssz
 = 
MSGSSZ
;

341 
msgšfo
.
msg£g
 = 
MSGSEG
;

342 ià(
cmd
 =ğ
MSG_INFO
) {

343 
msgšfo
.
msgpoŞ
 = 
u£d_queues
;

344 
msgšfo
.
msgm­
 = 
msghdrs
;

345 
msgšfo
.
msgtql
 = 
msgby‹s
;

347 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (
msgšfo
));

348 ià(
”r
)

349  
”r
;

350 
	`memıy_tofs
 (
buf
, &
msgšfo
, (msginfo));

351  
max_msqid
;

353 
MSG_STAT
:

354 ià(!
buf
)

355  -
EFAULT
;

356 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (*
msq
));

357 ià(
”r
)

358  
”r
;

359 ià(
msqid
 > 
max_msqid
)

360  -
EINVAL
;

361 
msq
 = 
msgque
[
msqid
];

362 ià(
msq
 =ğ
IPC_UNUSED
 || msq =ğ
IPC_NOID
)

363  -
EINVAL
;

364 ià(
	`ı”ms
 (&
msq
->
msg_³rm
, 
S_IRUGO
))

365  -
EACCES
;

366 
id
 = 
msqid
 + 
msq
->
msg_³rm
.
£q
 * 
MSGMNI
;

367 
	`memıy_tofs
 (
buf
, 
msq
, (*msq));

368  
id
;

369 
IPC_SET
:

370 ià(!
buf
)

371  -
EFAULT
;

372 
	`memıy_äomfs
 (&
tbuf
, 
buf
,  (*buf));

374 
IPC_STAT
:

375 ià(!
buf
)

376  -
EFAULT
;

377 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
, (*
msq
));

378 ià(
”r
)

379  
”r
;

383 
id
 = 
msqid
 % 
MSGMNI
;

384 
msq
 = 
msgque
 [
id
];

385 ià(
msq
 =ğ
IPC_UNUSED
 || msq =ğ
IPC_NOID
)

386  -
EINVAL
;

387 
ı
 = &
msq
->
msg_³rm
;

388 ià(
ı
->
£q
 !ğ
msqid
 / 
MSGMNI
)

389  -
EIDRM
;

391 
cmd
) {

392 
IPC_STAT
:

393 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

394  -
EACCES
;

395 
	`memıy_tofs
 (
buf
, 
msq
,  (*msq));

398 
IPC_RMID
: 
IPC_SET
:

399 ià(!
	`su£r
(è&& 
cu¼’t
->
euid
 !ğ
ı
->
cuid
 &&

400 
cu¼’t
->
euid
 !ğ
ı
->
uid
)

401  -
EPERM
;

402 ià(
cmd
 =ğ
IPC_RMID
) {

403 
	`ä“que
 (
id
);

406 ià(
tbuf
.
msg_qby‹s
 > 
MSGMNB
 && !
	`su£r
())

407  -
EPERM
;

408 
msq
->
msg_qby‹s
 = 
tbuf
.msg_qbytes;

409 
ı
->
uid
 = 
tbuf
.
msg_³rm
.uid;

410 
ı
->
gid
 = 
tbuf
.
msg_³rm
.gid;

411 
ı
->
mode
 = (ı->mod& ~
S_IRWXUGO
) |

412 (
S_IRWXUGO
 & 
tbuf
.
msg_³rm
.
mode
);

413 
msq
->
msg_ùime
 = 
CURRENT_TIME
;

416  -
EINVAL
;

420 
	}
}

	@ipc/sem.c

6 
	~<lšux/”ºo.h
>

7 
	~<asm/£gm’t.h
>

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/£m.h
>

11 
	~<lšux/c.h
>

12 
	~<lšux/¡©.h
>

13 
	~<lšux/m®loc.h
>

15 
ı”ms
 (
c_³rm
 *
ı
, 
£mæg
);

16 
Ãw¬y
 (
key_t
, , );

17 
fšdkey
 (
key_t
 
key
);

18 
ä“¬y
 (
id
);

20 
£mid_ds
 *
	g£m¬y
[
SEMMNI
];

21 
	gu£d_£ms
 = 0, 
	gu£d_£mids
 = 0;

22 
wa™_queue
 *
	g£m_lock
 = 
NULL
;

23 
	gmax_£mid
 = 0;

25 
	g£m_£q
 = 0;

27 
	$£m_š™
 ()

29 
i
=0;

31 
£m_lock
 = 
NULL
;

32 
u£d_£ms
 = 
u£d_£mids
 = 
max_£mid
 = 
£m_£q
 = 0;

33 
i
=0; i < 
SEMMNI
; i++)

34 
£m¬y
[
i
] = (
£mid_ds
 *è
IPC_UNUSED
;

36 
	}
}

38 
	$fšdkey
 (
key_t
 
key
)

40 
id
;

41 
£mid_ds
 *
sma
;

43 
id
=0; id <ğ
max_£mid
; id++) {

44 (
sma
 = 
£m¬y
[
id
]è=ğ
IPC_NOID
)

45 
	`š‹¼u±ibË_¦“p_Ú
 (&
£m_lock
);

46 ià(
sma
 =ğ
IPC_UNUSED
)

48 ià(
key
 =ğ
sma
->
£m_³rm
.key)

49  
id
;

52 
	}
}

54 
	$Ãw¬y
 (
key_t
 
key
, 
n£ms
, 
£mæg
)

56 
id
;

57 
£mid_ds
 *
sma
;

58 
c_³rm
 *
ı
;

59 
size
;

61 ià(!
n£ms
)

62  -
EINVAL
;

63 ià(
u£d_£ms
 + 
n£ms
 > 
SEMMNS
)

64  -
ENOSPC
;

65 
id
=0; id < 
SEMMNI
; id++)

66 ià(
£m¬y
[
id
] =ğ
IPC_UNUSED
) {

67 
£m¬y
[
id
] = (
£mid_ds
 *è
IPC_NOID
;

68 
found
;

70  -
ENOSPC
;

71 
found
:

72 
size
 =  (*
sma
è+ 
n£ms
 *  (
£m
);

73 
u£d_£ms
 +ğ
n£ms
;

74 
sma
 = (
£mid_ds
 *è
	`km®loc
 (
size
, 
GFP_KERNEL
);

75 ià(!
sma
) {

76 
£m¬y
[
id
] = (
£mid_ds
 *è
IPC_UNUSED
;

77 
u£d_£ms
 -ğ
n£ms
;

78 ià(
£m_lock
)

79 
	`wake_up
 (&
£m_lock
);

80  -
ENOMEM
;

82 
	`mem£t
 (
sma
, 0, 
size
);

83 
sma
->
£m_ba£
 = (
£m
 *) &sma[1];

84 
ı
 = &
sma
->
£m_³rm
;

85 
ı
->
mode
 = (
£mæg
 & 
S_IRWXUGO
);

86 
ı
->
key
 = key;

87 
ı
->
cuid
 = ipı->
uid
 = 
cu¼’t
->
euid
;

88 
ı
->
gid
 = ipı->
cgid
 = 
cu¼’t
->
egid
;

89 
ı
->
£q
 = 
£m_£q
;

90 
sma
->
ev’Š
 = sma->
ev’tz
 = 
NULL
;

91 
sma
->
£m_n£ms
 = 
n£ms
;

92 
sma
->
£m_ùime
 = 
CURRENT_TIME
;

93 ià(
id
 > 
max_£mid
)

94 
max_£mid
 = 
id
;

95 
u£d_£mids
++;

96 
£m¬y
[
id
] = 
sma
;

97 ià(
£m_lock
)

98 
	`wake_up
 (&
£m_lock
);

99  (è
£m_£q
 * 
SEMMNI
 + 
id
;

100 
	}
}

102 
	$sys_£mg‘
 (
key_t
 
key
, 
n£ms
, 
£mæg
)

104 
id
;

105 
£mid_ds
 *
sma
;

107 ià(
n£ms
 < 0 ||‚£m > 
SEMMSL
)

108  -
EINVAL
;

109 ià(
key
 =ğ
IPC_PRIVATE
)

110  
	`Ãw¬y
(
key
, 
n£ms
, 
£mæg
);

111 ià((
id
 = 
	`fšdkey
 (
key
)) == -1) {

112 ià(!(
£mæg
 & 
IPC_CREAT
))

113  -
ENOENT
;

114  
	`Ãw¬y
(
key
, 
n£ms
, 
£mæg
);

116 ià(
£mæg
 & 
IPC_CREAT
 && semæg & 
IPC_EXCL
)

117  -
EEXIST
;

118 
sma
 = 
£m¬y
[
id
];

119 ià(
n£ms
 > 
sma
->
£m_n£ms
)

120  -
EINVAL
;

121 ià(
	`ı”ms
(&
sma
->
£m_³rm
, 
£mæg
))

122  -
EACCES
;

123  
sma
->
£m_³rm
.
£q
*
SEMMNI
 + 
id
;

124 
	}
}

126 
	$ä“¬y
 (
id
)

128 
£mid_ds
 *
sma
 = 
£m¬y
[
id
];

129 
£m_undo
 *
un
;

131 
sma
->
£m_³rm
.
£q
++;

132 
£m_£q
++;

133 
u£d_£ms
 -ğ
sma
->
£m_n£ms
;

134 ià(
id
 =ğ
max_£mid
)

135 
max_£mid
 && (
£m¬y
[--max_£mid] =ğ
IPC_UNUSED
));

136 
£m¬y
[
id
] = (
£mid_ds
 *è
IPC_UNUSED
;

137 
u£d_£mids
--;

138 
un
=
sma
->
undo
; un; un=un->
id_Ãxt
)

139 
un
->
£madj
 = 0;

140 
sma
->
ev’tz
 || sma->
ev’Š
) {

141 ià(
sma
->
ev’tz
)

142 
	`wake_up
 (&
sma
->
ev’tz
);

143 ià(
sma
->
ev’Š
)

144 
	`wake_up
 (&
sma
->
ev’Š
);

145 
	`scheduË
();

147 
	`kä“_s
 (
sma
,  (*smaè+ sma->
£m_n£ms
 *  (
£m
));

149 
	}
}

151 
	$sys_£mùl
 (
£mid
, 
£mnum
, 
cmd
, *
¬g
)

153 
i
, 
id
, 
v®
 = 0;

154 
£mid_ds
 *
sma
, *
buf
 = 
NULL
, 
tbuf
;

155 
c_³rm
 *
ı
;

156 
£m
 *
cu¼
;

157 
£m_undo
 *
un
;

158 
ushÜt
 
n£ms
, *
¬¿y
 = 
NULL
;

159 
ushÜt
 
£m_io
[
SEMMSL
];

161 ià(
£mid
 < 0 || 
£mnum
 < 0 || 
cmd
 < 0)

162  -
EINVAL
;

164 
cmd
) {

165 
IPC_INFO
:

166 
SEM_INFO
:

168 
£mšfo
 semšfo, *
tmp
;

169 ià(!
¬g
 || ! (
tmp
 = (
£mšfo
 *è
	`g‘_fs_lÚg
((*)arg)))

170  -
EFAULT
;

171 
£mšfo
.
£mmni
 = 
SEMMNI
;

172 
£mšfo
.
£mmns
 = 
SEMMNS
;

173 
£mšfo
.
£mm¦
 = 
SEMMSL
;

174 
£mšfo
.
£mİm
 = 
SEMOPM
;

175 
£mšfo
.
£mvmx
 = 
SEMVMX
;

176 
£mšfo
.
£mmnu
 = 
SEMMNU
;

177 
£mšfo
.
£mm­
 = 
SEMMAP
;

178 
£mšfo
.
£mume
 = 
SEMUME
;

179 
£mšfo
.
£musz
 = 
SEMUSZ
;

180 
£mšfo
.
£m«m
 = 
SEMAEM
;

181 ià(
cmd
 =ğ
SEM_INFO
) {

182 
£mšfo
.
£musz
 = 
u£d_£mids
;

183 
£mšfo
.
£m«m
 = 
u£d_£ms
;

185 
i
ğ
	`v”ify_¬—
(
VERIFY_WRITE
, 
tmp
, (
£mšfo
));

186 ià(
i
)

187  
i
;

188 
	`memıy_tofs
 (
tmp
, &
£mšfo
, (seminfo));

189  
max_£mid
;

192 
SEM_STAT
:

193 ià(!
¬g
 || ! (
buf
 = (
£mid_ds
 *è
	`g‘_fs_lÚg
((*)‡rg)))

194  -
EFAULT
;

195 
i
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (*
sma
));

196 ià(
i
)

197  
i
;

198 ià(
£mid
 > 
max_£mid
)

199  -
EINVAL
;

200 
sma
 = 
£m¬y
[
£mid
];

201 ià(
sma
 =ğ
IPC_UNUSED
 || sm¨=ğ
IPC_NOID
)

202  -
EINVAL
;

203 ià(
	`ı”ms
 (&
sma
->
£m_³rm
, 
S_IRUGO
))

204  -
EACCES
;

205 
id
 = 
£mid
 + 
sma
->
£m_³rm
.
£q
 * 
SEMMNI
;

206 
	`memıy_tofs
 (
buf
, 
sma
, (*sma));

207  
id
;

210 
id
 = 
£mid
 % 
SEMMNI
;

211 
sma
 = 
£m¬y
 [
id
];

212 ià(
sma
 =ğ
IPC_UNUSED
 || sm¨=ğ
IPC_NOID
)

213  -
EINVAL
;

214 
ı
 = &
sma
->
£m_³rm
;

215 
n£ms
 = 
sma
->
£m_n£ms
;

216 ià(
ı
->
£q
 !ğ
£mid
 / 
SEMMNI
)

217  -
EIDRM
;

218 ià(
£mnum
 >ğ
n£ms
)

219  -
EINVAL
;

220 
cu¼
 = &
sma
->
£m_ba£
[
£mnum
];

222 
cmd
) {

223 
GETVAL
:

224 
GETPID
:

225 
GETNCNT
:

226 
GETZCNT
:

227 
GETALL
:

228 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

229  -
EACCES
;

230 
cmd
) {

231 
GETVAL
 :  
cu¼
->
£mv®
;

232 
GETPID
 :  
cu¼
->
£mpid
;

233 
GETNCNT
:  
cu¼
->
£mnút
;

234 
GETZCNT
:  
cu¼
->
£mzút
;

235 
GETALL
:

236 ià(!
¬g
 || ! (
¬¿y
 = (
ushÜt
 *è
	`g‘_fs_lÚg
((*)‡rg)))

237  -
EFAULT
;

238 
i
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
¬¿y
, 
n£ms
* ());

239 ià(
i
)

240  
i
;

243 
SETVAL
:

244 ià(!
¬g
)

245  -
EFAULT
;

246 ià((
v®
 = (è
	`g‘_fs_lÚg
 ((*è
¬g
)è> 
SEMVMX
 || val < 0)

247  -
ERANGE
;

249 
IPC_RMID
:

250 ià(
	`su£r
(è|| 
cu¼’t
->
euid
 =ğ
ı
->
cuid
 ||

251 
cu¼’t
->
euid
 =ğ
ı
->
uid
) {

252 
	`ä“¬y
 (
id
);

255  -
EPERM
;

256 
SETALL
:

257 ià(!
¬g
 || ! (
¬¿y
 = (
ushÜt
 *è
	`g‘_fs_lÚg
 ((*)‡rg)) )

258  -
EFAULT
;

259 ià((
i
 = 
	`v”ify_¬—
 (
VERIFY_READ
, 
¬¿y
,  
tbuf
)))

260  
i
;

261 
	`memıy_äomfs
 (
£m_io
, 
¬¿y
, 
n£ms
*(
ushÜt
));

262 
i
=0; i< 
n£ms
; i++)

263 ià(
£m_io
[
i
] > 
SEMVMX
)

264  -
ERANGE
;

266 
IPC_STAT
:

267 ià(!
¬g
 || !(
buf
 = (
£mid_ds
 *è
	`g‘_fs_lÚg
((*)‡rg)))

268  -
EFAULT
;

269 ià((
i
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
¬g
,  
tbuf
)))

270  
i
;

272 
IPC_SET
:

273 ià(!
¬g
 || !(
buf
 = (
£mid_ds
 *è
	`g‘_fs_lÚg
((*)‡rg)))

274  -
EFAULT
;

275 ià((
i
 = 
	`v”ify_¬—
 (
VERIFY_READ
, 
buf
,  
tbuf
)))

276  
i
;

277 
	`memıy_äomfs
 (&
tbuf
, 
buf
, buf);

281 ià(
£m¬y
[
id
] =ğ
IPC_UNUSED
 || sem¬y[id] =ğ
IPC_NOID
)

282  -
EIDRM
;

283 ià(
ı
->
£q
 !ğ
£mid
 / 
SEMMNI
)

284  -
EIDRM
;

286 
cmd
) {

287 
GETALL
:

288 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

289  -
EACCES
;

290 
i
=0; i< 
sma
->
£m_n£ms
; i++)

291 
£m_io
[
i
] = 
sma
->
£m_ba£
[i].
£mv®
;

292 
	`memıy_tofs
 (
¬¿y
, 
£m_io
, 
n£ms
*(
ushÜt
));

294 
SETVAL
:

295 ià(
	`ı”ms
 (
ı
, 
S_IWUGO
))

296  -
EACCES
;

297 
un
 = 
sma
->
undo
; un; uÀğun->
id_Ãxt
)

298 ià(
£mnum
 =ğ
un
->
£m_num
)

299 
un
->
£madj
 = 0;

300 
sma
->
£m_ùime
 = 
CURRENT_TIME
;

301 
cu¼
->
£mv®
 = 
v®
;

302 ià(
sma
->
ev’Š
)

303 
	`wake_up
 (&
sma
->
ev’Š
);

304 ià(
sma
->
ev’tz
)

305 
	`wake_up
 (&
sma
->
ev’tz
);

307 
IPC_SET
:

308 ià(
	`su£r
(è|| 
cu¼’t
->
euid
 =ğ
ı
->
cuid
 ||

309 
cu¼’t
->
euid
 =ğ
ı
->
uid
) {

310 
ı
->
uid
 = 
tbuf
.
£m_³rm
.uid;

311 
ı
->
gid
 = 
tbuf
.
£m_³rm
.gid;

312 
ı
->
mode
 = (ı->mod& ~
S_IRWXUGO
)

313 | (
tbuf
.
£m_³rm
.
mode
 & 
S_IRWXUGO
);

314 
sma
->
£m_ùime
 = 
CURRENT_TIME
;

317  -
EPERM
;

318 
IPC_STAT
:

319 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

320  -
EACCES
;

321 
	`memıy_tofs
 (
buf
, 
sma
,  (*sma));

323 
SETALL
:

324 ià(
	`ı”ms
 (
ı
, 
S_IWUGO
))

325  -
EACCES
;

326 
i
=0; i<
n£ms
; i++)

327 
sma
->
£m_ba£
[
i
].
£mv®
 = 
£m_io
[i];

328 
un
 = 
sma
->
undo
; un; uÀğun->
id_Ãxt
)

329 
un
->
£madj
 = 0;

330 ià(
sma
->
ev’Š
)

331 
	`wake_up
 (&
sma
->
ev’Š
);

332 ià(
sma
->
ev’tz
)

333 
	`wake_up
 (&
sma
->
ev’tz
);

334 
sma
->
£m_ùime
 = 
CURRENT_TIME
;

337  -
EINVAL
;

340 
	}
}

342 
	$sys_£mİ
 (
£mid
, 
£mbuf
 *
tsİs
, 
nsİs
)

344 
i
, 
id
;

345 
£mid_ds
 *
sma
;

346 
£m
 *
cu¼
 = 
NULL
;

347 
£mbuf
 
sİs
[
SEMOPM
], *
sİ
;

348 
£m_undo
 *
un
;

349 
undos
 = 0, 
®‹r
 = 0, 
£mnút
 = 0, 
£mzút
 = 0;

351 ià(
nsİs
 < 1 || 
£mid
 < 0)

352  -
EINVAL
;

353 ià(
nsİs
 > 
SEMOPM
)

354  -
E2BIG
;

355 ià(!
tsİs
)

356  -
EFAULT
;

357 
	`memıy_äomfs
 (
sİs
, 
tsİs
, 
nsİs
 * (*tsops));

358 
id
 = 
£mid
 % 
SEMMNI
;

359 ià((
sma
 = 
£m¬y
[
id
]è=ğ
IPC_UNUSED
 || sm¨=ğ
IPC_NOID
)

360  -
EINVAL
;

361 
i
=0; i<
nsİs
; i++) {

362 
sİ
 = &
sİs
[
i
];

363 ià(
sİ
->
£m_num
 > 
sma
->
£m_n£ms
)

364  -
EFBIG
;

365 ià(
sİ
->
£m_æg
 & 
SEM_UNDO
)

366 
undos
++;

367 ià(
sİ
->
£m_İ
) {

368 
®‹r
++;

369 ià(
sİ
->
£m_İ
 > 0)

370 
£mnút
 ++;

373 ià(
	`ı”ms
(&
sma
->
£m_³rm
, 
®‹r
 ? 
S_IWUGO
 : 
S_IRUGO
))

374  -
EACCES
;

378 ià(
undos
) {

379 
i
=0; i<
nsİs
; i++) {

380 ià(!(
sİs
[
i
].
£m_æg
 & 
SEM_UNDO
))

382 
un
 = 
cu¼’t
->
£mun
; un; uÀğun->
´oc_Ãxt
)

383 ià((
un
->
£mid
 == semid) &&

384 (
un
->
£m_num
 =ğ
sİs
[
i
].sem_num))

386 ià(
un
)

388 
un
 = (
£m_undo
 *)

389 
	`km®loc
 ((*
un
), 
GFP_ATOMIC
);

390 ià(!
un
)

391  -
ENOMEM
;

392 
un
->
£mid
 = semid;

393 
un
->
£madj
 = 0;

394 
un
->
£m_num
 = 
sİs
[
i
].sem_num;

395 
un
->
´oc_Ãxt
 = 
cu¼’t
->
£mun
;

396 
cu¼’t
->
£mun
 = 
un
;

397 
un
->
id_Ãxt
 = 
sma
->
undo
;

398 
sma
->
undo
 = 
un
;

402 
¦•t
:

403 ià(
sma
->
£m_³rm
.
£q
 !ğ
£mid
 / 
SEMMNI
)

404  -
EIDRM
;

405 
i
=0; i<
nsİs
; i++) {

406 
sİ
 = &
sİs
[
i
];

407 
cu¼
 = &
sma
->
£m_ba£
[
sİ
->
£m_num
];

408 ià(
sİ
->
£m_İ
 + 
cu¼
->
£mv®
 > 
SEMVMX
)

409  -
ERANGE
;

410 ià(!
sİ
->
£m_İ
 && 
cu¼
->
£mv®
) {

411 ià(
sİ
->
£m_æg
 & 
IPC_NOWAIT
)

412  -
EAGAIN
;

413 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

414  -
EINTR
;

415 
cu¼
->
£mzút
++;

416 
	`š‹¼u±ibË_¦“p_Ú
 (&
sma
->
ev’tz
);

417 
cu¼
->
£mzút
--;

418 
¦•t
;

420 ià((
sİ
->
£m_İ
 + 
cu¼
->
£mv®
 < 0) ) {

421 ià(
sİ
->
£m_æg
 & 
IPC_NOWAIT
)

422  -
EAGAIN
;

423 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

424  -
EINTR
;

425 
cu¼
->
£mnút
++;

426 
	`š‹¼u±ibË_¦“p_Ú
 (&
sma
->
ev’Š
);

427 
cu¼
->
£mnút
--;

428 
¦•t
;

432 
i
=0; i<
nsİs
; i++) {

433 
sİ
 = &
sİs
[
i
];

434 
cu¼
 = &
sma
->
£m_ba£
[
sİ
->
£m_num
];

435 
cu¼
->
£mpid
 = 
cu¼’t
->
pid
;

436 ià(!(
cu¼
->
£mv®
 +ğ
sİ
->
£m_İ
))

437 
£mzút
++;

438 ià(!(
sİ
->
£m_æg
 & 
SEM_UNDO
))

440 
un
 = 
cu¼’t
->
£mun
; un; uÀğun->
´oc_Ãxt
)

441 ià((
un
->
£mid
 == semid) &&

442 (
un
->
£m_num
 =ğ
sİ
->sem_num))

444 ià(!
un
) {

445 
	`´štk
 ("£mİ :‚ØundØfÜ o°%d\n", 
i
);

448 
un
->
£madj
 -ğ
sİ
->
£m_İ
;

450 
sma
->
£m_Ùime
 = 
CURRENT_TIME
;

451 ià(
£mnút
 && 
sma
->
ev’Š
)

452 
	`wake_up
(&
sma
->
ev’Š
);

453 ià(
£mzút
 && 
sma
->
ev’tz
)

454 
	`wake_up
(&
sma
->
ev’tz
);

455  
cu¼
->
£mv®
;

456 
	}
}

463 
	$£m_ex™
 ()

465 
£m_undo
 *
u
, *
un
 = 
NULL
, **
up
, **
uÅ
;

466 
£mid_ds
 *
sma
;

467 
£m
 *£m = 
NULL
;

469 
up
 = &
cu¼’t
->
£mun
; (
u
 = *up); *u°ğu->
´oc_Ãxt
, 
	`kä“
(u)) {

470 
sma
 = 
£m¬y
[
u
->
£mid
 % 
SEMMNI
];

471 ià(
sma
 =ğ
IPC_UNUSED
 || sm¨=ğ
IPC_NOID
)

473 ià(
sma
->
£m_³rm
.
£q
 !ğ
u
->
£mid
 / 
SEMMNI
)

475 
uÅ
 = &
sma
->
undo
; (
un
 = *uÅ); uÅ = &un->
id_Ãxt
) {

476 ià(
u
 =ğ
un
)

477 
found
;

479 
	`´štk
 ("£m_ex™ undØli¡ƒ¼Ü id=%d\n", 
u
->
£mid
);

481 
found
:

482 *
uÅ
 = 
un
->
id_Ãxt
;

483 ià(!
un
->
£madj
)

486 ià(
sma
->
£m_³rm
.
£q
 !ğ
un
->
£mid
 / 
SEMMNI
)

488 
£m
 = &
sma
->
£m_ba£
[
un
->
£m_num
];

489 ià(
£m
->
£mv®
 + 
un
->
£madj
 >= 0) {

490 
£m
->
£mv®
 +ğ
un
->
£madj
;

491 
£m
->
£mpid
 = 
cu¼’t
->
pid
;

492 
sma
->
£m_Ùime
 = 
CURRENT_TIME
;

493 ià(
un
->
£madj
 > 0 && 
sma
->
ev’Š
)

494 
	`wake_up
 (&
sma
->
ev’Š
);

495 ià(!
£m
->
£mv®
 && 
sma
->
ev’tz
)

496 
	`wake_up
 (&
sma
->
ev’tz
);

499 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

501 
£m
->
£mnút
++;

502 
	`š‹¼u±ibË_¦“p_Ú
 (&
sma
->
ev’Š
);

503 
£m
->
£mnút
--;

506 
cu¼’t
->
£mun
 = 
NULL
;

508 
	}
}

	@ipc/shm.c

8 
	~<lšux/”ºo.h
>

9 
	~<asm/£gm’t.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/c.h
>

12 
	~<lšux/shm.h
>

13 
	~<lšux/¡©.h
>

14 
	~<lšux/m®loc.h
>

16 
ı”ms
 (
c_³rm
 *
ı
, 
£mæg
);

17 
g‘_sw­_·ge
();

18 
fšdkey
 (
key_t
 
key
);

19 
Ãw£g
 (
key_t
 
key
, 
shmæg
, 
size
);

20 
shm_m­
 (
shm_desc
 *
shmd
, 
»m­
);

21 
kl£g
 (
id
);

23 
	gshm_tÙ
 = 0;

24 
	gshm_rss
 = 0;

25 
	gshm_swp
 = 0;

26 
	gmax_shmid
 = 0;

27 
wa™_queue
 *
	gshm_lock
 = 
NULL
;

28 
shmid_ds
 *
	gshm_£gs
[
SHMMNI
];

30 
	gshm_£q
 = 0;

33 
ulÚg
 
	gsw­_©‹m±s
 = 0;

34 
ulÚg
 
	gsw­_sucûs£s
 = 0;

35 
ulÚg
 
	gu£d_£gs
 = 0;

37 
	$shm_š™
 ()

39 
id
;

41 
id
 = 0; id < 
SHMMNI
; id++)

42 
shm_£gs
[
id
] = (
shmid_ds
 *è
IPC_UNUSED
;

43 
shm_tÙ
 = 
shm_rss
 = 
shm_£q
 = 
max_shmid
 = 
u£d_£gs
 = 0;

44 
shm_lock
 = 
NULL
;

46 
	}
}

48 
	$fšdkey
 (
key_t
 
key
)

50 
id
;

51 
shmid_ds
 *
shp
;

53 
id
=0; id <ğ
max_shmid
; id++) {

54 (
shp
 = 
shm_£gs
[
id
]è=ğ
IPC_NOID
)

55 
	`¦“p_Ú
 (&
shm_lock
);

56 ià(
shp
 =ğ
IPC_UNUSED
)

58 ià(
key
 =ğ
shp
->
shm_³rm
.key)

59  
id
;

62 
	}
}

67 
	$Ãw£g
 (
key_t
 
key
, 
shmæg
, 
size
)

69 
shmid_ds
 *
shp
;

70 
num·ges
 = (
size
 + 
PAGE_SIZE
 -1è>> 
PAGE_SHIFT
;

71 
id
, 
i
;

73 ià(
size
 < 
SHMMIN
)

74  -
EINVAL
;

75 ià(
shm_tÙ
 + 
num·ges
 >ğ
SHMALL
)

76  -
ENOSPC
;

77 
id
=0; id < 
SHMMNI
; id++)

78 ià(
shm_£gs
[
id
] =ğ
IPC_UNUSED
) {

79 
shm_£gs
[
id
] = (
shmid_ds
 *è
IPC_NOID
;

80 
found
;

82  -
ENOSPC
;

84 
found
:

85 
shp
 = (
shmid_ds
 *è
	`km®loc
 ( (*shp), 
GFP_KERNEL
);

86 ià(!
shp
) {

87 
shm_£gs
[
id
] = (
shmid_ds
 *è
IPC_UNUSED
;

88 ià(
shm_lock
)

89 
	`wake_up
 (&
shm_lock
);

90  -
ENOMEM
;

93 
shp
->
shm_·ges
 = (
ulÚg
 *è
	`km®loc
 (
num·ges
*(ulÚg),
GFP_KERNEL
);

94 ià(!
shp
->
shm_·ges
) {

95 
shm_£gs
[
id
] = (
shmid_ds
 *è
IPC_UNUSED
;

96 ià(
shm_lock
)

97 
	`wake_up
 (&
shm_lock
);

98 
	`kä“_s
 (
shp
,  (*shp));

99  -
ENOMEM
;

102 
i
=0; i< 
num·ges
; 
shp
->
shm_·ges
[i++] = 0);

103 
shm_tÙ
 +ğ
num·ges
;

104 
shp
->
shm_³rm
.
key
 = key;

105 
shp
->
shm_³rm
.
mode
 = (
shmæg
 & 
S_IRWXUGO
);

106 
shp
->
shm_³rm
.
cuid
 = shp->shm_³rm.
uid
 = 
cu¼’t
->
euid
;

107 
shp
->
shm_³rm
.
cgid
 = shp->shm_³rm.
gid
 = 
cu¼’t
->
egid
;

108 
shp
->
shm_³rm
.
£q
 = 
shm_£q
;

109 
shp
->
shm_£gsz
 = 
size
;

110 
shp
->
shm_ıid
 = 
cu¼’t
->
pid
;

111 
shp
->
©ches
 = 
NULL
;

112 
shp
->
shm_Íid
 = shp->
shm_Ç‰ch
 = 0;

113 
shp
->
shm_©ime
 = shp->
shm_dtime
 = 0;

114 
shp
->
shm_ùime
 = 
CURRENT_TIME
;

115 
shp
->
shm_Åages
 = 
num·ges
;

117 ià(
id
 > 
max_shmid
)

118 
max_shmid
 = 
id
;

119 
shm_£gs
[
id
] = 
shp
;

120 
u£d_£gs
++;

121 ià(
shm_lock
)

122 
	`wake_up
 (&
shm_lock
);

123  
id
 + ()
shm_£q
*
SHMMNI
;

124 
	}
}

126 
	$sys_shmg‘
 (
key_t
 
key
, 
size
, 
shmæg
)

128 
shmid_ds
 *
shp
;

129 
id
 = 0;

131 ià(
size
 < 0 || siz> 
SHMMAX
)

132  -
EINVAL
;

133 ià(
key
 =ğ
IPC_PRIVATE
)

134  
	`Ãw£g
(
key
, 
shmæg
, 
size
);

135 ià((
id
 = 
	`fšdkey
 (
key
)) == -1) {

136 ià(!(
shmæg
 & 
IPC_CREAT
))

137  -
ENOENT
;

138  
	`Ãw£g
(
key
, 
shmæg
, 
size
);

140 ià((
shmæg
 & 
IPC_CREAT
è&& (shmæg & 
IPC_EXCL
))

141  -
EEXIST
;

142 
shp
 = 
shm_£gs
[
id
];

143 ià(
shp
->
shm_³rm
.
mode
 & 
SHM_DEST
)

144  -
EIDRM
;

145 ià(
size
 > 
shp
->
shm_£gsz
)

146  -
EINVAL
;

147 ià(
	`ı”ms
 (&
shp
->
shm_³rm
, 
shmæg
))

148  -
EACCES
;

149  
shp
->
shm_³rm
.
£q
*
SHMMNI
 + 
id
;

150 
	}
}

156 
	$kl£g
 (
id
)

158 
shmid_ds
 *
shp
;

159 
i
, 
num·ges
;

160 
ulÚg
 
·ge
;

162 
shp
 = 
shm_£gs
[
id
];

163 ià(
shp
 =ğ
IPC_NOID
 || sh°=ğ
IPC_UNUSED
) {

164 
	`´štk
 ("shm‚Úo: kl£g c®Ëd oÀunu£d seg id=%d\n", 
id
);

167 
shp
->
shm_³rm
.
£q
++;

168 
num·ges
 = 
shp
->
shm_Åages
;

169 
shm_£q
++;

170 
shm_£gs
[
id
] = (
shmid_ds
 *è
IPC_UNUSED
;

171 
u£d_£gs
--;

172 ià(
id
 =ğ
max_shmid
)

173 
max_shmid
 && (
shm_£gs
[--max_shmid] =ğ
IPC_UNUSED
));

174 ià(!
shp
->
shm_·ges
) {

175 
	`´štk
 ("shm‚Úo: kl£g shp->·ges=NULL. id=%d\n", 
id
);

178 
i
=0; i< 
num·ges
 ; i++) {

179 ià(!(
·ge
 = 
shp
->
shm_·ges
[
i
]))

181 ià(
·ge
 & 1) {

182 
	`ä“_·ge
 (
·ge
 & 
PAGE_MASK
);

183 
shm_rss
--;

185 
	`sw­_ä“
 (
·ge
);

186 
shm_swp
--;

189 
	`kä“_s
 (
shp
->
shm_·ges
, 
num·ges
 *  (
ulÚg
));

190 
shm_tÙ
 -ğ
num·ges
;

191 
	`kä“_s
 (
shp
,  (*shp));

193 
	}
}

195 
	$sys_shmùl
 (
shmid
, 
cmd
, 
shmid_ds
 *
buf
)

197 
shmid_ds
 *
shp
, 
tbuf
;

198 
c_³rm
 *
ı
;

199 
id
, 
”r
;

201 ià(
cmd
 < 0 || 
shmid
 < 0)

202  -
EINVAL
;

203 ià(
cmd
 =ğ
IPC_SET
) {

204 ià(!
buf
)

205  -
EFAULT
;

206 
”r
 = 
	`v”ify_¬—
 (
VERIFY_READ
, 
buf
,  (*buf));

207 ià(
”r
)

208  
”r
;

209 
	`memıy_äomfs
 (&
tbuf
, 
buf
,  (*buf));

212 
cmd
) {

213 
IPC_INFO
:

215 
shmšfo
 shminfo;

216 ià(!
buf
)

217  -
EFAULT
;

218 
shmšfo
.
shmmni
 = 
SHMMNI
;

219 
shmšfo
.
shmmax
 = 
SHMMAX
;

220 
shmšfo
.
shmmš
 = 
SHMMIN
;

221 
shmšfo
.
shm®l
 = 
SHMALL
;

222 
shmšfo
.
shm£g
 = 
SHMSEG
;

223 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (
shmšfo
));

224 ià(
”r
)

225  
”r
;

226 
	`memıy_tofs
 (
buf
, &
shmšfo
, (shminfo));

227  
max_shmid
;

229 
SHM_INFO
:

231 
shm_šfo
 shm_info;

232 ià(!
buf
)

233  -
EFAULT
;

234 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (
shm_šfo
));

235 ià(
”r
)

236  
”r
;

237 
shm_šfo
.
u£d_ids
 = 
u£d_£gs
;

238 
shm_šfo
.
shm_rss
 = shm_rss;

239 
shm_šfo
.
shm_tÙ
 = shm_tot;

240 
shm_šfo
.
shm_swp
 = shm_swp;

241 
shm_šfo
.
sw­_©‹m±s
 = swap_attempts;

242 
shm_šfo
.
sw­_sucûs£s
 = swap_successes;

243 
	`memıy_tofs
 (
buf
, &
shm_šfo
, (shm_info));

244  
max_shmid
;

246 
SHM_STAT
:

247 ià(!
buf
)

248  -
EFAULT
;

249 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (*
shp
));

250 ià(
”r
)

251  
”r
;

252 ià(
shmid
 > 
max_shmid
)

253  -
EINVAL
;

254 
shp
 = 
shm_£gs
[
shmid
];

255 ià(
shp
 =ğ
IPC_UNUSED
 || sh°=ğ
IPC_NOID
)

256  -
EINVAL
;

257 ià(
	`ı”ms
 (&
shp
->
shm_³rm
, 
S_IRUGO
))

258  -
EACCES
;

259 
id
 = 
shmid
 + 
shp
->
shm_³rm
.
£q
 * 
SHMMNI
;

260 
	`memıy_tofs
 (
buf
, 
shp
, (*shp));

261  
id
;

264 
shp
 = 
shm_£gs
[
id
 = 
shmid
 % 
SHMMNI
];

265 ià(
shp
 =ğ
IPC_UNUSED
 || sh°=ğ
IPC_NOID
)

266  -
EINVAL
;

267 
ı
 = &
shp
->
shm_³rm
;

268 ià(
ı
->
£q
 !ğ
shmid
 / 
SHMMNI
)

269  -
EIDRM
;

271 
cmd
) {

272 
SHM_UNLOCK
:

273 ià(!
	`su£r
())

274  -
EPERM
;

275 ià(!(
ı
->
mode
 & 
SHM_LOCKED
))

276  -
EINVAL
;

277 
ı
->
mode
 &ğ~
SHM_LOCKED
;

279 
SHM_LOCK
:

283 ià(!
	`su£r
())

284  -
EPERM
;

285 ià(
ı
->
mode
 & 
SHM_LOCKED
)

286  -
EINVAL
;

287 
ı
->
mode
 |ğ
SHM_LOCKED
;

289 
IPC_STAT
:

290 ià(
	`ı”ms
 (
ı
, 
S_IRUGO
))

291  -
EACCES
;

292 ià(!
buf
)

293  -
EFAULT
;

294 
”r
 = 
	`v”ify_¬—
 (
VERIFY_WRITE
, 
buf
,  (*
shp
));

295 ià(
”r
)

296  
”r
;

297 
	`memıy_tofs
 (
buf
, 
shp
, (*shp));

299 
IPC_SET
:

300 ià(
	`su£r
(è|| 
cu¼’t
->
euid
 =ğ
shp
->
shm_³rm
.
uid
 ||

301 
cu¼’t
->
euid
 =ğ
shp
->
shm_³rm
.
cuid
) {

302 
ı
->
uid
 = 
tbuf
.
shm_³rm
.uid;

303 
ı
->
gid
 = 
tbuf
.
shm_³rm
.gid;

304 
ı
->
mode
 = (ı->mod& ~
S_IRWXUGO
)

305 | (
tbuf
.
shm_³rm
.
mode
 & 
S_IRWXUGO
);

306 
shp
->
shm_ùime
 = 
CURRENT_TIME
;

309  -
EPERM
;

310 
IPC_RMID
:

311 ià(
	`su£r
(è|| 
cu¼’t
->
euid
 =ğ
shp
->
shm_³rm
.
uid
 ||

312 
cu¼’t
->
euid
 =ğ
shp
->
shm_³rm
.
cuid
) {

313 
shp
->
shm_³rm
.
mode
 |ğ
SHM_DEST
;

314 ià(
shp
->
shm_Ç‰ch
 <= 0)

315 
	`kl£g
 (
id
);

318  -
EPERM
;

320  -
EINVAL
;

323 
	}
}

330 
	$shm_m­
 (
shm_desc
 *
shmd
, 
»m­
)

332 
šv®id
 = 0;

333 *
·ge_bË
;

334 
tmp
, 
shm_sgn
;

335 
·ge_dœ
 = 
shmd
->
sk
->
tss
.
ü3
;

338 
tmp
 = 
shmd
->
¡¬t
;m°< shmd->
’d
;m°+ğ
PAGE_SIZE
) {

339 
·ge_bË
 = 
	`PAGE_DIR_OFFSET
(
·ge_dœ
,
tmp
);

340 ià(*
·ge_bË
 & 
PAGE_PRESENT
) {

341 
·ge_bË
 = (
ulÚg
 *è(
PAGE_MASK
 & *page_table);

342 
·ge_bË
 +ğ((
tmp
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1));

343 ià(*
·ge_bË
) {

344 ià(!
»m­
)

345  -
EINVAL
;

346 ià(*
·ge_bË
 & 
PAGE_PRESENT
) {

347 --
cu¼’t
->
rss
;

348 
	`ä“_·ge
 (*
·ge_bË
 & 
PAGE_MASK
);

351 
	`sw­_ä“
 (*
·ge_bË
);

352 
šv®id
++;

357 
Ãw_±
;

358 if(!(
Ãw_±
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
)))

359  -
ENOMEM
;

360 *
·ge_bË
 = 
Ãw_±
 | 
PAGE_TABLE
;

361 
tmp
 |ğ((
PAGE_SIZE
 << 10) - PAGE_SIZE);

363 ià(
šv®id
)

364 
	`šv®id©e
();

367 
shm_sgn
 = 
shmd
->shm_sgn;

368 
tmp
 = 
shmd
->
¡¬t
;m°< shmd->
’d
;m°+ğ
PAGE_SIZE
,

369 
shm_sgn
 +ğ(1 << 
SHM_IDX_SHIFT
)) {

370 
·ge_bË
 = 
	`PAGE_DIR_OFFSET
(
·ge_dœ
,
tmp
);

371 
·ge_bË
 = (
ulÚg
 *è(
PAGE_MASK
 & *page_table);

372 
·ge_bË
 +ğ(
tmp
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

373 *
·ge_bË
 = 
shm_sgn
;

376 
	}
}

383 
	$sys_shm©
 (
shmid
, *
shmaddr
, 
shmæg
, 
ulÚg
 *
¿ddr
)

385 
shmid_ds
 *
shp
;

386 
shm_desc
 *
shmd
;

387 
”r
;

388 
id
;

389 
addr
;

391 ià(
shmid
 < 0)

392  -
EINVAL
;

394 ià(
¿ddr
) {

395 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
¿ddr
, ());

396 ià(
”r
)

397  
”r
;

400 
shp
 = 
shm_£gs
[
id
 = 
shmid
 % 
SHMMNI
];

401 ià(
shp
 =ğ
IPC_UNUSED
 || sh°=ğ
IPC_NOID
)

402  -
EINVAL
;

404 ià(!(
addr
 = (
ulÚg
è
shmaddr
)) {

405 ià(
shmæg
 & 
SHM_REMAP
)

406  -
EINVAL
;

408 
addr
 = 
SHM_RANGE_END
;

409 
shmd
 = 
cu¼’t
->
shm
; shmd; shmd = shmd->
sk_Ãxt
) {

410 ià(
shmd
->
¡¬t
 < 
SHM_RANGE_START
)

412 ià(
addr
 >ğ
shmd
->
¡¬t
)

413 
addr
 = 
shmd
->
¡¬t
;

415 
addr
 = (add¸- 
shp
->
shm_£gsz
è& 
PAGE_MASK
;

416 } ià(
addr
 & (
SHMLBA
-1)) {

417 ià(
shmæg
 & 
SHM_RND
)

418 
addr
 &ğ~(
SHMLBA
-1);

420  -
EINVAL
;

422 ià((
addr
 > 
cu¼’t
->
¡¬t_¡ack
 - 16384 - 
PAGE_SIZE
*
shp
->
shm_Åages
))

423  -
EINVAL
;

424 ià(
shmæg
 & 
SHM_REMAP
)

425 
shmd
 = 
cu¼’t
->
shm
; shmd; shmd = shmd->
sk_Ãxt
) {

426 ià(
addr
 >ğ
shmd
->
¡¬t
 &&‡dd¸< shmd->
’d
)

427  -
EINVAL
;

428 ià(
addr
 + 
shp
->
shm_£gsz
 >ğ
shmd
->
¡¬t
 &&

429 
addr
 + 
shp
->
shm_£gsz
 < 
shmd
->
’d
)

430  -
EINVAL
;

433 ià(
	`ı”ms
(&
shp
->
shm_³rm
, 
shmæg
 & 
SHM_RDONLY
 ? 
S_IRUGO
 : S_IRUGO|
S_IWUGO
))

434  -
EACCES
;

435 ià(
shp
->
shm_³rm
.
£q
 !ğ
shmid
 / 
SHMMNI
)

436  -
EIDRM
;

438 
shmd
 = (
shm_desc
 *è
	`km®loc
 ((*shmd), 
GFP_KERNEL
);

439 ià(!
shmd
)

440  -
ENOMEM
;

441 ià((
shp
 !ğ
shm_£gs
[
id
]è|| (shp->
shm_³rm
.
£q
 !ğ
shmid
 / 
SHMMNI
)) {

442 
	`kä“_s
 (
shmd
,  (*shmd));

443  -
EIDRM
;

445 
shmd
->
shm_sgn
 = (
SHM_SWP_TYPE
 << 1è| (
id
 << 
SHM_ID_SHIFT
) |

446 (
shmæg
 & 
SHM_RDONLY
 ? 
SHM_READ_ONLY
 : 0);

447 
shmd
->
¡¬t
 = 
addr
;

448 
shmd
->
’d
 = 
addr
 + 
shp
->
shm_Åages
 * 
PAGE_SIZE
;

449 
shmd
->
sk
 = 
cu¼’t
;

451 
shp
->
shm_Ç‰ch
++;

452 ià(
addr
 < 
cu¼’t
->
’d_d©a
) {

453 
	`ut
 (
cu¼’t
->
execubË
);

454 
cu¼’t
->
execubË
 = 
NULL
;

458 ià((
”r
 = 
	`shm_m­
 (
shmd
, 
shmæg
 & 
SHM_REMAP
))) {

459 ià(--
shp
->
shm_Ç‰ch
 <ğ0 && shp->
shm_³rm
.
mode
 & 
SHM_DEST
)

460 
	`kl£g
(
id
);

461 
	`kä“_s
 (
shmd
,  (*shmd));

462  
”r
;

465 
shmd
->
sk_Ãxt
 = 
cu¼’t
->
shm
;

466 
cu¼’t
->
shm
 = 
shmd
;

467 
shmd
->
£g_Ãxt
 = 
shp
->
©ches
;

468 
shp
->
©ches
 = 
shmd
;

469 
shp
->
shm_Íid
 = 
cu¼’t
->
pid
;

470 
shp
->
shm_©ime
 = 
CURRENT_TIME
;

471 ià(!
¿ddr
)

472  
addr
;

473 
	`put_fs_lÚg
 (
addr
, 
¿ddr
);

475 
	}
}

482 
	$d‘ach
 (
shm_desc
 **
shmdp
)

484 
shm_desc
 *
shmd
 = *
shmdp
;

485 
shmid_ds
 *
shp
;

486 
id
;

488 
id
 = (
shmd
->
shm_sgn
 >> 
SHM_ID_SHIFT
è& 
SHM_ID_MASK
;

489 
shp
 = 
shm_£gs
[
id
];

490 *
shmdp
 = 
shmd
->
sk_Ãxt
;

491 
shmdp
 = &
shp
->
©ches
; *shmdp; shmd°ğ&(*shmdp)->
£g_Ãxt
)

492 ià(*
shmdp
 =ğ
shmd
) {

493 *
shmdp
 = 
shmd
->
£g_Ãxt
;

494 
found
;

496 
	`´štk
("d‘ach: shm segm’ˆ(id=%dè©ch†i¡ incÚsi¡’t\n",
id
);

498 
found
:

499 
	`unm­_·ge_¿nge
 (
shmd
->
¡¬t
, 
shp
->
shm_£gsz
);

500 
	`kä“_s
 (
shmd
,  (*shmd));

501 
shp
->
shm_Íid
 = 
cu¼’t
->
pid
;

502 
shp
->
shm_dtime
 = 
CURRENT_TIME
;

503 ià(--
shp
->
shm_Ç‰ch
 <ğ0 && shp->
shm_³rm
.
mode
 & 
SHM_DEST
)

504 
	`kl£g
 (
id
);

506 
	}
}

512 
	$sys_shmdt
 (*
shmaddr
)

514 
shm_desc
 *
shmd
, **
shmdp
;

516 
shmdp
 = &
cu¼’t
->
shm
; (
shmd
 = *shmdp); shmdp=&shmd->
sk_Ãxt
) {

517 ià(
shmd
->
¡¬t
 =ğ(
ulÚg
è
shmaddr
) {

518 
	`d‘ach
 (
shmdp
);

522  -
EINVAL
;

523 
	}
}

528 
	$shm_ex™
 ()

530 
cu¼’t
->
shm
)

531 
	`d‘ach
(&
cu¼’t
->
shm
);

533 
	}
}

540 
	$shm_fÜk
 (
sk_¡ruù
 *
p1
, sk_¡ruù *
p2
)

542 
shm_desc
 *
shmd
, *
Ãw_desc
 = 
NULL
, *
tmp
;

543 
shmid_ds
 *
shp
;

544 
id
;

546 ià(!
p1
->
shm
)

548 
shmd
 = 
p1
->
shm
; shmd; shmd = shmd->
sk_Ãxt
) {

549 
tmp
 = (
shm_desc
 *è
	`km®loc
((*tmp), 
GFP_KERNEL
);

550 ià(!
tmp
) {

551 
Ãw_desc
) {

552 
tmp
 = 
Ãw_desc
->
sk_Ãxt
;

553 
	`kä“_s
 (
Ãw_desc
,  (*new_desc));

554 
Ãw_desc
 = 
tmp
;

556 
	`ä“_·ge_bËs
 (
p2
);

557  -
ENOMEM
;

559 *
tmp
 = *
shmd
;

560 
tmp
->
sk
 = 
p2
;

561 
tmp
->
sk_Ãxt
 = 
Ãw_desc
;

562 
Ãw_desc
 = 
tmp
;

564 
p2
->
shm
 = 
Ãw_desc
;

565 
shmd
 = 
Ãw_desc
; shmd; shmd = shmd->
sk_Ãxt
) {

566 
id
 = (
shmd
->
shm_sgn
 >> 
SHM_ID_SHIFT
è& 
SHM_ID_MASK
;

567 
shp
 = 
shm_£gs
[
id
];

568 ià(
shp
 =ğ
IPC_UNUSED
) {

569 
	`´štk
("shm_fÜk: unu£d id=%d PANIC\n", 
id
);

570  -
ENOMEM
;

572 
shmd
->
£g_Ãxt
 = 
shp
->
©ches
;

573 
shp
->
©ches
 = 
shmd
;

574 
shp
->
shm_Ç‰ch
++;

575 
shp
->
shm_©ime
 = 
CURRENT_TIME
;

576 
shp
->
shm_Íid
 = 
cu¼’t
->
pid
;

579 
	}
}

584 
	$shm_no_·ge
 (*
±’t
)

586 
·ge
;

587 
code
 = *
±’t
;

588 
shmid_ds
 *
shp
;

589 
id
, 
idx
;

591 
id
 = (
code
 >> 
SHM_ID_SHIFT
è& 
SHM_ID_MASK
;

592 ià(
id
 > 
max_shmid
) {

593 
	`´štk
 ("shm_no_·ge: id=%doØbig.…roømem cÜru±edn", 
id
);

596 
shp
 = 
shm_£gs
[
id
];

597 ià(
shp
 =ğ
IPC_UNUSED
 || sh°=ğ
IPC_NOID
) {

598 
	`´štk
 ("shm_no_·ge: id=%d inv®id. Raû.\n", 
id
);

601 
idx
 = (
code
 >> 
SHM_IDX_SHIFT
è& 
SHM_IDX_MASK
;

602 ià(
idx
 >ğ
shp
->
shm_Åages
) {

603 
	`´štk
 ("shm_no_·g:oØÏrg·gšdex. id=%d\n", 
id
);

607 ià(!(
shp
->
shm_·ges
[
idx
] & 
PAGE_PRESENT
)) {

608 if(!(
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

609 
	`oom
(
cu¼’t
);

610 *
±’t
 = 
BAD_PAGE
 | 
PAGE_ACCESSED
 | 7;

613 ià(
shp
->
shm_·ges
[
idx
] & 
PAGE_PRESENT
) {

614 
	`ä“_·ge
 (
·ge
);

615 
dÚe
;

617 ià(
shp
->
shm_·ges
[
idx
]) {

618 
	`»ad_sw­_·ge
 (
shp
->
shm_·ges
[
idx
], (*è
·ge
);

619 ià(
shp
->
shm_·ges
[
idx
] & 
PAGE_PRESENT
) {

620 
	`ä“_·ge
 (
·ge
);

621 
dÚe
;

623 
	`sw­_ä“
 (
shp
->
shm_·ges
[
idx
]);

624 
shm_swp
--;

626 
shm_rss
++;

627 
shp
->
shm_·ges
[
idx
] = 
·ge
 | (
PAGE_SHARED
 | 
PAGE_DIRTY
);

629 --
cu¼’t
->
maj_æt
;

631 
dÚe
:

632 
cu¼’t
->
mš_æt
++;

633 
·ge
 = 
shp
->
shm_·ges
[
idx
];

634 ià(
code
 & 
SHM_READ_ONLY
)

635 
·ge
 &= ~2;

636 
mem_m­
[
	`MAP_NR
(
·ge
)]++;

637 *
±’t
 = 
·ge
;

639 
	}
}

644 
	gsw­_id
 = 0;

645 
	gsw­_idx
 = 0;

647 
	$shm_sw­
 (
´io
)

649 
·ge
;

650 
shmid_ds
 *
shp
;

651 
shm_desc
 *
shmd
;

652 
sw­_Ä
;

653 
id
, 
idx
, 
šv®id
 = 0;

654 
couÁ”
;

656 
couÁ”
 = 
shm_rss
 >> 
´io
;

657 ià(!
couÁ”
 || !(
sw­_Ä
 = 
	`g‘_sw­_·ge
()))

660 
check_id
:

661 
shp
 = 
shm_£gs
[
sw­_id
];

662 ià(
shp
 =ğ
IPC_UNUSED
 || sh°=ğ
IPC_NOID
 || shp->
shm_³rm
.
mode
 & 
SHM_LOCKED
 ) {

663 
sw­_idx
 = 0;

664 ià(++
sw­_id
 > 
max_shmid
)

665 
sw­_id
 = 0;

666 
check_id
;

668 
id
 = 
sw­_id
;

670 
check_bË
:

671 
idx
 = 
sw­_idx
++;

672 ià(
idx
 >ğ
shp
->
shm_Åages
) {

673 
sw­_idx
 = 0;

674 ià(++
sw­_id
 > 
max_shmid
)

675 
sw­_id
 = 0;

676 
check_id
;

679 
·ge
 = 
shp
->
shm_·ges
[
idx
];

680 ià(!(
·ge
 & 
PAGE_PRESENT
))

681 
check_bË
;

682 
sw­_©‹m±s
++;

684 ià(--
couÁ”
 < 0) {

685 ià(
šv®id
)

686 
	`šv®id©e
();

687 
	`sw­_ä“
 (
sw­_Ä
);

690 
shmd
 = 
shp
->
©ches
; shmd; shmd = shmd->
£g_Ãxt
) {

691 
tmp
, *
±e
;

692 ià((
shmd
->
shm_sgn
 >> 
SHM_ID_SHIFT
 & 
SHM_ID_MASK
è!ğ
id
) {

693 
	`´štk
 ("shm_sw­: id=%ld dÛ nÙ m©ch shmd\n", 
id
);

696 
tmp
 = 
shmd
->
¡¬t
 + (
idx
 << 
PAGE_SHIFT
);

697 ià(
tmp
 >ğ
shmd
->
’d
) {

698 
	`´štk
 ("shm_sw­:oØÏrgidx=%ld id=%ld PANIC\n",
idx
, 
id
);

701 
±e
 = 
	`PAGE_DIR_OFFSET
(
shmd
->
sk
->
tss
.
ü3
,
tmp
);

702 ià(!(*
±e
 & 1)) {

703 
	`´štk
("shm_swap: bad…gtbl! id=%ld start=%lx idx=%ld\n",

704 
id
, 
shmd
->
¡¬t
, 
idx
);

705 *
±e
 = 0;

708 
±e
 = (
ulÚg
 *è(
PAGE_MASK
 & *pte);

709 
±e
 +ğ((
tmp
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1));

710 
tmp
 = *
±e
;

711 ià(!(
tmp
 & 
PAGE_PRESENT
))

713 ià(
tmp
 & 
PAGE_ACCESSED
) {

714 *
±e
 &ğ~
PAGE_ACCESSED
;

717 
tmp
 = 
shmd
->
shm_sgn
 | 
idx
 << 
SHM_IDX_SHIFT
;

718 *
±e
 = 
tmp
;

719 
mem_m­
[
	`MAP_NR
(
·ge
)]--;

720 
shmd
->
sk
->
rss
--;

721 
šv®id
++;

724 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] != 1)

725 
check_bË
;

726 
·ge
 &ğ
PAGE_MASK
;

727 
shp
->
shm_·ges
[
idx
] = 
sw­_Ä
;

728 ià(
šv®id
)

729 
	`šv®id©e
();

730 
	`wr™e_sw­_·ge
 (
sw­_Ä
, (*è
·ge
);

731 
	`ä“_·ge
 (
·ge
);

732 
sw­_sucûs£s
++;

733 
shm_swp
++;

734 
shm_rss
--;

736 
	}
}

	@ipc/util.c

6 
	~<lšux/cÚfig.h
>

7 
	~<lšux/”ºo.h
>

8 
	~<asm/£gm’t.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/£m.h
>

11 
	~<lšux/msg.h
>

12 
	~<lšux/shm.h
>

13 
	~<lšux/¡©.h
>

15 
c_š™
 ();

16 
asmlškage
 
sys_c
 (
ušt
 
ÿÎ
, 
fœ¡
, 
£cÚd
, 
thœd
, *
±r
);

18 #ifdeà
CONFIG_SYSVIPC


20 
ı”ms
 (
c_³rm
 *
ı
, 
æag
);

21 
£m_š™
 (), 
msg_š™
 (), 
shm_š™
 ();

22 
sys_£mg‘
 (
key_t
 
key
, 
n£ms
, 
£mæg
);

23 
sys_£mİ
 (
£mid
, 
£mbuf
 *
sİs
, 
nsİs
);

24 
sys_£mùl
 (
£mid
, 
£mnum
, 
cmd
, *
¬g
);

25 
sys_msgg‘
 (
key_t
 
key
, 
msgæg
);

26 
sys_msg¢d
 (
msqid
, 
msgbuf
 *
msgp
, 
msgsz
, 
msgæg
);

27 
sys_msgrcv
 (
msqid
, 
msgbuf
 *
msgp
, 
msgsz
, 
msgtyp
,

28 
msgæg
);

29 
sys_msgùl
 (
msqid
, 
cmd
, 
msqid_ds
 *
buf
);

30 
sys_shmùl
 (
shmid
, 
cmd
, 
shmid_ds
 *
buf
);

31 
sys_shmg‘
 (
key_t
 
key
, 
size
, 
æag
);

32 
sys_shm©
 (
shmid
, *
shmaddr
, 
shmæg
, 
ulÚg
 *
addr
);

33 
sys_shmdt
 (*
shmaddr
);

35 
	$c_š™
 ()

37 
	`£m_š™
();

38 
	`msg_š™
();

39 
	`shm_š™
();

41 
	}
}

47 
	$ı”ms
 (
c_³rm
 *
ı
, 
æag
)

49 
»que¡ed_mode
, 
g¿Áed_mode
;

51 ià(
	`su£r
())

53 
»que¡ed_mode
 = (
æag
 >> 6) | (flag >> 3) | flag;

54 
g¿Áed_mode
 = 
ı
->
mode
;

55 ià(
cu¼’t
->
euid
 =ğ
ı
->
cuid
 || cu¼’t->euid =ğı->
uid
)

56 
g¿Áed_mode
 >>= 6;

57 ià(
	`š_group_p
(
ı
->
cgid
è|| in_group_p(ı->
gid
))

58 
g¿Áed_mode
 >>= 3;

60 ià(
»que¡ed_mode
 & ~
g¿Áed_mode
 & 0007)

63 
	}
}

65 
asmlškage
 
	$sys_c
 (
ušt
 
ÿÎ
, 
fœ¡
, 
£cÚd
, 
thœd
, *
±r
)

68 ià(
ÿÎ
 <ğ
SEMCTL
)

69 
ÿÎ
) {

70 
SEMOP
:

71  
	`sys_£mİ
 (
fœ¡
, (
£mbuf
 *)
±r
, 
£cÚd
);

72 
SEMGET
:

73  
	`sys_£mg‘
 (
fœ¡
, 
£cÚd
, 
thœd
);

74 
SEMCTL
:

75  
	`sys_£mùl
 (
fœ¡
, 
£cÚd
, 
thœd
, 
±r
);

77  -
EINVAL
;

79 ià(
ÿÎ
 <ğ
MSGCTL
)

80 
ÿÎ
) {

81 
MSGSND
:

82  
	`sys_msg¢d
 (
fœ¡
, (
msgbuf
 *è
±r
,

83 
£cÚd
, 
thœd
);

84 
MSGRCV
: {

85 
c_kludge
 
tmp
;

86 ià(!
±r
)

87  -
EINVAL
;

88 
	`memıy_äomfs
 (&
tmp
,(
c_kludge
 *è
±r
,

89  (
tmp
));

90  
	`sys_msgrcv
 (
fœ¡
, 
tmp
.
msgp
, 
£cÚd
,mp.
msgtyp
,

91 
thœd
);

93 
MSGGET
:

94  
	`sys_msgg‘
 ((
key_t
è
fœ¡
, 
£cÚd
);

95 
MSGCTL
:

96  
	`sys_msgùl
 (
fœ¡
, 
£cÚd
,

97 (
msqid_ds
 *è
±r
);

99  -
EINVAL
;

101 ià(
ÿÎ
 <ğ
SHMCTL
)

102 
ÿÎ
) {

103 
SHMAT
:

104  
	`sys_shm©
 (
fœ¡
, (*è
±r
, 
£cÚd
,

105 (
ulÚg
 *è
thœd
);

106 
SHMDT
:

107  
	`sys_shmdt
 ((*)
±r
);

108 
SHMGET
:

109  
	`sys_shmg‘
 (
fœ¡
, 
£cÚd
, 
thœd
);

110 
SHMCTL
:

111  
	`sys_shmùl
 (
fœ¡
, 
£cÚd
,

112 (
shmid_ds
 *è
±r
);

114  -
EINVAL
;

116  -
EINVAL
;

117 
	}
}

121 
asmlškage
 
	$sys_c
 (
ušt
 
ÿÎ
, 
fœ¡
, 
£cÚd
, 
thœd
, *
±r
)

123  -
ENOSYS
;

124 
	}
}

126 
	$shm_fÜk
 (
sk_¡ruù
 *
p1
, sk_¡ruù *
p2
)

129 
	}
}

131 
	$£m_ex™
 ()

134 
	}
}

136 
	$shm_ex™
 ()

139 
	}
}

141 
	$shm_sw­
 (
´io
)

144 
	}
}

146 
	$shm_no_·ge
 (*
±’t
)

149 
	}
}

	@kernel/dma.c

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/”ºo.h
>

8 
	~<asm/dma.h
>

32 vŞ©
	gdma_chª_busy
[
MAX_DMA_CHANNELS
] = {

44 
__šlše__
 
	$mu‹x_©omic_sw­
(vŞ©* 
p
, 
Ãwv®
)

46 
£mv®
 = 
Ãwv®
;

55 
asm
 
	`__vŞ©e__
 ("xchgl %2, %0\n"

56 : "ô" (
£mv®
)

57 : "0" (
£mv®
), "m" (*
p
)

59  
£mv®
;

60 
	}
}

64 
	$»que¡_dma
(
dmªr
)

66 ià(
dmªr
 >ğ
MAX_DMA_CHANNELS
)

67  -
EINVAL
;

69 ià(
	`mu‹x_©omic_sw­
(&
dma_chª_busy
[
dmªr
], 1) != 0)

70  -
EBUSY
;

74 
	}
}

77 
	$ä“_dma
(
dmªr
)

79 ià(
dmªr
 >ğ
MAX_DMA_CHANNELS
) {

80 
	`´štk
("TryšgØä“ DMA%d\n", 
dmªr
);

84 ià(
	`mu‹x_©omic_sw­
(&
dma_chª_busy
[
dmªr
], 0) == 0)

85 
	`´štk
("TryšgØä“ f»DMA%d\n", 
dmªr
);

86 
	}
}

	@kernel/exit.c

7 
	#DEBUG_PROC_TREE


	)

9 
	~<lšux/wa™.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/sigÇl.h
>

12 
	~<lšux/sched.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/»sourû.h
>

15 
	~<lšux/mm.h
>

16 
	~<lšux/‰y.h
>

17 
	~<lšux/m®loc.h
>

19 
	~<asm/£gm’t.h
>

20 
shm_ex™
 ();

21 
£m_ex™
 ();

23 
g‘ru§ge
(
sk_¡ruù
 *, , 
ru§ge
 *);

25 
	$g’”©e
(
sig
, 
sk_¡ruù
 * 
p
)

27 
mask
 = 1 << (
sig
-1);

28 
sigaùiÚ
 * 
§
 = 
sig
 + 
p
->sigaction - 1;

31 ià(
p
->
æags
 & 
PF_PTRACED
) {

32 
p
->
sigÇl
 |ğ
mask
;

36 ià(
§
->
§_hªdËr
 =ğ
SIG_IGN
 && 
sig
 !ğ
SIGCHLD
)

39 ià((
§
->
§_hªdËr
 =ğ
SIG_DFL
) &&

40 (
sig
 =ğ
SIGCONT
 || sig =ğ
SIGCHLD
 || sig =ğ
SIGWINCH
))

42 
p
->
sigÇl
 |ğ
mask
;

44 
	}
}

46 
	$£nd_sig
(
sig
,
sk_¡ruù
 * 
p
,
´iv
)

48 ià(!
p
 || 
sig
 > 32)

49  -
EINVAL
;

50 ià(!
´iv
 && ((
sig
 !ğ
SIGCONT
è|| (
cu¼’t
->
£ssiÚ
 !ğ
p
->session)) &&

51 (
cu¼’t
->
euid
 !ğ
p
->euidè&& (cu¼’t->
uid
 !ğp->uidè&& !
	`su£r
())

52  -
EPERM
;

53 ià(!
sig
)

55 ià((
sig
 =ğ
SIGKILL
è|| (sig =ğ
SIGCONT
)) {

56 ià(
p
->
¡©e
 =ğ
TASK_STOPPED
)

57 
p
->
¡©e
 = 
TASK_RUNNING
;

58 
p
->
ex™_code
 = 0;

59 
p
->
sigÇl
 &ğ~Ğ(1<<(
SIGSTOP
-1)è| (1<<(
SIGTSTP
-1)) |

60 (1<<(
SIGTTIN
-1)è| (1<<(
SIGTTOU
-1)) );

63 ià((
sig
 >ğ
SIGSTOP
è&& (sig <ğ
SIGTTOU
))

64 
p
->
sigÇl
 &ğ~(1<<(
SIGCONT
-1));

66 
	`g’”©e
(
sig
,
p
);

68 
	}
}

70 
	$nÙify_·»Á
(
sk_¡ruù
 * 
tsk
)

72 ià(
tsk
->
p_µŒ
 =ğ
sk
[1])

73 
tsk
->
ex™_sigÇl
 = 
SIGCHLD
;

74 
	`£nd_sig
(
tsk
->
ex™_sigÇl
,sk->
p_µŒ
, 1);

75 
	`wake_up_š‹¼u±ibË
(&
tsk
->
p_µŒ
->
wa™_chldex™
);

76 
	}
}

78 
	$»Ëa£
(
sk_¡ruù
 * 
p
)

80 
i
;

82 ià(!
p
)

84 ià(
p
 =ğ
cu¼’t
) {

85 
	`´štk
("task„eleasing itself\n");

88 
i
=1 ; i<
NR_TASKS
 ; i++)

89 ià(
sk
[
i
] =ğ
p
) {

90 
sk
[
i
] = 
NULL
;

91 
	`REMOVE_LINKS
(
p
);

92 
	`ä“_·ge
(
p
->
k”Ãl_¡ack_·ge
);

93 
	`ä“_·ge
((è
p
);

96 
	`·nic
("tryingo„elease‚on-existentask");

97 
	}
}

99 #ifdeà
DEBUG_PROC_TREE


104 
	$bad_sk_±r
(
sk_¡ruù
 *
p
)

106 
i
;

108 ià(!
p
)

110 
i
=0 ; i<
NR_TASKS
 ; i++)

111 ià(
sk
[
i
] =ğ
p
)

114 
	}
}

125 
	$aud™_±»e
()

127 
i
;

129 
i
=1 ; i<
NR_TASKS
 ; i++) {

130 ià(!
sk
[
i
])

132 ià(
	`bad_sk_±r
(
sk
[
i
]->
p_µŒ
))

133 
	`´štk
("Warning,…id %d's…arent†ink is bad\n",

134 
sk
[
i
]->
pid
);

135 ià(
	`bad_sk_±r
(
sk
[
i
]->
p_ıŒ
))

136 
	`´štk
("Warning,…id %d's child†ink is bad\n",

137 
sk
[
i
]->
pid
);

138 ià(
	`bad_sk_±r
(
sk
[
i
]->
p_y¥Œ
))

139 
	`´štk
("Warning,…id %d's ys†ink is bad\n",

140 
sk
[
i
]->
pid
);

141 ià(
	`bad_sk_±r
(
sk
[
i
]->
p_o¥Œ
))

142 
	`´štk
("Warning,…id %d's os†ink is bad\n",

143 
sk
[
i
]->
pid
);

144 ià(
sk
[
i
]->
p_µŒ
 ==ask[i])

145 
	`´štk
("Warning,…id %d…arent†ink…ointso self\n",

146 
sk
[
i
]->
pid
);

147 ià(
sk
[
i
]->
p_ıŒ
 ==ask[i])

148 
	`´štk
("Warning,…id %d child†ink…ointso self\n",

149 
sk
[
i
]->
pid
);

150 ià(
sk
[
i
]->
p_y¥Œ
 ==ask[i])

151 
	`´štk
("Warning,…id %d ys†ink…ointso self\n",

152 
sk
[
i
]->
pid
);

153 ià(
sk
[
i
]->
p_o¥Œ
 ==ask[i])

154 
	`´štk
("Warning,…id %d os†ink…ointso self\n",

155 
sk
[
i
]->
pid
);

156 ià(
sk
[
i
]->
p_o¥Œ
) {

157 ià(
sk
[
i
]->
p_µŒ
 !ğsk[i]->
p_o¥Œ
->p_pptr)

158 
	`´štk
(

160 
sk
[
i
]->
pid
,ask[i]->
p_o¥Œ
->pid,

161 
sk
[
i
]->
p_o¥Œ
->
p_µŒ
->
pid
);

162 ià(
sk
[
i
]->
p_o¥Œ
->
p_y¥Œ
 !=ask[i])

163 
	`´štk
(

165 
sk
[
i
]->
pid
,ask[i]->
p_o¥Œ
->pid);

167 ià(
sk
[
i
]->
p_y¥Œ
) {

168 ià(
sk
[
i
]->
p_µŒ
 !ğsk[i]->
p_y¥Œ
->p_pptr)

169 
	`´štk
(

171 
sk
[
i
]->
pid
,ask[i]->
p_o¥Œ
->pid,

172 
sk
[
i
]->
p_o¥Œ
->
p_µŒ
->
pid
);

173 ià(
sk
[
i
]->
p_y¥Œ
->
p_o¥Œ
 !=ask[i])

174 
	`´štk
(

176 
sk
[
i
]->
pid
,ask[i]->
p_y¥Œ
->pid);

178 ià(
sk
[
i
]->
p_ıŒ
) {

179 ià(
sk
[
i
]->
p_ıŒ
->
p_µŒ
 !=ask[i])

180 
	`´štk
(

182 
sk
[
i
]->
pid
,ask[i]->
p_ıŒ
->pid);

183 ià(
sk
[
i
]->
p_ıŒ
->
p_y¥Œ
)

184 
	`´štk
(

186 
sk
[
i
]->
pid
,ask[i]->
p_ıŒ
->pid);

189 
	}
}

197 
	$£ssiÚ_of_pg½
(
pg½
)

199 
sk_¡ruù
 *
p
;

200 
çÎback
;

202 
çÎback
 = -1;

203 
	`fÜ_—ch_sk
(
p
) {

204 ià(
p
->
£ssiÚ
 <= 0)

206 ià(
p
->
pg½
 ==…grp)

207  
p
->
£ssiÚ
;

208 ià(
p
->
pid
 =ğ
pg½
)

209 
çÎback
 = 
p
->
£ssiÚ
;

211  
çÎback
;

212 
	}
}

218 
	$kl_pg
(
pg½
, 
sig
, 
´iv
)

220 
sk_¡ruù
 *
p
;

221 
”r
,
»tv®
 = -
ESRCH
;

222 
found
 = 0;

224 ià(
sig
<0 || sig>32 || 
pg½
<=0)

225  -
EINVAL
;

226 
	`fÜ_—ch_sk
(
p
) {

227 ià(
p
->
pg½
 ==…grp) {

228 ià((
”r
 = 
	`£nd_sig
(
sig
,
p
,
´iv
)) != 0)

229 
»tv®
 = 
”r
;

231 
found
++;

234 (
found
 ? 0 : 
»tv®
);

235 
	}
}

242 
	$kl_¦
(
£ss
, 
sig
, 
´iv
)

244 
sk_¡ruù
 *
p
;

245 
”r
,
»tv®
 = -
ESRCH
;

246 
found
 = 0;

248 ià(
sig
<0 || sig>32 || 
£ss
<=0)

249  -
EINVAL
;

250 
	`fÜ_—ch_sk
(
p
) {

251 ià(
p
->
£ssiÚ
 =ğ
£ss
 &&…->
Ëad”
) {

252 ià((
”r
 = 
	`£nd_sig
(
sig
,
p
,
´iv
)) != 0)

253 
»tv®
 = 
”r
;

255 
found
++;

258 (
found
 ? 0 : 
»tv®
);

259 
	}
}

261 
	$kl_´oc
(
pid
, 
sig
, 
´iv
)

263 
sk_¡ruù
 *
p
;

265 ià(
sig
<0 || sig>32)

266  -
EINVAL
;

267 
	`fÜ_—ch_sk
(
p
) {

268 ià(
p
 &&…->
pid
 ==…id)

269  
	`£nd_sig
(
sig
,
p
,
´iv
);

271 (-
ESRCH
);

272 
	}
}

278 
asmlškage
 
	$sys_kl
(
pid
,
sig
)

280 
”r
, 
»tv®
 = 0, 
couÁ
 = 0;

282 ià(!
pid
)

283 (
	`kl_pg
(
cu¼’t
->
pg½
,
sig
,0));

284 ià(
pid
 == -1) {

285 
sk_¡ruù
 * 
p
;

286 
	`fÜ_—ch_sk
(
p
) {

287 ià(
p
->
pid
 > 1 &&… !ğ
cu¼’t
) {

288 ++
couÁ
;

289 ià((
”r
 = 
	`£nd_sig
(
sig
,
p
,0)è!ğ-
EPERM
)

290 
»tv®
 = 
”r
;

293 (
couÁ
 ? 
»tv®
 : -
ESRCH
);

295 ià(
pid
 < 0)

296 (
	`kl_pg
(-
pid
,
sig
,0));

298 (
	`kl_´oc
(
pid
,
sig
,0));

299 
	}
}

309 
	$is_Üphªed_pg½
(
pg½
)

311 
sk_¡ruù
 *
p
;

313 
	`fÜ_—ch_sk
(
p
) {

314 ià((
p
->
pg½
 !=…grp) ||

315 (
p
->
¡©e
 =ğ
TASK_ZOMBIE
) ||

316 (
p
->
p_µŒ
->
pid
 == 1))

318 ià((
p
->
p_µŒ
->
pg½
 !=…grp) &&

319 (
p
->
p_µŒ
->
£ssiÚ
 ==…->session))

323 
	}
}

325 
	$has_¡İ³d_jobs
(
pg½
)

327 
sk_¡ruù
 * 
p
;

329 
	`fÜ_—ch_sk
(
p
) {

330 ià(
p
->
pg½
 !=…grp)

332 ià(
p
->
¡©e
 =ğ
TASK_STOPPED
)

336 
	}
}

338 
	$fÜg‘_Üigš®_·»Á
(
sk_¡ruù
 * 
çth”
)

340 
sk_¡ruù
 * 
p
;

342 
	`fÜ_—ch_sk
(
p
) {

343 ià(
p
->
p_İ±r
 =ğ
çth”
)

344 ià(
sk
[1])

345 
p
->
p_İ±r
 = 
sk
[1];

347 
p
->
p_İ±r
 = 
sk
[0];

349 
	}
}

351 
NORET_TYPE
 
	$do_ex™
(
code
)

353 
sk_¡ruù
 *
p
;

354 
i
;

356 
çke_vŞ©e
:

357 ià(
cu¼’t
->
£mun
)

358 
	`£m_ex™
();

359 ià(
cu¼’t
->
shm
)

360 
	`shm_ex™
();

361 
	`ä“_·ge_bËs
(
cu¼’t
);

362 
i
=0 ; i<
NR_OPEN
 ; i++)

363 ià(
cu¼’t
->
fp
[
i
])

364 
	`sys_şo£
(
i
);

365 
	`fÜg‘_Üigš®_·»Á
(
cu¼’t
);

366 
	`ut
(
cu¼’t
->
pwd
);

367 
cu¼’t
->
pwd
 = 
NULL
;

368 
	`ut
(
cu¼’t
->
roÙ
);

369 
cu¼’t
->
roÙ
 = 
NULL
;

370 
	`ut
(
cu¼’t
->
execubË
);

371 
cu¼’t
->
execubË
 = 
NULL
;

375 
vm_¬—_¡ruù
 * 
m²t
, *
m²t1
;

376 
m²t
 = 
cu¼’t
->
mm­
;

377 
cu¼’t
->
mm­
 = 
NULL
;

378 
m²t
) {

379 
m²t1
 = 
m²t
->
vm_Ãxt
;

380 ià(
m²t
->
vm_İs
 && m²t->vm_İs->
şo£
)

381 
m²t
->
vm_İs
->
	`şo£
(mpnt);

382 
	`kä“
(
m²t
);

383 
m²t
 = 
m²t1
;

387 ià(
cu¼’t
->
ldt
) {

388 
	`vä“
(
cu¼’t
->
ldt
);

389 
cu¼’t
->
ldt
 = 
NULL
;

390 
i
=1 ; i<
NR_TASKS
 ; i++) {

391 ià(
sk
[
i
] =ğ
cu¼’t
) {

392 
	`£t_ldt_desc
(
gdt
+(
i
<<1)+
FIRST_LDT_ENTRY
, &
deçuÉ_ldt
, 1);

393 
	`lßd_ldt
(
i
);

398 
cu¼’t
->
¡©e
 = 
TASK_ZOMBIE
;

399 
cu¼’t
->
ex™_code
 = 
code
;

400 
cu¼’t
->
rss
 = 0;

410 ià((
cu¼’t
->
p_µŒ
->
pg½
 != current->pgrp) &&

411 (
cu¼’t
->
p_µŒ
->
£ssiÚ
 == current->session) &&

412 
	`is_Üphªed_pg½
(
cu¼’t
->
pg½
) &&

413 
	`has_¡İ³d_jobs
(
cu¼’t
->
pg½
)) {

414 
	`kl_pg
(
cu¼’t
->
pg½
,
SIGHUP
,1);

415 
	`kl_pg
(
cu¼’t
->
pg½
,
SIGCONT
,1);

418 
	`nÙify_·»Á
(
cu¼’t
);

428 (
p
 = 
cu¼’t
->
p_ıŒ
è!ğ
NULL
) {

429 
cu¼’t
->
p_ıŒ
 = 
p
->
p_o¥Œ
;

430 
p
->
p_y¥Œ
 = 
NULL
;

431 
p
->
æags
 &ğ~(
PF_PTRACED
|
PF_TRACESYS
);

432 ià(
sk
[1] &&ask[1] !ğ
cu¼’t
)

433 
p
->
p_µŒ
 = 
sk
[1];

435 
p
->
p_µŒ
 = 
sk
[0];

436 
p
->
p_o¥Œ
 =…->
p_µŒ
->
p_ıŒ
;

437 
p
->
p_o¥Œ
->
p_y¥Œ
 =…;

438 
p
->
p_µŒ
->
p_ıŒ
 =…;

439 ià(
p
->
¡©e
 =ğ
TASK_ZOMBIE
)

440 
	`nÙify_·»Á
(
p
);

447 ià((
p
->
pg½
 !ğ
cu¼’t
->pgrp) &&

448 (
p
->
£ssiÚ
 =ğ
cu¼’t
->session) &&

449 
	`is_Üphªed_pg½
(
p
->
pg½
) &&

450 
	`has_¡İ³d_jobs
(
p
->
pg½
)) {

451 
	`kl_pg
(
p
->
pg½
,
SIGHUP
,1);

452 
	`kl_pg
(
p
->
pg½
,
SIGCONT
,1);

455 ià(
cu¼’t
->
Ëad”
)

456 
	`di§ssocŸ‹_ùty
(1);

457 ià(
Ï¡_sk_u£d_m©h
 =ğ
cu¼’t
)

458 
Ï¡_sk_u£d_m©h
 = 
NULL
;

459 #ifdeà
DEBUG_PROC_TREE


460 
	`aud™_±»e
();

462 
	`scheduË
();

476 
çke_vŞ©e
;

477 
	}
}

479 
asmlškage
 
	$sys_ex™
(
”rÜ_code
)

481 
	`do_ex™
((
”rÜ_code
&0xff)<<8);

482 
	}
}

484 
asmlškage
 
	$sys_wa™4
(
pid_t
 
pid
,* 
¡©_addr
, 
İtiÚs
, 
ru§ge
 * 
ru
)

486 
æag
, 
»tv®
;

487 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

488 
sk_¡ruù
 *
p
;

490 ià(
¡©_addr
) {

491 
æag
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
¡©_addr
, 4);

492 ià(
æag
)

493  
æag
;

495 
	`add_wa™_queue
(&
cu¼’t
->
wa™_chldex™
,&
wa™
);

496 
»³©
:

497 
æag
=0;

498 
p
 = 
cu¼’t
->
p_ıŒ
 ;… ;… =…->
p_o¥Œ
) {

499 ià(
pid
>0) {

500 ià(
p
->
pid
 !=…id)

502 } ià(!
pid
) {

503 ià(
p
->
pg½
 !ğ
cu¼’t
->pgrp)

505 } ià(
pid
 != -1) {

506 ià(
p
->
pg½
 !ğ-
pid
)

510 ià((
p
->
ex™_sigÇl
 !ğ
SIGCHLD
è^ ((
İtiÚs
 & 
__WCLONE
) != 0))

512 
æag
 = 1;

513 
p
->
¡©e
) {

514 
TASK_STOPPED
:

515 ià(!
p
->
ex™_code
)

517 ià(!(
İtiÚs
 & 
WUNTRACED
è&& !(
p
->
æags
 & 
PF_PTRACED
))

519 ià(
¡©_addr
)

520 
	`put_fs_lÚg
((
p
->
ex™_code
 << 8) | 0x7f,

521 
¡©_addr
);

522 
p
->
ex™_code
 = 0;

523 ià(
ru
 !ğ
NULL
)

524 
	`g‘ru§ge
(
p
, 
RUSAGE_BOTH
, 
ru
);

525 
»tv®
 = 
p
->
pid
;

526 
’d_wa™4
;

527 
TASK_ZOMBIE
:

528 
cu¼’t
->
cutime
 +ğ
p
->
utime
 +…->cutime;

529 
cu¼’t
->
c¡ime
 +ğ
p
->
¡ime
 +…->cstime;

530 
cu¼’t
->
cmš_æt
 +ğ
p
->
mš_æt
 +…->cmin_flt;

531 
cu¼’t
->
cmaj_æt
 +ğ
p
->
maj_æt
 +…->cmaj_flt;

532 ià(
ru
 !ğ
NULL
)

533 
	`g‘ru§ge
(
p
, 
RUSAGE_BOTH
, 
ru
);

534 
æag
 = 
p
->
pid
;

535 ià(
¡©_addr
)

536 
	`put_fs_lÚg
(
p
->
ex™_code
, 
¡©_addr
);

537 ià(
p
->
p_İ±r
 !ğp->
p_µŒ
) {

538 
	`REMOVE_LINKS
(
p
);

539 
p
->
p_µŒ
 =…->
p_İ±r
;

540 
	`SET_LINKS
(
p
);

541 
	`nÙify_·»Á
(
p
);

543 
	`»Ëa£
(
p
);

544 #ifdeà
DEBUG_PROC_TREE


545 
	`aud™_±»e
();

547 
»tv®
 = 
æag
;

548 
’d_wa™4
;

553 ià(
æag
) {

554 
»tv®
 = 0;

555 ià(
İtiÚs
 & 
WNOHANG
)

556 
’d_wa™4
;

557 
cu¼’t
->
¡©e
=
TASK_INTERRUPTIBLE
;

558 
	`scheduË
();

559 
cu¼’t
->
sigÇl
 &ğ~(1<<(
SIGCHLD
-1));

560 
»tv®
 = -
ERESTARTSYS
;

561 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

562 
’d_wa™4
;

563 
»³©
;

565 
»tv®
 = -
ECHILD
;

566 
’d_wa™4
:

567 
	`»move_wa™_queue
(&
cu¼’t
->
wa™_chldex™
,&
wa™
);

568  
»tv®
;

569 
	}
}

575 
asmlškage
 
	$sys_wa™pid
(
pid_t
 
pid
,* 
¡©_addr
, 
İtiÚs
)

577  
	`sys_wa™4
(
pid
, 
¡©_addr
, 
İtiÚs
, 
NULL
);

578 
	}
}

	@kernel/fork.c

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/sched.h
>

16 
	~<lšux/k”Ãl.h
>

17 
	~<lšux/mm.h
>

18 
	~<lšux/¡ddef.h
>

19 
	~<lšux/uni¡d.h
>

20 
	~<lšux/£gm’t.h
>

21 
	~<lšux/±¿û.h
>

22 
	~<lšux/m®loc.h
>

23 
	~<lšux/ldt.h
>

25 
	~<asm/£gm’t.h
>

26 
	~<asm/sy¡em.h
>

28 
asmlškage
 
	$»t_äom_sys_ÿÎ
(è
	`__asm__
("ret_from_sys_call");

32 
	#MAX_TASKS_PER_USER
 (
NR_TASKS
/2)

	)

33 
	#MIN_TASKS_LEFT_FOR_ROOT
 4

	)

35 
	`shm_fÜk
(
sk_¡ruù
 *, task_struct *);

36 
Ï¡_pid
=0;

38 
	$fšd_em±y_´oûss
()

40 
ä“_sk
;

41 
i
, 
sks_ä“
;

42 
this_u£r_sks
;

44 
»³©
:

45 ià((++
Ï¡_pid
) & 0xffff8000)

46 
Ï¡_pid
=1;

47 
this_u£r_sks
 = 0;

48 
sks_ä“
 = 0;

49 
ä“_sk
 = -
EAGAIN
;

50 
i
 = 
NR_TASKS
;

51 --
i
 > 0) {

52 ià(!
sk
[
i
]) {

53 
ä“_sk
 = 
i
;

54 
sks_ä“
++;

57 ià(
sk
[
i
]->
uid
 =ğ
cu¼’t
->uid)

58 
this_u£r_sks
++;

59 ià(
sk
[
i
]->
pid
 =ğ
Ï¡_pid
 ||ask[i]->
pg½
 ==†ast_pid ||

60 
sk
[
i
]->
£ssiÚ
 =ğ
Ï¡_pid
)

61 
»³©
;

63 ià(
sks_ä“
 <ğ
MIN_TASKS_LEFT_FOR_ROOT
 ||

64 
this_u£r_sks
 > 
MAX_TASKS_PER_USER
)

65 ià(
cu¼’t
->
uid
)

66  -
EAGAIN
;

67  
ä“_sk
;

68 
	}
}

70 
fe
 * 
	$cİy_fd
(
fe
 * 
Şd_fe
)

72 
fe
 * 
Ãw_fe
 = 
	`g‘_em±y_fp
();

73 
”rÜ
;

75 ià(
Ãw_fe
) {

76 
	`memıy
(
Ãw_fe
,
Şd_fe
,(
fe
));

77 
Ãw_fe
->
f_couÁ
 = 1;

78 ià(
Ãw_fe
->
f_šode
)

79 
Ãw_fe
->
f_šode
->
i_couÁ
++;

80 ià(
Ãw_fe
->
f_İ
 &&‚ew_fe->f_İ->
İ’
) {

81 
”rÜ
 = 
Ãw_fe
->
f_İ
->
	`İ’
Òew_fe->
f_šode
,new_file);

82 ià(
”rÜ
) {

83 
	`ut
(
Ãw_fe
->
f_šode
);

84 
Ãw_fe
->
f_couÁ
 = 0;

85 
Ãw_fe
 = 
NULL
;

89  
Ãw_fe
;

90 
	}
}

92 
	$dup_mm­
(
sk_¡ruù
 * 
tsk
)

94 
vm_¬—_¡ruù
 * 
m²t
, **
p
, *
tmp
;

96 
tsk
->
mm­
 = 
NULL
;

97 
tsk
->
¡k_vma
 = 
NULL
;

98 
p
 = &
tsk
->
mm­
;

99 
m²t
 = 
cu¼’t
->
mm­
 ; m²ˆ; m²ˆğm²t->
vm_Ãxt
) {

100 
tmp
 = (
vm_¬—_¡ruù
 *è
	`km®loc
((vm_¬—_¡ruù), 
GFP_KERNEL
);

101 ià(!
tmp
)

102  -
ENOMEM
;

103 *
tmp
 = *
m²t
;

104 
tmp
->
vm_sk
 = 
tsk
;

105 
tmp
->
vm_Ãxt
 = 
NULL
;

106 ià(
tmp
->
vm_šode
)

107 
tmp
->
vm_šode
->
i_couÁ
++;

108 *
p
 = 
tmp
;

109 
p
 = &
tmp
->
vm_Ãxt
;

110 ià(
cu¼’t
->
¡k_vma
 =ğ
m²t
)

111 
tsk
->
¡k_vma
 = 
tmp
;

114 
	}
}

116 
	#IS_CLONE
 (
»gs
.
Üig_—x
 =ğ
__NR_şÚe
)

	)

117 
	#cİy_vm
(
p
è((
şÚe_æags
 & 
COPYVM
)?
	`cİy_·ge_bËs
Õ):
	`şÚe_·ge_bËs
Õ))

	)

124 
asmlškage
 
	$sys_fÜk
(
±_»gs
 
»gs
)

126 
±_»gs
 * 
chd»gs
;

127 
sk_¡ruù
 *
p
;

128 
i
,
Ä
;

129 
fe
 *
f
;

130 
şÚe_æags
 = 
COPYVM
 | 
SIGCHLD
;

132 if(!(
p
 = (
sk_¡ruù
*)
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

133 
bad_fÜk
;

134 
Ä
 = 
	`fšd_em±y_´oûss
();

135 ià(
Ä
 < 0)

136 
bad_fÜk_ä“
;

137 
sk
[
Ä
] = 
p
;

138 *
p
 = *
cu¼’t
;

139 
p
->
did_exec
 = 0;

140 
p
->
k”Ãl_¡ack_·ge
 = 0;

141 
p
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

142 
p
->
æags
 &ğ~(
PF_PTRACED
|
PF_TRACESYS
);

143 
p
->
pid
 = 
Ï¡_pid
;

144 
p
->
sw­·bË
 = 1;

145 
p
->
p_µŒ
 =…->
p_İ±r
 = 
cu¼’t
;

146 
p
->
p_ıŒ
 = 
NULL
;

147 
	`SET_LINKS
(
p
);

148 
p
->
sigÇl
 = 0;

149 
p
->
™_»®_v®ue
 =…->
™_vœt_v®ue
 =…->
™_´of_v®ue
 = 0;

150 
p
->
™_»®_šü
 =…->
™_vœt_šü
 =…->
™_´of_šü
 = 0;

151 
p
->
Ëad”
 = 0;

152 
p
->
utime
 =…->
¡ime
 = 0;

153 
p
->
cutime
 =…->
c¡ime
 = 0;

154 
p
->
mš_æt
 =…->
maj_æt
 = 0;

155 
p
->
cmš_æt
 =…->
cmaj_æt
 = 0;

156 
p
->
¡¬t_time
 = 
jiff›s
;

160 ià(!(
p
->
k”Ãl_¡ack_·ge
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

161 
bad_fÜk_ş—nup
;

162 
p
->
tss
.
es
 = 
KERNEL_DS
;

163 
p
->
tss
.
cs
 = 
KERNEL_CS
;

164 
p
->
tss
.
ss
 = 
KERNEL_DS
;

165 
p
->
tss
.
ds
 = 
KERNEL_DS
;

166 
p
->
tss
.
fs
 = 
USER_DS
;

167 
p
->
tss
.
gs
 = 
KERNEL_DS
;

168 
p
->
tss
.
ss0
 = 
KERNEL_DS
;

169 
p
->
tss
.
e¥0
 =…->
k”Ãl_¡ack_·ge
 + 
PAGE_SIZE
;

170 
p
->
tss
.
Œ
 = 
	`_TSS
(
Ä
);

171 
chd»gs
 = ((
±_»gs
 *è(
p
->
k”Ãl_¡ack_·ge
 + 
PAGE_SIZE
)) - 1;

172 
p
->
tss
.
e¥
 = (è
chd»gs
;

173 
p
->
tss
.
e
 = (è
»t_äom_sys_ÿÎ
;

174 *
chd»gs
 = 
»gs
;

175 
chd»gs
->
—x
 = 0;

176 
p
->
tss
.
back_lšk
 = 0;

177 
p
->
tss
.
eæags
 = 
»gs
.eflags & 0xffffcfff;

178 ià(
IS_CLONE
) {

179 ià(
»gs
.
ebx
)

180 
chd»gs
->
e¥
 = 
»gs
.
ebx
;

181 
şÚe_æags
 = 
»gs
.
ecx
;

182 ià(
chd»gs
->
e¥
 =ğ
»gs
.esp)

183 
şÚe_æags
 |ğ
COPYVM
;

185 
p
->
ex™_sigÇl
 = 
şÚe_æags
 & 
CSIGNAL
;

186 
p
->
tss
.
ldt
 = 
	`_LDT
(
Ä
);

187 ià(
p
->
ldt
) {

188 
p
->
ldt
 = (
desc_¡ruù
*è
	`vm®loc
(
LDT_ENTRIES
*
LDT_ENTRY_SIZE
);

189 ià(
p
->
ldt
 !ğ
NULL
)

190 
	`memıy
(
p
->
ldt
, 
cu¼’t
->ldt, 
LDT_ENTRIES
*
LDT_ENTRY_SIZE
);

192 
p
->
tss
.
b™m­
 = 
	`off£tof
(
tss_¡ruù
,
io_b™m­
);

193 
i
 = 0; i < 
IO_BITMAP_SIZE
+1 ; i++)

194 
p
->
tss
.
io_b™m­
[
i
] = ~0;

195 ià(
Ï¡_sk_u£d_m©h
 =ğ
cu¼’t
)

196 
	`__asm__
("şt ; fn§v%0 ; fr¡Ü %0":"=m" (
p
->
tss
.
i387
));

197 
p
->
£mun
 = 
NULL
;…->
shm
 = NULL;

198 ià(
	`cİy_vm
(
p
è|| 
	`shm_fÜk
(
cu¼’t
,…))

199 
bad_fÜk_ş—nup
;

200 ià(
şÚe_æags
 & 
COPYFD
) {

201 
i
=0; i<
NR_OPEN
;i++)

202 ià((
f
 = 
p
->
fp
[
i
]è!ğ
NULL
)

203 
p
->
fp
[
i
] = 
	`cİy_fd
(
f
);

205 
i
=0; i<
NR_OPEN
;i++)

206 ià((
f
 = 
p
->
fp
[
i
]è!ğ
NULL
)

207 
f
->
f_couÁ
++;

209 ià(
cu¼’t
->
pwd
)

210 
cu¼’t
->
pwd
->
i_couÁ
++;

211 ià(
cu¼’t
->
roÙ
)

212 
cu¼’t
->
roÙ
->
i_couÁ
++;

213 ià(
cu¼’t
->
execubË
)

214 
cu¼’t
->
execubË
->
i_couÁ
++;

215 
	`dup_mm­
(
p
);

216 
	`£t_tss_desc
(
gdt
+(
Ä
<<1)+
FIRST_TSS_ENTRY
,&(
p
->
tss
));

217 ià(
p
->
ldt
)

218 
	`£t_ldt_desc
(
gdt
+(
Ä
<<1)+
FIRST_LDT_ENTRY
,
p
->
ldt
, 512);

220 
	`£t_ldt_desc
(
gdt
+(
Ä
<<1)+
FIRST_LDT_ENTRY
,&
deçuÉ_ldt
, 1);

222 
p
->
couÁ”
 = 
cu¼’t
->counter >> 1;

223 
p
->
¡©e
 = 
TASK_RUNNING
;

224  
p
->
pid
;

225 
bad_fÜk_ş—nup
:

226 
sk
[
Ä
] = 
NULL
;

227 
	`REMOVE_LINKS
(
p
);

228 
	`ä“_·ge
(
p
->
k”Ãl_¡ack_·ge
);

229 
bad_fÜk_ä“
:

230 
	`ä“_·ge
((è
p
);

231 
bad_fÜk
:

232  -
EAGAIN
;

233 
	}
}

	@kernel/info.c

9 
	~<asm/£gm’t.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/¡ršg.h
>

13 
	~<lšux/uni¡d.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/mm.h
>

17 
asmlškage
 
	$sys_sysšfo
(
sysšfo
 *
šfo
)

19 
”rÜ
;

20 
sysšfo
 
v®
;

21 
sk_¡ruù
 **
p
;

23 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
šfo
, (
sysšfo
));

24 ià(
”rÜ
)

25  
”rÜ
;

26 
	`mem£t
((*)&
v®
, 0, (
sysšfo
));

28 
v®
.
u±ime
 = 
jiff›s
 / 
HZ
;

30 
v®
.
lßds
[0] = 
av’run
[0] << (
SI_LOAD_SHIFT
 - 
FSHIFT
);

31 
v®
.
lßds
[1] = 
av’run
[1] << (
SI_LOAD_SHIFT
 - 
FSHIFT
);

32 
v®
.
lßds
[2] = 
av’run
[2] << (
SI_LOAD_SHIFT
 - 
FSHIFT
);

34 
p
 = &
LAST_TASK
;… > &
FIRST_TASK
;…--)

35 ià(*
p
è
v®
.
´ocs
++;

37 
	`si_memšfo
(&
v®
);

38 
	`si_sw­šfo
(&
v®
);

40 
	`memıy_tofs
(
šfo
, &
v®
, (
sysšfo
));

42 
	}
}

	@kernel/ioport.c

8 
	~<lšux/sched.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/iİÜt.h
>

14 
	giİÜt_»gi¡¿r
[
IO_BITMAP_SIZE
] = {0, };

16 
	#_IODEBUG


	)

18 #ifdeà
IODEBUG


19 * 
	$ios
(
l
)

21 
¡r
[33] = { '\0' };

22 
i
;

23 
mask
;

25 
i
 = 0, 
mask
 = 0x80000000; i < 32; ++i, mask >>= 1)

26 
¡r
[
i
] = (
l
 & 
mask
) ? '1' : '0';

27  
¡r
;

28 
	}
}

30 
	$dump_io_b™m­
()

32 
i
, 
j
;

33 
numl
 = (
cu¼’t
->
tss
.
io_b™m­
) >> 2;

35 
i
 = 
j
 = 0; j < 
numl
; ++i)

37 
	`´štk
("%4d [%3x]: ", 64*
i
, 64*i);

38 
	`´štk
("% ", 
	`ios
(
cu¼’t
->
tss
.
io_b™m­
[
j
++]));

39 ià(
j
 < 
numl
)

40 
	`´štk
("%s", 
	`ios
(
cu¼’t
->
tss
.
io_b™m­
[
j
++]));

41 
	`´štk
("\n");

43 
	}
}

47 
asmlškage
 
	$£t_b™m­
(*
b™m­
,

48 
ba£
, 
ex‹Á
, 
Ãw_v®ue
)

50 
mask
;

51 *
b™m­_ba£
 = 
b™m­
 + (
ba£
 >> 5);

52 
low_šdex
 = 
ba£
 & 0x1f;

53 
Ëngth
 = 
low_šdex
 + 
ex‹Á
;

55 ià(
low_šdex
 != 0) {

56 
mask
 = (~0 << 
low_šdex
);

57 ià(
Ëngth
 < 32)

58 
mask
 &ğ~(~0 << 
Ëngth
);

59 ià(
Ãw_v®ue
)

60 *
b™m­_ba£
++ |ğ
mask
;

62 *
b™m­_ba£
++ &ğ~
mask
;

63 
Ëngth
 -= 32;

66 
mask
 = (
Ãw_v®ue
 ? ~0 : 0);

67 
Ëngth
 >= 32) {

68 *
b™m­_ba£
++ = 
mask
;

69 
Ëngth
 -= 32;

72 ià(
Ëngth
 > 0) {

73 
mask
 = ~(~0 << 
Ëngth
);

74 ià(
Ãw_v®ue
)

75 *
b™m­_ba£
++ |ğ
mask
;

77 *
b™m­_ba£
++ &ğ~
mask
;

79 
	}
}

82 
asmlškage
 
	$check_b™m­
(*
b™m­
, 
ba£
, 
ex‹Á
)

84 
mask
;

85 *
b™m­_ba£
 = 
b™m­
 + (
ba£
 >> 5);

86 
low_šdex
 = 
ba£
 & 0x1f;

87 
Ëngth
 = 
low_šdex
 + 
ex‹Á
;

89 ià(
low_šdex
 != 0) {

90 
mask
 = (~0 << 
low_šdex
);

91 ià(
Ëngth
 < 32)

92 
mask
 &ğ~(~0 << 
Ëngth
);

93 ià(*
b™m­_ba£
++ & 
mask
)

95 
Ëngth
 -= 32;

97 
Ëngth
 >= 32) {

98 ià(*
b™m­_ba£
++ != 0)

100 
Ëngth
 -= 32;

103 ià(
Ëngth
 > 0) {

104 
mask
 = ~(~0 << 
Ëngth
);

105 ià(*
b™m­_ba£
++ & 
mask
)

109 
	}
}

114 
asmlškage
 
	$sys_iİ”m
(
äom
, 
num
, 
tuº_Ú
)

116 ià(
äom
 + 
num
 <= from)

117  -
EINVAL
;

118 ià(
äom
 + 
num
 > 
IO_BITMAP_SIZE
*32)

119  -
EINVAL
;

120 ià(!
	`su£r
())

121  -
EPERM
;

123 #ifdeà
IODEBUG


124 
	`´štk
("io: from=%d‚um=%d %s\n", 
äom
, 
num
, (
tuº_Ú
 ? "on" : "off"));

126 
	`£t_b™m­
((*)
cu¼’t
->
tss
.
io_b™m­
, 
äom
, 
num
, !
tuº_Ú
);

128 
	}
}

130 *
	g¡ack
;

142 
asmlškage
 
	$sys_iİl
(
ebx
,
ecx
,
edx
,

143 
esi
, 
edi
, 
ebp
, 
—x
, 
ds
,

144 
es
, 
fs
, 
gs
, 
Üig_—x
,

145 
e
,
cs
,
eæags
,
e¥
,
ss
)

147 
Ëv–
 = 
ebx
;

149 ià(
Ëv–
 > 3)

150  -
EINVAL
;

151 ià(!
	`su£r
())

152  -
EPERM
;

153 *(&
eæags
èğÓæag & 0xffffcfffè| (
Ëv–
 << 12);

155 
	}
}

158 
	$¢¬f_»giÚ
(
äom
, 
num
)

160 ià(
äom
 > 
IO_BITMAP_SIZE
*32)

162 ià(
äom
 + 
num
 > 
IO_BITMAP_SIZE
*32)

163 
num
 = 
IO_BITMAP_SIZE
*32 - 
äom
;

164 
	`£t_b™m­
(
iİÜt_»gi¡¿r
, 
äom
, 
num
, 1);

166 
	}
}

168 
	$check_»giÚ
(
äom
, 
num
)

170 ià(
äom
 > 
IO_BITMAP_SIZE
*32)

172 ià(
äom
 + 
num
 > 
IO_BITMAP_SIZE
*32)

173 
num
 = 
IO_BITMAP_SIZE
*32 - 
äom
;

174  
	`check_b™m­
(
iİÜt_»gi¡¿r
, 
äom
, 
num
);

175 
	}
}

178 
	$»£rve_£tup
(*
¡r
, *
šts
)

180 
i
;

182 
i
 = 1; i < 
šts
[0]; i += 2)

183 
	`¢¬f_»giÚ
(
šts
[
i
], ints[i+1]);

184 
	}
}

	@kernel/irq.c

25 
	~<lšux/±¿û.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/k”Ãl_¡©.h
>

28 
	~<lšux/sigÇl.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/š‹¼u±.h
>

32 
	~<asm/sy¡em.h
>

33 
	~<asm/io.h
>

34 
	~<asm/œq.h
>

36 
	#CR0_NE
 32

	)

38 
	gÿche_21
 = 0xff;

39 
	gÿche_A1
 = 0xff;

41 
	gšŒ_couÁ
 = 0;

42 
	gbh_aùive
 = 0;

43 
	gbh_mask
 = 0xFFFFFFFF;

44 
bh_¡ruù
 
	gbh_ba£
[32];

46 
	$di§bË_œq
(
œq_Ä
)

48 
æags
;

49 
mask
;

51 
mask
 = 1 << (
œq_Ä
 & 7);

52 
	`§ve_æags
(
æags
);

53 ià(
œq_Ä
 < 8) {

54 
	`şi
();

55 
ÿche_21
 |ğ
mask
;

56 
	`outb
(
ÿche_21
,0x21);

57 
	`»¡Üe_æags
(
æags
);

60 
	`şi
();

61 
ÿche_A1
 |ğ
mask
;

62 
	`outb
(
ÿche_A1
,0xA1);

63 
	`»¡Üe_æags
(
æags
);

64 
	}
}

66 
	$’abË_œq
(
œq_Ä
)

68 
æags
;

69 
mask
;

71 
mask
 = ~(1 << (
œq_Ä
 & 7));

72 
	`§ve_æags
(
æags
);

73 ià(
œq_Ä
 < 8) {

74 
	`şi
();

75 
ÿche_21
 &ğ
mask
;

76 
	`outb
(
ÿche_21
,0x21);

77 
	`»¡Üe_æags
(
æags
);

80 
	`şi
();

81 
ÿche_A1
 &ğ
mask
;

82 
	`outb
(
ÿche_A1
,0xA1);

83 
	`»¡Üe_æags
(
æags
);

84 
	}
}

91 
asmlškage
 
	$do_bÙtom_h®f
()

93 
aùive
;

94 
mask
, 
Ëá
;

95 
bh_¡ruù
 *
bh
;

97 
bh
 = 
bh_ba£
;

98 
aùive
 = 
bh_aùive
 & 
bh_mask
;

99 
mask
 = 1, 
Ëá
 = ~0 ;†eá & 
aùive
 ; 
bh
++,mask += mask,left +=†eft) {

100 ià(
mask
 & 
aùive
) {

101 (*
â
)(*);

102 
bh_aùive
 &ğ~
mask
;

103 
â
 = 
bh
->
routše
;

104 ià(!
â
)

105 
bad_bh
;

106 
	`â
(
bh
->
d©a
);

110 
bad_bh
:

111 
	`´štk
 ("irq.c:bad bottom halfƒntry\n");

112 
	}
}

129 
	$BUILD_IRQ
(
FIRST
,0,0x01)

130 
	$BUILD_IRQ
(
FIRST
,1,0x02)

131 
	$BUILD_IRQ
(
FIRST
,2,0x04)

132 
	$BUILD_IRQ
(
FIRST
,3,0x08)

133 
	$BUILD_IRQ
(
FIRST
,4,0x10)

134 
	$BUILD_IRQ
(
FIRST
,5,0x20)

135 
	$BUILD_IRQ
(
FIRST
,6,0x40)

136 
	$BUILD_IRQ
(
FIRST
,7,0x80)

137 
	$BUILD_IRQ
(
SECOND
,8,0x01)

138 
	$BUILD_IRQ
(
SECOND
,9,0x02)

139 
	$BUILD_IRQ
(
SECOND
,10,0x04)

140 
	$BUILD_IRQ
(
SECOND
,11,0x08)

141 
	$BUILD_IRQ
(
SECOND
,12,0x10)

142 
	$BUILD_IRQ
(
SECOND
,13,0x20)

143 
	$BUILD_IRQ
(
SECOND
,14,0x40)

144 
	$BUILD_IRQ
(
SECOND
,15,0x80)

150 (*
š‹¼u±
[16])() = {

151 
IRQ0_š‹¼u±
, 
IRQ1_š‹¼u±
, 
IRQ2_š‹¼u±
, 
IRQ3_š‹¼u±
,

152 
IRQ4_š‹¼u±
, 
IRQ5_š‹¼u±
, 
IRQ6_š‹¼u±
, 
IRQ7_š‹¼u±
,

153 
IRQ8_š‹¼u±
, 
IRQ9_š‹¼u±
, 
IRQ10_š‹¼u±
, 
IRQ11_š‹¼u±
,

154 
IRQ12_š‹¼u±
, 
IRQ13_š‹¼u±
, 
IRQ14_š‹¼u±
, 
IRQ15_š‹¼u±


155 
	}
};

157 (*
ç¡_š‹¼u±
[16])() = {

158 
ç¡_IRQ0_š‹¼u±
, 
ç¡_IRQ1_š‹¼u±
,

159 
ç¡_IRQ2_š‹¼u±
, 
ç¡_IRQ3_š‹¼u±
,

160 
ç¡_IRQ4_š‹¼u±
, 
ç¡_IRQ5_š‹¼u±
,

161 
ç¡_IRQ6_š‹¼u±
, 
ç¡_IRQ7_š‹¼u±
,

162 
ç¡_IRQ8_š‹¼u±
, 
ç¡_IRQ9_š‹¼u±
,

163 
ç¡_IRQ10_š‹¼u±
, 
ç¡_IRQ11_š‹¼u±
,

164 
ç¡_IRQ12_š‹¼u±
, 
ç¡_IRQ13_š‹¼u±
,

165 
ç¡_IRQ14_š‹¼u±
, 
ç¡_IRQ15_š‹¼u±


166 
	}
};

168 (*
bad_š‹¼u±
[16])() = {

169 
bad_IRQ0_š‹¼u±
, 
bad_IRQ1_š‹¼u±
,

170 
bad_IRQ2_š‹¼u±
, 
bad_IRQ3_š‹¼u±
,

171 
bad_IRQ4_š‹¼u±
, 
bad_IRQ5_š‹¼u±
,

172 
bad_IRQ6_š‹¼u±
, 
bad_IRQ7_š‹¼u±
,

173 
bad_IRQ8_š‹¼u±
, 
bad_IRQ9_š‹¼u±
,

174 
bad_IRQ10_š‹¼u±
, 
bad_IRQ11_š‹¼u±
,

175 
bad_IRQ12_š‹¼u±
, 
bad_IRQ13_š‹¼u±
,

176 
bad_IRQ14_š‹¼u±
, 
bad_IRQ15_š‹¼u±


177 
	}
};

182 
sigaùiÚ
 
	gœq_sigaùiÚ
[16] = {

183 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

184 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

185 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

186 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

187 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

188 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

189 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL },

190 { 
NULL
, 0, 0, NULL }, { NULL, 0, 0, NULL }

200 
asmlškage
 
	$do_IRQ
(
œq
, 
±_»gs
 * 
»gs
)

202 
sigaùiÚ
 * 
§
 = 
œq
 + 
œq_sigaùiÚ
;

204 
k¡©
.
š‹¼u±s
++;

205 
§
->
	`§_hªdËr
((è
»gs
);

206 
	}
}

213 
asmlškage
 
	$do_ç¡_IRQ
(
œq
)

215 
sigaùiÚ
 * 
§
 = 
œq
 + 
œq_sigaùiÚ
;

217 
k¡©
.
š‹¼u±s
++;

218 
§
->
	`§_hªdËr
(
œq
);

219 
	}
}

221 
	$œqaùiÚ
(
œq
, 
sigaùiÚ
 * 
Ãw_§
)

223 
sigaùiÚ
 * 
§
;

224 
æags
;

226 ià(
œq
 > 15)

227  -
EINVAL
;

228 
§
 = 
œq
 + 
œq_sigaùiÚ
;

229 ià(
§
->
§_mask
)

230  -
EBUSY
;

231 ià(!
Ãw_§
->
§_hªdËr
)

232  -
EINVAL
;

233 
	`§ve_æags
(
æags
);

234 
	`şi
();

235 *
§
 = *
Ãw_§
;

236 
§
->
§_mask
 = 1;

237 ià(
§
->
§_æags
 & 
SA_INTERRUPT
)

238 
	`£t_šŒ_g©e
(0x20+
œq
,
ç¡_š‹¼u±
[irq]);

240 
	`£t_šŒ_g©e
(0x20+
œq
,
š‹¼u±
[irq]);

241 ià(
œq
 < 8) {

242 
ÿche_21
 &ğ~(1<<
œq
);

243 
	`outb
(
ÿche_21
,0x21);

245 
ÿche_21
 &= ~(1<<2);

246 
ÿche_A1
 &ğ~(1<<(
œq
-8));

247 
	`outb
(
ÿche_21
,0x21);

248 
	`outb
(
ÿche_A1
,0xA1);

250 
	`»¡Üe_æags
(
æags
);

252 
	}
}

254 
»que¡_œq
(
œq
, (*
hªdËr
)())

256 
sigaùiÚ
 
§
;

258 
§
.
§_hªdËr
 = 
hªdËr
;

259 
§
.
§_æags
 = 0;

260 
§
.
§_mask
 = 0;

261 
§
.
§_»¡Ü”
 = 
NULL
;

262  
	`œqaùiÚ
(
œq
,&
§
);

263 
	}
}

265 
	$ä“_œq
(
œq
)

267 
sigaùiÚ
 * 
§
 = 
œq
 + 
œq_sigaùiÚ
;

268 
æags
;

270 ià(
œq
 > 15) {

271 
	`´štk
("TryšgØä“ IRQ%d\n",
œq
);

274 ià(!
§
->
§_mask
) {

275 
	`´štk
("TryšgØä“ f»IRQ%d\n",
œq
);

278 
	`§ve_æags
(
æags
);

279 
	`şi
();

280 ià(
œq
 < 8) {

281 
ÿche_21
 |ğ1 << 
œq
;

282 
	`outb
(
ÿche_21
,0x21);

284 
ÿche_A1
 |ğ1 << (
œq
-8);

285 
	`outb
(
ÿche_A1
,0xA1);

287 
	`£t_šŒ_g©e
(0x20+
œq
,
bad_š‹¼u±
[irq]);

288 
§
->
§_hªdËr
 = 
NULL
;

289 
§
->
§_æags
 = 0;

290 
§
->
§_mask
 = 0;

291 
§
->
§_»¡Ü”
 = 
NULL
;

292 
	`»¡Üe_æags
(
æags
);

293 
	}
}

306 
	$m©h_”rÜ_œq
(
ıl
)

308 
	`outb
(0,0xF0);

309 ià(
ignÜe_œq13
)

311 
	`m©h_”rÜ
();

312 
	}
}

314 
	$no_aùiÚ
(
ıl
è{ 
	}
}

316 
sigaùiÚ
 
	gignÜe_IRQ
 = {

317 
no_aùiÚ
,

319 
SA_INTERRUPT
,

320 
NULL


323 
	$š™_IRQ
()

325 
i
;

327 
i
 = 0; i < 16 ; i++)

328 
	`£t_šŒ_g©e
(0x20+
i
,
bad_š‹¼u±
[i]);

329 ià(
	`œqaùiÚ
(2,&
ignÜe_IRQ
))

330 
	`´štk
("Unableo get IRQ2 for cascade\n");

331 ià(
	`»que¡_œq
(13,
m©h_”rÜ_œq
))

332 
	`´štk
("Unableo get IRQ13 for math-error handler\n");

335 
i
 = 0; i < 32; i++) {

336 
bh_ba£
[
i
].
routše
 = 
NULL
;

337 
bh_ba£
[
i
].
d©a
 = 
NULL
;

339 
bh_aùive
 = 0;

340 
šŒ_couÁ
 = 0;

341 
	}
}

	@kernel/itimer.c

9 
	~<lšux/sigÇl.h
>

10 
	~<lšux/sched.h
>

11 
	~<lšux/¡ršg.h
>

12 
	~<lšux/”ºo.h
>

13 
	~<lšux/time.h
>

15 
	~<asm/£gm’t.h
>

17 
	$tvtojiff›s
(
timev®
 *
v®ue
)

19 (()
v®ue
->
tv_£c
 * 
HZ
 +

20 ()(
v®ue
->
tv_u£c
 + (1000000 / 
HZ
 - 1)) /

21 (1000000 / 
HZ
));

22 
	}
}

24 
	$jiff›¡Ùv
(
jiff›s
, 
timev®
 *
v®ue
)

26 
v®ue
->
tv_u£c
 = (
jiff›s
 % 
HZ
) * (1000000 / HZ);

27 
v®ue
->
tv_£c
 = 
jiff›s
 / 
HZ
;

29 
	}
}

31 
	$_g‘™im”
(
which
, 
™im”v®
 *
v®ue
)

33 
v®
, 
š‹rv®
;

35 
which
) {

36 
ITIMER_REAL
:

37 
v®
 = 
cu¼’t
->
™_»®_v®ue
;

38 
š‹rv®
 = 
cu¼’t
->
™_»®_šü
;

40 
ITIMER_VIRTUAL
:

41 
v®
 = 
cu¼’t
->
™_vœt_v®ue
;

42 
š‹rv®
 = 
cu¼’t
->
™_vœt_šü
;

44 
ITIMER_PROF
:

45 
v®
 = 
cu¼’t
->
™_´of_v®ue
;

46 
š‹rv®
 = 
cu¼’t
->
™_´of_šü
;

49 (-
EINVAL
);

51 
	`jiff›¡Ùv
(
v®
, &
v®ue
->
™_v®ue
);

52 
	`jiff›¡Ùv
(
š‹rv®
, &
v®ue
->
™_š‹rv®
);

54 
	}
}

56 
asmlškage
 
	$sys_g‘™im”
(
which
, 
™im”v®
 *
v®ue
)

58 
”rÜ
;

59 
™im”v®
 
g‘_bufãr
;

61 ià(!
v®ue
)

62  -
EFAULT
;

63 
”rÜ
 = 
	`_g‘™im”
(
which
, &
g‘_bufãr
);

64 ià(
”rÜ
)

65  
”rÜ
;

66 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
v®ue
, (
™im”v®
));

67 ià(
”rÜ
)

68  
”rÜ
;

69 
	`memıy_tofs
(
v®ue
, &
g‘_bufãr
, (get_buffer));

71 
	}
}

73 
	$_£t™im”
(
which
, 
™im”v®
 *
v®ue
, ™im”v® *
ov®ue
)

75 
i
, 
j
;

76 
k
;

78 
i
 = 
	`tvtojiff›s
(&
v®ue
->
™_š‹rv®
);

79 
j
 = 
	`tvtojiff›s
(&
v®ue
->
™_v®ue
);

80 ià(
ov®ue
 && (
k
 = 
	`_g‘™im”
(
which
, ovalue)) < 0)

81  
k
;

82 
which
) {

83 
ITIMER_REAL
:

84 ià(
j
) {

85 
j
 +ğ1+
™im”_ticks
;

86 ià(
j
 < 
™im”_Ãxt
)

87 
™im”_Ãxt
 = 
j
;

89 
cu¼’t
->
™_»®_v®ue
 = 
j
;

90 
cu¼’t
->
™_»®_šü
 = 
i
;

92 
ITIMER_VIRTUAL
:

93 ià(
j
)

94 
j
++;

95 
cu¼’t
->
™_vœt_v®ue
 = 
j
;

96 
cu¼’t
->
™_vœt_šü
 = 
i
;

98 
ITIMER_PROF
:

99 ià(
j
)

100 
j
++;

101 
cu¼’t
->
™_´of_v®ue
 = 
j
;

102 
cu¼’t
->
™_´of_šü
 = 
i
;

105  -
EINVAL
;

108 
	}
}

110 
asmlškage
 
	$sys_£t™im”
(
which
, 
™im”v®
 *
v®ue
, ™im”v® *
ov®ue
)

112 
”rÜ
;

113 
™im”v®
 
£t_bufãr
, 
g‘_bufãr
;

115 ià(!
v®ue
)

116 
	`mem£t
((*è&
£t_bufãr
, 0, (set_buffer));

118 
	`memıy_äomfs
(&
£t_bufãr
, 
v®ue
, (set_buffer));

119 
”rÜ
 = 
	`_£t™im”
(
which
, &
£t_bufãr
, 
ov®ue
 ? &
g‘_bufãr
 : 0);

120 ià(
”rÜ
 || !
ov®ue
)

121  
”rÜ
;

122 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
ov®ue
, (
™im”v®
));

123 ià(!
”rÜ
)

124 
	`memıy_tofs
(
ov®ue
, &
g‘_bufãr
, (get_buffer));

125  
”rÜ
;

126 
	}
}

	@kernel/ldt.c

7 
	~<lšux/cÚfig.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/¡ršg.h
>

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

13 
	~<lšux/ldt.h
>

15 
	$»ad_ldt
(* 
±r
, 
by‹couÁ
)

17 
”rÜ
;

18 * 
add»ss
 = 
cu¼’t
->
ldt
;

19 
size
;

21 ià(!
±r
)

22  -
EINVAL
;

23 
size
 = 
LDT_ENTRIES
*
LDT_ENTRY_SIZE
;

24 ià(!
add»ss
) {

25 
add»ss
 = &
deçuÉ_ldt
;

26 
size
 = (
deçuÉ_ldt
);

28 ià(
size
 > 
by‹couÁ
)

29 
size
 = 
by‹couÁ
;

30 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
±r
, 
size
);

31 ià(
”rÜ
)

32  
”rÜ
;

33 
	`memıy_tofs
(
±r
, 
add»ss
, 
size
);

34  
size
;

35 
	}
}

37 
	$wr™e_ldt
(* 
±r
, 
by‹couÁ
)

39 
modify_ldt_ldt_s
 
ldt_šfo
;

40 *
Í
;

41 
ba£
, 
lim™
;

42 
”rÜ
, 
i
;

44 ià(
by‹couÁ
 !ğ(
ldt_šfo
))

45  -
EINVAL
;

46 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
±r
, (
ldt_šfo
));

47 ià(
”rÜ
)

48  
”rÜ
;

50 
	`memıy_äomfs
(&
ldt_šfo
, 
±r
, (ldt_info));

52 ià(
ldt_šfo
.
cÚ‹Ás
 =ğ3 ||†dt_šfo.
’Œy_numb”
 >ğ
LDT_ENTRIES
)

53  -
EINVAL
;

55 
lim™
 = 
ldt_šfo
.limit;

56 
ba£
 = 
ldt_šfo
.
ba£_addr
;

57 ià(
ldt_šfo
.
lim™_š_·ges
)

58 
lim™
 *ğ
PAGE_SIZE
;

60 
lim™
 +ğ
ba£
;

61 ià(
lim™
 < 
ba£
 ||†imit >= 0xC0000000)

62  -
EINVAL
;

64 ià(!
cu¼’t
->
ldt
) {

65 
i
=1 ; i<
NR_TASKS
 ; i++) {

66 ià(
sk
[
i
] =ğ
cu¼’t
) {

67 ià(!(
cu¼’t
->
ldt
 = (
desc_¡ruù
*è
	`vm®loc
(
LDT_ENTRIES
*
LDT_ENTRY_SIZE
)))

68  -
ENOMEM
;

69 
	`£t_ldt_desc
(
gdt
+(
i
<<1)+
FIRST_LDT_ENTRY
, 
cu¼’t
->
ldt
, 
LDT_ENTRIES
);

70 
	`lßd_ldt
(
i
);

75 
Í
 = (*è&
cu¼’t
->
ldt
[
ldt_šfo
.
’Œy_numb”
];

77 ià(
ldt_šfo
.
ba£_addr
 =ğ0 &&†dt_šfo.
lim™
 == 0) {

78 *
Í
 = 0;

79 *(
Í
+1) = 0;

82 *
Í
 = ((
ldt_šfo
.
ba£_addr
 & 0x0000ffff) << 16) |

83 (
ldt_šfo
.
lim™
 & 0x0ffff);

84 *(
Í
+1èğ(
ldt_šfo
.
ba£_addr
 & 0xff000000) |

85 ((
ldt_šfo
.
ba£_addr
 & 0x00ff0000)>>16) |

86 (
ldt_šfo
.
lim™
 & 0xf0000) |

87 (
ldt_šfo
.
cÚ‹Ás
 << 10) |

88 ((
ldt_šfo
.
»ad_exec_Úly
 ^ 1) << 9) |

89 (
ldt_šfo
.
£g_32b™
 << 22) |

90 (
ldt_šfo
.
lim™_š_·ges
 << 23) |

93 
	}
}

95 
asmlškage
 
	$sys_modify_ldt
(
func
, *
±r
, 
by‹couÁ
)

97 ià(
func
 == 0)

98  
	`»ad_ldt
(
±r
, 
by‹couÁ
);

99 ià(
func
 == 1)

100  
	`wr™e_ldt
(
±r
, 
by‹couÁ
);

101  -
ENOSYS
;

102 
	}
}

	@kernel/mktime.c

7 
	~<lšux/mktime.h
>

20 
	#MINUTE
 60

	)

21 
	#HOUR
 (60*
MINUTE
)

	)

22 
	#DAY
 (24*
HOUR
)

	)

23 
	#YEAR
 (365*
DAY
)

	)

26 
	gmÚth
[12] = {

28 
DAY
*(31),

29 
DAY
*(31+29),

30 
DAY
*(31+29+31),

31 
DAY
*(31+29+31+30),

32 
DAY
*(31+29+31+30+31),

33 
DAY
*(31+29+31+30+31+30),

34 
DAY
*(31+29+31+30+31+30+31),

35 
DAY
*(31+29+31+30+31+30+31+31),

36 
DAY
*(31+29+31+30+31+30+31+31+30),

37 
DAY
*(31+29+31+30+31+30+31+31+30+31),

38 
DAY
*(31+29+31+30+31+30+31+31+30+31+30)

41 
	$k”Ãl_mktime
(
mktime
 * 
time
)

43 
»s
;

44 
y—r
;

46 
y—r
 = 
time
->year - 70;

48 
»s
 = 
YEAR
*
y—r
 + 
DAY
*((year+1)/4);

49 
»s
 +ğ
mÚth
[
time
->
mÚ
];

51 ià(
time
->
mÚ
>1 && ((
y—r
+2)%4))

52 
»s
 -ğ
DAY
;

53 
»s
 +ğ
DAY
*(
time
->
day
-1);

54 
»s
 +ğ
HOUR
*
time
->
hour
;

55 
»s
 +ğ
MINUTE
*
time
->
mš
;

56 
»s
 +ğ
time
->
£c
;

57  
»s
;

58 
	}
}

	@kernel/module.c

1 
	~<lšux/”ºo.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<asm/£gm’t.h
>

4 
	~<lšux/mm.h
>

5 
	~<lšux/¡ršg.h
>

6 
	~<lšux/moduË.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/m®loc.h
>

10 
moduË
 *
	gmoduË_li¡
 = 
NULL
;

11 
	gä“šg_moduËs
;

13 
moduË
 *
fšd_moduË
ĞcÚ¡ *
Çme
);

14 
g‘_mod_Çme
Ğ*
u£r_Çme
, *
buf
);

15 
ä“_moduËs
( );

20 
asmlškage
 

21 
	$sys_ü—‹_moduË
(*
moduË_Çme
, 
size
)

23 
Åages
;

24 * 
addr
;

25 
Ën
;

26 
Çme
[
MOD_MAX_NAME
];

27 *
§v’ame
;

28 
moduË
 *
mp
;

29 
”rÜ
;

31 ià(!
	`su£r
())

32  -
EPERM
;

33 ià(
moduË_Çme
 =ğ
NULL
 || 
size
 == 0)

34  -
EINVAL
;

35 ià((
”rÜ
 = 
	`g‘_mod_Çme
(
moduË_Çme
, 
Çme
)) != 0)

36  
”rÜ
;

37 ià(
	`fšd_moduË
(
Çme
è!ğ
NULL
) {

38  -
EEXIST
;

40 
Ën
 = 
	`¡¾’
(
Çme
) + 1;

41 ià((
§v’ame
 = (*è
	`km®loc
(
Ën
, 
GFP_KERNEL
)è=ğ
NULL
)

42  -
ENOMEM
;

43 
	`memıy
(
§v’ame
, 
Çme
, 
Ën
);

44 ià((
mp
 = (
moduË
*è
	`km®loc
( *mp, 
GFP_KERNEL
)è=ğ
NULL
) {

45 
	`kä“
(
§v’ame
);

46  -
ENOMEM
;

48 
Åages
 = (
size
 +  () + 4095) / 4096;

49 ià((
addr
 = 
	`vm®loc
(
Åages
 * 4096)) == 0) {

50 
	`kä“_s
(
mp
,  *mp);

51 
	`kä“
(
§v’ame
);

52  -
ENOMEM
;

54 
mp
->
Çme
 = 
§v’ame
;

55 
mp
->
size
 = 
Åages
;

56 
mp
->
addr
 =‡ddr;

57 
mp
->
¡©e
 = 
MOD_UNINITIALIZED
;

58 * (*è
addr
 = 0;

59 
mp
->
ş—nup
 = 
NULL
;

60 
mp
->
Ãxt
 = 
moduË_li¡
;

61 
moduË_li¡
 = 
mp
;

62 
	`´štk
("module `%s' (%lu…ages @ 0x%08lx) created\n",

63 
mp
->
Çme
, (èmp->
size
, (èmp->
addr
);

64  (è
addr
;

65 
	}
}

70 
asmlškage
 

71 
	$sys_š™_moduË
(*
moduË_Çme
, *
code
, 
codesize
,

72 
mod_routšes
 *
routšes
)

74 
moduË
 *
mp
;

75 
Çme
[
MOD_MAX_NAME
];

76 
”rÜ
;

77 
mod_routšes
 
¹
;

79 ià(!
	`su£r
())

80  -
EPERM
;

86 
	`ä“_moduËs
();

88 ià((
”rÜ
 = 
	`g‘_mod_Çme
(
moduË_Çme
, 
Çme
)) != 0)

89  
”rÜ
;

90 
	`´štk
( "initializing module `%s', %d (0x%x) bytes\n",

91 
Çme
, 
codesize
, codesize);

92 
	`memıy_äomfs
(&
¹
, 
routšes
, „t);

93 ià((
mp
 = 
	`fšd_moduË
(
Çme
)è=ğ
NULL
)

94  -
ENOENT
;

95 ià((
codesize
 +  (è+ 4095è/ 4096 > 
mp
->
size
)

96  -
EINVAL
;

97 
	`memıy_äomfs
((*)
mp
->
addr
 +  (), 
code
, 
codesize
);

98 
	`mem£t
((*)
mp
->
addr
 +  (è+ 
codesize
, 0,

99 
mp
->
size
 * 4096 - (
codesize
 +  ()));

100 
	`´štk
( " initƒntry @ 0x%08lx, cleanupƒntry @ 0x%08lx\n",

101 (è
¹
.
š™
, (è¹.
ş—nup
);

102 
mp
->
ş—nup
 = 
¹
.cleanup;

103 ià((*
¹
.
š™
)() != 0)

104  -
EBUSY
;

105 
mp
->
¡©e
 = 
MOD_RUNNING
;

107 
	}
}

109 
asmlškage
 

110 
	$sys_d–‘e_moduË
(*
moduË_Çme
)

112 
moduË
 *
mp
;

113 
Çme
[
MOD_MAX_NAME
];

114 
”rÜ
;

116 ià(!
	`su£r
())

117  -
EPERM
;

118 ià(
moduË_Çme
 !ğ
NULL
) {

119 ià((
”rÜ
 = 
	`g‘_mod_Çme
(
moduË_Çme
, 
Çme
)) != 0)

120  
”rÜ
;

121 ià((
mp
 = 
	`fšd_moduË
(
Çme
)è=ğ
NULL
)

122  -
ENOENT
;

123 ià(
mp
->
¡©e
 =ğ
MOD_RUNNING
)

124 (*
mp
->
ş—nup
)();

125 
mp
->
¡©e
 = 
MOD_DELETED
;

127 
	`ä“_moduËs
();

129 
	}
}

135 
asmlškage
 

136 
	$sys_g‘_k”Ãl_syms
(
k”Ãl_sym
 *
bË
)

138 
	ssymbŞ
 {

139 
addr
;

140 *
Çme
;

142 
symbŞ_bË_size
;

143 
symbŞ
 
symbŞ_bË
[];

144 
i
;

145 
symbŞ
 *
äom
;

146 
k”Ãl_sym
 *
to
;

147 
k”Ãl_sym
 
sym
;

149 ià(
bË
 !ğ
NULL
) {

150 
äom
 = 
symbŞ_bË
;

151 
to
 = 
bË
;

152 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
to
, 
symbŞ_bË_size
 *  *
bË
);

153 ià(
i
)

154  
i
;

155 
i
 = 
symbŞ_bË_size
 ; --i >= 0 ; ) {

156 
sym
.
v®ue
 = 
äom
->
addr
;

157 
	`¡ºıy
(
sym
.
Çme
, 
äom
->name,  sym.name);

158 
	`memıy_tofs
(
to
, &
sym
,  sym);

159 
äom
++, 
to
++;

162  
symbŞ_bË_size
;

163 
	}
}

170 
	$g‘_mod_Çme
(*
u£r_Çme
, *
buf
)

172 
i
;

174 
i
 = 0;

175 
i
 = 0 ; (
buf
[i] = 
	`g‘_fs_by‹
(
u£r_Çme
 + i)) != '\0' ; ) {

176 ià(++
i
 >ğ
MOD_MAX_NAME
)

177  -
E2BIG
;

180 
	}
}

186 
moduË
 *

187 
	$fšd_moduË
ĞcÚ¡ *
Çme
)

189 
moduË
 *
mp
;

191 
mp
 = 
moduË_li¡
 ; m°; m°ğmp->
Ãxt
) {

192 ià(
mp
->
¡©e
 =ğ
MOD_DELETED
)

194 ià(!
	`¡rcmp
(
mp
->
Çme
,‚ame))

197  
mp
;

198 
	}
}

206 
	$ä“_moduËs
( )

208 
moduË
 *
mp
;

209 
moduË
 **
mµ
;

210 
did_d–‘iÚ
;

212 
did_d–‘iÚ
 = 0;

213 
ä“šg_moduËs
 = 0;

214 
mµ
 = &
moduË_li¡
;

215 (
mp
 = *
mµ
è!ğ
NULL
) {

216 ià(
mp
->
¡©e
 !ğ
MOD_DELETED
) {

217 
mµ
 = &
mp
->
Ãxt
;

218 } ià(
	`GET_USE_COUNT
(
mp
) != 0) {

219 
ä“šg_moduËs
 = 1;

220 
mµ
 = &
mp
->
Ãxt
;

222 *
mµ
 = 
mp
->
Ãxt
;

223 
	`vä“
(
mp
->
addr
);

224 
	`kä“
(
mp
->
Çme
);

225 
	`kä“_s
(
mp
,  *mp);

226 
did_d–‘iÚ
 = 1;

229  
did_d–‘iÚ
;

230 
	}
}

236 
	$g‘_moduË_li¡
(*
buf
)

238 *
p
;

239 *
q
;

240 
i
;

241 
moduË
 *
mp
;

242 
size
[32];

244 
p
 = 
buf
;

245 
mp
 = 
moduË_li¡
 ; m°; m°ğmp->
Ãxt
) {

246 ià(
p
 - 
buf
 > 4096 - 100)

248 
q
 = 
mp
->
Çme
;

249 
i
 = 20;

250 *
q
) {

251 *
p
++ = *
q
++;

252 
i
--;

254 
	`¥rštf
(
size
, "%d", 
mp
->size);

255 
i
 -ğ
	`¡¾’
(
size
);

256 ià(
i
 <= 0)

257 
i
 = 1;

258 --
i
 >= 0)

259 *
p
++ = ' ';

260 
q
 = 
size
;

261 *
q
)

262 *
p
++ = *
q
++;

263 ià(
mp
->
¡©e
 =ğ
MOD_UNINITIALIZED
)

264 
q
 = " (uninitialized)";

265 ià(
mp
->
¡©e
 =ğ
MOD_RUNNING
)

266 
q
 = "";

267 ià(
mp
->
¡©e
 =ğ
MOD_DELETED
)

268 
q
 = " (deleted)";

270 
q
 = " (bad state)";

271 *
q
)

272 *
p
++ = *
q
++;

273 *
p
++ = '\n';

275  
p
 - 
buf
;

276 
	}
}

	@kernel/panic.c

11 
	~<¡d¬g.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/sched.h
>

16 
asmlškage
 
sys_sync
();

18 
v¥rštf
(* 
buf
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gs
);

20 
NORET_TYPE
 
	$·nic
(cÚ¡ * 
fmt
, ...)

22 
buf
[1024];

23 
va_li¡
 
¬gs
;

25 
	`va_¡¬t
(
¬gs
, 
fmt
);

26 
	`v¥rštf
(
buf
, 
fmt
, 
¬gs
);

27 
	`va_’d
(
¬gs
);

28 
	`´štk
(
KERN_EMERG
 "K”ÃÈ·nic: %s\n",
buf
);

29 ià(
cu¼’t
 =ğ
sk
[0])

30 
	`´štk
(
KERN_EMERG
 "In swapperask -‚ot syncing\n");

32 
	`sys_sync
();

34 
	}
}

	@kernel/printk.c

14 
	~<¡d¬g.h
>

16 
	~<asm/£gm’t.h
>

17 
	~<asm/sy¡em.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/sched.h
>

21 
	~<lšux/k”Ãl.h
>

23 
	#LOG_BUF_LEN
 4096

	)

25 
	gbuf
[1024];

27 
v¥rštf
(* 
buf
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gs
);

28 
cÚsŞe_´št
(const *);

30 
	#DEFAULT_MESSAGE_LOGLEVEL
 7

	)

31 
	#DEFAULT_CONSOLE_LOGLEVEL
 7

	)

33 
	glog_size
 = 0;

34 
wa™_queue
 * 
	glog_wa™
 = 
NULL
;

35 
	gcÚsŞe_logËv–
 = 
DEFAULT_CONSOLE_LOGLEVEL
;

37 (*
cÚsŞe_´št_´oc
)(const *) = 0;

38 
log_buf
[
LOG_BUF_LEN
];

39 
log_¡¬t
 = 0;

40 
logged_ch¬s
 = 0;

55 
asmlškage
 
	$sys_sy¦og
(
ty³
, * 
buf
, 
Ën
)

57 
i
, 
j
, 
couÁ
;

58 
do_ş—r
 = 0;

59 
c
;

60 
”rÜ
;

62 ià((
ty³
 !ğ3è&& !
	`su£r
())

63  -
EPERM
;

64 
ty³
) {

70 ià(!
buf
 || 
Ën
 < 0)

71  -
EINVAL
;

72 ià(!
Ën
)

74 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
buf
,
Ën
);

75 ià(
”rÜ
)

76  
”rÜ
;

77 
	`şi
();

78 !
log_size
) {

79 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

80 
	`¡i
();

81  -
ERESTARTSYS
;

83 
	`š‹¼u±ibË_¦“p_Ú
(&
log_wa™
);

85 
i
 = 0;

86 
log_size
 && 
i
 < 
Ën
) {

87 
c
 = *((*è
log_buf
+
log_¡¬t
);

88 
log_¡¬t
++;

89 
log_size
--;

90 
log_¡¬t
 &ğ
LOG_BUF_LEN
-1;

91 
	`¡i
();

92 
	`put_fs_by‹
(
c
,
buf
);

93 
buf
++;

94 
i
++;

95 
	`şi
();

97 
	`¡i
();

98  
i
;

100 
do_ş—r
 = 1;

103 ià(!
buf
 || 
Ën
 < 0)

104  -
EINVAL
;

105 ià(!
Ën
)

107 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
buf
,
Ën
);

108 ià(
”rÜ
)

109  
”rÜ
;

110 
couÁ
 = 
Ën
;

111 ià(
couÁ
 > 
LOG_BUF_LEN
)

112 
couÁ
 = 
LOG_BUF_LEN
;

113 ià(
couÁ
 > 
logged_ch¬s
)

114 
couÁ
 = 
logged_ch¬s
;

115 
j
 = 
log_¡¬t
 + 
log_size
 - 
couÁ
;

116 
i
 = 0; i < 
couÁ
; i++) {

117 
c
 = *((*è
log_buf
+(
j
++ & (
LOG_BUF_LEN
-1)));

118 
	`put_fs_by‹
(
c
, 
buf
++);

120 ià(
do_ş—r
)

121 
logged_ch¬s
 = 0;

122  
i
;

124 
logged_ch¬s
 = 0;

127 
cÚsŞe_logËv–
 = 1;

130 
cÚsŞe_logËv–
 = 
DEFAULT_CONSOLE_LOGLEVEL
;

133 ià(
Ën
 < 0 ||†en > 8)

134  -
EINVAL
;

135 
cÚsŞe_logËv–
 = 
Ën
;

138  -
EINVAL
;

139 
	}
}

142 
asmlškage
 
	$´štk
(cÚ¡ *
fmt
, ...)

144 
va_li¡
 
¬gs
;

145 
i
;

146 *
msg
, *
p
, *
buf_’d
;

147 
msg_Ëv–
 = -1;

148 
æags
;

150 
	`§ve_æags
(
æags
);

151 
	`şi
();

152 
	`va_¡¬t
(
¬gs
, 
fmt
);

153 
i
 = 
	`v¥rštf
(
buf
 + 3, 
fmt
, 
¬gs
);

154 
buf_’d
 = 
buf
 + 3 + 
i
;

155 
	`va_’d
(
¬gs
);

156 
p
 = 
buf
 + 3;… < 
buf_’d
;…++) {

157 
msg
 = 
p
;

158 ià(
msg_Ëv–
 < 0) {

160 
p
[0] != '<' ||

161 
p
[1] < '0' ||

162 
p
[1] > '7' ||

163 
p
[2] != '>'

165 
p
 -= 3;

166 
p
[0] = '<';

167 
p
[1] = 
DEFAULT_MESSAGE_LOGLEVEL
 - 1 + '0';

168 
p
[2] = '>';

170 
msg
 += 3;

171 
msg_Ëv–
 = 
p
[1] - '0';

173 ; 
p
 < 
buf_’d
;…++) {

174 
log_buf
[(
log_¡¬t
+
log_size
è& (
LOG_BUF_LEN
-1)] = *
p
;

175 ià(
log_size
 < 
LOG_BUF_LEN
)

176 
log_size
++;

178 
log_¡¬t
++;

179 
logged_ch¬s
++;

180 ià(*
p
 == '\n')

183 ià(
msg_Ëv–
 < 
cÚsŞe_logËv–
 && 
cÚsŞe_´št_´oc
) {

184 
tmp
 = 
p
[1];

185 
p
[1] = '\0';

186 (*
cÚsŞe_´št_´oc
)(
msg
);

187 
p
[1] = 
tmp
;

189 ià(*
p
 == '\n')

190 
msg_Ëv–
 = -1;

192 
	`»¡Üe_æags
(
æags
);

193 
	`wake_up_š‹¼u±ibË
(&
log_wa™
);

194  
i
;

195 
	}
}

203 
»gi¡”_cÚsŞe
((*
´oc
)(const *))

205 
i
,
j
;

206 
p
 = 
log_¡¬t
;

207 
buf
[16];

208 
msg_Ëv–
 = -1;

209 *
q
;

211 
cÚsŞe_´št_´oc
 = 
´oc
;

213 
i
=0,
j
=0; i < 
log_size
; i++) {

214 
buf
[
j
++] = 
log_buf
[
p
];

215 
p
++;… &ğ
LOG_BUF_LEN
-1;

216 ià(
buf
[
j
-1] !ğ'\n' && 
i
 < 
log_size
 - 1 && j < (buf)-1)

218 
buf
[
j
] = 0;

219 
q
 = 
buf
;

220 ià(
msg_Ëv–
 < 0) {

221 
msg_Ëv–
 = 
buf
[1] - '0';

222 
q
 = 
buf
 + 3;

224 ià(
msg_Ëv–
 < 
cÚsŞe_logËv–
)

225 (*
´oc
)(
q
);

226 ià(
buf
[
j
-1] == '\n')

227 
msg_Ëv–
 = -1;

228 
j
 = 0;

230 
	}
}

	@kernel/ptrace.c

5 
	~<lšux/h—d.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/mm.h
>

9 
	~<lšux/”ºo.h
>

10 
	~<lšux/±¿û.h
>

11 
	~<lšux/u£r.h
>

13 
	~<asm/£gm’t.h
>

14 
	~<asm/sy¡em.h
>

15 
	~<lšux/debug»g.h
>

24 
	#FLAG_MASK
 0x00044dd5

	)

27 
	#TRAP_FLAG
 0x100

	)

33 
	#MAGICNUMBER
 68

	)

36 
šlše
 
sk_¡ruù
 * 
	$g‘_sk
(
pid
)

38 
i
;

40 
i
 = 1; i < 
NR_TASKS
; i++) {

41 ià(
sk
[
i
] !ğ
NULL
 && (sk[i]->
pid
 ==…id))

42  
sk
[
i
];

44  
NULL
;

45 
	}
}

53 
šlše
 
	$g‘_¡ack_lÚg
(
sk_¡ruù
 *
sk
, 
off£t
)

55 *
¡ack
;

57 
¡ack
 = (*)
sk
->
tss
.
e¥0
;

58 
¡ack
 +ğ
off£t
;

59  (*((*)
¡ack
));

60 
	}
}

68 
šlše
 
	$put_¡ack_lÚg
(
sk_¡ruù
 *
sk
, 
off£t
,

69 
d©a
)

71 * 
¡ack
;

73 
¡ack
 = (*è
sk
->
tss
.
e¥0
;

74 
¡ack
 +ğ
off£t
;

75 *(*è
¡ack
 = 
d©a
;

77 
	}
}

88 
	$g‘_lÚg
(
sk_¡ruù
 * 
tsk
,

89 
addr
)

91 
·ge
;

93 
»³©
:

94 
·ge
 = *
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
addr
);

95 ià(
·ge
 & 
PAGE_PRESENT
) {

96 
·ge
 &ğ
PAGE_MASK
;

97 
·ge
 +ğ
	`PAGE_PTR
(
addr
);

98 
·ge
 = *((*)…age);

100 ià(!(
·ge
 & 
PAGE_PRESENT
)) {

101 
	`do_no_·ge
(0,
addr
,
tsk
,0);

102 
»³©
;

105 ià(
·ge
 >ğ
high_memÜy
)

107 
·ge
 &ğ
PAGE_MASK
;

108 
·ge
 +ğ
addr
 & ~
PAGE_MASK
;

109  *(*è
·ge
;

110 
	}
}

121 
	$put_lÚg
(
sk_¡ruù
 * 
tsk
, 
addr
,

122 
d©a
)

124 
·ge
, 
±e
 = 0;

125 
»adÚly
 = 0;

127 
»³©
:

128 
·ge
 = *
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
addr
);

129 ià(
·ge
 & 
PAGE_PRESENT
) {

130 
·ge
 &ğ
PAGE_MASK
;

131 
·ge
 +ğ
	`PAGE_PTR
(
addr
);

132 
±e
 = 
·ge
;

133 
·ge
 = *((*)…age);

135 ià(!(
·ge
 & 
PAGE_PRESENT
)) {

136 
	`do_no_·ge
(0 ,
addr
,
tsk
,0);

137 
»³©
;

139 ià(!(
·ge
 & 
PAGE_RW
)) {

140 if(!(
·ge
 & 
PAGE_COW
))

141 
»adÚly
 = 1;

142 
	`do_wp_·ge
(
PAGE_RW
 | 
PAGE_PRESENT
,
addr
,
tsk
,0);

143 
»³©
;

146 ià(
·ge
 >ğ
high_memÜy
)

149 *(*è
±e
 |ğ(
PAGE_DIRTY
|
PAGE_COW
);

150 
·ge
 &ğ
PAGE_MASK
;

151 
·ge
 +ğ
addr
 & ~
PAGE_MASK
;

152 *(*è
·ge
 = 
d©a
;

153 if(
»adÚly
) {

154 *(*è
±e
 &=~ (
PAGE_RW
|
PAGE_COW
);

155 
	`šv®id©e
();

157 
	}
}

163 
	$»ad_lÚg
(
sk_¡ruù
 * 
tsk
, 
addr
,

164 * 
»suÉ
)

166 
low
,
high
;

168 ià(
addr
 > 
TASK_SIZE
-())

169  -
EIO
;

170 ià((
addr
 & ~
PAGE_MASK
è> 
PAGE_SIZE
-()) {

171 
low
 = 
	`g‘_lÚg
(
tsk
,
addr
 & ~(()-1));

172 
high
 = 
	`g‘_lÚg
(
tsk
,(
addr
+()) & ~(()-1));

173 
addr
 & (()-1)) {

175 
low
 >>= 8;

176 
low
 |ğ
high
 << 24;

179 
low
 >>= 16;

180 
low
 |ğ
high
 << 16;

183 
low
 >>= 24;

184 
low
 |ğ
high
 << 8;

187 *
»suÉ
 = 
low
;

189 *
»suÉ
 = 
	`g‘_lÚg
(
tsk
,
addr
);

191 
	}
}

197 
	$wr™e_lÚg
(
sk_¡ruù
 * 
tsk
, 
addr
,

198 
d©a
)

200 
low
,
high
;

202 ià(
addr
 > 
TASK_SIZE
-())

203  -
EIO
;

204 ià((
addr
 & ~
PAGE_MASK
è> 
PAGE_SIZE
-()) {

205 
low
 = 
	`g‘_lÚg
(
tsk
,
addr
 & ~(()-1));

206 
high
 = 
	`g‘_lÚg
(
tsk
,(
addr
+()) & ~(()-1));

207 
addr
 & (()-1)) {

209 
low
 = 
d©a
;

212 
low
 &= 0x000000ff;

213 
low
 |ğ
d©a
 << 8;

214 
high
 &= ~0xff;

215 
high
 |ğ
d©a
 >> 24;

218 
low
 &= 0x0000ffff;

219 
low
 |ğ
d©a
 << 16;

220 
high
 &= ~0xffff;

221 
high
 |ğ
d©a
 >> 16;

224 
low
 &= 0x00ffffff;

225 
low
 |ğ
d©a
 << 24;

226 
high
 &= ~0xffffff;

227 
high
 |ğ
d©a
 >> 8;

230 
	`put_lÚg
(
tsk
,
addr
 & ~(()-1),
low
);

231 
	`put_lÚg
(
tsk
,(
addr
+()è& ~(()-1),
high
);

233 
	`put_lÚg
(
tsk
,
addr
,
d©a
);

235 
	}
}

237 
asmlškage
 
	$sys_±¿û
(
»que¡
, 
pid
, 
addr
, 
d©a
)

239 
sk_¡ruù
 *
chd
;

240 
u£r
 * 
dummy
;

241 
i
;

243 
dummy
 = 
NULL
;

245 ià(
»que¡
 =ğ
PTRACE_TRACEME
) {

247 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

248  -
EPERM
;

250 
cu¼’t
->
æags
 |ğ
PF_PTRACED
;

253 ià(
pid
 == 1)

254  -
EPERM
;

255 ià(!(
chd
 = 
	`g‘_sk
(
pid
)))

256  -
ESRCH
;

257 ià(
»que¡
 =ğ
PTRACE_ATTACH
) {

258 ià(
chd
 =ğ
cu¼’t
)

259  -
EPERM
;

260 ià((!
chd
->
dum·bË
 || (
cu¼’t
->
uid
 !ğchd->
euid
) ||

261 (
cu¼’t
->
gid
 !ğ
chd
->
egid
)è&& !
	`su£r
())

262  -
EPERM
;

264 ià(
chd
->
æags
 & 
PF_PTRACED
)

265  -
EPERM
;

266 
chd
->
æags
 |ğ
PF_PTRACED
;

267 ià(
chd
->
p_µŒ
 !ğ
cu¼’t
) {

268 
	`REMOVE_LINKS
(
chd
);

269 
chd
->
p_µŒ
 = 
cu¼’t
;

270 
	`SET_LINKS
(
chd
);

272 
	`£nd_sig
(
SIGSTOP
, 
chd
, 1);

275 ià(!(
chd
->
æags
 & 
PF_PTRACED
))

276  -
ESRCH
;

277 ià(
chd
->
¡©e
 !ğ
TASK_STOPPED
) {

278 ià(
»que¡
 !ğ
PTRACE_KILL
)

279  -
ESRCH
;

281 ià(
chd
->
p_µŒ
 !ğ
cu¼’t
)

282  -
ESRCH
;

284 
»que¡
) {

286 
PTRACE_PEEKTEXT
:

287 
PTRACE_PEEKDATA
: {

288 
tmp
;

289 
»s
;

291 
»s
 = 
	`»ad_lÚg
(
chd
, 
addr
, &
tmp
);

292 ià(
»s
 < 0)

293  
»s
;

294 
»s
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
d©a
, ());

295 ià(!
»s
)

296 
	`put_fs_lÚg
(
tmp
,(*è
d©a
);

297  
»s
;

301 
PTRACE_PEEKUSR
: {

302 
tmp
;

303 
»s
;

305 ià((
addr
 & 3) ||‡ddr < 0 ||

306 
addr
 > (
u£r
) - 3)

307  -
EIO
;

309 
»s
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, (*è
d©a
, ());

310 ià(
»s
)

311  
»s
;

312 
tmp
 = 0;

313 if(
addr
 < 17*()) {

314 
addr
 =‡ddr >> 2;

316 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, ()*
addr
 - 
MAGICNUMBER
);

317 ià(
addr
 =ğ
DS
 ||‡dd¸=ğ
ES
 ||

318 
addr
 =ğ
FS
 ||‡dd¸=ğ
GS
 ||

319 
addr
 =ğ
CS
 ||‡dd¸=ğ
SS
)

320 
tmp
 &= 0xffff;

322 if(
addr
 >ğ(è&
dummy
->
u_debug»g
[0] &&

323 
addr
 <ğ(è&
dummy
->
u_debug»g
[7]){

324 
addr
 -ğ(è&
dummy
->
u_debug»g
[0];

325 
addr
 =‡ddr >> 2;

326 
tmp
 = 
chd
->
debug»g
[
addr
];

328 
	`put_fs_lÚg
(
tmp
,(*è
d©a
);

333 
PTRACE_POKETEXT
:

334 
PTRACE_POKEDATA
:

335  
	`wr™e_lÚg
(
chd
,
addr
,
d©a
);

337 
PTRACE_POKEUSR
:

338 ià((
addr
 & 3) ||‡ddr < 0 ||

339 
addr
 > (
u£r
) - 3)

340  -
EIO
;

342 
addr
 =‡ddr >> 2;

344 ià(
addr
 =ğ
ORIG_EAX
)

345  -
EIO
;

346 ià(
addr
 =ğ
DS
 ||‡dd¸=ğ
ES
 ||

347 
addr
 =ğ
FS
 ||‡dd¸=ğ
GS
 ||

348 
addr
 =ğ
CS
 ||‡dd¸=ğ
SS
) {

349 
d©a
 &= 0xffff;

350 ià(
d©a
 && (data & 3) != 3)

351  -
EIO
;

353 ià(
addr
 =ğ
EFL
) {

354 
d©a
 &ğ
FLAG_MASK
;

355 
d©a
 |ğ
	`g‘_¡ack_lÚg
(
chd
, 
EFL
*()-
MAGICNUMBER
è& ~
FLAG_MASK
;

359 if(
addr
 < 17){

360 ià(
	`put_¡ack_lÚg
(
chd
, ()*
addr
-
MAGICNUMBER
, 
d©a
))

361  -
EIO
;

370 
addr
 =‡ddr << 2;

371 if(
addr
 >ğ(è&
dummy
->
u_debug»g
[0] &&

372 
addr
 <ğ(è&
dummy
->
u_debug»g
[7]){

374 if(
addr
 =ğ(è&
dummy
->
u_debug»g
[4]è -
EIO
;

375 if(
addr
 =ğ(è&
dummy
->
u_debug»g
[5]è -
EIO
;

376 if(
addr
 < (è&
dummy
->
u_debug»g
[4] &&

377 ((è
d©a
è>ğ0xbffffffdè -
EIO
;

379 if(
addr
 =ğ(è&
dummy
->
u_debug»g
[7]) {

380 
d©a
 &ğ~
DR_CONTROL_RESERVED
;

381 
i
=0; i<4; i++)

382 ià((0x5f54 >> ((
d©a
 >> (16 + 4*
i
)) & 0xf)) & 1)

383  -
EIO
;

386 
addr
 -ğ(è&
dummy
->
u_debug»g
;

387 
addr
 =‡ddr >> 2;

388 
chd
->
debug»g
[
addr
] = 
d©a
;

391  -
EIO
;

393 
PTRACE_SYSCALL
:

394 
PTRACE_CONT
: {

395 
tmp
;

397 ià((è
d©a
 > 
NSIG
)

398  -
EIO
;

399 ià(
»que¡
 =ğ
PTRACE_SYSCALL
)

400 
chd
->
æags
 |ğ
PF_TRACESYS
;

402 
chd
->
æags
 &ğ~
PF_TRACESYS
;

403 
chd
->
ex™_code
 = 
d©a
;

404 
chd
->
¡©e
 = 
TASK_RUNNING
;

406 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
è& ~
TRAP_FLAG
;

407 
	`put_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
,
tmp
);

416 
PTRACE_KILL
: {

417 
tmp
;

419 
chd
->
¡©e
 = 
TASK_RUNNING
;

420 
chd
->
ex™_code
 = 
SIGKILL
;

422 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
è& ~
TRAP_FLAG
;

423 
	`put_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
,
tmp
);

427 
PTRACE_SINGLESTEP
: {

428 
tmp
;

430 ià((è
d©a
 > 
NSIG
)

431  -
EIO
;

432 
chd
->
æags
 &ğ~
PF_TRACESYS
;

433 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
è| 
TRAP_FLAG
;

434 
	`put_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
,
tmp
);

435 
chd
->
¡©e
 = 
TASK_RUNNING
;

436 
chd
->
ex™_code
 = 
d©a
;

441 
PTRACE_DETACH
: {

442 
tmp
;

444 ià((è
d©a
 > 
NSIG
)

445  -
EIO
;

446 
chd
->
æags
 &ğ~(
PF_PTRACED
|
PF_TRACESYS
);

447 
chd
->
¡©e
 = 
TASK_RUNNING
;

448 
chd
->
ex™_code
 = 
d©a
;

449 
	`REMOVE_LINKS
(
chd
);

450 
chd
->
p_µŒ
 = chd->
p_İ±r
;

451 
	`SET_LINKS
(
chd
);

453 
tmp
 = 
	`g‘_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
è& ~
TRAP_FLAG
;

454 
	`put_¡ack_lÚg
(
chd
, ()*
EFL
-
MAGICNUMBER
,
tmp
);

459  -
EIO
;

461 
	}
}

463 
asmlškage
 
	$sysÿÎ_Œaû
()

465 ià((
cu¼’t
->
æags
 & (
PF_PTRACED
|
PF_TRACESYS
))

466 !ğ(
PF_PTRACED
|
PF_TRACESYS
))

468 
cu¼’t
->
ex™_code
 = 
SIGTRAP
;

469 
cu¼’t
->
¡©e
 = 
TASK_STOPPED
;

470 
	`nÙify_·»Á
(
cu¼’t
);

471 
	`scheduË
();

477 ià(
cu¼’t
->
ex™_code
)

478 
cu¼’t
->
sigÇl
 |ğ(1 << (cu¼’t->
ex™_code
 - 1));

479 
cu¼’t
->
ex™_code
 = 0;

480 
	}
}

	@kernel/sched.c

14 
	~<lšux/cÚfig.h
>

15 
	~<lšux/sigÇl.h
>

16 
	~<lšux/sched.h
>

17 
	~<lšux/tim”.h
>

18 
	~<lšux/k”Ãl.h
>

19 
	~<lšux/k”Ãl_¡©.h
>

20 
	~<lšux/sys.h
>

21 
	~<lšux/fd»g.h
>

22 
	~<lšux/”ºo.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/±¿û.h
>

25 
	~<lšux/£gm’t.h
>

26 
	~<lšux/d–ay.h
>

27 
	~<lšux/š‹¼u±.h
>

29 
	~<asm/sy¡em.h
>

30 
	~<asm/io.h
>

31 
	~<asm/£gm’t.h
>

33 
	#TIMER_IRQ
 0

	)

35 
	~<lšux/timex.h
>

40 
	gtick
 = 1000000 / 
HZ
;

41 vŞ©
timev®
 
	gxtime
;

42 
	gtickadj
 = 500/
HZ
;

47 
	gtime_¡©us
 = 
TIME_BAD
;

48 
	gtime_off£t
 = 0;

49 
	gtime_cÚ¡ªt
 = 0;

50 
	gtime_tŞ”ªû
 = 
MAXFREQ
;

51 
	gtime_´ecisiÚ
 = 1;

52 
	gtime_max”rÜ
 = 0x70000000;

53 
	gtime_e¡”rÜ
 = 0x70000000;

54 
	gtime_pha£
 = 0;

55 
	gtime_äeq
 = 0;

56 
	gtime_adj
 = 0;

57 
	gtime_»áime
 = 0;

59 
	gtime_adju¡
 = 0;

60 
	gtime_adju¡_¡•
 = 0;

62 
	gÃed_»sched
 = 0;

67 
	gh¬d_m©h
 = 0;

68 
	gx86
 = 0;

69 
	gignÜe_œq13
 = 0;

70 
	gwp_wÜks_ok
 = 0;

75 
	gEISA_bus
 = 0;

77 
_£t™im”
(, 
™im”v®
 *, itimerval *);

78 * 
	g´of_bufãr
 = 
NULL
;

79 
	g´of_Ën
 = 0;

81 
	#_S
(
Ä
è(1<<(Òr)-1))

	)

83 
mem_u£
();

85 
tim”_š‹¼u±
();

86 
asmlškage
 
sy¡em_ÿÎ
();

88 
	gš™_k”Ãl_¡ack
[1024];

89 
sk_¡ruù
 
	gš™_sk
 = 
INIT_TASK
;

91 vŞ©
	gjiff›s
=0;

93 
sk_¡ruù
 *
	gcu¼’t
 = &
š™_sk
;

94 
sk_¡ruù
 *
	gÏ¡_sk_u£d_m©h
 = 
NULL
;

96 
sk_¡ruù
 * 
	gsk
[
NR_TASKS
] = {&
š™_sk
, };

98 
	gu£r_¡ack
 [ 
PAGE_SIZE
>>2 ] ;

101 * 
	ma
;

102 
	mb
;

103 } 
	g¡ack_¡¬t
 = { & 
u£r_¡ack
 [
PAGE_SIZE
>>2] , 
KERNEL_DS
 };

105 
k”Ãl_¡©
 
	gk¡©
 =

112 #ifdeà
__ılu¥lus


116 
sys_ni_sysÿÎ
()

118  -
EINVAL
;

121 
â_±r
 
sys_ÿÎ_bË
[] = { 
sys_£tup
, 
sys_ex™
, 
sys_fÜk
, 
sys_»ad
,

122 
sys_wr™e
, 
sys_İ’
, 
sys_şo£
, 
sys_wa™pid
, 
sys_ü—t
, 
sys_lšk
,

123 
sys_uÆšk
, 
sys_execve
, 
sys_chdœ
, 
sys_time
, 
sys_mknod
, 
sys_chmod
,

124 
sys_chown
, 
sys_b»ak
, 
sys_¡©
, 
sys_l£ek
, 
sys_g‘pid
, 
sys_mouÁ
,

125 
sys_umouÁ
, 
sys_£tuid
, 
sys_g‘uid
, 
sys_¡ime
, 
sys_±¿û
, 
sys_®¬m
,

126 
sys_f¡©
, 
sys_·u£
, 
sys_utime
, 
sys_¡ty
, 
sys_g‰y
, 
sys_acûss
,

127 
sys_niû
, 
sys_áime
, 
sys_sync
, 
sys_kl
, 
sys_»Çme
, 
sys_mkdœ
,

128 
sys_rmdœ
, 
sys_dup
, 
sys_pe
, 
sys_times
, 
sys_´of
, 
sys_brk
, 
sys_£tgid
,

129 
sys_g‘gid
, 
sys_sigÇl
, 
sys_g‘euid
, 
sys_g‘egid
, 
sys_acù
, 
sys_phys
,

130 
sys_lock
, 
sys_ioùl
, 
sys_fú
, 
sys_mpx
, 
sys_£gid
, 
sys_ulim™
,

131 
sys_ŞduÇme
, 
sys_umask
, 
sys_chroÙ
, 
sys_u¡©
, 
sys_dup2
, 
sys_g‘µid
,

132 
sys_g‘pg½
, 
sys_£tsid
, 
sys_sigaùiÚ
, 
sys_sg‘mask
, 
sys_s£tmask
,

133 
sys_£Œeuid
,
sys_£Œegid
, 
sys_sigsu¥’d
, 
sys_sig³ndšg
,

134 
sys_£tho¡Çme
, 
sys_£Œlim™
, 
sys_g‘¾im™
, 
sys_g‘ru§ge
,

135 
sys_g‘timeofday
, 
sys_£‰imeofday
, 
sys_g‘groups
, 
sys_£tgroups
,

136 
sys_£Ëù
, 
sys_symlšk
, 
sys_l¡©
, 
sys_»adlšk
, 
sys_u£lib
,

137 
sys_sw­Ú
, 
sys_»boÙ
, 
sys_»addœ
, 
sys_mm­
, 
sys_munm­
, 
sys_Œunÿ‹
,

138 
sys_árunÿ‹
, 
sys_fchmod
, 
sys_fchown
, 
sys_g‘´iÜ™y
, 
sys_£riÜ™y
,

139 
sys_´of
, 
sys_¡©fs
, 
sys_f¡©fs
, 
sys_iİ”m
, 
sys_sock‘ÿÎ
,

140 
sys_sy¦og
, 
sys_£t™im”
, 
sys_g‘™im”
, 
sys_Ãw¡©
, 
sys_Ãwl¡©
,

141 
sys_Ãwf¡©
, 
sys_uÇme
, 
sys_iİl
, 
sys_vhªgup
, 
sys_idË
, 
sys_vm86
,

142 
sys_wa™4
, 
sys_sw­off
, 
sys_sysšfo
, 
sys_c
, 
sys_fsync
, 
sys_sig»tuº
,

143 
sys_şÚe
, 
sys_£tdomašÇme
, 
sys_ÃwuÇme
, 
sys_modify_ldt
,

144 
sys_adjtimex
, 
sys_m´Ùeù
, 
sys_sig´ocmask
, 
sys_ü—‹_moduË
,

145 
sys_š™_moduË
, 
sys_d–‘e_moduË
, 
sys_g‘_k”Ãl_syms
, 
sys_quÙaùl
,

146 
sys_g‘pgid
, 
sys_fchdœ
, 
sys_bdæush
 };

149 
NR_sysÿÎs
 = (
sys_ÿÎ_bË
)/(
â_±r
);

151 #ifdeà
__ılu¥lus


162 
asmlškage
 
	$m©h_¡©e_»¡Üe
()

164 
__asm__
 
	`__vŞ©e__
("clts");

165 ià(
Ï¡_sk_u£d_m©h
 =ğ
cu¼’t
)

167 
tim”_bË
[
COPRO_TIMER
].
expœes
 = 
jiff›s
+50;

168 
tim”_aùive
 |ğ1<<
COPRO_TIMER
;

169 ià(
Ï¡_sk_u£d_m©h
)

170 
	`__asm__
("â§v%0":"=m" (
Ï¡_sk_u£d_m©h
->
tss
.
i387
));

172 
	`__asm__
("fnclex");

173 
Ï¡_sk_u£d_m©h
 = 
cu¼’t
;

174 ià(
cu¼’t
->
u£d_m©h
) {

175 
	`__asm__
("ä¡Ü %0": :"m" (
cu¼’t
->
tss
.
i387
));

177 
	`__asm__
("fninit");

178 
cu¼’t
->
u£d_m©h
=1;

180 
tim”_aùive
 &ğ~(1<<
COPRO_TIMER
);

181 
	}
}

183 #iâdeà
CONFIG_MATH_EMULATION


185 
asmlškage
 
	$m©h_emuÏ‹
(
¬g
)

187 
	`´štk
("math-emulation‚otƒnabled‡nd‚o coprocessor found.\n");

188 
	`´štk
("klšg %s.\n",
cu¼’t
->
comm
);

189 
	`£nd_sig
(
SIGFPE
,
cu¼’t
,1);

190 
	`scheduË
();

191 
	}
}

195 
™im”_ticks
 = 0;

196 
	g™im”_Ãxt
 = ~0;

197 
	glo¡_ticks
 = 0;

211 
asmlškage
 
	$scheduË
()

213 
c
;

214 
sk_¡ruù
 * 
p
;

215 
sk_¡ruù
 * 
Ãxt
;

216 
ticks
;

220 
	`şi
();

221 
ticks
 = 
™im”_ticks
;

222 
™im”_ticks
 = 0;

223 
™im”_Ãxt
 = ~0;

224 
	`¡i
();

225 
Ãed_»sched
 = 0;

226 
p
 = &
š™_sk
;

228 ià((
p
 =…->
Ãxt_sk
è=ğ&
š™_sk
)

229 
cÚfu£_gcc1
;

230 ià(
ticks
 && 
p
->
™_»®_v®ue
) {

231 ià(
p
->
™_»®_v®ue
 <ğ
ticks
) {

232 
	`£nd_sig
(
SIGALRM
, 
p
, 1);

233 ià(!
p
->
™_»®_šü
) {

234 
p
->
™_»®_v®ue
 = 0;

235 
’d_™im”
;

238 
p
->
™_»®_v®ue
 +ğp->
™_»®_šü
;

239 } 
p
->
™_»®_v®ue
 <ğ
ticks
);

241 
p
->
™_»®_v®ue
 -ğ
ticks
;

242 ià(
p
->
™_»®_v®ue
 < 
™im”_Ãxt
)

243 
™im”_Ãxt
 = 
p
->
™_»®_v®ue
;

245 
’d_™im”
:

246 ià(
p
->
¡©e
 !ğ
TASK_INTERRUPTIBLE
)

248 ià(
p
->
sigÇl
 & ~p->
blocked
) {

249 
p
->
¡©e
 = 
TASK_RUNNING
;

252 ià(
p
->
timeout
 &&…->timeouˆ<ğ
jiff›s
) {

253 
p
->
timeout
 = 0;

254 
p
->
¡©e
 = 
TASK_RUNNING
;

257 
cÚfu£_gcc1
:

265 ià(
TASK_UNINTERRUPTIBLE
 >ğ(è
cu¼’t
->
¡©e
 &&

266 
cu¼’t
->
couÁ”
 < cu¼’t->
´iÜ™y
*2) {

267 ++
cu¼’t
->
couÁ”
;

270 
c
 = -1;

271 
Ãxt
 = 
p
 = &
š™_sk
;

273 ià((
p
 =…->
Ãxt_sk
è=ğ&
š™_sk
)

274 
cÚfu£_gcc2
;

275 ià(
p
->
¡©e
 =ğ
TASK_RUNNING
 &&…->
couÁ”
 > 
c
)

276 
c
 = 
p
->
couÁ”
, 
Ãxt
 =…;

278 
cÚfu£_gcc2
:

279 ià(!
c
) {

280 
	`fÜ_—ch_sk
(
p
)

281 
p
->
couÁ”
 = (p->couÁ” >> 1è+…->
´iÜ™y
;

283 if(
cu¼’t
 !ğ
Ãxt
)

284 
k¡©
.
cÚ‹xt_swtch
++;

285 
	`sw™ch_to
(
Ãxt
);

287 if(
cu¼’t
->
debug»g
[7]){

288 
	`lßddebug
(0);

289 
	`lßddebug
(1);

290 
	`lßddebug
(2);

291 
	`lßddebug
(3);

292 
	`lßddebug
(6);

294 
	}
}

296 
asmlškage
 
	$sys_·u£
()

298 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

299 
	`scheduË
();

300  -
ERESTARTNOHAND
;

301 
	}
}

311 
	$wake_up
(
wa™_queue
 **
q
)

313 
wa™_queue
 *
tmp
;

314 
sk_¡ruù
 * 
p
;

316 ià(!
q
 || !(
tmp
 = *q))

319 ià((
p
 = 
tmp
->
sk
è!ğ
NULL
) {

320 ià((
p
->
¡©e
 =ğ
TASK_UNINTERRUPTIBLE
) ||

321 (
p
->
¡©e
 =ğ
TASK_INTERRUPTIBLE
)) {

322 
p
->
¡©e
 = 
TASK_RUNNING
;

323 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

324 
Ãed_»sched
 = 1;

327 ià(!
tmp
->
Ãxt
) {

328 
	`´štk
("wa™_queui bad (e = %08lx)\n",((*è
q
)[-1]);

329 
	`´štk
(" q = %p\n",
q
);

330 
	`´štk
(" *q = %p\n",*
q
);

331 
	`´štk
("m°ğ%p\n",
tmp
);

334 
tmp
 =mp->
Ãxt
;

335 } 
tmp
 !ğ*
q
);

336 
	}
}

338 
	$wake_up_š‹¼u±ibË
(
wa™_queue
 **
q
)

340 
wa™_queue
 *
tmp
;

341 
sk_¡ruù
 * 
p
;

343 ià(!
q
 || !(
tmp
 = *q))

346 ià((
p
 = 
tmp
->
sk
è!ğ
NULL
) {

347 ià(
p
->
¡©e
 =ğ
TASK_INTERRUPTIBLE
) {

348 
p
->
¡©e
 = 
TASK_RUNNING
;

349 ià(
p
->
couÁ”
 > 
cu¼’t
->counter)

350 
Ãed_»sched
 = 1;

353 ià(!
tmp
->
Ãxt
) {

354 
	`´štk
("wa™_queui bad (e = %08lx)\n",((*è
q
)[-1]);

355 
	`´štk
(" q = %p\n",
q
);

356 
	`´štk
(" *q = %p\n",*
q
);

357 
	`´štk
("m°ğ%p\n",
tmp
);

360 
tmp
 =mp->
Ãxt
;

361 } 
tmp
 !ğ*
q
);

362 
	}
}

364 
	$__down
(
£m­hÜe
 * 
£m
)

366 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

367 
	`add_wa™_queue
(&
£m
->
wa™
, &wait);

368 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

369 
£m
->
couÁ
 <= 0) {

370 
	`scheduË
();

371 
cu¼’t
->
¡©e
 = 
TASK_UNINTERRUPTIBLE
;

373 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

374 
	`»move_wa™_queue
(&
£m
->
wa™
, &wait);

375 
	}
}

377 
šlše
 
	$__¦“p_Ú
(
wa™_queue
 **
p
, 
¡©e
)

379 
æags
;

380 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

382 ià(!
p
)

384 ià(
cu¼’t
 =ğ
sk
[0])

385 
	`·nic
("task[0]ryingo sleep");

386 
cu¼’t
->
¡©e
 = state;

387 
	`add_wa™_queue
(
p
, &
wa™
);

388 
	`§ve_æags
(
æags
);

389 
	`¡i
();

390 
	`scheduË
();

391 
	`»move_wa™_queue
(
p
, &
wa™
);

392 
	`»¡Üe_æags
(
æags
);

393 
	}
}

395 
	$š‹¼u±ibË_¦“p_Ú
(
wa™_queue
 **
p
)

397 
	`__¦“p_Ú
(
p
,
TASK_INTERRUPTIBLE
);

398 
	}
}

400 
	$¦“p_Ú
(
wa™_queue
 **
p
)

402 
	`__¦“p_Ú
(
p
,
TASK_UNINTERRUPTIBLE
);

403 
	}
}

405 
tim”_li¡
 * 
	gÃxt_tim”
 = 
NULL
;

407 
	$add_tim”
(
tim”_li¡
 * 
tim”
)

409 
æags
;

410 
tim”_li¡
 ** 
p
;

412 ià(!
tim”
)

414 
tim”
->
Ãxt
 = 
NULL
;

415 
p
 = &
Ãxt_tim”
;

416 
	`§ve_æags
(
æags
);

417 
	`şi
();

418 *
p
) {

419 ià((*
p
)->
expœes
 > 
tim”
->expires) {

420 (*
p
)->
expœes
 -ğ
tim”
->expires;

421 
tim”
->
Ãxt
 = *
p
;

424 
tim”
->
expœes
 -ğ(*
p
)->expires;

425 
p
 = &(*p)->
Ãxt
;

427 *
p
 = 
tim”
;

428 
	`»¡Üe_æags
(
æags
);

429 
	}
}

431 
	$d–_tim”
(
tim”_li¡
 * 
tim”
)

433 
æags
;

434 
expœes
 = 0;

435 
tim”_li¡
 **
p
;

437 
p
 = &
Ãxt_tim”
;

438 
	`§ve_æags
(
æags
);

439 
	`şi
();

440 *
p
) {

441 ià(*
p
 =ğ
tim”
) {

442 ià((*
p
 = 
tim”
->
Ãxt
è!ğ
NULL
)

443 (*
p
)->
expœes
 +ğ
tim”
->expires;

444 
tim”
->
expœes
 +=ƒxpires;

445 
	`»¡Üe_æags
(
æags
);

448 
expœes
 +ğ(*
p
)->expires;

449 
p
 = &(*p)->
Ãxt
;

451 
	`»¡Üe_æags
(
æags
);

453 
	}
}

455 
	gtim”_aùive
 = 0;

456 
tim”_¡ruù
 
	gtim”_bË
[32];

464 
	gav’run
[3] = { 0,0,0 };

469 
	$couÁ_aùive_sks
()

471 
sk_¡ruù
 **
p
;

472 
Ä
 = 0;

474 
p
 = &
LAST_TASK
;… > &
FIRST_TASK
; --p)

475 ià(*
p
 && ((*p)->
¡©e
 =ğ
TASK_RUNNING
 ||

476 (*
p
)->
¡©e
 =ğ
TASK_UNINTERRUPTIBLE
 ||

477 (*
p
)->
¡©e
 =ğ
TASK_SWAPPING
))

478 
Ä
 +ğ
FIXED_1
;

479  
Ä
;

480 
	}
}

482 
šlše
 
	$ÿlc_lßd
()

484 
aùive_sks
;

485 
couÁ
 = 
LOAD_FREQ
;

487 ià(
couÁ
-- > 0)

489 
couÁ
 = 
LOAD_FREQ
;

490 
aùive_sks
 = 
	`couÁ_aùive_sks
();

491 
	`CALC_LOAD
(
av’run
[0], 
EXP_1
, 
aùive_sks
);

492 
	`CALC_LOAD
(
av’run
[1], 
EXP_5
, 
aùive_sks
);

493 
	`CALC_LOAD
(
av’run
[2], 
EXP_15
, 
aùive_sks
);

494 
	}
}

506 
	$£cÚd_ov”æow
()

508 
Éemp
;

510 
Ï¡_¹c_upd©e
=0;

511 
	`£t_¹c_mmss
();

514 
time_max”rÜ
 = (0x70000000-time_max”rÜ < 
time_tŞ”ªû
) ?

515 0x70000000 : (
time_max”rÜ
 + 
time_tŞ”ªû
);

518 ià(
time_off£t
 < 0) {

519 
Éemp
 = (-(
time_off£t
+1è>> (
SHIFT_KG
 + 
time_cÚ¡ªt
)) + 1;

520 
time_adj
 = 
Éemp
 << (
SHIFT_SCALE
 - 
SHIFT_HZ
 - 
SHIFT_UPDATE
);

521 
time_off£t
 +ğ(
time_adj
 * 
HZ
è>> (
SHIFT_SCALE
 - 
SHIFT_UPDATE
);

522 
time_adj
 = -ime_adj;

523 } ià(
time_off£t
 > 0) {

524 
Éemp
 = ((
time_off£t
-1è>> (
SHIFT_KG
 + 
time_cÚ¡ªt
)) + 1;

525 
time_adj
 = 
Éemp
 << (
SHIFT_SCALE
 - 
SHIFT_HZ
 - 
SHIFT_UPDATE
);

526 
time_off£t
 -ğ(
time_adj
 * 
HZ
è>> (
SHIFT_SCALE
 - 
SHIFT_UPDATE
);

528 
time_adj
 = 0;

531 
time_adj
 +ğ(
time_äeq
 >> (
SHIFT_KF
 + 
SHIFT_HZ
 - 
SHIFT_SCALE
))

532 + 
FINETUNE
;

535 
time_¡©us
) {

536 
TIME_INS
:

538 ià(
xtime
.
tv_£c
 % 86400 == 0) {

539 
xtime
.
tv_£c
--;

540 
time_¡©us
 = 
TIME_OOP
;

541 
	`´štk
("Clock: inserting†eap second 23:59:60 GMT\n");

545 
TIME_DEL
:

547 ià(
xtime
.
tv_£c
 % 86400 == 86399) {

548 
xtime
.
tv_£c
++;

549 
time_¡©us
 = 
TIME_OK
;

550 
	`´štk
("Clock: deleting†eap second 23:59:59 GMT\n");

554 
TIME_OOP
:

555 
time_¡©us
 = 
TIME_OK
;

558 ià(
xtime
.
tv_£c
 > 
Ï¡_¹c_upd©e
 + 660)

559 ià(
	`£t_¹c_mmss
(
xtime
.
tv_£c
) == 0)

560 
Ï¡_¹c_upd©e
 = 
xtime
.
tv_£c
;

561 
	}
}

566 
	$tim”_bh
(* 
unu£d
)

568 
mask
;

569 
tim”_¡ruù
 *

;

571 
	`şi
();

572 
Ãxt_tim”
 &&‚ext_tim”->
expœes
 == 0) {

573 (*
â
)(èğ
Ãxt_tim”
->
funùiÚ
;

574 
d©a
 = 
Ãxt_tim”
->data;

575 
Ãxt_tim”
 =‚ext_tim”->
Ãxt
;

576 
	`¡i
();

577 
	`â
(
d©a
);

578 
	`şi
();

580 
	`¡i
();

582 
mask
 = 1, 

 = 
tim”_bË
+0 ; mask ;p++,mask += mask) {

583 ià(
mask
 > 
tim”_aùive
)

585 ià(!(
mask
 & 
tim”_aùive
))

587 ià(

->
expœes
 > 
jiff›s
)

589 
tim”_aùive
 &ğ~
mask
;

590 

->
	`â
();

591 
	`¡i
();

593 
	}
}

601 
	$do_tim”
(
±_»gs
 * 
»gs
)

603 
mask
;

604 
tim”_¡ruù
 *

;

606 
Éemp
;

611 
time_pha£
 +ğ
time_adj
;

612 ià(
time_pha£
 < -
FINEUSEC
) {

613 
Éemp
 = -
time_pha£
 >> 
SHIFT_SCALE
;

614 
time_pha£
 +ğ
Éemp
 << 
SHIFT_SCALE
;

615 
xtime
.
tv_u£c
 +ğ
tick
 + 
time_adju¡_¡•
 - 
Éemp
;

617 ià(
time_pha£
 > 
FINEUSEC
) {

618 
Éemp
 = 
time_pha£
 >> 
SHIFT_SCALE
;

619 
time_pha£
 -ğ
Éemp
 << 
SHIFT_SCALE
;

620 
xtime
.
tv_u£c
 +ğ
tick
 + 
time_adju¡_¡•
 + 
Éemp
;

622 
xtime
.
tv_u£c
 +ğ
tick
 + 
time_adju¡_¡•
;

624 ià(
time_adju¡
)

635 ià(
time_adju¡
 > 
tickadj
)

636 
time_adju¡_¡•
 = 
tickadj
;

637 ià(
time_adju¡
 < -
tickadj
)

638 
time_adju¡_¡•
 = -
tickadj
;

640 
time_adju¡_¡•
 = 
time_adju¡
;

643 
time_adju¡
 -ğ
time_adju¡_¡•
;

646 
time_adju¡_¡•
 = 0;

648 ià(
xtime
.
tv_u£c
 >= 1000000) {

649 
xtime
.
tv_u£c
 -= 1000000;

650 
xtime
.
tv_£c
++;

651 
	`£cÚd_ov”æow
();

654 
jiff›s
++;

655 
	`ÿlc_lßd
();

656 ià((
VM_MASK
 & 
»gs
->
eæags
è|| (3 &„egs->
cs
)) {

657 
cu¼’t
->
utime
++;

658 ià(
cu¼’t
 !ğ
sk
[0]) {

659 ià(
cu¼’t
->
´iÜ™y
 < 15)

660 
k¡©
.
ıu_niû
++;

662 
k¡©
.
ıu_u£r
++;

665 ià(
cu¼’t
->
™_vœt_v®ue
 && !(--current->it_virt_value)) {

666 
cu¼’t
->
™_vœt_v®ue
 = cu¼’t->
™_vœt_šü
;

667 
	`£nd_sig
(
SIGVTALRM
,
cu¼’t
,1);

670 
cu¼’t
->
¡ime
++;

671 if(
cu¼’t
 !ğ
sk
[0])

672 
k¡©
.
ıu_sy¡em
++;

673 #ifdeà
CONFIG_PROFILE


674 ià(
´of_bufãr
 && 
cu¼’t
 !ğ
sk
[0]) {

675 
e
 = 
»gs
->eip;

676 
e
 >>= 2;

677 ià(
e
 < 
´of_Ën
)

678 
´of_bufãr
[
e
]++;

682 ià(
cu¼’t
 =ğ
sk
[0] || (--cu¼’t->
couÁ”
)<=0) {

683 
cu¼’t
->
couÁ”
=0;

684 
Ãed_»sched
 = 1;

687 ià(
cu¼’t
->
™_´of_v®ue
 && !(--current->it_prof_value)) {

688 
cu¼’t
->
™_´of_v®ue
 = cu¼’t->
™_´of_šü
;

689 
	`£nd_sig
(
SIGPROF
,
cu¼’t
,1);

691 
mask
 = 1, 

 = 
tim”_bË
+0 ; mask ;p++,mask += mask) {

692 ià(
mask
 > 
tim”_aùive
)

694 ià(!(
mask
 & 
tim”_aùive
))

696 ià(

->
expœes
 > 
jiff›s
)

698 
	`m¬k_bh
(
TIMER_BH
);

700 
	`şi
();

701 
™im”_ticks
++;

702 ià(
™im”_ticks
 > 
™im”_Ãxt
)

703 
Ãed_»sched
 = 1;

704 ià(
Ãxt_tim”
) {

705 ià(
Ãxt_tim”
->
expœes
) {

706 
Ãxt_tim”
->
expœes
--;

707 ià(!
Ãxt_tim”
->
expœes
)

708 
	`m¬k_bh
(
TIMER_BH
);

710 
lo¡_ticks
++;

711 
	`m¬k_bh
(
TIMER_BH
);

714 
	`¡i
();

715 
	}
}

717 
asmlškage
 
	$sys_®¬m
(
£cÚds
)

719 
™im”v®
 
™_Ãw
, 
™_Şd
;

721 
™_Ãw
.
™_š‹rv®
.
tv_£c
 = it_Ãw.™_š‹rv®.
tv_u£c
 = 0;

722 
™_Ãw
.
™_v®ue
.
tv_£c
 = 
£cÚds
;

723 
™_Ãw
.
™_v®ue
.
tv_u£c
 = 0;

724 
	`_£t™im”
(
ITIMER_REAL
, &
™_Ãw
, &
™_Şd
);

725 (
™_Şd
.
™_v®ue
.
tv_£c
 + (™_Şd.™_v®ue.
tv_u£c
 / 1000000));

726 
	}
}

728 
asmlškage
 
	$sys_g‘pid
()

730  
cu¼’t
->
pid
;

731 
	}
}

733 
asmlškage
 
	$sys_g‘µid
()

735  
cu¼’t
->
p_İ±r
->
pid
;

736 
	}
}

738 
asmlškage
 
	$sys_g‘uid
()

740  
cu¼’t
->
uid
;

741 
	}
}

743 
asmlškage
 
	$sys_g‘euid
()

745  
cu¼’t
->
euid
;

746 
	}
}

748 
asmlškage
 
	$sys_g‘gid
()

750  
cu¼’t
->
gid
;

751 
	}
}

753 
asmlškage
 
	$sys_g‘egid
()

755  
cu¼’t
->
egid
;

756 
	}
}

758 
asmlškage
 
	$sys_niû
(
šüem’t
)

760 
Ãw´io
;

762 ià(
šüem’t
 < 0 && !
	`su£r
())

763  -
EPERM
;

764 
Ãw´io
 = 
cu¼’t
->
´iÜ™y
 - 
šüem’t
;

765 ià(
Ãw´io
 < 1)

766 
Ãw´io
 = 1;

767 ià(
Ãw´io
 > 35)

768 
Ãw´io
 = 35;

769 
cu¼’t
->
´iÜ™y
 = 
Ãw´io
;

771 
	}
}

773 
	$show_sk
(
Ä
,
sk_¡ruù
 * 
p
)

775 * 
¡©_Çm
[] = { "R", "S", "D", "Z", "T", "W" };

777 
	`´štk
("%-8 %3d ", 
p
->
comm
, (°=ğ
cu¼’t
è? -
Ä
 :‚r);

778 ià(((è
p
->
¡©e
è< (
¡©_Çm
)/(*))

779 
	`´štk
(
¡©_Çm
[
p
->
¡©e
]);

781 
	`´štk
(" ");

782 ià(
p
 =ğ
cu¼’t
)

783 
	`´štk
(" current ");

785 
	`´štk
(" %08lX ", ((*)
p
->
tss
.
e¥
)[3]);

786 
	`´štk
("%5lu %5d %6d ",

787 
p
->
tss
.
e¥
 -…->
k”Ãl_¡ack_·ge
,…->
pid
,…->
p_µŒ
->pid);

788 ià(
p
->
p_ıŒ
)

789 
	`´štk
("%5d ", 
p
->
p_ıŒ
->
pid
);

791 
	`´štk
(" ");

792 ià(
p
->
p_y¥Œ
)

793 
	`´štk
("%7d", 
p
->
p_y¥Œ
->
pid
);

795 
	`´štk
(" ");

796 ià(
p
->
p_o¥Œ
)

797 
	`´štk
(" %5d\n", 
p
->
p_o¥Œ
->
pid
);

799 
	`´štk
("\n");

800 
	}
}

802 
	$show_¡©e
()

804 
i
;

806 
	`´štk
(" free sibling\n");

807 
	`´štk
("ask PC stack…id father child younger older\n");

808 
i
=0 ; i<
NR_TASKS
 ; i++)

809 ià(
sk
[
i
])

810 
	`show_sk
(
i
,
sk
[i]);

811 
	}
}

813 
	$sched_š™
()

815 
i
;

816 
desc_¡ruù
 * 
p
;

818 
bh_ba£
[
TIMER_BH
].
routše
 = 
tim”_bh
;

819 ià((
sigaùiÚ
) != 16)

820 
	`·nic
("Struct sigaction MUST be 16 bytes");

821 
	`£t_tss_desc
(
gdt
+
FIRST_TSS_ENTRY
,&
š™_sk
.
tss
);

822 
	`£t_ldt_desc
(
gdt
+
FIRST_LDT_ENTRY
,&
deçuÉ_ldt
,1);

823 
	`£t_sy¡em_g©e
(0x80,&
sy¡em_ÿÎ
);

824 
p
 = 
gdt
+2+
FIRST_TSS_ENTRY
;

825 
i
=1 ; i<
NR_TASKS
 ; i++) {

826 
sk
[
i
] = 
NULL
;

827 
p
->
a
õ->
b
=0;

828 
p
++;

829 
p
->
a
õ->
b
=0;

830 
p
++;

833 
	`__asm__
("pushfl ;‡ndl $0xffffbfff,(%esp) ;…opfl");

834 
	`lßd_TR
(0);

835 
	`lßd_ldt
(0);

836 
	`outb_p
(0x34,0x43);

837 
	`outb_p
(
LATCH
 & 0xff , 0x40);

838 
	`outb
(
LATCH
 >> 8 , 0x40);

839 ià(
	`»que¡_œq
(
TIMER_IRQ
,((*)()è
do_tim”
)!=0)

840 
	`·nic
("Could‚ot‡llocateimer IRQ!");

841 
	}
}

	@kernel/signal.c

7 
	~<lšux/sched.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/sigÇl.h
>

10 
	~<lšux/”ºo.h
>

11 
	~<lšux/wa™.h
>

12 
	~<lšux/±¿û.h
>

13 
	~<lšux/uni¡d.h
>

15 
	~<asm/£gm’t.h
>

17 
	#_S
(
Ä
è(1<<(Òr)-1))

	)

19 
	#_BLOCKABLE
 (~(
	`_S
(
SIGKILL
è| _S(
SIGSTOP
)))

	)

21 
cÜe_dump
(
sigÄ
,
±_»gs
 * 
»gs
);

23 
asmlškage
 
do_sigÇl
(
Şdmask
, 
±_»gs
 * 
»gs
);

25 
	ssigcÚ‹xt_¡ruù
 {

26 
	mgs
, 
	m__gsh
;

27 
	mfs
, 
	m__fsh
;

28 
	mes
, 
	m__esh
;

29 
	mds
, 
	m__dsh
;

30 
	medi
;

31 
	mesi
;

32 
	mebp
;

33 
	me¥
;

34 
	mebx
;

35 
	medx
;

36 
	mecx
;

37 
	m—x
;

38 
	mŒ­no
;

39 
	m”r
;

40 
	me
;

41 
	mcs
, 
	m__csh
;

42 
	meæags
;

43 
	me¥_©_sigÇl
;

44 
	mss
, 
	m__ssh
;

45 
	mi387
;

46 
	mŞdmask
;

47 
	mü2
;

50 
asmlškage
 
	$sys_sig´ocmask
(
how
, 
sig£t_t
 *
£t
, sig£t_ˆ*
o£t
)

52 
sig£t_t
 
Ãw_£t
, 
Şd_£t
 = 
cu¼’t
->
blocked
;

53 
”rÜ
;

55 ià(
£t
) {

56 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
£t
, (
sig£t_t
));

57 ià(
”rÜ
)

58  
”rÜ
;

59 
Ãw_£t
 = 
	`g‘_fs_lÚg
((*è
£t
è& 
_BLOCKABLE
;

60 
how
) {

61 
SIG_BLOCK
:

62 
cu¼’t
->
blocked
 |ğ
Ãw_£t
;

64 
SIG_UNBLOCK
:

65 
cu¼’t
->
blocked
 &ğ~
Ãw_£t
;

67 
SIG_SETMASK
:

68 
cu¼’t
->
blocked
 = 
Ãw_£t
;

71  -
EINVAL
;

74 ià(
o£t
) {

75 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
o£t
, (
sig£t_t
));

76 ià(
”rÜ
)

77  
”rÜ
;

78 
	`put_fs_lÚg
(
Şd_£t
, (*è
o£t
);

81 
	}
}

83 
asmlškage
 
	$sys_sg‘mask
()

85  
cu¼’t
->
blocked
;

86 
	}
}

88 
asmlškage
 
	$sys_s£tmask
(
Ãwmask
)

90 
Şd
=
cu¼’t
->
blocked
;

92 
cu¼’t
->
blocked
 = 
Ãwmask
 & 
_BLOCKABLE
;

93  
Şd
;

94 
	}
}

96 
asmlškage
 
	$sys_sig³ndšg
(
sig£t_t
 *
£t
)

98 
”rÜ
;

100 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
£t
, 4);

101 ià(!
”rÜ
)

102 
	`put_fs_lÚg
(
cu¼’t
->
blocked
 & cu¼’t->
sigÇl
, (*)
£t
);

103  
”rÜ
;

104 
	}
}

109 
asmlškage
 
	$sys_sigsu¥’d
(
»¡¬t
, 
Şdmask
, 
£t
)

111 
mask
;

112 
±_»gs
 * 
»gs
 = (±_»g *è&
»¡¬t
;

114 
mask
 = 
cu¼’t
->
blocked
;

115 
cu¼’t
->
blocked
 = 
£t
 & 
_BLOCKABLE
;

116 
»gs
->
—x
 = -
EINTR
;

118 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

119 
	`scheduË
();

120 ià(
	`do_sigÇl
(
mask
,
»gs
))

121  -
EINTR
;

123 
	}
}

140 
	$check_³ndšg
(
signum
)

142 
sigaùiÚ
 *
p
;

144 
p
 = 
signum
 - 1 + 
cu¼’t
->
sigaùiÚ
;

145 ià(
p
->
§_hªdËr
 =ğ
SIG_IGN
) {

146 ià(
signum
 =ğ
SIGCHLD
)

148 
cu¼’t
->
sigÇl
 &ğ~
	`_S
(
signum
);

151 ià(
p
->
§_hªdËr
 =ğ
SIG_DFL
) {

152 ià(
signum
 !ğ
SIGCONT
 && signum !ğ
SIGCHLD
 && signum !ğ
SIGWINCH
)

154 
cu¼’t
->
sigÇl
 &ğ~
	`_S
(
signum
);

157 
	}
}

159 
asmlškage
 
	$sys_sigÇl
(
signum
, 
hªdËr
)

161 
sigaùiÚ
 
tmp
;

163 ià(
signum
<1 || signum>32 || signum==
SIGKILL
 || signum==
SIGSTOP
)

164  -
EINVAL
;

165 ià(
hªdËr
 >ğ
TASK_SIZE
)

166  -
EFAULT
;

167 
tmp
.
§_hªdËr
 = ((*)()è
hªdËr
;

168 
tmp
.
§_mask
 = 0;

169 
tmp
.
§_æags
 = 
SA_ONESHOT
 | 
SA_NOMASK
;

170 
tmp
.
§_»¡Ü”
 = 
NULL
;

171 
hªdËr
 = (è
cu¼’t
->
sigaùiÚ
[
signum
-1].
§_hªdËr
;

172 
cu¼’t
->
sigaùiÚ
[
signum
-1] = 
tmp
;

173 
	`check_³ndšg
(
signum
);

174  
hªdËr
;

175 
	}
}

177 
asmlškage
 
	$sys_sigaùiÚ
(
signum
, cÚ¡ 
sigaùiÚ
 * 
aùiÚ
,

178 
sigaùiÚ
 * 
ŞdaùiÚ
)

180 
sigaùiÚ
 
Ãw_§
, *
p
;

182 ià(
signum
<1 || signum>32 || signum==
SIGKILL
 || signum==
SIGSTOP
)

183  -
EINVAL
;

184 
p
 = 
signum
 - 1 + 
cu¼’t
->
sigaùiÚ
;

185 ià(
aùiÚ
) {

186 
”r
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
aùiÚ
, (*action));

187 ià(
”r
)

188  
”r
;

189 
	`memıy_äomfs
(&
Ãw_§
, 
aùiÚ
, (
sigaùiÚ
));

190 ià(
Ãw_§
.
§_æags
 & 
SA_NOMASK
)

191 
Ãw_§
.
§_mask
 = 0;

193 
Ãw_§
.
§_mask
 |ğ
	`_S
(
signum
);

194 
Ãw_§
.
§_mask
 &ğ
_BLOCKABLE
;

196 ià(
TASK_SIZE
 <ğ(è
Ãw_§
.
§_hªdËr
)

197  -
EFAULT
;

199 ià(
ŞdaùiÚ
) {

200 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
ŞdaùiÚ
, (*oldaction));

201 ià(
”r
)

202  
”r
;

203 
	`memıy_tofs
(
ŞdaùiÚ
, 
p
, (
sigaùiÚ
));

205 ià(
aùiÚ
) {

206 *
p
 = 
Ãw_§
;

207 
	`check_³ndšg
(
signum
);

210 
	}
}

212 
asmlškage
 
sys_wa™pid
(
pid_t
 
pid
,* 
¡©_addr
, 
İtiÚs
);

217 
asmlškage
 
	$sys_sig»tuº
(
__unu£d
)

219 
	#COPY
(
x
è
»gs
->x = 
cÚ‹xt
.
	)
x

220 
	#COPY_SEG
(
x
) \

221 ià((
cÚ‹xt
.
x
 & 0xfffcè&& (cÚ‹xt.x & 3è!ğ3è
badäame
; 
	`COPY
(x);

	)

222 
	#COPY_SEG_STRICT
(
x
) \

223 ià(!(
cÚ‹xt
.
x
 & 0xfffcè|| (cÚ‹xt.x & 3è!ğ3è
badäame
; 
	`COPY
(x);

	)

224 
sigcÚ‹xt_¡ruù
 
cÚ‹xt
;

225 
±_»gs
 * 
»gs
;

227 
»gs
 = (
±_»gs
 *è&
__unu£d
;

228 ià(
	`v”ify_¬—
(
VERIFY_READ
, (*è
»gs
->
e¥
, (
cÚ‹xt
)))

229 
badäame
;

230 
	`memıy_äomfs
(&
cÚ‹xt
,(*è
»gs
->
e¥
, (context));

231 
cu¼’t
->
blocked
 = 
cÚ‹xt
.
Şdmask
 & 
_BLOCKABLE
;

232 
	`COPY_SEG
(
ds
);

233 
	`COPY_SEG
(
es
);

234 
	`COPY_SEG
(
fs
);

235 
	`COPY_SEG
(
gs
);

236 
	`COPY_SEG_STRICT
(
ss
);

237 
	`COPY_SEG_STRICT
(
cs
);

238 
	`COPY
(
e
);

239 
	`COPY
(
ecx
); COPY(
edx
);

240 
	`COPY
(
ebx
);

241 
	`COPY
(
e¥
); COPY(
ebp
);

242 
	`COPY
(
edi
); COPY(
esi
);

243 
»gs
->
eæags
 &= ~0xCD5;

244 
»gs
->
eæags
 |ğ
cÚ‹xt
.eflags & 0xCD5;

245 
»gs
->
Üig_—x
 = -1;

246  
cÚ‹xt
.
—x
;

247 
badäame
:

248 
	`do_ex™
(
SIGSEGV
);

249 
	}
}

255 
	$£tup_äame
(
sigaùiÚ
 * 
§
, ** 
å
, 
e
,

256 
±_»gs
 * 
»gs
, 
sigÄ
, 
Şdmask
)

258 * 
äame
;

260 
	#__CODE
 (()(
äame
+24))

	)

261 
	#CODE
(
x
è((*è((x)+
__CODE
))

	)

262 
äame
 = *
å
;

263 ià(
»gs
->
ss
 !ğ
USER_DS
)

264 
äame
 = (*è
§
->
§_»¡Ü”
;

265 
äame
 -= 32;

266 ià(
	`v”ify_¬—
(
VERIFY_WRITE
,
äame
,32*4))

267 
	`do_ex™
(
SIGSEGV
);

269 
	`put_fs_lÚg
(
__CODE
,
äame
);

270 
	`put_fs_lÚg
(
sigÄ
, 
äame
+1);

271 
	`put_fs_lÚg
(
»gs
->
gs
, 
äame
+2);

272 
	`put_fs_lÚg
(
»gs
->
fs
, 
äame
+3);

273 
	`put_fs_lÚg
(
»gs
->
es
, 
äame
+4);

274 
	`put_fs_lÚg
(
»gs
->
ds
, 
äame
+5);

275 
	`put_fs_lÚg
(
»gs
->
edi
, 
äame
+6);

276 
	`put_fs_lÚg
(
»gs
->
esi
, 
äame
+7);

277 
	`put_fs_lÚg
(
»gs
->
ebp
, 
äame
+8);

278 
	`put_fs_lÚg
(()*
å
, 
äame
+9);

279 
	`put_fs_lÚg
(
»gs
->
ebx
, 
äame
+10);

280 
	`put_fs_lÚg
(
»gs
->
edx
, 
äame
+11);

281 
	`put_fs_lÚg
(
»gs
->
ecx
, 
äame
+12);

282 
	`put_fs_lÚg
(
»gs
->
—x
, 
äame
+13);

283 
	`put_fs_lÚg
(
cu¼’t
->
tss
.
Œ­_no
, 
äame
+14);

284 
	`put_fs_lÚg
(
cu¼’t
->
tss
.
”rÜ_code
, 
äame
+15);

285 
	`put_fs_lÚg
(
e
, 
äame
+16);

286 
	`put_fs_lÚg
(
»gs
->
cs
, 
äame
+17);

287 
	`put_fs_lÚg
(
»gs
->
eæags
, 
äame
+18);

288 
	`put_fs_lÚg
(
»gs
->
e¥
, 
äame
+19);

289 
	`put_fs_lÚg
(
»gs
->
ss
, 
äame
+20);

290 
	`put_fs_lÚg
(0,
äame
+21);

292 
	`put_fs_lÚg
(
Şdmask
, 
äame
+22);

293 
	`put_fs_lÚg
(
cu¼’t
->
tss
.
ü2
, 
äame
+23);

295 
	`put_fs_lÚg
(0x0000b858, 
	`CODE
(0));

296 
	`put_fs_lÚg
(0x80cd0000, 
	`CODE
(4));

297 
	`put_fs_lÚg
(
__NR_sig»tuº
, 
	`CODE
(2));

298 *
å
 = 
äame
;

299 #undeà
__CODE


300 #undeà
CODE


301 
	}
}

312 
asmlškage
 
	$do_sigÇl
(
Şdmask
, 
±_»gs
 * 
»gs
)

314 
mask
 = ~
cu¼’t
->
blocked
;

315 
hªdËr_sigÇl
 = 0;

316 *
äame
 = 
NULL
;

317 
e
 = 0;

318 
sigÄ
;

319 
sigaùiÚ
 * 
§
;

321 (
sigÄ
 = 
cu¼’t
->
sigÇl
 & 
mask
)) {

322 
	`__asm__
("bsf %2,%1\n\t"

324 :"=m" (
cu¼’t
->
sigÇl
),"ô" (
sigÄ
)

325 :"1" (
sigÄ
));

326 
§
 = 
cu¼’t
->
sigaùiÚ
 + 
sigÄ
;

327 
sigÄ
++;

328 ià((
cu¼’t
->
æags
 & 
PF_PTRACED
è&& 
sigÄ
 !ğ
SIGKILL
) {

329 
cu¼’t
->
ex™_code
 = 
sigÄ
;

330 
cu¼’t
->
¡©e
 = 
TASK_STOPPED
;

331 
	`nÙify_·»Á
(
cu¼’t
);

332 
	`scheduË
();

333 ià(!(
sigÄ
 = 
cu¼’t
->
ex™_code
))

335 
cu¼’t
->
ex™_code
 = 0;

336 ià(
sigÄ
 =ğ
SIGSTOP
)

338 ià(
	`_S
(
sigÄ
è& 
cu¼’t
->
blocked
) {

339 
cu¼’t
->
sigÇl
 |ğ
	`_S
(
sigÄ
);

342 
§
 = 
cu¼’t
->
sigaùiÚ
 + 
sigÄ
 - 1;

344 ià(
§
->
§_hªdËr
 =ğ
SIG_IGN
) {

345 ià(
sigÄ
 !ğ
SIGCHLD
)

348 
	`sys_wa™pid
(-1,
NULL
,
WNOHANG
) > 0)

352 ià(
§
->
§_hªdËr
 =ğ
SIG_DFL
) {

353 ià(
cu¼’t
->
pid
 == 1)

355 
sigÄ
) {

356 
SIGCONT
: 
SIGCHLD
: 
SIGWINCH
:

359 
SIGSTOP
: 
SIGTSTP
: 
SIGTTIN
: 
SIGTTOU
:

360 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

362 
cu¼’t
->
¡©e
 = 
TASK_STOPPED
;

363 
cu¼’t
->
ex™_code
 = 
sigÄ
;

364 ià(!(
cu¼’t
->
p_µŒ
->
sigaùiÚ
[
SIGCHLD
-1].
§_æags
 &

365 
SA_NOCLDSTOP
))

366 
	`nÙify_·»Á
(
cu¼’t
);

367 
	`scheduË
();

370 
SIGQUIT
: 
SIGILL
: 
SIGTRAP
:

371 
SIGIOT
: 
SIGFPE
: 
SIGSEGV
:

372 ià(
	`cÜe_dump
(
sigÄ
,
»gs
))

373 
sigÄ
 |= 0x80;

376 
cu¼’t
->
sigÇl
 |ğ
	`_S
(
sigÄ
 & 0x7f);

377 
	`do_ex™
(
sigÄ
);

383 ià(
»gs
->
Üig_—x
 >= 0) {

384 ià(
»gs
->
—x
 =ğ-
ERESTARTNOHAND
 ||

385 (
»gs
->
—x
 =ğ-
ERESTARTSYS
 && !(
§
->
§_æags
 & 
SA_RESTART
)))

386 
»gs
->
—x
 = -
EINTR
;

388 
hªdËr_sigÇl
 |ğ1 << (
sigÄ
-1);

389 
mask
 &ğ~
§
->
§_mask
;

391 ià(
»gs
->
Üig_—x
 >= 0 &&

392 (
»gs
->
—x
 =ğ-
ERESTARTNOHAND
 ||

393 
»gs
->
—x
 =ğ-
ERESTARTSYS
 ||

394 
»gs
->
—x
 =ğ-
ERESTARTNOINTR
)) {

395 
»gs
->
—x
 =„egs->
Üig_—x
;

396 
»gs
->
e
 -= 2;

398 ià(!
hªdËr_sigÇl
)

400 
e
 = 
»gs
->eip;

401 
äame
 = (*è
»gs
->
e¥
;

402 
sigÄ
 = 1;

403 
§
 = 
cu¼’t
->
sigaùiÚ
;

404 
mask
 = 1 ; mask ; 
§
++,
sigÄ
++,mask += mask) {

405 ià(
mask
 > 
hªdËr_sigÇl
)

407 ià(!(
mask
 & 
hªdËr_sigÇl
))

409 
	`£tup_äame
(
§
,&
äame
,
e
,
»gs
,
sigÄ
,
Şdmask
);

410 
e
 = (è
§
->
§_hªdËr
;

411 ià(
§
->
§_æags
 & 
SA_ONESHOT
)

412 
§
->
§_hªdËr
 = 
NULL
;

414 
	`__asm__
("‹¡b $0,%%fs:%0": :"m" (*(*è
e
));

415 
»gs
->
cs
 = 
USER_CS
;„egs->
ss
 = 
USER_DS
;

416 
»gs
->
ds
 = 
USER_DS
;„egs->
es
 = USER_DS;

417 
»gs
->
gs
 = 
USER_DS
;„egs->
fs
 = USER_DS;

418 
cu¼’t
->
blocked
 |ğ
§
->
§_mask
;

419 
Şdmask
 |ğ
§
->
§_mask
;

421 
»gs
->
e¥
 = (è
äame
;

422 
»gs
->
e
 =ƒip;

423 
cu¼’t
->
tss
.
Œ­_no
 = cu¼’t->tss.
”rÜ_code
 = 0;

425 
	}
}

	@kernel/sys.c

7 
	~<lšux/cÚfig.h
>

8 
	~<lšux/”ºo.h
>

9 
	~<lšux/sched.h
>

10 
	~<lšux/k”Ãl.h
>

11 
	~<lšux/times.h
>

12 
	~<lšux/ut¢ame.h
>

13 
	~<lšux/·¿m.h
>

14 
	~<lšux/»sourû.h
>

15 
	~<lšux/sigÇl.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/±¿û.h
>

18 
	~<lšux/¡©.h
>

19 
	~<lšux/mmª.h
>

21 
	~<asm/£gm’t.h
>

22 
	~<asm/io.h
>

27 
	gC_A_D
 = 1;

29 
adju¡_şock
();

31 
	#PZERO
 15

	)

33 
	$´oc_£l
(
sk_¡ruù
 *
p
, 
which
, 
who
)

35 
which
) {

36 
PRIO_PROCESS
:

37 ià(!
who
 && 
p
 =ğ
cu¼’t
)

39 (
p
->
pid
 =ğ
who
);

40 
PRIO_PGRP
:

41 ià(!
who
)

42 
who
 = 
cu¼’t
->
pg½
;

43 (
p
->
pg½
 =ğ
who
);

44 
PRIO_USER
:

45 ià(!
who
)

46 
who
 = 
cu¼’t
->
uid
;

47 (
p
->
uid
 =ğ
who
);

50 
	}
}

52 
asmlškage
 
	$sys_£riÜ™y
(
which
, 
who
, 
niûv®
)

54 
sk_¡ruù
 **
p
;

55 
”rÜ
 = 
ESRCH
;

56 
´iÜ™y
;

58 ià(
which
 > 2 || which < 0)

59  -
EINVAL
;

61 ià((
´iÜ™y
 = 
PZERO
 - 
niûv®
) <= 0)

62 
´iÜ™y
 = 1;

64 
p
 = &
LAST_TASK
;… > &
FIRST_TASK
; --p) {

65 ià(!*
p
 || !
	`´oc_£l
(*p, 
which
, 
who
))

67 ià((*
p
)->
uid
 !ğ
cu¼’t
->
euid
 &&

68 (*
p
)->
uid
 !ğ
cu¼’t
->uid && !
	`su£r
()) {

69 
”rÜ
 = 
EPERM
;

72 ià(
”rÜ
 =ğ
ESRCH
)

73 
”rÜ
 = 0;

74 ià(
´iÜ™y
 > (*
p
)->´iÜ™y && !
	`su£r
())

75 
”rÜ
 = 
EACCES
;

77 (*
p
)->
´iÜ™y
 =…riority;

79  -
”rÜ
;

80 
	}
}

82 
asmlškage
 
	$sys_g‘´iÜ™y
(
which
, 
who
)

84 
sk_¡ruù
 **
p
;

85 
max_´io
 = 0;

87 ià(
which
 > 2 || which < 0)

88  -
EINVAL
;

90 
p
 = &
LAST_TASK
;… > &
FIRST_TASK
; --p) {

91 ià(!*
p
 || !
	`´oc_£l
(*p, 
which
, 
who
))

93 ià((*
p
)->
´iÜ™y
 > 
max_´io
)

94 
max_´io
 = (*
p
)->
´iÜ™y
;

96 (
max_´io
 ? max_´iØ: -
ESRCH
);

97 
	}
}

99 
asmlškage
 
	$sys_´of
()

101  -
ENOSYS
;

102 
	}
}

104 
asmlškage
 
	$sys_áime
()

106  -
ENOSYS
;

107 
	}
}

109 
asmlškage
 
	$sys_b»ak
()

111  -
ENOSYS
;

112 
	}
}

114 
asmlškage
 
	$sys_¡ty
()

116  -
ENOSYS
;

117 
	}
}

119 
asmlškage
 
	$sys_g‰y
()

121  -
ENOSYS
;

122 
	}
}

124 
asmlškage
 
	$sys_´of
()

126  -
ENOSYS
;

127 
	}
}

129 
asmlškage
 
	$§ve_v86_¡©e
(
vm86_»gs
 * 
»gs
)

131 
¡ack
;

133 ià(!
cu¼’t
->
vm86_šfo
) {

134 
	`´štk
("no vm86_info: BAD\n");

135 
	`do_ex™
(
SIGSEGV
);

137 
	`memıy_tofs
(&(
cu¼’t
->
vm86_šfo
->
»gs
),regs,(*regs));

138 
	`put_fs_lÚg
(
cu¼’t
->
sü“n_b™m­
,&(cu¼’t->
vm86_šfo
->screen_bitmap));

139 
¡ack
 = 
cu¼’t
->
tss
.
e¥0
;

140 
cu¼’t
->
tss
.
e¥0
 = cu¼’t->
§ved_k”Ãl_¡ack
;

141 
cu¼’t
->
§ved_k”Ãl_¡ack
 = 0;

142  
¡ack
;

143 
	}
}

145 
	$m¬k_sü“n_rdÚly
(
sk_¡ruù
 * 
tsk
)

147 
tmp
;

148 *
pg_bË
;

150 ià((
tmp
 = 
tsk
->
tss
.
ü3
) != 0) {

151 
tmp
 = *(*)mp;

152 ià(
tmp
 & 
PAGE_PRESENT
) {

153 
tmp
 &ğ
PAGE_MASK
;

154 
pg_bË
 = (0xA0000 >> 
PAGE_SHIFT
è+ (*è
tmp
;

155 
tmp
 = 32;

156 
tmp
--) {

157 ià(
PAGE_PRESENT
 & *
pg_bË
)

158 *
pg_bË
 &ğ~
PAGE_RW
;

159 
pg_bË
++;

163 
	}
}

165 
asmlškage
 
	$sys_vm86
(
vm86_¡ruù
 * 
v86
)

167 
vm86_¡ruù
 
šfo
;

168 
±_»gs
 *…t_»g ğ(±_»g *è&
v86
;

170 ià(
cu¼’t
->
§ved_k”Ãl_¡ack
)

171  -
EPERM
;

172 
	`memıy_äomfs
(&
šfo
,
v86
,(info));

176 
šfo
.
»gs
.
__nuÎ_ds
 = 0;

177 
šfo
.
»gs
.
__nuÎ_es
 = 0;

178 
šfo
.
»gs
.
__nuÎ_fs
 = 0;

179 
šfo
.
»gs
.
__nuÎ_gs
 = 0;

185 
šfo
.
»gs
.
eæags
 &= 0x00000dd5;

186 
šfo
.
»gs
.
eæags
 |ğ~0x00000dd5 & 
±_»gs
->eflags;

187 
šfo
.
»gs
.
eæags
 |ğ
VM_MASK
;

188 
cu¼’t
->
§ved_k”Ãl_¡ack
 = cu¼’t->
tss
.
e¥0
;

189 
cu¼’t
->
tss
.
e¥0
 = (è
±_»gs
;

190 
cu¼’t
->
vm86_šfo
 = 
v86
;

191 
cu¼’t
->
sü“n_b™m­
 = 
šfo
.screen_bitmap;

192 ià(
šfo
.
æags
 & 
VM86_SCREEN_BITMAP
)

193 
	`m¬k_sü“n_rdÚly
(
cu¼’t
);

194 
__asm__
 
	`__vŞ©e__
("movl %0,%%esp\n\t"

198 :"g" ((è&(
šfo
.
»gs
)),"a" (šfo.»gs.
—x
));

200 
	}
}

202 
h¬d_»£t_now
();

212 
asmlškage
 
	$sys_»boÙ
(
magic
, 
magic_too
, 
æag
)

214 ià(!
	`su£r
())

215  -
EPERM
;

216 ià(
magic
 !ğ0xãe1d—d || 
magic_too
 != 672274793)

217  -
EINVAL
;

218 ià(
æag
 == 0x01234567)

219 
	`h¬d_»£t_now
();

220 ià(
æag
 == 0x89ABCDEF)

221 
C_A_D
 = 1;

222 ià(!
æag
)

223 
C_A_D
 = 0;

225  -
EINVAL
;

227 
	}
}

234 
	$ù¾_®t_d–
()

236 ià(
C_A_D
)

237 
	`h¬d_»£t_now
();

239 
	`£nd_sig
(
SIGINT
,
sk
[1],1);

240 
	}
}

254 
asmlškage
 
	$sys_£Œegid
(
gid_t
 
rgid
, gid_ˆ
egid
)

256 
Şd_rgid
 = 
cu¼’t
->
gid
;

258 ià(
rgid
 !ğ(
gid_t
) -1) {

259 ià((
cu¼’t
->
egid
==
rgid
) ||

260 (
Şd_rgid
 =ğ
rgid
) ||

261 
	`su£r
())

262 
cu¼’t
->
gid
 = 
rgid
;

264 (-
EPERM
);

266 ià(
egid
 !ğ(
gid_t
) -1) {

267 ià((
Şd_rgid
 =ğ
egid
) ||

268 (
cu¼’t
->
egid
 ==ƒgid) ||

269 
	`su£r
()) {

270 
cu¼’t
->
egid
 =ƒgid;

271 
cu¼’t
->
sgid
 = 
egid
;

273 
cu¼’t
->
gid
 = 
Şd_rgid
;

274 (-
EPERM
);

278 
	}
}

283 
asmlškage
 
	$sys_£tgid
(
gid_t
 
gid
)

285 ià(
	`su£r
())

286 
cu¼’t
->
gid
 = cu¼’t->
egid
 = cu¼’t->
sgid
 = gid;

287 ià((
gid
 =ğ
cu¼’t
->gidè|| (gid =ğcu¼’t->
sgid
))

288 
cu¼’t
->
egid
 = 
gid
;

290  -
EPERM
;

292 
	}
}

294 
asmlškage
 
	$sys_acù
()

296  -
ENOSYS
;

297 
	}
}

299 
asmlškage
 
	$sys_phys
()

301  -
ENOSYS
;

302 
	}
}

304 
asmlškage
 
	$sys_lock
()

306  -
ENOSYS
;

307 
	}
}

309 
asmlškage
 
	$sys_mpx
()

311  -
ENOSYS
;

312 
	}
}

314 
asmlškage
 
	$sys_ulim™
()

316  -
ENOSYS
;

317 
	}
}

319 
asmlškage
 
	$sys_Şd_sysÿÎ
()

321  -
ENOSYS
;

322 
	}
}

337 
asmlškage
 
	$sys_£Œeuid
(
uid_t
 
ruid
, uid_ˆ
euid
)

339 
Şd_ruid
 = 
cu¼’t
->
uid
;

341 ià(
ruid
 !ğ(
uid_t
) -1) {

342 ià((
cu¼’t
->
euid
==
ruid
) ||

343 (
Şd_ruid
 =ğ
ruid
) ||

344 
	`su£r
())

345 
cu¼’t
->
uid
 = 
ruid
;

347 (-
EPERM
);

349 ià(
euid
 !ğ(
uid_t
) -1) {

350 ià((
Şd_ruid
 =ğ
euid
) ||

351 (
cu¼’t
->
euid
 ==ƒuid) ||

352 
	`su£r
()) {

353 
cu¼’t
->
euid
 =ƒuid;

354 
cu¼’t
->
suid
 = 
euid
;

356 
cu¼’t
->
uid
 = 
Şd_ruid
;

357 (-
EPERM
);

361 
	}
}

374 
asmlškage
 
	$sys_£tuid
(
uid_t
 
uid
)

376 ià(
	`su£r
())

377 
cu¼’t
->
uid
 = cu¼’t->
euid
 = cu¼’t->
suid
 = uid;

378 ià((
uid
 =ğ
cu¼’t
->uidè|| (uid =ğcu¼’t->
suid
))

379 
cu¼’t
->
euid
 = 
uid
;

381  -
EPERM
;

383 
	}
}

385 
asmlškage
 
	$sys_times
(
tms
 * 
tbuf
)

387 ià(
tbuf
) {

388 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
tbuf
, *tbuf);

389 ià(
”rÜ
)

390  
”rÜ
;

391 
	`put_fs_lÚg
(
cu¼’t
->
utime
,(*)&
tbuf
->
tms_utime
);

392 
	`put_fs_lÚg
(
cu¼’t
->
¡ime
,(*)&
tbuf
->
tms_¡ime
);

393 
	`put_fs_lÚg
(
cu¼’t
->
cutime
,(*)&
tbuf
->
tms_cutime
);

394 
	`put_fs_lÚg
(
cu¼’t
->
c¡ime
,(*)&
tbuf
->
tms_c¡ime
);

396  
jiff›s
;

397 
	}
}

399 
asmlškage
 
	$sys_brk
(
brk
)

401 
ä“·ges
;

402 
¾im
;

403 
Ãwbrk
, 
Şdbrk
;

405 ià(
brk
 < 
cu¼’t
->
’d_code
)

406  
cu¼’t
->
brk
;

407 
Ãwbrk
 = 
	`PAGE_ALIGN
(
brk
);

408 
Şdbrk
 = 
	`PAGE_ALIGN
(
cu¼’t
->
brk
);

409 ià(
Şdbrk
 =ğ
Ãwbrk
)

410  
cu¼’t
->
brk
 = brk;

415 ià(
brk
 <ğ
cu¼’t
->brk) {

416 
cu¼’t
->
brk
 = brk;

417 
	`do_munm­
(
Ãwbrk
, 
Şdbrk
-newbrk);

418  
brk
;

423 
¾im
 = 
cu¼’t
->¾im[
RLIMIT_DATA
].
¾im_cur
;

424 ià(
¾im
 >ğ
RLIM_INFINITY
)

425 
¾im
 = ~0;

426 ià(
brk
 - 
cu¼’t
->
’d_code
 > 
¾im
 || brk >ğcu¼’t->
¡¬t_¡ack
 - 16384)

427  
cu¼’t
->
brk
;

433 
ä“·ges
 = 
bufãrmem
 >> 12;

434 
ä“·ges
 +ğ
Ä_ä“_·ges
;

435 
ä“·ges
 +ğ
Ä_sw­_·ges
;

436 
ä“·ges
 -ğ(
high_memÜy
 - 0x100000) >> 16;

437 
ä“·ges
 -ğ(
Ãwbrk
-
Şdbrk
) >> 12;

438 ià(
ä“·ges
 < 0)

439  
cu¼’t
->
brk
;

441 
ä“·ges
 +ğ
cu¼’t
->
rss
;

442 
ä“·ges
 -ğ
Şdbrk
 >> 12;

443 ià(
ä“·ges
 < 0)

444  
cu¼’t
->
brk
;

449 
cu¼’t
->
brk
 = brk;

450 
	`do_mm­
(
NULL
, 
Şdbrk
, 
Ãwbrk
-oldbrk,

451 
PROT_READ
|
PROT_WRITE
|
PROT_EXEC
,

452 
MAP_FIXED
|
MAP_PRIVATE
, 0);

453  
brk
;

454 
	}
}

468 
asmlškage
 
	$sys_£gid
(
pid_t
 
pid
,…id_ˆ
pgid
)

470 
sk_¡ruù
 * 
p
;

472 ià(!
pid
)

473 
pid
 = 
cu¼’t
->pid;

474 ià(!
pgid
)

475 
pgid
 = 
pid
;

476 ià(
pgid
 < 0)

477  -
EINVAL
;

478 
	`fÜ_—ch_sk
(
p
) {

479 ià(
p
->
pid
 ==…id)

480 
found_sk
;

482  -
ESRCH
;

484 
found_sk
:

485 ià(
p
->
p_µŒ
 =ğ
cu¼’t
 ||…->
p_İ±r
 == current) {

486 ià(
p
->
£ssiÚ
 !ğ
cu¼’t
->session)

487  -
EPERM
;

488 ià(
p
->
did_exec
)

489  -
EACCES
;

490 } ià(
p
 !ğ
cu¼’t
)

491  -
ESRCH
;

492 ià(
p
->
Ëad”
)

493  -
EPERM
;

494 ià(
pgid
 !ğ
pid
) {

495 
sk_¡ruù
 * 
tmp
;

496 
	`fÜ_—ch_sk
 (
tmp
) {

497 ià(
tmp
->
pg½
 =ğ
pgid
 &&

498 
tmp
->
£ssiÚ
 =ğ
cu¼’t
->session)

499 
ok_pgid
;

501  -
EPERM
;

504 
ok_pgid
:

505 
p
->
pg½
 = 
pgid
;

507 
	}
}

509 
asmlškage
 
	$sys_g‘pgid
(
pid_t
 
pid
)

511 
sk_¡ruù
 * 
p
;

513 ià(!
pid
)

514  
cu¼’t
->
pg½
;

515 
	`fÜ_—ch_sk
(
p
) {

516 ià(
p
->
pid
 ==…id)

517  
p
->
pg½
;

519  -
ESRCH
;

520 
	}
}

522 
asmlškage
 
	$sys_g‘pg½
()

524  
cu¼’t
->
pg½
;

525 
	}
}

527 
asmlškage
 
	$sys_£tsid
()

529 ià(
cu¼’t
->
Ëad”
)

530  -
EPERM
;

531 
cu¼’t
->
Ëad”
 = 1;

532 
cu¼’t
->
£ssiÚ
 = cu¼’t->
pg½
 = cu¼’t->
pid
;

533 
cu¼’t
->
‰y
 = -1;

534  
cu¼’t
->
pg½
;

535 
	}
}

540 
asmlškage
 
	$sys_g‘groups
(
gid£tsize
, 
gid_t
 *
grou¶i¡
)

542 
i
;

544 ià(
gid£tsize
) {

545 
i
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
grou¶i¡
, (
gid_t
è* 
gid£tsize
);

546 ià(
i
)

547  
i
;

549 
i
 = 0 ; (˜< 
NGROUPS
è&& (
cu¼’t
->
groups
[i] !ğ
NOGROUP
) ; i++) {

550 ià(!
gid£tsize
)

552 ià(
i
 >ğ
gid£tsize
)

554 
	`put_fs_wÜd
(
cu¼’t
->
groups
[
i
], (*è
grou¶i¡
);

555 
grou¶i¡
++;

557 (
i
);

558 
	}
}

560 
asmlškage
 
	$sys_£tgroups
(
gid£tsize
, 
gid_t
 *
grou¶i¡
)

562 
i
;

564 ià(!
	`su£r
())

565  -
EPERM
;

566 ià(
gid£tsize
 > 
NGROUPS
)

567  -
EINVAL
;

568 
i
 = 0; i < 
gid£tsize
; i++, 
grou¶i¡
++) {

569 
cu¼’t
->
groups
[
i
] = 
	`g‘_fs_wÜd
((*è
grou¶i¡
);

571 ià(
i
 < 
NGROUPS
)

572 
cu¼’t
->
groups
[
i
] = 
NOGROUP
;

574 
	}
}

576 
	$š_group_p
(
gid_t
 
g½
)

578 
i
;

580 ià(
g½
 =ğ
cu¼’t
->
egid
)

583 
i
 = 0; i < 
NGROUPS
; i++) {

584 ià(
cu¼’t
->
groups
[
i
] =ğ
NOGROUP
)

586 ià(
cu¼’t
->
groups
[
i
] =ğ
g½
)

590 
	}
}

592 
asmlškage
 
	$sys_ÃwuÇme
(
Ãw_ut¢ame
 * 
Çme
)

594 
”rÜ
;

596 ià(!
Çme
)

597  -
EFAULT
;

598 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
Çme
,  *name);

599 ià(!
”rÜ
)

600 
	`memıy_tofs
(
Çme
,&
sy¡em_ut¢ame
, *name);

601  
”rÜ
;

602 
	}
}

604 
asmlškage
 
	$sys_uÇme
(
Şd_ut¢ame
 * 
Çme
)

606 
”rÜ
;

607 ià(!
Çme
)

608  -
EFAULT
;

609 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
Çme
, *name);

610 ià(
”rÜ
)

611  
”rÜ
;

612 
	`memıy_tofs
(&
Çme
->
sy¢ame
,&
sy¡em_ut¢ame
.sysname,

613  (
sy¡em_ut¢ame
.
sy¢ame
));

614 
	`memıy_tofs
(&
Çme
->
nod’ame
,&
sy¡em_ut¢ame
.nodename,

615  (
sy¡em_ut¢ame
.
nod’ame
));

616 
	`memıy_tofs
(&
Çme
->
»Ëa£
,&
sy¡em_ut¢ame
.release,

617  (
sy¡em_ut¢ame
.
»Ëa£
));

618 
	`memıy_tofs
(&
Çme
->
v”siÚ
,&
sy¡em_ut¢ame
.version,

619  (
sy¡em_ut¢ame
.
v”siÚ
));

620 
	`memıy_tofs
(&
Çme
->
machše
,&
sy¡em_ut¢ame
.machine,

621  (
sy¡em_ut¢ame
.
machše
));

623 
	}
}

625 
asmlškage
 
	$sys_ŞduÇme
(
ŞdŞd_ut¢ame
 * 
Çme
)

627 
”rÜ
;

628 ià(!
Çme
)

629  -
EFAULT
;

630 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
Çme
, *name);

631 ià(
”rÜ
)

632  
”rÜ
;

633 
	`memıy_tofs
(&
Çme
->
sy¢ame
,&
sy¡em_ut¢ame
.sy¢ame,
__OLD_UTS_LEN
);

634 
	`put_fs_by‹
(0,
Çme
->
sy¢ame
+
__OLD_UTS_LEN
);

635 
	`memıy_tofs
(&
Çme
->
nod’ame
,&
sy¡em_ut¢ame
.nod’ame,
__OLD_UTS_LEN
);

636 
	`put_fs_by‹
(0,
Çme
->
nod’ame
+
__OLD_UTS_LEN
);

637 
	`memıy_tofs
(&
Çme
->
»Ëa£
,&
sy¡em_ut¢ame
.»Ëa£,
__OLD_UTS_LEN
);

638 
	`put_fs_by‹
(0,
Çme
->
»Ëa£
+
__OLD_UTS_LEN
);

639 
	`memıy_tofs
(&
Çme
->
v”siÚ
,&
sy¡em_ut¢ame
.v”siÚ,
__OLD_UTS_LEN
);

640 
	`put_fs_by‹
(0,
Çme
->
v”siÚ
+
__OLD_UTS_LEN
);

641 
	`memıy_tofs
(&
Çme
->
machše
,&
sy¡em_ut¢ame
.machše,
__OLD_UTS_LEN
);

642 
	`put_fs_by‹
(0,
Çme
->
machše
+
__OLD_UTS_LEN
);

644 
	}
}

649 
asmlškage
 
	$sys_£tho¡Çme
(*
Çme
, 
Ën
)

651 
i
;

653 ià(!
	`su£r
())

654  -
EPERM
;

655 ià(
Ën
 > 
__NEW_UTS_LEN
)

656  -
EINVAL
;

657 
i
=0; i < 
Ën
; i++) {

658 ià((
sy¡em_ut¢ame
.
nod’ame
[
i
] = 
	`g‘_fs_by‹
(
Çme
+i)) == 0)

661 
sy¡em_ut¢ame
.
nod’ame
[
i
] = 0;

663 
	}
}

669 
asmlškage
 
	$sys_£tdomašÇme
(*
Çme
, 
Ën
)

671 
i
;

673 ià(!
	`su£r
())

674  -
EPERM
;

675 ià(
Ën
 > 
__NEW_UTS_LEN
)

676  -
EINVAL
;

677 
i
=0; i < 
Ën
; i++) {

678 ià((
sy¡em_ut¢ame
.
domašÇme
[
i
] = 
	`g‘_fs_by‹
(
Çme
+i)) == 0)

681 
sy¡em_ut¢ame
.
domašÇme
[
i
] = 0;

683 
	}
}

685 
asmlškage
 
	$sys_g‘¾im™
(
»sourû
, 
¾im™
 *
¾im
)

687 
”rÜ
;

689 ià(
»sourû
 >ğ
RLIM_NLIMITS
)

690  -
EINVAL
;

691 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
¾im
, *rlim);

692 ià(
”rÜ
)

693  
”rÜ
;

694 
	`put_fs_lÚg
(
cu¼’t
->
¾im
[
»sourû
].
¾im_cur
,

695 (*è
¾im
);

696 
	`put_fs_lÚg
(
cu¼’t
->
¾im
[
»sourû
].
¾im_max
,

697 ((*è
¾im
)+1);

699 
	}
}

701 
asmlškage
 
	$sys_£Œlim™
(
»sourû
, 
¾im™
 *
¾im
)

703 
¾im™
 
Ãw_¾im
, *
Şd_¾im
;

705 ià(
»sourû
 >ğ
RLIM_NLIMITS
)

706  -
EINVAL
;

707 
Şd_¾im
 = 
cu¼’t
->
¾im
 + 
»sourû
;

708 
Ãw_¾im
.
¾im_cur
 = 
	`g‘_fs_lÚg
((*è
¾im
);

709 
Ãw_¾im
.
¾im_max
 = 
	`g‘_fs_lÚg
(((*è
¾im
)+1);

710 ià(((
Ãw_¾im
.
¾im_cur
 > 
Şd_¾im
->
¾im_max
) ||

711 (
Ãw_¾im
.
¾im_max
 > 
Şd_¾im
->rlim_max)) &&

712 !
	`su£r
())

713  -
EPERM
;

714 *
Şd_¾im
 = 
Ãw_¾im
;

716 
	}
}

726 
	$g‘ru§ge
(
sk_¡ruù
 *
p
, 
who
, 
ru§ge
 *
ru
)

728 
”rÜ
;

729 
ru§ge
 
r
;

730 *
Í
, *
Í’d
, *
de¡
;

732 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
ru
,  *ru);

733 ià(
”rÜ
)

734  
”rÜ
;

735 
	`mem£t
((*è&
r
, 0, (r));

736 
who
) {

737 
RUSAGE_SELF
:

738 
r
.
ru_utime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
utime
);

739 
r
.
ru_utime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
utime
);

740 
r
.
ru_¡ime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
¡ime
);

741 
r
.
ru_¡ime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
¡ime
);

742 
r
.
ru_mšæt
 = 
p
->
mš_æt
;

743 
r
.
ru_majæt
 = 
p
->
maj_æt
;

745 
RUSAGE_CHILDREN
:

746 
r
.
ru_utime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
cutime
);

747 
r
.
ru_utime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
cutime
);

748 
r
.
ru_¡ime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
c¡ime
);

749 
r
.
ru_¡ime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
c¡ime
);

750 
r
.
ru_mšæt
 = 
p
->
cmš_æt
;

751 
r
.
ru_majæt
 = 
p
->
cmaj_æt
;

754 
r
.
ru_utime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
utime
 +…->
cutime
);

755 
r
.
ru_utime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
utime
 +…->
cutime
);

756 
r
.
ru_¡ime
.
tv_£c
 = 
	`CT_TO_SECS
(
p
->
¡ime
 +…->
c¡ime
);

757 
r
.
ru_¡ime
.
tv_u£c
 = 
	`CT_TO_USECS
(
p
->
¡ime
 +…->
c¡ime
);

758 
r
.
ru_mšæt
 = 
p
->
mš_æt
 +…->
cmš_æt
;

759 
r
.
ru_majæt
 = 
p
->
maj_æt
 +…->
cmaj_æt
;

762 
Í
 = (*è&
r
;

763 
Í’d
 = (*è(&
r
+1);

764 
de¡
 = (*è
ru
;

765 ; 
Í
 < 
Í’d
;†p++, 
de¡
++)

766 
	`put_fs_lÚg
(*
Í
, 
de¡
);

768 
	}
}

770 
asmlškage
 
	$sys_g‘ru§ge
(
who
, 
ru§ge
 *
ru
)

772 ià(
who
 !ğ
RUSAGE_SELF
 && whØ!ğ
RUSAGE_CHILDREN
)

773  -
EINVAL
;

774  
	`g‘ru§ge
(
cu¼’t
, 
who
, 
ru
);

775 
	}
}

777 
asmlškage
 
	$sys_umask
(
mask
)

779 
Şd
 = 
cu¼’t
->
umask
;

781 
cu¼’t
->
umask
 = 
mask
 & 
S_IRWXUGO
;

782  (
Şd
);

783 
	}
}

	@kernel/time.c

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~<lšux/·¿m.h
>

24 
	~<lšux/¡ršg.h
>

26 
	~<asm/£gm’t.h
>

27 
	~<asm/io.h
>

29 
	~<lšux/mc146818¹c.h
>

30 
	#RTC_ALWAYS_BCD
 1

	)

32 
	~<lšux/timex.h
>

33 
timev®
 
xtime
;

35 
	~<lšux/mktime.h
>

36 
k”Ãl_mktime
(
mktime
 * 
time
);

38 
	$time_š™
()

40 
mktime
 
time
;

41 
i
;

49 
i
 = 0 ; i < 1000000 ; i++)

50 ià(
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
)

52 
i
 = 0 ; i < 1000000 ; i++)

53 ià(!(
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
))

56 
time
.
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

57 
time
.
mš
 = 
	`CMOS_READ
(
RTC_MINUTES
);

58 
time
.
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

59 
time
.
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

60 
time
.
mÚ
 = 
	`CMOS_READ
(
RTC_MONTH
);

61 
time
.
y—r
 = 
	`CMOS_READ
(
RTC_YEAR
);

62 } 
time
.
£c
 !ğ
	`CMOS_READ
(
RTC_SECONDS
));

63 ià(!(
	`CMOS_READ
(
RTC_CONTROL
è& 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
)

65 
	`BCD_TO_BIN
(
time
.
£c
);

66 
	`BCD_TO_BIN
(
time
.
mš
);

67 
	`BCD_TO_BIN
(
time
.
hour
);

68 
	`BCD_TO_BIN
(
time
.
day
);

69 
	`BCD_TO_BIN
(
time
.
mÚ
);

70 
	`BCD_TO_BIN
(
time
.
y—r
);

72 
time
.
mÚ
--;

73 
xtime
.
tv_£c
 = 
	`k”Ãl_mktime
(&
time
);

74 
	}
}

79 
timezÚe
 
	gsys_tz
 = { 0, 0};

81 
asmlškage
 
	$sys_time
(* 
oc
)

83 
i
, 
”rÜ
;

85 
i
 = 
CURRENT_TIME
;

86 ià(
oc
) {

87 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
oc
, 4);

88 ià(
”rÜ
)

89  
”rÜ
;

90 
	`put_fs_lÚg
(
i
,(*)
oc
);

92  
i
;

93 
	}
}

95 
asmlškage
 
	$sys_¡ime
(* 
Œ
)

97 ià(!
	`su£r
())

98  -
EPERM
;

99 
	`şi
();

100 
xtime
.
tv_£c
 = 
	`g‘_fs_lÚg
((*è
Œ
);

101 
xtime
.
tv_u£c
 = 0;

102 
time_¡©us
 = 
TIME_BAD
;

103 
time_max”rÜ
 = 0x70000000;

104 
time_e¡”rÜ
 = 0x70000000;

105 
	`¡i
();

107 
	}
}

141 
	#TICK_SIZE
 
tick


	)

143 
šlše
 
	$do_g‘timeoff£t
()

145 
couÁ
;

146 
off£t
 = 0;

149 
	`outb_p
(0x00, 0x43);

150 
couÁ
 = 
	`šb_p
(0x40);

151 
couÁ
 |ğ
	`šb
(0x40) << 8;

153 ià(
couÁ
 > (
LATCH
 - LATCH/100)) {

155 
	`outb_p
(0x0a, 0x20);

156 ià(
	`šb
(0x20) & 1)

157 
off£t
 = 
TICK_SIZE
;

159 
couÁ
 = ((
LATCH
-1è- couÁè* 
TICK_SIZE
;

160 
couÁ
 = (couÁ + 
LATCH
/2) / LATCH;

161  
off£t
 + 
couÁ
;

162 
	}
}

167 
šlše
 
	$do_g‘timeofday
(
timev®
 *
tv
)

169 #ifdeà
__i386__


170 
	`şi
();

171 *
tv
 = 
xtime
;

172 
tv
->
tv_u£c
 +ğ
	`do_g‘timeoff£t
();

173 ià(
tv
->
tv_u£c
 >= 1000000) {

174 
tv
->
tv_u£c
 -= 1000000;

175 
tv
->
tv_£c
++;

177 
	`¡i
();

179 
	`şi
();

180 *
tv
 = 
xtime
;

181 
	`¡i
();

183 
	}
}

185 
asmlškage
 
	$sys_g‘timeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

187 
”rÜ
;

189 ià(
tv
) {

190 
timev®
 
ktv
;

191 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
tv
,  *tv);

192 ià(
”rÜ
)

193  
”rÜ
;

194 
	`do_g‘timeofday
(&
ktv
);

195 
	`put_fs_lÚg
(
ktv
.
tv_£c
, (*è&
tv
->tv_sec);

196 
	`put_fs_lÚg
(
ktv
.
tv_u£c
, (*è&
tv
->tv_usec);

198 ià(
tz
) {

199 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
tz
,  *tz);

200 ià(
”rÜ
)

201  
”rÜ
;

202 
	`put_fs_lÚg
(
sys_tz
.
tz_mšu‹swe¡
, (*è
tz
);

203 
	`put_fs_lÚg
(
sys_tz
.
tz_d¡time
, ((*è
tz
)+1);

206 
	}
}

224 
šlše
 
	$w¬p_şock
()

226 
	`şi
();

227 
xtime
.
tv_£c
 +ğ
sys_tz
.
tz_mšu‹swe¡
 * 60;

228 
	`¡i
();

229 
	}
}

240 
asmlškage
 
	$sys_£‰imeofday
(
timev®
 *
tv
, 
timezÚe
 *
tz
)

242 
fœ¡time
 = 1;

244 ià(!
	`su£r
())

245  -
EPERM
;

246 ià(
tz
) {

247 
sys_tz
.
tz_mšu‹swe¡
 = 
	`g‘_fs_lÚg
((*è
tz
);

248 
sys_tz
.
tz_d¡time
 = 
	`g‘_fs_lÚg
(((*è
tz
)+1);

249 ià(
fœ¡time
) {

250 
fœ¡time
 = 0;

251 ià(!
tv
)

252 
	`w¬p_şock
();

255 ià(
tv
) {

256 
£c
, 
u£c
;

258 
£c
 = 
	`g‘_fs_lÚg
((*)
tv
);

259 
u£c
 = 
	`g‘_fs_lÚg
(((*)
tv
)+1);

261 
	`şi
();

268 
u£c
 -ğ
	`do_g‘timeoff£t
();

270 ià(
u£c
 < 0)

272 
u£c
 += 1000000;

273 
£c
--;

275 
xtime
.
tv_£c
 = 
£c
;

276 
xtime
.
tv_u£c
 = 
u£c
;

277 
time_¡©us
 = 
TIME_BAD
;

278 
time_max”rÜ
 = 0x70000000;

279 
time_e¡”rÜ
 = 0x70000000;

280 
	`¡i
();

283 
	}
}

288 
asmlškage
 
	$sys_adjtimex
(
timex
 *
txc_p
)

290 
Éemp
, 
m‹mp
, 
§ve_adju¡
;

291 
”rÜ
;

294 
timex
 
txc
;

296 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
txc_p
, (
timex
));

297 ià(
”rÜ
)

298  
”rÜ
;

304 
	`memıy_äomfs
(&
txc
, 
txc_p
, (
timex
));

307 ià(
txc
.
mode
 && !
	`su£r
())

308  -
EPERM
;

313 ià(
txc
.
mode
 & 
ADJ_OFFSET
)

315 ià(
txc
.
off£t
 <ğ-(1 << (31 - 
SHIFT_UPDATE
))

316 || 
txc
.
off£t
 >ğ(1 << (31 - 
SHIFT_UPDATE
)))

317  -
EINVAL
;

320 ià(
txc
.
mode
 & 
ADJ_STATUS
)

321 ià(
txc
.
¡©us
 < 
TIME_OK
 ||xc.¡©u > 
TIME_BAD
)

322  -
EINVAL
;

325 ià(
txc
.
mode
 & 
ADJ_TICK
)

326 ià(
txc
.
tick
 < 900000/
HZ
 ||xc.tick > 1100000/HZ)

327  -
EINVAL
;

329 
	`şi
();

332 
§ve_adju¡
 = 
time_adju¡
;

335 ià(
txc
.
mode
)

337 ià(
time_¡©us
 =ğ
TIME_BAD
)

338 
time_¡©us
 = 
TIME_OK
;

340 ià(
txc
.
mode
 & 
ADJ_STATUS
)

341 
time_¡©us
 = 
txc
.
¡©us
;

343 ià(
txc
.
mode
 & 
ADJ_FREQUENCY
)

344 
time_äeq
 = 
txc
.
äequ’cy
 << (
SHIFT_KF
 - 16);

346 ià(
txc
.
mode
 & 
ADJ_MAXERROR
)

347 
time_max”rÜ
 = 
txc
.
max”rÜ
;

349 ià(
txc
.
mode
 & 
ADJ_ESTERROR
)

350 
time_e¡”rÜ
 = 
txc
.
e¡”rÜ
;

352 ià(
txc
.
mode
 & 
ADJ_TIMECONST
)

353 
time_cÚ¡ªt
 = 
txc
.time_constant;

355 ià(
txc
.
mode
 & 
ADJ_OFFSET
)

356 ià(
txc
.
mode
 =ğ
ADJ_OFFSET_SINGLESHOT
)

358 
time_adju¡
 = 
txc
.
off£t
;

362 
time_off£t
 = 
txc
.
off£t
 << 
SHIFT_UPDATE
;

363 
m‹mp
 = 
xtime
.
tv_£c
 - 
time_»áime
;

364 
time_»áime
 = 
xtime
.
tv_£c
;

365 ià(
m‹mp
 > (
MAXSEC
+2) || mtemp < 0)

366 
m‹mp
 = 0;

368 ià(
txc
.
off£t
 < 0)

369 
time_äeq
 -ğ(-
txc
.
off£t
 * 
m‹mp
) >>

370 (
time_cÚ¡ªt
 +ime_constant);

372 
time_äeq
 +ğ(
txc
.
off£t
 * 
m‹mp
) >>

373 (
time_cÚ¡ªt
 +ime_constant);

375 
Éemp
 = 
time_tŞ”ªû
 << 
SHIFT_KF
;

377 ià(
time_äeq
 > 
Éemp
)

378 
time_äeq
 = 
Éemp
;

379 ià(
time_äeq
 < -
Éemp
)

380 
time_äeq
 = -
Éemp
;

382 ià(
txc
.
mode
 & 
ADJ_TICK
)

383 
tick
 = 
txc
.tick;

386 
txc
.
off£t
 = 
§ve_adju¡
;

387 
txc
.
äequ’cy
 = ((
time_äeq
+1è>> (
SHIFT_KF
 - 16));

388 
txc
.
max”rÜ
 = 
time_max”rÜ
;

389 
txc
.
e¡”rÜ
 = 
time_e¡”rÜ
;

390 
txc
.
¡©us
 = 
time_¡©us
;

391 
txc
.
time_cÚ¡ªt
 =ime_constant;

392 
txc
.
´ecisiÚ
 = 
time_´ecisiÚ
;

393 
txc
.
tŞ”ªû
 = 
time_tŞ”ªû
;

394 
txc
.
time
 = 
xtime
;

395 
txc
.
tick
 =ick;

397 
	`¡i
();

399 
	`memıy_tofs
(
txc_p
, &
txc
, (
timex
));

400  
time_¡©us
;

401 
	}
}

403 
	$£t_¹c_mmss
(
nowtime
)

405 
»tv®
 = 0;

406 
»®_£cÚds
 = 
nowtime
 % 60, 
»®_mšu‹s
 = (nowtime / 60) % 60;

407 
§ve_cÚŒŞ
, 
§ve_äeq_£Ëù
, 
cmos_mšu‹s
;

409 
§ve_cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

410 
	`CMOS_WRITE
((
§ve_cÚŒŞ
|
RTC_SET
), 
RTC_CONTROL
);

412 
§ve_äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

413 
	`CMOS_WRITE
((
§ve_äeq_£Ëù
|
RTC_DIV_RESET2
), 
RTC_FREQ_SELECT
);

415 
cmos_mšu‹s
 = 
	`CMOS_READ
(
RTC_MINUTES
);

416 ià(!(
§ve_cÚŒŞ
 & 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
)

417 
	`BCD_TO_BIN
(
cmos_mšu‹s
);

424 ià(((
cmos_mšu‹s
 < 
»®_mšu‹s
) ?

425 (
»®_mšu‹s
 - 
cmos_mšu‹s
) :

426 (
cmos_mšu‹s
 - 
»®_mšu‹s
)) < 30)

428 ià(!(
§ve_cÚŒŞ
 & 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
)

430 
	`BIN_TO_BCD
(
»®_£cÚds
);

431 
	`BIN_TO_BCD
(
»®_mšu‹s
);

433 
	`CMOS_WRITE
(
»®_£cÚds
,
RTC_SECONDS
);

434 
	`CMOS_WRITE
(
»®_mšu‹s
,
RTC_MINUTES
);

437 
»tv®
 = -1;

439 
	`CMOS_WRITE
(
§ve_äeq_£Ëù
, 
RTC_FREQ_SELECT
);

440 
	`CMOS_WRITE
(
§ve_cÚŒŞ
, 
RTC_CONTROL
);

441  
»tv®
;

442 
	}
}

	@kernel/traps.c

13 
	~<lšux/h—d.h
>

14 
	~<lšux/sched.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/£gm’t.h
>

19 
	~<lšux/±¿û.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/£gm’t.h
>

23 
	~<asm/io.h
>

25 
šlše
 
	$cÚsŞe_v”bo£
()

27 
cÚsŞe_logËv–
;

28 
cÚsŞe_logËv–
 = 15;

29 
	}
}

31 
	#DO_ERROR
(
Œ­Ä
, 
sigÄ
, 
¡r
, 
Çme
, 
tsk
) \

32 
asmlškage
 
do_
##
	`Çme
(
±_»gs
 * 
»gs
, 
”rÜ_code
) \

34 
tsk
->
tss
.
”rÜ_code
 =ƒrror_code; \

35 
tsk
->
tss
.
Œ­_no
 = 
Œ­Ä
; \

36 ià(
sigÄ
 =ğ
SIGTRAP
 && 
cu¼’t
->
æags
 & 
PF_PTRACED
) \

37 
cu¼’t
->
blocked
 &ğ~(1 << (
SIGTRAP
-1)); \

38 
	`£nd_sig
(
sigÄ
, 
tsk
, 1); \

39 
	`d›_if_k”Ãl
(
¡r
,
»gs
,
”rÜ_code
); \

40 }

	)

42 
	#g‘_£g_by‹
(
£g
,
addr
) ({ \

43 
__»s
; \

44 
	`__asm__
("push %%fs;mov %%ax,%%fs;movb %%fs:%2,%%al;pop %%fs" \

45 :"÷" (
__»s
):"0" (
£g
),"m" (*(
addr
))); \

46 
__»s
;})

	)

48 
	#g‘_£g_lÚg
(
£g
,
addr
) ({ \

49 
__»s
; \

50 
	`__asm__
("push %%fs;mov %%ax,%%fs;movl %%fs:%2,%%eax;pop %%fs" \

51 :"÷" (
__»s
):"0" (
£g
),"m" (*(
addr
))); \

52 
__»s
;})

	)

54 
	#_fs
() ({ \

55 
__»s
; \

56 
	`__asm__
("mov %%fs,%%ax":"÷" (
__»s
):); \

57 
__»s
;})

	)

59 
·ge_exû±iÚ
();

61 
asmlškage
 
divide_”rÜ
();

62 
asmlškage
 
debug
();

63 
asmlškage
 
nmi
();

64 
asmlškage
 
št3
();

65 
asmlškage
 
ov”æow
();

66 
asmlškage
 
bounds
();

67 
asmlškage
 
šv®id_İ
();

68 
asmlškage
 
deviû_nÙ_avaabË
();

69 
asmlškage
 
doubË_çuÉ
();

70 
asmlškage
 
cİroûssÜ_£gm’t_ov”run
();

71 
asmlškage
 
šv®id_TSS
();

72 
asmlškage
 
£gm’t_nÙ_´e£Á
();

73 
asmlškage
 
¡ack_£gm’t
();

74 
asmlškage
 
g’”®_´ÙeùiÚ
();

75 
asmlškage
 
·ge_çuÉ
();

76 
asmlškage
 
cİroûssÜ_”rÜ
();

77 
asmlškage
 
»£rved
();

78 
asmlškage
 
®ignm’t_check
();

80  
	$d›_if_k”Ãl
(* 
¡r
, 
±_»gs
 * 
»gs
, 
”r
)

82 
i
;

83 
e¥
;

84 
ss
;

86 
e¥
 = (è&
»gs
->esp;

87 
ss
 = 
KERNEL_DS
;

88 ià((
»gs
->
eæags
 & 
VM_MASK
è|| (3 &„egs->
cs
) == 3)

90 ià(
»gs
->
cs
 & 3) {

91 
e¥
 = 
»gs
->esp;

92 
ss
 = 
»gs
->ss;

94 
	`cÚsŞe_v”bo£
();

95 
	`´štk
("%s: %04lx\n", 
¡r
, 
”r
 & 0xffff);

96 
	`´štk
("EIP: %04x:%08lx\nEFLAGS: %08lx\n", 0xfffà& 
»gs
->
cs
,»gs->
e
,»gs->
eæags
);

97 
	`´štk
("eax: %08lxƒbx: %08lxƒcx: %08lxƒdx: %08lx\n",

98 
»gs
->
—x
,„egs->
ebx
,„egs->
ecx
,„egs->
edx
);

99 
	`´štk
("esi: %08lxƒdi: %08lxƒbp: %08lxƒsp: %08lx\n",

100 
»gs
->
esi
,„egs->
edi
,„egs->
ebp
, 
e¥
);

101 
	`´štk
("ds: %04xƒs: %04x fs: %04x gs: %04x ss: %04x\n",

102 
»gs
->
ds
,„egs->
es
,„egs->
fs
,„egs->
gs
, 
ss
);

103 
	`¡Üe_TR
(
i
);

104 
	`´štk
("Pid: %d,…roûs Ä: %d (%s)\nSck: ", 
cu¼’t
->
pid
, 0xfffà& 
i
, cu¼’t->
comm
);

105 
i
=0;i<5;i++)

106 
	`´štk
("%08lx ", 
	`g‘_£g_lÚg
(
ss
,(
i
+(*)
e¥
)));

107 
	`´štk
("\nCode: ");

108 
i
=0;i<20;i++)

109 
	`´štk
("%02x ",0xfà& 
	`g‘_£g_by‹
(
»gs
->
cs
,(
i
+(*ìegs->
e
)));

110 
	`´štk
("\n");

111 
	`do_ex™
(
SIGSEGV
);

112 
	}
}

114 
DO_ERROR
Ğ0, 
SIGFPE
, "divid”rÜ", 
divide_”rÜ
, 
cu¼’t
)

115 
DO_ERROR
Ğ3, 
SIGTRAP
, "št3", 
št3
, 
cu¼’t
)

116 
DO_ERROR
Ğ4, 
SIGSEGV
, "ov”æow", 
ov”æow
, 
cu¼’t
)

117 
DO_ERROR
Ğ5, 
SIGSEGV
, "bounds", 
bounds
, 
cu¼’t
)

118 
DO_ERROR
Ğ6, 
SIGILL
, "šv®id o³¿nd", 
šv®id_İ
, 
cu¼’t
)

119 
DO_ERROR
Ğ7, 
SIGSEGV
, "deviû‚Ù‡vaabË", 
deviû_nÙ_avaabË
, 
cu¼’t
)

120 
DO_ERROR
Ğ8, 
SIGSEGV
, "doubË fauÉ", 
doubË_çuÉ
, 
cu¼’t
)

121 
DO_ERROR
Ğ9, 
SIGFPE
, "cİroûssÜ segm’ˆov”run", 
cİroûssÜ_£gm’t_ov”run
, 
Ï¡_sk_u£d_m©h
)

122 
DO_ERROR
(10, 
SIGSEGV
, "šv®id TSS", 
šv®id_TSS
, 
cu¼’t
)

123 
DO_ERROR
(11, 
SIGSEGV
, "£gm’ˆnÙ…»£Á", 
£gm’t_nÙ_´e£Á
, 
cu¼’t
)

124 
DO_ERROR
(12, 
SIGSEGV
, "¡ack segm’t", 
¡ack_£gm’t
, 
cu¼’t
)

125 
DO_ERROR
(13, 
SIGSEGV
, "g’”®…rÙeùiÚ", 
g’”®_´ÙeùiÚ
, 
cu¼’t
)

126 
DO_ERROR
(15, 
SIGSEGV
, "»£rved", 
»£rved
, 
cu¼’t
)

127 
DO_ERROR
(17, 
SIGSEGV
, "®ignm’ˆcheck", 
®ignm’t_check
, 
cu¼’t
)

129 
asmlškage
 
	$do_nmi
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

131 
	`´štk
("Uhhuh. NMI„eceived. Dazed‡nd confused, butryingo continue\n");

132 
	`´štk
("You…robably have‡ hardware…roblem with your RAM chips\n");

133 
	}
}

135 
asmlškage
 
	$do_debug
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

137 ià(
cu¼’t
->
æags
 & 
PF_PTRACED
)

138 
cu¼’t
->
blocked
 &ğ~(1 << (
SIGTRAP
-1));

139 
	`£nd_sig
(
SIGTRAP
, 
cu¼’t
, 1);

140 
cu¼’t
->
tss
.
Œ­_no
 = 1;

141 
cu¼’t
->
tss
.
”rÜ_code
 =ƒrror_code;

142 if((
»gs
->
cs
 & 3) == 0) {

144 
	`__asm__
("movl $0,%%edx\n\t" \

151 
	`d›_if_k”Ãl
("debug",
»gs
,
”rÜ_code
);

152 
	}
}

169 
	$m©h_”rÜ
()

171 
i387_h¬d_¡ruù
 * 
’v
;

173 
	`şts
();

174 ià(!
Ï¡_sk_u£d_m©h
) {

175 
	`__asm__
("fnclex");

178 
’v
 = &
Ï¡_sk_u£d_m©h
->
tss
.
i387
.
h¬d
;

179 
	`£nd_sig
(
SIGFPE
, 
Ï¡_sk_u£d_m©h
, 1);

180 
Ï¡_sk_u£d_m©h
->
tss
.
Œ­_no
 = 16;

181 
Ï¡_sk_u£d_m©h
->
tss
.
”rÜ_code
 = 0;

182 
__asm__
 
	`__vŞ©e__
("â§v%0":"=m" (*
’v
));

183 
Ï¡_sk_u£d_m©h
 = 
NULL
;

184 
	`¡ts
();

185 
’v
->
fcs
 = (’v->
swd
 & 0x0000ffff) | (env->fcs & 0xffff0000);

186 
’v
->
fos
 =ƒnv->
twd
;

187 
’v
->
swd
 &= 0xffff3800;

188 
’v
->
twd
 = 0xffffffff;

189 
	}
}

191 
asmlškage
 
	$do_cİroûssÜ_”rÜ
(
±_»gs
 * 
»gs
, 
”rÜ_code
)

193 
ignÜe_œq13
 = 1;

194 
	`m©h_”rÜ
();

195 
	}
}

197 
	$Œ­_š™
()

199 
i
;

201 
	`£t_Œ­_g©e
(0,&
divide_”rÜ
);

202 
	`£t_Œ­_g©e
(1,&
debug
);

203 
	`£t_Œ­_g©e
(2,&
nmi
);

204 
	`£t_sy¡em_g©e
(3,&
št3
);

205 
	`£t_sy¡em_g©e
(4,&
ov”æow
);

206 
	`£t_sy¡em_g©e
(5,&
bounds
);

207 
	`£t_Œ­_g©e
(6,&
šv®id_İ
);

208 
	`£t_Œ­_g©e
(7,&
deviû_nÙ_avaabË
);

209 
	`£t_Œ­_g©e
(8,&
doubË_çuÉ
);

210 
	`£t_Œ­_g©e
(9,&
cİroûssÜ_£gm’t_ov”run
);

211 
	`£t_Œ­_g©e
(10,&
šv®id_TSS
);

212 
	`£t_Œ­_g©e
(11,&
£gm’t_nÙ_´e£Á
);

213 
	`£t_Œ­_g©e
(12,&
¡ack_£gm’t
);

214 
	`£t_Œ­_g©e
(13,&
g’”®_´ÙeùiÚ
);

215 
	`£t_Œ­_g©e
(14,&
·ge_çuÉ
);

216 
	`£t_Œ­_g©e
(15,&
»£rved
);

217 
	`£t_Œ­_g©e
(16,&
cİroûssÜ_”rÜ
);

218 
	`£t_Œ­_g©e
(17,&
®ignm’t_check
);

219 
i
=18;i<48;i++)

220 
	`£t_Œ­_g©e
(
i
,&
»£rved
);

221 
	}
}

	@kernel/vsprintf.c

12 
	~<¡d¬g.h
>

13 
	~<lšux/ty³s.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/ùy³.h
>

17 
	$sim¶e_¡¹oul
(cÚ¡ *
ı
,**
’dp
,
ba£
)

19 
»suÉ
 = 0,
v®ue
;

21 ià(!
ba£
) {

22 
ba£
 = 10;

23 ià(*
ı
 == '0') {

24 
ba£
 = 8;

25 
ı
++;

26 ià((*
ı
 =ğ'x'è&& 
	`isxdig™
(cp[1])) {

27 
ı
++;

28 
ba£
 = 16;

32 
	`isxdig™
(*
ı
è&& (
v®ue
 = 
	`isdig™
(*ıè? *ı-'0' : (
	`i¦ow”
(*cp)

33 ? 
	`touµ”
(*
ı
è: *ı)-'A'+10è< 
ba£
) {

34 
»suÉ
 =„esuÉ*
ba£
 + 
v®ue
;

35 
ı
++;

37 ià(
’dp
)

38 *
’dp
 = (*)
ı
;

39  
»suÉ
;

40 
	}
}

43 
	#is_dig™
(
c
è((cè>ğ'0' && (cè<ğ'9')

	)

45 
	$sk_©oi
(cÚ¡ **
s
)

47 
i
=0;

49 
	`is_dig™
(**
s
))

50 
i
 = i*10 + *((*
s
)++) - '0';

51  
i
;

52 
	}
}

54 
	#ZEROPAD
 1

	)

55 
	#SIGN
 2

	)

56 
	#PLUS
 4

	)

57 
	#SPACE
 8

	)

58 
	#LEFT
 16

	)

59 
	#SPECIAL
 32

	)

60 
	#SMALL
 64

	)

62 
	#do_div
(
n
,
ba£
) ({ \

63 
__»s
; \

64 
	`__asm__
("divÈ%4":"÷" (
n
),"=d" (
__»s
):"0" (n),"1" (0),"r" (
ba£
)); \

65 
__»s
; })

	)

67 * 
	$numb”
(* 
¡r
, 
num
, 
ba£
, 
size
, 
´ecisiÚ


68 ,
ty³
)

70 
c
,
sign
,
tmp
[36];

71 cÚ¡ *
dig™s
="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

72 
i
;

74 ià(
ty³
&
SMALL
è
dig™s
="0123456789abcdefghijklmnopqrstuvwxyz";

75 ià(
ty³
&
LEFT
èty³ &ğ~
ZEROPAD
;

76 ià(
ba£
<2 || base>36)

78 
c
 = (
ty³
 & 
ZEROPAD
) ? '0' : ' ' ;

79 ià(
ty³
&
SIGN
 && 
num
<0) {

80 
sign
='-';

81 
num
 = -num;

83 
sign
=(
ty³
&
PLUS
è? '+' : (Ñy³&
SPACE
) ? ' ' : 0);

84 ià(
sign
è
size
--;

85 ià(
ty³
&
SPECIAL
)

86 ià(
ba£
==16è
size
 -= 2;

87 ià(
ba£
==8è
size
--;

88 
i
=0;

89 ià(
num
==0)

90 
tmp
[
i
++]='0';

91 
num
!=0)

92 
tmp
[
i
++]=
dig™s
[
	`do_div
(
num
,
ba£
)];

93 ià(
i
>
´ecisiÚ
)…recision=i;

94 
size
 -ğ
´ecisiÚ
;

95 ià(!(
ty³
&(
ZEROPAD
+
LEFT
)))

96 
size
-->0)

97 *
¡r
++ = ' ';

98 ià(
sign
)

99 *
¡r
++ = 
sign
;

100 ià(
ty³
&
SPECIAL
)

101 ià(
ba£
==8)

102 *
¡r
++ = '0';

103 ià(
ba£
==16) {

104 *
¡r
++ = '0';

105 *
¡r
++ = 
dig™s
[33];

107 ià(!(
ty³
&
LEFT
))

108 
size
-->0)

109 *
¡r
++ = 
c
;

110 
i
<
´ecisiÚ
--)

111 *
¡r
++ = '0';

112 
i
-->0)

113 *
¡r
++ = 
tmp
[
i
];

114 
size
-->0)

115 *
¡r
++ = ' ';

116  
¡r
;

117 
	}
}

119 
	$v¥rštf
(*
buf
, cÚ¡ *
fmt
, 
va_li¡
 
¬gs
)

121 
Ën
;

122 
i
;

123 * 
¡r
;

124 *
s
;

125 *

;

127 
æags
;

129 
f›ld_width
;

130 
´ecisiÚ
;

132 
qu®if›r
;

134 
¡r
=
buf
 ; *
fmt
 ; ++fmt) {

135 ià(*
fmt
 != '%') {

136 *
¡r
++ = *
fmt
;

141 
æags
 = 0;

142 
»³©
:

143 ++
fmt
;

144 *
fmt
) {

145 '-': 
æags
 |ğ
LEFT
; 
»³©
;

146 '+': 
æags
 |ğ
PLUS
; 
»³©
;

147 ' ': 
æags
 |ğ
SPACE
; 
»³©
;

148 '#': 
æags
 |ğ
SPECIAL
; 
»³©
;

149 '0': 
æags
 |ğ
ZEROPAD
; 
»³©
;

153 
f›ld_width
 = -1;

154 ià(
	`is_dig™
(*
fmt
))

155 
f›ld_width
 = 
	`sk_©oi
(&
fmt
);

156 ià(*
fmt
 == '*') {

158 
f›ld_width
 = 
	`va_¬g
(
¬gs
, );

159 ià(
f›ld_width
 < 0) {

160 
f›ld_width
 = -field_width;

161 
æags
 |ğ
LEFT
;

166 
´ecisiÚ
 = -1;

167 ià(*
fmt
 == '.') {

168 ++
fmt
;

169 ià(
	`is_dig™
(*
fmt
))

170 
´ecisiÚ
 = 
	`sk_©oi
(&
fmt
);

171 ià(*
fmt
 == '*') {

173 
´ecisiÚ
 = 
	`va_¬g
(
¬gs
, );

175 ià(
´ecisiÚ
 < 0)

176 
´ecisiÚ
 = 0;

180 
qu®if›r
 = -1;

181 ià(*
fmt
 == 'h' || *fmt == 'l' || *fmt == 'L') {

182 
qu®if›r
 = *
fmt
;

183 ++
fmt
;

186 *
fmt
) {

188 ià(!(
æags
 & 
LEFT
))

189 --
f›ld_width
 > 0)

190 *
¡r
++ = ' ';

191 *
¡r
++ = (è
	`va_¬g
(
¬gs
, );

192 --
f›ld_width
 > 0)

193 *
¡r
++ = ' ';

197 
s
 = 
	`va_¬g
(
¬gs
, *);

198 ià(!
s
)

199 
s
 = "<NULL>";

200 
Ën
 = 
	`¡¾’
(
s
);

201 ià(
´ecisiÚ
 < 0)

202 
´ecisiÚ
 = 
Ën
;

203 ià(
Ën
 > 
´ecisiÚ
)

204 
Ën
 = 
´ecisiÚ
;

206 ià(!(
æags
 & 
LEFT
))

207 
Ën
 < 
f›ld_width
--)

208 *
¡r
++ = ' ';

209 
i
 = 0; i < 
Ën
; ++i)

210 *
¡r
++ = *
s
++;

211 
Ën
 < 
f›ld_width
--)

212 *
¡r
++ = ' ';

216 
¡r
 = 
	`numb”
(¡r, 
	`va_¬g
(
¬gs
, ), 8,

217 
f›ld_width
, 
´ecisiÚ
, 
æags
);

221 ià(
f›ld_width
 == -1) {

222 
f›ld_width
 = 8;

223 
æags
 |ğ
ZEROPAD
;

225 
¡r
 = 
	`numb”
(str,

226 (è
	`va_¬g
(
¬gs
, *), 16,

227 
f›ld_width
, 
´ecisiÚ
, 
æags
);

231 
æags
 |ğ
SMALL
;

233 
¡r
 = 
	`numb”
(¡r, 
	`va_¬g
(
¬gs
, ), 16,

234 
f›ld_width
, 
´ecisiÚ
, 
æags
);

239 
æags
 |ğ
SIGN
;

241 
¡r
 = 
	`numb”
(¡r, 
	`va_¬g
(
¬gs
, ), 10,

242 
f›ld_width
, 
´ecisiÚ
, 
æags
);

246 

 = 
	`va_¬g
(
¬gs
, *);

247 *

 = (
¡r
 - 
buf
);

251 ià(*
fmt
 != '%')

252 *
¡r
++ = '%';

253 ià(*
fmt
)

254 *
¡r
++ = *
fmt
;

256 --
fmt
;

260 *
¡r
 = '\0';

261  
¡r
-
buf
;

262 
	}
}

264 
	$¥rštf
(* 
buf
, cÚ¡ *
fmt
, ...)

266 
va_li¡
 
¬gs
;

267 
i
;

269 
	`va_¡¬t
(
¬gs
, 
fmt
);

270 
i
=
	`v¥rštf
(
buf
,
fmt
,
¬gs
);

271 
	`va_’d
(
¬gs
);

272  
i
;

273 
	}
}

	@lib/_exit.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

10 vŞ©
	$_ex™
(
ex™_code
)

12 
çke_vŞ©e
:

13 
	`__asm__
("movl %1,%%ebx\n\t"

16 :"a" (
__NR_ex™
),"g" (
ex™_code
));

17 
çke_vŞ©e
;

18 
	}
}

	@lib/close.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

10 
_sysÿÎ1
(,
şo£
,,
fd
)

	@lib/ctype.c

7 
	~<lšux/ùy³.h
>

9 
	g_ùmp
;

10 
	g_ùy³
[] = {0x00,

11 
_C
,_C,_C,_C,_C,_C,_C,_C,

12 
_C
,_C|
_S
,_C|_S,_C|_S,_C|_S,_C|_S,_C,_C,

13 
_C
,_C,_C,_C,_C,_C,_C,_C,

14 
_C
,_C,_C,_C,_C,_C,_C,_C,

15 
_S
|
_SP
,
_P
,_P,_P,_P,_P,_P,_P,

16 
_P
,_P,_P,_P,_P,_P,_P,_P,

17 
_D
,_D,_D,_D,_D,_D,_D,_D,

18 
_D
,_D,
_P
,_P,_P,_P,_P,_P,

19 
_P
,
_U
|
_X
,_U|_X,_U|_X,_U|_X,_U|_X,_U|_X,_U,

20 
_U
,_U,_U,_U,_U,_U,_U,_U,

21 
_U
,_U,_U,_U,_U,_U,_U,_U,

22 
_U
,_U,_U,
_P
,_P,_P,_P,_P,

23 
_P
,
_L
|
_X
,_L|_X,_L|_X,_L|_X,_L|_X,_L|_X,_L,

24 
_L
,_L,_L,_L,_L,_L,_L,_L,

25 
_L
,_L,_L,_L,_L,_L,_L,_L,

26 
_L
,_L,_L,
_P
,_P,_P,_P,
_C
,

	@lib/dup.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

10 
_sysÿÎ1
(,
dup
,,
fd
)

	@lib/errno.c

7 
	g”ºo
;

	@lib/execve.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

10 
_sysÿÎ3
(,
execve
,cÚ¡ *,
fe
,**,
¬gv
,**,
’vp
)

	@lib/malloc.c

64 
	~<lšux/k”Ãl.h
>

65 
	~<lšux/mm.h
>

66 
	~<lšux/¡ršg.h
>

67 
	~<lšux/m®loc.h
>

69 
	~<asm/sy¡em.h
>

71 
	sbuck‘_desc
 {

72 *
	m·ge
;

73 
buck‘_desc
 *
	mÃxt
;

74 *
	mä“±r
;

75 
	m»fút
;

76 
	mbuck‘_size
;

79 
	s_buck‘_dœ
 {

80 
	msize
;

81 
buck‘_desc
 *
	mchaš
;

84 #ifdeà
CONFIG_DEBUG_MALLOC


86 
	shdr_¡¬t
 {

87 cÚ¡ *
	mfe
;

88 cÚ¡ *
	mok_fe
;

89 
	mlše
;

90 
	mok_lše
;

91 
	msize
;

92 
	mmagic
;

94 
	shdr_’d
 {

95 
	mmagic
;

98 
	#DEB_MAGIC_FREE
 0x13579BDF

	)

99 
	#DEB_MAGIC_ALLOC
 0x2468ACE0

	)

100 
	#DEB_MAGIC_USED
 0x147AD036

	)

101 
	#DEB_MAGIC_FREED
 0x258BE169

	)

103 
	#DEB_MAGIC_END
 0x369CF258

	)

118 
_buck‘_dœ
 
	gbuck‘_dœ
[] = {

119 #iâdeà
CONFIG_DEBUG_MALLOC


120 { 16, (
buck‘_desc
 *) 0},

122 { 32, (
buck‘_desc
 *) 0},

123 { 64, (
buck‘_desc
 *) 0},

124 { 128, (
buck‘_desc
 *) 0},

125 { 256, (
buck‘_desc
 *) 0},

126 { 512, (
buck‘_desc
 *) 0},

127 { 1024, (
buck‘_desc
 *) 0},

128 { 2048, (
buck‘_desc
 *) 0},

129 { 4096, (
buck‘_desc
 *) 0},

130 { 0, (
buck‘_desc
 *) 0}};

135 
buck‘_desc
 *
	gä“_buck‘_desc
 = (bucket_desc *) 0;

144 
šlše
 
	$š™_buck‘_desc
(
·ge
)

146 
buck‘_desc
 *
bdesc
;

147 
i
;

149 
bdesc
 = (
buck‘_desc
 *è
·ge
;

150 
i
 = 
PAGE_SIZE
/(
buck‘_desc
); --˜> 0; 
bdesc
++ )

151 
bdesc
->
Ãxt
 = bdesc+1;

156 
	`şi
();

157 
bdesc
->
Ãxt
 = 
ä“_buck‘_desc
;

158 
ä“_buck‘_desc
 = (
buck‘_desc
 *è
·ge
;

159 
	}
}

165 #ifdeà
CONFIG_DEBUG_MALLOC


167 
	$deb_km®loc
(cÚ¡ *
deb_fe
, 
deb_lše
,

168 
Ën
, 
´iÜ™y
)

171 
	$km®loc
(
Ën
, 
´iÜ™y
)

174 
i
;

175 
æags
;

176 
·ge
;

177 
_buck‘_dœ
 *
bdœ
;

178 
buck‘_desc
 *
bdesc
;

179 *
»tv®
;

181 #ifdeà
CONFIG_DEBUG_MALLOC


182 
Ën
 +ğ(
hdr_¡¬t
)+(
hdr_’d
);

190 
bdœ
 = 
buck‘_dœ
;

191 
bdœ
 = 
buck‘_dœ
 ; bdœ->
size
 < 
Ën
 ; bdir++) {

192 ià(!
bdœ
->
size
)

193 
too_Ïrge
;

199 
	`§ve_æags
(
æags
);

200 
	`şi
();

201 
bdesc
 = 
bdœ
->
chaš
; bdesø!ğ
NULL
; bdesøğbdesc->
Ãxt
)

202 ià(
bdesc
->
ä“±r
)

203 
found_bdesc
;

214 ià(!
ä“_buck‘_desc
) {

215 
	`»¡Üe_æags
(
æags
);

216 if(!(
·ge
=
	`__g‘_ä“_·ge
(
´iÜ™y
)))

217  
NULL
;

218 
	`š™_buck‘_desc
(
·ge
);

221 
bdesc
 = 
ä“_buck‘_desc
;

222 
ä“_buck‘_desc
 = 
bdesc
->
Ãxt
;

223 
	`»¡Üe_æags
(
æags
);

225 if(!(
·ge
=
	`__g‘_ä“_·ge
(
´iÜ™y
))) {

229 
	`şi
();

230 
bdesc
->
Ãxt
 = 
ä“_buck‘_desc
;

231 
ä“_buck‘_desc
 = 
bdesc
;

232 
	`»¡Üe_æags
(
æags
);

233  
NULL
;

236 
bdesc
->
»fút
 = 0;

237 
bdesc
->
buck‘_size
 = 
bdœ
->
size
;

238 
bdesc
->
·ge
 = bdesc->
ä“±r
 = (*)…age;

241 
i
=
PAGE_SIZE
/
bdœ
->
size
; i > 0 ; i--) {

242 #ifdeà
CONFIG_DEBUG_MALLOC


243 
hdr_¡¬t
 *
hd
;

244 
hdr_’d
 *
he
;

245 
hd
 = (
hdr_¡¬t
 *è
·ge
;

246 
he
 = (
hdr_’d
 *)(
·ge
+(
bdœ
->
size
-(hdr_end)));

247 
hd
->
magic
 = 
DEB_MAGIC_FREE
;

248 
hd
->
fe
 = hd->
ok_fe
 = "(expand)";

249 
hd
->
lše
 = hd->
ok_lše
 = 0;

250 
hd
->
size
 = 
bdœ
->size-(
hdr_¡¬t
)-(
hdr_’d
);

251 
he
->
magic
 = 
DEB_MAGIC_END
;

253 
	`mem£t
(
hd
+1,0xF8,hd->
size
);

255 *((**è(
hd
+1)èğ(
i
==1è? 
NULL
 : (*)(
·ge
 + 
bdœ
->
size
);

257 *((**è
·ge
èğ(
i
==1è? 
NULL
 : (*)Õag+ 
bdœ
->
size
);

259 
·ge
 +ğ
bdœ
->
size
;

264 
	`şi
();

266 
bdesc
->
Ãxt
 = 
bdœ
->
chaš
;

267 
bdœ
->
chaš
 = 
bdesc
;

269 
found_bdesc
:

270 
»tv®
 = (*è
bdesc
->
ä“±r
;

271 #ifdeà
CONFIG_DEBUG_MALLOC


272 
bdesc
->
ä“±r
 = *((**è(((*)
»tv®
)+(
hdr_¡¬t
)));

274 
bdesc
->
ä“±r
 = *((**è
»tv®
);

276 
bdesc
->
»fút
++;

277 
	`»¡Üe_æags
(
æags
);

278 #ifdeà
CONFIG_DEBUG_MALLOC


280 
hdr_¡¬t
 *
hd
;

281 
hdr_’d
 *
he
;

283 
hd
 = (
hdr_¡¬t
 *è
»tv®
;

284 
»tv®
 = 
hd
+1;

285 
Ën
 -ğ(
hdr_¡¬t
)+(
hdr_’d
);

286 if(
hd
->
magic
 !ğ
DEB_MAGIC_FREE
 && hd->magiø!ğ
DEB_MAGIC_FREED
) {

287 
	`´štk
("DEB_MALLOC‡llocating %s block 0x%x (head 0x%x) from %s:%d, magic %x\n",

288 (
hd
->
magic
 =ğ
DEB_MAGIC_ALLOC
) ? "nonfree" : "trashed",

289 
»tv®
,
hd
,
deb_fe
,
deb_lše
,hd->
magic
);

290  
NULL
;

292 if(
Ën
 > 
hd
->
size
 ||†’ > 
bdœ
->size-(
hdr_¡¬t
)-(
hdr_’d
)) {

293 
	`´štk
("DEB_MALLOC got %x:%x-byte block, wanted %x, from %s:%d,†ast %s:%d\n",

294 
hd
->
size
,
bdœ
->size,
Ën
,hd->
fe
,hd->
lše
,
deb_fe
,
deb_lše
);

295  
NULL
;

298 *
x
 = (*è
»tv®
;

299 
pos
 = 4;

300 
x
 +ğ
pos
;

301 
pos
 < 
hd
->
size
) {

302 if(*
x
++ != 0xF8) {

303 
	`´štk
("DEB_MALLOC used 0x%x:%x(%x) while free, from %s:%d\n",

304 
»tv®
,
pos
,
hd
->
size
,hd->
fe
,hd->
lše
);

305  
NULL
;

307 
pos
++;

310 
he
 = (
hdr_’d
 *)(((*)
»tv®
)+
hd
->
size
);

311 if(
he
->
magic
 !ğ
DEB_MAGIC_END
) {

312 
	`´štk
("DEB_MALLOC ov”¿À0x%x:%d whä“, from %s:%d\n",
»tv®
,
hd
->
size
,hd->
fe
,hd->
lše
);

314 
	`mem£t
(
»tv®
, 0xf0, 
Ën
);

315 
he
 = (
hdr_’d
 *)(((*)
»tv®
)+
Ën
);

316 
hd
->
fe
 = hd->
ok_fe
 = 
deb_fe
;

317 
hd
->
lše
 = hd->
ok_lše
 = 
deb_lše
;

318 
hd
->
size
 = 
Ën
;

319 
hd
->
magic
 = 
DEB_MAGIC_ALLOC
;

320 
he
->
magic
 = 
DEB_MAGIC_END
;

323  
»tv®
;

325 
too_Ïrge
:

327 
	`´štk
("km®loøÿÎed w™h impossibly†¬g¬gum’ˆ(%d)\n", 
Ën
);

328  
NULL
;

329 
	}
}

331 #ifdeà
CONFIG_DEBUG_MALLOC


332 
	$deb_kcheck_s
(cÚ¡ *
deb_fe
, 
deb_lše
,

333 *
obj
, 
size
)

335 
hdr_¡¬t
 *
hd
;

336 
hdr_’d
 *
he
;

338 ià(!
obj
)

340 
hd
 = (
hdr_¡¬t
 *è
obj
;

341 
hd
--;

343 if(
hd
->
magic
 !ğ
DEB_MAGIC_ALLOC
) {

344 if(
hd
->
magic
 =ğ
DEB_MAGIC_FREE
) {

345 
	`´štk
("DEB_MALLOC Using free block of 0x%x‡t %s:%d, by %s:%d, wasOK %s:%d\n",

346 
obj
,
deb_fe
,
deb_lše
,
hd
->
fe
,hd->
lše
,hd->
ok_fe
,hd->
ok_lše
);

348 
hd
->
magic
 = 
DEB_MAGIC_FREED
;

352 if(
hd
->
size
 != size) {

353 if(
size
 != 0) {

354 
	`´štk
("DEB_MALLOC size for 0x%x given‡s %d, stored %d,‡t %s:%d, wasOK %s:%d\n",

355 
obj
,
size
,
hd
->size,
deb_fe
,
deb_lše
,hd->
ok_fe
,hd->
ok_lše
);

357 
size
 = 
hd
->size;

359 
he
 = (
hdr_’d
 *)(((*)
obj
)+
size
);

360 if(
he
->
magic
 !ğ
DEB_MAGIC_END
) {

361 
	`´štk
("DEB_MALLOC overran block 0x%x:%d,‡t %s:%d, wasOK %s:%d\n",

362 
obj
,
hd
->
size
,
deb_fe
,
deb_lše
,hd->
ok_fe
,hd->
ok_lše
);

363 
hd
->
magic
 = 
DEB_MAGIC_USED
;

366 
hd
->
ok_fe
 = 
deb_fe
;

367 
hd
->
ok_lše
 = 
deb_lše
;

368 
	}
}

378 #ifdeà
CONFIG_DEBUG_MALLOC


379 
	$deb_kä“_s
(cÚ¡ *
deb_fe
, 
deb_lše
,

380 *
obj
, 
size
)

382 
	$kä“_s
(*
obj
, 
size
)

385 
æags
;

386 *
·ge
;

387 
_buck‘_dœ
 *
bdœ
;

388 
buck‘_desc
 *
bdesc
, *
´ev
;

390 ià(!
obj
)

392 #ifdeà
CONFIG_DEBUG_MALLOC


394 
hdr_¡¬t
 *
hd
;

395 
hdr_’d
 *
he
;

396 
hd
 = (
hdr_¡¬t
 *è
obj
;

397 
hd
--;

399 if(
hd
->
magic
 =ğ
DEB_MAGIC_FREE
) {

400 
	`´štk
("DEB_MALLOC dup free of 0x%x‡t %s:%d by %s:%d, wasOK %s:%d\n",

401 
obj
,
deb_fe
,
deb_lše
,
hd
->
fe
,hd->
lše
,hd->
ok_fe
,hd->
ok_lše
);

404 if(
hd
->
size
 != size) {

405 if(
size
 != 0) {

406 if(
hd
->
magic
 !ğ
DEB_MAGIC_USED
)

407 
	`´štk
("DEB_MALLOC size for 0x%x given‡s %d, stored %d,‡t %s:%d, wasOK %s:%d\n",

408 
obj
,
size
,
hd
->size,
deb_fe
,
deb_lše
,hd->
ok_fe
,hd->
ok_lše
);

410 
size
 = 
hd
->size;

412 
he
 = (
hdr_’d
 *)(((*)
obj
)+
size
);

413 if(
he
->
magic
 !ğ
DEB_MAGIC_END
) {

414 if(
hd
->
magic
 !ğ
DEB_MAGIC_USED
)

415 
	`´štk
("DEB_MALLOC overran block 0x%x:%d,‡t %s:%d, from %s:%d, wasOK %s:%d\n",

416 
obj
,
hd
->
size
,
deb_fe
,
deb_lše
,hd->
fe
,hd->
lše
,hd->
ok_fe
,hd->
ok_lše
);

418 
size
 +ğ(
hdr_¡¬t
)+(
hdr_’d
);

421 
	`§ve_æags
(
æags
);

423 
·ge
 = (*è((è
obj
 & 
PAGE_MASK
);

426 
bdœ
 = 
buck‘_dœ
; bdœ->
size
; bdir++) {

427 
´ev
 = 0;

429 ià(
bdœ
->
size
 >= size) {

436 
	`şi
();

437 
bdesc
 = 
bdœ
->
chaš
; bdesc; bdesøğbdesc->
Ãxt
) {

438 ià(
bdesc
->
·ge
 ==…age)

439 
found
;

440 
´ev
 = 
bdesc
;

445 
	`»¡Üe_æags
(
æags
);

446 
	`´štk
("Bad‡dd»s ·s£dØk”ÃÈkä“_s(%p, %d)\n",
obj
, 
size
);

447 #ifdeà
CONFIG_DEBUG_MALLOC


448 
	`´štk
("Ofãndšg code: %s:%d\n",
deb_fe
,
deb_lše
);

450 
	`´štk
("Ofãndšgƒ: %08x\n",((*è&
obj
)[-1]);

454 
found
:

456 #ifdeà
CONFIG_DEBUG_MALLOC


459 
hdr_¡¬t
 *
hd
;

460 
hdr_’d
 *
he
;

461 
hd
 = (
hdr_¡¬t
 *è
obj
;

462 
hd
--;

464 
hd
->
fe
 = 
deb_fe
;

465 
hd
->
lše
 = 
deb_lše
;

466 
hd
->
magic
 = 
DEB_MAGIC_FREE
;

467 
hd
->
size
 = 
bdœ
->size-(
hdr_¡¬t
)-(
hdr_’d
);

468 
he
 = (
hdr_’d
 *)(((*)
obj
)+
hd
->
size
);

469 
	`mem£t
(
obj
, 0xf8, 
hd
->
size
);

470 
he
->
magic
 = 
DEB_MAGIC_END
;

471 *((**)
obj
èğ
bdesc
->
ä“±r
;

472 
obj
 = 
hd
;

475 *((**)
obj
èğ
bdesc
->
ä“±r
;

478 
bdesc
->
ä“±r
 = 
obj
;

479 
bdesc
->
»fút
--;

480 ià(
bdesc
->
»fút
 == 0) {

485 ià((
´ev
 && (´ev->
Ãxt
 !ğ
bdesc
)) ||

486 (!
´ev
 && (
bdœ
->
chaš
 !ğ
bdesc
)))

487 
´ev
 = 
bdœ
->
chaš
;…»v;…»v =…»v->
Ãxt
)

488 ià(
´ev
->
Ãxt
 =ğ
bdesc
)

490 ià(
´ev
)

491 
´ev
->
Ãxt
 = 
bdesc
->next;

493 ià(
bdœ
->
chaš
 !ğ
bdesc
)

494 
	`·nic
("kmalloc bucket chains corrupted");

495 
bdœ
->
chaš
 = 
bdesc
->
Ãxt
;

497 
bdesc
->
Ãxt
 = 
ä“_buck‘_desc
;

498 
ä“_buck‘_desc
 = 
bdesc
;

499 
	`ä“_·ge
((è
bdesc
->
·ge
);

501 
	`»¡Üe_æags
(
æags
);

503 
	}
}

505 #ifdeà
CONFIG_DEBUG_MALLOC


506 
	$g‘_m®loc
(*
bufãr
)

508 
Ën
 = 0;

509 
i
;

510 
æags
;

511 *
·ge
;

512 
_buck‘_dœ
 *
bdœ
;

513 
buck‘_desc
 *
bdesc
;

515 
	`§ve_æags
(
æags
);

516 
	`şi
();

517 
bdœ
 = 
buck‘_dœ
; bdœ->
size
; bdir++) {

518 
bdesc
 = 
bdœ
->
chaš
; bdesc; bdesøğbdesc->
Ãxt
) {

519 
·ge
 = 
bdesc
->page;

520 
i
=
PAGE_SIZE
/
bdœ
->
size
; i > 0 ; i--) {

521 
hdr_¡¬t
 *
hd
;

522 
hd
 = (
hdr_¡¬t
 *)
·ge
;

523 if(
hd
->
magic
 =ğ
DEB_MAGIC_ALLOC
) {

524 if(
Ën
 > 
PAGE_SIZE
-80) {

525 
	`»¡Üe_æags
(
æags
);

526 
Ën
 +ğ
	`¥rštf
(
bufãr
+len,"...\n");

527  
Ën
;

529 
Ën
 +ğ
	`¥rštf
(
bufãr
+len,"%08x:%03x %s:%d %s:%d\n",

530 ()(
·ge
+(
hdr_¡¬t
)),
hd
->
size
,hd->
fe
,hd->
lše
,hd->
ok_fe
,hd->
ok_lše
);

532 
·ge
 +ğ
bdœ
->
size
;

537 
	`»¡Üe_æags
(
æags
);

538  
Ën
;

539 
	}
}

	@lib/open.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

9 
	~<¡d¬g.h
>

11 
	$İ’
(cÚ¡ * 
f’ame
, 
æag
, ...)

13 
»s
;

14 
va_li¡
 
¬g
;

16 
	`va_¡¬t
(
¬g
,
æag
);

17 
	`__asm__
("movl %2,%%ebx\n\t"

19 :"÷" (
»s
)

20 :"0" (
__NR_İ’
),"g" (()(
f’ame
)),"c" (
æag
),

21 "d" (
	`va_¬g
(
¬g
,)));

22 ià(
»s
>=0)

23  
»s
;

24 
”ºo
 = -
»s
;

26 
	}
}

	@lib/setsid.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/uni¡d.h
>

11 
_sysÿÎ0
(
pid_t
,
£tsid
)

	@lib/string.c

7 #iâdeà
__GNUC__


8 #”rÜ 
I
 
wªt
 
gcc
!

11 
	~<lšux/ty³s.h
>

13 

	)

14 
	#šlše


	)

15 
	#__LIBRARY__


	)

16 
	~<lšux/¡ršg.h
>

	@lib/wait.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

9 
	~<lšux/ty³s.h
>

11 
	$_sysÿÎ3
(
pid_t
,
wa™pid
,pid_t,
pid
,*,
wa™_¡©
,,
İtiÚs
)

13 
pid_t
 
	$wa™
(* 
wa™_¡©
)

15  
	`wa™pid
(-1,
wa™_¡©
,0);

16 
	}
}

	@lib/write.c

7 
	#__LIBRARY__


	)

8 
	~<lšux/uni¡d.h
>

9 
	~<lšux/ty³s.h
>

11 
_sysÿÎ3
(,
wr™e
,,
fd
,cÚ¡ *,
buf
,
off_t
,
couÁ
)

	@mm/kmalloc.c

10 
	~<lšux/mm.h
>

11 
	~<asm/sy¡em.h
>

12 
	~<lšux/d–ay.h
>

14 
	#GFP_LEVEL_MASK
 0xf

	)

20 
	#MAX_KMALLOC_K
 4

	)

25 
	#MAX_GET_FREE_PAGE_TRIES
 4

	)

30 
	#MF_USED
 0xfça0055

	)

31 
	#MF_FREE
 0x0055fça

	)

48 
	sblock_h—d”
 {

49 
	mbh_æags
;

51 
	mubh_Ëngth
;

52 
block_h—d”
 *
	mfbh_Ãxt
;

53 } 
	mvp
;

57 
	#bh_Ëngth
 
vp
.
ubh_Ëngth


	)

58 
	#bh_Ãxt
 
vp
.
fbh_Ãxt


	)

59 
	#BH
(
p
è((
block_h—d”
 *)Õ))

	)

65 
	s·ge_desütÜ
 {

66 
·ge_desütÜ
 *
	mÃxt
;

67 
block_h—d”
 *
	mfœ¡ä“
;

68 
	mÜd”
;

69 
	mnä“
;

73 
	#PAGE_DESC
(
p
è((
·ge_desütÜ
 *)((()Õ)è& 
PAGE_MASK
))

	)

80 
	ssize_desütÜ
 {

81 
·ge_desütÜ
 *
	mfœ¡ä“
;

82 
	msize
;

83 
	mnblocks
;

85 
	mnm®locs
;

86 
	mnä“s
;

87 
	mnby‹sm®loûd
;

88 
	mÅages
;

92 
size_desütÜ
 
	gsizes
[] = {

93 { 
NULL
, 32,127, 0,0,0,0 },

94 { 
NULL
, 64, 63, 0,0,0,0 },

95 { 
NULL
, 128, 31, 0,0,0,0 },

96 { 
NULL
, 252, 16, 0,0,0,0 },

97 { 
NULL
, 508, 8, 0,0,0,0 },

98 { 
NULL
,1020, 4, 0,0,0,0 },

99 { 
NULL
,2040, 2, 0,0,0,0 },

100 { 
NULL
,4080, 1, 0,0,0,0 },

101 { 
NULL
, 0, 0, 0,0,0,0 }

105 
	#NBLOCKS
(
Üd”
è(
sizes
[Üd”].
nblocks
)

	)

106 
	#BLOCKSIZE
(
Üd”
è(
sizes
[Üd”].
size
)

	)

110 
	$km®loc_š™
 (
¡¬t_mem
,
’d_mem
)

112 
Üd”
;

118 
Üd”
 = 0;
	`BLOCKSIZE
(order);order++)

120 ià((
	`NBLOCKS
 (
Üd”
)*
	`BLOCKSIZE
(Üd”è+  (
·ge_desütÜ
)) >

121 
PAGE_SIZE
)

123 
	`´štk
 ("Cannot use %d bytes out of %d in order = %d block mallocs\n",

124 
	`NBLOCKS
 (
Üd”
è* 
	`BLOCKSIZE
(order) +

125  (
·ge_desütÜ
),

126 (è
PAGE_SIZE
,

127 
	`BLOCKSIZE
 (
Üd”
));

128 
	`·nic
 ("This only happens if someone messes with kmalloc");

131  
¡¬t_mem
;

132 
	}
}

136 
	$g‘_Üd”
 (
size
)

138 
Üd”
;

141 
size
 +ğ (
block_h—d”
);

142 
Üd”
 = 0;
	`BLOCKSIZE
(order);order++)

143 ià(
size
 <ğ
	`BLOCKSIZE
 (
Üd”
))

144  
Üd”
;

146 
	}
}

148 * 
	$km®loc
 (
size_t
 
size
, 
´iÜ™y
)

150 
æags
;

151 
Üd”
,
Œ›s
,
i
,
sz
;

152 
block_h—d”
 *
p
;

153 
·ge_desütÜ
 *
·ge
;

154 
šŒ_couÁ
;

157 ià(
šŒ_couÁ
 && 
´iÜ™y
 !ğ
GFP_ATOMIC
) {

158 
	`´štk
("kmalloc called‚onatomically from interrupt %08lx\n",

159 ((*)&
size
)[-1]);

160 
´iÜ™y
 = 
GFP_ATOMIC
;

162 ià(
size
 > 
MAX_KMALLOC_K
 * 1024)

164 
	`´štk
 ("kmalloc: I„efuseo‡llocate %d bytes (for‚ow max = %d).\n",

165 
size
,
MAX_KMALLOC_K
*1024);

166  (
NULL
);

169 
Üd”
 = 
	`g‘_Üd”
 (
size
);

170 ià(
Üd”
 < 0)

172 
	`´štk
 ("km®loøoàtoØÏrg¨block (%d by‹s).\n",
size
);

173  (
NULL
);

176 
	`§ve_æags
(
æags
);

180 
Œ›s
 = 
MAX_GET_FREE_PAGE_TRIES
;

181 
Œ›s
 --)

184 
	`şi
 ();

185 ià((
·ge
 = 
sizes
[
Üd”
].
fœ¡ä“
) &&

186 (
p
 = 
·ge
->
fœ¡ä“
))

188 ià(
p
->
bh_æags
 =ğ
MF_FREE
)

190 
·ge
->
fœ¡ä“
 = 
p
->
bh_Ãxt
;

191 
·ge
->
nä“
--;

192 ià(!
·ge
->
nä“
)

194 
sizes
[
Üd”
].
fœ¡ä“
 = 
·ge
->
Ãxt
;

195 
·ge
->
Ãxt
 = 
NULL
;

197 
	`»¡Üe_æags
(
æags
);

199 
sizes
 [
Üd”
].
nm®locs
++;

200 
sizes
 [
Üd”
].
nby‹sm®loûd
 +ğ
size
;

201 
p
->
bh_æags
 = 
MF_USED
;

202 
p
->
bh_Ëngth
 = 
size
;

203  
p
+1;

205 
	`´štk
 ("ProbËm: block oÀä“li¡‡ˆ%08lx i¢'ˆä“.\n",()
p
);

206  (
NULL
);

208 
	`»¡Üe_æags
(
æags
);

213 
sz
 = 
	`BLOCKSIZE
(
Üd”
);

216 
·ge
 = (
·ge_desütÜ
 *è
	`__g‘_ä“_·ge
 (
´iÜ™y
 & 
GFP_LEVEL_MASK
);

217 ià(!
·ge
)

219 
	`´štk
 ("Couldn't get‡ free…age.....\n");

220  
NULL
;

223 
	`´štk
 ("GÙ…ag%08xØu£ fÜ %d by‹ m®locs....",()
·ge
,
sz
);

225 
sizes
[
Üd”
].
Åages
++;

228 
i
=
	`NBLOCKS
(
Üd”
),
p
=
	`BH
 (
·ge
+1);˜> 1;i--,põ->
bh_Ãxt
)

230 
p
->
bh_æags
 = 
MF_FREE
;

231 
p
->
bh_Ãxt
 = 
	`BH
 ( ((í)+
sz
);

234 
p
->
bh_æags
 = 
MF_FREE
;

235 
p
->
bh_Ãxt
 = 
NULL
;

237 
·ge
->
Üd”
 = order;

238 
·ge
->
nä“
 = 
	`NBLOCKS
(
Üd”
);

239 
·ge
->
fœ¡ä“
 = 
	`BH
(page+1);

241 
	`´štk
 ("%d block ³¸·ge\n",
·ge
->
nä“
);

245 
	`şi
 ();

250 
·ge
->
Ãxt
 = 
sizes
[
Üd”
].
fœ¡ä“
;

251 
sizes
[
Üd”
].
fœ¡ä“
 = 
·ge
;

252 
	`»¡Üe_æags
(
æags
);

257 
	`´štk
 ("Hey. This is very funny. Iried %dimeso‡llocate‡ whole\n"

264 
MAX_GET_FREE_PAGE_TRIES
,

265 
size
);

266  
NULL
;

267 
	}
}

270 
	$kä“_s
 (*
±r
,
size
)

272 
æags
;

273 
Üd”
;

274 
block_h—d”
 *
p
=((block_h—d” *)
±r
) -1;

275 
·ge_desütÜ
 *
·ge
,*
pg2
;

277 
·ge
 = 
	`PAGE_DESC
 (
p
);

278 
Üd”
 = 
·ge
->order;

279 ià((
Üd”
 < 0) ||

280 (
Üd”
 >  (
sizes
)/ (sizes[0])) ||

281 ((()(
·ge
->
Ãxt
)è& ~
PAGE_MASK
) ||

282 (
p
->
bh_æags
 !ğ
MF_USED
))

284 
	`´štk
 ("kfree of‚on-kmalloced memory: %p,‚ext= %p, order=%d\n",

285 
p
, 
·ge
->
Ãxt
,…age->
Üd”
);

288 ià(
size
 &&

289 
size
 !ğ
p
->
bh_Ëngth
)

291 
	`´štk
 ("Tryingo free…ointer‡t %p with wrong size: %d instead of %lu.\n",

292 
p
,
size
,p->
bh_Ëngth
);

295 
size
 = 
p
->
bh_Ëngth
;

296 
p
->
bh_æags
 = 
MF_FREE
;

298 
	`§ve_æags
(
æags
);

299 
	`şi
 ();

300 
p
->
bh_Ãxt
 = 
·ge
->
fœ¡ä“
;

301 
·ge
->
fœ¡ä“
 = 
p
;

302 
·ge
->
nä“
 ++;

304 ià(
·ge
->
nä“
 == 1)

306 ià(
·ge
->
Ãxt
)

308 
	`´štk
 ("Pag%°®»ady oÀä“li¡ dazed‡nd cÚfu£d....\n", 
·ge
);

312 
·ge
->
Ãxt
 = 
sizes
[
Üd”
].
fœ¡ä“
;

313 
sizes
[
Üd”
].
fœ¡ä“
 = 
·ge
;

318 ià(
·ge
->
nä“
 =ğ
	`NBLOCKS
 (·ge->
Üd”
))

321 
	`´štk
 ("F»ešg…ag%08x.\n", ()
·ge
);

323 ià(
sizes
[
Üd”
].
fœ¡ä“
 =ğ
·ge
)

325 
sizes
[
Üd”
].
fœ¡ä“
 = 
·ge
->
Ãxt
;

329 
pg2
=
sizes
[
Üd”
].
fœ¡ä“
;

330 (
pg2
 !ğ
NULL
è&& (pg2->
Ãxt
 !ğ
·ge
);

331 
pg2
õg2->
Ãxt
)

333 ià(
pg2
 !ğ
NULL
)

334 
pg2
->
Ãxt
 = 
·ge
->next;

336 
	`´štk
 ("Ooİs.…ag%°dÛ¢'ˆshow oÀä“li¡.\n", 
·ge
);

338 
	`ä“_·ge
 (()
·ge
);

340 
	`»¡Üe_æags
(
æags
);

342 
sizes
[
Üd”
].
nä“s
++;

343 
sizes
[
Üd”
].
nby‹sm®loûd
 -ğ
size
;

344 
	}
}

	@mm/memory.c

31 
	~<asm/sy¡em.h
>

32 
	~<lšux/cÚfig.h
>

34 
	~<lšux/sigÇl.h
>

35 
	~<lšux/sched.h
>

36 
	~<lšux/h—d.h
>

37 
	~<lšux/k”Ãl.h
>

38 
	~<lšux/”ºo.h
>

39 
	~<lšux/¡ršg.h
>

40 
	~<lšux/ty³s.h
>

41 
	~<lšux/±¿û.h
>

42 
	~<lšux/mmª.h
>

44 
	ghigh_memÜy
 = 0;

46 
pg0
[1024];

48 
sound_mem_š™
();

49 
d›_if_k”Ãl
(*,
±_»gs
 *,);

51 
	gÄ_sw­_·ges
 = 0;

52 
	gÄ_ä“_·ges
 = 0;

53 
	gä“_·ge_li¡
 = 0;

60 
	gÄ_£cÚd¬y_·ges
 = 0;

61 
	g£cÚd¬y_·ge_li¡
 = 0;

63 
	#cİy_·ge
(
äom
,
to
) \

64 
	`__asm__
("şd ;„• ; mov¦": :"S" (
äom
),"D" (
to
),"c" (1024):"cx","di","si")

	)

66 * 
	gmem_m­
 = 
NULL
;

68 
	#CODE_SPACE
(
addr
,
p
è(×ddrè< (p)->
’d_code
)

	)

74 
	$oom
(
sk_¡ruù
 * 
sk
)

76 
	`´štk
("\nout of memory\n");

77 
sk
->
sigaùiÚ
[
SIGKILL
-1].
§_hªdËr
 = 
NULL
;

78 
sk
->
blocked
 &ğ~(1<<(
SIGKILL
-1));

79 
	`£nd_sig
(
SIGKILL
,
sk
,1);

80 
	}
}

82 
	$ä“_Úe_bË
(* 
·ge_dœ
)

84 
j
;

85 
pg_bË
 = *
·ge_dœ
;

86 * 
·ge_bË
;

88 ià(!
pg_bË
)

90 *
·ge_dœ
 = 0;

91 ià(
pg_bË
 >ğ
high_memÜy
 || !Õg_bË & 
PAGE_PRESENT
)) {

92 
	`´štk
("Bad…agbË: [%p]=%08lx\n",
·ge_dœ
,
pg_bË
);

95 ià(
mem_m­
[
	`MAP_NR
(
pg_bË
)] & 
MAP_PAGE_RESERVED
)

97 
·ge_bË
 = (*è(
pg_bË
 & 
PAGE_MASK
);

98 
j
 = 0 ; j < 
PTRS_PER_PAGE
 ; j++,
·ge_bË
++) {

99 
pg
 = *
·ge_bË
;

101 ià(!
pg
)

103 *
·ge_bË
 = 0;

104 ià(
pg
 & 
PAGE_PRESENT
)

105 
	`ä“_·ge
(
PAGE_MASK
 & 
pg
);

107 
	`sw­_ä“
(
pg
);

109 
	`ä“_·ge
(
PAGE_MASK
 & 
pg_bË
);

110 
	}
}

119 
	$ş—r_·ge_bËs
(
sk_¡ruù
 * 
tsk
)

121 
i
;

122 
pg_dœ
;

123 * 
·ge_dœ
;

125 ià(!
tsk
)

127 ià(
tsk
 =ğ
sk
[0])

128 
	`·nic
("task[0] (swapper) doesn't supportƒxec()\n");

129 
pg_dœ
 = 
tsk
->
tss
.
ü3
;

130 
·ge_dœ
 = (*è
pg_dœ
;

131 ià(!
·ge_dœ
 ||…age_dœ =ğ
sw­³r_pg_dœ
) {

132 
	`´štk
("Tryingo clear kernel…age-directory:‚ot good\n");

135 ià(
mem_m­
[
	`MAP_NR
(
pg_dœ
)] > 1) {

136 * 
Ãw_pg
;

138 ià(!(
Ãw_pg
 = (*è
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

139 
	`oom
(
tsk
);

142 
i
 = 768 ; i < 1024 ; i++)

143 
Ãw_pg
[
i
] = 
·ge_dœ
[i];

144 
	`ä“_·ge
(
pg_dœ
);

145 
tsk
->
tss
.
ü3
 = (è
Ãw_pg
;

148 
i
 = 0 ; i < 768 ; i++,
·ge_dœ
++)

149 
	`ä“_Úe_bË
(
·ge_dœ
);

150 
	`šv®id©e
();

152 
	}
}

157 
	$ä“_·ge_bËs
(
sk_¡ruù
 * 
tsk
)

159 
i
;

160 
pg_dœ
;

161 * 
·ge_dœ
;

163 ià(!
tsk
)

165 ià(
tsk
 =ğ
sk
[0]) {

166 
	`´štk
("task[0] (swapper) killed: unableo„ecover\n");

167 
	`·nic
("Tryingo free up swapper memory space");

169 
pg_dœ
 = 
tsk
->
tss
.
ü3
;

170 ià(!
pg_dœ
 ||…g_dœ =ğ(è
sw­³r_pg_dœ
) {

171 
	`´štk
("Tryingo free kernel…age-directory:‚ot good\n");

174 
tsk
->
tss
.
ü3
 = (è
sw­³r_pg_dœ
;

175 ià(
tsk
 =ğ
cu¼’t
)

176 
__asm__
 
	`__vŞ©e__
("movÈ%0,%%ü3": :"a" (
tsk
->
tss
.
ü3
));

177 ià(
mem_m­
[
	`MAP_NR
(
pg_dœ
)] > 1) {

178 
	`ä“_·ge
(
pg_dœ
);

181 
·ge_dœ
 = (*è
pg_dœ
;

182 
i
 = 0 ; i < 
PTRS_PER_PAGE
 ; i++,
·ge_dœ
++)

183 
	`ä“_Úe_bË
(
·ge_dœ
);

184 
	`ä“_·ge
(
pg_dœ
);

185 
	`šv®id©e
();

186 
	}
}

194 
	$şÚe_·ge_bËs
(
sk_¡ruù
 * 
tsk
)

196 
pg_dœ
;

198 
pg_dœ
 = 
cu¼’t
->
tss
.
ü3
;

199 
mem_m­
[
	`MAP_NR
(
pg_dœ
)]++;

200 
tsk
->
tss
.
ü3
 = 
pg_dœ
;

202 
	}
}

209 
	$cİy_·ge_bËs
(
sk_¡ruù
 * 
tsk
)

211 
i
;

212 
Şd_pg_dœ
, *
Şd_·ge_dœ
;

213 
Ãw_pg_dœ
, *
Ãw_·ge_dœ
;

215 ià(!(
Ãw_pg_dœ
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
)))

216  -
ENOMEM
;

217 
Şd_pg_dœ
 = 
cu¼’t
->
tss
.
ü3
;

218 
tsk
->
tss
.
ü3
 = 
Ãw_pg_dœ
;

219 
Şd_·ge_dœ
 = (*è
Şd_pg_dœ
;

220 
Ãw_·ge_dœ
 = (*è
Ãw_pg_dœ
;

221 
i
 = 0 ; i < 
PTRS_PER_PAGE
 ; i++,
Şd_·ge_dœ
++,
Ãw_·ge_dœ
++) {

222 
j
;

223 
Şd_pg_bË
, *
Şd_·ge_bË
;

224 
Ãw_pg_bË
, *
Ãw_·ge_bË
;

226 
Şd_pg_bË
 = *
Şd_·ge_dœ
;

227 ià(!
Şd_pg_bË
)

229 ià(
Şd_pg_bË
 >ğ
high_memÜy
 || !(Şd_pg_bË & 
PAGE_PRESENT
)) {

230 
	`´štk
("copy_page_tables: bad…ageable: "

232 *
Şd_·ge_dœ
 = 0;

235 ià(
mem_m­
[
	`MAP_NR
(
Şd_pg_bË
)] & 
MAP_PAGE_RESERVED
) {

236 *
Ãw_·ge_dœ
 = 
Şd_pg_bË
;

239 ià(!(
Ãw_pg_bË
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

240 
	`ä“_·ge_bËs
(
tsk
);

241  -
ENOMEM
;

243 
Şd_·ge_bË
 = (*è(
PAGE_MASK
 & 
Şd_pg_bË
);

244 
Ãw_·ge_bË
 = (*è(
PAGE_MASK
 & 
Ãw_pg_bË
);

245 
j
 = 0 ; j < 
PTRS_PER_PAGE
 ; j++,
Şd_·ge_bË
++,
Ãw_·ge_bË
++) {

246 
pg
;

247 
pg
 = *
Şd_·ge_bË
;

248 ià(!
pg
)

250 ià(!(
pg
 & 
PAGE_PRESENT
)) {

251 *
Ãw_·ge_bË
 = 
	`sw­_du¶iÿ‹
(
pg
);

254 ià((
pg
 & (
PAGE_RW
 | 
PAGE_COW
)) == (PAGE_RW | PAGE_COW))

255 
pg
 &ğ~
PAGE_RW
;

256 *
Ãw_·ge_bË
 = 
pg
;

257 ià(
mem_m­
[
	`MAP_NR
(
pg
)] & 
MAP_PAGE_RESERVED
)

259 *
Şd_·ge_bË
 = 
pg
;

260 
mem_m­
[
	`MAP_NR
(
pg
)]++;

262 *
Ãw_·ge_dœ
 = 
Ãw_pg_bË
 | 
PAGE_TABLE
;

264 
	`šv®id©e
();

266 
	}
}

272 
	$unm­_·ge_¿nge
(
äom
, 
size
)

274 
·ge
, 
·ge_dœ
;

275 *
·ge_bË
, *
dœ
;

276 
poff
, 
pút
, 
pc
;

278 ià(
äom
 & ~
PAGE_MASK
) {

279 
	`´štk
("unmap_page_range called with wrong‡lignment\n");

280  -
EINVAL
;

282 
size
 = (siz+ ~
PAGE_MASK
è>> 
PAGE_SHIFT
;

283 
dœ
 = 
	`PAGE_DIR_OFFSET
(
cu¼’t
->
tss
.
ü3
,
äom
);

284 
poff
 = (
äom
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

285 ià((
pút
 = 
PTRS_PER_PAGE
 - 
poff
è> 
size
)

286 
pút
 = 
size
;

288  ; 
size
 > 0; ++
dœ
, siz-ğ
pút
,

289 
pút
 = (
size
 > 
PTRS_PER_PAGE
 ? PTRS_PER_PAGE : size)) {

290 ià(!(
·ge_dœ
 = *
dœ
)) {

291 
poff
 = 0;

294 ià(!(
·ge_dœ
 & 
PAGE_PRESENT
)) {

295 
	`´štk
("unmap_page_range: bad…age directory.");

298 
·ge_bË
 = (*)(
PAGE_MASK
 & 
·ge_dœ
);

299 ià(
poff
) {

300 
·ge_bË
 +ğ
poff
;

301 
poff
 = 0;

303 
pc
 = 
pút
;…c--; 
·ge_bË
++) {

304 ià((
·ge
 = *
·ge_bË
) != 0) {

305 *
·ge_bË
 = 0;

306 ià(1 & 
·ge
) {

307 ià(!(
mem_m­
[
	`MAP_NR
(
·ge
)] & 
MAP_PAGE_RESERVED
))

308 ià(
cu¼’t
->
rss
 > 0)

309 --
cu¼’t
->
rss
;

310 
	`ä“_·ge
(
PAGE_MASK
 & 
·ge
);

312 
	`sw­_ä“
(
·ge
);

315 ià(
pút
 =ğ
PTRS_PER_PAGE
) {

316 *
dœ
 = 0;

317 
	`ä“_·ge
(
PAGE_MASK
 & 
·ge_dœ
);

320 
	`šv®id©e
();

322 
	}
}

324 
	$z”om­_·ge_¿nge
(
äom
, 
size
, 
mask
)

326 *
·ge_bË
, *
dœ
;

327 
poff
, 
pút
;

328 
·ge
;

330 ià(
mask
) {

331 ià((
mask
 & (
PAGE_MASK
|
PAGE_PRESENT
)) != PAGE_PRESENT) {

332 
	`´štk
("z”om­_·ge_¿nge: mask = %08x\n",
mask
);

333  -
EINVAL
;

335 
mask
 |ğ
ZERO_PAGE
;

337 ià(
äom
 & ~
PAGE_MASK
) {

338 
	`´štk
("z”om­_·ge_¿nge: from = %08lx\n",
äom
);

339  -
EINVAL
;

341 
dœ
 = 
	`PAGE_DIR_OFFSET
(
cu¼’t
->
tss
.
ü3
,
äom
);

342 
size
 = (siz+ ~
PAGE_MASK
è>> 
PAGE_SHIFT
;

343 
poff
 = (
äom
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

344 ià((
pút
 = 
PTRS_PER_PAGE
 - 
poff
è> 
size
)

345 
pút
 = 
size
;

347 
size
 > 0) {

348 ià(!(
PAGE_PRESENT
 & *
dœ
)) {

350 ià(!(
·ge_bË
 = (*è
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

351 
	`šv®id©e
();

352  -
ENOMEM
;

354 ià(
PAGE_PRESENT
 & *
dœ
) {

355 
	`ä“_·ge
((è
·ge_bË
);

356 
·ge_bË
 = (*)(
PAGE_MASK
 & *
dœ
++);

358 *
dœ
++ = ((è
·ge_bË
è| 
PAGE_TABLE
;

360 
·ge_bË
 = (*)(
PAGE_MASK
 & *
dœ
++);

361 
·ge_bË
 +ğ
poff
;

362 
poff
 = 0;

363 
size
 -ğ
pút
;…cnt-- ;) {

364 ià((
·ge
 = *
·ge_bË
) != 0) {

365 *
·ge_bË
 = 0;

366 ià(
·ge
 & 
PAGE_PRESENT
) {

367 ià(!(
mem_m­
[
	`MAP_NR
(
·ge
)] & 
MAP_PAGE_RESERVED
))

368 ià(
cu¼’t
->
rss
 > 0)

369 --
cu¼’t
->
rss
;

370 
	`ä“_·ge
(
PAGE_MASK
 & 
·ge
);

372 
	`sw­_ä“
(
·ge
);

374 *
·ge_bË
++ = 
mask
;

376 
pút
 = (
size
 > 
PTRS_PER_PAGE
 ? PTRS_PER_PAGE : size);

378 
	`šv®id©e
();

380 
	}
}

387 
	$»m­_·ge_¿nge
(
äom
, 
to
, 
size
, 
mask
)

389 *
·ge_bË
, *
dœ
;

390 
poff
, 
pút
;

391 
·ge
;

393 ià(
mask
) {

394 ià((
mask
 & (
PAGE_MASK
|
PAGE_PRESENT
)) != PAGE_PRESENT) {

395 
	`´štk
("»m­_·ge_¿nge: mask = %08x\n",
mask
);

396  -
EINVAL
;

399 ià((
äom
 & ~
PAGE_MASK
è|| (
to
 & ~PAGE_MASK)) {

400 
	`´štk
("»m­_·ge_¿nge: from = %08lx,o=%08lx\n",
äom
,
to
);

401  -
EINVAL
;

403 
dœ
 = 
	`PAGE_DIR_OFFSET
(
cu¼’t
->
tss
.
ü3
,
äom
);

404 
size
 = (siz+ ~
PAGE_MASK
è>> 
PAGE_SHIFT
;

405 
poff
 = (
äom
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

406 ià((
pút
 = 
PTRS_PER_PAGE
 - 
poff
è> 
size
)

407 
pút
 = 
size
;

409 
size
 > 0) {

410 ià(!(
PAGE_PRESENT
 & *
dœ
)) {

412 ià(!(
·ge_bË
 = (*è
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

413 
	`šv®id©e
();

416 *
dœ
++ = ((è
·ge_bË
è| 
PAGE_TABLE
;

419 
·ge_bË
 = (*)(
PAGE_MASK
 & *
dœ
++);

420 ià(
poff
) {

421 
·ge_bË
 +ğ
poff
;

422 
poff
 = 0;

425 
size
 -ğ
pút
;…cnt-- ;) {

426 ià((
·ge
 = *
·ge_bË
) != 0) {

427 *
·ge_bË
 = 0;

428 ià(
PAGE_PRESENT
 & 
·ge
) {

429 ià(!(
mem_m­
[
	`MAP_NR
(
·ge
)] & 
MAP_PAGE_RESERVED
))

430 ià(
cu¼’t
->
rss
 > 0)

431 --
cu¼’t
->
rss
;

432 
	`ä“_·ge
(
PAGE_MASK
 & 
·ge
);

434 
	`sw­_ä“
(
·ge
);

443 ià(!
mask
)

444 *
·ge_bË
++ = 0;

445 ià(
to
 >ğ
high_memÜy
)

446 *
·ge_bË
++ = (
to
 | 
mask
);

447 ià(!
mem_m­
[
	`MAP_NR
(
to
)])

448 *
·ge_bË
++ = 0;

450 *
·ge_bË
++ = (
to
 | 
mask
);

451 ià(!(
mem_m­
[
	`MAP_NR
(
to
)] & 
MAP_PAGE_RESERVED
)) {

452 ++
cu¼’t
->
rss
;

453 
mem_m­
[
	`MAP_NR
(
to
)]++;

456 
to
 +ğ
PAGE_SIZE
;

458 
pút
 = (
size
 > 
PTRS_PER_PAGE
 ? PTRS_PER_PAGE : size);

460 
	`šv®id©e
();

462 
	}
}

470 
	$put_·ge
(
sk_¡ruù
 * 
tsk
,
·ge
,

471 
add»ss
,
´Ù
)

473 *
·ge_bË
;

475 ià((
´Ù
 & (
PAGE_MASK
|
PAGE_PRESENT
)) != PAGE_PRESENT)

476 
	`´štk
("put_·ge:…rÙ = %08x\n",
´Ù
);

477 ià(
·ge
 >ğ
high_memÜy
) {

478 
	`´štk
("put_·ge:ryšgØpuˆ·g%08lx‡ˆ%08lx\n",
·ge
,
add»ss
);

481 
·ge_bË
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

482 ià((*
·ge_bË
è& 
PAGE_PRESENT
)

483 
·ge_bË
 = (*è(
PAGE_MASK
 & *page_table);

485 
	`´štk
("put_page: bad…age directoryƒntry\n");

486 
	`oom
(
tsk
);

487 *
·ge_bË
 = 
BAD_PAGETABLE
 | 
PAGE_TABLE
;

490 
·ge_bË
 +ğ(
add»ss
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

491 ià(*
·ge_bË
) {

492 
	`´štk
("put_page:…age‡lreadyƒxists\n");

493 *
·ge_bË
 = 0;

494 
	`šv®id©e
();

496 *
·ge_bË
 = 
·ge
 | 
´Ù
;

498  
·ge
;

499 
	}
}

507 
	$put_dœty_·ge
(
sk_¡ruù
 * 
tsk
, 
·ge
, 
add»ss
)

509 
tmp
, *
·ge_bË
;

511 ià(
·ge
 >ğ
high_memÜy
)

512 
	`´štk
("put_dœty_·ge:ryšgØpuˆ·g%08lx‡ˆ%08lx\n",
·ge
,
add»ss
);

513 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] != 1)

514 
	`´štk
("mem_m­ di§g»e w™h %08lx‡ˆ%08lx\n",
·ge
,
add»ss
);

515 
·ge_bË
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

516 ià(
PAGE_PRESENT
 & *
·ge_bË
)

517 
·ge_bË
 = (*è(
PAGE_MASK
 & *page_table);

519 ià(!(
tmp
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
)))

521 ià(
PAGE_PRESENT
 & *
·ge_bË
) {

522 
	`ä“_·ge
(
tmp
);

523 
·ge_bË
 = (*è(
PAGE_MASK
 & *page_table);

525 *
·ge_bË
 = 
tmp
 | 
PAGE_TABLE
;

526 
·ge_bË
 = (*è
tmp
;

529 
·ge_bË
 +ğ(
add»ss
 >> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

530 ià(*
·ge_bË
) {

531 
	`´štk
("put_dirty_page:…age‡lreadyƒxists\n");

532 *
·ge_bË
 = 0;

533 
	`šv®id©e
();

535 *
·ge_bË
 = 
·ge
 | (
PAGE_DIRTY
 | 
PAGE_PRIVATE
);

537  
·ge
;

538 
	}
}

551 
	$__do_wp_·ge
(
”rÜ_code
, 
add»ss
,

552 
sk_¡ruù
 * 
tsk
, 
u£r_e¥
)

554 *
pde
, 
±e
, 
Şd_·ge
, 
´Ù
;

555 
Ãw_·ge
;

557 
Ãw_·ge
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

558 
pde
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

559 
±e
 = *
pde
;

560 ià(!(
±e
 & 
PAGE_PRESENT
))

561 
’d_wp_·ge
;

562 ià((
±e
 & 
PAGE_TABLE
è!ğPAGE_TABLE ||…‹ >ğ
high_memÜy
)

563 
bad_wp_·g‘abË
;

564 
±e
 &ğ
PAGE_MASK
;

565 
±e
 +ğ
	`PAGE_PTR
(
add»ss
);

566 
Şd_·ge
 = *(*è
±e
;

567 ià(!(
Şd_·ge
 & 
PAGE_PRESENT
))

568 
’d_wp_·ge
;

569 ià(
Şd_·ge
 >ğ
high_memÜy
)

570 
bad_wp_·ge
;

571 ià(
Şd_·ge
 & 
PAGE_RW
)

572 
’d_wp_·ge
;

573 
tsk
->
mš_æt
++;

574 
´Ù
 = (
Şd_·ge
 & ~
PAGE_MASK
è| 
PAGE_RW
;

575 
Şd_·ge
 &ğ
PAGE_MASK
;

576 ià(
mem_m­
[
	`MAP_NR
(
Şd_·ge
)] != 1) {

577 ià(
Ãw_·ge
) {

578 ià(
mem_m­
[
	`MAP_NR
(
Şd_·ge
)] & 
MAP_PAGE_RESERVED
)

579 ++
tsk
->
rss
;

580 
	`cİy_·ge
(
Şd_·ge
,
Ãw_·ge
);

581 *(*è
±e
 = 
Ãw_·ge
 | 
´Ù
;

582 
	`ä“_·ge
(
Şd_·ge
);

583 
	`šv®id©e
();

586 
	`ä“_·ge
(
Şd_·ge
);

587 
	`oom
(
tsk
);

588 *(*è
±e
 = 
BAD_PAGE
 | 
´Ù
;

589 
	`šv®id©e
();

592 *(*è
±e
 |ğ
PAGE_RW
;

593 
	`šv®id©e
();

594 ià(
Ãw_·ge
)

595 
	`ä“_·ge
(
Ãw_·ge
);

597 
bad_wp_·ge
:

598 
	`´štk
("do_wp_·ge: bogu ·g©‡dd»s %08lx (%08lx)\n",
add»ss
,
Şd_·ge
);

599 *(*è
±e
 = 
BAD_PAGE
 | 
PAGE_SHARED
;

600 
	`£nd_sig
(
SIGKILL
, 
tsk
, 1);

601 
’d_wp_·ge
;

602 
bad_wp_·g‘abË
:

603 
	`´štk
("do_wp_·ge: bogu ·ge-bË‡ˆadd»s %08lx (%08lx)\n",
add»ss
,
±e
);

604 *
pde
 = 
BAD_PAGETABLE
 | 
PAGE_TABLE
;

605 
	`£nd_sig
(
SIGKILL
, 
tsk
, 1);

606 
’d_wp_·ge
:

607 ià(
Ãw_·ge
)

608 
	`ä“_·ge
(
Ãw_·ge
);

610 
	}
}

616 
	$do_wp_·ge
(
”rÜ_code
, 
add»ss
,

617 
sk_¡ruù
 * 
tsk
, 
u£r_e¥
)

619 
·ge
;

620 * 
pg_bË
;

622 
pg_bË
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

623 
·ge
 = *
pg_bË
;

624 ià(!
·ge
)

626 ià((
·ge
 & 
PAGE_PRESENT
è&&…ag< 
high_memÜy
) {

627 
pg_bË
 = (*è((
·ge
 & 
PAGE_MASK
è+ 
	`PAGE_PTR
(
add»ss
));

628 
·ge
 = *
pg_bË
;

629 ià(!(
·ge
 & 
PAGE_PRESENT
))

631 ià(
·ge
 & 
PAGE_RW
)

633 ià(!(
·ge
 & 
PAGE_COW
)) {

634 ià(
u£r_e¥
 && 
tsk
 =ğ
cu¼’t
) {

635 
cu¼’t
->
tss
.
ü2
 = 
add»ss
;

636 
cu¼’t
->
tss
.
”rÜ_code
 =ƒrror_code;

637 
cu¼’t
->
tss
.
Œ­_no
 = 14;

638 
	`£nd_sig
(
SIGSEGV
, 
tsk
, 1);

642 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] == 1) {

643 *
pg_bË
 |ğ
PAGE_RW
 | 
PAGE_DIRTY
;

644 
	`šv®id©e
();

647 
	`__do_wp_·ge
(
”rÜ_code
, 
add»ss
, 
tsk
, 
u£r_e¥
);

650 
	`´štk
("bad…agdœeùÜyƒÁry %08lx\n",
·ge
);

651 *
pg_bË
 = 0;

652 
	}
}

654 
	$__v”ify_wr™e
(
¡¬t
, 
size
)

656 
size
--;

657 
size
 +ğ
¡¬t
 & ~
PAGE_MASK
;

658 
size
 >>ğ
PAGE_SHIFT
;

659 
¡¬t
 &ğ
PAGE_MASK
;

661 
	`do_wp_·ge
(1,
¡¬t
,
cu¼’t
,0);

662 
¡¬t
 +ğ
PAGE_SIZE
;

663 } 
size
--);

665 
	}
}

667 
šlše
 
	$g‘_em±y_·ge
(
sk_¡ruù
 * 
tsk
, 
add»ss
)

669 
tmp
;

671 ià(!(
tmp
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

672 
	`oom
(
tsk
);

673 
tmp
 = 
BAD_PAGE
;

675 ià(!
	`put_·ge
(
tsk
,
tmp
,
add»ss
,
PAGE_PRIVATE
))

676 
	`ä“_·ge
(
tmp
);

677 
	}
}

693 
	$Œy_to_sh¬e
(
add»ss
, 
sk_¡ruù
 * 
tsk
,

694 
sk_¡ruù
 * 
p
, 
”rÜ_code
, 
Ãw·ge
)

696 
äom
;

697 
to
;

698 
äom_·ge
;

699 
to_·ge
;

701 
äom_·ge
 = ()
	`PAGE_DIR_OFFSET
(
p
->
tss
.
ü3
,
add»ss
);

702 
to_·ge
 = ()
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

704 
äom
 = *(*è
äom_·ge
;

705 ià(!(
äom
 & 
PAGE_PRESENT
))

707 
äom
 &ğ
PAGE_MASK
;

708 
äom_·ge
 = 
äom
 + 
	`PAGE_PTR
(
add»ss
);

709 
äom
 = *(*è
äom_·ge
;

711 ià((
äom
 & (
PAGE_PRESENT
 | 
PAGE_DIRTY
)) != PAGE_PRESENT)

713 ià(
äom
 >ğ
high_memÜy
)

715 ià(
mem_m­
[
	`MAP_NR
(
äom
)] & 
MAP_PAGE_RESERVED
)

718 
to
 = *(*è
to_·ge
;

719 ià(!(
to
 & 
PAGE_PRESENT
))

721 
to
 &ğ
PAGE_MASK
;

722 
to_·ge
 = 
to
 + 
	`PAGE_PTR
(
add»ss
);

723 ià(*(*è
to_·ge
)

726 ià(
”rÜ_code
 & 
PAGE_RW
) {

727 if(!
Ãw·ge
)

729 
	`cİy_·ge
((
äom
 & 
PAGE_MASK
),
Ãw·ge
);

730 
to
 = 
Ãw·ge
 | 
PAGE_PRIVATE
;

732 
mem_m­
[
	`MAP_NR
(
äom
)]++;

733 
äom
 &ğ~
PAGE_RW
;

734 
to
 = 
äom
;

735 if(
Ãw·ge
)

736 
	`ä“_·ge
(
Ãw·ge
);

738 *(*è
äom_·ge
 = 
äom
;

739 *(*è
to_·ge
 = 
to
;

740 
	`šv®id©e
();

742 
	}
}

752 
	$sh¬e_·ge
(
vm_¬—_¡ruù
 * 
¬—
, 
sk_¡ruù
 * 
tsk
,

753 
šode
 * inode,

754 
add»ss
, 
”rÜ_code
, 
Ãw·ge
)

756 
sk_¡ruù
 ** 
p
;

758 ià(!
šode
 || inode->
i_couÁ
 < 2 || !
¬—
->
vm_İs
)

760 
p
 = &
LAST_TASK
 ;… > &
FIRST_TASK
 ; --p) {

761 ià(!*
p
)

763 ià(
tsk
 =ğ*
p
)

765 ià(
šode
 !ğ(*
p
)->
execubË
) {

766 if(!
¬—
) ;

769 if(
¬—
){

770 
vm_¬—_¡ruù
 * 
m²t
;

771 
m²t
 = (*
p
)->
mm­
; m²t; m²ˆğm²t->
vm_Ãxt
) {

772 ià(
m²t
->
vm_İs
 =ğ
¬—
->vm_ops &&

773 
m²t
->
vm_šode
->
i_šo
 =ğ
¬—
->vm_inode->i_ino&&

774 
m²t
->
vm_šode
->
i_dev
 =ğ
¬—
->vm_inode->i_dev){

775 ià(
m²t
->
vm_İs
->
	`sh¬e
(m²t, 
¬—
, 
add»ss
))

779 ià(!
m²t
) ;

782 ià(
	`Œy_to_sh¬e
(
add»ss
,
tsk
,*
p
,
”rÜ_code
,
Ãw·ge
))

786 
	}
}

791 
šlše
 
	$g‘_em±y_pgbË
(
sk_¡ruù
 * 
tsk
,
add»ss
)

793 
·ge
;

794 *
p
;

796 
p
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

797 ià(
PAGE_PRESENT
 & *
p
)

798  *
p
;

799 ià(*
p
) {

800 
	`´štk
("get_empty_pgtable: bad…age-directoryƒntry \n");

801 *
p
 = 0;

803 
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

804 
p
 = 
	`PAGE_DIR_OFFSET
(
tsk
->
tss
.
ü3
,
add»ss
);

805 ià(
PAGE_PRESENT
 & *
p
) {

806 
	`ä“_·ge
(
·ge
);

807  *
p
;

809 ià(*
p
) {

810 
	`´štk
("get_empty_pgtable: bad…age-directoryƒntry \n");

811 *
p
 = 0;

813 ià(
·ge
) {

814 *
p
 = 
·ge
 | 
PAGE_TABLE
;

815  *
p
;

817 
	`oom
(
cu¼’t
);

818 *
p
 = 
BAD_PAGETABLE
 | 
PAGE_TABLE
;

820 
	}
}

822 
	$do_no_·ge
(
”rÜ_code
, 
add»ss
,

823 
sk_¡ruù
 *
tsk
, 
u£r_e¥
)

825 
tmp
;

826 
·ge
;

827 
vm_¬—_¡ruù
 * 
m²t
;

829 
·ge
 = 
	`g‘_em±y_pgbË
(
tsk
,
add»ss
);

830 ià(!
·ge
)

832 
·ge
 &ğ
PAGE_MASK
;

833 
·ge
 +ğ
	`PAGE_PTR
(
add»ss
);

834 
tmp
 = *(*è
·ge
;

835 ià(
tmp
 & 
PAGE_PRESENT
)

837 ++
tsk
->
rss
;

838 ià(
tmp
) {

839 ++
tsk
->
maj_æt
;

840 
	`sw­_š
((*è
·ge
);

843 
add»ss
 &= 0xfffff000;

844 
tmp
 = 0;

845 
m²t
 = 
tsk
->
mm­
; m²ˆ!ğ
NULL
; m²ˆğm²t->
vm_Ãxt
) {

846 ià(
add»ss
 < 
m²t
->
vm_¡¬t
)

848 ià(
add»ss
 >ğ
m²t
->
vm_’d
) {

849 
tmp
 = 
m²t
->
vm_’d
;

852 ià(!
m²t
->
vm_İs
 || !m²t->vm_İs->
nİage
) {

853 ++
tsk
->
mš_æt
;

854 
	`g‘_em±y_·ge
(
tsk
,
add»ss
);

857 
m²t
->
vm_İs
->
	`nİage
(
”rÜ_code
, m²t, 
add»ss
);

860 ià(
tsk
 !ğ
cu¼’t
)

861 
ok_no_·ge
;

862 ià(
add»ss
 >ğ
tsk
->
’d_d©a
 &&‡dd»s <sk->
brk
)

863 
ok_no_·ge
;

864 ià(
m²t
 && m²ˆ=ğ
tsk
->
¡k_vma
 &&

865 
add»ss
 - 
tmp
 > 
m²t
->
vm_¡¬t
 -‡ddress &&

866 
tsk
->
¾im
[
RLIMIT_STACK
].
¾im_cur
 > 
m²t
->
vm_’d
 - 
add»ss
) {

867 
m²t
->
vm_¡¬t
 = 
add»ss
;

868 
ok_no_·ge
;

870 
tsk
->
tss
.
ü2
 = 
add»ss
;

871 
cu¼’t
->
tss
.
”rÜ_code
 =ƒrror_code;

872 
cu¼’t
->
tss
.
Œ­_no
 = 14;

873 
	`£nd_sig
(
SIGSEGV
,
tsk
,1);

874 ià(
”rÜ_code
 & 4)

876 
ok_no_·ge
:

877 ++
tsk
->
mš_æt
;

878 
	`g‘_em±y_·ge
(
tsk
,
add»ss
);

879 
	}
}

886 
asmlškage
 
	$do_·ge_çuÉ
(
±_»gs
 *
»gs
, 
”rÜ_code
)

888 
add»ss
;

889 
u£r_e¥
 = 0;

890 
b™
;

893 
	`__asm__
("movÈ%%ü2,%0":"ô" (
add»ss
));

894 ià(
add»ss
 < 
TASK_SIZE
) {

895 ià(
”rÜ_code
 & 4) {

896 ià(
»gs
->
eæags
 & 
VM_MASK
) {

897 
b™
 = (
add»ss
 - 0xA0000è>> 
PAGE_SHIFT
;

898 ià(
b™
 < 32)

899 
cu¼’t
->
sü“n_b™m­
 |ğ1 << 
b™
;

901 
u£r_e¥
 = 
»gs
->
e¥
;

903 ià(
”rÜ_code
 & 1)

904 
	`do_wp_·ge
(
”rÜ_code
, 
add»ss
, 
cu¼’t
, 
u£r_e¥
);

906 
	`do_no_·ge
(
”rÜ_code
, 
add»ss
, 
cu¼’t
, 
u£r_e¥
);

909 
add»ss
 -ğ
TASK_SIZE
;

910 ià(
wp_wÜks_ok
 < 0 && 
add»ss
 =ğ0 && (
”rÜ_code
 & 
PAGE_PRESENT
)) {

911 
wp_wÜks_ok
 = 1;

912 
pg0
[0] = 
PAGE_SHARED
;

913 
	`´štk
("This…rocessor honourshe WP bitƒven when in supervisor mode. Good.\n");

916 ià(
add»ss
 < 
PAGE_SIZE
) {

917 
	`´štk
("Unableo handle kernel NULL…ointer dereference");

918 
pg0
[0] = 
PAGE_SHARED
;

920 
	`´štk
("Unableo handle kernel…aging„equest");

921 
	`´štk
("‡ˆadd»s %08lx\n",
add»ss
);

922 
	`d›_if_k”Ãl
("Oİs", 
»gs
, 
”rÜ_code
);

923 
	`do_ex™
(
SIGKILL
);

924 
	}
}

939 
	$__bad_·g‘abË
()

941 
em±y_bad_·ge_bË
[
PAGE_SIZE
];

943 
__asm__
 
	`__vŞ©e__
("cld ;„ep ; stosl":

944 :"a" (
BAD_PAGE
 + 
PAGE_TABLE
),

945 "D" ((è
em±y_bad_·ge_bË
),

946 "c" (
PTRS_PER_PAGE
)

948  (è
em±y_bad_·ge_bË
;

949 
	}
}

951 
	$__bad_·ge
()

953 
em±y_bad_·ge
[
PAGE_SIZE
];

955 
__asm__
 
	`__vŞ©e__
("cld ;„ep ; stosl":

957 "D" ((è
em±y_bad_·ge
),

958 "c" (
PTRS_PER_PAGE
)

960  (è
em±y_bad_·ge
;

961 
	}
}

963 
	$__z”o_·ge
()

965 
em±y_z”o_·ge
[
PAGE_SIZE
];

967 
__asm__
 
	`__vŞ©e__
("cld ;„ep ; stosl":

969 "D" ((è
em±y_z”o_·ge
),

970 "c" (
PTRS_PER_PAGE
)

972  (è
em±y_z”o_·ge
;

973 
	}
}

975 
	$show_mem
()

977 
i
,
ä“
 = 0,
tÙ®
 = 0,
»£rved
 = 0;

978 
sh¬ed
 = 0;

980 
	`´štk
("Mem-info:\n");

981 
	`´štk
("F»·ges: %6dkB\n",
Ä_ä“_·ges
<<(
PAGE_SHIFT
-10));

982 
	`´štk
("SecÚd¬y…ages: %6dkB\n",
Ä_£cÚd¬y_·ges
<<(
PAGE_SHIFT
-10));

983 
	`´štk
("F»sw­: %6dkB\n",
Ä_sw­_·ges
<<(
PAGE_SHIFT
-10));

984 
i
 = 
high_memÜy
 >> 
PAGE_SHIFT
;

985 
i
-- > 0) {

986 
tÙ®
++;

987 ià(
mem_m­
[
i
] & 
MAP_PAGE_RESERVED
)

988 
»£rved
++;

989 ià(!
mem_m­
[
i
])

990 
ä“
++;

992 
sh¬ed
 +ğ
mem_m­
[
i
]-1;

994 
	`´štk
("%d…age oàRAM\n",
tÙ®
);

995 
	`´štk
("%d f»·ges\n",
ä“
);

996 
	`´štk
("%d„e£rved…ages\n",
»£rved
);

997 
	`´štk
("%d…age sh¬ed\n",
sh¬ed
);

998 
	`show_bufãrs
();

999 
	}
}

1008 
	$·gšg_š™
(
¡¬t_mem
, 
’d_mem
)

1010 * 
pg_dœ
;

1011 * 
pg_bË
;

1012 
tmp
;

1013 
add»ss
;

1022 
	`mem£t
((*è0, 0, 
PAGE_SIZE
);

1024 
¡¬t_mem
 = 
	`PAGE_ALIGN
(start_mem);

1025 
add»ss
 = 0;

1026 
pg_dœ
 = 
sw­³r_pg_dœ
;

1027 
add»ss
 < 
’d_mem
) {

1028 
tmp
 = *(
pg_dœ
 + 768);

1029 ià(!
tmp
) {

1030 
tmp
 = 
¡¬t_mem
 | 
PAGE_TABLE
;

1031 *(
pg_dœ
 + 768èğ
tmp
;

1032 
¡¬t_mem
 +ğ
PAGE_SIZE
;

1034 *
pg_dœ
 = 
tmp
;

1035 
pg_dœ
++;

1036 
pg_bË
 = (*è(
tmp
 & 
PAGE_MASK
);

1037 
tmp
 = 0 ;m°< 
PTRS_PER_PAGE
 ;mp++,
pg_bË
++) {

1038 ià(
add»ss
 < 
’d_mem
)

1039 *
pg_bË
 = 
add»ss
 | 
PAGE_SHARED
;

1041 *
pg_bË
 = 0;

1042 
add»ss
 +ğ
PAGE_SIZE
;

1045 
	`šv®id©e
();

1046  
¡¬t_mem
;

1047 
	}
}

1049 
	$mem_š™
(
¡¬t_low_mem
,

1050 
¡¬t_mem
, 
’d_mem
)

1052 
cod•ages
 = 0;

1053 
»£rved·ges
 = 0;

1054 
d©­ages
 = 0;

1055 
tmp
;

1056 * 
p
;

1057 
‘ext
;

1059 
	`şi
();

1060 
’d_mem
 &ğ
PAGE_MASK
;

1061 
high_memÜy
 = 
’d_mem
;

1062 
¡¬t_mem
 += 0x0000000f;

1063 
¡¬t_mem
 &= ~0x0000000f;

1064 
tmp
 = 
	`MAP_NR
(
’d_mem
);

1065 
mem_m­
 = (*è
¡¬t_mem
;

1066 
p
 = 
mem_m­
 + 
tmp
;

1067 
¡¬t_mem
 = (è
p
;

1068 
p
 > 
mem_m­
)

1069 *--
p
 = 
MAP_PAGE_RESERVED
;

1070 
¡¬t_low_mem
 = 
	`PAGE_ALIGN
(start_low_mem);

1071 
¡¬t_mem
 = 
	`PAGE_ALIGN
(start_mem);

1072 
¡¬t_low_mem
 < 0xA0000) {

1073 
mem_m­
[
	`MAP_NR
(
¡¬t_low_mem
)] = 0;

1074 
¡¬t_low_mem
 +ğ
PAGE_SIZE
;

1076 
¡¬t_mem
 < 
’d_mem
) {

1077 
mem_m­
[
	`MAP_NR
(
¡¬t_mem
)] = 0;

1078 
¡¬t_mem
 +ğ
PAGE_SIZE
;

1080 #ifdeà
CONFIG_SOUND


1081 
	`sound_mem_š™
();

1083 
ä“_·ge_li¡
 = 0;

1084 
Ä_ä“_·ges
 = 0;

1085 
tmp
 = 0 ;m°< 
’d_mem
 ;m°+ğ
PAGE_SIZE
) {

1086 ià(
mem_m­
[
	`MAP_NR
(
tmp
)]) {

1087 ià(
tmp
 >= 0xA0000 &&mp < 0x100000)

1088 
»£rved·ges
++;

1089 ià(
tmp
 < (è&
‘ext
)

1090 
cod•ages
++;

1092 
d©­ages
++;

1095 *(*è
tmp
 = 
ä“_·ge_li¡
;

1096 
ä“_·ge_li¡
 = 
tmp
;

1097 
Ä_ä“_·ges
++;

1099 
tmp
 = 
Ä_ä“_·ges
 << 
PAGE_SHIFT
;

1100 
	`´štk
("Memory: %luk/%luk‡vailable (%dk kernel code, %dk„eserved, %dk data)\n",

1101 
tmp
 >> 10,

1102 
’d_mem
 >> 10,

1103 
cod•ages
 << (
PAGE_SHIFT
-10),

1104 
»£rved·ges
 << (
PAGE_SHIFT
-10),

1105 
d©­ages
 << (
PAGE_SHIFT
-10));

1107 
wp_wÜks_ok
 = -1;

1108 
pg0
[0] = 
PAGE_READONLY
;

1109 
	`šv®id©e
();

1110 
__asm__
 
	`__vŞ©e__
("movb 0,%%al ; movb %%al,0": : :"ax", "memory");

1111 
pg0
[0] = 0;

1112 
	`šv®id©e
();

1113 ià(
wp_wÜks_ok
 < 0)

1114 
wp_wÜks_ok
 = 0;

1116 
	}
}

1118 
	$si_memšfo
(
sysšfo
 *
v®
)

1120 
i
;

1122 
i
 = 
high_memÜy
 >> 
PAGE_SHIFT
;

1123 
v®
->
tÙ®¿m
 = 0;

1124 
v®
->
ä“¿m
 = 0;

1125 
v®
->
sh¬ed¿m
 = 0;

1126 
v®
->
bufã¼am
 = 
bufãrmem
;

1127 
i
-- > 0) {

1128 ià(
mem_m­
[
i
] & 
MAP_PAGE_RESERVED
)

1130 
v®
->
tÙ®¿m
++;

1131 ià(!
mem_m­
[
i
]) {

1132 
v®
->
ä“¿m
++;

1135 
v®
->
sh¬ed¿m
 +ğ
mem_m­
[
i
]-1;

1137 
v®
->
tÙ®¿m
 <<ğ
PAGE_SHIFT
;

1138 
v®
->
ä“¿m
 <<ğ
PAGE_SHIFT
;

1139 
v®
->
sh¬ed¿m
 <<ğ
PAGE_SHIFT
;

1141 
	}
}

1145 
	$fe_mm­_nİage
(
”rÜ_code
, 
vm_¬—_¡ruù
 * 
¬—
, 
add»ss
)

1147 
šode
 * inodğ
¬—
->
vm_šode
;

1148 
block
;

1149 
·ge
;

1150 
Ä
[8];

1151 
i
, 
j
;

1152 
´Ù
 = 
¬—
->
vm_·ge_´Ù
;

1154 
add»ss
 &ğ
PAGE_MASK
;

1155 
block
 = 
add»ss
 - 
¬—
->
vm_¡¬t
 +‡»a->
vm_off£t
;

1156 
block
 >>ğ
šode
->
i_sb
->
s_blocksize_b™s
;

1158 
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

1159 ià(
	`sh¬e_·ge
(
¬—
,‡»a->
vm_sk
, 
šode
, 
add»ss
, 
”rÜ_code
, 
·ge
)) {

1160 ++
¬—
->
vm_sk
->
mš_æt
;

1164 ++
¬—
->
vm_sk
->
maj_æt
;

1165 ià(!
·ge
) {

1166 
	`oom
(
cu¼’t
);

1167 
	`put_·ge
(
¬—
->
vm_sk
, 
BAD_PAGE
, 
add»ss
, 
PAGE_PRIVATE
);

1170 
i
=0, 
j
=0; i< 
PAGE_SIZE
 ; j++, 
block
++, i +ğ
šode
->
i_sb
->
s_blocksize
)

1171 
Ä
[
j
] = 
	`bm­
(
šode
,
block
);

1172 ià(
”rÜ_code
 & 
PAGE_RW
)

1173 
´Ù
 |ğ
PAGE_RW
 | 
PAGE_DIRTY
;

1174 
·ge
 = 
	`b»ad_·ge
Õage, 
šode
->
i_dev
, 
Ä
, inode->
i_sb
->
s_blocksize
, 
´Ù
);

1176 ià(!(
´Ù
 & 
PAGE_RW
)) {

1177 ià(
	`sh¬e_·ge
(
¬—
,‡»a->
vm_sk
, 
šode
, 
add»ss
, 
”rÜ_code
, 
·ge
))

1180 ià(
	`put_·ge
(
¬—
->
vm_sk
,
·ge
,
add»ss
,
´Ù
))

1182 
	`ä“_·ge
(
·ge
);

1183 
	`oom
(
cu¼’t
);

1184 
	}
}

1186 
	$fe_mm­_ä“
(
vm_¬—_¡ruù
 * 
¬—
)

1188 ià(
¬—
->
vm_šode
)

1189 
	`ut
(
¬—
->
vm_šode
);

1191 ià(
¬—
->
vm_šode
)

1192 
	`´štk
("F»šod%x:%d (%d)\n",
¬—
->
vm_šode
->
i_dev
,

1193 
¬—
->
vm_šode
->
i_šo
,‡»a->vm_šode->
i_couÁ
);

1195 
	}
}

1201 
	$fe_mm­_sh¬e
(
vm_¬—_¡ruù
 * 
¬—1
,

1202 
vm_¬—_¡ruù
 * 
¬—2
,

1203 
add»ss
)

1205 ià(
¬—1
->
vm_šode
 !ğ
¬—2
->vm_inode)

1207 ià(
¬—1
->
vm_¡¬t
 !ğ
¬—2
->vm_start)

1209 ià(
¬—1
->
vm_’d
 !ğ
¬—2
->vm_end)

1211 ià(
¬—1
->
vm_off£t
 !ğ
¬—2
->vm_offset)

1213 ià(
¬—1
->
vm_·ge_´Ù
 !ğ
¬—2
->vm_page_prot)

1216 
	}
}

1218 
vm_İ”©iÚs_¡ruù
 
	gfe_mm­
 = {

1219 
NULL
,

1220 
fe_mm­_ä“
,

1221 
fe_mm­_nİage
,

1222 
NULL
,

1223 
fe_mm­_sh¬e
,

1224 
NULL
,

	@mm/mmap.c

6 
	~<lšux/¡©.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/k”Ãl.h
>

9 
	~<lšux/mm.h
>

10 
	~<lšux/shm.h
>

11 
	~<lšux/”ºo.h
>

12 
	~<lšux/mmª.h
>

13 
	~<lšux/¡ršg.h
>

14 
	~<lšux/m®loc.h
>

16 
	~<asm/£gm’t.h
>

17 
	~<asm/sy¡em.h
>

19 
ªÚ_m­
(
šode
 *, 
fe
 *,

20 , 
size_t
, ,

39 
	#CODE_SPACE
(
addr
) \

40 (
	`PAGE_ALIGN
(
addr
è< 
cu¼’t
->
¡¬t_code
 + cu¼’t->
’d_code
)

	)

42 
	$do_mm­
(
fe
 * fe, 
addr
, 
Ën
,

43 
´Ù
, 
æags
, 
off
)

45 
mask
, 
”rÜ
;

47 ià((
Ën
 = 
	`PAGE_ALIGN
(len)) == 0)

48  
addr
;

50 ià(
addr
 > 
TASK_SIZE
 || 
Ën
 > TASK_SIZE ||‡ddr > TASK_SIZE-len)

51  -
EINVAL
;

59 ià(
fe
 !ğ
NULL
)

60 
æags
 & 
MAP_TYPE
) {

61 
MAP_SHARED
:

62 ià((
´Ù
 & 
PROT_WRITE
è&& !(
fe
->
f_mode
 & 2))

63  -
EACCES
;

65 
MAP_PRIVATE
:

66 ià(!(
fe
->
f_mode
 & 1))

67  -
EACCES
;

71  -
EINVAL
;

78 ià(
æags
 & 
MAP_FIXED
) {

79 ià(
addr
 & ~
PAGE_MASK
)

80  -
EINVAL
;

81 ià(
Ën
 > 
TASK_SIZE
 || 
addr
 > TASK_SIZE -†en)

82  -
EINVAL
;

84 
vm_¬—_¡ruù
 * 
vmm
;

87 
addr
 = 
SHM_RANGE_START
;

88 
addr
+
Ën
 < 
SHM_RANGE_END
) {

89 
vmm
 = 
cu¼’t
->
mm­
 ; vmm ; vmm = vmm->
vm_Ãxt
) {

90 ià(
addr
 >ğ
vmm
->
vm_’d
)

92 ià(
addr
 + 
Ën
 <ğ
vmm
->
vm_¡¬t
)

94 
addr
 = 
	`PAGE_ALIGN
(
vmm
->
vm_’d
);

97 ià(!
vmm
)

100 ià(
addr
+
Ën
 >ğ
SHM_RANGE_END
)

101  -
ENOMEM
;

109 ià(
fe
 && (!fe->
f_İ
 || !fe->f_İ->
mm­
))

110  -
ENODEV
;

111 
mask
 = 0;

112 ià(
´Ù
 & (
PROT_READ
 | 
PROT_EXEC
))

113 
mask
 |ğ
PAGE_READONLY
;

114 ià(
´Ù
 & 
PROT_WRITE
)

115 ià((
æags
 & 
MAP_TYPE
è=ğ
MAP_PRIVATE
)

116 
mask
 |ğ
PAGE_COPY
;

118 
mask
 |ğ
PAGE_SHARED
;

119 ià(!
mask
)

120  -
EINVAL
;

122 
	`do_munm­
(
addr
, 
Ën
);

124 ià(
fe
)

125 
”rÜ
 = 
fe
->
f_İ
->
	`mm­
(fe->
f_šode
, fe, 
addr
, 
Ën
, 
mask
, 
off
);

127 
”rÜ
 = 
	`ªÚ_m­
(
NULL
, NULL, 
addr
, 
Ën
, 
mask
, 
off
);

129 ià(!
”rÜ
)

130  
addr
;

132 ià(!
cu¼’t
->
”ºo
)

133 
cu¼’t
->
”ºo
 = -
”rÜ
;

135 
	}
}

137 
asmlškage
 
	$sys_mm­
(*
bufãr
)

139 
”rÜ
;

140 
æags
;

141 
fe
 * fğ
NULL
;

143 
”rÜ
 = 
	`v”ify_¬—
(
VERIFY_READ
, 
bufãr
, 6*4);

144 ià(
”rÜ
)

145  
”rÜ
;

146 
æags
 = 
	`g‘_fs_lÚg
(
bufãr
+3);

147 ià(!(
æags
 & 
MAP_ANONYMOUS
)) {

148 
fd
 = 
	`g‘_fs_lÚg
(
bufãr
+4);

149 ià(
fd
 >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd]))

150  -
EBADF
;

152  
	`do_mm­
(
fe
, 
	`g‘_fs_lÚg
(
bufãr
), get_fs_long(buffer+1),

153 
	`g‘_fs_lÚg
(
bufãr
+2), 
æags
, get_fs_long(buffer+5));

154 
	}
}

178 
	$unm­_fixup
(
vm_¬—_¡ruù
 *
¬—
,

179 
addr
, 
size_t
 
Ën
)

181 
vm_¬—_¡ruù
 *
m²t
;

182 
’d
 = 
addr
 + 
Ën
;

184 ià(
addr
 < 
¬—
->
vm_¡¬t
 ||‡dd¸>ğ¬—->
vm_’d
 ||

185 
’d
 <ğ
¬—
->
vm_¡¬t
 ||ƒnd >‡»a->
vm_’d
 ||

186 
’d
 < 
addr
)

188 
	`´štk
("unmap_fixup:‡rea=%lx-%lx, unmap %lx-%lx!!\n",

189 
¬—
->
vm_¡¬t
,‡»a->
vm_’d
, 
addr
, 
’d
);

194 ià(
addr
 =ğ
¬—
->
vm_¡¬t
 && 
’d
 =ğ¬—->
vm_’d
) {

195 ià(
¬—
->
vm_İs
 &&‡»a->vm_İs->
şo£
)

196 
¬—
->
vm_İs
->
	`şo£
(area);

201 ià(
addr
 >ğ
¬—
->
vm_¡¬t
 && 
’d
 =ğ¬—->
vm_’d
)

202 
¬—
->
vm_’d
 = 
addr
;

203 ià(
addr
 =ğ
¬—
->
vm_¡¬t
 && 
’d
 <ğ¬—->
vm_’d
) {

204 
¬—
->
vm_off£t
 +ğ(
’d
 -‡»a->
vm_¡¬t
);

205 
¬—
->
vm_¡¬t
 = 
’d
;

209 ià(
addr
 > 
¬—
->
vm_¡¬t
 && 
’d
 <‡»a->
vm_’d
)

212 
m²t
 = (
vm_¬—_¡ruù
 *)
	`km®loc
((*m²t), 
GFP_KERNEL
);

214 *
m²t
 = *
¬—
;

215 
m²t
->
vm_off£t
 +ğ(
’d
 - 
¬—
->
vm_¡¬t
);

216 
m²t
->
vm_¡¬t
 = 
’d
;

217 ià(
m²t
->
vm_šode
)

218 
m²t
->
vm_šode
->
i_couÁ
++;

219 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

220 
¬—
->
vm_’d
 = 
addr
;

224 
m²t
 = (
vm_¬—_¡ruù
 *)
	`km®loc
((*m²t), 
GFP_KERNEL
);

225 *
m²t
 = *
¬—
;

226 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

227 
	}
}

230 
asmlškage
 
	$sys_m´Ùeù
(
addr
, 
size_t
 
Ën
, 
´Ù
)

232  -
EINVAL
;

233 
	}
}

235 
asmlškage
 
	$sys_munm­
(
addr
, 
size_t
 
Ën
)

237  
	`do_munm­
(
addr
, 
Ën
);

238 
	}
}

246 
	$do_munm­
(
addr
, 
size_t
 
Ën
)

248 
vm_¬—_¡ruù
 *
m²t
, **
Åp
, *
ä“
;

250 ià((
addr
 & ~
PAGE_MASK
è||‡dd¸> 
TASK_SIZE
 || 
Ën
 > TASK_SIZE-addr)

251  -
EINVAL
;

253 ià((
Ën
 = 
	`PAGE_ALIGN
(len)) == 0)

262 
Åp
 = &
cu¼’t
->
mm­
;

263 
ä“
 = 
NULL
;

264 
m²t
 = *
Åp
; m²ˆ!ğ
NULL
; mpnt = *npp) {

265 
’d
 = 
addr
+
Ën
;

267 ià((
addr
 < 
m²t
->
vm_¡¬t
 && 
’d
 <= mpnt->vm_start) ||

268 (
addr
 >ğ
m²t
->
vm_’d
 && 
’d
 > mpnt->vm_end))

270 
Åp
 = &
m²t
->
vm_Ãxt
;

274 *
Åp
 = 
m²t
->
vm_Ãxt
;

275 
m²t
->
vm_Ãxt
 = 
ä“
;

276 
ä“
 = 
m²t
;

279 ià(
ä“
 =ğ
NULL
)

288 
ä“
) {

289 
¡
, 
’d
;

291 
m²t
 = 
ä“
;

292 
ä“
 = f»e->
vm_Ãxt
;

294 
¡
 = 
addr
 < 
m²t
->
vm_¡¬t
 ? mpnt->vm_start :‡ddr;

295 
’d
 = 
addr
+
Ën
;

296 
’d
 =ƒnd > 
m²t
->
vm_’d
 ? mpnt->vm_end :ƒnd;

298 ià(
m²t
->
vm_İs
 && m²t->vm_İs->
unm­
)

299 
m²t
->
vm_İs
->
	`unm­
(m²t, 
¡
, 
’d
-st);

301 
	`unm­_fixup
(
m²t
, 
¡
, 
’d
-st);

303 
	`kä“
(
m²t
);

306 
	`unm­_·ge_¿nge
(
addr
, 
Ën
);

308 
	}
}

311 
	$g’”ic_mm­
(
šode
 * inode, 
fe
 * file,

312 
addr
, 
size_t
 
Ën
, 
´Ù
, 
off
)

314 
vm_¬—_¡ruù
 * 
m²t
;

315 
vm_İ”©iÚs_¡ruù
 
fe_mm­
;

316 
bufãr_h—d
 * 
bh
;

318 ià(
´Ù
 & 
PAGE_RW
)

319  -
EINVAL
;

320 ià(
off
 & (
šode
->
i_sb
->
s_blocksize
 - 1))

321  -
EINVAL
;

322 ià(!
šode
->
i_sb
 || !
	`S_ISREG
(šode->
i_mode
))

323  -
EACCES
;

324 ià(!
šode
->
i_İ
 || !šode->i_İ->
bm­
)

325  -
ENOEXEC
;

326 ià(!(
bh
 = 
	`b»ad
(
šode
->
i_dev
,
	`bm­
(šode,0),šode->
i_sb
->
s_blocksize
)))

327  -
EACCES
;

328 ià(!
	`IS_RDONLY
(
šode
)) {

329 
šode
->
i_©ime
 = 
CURRENT_TIME
;

330 
šode
->
i_dœt
 = 1;

332 
	`b»l£
(
bh
);

334 
m²t
 = (
vm_¬—_¡ruù
 * ) 
	`km®loc
((vm_¬—_¡ruù), 
GFP_KERNEL
);

335 ià(!
m²t
)

336  -
ENOMEM
;

338 
	`unm­_·ge_¿nge
(
addr
, 
Ën
);

339 
m²t
->
vm_sk
 = 
cu¼’t
;

340 
m²t
->
vm_¡¬t
 = 
addr
;

341 
m²t
->
vm_’d
 = 
addr
 + 
Ën
;

342 
m²t
->
vm_·ge_´Ù
 = 
´Ù
;

343 
m²t
->
vm_sh¬e
 = 
NULL
;

344 
m²t
->
vm_šode
 = 
šode
;

345 
šode
->
i_couÁ
++;

346 
m²t
->
vm_off£t
 = 
off
;

347 
m²t
->
vm_İs
 = &
fe_mm­
;

348 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

349 
	`m”ge_£gm’ts
(
cu¼’t
->
mm­
, 
NULL
, NULL);

352 
	}
}

360 
	$š£¹_vm_¡ruù
(
sk_¡ruù
 *
t
, 
vm_¬—_¡ruù
 *
vmp
)

362 
vm_¬—_¡ruù
 **
nxp
, *
m²t
;

364 
nxp
 = &
t
->
mm­
;

366 
m²t
 = 
t
->
mm­
; m²ˆ!ğ
NULL
; m²ˆğm²t->
vm_Ãxt
)

368 ià(
m²t
->
vm_¡¬t
 > 
vmp
->vm_start)

370 
nxp
 = &
m²t
->
vm_Ãxt
;

372 ià((
vmp
->
vm_¡¬t
 >ğ
m²t
->vm_start &&

373 
vmp
->
vm_¡¬t
 < 
m²t
->
vm_’d
) ||

374 (
vmp
->
vm_’d
 >ğ
m²t
->
vm_¡¬t
 &&

375 
vmp
->
vm_’d
 < 
m²t
->vm_end))

376 
	`´štk
("insert_vm_struct: ins‡rea %lx-%lx in‡rea %lx-%lx\n",

377 
vmp
->
vm_¡¬t
, vmp->
vm_’d
,

378 
m²t
->
vm_¡¬t
, 
vmp
->
vm_’d
);

381 
vmp
->
vm_Ãxt
 = 
m²t
;

383 *
nxp
 = 
vmp
;

384 
	}
}

391 
	$m”ge_£gm’ts
(
vm_¬—_¡ruù
 *
m²t
,

392 
m­_m”g•_âp
 
m”g•
, *
mpd
)

394 
vm_¬—_¡ruù
 *
´ev
, *
Ãxt
;

396 ià(
m²t
 =ğ
NULL
)

399 
´ev
 = 
m²t
, m²ˆğm²t->
vm_Ãxt
;

400 
m²t
 !ğ
NULL
;

401 
´ev
 = 
m²t
, m²ˆğ
Ãxt
)

403 
mp
;

405 
Ãxt
 = 
m²t
->
vm_Ãxt
;

407 ià(
m”g•
 =ğ
NULL
)

409 
psz
 = 
´ev
->
vm_’d
 -…»v->
vm_¡¬t
;

410 
mp
 = 
´ev
->
vm_off£t
 + 
psz
 =ğ
m²t
->vm_offset;

413 
mp
 = (*
m”g•
)(
´ev
, 
m²t
, 
mpd
);

420 ià(
´ev
->
vm_İs
 !ğ
m²t
->vm_ops ||

421 
´ev
->
vm_·ge_´Ù
 !ğ
m²t
->vm_page_prot ||

422 
´ev
->
vm_šode
 !ğ
m²t
->vm_inode ||

423 
´ev
->
vm_’d
 !ğ
m²t
->
vm_¡¬t
 ||

424 !
mp
 ||

425 
´ev
->
vm_sh¬e
 !ğ
m²t
->vm_share ||

426 
´ev
->
vm_Ãxt
 !ğ
m²t
)

434 
´ev
->
vm_’d
 = 
m²t
->vm_end;

435 
´ev
->
vm_Ãxt
 = 
m²t
->vm_next;

436 
	`kä“_s
(
m²t
, (*mpnt));

437 
m²t
 = 
´ev
;

439 
	}
}

445 
	$ªÚ_m­
(
šode
 *
šo
, 
fe
 * file,

446 
addr
, 
size_t
 
Ën
, 
mask
,

447 
off
)

449 
vm_¬—_¡ruù
 * 
m²t
;

451 ià(
	`z”om­_·ge_¿nge
(
addr
, 
Ën
, 
mask
))

452  -
ENOMEM
;

454 
m²t
 = (
vm_¬—_¡ruù
 * ) 
	`km®loc
((vm_¬—_¡ruù), 
GFP_KERNEL
);

455 ià(!
m²t
)

456  -
ENOMEM
;

458 
m²t
->
vm_sk
 = 
cu¼’t
;

459 
m²t
->
vm_¡¬t
 = 
addr
;

460 
m²t
->
vm_’d
 = 
addr
 + 
Ën
;

461 
m²t
->
vm_·ge_´Ù
 = 
mask
;

462 
m²t
->
vm_sh¬e
 = 
NULL
;

463 
m²t
->
vm_šode
 = 
NULL
;

464 
m²t
->
vm_off£t
 = 0;

465 
m²t
->
vm_İs
 = 
NULL
;

466 
	`š£¹_vm_¡ruù
(
cu¼’t
, 
m²t
);

467 
	`m”ge_£gm’ts
(
cu¼’t
->
mm­
, 
ignoff_m”g•
, 
NULL
);

470 
	}
}

473 
	$ignoff_m”g•
(cÚ¡ 
vm_¬—_¡ruù
 *
m1
,

474 cÚ¡ 
vm_¬—_¡ruù
 *
m2
,

475 *
d©a
)

477 ià(
m1
->
vm_šode
 !ğ
m2
->vm_inode)

480  (
šode
 *)
d©a
 =ğ
m1
->
vm_šode
;

481 
	}
}

	@mm/swap.c

12 
	~<lšux/mm.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/h—d.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/k”Ãl_¡©.h
>

17 
	~<lšux/”ºo.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/¡©.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/b™İs.h
>

24 
	#MAX_SWAPFILES
 8

	)

26 
	#SWP_USED
 1

	)

27 
	#SWP_WRITEOK
 3

	)

29 
	#SWP_TYPE
(
’Œy
è((ÓÁryè& 0xãè>> 1)

	)

30 
	#SWP_OFFSET
(
’Œy
è(ÓÁryè>> 
PAGE_SHIFT
)

	)

31 
	#SWP_ENTRY
(
ty³
,
off£t
è((Ñy³è<< 1è| ((off£tè<< 
PAGE_SHIFT
))

	)

33 
	gÄ_sw­fes
 = 0;

34 
wa™_queue
 * 
	glock_queue
 = 
NULL
;

36 
	ssw­_šfo_¡ruù
 {

37 
	mæags
;

38 
šode
 * 
	msw­_fe
;

39 
	msw­_deviû
;

40 * 
	msw­_m­
;

41 * 
	msw­_lockm­
;

42 
	m·ges
;

43 
	mlowe¡_b™
;

44 
	mhighe¡_b™
;

45 
	mmax
;

46 } 
	gsw­_šfo
[
MAX_SWAPFILES
];

48 
ä“_·ge_li¡
;

49 
shm_sw­
 ();

55 
	#NR_LAST_FREE_PAGES
 32

	)

56 
	gÏ¡_ä“_·ges
[
NR_LAST_FREE_PAGES
] = {0,};

58 
	$rw_sw­_·ge
(
rw
, 
’Œy
, * 
buf
)

60 
ty³
, 
off£t
;

61 
sw­_šfo_¡ruù
 * 
p
;

63 
ty³
 = 
	`SWP_TYPE
(
’Œy
);

64 ià(
ty³
 >ğ
Ä_sw­fes
) {

65 
	`´štk
("Internalƒrror: bad swap-device\n");

68 
p
 = &
sw­_šfo
[
ty³
];

69 
off£t
 = 
	`SWP_OFFSET
(
’Œy
);

70 ià(
off£t
 >ğ
p
->
max
) {

71 
	`´štk
("rw_swap_page: weirdness\n");

74 ià(!(
p
->
æags
 & 
SWP_USED
)) {

75 
	`´štk
("Tryingo swapo unused swap-device\n");

78 
	`£t_b™
(
off£t
,
p
->
sw­_lockm­
))

79 
	`¦“p_Ú
(&
lock_queue
);

80 ià(
rw
 =ğ
READ
)

81 
k¡©
.
pswpš
++;

83 
k¡©
.
pswpout
++;

84 ià(
p
->
sw­_deviû
) {

85 
	`Î_rw_·ge
(
rw
,
p
->
sw­_deviû
,
off£t
,
buf
);

86 } ià(
p
->
sw­_fe
) {

87 
zÚes
[8];

88 
block
;

89 
i
, 
j
;

91 
block
 = 
off£t
 << (12 - 
p
->
sw­_fe
->
i_sb
->
s_blocksize_b™s
);

93 
i
=0, 
j
=0; j< 
PAGE_SIZE
 ; i++, j +=
p
->
sw­_fe
->
i_sb
->
s_blocksize
)

94 ià(!(
zÚes
[
i
] = 
	`bm­
(
p
->
sw­_fe
,
block
++))) {

95 
	`´štk
("rw_swap_page: bad swap file\n");

98 
	`Î_rw_sw­_fe
(
rw
,
p
->
sw­_fe
->
i_dev
, 
zÚes
, 
i
,
buf
);

100 
	`´štk
("re_swap_page:‚o swap file or device\n");

101 ià(
off£t
 && !
	`ş—r_b™
(off£t,
p
->
sw­_lockm­
))

102 
	`´štk
("rw_swap_page:†ock‡lready cleared\n");

103 
	`wake_up
(&
lock_queue
);

104 
	}
}

106 
	$g‘_sw­_·ge
()

108 
sw­_šfo_¡ruù
 * 
p
;

109 
off£t
, 
ty³
;

111 
p
 = 
sw­_šfo
;

112 
ty³
 = 0 ;y³ < 
Ä_sw­fes
 ;y³++,
p
++) {

113 ià((
p
->
æags
 & 
SWP_WRITEOK
) != SWP_WRITEOK)

115 
off£t
 = 
p
->
lowe¡_b™
; off£ˆ<ğp->
highe¡_b™
 ; offset++) {

116 ià(
p
->
sw­_m­
[
off£t
])

118 
p
->
sw­_m­
[
off£t
] = 1;

119 
Ä_sw­_·ges
--;

120 ià(
off£t
 =ğ
p
->
highe¡_b™
)

121 
p
->
highe¡_b™
--;

122 
p
->
lowe¡_b™
 = 
off£t
;

123  
	`SWP_ENTRY
(
ty³
,
off£t
);

127 
	}
}

129 
	$sw­_du¶iÿ‹
(
’Œy
)

131 
sw­_šfo_¡ruù
 * 
p
;

132 
off£t
, 
ty³
;

134 ià(!
’Œy
)

136 
off£t
 = 
	`SWP_OFFSET
(
’Œy
);

137 
ty³
 = 
	`SWP_TYPE
(
’Œy
);

138 ià(
ty³
 =ğ
SHM_SWP_TYPE
)

139  
’Œy
;

140 ià(
ty³
 >ğ
Ä_sw­fes
) {

141 
	`´štk
("Tryingo duplicate‚onexistent swap-page\n");

144 
p
 = 
ty³
 + 
sw­_šfo
;

145 ià(
off£t
 >ğ
p
->
max
) {

146 
	`´štk
("swap_free: weirdness\n");

149 ià(!
p
->
sw­_m­
[
off£t
]) {

150 
	`´štk
("swap_duplicate:ryingo duplicate unused…age\n");

153 
p
->
sw­_m­
[
off£t
]++;

154  
’Œy
;

155 
	}
}

157 
	$sw­_ä“
(
’Œy
)

159 
sw­_šfo_¡ruù
 * 
p
;

160 
off£t
, 
ty³
;

162 ià(!
’Œy
)

164 
ty³
 = 
	`SWP_TYPE
(
’Œy
);

165 ià(
ty³
 =ğ
SHM_SWP_TYPE
)

167 ià(
ty³
 >ğ
Ä_sw­fes
) {

168 
	`´štk
("Tryingo free‚onexistent swap-page\n");

171 
p
 = & 
sw­_šfo
[
ty³
];

172 
off£t
 = 
	`SWP_OFFSET
(
’Œy
);

173 ià(
off£t
 >ğ
p
->
max
) {

174 
	`´štk
("swap_free: weirdness\n");

177 ià(!(
p
->
æags
 & 
SWP_USED
)) {

178 
	`´štk
("Tryingo free swap from unused swap-device\n");

181 
	`£t_b™
(
off£t
,
p
->
sw­_lockm­
))

182 
	`¦“p_Ú
(&
lock_queue
);

183 ià(
off£t
 < 
p
->
lowe¡_b™
)

184 
p
->
lowe¡_b™
 = 
off£t
;

185 ià(
off£t
 > 
p
->
highe¡_b™
)

186 
p
->
highe¡_b™
 = 
off£t
;

187 ià(!
p
->
sw­_m­
[
off£t
])

188 
	`´štk
("sw­_ä“: sw­-¥aû m­ bad (’Œy %08lx)\n",
’Œy
);

190 ià(!--
p
->
sw­_m­
[
off£t
])

191 
Ä_sw­_·ges
++;

192 ià(!
	`ş—r_b™
(
off£t
,
p
->
sw­_lockm­
))

193 
	`´štk
("swap_free:†ock‡lready cleared\n");

194 
	`wake_up
(&
lock_queue
);

195 
	}
}

197 
	$sw­_š
(*
bË_±r
)

199 
’Œy
;

200 
·ge
;

202 
’Œy
 = *
bË_±r
;

203 ià(
PAGE_PRESENT
 & 
’Œy
) {

204 
	`´štk
("tryingo swap in…resent…age\n");

207 ià(!
’Œy
) {

208 
	`´štk
("No swap…age in swap_in\n");

211 ià(
	`SWP_TYPE
(
’Œy
è=ğ
SHM_SWP_TYPE
) {

212 
	`shm_no_·ge
 ((*è
bË_±r
);

215 ià(!(
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
))) {

216 
	`oom
(
cu¼’t
);

217 
·ge
 = 
BAD_PAGE
;

219 
	`»ad_sw­_·ge
(
’Œy
, (*è
·ge
);

220 ià(*
bË_±r
 !ğ
’Œy
) {

221 
	`ä“_·ge
(
·ge
);

224 *
bË_±r
 = 
·ge
 | (
PAGE_DIRTY
 | 
PAGE_PRIVATE
);

225 
	`sw­_ä“
(
’Œy
);

226 
	}
}

228 
šlše
 
	$Œy_to_sw­_out
(* 
bË_±r
)

230 
i
;

231 
·ge
;

232 
’Œy
;

234 
·ge
 = *
bË_±r
;

235 ià(!(
PAGE_PRESENT
 & 
·ge
))

237 ià(
·ge
 >ğ
high_memÜy
)

239 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] & 
MAP_PAGE_RESERVED
)

241 ià(
PAGE_ACCESSED
 & 
·ge
) {

242 *
bË_±r
 &ğ~
PAGE_ACCESSED
;

245 
i
 = 0; i < 
NR_LAST_FREE_PAGES
; i++)

246 ià(
Ï¡_ä“_·ges
[
i
] =ğ(
·ge
 & 
PAGE_MASK
))

248 ià(
PAGE_DIRTY
 & 
·ge
) {

249 
·ge
 &ğ
PAGE_MASK
;

250 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] != 1)

252 ià(!(
’Œy
 = 
	`g‘_sw­_·ge
()))

254 *
bË_±r
 = 
’Œy
;

255 
	`šv®id©e
();

256 
	`wr™e_sw­_·ge
(
’Œy
, (*è
·ge
);

257 
	`ä“_·ge
(
·ge
);

260 
·ge
 &ğ
PAGE_MASK
;

261 *
bË_±r
 = 0;

262 
	`šv®id©e
();

263 
	`ä“_·ge
(
·ge
);

264  1 + 
mem_m­
[
	`MAP_NR
(
·ge
)];

265 
	}
}

272 
asmlškage
 
	$sys_idË
()

274 
Ãed_»sched
 = 1;

276 
	}
}

291 #ifdeà
NEW_SWAP


296 
	#SWAP_MIN
 4

	)

297 
	#SWAP_MAX
 32

	)

303 
	#SWAP_RATIO
 128

	)

305 
	$sw­_out
(
´iÜ™y
)

307 
sw­_sk
;

308 
bË
;

309 
·ge
;

310 
pg_bË
;

311 
loİ
;

312 
couÁ”
 = 
NR_TASKS
 * 2 >> 
´iÜ™y
;

313 
sk_¡ruù
 *
p
;

315 
couÁ”
 = 
NR_TASKS
 * 2 >> 
´iÜ™y
;

316 ; 
couÁ”
 >ğ0; couÁ”--, 
sw­_sk
++) {

321 
loİ
 = 0;

323 if(
sw­_sk
 >ğ
NR_TASKS
) {

324 
sw­_sk
 = 1;

325 if(
loİ
)

328 
loİ
 = 1;

331 
p
 = 
sk
[
sw­_sk
];

332 if(
p
 &&…->
sw­·bË
 &&…->
rss
)

335 
sw­_sk
++;

341 if(! 
p
 -> 
sw­_út
) {

342 
p
->
dec_æt
 = (p->dec_æˆ* 3è/ 4 +…->
maj_æt
 -…->
Şd_maj_æt
;

343 
p
->
Şd_maj_æt
 =…->
maj_æt
;

345 if(
p
->
dec_æt
 >ğ
SWAP_RATIO
 / 
SWAP_MIN
) {

346 
p
->
dec_æt
 = 
SWAP_RATIO
 / 
SWAP_MIN
;

347 
p
->
sw­_út
 = 
SWAP_MIN
;

348 } if(
p
->
dec_æt
 <ğ
SWAP_RATIO
 / 
SWAP_MAX
)

349 
p
->
sw­_út
 = 
SWAP_MAX
;

351 
p
->
sw­_út
 = 
SWAP_RATIO
 /…->
dec_æt
;

357 
bË
 = 
p
->
sw­_bË
;able < 1024;able++) {

358 
pg_bË
 = ((*è
p
->
tss
.
ü3
)[
bË
];

359 if(
pg_bË
 >ğ
high_memÜy
)

361 if(
mem_m­
[
	`MAP_NR
(
pg_bË
)] & 
MAP_PAGE_RESERVED
)

363 if(!(
PAGE_PRESENT
 & 
pg_bË
)) {

364 
	`´štk
("swap_out: bad…age-table‡t…g_dir[%d]: %08lx\n",

365 
bË
, 
pg_bË
);

366 ((*è
p
->
tss
.
ü3
)[
bË
] = 0;

369 
pg_bË
 &= 0xfffff000;

374 
·ge
 = 
p
->
sw­_·ge
;…age < 1024;…age++) {

375 
	`Œy_to_sw­_out
(
·ge
 + (*è
pg_bË
)) {

380 
p
->
rss
--;

382 
p
->
sw­_bË
 = 
bË
;

383 
p
->
sw­_·ge
 = 
·ge
 + 1;

384 if((--
p
->
sw­_út
) == 0)

385 
sw­_sk
++;

389 
p
->
rss
--;

394 
p
->
sw­_·ge
 = 0;

401 
p
->
sw­_bË
 = 0;

404 
	}
}

416 
	$sw­_out
(
´iÜ™y
)

418 
sw­_sk
 = 1;

419 
sw­_bË
 = 0;

420 
sw­_·ge
 = 0;

421 
couÁ”
 = 
NR_TASKS
*8;

422 
pg_bË
;

423 
sk_¡ruù
 * 
p
;

425 
couÁ”
 >>ğ
´iÜ™y
;

426 
check_sk
:

427 ià(
couÁ”
-- < 0)

429 ià(
sw­_sk
 >ğ
NR_TASKS
) {

430 
sw­_sk
 = 1;

431 
check_sk
;

433 
p
 = 
sk
[
sw­_sk
];

434 ià(!
p
 || !p->
sw­·bË
) {

435 
sw­_sk
++;

436 
check_sk
;

438 
check_dœ
:

439 ià(
sw­_bË
 >ğ
PTRS_PER_PAGE
) {

440 
sw­_bË
 = 0;

441 
sw­_sk
++;

442 
check_sk
;

444 
pg_bË
 = ((*è
p
->
tss
.
ü3
)[
sw­_bË
];

445 ià(
pg_bË
 >ğ
high_memÜy
 || (
mem_m­
[
	`MAP_NR
Õg_bË)] & 
MAP_PAGE_RESERVED
)) {

446 
sw­_bË
++;

447 
check_dœ
;

449 ià(!(
PAGE_PRESENT
 & 
pg_bË
)) {

450 
	`´štk
("bad…age-table‡t…g_dir[%d]: %08x\n",

451 
sw­_bË
,
pg_bË
);

452 ((*è
p
->
tss
.
ü3
)[
sw­_bË
] = 0;

453 
sw­_bË
++;

454 
check_dœ
;

456 
pg_bË
 &ğ
PAGE_MASK
;

457 
check_bË
:

458 ià(
sw­_·ge
 >ğ
PTRS_PER_PAGE
) {

459 
sw­_·ge
 = 0;

460 
sw­_bË
++;

461 
check_dœ
;

463 
	`Œy_to_sw­_out
(
sw­_·ge
 + (*è
pg_bË
)) {

465 1: 
p
->
rss
--;  1;

466 : 
p
->
rss
--;

468 
sw­_·ge
++;

469 
check_bË
;

470 
	}
}

474 
	$Œy_to_ä“_·ge
()

476 
i
=6;

478 
i
--) {

479 ià(
	`shršk_bufãrs
(
i
))

481 ià(
	`shm_sw­
(
i
))

483 ià(
	`sw­_out
(
i
))

487 
	}
}

494 
šlše
 
	$add_mem_queue
(
addr
, * 
queue
)

496 
addr
 &ğ
PAGE_MASK
;

497 *(*è
addr
 = *
queue
;

498 *
queue
 = 
addr
;

499 
	}
}

512 
	$ä“_·ge
(
addr
)

514 ià(
addr
 < 
high_memÜy
) {

515 * 
m­
 = 
mem_m­
 + 
	`MAP_NR
(
addr
);

517 ià(*
m­
) {

518 ià(!(*
m­
 & 
MAP_PAGE_RESERVED
)) {

519 
æag
;

521 
	`§ve_æags
(
æag
);

522 
	`şi
();

523 ià(!--*
m­
) {

524 ià(
Ä_£cÚd¬y_·ges
 < 
MAX_SECONDARY_PAGES
) {

525 
	`add_mem_queue
(
addr
,&
£cÚd¬y_·ge_li¡
);

526 
Ä_£cÚd¬y_·ges
++;

527 
	`»¡Üe_æags
(
æag
);

530 
	`add_mem_queue
(
addr
,&
ä“_·ge_li¡
);

531 
Ä_ä“_·ges
++;

533 
	`»¡Üe_æags
(
æag
);

537 
	`´štk
("TryšgØä“ f»memÜy (%08lx): memÜy…robabably cÜru±ed\n",
addr
);

538 
	`´štk
("PC = %08lx\n",*(((*)&
addr
)-1));

541 
	}
}

553 
	#REMOVE_FROM_MEM_QUEUE
(
queue
,
Ä
) \

554 
	`şi
(); \

555 ià((
»suÉ
 = 
queue
) != 0) { \

556 ià(!(
»suÉ
 & ~
PAGE_MASK
è&&„esuÉ < 
high_memÜy
) { \

557 
queue
 = *(*è
»suÉ
; \

558 ià(!
mem_m­
[
	`MAP_NR
(
»suÉ
)]) { \

559 
mem_m­
[
	`MAP_NR
(
»suÉ
)] = 1; \

560 
Ä
--; \

561 
Ï¡_ä“_·ges
[
šdex
 = (šdex + 1è& (
NR_LAST_FREE_PAGES
 - 1)] = 
»suÉ
; \

562 
	`»¡Üe_æags
(
æag
); \

563  
»suÉ
; \

565 
	`´štk
("Free…age %08lx has mem_map = %d\n", \

566 
»suÉ
,
mem_m­
[
	`MAP_NR
(result)]); \

568 
	`´štk
("ResuÉ = 0x%08lx - memÜy m­ de¡royed\n", 
»suÉ
); \

569 
queue
 = 0; \

570 
Ä
 = 0; \

571 } ià(
Ä
) { \

572 
	`´štk
(#Ä " i %d, buˆ" #queu" i em±y\n",
Ä
); \

573 
Ä
 = 0; \

575 
	`»¡Üe_æags
(
æag
)

	)

586 
	$__g‘_ä“_·ge
(
´iÜ™y
)

588 
šŒ_couÁ
;

589 
»suÉ
, 
æag
;

590 
šdex
 = 0;

597 ià(
šŒ_couÁ
 && 
´iÜ™y
 !ğ
GFP_ATOMIC
) {

598 
	`´štk
("gfp called‚onatomically from interrupt %08lx\n",

599 ((*)&
´iÜ™y
)[-1]);

600 
´iÜ™y
 = 
GFP_ATOMIC
;

602 
	`§ve_æags
(
æag
);

603 
»³©
:

604 
	`REMOVE_FROM_MEM_QUEUE
(
ä“_·ge_li¡
,
Ä_ä“_·ges
);

605 ià(
´iÜ™y
 =ğ
GFP_BUFFER
)

607 ià(
´iÜ™y
 !ğ
GFP_ATOMIC
)

608 ià(
	`Œy_to_ä“_·ge
())

609 
»³©
;

610 
	`REMOVE_FROM_MEM_QUEUE
(
£cÚd¬y_·ge_li¡
,
Ä_£cÚd¬y_·ges
);

612 
	}
}

619 
	$Œy_to_unu£
(
ty³
)

621 
Ä
, 
pgt
, 
pg
;

622 
·ge
, *
µage
;

623 
tmp
 = 0;

624 
sk_¡ruù
 *
p
;

626 
Ä
 = 0;

631 
»³©
:

632 ; 
Ä
 < 
NR_TASKS
 ;‚r++) {

633 
p
 = 
sk
[
Ä
];

634 ià(!
p
)

636 
pgt
 = 0 ;…gˆ< 
PTRS_PER_PAGE
 ;…gt++) {

637 
µage
 = 
pgt
 + ((*è
p
->
tss
.
ü3
);

638 
·ge
 = *
µage
;

639 ià(!
·ge
)

641 ià(!(
·ge
 & 
PAGE_PRESENT
è|| (·g>ğ
high_memÜy
))

643 ià(
mem_m­
[
	`MAP_NR
(
·ge
)] & 
MAP_PAGE_RESERVED
)

645 
µage
 = (*è(
·ge
 & 
PAGE_MASK
);

646 
pg
 = 0 ;…g < 
PTRS_PER_PAGE
 ;…g++,
µage
++) {

647 
·ge
 = *
µage
;

648 ià(!
·ge
)

650 ià(
·ge
 & 
PAGE_PRESENT
)

652 ià(
	`SWP_TYPE
(
·ge
è!ğ
ty³
)

654 ià(!
tmp
) {

655 ià(!(
tmp
 = 
	`__g‘_ä“_·ge
(
GFP_KERNEL
)))

656  -
ENOMEM
;

657 
»³©
;

659 
	`»ad_sw­_·ge
(
·ge
, (*è
tmp
);

660 ià(*
µage
 =ğ
·ge
) {

661 *
µage
 = 
tmp
 | (
PAGE_DIRTY
 | 
PAGE_PRIVATE
);

662 ++
p
->
rss
;

663 
	`sw­_ä“
(
·ge
);

664 
tmp
 = 0;

666 
»³©
;

670 
	`ä“_·ge
(
tmp
);

672 
	}
}

674 
asmlškage
 
	$sys_sw­off
(cÚ¡ * 
¥ecŸlfe
)

676 
sw­_šfo_¡ruù
 * 
p
;

677 
šode
 * inode;

678 
ty³
;

679 
i
;

681 ià(!
	`su£r
())

682  -
EPERM
;

683 
i
 = 
	`Çmei
(
¥ecŸlfe
,&
šode
);

684 ià(
i
)

685  
i
;

686 
p
 = 
sw­_šfo
;

687 
ty³
 = 0 ;y³ < 
Ä_sw­fes
 ;y³++,
p
++) {

688 ià((
p
->
æags
 & 
SWP_WRITEOK
) != SWP_WRITEOK)

690 ià(
p
->
sw­_fe
) {

691 ià(
p
->
sw­_fe
 =ğ
šode
)

694 ià(!
	`S_ISBLK
(
šode
->
i_mode
))

696 ià(
p
->
sw­_deviû
 =ğ
šode
->
i_rdev
)

700 
	`ut
(
šode
);

701 ià(
ty³
 >ğ
Ä_sw­fes
)

702  -
EINVAL
;

703 
p
->
æags
 = 
SWP_USED
;

704 
i
 = 
	`Œy_to_unu£
(
ty³
);

705 ià(
i
) {

706 
p
->
æags
 = 
SWP_WRITEOK
;

707  
i
;

709 
Ä_sw­_·ges
 -ğ
p
->
·ges
;

710 
	`ut
(
p
->
sw­_fe
);

711 
p
->
sw­_fe
 = 
NULL
;

712 
p
->
sw­_deviû
 = 0;

713 
	`vä“
(
p
->
sw­_m­
);

714 
p
->
sw­_m­
 = 
NULL
;

715 
	`ä“_·ge
((è
p
->
sw­_lockm­
);

716 
p
->
sw­_lockm­
 = 
NULL
;

717 
p
->
æags
 = 0;

719 
	}
}

726 
asmlškage
 
	$sys_sw­Ú
(cÚ¡ * 
¥ecŸlfe
)

728 
sw­_šfo_¡ruù
 * 
p
;

729 
šode
 * 
sw­_šode
;

730 
ty³
;

731 
i
,
j
;

732 
”rÜ
;

734 ià(!
	`su£r
())

735  -
EPERM
;

736 
p
 = 
sw­_šfo
;

737 
ty³
 = 0 ;y³ < 
Ä_sw­fes
 ;y³++,
p
++)

738 ià(!(
p
->
æags
 & 
SWP_USED
))

740 ià(
ty³
 >ğ
MAX_SWAPFILES
)

741  -
EPERM
;

742 ià(
ty³
 >ğ
Ä_sw­fes
)

743 
Ä_sw­fes
 = 
ty³
+1;

744 
p
->
æags
 = 
SWP_USED
;

745 
p
->
sw­_fe
 = 
NULL
;

746 
p
->
sw­_deviû
 = 0;

747 
p
->
sw­_m­
 = 
NULL
;

748 
p
->
sw­_lockm­
 = 
NULL
;

749 
p
->
lowe¡_b™
 = 0;

750 
p
->
highe¡_b™
 = 0;

751 
p
->
max
 = 1;

752 
”rÜ
 = 
	`Çmei
(
¥ecŸlfe
,&
sw­_šode
);

753 ià(
”rÜ
)

754 
bad_sw­
;

755 
”rÜ
 = -
EBUSY
;

756 ià(
sw­_šode
->
i_couÁ
 != 1)

757 
bad_sw­
;

758 
”rÜ
 = -
EINVAL
;

759 ià(
	`S_ISBLK
(
sw­_šode
->
i_mode
)) {

760 
p
->
sw­_deviû
 = 
sw­_šode
->
i_rdev
;

761 
	`ut
(
sw­_šode
);

762 
”rÜ
 = -
ENODEV
;

763 ià(!
p
->
sw­_deviû
)

764 
bad_sw­
;

765 
”rÜ
 = -
EBUSY
;

766 
i
 = 0 ; i < 
Ä_sw­fes
 ; i++) {

767 ià(
i
 =ğ
ty³
)

769 ià(
p
->
sw­_deviû
 =ğ
sw­_šfo
[
i
].swap_device)

770 
bad_sw­
;

772 } ià(
	`S_ISREG
(
sw­_šode
->
i_mode
))

773 
p
->
sw­_fe
 = 
sw­_šode
;

775 
bad_sw­
;

776 
p
->
sw­_lockm­
 = (*è
	`g‘_ä“_·ge
(
GFP_USER
);

777 ià(!
p
->
sw­_lockm­
) {

778 
	`´štk
("Unableo start swapping: out of memory :-)\n");

779 
”rÜ
 = -
ENOMEM
;

780 
bad_sw­
;

782 
	`»ad_sw­_·ge
(
	`SWP_ENTRY
(
ty³
,0), (*è
p
->
sw­_lockm­
);

783 ià(
	`memcmp
("SWAP-SPACE",
p
->
sw­_lockm­
+4086,10)) {

784 
	`´štk
("Unableo find swap-space signature\n");

785 
”rÜ
 = -
EINVAL
;

786 
bad_sw­
;

788 
	`mem£t
(
p
->
sw­_lockm­
+
PAGE_SIZE
-10,0,10);

789 
j
 = 0;

790 
p
->
lowe¡_b™
 = 0;

791 
p
->
highe¡_b™
 = 0;

792 
i
 = 1 ; i < 8*
PAGE_SIZE
 ; i++) {

793 ià(
	`‹¡_b™
(
i
,
p
->
sw­_lockm­
)) {

794 ià(!
p
->
lowe¡_b™
)

795 
p
->
lowe¡_b™
 = 
i
;

796 
p
->
highe¡_b™
 = 
i
;

797 
p
->
max
 = 
i
+1;

798 
j
++;

801 ià(!
j
) {

802 
	`´štk
("Empty swap-file\n");

803 
”rÜ
 = -
EINVAL
;

804 
bad_sw­
;

806 
p
->
sw­_m­
 = (*è
	`vm®loc
Õ->
max
);

807 ià(!
p
->
sw­_m­
) {

808 
”rÜ
 = -
ENOMEM
;

809 
bad_sw­
;

811 
i
 = 1 ; i < 
p
->
max
 ; i++) {

812 ià(
	`‹¡_b™
(
i
,
p
->
sw­_lockm­
))

813 
p
->
sw­_m­
[
i
] = 0;

815 
p
->
sw­_m­
[
i
] = 0x80;

817 
p
->
sw­_m­
[0] = 0x80;

818 
	`mem£t
(
p
->
sw­_lockm­
,0,
PAGE_SIZE
);

819 
p
->
æags
 = 
SWP_WRITEOK
;

820 
p
->
·ges
 = 
j
;

821 
Ä_sw­_·ges
 +ğ
j
;

822 
	`´štk
("Addšg Sw­: %dk sw­-¥aû\n",
j
<<2);

824 
bad_sw­
:

825 
	`ä“_·ge
((è
p
->
sw­_lockm­
);

826 
	`vä“
(
p
->
sw­_m­
);

827 
	`ut
(
p
->
sw­_fe
);

828 
p
->
sw­_deviû
 = 0;

829 
p
->
sw­_fe
 = 
NULL
;

830 
p
->
sw­_m­
 = 
NULL
;

831 
p
->
sw­_lockm­
 = 
NULL
;

832 
p
->
æags
 = 0;

833  
”rÜ
;

834 
	}
}

836 
	$si_sw­šfo
(
sysšfo
 *
v®
)

838 
i
, 
j
;

840 
v®
->
ä“sw­
 = v®->
tÙ®sw­
 = 0;

841 
i
 = 0; i < 
Ä_sw­fes
; i++) {

842 ià(!(
sw­_šfo
[
i
].
æags
 & 
SWP_USED
))

844 
j
 = 0; j < 
sw­_šfo
[
i
].
max
; ++j)

845 
sw­_šfo
[
i
].
sw­_m­
[
j
]) {

849 ++
v®
->
ä“sw­
;

851 ++
v®
->
tÙ®sw­
;

854 
v®
->
ä“sw­
 <<ğ
PAGE_SHIFT
;

855 
v®
->
tÙ®sw­
 <<ğ
PAGE_SHIFT
;

857 
	}
}

	@mm/vmalloc.c

7 
	~<asm/sy¡em.h
>

8 
	~<lšux/cÚfig.h
>

10 
	~<lšux/sigÇl.h
>

11 
	~<lšux/sched.h
>

12 
	~<lšux/h—d.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/m®loc.h
>

17 
	~<asm/£gm’t.h
>

19 
	svm_¡ruù
 {

20 
	mæags
;

21 * 
	maddr
;

22 
	msize
;

23 
vm_¡ruù
 * 
	mÃxt
;

26 
vm_¡ruù
 * 
	gvmli¡
 = 
NULL
;

35 
	#VMALLOC_OFFSET
 (8*1024*1024)

	)

37 
šlše
 
	$£t_pgdœ
(
dšdex
, 
v®ue
)

39 
sk_¡ruù
 * 
p
;

41 
p
 = &
š™_sk
;

43 ((*è
p
->
tss
.
ü3
)[
dšdex
] = 
v®ue
;

44 
p
 =…->
Ãxt_sk
;

45 } 
p
 !ğ&
š™_sk
);

46 
	}
}

48 
	$ä“_¬—_·ges
(
dšdex
, 
šdex
, 
Ä
)

50 
·ge
, *
±e
;

52 ià(!(
PAGE_PRESENT
 & (
·ge
 = 
sw­³r_pg_dœ
[
dšdex
])))

54 
·ge
 &ğ
PAGE_MASK
;

55 
±e
 = 
šdex
 + (*è
·ge
;

57 
pg
 = *
±e
;

58 *
±e
 = 0;

59 ià(
pg
 & 
PAGE_PRESENT
)

60 
	`ä“_·ge
(
pg
);

61 
±e
++;

62 } --
Ä
);

63 
±e
 = (*è
·ge
;

64 
Ä
 = 0 ;‚¸< 1024 ;‚r++, 
±e
++)

65 ià(*
±e
)

67 
	`£t_pgdœ
(
dšdex
,0);

68 
mem_m­
[
	`MAP_NR
(
·ge
)] = 1;

69 
	`ä“_·ge
(
·ge
);

70 
	`šv®id©e
();

72 
	}
}

74 
	$®loc_¬—_·ges
(
dšdex
, 
šdex
, 
Ä
)

76 
·ge
, *
±e
;

78 
·ge
 = 
sw­³r_pg_dœ
[
dšdex
];

79 ià(!
·ge
) {

80 
·ge
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

81 ià(!
·ge
)

82  -
ENOMEM
;

83 ià(
sw­³r_pg_dœ
[
dšdex
]) {

84 
	`ä“_·ge
(
·ge
);

85 
·ge
 = 
sw­³r_pg_dœ
[
dšdex
];

87 
mem_m­
[
	`MAP_NR
(
·ge
)] = 
MAP_PAGE_RESERVED
;

88 
	`£t_pgdœ
(
dšdex
, 
·ge
 | 
PAGE_SHARED
);

91 
·ge
 &ğ
PAGE_MASK
;

92 
±e
 = 
šdex
 + (*è
·ge
;

93 *
±e
 = 
PAGE_SHARED
;

95 
pg
 = 
	`g‘_ä“_·ge
(
GFP_KERNEL
);

97 ià(!
pg
)

98  -
ENOMEM
;

99 *
±e
 = 
pg
 | 
PAGE_SHARED
;

100 
±e
++;

101 } --
Ä
);

102 
	`šv®id©e
();

104 
	}
}

106 
do_¬—
(* 
addr
, 
size
,

107 (*
¬—_â
)(,,))

109 
Ä
, 
dšdex
, 
šdex
;

111 
Ä
 = 
size
 >> 
PAGE_SHIFT
;

112 
dšdex
 = (
TASK_SIZE
 + (è
addr
) >> 22;

113 
šdex
 = (((è
addr
è>> 
PAGE_SHIFT
è& (
PTRS_PER_PAGE
-1);

114 
Ä
 > 0) {

115 
i
 = 
PTRS_PER_PAGE
 - 
šdex
;

117 ià(
i
 > 
Ä
)

118 
i
 = 
Ä
;

119 
Ä
 -ğ
i
;

120 ià(
	`¬—_â
(
dšdex
, 
šdex
, 
i
))

122 
šdex
 = 0;

123 
dšdex
++;

126 
	}
}

128 
	$vä“
(* 
addr
)

130 
vm_¡ruù
 **
p
, *
tmp
;

132 ià(!
addr
)

134 ià((
PAGE_SIZE
-1è& (è
addr
) {

135 
	`´štk
("TryšgØvä“(èbad‡dd»s (%p)\n", 
addr
);

138 
p
 = &
vmli¡
 ; (
tmp
 = *pè;… = &tmp->
Ãxt
) {

139 ià(
tmp
->
addr
 ==‡ddr) {

140 *
p
 = 
tmp
->
Ãxt
;

141 
	`do_¬—
(
tmp
->
addr
,mp->
size
, 
ä“_¬—_·ges
);

142 
	`kä“
(
tmp
);

146 
	`´štk
("TryšgØvä“(ènÚexi¡’ˆvm‡»¨(%p)\n", 
addr
);

147 
	}
}

149 * 
	$vm®loc
(
size
)

151 * 
addr
;

152 
vm_¡ruù
 **
p
, *
tmp
, *
¬—
;

154 
size
 = 
	`PAGE_ALIGN
(size);

155 ià(!
size
 || siz> 
high_memÜy
)

156  
NULL
;

157 
¬—
 = (
vm_¡ruù
 *è
	`km®loc
((*¬—), 
GFP_KERNEL
);

158 ià(!
¬—
)

159  
NULL
;

160 
addr
 = (*è((
high_memÜy
 + 
VMALLOC_OFFSET
) & ~(VMALLOC_OFFSET-1));

161 
¬—
->
size
 = siz+ 
PAGE_SIZE
;

162 
¬—
->
Ãxt
 = 
NULL
;

163 
p
 = &
vmli¡
; (
tmp
 = *pè;… = &tmp->
Ãxt
) {

164 ià(
size
 + (è
addr
 < (è
tmp
->addr)

166 
addr
 = (*è(
tmp
->
size
 + ()mp->addr);

168 
¬—
->
addr
 =‡ddr;

169 
¬—
->
Ãxt
 = *
p
;

170 *
p
 = 
¬—
;

171 ià(
	`do_¬—
(
addr
, 
size
, 
®loc_¬—_·ges
)) {

172 
	`vä“
(
addr
);

173  
NULL
;

175  
addr
;

176 
	}
}

178 
	$v»ad
(*
buf
, *
addr
, 
couÁ
)

180 
vm_¡ruù
 **
p
, *
tmp
;

181 *
vaddr
, *
buf_¡¬t
 = 
buf
;

182 
n
;

184 
p
 = &
vmli¡
; (
tmp
 = *pè;… = &tmp->
Ãxt
) {

185 
vaddr
 = (*è
tmp
->
addr
;

186 
addr
 < 
vaddr
) {

187 ià(
couÁ
 == 0)

188 
fšished
;

189 
	`put_fs_by‹
('\0', 
buf
++), 
addr
++, 
couÁ
--;

191 
n
 = 
tmp
->
size
 - 
PAGE_SIZE
;

192 ià(
addr
 > 
vaddr
)

193 
n
 -ğ
addr
 - 
vaddr
;

194 --
n
 >= 0) {

195 ià(
couÁ
 == 0)

196 
fšished
;

197 
	`put_fs_by‹
(*
addr
++, 
buf
++), 
couÁ
--;

200 
fšished
:

201  
buf
 - 
buf_¡¬t
;

202 
	}
}

	@net/Space.c

11 
	~<lšux/cÚfig.h
>

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/ddi.h
>

17 
	#CONFIG_UNIX
 
YES


	)

26 #ifdef 
CONFIG_UNIX


27 
	~"unix/unix.h
"

29 #ifdef 
CONFIG_INET


30 
	~"š‘/š‘.h
"

32 #ifdeà
CONFIG_IPX


33 
	~"š‘/xÿÎ.h
"

35 #ifdeà
CONFIG_AX25


36 
	~"š‘/ax25ÿÎ.h
"

39 
ddi_´Ùo
 
	g´ÙocŞs
[] = {

40 #ifdef 
CONFIG_UNIX


41 { "UNIX", 
unix_´Ùo_š™
 },

43 #ifdeà 
CONFIG_IPX


44 { "IPX", 
x_´Ùo_š™
 },

46 #ifdeà
CONFIG_AX25


47 { "AX.25", 
ax25_´Ùo_š™
 },

49 #ifdef 
CONFIG_INET


50 { "INET", 
š‘_´Ùo_š™
 },

52 { 
NULL
, NULL }

70 
ddi_deviû
 
	gdeviûs
[] = {

71 #ià
CONF_WE8003


73 "", 0, 1, 
we8003_š™
, 
NULL
,

74 19, 0, 
DDI_FCHRDEV
,

77 #ià
CONF_DP8390


79 "", 0, 1, 
dpwd8003_š™
, 
NULL
,

80 20, 0, 
DDI_FCHRDEV
,

83 "", 0, 1, 
d²e2000_š™
, 
NULL
,

84 20, 8, 
DDI_FCHRDEV
,

87 "", 0, 1, 
d³c503_š™
, 
NULL
,

88 20, 16, 
DDI_FCHRDEV
,

91 { 
NULL
,

92 "", 0, 0, 
NULL
, NULL,

	@net/ddi.c

11 
	~<asm/£gm’t.h
>

12 
	~<asm/sy¡em.h
>

13 
	~<lšux/ty³s.h
>

14 
	~<lšux/cÚfig.h
>

15 
	~<lšux/k”Ãl.h
>

16 
	~<lšux/sched.h
>

17 
	~<lšux/¡ršg.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/sock‘.h
>

20 
	~<lšux/ddi.h
>

23 #undeà
DDI_DEBUG


24 #ifdef 
DDI_DEBUG


25 
	#PRINTK
(
x
è
´štk
 
	)
x

27 
	#PRINTK
(
x
è

	)

31 
ddi_deviû
 
deviûs
[];

32 
ddi_´Ùo
 
´ÙocŞs
[];

44 
ddi_deviû
 *

45 
	$ddi_m­
(cÚ¡ *
id
)

47 
ddi_deviû
 *
dev
;

49 
	`PRINTK
 (("DDI: MAP:†ookšg fÜ \"%s\": ", 
id
));

50 
dev
 = 
deviûs
;

51 
dev
->
t™Ë
 !ğ
NULL
) {

52 ià(
	`¡ºcmp
(
dev
->
Çme
, 
id
, 
DDI_MAXNAME
) == 0) {

53 
	`PRINTK
 (("OK‡ˆ0x%X\n", 
dev
));

54 (
dev
);

56 
dev
++;

58 
	`PRINTK
 (("NOT FOUND\n"));

59 (
NULL
);

60 
	}
}

69 
	$ddi_š™
()

71 
ddi_´Ùo
 *
´o
;

72 
ddi_deviû
 *
dev
;

74 
	`PRINTK
 (("DDI: Starting up!\n"));

77 
´o
 = 
´ÙocŞs
;

78 
´o
->
Çme
 !ğ
NULL
) {

79 (*
´o
->
š™
)(pro);

80 
´o
++;

84 
dev
 = 
deviûs
;

85 
dev
->
t™Ë
 !ğ
NULL
) {

86 (*
dev
->
š™
)(dev);

87 
dev
++;

91 
	}
}

	@net/inet/arp.c

57 
	~<lšux/ty³s.h
>

58 
	~<lšux/¡ršg.h
>

59 
	~<lšux/k”Ãl.h
>

60 
	~<lšux/sched.h
>

61 
	~<lšux/cÚfig.h
>

62 
	~<lšux/sock‘.h
>

63 
	~<lšux/sockios.h
>

64 
	~<lšux/tim”.h
>

65 
	~<lšux/”ºo.h
>

66 
	~<lšux/if_¬p.h
>

67 
	~<lšux/š.h
>

68 
	~<asm/sy¡em.h
>

69 
	~<asm/£gm’t.h
>

70 
	~<¡d¬g.h
>

71 
	~"š‘.h
"

72 
	~"dev.h
"

73 
	~"‘h.h
"

74 
	~".h
"

75 
	~"rou‹.h
"

76 
	~"´ÙocŞ.h
"

77 
	~"tı.h
"

78 
	~"skbuff.h
"

79 
	~"sock.h
"

80 
	~"¬p.h
"

83 
	#ARP_MAX_TRIES
 3

	)

86 *
unk_´št
(*, );

87 *
‘h_­ršt
(*, );

90 *
	g¬p_cmds
[] = {

96 
NULL


98 
	#ARP_MAX_CMDS
 ((
¬p_cmds
è/ ×½_cmds[0]))

	)

101 *
	mÇme
;

102 *(*
	m´št
)(*
	m±r
, 
	mËn
);

103 } 
	g¬p_ty³s
[] = {

104 { "0x%04X", 
unk_´št
 },

105 { "10 Mbp Eth”Ãt", 
‘h_­ršt
 },

106 { "3 Mbp Eth”Ãt", 
‘h_­ršt
 },

107 { "AX.25", 
unk_´št
 },

108 { "PrÚ‘", 
unk_´št
 },

109 { "Chaos", 
unk_´št
 },

110 { "IEEE 802.2 Eth”Ãˆ(?)", 
‘h_­ršt
 },

111 { "Arú‘", 
unk_´št
 },

112 { "AµËT®k", 
unk_´št
 },

113 { 
NULL
, NULL }

115 
	#ARP_MAX_TYPE
 ((
¬p_ty³s
è/ ×½_ty³s[0]))

	)

118 
¬p_bË
 *
	g¬p_bËs
[
ARP_TABLE_SIZE
] = {

119 
NULL
,

122 
	g¬p_´ox›s
=0;

126 
sk_buff
 * vŞ©
	g¬p_q
 = 
NULL
;

128 
¬p_bË
 *
¬p_lookup
(
addr
);

129 
¬p_bË
 *
¬p_lookup_´oxy
(
addr
);

133 
	$unk_´št
(*
±r
, 
Ën
)

135 
buff
[32];

136 *
buå
 = 
buff
;

137 
i
;

139 
i
 = 0; i < 
Ën
; i++)

140 
buå
 +ğ
	`¥rštf
(buå, "%02X ", (*
±r
++ & 0377));

141 (
buff
);

142 
	}
}

147 
	$‘h_­ršt
(*
±r
, 
Ën
)

149 ià(
Ën
 !ğ
ETH_ALEN
) ("");

150 (
	`‘h_´št
(
±r
));

151 
	}
}

156 
	$¬p_´št
(
¬phdr
 *
¬p
)

158 
Ën
, 
idx
;

159 *
±r
;

161 ià(
š‘_debug
 !ğ
DBG_ARP
) ;

163 
	`´štk
("ARP: ");

164 ià(
¬p
 =ğ
NULL
) {

165 
	`´štk
("(null)\n");

170 
Ën
 = 
	`htÚs
(
¬p
->
¬_İ
);

171 ià(
Ën
 < 
ARP_MAX_CMDS
è
idx
 =†en;

172 
idx
 = 0;

173 
	`´štk
("op ");

174 
	`´štk
(
¬p_cmds
[
idx
], 
Ën
);

177 
Ën
 = 
	`htÚs
(
¬p
->
¬_hrd
);

178 ià(
Ën
 < 
ARP_MAX_TYPE
è
idx
 =†en;

179 
idx
 = 0;

180 
	`´štk
(" hrd = ");…rštk(
¬p_ty³s
[
idx
].
Çme
, 
Ën
);

181 
	`´štk
("…rØğ0x%04X\n", 
	`htÚs
(
¬p
->
¬_´o
));

182 
	`´štk
(" hËÀğ%d…ËÀğ%d\n", 
¬p
->
¬_hÊ
,‡½->
¬_¶n
);

190 
±r
 = ((*è&
¬p
->
¬_İ
è+ (
u_shÜt
);

191 
	`´štk
(" s’d” HA = % ", 
¬p_ty³s
[
idx
].
	`´št
(
±r
, 
¬p
->
¬_hÊ
));

192 
±r
 +ğ
¬p
->
¬_hÊ
;

193 
	`´štk
(" PA = %s\n", 
	`š_Áß
(*(*è
±r
));

194 
±r
 +ğ
¬p
->
¬_¶n
;

195 
	`´štk
("¬g‘ HA = % ", 
¬p_ty³s
[
idx
].
	`´št
(
±r
, 
¬p
->
¬_hÊ
));

196 
±r
 +ğ
¬p
->
¬_hÊ
;

197 
	`´štk
(" PA = %s\n", 
	`š_Áß
(*(*è
±r
));

198 
	}
}

203 
	$¬p_£nd_q
()

205 
sk_buff
 *
skb
;

206 
sk_buff
 *vŞ©
wÜk_q
;

207 
	`şi
();

208 
wÜk_q
 = 
¬p_q
;

209 
	`skb_Ãw_li¡_h—d
(&
wÜk_q
);

210 
¬p_q
 = 
NULL
;

211 
	`¡i
();

212 (
skb
=
	`skb_dequeue
(&
wÜk_q
))!=
NULL
)

214 
	`IS_SKB
(
skb
);

215 
skb
->
magic
 = 0;

216 
skb
->
Ãxt
 = 
NULL
;

217 
skb
->
´ev
 = 
NULL
;

220 
	`şi
();

221 
skb
->
Œ›s
--;

222 ià(
skb
->
Œ›s
 == 0) {

232 
skb
->
sk
 = 
NULL
;

233 if(
skb
->
ä“
)

234 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

237 
	`¡i
();

242 
	`¡i
();

243 ià(
skb
->
¬p
 || !skb->
dev
->
	`»bud_h—d”
(skb->
d©a
, skb->dev)) {

244 
skb
->
¬p
 = 1;

245 
skb
->
dev
->
	`queue_xm™
(skb, skb->dev, 0);

248 
skb
->
magic
 = 
ARP_QUEUE_MAGIC
;

249 
	`skb_queue_h—d
(&
¬p_q
,
skb
);

252 
	}
}

255 
tim”_li¡
 
	g¬p_tim”
;

257 
¬p_queue_tick”
(
d©a
);

259 
	$¬p_queue_kick
()

261 
¬p_tim”
.
expœes
 = 500;

262 
¬p_tim”
.
d©a
 = 0;

263 
¬p_tim”
.
funùiÚ
 = 
¬p_queue_tick”
;

264 
	`d–_tim”
(&
¬p_tim”
);

265 
	`add_tim”
(&
¬p_tim”
);

266 
	}
}

268 
	$¬p_queue_tick”
(
d©a
 )

270 
	`¬p_£nd_q
();

271 ià(
	`skb_³ek
(&
¬p_q
))

272 
	`¬p_queue_kick
();

273 
	}
}

279 
	$¬p_»¥Ú£
(
¬phdr
 *
¬p1
, 
deviû
 *
dev
, 
add¹y³
)

281 
¬phdr
 *
¬p2
;

282 
sk_buff
 *
skb
;

283 
¤c
, 
d¡
;

284 *
±r1
, *
±r2
;

285 
hËn
;

286 
¬p_bË
 *
­t
 = 
NULL
;

289 
±r1
 = ((*è&
¬p1
->
¬_İ
è+ (
u_shÜt
);

290 
¤c
 = *((*è(
±r1
 + 
¬p1
->
¬_hÊ
));

291 
d¡
 = *((*è(
±r1
 + (
¬p1
->
¬_hÊ
 * 2è+‡½1->
¬_¶n
));

293 if(
add¹y³
!=
IS_MYADDR
)

295 
­t
=
	`¬p_lookup_´oxy
(
d¡
);

296 if(
­t
==
NULL
)

301 
skb
 = 
	`®loc_skb
((
sk_buff
) +

302 (
¬phdr
) +

303 (2 * 
¬p1
->
¬_hÊ
è+ (2 *‡½1->
¬_¶n
) +

304 
dev
->
h¬d_h—d”_Ën
, 
GFP_ATOMIC
);

305 ià(
skb
 =ğ
NULL
) {

306 
	`´štk
("ARP:‚o memory‡vailable for ARP REPLY!\n");

310 
skb
->
mem_addr
 = skb;

311 
skb
->
Ën
 = (
¬phdr
è+ (2 * 
¬p1
->
¬_hÊ
) +

312 (2 * 
¬p1
->
¬_¶n
è+ 
dev
->
h¬d_h—d”_Ën
;

313 
skb
->
mem_Ën
 = (
sk_buff
è+ skb->
Ën
;

314 
hËn
 = 
dev
->
	`h¬d_h—d”
(
skb
->
d©a
, dev, 
ETH_P_ARP
, 
¤c
, 
d¡
, skb->
Ën
);

315 ià(
hËn
 < 0) {

316 
	`´štk
("ARP: cannot create HW frame header for REPLY !\n");

317 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

326 
¬p2
 = (
¬phdr
 *è(
skb
->
d©a
 + 
hËn
);

327 
±r2
 = ((*è&
¬p2
->
¬_İ
è+ (
u_shÜt
);

328 
¬p2
->
¬_hrd
 = 
¬p1
->ar_hrd;

329 
¬p2
->
¬_´o
 = 
¬p1
->ar_pro;

330 
¬p2
->
¬_hÊ
 = 
¬p1
->ar_hln;

331 
¬p2
->
¬_¶n
 = 
¬p1
->ar_pln;

332 
¬p2
->
¬_İ
 = 
	`htÚs
(
ARPOP_REPLY
);

333 if(
add¹y³
==
IS_MYADDR
)

334 
	`memıy
(
±r2
, 
dev
->
dev_addr
, 
¬p2
->
¬_hÊ
);

336 
	`memıy
(
±r2
, 
­t
->
ha
, 
¬p2
->
¬_hÊ
);

337 
±r2
 +ğ
¬p2
->
¬_hÊ
;

338 
	`memıy
(
±r2
, 
±r1
 + (
¬p1
->
¬_hÊ
 * 2è+‡½1->
¬_¶n
, 
¬p2
->ar_pln);

339 
±r2
 +ğ
¬p2
->
¬_¶n
;

340 
	`memıy
(
±r2
, 
±r1
, 
¬p2
->
¬_hÊ
);

341 
±r2
 +ğ
¬p2
->
¬_hÊ
;

342 
	`memıy
(
±r2
, 
±r1
 + 
¬p1
->
¬_hÊ
, 
¬p2
->
¬_¶n
);

344 
skb
->
ä“
 = 1;

345 
skb
->
¬p
 = 1;

346 
skb
->
sk
 = 
NULL
;

347 
skb
->
Ãxt
 = 
NULL
;

349 
	`DPRINTF
((
DBG_ARP
, ">>"));

350 
	`¬p_´št
(
¬p2
);

353 
dev
->
	`queue_xm™
(
skb
, dev, 0);

355 
	}
}

359 
¬p_bË
 *

360 
	$¬p_lookup
(
·ddr
)

362 
¬p_bË
 *
­t
;

363 
hash
;

365 
	`DPRINTF
((
DBG_ARP
, "ARP:†ookup(%s)\n", 
	`š_Áß
(
·ddr
)));

368 ià(
	`chk_addr
(
·ddr
è=ğ
IS_MYADDR
) {

369 
	`´štk
("ARP: ARPšg my owÀIP‡dd»s % !\n", 
	`š_Áß
(
·ddr
));

370 (
NULL
);

374 
hash
 = 
	`htÚl
(
·ddr
è& (
ARP_TABLE_SIZE
 - 1);

375 
	`şi
();

376 
­t
 = 
¬p_bËs
[
hash
];

377 
­t
 !ğ
NULL
) {

378 ià(
­t
->

 =ğ
·ddr
) {

379 
	`¡i
();

380 (
­t
);

382 
­t
 =‡±->
Ãxt
;

384 
	`¡i
();

385 (
NULL
);

386 
	}
}

390 
¬p_bË
 *
	$¬p_lookup_´oxy
(
·ddr
)

392 
¬p_bË
 *
­t
;

393 
hash
;

395 
	`DPRINTF
((
DBG_ARP
, "ARP:†ooku°´oxy(%s)\n", 
	`š_Áß
(
·ddr
)));

398 
hash
 = 
	`htÚl
(
·ddr
è& (
ARP_TABLE_SIZE
 - 1);

399 
	`şi
();

400 
­t
 = 
¬p_bËs
[
hash
];

401 
­t
 !ğ
NULL
) {

402 ià(
­t
->

 =ğ
·ddr
 && (­t->
æags
 & 
ATF_PUBL
) ) {

403 
	`¡i
();

404 (
­t
);

406 
­t
 =‡±->
Ãxt
;

408 
	`¡i
();

409 (
NULL
);

410 
	}
}

415 
	$¬p_de¡ruùÜ
(
·ddr
, 
fÜû
)

417 
¬p_bË
 *
­t
;

418 
¬p_bË
 **
Ï±
;

419 
hash
;

421 
	`DPRINTF
((
DBG_ARP
, "ARP: de¡roy(%s)\n", 
	`š_Áß
(
·ddr
)));

424 ià(
	`chk_addr
(
·ddr
è=ğ
IS_MYADDR
) {

425 
	`DPRINTF
((
DBG_ARP
, "ARP: Destroying my own IP‡ddress %s !\n",

426 
	`š_Áß
(
·ddr
)));

429 
hash
 = 
	`htÚl
(
·ddr
è& (
ARP_TABLE_SIZE
 - 1);

431 
	`şi
();

432 
Ï±
 = &
¬p_bËs
[
hash
];

433 (
­t
 = *
Ï±
è!ğ
NULL
) {

434 ià(
­t
->

 =ğ
·ddr
) {

435 if((
­t
->
æags
&
ATF_PERM
è&& !
fÜû
)

437 *
Ï±
 = 
­t
->
Ãxt
;

438 if(
­t
->
æags
&
ATF_PUBL
)

439 
¬p_´ox›s
--;

440 
	`kä“_s
(
­t
, (
¬p_bË
));

441 
	`¡i
();

444 
Ï±
 = &
­t
->
Ãxt
;

446 
	`¡i
();

447 
	}
}

453 
	$¬p_de¡roy
(
·ddr
)

455 
	`¬p_de¡ruùÜ
(
·ddr
,1);

456 
	}
}

462 
	$¬p_de¡roy_maybe
(
·ddr
)

464 
	`¬p_de¡ruùÜ
(
·ddr
,0);

465 
	}
}

468 
¬p_bË
 *

469 
	$¬p_ü—‹
(
·ddr
, *
addr
, 
hËn
, 
hty³
)

471 
¬p_bË
 *
­t
;

472 
hash
;

474 
	`DPRINTF
((
DBG_ARP
, "ARP: c»©e(%s, ", 
	`š_Áß
(
·ddr
)));

475 
	`DPRINTF
((
DBG_ARP
, "%s, ", 
	`‘h_´št
(
addr
)));

476 
	`DPRINTF
((
DBG_ARP
, "%d, %d)\n", 
hËn
, 
hty³
));

478 
­t
 = (
¬p_bË
 *è
	`km®loc
((¬p_bË), 
GFP_ATOMIC
);

479 ià(
­t
 =ğ
NULL
) {

480 
	`´štk
("ARP:‚o memory‡vailable for‚ew ARPƒntry!\n");

481 (
NULL
);

485 
hash
 = 
	`htÚl
(
·ddr
è& (
ARP_TABLE_SIZE
 - 1);

486 
­t
->

 = 
·ddr
;

487 
­t
->
hËn
 = hlen;

488 
­t
->
hty³
 = htype;

489 
­t
->
æags
 = (
ATF_INUSE
 | 
ATF_COM
);

490 
	`memıy
(
­t
->
ha
, 
addr
, 
hËn
);

491 
­t
->
Ï¡_u£d
 = 
jiff›s
;

492 
	`şi
();

493 
­t
->
Ãxt
 = 
¬p_bËs
[
hash
];

494 
¬p_bËs
[
hash
] = 
­t
;

495 
	`¡i
();

496 (
­t
);

497 
	}
}

510 
	$¬p_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
·ck‘_ty³
 *
±
)

512 
¬phdr
 *
¬p
;

513 
¬p_bË
 *
tbl
;

514 
¤c
, 
d¡
;

515 *
±r
;

516 
»t
;

517 
addr_hšt
;

519 
	`DPRINTF
((
DBG_ARP
, "<<\n"));

520 
¬p
 = 
skb
->
h
.arp;

521 
	`¬p_´št
(
¬p
);

524 ià(
¬p
->
¬_hÊ
 !ğ
dev
->
addr_Ën
 || dev->
ty³
 !ğ
	`NET16
×½->
¬_hrd
))

526 
	`DPRINTF
((
DBG_ARP
,"ARP: Bad…ack‘„eûived oÀdeviû \"%s\" !\n", 
dev
->
Çme
));

527 
	`kä“_skb
(
skb
, 
FREE_READ
);

532 ià(((
¬p
->
¬_´o
 !ğ
	`NET16
(0x00CCè&& 
dev
->
ty³
==3è|| (¬p->¬_´Ø!ğNET16(
ETH_P_IP
è&& dev->ty³!=3èè||‡½->
¬_¶n
 != 4)

534 ià(
¬p
->
¬_İ
 !ğ
	`NET16
(
ARPOP_REQUEST
))

535 
	`DPRINTF
((
DBG_ARP
,"ARP: NÚ-IP„eque¡ oÀdeviû \"%s\" !\n", 
dev
->
Çme
));

536 
	`kä“_skb
(
skb
, 
FREE_READ
);

545 
±r
 = ((*è&
¬p
->
¬_İ
è+ (
u_shÜt
);

546 
	`memıy
(&
¤c
, 
±r
 + 
¬p
->
¬_hÊ
,‡½->
¬_¶n
);

547 
tbl
 = 
	`¬p_lookup
(
¤c
);

548 ià(
tbl
 !ğ
NULL
) {

549 
	`DPRINTF
((
DBG_ARP
, "ARP: ud©šgƒÁry fÜ %s\n", 
	`š_Áß
(
¤c
)));

550 
	`memıy
(
tbl
->
ha
, 
±r
, 
¬p
->
¬_hÊ
);

551 
tbl
->
hËn
 = 
¬p
->
¬_hÊ
;

552 
tbl
->
æags
 |ğ
ATF_COM
;

553 
tbl
->
Ï¡_u£d
 = 
jiff›s
;

555 
	`memıy
(&
d¡
, 
±r
 + (
¬p
->
¬_hÊ
 * 2è+‡½->
¬_¶n
,‡rp->ar_pln);

556 ià(
	`chk_addr
(
d¡
è!ğ
IS_MYADDR
 && 
¬p_´ox›s
 == 0) {

557 
	`kä“_skb
(
skb
, 
FREE_READ
);

560 
tbl
 = 
	`¬p_ü—‹
(
¤c
, 
±r
, 
¬p
->
¬_hÊ
,‡½->
¬_hrd
);

561 ià(
tbl
 =ğ
NULL
) {

562 
	`kä“_skb
(
skb
, 
FREE_READ
);

573 
	`¬p_£nd_q
();

579 ià(
¬p
->
¬_İ
 !ğ
	`NET16
(
ARPOP_REQUEST
)) {

580 
	`kä“_skb
(
skb
, 
FREE_READ
);

588 if(
	`chk_addr
(
d¡
)==
IS_BROADCAST
)

590 
	`kä“_skb
(
skb
, 
FREE_READ
);

594 
	`memıy
(&
d¡
, 
±r
 + (
¬p
->
¬_hÊ
 * 2è+‡½->
¬_¶n
,‡rp->ar_pln);

595 ià((
addr_hšt
=
	`chk_addr
(
d¡
)è!ğ
IS_MYADDR
 && 
¬p_´ox›s
==0) {

596 
	`DPRINTF
((
DBG_ARP
, "ARP:„equest was‚ot for me!\n"));

597 
	`kä“_skb
(
skb
, 
FREE_READ
);

605 
»t
 = 
	`¬p_»¥Ú£
(
¬p
, 
dev
, 
addr_hšt
);

606 
	`kä“_skb
(
skb
, 
FREE_READ
);

607 (
»t
);

608 
	}
}

613 
	$¬p_£nd
(
·ddr
, 
deviû
 *
dev
, 
§ddr
)

615 
sk_buff
 *
skb
;

616 
¬phdr
 *
¬p
;

617 *
±r
;

618 
tmp
;

620 
	`DPRINTF
((
DBG_ARP
, "ARP: s’dÕaddr=%s, ", 
	`š_Áß
(
·ddr
)));

621 
	`DPRINTF
((
DBG_ARP
, "dev=%s, ", 
dev
->
Çme
));

622 
	`DPRINTF
((
DBG_ARP
, "§ddr=%s)\n", 
	`š_Áß
(
§ddr
)));

624 
skb
 = 
	`®loc_skb
((
sk_buff
) +

625 (
¬phdr
è+ (2 * 
dev
->
addr_Ën
) +

626 
dev
->
h¬d_h—d”_Ën
 +

627 (2 * 4 ), 
GFP_ATOMIC
);

628 ià(
skb
 =ğ
NULL
) {

629 
	`´štk
("ARP: NØmemÜy‡vaabË fÜ REQUEST %s\n", 
	`š_Áß
(
·ddr
));

634 
skb
->
sk
 = 
NULL
;

635 
skb
->
mem_addr
 = skb;

636 
skb
->
Ën
 = (
¬phdr
) +

637 
dev
->
h¬d_h—d”_Ën
 + (2 * dev->
addr_Ën
) + 8;

638 
skb
->
mem_Ën
 = (
sk_buff
è+ skb->
Ën
;

639 
skb
->
¬p
 = 1;

640 
skb
->
dev
 = dev;

641 
skb
->
Ãxt
 = 
NULL
;

642 
skb
->
ä“
 = 1;

643 
tmp
 = 
dev
->
	`h¬d_h—d”
(
skb
->
d©a
, dev, 
ETH_P_ARP
, 0, 
§ddr
, skb->
Ën
);

644 ià(
tmp
 < 0) {

645 
	`kä“_skb
(
skb
,
FREE_WRITE
);

648 
¬p
 = (
¬phdr
 *è(
skb
->
d©a
 + 
tmp
);

649 
¬p
->
¬_hrd
 = 
	`htÚs
(
dev
->
ty³
);

650 if(
dev
->
ty³
!=3)

651 
¬p
->
¬_´o
 = 
	`htÚs
(
ETH_P_IP
);

653 
¬p
->
¬_´o
 = 
	`htÚs
(0xCC);

654 
¬p
->
¬_hÊ
 = 
dev
->
addr_Ën
;

655 
¬p
->
¬_¶n
 = 4;

656 
¬p
->
¬_İ
 = 
	`htÚs
(
ARPOP_REQUEST
);

658 
±r
 = ((*è&
¬p
->
¬_İ
è+ (
u_shÜt
);

659 
	`memıy
(
±r
, 
dev
->
dev_addr
, 
¬p
->
¬_hÊ
);

660 
±r
 +ğ
¬p
->
¬_hÊ
;

661 
	`memıy
(
±r
, &
§ddr
, 
¬p
->
¬_¶n
);

662 
±r
 +ğ
¬p
->
¬_¶n
;

664 
	`mem£t
(
±r
,0,
¬p
->
¬_hÊ
);

665 
±r
 +ğ
¬p
->
¬_hÊ
;

666 
	`memıy
(
±r
, &
·ddr
, 
¬p
->
¬_¶n
);

668 
	`DPRINTF
((
DBG_ARP
, ">>\n"));

669 
	`¬p_´št
(
¬p
);

670 
dev
->
	`queue_xm™
(
skb
, dev, 0);

671 
	}
}

676 
	$¬p_fšd
(*
haddr
, 
·ddr
, 
deviû
 *
dev
,

677 
§ddr
)

679 
¬p_bË
 *
­t
;

681 
	`DPRINTF
((
DBG_ARP
, "ARP: fšd(haddr=%s, ", 
	`‘h_´št
(
haddr
)));

682 
	`DPRINTF
((
DBG_ARP
, "·ddr=%s, ", 
	`š_Áß
(
·ddr
)));

683 
	`DPRINTF
((
DBG_ARP
, "dev=%s, saddr=%s)\n", 
dev
->
Çme
, 
	`š_Áß
(
§ddr
)));

685 
	`chk_addr
(
·ddr
)) {

686 
IS_MYADDR
:

687 
	`memıy
(
haddr
, 
dev
->
dev_addr
, dev->
addr_Ën
);

689 
IS_BROADCAST
:

690 
	`memıy
(
haddr
, 
dev
->
brßdÿ¡
, dev->
addr_Ën
);

694 
­t
 = 
	`¬p_lookup
(
·ddr
);

695 ià(
­t
 !ğ
NULL
) {

701 ià((
­t
->
æags
 & 
ATF_PERM
) ||

702 (
­t
->
Ï¡_u£d
 < 
jiff›s
+
ARP_TIMEOUT
 &&‡±->
hËn
 != 0)) {

703 
­t
->
Ï¡_u£d
 = 
jiff›s
;

704 
	`memıy
(
haddr
, 
­t
->
ha
, 
dev
->
addr_Ën
);

707 
	`DPRINTF
((
DBG_ARP
, "ARP: find: foundƒxpiredƒntry for %s\n",

708 
	`š_Áß
(
­t
->

)));

717 *(*)
haddr
 = 
·ddr
;

720 
	`¬p_£nd
(
·ddr
, 
dev
, 
§ddr
);

723 
	}
}

728 
	$¬p_add
(
addr
, *
haddr
, 
deviû
 *
dev
)

730 
¬p_bË
 *
­t
;

732 
	`DPRINTF
((
DBG_ARP
, "ARP:‡dd(%s, ", 
	`š_Áß
(
addr
)));

733 
	`DPRINTF
((
DBG_ARP
, "%s, ", 
	`‘h_´št
(
haddr
)));

734 
	`DPRINTF
((
DBG_ARP
, "%d, %d)\n", 
dev
->
h¬d_h—d”_Ën
, dev->
ty³
));

737 ià(
addr
 == 0) {

738 
	`´štk
("ARP:‡dd: will‚ot‡ddƒntry for 0.0.0.0 !\n");

743 
­t
 = 
	`¬p_lookup
(
addr
);

744 ià(
­t
 !ğ
NULL
) {

745 
	`DPRINTF
((
DBG_ARP
, "ARP: upd©šgƒÁry fÜ %s\n", 
	`š_Áß
(
addr
)));

746 
­t
->
Ï¡_u£d
 = 
jiff›s
;

747 
	`memıy
(
­t
->
ha
, 
haddr
 , 
dev
->
addr_Ën
);

750 
	`¬p_ü—‹
(
addr
, 
haddr
, 
dev
->
addr_Ën
, dev->
ty³
);

751 
	}
}

756 
	$¬p_add_brßd
(
addr
, 
deviû
 *
dev
)

758 
¬p_bË
 *
­t
;

760 
	`¬p_add
(
addr
, 
dev
->
brßdÿ¡
, dev);

761 
­t
 = 
	`¬p_lookup
(
addr
);

762 ià(
­t
 !ğ
NULL
) {

763 
­t
->
æags
 |ğ
ATF_PERM
;

765 
	}
}

770 
	$¬p_queue
(
sk_buff
 *
skb
)

772 
	`şi
();

773 
skb
->
Œ›s
 = 
ARP_MAX_TRIES
;

775 ià(
skb
->
Ãxt
 !ğ
NULL
) {

776 
	`¡i
();

777 
	`´štk
("ARP:‡½_queuskb‡Ì—dy oÀqueumagic=%X.\n", 
skb
->
magic
);

780 if(
¬p_q
==
NULL
)

781 
	`¬p_queue_kick
();

782 
	`skb_queue_
(&
¬p_q
,
skb
);

783 
skb
->
magic
 = 
ARP_QUEUE_MAGIC
;

784 
	`¡i
();

785 
	}
}

804 
	$¬p_g‘_šfo
(*
bufãr
)

806 
¬´eq
 *
»q
;

807 
¬p_bË
 *
­t
;

808 
i
;

809 *
pos
;

812 
pos
 = 
bufãr
;

813 
i
 = 0;

814 
i
 = 0; i < 
ARP_TABLE_SIZE
; i++) {

815 
	`şi
();

816 
­t
 = 
¬p_bËs
[
i
];

817 
	`¡i
();

818 
­t
 !ğ
NULL
) {

819 ià(
pos
 < (
bufãr
 + 4000)) {

820 
»q
 = (
¬´eq
 *è
pos
;

821 
	`mem£t
((*è
»q
, 0, (
¬´eq
));

822 
»q
->
¬p_·
.
§_çmy
 = 
AF_INET
;

823 
	`memıy
((*è
»q
->
¬p_·
.
§_d©a
, (*è&
­t
->

, 4);

824 
»q
->
¬p_ha
.
§_çmy
 = 
­t
->
hty³
;

825 
	`memıy
((*è
»q
->
¬p_ha
.
§_d©a
,

826 (*è&
­t
->
ha
,‡±->
hËn
);

827 
»q
->
¬p_æags
 = 
­t
->
æags
;

829 
pos
 +ğ(
¬´eq
);

830 
	`şi
();

831 
­t
 =‡±->
Ãxt
;

832 
	`¡i
();

835 (
pos
 - 
bufãr
);

836 
	}
}

841 
	$¬p_»q_£t
(
¬´eq
 *
»q
)

843 
¬´eq
 
r
;

844 
¬p_bË
 *
­t
;

845 
sockaddr_š
 *
si
;

846 
hty³
, 
hËn
;

849 
	`memıy_äomfs
(&
r
, 
»q
, (r));

850 ià(
r
.
¬p_·
.
§_çmy
 !ğ
AF_INET
è(-
EPFNOSUPPORT
);

857 
si
 = (
sockaddr_š
 *è&
r
.
¬p_·
;

858 
r
.
¬p_ha
.
§_çmy
) {

860 
ARPHRD_ETHER
:

861 
hty³
 = 
ARPHRD_ETHER
;

862 
hËn
 = 
ETH_ALEN
;

864 
ARPHRD_AX25
:

865 
hty³
 = 
ARPHRD_AX25
;

866 
hËn
 = 7;

870 (-
EPFNOSUPPORT
);

874 ià(
si
->
sš_addr
.
s_addr
 == 0) {

875 
	`´štk
("ARP: SETARP:„equested PA is 0.0.0.0 !\n");

876 (-
EINVAL
);

878 
­t
 = 
	`¬p_lookup
(
si
->
sš_addr
.
s_addr
);

879 ià(
­t
 =ğ
NULL
) {

880 
­t
 = 
	`¬p_ü—‹
(
si
->
sš_addr
.
s_addr
,

881 (*è
r
.
¬p_ha
.
§_d©a
, 
hËn
, 
hty³
);

882 ià(
­t
 =ğ
NULL
è(-
ENOMEM
);

886 
	`memıy
((*è&
­t
->
ha
, (*è&
r
.
¬p_ha
.
§_d©a
, 
hËn
);

887 
­t
->
Ï¡_u£d
 = 
jiff›s
;

888 
­t
->
æags
 = 
r
.
¬p_æags
;

889 if(
­t
->
æags
&
ATF_PUBL
)

890 
¬p_´ox›s
++;

893 
	}
}

898 
	$¬p_»q_g‘
(
¬´eq
 *
»q
)

900 
¬´eq
 
r
;

901 
¬p_bË
 *
­t
;

902 
sockaddr_š
 *
si
;

905 
	`memıy_äomfs
(&
r
, 
»q
, (r));

906 ià(
r
.
¬p_·
.
§_çmy
 !ğ
AF_INET
è(-
EPFNOSUPPORT
);

909 
si
 = (
sockaddr_š
 *è&
r
.
¬p_·
;

910 
­t
 = 
	`¬p_lookup
(
si
->
sš_addr
.
s_addr
);

911 ià(
­t
 =ğ
NULL
è(-
ENXIO
);

914 
	`memıy
((*è
r
.
¬p_ha
.
§_d©a
, (*è&
­t
->
ha
,‡±->
hËn
);

915 
r
.
¬p_ha
.
§_çmy
 = 
­t
->
hty³
;

918 
	`memıy_tofs
(
»q
, &
r
, (r));

920 
	}
}

925 
	$¬p_»q_d–
(
¬´eq
 *
»q
)

927 
¬´eq
 
r
;

928 
sockaddr_š
 *
si
;

931 
	`memıy_äomfs
(&
r
, 
»q
, (r));

932 ià(
r
.
¬p_·
.
§_çmy
 !ğ
AF_INET
è(-
EPFNOSUPPORT
);

934 
si
 = (
sockaddr_š
 *è&
r
.
¬p_·
;

938 if(
	`chk_addr
(
si
->
sš_addr
.
s_addr
)==
IS_MYADDR
)

939  -
EINVAL
;

941 
	`¬p_de¡roy
(
si
->
sš_addr
.
s_addr
);

944 
	}
}

949 
	$¬p_ioùl
(
cmd
, *
¬g
)

951 
”r
;

952 
cmd
) {

953 
DDIOCSDBG
:

954 (
	`dbg_ioùl
(
¬g
, 
DBG_ARP
));

955 
SIOCDARP
:

956 ià(!
	`su£r
()è(-
EPERM
);

957 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
¬g
,(
¬´eq
));

958 if(
”r
)

959  
”r
;

960 (
	`¬p_»q_d–
((
¬´eq
 *)
¬g
));

961 
SIOCGARP
:

962 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
¬g
,(
¬´eq
));

963 if(
”r
)

964  
”r
;

965 (
	`¬p_»q_g‘
((
¬´eq
 *)
¬g
));

966 
SIOCSARP
:

967 ià(!
	`su£r
()è(-
EPERM
);

968 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
¬g
,(
¬´eq
));

969 if(
”r
)

970  
”r
;

971 (
	`¬p_»q_£t
((
¬´eq
 *)
¬g
));

973 (-
EINVAL
);

977 
	}
}

	@net/inet/arp.h

18 #iâdeà
_ARP_H


19 
	#_ARP_H


	)

21 
	#ARP_TABLE_SIZE
 16

	)

22 
	#ARP_TIMEOUT
 30000

	)

23 
	#ARP_RES_TIME
 250

	)

25 
	#ARP_MAX_TRIES
 3

	)

26 
	#ARP_QUEUE_MAGIC
 0x0432447A

	)

30 
	s¬p_bË
 {

31 
¬p_bË
 *
	mÃxt
;

32 vŞ©
	mÏ¡_u£d
;

33 
	mæags
;

35 
	m
;

37 
	m·
[
MAX_ADDR_LEN
];

38 
	m¶’
;

39 
	m±y³
;

41 
	mha
[
MAX_ADDR_LEN
];

42 
	mhËn
;

43 
	mhty³
;

48 
sk_buff
 *
¬p_q
;

51 
¬p_de¡roy
(
·ddr
);

52 
¬p_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

53 
·ck‘_ty³
 *
±
);

54 
¬p_fšd
(*
haddr
, 
·ddr
,

55 
deviû
 *
dev
, 
§ddr
);

56 
¬p_add
(
addr
, *
haddr
,

57 
deviû
 *
dev
);

58 
¬p_add_brßd
(
addr
, 
deviû
 *
dev
);

59 
¬p_queue
(
sk_buff
 *
skb
);

60 
¬p_g‘_šfo
(*
bufãr
);

61 
¬p_ioùl
(
cmd
, *
¬g
);

62 
¬p_de¡roy_maybe
(
·ddr
);

	@net/inet/datagram.c

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/ty³s.h
>

21 
	~<lšux/k”Ãl.h
>

22 
	~<asm/£gm’t.h
>

23 
	~<asm/sy¡em.h
>

24 
	~<lšux/mm.h
>

25 
	~<lšux/š‹¼u±.h
>

26 
	~<lšux/š.h
>

27 
	~<lšux/”ºo.h
>

28 
	~<lšux/sched.h
>

29 
	~"š‘.h
"

30 
	~"dev.h
"

31 
	~".h
"

32 
	~"´ÙocŞ.h
"

33 
	~"¬p.h
"

34 
	~"rou‹.h
"

35 
	~"tı.h
"

36 
	~"udp.h
"

37 
	~"skbuff.h
"

38 
	~"sock.h
"

49 
sk_buff
 *
	$skb_»cv_d©ag¿m
(
sock
 *
sk
, 
æags
, 
noblock
, *
”r
)

51 
sk_buff
 *
skb
;

54 
»¡¬t
:

55 
sk
->
šu£
 = 1;

56 
sk
->
rqueue
 =ğ
NULL
)

59 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
)

61 
	`»Ëa£_sock
(
sk
);

62 *
”r
=0;

63  
NULL
;

66 if(
sk
->
”r
)

68 
	`»Ëa£_sock
(
sk
);

69 *
”r
=-
sk
->err;

70 
sk
->
”r
=0;

71  
NULL
;

75 if(
sk
->
ty³
==
SOCK_SEQPACKET
 && sk->
¡©e
!=
TCP_ESTABLISHED
)

77 
	`»Ëa£_sock
(
sk
);

78 *
”r
=-
ENOTCONN
;

79  
NULL
;

83 ià(
noblock
)

85 
	`»Ëa£_sock
(
sk
);

86 *
”r
=-
EAGAIN
;

87  
NULL
;

89 
	`»Ëa£_sock
(
sk
);

93 
	`şi
();

94 ià(
sk
->
rqueue
 =ğ
NULL
)

96 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

98 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

100 
	`¡i
();

101 *
”r
=-
ERESTARTSYS
;

102 (
NULL
);

104 if(
sk
->
”r
 != 0)

108 *
”r
 = -
sk
->err;

109 
	`¡i
();

110 
sk
->
”r
=0;

111  
NULL
;

114 
sk
->
šu£
 = 1;

115 
	`¡i
();

119 ià(!(
æags
 & 
MSG_PEEK
))

121 
skb
=
	`skb_dequeue
(&
sk
->
rqueue
);

122 if(
skb
!=
NULL
)

123 
skb
->
u£rs
++;

125 
»¡¬t
;

129 
	`şi
();

130 
skb
=
	`skb_³ek
(&
sk
->
rqueue
);

131 if(
skb
!=
NULL
)

132 
skb
->
u£rs
++;

133 
	`¡i
();

134 if(
skb
==
NULL
)

135 *
”r
=-
EAGAIN
;

137  
skb
;

138 
	}
}

140 
	$skb_ä“_d©ag¿m
(
sk_buff
 *
skb
)

142 
æags
;

144 
	`§ve_æags
(
æags
);

145 
	`şi
();

146 
skb
->
u£rs
--;

147 if(
skb
->
u£rs
>0)

149 
	`»¡Üe_æags
(
æags
);

153 if(
skb
->
li¡
 =ğ
NULL
)

154 
	`kä“_skb
(
skb
,
FREE_READ
);

155 
	`»¡Üe_æags
(
æags
);

156 
	}
}

158 
	$skb_cİy_d©ag¿m
(
sk_buff
 *
skb
, 
off£t
, *
to
, 
size
)

162 
	`memıy_tofs
(
to
,
skb
->
h
.
¿w
+
off£t
,
size
);

163 
	}
}

170 
	$d©ag¿m_£Ëù
(
sock
 *
sk
, 
£l_ty³
, 
£Ëù_bË
 *
wa™
)

172 
	`£Ëù_wa™
(
sk
->
¦“p
, 
wa™
);

173 
£l_ty³
)

175 
SEL_IN
:

176 ià(
sk
->
ty³
==
SOCK_SEQPACKET
 && sk->
¡©e
==
TCP_CLOSE
)

181 ià(
sk
->
rqueue
 !ğ
NULL
 || sk->
”r
 != 0)

188 
SEL_OUT
:

189 ià(
sk
->
´Ù
 && sk->´Ù->
	`w¥aû
(skè>ğ
MIN_WRITE_SPACE
)

193 ià(
sk
->
´Ù
==
NULL
 && sk->
¢dbuf
-sk->
wmem_®loc
 >ğ
MIN_WRITE_SPACE
)

199 
SEL_EX
:

200 ià(
sk
->
”r
)

205 
	}
}

	@net/inet/dev.c

39 
	~<asm/£gm’t.h
>

40 
	~<asm/sy¡em.h
>

41 
	~<asm/b™İs.h
>

42 
	~<lšux/cÚfig.h
>

43 
	~<lšux/ty³s.h
>

44 
	~<lšux/k”Ãl.h
>

45 
	~<lšux/sched.h
>

46 
	~<lšux/¡ršg.h
>

47 
	~<lšux/mm.h
>

48 
	~<lšux/sock‘.h
>

49 
	~<lšux/sockios.h
>

50 
	~<lšux/š.h
>

51 
	~<lšux/”ºo.h
>

52 
	~<lšux/š‹¼u±.h
>

53 
	~<lšux/if_‘h”.h
>

54 
	~"š‘.h
"

55 
	~"dev.h
"

56 
	~"‘h.h
"

57 
	~".h
"

58 
	~"rou‹.h
"

59 
	~"´ÙocŞ.h
"

60 
	~"tı.h
"

61 
	~"skbuff.h
"

62 
	~"sock.h
"

63 
	~"¬p.h
"

64 #ifdeà
CONFIG_AX25


65 
	~"ax25.h
"

69 #ifdeà
CONFIG_IPX


71 
·ck‘_ty³
 
	gx_8023_ty³
 = {

72 
NET16
(
ETH_P_802_3
),

74 
x_rcv
,

75 
NULL
,

76 
NULL


79 
·ck‘_ty³
 
	gx_·ck‘_ty³
 = {

80 
NET16
(
ETH_P_IPX
),

82 
x_rcv
,

83 
NULL
,

84 &
x_8023_ty³


89 #ifdeà
CONFIG_AX25


91 
·ck‘_ty³
 
	gax25_·ck‘_ty³
 = {

92 
NET16
(
ETH_P_AX25
),

94 
ax25_rcv
,

95 
NULL
,

96 #ifdeà
CONFIG_IPX


97 &
x_·ck‘_ty³


99 
NULL


105 
·ck‘_ty³
 
	g¬p_·ck‘_ty³
 = {

106 
NET16
(
ETH_P_ARP
),

108 
¬p_rcv
,

109 
NULL
,

110 #ifdeà
CONFIG_IPX


111 #iâdeà
CONFIG_AX25


112 &
x_·ck‘_ty³


114 &
ax25_·ck‘_ty³


117 #ifdeà
CONFIG_AX25


118 &
ax25_·ck‘_ty³


120 
NULL


126 
·ck‘_ty³
 
	g_·ck‘_ty³
 = {

127 
NET16
(
ETH_P_IP
),

129 
_rcv
,

130 
NULL
,

131 &
¬p_·ck‘_ty³


135 
·ck‘_ty³
 *
	g±y³_ba£
 = &
_·ck‘_ty³
;

136 
sk_buff
 *vŞ©
	gbacklog
 = 
NULL
;

137 
	g_bÿ¡
 = 0;

142 
	$mš
(
a
, 
b
)

144 ià(
a
 < 
b
) (a);

145 (
b
);

146 
	}
}

151 
	$g‘_mask
(
addr
)

153 
d¡
;

155 ià(
addr
 == 0L)

158 
d¡
 = 
	`Áohl
(
addr
);

159 ià(
	`IN_CLASSA
(
d¡
))

160 (
	`htÚl
(
IN_CLASSA_NET
));

161 ià(
	`IN_CLASSB
(
d¡
))

162 (
	`htÚl
(
IN_CLASSB_NET
));

163 ià(
	`IN_CLASSC
(
d¡
))

164 (
	`htÚl
(
IN_CLASSC_NET
));

168 
	}
}

172 
	$_addr_m©ch
(
me
, 
him
)

174 
i
;

175 
mask
=0xFFFFFFFF;

176 
	`DPRINTF
((
DBG_DEV
, "_addr_m©ch(%s, ", 
	`š_Áß
(
me
)));

177 
	`DPRINTF
((
DBG_DEV
, "%s)\n", 
	`š_Áß
(
him
)));

179 ià(
me
 =ğ
him
)

181 
i
 = 0; i < 4; i++, 
me
 >>ğ8, 
him
 >>ğ8, 
mask
 >>= 8) {

182 ià((
me
 & 0xFFè!ğ(
him
 & 0xFF)) {

187 ià(
me
 !ğ0 && m!ğ
mask
) (0);

192 
	}
}

196 
	$chk_addr
(
addr
)

198 
deviû
 *
dev
;

199 
mask
;

202 ià(
addr
 =ğ
INADDR_ANY
 ||‡dd¸=ğ
INADDR_BROADCAST
)

203  
IS_BROADCAST
;

205 
mask
 = 
	`g‘_mask
(
addr
);

208 ià((
addr
 & 
mask
è=ğ
	`htÚl
(0x7F000000L))

209  
IS_MYADDR
;

212 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

213 ià(!(
dev
->
æags
 & 
IFF_UP
))

215 ià((
dev
->
·_addr
 == 0) )

216  
IS_MYADDR
;

218 ià(
addr
 =ğ
dev
->
·_addr
)

219  
IS_MYADDR
;

221 ià((
dev
->
æags
 & 
IFF_BROADCAST
è&& 
addr
 =ğdev->
·_brdaddr
)

222  
IS_BROADCAST
;

224 ià(((
addr
 ^ 
dev
->
·_addr
è& dev->
·_mask
) == 0) {

225 ià((
addr
 & ~
dev
->
·_mask
) == 0)

226  
IS_BROADCAST
;

227 ià((
addr
 & ~
dev
->
·_mask
) == ~dev->pa_mask)

228  
IS_BROADCAST
;

231 ià(((
addr
 ^ 
dev
->
·_addr
è& 
mask
) == 0) {

232 ià((
addr
 & ~
mask
) == 0)

233  
IS_BROADCAST
;

234 ià((
addr
 & ~
mask
) == ~mask)

235  
IS_BROADCAST
;

239 
	}
}

251 
	$my_addr
()

253 
deviû
 *
dev
;

255 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

256 ià(
dev
->
æags
 & 
IFF_LOOPBACK
è(dev->
·_addr
);

259 
	}
}

262 
	gdev_n™
=0;

266 
	$dev_add_·ck
(
·ck‘_ty³
 *
±
)

268 
·ck‘_ty³
 *
p1
;

269 
±
->
Ãxt
 = 
±y³_ba£
;

274 
±
->
cİy
=0;

275 if(
±
->
ty³
==
	`NET16
(
ETH_P_ALL
))

276 
dev_n™
++;

280 
p1
 = 
±y³_ba£
;…1 !ğ
NULL
;…1 =…1->
Ãxt
) {

281 ià(
p1
->
ty³
 =ğ
±
->type) {

282 
±
->
cİy
 = 1;

292 if(
±
->
ty³
==
	`NET16
(
ETH_P_ALL
))

294 
±
->
Ãxt
=
NULL
;

295 if(
±y³_ba£
==
NULL
)

296 
±y³_ba£
=
±
;

299 
p1
=
±y³_ba£
;p1->
Ãxt
!=
NULL
;p1=p1->next);

300 
p1
->
Ãxt
=
±
;

304 
±y³_ba£
 = 
±
;

305 
	}
}

310 
	$dev_»move_·ck
(
·ck‘_ty³
 *
±
)

312 
·ck‘_ty³
 *
Ít
, *
±1
;

314 ià(
±
->
ty³
 =ğ
	`NET16
(
ETH_P_ALL
))

315 
dev_n™
--;

316 ià(
±
 =ğ
±y³_ba£
) {

317 
±y³_ba£
 = 
±
->
Ãxt
;

321 
Ít
 = 
NULL
;

322 
±1
 = 
±y³_ba£
;…t1->
Ãxt
 !ğ
NULL
;…t1 =…t1->next) {

323 ià(
±1
->
Ãxt
 =ğ
±
 ) {

324 
	`şi
();

325 ià(!
±
->
cİy
 && 
Ít
)

326 
Ít
->
cİy
 = 0;

327 
±1
->
Ãxt
 = 
±
->next;

328 
	`¡i
();

332 ià(
±1
->
Ãxt
 -> 
ty³
 =ğ
±
 ->ty³ &&…t->ty³ !ğ
	`NET16
(
ETH_P_ALL
)) {

333 
Ít
 = 
±1
->
Ãxt
;

336 
	}
}

340 
deviû
 *

341 
	$dev_g‘
(*
Çme
)

343 
deviû
 *
dev
;

345 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

346 ià(
	`¡rcmp
(
dev
->
Çme
,‚ame) == 0)

347 (
dev
);

349 (
NULL
);

350 
	}
}

354 
deviû
 * 
	$dev_check
(
addr
)

356 
deviû
 *
dev
;

358 
dev
 = 
dev_ba£
; dev; dev = dev->
Ãxt
) {

359 ià(!(
dev
->
æags
 & 
IFF_UP
))

361 ià(!(
dev
->
æags
 & 
IFF_POINTOPOINT
))

363 ià(
addr
 !ğ
dev
->
·_d¡addr
)

365  
dev
;

367 
dev
 = 
dev_ba£
; dev; dev = dev->
Ãxt
) {

368 ià(!(
dev
->
æags
 & 
IFF_UP
))

370 ià(
dev
->
æags
 & 
IFF_POINTOPOINT
)

372 ià(
dev
->
·_mask
 & (
addr
 ^ dev->
·_addr
))

374  
dev
;

376  
NULL
;

377 
	}
}

382 
	$dev_İ’
(
deviû
 *
dev
)

384 
»t
 = 0;

386 ià(
dev
->
İ’
)

387 
»t
 = 
dev
->
	`İ’
(dev);

388 ià(
»t
 == 0)

389 
dev
->
æags
 |ğ(
IFF_UP
 | 
IFF_RUNNING
);

391 (
»t
);

392 
	}
}

397 
	$dev_şo£
(
deviû
 *
dev
)

399 ià(
dev
->
æags
 != 0) {

400 
ù
=0;

401 
dev
->
æags
 = 0;

402 ià(
dev
->
¡İ
)

403 
dev
->
	`¡İ
(dev);

404 
	`¹_æush
(
dev
);

405 
dev
->
·_addr
 = 0;

406 
dev
->
·_d¡addr
 = 0;

407 
dev
->
·_brdaddr
 = 0;

408 
dev
->
·_mask
 = 0;

410 
ù
<
DEV_NUMBUFFS
)

412 
sk_buff
 *
skb
;

413 (
skb
=
	`skb_dequeue
(&
dev
->
buffs
[
ù
]))!=
NULL
)

414 if(
skb
->
ä“
)

415 
	`kä“_skb
(
skb
,
FREE_WRITE
);

416 
ù
++;

421 
	}
}

426 
	$dev_queue_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
´i
)

428 
wh”e
 = 0;

432 
	`DPRINTF
((
DBG_DEV
, "dev_queue_xmit(skb=%X, dev=%X,…ri = %d)\n",

433 
skb
, 
dev
, 
´i
));

435 ià(
dev
 =ğ
NULL
) {

436 
	`´štk
("dev.c: dev_queue_xmit: dev = NULL\n");

440 
	`IS_SKB
(
skb
);

442 
skb
->
dev
 = dev;

443 ià(
skb
->
Ãxt
 !ğ
NULL
) {

445 
dev
->
	`h¬d_¡¬t_xm™
(
NULL
, dev);

449 ià(
´i
 < 0) {

450 
´i
 = -pri-1;

451 
wh”e
 = 1;

454 ià(
´i
 >ğ
DEV_NUMBUFFS
) {

455 
	`´štk
("bad…riority in dev_queue_xmit.\n");

456 
´i
 = 1;

459 ià(
dev
->
	`h¬d_¡¬t_xm™
(
skb
, dev) == 0) {

464 
	`DPRINTF
((
DBG_DEV
, "dev_queue_xmit dev->buffs[%d]=%X\n",

465 
´i
, 
dev
->
buffs
[pri]));

468 
	`şi
();

469 
skb
->
magic
 = 
DEV_QUEUE_MAGIC
;

470 if(
wh”e
)

471 
	`skb_queue_h—d
(&
dev
->
buffs
[
´i
],
skb
);

473 
	`skb_queue_
(&
dev
->
buffs
[
´i
],
skb
);

474 
skb
->
magic
 = 
DEV_QUEUE_MAGIC
;

475 
	`¡i
();

476 
	}
}

483 
	$Ãtif_rx
(
sk_buff
 *
skb
)

486 
skb
->
sk
 = 
NULL
;

487 
skb
->
ä“
 = 1;

490 
	`IS_SKB
(
skb
);

491 
	`skb_queue_
(&
backlog
,
skb
);

494 ià(
backlog
 !ğ
NULL
è
	`m¬k_bh
(
INET_BH
);

497 
	}
}

511 
	$dev_ršt
(*
buff
, 
Ën
, 
æags
, 
deviû
 *
dev
)

513 
drİpšg
 = 0;

514 
sk_buff
 *
skb
 = 
NULL
;

515 *
to
;

516 
amouÁ
, 
Ëá
;

517 
Ën2
;

519 ià(
dev
 =ğ
NULL
 || 
buff
 =ğNULL || 
Ën
 <= 0) (1);

520 ià(
æags
 & 
IN_SKBUFF
) {

521 
skb
 = (
sk_buff
 *è
buff
;

523 ià(
drİpšg
) {

524 ià(
backlog
 !ğ
NULL
)

526 
	`´štk
("INET: dev_rint:‚o†onger dropping…ackets.\n");

527 
drİpšg
 = 0;

530 
skb
 = 
	`®loc_skb
((*skbè+ 
Ën
, 
GFP_ATOMIC
);

531 ià(
skb
 =ğ
NULL
) {

532 
	`´štk
("dev_rint:…acket dropped on %s (no memory) !\n",

533 
dev
->
Çme
);

534 
drİpšg
 = 1;

537 
skb
->
mem_Ën
 = (*skbè+ 
Ën
;

538 
skb
->
mem_addr
 = (
sk_buff
 *) skb;

541 
to
 = 
skb
->
d©a
;

542 
Ëá
 = 
Ën
;

543 
Ën2
 = 
Ën
;

544 
Ën2
 > 0) {

545 
amouÁ
 = 
	`mš
(
Ën2
, (è
dev
->
rmem_’d
 -

546 (è
buff
);

547 
	`memıy
(
to
, 
buff
, 
amouÁ
);

548 
Ën2
 -ğ
amouÁ
;

549 
Ëá
 -ğ
amouÁ
;

550 
buff
 +ğ
amouÁ
;

551 
to
 +ğ
amouÁ
;

552 ià((è
buff
 =ğ
dev
->
rmem_’d
)

553 
buff
 = (*è
dev
->
rmem_¡¬t
;

556 
skb
->
Ën
 =†en;

557 
skb
->
dev
 = dev;

558 
skb
->
ä“
 = 1;

560 
	`Ãtif_rx
(
skb
);

563 
	}
}

568 
	$dev_Œªsm™
()

570 
deviû
 *
dev
;

572 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

573 ià(!
dev
->
tbusy
) {

574 
	`dev_tšt
(
dev
);

577 
	}
}

579 vŞ©
	gš_bh
 = 0;

581 
	$š_š‘_bh
()

583 (
š_bh
==0?0:1);

584 
	}
}

592 
	$š‘_bh
(*
tmp
)

594 
sk_buff
 *
skb
;

595 
·ck‘_ty³
 *
±y³
;

596 
ty³
;

597 
æag
 = 0;

598 
n™couÁ
;

601 ià(
	`£t_b™
(1, (*)&
š_bh
))

605 
	`dev_Œªsm™
();

608 (
skb
=
	`skb_dequeue
(&
backlog
))!=
NULL
)

610 
n™couÁ
=
dev_n™
;

611 
æag
=0;

612 
	`¡i
();

619 
skb
->
h
.
¿w
 = skb->
d©a
 + skb->
dev
->
h¬d_h—d”_Ën
;

620 
skb
->
Ën
 -ğskb->
dev
->
h¬d_h—d”_Ën
;

631 
ty³
 = 
skb
->
dev
->
	`ty³_Œªs
(skb, skb->dev);

639 
±y³
 = 
±y³_ba£
;…ty³ !ğ
NULL
;…ty³ =…ty³->
Ãxt
) {

640 ià(
±y³
->
ty³
 =ğty³ ||…ty³->ty³ =ğ
	`NET16
(
ETH_P_ALL
)) {

641 
sk_buff
 *
skb2
;

643 ià(
±y³
->
ty³
==
	`NET16
(
ETH_P_ALL
))

644 
n™couÁ
--;

645 ià(
±y³
->
cİy
 || 
n™couÁ
) {

646 
skb2
 = 
	`®loc_skb
(
skb
->
mem_Ën
, 
GFP_ATOMIC
);

647 ià(
skb2
 =ğ
NULL
)

649 
	`memıy
(
skb2
, (cÚ¡ *è
skb
, skb->
mem_Ën
);

650 
skb2
->
mem_addr
 = skb2;

651 
skb2
->
h
.
¿w
 = (*)(

652 (è
skb2
 +

653 (è
skb
->
h
.
¿w
 -

654 (è
skb


656 
skb2
->
ä“
 = 1;

658 
skb2
 = 
skb
;

665 
æag
 = 1;

668 
±y³
->
	`func
(
skb2
, 
skb
->
dev
,…type);

676 ià(!
æag
) {

677 
	`DPRINTF
((
DBG_DEV
,

678 "INET: unknowÀ·ck‘y³ 0x%04X (ignÜed)\n", 
ty³
));

679 
skb
->
sk
 = 
NULL
;

680 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

684 
	`dev_Œªsm™
();

685 
	`şi
();

687 
š_bh
 = 0;

688 
	`¡i
();

689 
	`dev_Œªsm™
();

690 
	}
}

698 
	$dev_tšt
(
deviû
 *
dev
)

700 
i
;

701 
sk_buff
 *
skb
;

703 
i
 = 0;˜< 
DEV_NUMBUFFS
; i++) {

704 (
skb
=
	`skb_dequeue
(&
dev
->
buffs
[
i
]))!=
NULL
)

706 
skb
->
magic
 = 0;

707 
skb
->
Ãxt
 = 
NULL
;

708 
skb
->
´ev
 = 
NULL
;

709 
dev
->
	`queue_xm™
(
skb
,dev,-
i
 - 1);

710 ià(
dev
->
tbusy
)

714 
	}
}

719 
	$dev_ifcÚf
(*
¬g
)

721 
ifcÚf
 
ifc
;

722 
iäeq
 
iä
;

723 
deviû
 *
dev
;

724 *
pos
;

725 
Ën
;

726 
”r
;

729 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
¬g
, (
ifcÚf
));

730 if(
”r
)

731  
”r
;

732 
	`memıy_äomfs
(&
ifc
, 
¬g
, (
ifcÚf
));

733 
Ën
 = 
ifc
.
ifc_Ën
;

734 
pos
 = 
ifc
.
ifc_buf
;

737 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

738 if(!(
dev
->
æags
 & 
IFF_UP
))

740 
	`mem£t
(&
iä
, 0, (
iäeq
));

741 
	`¡rıy
(
iä
.
iä_Çme
, 
dev
->
Çme
);

742 (*(
sockaddr_š
 *è&
iä
.
iä_addr
).
sš_çmy
 = 
dev
->
çmy
;

743 (*(
sockaddr_š
 *è&
iä
.
iä_addr
).
sš_addr
.
s_addr
 = 
dev
->
·_addr
;

746 
	`memıy_tofs
(
pos
, &
iä
, (
iäeq
));

747 
pos
 +ğ(
iäeq
);

748 
Ën
 -ğ(
iäeq
);

749 ià(
Ën
 < (
iäeq
)) ;

753 
ifc
.
ifc_Ën
 = (
pos
 - ifc.
ifc_buf
);

754 
ifc
.
ifc_»q
 = (
iäeq
 *èifc.
ifc_buf
;

755 
	`memıy_tofs
(
¬g
, &
ifc
, (
ifcÚf
));

756 (
pos
 - 
¬g
);

757 
	}
}

760 *
	$¥rštf_¡©s
(*
bufãr
, 
deviû
 *
dev
)

762 *
pos
 = 
bufãr
;

763 
’‘_¡©i¡ics
 *
¡©s
 = (
dev
->
g‘_¡©s
 ? dev->
	`g‘_¡©s
(dev): 
NULL
);

765 ià(
¡©s
)

766 
pos
 +ğ
	`¥rštf
(pos, "%6s:%7d %4d %4d %4d %4d %8d %4d %4d %4d %5d %4d\n",

767 
dev
->
Çme
,

768 
¡©s
->
rx_·ck‘s
, sts->
rx_”rÜs
,

769 
¡©s
->
rx_drİ³d
 + sts->
rx_mis£d_”rÜs
,

770 
¡©s
->
rx_fifo_”rÜs
,

771 
¡©s
->
rx_Ëngth_”rÜs
 + sts->
rx_ov”_”rÜs


772 + 
¡©s
->
rx_üc_”rÜs
 + sts->
rx_äame_”rÜs
,

773 
¡©s
->
tx_·ck‘s
, sts->
tx_”rÜs
, sts->
tx_drİ³d
,

774 
¡©s
->
tx_fifo_”rÜs
, sts->
cŞlisiÚs
,

775 
¡©s
->
tx_ÿ¼›r_”rÜs
 + sts->
tx_abÜ‹d_”rÜs


776 + 
¡©s
->
tx_wšdow_”rÜs
 + sts->
tx_h—¹b—t_”rÜs
);

778 
pos
 +ğ
	`¥rštf
Õos, "%6s: NØ¡©i¡ic avaabË.\n", 
dev
->
Çme
);

780  
pos
;

781 
	}
}

785 
	$dev_g‘_šfo
(*
bufãr
)

787 *
pos
 = 
bufãr
;

788 
deviû
 *
dev
;

790 
pos
 +=

791 
	`¥rštf
(
pos
,

794 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev = dev->
Ãxt
) {

795 
pos
 = 
	`¥rštf_¡©s
Õos, 
dev
);

797  
pos
 - 
bufãr
;

798 
	}
}

800 
šlše
 
	$bad_mask
(
mask
, 
addr
)

802 ià(
addr
 & (
mask
 = ~mask))

804 
mask
 = 
	`Áohl
(mask);

805 ià(
mask
 & (mask+1))

808 
	}
}

813 
	$dev_ifsioc
(*
¬g
, 
g‘£t
)

815 
iäeq
 
iä
;

816 
deviû
 *
dev
;

817 
»t
;

820 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
¬g
, (
iäeq
));

821 if(
”r
)

822  
”r
;

823 
	`memıy_äomfs
(&
iä
, 
¬g
, (
iäeq
));

826 ià((
dev
 = 
	`dev_g‘
(
iä
.
iä_Çme
)è=ğ
NULL
è(-
EINVAL
);

828 
g‘£t
) {

829 
SIOCGIFFLAGS
:

830 
iä
.
iä_æags
 = 
dev
->
æags
;

831 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

832 
»t
 = 0;

834 
SIOCSIFFLAGS
:

836 
Şd_æags
 = 
dev
->
æags
;

837 
dev
->
æags
 = 
iä
.
iä_æags
 & (

838 
IFF_UP
 | 
IFF_BROADCAST
 | 
IFF_DEBUG
 | 
IFF_LOOPBACK
 |

839 
IFF_POINTOPOINT
 | 
IFF_NOTRAILERS
 | 
IFF_RUNNING
 |

840 
IFF_NOARP
 | 
IFF_PROMISC
 | 
IFF_ALLMULTI
);

842 iàĞ(
Şd_æags
 & 
IFF_PROMISC
è&& ((
dev
->
æags
 & IFF_PROMISC) == 0))

843 
dev
->
	`£t_muÉiÿ¡_li¡
(dev,0,
NULL
);

844 iàĞ(
dev
->
æags
 & 
IFF_PROMISC
è&& ((
Şd_æags
 & IFF_PROMISC) == 0))

845 
dev
->
	`£t_muÉiÿ¡_li¡
(dev,-1,
NULL
);

846 ià((
Şd_æags
 & 
IFF_UP
è&& ((
dev
->
æags
 & IFF_UP) == 0)) {

847 
»t
 = 
	`dev_şo£
(
dev
);

850 
»t
 = (! (
Şd_æags
 & 
IFF_UP
è&& (
dev
->
æags
 & IFF_UP))

851 ? 
	`dev_İ’
(
dev
) : 0;

852 if(
»t
<0)

853 
dev
->
æags
&=~
IFF_UP
;

857 
SIOCGIFADDR
:

858 (*(
sockaddr_š
 *)

859 &
iä
.
iä_addr
).
sš_addr
.
s_addr
 = 
dev
->
·_addr
;

860 (*(
sockaddr_š
 *)

861 &
iä
.
iä_addr
).
sš_çmy
 = 
dev
->
çmy
;

862 (*(
sockaddr_š
 *)

863 &
iä
.
iä_addr
).
sš_pÜt
 = 0;

864 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

865 
»t
 = 0;

867 
SIOCSIFADDR
:

868 
dev
->
·_addr
 = (*(
sockaddr_š
 *)

869 &
iä
.
iä_addr
).
sš_addr
.
s_addr
;

870 
dev
->
çmy
 = 
iä
.
iä_addr
.
§_çmy
;

871 
dev
->
·_mask
 = 
	`g‘_mask
(dev->
·_addr
);

872 
dev
->
·_brdaddr
 = dev->
·_addr
 | ~dev->
·_mask
;

873 
»t
 = 0;

875 
SIOCGIFBRDADDR
:

876 (*(
sockaddr_š
 *)

877 &
iä
.
iä_brßdaddr
).
sš_addr
.
s_addr
 = 
dev
->
·_brdaddr
;

878 (*(
sockaddr_š
 *)

879 &
iä
.
iä_brßdaddr
).
sš_çmy
 = 
dev
->
çmy
;

880 (*(
sockaddr_š
 *)

881 &
iä
.
iä_brßdaddr
).
sš_pÜt
 = 0;

882 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

883 
»t
 = 0;

885 
SIOCSIFBRDADDR
:

886 
dev
->
·_brdaddr
 = (*(
sockaddr_š
 *)

887 &
iä
.
iä_brßdaddr
).
sš_addr
.
s_addr
;

888 
»t
 = 0;

890 
SIOCGIFDSTADDR
:

891 (*(
sockaddr_š
 *)

892 &
iä
.
iä_d¡addr
).
sš_addr
.
s_addr
 = 
dev
->
·_d¡addr
;

893 (*(
sockaddr_š
 *)

894 &
iä
.
iä_brßdaddr
).
sš_çmy
 = 
dev
->
çmy
;

895 (*(
sockaddr_š
 *)

896 &
iä
.
iä_brßdaddr
).
sš_pÜt
 = 0;

897 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

898 
»t
 = 0;

900 
SIOCSIFDSTADDR
:

901 
dev
->
·_d¡addr
 = (*(
sockaddr_š
 *)

902 &
iä
.
iä_d¡addr
).
sš_addr
.
s_addr
;

903 
»t
 = 0;

905 
SIOCGIFNETMASK
:

906 (*(
sockaddr_š
 *)

907 &
iä
.
iä_Ãtmask
).
sš_addr
.
s_addr
 = 
dev
->
·_mask
;

908 (*(
sockaddr_š
 *)

909 &
iä
.
iä_Ãtmask
).
sš_çmy
 = 
dev
->
çmy
;

910 (*(
sockaddr_š
 *)

911 &
iä
.
iä_Ãtmask
).
sš_pÜt
 = 0;

912 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

913 
»t
 = 0;

915 
SIOCSIFNETMASK
: {

916 
mask
 = (*(
sockaddr_š
 *)

917 &
iä
.
iä_Ãtmask
).
sš_addr
.
s_addr
;

918 
»t
 = -
EINVAL
;

919 ià(
	`bad_mask
(
mask
,0))

921 
dev
->
·_mask
 = 
mask
;

922 
»t
 = 0;

925 
SIOCGIFMETRIC
:

926 
iä
.
iä_m‘ric
 = 
dev
->
m‘ric
;

927 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

928 
»t
 = 0;

930 
SIOCSIFMETRIC
:

931 
dev
->
m‘ric
 = 
iä
.
iä_m‘ric
;

932 
»t
 = 0;

934 
SIOCGIFMTU
:

935 
iä
.
iä_mtu
 = 
dev
->
mtu
;

936 
	`memıy_tofs
(
¬g
, &
iä
, (
iäeq
));

937 
»t
 = 0;

939 
SIOCSIFMTU
:

940 
dev
->
mtu
 = 
iä
.
iä_mtu
;

941 
»t
 = 0;

943 
SIOCGIFMEM
:

944 
	`´štk
("NET: ioùl(SIOCGIFMEM, 0x%08X)\n", ()
¬g
);

945 
»t
 = -
EINVAL
;

947 
SIOCSIFMEM
:

948 
	`´štk
("NET: ioùl(SIOCSIFMEM, 0x%08X)\n", ()
¬g
);

949 
»t
 = -
EINVAL
;

951 
SIOCGIFHWADDR
:

952 
	`memıy
(
iä
.
iä_hwaddr
,
dev
->
dev_addr
, 
MAX_ADDR_LEN
);

953 
	`memıy_tofs
(
¬g
,&
iä
,(
iäeq
));

954 
»t
=0;

957 
»t
 = -
EINVAL
;

959 (
»t
);

960 
	}
}

965 
	$dev_ioùl
(
cmd
, *
¬g
)

967 
iæšk
 iflink;

968 
ddi_deviû
 *
dev
;

970 
cmd
) {

971 
IP_SET_DEV
:

972 
	`´štk
("Your‚etwork configuration…rogram‚eeds upgrading.\n");

973  -
EINVAL
;

975 
SIOCGIFCONF
:

976 (è
	`dev_ifcÚf
((*è
¬g
);

979 
SIOCGIFFLAGS
:

980 
SIOCGIFADDR
:

981 
SIOCGIFDSTADDR
:

982 
SIOCGIFBRDADDR
:

983 
SIOCGIFNETMASK
:

984 
SIOCGIFMETRIC
:

985 
SIOCGIFMTU
:

986 
SIOCGIFMEM
:

987 
SIOCGIFHWADDR
:

988  
	`dev_ifsioc
(
¬g
, 
cmd
);

990 
SIOCSIFFLAGS
:

991 
SIOCSIFADDR
:

992 
SIOCSIFDSTADDR
:

993 
SIOCSIFBRDADDR
:

994 
SIOCSIFNETMASK
:

995 
SIOCSIFMETRIC
:

996 
SIOCSIFMTU
:

997 
SIOCSIFMEM
:

998 ià(!
	`su£r
())

999  -
EPERM
;

1000  
	`dev_ifsioc
(
¬g
, 
cmd
);

1002 
SIOCSIFLINK
:

1003 ià(!
	`su£r
())

1004  -
EPERM
;

1005 
	`memıy_äomfs
(&
iæšk
, 
¬g
, (iflink));

1006 
dev
 = 
	`ddi_m­
(
iæšk
.
id
);

1007 ià(
dev
 =ğ
NULL
)

1008  -
EINVAL
;

1011 
	`´štk
("AF_INET: DDI \"%s\"†inkedo stream \"%s\"\n",

1012 
dev
->
Çme
, 
iæšk
.
¡»am
);

1016  -
EINVAL
;

1018 
	}
}

1023 
	$dev_š™
()

1025 
deviû
 *
dev
, *
dev2
;

1032 
dev2
 = 
NULL
;

1033 
dev
 = 
dev_ba£
; dev !ğ
NULL
; dev=dev->
Ãxt
) {

1034 ià(
dev
->
š™
 && dev->
	`š™
(dev)) {

1035 ià(
dev2
 =ğ
NULL
è
dev_ba£
 = 
dev
->
Ãxt
;

1036 
dev2
->
Ãxt
 = 
dev
->next;

1038 
dev2
 = 
dev
;

1043 
_bÿ¡
 = 
	`š_©Ú
("255.255.255.255");

1044 
	}
}

	@net/inet/dev.h

20 #iâdeà
_DEV_H


21 
	#_DEV_H


	)

23 
	~<lšux/if.h
>

24 
	~<lšux/if_‘h”.h
>

28 
	#DEV_NUMBUFFS
 3

	)

29 
	#MAX_ADDR_LEN
 7

	)

30 
	#MAX_HEADER
 18

	)

32 
	#IS_MYADDR
 1

	)

33 
	#IS_LOOPBACK
 2

	)

34 
	#IS_BROADCAST
 3

	)

35 
	#IS_INVBCAST
 4

	)

45 
	sdeviû
 {

52 *
	mÇme
;

55 
	mrmem_’d
;

56 
	mrmem_¡¬t
;

57 
	mmem_’d
;

58 
	mmem_¡¬t
;

59 
	mba£_addr
;

60 
	mœq
;

63 vŞ©
	m¡¬t
,

64 
	mtbusy
,

65 
	mš‹¼u±
;

73 
deviû
 *
	mÃxt
;

76 (*
	mš™
)(
deviû
 *
	mdev
);

80 
	mif_pÜt
;

81 
	mdma
;

83 
	m’‘_¡©i¡ics
* (*
	mg‘_¡©s
)(
deviû
 *
	mdev
);

92 
	mŒªs_¡¬t
;

93 
	mÏ¡_rx
;

95 
	mæags
;

96 
	mçmy
;

97 
	mm‘ric
;

98 
	mmtu
;

99 
	mty³
;

100 
	mh¬d_h—d”_Ën
;

101 *
	m´iv
;

104 
	mbrßdÿ¡
[
MAX_ADDR_LEN
];

105 
	mdev_addr
[
MAX_ADDR_LEN
];

106 
	maddr_Ën
;

107 
	m·_addr
;

108 
	m·_brdaddr
;

109 
	m·_d¡addr
;

110 
	m·_mask
;

111 
	m·_®’
;

114 
sk_buff
 *vŞ©
	mbuffs
[
DEV_NUMBUFFS
];

117 (*
	mİ’
)(
deviû
 *
	mdev
);

118 (*
	m¡İ
)(
deviû
 *
	mdev
);

119 (*
	mh¬d_¡¬t_xm™
è(
sk_buff
 *
	mskb
,

120 
deviû
 *
	mdev
);

121 (*
	mh¬d_h—d”
è(*
	mbuff
,

122 
deviû
 *
	mdev
,

123 
	mty³
,

124 
	mdaddr
,

125 
	m§ddr
,

126 
	mËn
);

127 (*
	madd_¬p
è(
	maddr
,

128 
sk_buff
 *
	mskb
,

129 
deviû
 *
	mdev
);

130 (*
	mqueue_xm™
)(
sk_buff
 *
	mskb
,

131 
deviû
 *
	mdev
, 
	m´i
);

132 (*
	m»bud_h—d”
)(*
	m‘h
, 
deviû
 *
	mdev
);

133 (*
	mty³_Œªs
è(
sk_buff
 *
	mskb
,

134 
deviû
 *
	mdev
);

135 
	#HAVE_MULTICAST


	)

136 (*
	m£t_muÉiÿ¡_li¡
)(
deviû
 *
	mdev
,

137 
	mnum_addrs
, *
	maddrs
);

138 
	#HAVE_SET_MAC_ADDR


	)

139 (*
	m£t_mac_add»ss
)(
deviû
 *
	mdev
, *
	maddr
);

143 
	s·ck‘_ty³
 {

144 
	mty³
;

148 
	mcİy
:1;

149 (*
	mfunc
è(
	msk_buff
 *, 
	mdeviû
 *,

150 
	m·ck‘_ty³
 *);

151 *
	md©a
;

152 
·ck‘_ty³
 *
	mÃxt
;

157 
	#IN_SKBUFF
 1

	)

158 
	#DEV_QUEUE_MAGIC
 0x17432895

	)

161 
deviû
 *
dev_ba£
;

162 
·ck‘_ty³
 *
±y³_ba£
;

165 
_addr_m©ch
(
addr1
, 
addr2
);

166 
chk_addr
(
addr
);

167 
deviû
 *
dev_check
(
daddr
);

168 
my_addr
();

170 
dev_add_·ck
(
·ck‘_ty³
 *
±
);

171 
dev_»move_·ck
(
·ck‘_ty³
 *
±
);

172 
deviû
 *
dev_g‘
(*
Çme
);

173 
dev_İ’
(
deviû
 *
dev
);

174 
dev_şo£
(
deviû
 *
dev
);

175 
dev_queue_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

176 
´i
);

177 
	#HAVE_NETIF_RX
 1

	)

178 
Ãtif_rx
(
sk_buff
 *
skb
);

180 
dev_ršt
(*
buff
, 
Ën
, 
æags
,

181 
deviû
 * 
dev
);

182 
dev_Œªsm™
();

183 
š_š‘_bh
();

184 
š‘_bh
(*
tmp
);

185 
dev_tšt
(
deviû
 *
dev
);

186 
dev_g‘_šfo
(*
bufãr
);

187 
dev_ioùl
(
cmd
, *);

189 
dev_š™
();

	@net/inet/eth.c

27 
	~<asm/£gm’t.h
>

28 
	~<asm/sy¡em.h
>

29 
	~<lšux/ty³s.h
>

30 
	~<lšux/k”Ãl.h
>

31 
	~<lšux/sched.h
>

32 
	~<lšux/¡ršg.h
>

33 
	~<lšux/mm.h
>

34 
	~<lšux/sock‘.h
>

35 
	~<lšux/š.h
>

36 
	~"š‘.h
"

37 
	~"dev.h
"

38 
	~"‘h.h
"

39 
	~".h
"

40 
	~"rou‹.h
"

41 
	~"´ÙocŞ.h
"

42 
	~"tı.h
"

43 
	~"skbuff.h
"

44 
	~"sock.h
"

45 
	~<lšux/”ºo.h
>

46 
	~"¬p.h
"

50 *
	$‘h_´št
(*
±r
)

52 
buff
[64];

54 ià(
±r
 =ğ
NULL
) ("[NONE]");

55 
	`¥rštf
(
buff
, "%02X:%02X:%02X:%02X:%02X:%02X",

56 (
±r
[0] & 255), (ptr[1] & 255), (ptr[2] & 255),

57 (
±r
[3] & 255), (ptr[4] & 255), (ptr[5] & 255)

59 (
buff
);

60 
	}
}

62 
	$‘h_£tup
(*
¡r
, *
šts
)

64 
deviû
 *
d
 = 
dev_ba£
;

66 ià(!
¡r
 || !*str)

68 
d
) {

69 ià(!
	`¡rcmp
(
¡r
,
d
->
Çme
)) {

70 ià(
šts
[0] > 0)

71 
d
->
œq
=
šts
[1];

72 ià(
šts
[0] > 1)

73 
d
->
ba£_addr
=
šts
[2];

74 ià(
šts
[0] > 2)

75 
d
->
mem_¡¬t
=
šts
[3];

76 ià(
šts
[0] > 3)

77 
d
->
mem_’d
=
šts
[4];

80 
d
=d->
Ãxt
;

82 
	}
}

86 
	$‘h_dump
(
‘hhdr
 *
‘h
)

88 ià(
š‘_debug
 !ğ
DBG_ETH
) ;

90 
	`´štk
("‘h: SRC = % ", 
	`‘h_´št
(
‘h
->
h_sourû
));

91 
	`´štk
("DST = % ", 
	`‘h_´št
(
‘h
->
h_de¡
));

92 
	`´štk
("TYPE = %04X\n", 
	`Áohs
(
‘h
->
h_´Ùo
));

93 
	}
}

98 
	$‘h_h—d”
(*
buff
, 
deviû
 *
dev
, 
ty³
,

99 
daddr
, 
§ddr
, 
Ën
)

101 
‘hhdr
 *
‘h
;

103 
	`DPRINTF
((
DBG_DEV
, "ETH: h—d”(%s, ", 
	`š_Áß
(
§ddr
)));

104 
	`DPRINTF
((
DBG_DEV
, "%s, 0x%X)\n", 
	`š_Áß
(
daddr
), 
ty³
));

107 
‘h
 = (
‘hhdr
 *è
buff
;

108 
‘h
->
h_´Ùo
 = 
	`htÚs
(
ty³
);

111 ià(
dev
->
æags
 & 
IFF_LOOPBACK
) {

112 
	`DPRINTF
((
DBG_DEV
, "ETH: No header for†oopback\n"));

113 
	`memıy
(
‘h
->
h_sourû
, 
dev
->
dev_addr
, dev->
addr_Ën
);

114 
	`mem£t
(
‘h
->
h_de¡
, 0, 
dev
->
addr_Ën
);

115 (
dev
->
h¬d_h—d”_Ën
);

119 ià(
	`chk_addr
(
daddr
è=ğ
IS_BROADCAST
) {

120 
	`DPRINTF
((
DBG_DEV
, "ETH: Using MAC Broadcast\n"));

121 
	`memıy
(
‘h
->
h_sourû
, 
dev
->
dev_addr
, dev->
addr_Ën
);

122 
	`memıy
(
‘h
->
h_de¡
, 
dev
->
brßdÿ¡
, dev->
addr_Ën
);

123 (
dev
->
h¬d_h—d”_Ën
);

125 
	`şi
();

126 
	`memıy
(
‘h
->
h_sourû
, &
§ddr
, 4);

128 ià(
	`¬p_fšd
(
‘h
->
h_de¡
, 
daddr
, 
dev
, dev->
·_addr
))

130 
	`¡i
();

131 if(
ty³
!=
ETH_P_IP
)

132 
	`´štk
("Erk:…rÙocŞ %X gÙ iÁØª‡½„eque¡ s‹!\n",
ty³
);

133 (-
dev
->
h¬d_h—d”_Ën
);

137 
	`memıy
(
‘h
->
h_sourû
,
dev
->
dev_addr
,dev->
addr_Ën
);

139 
	`¡i
();

140 (
dev
->
h¬d_h—d”_Ën
);

142 
	}
}

147 
	$‘h_»bud_h—d”
(*
buff
, 
deviû
 *
dev
)

149 
‘hhdr
 *
‘h
;

150 
¤c
, 
d¡
;

152 
	`DPRINTF
((
DBG_DEV
, "ETH: Using MAC Broadcast\n"));

153 
‘h
 = (
‘hhdr
 *è
buff
;

154 
¤c
 = *(*è
‘h
->
h_sourû
;

155 
d¡
 = *(*è
‘h
->
h_de¡
;

156 
	`DPRINTF
((
DBG_DEV
, "ETH: RebudH—d”: SRC=% ", 
	`š_Áß
(
¤c
)));

157 
	`DPRINTF
((
DBG_DEV
, "DST=%s\n", 
	`š_Áß
(
d¡
)));

158 if(
‘h
->
h_´Ùo
!=
	`htÚs
(
ETH_P_ARP
))

159 ià(
	`¬p_fšd
(
‘h
->
h_de¡
, 
d¡
, 
dev
, dev->
·_addr
 )) (1);

160 
	`memıy
(
‘h
->
h_sourû
, 
dev
->
dev_addr
, dev->
addr_Ën
);

162 
	}
}

167 
	$‘h_add_¬p
(
addr
, 
sk_buff
 *
skb
, 
deviû
 *
dev
)

169 
‘hhdr
 *
‘h
;

171 
‘h
 = (
‘hhdr
 *è
skb
->
d©a
;

172 
	`¬p_add
(
addr
, 
‘h
->
h_sourû
, 
dev
);

173 
	}
}

178 
	$‘h_ty³_Œªs
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

180 
‘hhdr
 *
‘h
;

182 
‘h
 = (
‘hhdr
 *è
skb
->
d©a
;

184 if(
	`Áohs
(
‘h
->
h_´Ùo
)<1536)

185 (
	`htÚs
(
ETH_P_802_3
));

186 (
‘h
->
h_´Ùo
);

187 
	}
}

	@net/inet/eth.h

18 #iâdeà
_ETH_H


19 
	#_ETH_H


	)

22 
	~<lšux/if_‘h”.h
>

25 *
‘h_´št
(*
±r
);

26 
‘h_dump
(
‘hhdr
 *
‘h
);

27 
‘h_h—d”
(*
buff
, 
deviû
 *
dev
,

28 
ty³
, 
daddr
,

29 
§ddr
, 
Ën
);

30 
‘h_»bud_h—d”
(*
buff
, 
deviû
 *
dev
);

31 
‘h_add_¬p
(
addr
, 
sk_buff
 *
skb
,

32 
deviû
 *
dev
);

33 
‘h_ty³_Œªs
(
sk_buff
 *
skb
, 
deviû
 *
dev
);

	@net/inet/icmp.c

25 
	~<lšux/ty³s.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/k”Ãl.h
>

28 
	~<lšux/fú.h
>

29 
	~<lšux/sock‘.h
>

30 
	~<lšux/š.h
>

31 
	~"š‘.h
"

32 
	~"dev.h
"

33 
	~".h
"

34 
	~"rou‹.h
"

35 
	~"´ÙocŞ.h
"

36 
	~"icmp.h
"

37 
	~"tı.h
"

38 
	~"skbuff.h
"

39 
	~"sock.h
"

40 
	~<lšux/”ºo.h
>

41 
	~<lšux/tim”.h
>

42 
	~<asm/sy¡em.h
>

43 
	~<asm/£gm’t.h
>

46 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

50 
icmp_”r
 
	gicmp_”r_cÚv”t
[] = {

51 { 
ENETUNREACH
, 1 },

52 { 
EHOSTUNREACH
, 1 },

53 { 
ENOPROTOOPT
, 1 },

54 { 
ECONNREFUSED
, 1 },

55 { 
EOPNOTSUPP
, 0 },

56 { 
EOPNOTSUPP
, 0 },

57 { 
ENETUNREACH
, 1 },

58 { 
EHOSTDOWN
, 1 },

59 { 
ENONET
, 1 },

60 { 
ENETUNREACH
, 1 },

61 { 
EHOSTUNREACH
, 1 },

62 { 
EOPNOTSUPP
, 0 },

63 { 
EOPNOTSUPP
, 0 }

69 
	$´št_icmp
(
icmphdr
 *
icmph
)

71 ià(
š‘_debug
 !ğ
DBG_ICMP
) ;

73 
	`´štk
("ICMP:ype = %d, code = %d, checksum = %X\n",

74 
icmph
->
ty³
, icmph->
code
, icmph->
checksum
);

75 
	`´štk
(" g©eway = %s\n", 
	`š_Áß
(
icmph
->
un
.
g©eway
));

76 
	}
}

81 
	$icmp_£nd
(
sk_buff
 *
skb_š
, 
ty³
, 
code
, 
deviû
 *
dev
)

83 
sk_buff
 *
skb
;

84 
hdr
 *
h
;

85 
off£t
;

86 
icmphdr
 *
icmph
;

87 
Ën
;

89 
	`DPRINTF
((
DBG_ICMP
, "icmp_send(skb_in = %X,ype = %d, code = %d, dev=%X)\n",

90 
skb_š
, 
ty³
, 
code
, 
dev
));

93 
Ën
 = (
sk_buff
è+ 
dev
->
h¬d_h—d”_Ën
 +

94 (
hdr
è+ (
icmphdr
) +

95 (
hdr
) + 8;

97 
skb
 = (
sk_buff
 *è
	`®loc_skb
(
Ën
, 
GFP_ATOMIC
);

98 ià(
skb
 =ğ
NULL
)

101 
skb
->
sk
 = 
NULL
;

102 
skb
->
mem_addr
 = skb;

103 
skb
->
mem_Ën
 = 
Ën
;

104 
Ën
 -ğ(
sk_buff
);

107 
h
 = (
hdr
 *è(
skb_š
->
d©a
 + 
dev
->
h¬d_h—d”_Ën
);

110 
off£t
 = 
	`_bud_h—d”
(
skb
, 
dev
->
·_addr
, 
h
->
§ddr
,

111 &
dev
, 
IPPROTO_ICMP
, 
NULL
, 
Ën
, 
skb_š
->
_hdr
->
tos
,255);

112 ià(
off£t
 < 0) {

113 
skb
->
sk
 = 
NULL
;

114 
	`kä“_skb
(
skb
, 
FREE_READ
);

119 
skb
->
Ën
 = 
off£t
 + (
icmphdr
è+ (
hdr
) + 8;

120 
icmph
 = (
icmphdr
 *è(
skb
->
d©a
 + 
off£t
);

121 
icmph
->
ty³
 =ype;

122 
icmph
->
code
 = code;

123 
icmph
->
checksum
 = 0;

124 
icmph
->
un
.
g©eway
 = 0;

125 
	`memıy
(
icmph
 + 1, 
h
, (
hdr
) + 8);

127 
icmph
->
checksum
 = 
	`_compu‹_csum
((*)icmph,

128 (
icmphdr
è+ (
hdr
) + 8);

130 
	`DPRINTF
((
DBG_ICMP
, ">>\n"));

131 
	`´št_icmp
(
icmph
);

134 
	`_queue_xm™
(
NULL
, 
dev
, 
skb
, 1);

135 
	}
}

140 
	$icmp_uÄ—ch
(
icmphdr
 *
icmph
, 
sk_buff
 *
skb
)

142 
š‘_´ÙocŞ
 *
´Ù
;

143 
hdr
 *
h
;

144 
hash
;

145 
”r
;

147 
”r
 = (
icmph
->
ty³
 << 8è| icmph->
code
;

148 
h
 = (
hdr
 *è(
icmph
 + 1);

149 
icmph
->
code
 & 7) {

150 
ICMP_NET_UNREACH
:

151 
	`DPRINTF
((
DBG_ICMP
, "ICMP: %s:‚etwork unreachable.\n",

152 
	`š_Áß
(
h
->
daddr
)));

154 
ICMP_HOST_UNREACH
:

155 
	`DPRINTF
((
DBG_ICMP
, "ICMP: %s: host unreachable.\n",

156 
	`š_Áß
(
h
->
daddr
)));

158 
ICMP_PROT_UNREACH
:

159 
	`´štk
("ICMP: %s:%d:…rotocol unreachable.\n",

160 
	`š_Áß
(
h
->
daddr
), 
	`Áohs
(h->
´ÙocŞ
));

162 
ICMP_PORT_UNREACH
:

163 
	`DPRINTF
((
DBG_ICMP
, "ICMP: %s:%d:…ort unreachable.\n",

164 
	`š_Áß
(
h
->
daddr
), -1 ));

166 
ICMP_FRAG_NEEDED
:

167 
	`´štk
("ICMP: %s: fragmentation‚eeded‡nd DF set.\n",

168 
	`š_Áß
(
h
->
daddr
));

170 
ICMP_SR_FAILED
:

171 
	`´štk
("ICMP: %s: Sourû Rou‹ Faed.\n", 
	`š_Áß
(
h
->
daddr
));

174 
	`DPRINTF
((
DBG_ICMP
, "ICMP: Unreachable: CODE=%d from %s\n",

175 (
icmph
->
code
 & 7), 
	`š_Áß
(
h
->
daddr
)));

180 
hash
 = 
h
->
´ÙocŞ
 & (
MAX_INET_PROTOS
 -1);

183 
´Ù
 = (
š‘_´ÙocŞ
 *è
š‘_´Ùos
[
hash
];

184 
´Ù
 !ğ
NULL
) {

185 
š‘_´ÙocŞ
 *
Ãxt
;

187 
Ãxt
 = (
š‘_´ÙocŞ
 *è
´Ù
->
Ãxt
;

190 ià(
h
->
´ÙocŞ
 =ğ
´Ù
->´ÙocŞ && iµrÙ->
”r_hªdËr
) {

191 
´Ù
->
	`”r_hªdËr
(
”r
, (*)(
icmph
 + 1),

192 
h
->
daddr
, iph->
§ddr
, 
´Ù
);

195 
´Ù
 = 
Ãxt
;

197 
skb
->
sk
 = 
NULL
;

198 
	`kä“_skb
(
skb
, 
FREE_READ
);

199 
	}
}

204 
	$icmp_»dœeù
(
icmphdr
 *
icmph
, 
sk_buff
 *
skb
, 
deviû
 *
dev
)

206 
hdr
 *
h
;

207 

;

209 
h
 = (
hdr
 *è(
icmph
 + 1);

210 

 = 
h
->
daddr
;

211 
icmph
->
code
 & 7) {

212 
ICMP_REDIR_NET
:

213 #ifdeà
nÙ_a_good_id—


214 
	`¹_add
((
RTF_DYNAMIC
 | 
RTF_MODIFIED
 | 
RTF_GATEWAY
),

215 

, 0, 
icmph
->
un
.
g©eway
, 
dev
);

218 
ICMP_REDIR_HOST
:

219 
	`¹_add
((
RTF_DYNAMIC
 | 
RTF_MODIFIED
 | 
RTF_HOST
 | 
RTF_GATEWAY
),

220 

, 0, 
icmph
->
un
.
g©eway
, 
dev
);

222 
ICMP_REDIR_NETTOS
:

223 
ICMP_REDIR_HOSTTOS
:

224 
	`´štk
("ICMP: cannot handle TOS„edirects yet!\n");

227 
	`DPRINTF
((
DBG_ICMP
, "ICMP: Unreach: CODE=%d\n",

228 (
icmph
->
code
 & 7)));

231 
skb
->
sk
 = 
NULL
;

232 
	`kä“_skb
(
skb
, 
FREE_READ
);

233 
	}
}

238 
	$icmp_echo
(
icmphdr
 *
icmph
, 
sk_buff
 *
skb
, 
deviû
 *
dev
,

239 
§ddr
, 
daddr
, 
Ën
,

240 
İtiÚs
 *
İt
)

242 
icmphdr
 *
icmphr
;

243 
sk_buff
 *
skb2
;

244 
size
, 
off£t
;

246 
size
 = (
sk_buff
è+ 
dev
->
h¬d_h—d”_Ën
 + 64 + 
Ën
;

247 
skb2
 = 
	`®loc_skb
(
size
, 
GFP_ATOMIC
);

248 ià(
skb2
 =ğ
NULL
) {

249 
skb
->
sk
 = 
NULL
;

250 
	`kä“_skb
(
skb
, 
FREE_READ
);

253 
skb2
->
sk
 = 
NULL
;

254 
skb2
->
mem_addr
 = skb2;

255 
skb2
->
mem_Ën
 = 
size
;

256 
skb2
->
ä“
 = 1;

259 
off£t
 = 
	`_bud_h—d”
(
skb2
, 
daddr
, 
§ddr
, &
dev
,

260 
IPPROTO_ICMP
, 
İt
, 
Ën
, 
skb
->
_hdr
->
tos
,255);

261 ià(
off£t
 < 0) {

262 
	`´štk
("ICMP: Could‚ot build IP Header for ICMP ECHO Response\n");

263 
	`kä“_skb
(
skb2
,
FREE_WRITE
);

264 
skb
->
sk
 = 
NULL
;

265 
	`kä“_skb
(
skb
, 
FREE_READ
);

270 
skb2
->
Ën
 = 
off£t
 +†en;

273 
icmphr
 = (
icmphdr
 *è(
skb2
->
d©a
 + 
off£t
);

274 
	`memıy
((*è
icmphr
, (*è
icmph
, 
Ën
);

275 
icmphr
->
ty³
 = 
ICMP_ECHOREPLY
;

276 
icmphr
->
code
 = 0;

277 
icmphr
->
checksum
 = 0;

278 
icmphr
->
checksum
 = 
	`_compu‹_csum
((*)icmphr, 
Ën
);

281 
	`_queue_xm™
((
sock
 *)
NULL
, 
dev
, 
skb2
, 1);

283 
skb
->
sk
 = 
NULL
;

284 
	`kä“_skb
(
skb
, 
FREE_READ
);

285 
	}
}

290 
	$icmp_šfo
(
icmphdr
 *
icmph
, 
sk_buff
 *
skb
, 
deviû
 *
dev
,

291 
§ddr
, 
daddr
, 
Ën
,

292 
İtiÚs
 *
İt
)

295 
skb
->
sk
 = 
NULL
;

296 
	`kä“_skb
(
skb
, 
FREE_READ
);

297 
	}
}

302 
	$icmp_add»ss
(
icmphdr
 *
icmph
, 
sk_buff
 *
skb
, 
deviû
 *
dev
,

303 
§ddr
, 
daddr
, 
Ën
,

304 
İtiÚs
 *
İt
)

306 
icmphdr
 *
icmphr
;

307 
sk_buff
 *
skb2
;

308 
size
, 
off£t
;

310 
size
 = (
sk_buff
è+ 
dev
->
h¬d_h—d”_Ën
 + 64 + 
Ën
;

311 
skb2
 = 
	`®loc_skb
(
size
, 
GFP_ATOMIC
);

312 ià(
skb2
 =ğ
NULL
) {

313 
skb
->
sk
 = 
NULL
;

314 
	`kä“_skb
(
skb
, 
FREE_READ
);

317 
skb2
->
sk
 = 
NULL
;

318 
skb2
->
mem_addr
 = skb2;

319 
skb2
->
mem_Ën
 = 
size
;

320 
skb2
->
ä“
 = 1;

323 
off£t
 = 
	`_bud_h—d”
(
skb2
, 
daddr
, 
§ddr
, &
dev
,

324 
IPPROTO_ICMP
, 
İt
, 
Ën
, 
skb
->
_hdr
->
tos
,255);

325 ià(
off£t
 < 0) {

326 
	`´štk
("ICMP: Could‚ot build IP Header for ICMP ADDRESS Response\n");

327 
	`kä“_skb
(
skb2
,
FREE_WRITE
);

328 
skb
->
sk
 = 
NULL
;

329 
	`kä“_skb
(
skb
, 
FREE_READ
);

334 
skb2
->
Ën
 = 
off£t
 +†en;

337 
icmphr
 = (
icmphdr
 *è(
skb2
->
d©a
 + 
off£t
);

338 
icmphr
->
ty³
 = 
ICMP_ADDRESSREPLY
;

339 
icmphr
->
code
 = 0;

340 
icmphr
->
checksum
 = 0;

341 
icmphr
->
un
.
echo
.
id
 = 
icmph
->un.echo.id;

342 
icmphr
->
un
.
echo
.
£qu’û
 = 
icmph
->un.echo.sequence;

343 
	`memıy
((*è(
icmphr
 + 1), (*è&
dev
->
·_mask
, (dev->pa_mask));

345 
icmphr
->
checksum
 = 
	`_compu‹_csum
((*)icmphr, 
Ën
);

348 
	`_queue_xm™
((
sock
 *)
NULL
, 
dev
, 
skb2
, 1);

350 
skb
->
sk
 = 
NULL
;

351 
	`kä“_skb
(
skb
, 
FREE_READ
);

352 
	}
}

357 
	$icmp_rcv
(
sk_buff
 *
skb1
, 
deviû
 *
dev
, 
İtiÚs
 *
İt
,

358 
daddr
, 
Ën
,

359 
§ddr
, 
»do
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

361 
icmphdr
 *
icmph
;

362 *
buff
;

365 ià(
	`chk_addr
(
daddr
è=ğ
IS_BROADCAST
) {

366 
	`DPRINTF
((
DBG_ICMP
, "ICMP: Discarded broadcast from %s\n",

367 
	`š_Áß
(
§ddr
)));

368 
skb1
->
sk
 = 
NULL
;

369 
	`kä“_skb
(
skb1
, 
FREE_READ
);

373 
buff
 = 
skb1
->
h
.
¿w
;

374 
icmph
 = (
icmphdr
 *è
buff
;

377 ià(
	`_compu‹_csum
((*è
icmph
, 
Ën
)) {

379 
	`´štk
("ICMP: faed checksum from %s!\n", 
	`š_Áß
(
§ddr
));

380 
skb1
->
sk
 = 
NULL
;

381 
	`kä“_skb
(
skb1
, 
FREE_READ
);

384 
	`´št_icmp
(
icmph
);

387 
icmph
->
ty³
) {

388 
ICMP_TIME_EXCEEDED
:

389 
ICMP_DEST_UNREACH
:

390 
ICMP_SOURCE_QUENCH
:

391 
	`icmp_uÄ—ch
(
icmph
, 
skb1
);

393 
ICMP_REDIRECT
:

394 
	`icmp_»dœeù
(
icmph
, 
skb1
, 
dev
);

396 
ICMP_ECHO
:

397 
	`icmp_echo
(
icmph
, 
skb1
, 
dev
, 
§ddr
, 
daddr
, 
Ën
, 
İt
);

399 
ICMP_ECHOREPLY
:

400 
skb1
->
sk
 = 
NULL
;

401 
	`kä“_skb
(
skb1
, 
FREE_READ
);

403 
ICMP_INFO_REQUEST
:

404 
	`icmp_šfo
(
icmph
, 
skb1
, 
dev
, 
§ddr
, 
daddr
, 
Ën
, 
İt
);

406 
ICMP_INFO_REPLY
:

407 
skb1
->
sk
 = 
NULL
;

408 
	`kä“_skb
(
skb1
, 
FREE_READ
);

410 
ICMP_ADDRESS
:

411 
	`icmp_add»ss
(
icmph
, 
skb1
, 
dev
, 
§ddr
, 
daddr
, 
Ën
, 
İt
);

413 
ICMP_ADDRESSREPLY
:

414 
skb1
->
sk
 = 
NULL
;

415 
	`kä“_skb
(
skb1
, 
FREE_READ
);

418 
	`DPRINTF
((
DBG_ICMP
,

420 
	`š_Áß
(
§ddr
), 
icmph
->
ty³
));

421 
skb1
->
sk
 = 
NULL
;

422 
	`kä“_skb
(
skb1
, 
FREE_READ
);

426 
skb1
->
sk
 = 
NULL
;

427 
	`kä“_skb
(
skb1
, 
FREE_READ
);

429 
	}
}

434 
	$icmp_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
)

436 
cmd
) {

437 
DDIOCSDBG
:

438 (
	`dbg_ioùl
((*è
¬g
, 
DBG_ICMP
));

440 (-
EINVAL
);

443 
	}
}

	@net/inet/icmp.h

18 #iâdeà
_ICMP_H


19 
	#_ICMP_H


	)

21 
	~<lšux/icmp.h
>

24 
icmp_”r
 
icmp_”r_cÚv”t
[];

26 
icmp_£nd
(
sk_buff
 *
skb_š
, 
ty³
, 
code
,

27 
deviû
 *
dev
);

28 
icmp_rcv
(
sk_buff
 *
skb1
, 
deviû
 *
dev
,

29 
İtiÚs
 *
İt
, 
daddr
,

30 
Ën
, 
§ddr
,

31 
»do
, 
š‘_´ÙocŞ
 *
´ÙocŞ
);

33 
icmp_ioùl
(
sock
 *
sk
, 
cmd
,

34 
¬g
);

	@net/inet/inet.h

48 #iâdeà
_INET_H


49 
	#_INET_H


	)

52 
	~<lšux/ddi.h
>

55 
	#NET16
(
x
è((((xè>> 8è& 0x00FFè| (((xè<< 8è& 0xFF00))

	)

58 #undeà
INET_DEBUG


59 #ifdef 
INET_DEBUG


60 
	#DPRINTF
(
x
è
d´štf
 
	)
x

62 
	#DPRINTF
(
x
èdØ; 0)

	)

66 
	#DBG_OFF
 0

	)

67 
	#DBG_INET
 1

	)

68 
	#DBG_RT
 2

	)

69 
	#DBG_DEV
 3

	)

70 
	#DBG_ETH
 4

	)

71 
	#DBG_PROTO
 5

	)

72 
	#DBG_TMR
 6

	)

73 
	#DBG_PKT
 7

	)

74 
	#DBG_RAW
 8

	)

76 
	#DBG_LOOPB
 10

	)

77 
	#DBG_SLIP
 11

	)

79 
	#DBG_ARP
 20

	)

80 
	#DBG_IP
 21

	)

81 
	#DBG_ICMP
 22

	)

82 
	#DBG_TCP
 23

	)

83 
	#DBG_UDP
 24

	)

86 
š‘_debug
;

89 
š‘_´Ùo_š™
(
ddi_´Ùo
 *
´o
);

90 *
š_Áß
(
š
);

91 
š_©Ú
(*
¡r
);

93 
d´štf
(
Ëv–
, *
fmt
, ...);

95 
dbg_ioùl
(*
¬g
, 
Ëv–
);

	@net/inet/ip.c

53 
	~<asm/£gm’t.h
>

54 
	~<asm/sy¡em.h
>

55 
	~<lšux/ty³s.h
>

56 
	~<lšux/k”Ãl.h
>

57 
	~<lšux/sched.h
>

58 
	~<lšux/¡ršg.h
>

59 
	~<lšux/”ºo.h
>

60 
	~<lšux/sock‘.h
>

61 
	~<lšux/sockios.h
>

62 
	~<lšux/š.h
>

63 
	~"š‘.h
"

64 
	~"dev.h
"

65 
	~"‘h.h
"

66 
	~".h
"

67 
	~"´ÙocŞ.h
"

68 
	~"rou‹.h
"

69 
	~"tı.h
"

70 
	~"skbuff.h
"

71 
	~"sock.h
"

72 
	~"¬p.h
"

73 
	~"icmp.h
"

75 
	#CONFIG_IP_FORWARD


	)

76 
	#CONFIG_IP_DEFRAG


	)

78 
Ï¡_»Œª
;

79 
sÜt_£nd
(
sock
 *
sk
);

81 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

84 
	$_´št
(
hdr
 *

)

86 
buff
[32];

87 *
±r
;

88 
addr
, 
Ën
, 
i
;

90 ià(
š‘_debug
 !ğ
DBG_IP
) ;

93 
	`´štk
("IP: ihl=%d, version=%d,os=%d,ot_len=%d\n",

94 

->
ihl
, ip->
v”siÚ
, ip->
tos
, 
	`Áohs
(->
tÙ_Ën
));

95 
	`´štk
(" id=%X,tl=%d,…rot=%d, check=%X\n",

96 

->
id
, ip->
‰l
, ip->
´ÙocŞ
, ip->
check
);

97 
	`´štk
(" f¿g_off=%d\n", 

->
äag_off
);

98 
	`´štk
(" souüe=% ", 
	`š_Áß
(

->
§ddr
));

99 
	`´štk
("de¡=%s\n", 
	`š_Áß
(

->
daddr
));

100 
	`´štk
(" ----\n");

103 
±r
 = (*)(

 + 1);

104 
addr
 = 0;

105 
Ën
 = 
	`Áohs
(

->
tÙ_Ën
è- (4 * ip->
ihl
);

106 
Ën
 > 0) {

107 
	`´štk
(" %04X: ", 
addr
);

108 
i
 = 0; i < 16; i++) {

109 ià(
Ën
 > 0) {

110 
	`´štk
("%02X ", (*
±r
 & 0xFF));

111 
buff
[
i
] = *
±r
++;

112 ià(
buff
[
i
] < 32 || buff[i] > 126) buff[i] = '.';

114 
	`´štk
(" ");

115 
buff
[
i
] = ' ';

117 
addr
++;

118 
Ën
--;

120 
buff
[
i
] = '\0';

121 
	`´štk
(" \"%s\"\n", 
buff
);

123 
	`´štk
(" ----\n\n");

124 
	}
}

128 
	$_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
)

130 
cmd
) {

131 
DDIOCSDBG
:

132 (
	`dbg_ioùl
((*è
¬g
, 
DBG_IP
));

134 (-
EINVAL
);

136 
	}
}

141 
	$¡riù_rou‹
(
hdr
 *
h
, 
İtiÚs
 *
İt
)

143 
	}
}

147 
	$loo£_rou‹
(
hdr
 *
h
, 
İtiÚs
 *
İt
)

149 
	}
}

153 
	$´št_´Ù
(
š‘_´ÙocŞ
 *
´Ù
)

155 
	`DPRINTF
((
DBG_IP
, "handler = %X,…rotocol = %d, copy=%d \n",

156 
´Ù
->
hªdËr
, iµrÙ->
´ÙocŞ
, iµrÙ->
cİy
));

157 
	}
}

162 
	$_rou‹_check
(
daddr
)

164 
	}
}

170 
	$bud_İtiÚs
(
hdr
 *
h
, 
İtiÚs
 *
İt
)

172 *
±r
;

174 
±r
 = (*)(
h
+1);

175 *
±r
 = 0;

177 
	}
}

183 
	$_£nd
(
sk_buff
 *
skb
, 
daddr
, 
Ën
, 
deviû
 *
dev
,

184 
§ddr
)

186 *
±r
;

187 
mac
;

189 
±r
 = 
skb
->
d©a
;

190 
mac
 = 0;

191 
skb
->
¬p
 = 1;

192 ià(
dev
->
h¬d_h—d”
) {

193 
mac
 = 
dev
->
	`h¬d_h—d”
(
±r
, dev, 
ETH_P_IP
, 
daddr
, 
§ddr
, 
Ën
);

195 ià(
mac
 < 0) {

196 
mac
 = -mac;

197 
skb
->
¬p
 = 0;

199 
skb
->
dev
 = dev;

200 (
mac
);

201 
	}
}

211 
	$_bud_h—d”
(
sk_buff
 *
skb
, 
§ddr
, 
daddr
,

212 
deviû
 **
dev
, 
ty³
, 
İtiÚs
 *
İt
, 
Ën
, 
tos
, 
‰l
)

214 
İtiÚs
 
İtmem
;

215 
hdr
 *
h
;

216 
¹abË
 *
¹
;

217 *
buff
;

218 
¿ddr
;

219 
couÁ
 = 0;

220 
tmp
;

222 ià(
§ddr
 == 0)

223 
§ddr
 = 
	`my_addr
();

225 
	`DPRINTF
((
DBG_IP
, "ip_build_header (skb=%X, saddr=%X, daddr=%X, *dev=%X,\n"

227 
skb
, 
§ddr
, 
daddr
, *
dev
, 
ty³
, 
İt
, 
Ën
));

229 
buff
 = 
skb
->
d©a
;

232 ià(*
dev
 =ğ
NULL
) {

233 
¹
 = 
	`¹_rou‹
(
daddr
, &
İtmem
);

234 ià(
¹
 =ğ
NULL
)

235 (-
ENETUNREACH
);

237 *
dev
 = 
¹
->
¹_dev
;

238 ià(
§ddr
 =ğ0x0100007FL && 
daddr
 != 0x0100007FL)

239 
§ddr
 = 
¹
->
¹_dev
->
·_addr
;

240 
¿ddr
 = 
¹
->
¹_g©eway
;

242 
	`DPRINTF
((
DBG_IP
, "_bud_h—d”: sadd¸£ˆtØ%s\n", 
	`š_Áß
(
§ddr
)));

243 
İt
 = &
İtmem
;

246 
¹
 = 
	`¹_rou‹
(
daddr
, &
İtmem
);

247 
¿ddr
 = (
¹
 =ğ
NULL
è? 0 :„t->
¹_g©eway
;

249 ià(
¿ddr
 == 0)

250 
¿ddr
 = 
daddr
;

253 
tmp
 = 
	`_£nd
(
skb
, 
¿ddr
, 
Ën
, *
dev
, 
§ddr
);

254 
buff
 +ğ
tmp
;

255 
Ën
 -ğ
tmp
;

257 
skb
->
dev
 = *dev;

258 
skb
->
§ddr
 = saddr;

259 ià(
skb
->
sk
èskb->sk->
§ddr
 = saddr;

266 if(
ty³
 =ğ
IPPROTO_RAW
è (
tmp
);

268 
h
 = (
hdr
 *)
buff
;

269 
h
->
v”siÚ
 = 4;

270 
h
->
tos
 =os;

271 
h
->
äag_off
 = 0;

272 
h
->
‰l
 =tl;

273 
h
->
daddr
 = daddr;

274 
h
->
§ddr
 = saddr;

275 
h
->
´ÙocŞ
 = 
ty³
;

276 
h
->
ihl
 = 5;

277 
h
->
id
 = 
	`htÚs
(
couÁ
++);

280 #ifdeà
NÙ_Y‘_Ava


281 
	`bud_İtiÚs
(
h
, 
İt
);

284 (20 + 
tmp
);

285 
	}
}

289 
	$do_İtiÚs
(
hdr
 *
h
, 
İtiÚs
 *
İt
)

291 *
buff
;

292 
dÚe
 = 0;

293 
i
, 
Ën
 = (
hdr
);

296 
İt
->
»cÜd_rou‹
.
rou‹_size
 = 0;

297 
İt
->
loo£_rou‹
.
rou‹_size
 = 0;

298 
İt
->
¡riù_rou‹
.
rou‹_size
 = 0;

299 
İt
->
t¡amp
.
±r
 = 0;

300 
İt
->
£cur™y
 = 0;

301 
İt
->
com·¹m’t
 = 0;

302 
İt
->
hªdlšg
 = 0;

303 
İt
->
¡»am
 = 0;

304 
İt
->
tcc
 = 0;

308 
buff
 = (*)(
h
 + 1);

311 !
dÚe
 && 
Ën
 < 
h
->
ihl
*4è*
buff
) {

312 
IPOPT_END
:

313 
dÚe
 = 1;

315 
IPOPT_NOOP
:

316 
buff
++;

317 
Ën
++;

319 
IPOPT_SEC
:

320 
buff
++;

321 ià(*
buff
 != 11) (1);

322 
buff
++;

323 
İt
->
£cur™y
 = 
	`Áohs
(*(*)
buff
);

324 
buff
 += 2;

325 
İt
->
com·¹m’t
 = 
	`Áohs
(*(*)
buff
);

326 
buff
 += 2;

327 
İt
->
hªdlšg
 = 
	`Áohs
(*(*)
buff
);

328 
buff
 += 2;

329 
İt
->
tcc
 = ((*
buff
è<< 16è+ 
	`Áohs
(*(*)(buff+1));

330 
buff
 += 3;

331 
Ën
 += 11;

333 
IPOPT_LSRR
:

334 
buff
++;

335 ià((*
buff
 - 3)% 4 != 0) (1);

336 
Ën
 +ğ*
buff
;

337 
İt
->
loo£_rou‹
.
rou‹_size
 = (*
buff
 -3)/4;

338 
buff
++;

339 ià(*
buff
 % 4 != 0) (1);

340 
İt
->
loo£_rou‹
.
poš‹r
 = *
buff
/4 - 1;

341 
buff
++;

342 
buff
++;

343 
i
 = 0; i < 
İt
->
loo£_rou‹
.
rou‹_size
; i++) {

344 if(
i
>=
MAX_ROUTE
)

346 
İt
->
loo£_rou‹
.
rou‹
[
i
] = *(*)
buff
;

347 
buff
 += 4;

350 
IPOPT_SSRR
:

351 
buff
++;

352 ià((*
buff
 - 3)% 4 != 0) (1);

353 
Ën
 +ğ*
buff
;

354 
İt
->
¡riù_rou‹
.
rou‹_size
 = (*
buff
 -3)/4;

355 
buff
++;

356 ià(*
buff
 % 4 != 0) (1);

357 
İt
->
¡riù_rou‹
.
poš‹r
 = *
buff
/4 - 1;

358 
buff
++;

359 
buff
++;

360 
i
 = 0; i < 
İt
->
¡riù_rou‹
.
rou‹_size
; i++) {

361 if(
i
>=
MAX_ROUTE
)

363 
İt
->
¡riù_rou‹
.
rou‹
[
i
] = *(*)
buff
;

364 
buff
 += 4;

367 
IPOPT_RR
:

368 
buff
++;

369 ià((*
buff
 - 3)% 4 != 0) (1);

370 
Ën
 +ğ*
buff
;

371 
İt
->
»cÜd_rou‹
.
rou‹_size
 = (*
buff
 -3)/4;

372 
buff
++;

373 ià(*
buff
 % 4 != 0) (1);

374 
İt
->
»cÜd_rou‹
.
poš‹r
 = *
buff
/4 - 1;

375 
buff
++;

376 
buff
++;

377 
i
 = 0; i < 
İt
->
»cÜd_rou‹
.
rou‹_size
; i++) {

378 if(
i
>=
MAX_ROUTE
)

380 
İt
->
»cÜd_rou‹
.
rou‹
[
i
] = *(*)
buff
;

381 
buff
 += 4;

384 
IPOPT_SID
:

385 
Ën
 += 4;

386 
buff
 +=2;

387 
İt
->
¡»am
 = *(*)
buff
;

388 
buff
 += 2;

390 
IPOPT_TIMESTAMP
:

391 
buff
++;

392 
Ën
 +ğ*
buff
;

393 ià(*
buff
 % 4 != 0) (1);

394 
İt
->
t¡amp
.
Ën
 = *
buff
 / 4 - 1;

395 
buff
++;

396 ià((*
buff
 - 1) % 4 != 0) (1);

397 
İt
->
t¡amp
.
±r
 = (*
buff
-1)/4;

398 
buff
++;

399 
İt
->
t¡amp
.
x
.
fuÎ_ch¬
 = *
buff
;

400 
buff
++;

401 
i
 = 0; i < 
İt
->
t¡amp
.
Ën
; i++) {

402 
İt
->
t¡amp
.
d©a
[
i
] = *(*)
buff
;

403 
buff
 += 4;

410 ià(
İt
->
»cÜd_rou‹
.
rou‹_size
 == 0) {

411 ià(
İt
->
¡riù_rou‹
.
rou‹_size
 != 0) {

412 
	`memıy
(&(
İt
->
»cÜd_rou‹
), &(İt->
¡riù_rou‹
),

413 (
İt
->
»cÜd_rou‹
));

414 } ià(
İt
->
loo£_rou‹
.
rou‹_size
 != 0) {

415 
	`memıy
(&(
İt
->
»cÜd_rou‹
), &(İt->
loo£_rou‹
),

416 (
İt
->
»cÜd_rou‹
));

420 ià(
İt
->
¡riù_rou‹
.
rou‹_size
 != 0 &&

421 
İt
->
¡riù_rou‹
.
rou‹_size
 !ğİt->¡riù_rou‹.
poš‹r
) {

422 
	`¡riù_rou‹
(
h
, 
İt
);

426 ià(
İt
->
loo£_rou‹
.
rou‹_size
 != 0 &&

427 
İt
->
loo£_rou‹
.
rou‹_size
 !ğİt->loo£_rou‹.
poš‹r
) {

428 
	`loo£_rou‹
(
h
, 
İt
);

433 
	}
}

437 
šlše
 

438 
	$_ç¡_csum
(* 
buff
, 
wËn
)

440 
sum
 = 0;

442 ià(
wËn
) {

443 
bogus
;

444 
	`__asm__
("clc\n"

455 : "ô" (
sum
), "=S" (
buff
), "ô" (
wËn
), "÷" (
bogus
)

456 : "0" (
sum
), "1" (
buff
), "2" (
wËn
));

458  (~
sum
) & 0xffff;

459 
	}
}

466 
	$_compu‹_csum
(* 
buff
, 
Ën
)

468 
sum
 = 0;

471 ià(
Ën
 > 3) {

472 
	`__asm__
("clc\n"

482 : "=b" (
sum
è, "=S" (
buff
)

483 : "0" (
sum
), "c" (
Ën
 >> 2è,"1" (
buff
)

486 ià(
Ën
 & 2) {

487 
	`__asm__
("lodsw\n\t"

490 : "=b" (
sum
), "=S" (
buff
)

491 : "0" (
sum
), "1" (
buff
)

494 ià(
Ën
 & 1) {

495 
	`__asm__
("lodsb\n\t"

499 : "=b" (
sum
), "=S" (
buff
)

500 : "0" (
sum
), "1" (
buff
)

503 
sum
 =~sum;

504 (
sum
 & 0xffff);

505 
	}
}

509 
	$_csum
(
hdr
 *
h
)

511  
	`_ç¡_csum
((*)
h
, iph->
ihl
);

512 
	}
}

516 
	$_£nd_check
(
hdr
 *
h
)

518 
h
->
check
 = 0;

519 
h
->
check
 = 
	`_ç¡_csum
((*)h, iph->
ihl
);

520 
	}
}

524 
q
 *
	gqueue
 = 
NULL
;

526 
äag
 *
	$_äag_ü—‹
(
off£t
, 
’d
, 
sk_buff
 *
skb
, *
±r
)

528 
äag
 *
å
;

530 
å
 = (
äag
 *è
	`km®loc
((äag), 
GFP_ATOMIC
);

531 ià(
å
 =ğ
NULL
)

533 
	`´štk
("IP: frag_create:‚o memory†eft !\n");

534 (
NULL
);

536 
	`mem£t
(
å
, 0, (
äag
));

539 
å
->
off£t
 = offset;

540 
å
->
’d
 =ƒnd;

541 
å
->
Ën
 = 
’d
 - 
off£t
;

542 
å
->
skb
 = skb;

543 
å
->
±r
 =…tr;

545 (
å
);

546 
	}
}

553 
q
 *
	$_fšd
(
hdr
 *
h
)

555 
q
 *
qp
;

556 
q
 *
q¶a¡
;

558 
	`şi
();

559 
q¶a¡
 = 
NULL
;

560 
qp
 = 
queue
; q°!ğ
NULL
; 
q¶a¡
 = qp, q°ğqp->
Ãxt
)

562 ià(
h
->
id
=ğ
qp
->h->id && iph->
§ddr
 == qp->iph->saddr &&

563 
h
->
daddr
 =ğ
qp
->h->dadd¸&& iph->
´ÙocŞ
 == qp->iph->protocol)

565 
	`d–_tim”
(&
qp
->
tim”
);

566 
	`¡i
();

567 (
qp
);

570 
	`¡i
();

571 (
NULL
);

572 
	}
}

581 
	$_ä“
(
q
 *
qp
)

583 
äag
 *
å
;

584 
äag
 *
xp
;

588 
	`d–_tim”
(&
qp
->
tim”
);

591 
	`şi
();

592 ià(
qp
->
´ev
 =ğ
NULL
)

594 
queue
 = 
qp
->
Ãxt
;

595 ià(
queue
 !ğ
NULL
)

596 
queue
->
´ev
 = 
NULL
;

600 
qp
->
´ev
->
Ãxt
 = qp->next;

601 ià(
qp
->
Ãxt
 !ğ
NULL
)

602 
qp
->
Ãxt
->
´ev
 = qp->prev;

607 
å
 = 
qp
->
äagm’ts
;

608 
å
 !ğ
NULL
)

610 
xp
 = 
å
->
Ãxt
;

611 
	`IS_SKB
(
å
->
skb
);

612 
	`kä“_skb
(
å
->
skb
,
FREE_READ
);

613 
	`kä“_s
(
å
, (
äag
));

614 
å
 = 
xp
;

620 
	`kä“_s
(
qp
->
mac
, qp->
maş’
);

623 
	`kä“_s
(
qp
->
h
, qp->
ihËn
 + 8);

626 
	`kä“_s
(
qp
, (
q
));

628 
	`¡i
();

629 
	}
}

634 
	$_expœe
(
¬g
)

636 
q
 *
qp
;

638 
qp
 = (
q
 *)
¬g
;

639 
	`DPRINTF
((
DBG_IP
, "IP: queue_expœe: f¿gm’ˆqueu0x%Ximed out!\n", 
qp
));

643 
	`icmp_£nd
(
qp
->
h
->
_¤c
.
s_addr
, 
ICMP_TIME_EXCEEDED
,

644 
ICMP_EXC_FRAGTIME
, 
qp
->
h
);

646 if(
qp
->
äagm’ts
!=
NULL
)

647 
	`icmp_£nd
(
qp
->
äagm’ts
->
skb
,
ICMP_TIME_EXCEEDED
,

648 
ICMP_EXC_FRAGTIME
, 
qp
->
dev
);

651 
	`_ä“
(
qp
);

652 
	}
}

662 
q
 *
	$_ü—‹
(
sk_buff
 *
skb
, 
hdr
 *
h
, 
deviû
 *
dev
)

664 
q
 *
qp
;

665 
maş’
;

666 
ihËn
;

668 
qp
 = (
q
 *è
	`km®loc
((q), 
GFP_ATOMIC
);

669 ià(
qp
 =ğ
NULL
)

671 
	`´štk
("IP: create:‚o memory†eft !\n");

672 (
NULL
);

674 
	`mem£t
(
qp
, 0, (
q
));

677 
maş’
 = ((è
h
è- ((è
skb
->
d©a
);

678 
qp
->
mac
 = (*è
	`km®loc
(
maş’
, 
GFP_ATOMIC
);

679 ià(
qp
->
mac
 =ğ
NULL
)

681 
	`´štk
("IP: create:‚o memory†eft !\n");

682 
	`kä“_s
(
qp
, (
q
));

683 (
NULL
);

687 
ihËn
 = (
h
->
ihl
 * ());

688 
qp
->
h
 = (
hdr
 *è
	`km®loc
(
ihËn
 + 8, 
GFP_ATOMIC
);

689 ià(
qp
->
h
 =ğ
NULL
)

691 
	`´štk
("IP: create:‚o memory†eft !\n");

692 
	`kä“_s
(
qp
->
mac
, 
maş’
);

693 
	`kä“_s
(
qp
, (
q
));

694 (
NULL
);

698 
	`memıy
(
qp
->
mac
, 
skb
->
d©a
, 
maş’
);

699 
	`memıy
(
qp
->
h
, iph, 
ihËn
 + 8);

700 
qp
->
Ën
 = 0;

701 
qp
->
ihËn
 = ihlen;

702 
qp
->
maş’
 = maclen;

703 
qp
->
äagm’ts
 = 
NULL
;

704 
qp
->
dev
 = dev;

708 
qp
->
tim”
.
expœes
 = 
IP_FRAG_TIME
;

709 
qp
->
tim”
.
d©a
 = () qp;

710 
qp
->
tim”
.
funùiÚ
 = 
_expœe
;

711 
	`add_tim”
(&
qp
->
tim”
);

714 
qp
->
´ev
 = 
NULL
;

715 
	`şi
();

716 
qp
->
Ãxt
 = 
queue
;

717 ià(
qp
->
Ãxt
 !ğ
NULL
)

718 
qp
->
Ãxt
->
´ev
 = qp;

719 
queue
 = 
qp
;

720 
	`¡i
();

721 (
qp
);

722 
	}
}

726 
	$_dÚe
(
q
 *
qp
)

728 
äag
 *
å
;

729 
off£t
;

732 ià(
qp
->
Ën
 == 0)

736 
å
 = 
qp
->
äagm’ts
;

737 
off£t
 = 0;

738 
å
 !ğ
NULL
)

740 ià(
å
->
off£t
 > offset)

742 
off£t
 = 
å
->
’d
;

743 
å
 = fp->
Ãxt
;

748 
	}
}

752 
sk_buff
 *
	$_glue
(
q
 *
qp
)

754 
sk_buff
 *
skb
;

755 
hdr
 *
h
;

756 
äag
 *
å
;

757 *
±r
;

758 
couÁ
, 
Ën
;

761 
Ën
 = (
sk_buff
)+
qp
->
maş’
 + qp->
ihËn
 + qp->len;

762 ià((
skb
 = 
	`®loc_skb
(
Ën
,
GFP_ATOMIC
)è=ğ
NULL
)

764 
	`´štk
("IP: queue_glue:‚ØmemÜy fÜ gluešg queu0x%X\n", (è
qp
);

765 
	`_ä“
(
qp
);

766 (
NULL
);

770 
skb
->
Ën
 = (ËÀ- 
qp
->
maş’
);

771 
skb
->
h
.
¿w
 = skb->
d©a
;

772 
skb
->
ä“
 = 1;

775 
±r
 = (*è
skb
->
h
.
¿w
;

776 
	`memıy
(
±r
, ((*è
qp
->
mac
), qp->
maş’
);

778 
±r
 +ğ
qp
->
maş’
;

779 
	`memıy
(
±r
, ((*è
qp
->
h
), qp->
ihËn
);

781 
±r
 +ğ
qp
->
ihËn
;

782 
skb
->
h
.
¿w
 +ğ
qp
->
maş’
;

785 
couÁ
 = 0;

788 
å
 = 
qp
->
äagm’ts
;

789 
å
 !ğ
NULL
)

791 if(
couÁ
+
å
->
Ën
>
skb
->len)

793 
	`´štk
("Invalid fragment†ist: Fragment over size.\n");

794 
	`_ä“
(
qp
);

795 
	`kä“_skb
(
skb
,
FREE_WRITE
);

796  
NULL
;

799 
	`memıy
((
±r
 + 
å
->
off£t
), fp->±r, fp->
Ën
);

800 
couÁ
 +ğ
å
->
Ën
;

801 
å
 = fp->
Ãxt
;

805 
	`_ä“
(
qp
);

808 
h
 = 
skb
->
h
.iph;

809 
h
->
äag_off
 = 0;

810 
h
->
tÙ_Ën
 = 
	`htÚs
((h->
ihl
 * ()è+ 
couÁ
);

811 
skb
->
_hdr
 = 
h
;

812 (
skb
);

813 
	}
}

817 
sk_buff
 *
	$_deäag
(
hdr
 *
h
, 
sk_buff
 *
skb
, 
deviû
 *
dev
)

819 
äag
 *
´ev
, *
Ãxt
;

820 
äag
 *
tå
;

821 
q
 *
qp
;

822 
sk_buff
 *
skb2
;

823 *
±r
;

824 
æags
, 
off£t
;

825 
i
, 
ihl
, 
’d
;

828 
qp
 = 
	`_fšd
(
h
);

831 
off£t
 = 
	`Áohs
(
h
->
äag_off
);

832 
æags
 = 
off£t
 & ~
IP_OFFSET
;

833 
off£t
 &ğ
IP_OFFSET
;

834 ià(((
æags
 & 
IP_MF
è=ğ0è&& (
off£t
 == 0))

836 ià(
qp
 !ğ
NULL
)

837 
	`_ä“
(
qp
);

838 (
skb
);

840 
off£t
 <<= 3;

847 ià(
qp
 !ğ
NULL
)

849 
	`d–_tim”
(&
qp
->
tim”
);

850 
qp
->
tim”
.
expœes
 = 
IP_FRAG_TIME
;

851 
qp
->
tim”
.
d©a
 = () qp;

852 
qp
->
tim”
.
funùiÚ
 = 
_expœe
;

853 
	`add_tim”
(&
qp
->
tim”
);

857 ià((
qp
 = 
	`_ü—‹
(
skb
, 
h
, 
dev
)è=ğ
NULL
)

858 (
NULL
);

862 
ihl
 = (
h
->ihl * ());

863 
’d
 = 
off£t
 + 
	`Áohs
(
h
->
tÙ_Ën
è- 
ihl
;

866 
±r
 = 
skb
->
d©a
 + 
dev
->
h¬d_h—d”_Ën
 + 
ihl
;

869 ià((
æags
 & 
IP_MF
) == 0)

870 
qp
->
Ën
 = 
’d
;

877 
´ev
 = 
NULL
;

878 
Ãxt
 = 
qp
->
äagm’ts
;‚exˆ!ğ
NULL
;‚ext =‚ext->next)

880 ià(
Ãxt
->
off£t
 > offset)

882 
´ev
 = 
Ãxt
;

890 ià(
´ev
 !ğ
NULL
 && 
off£t
 <…»v->
’d
)

892 
i
 = 
´ev
->
’d
 - 
off£t
;

893 
off£t
 +ğ
i
;

894 
±r
 +ğ
i
;

895 
	`DPRINTF
((
DBG_IP
, "IP: deäag: fixed†ow ov”Ï°%d by‹s\n", 
i
));

903 ; 
Ãxt
 !ğ
NULL
;‚exˆğ
tå
)

905 
tå
 = 
Ãxt
->next;

906 ià(
Ãxt
->
off£t
 >ğ
’d
)

909 
i
 = 
’d
 - 
Ãxt
->
off£t
;

910 
Ãxt
->
Ën
 -ğ
i
;

911 
Ãxt
->
off£t
 +ğ
i
;

912 
Ãxt
->
±r
 +ğ
i
;

915 ià(
Ãxt
->
Ën
 <= 0)

917 
	`DPRINTF
((
DBG_IP
, "IP: defrag:„emoving frag 0x%X (len %d)\n",

918 
Ãxt
,‚ext->
Ën
));

919 ià(
Ãxt
->
´ev
 !ğ
NULL
)

920 
Ãxt
->
´ev
->next =‚ext->next;

922 
qp
->
äagm’ts
 = 
Ãxt
->next;

924 ià(
tå
->
Ãxt
 !ğ
NULL
)

925 
Ãxt
->Ãxt->
´ev
 =‚ext->prev;

927 
	`kä“_s
(
Ãxt
, (
äag
));

929 
	`DPRINTF
((
DBG_IP
, "IP: deäag: fixed high ov”Ï°%d by‹s\n", 
i
));

933 
tå
 = 
NULL
;

934 
tå
 = 
	`_äag_ü—‹
(
off£t
, 
’d
, 
skb
, 
±r
);

935 
tå
->
´ev
 =…rev;

936 
tå
->
Ãxt
 =‚ext;

937 ià(
´ev
 !ğ
NULL
)

938 
´ev
->
Ãxt
 = 
tå
;

940 
qp
->
äagm’ts
 = 
tå
;

942 ià(
Ãxt
 !ğ
NULL
)

943 
Ãxt
->
´ev
 = 
tå
;

951 ià(
	`_dÚe
(
qp
))

953 
skb2
 = 
	`_glue
(
qp
);

954 (
skb2
);

956 (
NULL
);

957 
	}
}

968 
	$_äagm’t
(
sock
 *
sk
, 
sk_buff
 *
skb
, 
deviû
 *
dev
, 
is_äag
)

970 
hdr
 *
h
;

971 *
¿w
;

972 *
±r
;

973 
sk_buff
 *
skb2
;

974 
Ëá
, 
mtu
, 
hËn
, 
Ën
;

975 
off£t
;

978 
¿w
 = 
skb
->
d©a
;

979 
h
 = (
hdr
 *è(
¿w
 + 
dev
->
h¬d_h—d”_Ën
);

981 
skb
->
_hdr
 = 
h
;

984 
hËn
 = (
h
->
ihl
 * ());

985 
Ëá
 = 
	`Áohs
(
h
->
tÙ_Ën
è- 
hËn
;

986 
hËn
 +ğ
dev
->
h¬d_h—d”_Ën
;

987 
mtu
 = (
dev
->mtu - 
hËn
);

988 
±r
 = (
¿w
 + 
hËn
);

990 
	`DPRINTF
((
DBG_IP
, "IP: Fragmentation Desired\n"));

991 
	`DPRINTF
((
DBG_IP
, " DEV=%s, MTU=%d, LEN=%d SRC=%s",

992 
dev
->
Çme
, dev->
mtu
, 
Ëá
, 
	`š_Áß
(
h
->
§ddr
)));

993 
	`DPRINTF
((
DBG_IP
, " DST=%s\n", 
	`š_Áß
(
h
->
daddr
)));

996 ià(
	`Áohs
(
h
->
äag_off
è& 
IP_DF
)

998 
	`DPRINTF
((
DBG_IP
, "IP: Fragmentation Desired, but DF set !\n"));

999 
	`DPRINTF
((
DBG_IP
, " DEV=%s, MTU=%d, LEN=%d SRC=%s",

1000 
dev
->
Çme
, dev->
mtu
, 
Ëá
, 
	`š_Áß
(
h
->
§ddr
)));

1001 
	`DPRINTF
((
DBG_IP
, " DST=%s\n", 
	`š_Áß
(
h
->
daddr
)));

1008 
	`icmp_£nd
(
skb
,
ICMP_DEST_UNREACH
, 
ICMP_FRAG_NEEDED
, 
dev
);

1013 ià(
is_äag
 & 2)

1014 
off£t
 = (
	`Áohs
(
h
->
äag_off
) & 0x1fff) << 3;

1016 
off£t
 = 0;

1017 
Ëá
 > 0)

1019 
Ën
 = 
Ëá
;

1020 #ifdeà
OLD


1021 ià(
Ën
+8 > 
mtu
)

1022 
Ën
 = (
dev
->
mtu
 - 
hËn
 - 8);

1023 ià((
Ëá
 - 
Ën
) >= 8)

1025 
Ën
 /= 8;

1026 
Ën
 *= 8;

1030 ià(
Ën
 > 
mtu
)

1031 
Ën
 = 
mtu
;

1034 ià(
Ën
 < 
Ëá
)

1036 
Ën
/=8;

1037 
Ën
*=8;

1040 
	`DPRINTF
((
DBG_IP
,"IP: frag: creating fragment of %d bytes (%dotal)\n",

1041 
Ën
,†’ + 
hËn
));

1044 ià((
skb2
 = 
	`®loc_skb
((
sk_buff
è+ 
Ën
 + 
hËn
,
GFP_ATOMIC
)è=ğ
NULL
)

1046 
	`´štk
("IP: frag:‚o memory for‚ew fragment!\n");

1049 
skb2
->
¬p
 = 
skb
->arp;

1050 
skb2
->
ä“
 = 
skb
->free;

1051 
skb2
->
Ën
 =†’ + 
hËn
;

1052 
skb2
->
h
.
¿w
=(*èskb2->
d©a
;

1054 ià(
sk
)

1055 
sk
->
wmem_®loc
 +ğ
skb2
->
mem_Ën
;

1058 
	`memıy
(
skb2
->
h
.
¿w
,„aw, 
hËn
);

1061 
	`memıy
(
skb2
->
h
.
¿w
 + 
hËn
, 
±r
, 
Ën
);

1062 
Ëá
 -ğ
Ën
;

1064 
skb2
->
h
.
¿w
+=
dev
->
h¬d_h—d”_Ën
;

1066 
h
 = (
hdr
 *)(
skb2
->
h
.
¿w
 );

1067 
h
->
äag_off
 = 
	`htÚs
((
off£t
 >> 3));

1070 ià(
Ëá
 > 0 || (
is_äag
 & 1))

1071 
h
->
äag_off
 |ğ
	`htÚs
(
IP_MF
);

1072 
±r
 +ğ
Ën
;

1073 
off£t
 +ğ
Ën
;

1077 
	`_queue_xm™
(
sk
, 
dev
, 
skb2
, 1);

1080 
	}
}

1084 #ifdeà
CONFIG_IP_FORWARD


1088 
	$_fÜw¬d
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
is_äag
)

1090 
deviû
 *
dev2
;

1091 
hdr
 *
h
;

1092 
sk_buff
 *
skb2
;

1093 
¹abË
 *
¹
;

1094 *
±r
;

1095 
¿ddr
;

1102 if(
dev
->
æags
&
IFF_PROMISC
)

1104 if(
	`memcmp
((*)&
skb
[1],
dev
->
dev_addr
,dev->
addr_Ën
))

1113 
h
 = 
skb
->
h
.iph;

1114 
h
->
‰l
--;

1115 ià(
h
->
‰l
 <= 0) {

1116 
	`DPRINTF
((
DBG_IP
, "\nIP: *** datagramƒxpired: TTL=0 (ignored) ***\n"));

1117 
	`DPRINTF
((
DBG_IP
, " SRC = %  ", 
	`š_Áß
(
h
->
§ddr
)));

1118 
	`DPRINTF
((
DBG_IP
, " DST = % (ignÜed)\n", 
	`š_Áß
(
h
->
daddr
)));

1121 
	`icmp_£nd
(
skb
, 
ICMP_TIME_EXCEEDED
, 
ICMP_EXC_TTL
, 
dev
);

1126 
	`_£nd_check
(
h
);

1132 
¹
 = 
	`¹_rou‹
(
h
->
daddr
, 
NULL
);

1133 ià(
¹
 =ğ
NULL
) {

1134 
	`DPRINTF
((
DBG_IP
, "\nIP: ***„outing (phase I) failed ***\n"));

1137 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_NET_UNREACH
, 
dev
);

1149 
¿ddr
 = 
¹
->
¹_g©eway
;

1150 ià(
¿ddr
 != 0) {

1151 
¹
 = 
	`¹_rou‹
(
¿ddr
, 
NULL
);

1152 ià(
¹
 =ğ
NULL
) {

1153 
	`DPRINTF
((
DBG_IP
, "\nIP: ***„outing (phase II) failed ***\n"));

1156 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_HOST_UNREACH
, 
dev
);

1159 ià(
¹
->
¹_g©eway
 !ğ0è
¿ddr
 =„t->rt_gateway;

1160 } 
¿ddr
 = 
h
->
daddr
;

1161 
dev2
 = 
¹
->
¹_dev
;

1164 ià(
dev
 =ğ
dev2
)

1170 
	`DPRINTF
((
DBG_IP
, "\nIP: *** fwd % -> ", 
	`š_Áß
(
h
->
§ddr
)));

1171 
	`DPRINTF
((
DBG_IP
, "%s (via %s), LEN=%d\n",

1172 
	`š_Áß
(
¿ddr
), 
dev2
->
Çme
, 
skb
->
Ën
));

1174 ià(
dev2
->
æags
 & 
IFF_UP
) {

1175 
skb2
 = (
sk_buff
 *è
	`®loc_skb
((sk_buff) +

1176 
dev2
->
h¬d_h—d”_Ën
 + 
skb
->
Ën
, 
GFP_ATOMIC
);

1177 ià(
skb2
 =ğ
NULL
) {

1178 
	`´štk
("\nIP: No memory‡vailable for IP forward\n");

1181 
±r
 = 
skb2
->
d©a
;

1182 
skb2
->
sk
 = 
NULL
;

1183 
skb2
->
ä“
 = 1;

1184 
skb2
->
Ën
 = 
skb
->ËÀ+ 
dev2
->
h¬d_h—d”_Ën
;

1185 
skb2
->
mem_addr
 = skb2;

1186 
skb2
->
mem_Ën
 = (
sk_buff
è+ skb2->
Ën
;

1187 
skb2
->
Ãxt
 = 
NULL
;

1188 
skb2
->
h
.
¿w
 = 
±r
;

1191 
	`memıy
(
±r
 + 
dev2
->
h¬d_h—d”_Ën
, 
skb
->
h
.
¿w
, skb->
Ën
);

1194 (è
	`_£nd
(
skb2
, 
¿ddr
, 
skb
->
Ën
, 
dev2
, dev2->
·_addr
);

1196 if(
skb2
->
Ën
 > 
dev2
->
mtu
)

1198 
	`_äagm’t
(
NULL
,
skb2
,
dev2
, 
is_äag
);

1199 
	`kä“_skb
(
skb2
,
FREE_WRITE
);

1202 
dev2
->
	`queue_xm™
(
skb2
, dev2, 
SOPRI_NORMAL
);

1204 
	}
}

1211 
	$_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
·ck‘_ty³
 *
±
)

1213 
hdr
 *
h
 = 
skb
->
h
.iph;

1214 
hash
;

1215 
æag
 = 0;

1216 
İts_p
 = 0;

1217 
š‘_´ÙocŞ
 *
´Ù
;

1218 
İtiÚs
 
İt
;

1220 
brd
;

1221 
is_äag
=0;

1223 
	`DPRINTF
((
DBG_IP
, "<<\n"));

1225 
skb
->
_hdr
 = 
h
;

1227 ià(
skb
->
Ën
<(
hdr
è|| 
h
->
ihl
<5 || iph->
v”siÚ
 !ğ4 || 
	`_ç¡_csum
((*)iph, iph->ihl) !=0) {

1228 
	`DPRINTF
((
DBG_IP
, "\nIP: *** datagramƒrror ***\n"));

1229 
	`DPRINTF
((
DBG_IP
, " SRC = %  ", 
	`š_Áß
(
h
->
§ddr
)));

1230 
	`DPRINTF
((
DBG_IP
, " DST = % (ignÜed)\n", 
	`š_Áß
(
h
->
daddr
)));

1231 
skb
->
sk
 = 
NULL
;

1232 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

1236 ià(
h
->
ihl
 != 5) {

1237 
	`_´št
(
h
);

1238 
	`mem£t
((*è&
İt
, 0, (opt));

1239 ià(
	`do_İtiÚs
(
h
, &
İt
) != 0)

1241 
İts_p
 = 1;

1244 ià(
h
->
äag_off
 & 0x0020)

1245 
is_äag
|=1;

1246 ià(
	`Áohs
(
h
->
äag_off
) & 0x1fff)

1247 
is_äag
|=2;

1250 ià((
brd
 = 
	`chk_addr
(
h
->
daddr
)) == 0) {

1251 #ifdeà
CONFIG_IP_FORWARD


1252 
	`_fÜw¬d
(
skb
, 
dev
, 
is_äag
);

1254 
	`´štk
("Machine %xriedo use us‡s‡ forwardero %x but we have forwarding disabled!\n",

1255 
h
->
§ddr
,h->
daddr
);

1257 
skb
->
sk
 = 
NULL
;

1258 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

1266 if(
is_äag
)

1268 #ifdeà
CONFIG_IP_DEFRAG


1269 
skb
=
	`_deäag
(
h
,skb,
dev
);

1270 if(
skb
==
NULL
)

1274 
h
=
skb
->
h
.iph;

1276 
	`´štk
("\nIP: *** datagram fragmentation‚ot yet implemented ***\n");

1277 
	`´štk
(" SRC = %  ", 
	`š_Áß
(
h
->
§ddr
));

1278 
	`´štk
(" DST = % (ignÜed)\n", 
	`š_Áß
(
h
->
daddr
));

1279 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_PROT_UNREACH
, 
dev
);

1280 
skb
->
sk
 = 
NULL
;

1281 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

1288 if(
brd
==
IS_INVBCAST
)

1292 
skb
->
sk
=
NULL
;

1293 
	`kä“_skb
(
skb
,
FREE_WRITE
);

1299 
skb
->
_hdr
 = 
h
;

1300 
skb
->
h
.
¿w
 +ğ
h
->
ihl
*4;

1301 
hash
 = 
h
->
´ÙocŞ
 & (
MAX_INET_PROTOS
 -1);

1302 
´Ù
 = (
š‘_´ÙocŞ
 *)
š‘_´Ùos
[
hash
];

1303 
´Ù
 !ğ
NULL
;

1304 
´Ù
=(
š‘_´ÙocŞ
 *)´Ù->
Ãxt
)

1306 
sk_buff
 *
skb2
;

1308 ià(
´Ù
->
´ÙocŞ
 !ğ
h
->protocol) ;

1309 
	`DPRINTF
((
DBG_IP
, "Usšg…rÙocŞ = %X:\n", 
´Ù
));

1310 
	`´št_´Ù
(
´Ù
);

1317 ià(
´Ù
->
cİy
) {

1318 
skb2
 = 
	`®loc_skb
(
skb
->
mem_Ën
, 
GFP_ATOMIC
);

1319 ià(
skb2
 =ğ
NULL
)

1321 
	`memıy
(
skb2
, 
skb
, skb->
mem_Ën
);

1322 
skb2
->
mem_addr
 = skb2;

1323 
skb2
->
_hdr
 = (
hdr
 *)(

1324 ()
skb2
 +

1325 (è
skb
->
_hdr
 -

1326 ()
skb
);

1327 
skb2
->
h
.
¿w
 = (*)(

1328 ()
skb2
 +

1329 (è
skb
->
h
.
¿w
 -

1330 ()
skb
);

1331 
skb2
->
ä“
=1;

1333 
skb2
 = 
skb
;

1335 
æag
 = 1;

1342 
´Ù
->
	`hªdËr
(
skb2
, 
dev
, 
İts_p
 ? &
İt
 : 0, 
h
->
daddr
,

1343 (
	`Áohs
(
h
->
tÙ_Ën
è- (h->
ihl
 * 4)),

1344 
h
->
§ddr
, 0, 
´Ù
);

1354 ià(!
æag
) {

1355 ià(
brd
 !ğ
IS_BROADCAST
)

1356 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_PROT_UNREACH
, 
dev
);

1357 
skb
->
sk
 = 
NULL
;

1358 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

1362 
	}
}

1373 
	$_queue_xm™
(
sock
 *
sk
, 
deviû
 *
dev
,

1374 
sk_buff
 *
skb
, 
ä“
)

1376 
hdr
 *
h
;

1377 *
±r
;

1379 ià(
sk
 =ğ
NULL
è
ä“
 = 1;

1380 ià(
dev
 =ğ
NULL
) {

1381 
	`´štk
("IP: ip_queue_xmit dev = NULL\n");

1384 
	`IS_SKB
(
skb
);

1385 
skb
->
ä“
 = free;

1386 
skb
->
dev
 = dev;

1387 
skb
->
wh’
 = 
jiff›s
;

1389 
	`DPRINTF
((
DBG_IP
, ">>\n"));

1390 
±r
 = 
skb
->
d©a
;

1391 
±r
 +ğ
dev
->
h¬d_h—d”_Ën
;

1392 
h
 = (
hdr
 *)
±r
;

1393 
skb
->
_hdr
 = 
h
;

1394 
h
->
tÙ_Ën
 = 
	`Áohs
(
skb
->
Ën
-
dev
->
h¬d_h—d”_Ën
);

1396 if(
skb
->
Ën
 > 
dev
->
mtu
)

1399 
	`_äagm’t
(
sk
,
skb
,
dev
,0);

1400 
	`IS_SKB
(
skb
);

1401 
	`kä“_skb
(
skb
,
FREE_WRITE
);

1405 
	`_£nd_check
(
h
);

1406 
	`_´št
(
h
);

1407 
skb
->
Ãxt
 = 
NULL
;

1410 
skb
->
magic
 = 1;

1411 ià(!
ä“
) {

1412 
skb
->
lšk3
 = 
NULL
;

1413 
sk
->
·ck‘s_out
++;

1414 
	`şi
();

1415 ià(
sk
->
£nd_h—d
 =ğ
NULL
) {

1416 
sk
->
£nd_
 = 
skb
;

1417 
sk
->
£nd_h—d
 = 
skb
;

1420 ià(
sk
->
£nd_
 =ğ
NULL
) {

1421 
	`´štk
("IP: ***bug sk->send_tail == NULL != sk->send_head\n");

1422 
	`sÜt_£nd
(
sk
);

1424 
sk
->
£nd_
->
lšk3
 = 
skb
;

1425 
sk
->
£nd_
 = 
skb
;

1428 
	`¡i
();

1429 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, sk->
¹o
);

1431 
skb
->
sk
 = sk;

1435 ià(
dev
->
æags
 & 
IFF_UP
) {

1436 ià(
sk
 !ğ
NULL
) {

1437 
dev
->
	`queue_xm™
(
skb
, dev, 
sk
->
´iÜ™y
);

1440 
dev
->
	`queue_xm™
(
skb
, dev, 
SOPRI_NORMAL
);

1443 ià(
ä“
è
	`kä“_skb
(
skb
, 
FREE_WRITE
);

1445 
	}
}

1449 
	$_do_»Œªsm™
(
sock
 *
sk
, 
®l
)

1451 
sk_buff
 * 
skb
;

1452 
´Ùo
 *
´Ù
;

1453 
deviû
 *
dev
;

1454 
»Œªsm™s
;

1456 
´Ù
 = 
sk
->prot;

1457 
skb
 = 
sk
->
£nd_h—d
;

1458 
»Œªsm™s
 = 
sk
->retransmits;

1459 
skb
 !ğ
NULL
) {

1460 
dev
 = 
skb
->dev;

1462 if(
dev
==
NULL
)

1464 
	`´štk
("ip_retransmit: NULL device bug!\n");

1465 
oİs
;

1468 
	`IS_SKB
(
skb
);

1475 
	`şi
();

1478 ià(!
skb
->
¬p
) {

1479 ià(
dev
->
	`»bud_h—d”
(
skb
->
d©a
, dev)) {

1480 
	`¡i
();

1481 ià(!
®l
) ;

1482 
skb
 = (
sk_buff
 *)skb->
lšk3
;

1486 
skb
->
¬p
 = 1;

1487 
	`¡i
();

1488 
skb
->
wh’
 = 
jiff›s
;

1491 ià(
dev
->
æags
 & 
IFF_UP
) {

1492 ià(
sk
 && !
	`skb_deviû_locked
(
skb
))

1493 
dev
->
	`queue_xm™
(
skb
, dev, 
sk
->
´iÜ™y
);

1497 
oİs
: 
»Œªsm™s
++;

1498 
sk
->
´Ù
->
»Œªsm™s
 ++;

1499 ià(!
®l
) ;

1502 ià(
sk
->
»Œªsm™s
 > sk->
cÚg_wšdow
) ;

1503 
skb
 = (
sk_buff
 *)skb->
lšk3
;

1505 
	}
}

1515 
	$_»Œªsm™
(
sock
 *
sk
, 
®l
)

1517 
	`_do_»Œªsm™
(
sk
, 
®l
);

1532 
sk
->
»Œªsm™s
++;

1533 
sk
->
backoff
++;

1534 
sk
->
¹o
 = 
	`mš
(sk->¹Ø<< 1, 120*
HZ
);

1535 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, sk->
¹o
);

1536 
	}
}

1543 
	$_£tsockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, 
İ’
)

1545 
v®
,
”r
;

1547 ià(
İtv®
 =ğ
NULL
)

1548 (-
EINVAL
);

1550 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
İtv®
, ());

1551 if(
”r
)

1552  
”r
;

1554 
v®
 = 
	`g‘_fs_lÚg
((*)
İtv®
);

1556 if(
Ëv–
!=
SOL_IP
)

1557  -
EOPNOTSUPP
;

1559 
İŠame
)

1561 
IP_TOS
:

1562 if(
v®
<0||val>255)

1563  -
EINVAL
;

1564 
sk
->
_tos
=
v®
;

1566 
IP_TTL
:

1567 if(
v®
<1||val>255)

1568  -
EINVAL
;

1569 
sk
->
_‰l
=
v®
;

1573 (-
ENOPROTOOPT
);

1575 
	}
}

1577 
	$_g‘sockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, *
İ’
)

1579 
v®
,
”r
;

1581 if(
Ëv–
!=
SOL_IP
)

1582  -
EOPNOTSUPP
;

1584 
İŠame
)

1586 
IP_TOS
:

1587 
v®
=
sk
->
_tos
;

1589 
IP_TTL
:

1590 
v®
=
sk
->
_‰l
;

1593 (-
ENOPROTOOPT
);

1595 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İ’
, ());

1596 if(
”r
)

1597  
”r
;

1598 
	`put_fs_lÚg
((),(*è
İ’
);

1600 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İtv®
, ());

1601 if(
”r
)

1602  
”r
;

1603 
	`put_fs_lÚg
(
v®
,(*)
İtv®
);

1606 
	}
}

	@net/inet/ip.h

18 #iâdeà
_IP_H


19 
	#_IP_H


	)

22 
	~<lšux/.h
>

25 
	~"sock.h
"

28 
	#IP_CE
 0x8000

	)

29 
	#IP_DF
 0x4000

	)

30 
	#IP_MF
 0x2000

	)

31 
	#IP_OFFSET
 0x1FFF

	)

33 
	#IP_FRAG_TIME
 (30 * 
HZ
è

	)

37 
	säag
 {

38 
	moff£t
;

39 
	m’d
;

40 
	mËn
;

41 
sk_buff
 *
	mskb
;

42 *
	m±r
;

43 
äag
 *
	mÃxt
;

44 
äag
 *
	m´ev
;

48 
	sq
 {

49 *
	mmac
;

50 
hdr
 *
	mh
;

51 
	mËn
;

52 
	mihËn
;

53 
	mmaş’
;

54 
tim”_li¡
 
	mtim”
;

55 
äag
 *
	mäagm’ts
;

56 
q
 *
	mÃxt
;

57 
q
 *
	m´ev
;

58 
deviû
 *
	mdev
;

62 
backoff
(
n
);

64 
_´št
(
hdr
 *

);

65 
_ioùl
(
sock
 *
sk
, 
cmd
,

66 
¬g
);

67 
_rou‹_check
(
daddr
);

68 
_bud_h—d”
(
sk_buff
 *
skb
,

69 
§ddr
,

70 
daddr
,

71 
deviû
 **
dev
, 
ty³
,

72 
İtiÚs
 *
İt
, 
Ën
,

73 
tos
,
‰l
);

74 
_compu‹_csum
(* 
buff
, 
Ën
);

75 
_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

76 
·ck‘_ty³
 *
±
);

77 
_queue_xm™
(
sock
 *
sk
,

78 
deviû
 *
dev
, 
sk_buff
 *
skb
,

79 
ä“
);

80 
_»Œªsm™
(
sock
 *
sk
, 
®l
);

81 
_do_»Œªsm™
(
sock
 *
sk
, 
®l
);

82 
_£tsockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, 
İ’
);

83 
_g‘sockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, *
İ’
);

	@net/inet/loopback.c

19 
	~<lšux/cÚfig.h
>

20 
	~<lšux/k”Ãl.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/ty³s.h
>

24 
	~<lšux/¡ršg.h
>

25 
	~<lšux/sock‘.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/fú.h
>

28 
	~<lšux/š.h
>

29 
	~<lšux/if_‘h”.h
>

31 
	~<asm/sy¡em.h
>

32 
	~<asm/£gm’t.h
>

33 
	~<asm/io.h
>

35 
	~"š‘.h
"

36 
	~"dev.h
"

37 
	~"‘h.h
"

38 
	~".h
"

39 
	~"´ÙocŞ.h
"

40 
	~"tı.h
"

41 
	~"skbuff.h
"

42 
	~"sock.h
"

43 
	~"¬p.h
"

47 
	$loİback_xm™
(
sk_buff
 *
skb
, 
deviû
 *
dev
)

49 
’‘_¡©i¡ics
 *
¡©s
 = (’‘_¡©i¡ic *)
dev
->
´iv
;

50 
dÚe
;

52 
	`DPRINTF
((
DBG_LOOPB
, "loİback_xm™(dev=%X, skb=%X)\n", 
dev
, 
skb
));

53 ià(
skb
 =ğ
NULL
 || 
dev
 == NULL) (0);

55 
	`şi
();

56 ià(
dev
->
tbusy
 != 0) {

57 
	`¡i
();

58 
¡©s
->
tx_”rÜs
++;

61 
dev
->
tbusy
 = 1;

62 
	`¡i
();

64 
dÚe
 = 
	`dev_ršt
(
skb
->
d©a
, skb->
Ën
, 0, 
dev
);

65 ià(
skb
->
ä“
è
	`kä“_skb
(skb, 
FREE_WRITE
);

67 
dÚe
 != 1) {

68 
dÚe
 = 
	`dev_ršt
(
NULL
, 0, 0, 
dev
);

70 
¡©s
->
tx_·ck‘s
++;

72 
dev
->
tbusy
 = 0;

75 
	`__asm__
("cmpl $0,_intr_count\n\t"

90 
	}
}

92 
’‘_¡©i¡ics
 *

93 
	$g‘_¡©s
(
deviû
 *
dev
)

95  (
’‘_¡©i¡ics
 *)
dev
->
´iv
;

96 
	}
}

100 
	$loİback_š™
(
deviû
 *
dev
)

102 
dev
->
mtu
 = 2000;

103 
dev
->
tbusy
 = 0;

104 
dev
->
h¬d_¡¬t_xm™
 = 
loİback_xm™
;

105 
dev
->
İ’
 = 
NULL
;

107 
dev
->
h¬d_h—d”
 = 
‘h_h—d”
;

108 
dev
->
add_¬p
 = 
NULL
;

109 
dev
->
h¬d_h—d”_Ën
 = 
ETH_HLEN
;

110 
dev
->
addr_Ën
 = 
ETH_ALEN
;

111 
dev
->
ty³
 = 
ARPHRD_ETHER
;

112 
dev
->
ty³_Œªs
 = 
‘h_ty³_Œªs
;

113 
dev
->
»bud_h—d”
 = 
‘h_»bud_h—d”
;

115 
dev
->
h¬d_h—d”_Ëngth
 = 0;

116 
dev
->
add_¬p
 = 
NULL
;

117 
dev
->
addr_Ën
 = 0;

118 
dev
->
ty³
 = 0;

119 
dev
->
h¬d_h—d”
 = 
NULL
;

120 
dev
->
ty³_Œªs
 = 
NULL
;

121 
dev
->
»bud_h—d”
 = 
NULL
;

123 
dev
->
queue_xm™
 = 
dev_queue_xm™
;

126 
dev
->
æags
 = 
IFF_LOOPBACK
;

127 
dev
->
çmy
 = 
AF_INET
;

128 
dev
->
·_addr
 = 
	`š_©Ú
("127.0.0.1");

129 
dev
->
·_brdaddr
 = 
	`š_©Ú
("127.255.255.255");

130 
dev
->
·_mask
 = 
	`š_©Ú
("255.0.0.0");

131 
dev
->
·_®’
 = ();

132 
dev
->
´iv
 = 
	`km®loc
((
’‘_¡©i¡ics
), 
GFP_KERNEL
);

133 
	`mem£t
(
dev
->
´iv
, 0, (
’‘_¡©i¡ics
));

134 
dev
->
g‘_¡©s
 = get_stats;

137 
	}
};

	@net/inet/packet.c

29 
	~<lšux/ty³s.h
>

30 
	~<lšux/sched.h
>

31 
	~<lšux/fú.h
>

32 
	~<lšux/sock‘.h
>

33 
	~<lšux/š.h
>

34 
	~"š‘.h
"

35 
	~"dev.h
"

36 
	~".h
"

37 
	~"´ÙocŞ.h
"

38 
	~"tı.h
"

39 
	~"skbuff.h
"

40 
	~"sock.h
"

41 
	~<lšux/”ºo.h
>

42 
	~<lšux/tim”.h
>

43 
	~<asm/sy¡em.h
>

44 
	~<asm/£gm’t.h
>

45 
	~"udp.h
"

46 
	~"¿w.h
"

50 
	$mš
(
a
, 
b
)

52 ià(
a
 < 
b
) (a);

53 (
b
);

54 
	}
}

59 
	$·ck‘_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
·ck‘_ty³
 *
±
)

61 
sock
 *
sk
;

63 
sk
 = (
sock
 *è
±
->
d©a
;

64 
skb
->
dev
 = dev;

65 
skb
->
Ën
 +ğ
dev
->
h¬d_h—d”_Ën
;

67 
skb
->
sk
 = sk;

70 ià(
sk
->
rmem_®loc
 + 
skb
->
mem_Ën
 >ğsk->
rcvbuf
) {

71 
skb
->
sk
 = 
NULL
;

72 
	`kä“_skb
(
skb
, 
FREE_READ
);

75 
sk
->
rmem_®loc
 +ğ
skb
->
mem_Ën
;

76 
	`skb_queue_
(&
sk
->
rqueue
,
skb
);

77 
	`wake_up_š‹¼u±ibË
(
sk
->
¦“p
);

78 
	`»Ëa£_sock
(
sk
);

80 
	}
}

85 
	$·ck‘_£ndto
(
sock
 *
sk
, *
äom
, 
Ën
,

86 
noblock
, 
æags
, 
sockaddr_š
 *
usš
,

87 
addr_Ën
)

89 
sk_buff
 *
skb
;

90 
deviû
 *
dev
;

91 
sockaddr
 
§ddr
;

92 
”r
;

95 ià(
æags
è(-
EINVAL
);

96 ià(
Ën
 < 0è(-
EINVAL
);

99 ià(
usš
) {

100 ià(
addr_Ën
 < (
§ddr
)è(-
EINVAL
);

101 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
usš
, (
§ddr
));

102 if(
”r
)

103  
”r
;

104 
	`memıy_äomfs
(&
§ddr
, 
usš
, (saddr));

106 (-
EINVAL
);

108 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
äom
,
Ën
);

109 if(
”r
)

110 (
”r
);

113 
§ddr
.
§_d©a
[13] = 0;

114 
dev
 = 
	`dev_g‘
(
§ddr
.
§_d©a
);

115 ià(
dev
 =ğ
NULL
) {

116 (-
ENXIO
);

118 if(
Ën
>
dev
->
mtu
)

119  -
EMSGSIZE
;

122 
skb
 = 
sk
->
´Ù
->
	`wm®loc
(sk, 
Ën
+(*skb), 0, 
GFP_KERNEL
);

125 ià(
skb
 =ğ
NULL
) {

126 
	`DPRINTF
((
DBG_PKT
, "packet_sendto: write buffer full?\n"));

127 (-
ENOMEM
);

130 
skb
->
mem_addr
 = skb;

131 
skb
->
mem_Ën
 = 
Ën
 + (*skb);

132 
skb
->
sk
 = sk;

133 
skb
->
ä“
 = 1;

134 
	`memıy_äomfs
(
skb
->
d©a
, 
äom
, 
Ën
);

135 
skb
->
Ën
 =†en;

136 
skb
->
Ãxt
 = 
NULL
;

137 
skb
->
¬p
 = 1;

138 ià(
dev
->
æags
 & 
IFF_UP
èdev->
	`queue_xm™
(
skb
, dev, 
sk
->
´iÜ™y
);

139 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

140 (
Ën
);

141 
	}
}

145 
	$·ck‘_wr™e
(
sock
 *
sk
, *
buff
,

146 
Ën
, 
noblock
, 
æags
)

148 (
	`·ck‘_£ndto
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, 0));

149 
	}
}

153 
	$·ck‘_şo£
(
sock
 *
sk
, 
timeout
)

155 
sk
->
šu£
 = 1;

156 
sk
->
¡©e
 = 
TCP_CLOSE
;

157 
	`dev_»move_·ck
((
·ck‘_ty³
 *)
sk
->
·œ
);

158 
	`kä“_s
((*)
sk
->
·œ
, (
·ck‘_ty³
));

159 
sk
->
·œ
 = 
NULL
;

160 
	`»Ëa£_sock
(
sk
);

161 
	}
}

165 
	$·ck‘_š™
(
sock
 *
sk
)

167 
·ck‘_ty³
 *
p
;

169 
p
 = (
·ck‘_ty³
 *è
	`km®loc
((*p), 
GFP_KERNEL
);

170 ià(
p
 =ğ
NULL
è(-
ENOMEM
);

172 
p
->
func
 = 
·ck‘_rcv
;

173 
p
->
ty³
 = 
sk
->
num
;

174 
p
->
d©a
 = (*)
sk
;

175 
	`dev_add_·ck
(
p
);

178 
sk
->
·œ
 = (
sock
 *)
p
;

181 
	}
}

189 
	$·ck‘_»cväom
(
sock
 *
sk
, *
to
, 
Ën
,

190 
noblock
, 
æags
, 
sockaddr_š
 *
sš
,

191 *
addr_Ën
)

193 
cİ›d
=0;

194 
sk_buff
 *
skb
;

195 
sockaddr
 *
§ddr
;

196 
”r
;

198 
§ddr
 = (
sockaddr
 *)
sš
;

199 ià(
Ën
 == 0) (0);

200 ià(
Ën
 < 0è(-
EINVAL
);

202 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) (0);

203 ià(
addr_Ën
) {

204 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
addr_Ën
, (*addr_len));

205 if(
”r
)

206  
”r
;

207 
	`put_fs_lÚg
((*
§ddr
), 
addr_Ën
);

210 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
to
,
Ën
);

211 if(
”r
)

212  
”r
;

213 
skb
=
	`skb_»cv_d©ag¿m
(
sk
,
æags
,
noblock
,&
”r
);

214 if(
skb
==
NULL
)

215  
”r
;

216 
cİ›d
 = 
	`mš
(
Ën
, 
skb
->len);

218 
	`memıy_tofs
(
to
, 
skb
->
d©a
, 
cİ›d
);

221 ià(
§ddr
) {

222 
sockaddr
 
addr
;

224 
addr
.
§_çmy
 = 
skb
->
dev
->
ty³
;

225 
	`memıy
(
addr
.
§_d©a
,
skb
->
dev
->
Çme
, 14);

226 
	`v”ify_¬—
(
VERIFY_WRITE
, 
§ddr
, (*saddr));

227 
	`memıy_tofs
(
§ddr
, &
addr
, (*saddr));

230 
	`skb_ä“_d©ag¿m
(
skb
);

232 
	`»Ëa£_sock
(
sk
);

233 (
cİ›d
);

234 
	}
}

238 
	$·ck‘_»ad
(
sock
 *
sk
, *
buff
,

239 
Ën
, 
noblock
, 
æags
)

241 (
	`·ck‘_»cväom
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, NULL));

242 
	}
}

245 
´Ùo
 
	g·ck‘_´Ù
 = {

246 
sock_wm®loc
,

247 
sock_rm®loc
,

248 
sock_wä“
,

249 
sock_rä“
,

250 
sock_r¥aû
,

251 
sock_w¥aû
,

252 
·ck‘_şo£
,

253 
·ck‘_»ad
,

254 
·ck‘_wr™e
,

255 
·ck‘_£ndto
,

256 
·ck‘_»cväom
,

257 
_bud_h—d”
,

258 
udp_cÚÃù
,

259 
NULL
,

260 
_queue_xm™
,

261 
_»Œªsm™
,

262 
NULL
,

263 
NULL
,

264 
NULL
,

265 
d©ag¿m_£Ëù
,

266 
NULL
,

267 
·ck‘_š™
,

268 
NULL
,

269 
NULL
,

270 
NULL
,

273 {
NULL
,},

	@net/inet/proc.c

31 
	~<asm/sy¡em.h
>

32 
	~<lšux/autocÚf.h
>

33 
	~<lšux/sched.h
>

34 
	~<lšux/sock‘.h
>

35 
	~<lšux/Ãt.h
>

36 
	~<lšux/un.h
>

37 
	~<lšux/š.h
>

38 
	~<lšux/·¿m.h
>

39 
	~"š‘.h
"

40 
	~"dev.h
"

41 
	~".h
"

42 
	~"´ÙocŞ.h
"

43 
	~"tı.h
"

44 
	~"udp.h
"

45 
	~"skbuff.h
"

46 
	~"sock.h
"

47 
	~"¿w.h
"

57 
	$g‘__Ãtšfo
(
´Ùo
 *
´o
, *
bufãr
, 
fÜm©
)

59 
sock
 **
s_¬¿y
;

60 
sock
 *
¥
;

61 *
pos
=
bufãr
;

62 
i
;

63 
tim”_aùive
;

64 
de¡
, 
¤c
;

65 
de¡p
, 
¤ı
;

67 
s_¬¿y
 = 
´o
->
sock_¬¿y
;

68 
pos
+=
	`¥rštf
(pos, "sl†ocal_address„em_address stx_queue„x_queuerm->when uid\n");

74 
i
 = 0; i < 
SOCK_ARRAY_SIZE
; i++) {

75 
	`şi
();

76 
¥
 = 
s_¬¿y
[
i
];

77 
¥
 !ğ
NULL
) {

78 
de¡
 = 
¥
->
daddr
;

79 
¤c
 = 
¥
->
§ddr
;

80 
de¡p
 = 
¥
->
dummy_th
.
de¡
;

81 
¤ı
 = 
¥
->
dummy_th
.
sourû
;

84 
de¡p
 = 
	`Áohs
(destp);

85 
¤ı
 = 
	`Áohs
(srcp);

86 
tim”_aùive
 = 
	`d–_tim”
(&
¥
->
tim”
);

87 ià(!
tim”_aùive
)

88 
¥
->
tim”
.
expœes
 = 0;

89 
pos
+=
	`¥rštf
(pos, "%2d: %08lX:%04X %08lX:%04X %02X %08lX:%08lX %02X:%08lX %08X %d\n",

90 
i
, 
¤c
, 
¤ı
, 
de¡
, 
de¡p
, 
¥
->
¡©e
,

91 
fÜm©
==0?
¥
->
wr™e_£q
-¥->
rcv_ack_£q
:¥->
rmem_®loc
,

92 
fÜm©
==0?
¥
->
acked_£q
-¥->
cİ›d_£q
:¥->
wmem_®loc
,

93 
tim”_aùive
, 
¥
->
tim”
.
expœes
, (è¥->
»Œªsm™s
,

94 
	`SOCK_INODE
(
¥
->
sock‘
)->
i_uid
);

95 ià(
tim”_aùive
)

96 
	`add_tim”
(&
¥
->
tim”
);

98 ià(
pos
 > 
bufãr
+
PAGE_SIZE
-80) {

99 
	`´štk
("oops,oo many %s sockets for‚etinfo.\n",

100 
´o
->
Çme
);

101 (
	`¡¾’
(
bufãr
));

109 
¥
 = sp->
Ãxt
;

111 
	`¡i
();

114 (
	`¡¾’
(
bufãr
));

115 
	}
}

118 
	$tı_g‘_šfo
(*
bufãr
)

120  
	`g‘__Ãtšfo
(&
tı_´Ù
, 
bufãr
,0);

121 
	}
}

124 
	$udp_g‘_šfo
(*
bufãr
)

126  
	`g‘__Ãtšfo
(&
udp_´Ù
, 
bufãr
,1);

127 
	}
}

130 
	$¿w_g‘_šfo
(*
bufãr
)

132  
	`g‘__Ãtšfo
(&
¿w_´Ù
, 
bufãr
,1);

133 
	}
}

	@net/inet/protocol.c

24 
	~<asm/£gm’t.h
>

25 
	~<asm/sy¡em.h
>

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/k”Ãl.h
>

28 
	~<lšux/sched.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/sock‘.h
>

31 
	~<lšux/š.h
>

32 
	~"š‘.h
"

33 
	~"dev.h
"

34 
	~".h
"

35 
	~"´ÙocŞ.h
"

36 
	~"tı.h
"

37 
	~"skbuff.h
"

38 
	~"sock.h
"

39 
	~"icmp.h
"

40 
	~"udp.h
"

43 
š‘_´ÙocŞ
 
	gtı_´ÙocŞ
 = {

44 
tı_rcv
,

45 
NULL
,

46 
tı_”r
,

47 
NULL
,

48 
IPPROTO_TCP
,

50 
NULL
,

55 
š‘_´ÙocŞ
 
	gudp_´ÙocŞ
 = {

56 
udp_rcv
,

57 
NULL
,

58 
udp_”r
,

59 &
tı_´ÙocŞ
,

60 
IPPROTO_UDP
,

62 
NULL
,

67 
š‘_´ÙocŞ
 
	gicmp_´ÙocŞ
 = {

68 
icmp_rcv
,

69 
NULL
,

70 
NULL
,

71 &
udp_´ÙocŞ
,

72 
IPPROTO_ICMP
,

74 
NULL
,

79 
š‘_´ÙocŞ
 *
	gš‘_´ÙocŞ_ba£
 = &
icmp_´ÙocŞ
;

80 
š‘_´ÙocŞ
 *
	gš‘_´Ùos
[
MAX_INET_PROTOS
] = {

81 
NULL


85 
š‘_´ÙocŞ
 *

86 
	$š‘_g‘_´ÙocŞ
(
´Ù
)

88 
hash
;

89 
š‘_´ÙocŞ
 *
p
;

91 
	`DPRINTF
((
DBG_PROTO
, "g‘_´ÙocŞ (%d)\À", 
´Ù
));

92 
hash
 = 
´Ù
 & (
MAX_INET_PROTOS
 - 1);

93 
p
 = 
š‘_´Ùos
[
hash
] ;… !ğ
NULL
;…õ->
Ãxt
) {

94 
	`DPRINTF
((
DBG_PROTO
, "Œyšg…rÙocŞ %d\n", 
p
->
´ÙocŞ
));

95 ià(
p
->
´ÙocŞ
 =ğ
´Ù
è((
š‘_´ÙocŞ
 *)…);

97 (
NULL
);

98 
	}
}

102 
	$š‘_add_´ÙocŞ
(
š‘_´ÙocŞ
 *
´Ù
)

104 
hash
;

105 
š‘_´ÙocŞ
 *
p2
;

107 
hash
 = 
´Ù
->
´ÙocŞ
 & (
MAX_INET_PROTOS
 - 1);

108 
´Ù
 ->
Ãxt
 = 
š‘_´Ùos
[
hash
];

109 
š‘_´Ùos
[
hash
] = 
´Ù
;

110 
´Ù
->
cİy
 = 0;

113 
p2
 = (
š‘_´ÙocŞ
 *è
´Ù
->
Ãxt
;

114 
p2
 !ğ
NULL
) {

115 ià(
p2
->
´ÙocŞ
 =ğ
´Ù
->protocol) {

116 
´Ù
->
cİy
 = 1;

119 
p2
 = (
š‘_´ÙocŞ
 *è
´Ù
->
Ãxt
;

121 
	}
}

125 
	$š‘_d–_´ÙocŞ
(
š‘_´ÙocŞ
 *
´Ù
)

127 
š‘_´ÙocŞ
 *
p
;

128 
š‘_´ÙocŞ
 *
Í
 = 
NULL
;

129 
hash
;

131 
hash
 = 
´Ù
->
´ÙocŞ
 & (
MAX_INET_PROTOS
 - 1);

132 ià(
´Ù
 =ğ
š‘_´Ùos
[
hash
]) {

133 
š‘_´Ùos
[
hash
] = (
š‘_´ÙocŞ
 *èš‘_´Ùos[hash]->
Ãxt
;

137 
p
 = (
š‘_´ÙocŞ
 *è
š‘_´Ùos
[
hash
];

138 
p
 !ğ
NULL
) {

144 ià(
p
->
Ãxt
 !ğ
NULL
 &&…->Ãxˆ=ğ
´Ù
) {

149 ià(
p
->
cİy
 =ğ0 && 
Í
 !ğ
NULL
)†p->copy = 0;

150 
p
->
Ãxt
 = 
´Ù
->next;

154 ià(
p
->
Ãxt
 !ğ
NULL
 &&…->Ãxt->
´ÙocŞ
 =ğ
´Ù
->protocol) {

155 
Í
 = 
p
;

158 
p
 = (
š‘_´ÙocŞ
 *èp->
Ãxt
;

161 
	}
}

	@net/inet/protocol.h

22 #iâdeà
_PROTOCOL_H


23 
	#_PROTOCOL_H


	)

26 
	#MAX_INET_PROTOS
 32

	)

30 
	sš‘_´ÙocŞ
 {

31 (*
	mhªdËr
)(
sk_buff
 *
	mskb
, 
deviû
 *
	mdev
,

32 
İtiÚs
 *
	mİt
, 
	mdaddr
,

33 
	mËn
, 
	m§ddr
,

34 
	m»do
, 
š‘_´ÙocŞ
 *
	m´ÙocŞ
);

35 (*
	mäag_hªdËr
)(
sk_buff
 *
	mskb
, 
deviû
 *
	mdev
,

36 
İtiÚs
 *
	mİt
, 
	mdaddr
,

37 
	mËn
, 
	m§ddr
,

38 
	m»do
, 
š‘_´ÙocŞ
 *
	m´ÙocŞ
);

39 (*
	m”r_hªdËr
)(
	m”r
, *
	mbuff
,

40 
	mdaddr
,

41 
	m§ddr
,

42 
š‘_´ÙocŞ
 *
	m´ÙocŞ
);

43 
š‘_´ÙocŞ
 *
	mÃxt
;

44 
	m´ÙocŞ
;

45 
	mcİy
:1;

46 *
	md©a
;

47 *
	mÇme
;

51 
š‘_´ÙocŞ
 *
š‘_´ÙocŞ_ba£
;

52 
š‘_´ÙocŞ
 *
š‘_´Ùos
[
MAX_INET_PROTOS
];

55 
š‘_add_´ÙocŞ
(
š‘_´ÙocŞ
 *
´Ù
);

56 
š‘_d–_´ÙocŞ
(
š‘_´ÙocŞ
 *
´Ù
);

	@net/inet/raw.c

32 
	~<asm/sy¡em.h
>

33 
	~<asm/£gm’t.h
>

34 
	~<lšux/ty³s.h
>

35 
	~<lšux/sched.h
>

36 
	~<lšux/”ºo.h
>

37 
	~<lšux/tim”.h
>

38 
	~<lšux/mm.h
>

39 
	~<lšux/k”Ãl.h
>

40 
	~<lšux/fú.h
>

41 
	~<lšux/sock‘.h
>

42 
	~<lšux/š.h
>

43 
	~"š‘.h
"

44 
	~"dev.h
"

45 
	~".h
"

46 
	~"´ÙocŞ.h
"

47 
	~"tı.h
"

48 
	~"skbuff.h
"

49 
	~"sock.h
"

50 
	~"icmp.h
"

51 
	~"udp.h
"

55 
	$mš
(
a
, 
b
)

57 ià(
a
 < 
b
) (a);

58 (
b
);

59 
	}
}

64 
	$¿w_”r
 (
”r
, *
h—d”
, 
daddr
,

65 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

67 
sock
 *
sk
;

69 
	`DPRINTF
((
DBG_RAW
, "raw_err(err=%d, hdr=%X, daddr=%X, saddr=%X,…rotocl=%X)\n",

70 
”r
, 
h—d”
, 
daddr
, 
§ddr
, 
´ÙocŞ
));

72 ià(
´ÙocŞ
 =ğ
NULL
) ;

73 
sk
 = (
sock
 *è
´ÙocŞ
->
d©a
;

74 ià(
sk
 =ğ
NULL
) ;

77 ià(
”r
 & 0xff00 =ğ(
ICMP_SOURCE_QUENCH
 << 8)) {

78 ià(
sk
->
cÚg_wšdow
 > 1) sk->cong_window = sk->cong_window/2;

82 
sk
->
”r
 = 
icmp_”r_cÚv”t
[”¸& 0xff].
”ºo
;

83 
sk
->
	`”rÜ_»pÜt
(sk);

86 
	}
}

94 
	$¿w_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
İtiÚs
 *
İt
,

95 
daddr
, 
Ën
, 
§ddr
,

96 
»do
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

98 
sock
 *
sk
;

100 
	`DPRINTF
((
DBG_RAW
, "raw_rcv(skb=%X, dev=%X, opt=%X, daddr=%X,\n"

102 
skb
, 
dev
, 
İt
, 
daddr
, 
Ën
, 
§ddr
, 
»do
, 
´ÙocŞ
));

104 ià(
skb
 =ğ
NULL
) (0);

105 ià(
´ÙocŞ
 =ğ
NULL
) {

106 
	`kä“_skb
(
skb
, 
FREE_READ
);

109 
sk
 = (
sock
 *è
´ÙocŞ
->
d©a
;

110 ià(
sk
 =ğ
NULL
) {

111 
	`kä“_skb
(
skb
, 
FREE_READ
);

116 
skb
->
sk
 = sk;

117 
skb
->
Ën
 =†’ + skb->
_hdr
->
ihl
*();

118 
skb
->
h
.
¿w
 = (*èskb->
_hdr
;

119 
skb
->
dev
 = dev;

120 
skb
->
§ddr
 = 
daddr
;

121 
skb
->
daddr
 = 
§ddr
;

124 ià(
sk
->
rmem_®loc
 + 
skb
->
mem_Ën
 >ğsk->
rcvbuf
) {

125 
skb
->
sk
 = 
NULL
;

126 
	`kä“_skb
(
skb
, 
FREE_READ
);

129 
sk
->
rmem_®loc
 +ğ
skb
->
mem_Ën
;

130 
	`skb_queue_
(&
sk
->
rqueue
,
skb
);

131 
sk
->
	`d©a_»ady
(sk,
skb
->
Ën
);

132 
	`»Ëa£_sock
(
sk
);

134 
	}
}

139 
	$¿w_£ndto
(
sock
 *
sk
, *
äom
, 
Ën
,

140 
noblock
,

141 
æags
, 
sockaddr_š
 *
usš
, 
addr_Ën
)

143 
sk_buff
 *
skb
;

144 
deviû
 *
dev
=
NULL
;

145 
sockaddr_š
 
sš
;

146 
tmp
;

147 
”r
;

149 
	`DPRINTF
((
DBG_RAW
, "raw_sendto(sk=%X, from=%X,†en=%d,‚oblock=%d, flags=%X,\n"

150 " usš=%X,‡ddr_ËÀğ%d)\n", 
sk
, 
äom
, 
Ën
, 
noblock
,

151 
æags
, 
usš
, 
addr_Ën
));

154 ià(
æags
è(-
EINVAL
);

155 ià(
Ën
 < 0è(-
EINVAL
);

157 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
äom
,
Ën
);

158 if(
”r
)

159  
”r
;

161 ià(
usš
) {

162 ià(
addr_Ën
 < (
sš
)è(-
EINVAL
);

163 
”r
=
	`v”ify_¬—
 (
VERIFY_READ
, 
usš
,  (
sš
));

164 if(
”r
)

165  
”r
;

166 
	`memıy_äomfs
(&
sš
, 
usš
, (sin));

167 ià(
sš
.
sš_çmy
 && sš.sš_çmy !ğ
AF_INET
è(-
EINVAL
);

169 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
è(-
EINVAL
);

170 
sš
.
sš_çmy
 = 
AF_INET
;

171 
sš
.
sš_pÜt
 = 
sk
->
´ÙocŞ
;

172 
sš
.
sš_addr
.
s_addr
 = 
sk
->
daddr
;

174 ià(
sš
.
sš_pÜt
 =ğ0èsš.sš_pÜˆğ
sk
->
´ÙocŞ
;

176 ià(
sk
->
brßdÿ¡
 =ğ0 && 
	`chk_addr
(
sš
.
sš_addr
.
s_addr
)==
IS_BROADCAST
)

177  -
EACCES
;

179 
sk
->
šu£
 = 1;

180 
skb
 = 
NULL
;

181 
skb
 =ğ
NULL
) {

182 if(
sk
->
”r
!=0)

184 
”r
ğ-
sk
->err;

185 
sk
->
”r
=0;

186 
	`»Ëa£_sock
(
sk
);

187 (
”r
);

190 
skb
 = 
sk
->
´Ù
->
	`wm®loc
(sk,

191 
Ën
+(*
skb
è+ 
sk
->
´Ù
->
max_h—d”
,

192 0, 
GFP_KERNEL
);

193 ià(
skb
 =ğ
NULL
) {

194 
tmp
;

196 
	`DPRINTF
((
DBG_RAW
, "raw_sendto: write buffer full?\n"));

197 ià(
noblock
)

198 (-
EAGAIN
);

199 
tmp
 = 
sk
->
wmem_®loc
;

200 
	`»Ëa£_sock
(
sk
);

201 
	`şi
();

202 ià(
tmp
 <ğ
sk
->
wmem_®loc
) {

203 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

204 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

205 
	`¡i
();

206 (-
ERESTARTSYS
);

209 
sk
->
šu£
 = 1;

210 
	`¡i
();

213 
skb
->
mem_addr
 = skb;

214 
skb
->
mem_Ën
 = 
Ën
 + (*skbè+
sk
->
´Ù
->
max_h—d”
;

215 
skb
->
sk
 = sk;

217 
skb
->
ä“
 = 1;

218 
skb
->
¬p
 = 0;

220 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
skb
, sk->
§ddr
,

221 
sš
.
sš_addr
.
s_addr
, &
dev
,

222 
sk
->
´ÙocŞ
, sk->
İt
, 
skb
->
mem_Ën
, sk->
_tos
,sk->
_‰l
);

223 ià(
tmp
 < 0) {

224 
	`DPRINTF
((
DBG_RAW
, "raw_sendto:ƒrror building ip header.\n"));

225 
	`kä“_skb
(
skb
,
FREE_WRITE
);

226 
	`»Ëa£_sock
(
sk
);

227 (
tmp
);

231 
	`memıy_äomfs
(
skb
->
d©a
 + 
tmp
, 
äom
, 
Ën
);

236 if(
sk
->
´ÙocŞ
==
IPPROTO_RAW
) {

237 *
buff
;

238 
hdr
 *
h
;

240 
buff
 = 
skb
->
d©a
;

241 
buff
 +ğ
tmp
;

242 
h
 = (
hdr
 *)
buff
;

243 
h
->
§ddr
 = 
sk
->saddr;

246 
skb
->
Ën
 = 
tmp
 +†en;

248 if(
dev
!=
NULL
 && 
skb
->
Ën
 > 4095)

250 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

251 
	`»Ëa£_sock
(
sk
);

252 (-
EMSGSIZE
);

255 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
skb
, 1);

256 
	`»Ëa£_sock
(
sk
);

257 (
Ën
);

258 
	}
}

262 
	$¿w_wr™e
(
sock
 *
sk
, *
buff
, 
Ën
, 
noblock
,

263 
æags
)

265 (
	`¿w_£ndto
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, 0));

266 
	}
}

270 
	$¿w_şo£
(
sock
 *
sk
, 
timeout
)

272 
sk
->
šu£
 = 1;

273 
sk
->
¡©e
 = 
TCP_CLOSE
;

275 
	`DPRINTF
((
DBG_RAW
, "raw_close: deleting…rotocol %d\n",

276 ((
š‘_´ÙocŞ
 *)
sk
->
·œ
)->
´ÙocŞ
));

278 ià(
	`š‘_d–_´ÙocŞ
((
š‘_´ÙocŞ
 *)
sk
->
·œ
) < 0)

279 
	`DPRINTF
((
DBG_RAW
, "raw_close: del_protocol failed.\n"));

280 
	`kä“_s
((*)
sk
->
·œ
,  (
š‘_´ÙocŞ
));

281 
sk
->
·œ
 = 
NULL
;

282 
	`»Ëa£_sock
(
sk
);

283 
	}
}

287 
	$¿w_š™
(
sock
 *
sk
)

289 
š‘_´ÙocŞ
 *
p
;

291 
p
 = (
š‘_´ÙocŞ
 *è
	`km®loc
( (*p), 
GFP_KERNEL
);

292 ià(
p
 =ğ
NULL
è(-
ENOMEM
);

294 
p
->
hªdËr
 = 
¿w_rcv
;

295 
p
->
´ÙocŞ
 = 
sk
->protocol;

296 
p
->
d©a
 = (*)
sk
;

297 
p
->
”r_hªdËr
 = 
¿w_”r
;

298 
p
->
Çme
="USER";

299 
p
->
äag_hªdËr
 = 
NULL
;

300 
	`š‘_add_´ÙocŞ
(
p
);

303 
sk
->
·œ
 = (
sock
 *)
p
;

305 
	`DPRINTF
((
DBG_RAW
, "¿w in™‡dded…rÙocŞ %d\n", 
sk
->
´ÙocŞ
));

308 
	}
}

316 
	$¿w_»cväom
(
sock
 *
sk
, *
to
, 
Ën
,

317 
noblock
, 
æags
, 
sockaddr_š
 *
sš
,

318 *
addr_Ën
)

320 
cİ›d
=0;

321 
sk_buff
 *
skb
;

322 
”r
;

324 
	`DPRINTF
((
DBG_RAW
, "raw_recvfrom (sk=%X,o=%X,†en=%d,‚oblock=%d, flags=%X,\n"

326 
sk
, 
to
, 
Ën
, 
noblock
, 
æags
, 
sš
, 
addr_Ën
));

328 ià(
Ën
 == 0) (0);

329 ià(
Ën
 < 0è(-
EINVAL
);

331 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) (0);

332 ià(
addr_Ën
) {

333 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
addr_Ën
, (*addr_len));

334 if(
”r
)

335  
”r
;

336 
	`put_fs_lÚg
((*
sš
), 
addr_Ën
);

338 if(
sš
)

340 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
sš
, (*sin));

341 if(
”r
)

342  
”r
;

345 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
to
,
Ën
);

346 if(
”r
)

347  
”r
;

349 
skb
=
	`skb_»cv_d©ag¿m
(
sk
,
æags
,
noblock
,&
”r
);

350 if(
skb
==
NULL
)

351  
”r
;

353 
cİ›d
 = 
	`mš
(
Ën
, 
skb
->len);

355 
	`skb_cİy_d©ag¿m
(
skb
, 0, 
to
, 
cİ›d
);

358 ià(
sš
) {

359 
sockaddr_š
 
addr
;

361 
addr
.
sš_çmy
 = 
AF_INET
;

362 
addr
.
sš_addr
.
s_addr
 = 
skb
->
daddr
;

363 
	`memıy_tofs
(
sš
, &
addr
, (*sin));

366 
	`skb_ä“_d©ag¿m
(
skb
);

367 
	`»Ëa£_sock
(
sk
);

368  (
cİ›d
);

369 
	}
}

373 
	$¿w_»ad
 (
sock
 *
sk
, *
buff
, 
Ën
, 
noblock
,

374 
æags
)

376 (
	`¿w_»cväom
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, NULL));

377 
	}
}

380 
´Ùo
 
	g¿w_´Ù
 = {

381 
sock_wm®loc
,

382 
sock_rm®loc
,

383 
sock_wä“
,

384 
sock_rä“
,

385 
sock_r¥aû
,

386 
sock_w¥aû
,

387 
¿w_şo£
,

388 
¿w_»ad
,

389 
¿w_wr™e
,

390 
¿w_£ndto
,

391 
¿w_»cväom
,

392 
_bud_h—d”
,

393 
udp_cÚÃù
,

394 
NULL
,

395 
_queue_xm™
,

396 
_»Œªsm™
,

397 
NULL
,

398 
NULL
,

399 
¿w_rcv
,

400 
d©ag¿m_£Ëù
,

401 
NULL
,

402 
¿w_š™
,

403 
NULL
,

404 
_£tsockİt
,

405 
_g‘sockİt
,

408 {
NULL
,},

	@net/inet/raw.h

17 #iâdeà
_RAW_H


18 
	#_RAW_H


	)

21 
´Ùo
 
¿w_´Ù
;

24 
¿w_”r
(
”r
, *
h—d”
, 
daddr
,

25 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
);

26 
¿w_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

27 
İtiÚs
 *
İt
, 
daddr
,

28 
Ën
, 
§ddr
,

29 
»do
, 
š‘_´ÙocŞ
 *
´ÙocŞ
);

30 
¿w_»cväom
(
sock
 *
sk
, *
to
,

31 
Ën
, 
noblock
, 
æags
,

32 
sockaddr_š
 *
sš
, *
addr_Ën
);

33 
¿w_»ad
(
sock
 *
sk
, *
buff
,

34 
Ën
, 
noblock
, 
æags
);

	@net/inet/route.c

25 
	~<asm/£gm’t.h
>

26 
	~<asm/sy¡em.h
>

27 
	~<lšux/ty³s.h
>

28 
	~<lšux/k”Ãl.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/sock‘.h
>

32 
	~<lšux/sockios.h
>

33 
	~<lšux/”ºo.h
>

34 
	~<lšux/š.h
>

35 
	~"š‘.h
"

36 
	~"dev.h
"

37 
	~".h
"

38 
	~"´ÙocŞ.h
"

39 
	~"rou‹.h
"

40 
	~"tı.h
"

41 
	~"skbuff.h
"

42 
	~"sock.h
"

43 
	~"¬p.h
"

44 
	~"icmp.h
"

47 
¹abË
 *
	g¹_ba£
 = 
NULL
;

48 
¹abË
 *
	g¹_loİback
 = 
NULL
;

52 
	$¹_´št
(
¹abË
 *
¹
)

54 ià(
¹
 =ğ
NULL
 || 
š‘_debug
 !ğ
DBG_RT
) ;

56 
	`´štk
("RT: %06lx NXT=%06lx FLAGS=0x%02x\n",

57 (è
¹
, (è¹->
¹_Ãxt
,„t->
¹_æags
);

58 
	`´štk
(" TARGET=% ", 
	`š_Áß
(
¹
->
¹_d¡
));

59 
	`´štk
("GW=% ", 
	`š_Áß
(
¹
->
¹_g©eway
));

60 
	`´štk
(" DEV=%s USE=%ld REF=%d\n",

61 (
¹
->
¹_dev
 =ğ
NULL
è? "NONE" :„t->¹_dev->
Çme
,

62 
¹
->
¹_u£
,„t->
¹_»fút
);

63 
	}
}

69 
	$¹_d–
(
d¡
)

71 
¹abË
 *
r
, **
½
;

72 
æags
;

74 
	`DPRINTF
((
DBG_RT
, "RT: flushšg fÜ d¡ %s\n", 
	`š_Áß
(
d¡
)));

75 
½
 = &
¹_ba£
;

76 
	`§ve_æags
(
æags
);

77 
	`şi
();

78 (
r
 = *
½
è!ğ
NULL
) {

79 ià(
r
->
¹_d¡
 !ğ
d¡
) {

80 
½
 = &
r
->
¹_Ãxt
;

83 *
½
 = 
r
->
¹_Ãxt
;

84 ià(
¹_loİback
 =ğ
r
)

85 
¹_loİback
 = 
NULL
;

86 
	`kä“_s
(
r
, (
¹abË
));

88 
	`»¡Üe_æags
(
æags
);

89 
	}
}

95 
	$¹_æush
(
deviû
 *
dev
)

97 
¹abË
 *
r
;

98 
¹abË
 **
½
;

99 
æags
;

101 
	`DPRINTF
((
DBG_RT
, "RT: flushšg fÜ dev 0x%08lx (%s)\n", ()
dev
, dev->
Çme
));

102 
½
 = &
¹_ba£
;

103 
	`şi
();

104 
	`§ve_æags
(
æags
);

105 (
r
 = *
½
è!ğ
NULL
) {

106 ià(
r
->
¹_dev
 !ğ
dev
) {

107 
½
 = &
r
->
¹_Ãxt
;

110 *
½
 = 
r
->
¹_Ãxt
;

111 ià(
¹_loİback
 =ğ
r
)

112 
¹_loİback
 = 
NULL
;

113 
	`kä“_s
(
r
, (
¹abË
));

115 
	`»¡Üe_æags
(
æags
);

116 
	}
}

125 
šlše
 
	$deçuÉ_mask
(
d¡
)

127 
d¡
 = 
	`Áohl
(dst);

128 ià(
	`IN_CLASSA
(
d¡
))

129  
	`htÚl
(
IN_CLASSA_NET
);

130 ià(
	`IN_CLASSB
(
d¡
))

131  
	`htÚl
(
IN_CLASSB_NET
);

132  
	`htÚl
(
IN_CLASSC_NET
);

133 
	}
}

135 
	$guess_mask
(
d¡
, 
deviû
 * 
dev
)

137 
mask
;

139 ià(!
d¡
)

141 
mask
 = 
	`deçuÉ_mask
(
d¡
);

142 ià((
d¡
 ^ 
dev
->
·_addr
è& 
mask
)

143  
mask
;

144  
dev
->
·_mask
;

145 
	}
}

147 
šlše
 
deviû
 * 
	$g‘_gw_dev
(
gw
)

149 
¹abË
 * 
¹
;

151 
¹
 = 
¹_ba£
 ; ;„ˆğ¹->
¹_Ãxt
) {

152 ià(!
¹
)

153  
NULL
;

154 ià((
gw
 ^ 
¹
->
¹_d¡
è&„t->
¹_mask
)

157 ià(
¹
->
¹_æags
 & 
RTF_GATEWAY
)

158  
NULL
;

159  
¹
->
¹_dev
;

161 
	}
}

166 
	$¹_add
(
æags
, 
d¡
, 
mask
,

167 
gw
, 
deviû
 *
dev
)

169 
¹abË
 *
r
, *
¹
;

170 
¹abË
 **
½
;

171 
ıuæags
;

173 ià(
æags
 & 
RTF_HOST
) {

174 
mask
 = 0xffffffff;

175 } ià(!
mask
) {

176 ià(!((
d¡
 ^ 
dev
->
·_addr
è& dev->
·_mask
)) {

177 
mask
 = 
dev
->
·_mask
;

178 
æags
 &ğ~
RTF_GATEWAY
;

179 ià(
æags
 & 
RTF_DYNAMIC
) {

184 
mask
 = 
	`guess_mask
(
d¡
, 
dev
);

185 
d¡
 &ğ
mask
;

187 ià(
gw
 =ğ
dev
->
·_addr
)

188 
æags
 &ğ~
RTF_GATEWAY
;

189 ià(
æags
 & 
RTF_GATEWAY
) {

191 ià(
dev
 !ğ
	`g‘_gw_dev
(
gw
))

193 
æags
 |ğ
RTF_GATEWAY
;

195 
gw
 = 0;

197 
¹
 = (
¹abË
 *è
	`km®loc
((¹abË), 
GFP_ATOMIC
);

198 ià(
¹
 =ğ
NULL
) {

199 
	`DPRINTF
((
DBG_RT
, "RT:‚o memory for‚ew„oute!\n"));

202 
	`mem£t
(
¹
, 0, (
¹abË
));

203 
¹
->
¹_æags
 = 
æags
 | 
RTF_UP
;

204 
¹
->
¹_d¡
 = 
d¡
;

205 
¹
->
¹_dev
 = 
dev
;

206 
¹
->
¹_g©eway
 = 
gw
;

207 
¹
->
¹_mask
 = 
mask
;

208 
¹
->
¹_mtu
 = 
dev
->
mtu
;

209 
	`¹_´št
(
¹
);

215 
	`§ve_æags
(
ıuæags
);

216 
	`şi
();

218 
½
 = &
¹_ba£
;

219 (
r
 = *
½
è!ğ
NULL
) {

220 ià(
r
->
¹_d¡
 !ğ
d¡
) {

221 
½
 = &
r
->
¹_Ãxt
;

224 *
½
 = 
r
->
¹_Ãxt
;

225 ià(
¹_loİback
 =ğ
r
)

226 
¹_loİback
 = 
NULL
;

227 
	`kä“_s
(
r
, (
¹abË
));

230 
½
 = &
¹_ba£
;

231 (
r
 = *
½
è!ğ
NULL
) {

232 ià((
r
->
¹_mask
 & 
mask
) != mask)

234 
½
 = &
r
->
¹_Ãxt
;

236 
¹
->
¹_Ãxt
 = 
r
;

237 *
½
 = 
¹
;

238 ià(
¹
->
¹_dev
->
æags
 & 
IFF_LOOPBACK
)

239 
¹_loİback
 = 
¹
;

240 
	`»¡Üe_æags
(
ıuæags
);

242 
	}
}

244 
šlše
 
	$bad_mask
(
mask
, 
addr
)

246 ià(
addr
 & (
mask
 = ~mask))

248 
mask
 = 
	`Áohl
(mask);

249 ià(
mask
 & (mask+1))

252 
	}
}

254 
	$¹_Ãw
(
¹’Œy
 *
r
)

256 
”r
;

257 * 
devÇme
;

258 
deviû
 * 
dev
 = 
NULL
;

259 
æags
, 
daddr
, 
mask
, 
gw
;

261 ià((
devÇme
 = 
r
->
¹_dev
è!ğ
NULL
) {

262 
”r
 = 
	`g‘Çme
(
devÇme
, &devname);

263 ià(
”r
)

264  
”r
;

265 
dev
 = 
	`dev_g‘
(
devÇme
);

266 
	`puŠame
(
devÇme
);

267 ià(!
dev
)

268  -
EINVAL
;

271 ià(
r
->
¹_d¡
.
§_çmy
 !ğ
AF_INET
)

272  -
EAFNOSUPPORT
;

274 
æags
 = 
r
->
¹_æags
;

275 
daddr
 = ((
sockaddr_š
 *è&
r
->
¹_d¡
)->
sš_addr
.
s_addr
;

276 
mask
 = ((
sockaddr_š
 *è&
r
->
¹_g’mask
)->
sš_addr
.
s_addr
;

277 
gw
 = ((
sockaddr_š
 *è&
r
->
¹_g©eway
)->
sš_addr
.
s_addr
;

282 ià(!
dev
 && (
æags
 & 
RTF_GATEWAY
)) {

283 
deviû
 *
dev2
;

284 
dev2
 = 
dev_ba£
 ; dev2 !ğ
NULL
 ; dev2 = dev2->
Ãxt
) {

285 ià((
dev2
->
æags
 & 
IFF_UP
è&& dev2->
·_addr
 =ğ
gw
) {

286 
æags
 &ğ~
RTF_GATEWAY
;

287 
dev
 = 
dev2
;

293 ià(
	`bad_mask
(
mask
, 
daddr
))

294 
mask
 = 0;

296 ià(
æags
 & 
RTF_HOST
)

297 
mask
 = 0xffffffff;

298 ià(
mask
 && 
r
->
¹_g’mask
.
§_çmy
 !ğ
AF_INET
)

299  -
EAFNOSUPPORT
;

301 ià(
æags
 & 
RTF_GATEWAY
) {

302 ià(
r
->
¹_g©eway
.
§_çmy
 !ğ
AF_INET
)

303  -
EAFNOSUPPORT
;

304 ià(!
dev
)

305 
dev
 = 
	`g‘_gw_dev
(
gw
);

306 } ià(!
dev
)

307 
dev
 = 
	`dev_check
(
daddr
);

309 ià(
dev
 =ğ
NULL
)

310  -
ENETUNREACH
;

312 
	`¹_add
(
æags
, 
daddr
, 
mask
, 
gw
, 
dev
);

314 
	}
}

317 
	$¹_kl
(
¹’Œy
 *
r
)

319 
sockaddr_š
 *
Œg
;

321 
Œg
 = (
sockaddr_š
 *è&
r
->
¹_d¡
;

322 
	`¹_d–
(
Œg
->
sš_addr
.
s_addr
);

324 
	}
}

329 
	$¹_g‘_šfo
(*
bufãr
)

331 
¹abË
 *
r
;

332 *
pos
;

334 
pos
 = 
bufãr
;

336 
pos
 +ğ
	`¥rštf
(pos,

340 
r
 = 
¹_ba£
;„ !ğ
NULL
;„ =„->
¹_Ãxt
) {

341 
pos
 +ğ
	`¥rštf
(pos, "%s\t%08lX\t%08lX\t%02X\t%d\t%lu\t%d\t%08lX\n",

342 
r
->
¹_dev
->
Çme
,„->
¹_d¡
,„->
¹_g©eway
,

343 
r
->
¹_æags
,„->
¹_»fút
,„->
¹_u£
,„->
¹_m‘ric
,

344 
r
->
¹_mask
);

346 (
pos
 - 
bufãr
);

347 
	}
}

352 
	#—¾y_out
 ({ 
no_rou‹
; 1; })

	)

354 
¹abË
 * 
	$¹_rou‹
(
daddr
, 
İtiÚs
 *
İt
)

356 
¹abË
 *
¹
;

358 
¹
 = 
¹_ba£
;„ˆ!ğ
NULL
 || 
—¾y_out
 ;„ˆğ¹->
¹_Ãxt
) {

359 ià(!((
¹
->
¹_d¡
 ^ 
daddr
è&„t->
¹_mask
))

362 ià((
¹
->
¹_dev
->
æags
 & 
IFF_BROADCAST
) &&

363 
¹
->
¹_dev
->
·_brdaddr
 =ğ
daddr
)

366 ià(
daddr
 =ğ
¹
->
¹_dev
->
·_addr
) {

367 ià((
¹
 = 
¹_loİback
è=ğ
NULL
)

368 
no_rou‹
;

370 
¹
->
¹_u£
++;

371  
¹
;

372 
no_rou‹
:

373  
NULL
;

374 
	}
}

376 
	$g‘_Şd_¹’t
(
Şd_¹’Œy
 * 
¤c
, 
¹’Œy
 * 
¹
)

378 
”r
;

379 
Şd_¹’Œy
 
tmp
;

381 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
¤c
, (*src));

382 ià(
”r
)

383  
”r
;

384 
	`memıy_äomfs
(&
tmp
, 
¤c
, (*src));

385 
	`mem£t
(
¹
, 0, (*rt));

386 
¹
->
¹_d¡
 = 
tmp
.rt_dst;

387 
¹
->
¹_g©eway
 = 
tmp
.rt_gateway;

388 
¹
->
¹_g’mask
.
§_çmy
 = 
AF_INET
;

389 ((
sockaddr_š
 *è&
¹
->
¹_g’mask
)->
sš_addr
.
s_addr
 = 
tmp
.rt_genmask;

390 
¹
->
¹_æags
 = 
tmp
.rt_flags;

391 
¹
->
¹_dev
 = 
tmp
.rt_dev;

393 
	}
}

395 
	$¹_ioùl
(
cmd
, *
¬g
)

397 
”r
;

398 
¹’Œy
 
¹
;

400 
cmd
) {

401 
DDIOCSDBG
:

402  
	`dbg_ioùl
(
¬g
, 
DBG_RT
);

403 
SIOCADDRTOLD
:

404 
SIOCDELRTOLD
:

405 ià(!
	`su£r
())

406  -
EPERM
;

407 
”r
 = 
	`g‘_Şd_¹’t
((
Şd_¹’Œy
 *è
¬g
, &
¹
);

408 ià(
”r
)

409  
”r
;

410  (
cmd
 =ğ
SIOCDELRTOLD
è? 
	`¹_kl
(&
¹
è: 
	`¹_Ãw
(&rt);

411 
SIOCADDRT
:

412 
SIOCDELRT
:

413 ià(!
	`su£r
())

414  -
EPERM
;

415 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬g
, (
¹’Œy
));

416 ià(
”r
)

417  
”r
;

418 
	`memıy_äomfs
(&
¹
, 
¬g
, (
¹’Œy
));

419  (
cmd
 =ğ
SIOCDELRT
è? 
	`¹_kl
(&
¹
è: 
	`¹_Ãw
(&rt);

422  -
EINVAL
;

423 
	}
}

	@net/inet/route.h

18 #iâdeà
_ROUTE_H


19 
	#_ROUTE_H


	)

22 
	~<lšux/rou‹.h
>

26 
	s¹abË
 {

27 
¹abË
 *
	m¹_Ãxt
;

28 
	m¹_d¡
;

29 
	m¹_mask
;

30 
	m¹_g©eway
;

31 
	m¹_æags
;

32 
	m¹_m‘ric
;

33 
	m¹_»fút
;

34 
	m¹_u£
;

35 
	m¹_mss
, 
	m¹_mtu
;

36 
deviû
 *
	m¹_dev
;

40 
¹_æush
(
deviû
 *
dev
);

41 
¹_add
(
æags
, 
addr
, 
mask
,

42 
gw
, 
deviû
 *
dev
);

43 
¹abË
 *
¹_rou‹
(
daddr
, 
İtiÚs
 *
İt
);

44 
¹_g‘_šfo
(* 
bufãr
);

45 
¹_ioùl
(
cmd
, *
¬g
);

	@net/inet/skbuff.c

17 
	~<lšux/cÚfig.h
>

18 
	~<lšux/ty³s.h
>

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/sched.h
>

21 
	~<asm/£gm’t.h
>

22 
	~<asm/sy¡em.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/š.h
>

26 
	~"š‘.h
"

27 
	~"dev.h
"

28 
	~".h
"

29 
	~"´ÙocŞ.h
"

30 
	~"¬p.h
"

31 
	~"rou‹.h
"

32 
	~"tı.h
"

33 
	~"udp.h
"

34 
	~"skbuff.h
"

35 
	~"sock.h
"

48 vŞ©
	gÃt_memÜy
=0;

49 vŞ©
	gÃt_skbcouÁ
=0;

57 
	$skb_check
(
sk_buff
 *
skb
, 
lše
, *
fe
)

59 if(
skb
->
magic_debug_cook›
==
SK_FREED_SKB
)

61 
	`´štk
("File: %s Line %d, found‡ freed skb†urking inhe undergrowth!\n",

62 
fe
,
lše
);

63 
	`´štk
("skb=%p,„eal size=%ld, claimed size=%ld, magic=%d,†ist=%p, free=%d\n",

64 
skb
,skb->
Œuesize
,skb->
mem_Ën
,skb->
magic
,skb->
li¡
,skb->
ä“
);

66 if(
skb
->
magic_debug_cook›
!=
SK_GOOD_SKB
)

68 
	`´štk
("Fe: % Lš%d,…as£d‡‚Ú skb!\n", 
fe
,
lše
);

69 
	`´štk
("skb=%p,„eal size=%ld, claimed size=%ld, magic=%d,†ist=%p, free=%d\n",

70 
skb
,skb->
Œuesize
,skb->
mem_Ën
,skb->
magic
,skb->
li¡
,skb->
ä“
);

72 if(
skb
->
mem_Ën
!=skb->
Œuesize
)

74 
	`´štk
("Fe: % Lš%d, Dubiou siz£‰šg!\n",
fe
,
lše
);

75 
	`´štk
("skb=%p,„eal size=%ld, claimed size=%ld, magic=%d,†ist=%p\n",

76 
skb
,skb->
Œuesize
,skb->
mem_Ën
,skb->
magic
,skb->
li¡
);

79 
	}
}

85 
	$skb_queue_h—d
(
sk_buff
 *vŞ©e* 
li¡
,sk_bufà*
Ãwsk
)

87 
æags
;

89 
	`IS_SKB
(
Ãwsk
);

90 if(
Ãwsk
->
li¡
)

91 
	`´štk
("Suspicious queue head: sk_buff on†ist!\n");

92 
	`§ve_æags
(
æags
);

93 
	`şi
();

94 
Ãwsk
->
li¡
=list;

96 
Ãwsk
->
Ãxt
=*
li¡
;

98 if(*
li¡
)

99 
Ãwsk
->
´ev
=(*
li¡
)->prev;

101 
Ãwsk
->
´ev
=newsk;

102 
Ãwsk
->
´ev
->
Ãxt
=newsk;

103 
Ãwsk
->
Ãxt
->
´ev
=newsk;

104 
	`IS_SKB
(
Ãwsk
->
´ev
);

105 
	`IS_SKB
(
Ãwsk
->
Ãxt
);

106 *
li¡
=
Ãwsk
;

107 
	`»¡Üe_æags
(
æags
);

108 
	}
}

114 
	$skb_queue_
(
sk_buff
 *vŞ©e* 
li¡
, sk_bufà*
Ãwsk
)

116 
æags
;

118 if(
Ãwsk
->
li¡
)

119 
	`´štk
("Suspicious queueail: sk_buff on†ist!\n");

121 
	`IS_SKB
(
Ãwsk
);

122 
	`§ve_æags
(
æags
);

123 
	`şi
();

125 
Ãwsk
->
li¡
=list;

126 if(*
li¡
)

128 (*
li¡
)->
´ev
->
Ãxt
=
Ãwsk
;

129 
Ãwsk
->
´ev
=(*
li¡
)->prev;

130 
Ãwsk
->
Ãxt
=*
li¡
;

131 (*
li¡
)->
´ev
=
Ãwsk
;

135 
Ãwsk
->
Ãxt
=newsk;

136 
Ãwsk
->
´ev
=newsk;

137 *
li¡
=
Ãwsk
;

139 
	`IS_SKB
(
Ãwsk
->
´ev
);

140 
	`IS_SKB
(
Ãwsk
->
Ãxt
);

141 
	`»¡Üe_æags
(
æags
);

143 
	}
}

150 
sk_buff
 *
	$skb_dequeue
(
sk_buff
 *vŞ©e* 
li¡
)

152 
æags
;

153 
sk_buff
 *
»suÉ
;

155 
	`§ve_æags
(
æags
);

156 
	`şi
();

158 if(*
li¡
==
NULL
)

160 
	`»¡Üe_æags
(
æags
);

161 (
NULL
);

164 
»suÉ
=*
li¡
;

165 if(
»suÉ
->
Ãxt
==result)

166 *
li¡
=
NULL
;

169 
»suÉ
->
Ãxt
->
´ev
=result->prev;

170 
»suÉ
->
´ev
->
Ãxt
=result->next;

171 *
li¡
=
»suÉ
->
Ãxt
;

174 
	`IS_SKB
(
»suÉ
);

175 
	`»¡Üe_æags
(
æags
);

177 if(
»suÉ
->
li¡
!=list)

178 
	`´štk
("Dequeued…acket has invalid†ist…ointer\n");

180 
»suÉ
->
li¡
=0;

181 
»suÉ
->
Ãxt
=0;

182 
»suÉ
->
´ev
=0;

183 (
»suÉ
);

184 
	}
}

190 
	$skb_š£¹
(
sk_buff
 *
Şd
, sk_bufà*
Ãwsk
)

192 
æags
;

194 
	`IS_SKB
(
Şd
);

195 
	`IS_SKB
(
Ãwsk
);

197 if(!
Şd
->
li¡
)

198 
	`´štk
("insert before unlisted item!\n");

199 if(
Ãwsk
->
li¡
)

200 
	`´štk
("inserted item is‡lready on‡†ist.\n");

202 
	`§ve_æags
(
æags
);

203 
	`şi
();

204 
Ãwsk
->
li¡
=
Şd
->list;

205 
Ãwsk
->
Ãxt
=
Şd
;

206 
Ãwsk
->
´ev
=
Şd
->prev;

207 
Ãwsk
->
Ãxt
->
´ev
=newsk;

208 
Ãwsk
->
´ev
->
Ãxt
=newsk;

210 
	`»¡Üe_æags
(
æags
);

211 
	}
}

217 
	$skb_­³nd
(
sk_buff
 *
Şd
, sk_bufà*
Ãwsk
)

219 
æags
;

221 
	`IS_SKB
(
Şd
);

222 
	`IS_SKB
(
Ãwsk
);

224 if(!
Şd
->
li¡
)

225 
	`´štk
("append before unlisted item!\n");

226 if(
Ãwsk
->
li¡
)

227 
	`´štk
("append item is‡lready on‡†ist.\n");

229 
	`§ve_æags
(
æags
);

230 
	`şi
();

231 
Ãwsk
->
li¡
=
Şd
->list;

232 
Ãwsk
->
´ev
=
Şd
;

233 
Ãwsk
->
Ãxt
=
Şd
->next;

234 
Ãwsk
->
Ãxt
->
´ev
=newsk;

235 
Ãwsk
->
´ev
->
Ãxt
=newsk;

237 
	`»¡Üe_æags
(
æags
);

238 
	}
}

247 
	$skb_uÆšk
(
sk_buff
 *
skb
)

249 
æags
;

250 
	`§ve_æags
(
æags
);

251 
	`şi
();

253 
	`IS_SKB
(
skb
);

255 if(
skb
->
li¡
)

257 
skb
->
Ãxt
->
´ev
=skb->prev;

258 
skb
->
´ev
->
Ãxt
=skb->next;

259 if(*
skb
->
li¡
==skb)

261 if(
skb
->
Ãxt
==skb)

262 *
skb
->
li¡
=
NULL
;

264 *
skb
->
li¡
=skb->
Ãxt
;

266 
skb
->
Ãxt
=0;

267 
skb
->
´ev
=0;

268 
skb
->
li¡
=0;

270 
	`»¡Üe_æags
(
æags
);

271 
	}
}

279 
	$skb_Ãw_li¡_h—d
(
sk_buff
 *vŞ©e* 
li¡
)

281 
sk_buff
 *
skb
=
	`skb_³ek
(
li¡
);

282 if(
skb
!=
NULL
)

286 
	`IS_SKB
(
skb
);

287 
skb
->
li¡
=list;

288 
skb
=skb->
Ãxt
;

290 
skb
!=*
li¡
);

292 
	}
}

301 
sk_buff
 *
	$skb_³ek
(
sk_buff
 *vŞ©e* 
li¡
)

303  *
li¡
;

304 
	}
}

314 
sk_buff
 *
	$skb_³ek_cİy
(
sk_buff
 *vŞ©e* 
li¡
)

316 
sk_buff
 *
Üig
,*
Ãwsk
;

317 
æags
;

318 
Ën
;

323 
	`§ve_æags
(
æags
);

324 
	`şi
();

325 
Üig
=
	`skb_³ek
(
li¡
);

326 if(
Üig
==
NULL
)

328 
	`»¡Üe_æags
(
æags
);

329  
NULL
;

331 
	`IS_SKB
(
Üig
);

332 
Ën
=
Üig
->
Œuesize
;

333 
	`»¡Üe_æags
(
æags
);

335 
Ãwsk
=
	`®loc_skb
(
Ën
,
GFP_KERNEL
);

337 if(
Ãwsk
==
NULL
)

338  
NULL
;

340 
	`§ve_æags
(
æags
);

341 
	`şi
();

342 if(
	`skb_³ek
(
li¡
)!=
Üig
)

344 
	`»¡Üe_æags
(
æags
);

345 
Ãwsk
->
sk
=
NULL
;

346 
Ãwsk
->
ä“
=1;

347 
Ãwsk
->
mem_addr
=newsk;

348 
Ãwsk
->
mem_Ën
=
Ën
;

349 
	`kä“_skb
(
Ãwsk
, 
FREE_WRITE
);

353 
	`IS_SKB
(
Üig
);

354 
	`IS_SKB
(
Ãwsk
);

355 
	`memıy
(
Ãwsk
,
Üig
,
Ën
);

356 
Ãwsk
->
li¡
=
NULL
;

357 
Ãwsk
->
magic
=0;

358 
Ãwsk
->
Ãxt
=
NULL
;

359 
Ãwsk
->
´ev
=
NULL
;

360 
Ãwsk
->
mem_addr
=newsk;

361 
Ãwsk
->
h
.
¿w
+=((*êewsk-(*)
Üig
);

362 
Ãwsk
->
lšk3
=
NULL
;

363 
Ãwsk
->
sk
=
NULL
;

364 
Ãwsk
->
ä“
=1;

368 
	`»¡Üe_æags
(
æags
);

369 (
Ãwsk
);

370 
	}
}

377 
	$kä“_skb
(
sk_buff
 *
skb
, 
rw
)

379 ià(
skb
 =ğ
NULL
) {

380 
	`´štk
("kfree_skb: skb = NULL\n");

383 
	`IS_SKB
(
skb
);

384 if(
skb
->
lock
)

386 
skb
->
ä“
=1;

390 if(
skb
->
ä“
 == 2)

391 
	`´štk
("Warning: kfree_skb…assed‡n skbhat‚obody sethe free flag on!\n");

392 if(
skb
->
li¡
)

393 
	`´štk
("Warning: kfree_skb…assed‡n skb still on‡†ist.\n");

394 
skb
->
magic
 = 0;

395 ià(
skb
->
sk
)

397 if(
skb
->
sk
->
´Ù
!=
NULL
)

399 ià(
rw
)

400 
skb
->
sk
->
´Ù
->
	`rä“
(skb->sk, skb->
mem_addr
, skb->
mem_Ën
);

402 
skb
->
sk
->
´Ù
->
	`wä“
(skb->sk, skb->
mem_addr
, skb->
mem_Ën
);

408 ià(
rw
)

409 
skb
->
sk
->
rmem_®loc
-=skb->
mem_Ën
;

411 
skb
->
sk
->
wmem_®loc
-=skb->
mem_Ën
;

412 if(!
skb
->
sk
->
d—d
)

413 
	`wake_up_š‹¼u±ibË
(
skb
->
sk
->
¦“p
);

414 
	`kä“_skbmem
(
skb
->
mem_addr
,skb->
mem_Ën
);

418 
	`kä“_skbmem
(
skb
->
mem_addr
, skb->
mem_Ën
);

419 
	}
}

426 
sk_buff
 *
	$®loc_skb
(
size
,
´iÜ™y
)

428 
sk_buff
 *
skb
;

429 
šŒ_couÁ
;

431 ià(
šŒ_couÁ
 && 
´iÜ™y
 !ğ
GFP_ATOMIC
) {

432 
	`´štk
("alloc_skb called‚onatomically from interrupt %08lx\n",

433 ((*)&
size
)[-1]);

434 
´iÜ™y
 = 
GFP_ATOMIC
;

436 
skb
=(
sk_buff
 *)
	`km®loc
(
size
,
´iÜ™y
);

437 if(
skb
==
NULL
)

438  
NULL
;

439 
skb
->
ä“
= 2;

440 
skb
->
li¡
= 0;

441 
skb
->
lock
= 0;

442 
skb
->
Œuesize
=
size
;

443 
skb
->
mem_Ën
=
size
;

444 
skb
->
mem_addr
=skb;

445 
skb
->
äagli¡
=
NULL
;

446 
Ãt_memÜy
+=
size
;

447 
Ãt_skbcouÁ
++;

448 
skb
->
magic_debug_cook›
=
SK_GOOD_SKB
;

449 
skb
->
u£rs
=0;

450  
skb
;

451 
	}
}

457 
	$kä“_skbmem
(*
mem
,
size
)

459 
sk_buff
 *
x
=
mem
;

460 
	`IS_SKB
(
x
);

461 if(
x
->
magic_debug_cook›
==
SK_GOOD_SKB
)

463 
x
->
magic_debug_cook›
=
SK_FREED_SKB
;

464 
	`kä“_s
(
mem
,
size
);

465 
Ãt_skbcouÁ
--;

466 
Ãt_memÜy
-=
size
;

468 
	}
}

474 
	$skb_k•t_by_deviû
(
sk_buff
 *
skb
)

476 
skb
->
lock
++;

477 
	}
}

479 
	$skb_deviû_»Ëa£
(
sk_buff
 *
skb
, 
mode
)

481 
æags
;

483 
	`§ve_æags
(
æags
);

484 
	`şi
();

485 ià(!--
skb
->
lock
) {

486 ià(
skb
->
ä“
==1)

487 
	`kä“_skb
(
skb
,
mode
);

489 
	`»¡Üe_æags
(
æags
);

490 
	}
}

492 
	$skb_deviû_locked
(
sk_buff
 *
skb
)

494 if(
skb
->
lock
)

497 
	}
}

	@net/inet/skbuff.h

26 #iâdeà
_SKBUFF_H


27 
	#_SKBUFF_H


	)

28 
	~<lšux/m®loc.h
>

30 #ifdeà
CONFIG_IPX


31 
	~"x.h
"

34 
	#HAVE_ALLOC_SKB


	)

37 
	#FREE_READ
 1

	)

38 
	#FREE_WRITE
 0

	)

41 
	ssk_buff
 {

42 
	mmagic_debug_cook›
;

43 
sk_buff
 *vŞ©
	mÃxt
;

44 
sk_buff
 *vŞ©
	m´ev
;

45 
sk_buff
 *vŞ©
	mlšk3
;

46 
sk_buff
 *vŞ©e* 
	mli¡
;

47 
sock
 *
	msk
;

48 vŞ©
	mwh’
;

49 
deviû
 *
	mdev
;

50 *
	mmem_addr
;

52 
tıhdr
 *
	mth
;

53 
‘hhdr
 *
	m‘h
;

54 
hdr
 *
	mh
;

55 
udphdr
 *
	muh
;

56 
¬phdr
 *
	m¬p
;

57 *
	m¿w
;

58 
	m£q
;

59 #ifdeà
CONFIG_IPX


60 
x_·ck‘
 *
	mx
;

62 } 
	mh
;

63 
hdr
 *
	m_hdr
;

64 
	mmem_Ën
;

65 
	mËn
;

66 
	mäagËn
;

67 
sk_buff
 *
	mäagli¡
;

68 
	mŒuesize
;

69 
	m§ddr
;

70 
	mdaddr
;

71 
	mmagic
;

72 vŞ©
	macked
,

73 
	mu£d
,

74 
	mä“
,

75 
	m¬p
;

76 
	mŒ›s
,
	mlock
;

77 
	mu£rs
;

78 
	m·ddšg
[0];

79 
	md©a
[0];

82 
	#SK_WMEM_MAX
 8192

	)

83 
	#SK_RMEM_MAX
 32767

	)

85 
	#SK_FREED_SKB
 0x0DE2C0DE

	)

86 
	#SK_GOOD_SKB
 0xDEC0DED1

	)

88 
´št_skb
(
sk_buff
 *);

89 
kä“_skb
(
sk_buff
 *
skb
, 
rw
);

90 
skb_queue_h—d
(
sk_buff
 * vŞ©*
li¡
,sk_bufà*
buf
);

91 
skb_queue_
(
sk_buff
 * vŞ©*
li¡
,sk_bufà*
buf
);

92 
sk_buff
 * 
skb_dequeue
(sk_bufà* vŞ©*
li¡
);

93 
skb_š£¹
(
sk_buff
 *
Şd
,sk_bufà*
Ãwsk
);

94 
skb_­³nd
(
sk_buff
 *
Şd
,sk_bufà*
Ãwsk
);

95 
skb_uÆšk
(
sk_buff
 *
buf
);

96 
skb_Ãw_li¡_h—d
(
sk_buff
 *vŞ©e* 
li¡
);

97 
sk_buff
 * 
skb_³ek
(sk_bufà* vŞ©*
li¡
);

98 
sk_buff
 * 
skb_³ek_cİy
(sk_bufà* vŞ©*
li¡
);

99 
sk_buff
 * 
®loc_skb
(
size
, 
´iÜ™y
);

100 
kä“_skbmem
(*
mem
, 
size
);

101 
skb_k•t_by_deviû
(
sk_buff
 *
skb
);

102 
skb_deviû_»Ëa£
(
sk_buff
 *
skb
, 
mode
);

103 
skb_deviû_locked
(
sk_buff
 *
skb
);

104 
skb_check
(
sk_buff
 *
skb
,, *);

105 
	#IS_SKB
(
skb
è
	`skb_check
((skb),
__LINE__
,
__FILE__
)

	)

107 
sk_buff
 * 
skb_»cv_d©ag¿m
(
sock
 *
sk
,
æags
,
noblock
, *
”r
);

108 
d©ag¿m_£Ëù
(
sock
 *
sk
, 
£l_ty³
, 
£Ëù_bË
 *
wa™
);

109 
skb_cİy_d©ag¿m
(
sk_buff
 *
äom
, 
off£t
, *
to
,
size
);

110 
skb_ä“_d©ag¿m
(
sk_buff
 *
skb
);

	@net/inet/sock.c

65 
	~<lšux/cÚfig.h
>

66 
	~<lšux/”ºo.h
>

67 
	~<lšux/ty³s.h
>

68 
	~<lšux/sock‘.h
>

69 
	~<lšux/š.h
>

70 
	~<lšux/k”Ãl.h
>

71 
	~<lšux/majÜ.h
>

72 
	~<lšux/sched.h
>

73 
	~<lšux/tim”.h
>

74 
	~<lšux/¡ršg.h
>

75 
	~<lšux/sockios.h
>

76 
	~<lšux/Ãt.h
>

77 
	~<lšux/fú.h
>

78 
	~<lšux/mm.h
>

79 
	~<lšux/š‹¼u±.h
>

81 
	~<asm/£gm’t.h
>

82 
	~<asm/sy¡em.h
>

84 
	~"š‘.h
"

85 
	~"dev.h
"

86 
	~".h
"

87 
	~"´ÙocŞ.h
"

88 
	~"¬p.h
"

89 
	~"rou‹.h
"

90 
	~"tı.h
"

91 
	~"udp.h
"

92 
	~"skbuff.h
"

93 
	~"sock.h
"

94 
	~"¿w.h
"

95 
	~"icmp.h
"

98 
	gš‘_debug
 = 
DBG_OFF
;

101 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

103 
´Ùo
 
·ck‘_´Ù
;

107 
	$´št_sk
(
sock
 *
sk
)

109 ià(!
sk
) {

110 
	`´štk
("…rint_sk(NULL)\n");

113 
	`´štk
(" wmem_®loøğ%lu\n", 
sk
->
wmem_®loc
);

114 
	`´štk
("„mem_®loøğ%lu\n", 
sk
->
rmem_®loc
);

115 
	`´štk
(" s’d_h—d = %p\n", 
sk
->
£nd_h—d
);

116 
	`´štk
(" s‹ = %d\n",
sk
->
¡©e
);

117 
	`´štk
(" wback = %p,„queuğ%p\n", 
sk
->
wback
, sk->
rqueue
);

118 
	`´štk
(" wäÚˆğ%p\n", 
sk
->
wäÚt
);

119 
	`´štk
(" dadd¸ğ%lX, sadd¸ğ%lX\n", 
sk
->
daddr
,sk->
§ddr
);

120 
	`´štk
("‚um = %d", 
sk
->
num
);

121 
	`´štk
("‚exˆğ%p\n", 
sk
->
Ãxt
);

122 
	`´štk
(" write_seq = %ld,‡cked_seq = %ld, copied_seq = %ld\n",

123 
sk
->
wr™e_£q
, sk->
acked_£q
, sk->
cİ›d_£q
);

124 
	`´štk
("„cv_ack_seq = %ld, window_seq = %ld, fin_seq = %ld\n",

125 
sk
->
rcv_ack_£q
, sk->
wšdow_£q
, sk->
fš_£q
);

126 
	`´štk
("…rÙ = %p\n", 
sk
->
´Ù
);

127 
	`´štk
("…aœ = %p, back_log = %p\n", 
sk
->
·œ
,sk->
back_log
);

128 
	`´štk
(" inu£ = %d , blog = %d\n", 
sk
->
šu£
, sk->
blog
);

129 
	`´štk
(" d—d = %d d–ay_acks=%d\n", 
sk
->
d—d
, sk->
d–ay_acks
);

130 
	`´štk
("„‘¿nsm™ ğ%ld,imeouˆğ%d\n", 
sk
->
»Œªsm™s
, sk->
timeout
);

131 
	`´štk
(" cÚg_wšdow = %d,…ack‘s_ouˆğ%d\n", 
sk
->
cÚg_wšdow
,

132 
sk
->
·ck‘s_out
);

133 
	`´štk
(" shutdown=%d\n", 
sk
->
shutdown
);

134 
	}
}

138 
	$´št_skb
(
sk_buff
 *
skb
)

140 ià(!
skb
) {

141 
	`´štk
("…rint_skb(NULL)\n");

144 
	`´štk
("…»v = %p,‚exˆğ%p\n", 
skb
->
´ev
, skb->
Ãxt
);

145 
	`´štk
(" sk = %°lšk3 = %p\n", 
skb
->
sk
, skb->
lšk3
);

146 
	`´štk
(" mem_add¸ğ%p, mem_ËÀğ%lu\n", 
skb
->
mem_addr
, skb->
mem_Ën
);

147 
	`´štk
(" u£d = %d f»ğ%d\n", 
skb
->
u£d
,skb->
ä“
);

148 
	}
}

153 
	$sk_šu£
(
´Ùo
 *
´Ù
, 
num
)

155 
sock
 *
sk
;

157 
sk
 = 
´Ù
->
sock_¬¿y
[
num
 & (
SOCK_ARRAY_SIZE
 -1 )];

158 
sk
 !ğ
NULL
;

159 
sk
=sk->
Ãxt
) {

160 ià(
sk
->
num
 ==‚um) (1);

163 
	}
}

167 
	$g‘_Ãw_socknum
(
´Ùo
 *
´Ù
, 
ba£
)

169 
¡¬t
=0;

175 
i
, 
j
;

176 
be¡
 = 0;

177 
size
 = 32767;

178 
sock
 *
sk
;

180 ià(
ba£
 =ğ0èba£ = 
PROT_SOCK
+1+(
¡¬t
 % 1024);

181 ià(
ba£
 <ğ
PROT_SOCK
) {

182 
ba£
 +ğ
PROT_SOCK
+(
¡¬t
 % 1024);

186 
i
=0; i < 
SOCK_ARRAY_SIZE
; i++) {

187 
j
 = 0;

188 
sk
 = 
´Ù
->
sock_¬¿y
[(
i
+
ba£
+1è&(
SOCK_ARRAY_SIZE
 -1)];

189 
sk
 !ğ
NULL
) {

190 
sk
 = sk->
Ãxt
;

191 
j
++;

193 ià(
j
 == 0) {

194 
¡¬t
 =(
i
+1+start )%1024;

195 
	`DPRINTF
((
DBG_INET
, "get_new_socknum„eturning %d, start = %d\n",

196 
i
 + 
ba£
 + 1, 
¡¬t
));

197 (
i
+
ba£
+1);

199 ià(
j
 < 
size
) {

200 
be¡
 = 
i
;

201 
size
 = 
j
;

206 
	`sk_šu£
(
´Ù
, 
ba£
 +
be¡
+1)) {

207 
be¡
 +ğ
SOCK_ARRAY_SIZE
;

209 
	`DPRINTF
((
DBG_INET
, "get_new_socknum„eturning %d, start = %d\n",

210 
be¡
 + 
ba£
 + 1, 
¡¬t
));

211 (
be¡
+
ba£
+1);

212 
	}
}

216 
	$put_sock
(
num
, 
sock
 *
sk
)

218 
sock
 *
sk1
;

219 
sock
 *
sk2
;

220 
mask
;

222 
	`DPRINTF
((
DBG_INET
, "put_sockÒum = %d, sk = %X\n", 
num
, 
sk
));

223 
sk
->
num
 =‚um;

224 
sk
->
Ãxt
 = 
NULL
;

225 
num
 =‚um &(
SOCK_ARRAY_SIZE
 -1);

228 
	`şi
();

229 ià(
sk
->
´Ù
->
sock_¬¿y
[
num
] =ğ
NULL
) {

230 
sk
->
´Ù
->
sock_¬¿y
[
num
] = sk;

231 
	`¡i
();

234 
	`¡i
();

235 
mask
 = 0xff000000; mask != 0xffffffff; mask = (mask >> 8) | mask) {

236 ià((
mask
 & 
sk
->
§ddr
) &&

237 (
mask
 & 
sk
->
§ddr
) != (mask & 0xffffffff)) {

238 
mask
 = mask << 8;

242 
	`DPRINTF
((
DBG_INET
, "mask = %X\n", 
mask
));

244 
	`şi
();

245 
sk1
 = 
sk
->
´Ù
->
sock_¬¿y
[
num
];

246 
sk2
 = 
sk1
; sk2 !ğ
NULL
; sk2=sk2->
Ãxt
) {

247 ià(!(
sk2
->
§ddr
 & 
mask
)) {

248 ià(
sk2
 =ğ
sk1
) {

249 
sk
->
Ãxt
 = sk->
´Ù
->
sock_¬¿y
[
num
];

250 
sk
->
´Ù
->
sock_¬¿y
[
num
] = sk;

251 
	`¡i
();

254 
sk
->
Ãxt
 = 
sk2
;

255 
sk1
->
Ãxt
ğ
sk
;

256 
	`¡i
();

259 
sk1
 = 
sk2
;

263 
sk
->
Ãxt
 = 
NULL
;

264 
sk1
->
Ãxt
 = 
sk
;

265 
	`¡i
();

266 
	}
}

270 
	$»move_sock
(
sock
 *
sk1
)

272 
sock
 *
sk2
;

274 
	`DPRINTF
((
DBG_INET
, "»move_sock(sk1=%X)\n", 
sk1
));

275 ià(!
sk1
) {

276 
	`´štk
("sock.c:„emove_sock: sk1 == NULL\n");

280 ià(!
sk1
->
´Ù
) {

281 
	`´štk
("sock.c:„emove_sock: sk1->prot == NULL\n");

286 
	`şi
();

287 
sk2
 = 
sk1
->
´Ù
->
sock_¬¿y
[sk1->
num
 &(
SOCK_ARRAY_SIZE
 -1)];

288 ià(
sk2
 =ğ
sk1
) {

289 
sk1
->
´Ù
->
sock_¬¿y
[sk1->
num
 &(
SOCK_ARRAY_SIZE
 -1)] = sk1->
Ãxt
;

290 
	`¡i
();

294 
sk2
 && sk2->
Ãxt
 !ğ
sk1
) {

295 
sk2
 = sk2->
Ãxt
;

298 ià(
sk2
) {

299 
sk2
->
Ãxt
 = 
sk1
->next;

300 
	`¡i
();

303 
	`¡i
();

305 ià(
sk1
->
num
 !ğ0è
	`DPRINTF
((
DBG_INET
, "remove_sock: sock‚ot found.\n"));

306 
	}
}

310 
	$de¡roy_sock
(
sock
 *
sk
)

312 
sk_buff
 *
skb
;

314 
	`DPRINTF
((
DBG_INET
, "de¡royšg sock‘ %X\n", 
sk
));

315 
sk
->
šu£
 = 1;

318 ià(!
sk
->
d—d
)

319 
sk
->
	`wr™e_¥aû
(sk);

321 
	`»move_sock
(
sk
);

324 
	`d–‘e_tim”
(
sk
);

327 (
skb
 = 
	`tı_dequeue_·¹Ÿl
(
sk
)è!ğ
NULL
)

329 
	`IS_SKB
(
skb
);

330 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

334 
skb
 = 
sk
->
wäÚt
; skb !ğ
NULL
; )

336 
sk_buff
 *
skb2
;

338 
skb2
=(
sk_buff
 *)
skb
->
Ãxt
;

339 ià(
skb
->
magic
 !ğ
TCP_WRITE_QUEUE_MAGIC
) {

340 
	`´štk
("sock.c:destroy_sock write queue with bad magic(%X)\n",

341 
skb
->
magic
);

344 
	`IS_SKB
(
skb
);

345 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

346 
skb
 = 
skb2
;

349 
sk
->
wäÚt
 = 
NULL
;

350 
sk
->
wback
 = 
NULL
;

352 ià(
sk
->
rqueue
 !ğ
NULL
)

354 (
skb
=
	`skb_dequeue
(&
sk
->
rqueue
))!=
NULL
)

360 ià(
skb
->
sk
 !ğ
NULL
 && skb->sk != sk)

362 
	`IS_SKB
(
skb
);

363 
skb
->
sk
->
d—d
 = 1;

364 
skb
->
sk
->
´Ù
->
	`şo£
(skb->sk, 0);

366 
	`IS_SKB
(
skb
);

367 
	`kä“_skb
(
skb
, 
FREE_READ
);

370 
sk
->
rqueue
 = 
NULL
;

373 
skb
 = 
sk
->
£nd_h—d
; skb !ğ
NULL
; )

375 
sk_buff
 *
skb2
;

381 
	`şi
();

385 ià(
skb
->
Ãxt
 !ğ
NULL
)

387 
	`IS_SKB
(
skb
);

388 
	`skb_uÆšk
(
skb
);

390 
skb
->
dev
 = 
NULL
;

391 
	`¡i
();

392 
skb2
 = (
sk_buff
 *)
skb
->
lšk3
;

393 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

394 
skb
 = 
skb2
;

396 
sk
->
£nd_h—d
 = 
NULL
;

399 ià(
sk
->
back_log
 !ğ
NULL
)

402 
	`´štk
("cleaning back_log. \n");

403 
	`şi
();

404 
skb
 = (
sk_buff
 *)
sk
->
back_log
;

407 
sk_buff
 *
skb2
;

409 
skb2
 = (
sk_buff
 *)
skb
->
Ãxt
;

410 
	`kä“_skb
(
skb
, 
FREE_READ
);

411 
skb
 = 
skb2
;

413 
skb
 !ğ
sk
->
back_log
);

414 
	`¡i
();

416 
sk
->
back_log
 = 
NULL
;

419 ià(
sk
->
·œ
)

421 
sk
->
·œ
->
d—d
 = 1;

422 
sk
->
·œ
->
´Ù
->
	`şo£
(sk->pair, 0);

423 
sk
->
·œ
 = 
NULL
;

431 ià(
sk
->
rmem_®loc
 =ğ0 && sk->
wmem_®loc
 == 0)

433 
	`kä“_s
((*)
sk
,(*sk));

439 
	`DPRINTF
((
DBG_INET
, "possibË memÜy†—k iÀsock‘ = %X\n", 
sk
));

440 
sk
->
de¡roy
 = 1;

441 
sk
->
ack_backlog
 = 0;

442 
sk
->
šu£
 = 0;

443 
	`»£t_tim”
(
sk
, 
TIME_DESTROY
, 
SOCK_DESTROY_TIME
);

445 
	`DPRINTF
((
DBG_INET
, "leaving destroy_sock\n"));

446 
	}
}

450 
	$š‘_fú
(
sock‘
 *
sock
, 
cmd
, 
¬g
)

452 
sock
 *
sk
;

454 
sk
 = (
sock
 *èsock->
d©a
;

455 ià(
sk
 =ğ
NULL
) {

456 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

460 
cmd
) {

461 
F_SETOWN
:

467 ià(!
	`su£r
(è&& 
cu¼’t
->
pg½
 !ğ-
¬g
 &&

468 
cu¼’t
->
pid
 !ğ
¬g
è(-
EPERM
);

469 
sk
->
´oc
 = 
¬g
;

471 
F_GETOWN
:

472 (
sk
->
´oc
);

474 (-
EINVAL
);

476 
	}
}

482 
	$š‘_£tsockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

483 *
İtv®
, 
İ’
)

485 
sock
 *
sk
 = (sock *èsock->
d©a
;

486 ià(
Ëv–
 =ğ
SOL_SOCKET
)

487  
	`sock_£tsockİt
(
sk
,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

488 ià(
sk
->
´Ù
->
£tsockİt
==
NULL
)

489 (-
EOPNOTSUPP
);

491  
sk
->
´Ù
->
	`£tsockİt
(sk,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

492 
	}
}

497 
	$š‘_g‘sockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

498 *
İtv®
, *
İ’
)

500 
sock
 *
sk
 = (sock *èsock->
d©a
;

501 ià(
Ëv–
 =ğ
SOL_SOCKET
)

502  
	`sock_g‘sockİt
(
sk
,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

503 if(
sk
->
´Ù
->
g‘sockİt
==
NULL
)

504 (-
EOPNOTSUPP
);

506  
sk
->
´Ù
->
	`g‘sockİt
(sk,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

507 
	}
}

514 
	$sock_£tsockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
,

515 *
İtv®
, 
İ’
)

517 
v®
;

518 
”r
;

519 
lšg”
 
lšg
;

521 ià(
İtv®
 =ğ
NULL
)

522 (-
EINVAL
);

524 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
İtv®
, ());

525 if(
”r
)

526  
”r
;

528 
v®
 = 
	`g‘_fs_lÚg
((*)
İtv®
);

529 
İŠame
)

531 
SO_TYPE
:

532 
SO_ERROR
:

533 (-
ENOPROTOOPT
);

535 
SO_DEBUG
:

536 
sk
->
debug
=
v®
?1:0;

537 
SO_DONTROUTE
:

539 
SO_BROADCAST
:

540 
sk
->
brßdÿ¡
=
v®
?1:0;

542 
SO_SNDBUF
:

543 if(
v®
>32767)

544 
v®
=32767;

545 if(
v®
<256)

546 
v®
=256;

547 
sk
->
¢dbuf
=
v®
;

549 
SO_LINGER
:

550 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,
İtv®
,(
lšg
));

551 if(
”r
)

552  
”r
;

553 
	`memıy_äomfs
(&
lšg
,
İtv®
,(ling));

554 if(
lšg
.
l_Úoff
==0)

555 
sk
->
lšg”
=0;

558 
sk
->
lšg”time
=
lšg
.
l_lšg”
;

559 
sk
->
lšg”
=1;

562 
SO_RCVBUF
:

563 if(
v®
>32767)

564 
v®
=32767;

565 if(
v®
<256)

566 
v®
=256;

567 
sk
->
rcvbuf
=
v®
;

570 
SO_REUSEADDR
:

571 ià(
v®
)

572 
sk
->
»u£
 = 1;

574 
sk
->
»u£
 = 0;

577 
SO_KEEPALIVE
:

578 ià(
v®
)

579 
sk
->
k“pİ’
 = 1;

581 
sk
->
k“pİ’
 = 0;

584 
SO_OOBINLINE
:

585 ià(
v®
)

586 
sk
->
urgšlše
 = 1;

588 
sk
->
urgšlše
 = 0;

591 
SO_NO_CHECK
:

592 ià(
v®
)

593 
sk
->
no_check
 = 1;

595 
sk
->
no_check
 = 0;

598 
SO_PRIORITY
:

599 ià(
v®
 >ğ0 && v® < 
DEV_NUMBUFFS
)

601 
sk
->
´iÜ™y
 = 
v®
;

605 (-
EINVAL
);

610 (-
ENOPROTOOPT
);

612 
	}
}

615 
	$sock_g‘sockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
,

616 *
İtv®
, *
İ’
)

618 
v®
;

619 
”r
;

620 
lšg”
 
lšg
;

622 
İŠame
)

624 
SO_DEBUG
:

625 
v®
 = 
sk
->
debug
;

628 
SO_DONTROUTE
:

629 
v®
 = 0;

632 
SO_BROADCAST
:

633 
v®
ğ
sk
->
brßdÿ¡
;

636 
SO_LINGER
:

637 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
İtv®
,(
lšg
));

638 if(
”r
)

639  
”r
;

640 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,
İ’
,());

641 if(
”r
)

642  
”r
;

643 
	`put_fs_lÚg
((
lšg
),(*)
İ’
);

644 
lšg
.
l_Úoff
=
sk
->
lšg”
;

645 
lšg
.
l_lšg”
=
sk
->
lšg”time
;

646 
	`memıy_tofs
(
İtv®
,&
lšg
,(ling));

649 
SO_SNDBUF
:

650 
v®
=
sk
->
¢dbuf
;

653 
SO_RCVBUF
:

654 
v®
 =
sk
->
rcvbuf
;

657 
SO_REUSEADDR
:

658 
v®
 = 
sk
->
»u£
;

661 
SO_KEEPALIVE
:

662 
v®
 = 
sk
->
k“pİ’
;

665 
SO_TYPE
:

666 ià(
sk
->
´Ù
 =ğ&
tı_´Ù
)

667 
v®
 = 
SOCK_STREAM
;

669 
v®
 = 
SOCK_DGRAM
;

672 
SO_ERROR
:

673 
v®
 = 
sk
->
”r
;

674 
sk
->
”r
 = 0;

677 
SO_OOBINLINE
:

678 
v®
 = 
sk
->
urgšlše
;

681 
SO_NO_CHECK
:

682 
v®
 = 
sk
->
no_check
;

685 
SO_PRIORITY
:

686 
v®
 = 
sk
->
´iÜ™y
;

690 (-
ENOPROTOOPT
);

692 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İ’
, ());

693 if(
”r
)

694  
”r
;

695 
	`put_fs_lÚg
((),(*è
İ’
);

697 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İtv®
, ());

698 if(
”r
)

699  
”r
;

700 
	`put_fs_lÚg
(
v®
,(*)
İtv®
);

703 
	}
}

709 
	$š‘_li¡’
(
sock‘
 *
sock
, 
backlog
)

711 
sock
 *
sk
;

713 
sk
 = (
sock
 *èsock->
d©a
;

714 ià(
sk
 =ğ
NULL
) {

715 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

720 ià(
sk
->
num
 == 0) {

721 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

722 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

723 
	`put_sock
(
sk
->
num
, sk);

724 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

728 
sk
->
max_ack_backlog
 = 
backlog
;

729 ià(
sk
->
¡©e
 !ğ
TCP_LISTEN
) {

730 
sk
->
ack_backlog
 = 0;

731 
sk
->
¡©e
 = 
TCP_LISTEN
;

734 
	}
}

741 
	$def_ÿÎback1
(
sock
 *
sk
)

743 if(!
sk
->
d—d
)

744 
	`wake_up_š‹¼u±ibË
(
sk
->
¦“p
);

745 
	}
}

747 
	$def_ÿÎback2
(
sock
 *
sk
,
Ën
)

749 if(!
sk
->
d—d
)

750 
	`wake_up_š‹¼u±ibË
(
sk
->
¦“p
);

751 
	}
}

755 
	$š‘_ü—‹
(
sock‘
 *
sock
, 
´ÙocŞ
)

757 
sock
 *
sk
;

758 
´Ùo
 *
´Ù
;

759 
”r
;

761 
sk
 = (
sock
 *è
	`km®loc
((*sk), 
GFP_KERNEL
);

762 ià(
sk
 =ğ
NULL
)

763 (-
ENOMEM
);

764 
sk
->
num
 = 0;

765 
sk
->
»u£
 = 0;

766 
sock
->
ty³
) {

767 
SOCK_STREAM
:

768 
SOCK_SEQPACKET
:

769 ià(
´ÙocŞ
 &&…rÙocŞ !ğ
IPPROTO_TCP
) {

770 
	`kä“_s
((*)
sk
, (*sk));

771 (-
EPROTONOSUPPORT
);

773 
´ÙocŞ
 = 
IPPROTO_TCP
;

774 
sk
->
no_check
 = 
TCP_NO_CHECK
;

775 
´Ù
 = &
tı_´Ù
;

778 
SOCK_DGRAM
:

779 ià(
´ÙocŞ
 &&…rÙocŞ !ğ
IPPROTO_UDP
) {

780 
	`kä“_s
((*)
sk
, (*sk));

781 (-
EPROTONOSUPPORT
);

783 
´ÙocŞ
 = 
IPPROTO_UDP
;

784 
sk
->
no_check
 = 
UDP_NO_CHECK
;

785 
´Ù
=&
udp_´Ù
;

788 
SOCK_RAW
:

789 ià(!
	`su£r
()) {

790 
	`kä“_s
((*)
sk
, (*sk));

791 (-
EPERM
);

793 ià(!
´ÙocŞ
) {

794 
	`kä“_s
((*)
sk
, (*sk));

795 (-
EPROTONOSUPPORT
);

797 
´Ù
 = &
¿w_´Ù
;

798 
sk
->
»u£
 = 1;

799 
sk
->
no_check
 = 0;

803 
sk
->
num
 = 
´ÙocŞ
;

806 
SOCK_PACKET
:

807 ià(!
	`su£r
()) {

808 
	`kä“_s
((*)
sk
, (*sk));

809 (-
EPERM
);

811 ià(!
´ÙocŞ
) {

812 
	`kä“_s
((*)
sk
, (*sk));

813 (-
EPROTONOSUPPORT
);

815 
´Ù
 = &
·ck‘_´Ù
;

816 
sk
->
»u£
 = 1;

817 
sk
->
no_check
 = 0;

820 
sk
->
num
 = 
´ÙocŞ
;

824 
	`kä“_s
((*)
sk
, (*sk));

825 (-
ESOCKTNOSUPPORT
);

827 
sk
->
sock‘
 = 
sock
;

828 #ifdeà
CONFIG_TCP_NAGLE_OFF


829 
sk
->
nÚagË
 = 1;

831 
sk
->
nÚagË
 = 0;

833 
sk
->
ty³
 = 
sock
->type;

834 
sk
->
´ÙocŞ
 =…rotocol;

835 
sk
->
wmem_®loc
 = 0;

836 
sk
->
rmem_®loc
 = 0;

837 
sk
->
¢dbuf
 = 
SK_WMEM_MAX
;

838 
sk
->
rcvbuf
 = 
SK_RMEM_MAX
;

839 
sk
->
·œ
 = 
NULL
;

840 
sk
->
İt
 = 
NULL
;

841 
sk
->
wr™e_£q
 = 0;

842 
sk
->
acked_£q
 = 0;

843 
sk
->
cİ›d_£q
 = 0;

844 
sk
->
fš_£q
 = 0;

845 
sk
->
urg_£q
 = 0;

846 
sk
->
urg_d©a
 = 0;

847 
sk
->
´oc
 = 0;

848 
sk
->
¹t
 = 
TCP_WRITE_TIME
 << 3;

849 
sk
->
¹o
 = 
TCP_WRITE_TIME
;

850 
sk
->
mdev
 = 0;

851 
sk
->
backoff
 = 0;

852 
sk
->
·ck‘s_out
 = 0;

853 
sk
->
cÚg_wšdow
 = 1;

854 
sk
->
cÚg_couÁ
 = 0;

855 
sk
->
s¡h»sh
 = 0;

856 
sk
->
max_wšdow
 = 0;

857 
sk
->
urgšlše
 = 0;

858 
sk
->
šŒ
 = 0;

859 
sk
->
lšg”
 = 0;

860 
sk
->
de¡roy
 = 0;

862 
sk
->
´iÜ™y
 = 1;

863 
sk
->
shutdown
 = 0;

864 
sk
->
k“pİ’
 = 0;

865 
sk
->
z­³d
 = 0;

866 
sk
->
dÚe
 = 0;

867 
sk
->
ack_backlog
 = 0;

868 
sk
->
wšdow
 = 0;

869 
sk
->
by‹s_rcv
 = 0;

870 
sk
->
¡©e
 = 
TCP_CLOSE
;

871 
sk
->
d—d
 = 0;

872 
sk
->
ack_timed
 = 0;

873 
sk
->
·¹Ÿl
 = 
NULL
;

874 
sk
->
u£r_mss
 = 0;

875 
sk
->
debug
 = 0;

878 
sk
->
max_uÇcked
 = 2048;

882 
sk
->
max_ack_backlog
 = 0;

883 
sk
->
šu£
 = 0;

884 
sk
->
d–ay_acks
 = 0;

885 
sk
->
wback
 = 
NULL
;

886 
sk
->
wäÚt
 = 
NULL
;

887 
sk
->
rqueue
 = 
NULL
;

888 
sk
->
mtu
 = 576;

889 
sk
->
´Ù
 =…rot;

890 
sk
->
¦“p
 = 
sock
->
wa™
;

891 
sk
->
daddr
 = 0;

892 
sk
->
§ddr
 = 
	`my_addr
();

893 
sk
->
”r
 = 0;

894 
sk
->
Ãxt
 = 
NULL
;

895 
sk
->
·œ
 = 
NULL
;

896 
sk
->
£nd_
 = 
NULL
;

897 
sk
->
£nd_h—d
 = 
NULL
;

898 
sk
->
timeout
 = 0;

899 
sk
->
brßdÿ¡
 = 0;

900 
sk
->
tim”
.
d©a
 = ()sk;

901 
sk
->
tim”
.
funùiÚ
 = &
Ãt_tim”
;

902 
sk
->
back_log
 = 
NULL
;

903 
sk
->
blog
 = 0;

904 
sock
->
d©a
 =(*è
sk
;

905 
sk
->
dummy_th
.
doff
 = (sk->dummy_th)/4;

906 
sk
->
dummy_th
.
»s1
=0;

907 
sk
->
dummy_th
.
»s2
=0;

908 
sk
->
dummy_th
.
urg_±r
 = 0;

909 
sk
->
dummy_th
.
fš
 = 0;

910 
sk
->
dummy_th
.
syn
 = 0;

911 
sk
->
dummy_th
.
r¡
 = 0;

912 
sk
->
dummy_th
.
psh
 = 0;

913 
sk
->
dummy_th
.
ack
 = 0;

914 
sk
->
dummy_th
.
urg
 = 0;

915 
sk
->
dummy_th
.
de¡
 = 0;

917 
sk
->
_tos
=0;

918 
sk
->
_‰l
=64;

920 
sk
->
¡©e_chªge
 = 
def_ÿÎback1
;

921 
sk
->
d©a_»ady
 = 
def_ÿÎback2
;

922 
sk
->
wr™e_¥aû
 = 
def_ÿÎback1
;

923 
sk
->
”rÜ_»pÜt
 = 
def_ÿÎback1
;

925 ià(
sk
->
num
) {

932 
	`put_sock
(
sk
->
num
, sk);

933 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

936 ià(
sk
->
´Ù
->
š™
) {

937 
”r
 = 
sk
->
´Ù
->
	`š™
(sk);

938 ià(
”r
 != 0) {

939 
	`de¡roy_sock
(
sk
);

940 (
”r
);

944 
	}
}

948 
	$š‘_dup
(
sock‘
 *
Ãwsock
, sock‘ *
Şdsock
)

950 (
	`š‘_ü—‹
(
Ãwsock
,

951 ((
sock
 *)(
Şdsock
->
d©a
))->
´ÙocŞ
));

952 
	}
}

957 
	$š‘_»Ëa£
(
sock‘
 *
sock
, sock‘ *
³”
)

959 
sock
 *
sk
;

961 
sk
 = (
sock
 *èsock->
d©a
;

962 ià(
sk
 =ğ
NULL
) (0);

964 
	`DPRINTF
((
DBG_INET
, "š‘_»Ëa£(sock = %X,…“¸ğ%X)\n", 
sock
, 
³”
));

965 
sk
->
	`¡©e_chªge
(sk);

973 ià(
sk
->
lšg”
 == 0) {

974 
sk
->
´Ù
->
	`şo£
(sk,0);

975 
sk
->
d—d
 = 1;

977 
	`DPRINTF
((
DBG_INET
, "sk->linger set.\n"));

978 
sk
->
´Ù
->
	`şo£
(sk, 0);

979 
	`şi
();

980 ià(
sk
->
lšg”time
)

981 
cu¼’t
->
timeout
 = 
jiff›s
 + 
HZ
*
sk
->
lšg”time
;

982 
sk
->
¡©e
 !ğ
TCP_CLOSE
 && 
cu¼’t
->
timeout
>0) {

983 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

984 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

988 
	`¡i
();

989 
cu¼’t
->
timeout
=0;

990 (-
ERESTARTSYS
);

994 
cu¼’t
->
timeout
=0;

995 
	`¡i
();

996 
sk
->
d—d
 = 1;

998 
sk
->
šu£
 = 1;

1001 
	`»Ëa£_sock
(
sk
);

1002 
sock
->
d©a
 = 
NULL
;

1003 
	`DPRINTF
((
DBG_INET
, "inet_release„eturning\n"));

1005 
	}
}

1013 
	$š‘_bšd
(
sock‘
 *
sock
, 
sockaddr
 *
uaddr
,

1014 
addr_Ën
)

1016 
sockaddr_š
 
addr
;

1017 
sock
 *
sk
, *
sk2
;

1018 
¢um
;

1019 
”r
;

1021 
sk
 = (
sock
 *èsock->
d©a
;

1022 ià(
sk
 =ğ
NULL
) {

1023 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1028 ià(
sk
->
¡©e
 !ğ
TCP_CLOSE
è(-
EIO
);

1029 ià(
sk
->
num
 !ğ0è(-
EINVAL
);

1031 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
uaddr
, 
addr_Ën
);

1032 if(
”r
)

1033  
”r
;

1034 
	`memıy_äomfs
(&
addr
, 
uaddr
, 
	`mš
(×ddr), 
addr_Ën
));

1036 
¢um
 = 
	`Áohs
(
addr
.
sš_pÜt
);

1037 
	`DPRINTF
((
DBG_INET
, "bšd sk =%XØpÜˆğ%d\n", 
sk
, 
¢um
));

1038 
sk
 = (
sock
 *èsock->
d©a
;

1045 ià(
¢um
 == 0) {

1046 
¢um
 = 
	`g‘_Ãw_socknum
(
sk
->
´Ù
, 0);

1048 ià(
¢um
 < 
PROT_SOCK
 && !
	`su£r
()è(-
EACCES
);

1050 ià(
addr
.
sš_addr
.
s_addr
!=0 && 
	`chk_addr
×ddr.sš_addr.s_addr)!=
IS_MYADDR
)

1051 (-
EADDRNOTAVAIL
);

1053 ià(
	`chk_addr
(
addr
.
sš_addr
.
s_addr
) ||‡ddr.sin_addr.s_addr == 0)

1054 
sk
->
§ddr
 = 
addr
.
sš_addr
.
s_addr
;

1056 
	`DPRINTF
((
DBG_INET
, "sock_¬¿y[%d] = %X:\n", 
¢um
 &(
SOCK_ARRAY_SIZE
 -1),

1057 
sk
->
´Ù
->
sock_¬¿y
[
¢um
 &(
SOCK_ARRAY_SIZE
 -1)]));

1060 
	`şi
();

1061 
outside_loİ
:

1062 
sk2
 = 
sk
->
´Ù
->
sock_¬¿y
[
¢um
 & (
SOCK_ARRAY_SIZE
 -1)];

1063 
sk2
 !ğ
NULL
; sk2 = sk2->
Ãxt
) {

1065 ià(
sk2
->
num
 !ğ
¢um
) ;

1068 ià(
sk2
->
d—d
) {

1069 
	`de¡roy_sock
(
sk2
);

1070 
outside_loİ
;

1072 ià(!
sk
->
»u£
) {

1073 
	`¡i
();

1074 (-
EADDRINUSE
);

1076 ià(
sk2
->
num
 !ğ
¢um
) ;

1077 ià(
sk2
->
§ddr
 !ğ
sk
->saddr) ;

1078 ià(!
sk2
->
»u£
) {

1079 
	`¡i
();

1080 (-
EADDRINUSE
);

1083 
	`¡i
();

1085 
	`»move_sock
(
sk
);

1086 
	`put_sock
(
¢um
, 
sk
);

1087 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1088 
sk
->
daddr
 = 0;

1089 
sk
->
dummy_th
.
de¡
 = 0;

1091 
	}
}

1095 
	$š‘_cÚÃù
(
sock‘
 *
sock
, 
sockaddr
 * 
uaddr
,

1096 
addr_Ën
, 
æags
)

1098 
sock
 *
sk
;

1099 
”r
;

1101 
sock
->
cÚn
 = 
NULL
;

1102 
sk
 = (
sock
 *èsock->
d©a
;

1103 ià(
sk
 =ğ
NULL
) {

1104 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1108 ià(
sock
->
¡©e
 =ğ
SS_CONNECTING
 && 
sk
->¡©=ğ
TCP_ESTABLISHED
)

1110 
sock
->
¡©e
 = 
SS_CONNECTED
;

1115 ià(
sock
->
¡©e
 =ğ
SS_CONNECTING
 && 
sk
->
´ÙocŞ
 =ğ
IPPROTO_TCP
 &&

1116 (
æags
 & 
O_NONBLOCK
))

1117  -
EALREADY
;

1119 ià(
sock
->
¡©e
 !ğ
SS_CONNECTING
) {

1121 ià(
sk
->
num
 == 0) {

1122 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1123 ià(
sk
->
num
 == 0)

1124 (-
EAGAIN
);

1125 
	`put_sock
(
sk
->
num
, sk);

1126 
sk
->
dummy_th
.
sourû
 = 
	`htÚs
(sk->
num
);

1129 ià(
sk
->
´Ù
->
cÚÃù
 =ğ
NULL
)

1130 (-
EOPNOTSUPP
);

1132 
”r
 = 
sk
->
´Ù
->
	`cÚÃù
(sk, (
sockaddr_š
 *)
uaddr
, 
addr_Ën
);

1133 ià(
”r
 < 0) (err);

1135 
sock
->
¡©e
 = 
SS_CONNECTING
;

1138 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 &&(
æags
 & 
O_NONBLOCK
))

1139 (-
EINPROGRESS
);

1141 
	`şi
();

1142 
sk
->
¡©e
 =ğ
TCP_SYN_SENT
 || sk->¡©=ğ
TCP_SYN_RECV
)

1144 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

1145 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1146 
	`¡i
();

1147 (-
ERESTARTSYS
);

1151 if(
sk
->
”r
 && sk->
´ÙocŞ
 =ğ
IPPROTO_TCP
)

1153 
	`¡i
();

1154 
sock
->
¡©e
 = 
SS_UNCONNECTED
;

1155 
”r
 = -
sk
->err;

1156 
sk
->
”r
=0;

1157  
”r
;

1160 
	`¡i
();

1161 
sock
->
¡©e
 = 
SS_CONNECTED
;

1163 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->
”r
) {

1164 
sock
->
¡©e
 = 
SS_UNCONNECTED
;

1165 
”r
=
sk
->err;

1166 
sk
->
”r
=0;

1167 (-
”r
);

1170 
	}
}

1174 
	$š‘_sock‘·œ
(
sock‘
 *
sock1
, sock‘ *
sock2
)

1176 (-
EOPNOTSUPP
);

1177 
	}
}

1181 
	$š‘_acû±
(
sock‘
 *
sock
, sock‘ *
Ãwsock
, 
æags
)

1183 
sock
 *
sk1
, *
sk2
;

1184 
”r
;

1186 
sk1
 = (
sock
 *èsock->
d©a
;

1187 ià(
sk1
 =ğ
NULL
) {

1188 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1197 ià(
Ãwsock
->
d©a
è
	`kä“_s
Òewsock->d©a, (
sock
));

1198 
Ãwsock
->
d©a
 = 
NULL
;

1200 ià(
sk1
->
´Ù
->
acû±
 =ğ
NULL
è(-
EOPNOTSUPP
);

1203 ià(
sk1
->
·œ
 !ğ
NULL
 ) {

1204 
sk2
 = 
sk1
->
·œ
;

1205 
sk1
->
·œ
 = 
NULL
;

1207 
sk2
 = 
sk1
->
´Ù
->
	`acû±
(sk1,
æags
);

1208 ià(
sk2
 =ğ
NULL
) {

1209 ià(
sk1
->
”r
 <= 0)

1210 
	`´štk
("Warning sock.c:sk1->err <= 0. Returning‚on-error.\n");

1211 
”r
=
sk1
->err;

1212 
sk1
->
”r
=0;

1213 (-
”r
);

1216 
Ãwsock
->
d©a
 = (*)
sk2
;

1217 
sk2
->
¦“p
 = 
Ãwsock
->
wa™
;

1218 
Ãwsock
->
cÚn
 = 
NULL
;

1219 ià(
æags
 & 
O_NONBLOCK
) (0);

1221 
	`şi
();

1222 
sk2
->
¡©e
 =ğ
TCP_SYN_RECV
) {

1223 
	`š‹¼u±ibË_¦“p_Ú
(
sk2
->
¦“p
);

1224 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1225 
	`¡i
();

1226 
sk1
->
·œ
 = 
sk2
;

1227 
sk2
->
¦“p
 = 
NULL
;

1228 
Ãwsock
->
d©a
 = 
NULL
;

1229 (-
ERESTARTSYS
);

1232 
	`¡i
();

1234 ià(
sk2
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk2->
”r
 > 0) {

1236 
”r
 = -
sk2
->err;

1237 
sk2
->
”r
=0;

1238 
	`de¡roy_sock
(
sk2
);

1239 
Ãwsock
->
d©a
 = 
NULL
;

1240 (
”r
);

1242 
Ãwsock
->
¡©e
 = 
SS_CONNECTED
;

1244 
	}
}

1248 
	$š‘_g‘Çme
(
sock‘
 *
sock
, 
sockaddr
 *
uaddr
,

1249 *
uaddr_Ën
, 
³”
)

1251 
sockaddr_š
 
sš
;

1252 
sock
 *
sk
;

1253 
Ën
;

1254 
”r
;

1257 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
uaddr_Ën
,());

1258 if(
”r
)

1259  
”r
;

1261 
Ën
=
	`g‘_fs_lÚg
(
uaddr_Ën
);

1263 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
uaddr
, 
Ën
);

1264 if(
”r
)

1265  
”r
;

1268 ià(
Ën
 < (
sš
)è(-
EINVAL
);

1270 
sš
.
sš_çmy
 = 
AF_INET
;

1271 
sk
 = (
sock
 *èsock->
d©a
;

1272 ià(
sk
 =ğ
NULL
) {

1273 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1276 ià(
³”
) {

1277 ià(!
	`tı_cÚÃùed
(
sk
->
¡©e
)è(-
ENOTCONN
);

1278 
sš
.
sš_pÜt
 = 
sk
->
dummy_th
.
de¡
;

1279 
sš
.
sš_addr
.
s_addr
 = 
sk
->
daddr
;

1281 
sš
.
sš_pÜt
 = 
sk
->
dummy_th
.
sourû
;

1282 ià(
sk
->
§ddr
 =ğ0è
sš
.
sš_addr
.
s_addr
 = 
	`my_addr
();

1283 
sš
.
sš_addr
.
s_addr
 = 
sk
->
§ddr
;

1285 
Ën
 = (
sš
);

1287 
	`memıy_tofs
(
uaddr
, &
sš
, (sin));

1289 
	`put_fs_lÚg
(
Ën
, 
uaddr_Ën
);

1291 
	}
}

1295 
	$š‘_»ad
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
)

1297 
sock
 *
sk
;

1299 
sk
 = (
sock
 *èsock->
d©a
;

1300 ià(
sk
 =ğ
NULL
) {

1301 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1306 ià(
sk
->
num
 == 0) {

1307 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1308 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1309 
	`put_sock
(
sk
->
num
, sk);

1310 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1312 (
sk
->
´Ù
->
	`»ad
(sk, (*è
ubuf
, 
size
, 
noblock
,0));

1313 
	}
}

1317 
	$š‘_»cv
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
,

1318 
æags
)

1320 
sock
 *
sk
;

1322 
sk
 = (
sock
 *èsock->
d©a
;

1323 ià(
sk
 =ğ
NULL
) {

1324 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1329 ià(
sk
->
num
 == 0) {

1330 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1331 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1332 
	`put_sock
(
sk
->
num
, sk);

1333 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1335 (
sk
->
´Ù
->
	`»ad
(sk, (*è
ubuf
, 
size
, 
noblock
, 
æags
));

1336 
	}
}

1340 
	$š‘_wr™e
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
)

1342 
sock
 *
sk
;

1344 
sk
 = (
sock
 *èsock->
d©a
;

1345 ià(
sk
 =ğ
NULL
) {

1346 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1349 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) {

1350 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

1351 (-
EPIPE
);

1355 ià(
sk
->
num
 == 0) {

1356 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1357 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1358 
	`put_sock
(
sk
->
num
, sk);

1359 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1362 (
sk
->
´Ù
->
	`wr™e
(sk, (*è
ubuf
, 
size
, 
noblock
, 0));

1363 
	}
}

1367 
	$š‘_£nd
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
,

1368 
æags
)

1370 
sock
 *
sk
;

1372 
sk
 = (
sock
 *èsock->
d©a
;

1373 ià(
sk
 =ğ
NULL
) {

1374 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1377 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) {

1378 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

1379 (-
EPIPE
);

1383 ià(
sk
->
num
 == 0) {

1384 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1385 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1386 
	`put_sock
(
sk
->
num
, sk);

1387 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1390 (
sk
->
´Ù
->
	`wr™e
(sk, (*è
ubuf
, 
size
, 
noblock
, 
æags
));

1391 
	}
}

1395 
	$š‘_£ndto
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
,

1396 
æags
, 
sockaddr
 *
sš
, 
addr_Ën
)

1398 
sock
 *
sk
;

1400 
sk
 = (
sock
 *èsock->
d©a
;

1401 ià(
sk
 =ğ
NULL
) {

1402 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1405 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) {

1406 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

1407 (-
EPIPE
);

1410 ià(
sk
->
´Ù
->
£ndto
 =ğ
NULL
è(-
EOPNOTSUPP
);

1413 ià(
sk
->
num
 == 0) {

1414 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1415 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1416 
	`put_sock
(
sk
->
num
, sk);

1417 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1420 (
sk
->
´Ù
->
	`£ndto
(sk, (*è
ubuf
, 
size
, 
noblock
, 
æags
,

1421 (
sockaddr_š
 *)
sš
, 
addr_Ën
));

1422 
	}
}

1426 
	$š‘_»cväom
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
noblock
,

1427 
æags
, 
sockaddr
 *
sš
, *
addr_Ën
 )

1429 
sock
 *
sk
;

1431 
sk
 = (
sock
 *èsock->
d©a
;

1432 ià(
sk
 =ğ
NULL
) {

1433 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1437 ià(
sk
->
´Ù
->
»cväom
 =ğ
NULL
è(-
EOPNOTSUPP
);

1440 ià(
sk
->
num
 == 0) {

1441 
sk
->
num
 = 
	`g‘_Ãw_socknum
(sk->
´Ù
, 0);

1442 ià(
sk
->
num
 =ğ0è(-
EAGAIN
);

1443 
	`put_sock
(
sk
->
num
, sk);

1444 
sk
->
dummy_th
.
sourû
 = 
	`Áohs
(sk->
num
);

1447 (
sk
->
´Ù
->
	`»cväom
(sk, (*è
ubuf
, 
size
, 
noblock
, 
æags
,

1448 (
sockaddr_š
*)
sš
, 
addr_Ën
));

1449 
	}
}

1453 
	$š‘_shutdown
(
sock‘
 *
sock
, 
how
)

1455 
sock
 *
sk
;

1461 
how
++;

1464 ià(
how
 & ~
SHUTDOWN_MASK
è(-
EINVAL
);

1465 
sk
 = (
sock
 *èsock->
d©a
;

1466 ià(
sk
 =ğ
NULL
) {

1467 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1470 ià(
sock
->
¡©e
 =ğ
SS_CONNECTING
 && 
sk
->¡©=ğ
TCP_ESTABLISHED
)

1471 
sock
->
¡©e
 = 
SS_CONNECTED
;

1473 ià(!
	`tı_cÚÃùed
(
sk
->
¡©e
)è(-
ENOTCONN
);

1474 
sk
->
shutdown
 |ğ
how
;

1475 ià(
sk
->
´Ù
->
shutdown
èsk->´Ù->
	`shutdown
(sk, 
how
);

1477 
	}
}

1481 
	$š‘_£Ëù
(
sock‘
 *
sock
, 
£l_ty³
, 
£Ëù_bË
 *
wa™
 )

1483 
sock
 *
sk
;

1485 
sk
 = (
sock
 *èsock->
d©a
;

1486 ià(
sk
 =ğ
NULL
) {

1487 
	`´štk
("W¬nšg: sock->d©¨ğNULL: %d\n" ,
__LINE__
);

1491 ià(
sk
->
´Ù
->
£Ëù
 =ğ
NULL
) {

1492 
	`DPRINTF
((
DBG_INET
, "select on‚on-selectable socket.\n"));

1495 (
sk
->
´Ù
->
	`£Ëù
(sk, 
£l_ty³
, 
wa™
));

1496 
	}
}

1500 
	$š‘_ioùl
(
sock‘
 *
sock
, 
cmd
, 
¬g
)

1502 
sock
 *
sk
;

1503 
”r
;

1505 
	`DPRINTF
((
DBG_INET
, "INET: in inet_ioctl\n"));

1506 
sk
 = 
NULL
;

1507 ià(
sock
 && (
sk
 = (sock *èsock->
d©a
è=ğ
NULL
) {

1508 
	`´štk
("AF_INET: W¬nšg: sock->d©¨ğNULL: %d\n" , 
__LINE__
);

1512 
cmd
) {

1513 
FIOSETOWN
:

1514 
SIOCSPGRP
:

1515 
”r
=
	`v”ify_¬—
(
VERIFY_READ
,(*)
¬g
,());

1516 if(
”r
)

1517  
”r
;

1518 ià(
sk
)

1519 
sk
->
´oc
 = 
	`g‘_fs_lÚg
((*è
¬g
);

1521 
FIOGETOWN
:

1522 
SIOCGPGRP
:

1523 ià(
sk
) {

1524 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
, ());

1525 if(
”r
)

1526  
”r
;

1527 
	`put_fs_lÚg
(
sk
->
´oc
,(*)
¬g
);

1531 
SIOCATMARK
:

1532 
	`´štk
("AF_INET: ioùl(SIOCATMARK, 0x%08X)\n",(*è
¬g
);

1533 (-
EINVAL
);

1536 
DDIOCSDBG
:

1537 (
	`dbg_ioùl
((*è
¬g
, 
DBG_INET
));

1539 
SIOCADDRT
: 
SIOCADDRTOLD
:

1540 
SIOCDELRT
: 
SIOCDELRTOLD
:

1541 (
	`¹_ioùl
(
cmd
,(*è
¬g
));

1543 
SIOCDARP
:

1544 
SIOCGARP
:

1545 
SIOCSARP
:

1546 (
	`¬p_ioùl
(
cmd
,(*è
¬g
));

1548 
IP_SET_DEV
:

1549 
SIOCGIFCONF
:

1550 
SIOCGIFFLAGS
:

1551 
SIOCSIFFLAGS
:

1552 
SIOCGIFADDR
:

1553 
SIOCSIFADDR
:

1554 
SIOCGIFDSTADDR
:

1555 
SIOCSIFDSTADDR
:

1556 
SIOCGIFBRDADDR
:

1557 
SIOCSIFBRDADDR
:

1558 
SIOCGIFNETMASK
:

1559 
SIOCSIFNETMASK
:

1560 
SIOCGIFMETRIC
:

1561 
SIOCSIFMETRIC
:

1562 
SIOCGIFMEM
:

1563 
SIOCSIFMEM
:

1564 
SIOCGIFMTU
:

1565 
SIOCSIFMTU
:

1566 
SIOCSIFLINK
:

1567 
SIOCGIFHWADDR
:

1568 (
	`dev_ioùl
(
cmd
,(*è
¬g
));

1571 ià(!
sk
 || !sk->
´Ù
->
ioùl
è(-
EINVAL
);

1572 (
sk
->
´Ù
->
	`ioùl
(sk, 
cmd
, 
¬g
));

1576 
	}
}

1579 
sk_buff
 *

1580 
	$sock_wm®loc
(
sock
 *
sk
, 
size
, 
fÜû
,

1581 
´iÜ™y
)

1583 ià(
sk
) {

1584 ià(
sk
->
wmem_®loc
 + 
size
 < sk->
¢dbuf
 || 
fÜû
) {

1585 
sk_buff
 * 
c
 = 
	`®loc_skb
(
size
, 
´iÜ™y
);

1586 ià(
c
) {

1587 
	`şi
();

1588 
sk
->
wmem_®loc
+ğ
size
;

1589 
	`¡i
();

1591  
c
;

1593 
	`DPRINTF
((
DBG_INET
, "sock_wmalloc(%X,%d,%d,%d)„eturning NULL\n",

1594 
sk
, 
size
, 
fÜû
, 
´iÜ™y
));

1595 (
NULL
);

1597 (
	`®loc_skb
(
size
, 
´iÜ™y
));

1598 
	}
}

1601 
sk_buff
 *

1602 
	$sock_rm®loc
(
sock
 *
sk
, 
size
, 
fÜû
, 
´iÜ™y
)

1604 ià(
sk
) {

1605 ià(
sk
->
rmem_®loc
 + 
size
 < sk->
rcvbuf
 || 
fÜû
) {

1606 
sk_buff
 *
c
 = 
	`®loc_skb
(
size
, 
´iÜ™y
);

1607 ià(
c
) {

1608 
	`şi
();

1609 
sk
->
rmem_®loc
 +ğ
size
;

1610 
	`¡i
();

1612 (
c
);

1614 
	`DPRINTF
((
DBG_INET
, "sock_rmalloc(%X,%d,%d,%d)„eturning NULL\n",

1615 
sk
,
size
,
fÜû
, 
´iÜ™y
));

1616 (
NULL
);

1618 (
	`®loc_skb
(
size
, 
´iÜ™y
));

1619 
	}
}

1623 
	$sock_r¥aû
(
sock
 *
sk
)

1625 
amt
;

1627 ià(
sk
 !ğ
NULL
) {

1628 ià(
sk
->
rmem_®loc
 >ğsk->
rcvbuf
-2*
MIN_WINDOW
) (0);

1629 
amt
 = 
	`mš
((
sk
->
rcvbuf
-sk->
rmem_®loc
)/2-
MIN_WINDOW
, 
MAX_WINDOW
);

1630 ià(
amt
 < 0) (0);

1631 (
amt
);

1634 
	}
}

1638 
	$sock_w¥aû
(
sock
 *
sk
)

1640 ià(
sk
 !ğ
NULL
) {

1641 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) (0);

1642 ià(
sk
->
wmem_®loc
 >ğsk->
¢dbuf
) (0);

1643 (
sk
->
¢dbuf
-sk->
wmem_®loc
 );

1646 
	}
}

1650 
	$sock_wä“
(
sock
 *
sk
, *
mem
, 
size
)

1652 
	`DPRINTF
((
DBG_INET
, "sock_wä“(sk=%X, mem=%X, size=%d)\n", 
sk
, 
mem
, 
size
));

1654 
	`IS_SKB
(
mem
);

1655 
	`kä“_skbmem
(
mem
, 
size
);

1656 ià(
sk
) {

1657 
sk
->
wmem_®loc
 -ğ
size
;

1660 ià(!
sk
->
d—d
èsk->
	`wr™e_¥aû
(sk);

1661 ià(
sk
->
de¡roy
 && sk->
wmem_®loc
 =ğ0 && sk->
rmem_®loc
 == 0) {

1662 
	`DPRINTF
((
DBG_INET
,

1663 "»cov”ed†o¡ memÜy, sock = %X\n", 
sk
));

1667 
	}
}

1671 
	$sock_rä“
(
sock
 *
sk
, *
mem
, 
size
)

1673 
	`DPRINTF
((
DBG_INET
, "sock_rä“(sk=%X, mem=%X, size=%d)\n", 
sk
, 
mem
, 
size
));

1674 
	`IS_SKB
(
mem
);

1675 
	`kä“_skbmem
(
mem
, 
size
);

1676 ià(
sk
) {

1677 
sk
->
rmem_®loc
 -ğ
size
;

1678 ià(
sk
->
de¡roy
 && sk->
wmem_®loc
 =ğ0 && sk->
rmem_®loc
 == 0) {

1679 
	`DPRINTF
((
DBG_INET
,

1680 "»cov”ed†Ù memÜy, sock = %X\n", 
sk
));

1683 
	}
}

1690 
sock
 *
	$g‘_sock
(
´Ùo
 *
´Ù
, 
num
,

1691 
¿ddr
,

1692 
ºum
, 
Ïddr
)

1694 
sock
 *
s
;

1695 
hnum
;

1697 
hnum
 = 
	`Áohs
(
num
);

1698 
	`DPRINTF
((
DBG_INET
, "get_sock(prot=%X,‚um=%d,„addr=%X,„num=%d,†addr=%X)\n",

1699 
´Ù
, 
num
, 
¿ddr
, 
ºum
, 
Ïddr
));

1709 
s
 = 
´Ù
->
sock_¬¿y
[
hnum
 & (
SOCK_ARRAY_SIZE
 - 1)];

1710 
s
 !ğ
NULL
; s = s->
Ãxt
)

1712 ià(
s
->
num
 !ğ
hnum
)

1714 if(
s
->
d—d
 && (s->
¡©e
 =ğ
TCP_CLOSE
))

1716 if(
´Ù
 =ğ&
udp_´Ù
)

1717  
s
;

1718 if(
	`_addr_m©ch
(
s
->
daddr
,
¿ddr
)==0)

1720 ià(
s
->
dummy_th
.
de¡
 !ğ
ºum
 && s->dummy_th.dest != 0)

1722 if(
	`_addr_m©ch
(
s
->
§ddr
,
Ïddr
) == 0)

1724 (
s
);

1726 (
NULL
);

1727 
	}
}

1730 
	$»Ëa£_sock
(
sock
 *
sk
)

1732 ià(!
sk
) {

1733 
	`´štk
("sock.c:„elease_sock sk == NULL\n");

1736 ià(!
sk
->
´Ù
) {

1741 ià(
sk
->
blog
) ;

1744 
	`şi
();

1745 
sk
->
šu£
 = 1;

1746 
sk
->
back_log
 !ğ
NULL
) {

1747 
sk_buff
 *
skb
;

1749 
sk
->
blog
 = 1;

1750 
skb
 =(
sk_buff
 *)
sk
->
back_log
;

1751 
	`DPRINTF
((
DBG_INET
, "»Ëa£_sock: skb = %X:\n", 
skb
));

1752 ià(
skb
->
Ãxt
 != skb) {

1753 
sk
->
back_log
 = 
skb
->
Ãxt
;

1754 
skb
->
´ev
->
Ãxt
 = skb->next;

1755 
skb
->
Ãxt
->
´ev
 = skb->prev;

1757 
sk
->
back_log
 = 
NULL
;

1759 
	`¡i
();

1760 
	`DPRINTF
((
DBG_INET
, "sk->back_log = %X\n", 
sk
->
back_log
));

1761 ià(
sk
->
´Ù
->
rcv
èsk->´Ù->
	`rcv
(
skb
, skb->
dev
, sk->
İt
,

1762 
skb
->
§ddr
, skb->
Ën
, skb->
daddr
, 1,

1765 (
š‘_´ÙocŞ
 *)
sk
->
·œ
);

1766 
	`şi
();

1768 
sk
->
blog
 = 0;

1769 
sk
->
šu£
 = 0;

1770 
	`¡i
();

1771 ià(
sk
->
d—d
 && sk->
¡©e
 =ğ
TCP_CLOSE
) {

1773 
	`»£t_tim”
(
sk
, 
TIME_DONE
, 
	`mš
(sk->
¹t
 * 2, 
TCP_DONE_TIME
));

1775 
	}
}

1779 
	$š‘_fioùl
(
šode
 *šode, 
fe
 *file,

1780 
cmd
, 
¬g
)

1782 
mšÜ
, 
»t
;

1785 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

1786 ià(
mšÜ
 !ğ0è(-
ENODEV
);

1789 
mšÜ
) {

1791 
»t
 = 
	`š‘_ioùl
(
NULL
, 
cmd
, 
¬g
);

1794 
»t
 = 
	`_ioùl
(
NULL
, 
cmd
, 
¬g
);

1797 
»t
 = 
	`icmp_ioùl
(
NULL
, 
cmd
, 
¬g
);

1800 
»t
 = 
	`tı_ioùl
(
NULL
, 
cmd
, 
¬g
);

1803 
»t
 = 
	`udp_ioùl
(
NULL
, 
cmd
, 
¬g
);

1806 
»t
 = -
ENODEV
;

1809 (
»t
);

1810 
	}
}

1815 
fe_İ”©iÚs
 
	gš‘_fİs
 = {

1816 
NULL
,

1817 
NULL
,

1818 
NULL
,

1819 
NULL
,

1820 
NULL
,

1821 
š‘_fioùl
,

1822 
NULL
,

1823 
NULL
,

1824 
NULL


1828 
´Ùo_İs
 
	gš‘_´Ùo_İs
 = {

1829 
AF_INET
,

1831 
š‘_ü—‹
,

1832 
š‘_dup
,

1833 
š‘_»Ëa£
,

1834 
š‘_bšd
,

1835 
š‘_cÚÃù
,

1836 
š‘_sock‘·œ
,

1837 
š‘_acû±
,

1838 
š‘_g‘Çme
,

1839 
š‘_»ad
,

1840 
š‘_wr™e
,

1841 
š‘_£Ëù
,

1842 
š‘_ioùl
,

1843 
š‘_li¡’
,

1844 
š‘_£nd
,

1845 
š‘_»cv
,

1846 
š‘_£ndto
,

1847 
š‘_»cväom
,

1848 
š‘_shutdown
,

1849 
š‘_£tsockİt
,

1850 
š‘_g‘sockİt
,

1851 
š‘_fú
,

1854 
£q_off£t
;

1857 
	$š‘_´Ùo_š™
(
ddi_´Ùo
 *
´o
)

1859 
š‘_´ÙocŞ
 *
p
;

1860 
i
;

1862 
	`´štk
("Swansea University Computer Society Net2Debugged [1.30]\n");

1864 ià(
	`»gi¡”_chrdev
(
AF_INET_MAJOR
, "af_š‘", &
š‘_fİs
) < 0) {

1865 
	`´štk
("%s: cannot„egister major device %d!\n",

1866 
´o
->
Çme
, 
AF_INET_MAJOR
);

1871 (è
	`sock_»gi¡”
(
š‘_´Ùo_İs
.
çmy
, &inet_proto_ops);

1873 
£q_off£t
 = 
CURRENT_TIME
*250;

1876 
i
 = 0; i < 
SOCK_ARRAY_SIZE
; i++) {

1877 
tı_´Ù
.
sock_¬¿y
[
i
] = 
NULL
;

1878 
udp_´Ù
.
sock_¬¿y
[
i
] = 
NULL
;

1879 
¿w_´Ù
.
sock_¬¿y
[
i
] = 
NULL
;

1881 
	`´štk
("IP Protocols: ");

1882 
p
 = 
š‘_´ÙocŞ_ba£
;… !ğ
NULL
;) {

1883 
š‘_´ÙocŞ
 *
tmp
;

1885 
tmp
 = (
š‘_´ÙocŞ
 *è
p
->
Ãxt
;

1886 
	`š‘_add_´ÙocŞ
(
p
);

1887 
	`´štk
("%s%s",
p
->
Çme
,
tmp
?", ":"\n");

1888 
p
 = 
tmp
;

1892 
	`dev_š™
();

1895 
bh_ba£
[
INET_BH
].
routše
 = 
š‘_bh
;

1896 
	}
}

	@net/inet/sock.h

30 #iâdeà
_SOCK_H


31 
	#_SOCK_H


	)

33 
	~<lšux/tim”.h
>

34 
	~<lšux/.h
>

35 
	~<lšux/tı.h
>

37 
	~"skbuff.h
"

38 
	~"´ÙocŞ.h
"

39 #ifdeà
CONFIG_AX25


40 
	~"ax25.h
"

42 #ifdeà
CONFIG_IPX


43 
	~"x.h
"

46 
	#SOCK_ARRAY_SIZE
 64

	)

54 
	ssock
 {

55 
İtiÚs
 *
	mİt
;

56 vŞ©
	mwmem_®loc
;

57 vŞ©
	mrmem_®loc
;

58 
	mwr™e_£q
;

59 
	m£Á_£q
;

60 
	macked_£q
;

61 
	mcİ›d_£q
;

62 
	mrcv_ack_£q
;

63 
	mwšdow_£q
;

64 
	mfš_£q
;

65 
	murg_£q
;

66 
	murg_d©a
;

72 vŞ©
	mšu£
,

73 
	md—d
,

74 
	murgšlše
,

75 
	mšŒ
,

76 
	mblog
,

77 
	mdÚe
,

78 
	m»u£
,

79 
	mk“pİ’
,

80 
	mlšg”
,

81 
	md–ay_acks
,

82 
	mde¡roy
,

83 
	mack_timed
,

84 
	mno_check
,

85 
	mz­³d
,

86 
	mbrßdÿ¡
,

87 
	mnÚagË
;

88 
	mlšg”time
;

89 
	m´oc
;

90 
sock
 *
	mÃxt
;

91 
sock
 *
	m·œ
;

92 
sk_buff
 *vŞ©
	m£nd_
;

93 
sk_buff
 *vŞ©
	m£nd_h—d
;

94 
sk_buff
 *vŞ©
	mback_log
;

95 
sk_buff
 *
	m·¹Ÿl
;

96 
tim”_li¡
 
	m·¹Ÿl_tim”
;

97 
	m»Œªsm™s
;

98 
sk_buff
 *vŞ©
	mwback
,

99 *vŞ©
	mwäÚt
,

100 *vŞ©
	mrqueue
;

101 
´Ùo
 *
	m´Ù
;

102 
wa™_queue
 **
	m¦“p
;

103 
	mdaddr
;

104 
	m§ddr
;

105 
	mmax_uÇcked
;

106 
	mwšdow
;

107 
	mby‹s_rcv
;

109 
	mmtu
;

110 vŞ©
	mmss
;

111 vŞ©
	mu£r_mss
;

112 vŞ©
	mmax_wšdow
;

113 
	mnum
;

114 vŞ©
	mcÚg_wšdow
;

115 vŞ©
	mcÚg_couÁ
;

116 vŞ©
	ms¡h»sh
;

117 vŞ©
	m·ck‘s_out
;

118 vŞ©
	mshutdown
;

119 vŞ©
	m¹t
;

120 vŞ©
	mmdev
;

121 vŞ©
	m¹o
;

125 vŞ©
	mbackoff
;

126 vŞ©
	m”r
;

127 
	m´ÙocŞ
;

128 vŞ©
	m¡©e
;

129 vŞ©
	mack_backlog
;

130 
	mmax_ack_backlog
;

131 
	m´iÜ™y
;

132 
	mdebug
;

133 
	mrcvbuf
;

134 
	m¢dbuf
;

135 
	mty³
;

136 #ifdeà
CONFIG_IPX


137 
x_add»ss
 
	mx_sourû_addr
,
	mx_de¡_addr
;

138 
	mx_ty³
;

140 #ifdeà
CONFIG_AX25


142 
ax25_add»ss
 
	max25_sourû_addr
,
	max25_de¡_addr
;

143 
sk_buff
 *vŞ©
	max25_»txq
[8];

144 
	max25_¡©e
,
	max25_vs
,
	max25_vr
,
	max25_Ï¡rxÄ
,
	max25_Ï¡txÄ
;

145 
	max25_cÚd™iÚ
;

146 
	max25_»txút
;

147 
	max25_xx
;

148 
	max25_»txqi
;

149 
	max25_¼tim”
;

150 
	max25_tim”
;

151 
ax25_digi
 *
	max25_dig—t
;

154 
	m_‰l
;

155 
	m_tos
;

156 
tıhdr
 
	mdummy_th
;

159 
	mtimeout
;

160 
tim”_li¡
 
	mtim”
;

163 
sock‘
 *
	msock‘
;

166 (*
	m¡©e_chªge
)(
sock
 *
	msk
);

167 (*
	md©a_»ady
)(
sock
 *
	msk
,
	mby‹s
);

168 (*
	mwr™e_¥aû
)(
sock
 *
	msk
);

169 (*
	m”rÜ_»pÜt
)(
sock
 *
	msk
);

173 
	s´Ùo
 {

174 
	msk_buff
 * (*
	mwm®loc
)(
sock
 *
	msk
,

175 
	msize
, 
	mfÜû
,

176 
	m´iÜ™y
);

177 
	msk_buff
 * (*
	mrm®loc
)(
sock
 *
	msk
,

178 
	msize
, 
	mfÜû
,

179 
	m´iÜ™y
);

180 (*
	mwä“
)(
sock
 *
	msk
, *
	mmem
,

181 
	msize
);

182 (*
	mrä“
)(
sock
 *
	msk
, *
	mmem
,

183 
	msize
);

184 (*
	mr¥aû
)(
sock
 *
	msk
);

185 (*
	mw¥aû
)(
sock
 *
	msk
);

186 (*
	mşo£
)(
sock
 *
	msk
, 
	mtimeout
);

187 (*
	m»ad
)(
sock
 *
	msk
, *
	mto
,

188 
	mËn
, 
	mnÚblock
, 
	mæags
);

189 (*
	mwr™e
)(
sock
 *
	msk
, *
	mto
,

190 
	mËn
, 
	mnÚblock
, 
	mæags
);

191 (*
	m£ndto
)(
sock
 *
	msk
,

192 *
	mäom
, 
	mËn
, 
	mnoblock
,

193 
	mæags
, 
sockaddr_š
 *
	musš
,

194 
	maddr_Ën
);

195 (*
	m»cväom
)(
sock
 *
	msk
,

196 *
	mäom
, 
	mËn
, 
	mnoblock
,

197 
	mæags
, 
sockaddr_š
 *
	musš
,

198 *
	maddr_Ën
);

199 (*
	mbud_h—d”
)(
sk_buff
 *
	mskb
,

200 
	m§ddr
,

201 
	mdaddr
,

202 
deviû
 **
	mdev
, 
	mty³
,

203 
İtiÚs
 *
	mİt
, 
	mËn
, 
	mtos
, 
	m‰l
);

204 (*
	mcÚÃù
)(
sock
 *
	msk
,

205 
sockaddr_š
 *
	musš
, 
	maddr_Ën
);

206 
	msock
 * (*
	macû±
è(
sock
 *
	msk
, 
	mæags
);

207 (*
	mqueue_xm™
)(
sock
 *
	msk
,

208 
deviû
 *
	mdev
, 
sk_buff
 *
	mskb
,

209 
	mä“
);

210 (*
	m»Œªsm™
)(
sock
 *
	msk
, 
	m®l
);

211 (*
	mwr™e_wakeup
)(
sock
 *
	msk
);

212 (*
	m»ad_wakeup
)(
sock
 *
	msk
);

213 (*
	mrcv
)(
sk_buff
 *
	mbuff
, 
deviû
 *
	mdev
,

214 
İtiÚs
 *
	mİt
, 
	mdaddr
,

215 
	mËn
, 
	m§ddr
,

216 
	m»do
, 
š‘_´ÙocŞ
 *
	m´ÙocŞ
);

217 (*
	m£Ëù
)(
sock
 *
	msk
, 
	mwhich
,

218 
£Ëù_bË
 *
	mwa™
);

219 (*
	mioùl
)(
sock
 *
	msk
, 
	mcmd
,

220 
	m¬g
);

221 (*
	mš™
)(
sock
 *
	msk
);

222 (*
	mshutdown
)(
sock
 *
	msk
, 
	mhow
);

223 (*
	m£tsockİt
)(
sock
 *
	msk
, 
	mËv–
, 
	mİŠame
,

224 *
	mİtv®
, 
	mİ’
);

225 (*
	mg‘sockİt
)(
sock
 *
	msk
, 
	mËv–
, 
	mİŠame
,

226 *
	mİtv®
, *
	mİtiÚ
);

227 
	mmax_h—d”
;

228 
	m»Œªsm™s
;

229 
sock
 * 
	msock_¬¿y
[
SOCK_ARRAY_SIZE
];

230 
	mÇme
[80];

233 
	#TIME_WRITE
 1

	)

234 
	#TIME_CLOSE
 2

	)

235 
	#TIME_KEEPOPEN
 3

	)

236 
	#TIME_DESTROY
 4

	)

237 
	#TIME_DONE
 5

	)

238 
	#TIME_PROBE0
 6

	)

239 
	#SOCK_DESTROY_TIME
 1000

	)

241 
	#PROT_SOCK
 1024

	)

243 
	#SHUTDOWN_MASK
 3

	)

244 
	#RCV_SHUTDOWN
 1

	)

245 
	#SEND_SHUTDOWN
 2

	)

248 
de¡roy_sock
(
sock
 *
sk
);

249 
g‘_Ãw_socknum
(
´Ùo
 *, );

250 
put_sock
(, 
sock
 *);

251 
»Ëa£_sock
(
sock
 *
sk
);

252 
sock
 *
g‘_sock
(
´Ùo
 *, ,

255 
´št_sk
(
sock
 *);

256 
sk_buff
 *
sock_wm®loc
(
sock
 *
sk
,

257 
size
, 
fÜû
,

258 
´iÜ™y
);

259 
sk_buff
 *
sock_rm®loc
(
sock
 *
sk
,

260 
size
, 
fÜû
,

261 
´iÜ™y
);

262 
sock_wä“
(
sock
 *
sk
, *
mem
,

263 
size
);

264 
sock_rä“
(
sock
 *
sk
, *
mem
,

265 
size
);

266 
sock_r¥aû
(
sock
 *
sk
);

267 
sock_w¥aû
(
sock
 *
sk
);

269 
sock_£tsockİt
(
sock
 *
sk
,
Ëv–
,
İ
,*
İtv®
,
İ’
);

270 
sock_g‘sockİt
(
sock
 *
sk
,
Ëv–
,
İ
,*
İtv®
,*
İ’
);

273 
sock
 *
tim”_ba£
;

275 
d–‘e_tim”
 (
sock
 *);

276 
»£t_tim”
 (
sock
 *, , );

277 
Ãt_tim”
 ();

	@net/inet/tcp.c

84 
	~<lšux/ty³s.h
>

85 
	~<lšux/sched.h
>

86 
	~<lšux/mm.h
>

87 
	~<lšux/¡ršg.h
>

88 
	~<lšux/sock‘.h
>

89 
	~<lšux/sockios.h
>

90 
	~<lšux/‹rmios.h
>

91 
	~<lšux/š.h
>

92 
	~<lšux/fú.h
>

93 
	~"š‘.h
"

94 
	~"dev.h
"

95 
	~".h
"

96 
	~"´ÙocŞ.h
"

97 
	~"icmp.h
"

98 
	~"tı.h
"

99 
	~"skbuff.h
"

100 
	~"sock.h
"

101 
	~"¬p.h
"

102 
	~<lšux/”ºo.h
>

103 
	~<lšux/tim”.h
>

104 
	~<asm/sy¡em.h
>

105 
	~<asm/£gm’t.h
>

106 
	~<lšux/mm.h
>

108 
	#SEQ_TICK
 3

	)

109 
	g£q_off£t
;

110 
	#SUBNETSARELOCAL


	)

112 
__šlše__
 

113 
	$mš
(
a
, 
b
)

115 ià(
a
 < 
b
) (a);

116 (
b
);

117 
	}
}

120 
	$__´št_th
(
tıhdr
 *
th
)

122 *
±r
;

124 
	`´štk
("TCP header:\n");

125 
	`´štk
(" source=%d, dest=%d, seq =%ld,‡ck_seq = %ld\n",

126 
	`Áohs
(
th
->
sourû
),‚tohsÑh->
de¡
),

127 
	`Áohl
(
th
->
£q
),‚tohlÑh->
ack_£q
));

128 
	`´štk
(" fin=%d, syn=%d,„st=%d,…sh=%d,‡ck=%d, urg=%d„es1=%d„es2=%d\n",

129 
th
->
fš
,h->
syn
,h->
r¡
,h->
psh
,h->
ack
,

130 
th
->
urg
,h->
»s1
,h->
»s2
);

131 
	`´štk
(" window = %d, check = %d urg_ptr = %d\n",

132 
	`Áohs
(
th
->
wšdow
),‚tohsÑh->
check
),‚tohsÑh->
urg_±r
));

133 
	`´štk
(" dofàğ%d\n", 
th
->
doff
);

134 
±r
 =(*)(
th
 + 1);

135 
	`´štk
(" o±iÚ ğ%d %d %d %d\n", 
±r
[0],…tr[1],…tr[2],…tr[3]);

136 
	}
}

138 
šlše
 
	$´št_th
(
tıhdr
 *
th
)

140 ià(
š‘_debug
 =ğ
DBG_TCP
)

141 
	`__´št_th
(
th
);

142 
	}
}

145 
sk_buff
 *

146 
	$g‘_fœ¡r
(
sock
 *
sk
)

148  
	`skb_dequeue
(&
sk
->
rqueue
);

149 
	}
}

156 
	$diff
(
£q1
, 
£q2
)

158 
d
;

160 
d
 = 
£q1
 - 
£q2
;

161 ià(
d
 > 0) (d);

164 (~
d
+1);

165 
	}
}

182 
	$tı_£Ëù_wšdow
(
sock
 *
sk
)

184 
Ãw_wšdow
 = 
sk
->
´Ù
->
	`r¥aû
(sk);

195 ià(
Ãw_wšdow
 < 
	`mš
(
sk
->
mss
, 
MAX_WINDOW
/2) ||

196 
Ãw_wšdow
 < 
sk
->
wšdow
)

197 (
sk
->
wšdow
);

198 (
Ãw_wšdow
);

199 
	}
}

203 
	$tı_time_wa™
(
sock
 *
sk
)

205 
sk
->
¡©e
 = 
TCP_TIME_WAIT
;

206 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

207 ià(!
sk
->
d—d
)

208 
sk
->
	`¡©e_chªge
(sk);

209 
	`»£t_tim”
(
sk
, 
TIME_CLOSE
, 
TCP_TIMEWAIT_LEN
);

210 
	}
}

220 
	$tı_»Œªsm™
(
sock
 *
sk
, 
®l
)

222 ià(
®l
) {

223 
	`_»Œªsm™
(
sk
, 
®l
);

227 
sk
->
s¡h»sh
 = sk->
cÚg_wšdow
 >> 1;

229 
sk
->
cÚg_couÁ
 = 0;

231 
sk
->
cÚg_wšdow
 = 1;

234 
	`_»Œªsm™
(
sk
, 
®l
);

235 
	}
}

247 
	$tı_”r
(
”r
, *
h—d”
, 
daddr
,

248 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

250 
tıhdr
 *
th
;

251 
sock
 *
sk
;

252 
hdr
 *
h
=(hd¸*)
h—d”
;

254 
h—d”
+=4*
h
->
ihl
;

256 
	`DPRINTF
((
DBG_TCP
, "TCP:cp_err(%d, hdr=%X, daddr=%X saddr=%X,…rotocol=%X)\n",

257 
”r
, 
h—d”
, 
daddr
, 
§ddr
, 
´ÙocŞ
));

259 
th
 =(
tıhdr
 *)
h—d”
;

260 
sk
 = 
	`g‘_sock
(&
tı_´Ù
, 
th
->
sourû
 , 
daddr
,h->
de¡
 , 
§ddr
);

261 
	`´št_th
(
th
);

263 ià(
sk
 =ğ
NULL
) ;

265 if(
”r
<0)

267 
sk
->
”r
 = -err;

268 
sk
->
	`”rÜ_»pÜt
(sk);

272 ià((
”r
 & 0xff00è=ğ(
ICMP_SOURCE_QUENCH
 << 8)) {

278 ià(
sk
->
cÚg_wšdow
 > 4) sk->cong_window--;

282 
	`DPRINTF
((
DBG_TCP
, "TCP: icmp_err gotƒrror\n"));

283 
sk
->
”r
 = 
icmp_”r_cÚv”t
[”¸& 0xff].
”ºo
;

289 ià(
icmp_”r_cÚv”t
[
”r
 & 0xff].
çl
) {

290 ià(
sk
->
¡©e
 =ğ
TCP_SYN_SENT
) {

291 
sk
->
¡©e
 = 
TCP_CLOSE
;

292 
sk
->
	`”rÜ_»pÜt
(sk);

296 
	}
}

305 
	$tı_»adabË
(
sock
 *
sk
)

307 
couÁed
;

308 
amouÁ
;

309 
sk_buff
 *
skb
;

310 
couÁ
=0;

311 
sum
;

312 
æags
;

314 
	`DPRINTF
((
DBG_TCP
, "tı_»adabË(sk=%X)\n", 
sk
));

315 if(
sk
 && sk->
debug
)

316 
	`´štk
("tı_»adabË: %°- ",
sk
);

318 ià(
sk
 =ğ
NULL
 || 
	`skb_³ek
(&sk->
rqueue
) == NULL)

320 if(
sk
 && sk->
debug
)

321 
	`´štk
("empty\n");

325 
couÁed
 = 
sk
->
cİ›d_£q
+1;

326 
amouÁ
 = 0;

328 
	`§ve_æags
(
æags
);

329 
	`şi
();

330 
skb
 =(
sk_buff
 *)
sk
->
rqueue
;

334 
couÁ
++;

335 #ifdeà
OLD


337 ià(
couÁ
 > 20) {

338 
	`»¡Üe_æags
(
æags
);

339 
	`DPRINTF
((
DBG_TCP
, "tcp_readable, morehan 20…ackets without‡…sh\n"));

340 
	`´štk
("tcp_read:…ossible„ead_queue corruption.\n");

341 (
amouÁ
);

344 ià(
	`befÜe
(
couÁed
, 
skb
->
h
.
th
->
£q
))

346 
sum
 = 
skb
->
Ën
 -(
couÁed
 - skb->
h
.
th
->
£q
);

347 ià(
skb
->
h
.
th
->
syn
)

348 
sum
++;

349 ià(
sum
 >= 0) {

350 
amouÁ
 +ğ
sum
;

351 ià(
skb
->
h
.
th
->
syn
è
amouÁ
--;

352 
couÁed
 +ğ
sum
;

354 ià(
amouÁ
 && 
skb
->
h
.
th
->
psh
) ;

355 
skb
 =(
sk_buff
 *)skb->
Ãxt
;

356 } 
skb
 !ğ
sk
->
rqueue
);

357 ià(
amouÁ
 && !
sk
->
urgšlše
 && sk->
urg_d©a
 &&

358 (
sk
->
urg_£q
 - sk->
cİ›d_£q
è<ğ(
couÁed
 - sk->copied_seq))

359 
amouÁ
--;

360 
	`»¡Üe_æags
(
æags
);

361 
	`DPRINTF
((
DBG_TCP
, "tı„—dabË„‘uºšg %d by‹s\n", 
amouÁ
));

362 if(
sk
->
debug
)

363 
	`´štk
("gÙ %lu by‹s.\n",
amouÁ
);

364 (
amouÁ
);

365 
	}
}

374 
	$tı_£Ëù
(
sock
 *
sk
, 
£l_ty³
, 
£Ëù_bË
 *
wa™
)

376 
	`DPRINTF
((
DBG_TCP
, "tcp_select(sk=%X, sel_type = %d, wait = %X)\n",

377 
sk
, 
£l_ty³
, 
wa™
));

379 
sk
->
šu£
 = 1;

380 
£l_ty³
) {

381 
SEL_IN
:

382 if(
sk
->
debug
)

383 
	`´štk
("select in");

384 
	`£Ëù_wa™
(
sk
->
¦“p
, 
wa™
);

385 if(
sk
->
debug
)

386 
	`´štk
("-select out");

387 ià(
	`skb_³ek
(&
sk
->
rqueue
è!ğ
NULL
) {

388 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
 || 
	`tı_»adabË
(sk)) {

389 
	`»Ëa£_sock
(
sk
);

390 if(
sk
->
debug
)

391 
	`´štk
("-select ok data\n");

395 ià(
sk
->
”r
 != 0)

397 
	`»Ëa£_sock
(
sk
);

398 if(
sk
->
debug
)

399 
	`´štk
("-select okƒrror");

402 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) {

403 
	`»Ëa£_sock
(
sk
);

404 if(
sk
->
debug
)

405 
	`´štk
("-select ok down\n");

408 
	`»Ëa£_sock
(
sk
);

409 if(
sk
->
debug
)

410 
	`´štk
("-select fail\n");

413 
SEL_OUT
:

414 
	`£Ëù_wa™
(
sk
->
¦“p
, 
wa™
);

415 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) {

416 
	`DPRINTF
((
DBG_TCP
,

420 
	`»Ëa£_sock
(
sk
);

429 ià(
sk
->
´Ù
->
	`w¥aû
(skè>ğsk->
mss
) {

430 
	`»Ëa£_sock
(
sk
);

432 ià(
sk
->
¡©e
 =ğ
TCP_SYN_RECV
 ||

433 
sk
->
¡©e
 =ğ
TCP_SYN_SENT
) (0);

436 
	`DPRINTF
((
DBG_TCP
,

441 
sk
->
wmem_®loc
, sk->
·ck‘s_out
,

442 
sk
->
wback
, sk->
wäÚt
,

443 
sk
->
wr™e_£q
, sk->
wšdow_£q
));

445 
	`»Ëa£_sock
(
sk
);

447 
SEL_EX
:

448 
	`£Ëù_wa™
(
sk
->
¦“p
,
wa™
);

449 ià(
sk
->
”r
 || sk->
urg_d©a
) {

450 
	`»Ëa£_sock
(
sk
);

453 
	`»Ëa£_sock
(
sk
);

457 
	`»Ëa£_sock
(
sk
);

459 
	}
}

463 
	$tı_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
)

465 
”r
;

466 
	`DPRINTF
((
DBG_TCP
, "tı_ioùl(sk=%X, cmd = %d,‡rg=%X)\n", 
sk
, 
cmd
, 
¬g
));

467 
cmd
) {

468 
DDIOCSDBG
:

469 (
	`dbg_ioùl
((*è
¬g
, 
DBG_TCP
));

471 
TIOCINQ
:

472 #ifdeà
FIXME


473 
FIONREAD
:

476 
amouÁ
;

478 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
è(-
EINVAL
);

480 
sk
->
šu£
 = 1;

481 
amouÁ
 = 
	`tı_»adabË
(
sk
);

482 
	`»Ëa£_sock
(
sk
);

483 
	`DPRINTF
((
DBG_TCP
, "»tuºšg %d\n", 
amouÁ
));

484 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
,

486 if(
”r
)

487  
”r
;

488 
	`put_fs_lÚg
(
amouÁ
,(*)
¬g
);

491 
SIOCATMARK
:

493 
ªsw
 = 
sk
->
urg_d©a
 && sk->
urg_£q
 =ğsk->
cİ›d_£q
+1;

495 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,(*è
¬g
,

497 ià(
”r
)

498  
”r
;

499 
	`put_fs_lÚg
(
ªsw
,(*è
¬g
);

502 
TIOCOUTQ
:

504 
amouÁ
;

506 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
è(-
EINVAL
);

507 
amouÁ
 = 
sk
->
´Ù
->
	`w¥aû
(sk);

508 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
,

510 if(
”r
)

511  
”r
;

512 
	`put_fs_lÚg
(
amouÁ
,(*)
¬g
);

516 (-
EINVAL
);

518 
	}
}

523 
	$tı_check
(
tıhdr
 *
th
, 
Ën
,

524 
§ddr
, 
daddr
)

526 
sum
;

528 ià(
§ddr
 =ğ0è§dd¸ğ
	`my_addr
();

529 
	`´št_th
(
th
);

530 
	`__asm__
("\t‡ddl %%ecx,%%ebx\n"

533 : "=b"(
sum
)

534 : "0"(
daddr
), "c"(
§ddr
), "d"((
	`Áohs
(
Ën
è<< 16è+ 
IPPROTO_TCP
*256)

537 ià(
Ën
 > 3) {

538 
	`__asm__
("\tclc\n"

544 : "=b"(
sum
è, "=S"(
th
)

545 : "0"(
sum
), "c"(
Ën
/4è,"1"(
th
)

550 
	`__asm__
("\t movl %%ebx, %%ecx\n"

554 : "=b"(
sum
)

555 : "0"(
sum
)

559 ià((
Ën
 & 2) != 0) {

560 
	`__asm__
("\t†odsw\n"

563 : "=b"(
sum
), "=S"(
th
)

564 : "0"(
sum
è,"1"(
th
)

569 ià((
Ën
 & 1) != 0) {

570 
	`__asm__
("\t†odsb\n"

574 : "=b"(
sum
)

575 : "0"(
sum
è,"S"(
th
)

580 ((~
sum
) & 0xffff);

581 
	}
}

584 
	$tı_£nd_check
(
tıhdr
 *
th
, 
§ddr
,

585 
daddr
, 
Ën
, 
sock
 *
sk
)

587 
th
->
check
 = 0;

588 
th
->
check
 = 
	`tı_check
Ñh, 
Ën
, 
§ddr
, 
daddr
);

590 
	}
}

592 
	$tı_£nd_skb
(
sock
 *
sk
, 
sk_buff
 *
skb
)

594 
size
;

595 
tıhdr
 * 
th
 = 
skb
->
h
.th;

598 
size
 = 
skb
->
Ën
 - ((*è
th
 - skb->
d©a
);

601 ià(
size
 < (
tıhdr
è|| siz> 
skb
->
Ën
) {

602 
	`´štk
("tcp_send_skb: bad skb (skb = %p, data = %p,h = %p,†en = %lu)\n",

603 
skb
, skb->
d©a
, 
th
, skb->
Ën
);

604 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

609 ià(
size
 =ğ(
tıhdr
)) {

611 if(!
th
->
syn
 && !th->
fš
) {

612 
	`´štk
("tcp_send_skb:‡ttempto queue‡ bogon.\n");

613 
	`kä“_skb
(
skb
,
FREE_WRITE
);

619 
	`tı_£nd_check
(
th
, 
sk
->
§ddr
, sk->
daddr
, 
size
, sk);

621 
skb
->
h
.
£q
 = 
	`Áohl
(
th
->£qè+ 
size
 - 4*th->
doff
;

622 ià(
	`aá”
(
skb
->
h
.
£q
, 
sk
->
wšdow_£q
) ||

623 (
sk
->
»Œªsm™s
 && sk->
timeout
 =ğ
TIME_WRITE
) ||

624 
sk
->
·ck‘s_out
 >ğsk->
cÚg_wšdow
) {

625 
	`DPRINTF
((
DBG_TCP
, "sk->cong_window = %d, sk->packets_out = %d\n",

626 
sk
->
cÚg_wšdow
, sk->
·ck‘s_out
));

627 
	`DPRINTF
((
DBG_TCP
, "sk->write_seq = %d, sk->window_seq = %d\n",

628 
sk
->
wr™e_£q
, sk->
wšdow_£q
));

629 
skb
->
Ãxt
 = 
NULL
;

630 
skb
->
magic
 = 
TCP_WRITE_QUEUE_MAGIC
;

631 ià(
sk
->
wback
 =ğ
NULL
) {

632 
sk
->
wäÚt
 = 
skb
;

634 
sk
->
wback
->
Ãxt
 = 
skb
;

636 
sk
->
wback
 = 
skb
;

637 ià(
	`befÜe
(
sk
->
wšdow_£q
, sk->
wäÚt
->
h
.
£q
) &&

638 
sk
->
£nd_h—d
 =ğ
NULL
 &&

639 
sk
->
ack_backlog
 == 0)

640 
	`»£t_tim”
(
sk
, 
TIME_PROBE0
, sk->
¹o
);

642 
sk
->
£Á_£q
 = sk->
wr™e_£q
;

643 
sk
->
´Ù
->
	`queue_xm™
(sk, 
skb
->
dev
, skb, 0);

645 
	}
}

647 
sk_buff
 * 
	$tı_dequeue_·¹Ÿl
(
sock
 * 
sk
)

649 
sk_buff
 * 
skb
;

650 
æags
;

652 
	`§ve_æags
(
æags
);

653 
	`şi
();

654 
skb
 = 
sk
->
·¹Ÿl
;

655 ià(
skb
) {

656 
sk
->
·¹Ÿl
 = 
NULL
;

657 
	`d–_tim”
(&
sk
->
·¹Ÿl_tim”
);

659 
	`»¡Üe_æags
(
æags
);

660  
skb
;

661 
	}
}

663 
	$tı_£nd_·¹Ÿl
(
sock
 *
sk
)

665 
sk_buff
 *
skb
;

667 ià(
sk
 =ğ
NULL
)

669 (
skb
 = 
	`tı_dequeue_·¹Ÿl
(
sk
)è!ğ
NULL
)

670 
	`tı_£nd_skb
(
sk
, 
skb
);

671 
	}
}

673 
	$tı_’queue_·¹Ÿl
(
sk_buff
 * 
skb
, 
sock
 * 
sk
)

675 
sk_buff
 * 
tmp
;

676 
æags
;

678 
	`§ve_æags
(
æags
);

679 
	`şi
();

680 
tmp
 = 
sk
->
·¹Ÿl
;

681 ià(
tmp
)

682 
	`d–_tim”
(&
sk
->
·¹Ÿl_tim”
);

683 
sk
->
·¹Ÿl
 = 
skb
;

684 
sk
->
·¹Ÿl_tim”
.
expœes
 = 
HZ
;

685 
sk
->
·¹Ÿl_tim”
.
funùiÚ
 = ((*)()è
tı_£nd_·¹Ÿl
;

686 
sk
->
·¹Ÿl_tim”
.
d©a
 = () sk;

687 
	`add_tim”
(&
sk
->
·¹Ÿl_tim”
);

688 
	`»¡Üe_æags
(
æags
);

689 ià(
tmp
)

690 
	`tı_£nd_skb
(
sk
, 
tmp
);

691 
	}
}

696 
	$tı_£nd_ack
(
£qu’û
, 
ack
,

697 
sock
 *
sk
,

698 
tıhdr
 *
th
, 
daddr
)

700 
sk_buff
 *
buff
;

701 
tıhdr
 *
t1
;

702 
deviû
 *
dev
 = 
NULL
;

703 
tmp
;

705 if(
sk
->
z­³d
)

711 
buff
 = 
sk
->
´Ù
->
	`wm®loc
(sk, 
MAX_ACK_SIZE
, 1, 
GFP_ATOMIC
);

712 ià(
buff
 =ğ
NULL
) {

714 
sk
->
ack_backlog
++;

715 ià(
sk
->
timeout
 !ğ
TIME_WRITE
 && 
	`tı_cÚÃùed
(sk->
¡©e
)) {

716 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 10);

718 ià(
š‘_debug
 =ğ
DBG_SLIP
è
	`´štk
("\rtcp_ack: malloc failed\n");

722 
buff
->
mem_addr
 = buff;

723 
buff
->
mem_Ën
 = 
MAX_ACK_SIZE
;

724 
buff
->
Ën
 = (
tıhdr
);

725 
buff
->
sk
 = sk;

726 
t1
 =(
tıhdr
 *è
buff
->
d©a
;

729 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
buff
, sk->
§ddr
, 
daddr
, &
dev
,

730 
IPPROTO_TCP
, 
sk
->
İt
, 
MAX_ACK_SIZE
,sk->
_tos
,sk->
_‰l
);

731 ià(
tmp
 < 0) {

732 
buff
->
ä“
=1;

733 
sk
->
´Ù
->
	`wä“
(sk, 
buff
->
mem_addr
, buff->
mem_Ën
);

734 ià(
š‘_debug
 =ğ
DBG_SLIP
è
	`´štk
("\rtcp_ack: build_header failed\n");

737 
buff
->
Ën
 +ğ
tmp
;

738 
t1
 =(
tıhdr
 *)((*é1 +
tmp
);

741 
	`memıy
(
t1
, 
th
, (*t1));

744 
t1
->
de¡
 = 
th
->
sourû
;

745 
t1
->
sourû
 = 
th
->
de¡
;

746 
t1
->
£q
 = 
	`Áohl
(
£qu’û
);

747 
t1
->
ack
 = 1;

748 
sk
->
wšdow
 = 
	`tı_£Ëù_wšdow
(sk);

749 
t1
->
wšdow
 = 
	`Áohs
(
sk
->window);

750 
t1
->
»s1
 = 0;

751 
t1
->
»s2
 = 0;

752 
t1
->
r¡
 = 0;

753 
t1
->
urg
 = 0;

754 
t1
->
syn
 = 0;

755 
t1
->
psh
 = 0;

756 
t1
->
fš
 = 0;

757 ià(
ack
 =ğ
sk
->
acked_£q
) {

758 
sk
->
ack_backlog
 = 0;

759 
sk
->
by‹s_rcv
 = 0;

760 
sk
->
ack_timed
 = 0;

761 ià(
sk
->
£nd_h—d
 =ğ
NULL
 && sk->
wäÚt
 =ğNULL && sk->
timeout
 =ğ
TIME_WRITE
)

763 if(
sk
->
k“pİ’
)

764 
	`»£t_tim”
(
sk
,
TIME_KEEPOPEN
,
TCP_TIMEOUT_LEN
);

766 
	`d–‘e_tim”
(
sk
);

769 
t1
->
ack_£q
 = 
	`Áohl
(
ack
);

770 
t1
->
doff
 = (*t1)/4;

771 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, 
daddr
, (*t1), sk);

772 ià(
sk
->
debug
)

773 
	`´štk
("\¹ı_ack: seq %lx‡ck %lx\n", 
£qu’û
, 
ack
);

774 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
buff
, 1);

775 
	}
}

780 
	$tı_bud_h—d”
(
tıhdr
 *
th
, 
sock
 *
sk
, 
push
)

784 
	`memıy
(
th
,(*è&(
sk
->
dummy_th
), (*th));

785 
th
->
£q
 = 
	`htÚl
(
sk
->
wr™e_£q
);

786 
th
->
psh
 =(
push
 == 0) ? 1 : 0;

787 
th
->
doff
 = (*th)/4;

788 
th
->
ack
 = 1;

789 
th
->
fš
 = 0;

790 
sk
->
ack_backlog
 = 0;

791 
sk
->
by‹s_rcv
 = 0;

792 
sk
->
ack_timed
 = 0;

793 
th
->
ack_£q
 = 
	`htÚl
(
sk
->
acked_£q
);

794 
sk
->
wšdow
 = 
	`tı_£Ëù_wšdow
(sk) ;

795 
th
->
wšdow
 = 
	`htÚs
(
sk
->window);

797 ((*
th
));

798 
	}
}

805 
	$tı_wr™e
(
sock
 *
sk
, *
äom
,

806 
Ën
, 
nÚblock
, 
æags
)

808 
cİ›d
 = 0;

809 
cİy
;

810 
tmp
;

811 
sk_buff
 *
skb
;

812 
sk_buff
 *
£nd_tmp
;

813 *
buff
;

814 
´Ùo
 *
´Ù
;

815 
deviû
 *
dev
 = 
NULL
;

817 
	`DPRINTF
((
DBG_TCP
, "tcp_write(sk=%X, from=%X,†en=%d,‚onblock=%d, flags=%X)\n",

818 
sk
, 
äom
, 
Ën
, 
nÚblock
, 
æags
));

820 
sk
->
šu£
=1;

821 
´Ù
 = 
sk
->prot;

822 
Ën
 > 0) {

823 ià(
sk
->
”r
) {

824 
	`»Ëa£_sock
(
sk
);

825 ià(
cİ›d
) (copied);

826 
tmp
 = -
sk
->
”r
;

827 
sk
->
”r
 = 0;

828 (
tmp
);

832 ià(
sk
->
shutdown
 & 
SEND_SHUTDOWN
) {

833 
	`»Ëa£_sock
(
sk
);

834 
sk
->
”r
 = 
EPIPE
;

835 ià(
cİ›d
) (copied);

836 
sk
->
”r
 = 0;

837 (-
EPIPE
);

843 
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->¡©!ğ
TCP_CLOSE_WAIT
) {

844 ià(
sk
->
”r
) {

845 
	`»Ëa£_sock
(
sk
);

846 ià(
cİ›d
) (copied);

847 
tmp
 = -
sk
->
”r
;

848 
sk
->
”r
 = 0;

849 (
tmp
);

852 ià(
sk
->
¡©e
 !ğ
TCP_SYN_SENT
 && sk->¡©!ğ
TCP_SYN_RECV
) {

853 
	`»Ëa£_sock
(
sk
);

854 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 1\n"));

855 ià(
cİ›d
) (copied);

857 ià(
sk
->
”r
) {

858 
tmp
 = -
sk
->
”r
;

859 
sk
->
”r
 = 0;

860 (
tmp
);

863 ià(
sk
->
k“pİ’
) {

864 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 0);

866 (-
EPIPE
);

869 ià(
nÚblock
 || 
cİ›d
) {

870 
	`»Ëa£_sock
(
sk
);

871 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 2\n"));

872 ià(
cİ›d
) (copied);

873 (-
EAGAIN
);

876 
	`»Ëa£_sock
(
sk
);

877 
	`şi
();

878 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 &&

879 
sk
->
¡©e
 !ğ
TCP_CLOSE_WAIT
 && sk->
”r
 == 0) {

880 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

881 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

882 
	`¡i
();

883 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 3\n"));

884 ià(
cİ›d
) (copied);

885 (-
ERESTARTSYS
);

888 
sk
->
šu£
 = 1;

889 
	`¡i
();

905 ià((
skb
 = 
	`tı_dequeue_·¹Ÿl
(
sk
)è!ğ
NULL
) {

906 
hd¾’
;

909 
hd¾’
 = (()
skb
->
h
.
th
 - ()skb->
d©a
)

910 + (
tıhdr
);

913 ià(!(
æags
 & 
MSG_OOB
)) {

914 
cİy
 = 
	`mš
(
sk
->
mss
 - (
skb
->
Ën
 - 
hd¾’
),†en);

916 ià(
cİy
 <= 0) {

917 
	`´štk
("TCP: **bug**: \"copy\" <= 0!!\n");

918 
cİy
 = 0;

921 
	`memıy_äomfs
(
skb
->
d©a
 + skb->
Ën
, 
äom
, 
cİy
);

922 
skb
->
Ën
 +ğ
cİy
;

923 
äom
 +ğ
cİy
;

924 
cİ›d
 +ğ
cİy
;

925 
Ën
 -ğ
cİy
;

926 
sk
->
wr™e_£q
 +ğ
cİy
;

928 ià((
skb
->
Ën
 - 
hd¾’
è>ğ
sk
->
mss
 ||

929 (
æags
 & 
MSG_OOB
) ||

930 !
sk
->
·ck‘s_out
)

931 
	`tı_£nd_skb
(
sk
, 
skb
);

933 
	`tı_’queue_·¹Ÿl
(
skb
, 
sk
);

949 
cİy
 = 
sk
->
wšdow_£q
 - sk->
wr™e_£q
;

950 ià(
cİy
 <ğ0 || cİy < (
sk
->
max_wšdow
 >> 1è|| cİy > sk->
mss
)

951 
cİy
 = 
sk
->
mss
;

952 ià(
cİy
 > 
Ën
)

953 
cİy
 = 
Ën
;

956 
£nd_tmp
 = 
NULL
;

957 ià(
cİy
 < 
sk
->
mss
 && !(
æags
 & 
MSG_OOB
)) {

959 
	`»Ëa£_sock
(
sk
);

962 
skb
 = 
´Ù
->
	`wm®loc
(
sk
, sk->
mtu
 + 128 +…rÙ->
max_h—d”
 + (*skb), 0, 
GFP_KERNEL
);

963 
sk
->
šu£
 = 1;

964 
£nd_tmp
 = 
skb
;

967 
	`»Ëa£_sock
(
sk
);

968 
skb
 = 
´Ù
->
	`wm®loc
(
sk
, 
cİy
 +…rÙ->
max_h—d”
 + (*skb), 0, 
GFP_KERNEL
);

969 
sk
->
šu£
 = 1;

973 ià(
skb
 =ğ
NULL
) {

974 ià(
nÚblock
 ) {

975 
	`»Ëa£_sock
(
sk
);

976 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 4\n"));

977 ià(
cİ›d
) (copied);

978 (-
EAGAIN
);

982 
tmp
 = 
sk
->
wmem_®loc
;

983 
	`»Ëa£_sock
(
sk
);

984 
	`şi
();

986 ià(
tmp
 <ğ
sk
->
wmem_®loc
 &&

987 (
sk
->
¡©e
 =ğ
TCP_ESTABLISHED
||sk->¡©=ğ
TCP_CLOSE_WAIT
)

988 && 
sk
->
”r
 == 0) {

989 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

990 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

991 
	`¡i
();

992 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 5\n"));

993 ià(
cİ›d
) (copied);

994 (-
ERESTARTSYS
);

997 
sk
->
šu£
 = 1;

998 
	`¡i
();

1002 
skb
->
Ën
 = 0;

1003 
skb
->
sk
 = sk;

1004 
skb
->
ä“
 = 0;

1006 
buff
 = 
skb
->
d©a
;

1012 
tmp
 = 
´Ù
->
	`bud_h—d”
(
skb
, 
sk
->
§ddr
, sk->
daddr
, &
dev
,

1013 
IPPROTO_TCP
, 
sk
->
İt
, 
skb
->
mem_Ën
,sk->
_tos
,sk->
_‰l
);

1014 ià(
tmp
 < 0 ) {

1015 
´Ù
->
	`wä“
(
sk
, 
skb
->
mem_addr
, skb->
mem_Ën
);

1016 
	`»Ëa£_sock
(
sk
);

1017 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 6\n"));

1018 ià(
cİ›d
) (copied);

1019 (
tmp
);

1021 
skb
->
Ën
 +ğ
tmp
;

1022 
skb
->
dev
 = dev;

1023 
buff
 +ğ
tmp
;

1024 
skb
->
h
.
th
 =(
tıhdr
 *è
buff
;

1025 
tmp
 = 
	`tı_bud_h—d”
((
tıhdr
 *)
buff
, 
sk
, 
Ën
-
cİy
);

1026 ià(
tmp
 < 0) {

1027 
´Ù
->
	`wä“
(
sk
, 
skb
->
mem_addr
, skb->
mem_Ën
);

1028 
	`»Ëa£_sock
(
sk
);

1029 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 7\n"));

1030 ià(
cİ›d
) (copied);

1031 (
tmp
);

1034 ià(
æags
 & 
MSG_OOB
) {

1035 ((
tıhdr
 *)
buff
)->
urg
 = 1;

1036 ((
tıhdr
 *)
buff
)->
urg_±r
 = 
	`Áohs
(
cİy
);

1038 
skb
->
Ën
 +ğ
tmp
;

1039 
	`memıy_äomfs
(
buff
+
tmp
, 
äom
, 
cİy
);

1041 
äom
 +ğ
cİy
;

1042 
cİ›d
 +ğ
cİy
;

1043 
Ën
 -ğ
cİy
;

1044 
skb
->
Ën
 +ğ
cİy
;

1045 
skb
->
ä“
 = 0;

1046 
sk
->
wr™e_£q
 +ğ
cİy
;

1048 ià(
£nd_tmp
 !ğ
NULL
 && 
sk
->
·ck‘s_out
) {

1049 
	`tı_’queue_·¹Ÿl
(
£nd_tmp
, 
sk
);

1052 
	`tı_£nd_skb
(
sk
, 
skb
);

1054 
sk
->
”r
 = 0;

1064 if(
sk
->
·¹Ÿl
 &&

1065 ((!
sk
->
·ck‘s_out
)

1067 || (
sk
->
nÚagË
 && 
	`befÜe
(sk->
wr™e_£q
 , sk->
wšdow_£q
))

1069 
	`tı_£nd_·¹Ÿl
(
sk
);

1071 
	`»Ëa£_sock
(
sk
);

1072 
	`DPRINTF
((
DBG_TCP
, "tcp_write:„eturn 8\n"));

1073 (
cİ›d
);

1074 
	}
}

1078 
	$tı_£ndto
(
sock
 *
sk
, *
äom
,

1079 
Ën
, 
nÚblock
, 
æags
,

1080 
sockaddr_š
 *
addr
, 
addr_Ën
)

1082 
sockaddr_š
 
sš
;

1084 ià(
addr_Ën
 < (
sš
)è(-
EINVAL
);

1085 
	`memıy_äomfs
(&
sš
, 
addr
, (sin));

1086 ià(
sš
.
sš_çmy
 && sš.sš_çmy !ğ
AF_INET
è(-
EINVAL
);

1087 ià(
sš
.
sš_pÜt
 !ğ
sk
->
dummy_th
.
de¡
è(-
EINVAL
);

1088 ià(
sš
.
sš_addr
.
s_addr
 !ğ
sk
->
daddr
è(-
EINVAL
);

1089 (
	`tı_wr™e
(
sk
, 
äom
, 
Ën
, 
nÚblock
, 
æags
));

1090 
	}
}

1094 
	$tı_»ad_wakeup
(
sock
 *
sk
)

1096 
tmp
;

1097 
deviû
 *
dev
 = 
NULL
;

1098 
tıhdr
 *
t1
;

1099 
sk_buff
 *
buff
;

1101 
	`DPRINTF
((
DBG_TCP
, "incp„ead wakeup\n"));

1102 ià(!
sk
->
ack_backlog
) ;

1114 
buff
 = 
sk
->
´Ù
->
	`wm®loc
(sk,
MAX_ACK_SIZE
,1, 
GFP_ATOMIC
);

1115 ià(
buff
 =ğ
NULL
) {

1117 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 10);

1121 
buff
->
mem_addr
 = buff;

1122 
buff
->
mem_Ën
 = 
MAX_ACK_SIZE
;

1123 
buff
->
Ën
 = (
tıhdr
);

1124 
buff
->
sk
 = sk;

1127 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
buff
, sk->
§ddr
, sk->
daddr
, &
dev
,

1128 
IPPROTO_TCP
, 
sk
->
İt
, 
MAX_ACK_SIZE
,sk->
_tos
,sk->
_‰l
);

1129 ià(
tmp
 < 0) {

1130 
buff
->
ä“
=1;

1131 
sk
->
´Ù
->
	`wä“
(sk, 
buff
->
mem_addr
, buff->
mem_Ën
);

1135 
buff
->
Ën
 +ğ
tmp
;

1136 
t1
 =(
tıhdr
 *)(
buff
->
d©a
 +
tmp
);

1138 
	`memıy
(
t1
,(*è&
sk
->
dummy_th
, (*t1));

1139 
t1
->
£q
 = 
	`htÚl
(
sk
->
£Á_£q
);

1140 
t1
->
ack
 = 1;

1141 
t1
->
»s1
 = 0;

1142 
t1
->
»s2
 = 0;

1143 
t1
->
r¡
 = 0;

1144 
t1
->
urg
 = 0;

1145 
t1
->
syn
 = 0;

1146 
t1
->
psh
 = 0;

1147 
sk
->
ack_backlog
 = 0;

1148 
sk
->
by‹s_rcv
 = 0;

1149 
sk
->
wšdow
 = 
	`tı_£Ëù_wšdow
(sk);

1150 
t1
->
wšdow
 = 
	`Áohs
(
sk
->window);

1151 
t1
->
ack_£q
 = 
	`Áohl
(
sk
->
acked_£q
);

1152 
t1
->
doff
 = (*t1)/4;

1153 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, sk->
daddr
, (*t1), sk);

1154 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
buff
, 1);

1155 
	}
}

1165 
	$ş—nup_rbuf
(
sock
 *
sk
)

1167 
æags
;

1168 
Ëá
;

1169 
sk_buff
 *
skb
;

1171 if(
sk
->
debug
)

1172 
	`´štk
("ş—nšg„buàfÜ sk=%p\n", 
sk
);

1174 
	`§ve_æags
(
æags
);

1175 
	`şi
();

1177 
Ëá
 = 
sk
->
´Ù
->
	`r¥aû
(sk);

1183 (
skb
=
	`skb_³ek
(&
sk
->
rqueue
)è!ğ
NULL
 )

1185 ià(!
skb
->
u£d
)

1187 
	`skb_uÆšk
(
skb
);

1188 
skb
->
sk
 = sk;

1189 
	`kä“_skb
(
skb
, 
FREE_READ
);

1192 
	`»¡Üe_æags
(
æags
);

1200 
	`DPRINTF
((
DBG_TCP
, "sk->window†eft = %d, sk->prot->rspace(sk)=%d\n",

1201 
sk
->
wšdow
 - sk->
by‹s_rcv
, sk->
´Ù
->
	`r¥aû
(sk)));

1203 if(
sk
->
debug
)

1204 
	`´štk
("sk->r¥aû = %lu, wa %d\n", 
sk
->
´Ù
->
	`r¥aû
(sk),

1205 
Ëá
);

1206 ià(
sk
->
´Ù
->
	`r¥aû
(skè!ğ
Ëá
)

1218 
sk
->
ack_backlog
++;

1227 ià((
sk
->
´Ù
->
	`r¥aû
(skè> (sk->
wšdow
 - sk->
by‹s_rcv
 + sk->
mtu
))) {

1229 
	`tı_»ad_wakeup
(
sk
);

1232 
was_aùive
 = 
	`d–_tim”
(&
sk
->
tim”
);

1233 ià(!
was_aùive
 || 
TCP_ACK_TIME
 < 
sk
->
tim”
.
expœes
) {

1234 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 
TCP_ACK_TIME
);

1236 
	`add_tim”
(&
sk
->
tim”
);

1239 
	}
}

1244 
	$tı_»ad_urg
(
sock
 * 
sk
, 
nÚblock
,

1245 *
to
, 
Ën
, 
æags
)

1247 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

1249 
Ën
 > 0) {

1250 ià(
sk
->
urgšlše
 || !sk->
urg_d©a
 || sk->urg_d©¨=ğ
URG_READ
)

1251  -
EINVAL
;

1252 ià(
sk
->
urg_d©a
 & 
URG_VALID
) {

1253 
c
 = 
sk
->
urg_d©a
;

1254 ià(!(
æags
 & 
MSG_PEEK
))

1255 
sk
->
urg_d©a
 = 
URG_READ
;

1256 
	`put_fs_by‹
(
c
, 
to
);

1260 ià(
sk
->
”r
) {

1261 
tmp
 = -
sk
->
”r
;

1262 
sk
->
”r
 = 0;

1263  
tmp
;

1266 ià(
sk
->
¡©e
 =ğ
TCP_CLOSE
 || sk->
dÚe
) {

1267 ià(!
sk
->
dÚe
) {

1268 
sk
->
dÚe
 = 1;

1271  -
ENOTCONN
;

1274 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) {

1275 
sk
->
dÚe
 = 1;

1279 ià(
nÚblock
)

1280  -
EAGAIN
;

1282 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
)

1283  -
ERESTARTSYS
;

1285 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1286 
	`add_wa™_queue
(
sk
->
¦“p
, &
wa™
);

1287 ià((
sk
->
urg_d©a
 & 
URG_NOTYET
è&& sk->
”r
 == 0 &&

1288 !(
sk
->
shutdown
 & 
RCV_SHUTDOWN
))

1289 
	`scheduË
();

1290 
	`»move_wa™_queue
(
sk
->
¦“p
, &
wa™
);

1291 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1294 
	}
}

1298 
	$tı_»ad
(
sock
 *
sk
, *
to
,

1299 
Ën
, 
nÚblock
, 
æags
)

1301 
wa™_queue
 
wa™
 = { 
cu¼’t
, 
NULL
 };

1302 
cİ›d
 = 0;

1303 
³ek_£q
;

1304 *
£q
;

1305 
u£d
;

1306 
”r
;

1308 ià(
Ën
 == 0)

1311 ià(
Ën
 < 0)

1312  -
EINVAL
;

1314 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
, 
to
, 
Ën
);

1315 ià(
”r
)

1316  
”r
;

1319 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
)

1320  -
ENOTCONN
;

1323 ià(
æags
 & 
MSG_OOB
)

1324  
	`tı_»ad_urg
(
sk
, 
nÚblock
, 
to
, 
Ën
, 
æags
);

1326 
³ek_£q
 = 
sk
->
cİ›d_£q
;

1327 
£q
 = &
sk
->
cİ›d_£q
;

1328 ià(
æags
 & 
MSG_PEEK
)

1329 
£q
 = &
³ek_£q
;

1331 
	`add_wa™_queue
(
sk
->
¦“p
, &
wa™
);

1332 
sk
->
šu£
 = 1;

1333 
Ën
 > 0) {

1334 
sk_buff
 * 
skb
;

1335 
off£t
;

1340 ià(
cİ›d
 && 
sk
->
urg_d©a
 && sk->
urg_£q
 =ğ1+*
£q
)

1343 
cu¼’t
->
¡©e
 = 
TASK_INTERRUPTIBLE
;

1345 
skb
 = 
sk
->
rqueue
;

1347 ià(!
skb
)

1349 ià(
	`befÜe
(1+*
£q
, 
skb
->
h
.
th
->seq))

1351 
off£t
 = 1 + *
£q
 - 
skb
->
h
.
th
->seq;

1352 ià(
skb
->
h
.
th
->
syn
)

1353 
off£t
--;

1354 ià(
off£t
 < 
skb
->
Ën
)

1355 
found_ok_skb
;

1356 ià(!(
æags
 & 
MSG_PEEK
))

1357 
skb
->
u£d
 = 1;

1358 
skb
 = (
sk_buff
 *)skb->
Ãxt
;

1359 } 
skb
 !ğ
sk
->
rqueue
);

1361 ià(
cİ›d
)

1364 ià(
sk
->
”r
) {

1365 
cİ›d
 = -
sk
->
”r
;

1366 
sk
->
”r
 = 0;

1370 ià(
sk
->
¡©e
 =ğ
TCP_CLOSE
) {

1371 ià(!
sk
->
dÚe
) {

1372 
sk
->
dÚe
 = 1;

1375 
cİ›d
 = -
ENOTCONN
;

1379 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) {

1380 
sk
->
dÚe
 = 1;

1384 ià(
nÚblock
) {

1385 
cİ›d
 = -
EAGAIN
;

1389 
	`ş—nup_rbuf
(
sk
);

1390 
	`»Ëa£_sock
(
sk
);

1391 
	`scheduË
();

1392 
sk
->
šu£
 = 1;

1394 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

1395 
cİ›d
 = -
ERESTARTSYS
;

1400 
found_ok_skb
:

1402 
u£d
 = 
skb
->
Ën
 - 
off£t
;

1403 ià(
Ën
 < 
u£d
)

1404 
u£d
 = 
Ën
;

1406 ià(
sk
->
urg_d©a
) {

1407 
urg_off£t
 = 
sk
->
urg_£q
 - (1 + *
£q
);

1408 ià(
urg_off£t
 < 
u£d
) {

1409 ià(!
urg_off£t
) {

1410 ià(!
sk
->
urgšlše
) {

1411 ++*
£q
;

1412 
off£t
++;

1413 
u£d
--;

1416 
u£d
 = 
urg_off£t
;

1420 
	`memıy_tofs
(
to
,((*)
skb
->
h
.
th
) +

1421 
skb
->
h
.
th
->
doff
*4 + 
off£t
, 
u£d
);

1422 
cİ›d
 +ğ
u£d
;

1423 
Ën
 -ğ
u£d
;

1424 
to
 +ğ
u£d
;

1425 *
£q
 +ğ
u£d
;

1426 ià(
	`aá”
(
sk
->
cİ›d_£q
+1,sk->
urg_£q
))

1427 
sk
->
urg_d©a
 = 0;

1428 ià(!(
æags
 & 
MSG_PEEK
è&& (
u£d
 + 
off£t
 >ğ
skb
->
Ën
))

1429 
skb
->
u£d
 = 1;

1431 
	`»move_wa™_queue
(
sk
->
¦“p
, &
wa™
);

1432 
cu¼’t
->
¡©e
 = 
TASK_RUNNING
;

1435 
	`ş—nup_rbuf
(
sk
);

1436 
	`»Ëa£_sock
(
sk
);

1437 
	`DPRINTF
((
DBG_TCP
, "tı_»ad:„‘uºšg %d\n", 
cİ›d
));

1438  
cİ›d
;

1439 
	}
}

1447 
	$tı_shutdown
(
sock
 *
sk
, 
how
)

1449 
sk_buff
 *
buff
;

1450 
tıhdr
 *
t1
, *
th
;

1451 
´Ùo
 *
´Ù
;

1452 
tmp
;

1453 
deviû
 *
dev
 = 
NULL
;

1463 ià(
sk
->
¡©e
 =ğ
TCP_FIN_WAIT1
 || sk->¡©=ğ
TCP_FIN_WAIT2
) ;

1464 ià(!(
how
 & 
SEND_SHUTDOWN
)) ;

1465 
sk
->
šu£
 = 1;

1468 ià(
sk
->
·¹Ÿl
)

1469 
	`tı_£nd_·¹Ÿl
(
sk
);

1471 
´Ù
 =(
´Ùo
 *)
sk
->prot;

1472 
th
 =(
tıhdr
 *)&
sk
->
dummy_th
;

1473 
	`»Ëa£_sock
(
sk
);

1474 
buff
 = 
´Ù
->
	`wm®loc
(
sk
, 
MAX_RESET_SIZE
,1 , 
GFP_KERNEL
);

1475 ià(
buff
 =ğ
NULL
) ;

1476 
sk
->
šu£
 = 1;

1478 
	`DPRINTF
((
DBG_TCP
, "tı_shutdown_£nd bufàğ%X\n", 
buff
));

1479 
buff
->
mem_addr
 = buff;

1480 
buff
->
mem_Ën
 = 
MAX_RESET_SIZE
;

1481 
buff
->
sk
 = sk;

1482 
buff
->
Ën
 = (*
t1
);

1483 
t1
 =(
tıhdr
 *è
buff
->
d©a
;

1486 
tmp
 = 
´Ù
->
	`bud_h—d”
(
buff
,
sk
->
§ddr
, sk->
daddr
, &
dev
,

1487 
IPPROTO_TCP
, 
sk
->
İt
,

1488 (
tıhdr
),
sk
->
_tos
,sk->
_‰l
);

1489 ià(
tmp
 < 0) {

1490 
buff
->
ä“
=1;

1491 
´Ù
->
	`wä“
(
sk
,
buff
->
mem_addr
, buff->
mem_Ën
);

1492 
	`»Ëa£_sock
(
sk
);

1493 
	`DPRINTF
((
DBG_TCP
, "Unableo build header for fin.\n"));

1497 
t1
 =(
tıhdr
 *)((*é1 +
tmp
);

1498 
buff
->
Ën
 +ğ
tmp
;

1499 
buff
->
dev
 = dev;

1500 
	`memıy
(
t1
, 
th
, (*t1));

1501 
t1
->
£q
 = 
	`Áohl
(
sk
->
wr™e_£q
);

1502 
sk
->
wr™e_£q
++;

1503 
buff
->
h
.
£q
 = 
sk
->
wr™e_£q
;

1504 
t1
->
ack
 = 1;

1505 
t1
->
ack_£q
 = 
	`Áohl
(
sk
->
acked_£q
);

1506 
t1
->
wšdow
 = 
	`Áohs
(
sk
->wšdow=
	`tı_£Ëù_wšdow
(sk) );

1507 
t1
->
fš
 = 1;

1508 
t1
->
r¡
 = 0;

1509 
t1
->
doff
 = (*t1)/4;

1510 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, sk->
daddr
, (*t1), sk);

1516 ià(
sk
->
wback
 !ğ
NULL
) {

1517 
buff
->
ä“
=0;

1518 
buff
->
Ãxt
 = 
NULL
;

1519 
sk
->
wback
->
Ãxt
 = 
buff
;

1520 
sk
->
wback
 = 
buff
;

1521 
buff
->
magic
 = 
TCP_WRITE_QUEUE_MAGIC
;

1523 
sk
->
£Á_£q
 = sk->
wr™e_£q
;

1524 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
buff
, 0);

1527 ià(
sk
->
¡©e
 =ğ
TCP_ESTABLISHED
èsk->¡©ğ
TCP_FIN_WAIT1
;

1528 
sk
->
¡©e
 = 
TCP_FIN_WAIT2
;

1530 
	`»Ëa£_sock
(
sk
);

1531 
	}
}

1535 
	$tı_»cväom
(
sock
 *
sk
, *
to
,

1536 
to_Ën
, 
nÚblock
, 
æags
,

1537 
sockaddr_š
 *
addr
, *
addr_Ën
)

1539 
sockaddr_š
 
sš
;

1540 
Ën
;

1541 
”r
;

1542 
»suÉ
;

1547 
”r
 = 
	`v”ify_¬—
(
VERIFY_WRITE
,
addr_Ën
,());

1548 if(
”r
)

1549  
”r
;

1550 
Ën
 = 
	`g‘_fs_lÚg
(
addr_Ën
);

1551 if(
Ën
 > (
sš
))

1552 
Ën
 = (
sš
);

1553 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
addr
, 
Ën
);

1554 if(
”r
)

1555  
”r
;

1557 
»suÉ
=
	`tı_»ad
(
sk
, 
to
, 
to_Ën
, 
nÚblock
, 
æags
);

1559 ià(
»suÉ
 < 0) (result);

1561 
sš
.
sš_çmy
 = 
AF_INET
;

1562 
sš
.
sš_pÜt
 = 
sk
->
dummy_th
.
de¡
;

1563 
sš
.
sš_addr
.
s_addr
 = 
sk
->
daddr
;

1565 
	`memıy_tofs
(
addr
, &
sš
, 
Ën
);

1566 
	`put_fs_lÚg
(
Ën
, 
addr_Ën
);

1567 (
»suÉ
);

1568 
	}
}

1573 
	$tı_»£t
(
§ddr
, 
daddr
, 
tıhdr
 *
th
,

1574 
´Ùo
 *
´Ù
, 
İtiÚs
 *
İt
, 
deviû
 *
dev
, 
tos
, 
‰l
)

1576 
sk_buff
 *
buff
;

1577 
tıhdr
 *
t1
;

1578 
tmp
;

1584 
buff
 = 
´Ù
->
	`wm®loc
(
NULL
, 
MAX_RESET_SIZE
, 1, 
GFP_ATOMIC
);

1585 ià(
buff
 =ğ
NULL
)

1588 
	`DPRINTF
((
DBG_TCP
, "tı_»£ˆbufàğ%X\n", 
buff
));

1589 
buff
->
mem_addr
 = buff;

1590 
buff
->
mem_Ën
 = 
MAX_RESET_SIZE
;

1591 
buff
->
Ën
 = (*
t1
);

1592 
buff
->
sk
 = 
NULL
;

1593 
buff
->
dev
 = dev;

1595 
t1
 =(
tıhdr
 *è
buff
->
d©a
;

1598 
tmp
 = 
´Ù
->
	`bud_h—d”
(
buff
, 
§ddr
, 
daddr
, &
dev
, 
IPPROTO_TCP
, 
İt
,

1599 (
tıhdr
),
tos
,
‰l
);

1600 ià(
tmp
 < 0) {

1601 
buff
->
ä“
 = 1;

1602 
´Ù
->
	`wä“
(
NULL
, 
buff
->
mem_addr
, buff->
mem_Ën
);

1605 
t1
 =(
tıhdr
 *)((*é1 +
tmp
);

1606 
buff
->
Ën
 +ğ
tmp
;

1607 
	`memıy
(
t1
, 
th
, (*t1));

1610 
t1
->
de¡
 = 
th
->
sourû
;

1611 
t1
->
sourû
 = 
th
->
de¡
;

1612 
t1
->
r¡
 = 1;

1613 
t1
->
wšdow
 = 0;

1615 if(
th
->
ack
)

1617 
t1
->
ack
 = 0;

1618 
t1
->
£q
 = 
th
->
ack_£q
;

1619 
t1
->
ack_£q
 = 0;

1623 
t1
->
ack
 = 1;

1624 if(!
th
->
syn
)

1625 
t1
->
ack_£q
=
	`htÚl
(
th
->
£q
);

1627 
t1
->
ack_£q
=
	`htÚl
(
th
->
£q
+1);

1628 
t1
->
£q
=0;

1631 
t1
->
syn
 = 0;

1632 
t1
->
urg
 = 0;

1633 
t1
->
fš
 = 0;

1634 
t1
->
psh
 = 0;

1635 
t1
->
doff
 = (*t1)/4;

1636 
	`tı_£nd_check
(
t1
, 
§ddr
, 
daddr
, (*t1), 
NULL
);

1637 
´Ù
->
	`queue_xm™
(
NULL
, 
dev
, 
buff
, 1);

1638 
	}
}

1650 
	$tı_İtiÚs
(
sock
 *
sk
, 
tıhdr
 *
th
)

1652 *
±r
;

1653 
Ëngth
=(
th
->
doff
*4)-(
tıhdr
);

1654 
mss_£’
 = 0;

1656 
±r
 = (*)(
th
 + 1);

1658 
Ëngth
>0)

1660 
İcode
=*
±r
++;

1661 
İsize
=*
±r
++;

1662 
İcode
)

1664 
TCPOPT_EOL
:

1666 
TCPOPT_NOP
:

1667 
Ëngth
-=2;

1671 if(
İsize
<=2)

1673 
İcode
)

1675 
TCPOPT_MSS
:

1676 if(
İsize
==4 && 
th
->
syn
)

1678 
sk
->
mtu
=
	`mš
(sk->mtu,
	`Áohs
(*(*)
±r
));

1679 
mss_£’
 = 1;

1684 
±r
+=
İsize
-2;

1685 
Ëngth
-=
İsize
;

1688 ià(
th
->
syn
) {

1689 ià(! 
mss_£’
)

1690 
sk
->
mtu
=
	`mš
(sk->mtu, 536);

1692 
sk
->
mss
 = 
	`mš
(sk->
max_wšdow
, sk->
mtu
);

1693 
	}
}

1695 
šlše
 
	$deçuÉ_mask
(
d¡
)

1697 
d¡
 = 
	`Áohl
(dst);

1698 ià(
	`IN_CLASSA
(
d¡
))

1699  
	`htÚl
(
IN_CLASSA_NET
);

1700 ià(
	`IN_CLASSB
(
d¡
))

1701  
	`htÚl
(
IN_CLASSB_NET
);

1702  
	`htÚl
(
IN_CLASSC_NET
);

1703 
	}
}

1713 
	$tı_cÚn_»que¡
(
sock
 *
sk
, 
sk_buff
 *
skb
,

1714 
daddr
, 
§ddr
,

1715 
İtiÚs
 *
İt
, 
deviû
 *
dev
)

1717 
sk_buff
 *
buff
;

1718 
tıhdr
 *
t1
;

1719 *
±r
;

1720 
sock
 *
Ãwsk
;

1721 
tıhdr
 *
th
;

1722 
tmp
;

1724 
	`DPRINTF
((
DBG_TCP
, "tcp_conn_request(sk = %X, skb = %X, daddr = %X, sadd4= %X, \n"

1726 
sk
, 
skb
, 
daddr
, 
§ddr
, 
İt
, 
dev
));

1728 
th
 = 
skb
->
h
.th;

1731 ià(!
sk
->
d—d
) {

1732 
sk
->
	`d©a_»ady
(sk,0);

1734 
	`DPRINTF
((
DBG_TCP
, "tcp_conn_request on dead socket\n"));

1735 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
sk
->
´Ù
, 
İt
, 
dev
, sk->
_tos
,sk->
_‰l
);

1736 
	`kä“_skb
(
skb
, 
FREE_READ
);

1744 ià(
sk
->
ack_backlog
 >ğsk->
max_ack_backlog
) {

1745 
	`kä“_skb
(
skb
, 
FREE_READ
);

1756 
Ãwsk
 = (
sock
 *è
	`km®loc
((sock), 
GFP_ATOMIC
);

1757 ià(
Ãwsk
 =ğ
NULL
) {

1759 
	`kä“_skb
(
skb
, 
FREE_READ
);

1763 
	`DPRINTF
((
DBG_TCP
, "Ãwsk = %X\n", 
Ãwsk
));

1764 
	`memıy
((*)
Ãwsk
,(*)
sk
, (*newsk));

1765 
Ãwsk
->
wback
 = 
NULL
;

1766 
Ãwsk
->
wäÚt
 = 
NULL
;

1767 
Ãwsk
->
rqueue
 = 
NULL
;

1768 
Ãwsk
->
£nd_h—d
 = 
NULL
;

1769 
Ãwsk
->
£nd_
 = 
NULL
;

1770 
Ãwsk
->
back_log
 = 
NULL
;

1771 
Ãwsk
->
¹t
 = 
TCP_CONNECT_TIME
 << 3;

1772 
Ãwsk
->
¹o
 = 
TCP_CONNECT_TIME
;

1773 
Ãwsk
->
mdev
 = 0;

1774 
Ãwsk
->
max_wšdow
 = 0;

1775 
Ãwsk
->
cÚg_wšdow
 = 1;

1776 
Ãwsk
->
cÚg_couÁ
 = 0;

1777 
Ãwsk
->
s¡h»sh
 = 0;

1778 
Ãwsk
->
backoff
 = 0;

1779 
Ãwsk
->
blog
 = 0;

1780 
Ãwsk
->
šŒ
 = 0;

1781 
Ãwsk
->
´oc
 = 0;

1782 
Ãwsk
->
dÚe
 = 0;

1783 
Ãwsk
->
·¹Ÿl
 = 
NULL
;

1784 
Ãwsk
->
·œ
 = 
NULL
;

1785 
Ãwsk
->
wmem_®loc
 = 0;

1786 
Ãwsk
->
rmem_®loc
 = 0;

1788 
Ãwsk
->
max_uÇcked
 = 
MAX_WINDOW
 - 
TCP_WINDOW_DIFF
;

1790 
Ãwsk
->
”r
 = 0;

1791 
Ãwsk
->
shutdown
 = 0;

1792 
Ãwsk
->
ack_backlog
 = 0;

1793 
Ãwsk
->
acked_£q
 = 
skb
->
h
.
th
->
£q
+1;

1794 
Ãwsk
->
fš_£q
 = 
skb
->
h
.
th
->
£q
;

1795 
Ãwsk
->
cİ›d_£q
 = 
skb
->
h
.
th
->
£q
;

1796 
Ãwsk
->
¡©e
 = 
TCP_SYN_RECV
;

1797 
Ãwsk
->
timeout
 = 0;

1798 
Ãwsk
->
wr™e_£q
 = 
jiff›s
 * 
SEQ_TICK
 - 
£q_off£t
;

1799 
Ãwsk
->
wšdow_£q
 =‚ewsk->
wr™e_£q
;

1800 
Ãwsk
->
rcv_ack_£q
 =‚ewsk->
wr™e_£q
;

1801 
Ãwsk
->
urg_d©a
 = 0;

1802 
Ãwsk
->
»Œªsm™s
 = 0;

1803 
Ãwsk
->
de¡roy
 = 0;

1804 
Ãwsk
->
tim”
.
d©a
 = ()newsk;

1805 
Ãwsk
->
tim”
.
funùiÚ
 = &
Ãt_tim”
;

1806 
Ãwsk
->
dummy_th
.
sourû
 = 
skb
->
h
.
th
->
de¡
;

1807 
Ãwsk
->
dummy_th
.
de¡
 = 
skb
->
h
.
th
->
sourû
;

1810 
Ãwsk
->
daddr
 = 
§ddr
;

1811 
Ãwsk
->
§ddr
 = 
daddr
;

1813 
	`put_sock
(
Ãwsk
->
num
,newsk);

1814 
Ãwsk
->
dummy_th
.
»s1
 = 0;

1815 
Ãwsk
->
dummy_th
.
doff
 = 6;

1816 
Ãwsk
->
dummy_th
.
fš
 = 0;

1817 
Ãwsk
->
dummy_th
.
syn
 = 0;

1818 
Ãwsk
->
dummy_th
.
r¡
 = 0;

1819 
Ãwsk
->
dummy_th
.
psh
 = 0;

1820 
Ãwsk
->
dummy_th
.
ack
 = 0;

1821 
Ãwsk
->
dummy_th
.
urg
 = 0;

1822 
Ãwsk
->
dummy_th
.
»s2
 = 0;

1823 
Ãwsk
->
acked_£q
 = 
skb
->
h
.
th
->
£q
 + 1;

1824 
Ãwsk
->
cİ›d_£q
 = 
skb
->
h
.
th
->
£q
;

1827 
Ãwsk
->
_‰l
=
sk
->ip_ttl;

1828 
Ãwsk
->
_tos
=
skb
->
_hdr
->
tos
;

1832 ià(
sk
->
u£r_mss
)

1833 
Ãwsk
->
mtu
 = 
sk
->
u£r_mss
;

1835 #ifdeà
SUBNETSARELOCAL


1836 ià((
§ddr
 ^ 
daddr
è& 
	`deçuÉ_mask
(saddr))

1838 ià((
§ddr
 ^ 
daddr
è& 
dev
->
·_mask
)

1840 
Ãwsk
->
mtu
 = 576 - 
HEADER_SIZE
;

1842 
Ãwsk
->
mtu
 = 
MAX_WINDOW
;

1845 
Ãwsk
->
mtu
 = 
	`mš
Òewsk->mtu, 
dev
->mtu - 
HEADER_SIZE
);

1848 
	`tı_İtiÚs
(
Ãwsk
,
skb
->
h
.
th
);

1850 
buff
 = 
Ãwsk
->
´Ù
->
	`wm®loc
Òewsk, 
MAX_SYN_SIZE
, 1, 
GFP_ATOMIC
);

1851 ià(
buff
 =ğ
NULL
) {

1852 
sk
->
”r
 = -
ENOMEM
;

1853 
Ãwsk
->
d—d
 = 1;

1854 
	`»Ëa£_sock
(
Ãwsk
);

1855 
	`kä“_skb
(
skb
, 
FREE_READ
);

1859 
buff
->
mem_addr
 = buff;

1860 
buff
->
mem_Ën
 = 
MAX_SYN_SIZE
;

1861 
buff
->
Ën
 = (
tıhdr
)+4;

1862 
buff
->
sk
 = 
Ãwsk
;

1864 
t1
 =(
tıhdr
 *è
buff
->
d©a
;

1867 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
buff
, 
Ãwsk
->
§ddr
,‚ewsk->
daddr
, &
dev
,

1868 
IPPROTO_TCP
, 
NULL
, 
MAX_SYN_SIZE
,
sk
->
_tos
,sk->
_‰l
);

1871 ià(
tmp
 < 0) {

1872 
sk
->
”r
 = 
tmp
;

1873 
buff
->
ä“
=1;

1874 
	`kä“_skb
(
buff
,
FREE_WRITE
);

1875 
Ãwsk
->
d—d
 = 1;

1876 
	`»Ëa£_sock
(
Ãwsk
);

1877 
skb
->
sk
 = sk;

1878 
	`kä“_skb
(
skb
, 
FREE_READ
);

1882 
buff
->
Ën
 +ğ
tmp
;

1883 
t1
 =(
tıhdr
 *)((*é1 +
tmp
);

1885 
	`memıy
(
t1
, 
skb
->
h
.
th
, (*t1));

1886 
buff
->
h
.
£q
 = 
Ãwsk
->
wr™e_£q
;

1889 
t1
->
de¡
 = 
skb
->
h
.
th
->
sourû
;

1890 
t1
->
sourû
 = 
Ãwsk
->
dummy_th
.source;

1891 
t1
->
£q
 = 
	`Áohl
(
Ãwsk
->
wr™e_£q
++);

1892 
t1
->
ack
 = 1;

1893 
Ãwsk
->
wšdow
 = 
	`tı_£Ëù_wšdow
(newsk);

1894 
Ãwsk
->
£Á_£q
 =‚ewsk->
wr™e_£q
;

1895 
t1
->
wšdow
 = 
	`Áohs
(
Ãwsk
->window);

1896 
t1
->
»s1
 = 0;

1897 
t1
->
»s2
 = 0;

1898 
t1
->
r¡
 = 0;

1899 
t1
->
urg
 = 0;

1900 
t1
->
psh
 = 0;

1901 
t1
->
syn
 = 1;

1902 
t1
->
ack_£q
 = 
	`Áohl
(
skb
->
h
.
th
->
£q
+1);

1903 
t1
->
doff
 = (*t1)/4+1;

1905 
±r
 =(*)(
t1
+1);

1906 
±r
[0] = 2;

1907 
±r
[1] = 4;

1908 
±r
[2] = ((
Ãwsk
->
mtu
) >> 8) & 0xff;

1909 
±r
[3] =(
Ãwsk
->
mtu
) & 0xff;

1911 
	`tı_£nd_check
(
t1
, 
daddr
, 
§ddr
, (*t1)+4, 
Ãwsk
);

1912 
Ãwsk
->
´Ù
->
	`queue_xm™
Òewsk, 
dev
, 
buff
, 0);

1914 
	`»£t_tim”
(
Ãwsk
, 
TIME_WRITE
 , 
TCP_CONNECT_TIME
);

1915 
skb
->
sk
 = 
Ãwsk
;

1918 
sk
->
rmem_®loc
 -ğ
skb
->
mem_Ën
;

1919 
Ãwsk
->
rmem_®loc
 +ğ
skb
->
mem_Ën
;

1921 
	`skb_queue_
(&
sk
->
rqueue
,
skb
);

1922 
sk
->
ack_backlog
++;

1923 
	`»Ëa£_sock
(
Ãwsk
);

1924 
	}
}

1928 
	$tı_şo£
(
sock
 *
sk
, 
timeout
)

1930 
sk_buff
 *
buff
;

1931 
Ãed_»£t
 = 0;

1932 
tıhdr
 *
t1
, *
th
;

1933 
´Ùo
 *
´Ù
;

1934 
deviû
 *
dev
=
NULL
;

1935 
tmp
;

1941 
	`DPRINTF
((
DBG_TCP
, "tı_şo£((¡ruù sock *)%X, %d)\n",
sk
, 
timeout
));

1942 
sk
->
šu£
 = 1;

1943 
sk
->
k“pİ’
 = 1;

1944 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

1946 ià(!
sk
->
d—d
)

1947 
sk
->
	`¡©e_chªge
(sk);

1950 ià(
	`skb_³ek
(&
sk
->
rqueue
è!ğ
NULL
)

1952 
sk_buff
 *
skb
;

1953 if(
sk
->
debug
)

1954 
	`´štk
("Clean„cv queue\n");

1955 (
skb
=
	`skb_dequeue
(&
sk
->
rqueue
))!=
NULL
)

1957 if(
skb
->
Ën
 > 0 && 
	`aá”
(skb->
h
.
th
->
£q
 + skb->ËÀ+ 1 , 
sk
->
cİ›d_£q
))

1958 
Ãed_»£t
 = 1;

1959 
	`kä“_skb
(
skb
, 
FREE_READ
);

1961 if(
sk
->
debug
)

1962 
	`´štk
("Cleaned.\n");

1964 
sk
->
rqueue
 = 
NULL
;

1967 ià(
sk
->
·¹Ÿl
) {

1968 
	`tı_£nd_·¹Ÿl
(
sk
);

1971 
sk
->
¡©e
) {

1972 
TCP_FIN_WAIT1
:

1973 
TCP_FIN_WAIT2
:

1974 
TCP_LAST_ACK
:

1980 
	`»£t_tim”
(
sk
, 
TIME_CLOSE
, 4 * sk->
¹o
);

1981 ià(
timeout
è
	`tı_time_wa™
(
sk
);

1982 
	`»Ëa£_sock
(
sk
);

1984 
TCP_TIME_WAIT
:

1985 ià(
timeout
) {

1986 
sk
->
¡©e
 = 
TCP_CLOSE
;

1988 
	`»Ëa£_sock
(
sk
);

1990 
TCP_LISTEN
:

1991 
sk
->
¡©e
 = 
TCP_CLOSE
;

1992 
	`»Ëa£_sock
(
sk
);

1994 
TCP_CLOSE
:

1995 
	`»Ëa£_sock
(
sk
);

1997 
TCP_CLOSE_WAIT
:

1998 
TCP_ESTABLISHED
:

1999 
TCP_SYN_SENT
:

2000 
TCP_SYN_RECV
:

2001 
´Ù
 =(
´Ùo
 *)
sk
->prot;

2002 
th
 =(
tıhdr
 *)&
sk
->
dummy_th
;

2003 
buff
 = 
´Ù
->
	`wm®loc
(
sk
, 
MAX_FIN_SIZE
, 1, 
GFP_ATOMIC
);

2004 ià(
buff
 =ğ
NULL
) {

2008 
	`»Ëa£_sock
(
sk
);

2009 ià(
sk
->
¡©e
 !ğ
TCP_CLOSE_WAIT
)

2010 
sk
->
¡©e
 = 
TCP_ESTABLISHED
;

2011 
	`»£t_tim”
(
sk
, 
TIME_CLOSE
, 100);

2014 
buff
->
mem_addr
 = buff;

2015 
buff
->
mem_Ën
 = 
MAX_FIN_SIZE
;

2016 
buff
->
sk
 = sk;

2017 
buff
->
ä“
 = 1;

2018 
buff
->
Ën
 = (*
t1
);

2019 
t1
 =(
tıhdr
 *è
buff
->
d©a
;

2022 
tmp
 = 
´Ù
->
	`bud_h—d”
(
buff
,
sk
->
§ddr
, sk->
daddr
, &
dev
,

2023 
IPPROTO_TCP
, 
sk
->
İt
,

2024 (
tıhdr
),
sk
->
_tos
,sk->
_‰l
);

2025 ià(
tmp
 < 0) {

2026 
	`kä“_skb
(
buff
,
FREE_WRITE
);

2027 
	`DPRINTF
((
DBG_TCP
, "Unableo build header for fin.\n"));

2028 
	`»Ëa£_sock
(
sk
);

2032 
t1
 =(
tıhdr
 *)((*é1 +
tmp
);

2033 
buff
->
Ën
 +ğ
tmp
;

2034 
buff
->
dev
 = dev;

2035 
	`memıy
(
t1
, 
th
, (*t1));

2036 
t1
->
£q
 = 
	`Áohl
(
sk
->
wr™e_£q
);

2037 
sk
->
wr™e_£q
++;

2038 
buff
->
h
.
£q
 = 
sk
->
wr™e_£q
;

2039 
t1
->
ack
 = 1;

2042 
sk
->
d–ay_acks
 = 0;

2043 
t1
->
ack_£q
 = 
	`Áohl
(
sk
->
acked_£q
);

2044 
t1
->
wšdow
 = 
	`Áohs
(
sk
->wšdow=
	`tı_£Ëù_wšdow
(sk) );

2045 
t1
->
fš
 = 1;

2046 
t1
->
r¡
 = 
Ãed_»£t
;

2047 
t1
->
doff
 = (*t1)/4;

2048 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, sk->
daddr
, (*t1), sk);

2050 ià(
sk
->
wäÚt
 =ğ
NULL
) {

2051 
sk
->
£Á_£q
 = sk->
wr™e_£q
;

2052 
´Ù
->
	`queue_xm™
(
sk
, 
dev
, 
buff
, 0);

2054 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, sk->
¹o
);

2055 
buff
->
Ãxt
 = 
NULL
;

2056 ià(
sk
->
wback
 =ğ
NULL
) {

2057 
sk
->
wäÚt
 = 
buff
;

2059 
sk
->
wback
->
Ãxt
 = 
buff
;

2061 
sk
->
wback
 = 
buff
;

2062 
buff
->
magic
 = 
TCP_WRITE_QUEUE_MAGIC
;

2065 ià(
sk
->
¡©e
 =ğ
TCP_CLOSE_WAIT
) {

2066 
sk
->
¡©e
 = 
TCP_FIN_WAIT2
;

2068 
sk
->
¡©e
 = 
TCP_FIN_WAIT1
;

2071 
	`»Ëa£_sock
(
sk
);

2072 
	}
}

2080 
	$tı_wr™e_xm™
(
sock
 *
sk
)

2082 
sk_buff
 *
skb
;

2084 
	`DPRINTF
((
DBG_TCP
, "tı_wr™e_xm™(sk=%X)\n", 
sk
));

2088 if(
sk
->
z­³d
)

2091 
sk
->
wäÚt
 !ğ
NULL
 &&

2092 
	`befÜe
(
sk
->
wäÚt
->
h
.
£q
, sk->
wšdow_£q
 +1) &&

2093 (
sk
->
»Œªsm™s
 == 0 ||

2094 
sk
->
timeout
 !ğ
TIME_WRITE
 ||

2095 
	`befÜe
(
sk
->
wäÚt
->
h
.
£q
, sk->
rcv_ack_£q
 +1))

2096 && 
sk
->
·ck‘s_out
 < sk->
cÚg_wšdow
) {

2097 
skb
 = 
sk
->
wäÚt
;

2098 
	`IS_SKB
(
skb
);

2099 
sk
->
wäÚt
 = 
skb
->
Ãxt
;

2100 ià(
sk
->
wäÚt
 =ğ
NULL
èsk->
wback
 = NULL;

2101 
skb
->
Ãxt
 = 
NULL
;

2102 ià(
skb
->
magic
 !ğ
TCP_WRITE_QUEUE_MAGIC
) {

2103 
	`´štk
("tcp.c skb with bad magic(%X) on write queue. Squashing "

2104 "queue\n", 
skb
->
magic
);

2105 
sk
->
wäÚt
 = 
NULL
;

2106 
sk
->
wback
 = 
NULL
;

2109 
skb
->
magic
 = 0;

2110 
	`DPRINTF
((
DBG_TCP
, "Sending‡…acket.\n"));

2113 ià(
	`befÜe
(
skb
->
h
.
£q
, 
sk
->
rcv_ack_£q
 +1)) {

2114 
sk
->
»Œªsm™s
 = 0;

2115 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

2116 ià(!
sk
->
d—d
èsk->
	`wr™e_¥aû
(sk);

2118 
sk
->
£Á_£q
 = 
skb
->
h
.
£q
;

2119 
sk
->
´Ù
->
	`queue_xm™
(sk, 
skb
->
dev
, skb, skb->
ä“
);

2122 
	}
}

2130 
	$sÜt_£nd
(
sock
 *
sk
)

2132 
sk_buff
 *
li¡
 = 
NULL
;

2133 
sk_buff
 *
skb
,*
skb2
,*
skb3
;

2135 
skb
 = 
sk
->
£nd_h—d
; skb !ğ
NULL
; skb = 
skb2
) {

2136 
skb2
 = (
sk_buff
 *)
skb
->
lšk3
;

2137 ià(
li¡
 =ğ
NULL
 || 
	`befÜe
 (
skb2
->
h
.
£q
,†ist->h.seq)) {

2138 
skb
->
lšk3
 = 
li¡
;

2139 
sk
->
£nd_
 = 
skb
;

2140 
li¡
 = 
skb
;

2142 
skb3
 = 
li¡
; ; skb3 = (
sk_buff
 *)skb3->
lšk3
) {

2143 ià(
skb3
->
lšk3
 =ğ
NULL
 ||

2144 
	`befÜe
(
skb
->
h
.
£q
, 
skb3
->
lšk3
->h.seq)) {

2145 
skb
->
lšk3
 = 
skb3
->link3;

2146 
skb3
->
lšk3
 = 
skb
;

2147 ià(
skb
->
lšk3
 =ğ
NULL
è
sk
->
£nd_
 = skb;

2153 
sk
->
£nd_h—d
 = 
li¡
;

2154 
	}
}

2159 
	$tı_ack
(
sock
 *
sk
, 
tıhdr
 *
th
, 
§ddr
, 
Ën
)

2161 
ack
;

2162 
æag
 = 0;

2170 if(
sk
->
z­³d
)

2173 
ack
 = 
	`Áohl
(
th
->
ack_£q
);

2174 
	`DPRINTF
((
DBG_TCP
, "tcp_ack‡ck=%d, window=%d, "

2176 
ack
, 
	`Áohs
(
th
->
wšdow
), 
sk
->
rcv_ack_£q
, sk->
wšdow_£q
));

2178 ià(
	`Áohs
(
th
->
wšdow
è> 
sk
->
max_wšdow
) {

2179 
sk
->
max_wšdow
 = 
	`Áohs
(
th
->
wšdow
);

2180 
sk
->
mss
 = 
	`mš
(sk->
max_wšdow
, sk->
mtu
);

2183 ià(
sk
->
»Œªsm™s
 && sk->
timeout
 =ğ
TIME_KEEPOPEN
)

2184 
sk
->
»Œªsm™s
 = 0;

2187 ià(
	`aá”
(
ack
, 
sk
->
£Á_£q
+1è|| 
	`befÜe
×ck, sk->
rcv_ack_£q
-1)) {

2188 ià(
	`aá”
(
ack
, 
sk
->
£Á_£q
) ||

2189 (
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->¡©!ğ
TCP_CLOSE_WAIT
)) {

2192 ià(
sk
->
k“pİ’
) {

2193 
	`»£t_tim”
(
sk
, 
TIME_KEEPOPEN
, 
TCP_TIMEOUT_LEN
);

2198 ià(
Ën
 !ğ
th
->
doff
*4è
æag
 |= 1;

2201 ià(
	`aá”
(
sk
->
wšdow_£q
, 
ack
+
	`Áohs
(
th
->
wšdow
))) {

2209 
sk_buff
 *
skb
;

2210 
sk_buff
 *
skb2
;

2211 
sk_buff
 *
wskb
 = 
NULL
;

2213 
skb2
 = 
sk
->
£nd_h—d
;

2214 
sk
->
£nd_h—d
 = 
NULL
;

2215 
sk
->
£nd_
 = 
NULL
;

2217 
æag
 |= 4;

2219 
sk
->
wšdow_£q
 = 
ack
 + 
	`Áohs
(
th
->
wšdow
);

2220 
	`şi
();

2221 
skb2
 !ğ
NULL
) {

2222 
skb
 = 
skb2
;

2223 
skb2
 = (
sk_buff
 *)
skb
->
lšk3
;

2224 
skb
->
lšk3
 = 
NULL
;

2225 ià(
	`aá”
(
skb
->
h
.
£q
, 
sk
->
wšdow_£q
)) {

2226 ià(
sk
->
·ck‘s_out
 > 0) sk->packets_out--;

2228 ià(
skb
->
Ãxt
 !ğ
NULL
) {

2229 
	`skb_uÆšk
(
skb
);

2232 
skb
->
magic
 = 
TCP_WRITE_QUEUE_MAGIC
;

2233 ià(
wskb
 =ğ
NULL
) {

2234 
skb
->
Ãxt
 = 
sk
->
wäÚt
;

2235 
sk
->
wäÚt
 = 
skb
;

2237 
skb
->
Ãxt
 = 
wskb
->next;

2238 
wskb
->
Ãxt
 = 
skb
;

2240 ià(
sk
->
wback
 =ğ
wskb
èsk->wback = 
skb
;

2241 
wskb
 = 
skb
;

2243 ià(
sk
->
£nd_h—d
 =ğ
NULL
) {

2244 
sk
->
£nd_h—d
 = 
skb
;

2245 
sk
->
£nd_
 = 
skb
;

2247 
sk
->
£nd_
->
lšk3
 = 
skb
;

2248 
sk
->
£nd_
 = 
skb
;

2250 
skb
->
lšk3
 = 
NULL
;

2253 
	`¡i
();

2256 ià(
sk
->
£nd_
 =ğ
NULL
 || sk->
£nd_h—d
 == NULL) {

2257 
sk
->
£nd_h—d
 = 
NULL
;

2258 
sk
->
£nd_
 = 
NULL
;

2259 
sk
->
·ck‘s_out
= 0;

2262 
sk
->
wšdow_£q
 = 
ack
 + 
	`Áohs
(
th
->
wšdow
);

2265 ià(
sk
->
timeout
 =ğ
TIME_WRITE
 &&

2266 
sk
->
cÚg_wšdow
 < 2048 && 
	`aá”
(
ack
, sk->
rcv_ack_£q
)) {

2276 ià(
sk
->
cÚg_wšdow
 < sk->
s¡h»sh
)

2278 
sk
->
cÚg_wšdow
++;

2283 ià(
sk
->
cÚg_couÁ
 >ğsk->
cÚg_wšdow
) {

2284 
sk
->
cÚg_wšdow
++;

2285 
sk
->
cÚg_couÁ
 = 0;

2287 
sk
->
cÚg_couÁ
++;

2291 
	`DPRINTF
((
DBG_TCP
, "tcp_ack: Updating„cv‡ck sequence.\n"));

2292 
sk
->
rcv_ack_£q
 = 
ack
;

2299 ià(
sk
->
timeout
 =ğ
TIME_PROBE0
) {

2300 ià(
sk
->
wäÚt
 !ğ
NULL
 &&

2301 ! 
	`befÜe
 (
sk
->
wšdow_£q
, sk->
wäÚt
->
h
.
£q
)) {

2302 
sk
->
»Œªsm™s
 = 0;

2303 
sk
->
backoff
 = 0;

2305 
sk
->
¹o
 = ((sk->
¹t
 >> 2è+ sk->
mdev
) >> 1;

2306 ià(
sk
->
¹o
 > 120*
HZ
)

2307 
sk
->
¹o
 = 120*
HZ
;

2308 ià(
sk
->
¹o
 < 1*
HZ
)

2309 
sk
->
¹o
 = 1*
HZ
;

2314 
sk
->
£nd_h—d
 !ğ
NULL
) {

2316 ià(
sk
->
£nd_h—d
->
lšk3
 &&

2317 
	`aá”
(
sk
->
£nd_h—d
->
h
.
£q
, sk->£nd_h—d->
lšk3
->h.seq)) {

2318 
	`´štk
("INET:cp.c: *** bug send_list out of order.\n");

2319 
	`sÜt_£nd
(
sk
);

2322 ià(
	`befÜe
(
sk
->
£nd_h—d
->
h
.
£q
, 
ack
+1)) {

2323 
sk_buff
 *
oskb
;

2325 ià(
sk
->
»Œªsm™s
) {

2328 
æag
 |= 2;

2338 ià(
sk
->
£nd_h—d
->
lšk3
)

2339 
sk
->
»Œªsm™s
 = 1;

2341 
sk
->
»Œªsm™s
 = 0;

2358 ià(
sk
->
·ck‘s_out
 > 0) sk->packets_out --;

2359 
	`DPRINTF
((
DBG_TCP
, "skb=%X skb->h.seq = %d‡cked‡ck=%d\n",

2360 
sk
->
£nd_h—d
, sk->£nd_h—d->
h
.
£q
, 
ack
));

2363 ià(!
sk
->
d—d
èsk->
	`wr™e_¥aû
(sk);

2365 
oskb
 = 
sk
->
£nd_h—d
;

2367 ià(!(
æag
&2)) {

2368 
m
;

2377 
m
 = 
jiff›s
 - 
oskb
->
wh’
;

2378 
m
 -ğ(
sk
->
¹t
 >> 3);

2379 
sk
->
¹t
 +ğ
m
;

2380 ià(
m
 < 0)

2381 
m
 = -m;

2382 
m
 -ğ(
sk
->
mdev
 >> 2);

2383 
sk
->
mdev
 +ğ
m
;

2386 
sk
->
¹o
 = ((sk->
¹t
 >> 2è+ sk->
mdev
) >> 1;

2387 ià(
sk
->
¹o
 > 120*
HZ
)

2388 
sk
->
¹o
 = 120*
HZ
;

2389 ià(
sk
->
¹o
 < 1*
HZ
)

2390 
sk
->
¹o
 = 1*
HZ
;

2391 
sk
->
backoff
 = 0;

2394 
æag
 |= (2|4);

2396 
	`şi
();

2398 
oskb
 = 
sk
->
£nd_h—d
;

2399 
	`IS_SKB
(
oskb
);

2400 
sk
->
£nd_h—d
 =(
sk_buff
 *)
oskb
->
lšk3
;

2401 ià(
sk
->
£nd_h—d
 =ğ
NULL
) {

2402 
sk
->
£nd_
 = 
NULL
;

2406 
	`skb_uÆšk
(
oskb
);

2407 
	`¡i
();

2408 
oskb
->
magic
 = 0;

2409 
	`kä“_skb
(
oskb
, 
FREE_WRITE
);

2410 ià(!
sk
->
d—d
èsk->
	`wr™e_¥aû
(sk);

2420 ià(
sk
->
wäÚt
 !ğ
NULL
) {

2421 ià(
	`aá”
 (
sk
->
wšdow_£q
+1, sk->
wäÚt
->
h
.
£q
) &&

2422 (
sk
->
»Œªsm™s
 == 0 ||

2423 
sk
->
timeout
 !ğ
TIME_WRITE
 ||

2424 
	`befÜe
(
sk
->
wäÚt
->
h
.
£q
, sk->
rcv_ack_£q
 +1))

2425 && 
sk
->
·ck‘s_out
 < sk->
cÚg_wšdow
) {

2426 
æag
 |= 1;

2427 
	`tı_wr™e_xm™
(
sk
);

2428 } ià(
	`befÜe
(
sk
->
wšdow_£q
, sk->
wäÚt
->
h
.
£q
) &&

2429 
sk
->
£nd_h—d
 =ğ
NULL
 &&

2430 
sk
->
ack_backlog
 == 0 &&

2431 
sk
->
¡©e
 !ğ
TCP_TIME_WAIT
) {

2432 
	`»£t_tim”
(
sk
, 
TIME_PROBE0
, sk->
¹o
);

2435 ià(
sk
->
£nd_h—d
 =ğ
NULL
 && sk->
ack_backlog
 == 0 &&

2436 
sk
->
¡©e
 !ğ
TCP_TIME_WAIT
 && !sk->
k“pİ’
) {

2437 
	`DPRINTF
((
DBG_TCP
, "Nothingo do, goingo sleep.\n"));

2438 ià(!
sk
->
d—d
èsk->
	`wr™e_¥aû
(sk);

2440 ià(
sk
->
k“pİ’
)

2441 
	`»£t_tim”
(
sk
, 
TIME_KEEPOPEN
, 
TCP_TIMEOUT_LEN
);

2443 
	`d–‘e_tim”
(
sk
);

2445 ià(
sk
->
¡©e
 !ğ(èsk->
k“pİ’
) {

2446 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, sk->
¹o
);

2448 ià(
sk
->
¡©e
 =ğ
TCP_TIME_WAIT
) {

2449 
	`»£t_tim”
(
sk
, 
TIME_CLOSE
, 
TCP_TIMEWAIT_LEN
);

2454 ià(
sk
->
·ck‘s_out
 =ğ0 && sk->
·¹Ÿl
 !ğ
NULL
 &&

2455 
sk
->
wäÚt
 =ğ
NULL
 && sk->
£nd_h—d
 == NULL) {

2456 
æag
 |= 1;

2457 
	`tı_£nd_·¹Ÿl
(
sk
);

2461 ià(
sk
->
¡©e
 =ğ
TCP_TIME_WAIT
) {

2462 ià(!
sk
->
d—d
)

2463 
sk
->
	`¡©e_chªge
(sk);

2464 ià(
sk
->
rcv_ack_£q
 =ğsk->
wr™e_£q
 && sk->
acked_£q
 =ğsk->
fš_£q
) {

2465 
æag
 |= 1;

2466 
sk
->
¡©e
 = 
TCP_CLOSE
;

2467 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

2471 ià(
sk
->
¡©e
 =ğ
TCP_LAST_ACK
 || sk->¡©=ğ
TCP_FIN_WAIT2
) {

2472 ià(!
sk
->
d—d
èsk->
	`¡©e_chªge
(sk);

2473 ià(
sk
->
rcv_ack_£q
 =ğsk->
wr™e_£q
) {

2474 
æag
 |= 1;

2475 ià(
sk
->
acked_£q
 !ğsk->
fš_£q
) {

2476 
	`tı_time_wa™
(
sk
);

2478 
	`DPRINTF
((
DBG_TCP
, "tı_ack closšg sock‘ - %X\n", 
sk
));

2479 
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
, sk,

2480 
th
, 
sk
->
daddr
);

2481 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

2482 
sk
->
¡©e
 = 
TCP_CLOSE
;

2516 ià(((!
æag
è|| (æag&4)è&& 
sk
->
£nd_h—d
 !ğ
NULL
 &&

2517 (((
æag
&2è&& 
sk
->
»Œªsm™s
) ||

2518 (
sk
->
£nd_h—d
->
wh’
 + sk->
¹o
 < 
jiff›s
))) {

2519 
	`_do_»Œªsm™
(
sk
, 1);

2520 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, sk->
¹o
);

2523 
	`DPRINTF
((
DBG_TCP
, "leavingcp_ack\n"));

2525 
	}
}

2534 
	$tı_d©a
(
sk_buff
 *
skb
, 
sock
 *
sk
,

2535 
§ddr
, 
Ën
)

2537 
sk_buff
 *
skb1
, *
skb2
;

2538 
tıhdr
 *
th
;

2539 
dup_dum³d
=0;

2541 
th
 = 
skb
->
h
.th;

2542 
	`´št_th
(
th
);

2543 
skb
->
Ën
 =†’ -(
th
->
doff
*4);

2545 
	`DPRINTF
((
DBG_TCP
, "tı_d©¨ËÀğ%d sk = %X:\n", 
skb
->
Ën
, 
sk
));

2547 
sk
->
by‹s_rcv
 +ğ
skb
->
Ën
;

2548 ià(
skb
->
Ën
 =ğ0 && !
th
->
fš
 && !th->
urg
 && !th->
psh
) {

2550 ià(!
th
->
ack
è
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
,sk,h, 
§ddr
);

2551 
	`kä“_skb
(
skb
, 
FREE_READ
);

2555 ià(
sk
->
shutdown
 & 
RCV_SHUTDOWN
) {

2556 
sk
->
acked_£q
 = 
th
->
£q
 + 
skb
->
Ën
 +h->
syn
 +h->
fš
;

2557 
	`tı_»£t
(
sk
->
§ddr
, sk->
daddr
, 
skb
->
h
.
th
,

2558 
sk
->
´Ù
, 
NULL
, 
skb
->
dev
, sk->
_tos
, sk->
_‰l
);

2559 
sk
->
¡©e
 = 
TCP_CLOSE
;

2560 
sk
->
”r
 = 
EPIPE
;

2561 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

2562 
	`DPRINTF
((
DBG_TCP
, "tı_d©a: closšg sock‘ - %X\n", 
sk
));

2563 
	`kä“_skb
(
skb
, 
FREE_READ
);

2564 ià(!
sk
->
d—d
èsk->
	`¡©e_chªge
(sk);

2577 ià(
sk
->
rqueue
 =ğ
NULL
) {

2578 
	`DPRINTF
((
DBG_TCP
, "tı_d©a: skb = %X:\n", 
skb
));

2579 #ifdeà
OLDWAY


2580 
sk
->
rqueue
 = 
skb
;

2581 
skb
->
Ãxt
 = skb;

2582 
skb
->
´ev
 = skb;

2583 
skb
->
li¡
 = &
sk
->
rqueue
;

2585 
	`skb_queue_h—d
(&
sk
->
rqueue
,
skb
);

2587 
skb1
ğ
NULL
;

2589 
	`DPRINTF
((
DBG_TCP
, "tı_d©¨addšgØchaš sk = %X:\n", 
sk
));

2590 
skb1
=
sk
->
rqueue
->
´ev
; ; skb1 =(
sk_buff
 *)skb1->prev) {

2591 if(
sk
->
debug
)

2593 
	`´štk
("skb1=%°:", 
skb1
);

2594 
	`´štk
("skb1->h.th->£q = %ld: ", 
skb1
->
h
.
th
->
£q
);

2595 
	`´štk
("skb->h.th->£q = %ld\n",
skb
->
h
.
th
->
£q
);

2596 
	`´štk
("cİ›d_£q = %ld‡cked_£q = %ld\n", 
sk
->
cİ›d_£q
,

2597 
sk
->
acked_£q
);

2599 #ifdeà
OLD


2600 ià(
	`aá”
(
th
->
£q
+1, 
skb1
->
h
.th->seq)) {

2601 
skb
->
´ev
 = 
skb1
;

2602 
skb
->
Ãxt
 = 
skb1
->next;

2603 
skb
->
Ãxt
->
´ev
 = skb;

2604 
skb1
->
Ãxt
 = 
skb
;

2605 ià(
skb1
 =ğ
sk
->
rqueue
èsk->rqueuğ
skb
;

2608 ià(
skb1
->
´ev
 =ğ
sk
->
rqueue
) {

2609 
skb
->
Ãxt
ğ
skb1
;

2610 
skb
->
´ev
 = 
skb1
->prev;

2611 
skb
->
´ev
->
Ãxt
 = skb;

2612 
skb1
->
´ev
 = 
skb
;

2613 
skb1
 = 
NULL
;

2618 ià(
th
->
£q
==
skb1
->
h
.th->£q && 
skb
->
Ën
>= skb1->len)

2620 
	`skb_­³nd
(
skb1
,
skb
);

2621 
	`skb_uÆšk
(
skb1
);

2622 
	`kä“_skb
(
skb1
,
FREE_READ
);

2623 
dup_dum³d
=1;

2624 
skb1
=
NULL
;

2627 ià(
	`aá”
(
th
->
£q
+1, 
skb1
->
h
.th->seq))

2629 
	`skb_­³nd
(
skb1
,
skb
);

2632 ià(
skb1
 =ğ
sk
->
rqueue
)

2634 
	`skb_queue_h—d
(&
sk
->
rqueue
, 
skb
);

2639 
	`DPRINTF
((
DBG_TCP
, "skb = %X:\n", 
skb
));

2642 
th
->
ack_£q
 =h->
£q
 + 
skb
->
Ën
;

2643 ià(
th
->
syn
èth->
ack_£q
++;

2644 ià(
th
->
fš
èth->
ack_£q
++;

2646 ià(
	`befÜe
(
sk
->
acked_£q
, sk->
cİ›d_£q
)) {

2647 
	`´štk
("***cp.c:tcp_data bug‡cked < copied\n");

2648 
sk
->
acked_£q
 = sk->
cİ›d_£q
;

2652 ià((!
dup_dum³d
 && (
skb1
 =ğ
NULL
 || skb1->
acked
)è|| 
	`befÜe
(
th
->
£q
, 
sk
->
acked_£q
+1)) {

2653 ià(
	`befÜe
(
th
->
£q
, 
sk
->
acked_£q
+1)) {

2654 
Ãwwšdow
;

2656 ià(
	`aá”
(
th
->
ack_£q
, 
sk
->
acked_£q
)) {

2657 
Ãwwšdow
 = 
sk
->
wšdow
 -

2658 (
th
->
ack_£q
 - 
sk
->
acked_£q
);

2659 ià(
Ãwwšdow
 < 0)

2660 
Ãwwšdow
 = 0;

2661 
sk
->
wšdow
 = 
Ãwwšdow
;

2662 
sk
->
acked_£q
 = 
th
->
ack_£q
;

2664 
skb
->
acked
 = 1;

2667 ià(
skb
->
h
.
th
->
fš
) {

2668 ià(!
sk
->
d—d
èsk->
	`¡©e_chªge
(sk);

2669 
sk
->
shutdown
 |ğ
RCV_SHUTDOWN
;

2672 
skb2
 = (
sk_buff
 *)
skb
->
Ãxt
;

2673 
skb2
 !=(
sk_buff
 *è
sk
->
rqueue
;

2674 
skb2
 = (
sk_buff
 *)skb2->
Ãxt
) {

2675 ià(
	`befÜe
(
skb2
->
h
.
th
->
£q
, 
sk
->
acked_£q
+1)) {

2676 ià(
	`aá”
(
skb2
->
h
.
th
->
ack_£q
, 
sk
->
acked_£q
))

2678 
Ãwwšdow
 = 
sk
->
wšdow
 -

2679 (
skb2
->
h
.
th
->
ack_£q
 - 
sk
->
acked_£q
);

2680 ià(
Ãwwšdow
 < 0)

2681 
Ãwwšdow
 = 0;

2682 
sk
->
wšdow
 = 
Ãwwšdow
;

2683 
sk
->
acked_£q
 = 
skb2
->
h
.
th
->
ack_£q
;

2685 
skb2
->
acked
 = 1;

2691 ià(
skb2
->
h
.
th
->
fš
) {

2692 
sk
->
shutdown
 |ğ
RCV_SHUTDOWN
;

2693 ià(!
sk
->
d—d
èsk->
	`¡©e_chªge
(sk);

2697 
sk
->
ack_backlog
 = sk->
max_ack_backlog
;

2707 ià(!
sk
->
d–ay_acks
 ||

2708 
sk
->
ack_backlog
 >ğsk->
max_ack_backlog
 ||

2709 
sk
->
by‹s_rcv
 > sk->
max_uÇcked
 || 
th
->
fš
) {

2712 
sk
->
ack_backlog
++;

2713 if(
sk
->
debug
)

2714 
	`´štk
("Ack queued.\n");

2715 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 
TCP_ACK_TIME
);

2724 ià(!
skb
->
acked
) {

2731 
sk
->
´Ù
->
	`r¥aû
(skè< sk->
mtu
) {

2732 
skb1
 = 
	`skb_³ek
(&
sk
->
rqueue
);

2733 ià(
skb1
 =ğ
NULL
) {

2734 
	`´štk
("INET:cp.c:tcp_data memory†eak detected.\n");

2739 ià(
skb1
->
acked
) {

2743 
	`skb_uÆšk
(
skb1
);

2744 #ifdeà
OLDWAY


2745 ià(
skb1
->
´ev
 == skb1) {

2746 
sk
->
rqueue
 = 
NULL
;

2748 
sk
->
rqueue
 = (
sk_buff
 *)
skb1
->
´ev
;

2749 
skb1
->
Ãxt
->
´ev
 = skb1->prev;

2750 
skb1
->
´ev
->
Ãxt
 = skb1->next;

2753 
	`kä“_skb
(
skb1
, 
FREE_READ
);

2755 
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
, sk, 
th
, 
§ddr
);

2756 
sk
->
ack_backlog
++;

2757 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 
TCP_ACK_TIME
);

2760 
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
, sk, 
th
, 
§ddr
);

2764 ià(!
sk
->
d—d
) {

2765 if(
sk
->
debug
)

2766 
	`´štk
("Data wakeup.\n");

2767 
sk
->
	`d©a_»ady
(sk,0);

2769 
	`DPRINTF
((
DBG_TCP
, "data„eceived on dead socket.\n"));

2772 ià(
sk
->
¡©e
 =ğ
TCP_FIN_WAIT2
 &&

2773 
sk
->
acked_£q
 =ğsk->
fš_£q
 && sk->
rcv_ack_£q
 =ğsk->
wr™e_£q
) {

2774 
	`DPRINTF
((
DBG_TCP
, "tı_d©a:ƒÁ”šg†a¡_ack s‹ sk = %X\n", 
sk
));

2777 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

2778 
sk
->
¡©e
 = 
TCP_LAST_ACK
;

2779 ià(!
sk
->
d—d
èsk->
	`¡©e_chªge
(sk);

2783 
	}
}

2786 
	$tı_check_urg
(
sock
 * 
sk
, 
tıhdr
 * 
th
)

2788 
±r
 = 
	`Áohs
(
th
->
urg_±r
);

2790 ià(
±r
)

2791 
±r
--;

2792 
±r
 +ğ
th
->
£q
;

2795 ià(
	`aá”
(
sk
->
cİ›d_£q
+1, 
±r
))

2799 ià(
sk
->
urg_d©a
 && !
	`aá”
(
±r
, sk->
urg_£q
))

2803 ià(
sk
->
´oc
 != 0) {

2804 ià(
sk
->
´oc
 > 0) {

2805 
	`kl_´oc
(
sk
->
´oc
, 
SIGURG
, 1);

2807 
	`kl_pg
(-
sk
->
´oc
, 
SIGURG
, 1);

2810 
sk
->
urg_d©a
 = 
URG_NOTYET
;

2811 
sk
->
urg_£q
 = 
±r
;

2812 
	}
}

2814 
šlše
 
	$tı_urg
(
sock
 *
sk
, 
tıhdr
 *
th
,

2815 
§ddr
, 
Ën
)

2817 
±r
;

2820 ià(
th
->
urg
)

2821 
	`tı_check_urg
(
sk
,
th
);

2824 ià(
sk
->
urg_d©a
 !ğ
URG_NOTYET
)

2828 
±r
 = 
sk
->
urg_£q
 - 
th
->
£q
 +h->
doff
*4;

2829 ià(
±r
 >ğ
Ën
)

2833 
sk
->
urg_d©a
 = 
URG_VALID
 | *(
±r
 + (*è
th
);

2834 ià(!
sk
->
d—d
)

2835 
	`wake_up_š‹¼u±ibË
(
sk
->
¦“p
);

2837 
	}
}

2842 
	$tı_fš
(
sock
 *
sk
, 
tıhdr
 *
th
,

2843 
§ddr
, 
deviû
 *
dev
)

2845 
	`DPRINTF
((
DBG_TCP
, "tcp_fin(sk=%X,h=%X, saddr=%X, dev=%X)\n",

2846 
sk
, 
th
, 
§ddr
, 
dev
));

2848 ià(!
sk
->
d—d
) {

2849 
sk
->
	`¡©e_chªge
(sk);

2852 
sk
->
¡©e
) {

2853 
TCP_SYN_RECV
:

2854 
TCP_SYN_SENT
:

2855 
TCP_ESTABLISHED
:

2857 
sk
->
fš_£q
 = 
th
->
£q
+1;

2858 
sk
->
¡©e
 = 
TCP_CLOSE_WAIT
;

2859 ià(
th
->
r¡
è
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

2862 
TCP_CLOSE_WAIT
:

2863 
TCP_FIN_WAIT2
:

2866 
TCP_FIN_WAIT1
:

2868 
sk
->
fš_£q
 = 
th
->
£q
+1;

2869 
sk
->
¡©e
 = 
TCP_FIN_WAIT2
;

2873 
TCP_TIME_WAIT
:

2874 
sk
->
¡©e
 = 
TCP_LAST_ACK
;

2877 
	`»£t_tim”
(
sk
, 
TIME_CLOSE
, 
TCP_TIMEWAIT_LEN
);

2880 
sk
->
ack_backlog
++;

2883 
	}
}

2887 
sock
 *

2888 
	$tı_acû±
(
sock
 *
sk
, 
æags
)

2890 
sock
 *
Ãwsk
;

2891 
sk_buff
 *
skb
;

2893 
	`DPRINTF
((
DBG_TCP
, "tcp_accept(sk=%X, flags=%X,‡ddr=%s)\n",

2894 
sk
, 
æags
, 
	`š_Áß
(sk->
§ddr
)));

2900 ià(
sk
->
¡©e
 !ğ
TCP_LISTEN
) {

2901 
sk
->
”r
 = 
EINVAL
;

2902 (
NULL
);

2906 
	`şi
();

2907 
sk
->
šu£
 = 1;

2908 (
skb
 = 
	`g‘_fœ¡r
(
sk
)è=ğ
NULL
) {

2909 ià(
æags
 & 
O_NONBLOCK
) {

2910 
	`¡i
();

2911 
	`»Ëa£_sock
(
sk
);

2912 
sk
->
”r
 = 
EAGAIN
;

2913 (
NULL
);

2916 
	`»Ëa£_sock
(
sk
);

2917 
	`š‹¼u±ibË_¦“p_Ú
(
sk
->
¦“p
);

2918 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

2919 
	`¡i
();

2920 
sk
->
”r
 = 
ERESTARTSYS
;

2921 (
NULL
);

2923 
sk
->
šu£
 = 1;

2925 
	`¡i
();

2928 
Ãwsk
 = 
skb
->
sk
;

2930 
	`kä“_skb
(
skb
, 
FREE_READ
);

2931 
sk
->
ack_backlog
--;

2932 
	`»Ëa£_sock
(
sk
);

2933 (
Ãwsk
);

2934 
	}
}

2939 
	$tı_cÚÃù
(
sock
 *
sk
, 
sockaddr_š
 *
usš
, 
addr_Ën
)

2941 
sk_buff
 *
buff
;

2942 
sockaddr_š
 
sš
;

2943 
deviû
 *
dev
=
NULL
;

2944 *
±r
;

2945 
tmp
;

2946 
tıhdr
 *
t1
;

2947 
”r
;

2949 ià(
sk
->
¡©e
 !ğ
TCP_CLOSE
è(-
EISCONN
);

2950 ià(
addr_Ën
 < 8è(-
EINVAL
);

2952 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
usš
, 
addr_Ën
);

2953 if(
”r
)

2954  
”r
;

2956 
	`memıy_äomfs
(&
sš
,
usš
, 
	`mš
((sš), 
addr_Ën
));

2958 ià(
sš
.
sš_çmy
 && sš.sš_çmy !ğ
AF_INET
è(-
EAFNOSUPPORT
);

2960 
	`DPRINTF
((
DBG_TCP
, "TCP cÚÃù daddr=%s\n", 
	`š_Áß
(
sš
.
sš_addr
.
s_addr
)));

2963 ià(
	`chk_addr
(
sš
.
sš_addr
.
s_addr
è=ğ
IS_BROADCAST
) {

2964 
	`DPRINTF
((
DBG_TCP
, "TCP connectiono broadcast‡ddress‚ot‡llowed\n"));

2965 (-
ENETUNREACH
);

2969 if(
sk
->
§ddr
 =ğ
sš
.
sš_addr
.
s_addr
 && sk->
num
==
	`Áohs
(sš.
sš_pÜt
))

2970  -
EBUSY
;

2972 
sk
->
šu£
 = 1;

2973 
sk
->
daddr
 = 
sš
.
sš_addr
.
s_addr
;

2974 
sk
->
wr™e_£q
 = 
jiff›s
 * 
SEQ_TICK
 - 
£q_off£t
;

2975 
sk
->
wšdow_£q
 = sk->
wr™e_£q
;

2976 
sk
->
rcv_ack_£q
 = sk->
wr™e_£q
 -1;

2977 
sk
->
”r
 = 0;

2978 
sk
->
dummy_th
.
de¡
 = 
sš
.
sš_pÜt
;

2979 
	`»Ëa£_sock
(
sk
);

2981 
buff
 = 
sk
->
´Ù
->
	`wm®loc
(sk,
MAX_SYN_SIZE
,0, 
GFP_KERNEL
);

2982 ià(
buff
 =ğ
NULL
) {

2983 (-
ENOMEM
);

2985 
sk
->
šu£
 = 1;

2986 
buff
->
mem_addr
 = buff;

2987 
buff
->
mem_Ën
 = 
MAX_SYN_SIZE
;

2988 
buff
->
Ën
 = 24;

2989 
buff
->
sk
 = sk;

2990 
buff
->
ä“
 = 1;

2991 
t1
 = (
tıhdr
 *è
buff
->
d©a
;

2995 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
buff
, sk->
§ddr
, sk->
daddr
, &
dev
,

2996 
IPPROTO_TCP
, 
NULL
, 
MAX_SYN_SIZE
,
sk
->
_tos
,sk->
_‰l
);

2997 ià(
tmp
 < 0) {

2998 
sk
->
´Ù
->
	`wä“
(sk, 
buff
->
mem_addr
, buff->
mem_Ën
);

2999 
	`»Ëa£_sock
(
sk
);

3000 (-
ENETUNREACH
);

3002 
buff
->
Ën
 +ğ
tmp
;

3003 
t1
 = (
tıhdr
 *)((*é1 +
tmp
);

3005 
	`memıy
(
t1
,(*)&(
sk
->
dummy_th
), (*t1));

3006 
t1
->
£q
 = 
	`Áohl
(
sk
->
wr™e_£q
++);

3007 
sk
->
£Á_£q
 = sk->
wr™e_£q
;

3008 
buff
->
h
.
£q
 = 
sk
->
wr™e_£q
;

3009 
t1
->
ack
 = 0;

3010 
t1
->
wšdow
 = 2;

3011 
t1
->
»s1
=0;

3012 
t1
->
»s2
=0;

3013 
t1
->
r¡
 = 0;

3014 
t1
->
urg
 = 0;

3015 
t1
->
psh
 = 0;

3016 
t1
->
syn
 = 1;

3017 
t1
->
urg_±r
 = 0;

3018 
t1
->
doff
 = 6;

3021 ià(
sk
->
u£r_mss
)

3022 
sk
->
mtu
 = sk->
u£r_mss
;

3024 #ifdeà
SUBNETSARELOCAL


3025 ià((
sk
->
§ddr
 ^ sk->
daddr
è& 
	`deçuÉ_mask
(sk->saddr))

3027 ià((
sk
->
§ddr
 ^ sk->
daddr
è& 
dev
->
·_mask
)

3029 
sk
->
mtu
 = 576 - 
HEADER_SIZE
;

3031 
sk
->
mtu
 = 
MAX_WINDOW
;

3034 
sk
->
mtu
 = 
	`mš
(sk->mtu, 
dev
->mtu - 
HEADER_SIZE
);

3037 
±r
 = (*)(
t1
+1);

3038 
±r
[0] = 2;

3039 
±r
[1] = 4;

3040 
±r
[2] = (
sk
->
mtu
) >> 8;

3041 
±r
[3] = (
sk
->
mtu
) & 0xff;

3042 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, sk->
daddr
,

3043 (
tıhdr
è+ 4, 
sk
);

3046 
sk
->
¡©e
 = 
TCP_SYN_SENT
;

3047 
sk
->
¹t
 = 
TCP_CONNECT_TIME
;

3048 
	`»£t_tim”
(
sk
, 
TIME_WRITE
, 
TCP_CONNECT_TIME
);

3049 
sk
->
»Œªsm™s
 = 
TCP_RETR2
 - 
TCP_SYN_RETRIES
;

3051 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
buff
, 0);

3053 
	`»Ëa£_sock
(
sk
);

3055 
	}
}

3060 
	$tı_£qu’û
(
sock
 *
sk
, 
tıhdr
 *
th
, 
Ën
,

3061 
İtiÚs
 *
İt
, 
§ddr
, 
deviû
 *
dev
)

3063 
Ãxt_£q
;

3065 
Ãxt_£q
 = 
Ën
 - 4*
th
->
doff
;

3066 ià(
th
->
fš
)

3067 
Ãxt_£q
++;

3069 ià(
Ãxt_£q
 && !
sk
->
wšdow
)

3070 
ignÜe_™
;

3071 
Ãxt_£q
 +ğ
th
->
£q
;

3081 ià(!
	`aá”
(
Ãxt_£q
+1, 
sk
->
acked_£q
))

3082 
ignÜe_™
;

3084 ià(!
	`befÜe
(
th
->
£q
, 
sk
->
acked_£q
 + sk->
wšdow
 + 1))

3085 
ignÜe_™
;

3090 
ignÜe_™
:

3091 
	`DPRINTF
((
DBG_TCP
, "tcp_sequence:„ejecting…acket.\n"));

3100 ià(
sk
->
¡©e
==
TCP_SYN_SENT
 || sk->¡©e==
TCP_SYN_RECV
) {

3101 
	`tı_»£t
(
sk
->
§ddr
,sk->
daddr
,
th
,sk->
´Ù
,
NULL
,
dev
, sk->
_tos
,sk->
_‰l
);

3105 ià(
th
->
r¡
)

3109 
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
, sk, 
th
, 
§ddr
);

3111 
	}
}

3115 
	$tı_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
İtiÚs
 *
İt
,

3116 
daddr
, 
Ën
,

3117 
§ddr
, 
»do
, 
š‘_´ÙocŞ
 * 
´ÙocŞ
)

3119 
tıhdr
 *
th
;

3120 
sock
 *
sk
;

3122 ià(!
skb
) {

3123 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv skb = NULL\n"));

3127 ià(!
´ÙocŞ
) {

3128 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv…rotocol = NULL\n"));

3132 ià(!
İt
) {

3133 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv opt = NULL\n"));

3136 ià(!
dev
) {

3137 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv dev = NULL\n"));

3140 
th
 = 
skb
->
h
.th;

3143 
sk
 = 
	`g‘_sock
(&
tı_´Ù
, 
th
->
de¡
, 
§ddr
,h->
sourû
, 
daddr
);

3144 
	`DPRINTF
((
DBG_TCP
, "<<\n"));

3145 
	`DPRINTF
((
DBG_TCP
, "ËÀğ%d,„edØğ%d, skb=%X\n", 
Ën
, 
»do
, 
skb
));

3149 ià(
sk
!=
NULL
 && sk->
z­³d
)

3150 
sk
=
NULL
;

3152 ià(
sk
) {

3153 
	`DPRINTF
((
DBG_TCP
, "sk = %X:\n", 
sk
));

3156 ià(!
»do
) {

3157 ià(
	`tı_check
(
th
, 
Ën
, 
§ddr
, 
daddr
 )) {

3158 
skb
->
sk
 = 
NULL
;

3159 
	`DPRINTF
((
DBG_TCP
, "packet dropped with bad checksum.\n"));

3160 ià(
š‘_debug
 =ğ
DBG_SLIP
è
	`´štk
("\rtcp_rcv: bad checksum\n");

3161 
	`kä“_skb
(
skb
,
FREE_READ
);

3169 
th
->
£q
 = 
	`Áohl
(th->seq);

3172 ià(
sk
 =ğ
NULL
) {

3173 ià(!
th
->
r¡
)

3174 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, &
tı_´Ù
, 
İt
,
dev
,
skb
->
_hdr
->
tos
,255);

3175 
skb
->
sk
 = 
NULL
;

3176 
	`kä“_skb
(
skb
, 
FREE_READ
);

3180 
skb
->
Ën
 =†en;

3181 
skb
->
sk
 = sk;

3182 
skb
->
acked
 = 0;

3183 
skb
->
u£d
 = 0;

3184 
skb
->
ä“
 = 0;

3185 
skb
->
§ddr
 = 
daddr
;

3186 
skb
->
daddr
 = 
§ddr
;

3189 
	`şi
();

3190 ià(
sk
->
šu£
) {

3191 ià(
sk
->
back_log
 =ğ
NULL
) {

3192 
sk
->
back_log
 = 
skb
;

3193 
skb
->
Ãxt
 = skb;

3194 
skb
->
´ev
 = skb;

3196 
skb
->
Ãxt
 = 
sk
->
back_log
;

3197 
skb
->
´ev
 = 
sk
->
back_log
->prev;

3198 
skb
->
´ev
->
Ãxt
 = skb;

3199 
skb
->
Ãxt
->
´ev
 = skb;

3201 
	`¡i
();

3204 
sk
->
šu£
 = 1;

3205 
	`¡i
();

3207 ià(!
sk
) {

3208 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv bug sk=NULL„edo = 1\n"));

3213 ià(!
sk
->
´Ù
) {

3214 
	`DPRINTF
((
DBG_TCP
, "tcp.c:cp_rcv sk->prot = NULL \n"));

3219 ià(
sk
->
rmem_®loc
 + 
skb
->
mem_Ën
 >ğsk->
rcvbuf
) {

3220 
skb
->
sk
 = 
NULL
;

3221 
	`DPRINTF
((
DBG_TCP
, "dropping…acket dueo†ack of buffer space.\n"));

3222 
	`kä“_skb
(
skb
, 
FREE_READ
);

3223 
	`»Ëa£_sock
(
sk
);

3226 
sk
->
rmem_®loc
 +ğ
skb
->
mem_Ën
;

3228 
	`DPRINTF
((
DBG_TCP
, "Abouto do switch.\n"));

3231 
sk
->
¡©e
) {

3236 
TCP_LAST_ACK
:

3237 ià(
th
->
r¡
) {

3238 
sk
->
z­³d
=1;

3239 
sk
->
”r
 = 
ECONNRESET
;

3240 
sk
->
¡©e
 = 
TCP_CLOSE
;

3241 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

3242 ià(!
sk
->
d—d
) {

3243 
sk
->
	`¡©e_chªge
(sk);

3245 
	`kä“_skb
(
skb
, 
FREE_READ
);

3246 
	`»Ëa£_sock
(
sk
);

3250 
TCP_ESTABLISHED
:

3251 
TCP_CLOSE_WAIT
:

3252 
TCP_FIN_WAIT1
:

3253 
TCP_FIN_WAIT2
:

3254 
TCP_TIME_WAIT
:

3255 ià(!
	`tı_£qu’û
(
sk
, 
th
, 
Ën
, 
İt
, 
§ddr
,
dev
)) {

3256 ià(
š‘_debug
 =ğ
DBG_SLIP
è
	`´štk
("\rtcp_rcv:‚ot in seq\n");

3257 #ifdeà
undef


3259 if(!
th
->
r¡
)

3260 
	`tı_£nd_ack
(
sk
->
£Á_£q
, sk->
acked_£q
,

3261 
sk
, 
th
, 
§ddr
);

3263 
	`kä“_skb
(
skb
, 
FREE_READ
);

3264 
	`»Ëa£_sock
(
sk
);

3268 ià(
th
->
r¡
) {

3269 
sk
->
z­³d
=1;

3271 
sk
->
”r
 = 
ECONNRESET
;

3273 ià(
sk
->
¡©e
 =ğ
TCP_CLOSE_WAIT
) {

3274 
sk
->
”r
 = 
EPIPE
;

3281 
sk
->
¡©e
 = 
TCP_CLOSE
;

3282 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

3283 ià(!
sk
->
d—d
) {

3284 
sk
->
	`¡©e_chªge
(sk);

3286 
	`kä“_skb
(
skb
, 
FREE_READ
);

3287 
	`»Ëa£_sock
(
sk
);

3292 ià((
İt
 && (İt->
£cur™y
 != 0 ||

3293 
İt
->
com·¹m’t
 != 0)) ||

3295 
th
->
syn
) {

3296 
sk
->
”r
 = 
ECONNRESET
;

3297 
sk
->
¡©e
 = 
TCP_CLOSE
;

3298 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

3299 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
sk
->
´Ù
, 
İt
,
dev
, sk->
_tos
,sk->
_‰l
);

3300 ià(!
sk
->
d—d
) {

3301 
sk
->
	`¡©e_chªge
(sk);

3303 
	`kä“_skb
(
skb
, 
FREE_READ
);

3304 
	`»Ëa£_sock
(
sk
);

3308 ià(
th
->
ack
 && !
	`tı_ack
(
sk
,h, 
§ddr
, 
Ën
)) {

3309 
	`kä“_skb
(
skb
, 
FREE_READ
);

3310 
	`»Ëa£_sock
(
sk
);

3314 ià(
	`tı_urg
(
sk
, 
th
, 
§ddr
, 
Ën
)) {

3315 
	`kä“_skb
(
skb
, 
FREE_READ
);

3316 
	`»Ëa£_sock
(
sk
);

3320 ià(
	`tı_d©a
(
skb
, 
sk
, 
§ddr
, 
Ën
)) {

3321 
	`kä“_skb
(
skb
, 
FREE_READ
);

3322 
	`»Ëa£_sock
(
sk
);

3327 ià(
th
->
fš
 && 
	`tı_fš
(
sk
,h, 
§ddr
, 
dev
)) {

3328 
	`kä“_skb
(
skb
, 
FREE_READ
);

3329 
	`»Ëa£_sock
(
sk
);

3333 
	`»Ëa£_sock
(
sk
);

3336 
TCP_CLOSE
:

3337 ià(
sk
->
d—d
 || sk->
daddr
) {

3338 
	`DPRINTF
((
DBG_TCP
, "packet„eceived for closed,dead socket\n"));

3339 
	`kä“_skb
(
skb
, 
FREE_READ
);

3340 
	`»Ëa£_sock
(
sk
);

3344 ià(!
th
->
r¡
) {

3345 ià(!
th
->
ack
)

3346 
th
->
ack_£q
 = 0;

3347 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
sk
->
´Ù
, 
İt
,
dev
,sk->
_tos
,sk->
_‰l
);

3349 
	`kä“_skb
(
skb
, 
FREE_READ
);

3350 
	`»Ëa£_sock
(
sk
);

3353 
TCP_LISTEN
:

3354 ià(
th
->
r¡
) {

3355 
	`kä“_skb
(
skb
, 
FREE_READ
);

3356 
	`»Ëa£_sock
(
sk
);

3359 ià(
th
->
ack
) {

3360 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
sk
->
´Ù
, 
İt
,
dev
,sk->
_tos
,sk->
_‰l
);

3361 
	`kä“_skb
(
skb
, 
FREE_READ
);

3362 
	`»Ëa£_sock
(
sk
);

3366 ià(
th
->
syn
) {

3368 ià(
İt
->
£cur™y
 !ğ0 || o±->
com·¹m’t
 != 0) {

3369 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
´Ù
, 
İt
,
dev
);

3370 
	`»Ëa£_sock
(
sk
);

3381 
	`tı_cÚn_»que¡
(
sk
, 
skb
, 
daddr
, 
§ddr
, 
İt
, 
dev
);

3382 
	`»Ëa£_sock
(
sk
);

3386 
	`kä“_skb
(
skb
, 
FREE_READ
);

3387 
	`»Ëa£_sock
(
sk
);

3391 ià(!
	`tı_£qu’û
(
sk
, 
th
, 
Ën
, 
İt
, 
§ddr
,
dev
)) {

3392 
	`kä“_skb
(
skb
, 
FREE_READ
);

3393 
	`»Ëa£_sock
(
sk
);

3397 
TCP_SYN_SENT
:

3398 ià(
th
->
r¡
) {

3399 
sk
->
”r
 = 
ECONNREFUSED
;

3400 
sk
->
¡©e
 = 
TCP_CLOSE
;

3401 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

3402 
sk
->
z­³d
 = 1;

3403 ià(!
sk
->
d—d
) {

3404 
sk
->
	`¡©e_chªge
(sk);

3406 
	`kä“_skb
(
skb
, 
FREE_READ
);

3407 
	`»Ëa£_sock
(
sk
);

3411 ià(
İt
->
£cur™y
 !ğ0 || o±->
com·¹m’t
 != 0) {

3412 
sk
->
”r
 = 
ECONNRESET
;

3413 
sk
->
¡©e
 = 
TCP_CLOSE
;

3414 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

3415 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
, 
sk
->
´Ù
, 
İt
, 
dev
);

3416 ià(!
sk
->
d—d
) {

3417 
	`wake_up_š‹¼u±ibË
(
sk
->
¦“p
);

3419 
	`kä“_skb
(
skb
, 
FREE_READ
);

3420 
	`»Ëa£_sock
(
sk
);

3424 ià(!
th
->
ack
) {

3425 ià(
th
->
syn
) {

3426 
sk
->
¡©e
 = 
TCP_SYN_RECV
;

3429 
	`kä“_skb
(
skb
, 
FREE_READ
);

3430 
	`»Ëa£_sock
(
sk
);

3434 
sk
->
¡©e
) {

3435 
TCP_SYN_SENT
:

3436 ià(!
	`tı_ack
(
sk
, 
th
, 
§ddr
, 
Ën
)) {

3437 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
,

3438 
sk
->
´Ù
, 
İt
,
dev
,sk->
_tos
,sk->
_‰l
);

3439 
	`kä“_skb
(
skb
, 
FREE_READ
);

3440 
	`»Ëa£_sock
(
sk
);

3448 ià(!
th
->
syn
) {

3449 
	`kä“_skb
(
skb
, 
FREE_READ
);

3450 
	`»Ëa£_sock
(
sk
);

3455 
sk
->
acked_£q
 = 
th
->
£q
+1;

3456 
sk
->
fš_£q
 = 
th
->
£q
;

3457 
	`tı_£nd_ack
(
sk
->
£Á_£q
, 
th
->
£q
+1,

3458 
sk
, 
th
, sk->
daddr
);

3460 
TCP_SYN_RECV
:

3461 ià(!
	`tı_ack
(
sk
, 
th
, 
§ddr
, 
Ën
)) {

3462 
	`tı_»£t
(
daddr
, 
§ddr
, 
th
,

3463 
sk
->
´Ù
, 
İt
, 
dev
,sk->
_tos
,sk->
_‰l
);

3464 
	`kä“_skb
(
skb
, 
FREE_READ
);

3465 
	`»Ëa£_sock
(
sk
);

3468 
sk
->
¡©e
 = 
TCP_ESTABLISHED
;

3475 
	`tı_İtiÚs
(
sk
, 
th
);

3476 
sk
->
dummy_th
.
de¡
 = 
th
->
sourû
;

3477 
sk
->
cİ›d_£q
 = sk->
acked_£q
-1;

3478 ià(!
sk
->
d—d
) {

3479 
sk
->
	`¡©e_chªge
(sk);

3491 ià(
sk
->
max_wšdow
 == 0) {

3492 
sk
->
max_wšdow
 = 32;

3493 
sk
->
mss
 = 
	`mš
(sk->
max_wšdow
, sk->
mtu
);

3500 ià(
th
->
urg
) {

3501 ià(
	`tı_urg
(
sk
, 
th
, 
§ddr
, 
Ën
)) {

3502 
	`kä“_skb
(
skb
, 
FREE_READ
);

3503 
	`»Ëa£_sock
(
sk
);

3507 ià(
	`tı_d©a
(
skb
, 
sk
, 
§ddr
, 
Ën
))

3508 
	`kä“_skb
(
skb
, 
FREE_READ
);

3510 ià(
th
->
fš
è
	`tı_fš
(
sk
,h, 
§ddr
, 
dev
);

3511 
	`»Ëa£_sock
(
sk
);

3515 ià(
th
->
urg
) {

3516 ià(
	`tı_urg
(
sk
, 
th
, 
§ddr
, 
Ën
)) {

3517 
	`kä“_skb
(
skb
, 
FREE_READ
);

3518 
	`»Ëa£_sock
(
sk
);

3523 ià(
	`tı_d©a
(
skb
, 
sk
, 
§ddr
, 
Ën
)) {

3524 
	`kä“_skb
(
skb
, 
FREE_READ
);

3525 
	`»Ëa£_sock
(
sk
);

3529 ià(!
th
->
fš
) {

3530 
	`»Ëa£_sock
(
sk
);

3533 
	`tı_fš
(
sk
, 
th
, 
§ddr
, 
dev
);

3534 
	`»Ëa£_sock
(
sk
);

3537 
	}
}

3545 
	$tı_wr™e_wakeup
(
sock
 *
sk
)

3547 
sk_buff
 *
buff
;

3548 
tıhdr
 *
t1
;

3549 
deviû
 *
dev
=
NULL
;

3550 
tmp
;

3552 ià(
sk
->
z­³d
)

3555 ià(
sk
 -> 
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->¡©!ğ
TCP_CLOSE_WAIT
 &&

3556 
sk
 -> 
¡©e
 !ğ
TCP_FIN_WAIT1
 && sk->¡©!ğ
TCP_FIN_WAIT2
)

3559 
buff
 = 
sk
->
´Ù
->
	`wm®loc
(sk,
MAX_ACK_SIZE
,1, 
GFP_ATOMIC
);

3560 ià(
buff
 =ğ
NULL
) ;

3562 
buff
->
mem_addr
 = buff;

3563 
buff
->
mem_Ën
 = 
MAX_ACK_SIZE
;

3564 
buff
->
Ën
 = (
tıhdr
);

3565 
buff
->
ä“
 = 1;

3566 
buff
->
sk
 = sk;

3567 
	`DPRINTF
((
DBG_TCP
, "incp_write_wakeup\n"));

3568 
t1
 = (
tıhdr
 *è
buff
->
d©a
;

3571 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
buff
, sk->
§ddr
, sk->
daddr
, &
dev
,

3572 
IPPROTO_TCP
, 
sk
->
İt
, 
MAX_ACK_SIZE
,sk->
_tos
,sk->
_‰l
);

3573 ià(
tmp
 < 0) {

3574 
sk
->
´Ù
->
	`wä“
(sk, 
buff
->
mem_addr
, buff->
mem_Ën
);

3578 
buff
->
Ën
 +ğ
tmp
;

3579 
t1
 = (
tıhdr
 *)((*é1 +
tmp
);

3581 
	`memıy
(
t1
,(*è&
sk
->
dummy_th
, (*t1));

3587 
t1
->
£q
 = 
	`htÚl
(
sk
->
£Á_£q
-1);

3588 
t1
->
ack
 = 1;

3589 
t1
->
»s1
= 0;

3590 
t1
->
»s2
= 0;

3591 
t1
->
r¡
 = 0;

3592 
t1
->
urg
 = 0;

3593 
t1
->
psh
 = 0;

3594 
t1
->
fš
 = 0;

3595 
t1
->
syn
 = 0;

3596 
t1
->
ack_£q
 = 
	`Áohl
(
sk
->
acked_£q
);

3597 
t1
->
wšdow
 = 
	`Áohs
(
	`tı_£Ëù_wšdow
(
sk
) );

3598 
t1
->
doff
 = (*t1)/4;

3599 
	`tı_£nd_check
(
t1
, 
sk
->
§ddr
, sk->
daddr
, (*t1), sk);

3604 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
buff
, 1);

3605 
	}
}

3608 
	$tı_£nd_´obe0
(
sock
 *
sk
)

3610 ià(
sk
->
z­³d
)

3613 
	`tı_wr™e_wakeup
(
sk
);

3615 
sk
->
backoff
++;

3616 
sk
->
¹o
 = 
	`mš
(sk->¹Ø<< 1, 120*
HZ
);

3617 
	`»£t_tim”
 (
sk
, 
TIME_PROBE0
, sk->
¹o
);

3618 
sk
->
»Œªsm™s
++;

3619 
sk
->
´Ù
->
»Œªsm™s
 ++;

3620 
	}
}

3626 
	$tı_£tsockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, 
İ’
)

3628 
v®
,
”r
;

3630 if(
Ëv–
!=
SOL_TCP
)

3631  
	`_£tsockİt
(
sk
,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

3633 ià(
İtv®
 =ğ
NULL
)

3634 (-
EINVAL
);

3636 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
İtv®
, ());

3637 if(
”r
)

3638  
”r
;

3640 
v®
 = 
	`g‘_fs_lÚg
((*)
İtv®
);

3642 
İŠame
)

3644 
TCP_MAXSEG
:

3651 if(
v®
<1||v®>
MAX_WINDOW
)

3652  -
EINVAL
;

3653 
sk
->
u£r_mss
=
v®
;

3655 
TCP_NODELAY
:

3656 
sk
->
nÚagË
=(
v®
==0)?0:1;

3659 (-
ENOPROTOOPT
);

3661 
	}
}

3663 
	$tı_g‘sockİt
(
sock
 *
sk
, 
Ëv–
, 
İŠame
, *
İtv®
, *
İ’
)

3665 
v®
,
”r
;

3667 if(
Ëv–
!=
SOL_TCP
)

3668  
	`_g‘sockİt
(
sk
,
Ëv–
,
İŠame
,
İtv®
,
İ’
);

3670 
İŠame
)

3672 
TCP_MAXSEG
:

3673 
v®
=
sk
->
u£r_mss
;

3675 
TCP_NODELAY
:

3676 
v®
=
sk
->
nÚagË
;

3679 (-
ENOPROTOOPT
);

3681 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İ’
, ());

3682 if(
”r
)

3683  
”r
;

3684 
	`put_fs_lÚg
((),(*è
İ’
);

3686 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
İtv®
, ());

3687 if(
”r
)

3688  
”r
;

3689 
	`put_fs_lÚg
(
v®
,(*)
İtv®
);

3692 
	}
}

3695 
´Ùo
 
	gtı_´Ù
 = {

3696 
sock_wm®loc
,

3697 
sock_rm®loc
,

3698 
sock_wä“
,

3699 
sock_rä“
,

3700 
sock_r¥aû
,

3701 
sock_w¥aû
,

3702 
tı_şo£
,

3703 
tı_»ad
,

3704 
tı_wr™e
,

3705 
tı_£ndto
,

3706 
tı_»cväom
,

3707 
_bud_h—d”
,

3708 
tı_cÚÃù
,

3709 
tı_acû±
,

3710 
_queue_xm™
,

3711 
tı_»Œªsm™
,

3712 
tı_wr™e_wakeup
,

3713 
tı_»ad_wakeup
,

3714 
tı_rcv
,

3715 
tı_£Ëù
,

3716 
tı_ioùl
,

3717 
NULL
,

3718 
tı_shutdown
,

3719 
tı_£tsockİt
,

3720 
tı_g‘sockİt
,

3723 {
NULL
,},

	@net/inet/tcp.h

18 #iâdeà
_TCP_H


19 
	#_TCP_H


	)

21 
	~<lšux/tı.h
>

23 
	#MAX_SYN_SIZE
 44 +  (
sk_buff
è+ 
MAX_HEADER


	)

24 
	#MAX_FIN_SIZE
 40 +  (
sk_buff
è+ 
MAX_HEADER


	)

25 
	#MAX_ACK_SIZE
 40 +  (
sk_buff
è+ 
MAX_HEADER


	)

26 
	#MAX_RESET_SIZE
 40 +  (
sk_buff
è+ 
MAX_HEADER


	)

27 
	#MAX_WINDOW
 4096

	)

28 
	#MIN_WINDOW
 2048

	)

29 
	#MAX_ACK_BACKLOG
 2

	)

30 
	#MIN_WRITE_SPACE
 2048

	)

31 
	#TCP_WINDOW_DIFF
 2048

	)

34 
	#URG_VALID
 0x0100

	)

35 
	#URG_NOTYET
 0x0200

	)

36 
	#URG_READ
 0x0400

	)

38 
	#TCP_RETR1
 7

	)

44 
	#TCP_RETR2
 15

	)

49 
	#TCP_TIMEOUT_LEN
 (15*60*
HZ
è

	)

50 
	#TCP_TIMEWAIT_LEN
 (60*
HZ
è

	)

52 
	#TCP_ACK_TIME
 3000

	)

53 
	#TCP_DONE_TIME
 250

	)

55 
	#TCP_WRITE_TIME
 3000

	)

57 
	#TCP_CONNECT_TIME
 2000

	)

58 
	#TCP_SYN_RETRIES
 5

	)

60 
	#TCP_PROBEWAIT_LEN
 100

	)

64 
	#TCP_NO_CHECK
 0

	)

67 
	#TCP_WRITE_QUEUE_MAGIC
 0xa5f23477

	)

73 
	#TCPOPT_NOP
 1

	)

74 
	#TCPOPT_EOL
 0

	)

75 
	#TCPOPT_MSS
 2

	)

81 
šlše
 
	$befÜe
(
£q1
, 
£q2
)

83  ()(
£q1
-
£q2
) < 0;

84 
	}
}

86 
šlše
 
	$aá”
(
£q1
, 
£q2
)

88  ()(
£q1
-
£q2
) > 0;

89 
	}
}

93 
šlše
 
	$b‘w“n
(
£q1
, 
£q2
, 
£q3
)

95  (
	`aá”
(
£q1
+1, 
£q2
è&& 
	`befÜe
(£q1, 
£q3
+1));

96 
	}
}

105 
šlše
 const 

106 
	$tı_cÚÃùed
(cÚ¡ 
¡©e
)

108 (
¡©e
 =ğ
TCP_ESTABLISHED
 || s‹ =ğ
TCP_CLOSE_WAIT
 ||

109 
¡©e
 =ğ
TCP_FIN_WAIT1
 || s‹ =ğ
TCP_FIN_WAIT2
 ||

110 
¡©e
 =ğ
TCP_SYN_RECV
);

111 
	}
}

114 
´Ùo
 
tı_´Ù
;

117 
tı_”r
(
”r
, *
h—d”
, 
daddr
,

118 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
);

119 
tı_shutdown
 (
sock
 *
sk
, 
how
);

120 
tı_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

121 
İtiÚs
 *
İt
, 
daddr
,

122 
Ën
, 
§ddr
, 
»do
,

123 
š‘_´ÙocŞ
 *
´ÙocŞ
);

125 
tı_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
);

127 
tı_£nd_´obe0
(
sock
 *
sk
);

128 
tı_’queue_·¹Ÿl
(
sk_buff
 *, 
sock
 *);

129 
sk_buff
 * 
tı_dequeue_·¹Ÿl
(
sock
 *);

	@net/inet/timer.c

34 
	~<lšux/ty³s.h
>

35 
	~<lšux/”ºo.h
>

36 
	~<lšux/sock‘.h
>

37 
	~<lšux/š.h
>

38 
	~<lšux/k”Ãl.h
>

39 
	~<lšux/sched.h
>

40 
	~<lšux/tim”.h
>

41 
	~<asm/sy¡em.h
>

42 
	~<lšux/š‹¼u±.h
>

43 
	~"š‘.h
"

44 
	~"dev.h
"

45 
	~".h
"

46 
	~"´ÙocŞ.h
"

47 
	~"tı.h
"

48 
	~"skbuff.h
"

49 
	~"sock.h
"

50 
	~"¬p.h
"

53 
	$d–‘e_tim”
 (
sock
 *
t
)

55 
æags
;

57 
	`§ve_æags
 (
æags
);

58 
	`şi
();

60 
t
->
timeout
 = 0;

61 
	`d–_tim”
 (&
t
->
tim”
);

63 
	`»¡Üe_æags
 (
æags
);

64 
	}
}

67 
	$»£t_tim”
 (
sock
 *
t
, 
timeout
, 
Ën
)

69 
	`d–‘e_tim”
 (
t
);

71 ià(
timeout
 != -1)

72 
t
->
timeout
 =imeout;

76 ià((è
Ën
 < 0)

77 
Ën
 = 3;

79 
t
->
tim”
.
expœes
 = 
Ën
;

80 
	`add_tim”
 (&
t
->
tim”
);

81 
	}
}

90 
	$Ãt_tim”
 (
d©a
)

92 
sock
 *
sk
 = (sock*)
d©a
;

93 
why
 = 
sk
->
timeout
;

96 ià(
sk
->
šu£
 || 
	`š_š‘_bh
()) {

97 
sk
->
tim”
.
expœes
 = 10;

98 
	`add_tim”
(&
sk
->
tim”
);

101 
sk
->
šu£
 = 1;

103 
	`DPRINTF
 ((
DBG_TMR
, "Ãt_tim”: found sk=%X why = %d\n", 
sk
, 
why
));

104 ià(
sk
->
wäÚt
 &&

105 
	`befÜe
(
sk
->
wšdow_£q
, sk->
wäÚt
->
h
.
£q
) &&

106 
sk
->
£nd_h—d
 =ğ
NULL
 &&

107 
sk
->
ack_backlog
 == 0 &&

108 
sk
->
¡©e
 !ğ
TCP_TIME_WAIT
)

109 
	`»£t_tim”
(
sk
, 
TIME_PROBE0
, sk->
¹o
);

110 ià(
sk
->
k“pİ’
)

111 
	`»£t_tim”
 (
sk
, 
TIME_KEEPOPEN
, 
TCP_TIMEOUT_LEN
);

114 ià(
sk
->
ack_backlog
) {

115 
sk
->
´Ù
->
	`»ad_wakeup
 (sk);

116 ià(! 
sk
->
d—d
)

117 
	`wake_up_š‹¼u±ibË
 (
sk
->
¦“p
);

121 
why
) {

122 
TIME_DONE
:

123 ià(! 
sk
->
d—d
 || sk->
¡©e
 !ğ
TCP_CLOSE
) {

124 
	`´štk
 ("non dead socket inime_done\n");

125 
	`»Ëa£_sock
 (
sk
);

128 
	`de¡roy_sock
 (
sk
);

130 
TIME_DESTROY
:

134 if(
sk
->
wmem_®loc
!=0 || sk->
rmem_®loc
!=0)

136 
	`DPRINTF
 ((
DBG_TMR
, "possibË memÜy†—k. sk = %X\n", 
sk
));

137 
sk
->
wmem_®loc
++;

138 
	`de¡roy_sock
 (
sk
);

139 
sk
->
wmem_®loc
--;

140 
sk
->
šu£
 = 0;

142 if(
sk
->
wmem_®loc
==0 && sk->
rmem_®loc
==0)

143 
	`de¡roy_sock
(
sk
);

145 
TIME_CLOSE
:

147 
sk
->
¡©e
 = 
TCP_CLOSE
;

148 
	`d–‘e_tim”
 (
sk
);

150 
	`¬p_de¡roy_maybe
 (
sk
->
daddr
);

151 ià(!
sk
->
d—d
)

152 
	`wake_up_š‹¼u±ibË
 (
sk
->
¦“p
);

153 
sk
->
shutdown
 = 
SHUTDOWN_MASK
;

154 
	`»£t_tim”
 (
sk
, 
TIME_DESTROY
, 
TCP_DONE_TIME
);

155 
	`»Ëa£_sock
 (
sk
);

157 
TIME_PROBE0
:

158 
	`tı_£nd_´obe0
(
sk
);

159 
	`»Ëa£_sock
 (
sk
);

161 
TIME_WRITE
:

165 ià(
sk
->
£nd_h—d
) {

166 ià(
jiff›s
 < (
sk
->
£nd_h—d
->
wh’
 + sk->
¹o
)) {

167 
	`»£t_tim”
 (
sk
, 
TIME_WRITE
,

168 (
sk
->
£nd_h—d
->
wh’
 + sk->
¹o
 - 
jiff›s
));

169 
	`»Ëa£_sock
 (
sk
);

174 
	`DPRINTF
 ((
DBG_TMR
, "retransmitting.\n"));

175 
sk
->
´Ù
->
	`»Œªsm™
 (sk, 0);

176 ià((
sk
->
¡©e
 =ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 && !(sk->retransmits & 7))

177 || (
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 > 
TCP_RETR1
)) {

178 
	`DPRINTF
 ((
DBG_TMR
, "timer.c TIME_WRITEime-out 1\n"));

179 
	`¬p_de¡roy_maybe
 (
sk
->
daddr
);

180 
	`_rou‹_check
 (
sk
->
daddr
);

182 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 > 
TCP_RETR2
) {

183 
	`DPRINTF
 ((
DBG_TMR
, "timer.c TIME_WRITEime-out 2\n"));

184 
sk
->
”r
 = 
ETIMEDOUT
;

185 ià(
sk
->
¡©e
 =ğ
TCP_FIN_WAIT1
 || sk->¡©=ğ
TCP_FIN_WAIT2


186 || 
sk
->
¡©e
 =ğ
TCP_LAST_ACK
) {

187 
sk
->
¡©e
 = 
TCP_TIME_WAIT
;

188 
	`»£t_tim”
 (
sk
, 
TIME_CLOSE
, 
TCP_TIMEWAIT_LEN
);

190 
sk
->
´Ù
->
	`şo£
 (sk, 1);

195 
	`»Ëa£_sock
 (
sk
);

197 
TIME_KEEPOPEN
:

199 ià(
sk
->
´Ù
->
wr™e_wakeup
)

200 
sk
->
´Ù
->
	`wr™e_wakeup
 (sk);

201 
sk
->
»Œªsm™s
++;

202 ià(
sk
->
shutdown
 =ğ
SHUTDOWN_MASK
) {

203 
sk
->
´Ù
->
	`şo£
 (sk, 1);

204 
sk
->
¡©e
 = 
TCP_CLOSE
;

207 ià((
sk
->
¡©e
 =ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 && !(sk->retransmits & 7))

208 || (
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 > 
TCP_RETR1
)) {

209 
	`DPRINTF
 ((
DBG_TMR
, "timer.c TIME_KEEPOPENime-out 1\n"));

210 
	`¬p_de¡roy_maybe
 (
sk
->
daddr
);

211 
	`_rou‹_check
 (
sk
->
daddr
);

212 
	`»Ëa£_sock
 (
sk
);

215 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
 && sk->
»Œªsm™s
 > 
TCP_RETR2
) {

216 
	`DPRINTF
 ((
DBG_TMR
, "timer.c TIME_KEEPOPENime-out 2\n"));

217 
	`¬p_de¡roy_maybe
 (
sk
->
daddr
);

218 
sk
->
”r
 = 
ETIMEDOUT
;

219 ià(
sk
->
¡©e
 =ğ
TCP_FIN_WAIT1
 || sk->¡©=ğ
TCP_FIN_WAIT2
) {

220 
sk
->
¡©e
 = 
TCP_TIME_WAIT
;

221 ià(!
sk
->
d—d
)

222 
	`wake_up_š‹¼u±ibË
 (
sk
->
¦“p
);

223 
	`»Ëa£_sock
 (
sk
);

225 
sk
->
´Ù
->
	`şo£
 (sk, 1);

229 
	`»Ëa£_sock
 (
sk
);

232 
	`´štk
 ("Ãˆtim”ƒxpœed -„—sÚ unknown, sk=%08X\n", ()
sk
);

233 
	`»Ëa£_sock
 (
sk
);

236 
	}
}

	@net/inet/udp.c

45 
	~<asm/sy¡em.h
>

46 
	~<asm/£gm’t.h
>

47 
	~<lšux/ty³s.h
>

48 
	~<lšux/sched.h
>

49 
	~<lšux/fú.h
>

50 
	~<lšux/sock‘.h
>

51 
	~<lšux/sockios.h
>

52 
	~<lšux/š.h
>

53 
	~<lšux/”ºo.h
>

54 
	~<lšux/tim”.h
>

55 
	~<lšux/‹rmios.h
>

56 
	~<lšux/mm.h
>

57 
	~"š‘.h
"

58 
	~"dev.h
"

59 
	~".h
"

60 
	~"´ÙocŞ.h
"

61 
	~"tı.h
"

62 
	~"skbuff.h
"

63 
	~"sock.h
"

64 
	~"udp.h
"

65 
	~"icmp.h
"

68 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

72 
	$´št_udp
(
udphdr
 *
uh
)

74 ià(
š‘_debug
 !ğ
DBG_UDP
) ;

76 ià(
uh
 =ğ
NULL
) {

77 
	`´štk
("(NULL)\n");

80 
	`´štk
("UDP: sourû = %d, de¡ = %d\n", 
	`Áohs
(
uh
->
sourû
),‚tohs(uh->
de¡
));

81 
	`´štk
("†’ = %d, check = %d\n", 
	`Áohs
(
uh
->
Ën
),‚tohs(uh->
check
));

82 
	}
}

96 
	$udp_”r
(
”r
, *
h—d”
, 
daddr
,

97 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

99 
udphdr
 *
th
;

100 
sock
 *
sk
;

101 
hdr
 *

=(hd¸*)
h—d”
;

103 
h—d”
 +ğ4*

->
ihl
;

105 
th
 = (
udphdr
 *)
h—d”
;

107 
	`DPRINTF
((
DBG_UDP
,"UDP:ƒ¼Ó¼=%d, h—d”=%X, daddr=%X, saddr=%X,…rÙoş=%X)\n\
=%d,dpÜt=%d", 
”r
, 
h—d”
, 
daddr
, 
§ddr
, 
´ÙocŞ
, ()
th
->
sourû
,(éh->
de¡
));

110 
sk
 = 
	`g‘_sock
(&
udp_´Ù
, 
th
->
sourû
, 
daddr
,h->
de¡
, 
§ddr
);

112 ià(
sk
 =ğ
NULL
)

115 ià(
”r
 < 0)

117 
sk
->
”r
 = -err;

118 
sk
->
	`”rÜ_»pÜt
(sk);

122 ià(
”r
 & 0xff00 ==(
ICMP_SOURCE_QUENCH
 << 8)) {

123 ià(
sk
->
cÚg_wšdow
 > 1)

124 
sk
->
cÚg_wšdow
 = sk->cong_window/2;

128 
sk
->
”r
 = 
icmp_”r_cÚv”t
[”¸& 0xff].
”ºo
;

131 ià(
icmp_”r_cÚv”t
[
”r
 & 0xff].
çl
 && 
sk
->
¡©e
 =ğ
TCP_ESTABLISHED
) {

132 
sk
->
”r
=
ECONNREFUSED
;

134 
sk
->
	`”rÜ_»pÜt
(sk);

135 
	}
}

139 
	$udp_check
(
udphdr
 *
uh
, 
Ën
,

140 
§ddr
, 
daddr
)

142 
sum
;

144 
	`DPRINTF
((
DBG_UDP
, "UDP: check(uh=%X,†en = %d, saddr = %X, daddr = %X)\n",

145 
uh
, 
Ën
, 
§ddr
, 
daddr
));

147 
	`´št_udp
(
uh
);

149 
	`__asm__
("\t‡ddl %%ecx,%%ebx\n"

152 : "=b"(
sum
)

153 : "0"(
daddr
), "c"(
§ddr
), "d"((
	`Áohs
(
Ën
è<< 16è+ 
IPPROTO_UDP
*256)

156 ià(
Ën
 > 3) {

157 
	`__asm__
("\tclc\n"

163 : "=b"(
sum
è, "=S"(
uh
)

164 : "0"(
sum
), "c"(
Ën
/4è,"1"(
uh
)

169 
	`__asm__
("\t movl %%ebx, %%ecx\n"

173 : "=b"(
sum
)

174 : "0"(
sum
)

178 ià((
Ën
 & 2) != 0) {

179 
	`__asm__
("\t†odsw\n"

182 : "=b"(
sum
), "=S"(
uh
)

183 : "0"(
sum
è,"1"(
uh
)

188 ià((
Ën
 & 1) != 0) {

189 
	`__asm__
("\t†odsb\n"

193 : "=b"(
sum
)

194 : "0"(
sum
è,"S"(
uh
)

199 ((~
sum
) & 0xffff);

200 
	}
}

204 
	$udp_£nd_check
(
udphdr
 *
uh
, 
§ddr
,

205 
daddr
, 
Ën
, 
sock
 *
sk
)

207 
uh
->
check
 = 0;

208 ià(
sk
 && sk->
no_check
)

210 
uh
->
check
 = 
	`udp_check
(uh, 
Ën
, 
§ddr
, 
daddr
);

211 ià(
uh
->
check
 == 0) uh->check = 0xffff;

212 
	}
}

216 
	$udp_£nd
(
sock
 *
sk
, 
sockaddr_š
 *
sš
,

217 *
äom
, 
Ën
)

219 
sk_buff
 *
skb
;

220 
deviû
 *
dev
;

221 
udphdr
 *
uh
;

222 *
buff
;

223 
§ddr
;

224 
size
, 
tmp
;

225 
”r
;

227 
	`DPRINTF
((
DBG_UDP
, "UDP: send(dst=%s:%d buff=%X†en=%d)\n",

228 
	`š_Áß
(
sš
->
sš_addr
.
s_addr
), 
	`Áohs
(sš->
sš_pÜt
),

229 
äom
, 
Ën
));

231 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
äom
, 
Ën
);

232 if(
”r
)

233 (
”r
);

236 
size
 = (
sk_buff
è+ 
sk
->
´Ù
->
max_h—d”
 + 
Ën
;

237 
skb
 = 
sk
->
´Ù
->
	`wm®loc
(sk, 
size
, 0, 
GFP_KERNEL
);

238 ià(
skb
 =ğ
NULL
è(-
ENOMEM
);

240 
skb
->
mem_addr
 = skb;

241 
skb
->
mem_Ën
 = 
size
;

242 
skb
->
sk
 = 
NULL
;

243 
skb
->
ä“
 = 1;

244 
skb
->
¬p
 = 0;

247 
buff
 = 
skb
->
d©a
;

248 
§ddr
 = 0;

249 
dev
 = 
NULL
;

250 
	`DPRINTF
((
DBG_UDP
, "UDP: >> IP_Header: %X -> %X dev=%X…rot=%X†en=%d\n",

251 
§ddr
, 
sš
->
sš_addr
.
s_addr
, 
dev
, 
IPPROTO_UDP
, 
skb
->
mem_Ën
));

252 
tmp
 = 
sk
->
´Ù
->
	`bud_h—d”
(
skb
, 
§ddr
, 
sš
->
sš_addr
.
s_addr
,

253 &
dev
, 
IPPROTO_UDP
, 
sk
->
İt
, 
skb
->
mem_Ën
,sk->
_tos
,sk->
_‰l
);

254 
skb
->
sk
=sk;

256 ià(
tmp
 < 0 ) {

257 
sk
->
´Ù
->
	`wä“
(sk, 
skb
->
mem_addr
, skb->
mem_Ën
);

258 (
tmp
);

260 
buff
 +ğ
tmp
;

261 
§ddr
 = 
dev
->
·_addr
;

262 
	`DPRINTF
((
DBG_UDP
, "UDP: >> MAC+IP†’=%d\n", 
tmp
));

264 
skb
->
Ën
 = 
tmp
 + (
udphdr
) +†en;

265 
skb
->
dev
 = dev;

266 #ifdeà
OLD


272 ià(
Ën
 > 
dev
->
mtu
) {

274 ià(
skb
->
Ën
 > 4095)

277 
	`´štk
("UDP: s’d:†’gth %d > mtu %d (ignÜed)\n", 
Ën
, 
dev
->
mtu
);

278 
sk
->
´Ù
->
	`wä“
(sk, 
skb
->
mem_addr
, skb->
mem_Ën
);

279 (-
EMSGSIZE
);

283 
uh
 = (
udphdr
 *è
buff
;

284 
uh
->
Ën
 = 
	`htÚs
Ö’ + (
udphdr
));

285 
uh
->
sourû
 = 
sk
->
dummy_th
.source;

286 
uh
->
de¡
 = 
sš
->
sš_pÜt
;

287 
buff
 = (*è(
uh
 + 1);

290 
	`memıy_äomfs
(
buff
, 
äom
, 
Ën
);

293 
	`udp_£nd_check
(
uh
, 
§ddr
, 
sš
->
sš_addr
.
s_addr
, 
skb
->
Ën
 - 
tmp
, 
sk
);

296 
sk
->
´Ù
->
	`queue_xm™
(sk, 
dev
, 
skb
, 1);

298 (
Ën
);

299 
	}
}

303 
	$udp_£ndto
(
sock
 *
sk
, *
äom
, 
Ën
, 
noblock
,

304 
æags
, 
sockaddr_š
 *
usš
, 
addr_Ën
)

306 
sockaddr_š
 
sš
;

307 
tmp
;

308 
”r
;

310 
	`DPRINTF
((
DBG_UDP
, "UDP: s’dtoÖ’=%d, fÏgs=%X)\n", 
Ën
, 
æags
));

313 ià(
æags
)

314 (-
EINVAL
);

315 ià(
Ën
 < 0)

316 (-
EINVAL
);

317 ià(
Ën
 == 0)

321 ià(
usš
) {

322 ià(
addr_Ën
 < (
sš
)è(-
EINVAL
);

323 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, 
usš
, (
sš
));

324 if(
”r
)

325  
”r
;

326 
	`memıy_äomfs
(&
sš
, 
usš
, (sin));

327 ià(
sš
.
sš_çmy
 && sš.sš_çmy !ğ
AF_INET
)

328 (-
EINVAL
);

329 ià(
sš
.
sš_pÜt
 == 0)

330 (-
EINVAL
);

332 ià(
sk
->
¡©e
 !ğ
TCP_ESTABLISHED
è(-
EINVAL
);

333 
sš
.
sš_çmy
 = 
AF_INET
;

334 
sš
.
sš_pÜt
 = 
sk
->
dummy_th
.
de¡
;

335 
sš
.
sš_addr
.
s_addr
 = 
sk
->
daddr
;

338 if(!
sk
->
brßdÿ¡
 && 
	`chk_addr
(
sš
.
sš_addr
.
s_addr
)==
IS_BROADCAST
)

339  -
EACCES
;

340 
sk
->
šu£
 = 1;

343 
tmp
 = 
	`udp_£nd
(
sk
, &
sš
, 
äom
, 
Ën
);

346 
	`»Ëa£_sock
(
sk
);

347 (
tmp
);

348 
	}
}

352 
	$udp_wr™e
(
sock
 *
sk
, *
buff
, 
Ën
, 
noblock
,

353 
æags
)

355 (
	`udp_£ndto
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, 0));

356 
	}
}

360 
	$udp_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
)

362 
”r
;

363 
cmd
) {

364 
DDIOCSDBG
:

366 
v®
;

368 ià(!
	`su£r
()è(-
EPERM
);

369 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, (*)
¬g
, ());

370 if(
”r
)

371  
”r
;

372 
v®
 = 
	`g‘_fs_lÚg
((*)
¬g
);

373 
v®
) {

375 
š‘_debug
 = 0;

378 
š‘_debug
 = 
DBG_UDP
;

381 (-
EINVAL
);

385 
TIOCOUTQ
:

387 
amouÁ
;

389 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
è(-
EINVAL
);

390 
amouÁ
 = 
sk
->
´Ù
->
	`w¥aû
(sk) ;

391 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
,

393 if(
”r
)

394 (
”r
);

395 
	`put_fs_lÚg
(
amouÁ
,(*)
¬g
);

399 
TIOCINQ
:

401 
sk_buff
 *
skb
;

402 
amouÁ
;

404 ià(
sk
->
¡©e
 =ğ
TCP_LISTEN
è(-
EINVAL
);

405 
amouÁ
 = 0;

406 
skb
 = 
sk
->
rqueue
;

407 ià(
skb
 !ğ
NULL
) {

413 
amouÁ
 = 
skb
->
Ën
;

415 
”r
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
,

417 if(
”r
)

418 (
”r
);

419 
	`put_fs_lÚg
(
amouÁ
,(*)
¬g
);

424 (-
EINVAL
);

427 
	}
}

435 
	$udp_»cväom
(
sock
 *
sk
, *
to
, 
Ën
,

436 
noblock
, 
æags
, 
sockaddr_š
 *
sš
,

437 *
addr_Ën
)

439 
cİ›d
 = 0;

440 
sk_buff
 *
skb
;

441 
”
;

448 ià(
sk
->
”r
) {

449 
”r
;

451 
”r
 = -
sk
->err;

452 
sk
->
”r
 = 0;

453 (
”r
);

456 ià(
Ën
 == 0)

458 ià(
Ën
 < 0)

459 (-
EINVAL
);

461 ià(
addr_Ën
) {

462 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
addr_Ën
, (*addr_len));

463 if(
”
)

464 (
”
);

465 
	`put_fs_lÚg
((*
sš
), 
addr_Ën
);

467 if(
sš
)

469 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
sš
, (*sin));

470 if(
”
)

471 (
”
);

473 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
,
to
,
Ën
);

474 if(
”
)

475  
”
;

476 
skb
=
	`skb_»cv_d©ag¿m
(
sk
,
æags
,
noblock
,&
”
);

477 if(
skb
==
NULL
)

478  
”
;

479 
cİ›d
 = 
	`mš
(
Ën
, 
skb
->len);

482 
	`skb_cİy_d©ag¿m
(
skb
,(
udphdr
),
to
,
cİ›d
);

485 ià(
sš
) {

486 
sockaddr_š
 
addr
;

488 
addr
.
sš_çmy
 = 
AF_INET
;

489 
addr
.
sš_pÜt
 = 
skb
->
h
.
uh
->
sourû
;

490 
addr
.
sš_addr
.
s_addr
 = 
skb
->
daddr
;

491 
	`memıy_tofs
(
sš
, &
addr
, (*sin));

494 
	`skb_ä“_d©ag¿m
(
skb
);

495 
	`»Ëa£_sock
(
sk
);

496 (
cİ›d
);

497 
	}
}

501 
	$udp_»ad
(
sock
 *
sk
, *
buff
, 
Ën
, 
noblock
,

502 
æags
)

504 (
	`udp_»cväom
(
sk
, 
buff
, 
Ën
, 
noblock
, 
æags
, 
NULL
, NULL));

505 
	}
}

509 
	$udp_cÚÃù
(
sock
 *
sk
, 
sockaddr_š
 *
usš
, 
addr_Ën
)

511 
sockaddr_š
 
sš
;

512 
”
;

514 ià(
addr_Ën
 < (
sš
))

515 (-
EINVAL
);

517 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
usš
, (
sš
));

518 if(
”
)

519  
”
;

521 
	`memıy_äomfs
(&
sš
, 
usš
, (sin));

522 ià(
sš
.
sš_çmy
 && sš.sš_çmy !ğ
AF_INET
)

523 (-
EAFNOSUPPORT
);

525 if(!
sk
->
brßdÿ¡
 && 
	`chk_addr
(
sš
.
sš_addr
.
s_addr
)==
IS_BROADCAST
)

526  -
EACCES
;

528 
sk
->
daddr
 = 
sš
.
sš_addr
.
s_addr
;

529 
sk
->
dummy_th
.
de¡
 = 
sš
.
sš_pÜt
;

530 
sk
->
¡©e
 = 
TCP_ESTABLISHED
;

532 
	}
}

536 
	$udp_şo£
(
sock
 *
sk
, 
timeout
)

538 
sk
->
šu£
 = 1;

539 
sk
->
¡©e
 = 
TCP_CLOSE
;

540 ià(
sk
->
d—d
è
	`de¡roy_sock
(sk);

541 
	`»Ëa£_sock
(
sk
);

542 
	}
}

547 
	$udp_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
, 
İtiÚs
 *
İt
,

548 
daddr
, 
Ën
,

549 
§ddr
, 
»do
, 
š‘_´ÙocŞ
 *
´ÙocŞ
)

551 
sock
 *
sk
;

552 
udphdr
 *
uh
;

554 
uh
 = (
udphdr
 *è
skb
->
h
.uh;

555 
sk
 = 
	`g‘_sock
(&
udp_´Ù
, 
uh
->
de¡
, 
§ddr
, uh->
sourû
, 
daddr
);

556 ià(
sk
 =ğ
NULL
)

558 ià(
	`chk_addr
(
daddr
è=ğ
IS_MYADDR
)

560 
	`icmp_£nd
(
skb
, 
ICMP_DEST_UNREACH
, 
ICMP_PORT_UNREACH
, 
dev
);

567 
skb
->
sk
 = 
NULL
;

568 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

572 ià(
uh
->
check
 && 
	`udp_check
(uh, 
Ën
, 
§ddr
, 
daddr
)) {

573 
	`DPRINTF
((
DBG_UDP
, "UDP: bad checksum\n"));

574 
skb
->
sk
 = 
NULL
;

575 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

579 
skb
->
sk
 = sk;

580 
skb
->
dev
 = dev;

581 
skb
->
Ën
 =†en;

584 
skb
->
daddr
 = 
§ddr
;

585 
skb
->
§ddr
 = 
daddr
;

589 ià(
sk
->
rmem_®loc
 + 
skb
->
mem_Ën
 >ğsk->
rcvbuf
)

591 
skb
->
sk
 = 
NULL
;

592 
	`kä“_skb
(
skb
, 
FREE_WRITE
);

593 
	`»Ëa£_sock
(
sk
);

596 
sk
->
rmem_®loc
 +ğ
skb
->
mem_Ën
;

599 
	`DPRINTF
((
DBG_UDP
, "<< \n"));

600 
	`´št_udp
(
uh
);

604 
	`skb_queue_
(&
sk
->
rqueue
,
skb
);

606 
skb
->
Ën
 =†’ - (*
uh
);

608 ià(!
sk
->
d—d
)

609 
sk
->
	`d©a_»ady
(sk,
skb
->
Ën
);

611 
	`»Ëa£_sock
(
sk
);

613 
	}
}

616 
´Ùo
 
	gudp_´Ù
 = {

617 
sock_wm®loc
,

618 
sock_rm®loc
,

619 
sock_wä“
,

620 
sock_rä“
,

621 
sock_r¥aû
,

622 
sock_w¥aû
,

623 
udp_şo£
,

624 
udp_»ad
,

625 
udp_wr™e
,

626 
udp_£ndto
,

627 
udp_»cväom
,

628 
_bud_h—d”
,

629 
udp_cÚÃù
,

630 
NULL
,

631 
_queue_xm™
,

632 
_»Œªsm™
,

633 
NULL
,

634 
NULL
,

635 
udp_rcv
,

636 
d©ag¿m_£Ëù
,

637 
udp_ioùl
,

638 
NULL
,

639 
NULL
,

640 
_£tsockİt
,

641 
_g‘sockİt
,

644 {
NULL
,},

	@net/inet/udp.h

22 #iâdeà
_UDP_H


23 
	#_UDP_H


	)

25 
	~<lšux/udp.h
>

28 
	#UDP_NO_CHECK
 0

	)

31 
´Ùo
 
udp_´Ù
;

34 
udp_”r
(
”r
, *
h—d”
, 
daddr
,

35 
§ddr
, 
š‘_´ÙocŞ
 *
´ÙocŞ
);

36 
udp_»cväom
(
sock
 *
sk
, *
to
,

37 
Ën
, 
noblock
, 
æags
,

38 
sockaddr_š
 *
sš
, *
addr_Ën
);

39 
udp_»ad
(
sock
 *
sk
, *
buff
,

40 
Ën
, 
noblock
, 
æags
);

41 
udp_cÚÃù
(
sock
 *
sk
,

42 
sockaddr_š
 *
usš
, 
addr_Ën
);

43 
udp_rcv
(
sk_buff
 *
skb
, 
deviû
 *
dev
,

44 
İtiÚs
 *
İt
, 
daddr
,

45 
Ën
, 
§ddr
, 
»do
,

46 
š‘_´ÙocŞ
 *
´ÙocŞ
);

47 
udp_ioùl
(
sock
 *
sk
, 
cmd
, 
¬g
);

	@net/inet/utils.c

22 
	~<asm/£gm’t.h
>

23 
	~<asm/sy¡em.h
>

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/k”Ãl.h
>

26 
	~<lšux/sched.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/mm.h
>

29 
	~<lšux/sock‘.h
>

30 
	~<lšux/š.h
>

31 
	~<lšux/”ºo.h
>

32 
	~<lšux/¡©.h
>

33 
	~<¡d¬g.h
>

34 
	~"š‘.h
"

35 
	~"dev.h
"

36 
	~"‘h.h
"

37 
	~".h
"

38 
	~"´ÙocŞ.h
"

39 
	~"tı.h
"

40 
	~"skbuff.h
"

41 
	~"¬p.h
"

45 *
	$š_Áß
(
š
)

47 
buff
[18];

48 *
p
;

50 
p
 = (*è&
š
;

51 
	`¥rštf
(
buff
, "%d.%d.%d.%d",

52 (
p
[0] & 255), (p[1] & 255), (p[2] & 255), (p[3] & 255));

53 (
buff
);

54 
	}
}

59 
	$š_©Ú
(*
¡r
)

61 
l
;

62 
v®
;

63 
i
;

65 
l
 = 0;

66 
i
 = 0; i < 4; i++) {

67 
l
 <<= 8;

68 ià(*
¡r
 != '\0') {

69 
v®
 = 0;

70 *
¡r
 != '\0' && *str != '.') {

71 
v®
 *= 10;

72 
v®
 +ğ*
¡r
 - '0';

73 
¡r
++;

75 
l
 |ğ
v®
;

76 ià(*
¡r
 != '\0') str++;

79 (
	`htÚl
(
l
));

80 
	}
}

84 
	$d´štf
(
Ëv–
, *
fmt
, ...)

86 
va_li¡
 
¬gs
;

87 *
buff
;

88 
	`v¥rštf
(* 
buf
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gs
);

90 ià(
Ëv–
 !ğ
š‘_debug
) ;

92 
buff
 = (*è
	`km®loc
(256, 
GFP_ATOMIC
);

93 ià(
buff
 !ğ
NULL
) {

94 
	`va_¡¬t
(
¬gs
, 
fmt
);

95 
	`v¥rštf
(
buff
, 
fmt
, 
¬gs
);

96 
	`va_’d
(
¬gs
);

97 
	`´štk
(
buff
);

98 
	`kä“
(
buff
);

100 
	}
}

104 
	$dbg_ioùl
(*
¬g
, 
Ëv–
)

106 
v®
;

107 
”r
;

109 ià(!
	`su£r
()è(-
EPERM
);

110 
”r
=
	`v”ify_¬—
(
VERIFY_READ
, (*)
¬g
, ());

111 if(
”r
)

112  
”r
;

113 
v®
 = 
	`g‘_fs_lÚg
((*)
¬g
);

114 
v®
) {

116 
š‘_debug
 = 
DBG_OFF
;

119 
š‘_debug
 = 
Ëv–
;

122 
DBG_RT
:

123 
DBG_DEV
:

124 
DBG_ETH
:

125 
DBG_PROTO
:

126 
DBG_TMR
:

127 
DBG_PKT
:

128 
DBG_RAW
:

130 
DBG_LOOPB
:

131 
DBG_SLIP
:

133 
DBG_ARP
:

134 
DBG_IP
:

135 
DBG_ICMP
:

136 
DBG_TCP
:

137 
DBG_UDP
:

139 
š‘_debug
 = 
v®
;

143 (-
EINVAL
);

147 
	}
}

	@net/socket.c

22 
	~<lšux/cÚfig.h
>

23 
	~<lšux/sigÇl.h
>

24 
	~<lšux/”ºo.h
>

25 
	~<lšux/sched.h
>

26 
	~<lšux/k”Ãl.h
>

27 
	~<lšux/majÜ.h
>

28 
	~<lšux/¡©.h
>

29 
	~<lšux/sock‘.h
>

30 
	~<lšux/fú.h
>

31 
	~<lšux/Ãt.h
>

32 
	~<lšux/ddi.h
>

34 
	~<asm/sy¡em.h
>

35 
	~<asm/£gm’t.h
>

37 #undeà
SOCK_DEBUG


39 #ifdeà
SOCK_DEBUG


40 
	~<¡d¬g.h
>

41 
	#DPRINTF
(
x
è
d´štf
 
	)
x

43 
	#DPRINTF
(
x
è

	)

46 
sock_l£ek
(
šode
 *šode, 
fe
 *fe, 
off_t
 
off£t
,

47 
wh’û
);

48 
sock_»ad
(
šode
 *šode, 
fe
 *fe, *
buf
,

49 
size
);

50 
sock_wr™e
(
šode
 *šode, 
fe
 *fe, *
buf
,

51 
size
);

52 
sock_»addœ
(
šode
 *šode, 
fe
 *file,

53 
dœ’t
 *dœ’t, 
couÁ
);

54 
sock_şo£
(
šode
 *šode, 
fe
 *file);

55 
sock_£Ëù
(
šode
 *šode, 
fe
 *fe, 
which
, 
£Ëù_bË
 *
£ÉabË
);

56 
sock_ioùl
(
šode
 *šode, 
fe
 *file,

57 
cmd
, 
¬g
);

60 
fe_İ”©iÚs
 
	gsock‘_fe_İs
 = {

61 
sock_l£ek
,

62 
sock_»ad
,

63 
sock_wr™e
,

64 
sock_»addœ
,

65 
sock_£Ëù
,

66 
sock_ioùl
,

67 
NULL
,

68 
NULL
,

69 
sock_şo£


72 
sock‘
 
	gsock‘s
[
NSOCKETS
];

73 
wa™_queue
 *
	gsock‘_wa™_ä“
 = 
NULL
;

74 
´Ùo_İs
 *
	gpİs
[
NPROTO
];

75 
	gÃt_debug
 = 0;

77 
	#Ï¡_sock‘
 (
sock‘s
 + 
NSOCKETS
 - 1)

	)

79 #ifdeà
SOCK_DEBUG


82 
	$d´štf
(
Ëv–
, *
fmt
, ...)

84 
buff
[1024];

85 
va_li¡
 
¬gs
;

86 
	`v¥rštf
(* 
buf
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gs
);

88 ià(
Ëv–
 == 0) ;

89 
	`va_¡¬t
(
¬gs
, 
fmt
);

90 
	`v¥rštf
(
buff
, 
fmt
, 
¬gs
);

91 
	`va_’d
(
¬gs
);

92 
	`´štk
(
buff
);

93 
	}
}

98 
	$g‘_fd
(
šode
 *inode)

100 
fd
;

101 
fe
 *file;

104 
fe
 = 
	`g‘_em±y_fp
();

105 ià(!
fe
) (-1);

106 
fd
 = 0; fd < 
NR_OPEN
; ++fd)

107 ià(!
cu¼’t
->
fp
[
fd
]) ;

108 ià(
fd
 =ğ
NR_OPEN
) {

109 
fe
->
f_couÁ
 = 0;

112 
	`FD_CLR
(
fd
, &
cu¼’t
->
şo£_Ú_exec
);

113 
cu¼’t
->
fp
[
fd
] = 
fe
;

114 
fe
->
f_İ
 = &
sock‘_fe_İs
;

115 
fe
->
f_mode
 = 3;

116 
fe
->
f_æags
 = 0;

117 
fe
->
f_couÁ
 = 1;

118 
fe
->
f_šode
 = 
šode
;

119 ià(
šode
èšode->
i_couÁ
++;

120 
fe
->
f_pos
 = 0;

121 (
fd
);

122 
	}
}

130 
šlše
 

131 
	$toss_fd
(
fd
)

133 
	`sys_şo£
(
fd
);

134 
	}
}

137 
sock‘
 *

138 
	$socki_lookup
(
šode
 *inode)

140 
sock‘
 *
sock
;

142 ià((
sock
 = 
šode
->
i_sock‘
è!ğ
NULL
) {

143 ià(
sock
->
¡©e
 !ğ
SS_FREE
 && 
	`SOCK_INODE
(sockè=ğ
šode
)

144  
sock
;

145 
	`´štk
("socket.c: uhhuh. stale inode->i_socket…ointer\n");

147 
sock
 = 
sock‘s
; sock <ğ
Ï¡_sock‘
; ++sock)

148 ià(
sock
->
¡©e
 !ğ
SS_FREE
 && 
	`SOCK_INODE
(sockè=ğ
šode
) {

149 
	`´štk
("socket.c: uhhuh. Found socket despite‚o inode->i_socket…ointer\n");

150 (
sock
);

152 (
NULL
);

153 
	}
}

156 
šlše
 
sock‘
 *

157 
	$sockfd_lookup
(
fd
, 
fe
 **
pfe
)

159 
fe
 *file;

161 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || !(
fe
 = 
cu¼’t
->
fp
[fd])è(
NULL
);

162 ià(
pfe
è*pfğ
fe
;

163 (
	`socki_lookup
(
fe
->
f_šode
));

164 
	}
}

167 
sock‘
 *

168 
	$sock_®loc
(
wa™
)

170 
sock‘
 *
sock
;

173 
	`şi
();

174 
sock
 = 
sock‘s
; sock <ğ
Ï¡_sock‘
; ++sock) {

175 ià(
sock
->
¡©e
 =ğ
SS_FREE
) {

176 
sock
->
¡©e
 = 
SS_UNCONNECTED
;

177 
	`¡i
();

178 
sock
->
æags
 = 0;

179 
sock
->
İs
 = 
NULL
;

180 
sock
->
d©a
 = 
NULL
;

181 
sock
->
cÚn
 = 
NULL
;

182 
sock
->
icÚn
 = 
NULL
;

191 ià(!(
	`SOCK_INODE
(
sock
èğ
	`g‘_em±y_šode
())) {

192 
	`´štk
("NET: sock_alloc:‚o more inodes\n");

193 
sock
->
¡©e
 = 
SS_FREE
;

194 (
NULL
);

196 
	`SOCK_INODE
(
sock
)->
i_mode
 = 
S_IFSOCK
;

197 
	`SOCK_INODE
(
sock
)->
i_uid
 = 
cu¼’t
->
euid
;

198 
	`SOCK_INODE
(
sock
)->
i_gid
 = 
cu¼’t
->
egid
;

199 
	`SOCK_INODE
(
sock
)->
i_sock‘
 = sock;

201 
sock
->
wa™
 = &
	`SOCK_INODE
(sock)->
i_wa™
;

202 
	`DPRINTF
((
Ãt_debug
,

204 
sock
, 
	`SOCK_INODE
(sock)));

205 (
sock
);

208 
	`¡i
();

209 ià(!
wa™
è(
NULL
);

210 
	`DPRINTF
((
Ãt_debug
, "NET: sock_alloc:‚o free sockets, sleeping...\n"));

211 
	`š‹¼u±ibË_¦“p_Ú
(&
sock‘_wa™_ä“
);

212 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

213 
	`DPRINTF
((
Ãt_debug
, "NET: sock_alloc: sleep was interrupted\n"));

214 (
NULL
);

216 
	`DPRINTF
((
Ãt_debug
, "NET: sock_alloc: wakeup...rying‡gain...\n"));

218 
	}
}

221 
šlše
 

222 
	$sock_»Ëa£_³”
(
sock‘
 *
³”
)

224 
³”
->
¡©e
 = 
SS_DISCONNECTING
;

225 
	`wake_up_š‹¼u±ibË
(
³”
->
wa™
);

226 
	}
}

230 
	$sock_»Ëa£
(
sock‘
 *
sock
)

232 
Şd¡©e
;

233 
šode
 *inode;

234 
sock‘
 *
³”sock
, *
Ãxtsock
;

236 
	`DPRINTF
((
Ãt_debug
, "NET: sock_release: socket 0x%x, inode 0x%x\n",

237 
sock
, 
	`SOCK_INODE
(sock)));

238 ià((
Şd¡©e
 = 
sock
->
¡©e
è!ğ
SS_UNCONNECTED
)

239 
sock
->
¡©e
 = 
SS_DISCONNECTING
;

242 
³”sock
 = 
sock
->
icÚn
;…“rsock;…“rsock = 
Ãxtsock
) {

243 
Ãxtsock
 = 
³”sock
->
Ãxt
;

244 
	`sock_»Ëa£_³”
(
³”sock
);

251 
³”sock
 = (
Şd¡©e
 =ğ
SS_CONNECTED
è? 
sock
->
cÚn
 : 
NULL
;

252 ià(
sock
->
İs
èsock->İs->
	`»Ëa£
(sock, 
³”sock
);

253 ià(
³”sock
è
	`sock_»Ëa£_³”
(peersock);

254 
šode
 = 
	`SOCK_INODE
(
sock
);

255 
sock
->
¡©e
 = 
SS_FREE
;

256 
	`wake_up_š‹¼u±ibË
(&
sock‘_wa™_ä“
);

259 
	`ut
(
šode
);

260 
	}
}

264 
	$sock_l£ek
(
šode
 *šode, 
fe
 *fe, 
off_t
 
off£t
, 
wh’û
)

266 
	`DPRINTF
((
Ãt_debug
, "NET: sock_lseek: huh?\n"));

267 (-
ESPIPE
);

268 
	}
}

272 
	$sock_»ad
(
šode
 *šode, 
fe
 *fe, *
ubuf
, 
size
)

274 
sock‘
 *
sock
;

276 
	`DPRINTF
((
Ãt_debug
, "NET: sock_»ad: buf=0x%x, size=%d\n", 
ubuf
, 
size
));

277 ià(!(
sock
 = 
	`socki_lookup
(
šode
))) {

278 
	`´štk
("NET: sock_read: can't find socket for inode!\n");

279 (-
EBADF
);

281 ià(
sock
->
æags
 & 
SO_ACCEPTCON
è(-
EINVAL
);

282 (
sock
->
İs
->
	`»ad
(sock, 
ubuf
, 
size
, (
fe
->
f_æags
 & 
O_NONBLOCK
)));

283 
	}
}

287 
	$sock_wr™e
(
šode
 *šode, 
fe
 *fe, *
ubuf
, 
size
)

289 
sock‘
 *
sock
;

291 
	`DPRINTF
((
Ãt_debug
, "NET: sock_wr™e: buf=0x%x, size=%d\n", 
ubuf
, 
size
));

292 ià(!(
sock
 = 
	`socki_lookup
(
šode
))) {

293 
	`´štk
("NET: sock_write: can't find socket for inode!\n");

294 (-
EBADF
);

296 ià(
sock
->
æags
 & 
SO_ACCEPTCON
è(-
EINVAL
);

297 (
sock
->
İs
->
	`wr™e
(sock, 
ubuf
, 
size
,(
fe
->
f_æags
 & 
O_NONBLOCK
)));

298 
	}
}

302 
	$sock_»addœ
(
šode
 *šode, 
fe
 *fe, 
dœ’t
 *dirent,

303 
couÁ
)

305 
	`DPRINTF
((
Ãt_debug
, "NET: sock_readdir: huh?\n"));

306 (-
EBADF
);

307 
	}
}

311 
	$sock_ioùl
(
šode
 *šode, 
fe
 *fe, 
cmd
,

312 
¬g
)

314 
sock‘
 *
sock
;

316 
	`DPRINTF
((
Ãt_debug
, "NET: sock_ioctl: inode=0x%x cmd=0x%x‡rg=%d\n",

317 
šode
, 
cmd
, 
¬g
));

318 ià(!(
sock
 = 
	`socki_lookup
(
šode
))) {

319 
	`´štk
("NET: sock_ioctl: can't find socket for inode!\n");

320 (-
EBADF
);

322 (
sock
->
İs
->
	`ioùl
(sock, 
cmd
, 
¬g
));

323 
	}
}

327 
	$sock_£Ëù
(
šode
 *šode, 
fe
 *fe, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

329 
sock‘
 *
sock
;

331 
	`DPRINTF
((
Ãt_debug
, "NET: sock_£Ëù: inodğ0x%x, kšd = %s\n", 
šode
,

332 (
£l_ty³
 =ğ
SEL_IN
) ? "in" :

333 (
£l_ty³
 =ğ
SEL_OUT
) ? "out" : "ex"));

334 ià(!(
sock
 = 
	`socki_lookup
(
šode
))) {

335 
	`´štk
("NET: sock_select: can't find socket for inode!\n");

340 ià(
sock
->
İs
 && sock->İs->
£Ëù
)

341 (
sock
->
İs
->
	`£Ëù
(sock, 
£l_ty³
, 
wa™
));

343 
	}
}

347 
	$sock_şo£
(
šode
 *šode, 
fe
 *file)

349 
sock‘
 *
sock
;

351 
	`DPRINTF
((
Ãt_debug
, "NET: sock_close: inode=0x%x (cnt=%d)\n",

352 
šode
, inode->
i_couÁ
));

355 ià(!
šode
) ;

356 ià(!(
sock
 = 
	`socki_lookup
(
šode
))) {

357 
	`´štk
("NET: sock_close: can't find socket for inode!\n");

360 
	`sock_»Ëa£
(
sock
);

361 
	}
}

365 
	$sock_awa™cÚn
(
sock‘
 *
mysock
, sock‘ *
£rvsock
)

367 
sock‘
 *
Ï¡
;

369 
	`DPRINTF
((
Ãt_debug
,

371 
mysock
, 
£rvsock
));

372 ià(!(
£rvsock
->
æags
 & 
SO_ACCEPTCON
)) {

373 
	`DPRINTF
((
Ãt_debug
,

375 (-
EINVAL
);

379 
mysock
->
Ãxt
 = 
NULL
;

380 
	`şi
();

381 ià(!(
Ï¡
 = 
£rvsock
->
icÚn
)è£rvsock->icÚÀğ
mysock
;

383 
Ï¡
->
Ãxt
)†ast =†ast->next;

384 
Ï¡
->
Ãxt
 = 
mysock
;

386 
mysock
->
¡©e
 = 
SS_CONNECTING
;

387 
mysock
->
cÚn
 = 
£rvsock
;

388 
	`¡i
();

394 
	`wake_up_š‹¼u±ibË
(
£rvsock
->
wa™
);

395 ià(
mysock
->
¡©e
 !ğ
SS_CONNECTED
) {

396 
	`š‹¼u±ibË_¦“p_Ú
(
mysock
->
wa™
);

397 ià(
mysock
->
¡©e
 !ğ
SS_CONNECTED
 &&

398 
mysock
->
¡©e
 !ğ
SS_DISCONNECTING
) {

406 ià(
mysock
->
cÚn
 =ğ
£rvsock
) {

407 
	`şi
();

408 ià((
Ï¡
 = 
£rvsock
->
icÚn
è=ğ
mysock
)

409 
£rvsock
->
icÚn
 = 
mysock
->
Ãxt
;

411 
Ï¡
->
Ãxt
 !ğ
mysock
)†ast =†ast->next;

412 
Ï¡
->
Ãxt
 = 
mysock
->next;

414 
	`¡i
();

416 (
mysock
->
cÚn
 ? -
EINTR
 : -
EACCES
);

420 
	}
}

428 
	$sock_sock‘
(
çmy
, 
ty³
, 
´ÙocŞ
)

430 
i
, 
fd
;

431 
sock‘
 *
sock
;

432 
´Ùo_İs
 *
İs
;

434 
	`DPRINTF
((
Ãt_debug
,

436 
çmy
, 
ty³
, 
´ÙocŞ
));

439 
i
 = 0; i < 
NPROTO
; ++i) {

440 ià(
pİs
[
i
] =ğ
NULL
) ;

441 ià(
pİs
[
i
]->
çmy
 == family) ;

443 ià(
i
 =ğ
NPROTO
) {

444 
	`DPRINTF
((
Ãt_debug
, "NET: sock_socket: family‚ot found\n"));

445 (-
EINVAL
);

447 
İs
 = 
pİs
[
i
];

454 ià((
ty³
 !ğ
SOCK_STREAM
 &&y³ !ğ
SOCK_DGRAM
 &&

455 
ty³
 !ğ
SOCK_SEQPACKET
 &&y³ !ğ
SOCK_RAW
 &&

456 
ty³
 !ğ
SOCK_PACKET
è|| 
´ÙocŞ
 < 0)

457 (-
EINVAL
);

464 ià(!(
sock
 = 
	`sock_®loc
(1))) {

465 
	`´štk
("sock_socket:‚o more sockets\n");

466 (-
EAGAIN
);

468 
sock
->
ty³
 =ype;

469 
sock
->
İs
 = ops;

470 ià((
i
 = 
sock
->
İs
->
	`ü—‹
(sock, 
´ÙocŞ
)) < 0) {

471 
	`sock_»Ëa£
(
sock
);

472 (
i
);

475 ià((
fd
 = 
	`g‘_fd
(
	`SOCK_INODE
(
sock
))) < 0) {

476 
	`sock_»Ëa£
(
sock
);

477 (-
EINVAL
);

480 (
fd
);

481 
	}
}

485 
	$sock_sock‘·œ
(
çmy
, 
ty³
, 
´ÙocŞ
, 
usockvec
[2])

487 
fd1
, 
fd2
, 
i
;

488 
sock‘
 *
sock1
, *
sock2
;

489 
”
;

491 
	`DPRINTF
((
Ãt_debug
,

493 
çmy
, 
ty³
, 
´ÙocŞ
));

499 ià((
fd1
 = 
	`sock_sock‘
(
çmy
, 
ty³
, 
´ÙocŞ
)) < 0) (fd1);

500 
sock1
 = 
	`sockfd_lookup
(
fd1
, 
NULL
);

501 ià(!
sock1
->
İs
->
sock‘·œ
) {

502 
	`sys_şo£
(
fd1
);

503 (-
EINVAL
);

507 ià((
fd2
 = 
	`sock_sock‘
(
çmy
, 
ty³
, 
´ÙocŞ
)) < 0) {

508 
	`sys_şo£
(
fd1
);

509 (-
EINVAL
);

511 
sock2
 = 
	`sockfd_lookup
(
fd2
, 
NULL
);

512 ià((
i
 = 
sock1
->
İs
->
	`sock‘·œ
(sock1, 
sock2
)) < 0) {

513 
	`sys_şo£
(
fd1
);

514 
	`sys_şo£
(
fd2
);

515 (
i
);

517 
sock1
->
cÚn
 = 
sock2
;

518 
sock2
->
cÚn
 = 
sock1
;

519 
sock1
->
¡©e
 = 
SS_CONNECTED
;

520 
sock2
->
¡©e
 = 
SS_CONNECTED
;

522 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
usockvec
, 2 * ());

523 if(
”
)

524  
”
;

525 
	`put_fs_lÚg
(
fd1
, &
usockvec
[0]);

526 
	`put_fs_lÚg
(
fd2
, &
usockvec
[1]);

529 
	}
}

537 
	$sock_bšd
(
fd
, 
sockaddr
 *
umyaddr
, 
add¾’
)

539 
sock‘
 *
sock
;

540 
i
;

542 
	`DPRINTF
((
Ãt_debug
, "NET: sock_bšd: fd = %d\n", 
fd
));

543 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || 
cu¼’t
->
fp
[fd] =ğ
NULL
)

544 (-
EBADF
);

545 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

546 ià((
i
 = 
sock
->
İs
->
	`bšd
(sock, 
umyaddr
, 
add¾’
)) < 0) {

547 
	`DPRINTF
((
Ãt_debug
, "NET: sock_bind: bind failed\n"));

548 (
i
);

551 
	}
}

560 
	$sock_li¡’
(
fd
, 
backlog
)

562 
sock‘
 *
sock
;

564 
	`DPRINTF
((
Ãt_debug
, "NET: sock_li¡’: fd = %d\n", 
fd
));

565 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || 
cu¼’t
->
fp
[fd] =ğ
NULL
)

566 (-
EBADF
);

567 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

568 ià(
sock
->
¡©e
 !ğ
SS_UNCONNECTED
) {

569 
	`DPRINTF
((
Ãt_debug
, "NET: sock_listen: socket isn't unconnected\n"));

570 (-
EINVAL
);

572 ià(
sock
->
İs
 && sock->İs->
li¡’
èsock->İs->
	`li¡’
(sock, 
backlog
);

573 
sock
->
æags
 |ğ
SO_ACCEPTCON
;

575 
	}
}

584 
	$sock_acû±
(
fd
, 
sockaddr
 *
u³”_sockaddr
, *
u³”_add¾’
)

586 
fe
 *file;

587 
sock‘
 *
sock
, *
Ãwsock
;

588 
i
;

590 
	`DPRINTF
((
Ãt_debug
, "NET: sock_acû±: fd = %d\n", 
fd
));

591 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

592 (-
EBADF
);

594 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, &
fe
))è(-
ENOTSOCK
);

595 ià(
sock
->
¡©e
 !ğ
SS_UNCONNECTED
) {

596 
	`DPRINTF
((
Ãt_debug
, "NET: sock_accept: socket isn't unconnected\n"));

597 (-
EINVAL
);

599 ià(!(
sock
->
æags
 & 
SO_ACCEPTCON
)) {

600 
	`DPRINTF
((
Ãt_debug
,

602 (-
EINVAL
);

605 ià(!(
Ãwsock
 = 
	`sock_®loc
(0))) {

606 
	`´štk
("NET: sock_accept:‚o more sockets\n");

607 (-
EAGAIN
);

609 
Ãwsock
->
ty³
 = 
sock
->type;

610 
Ãwsock
->
İs
 = 
sock
->ops;

611 ià((
i
 = 
sock
->
İs
->
	`dup
(
Ãwsock
, sock)) < 0) {

612 
	`sock_»Ëa£
(
Ãwsock
);

613 (
i
);

616 
i
 = 
Ãwsock
->
İs
->
	`acû±
(
sock
,‚ewsock, 
fe
->
f_æags
);

617 iàĞ
i
 < 0) {

618 
	`sock_»Ëa£
(
Ãwsock
);

619 (
i
);

622 ià((
fd
 = 
	`g‘_fd
(
	`SOCK_INODE
(
Ãwsock
))) < 0) {

623 
	`sock_»Ëa£
(
Ãwsock
);

624 (-
EINVAL
);

627 
	`DPRINTF
((
Ãt_debug
, "NET: sock_accept: connected socket 0x%x via 0x%x\n",

628 
sock
, 
Ãwsock
));

630 ià(
u³”_sockaddr
)

631 
Ãwsock
->
İs
->
	`g‘Çme
Òewsock, 
u³”_sockaddr
, 
u³”_add¾’
, 1);

633 (
fd
);

634 
	}
}

639 
	$sock_cÚÃù
(
fd
, 
sockaddr
 *
u£rvaddr
, 
add¾’
)

641 
sock‘
 *
sock
;

642 
fe
 *file;

643 
i
;

645 
	`DPRINTF
((
Ãt_debug
, "NET: sock_cÚÃù: fd = %d\n", 
fd
));

646 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || (
fe
=
cu¼’t
->
fp
[fd]è=ğ
NULL
)

647 (-
EBADF
);

649 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, &
fe
))è(-
ENOTSOCK
);

650 
sock
->
¡©e
) {

651 
SS_UNCONNECTED
:

654 
SS_CONNECTED
:

656  -
EISCONN
;

657 
SS_CONNECTING
:

659 (
sock
->
İs
->
	`cÚÃù
(sock, 
u£rvaddr
,

660 
add¾’
, 
fe
->
f_æags
));

662 
	`DPRINTF
((
Ãt_debug
,

664 (-
EINVAL
);

666 
i
 = 
sock
->
İs
->
	`cÚÃù
(sock, 
u£rvaddr
, 
add¾’
, 
fe
->
f_æags
);

667 ià(
i
 < 0) {

668 
	`DPRINTF
((
Ãt_debug
, "NET: sock_connect: connect failed\n"));

669 (
i
);

672 
	}
}

676 
	$sock_g‘sockÇme
(
fd
, 
sockaddr
 *
usockaddr
, *
usockaddr_Ën
)

678 
sock‘
 *
sock
;

680 
	`DPRINTF
((
Ãt_debug
, "NET: sock_g‘sockÇme: fd = %d\n", 
fd
));

681 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || 
cu¼’t
->
fp
[fd] =ğ
NULL
)

682 (-
EBADF
);

683 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

684 (
sock
->
İs
->
	`g‘Çme
(sock, 
usockaddr
, 
usockaddr_Ën
, 0));

685 
	}
}

689 
	$sock_g‘³”Çme
(
fd
, 
sockaddr
 *
usockaddr
, *
usockaddr_Ën
)

691 
sock‘
 *
sock
;

693 
	`DPRINTF
((
Ãt_debug
, "NET: sock_g‘³”Çme: fd = %d\n", 
fd
));

694 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || 
cu¼’t
->
fp
[fd] =ğ
NULL
)

695 (-
EBADF
);

696 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

697 (
sock
->
İs
->
	`g‘Çme
(sock, 
usockaddr
, 
usockaddr_Ën
, 1));

698 
	}
}

702 
	$sock_£nd
(
fd
, * 
buff
, 
Ën
, 
æags
)

704 
sock‘
 *
sock
;

705 
fe
 *file;

707 
	`DPRINTF
((
Ãt_debug
,

709 
fd
, 
buff
, 
Ën
, 
æags
));

711 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

712 (-
EBADF
);

713 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

715 (
sock
->
İs
->
	`£nd
(sock, 
buff
, 
Ën
, (
fe
->
f_æags
 & 
O_NONBLOCK
), 
æags
));

716 
	}
}

720 
	$sock_£ndto
(
fd
, * 
buff
, 
Ën
, 
æags
,

721 
sockaddr
 *
addr
, 
addr_Ën
)

723 
sock‘
 *
sock
;

724 
fe
 *file;

726 
	`DPRINTF
((
Ãt_debug
,

728 "‡ddr=%X,‡ËÀğ%d\n", 
fd
, 
buff
, 
Ën
, 
æags
, 
addr
, 
addr_Ën
));

730 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

731 (-
EBADF
);

732 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

734 (
sock
->
İs
->
	`£ndto
(sock, 
buff
, 
Ën
, (
fe
->
f_æags
 & 
O_NONBLOCK
),

735 
æags
, 
addr
, 
addr_Ën
));

736 
	}
}

740 
	$sock_»cv
(
fd
, * 
buff
, 
Ën
, 
æags
)

742 
sock‘
 *
sock
;

743 
fe
 *file;

745 
	`DPRINTF
((
Ãt_debug
,

747 
fd
, 
buff
, 
Ën
, 
æags
));

749 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

750 (-
EBADF
);

751 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

753 (
sock
->
İs
->
	`»cv
(sock, 
buff
, 
Ën
,(
fe
->
f_æags
 & 
O_NONBLOCK
), 
æags
));

754 
	}
}

758 
	$sock_»cväom
(
fd
, * 
buff
, 
Ën
, 
æags
,

759 
sockaddr
 *
addr
, *
addr_Ën
)

761 
sock‘
 *
sock
;

762 
fe
 *file;

764 
	`DPRINTF
((
Ãt_debug
,

766 "‡ddr=%X,‡Ën=%X\n", 
fd
, 
buff
, 
Ën
, 
æags
, 
addr
, 
addr_Ën
));

768 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

769 (-
EBADF
);

770 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

772 (
sock
->
İs
->
	`»cväom
(sock, 
buff
, 
Ën
, (
fe
->
f_æags
 & 
O_NONBLOCK
),

773 
æags
, 
addr
, 
addr_Ën
));

774 
	}
}

778 
	$sock_£tsockİt
(
fd
, 
Ëv–
, 
İŠame
, *
İtv®
, 
İ’
)

780 
sock‘
 *
sock
;

781 
fe
 *file;

783 
	`DPRINTF
((
Ãt_debug
, "NET: sock_setsockopt(fd=%d,†evel=%d, optname=%d,\n",

784 
fd
, 
Ëv–
, 
İŠame
));

785 
	`DPRINTF
((
Ãt_debug
, " optval = %X, optlen = %d)\n",

786 
İtv®
, 
İ’
));

788 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

789 (-
EBADF
);

790 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

792 (
sock
->
İs
->
	`£tsockİt
(sock, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
));

793 
	}
}

797 
	$sock_g‘sockİt
(
fd
, 
Ëv–
, 
İŠame
, *
İtv®
, *
İ’
)

799 
sock‘
 *
sock
;

800 
fe
 *file;

802 
	`DPRINTF
((
Ãt_debug
, "NET: sock_getsockopt(fd=%d,†evel=%d, optname=%d,\n",

803 
fd
, 
Ëv–
, 
İŠame
));

804 
	`DPRINTF
((
Ãt_debug
, " optval = %X, optlen = %X)\n",

805 
İtv®
, 
İ’
));

807 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

808 (-
EBADF
);

809 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

811 ià(!
sock
->
İs
 || !sock->İs->
g‘sockİt
) (0);

812 (
sock
->
İs
->
	`g‘sockİt
(sock, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
));

813 
	}
}

817 
	$sock_shutdown
(
fd
, 
how
)

819 
sock‘
 *
sock
;

820 
fe
 *file;

822 
	`DPRINTF
((
Ãt_debug
, "NET: sock_shutdown(fd = %d, how = %d)\n", 
fd
, 
how
));

824 ià(
fd
 < 0 || fd >ğ
NR_OPEN
 || ((
fe
 = 
cu¼’t
->
fp
[fd]è=ğ
NULL
))

825 (-
EBADF
);

827 ià(!(
sock
 = 
	`sockfd_lookup
(
fd
, 
NULL
))è(-
ENOTSOCK
);

829 (
sock
->
İs
->
	`shutdown
(sock, 
how
));

830 
	}
}

834 
	$sock_fú
(
fe
 *
fp
, 
cmd
, 
¬g
)

836 
sock‘
 *
sock
;

838 
sock
 = 
	`socki_lookup
 (
fp
->
f_šode
);

839 ià(
sock
 !ğ
NULL
 && sock->
İs
 !ğNULL && sock->İs->
fú
 != NULL)

840 (
sock
->
İs
->
	`fú
(sock, 
cmd
, 
¬g
));

841 (-
EINVAL
);

842 
	}
}

850 
asmlškage
 

851 
	$sys_sock‘ÿÎ
(
ÿÎ
, *
¬gs
)

853 
”
;

854 
ÿÎ
) {

855 
SYS_SOCKET
:

856 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

857 if(
”
)

858  
”
;

859 (
	`sock_sock‘
(
	`g‘_fs_lÚg
(
¬gs
+0),

860 
	`g‘_fs_lÚg
(
¬gs
+1),

861 
	`g‘_fs_lÚg
(
¬gs
+2)));

862 
SYS_BIND
:

863 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

864 if(
”
)

865  
”
;

866 (
	`sock_bšd
(
	`g‘_fs_lÚg
(
¬gs
+0),

867 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+1),

868 
	`g‘_fs_lÚg
(
¬gs
+2)));

869 
SYS_CONNECT
:

870 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

871 if(
”
)

872  
”
;

873 (
	`sock_cÚÃù
(
	`g‘_fs_lÚg
(
¬gs
+0),

874 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+1),

875 
	`g‘_fs_lÚg
(
¬gs
+2)));

876 
SYS_LISTEN
:

877 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 2 * ());

878 if(
”
)

879  
”
;

880 (
	`sock_li¡’
(
	`g‘_fs_lÚg
(
¬gs
+0),

881 
	`g‘_fs_lÚg
(
¬gs
+1)));

882 
SYS_ACCEPT
:

883 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

884 if(
”
)

885  
”
;

886 (
	`sock_acû±
(
	`g‘_fs_lÚg
(
¬gs
+0),

887 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+1),

888 (*)
	`g‘_fs_lÚg
(
¬gs
+2)));

889 
SYS_GETSOCKNAME
:

890 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

891 if(
”
)

892  
”
;

893 (
	`sock_g‘sockÇme
(
	`g‘_fs_lÚg
(
¬gs
+0),

894 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+1),

895 (*)
	`g‘_fs_lÚg
(
¬gs
+2)));

896 
SYS_GETPEERNAME
:

897 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 3 * ());

898 if(
”
)

899  
”
;

900 (
	`sock_g‘³”Çme
(
	`g‘_fs_lÚg
(
¬gs
+0),

901 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+1),

902 (*)
	`g‘_fs_lÚg
(
¬gs
+2)));

903 
SYS_SOCKETPAIR
:

904 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 4 * ());

905 if(
”
)

906  
”
;

907 (
	`sock_sock‘·œ
(
	`g‘_fs_lÚg
(
¬gs
+0),

908 
	`g‘_fs_lÚg
(
¬gs
+1),

909 
	`g‘_fs_lÚg
(
¬gs
+2),

910 (*)
	`g‘_fs_lÚg
(
¬gs
+3)));

911 
SYS_SEND
:

912 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 4 * ());

913 if(
”
)

914  
”
;

915 (
	`sock_£nd
(
	`g‘_fs_lÚg
(
¬gs
+0),

916 (*)
	`g‘_fs_lÚg
(
¬gs
+1),

917 
	`g‘_fs_lÚg
(
¬gs
+2),

918 
	`g‘_fs_lÚg
(
¬gs
+3)));

919 
SYS_SENDTO
:

920 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 6 * ());

921 if(
”
)

922  
”
;

923 (
	`sock_£ndto
(
	`g‘_fs_lÚg
(
¬gs
+0),

924 (*)
	`g‘_fs_lÚg
(
¬gs
+1),

925 
	`g‘_fs_lÚg
(
¬gs
+2),

926 
	`g‘_fs_lÚg
(
¬gs
+3),

927 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+4),

928 
	`g‘_fs_lÚg
(
¬gs
+5)));

929 
SYS_RECV
:

930 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 4 * ());

931 if(
”
)

932  
”
;

933 (
	`sock_»cv
(
	`g‘_fs_lÚg
(
¬gs
+0),

934 (*)
	`g‘_fs_lÚg
(
¬gs
+1),

935 
	`g‘_fs_lÚg
(
¬gs
+2),

936 
	`g‘_fs_lÚg
(
¬gs
+3)));

937 
SYS_RECVFROM
:

938 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 6 * ());

939 if(
”
)

940  
”
;

941 (
	`sock_»cväom
(
	`g‘_fs_lÚg
(
¬gs
+0),

942 (*)
	`g‘_fs_lÚg
(
¬gs
+1),

943 
	`g‘_fs_lÚg
(
¬gs
+2),

944 
	`g‘_fs_lÚg
(
¬gs
+3),

945 (
sockaddr
 *)
	`g‘_fs_lÚg
(
¬gs
+4),

946 (*)
	`g‘_fs_lÚg
(
¬gs
+5)));

947 
SYS_SHUTDOWN
:

948 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 2* ());

949 if(
”
)

950  
”
;

951 (
	`sock_shutdown
(
	`g‘_fs_lÚg
(
¬gs
+0),

952 
	`g‘_fs_lÚg
(
¬gs
+1)));

953 
SYS_SETSOCKOPT
:

954 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 5*());

955 if(
”
)

956  
”
;

957 (
	`sock_£tsockİt
(
	`g‘_fs_lÚg
(
¬gs
+0),

958 
	`g‘_fs_lÚg
(
¬gs
+1),

959 
	`g‘_fs_lÚg
(
¬gs
+2),

960 (*)
	`g‘_fs_lÚg
(
¬gs
+3),

961 
	`g‘_fs_lÚg
(
¬gs
+4)));

962 
SYS_GETSOCKOPT
:

963 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
¬gs
, 5*());

964 if(
”
)

965  
”
;

966 (
	`sock_g‘sockİt
(
	`g‘_fs_lÚg
(
¬gs
+0),

967 
	`g‘_fs_lÚg
(
¬gs
+1),

968 
	`g‘_fs_lÚg
(
¬gs
+2),

969 (*)
	`g‘_fs_lÚg
(
¬gs
+3),

970 (*)
	`g‘_fs_lÚg
(
¬gs
+4)));

972 (-
EINVAL
);

974 
	}
}

978 
	$Ãt_ioùl
(
cmd
, 
¬g
)

980 
”
;

981 
cmd
) {

982 
DDIOCSDBG
:

983 
”
=
	`v”ify_¬—
(
VERIFY_READ
, (*)
¬g
, ());

984 if(
”
)

985  
”
;

986 
Ãt_debug
 = 
	`g‘_fs_lÚg
((*)
¬g
);

987 ià(
Ãt_debug
 != 0 &&‚et_debug != 1) {

988 
Ãt_debug
 = 0;

989 (-
EINVAL
);

993 (-
EINVAL
);

997 
	}
}

1008 
	$Ãt_fioùl
(
šode
 *šode, 
fe
 *file,

1009 
cmd
, 
¬g
)

1011 
	`¬p_ioùl
(, *);

1014 
	`MINOR
(
šode
->
i_rdev
)) {

1016 
	`DPRINTF
((
Ãt_debug
, "NET: SOCKET†evel I/O control„equest.\n"));

1017 (
	`Ãt_ioùl
(
cmd
, 
¬g
));

1018 #ifdeà
CONFIG_INET


1020 
	`DPRINTF
((
Ãt_debug
, "NET: ARP†evel I/O control„equest.\n"));

1021 (
	`¬p_ioùl
(
cmd
, (*è
¬g
));

1024 (-
ENODEV
);

1027 (-
EINVAL
);

1028 
	}
}

1031 
fe_İ”©iÚs
 
	gÃt_fİs
 = {

1032 
NULL
,

1033 
NULL
,

1034 
NULL
,

1035 
NULL
,

1036 
NULL
,

1037 
Ãt_fioùl
,

1038 
NULL
,

1039 
NULL
,

1040 
NULL


1050 
	$sock_»gi¡”
(
çmy
, 
´Ùo_İs
 *
İs
)

1052 
i
;

1054 
	`şi
();

1055 
i
 = 0; i < 
NPROTO
; i++) {

1056 ià(
pİs
[
i
] !ğ
NULL
) ;

1057 
pİs
[
i
] = 
İs
;

1058 
pİs
[
i
]->
çmy
 = family;

1059 
	`¡i
();

1060 
	`DPRINTF
((
Ãt_debug
, "NET: Installed…rotocol %d in slot %d (0x%X)\n",

1061 
çmy
, 
i
, ()
İs
));

1062 (
i
);

1064 
	`¡i
();

1065 (-
ENOMEM
);

1066 
	}
}

1070 
	$sock_š™
()

1072 
sock‘
 *
sock
;

1073 
i
;

1076 ià(
	`»gi¡”_chrdev
(
SOCKET_MAJOR
, "sock‘", &
Ãt_fİs
) < 0) {

1077 
	`´štk
("NET: cªnÙ„egi¡” majÜ deviû %d!\n", 
SOCKET_MAJOR
);

1082 
sock
 = 
sock‘s
; sock <ğ
Ï¡_sock‘
; ++sockèsock->
¡©e
 = 
SS_FREE
;

1085 
i
 = 0; i < 
NPROTO
; ++iè
pİs
[i] = 
NULL
;

1088 
	`ddi_š™
();

1092 
	`¬p_š™
();

1094 
	}
}

	@net/unix/proc.c

26 
	~<lšux/autocÚf.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/sock‘.h
>

30 
	~<lšux/Ãt.h
>

31 
	~<lšux/ddi.h
>

32 
	~<lšux/un.h
>

33 
	~<lšux/·¿m.h
>

34 
	~"unix.h
"

38 
	$unix_g‘_šfo
(*
bufãr
)

40 *
pos
;

41 
i
;

43 
pos
 = 
bufãr
;

44 
pos
 +ğ
	`¥rštf
(pos, "Num RefCount Protocol Flags Type St Path\n");

46 
i
 = 0; i < 
NSOCKETS
; i++) {

47 ià(
unix_d©as
[
i
].
»fút
>0) {

48 
pos
 +ğ
	`¥rštf
Õos, "%2d: %08X %08X %08lX %04X %02X", 
i
,

49 
unix_d©as
[
i
].
»fút
,

50 
unix_d©as
[
i
].
´ÙocŞ
,

51 
unix_d©as
[
i
].
sock‘
->
æags
,

52 
unix_d©as
[
i
].
sock‘
->
ty³
,

53 
unix_d©as
[
i
].
sock‘
->
¡©e


57 if(
unix_d©as
[
i
].
sockaddr_Ën
>0) {

58 
pos
 +ğ
	`¥rštf
(pos, " %s\n",

59 
unix_d©as
[
i
].
sockaddr_un
.
sun_·th
);

61 *
pos
='\n';

62 
pos
++;

63 *
pos
='\0';

71 ià(
pos
 > 
bufãr
+
PAGE_SIZE
-80-
PATH_MAX
) {

72 
	`´štk
("UNIX:‚etinfo: oops,oo many sockets.\n");

73 (
pos
 - 
bufãr
);

77 (
pos
 - 
bufãr
);

78 
	}
}

	@net/unix/sock.c

30 
	~<lšux/cÚfig.h
>

31 
	~<lšux/k”Ãl.h
>

32 
	~<lšux/majÜ.h
>

33 
	~<lšux/sigÇl.h
>

34 
	~<lšux/sched.h
>

35 
	~<lšux/”ºo.h
>

36 
	~<lšux/¡ršg.h
>

37 
	~<lšux/¡©.h
>

38 
	~<lšux/sock‘.h
>

39 
	~<lšux/un.h
>

40 
	~<lšux/fú.h
>

41 
	~<lšux/‹rmios.h
>

42 
	~<lšux/sockios.h
>

43 
	~<lšux/Ãt.h
>

44 
	~<lšux/fs.h
>

45 
	~<lšux/ddi.h
>

46 
	~<lšux/m®loc.h
>

48 
	~<asm/sy¡em.h
>

49 
	~<asm/£gm’t.h
>

51 
	~<¡d¬g.h
>

53 
	~"unix.h
"

55 
unix_´Ùo_d©a
 
	gunix_d©as
[
NSOCKETS
];

56 
	gunix_debug
 = 0;

59 
unix_´Ùo_ü—‹
(
sock‘
 *
sock
, 
´ÙocŞ
);

60 
unix_´Ùo_dup
(
sock‘
 *
Ãwsock
, sock‘ *
Şdsock
);

61 
unix_´Ùo_»Ëa£
(
sock‘
 *
sock
, sock‘ *
³”
);

62 
unix_´Ùo_bšd
(
sock‘
 *
sock
, 
sockaddr
 *
umyaddr
,

63 
sockaddr_Ën
);

64 
unix_´Ùo_cÚÃù
(
sock‘
 *
sock
, 
sockaddr
 *
u£rvaddr
,

65 
sockaddr_Ën
, 
æags
);

66 
unix_´Ùo_sock‘·œ
(
sock‘
 *
sock1
, sock‘ *
sock2
);

67 
unix_´Ùo_acû±
(
sock‘
 *
sock
, sock‘ *
Ãwsock
,

68 
æags
);

69 
unix_´Ùo_g‘Çme
(
sock‘
 *
sock
, 
sockaddr
 *
usockaddr
,

70 *
usockaddr_Ën
, 
³”
);

71 
unix_´Ùo_»ad
(
sock‘
 *
sock
, *
ubuf
, 
size
,

72 
nÚblock
);

73 
unix_´Ùo_wr™e
(
sock‘
 *
sock
, *
ubuf
, 
size
,

74 
nÚblock
);

75 
unix_´Ùo_£Ëù
(
sock‘
 *
sock
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
);

76 
unix_´Ùo_ioùl
(
sock‘
 *
sock
, 
cmd
,

77 
¬g
);

78 
unix_´Ùo_li¡’
(
sock‘
 *
sock
, 
backlog
);

79 
unix_´Ùo_£nd
(
sock‘
 *
sock
, *
buff
, 
Ën
,

80 
nÚblock
, 
æags
);

81 
unix_´Ùo_»cv
(
sock‘
 *
sock
, *
buff
, 
Ën
,

82 
nÚblock
, 
æags
);

83 
unix_´Ùo_£ndto
(
sock‘
 *
sock
, *
buff
, 
Ën
,

84 
nÚblock
, 
æags
,

85 
sockaddr
 *
addr
, 
addr_Ën
);

86 
unix_´Ùo_»cväom
(
sock‘
 *
sock
, *
buff
, 
Ën
,

87 
nÚblock
, 
æags
,

88 
sockaddr
 *
addr
, *
addr_Ën
);

90 
unix_´Ùo_shutdown
(
sock‘
 *
sock
, 
how
);

92 
unix_´Ùo_£tsockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

93 *
İtv®
, 
İ’
);

94 
unix_´Ùo_g‘sockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

95 *
İtv®
, *
İ’
);

99 
	$d´štf
(
Ëv–
, *
fmt
, ...)

101 
va_li¡
 
¬gs
;

102 *
buff
;

103 
	`v¥rštf
(* 
buf
, cÚ¡ * 
fmt
, 
va_li¡
 
¬gs
);

105 ià(
Ëv–
 !ğ
unix_debug
) ;

107 
buff
 = (*è
	`km®loc
(256, 
GFP_KERNEL
);

108 ià(
buff
 !ğ
NULL
) {

109 
	`va_¡¬t
(
¬gs
, 
fmt
);

110 
	`v¥rštf
(
buff
, 
fmt
, 
¬gs
);

111 
	`va_’d
(
¬gs
);

112 
	`´štk
(
buff
);

113 
	`kä“
(
buff
);

115 
	}
}

118 
šlše
 

119 
	$mš
(
a
, 
b
)

121 ià(
a
 < 
b
) (a);

122 (
b
);

123 
	}
}

127 
	$sockaddr_un_´štk
(
sockaddr_un
 *
sockun
, 
sockaddr_Ën
)

129 
buf
[(
sockun
->
sun_·th
) + 1];

131 ià(
unix_debug
 == 0) ;

133 
sockaddr_Ën
 -ğ
UN_PATH_OFFSET
;

134 ià(
sockun
->
sun_çmy
 !ğ
AF_UNIX
)

135 
	`´štk
("UNIX: Badd‡dd¸çmy %d>\n", 
sockun
->
sun_çmy
);

136 ià(
sockaddr_Ën
 <ğ0 || sockaddr_ËÀ>ğ(
buf
))

137 
	`´štk
("UNIX: Bad‡dd¸ËÀ%d>\n", 
sockaddr_Ën
);

139 
	`memıy
(
buf
, 
sockun
->
sun_·th
, 
sockaddr_Ën
);

140 
buf
[
sockaddr_Ën
] = '\0';

141 
	`´štk
("\"%s\"[%lu]\n", 
buf
, 
sockaddr_Ën
 + 
UN_PATH_OFFSET
);

143 
	}
}

155 
	$unix_lock
(
unix_´Ùo_d©a
 *
upd
)

157 
upd
->
lock_æag
)

158 
	`¦“p_Ú
(&
upd
->
wa™
);

159 
upd
->
lock_æag
 = 1;

160 
	}
}

163 
	$unix_uÆock
(
unix_´Ùo_d©a
 *
upd
)

165 
upd
->
lock_æag
 = 0;

166 
	`wake_up
(&
upd
->
wa™
);

167 
	}
}

171 
	$unix_´Ùo_li¡’
(
sock‘
 *
sock
, 
backlog
)

174 
	}
}

178 
	$unix_´Ùo_£tsockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

179 *
İtv®
, 
İ’
)

181 (-
EOPNOTSUPP
);

182 
	}
}

186 
	$unix_´Ùo_g‘sockİt
(
sock‘
 *
sock
, 
Ëv–
, 
İŠame
,

187 *
İtv®
, *
İ’
)

189 (-
EOPNOTSUPP
);

190 
	}
}

193 
	$unix_´Ùo_£ndto
(
sock‘
 *
sock
, *
buff
, 
Ën
, 
nÚblock
,

194 
æags
, 
sockaddr
 *
addr
, 
addr_Ën
)

196 (-
EOPNOTSUPP
);

197 
	}
}

200 
	$unix_´Ùo_»cväom
(
sock‘
 *
sock
, *
buff
, 
Ën
, 
nÚblock
,

201 
æags
, 
sockaddr
 *
addr
, *
addr_Ën
)

203 (-
EOPNOTSUPP
);

204 
	}
}

208 
	$unix_´Ùo_shutdown
(
sock‘
 *
sock
, 
how
)

210 (-
EOPNOTSUPP
);

211 
	}
}

216 
	$unix_´Ùo_£nd
(
sock‘
 *
sock
, *
buff
, 
Ën
, 
nÚblock
,

217 
æags
)

219 ià(
æags
 !ğ0è(-
EINVAL
);

220 (
	`unix_´Ùo_wr™e
(
sock
, (*è
buff
, 
Ën
, 
nÚblock
));

221 
	}
}

226 
	$unix_´Ùo_»cv
(
sock‘
 *
sock
, *
buff
, 
Ën
, 
nÚblock
,

227 
æags
)

229 ià(
æags
 !ğ0è(-
EINVAL
);

230 (
	`unix_´Ùo_»ad
(
sock
, (*è
buff
, 
Ën
, 
nÚblock
));

231 
	}
}

234 
unix_´Ùo_d©a
 *

235 
	$unix_d©a_lookup
(
sockaddr_un
 *
sockun
, 
sockaddr_Ën
,

236 
šode
 *inode)

238 
unix_´Ùo_d©a
 *
upd
;

240 
upd
 = 
unix_d©as
; upd <ğ
Ï¡_unix_d©a
; ++upd) {

241 ià(
upd
->
»fút
 > 0 && upd->
sock‘
 &&

242 
upd
->
sock‘
->
¡©e
 =ğ
SS_UNCONNECTED
 &&

243 
upd
->
sockaddr_un
.
sun_çmy
 =ğ
sockun
->sun_family &&

244 
upd
->
šode
 == inode) (upd);

246 (
NULL
);

247 
	}
}

250 
unix_´Ùo_d©a
 *

251 
	$unix_d©a_®loc
()

253 
unix_´Ùo_d©a
 *
upd
;

255 
	`şi
();

256 
upd
 = 
unix_d©as
; upd <ğ
Ï¡_unix_d©a
; ++upd) {

257 ià(!
upd
->
»fút
) {

258 
upd
->
»fút
 = -1;

259 
	`¡i
();

260 
upd
->
sock‘
 = 
NULL
;

261 
upd
->
sockaddr_Ën
 = 0;

262 
upd
->
sockaddr_un
.
sun_çmy
 = 0;

263 
upd
->
buf
 = 
NULL
;

264 
upd
->
bp_h—d
 = upd->
bp_
 = 0;

265 
upd
->
šode
 = 
NULL
;

266 
upd
->
³”upd
 = 
NULL
;

267 (
upd
);

270 
	`¡i
();

271 (
NULL
);

272 
	}
}

275 
šlše
 

276 
	$unix_d©a_»f
(
unix_´Ùo_d©a
 *
upd
)

278 ià(!
upd
) {

279 
	`d´štf
(1, "UNIX: data_ref: upd = NULL\n");

282 ++
upd
->
»fút
;

283 
	`d´štf
(1, "UNIX: d©a_»f:„efšg d©¨0x%x(%d)\n", 
upd
, upd->
»fút
);

284 
	}
}

288 
	$unix_d©a_d”ef
(
unix_´Ùo_d©a
 *
upd
)

290 ià(!
upd
) {

291 
	`d´štf
(1, "UNIX: data_deref: upd = NULL\n");

294 ià(
upd
->
»fút
 == 1) {

295 
	`d´štf
(1, "UNIX: d©a_d”ef:„–—sšg d©¨0x%x\n", 
upd
);

296 ià(
upd
->
buf
) {

297 
	`ä“_·ge
(()
upd
->
buf
);

298 
upd
->
buf
 = 
NULL
;

299 
upd
->
bp_h—d
 = upd->
bp_
 = 0;

302 --
upd
->
»fút
;

303 
	}
}

311 
	$unix_´Ùo_ü—‹
(
sock‘
 *
sock
, 
´ÙocŞ
)

313 
unix_´Ùo_d©a
 *
upd
;

315 
	`d´štf
(1, "UNIX: c»©e: sock‘ 0x%x,…rÙØ%d\n", 
sock
, 
´ÙocŞ
);

316 ià(
´ÙocŞ
 != 0) {

317 
	`d´štf
(1, "UNIX: create:…rotocol != 0\n");

318 (-
EINVAL
);

320 ià(!(
upd
 = 
	`unix_d©a_®loc
())) {

321 
	`´štk
("UNIX: create: can't‡llocate buffer\n");

322 (-
ENOMEM
);

324 ià(!(
upd
->
buf
 = (*è
	`g‘_ä“_·ge
(
GFP_USER
))) {

325 
	`´štk
("UNIX: create: can't get…age!\n");

326 
	`unix_d©a_d”ef
(
upd
);

327 (-
ENOMEM
);

329 
upd
->
´ÙocŞ
 =…rotocol;

330 
upd
->
sock‘
 = 
sock
;

331 
	`UN_DATA
(
sock
èğ
upd
;

332 
upd
->
»fút
 = 1;

333 
	`d´štf
(1, "UNIX: c»©e:‡Îoÿ‹d d©¨0x%x\n", 
upd
);

335 
	}
}

339 
	$unix_´Ùo_dup
(
sock‘
 *
Ãwsock
, sock‘ *
Şdsock
)

341 
unix_´Ùo_d©a
 *
upd
 = 
	`UN_DATA
(
Şdsock
);

343 (
	`unix_´Ùo_ü—‹
(
Ãwsock
, 
upd
->
´ÙocŞ
));

344 
	}
}

348 
	$unix_´Ùo_»Ëa£
(
sock‘
 *
sock
, sock‘ *
³”
)

350 
unix_´Ùo_d©a
 *
upd
 = 
	`UN_DATA
(
sock
);

352 
	`d´štf
(1, "UNIX:„–—£: sock‘ 0x%x, unix_d©¨0x%x\n", 
sock
, 
upd
);

353 ià(!
upd
) (0);

354 ià(
upd
->
sock‘
 !ğ
sock
) {

355 
	`´štk
("UNIX:„elease: socket†ink mismatch!\n");

356 (-
EINVAL
);

358 ià(
upd
->
šode
) {

359 
	`d´štf
(1, "UNIX:„–—£:„–—sšg inod0x%x\n", 
upd
->
šode
);

360 
	`ut
(
upd
->
šode
);

361 
upd
->
šode
 = 
NULL
;

363 
	`UN_DATA
(
sock
èğ
NULL
;

364 
upd
->
sock‘
 = 
NULL
;

365 ià(
upd
->
³”upd
è
	`unix_d©a_d”ef
(upd->peerupd);

366 
	`unix_d©a_d”ef
(
upd
);

368 
	}
}

381 
	$unix_´Ùo_bšd
(
sock‘
 *
sock
, 
sockaddr
 *
umyaddr
,

382 
sockaddr_Ën
)

384 
âame
[(((
sockaddr_un
 *)0)->
sun_·th
) + 1];

385 
unix_´Ùo_d©a
 *
upd
 = 
	`UN_DATA
(
sock
);

386 
Şd_fs
;

387 
i
;

388 
”
;

390 
	`d´štf
(1, "UNIX: bšd: sock‘ 0x%x,†’=%d\n", 
sock
, 
sockaddr_Ën
);

391 ià(
sockaddr_Ën
 <ğ
UN_PATH_OFFSET
 ||

392 
sockaddr_Ën
 > (
sockaddr_un
)) {

393 
	`d´štf
(1, "UNIX: bšd: bad†’gth %d\n", 
sockaddr_Ën
);

394 (-
EINVAL
);

396 ià(
upd
->
sockaddr_Ën
 || upd->
šode
) {

397 
	`´štk
("UNIX: bind:‡lready bound!\n");

398 (-
EINVAL
);

400 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
umyaddr
, 
sockaddr_Ën
);

401 if(
”
)

402  
”
;

403 
	`memıy_äomfs
(&
upd
->
sockaddr_un
, 
umyaddr
, 
sockaddr_Ën
);

404 
upd
->
sockaddr_un
.
sun_·th
[
sockaddr_Ën
-
UN_PATH_OFFSET
] = '\0';

405 ià(
upd
->
sockaddr_un
.
sun_çmy
 !ğ
AF_UNIX
) {

406 
	`d´štf
(1, "UNIX: bind: family is %d,‚ot AF_UNIX(%d)\n",

407 
upd
->
sockaddr_un
.
sun_çmy
, 
AF_UNIX
);

408 (-
EINVAL
);

411 
	`memıy
(
âame
, 
upd
->
sockaddr_un
.
sun_·th
, 
sockaddr_Ën
-
UN_PATH_OFFSET
);

412 
âame
[
sockaddr_Ën
-
UN_PATH_OFFSET
] = '\0';

413 
Şd_fs
 = 
	`g‘_fs
();

414 
	`£t_fs
(
	`g‘_ds
());

415 
i
 = 
	`do_mknod
(
âame
, 
S_IFSOCK
 | 
S_IRWXUGO
, 0);

416 ià(
i
 =ğ0è˜ğ
	`İ’_Çmei
(
âame
, 0, 
S_IFSOCK
, &
upd
->
šode
, 
NULL
);

417 
	`£t_fs
(
Şd_fs
);

418 ià(
i
 < 0) {

419 
	`´štk
("UNIX: bšd: cª'ˆİ’ sock‘ %s\n", 
âame
);

420 (
i
);

422 
upd
->
sockaddr_Ën
 = sockaddr_len;

424 
	`d´štf
(1, "UNIX: bind: bound socket‡ddress: ");

425 
	`sockaddr_un_´štk
(&
upd
->
sockaddr_un
, upd->
sockaddr_Ën
);

426 
	`d´štf
(1, "tØšod0x%x\n", 
upd
->
šode
);

428 
	}
}

437 
	$unix_´Ùo_cÚÃù
(
sock‘
 *
sock
, 
sockaddr
 *
u£rvaddr
,

438 
sockaddr_Ën
, 
æags
)

440 
âame
[(((
sockaddr_un
 *)0)->
sun_·th
) + 1];

441 
sockaddr_un
 
sockun
;

442 
unix_´Ùo_d©a
 *
£rv_upd
;

443 
šode
 *inode;

444 
Şd_fs
;

445 
i
;

446 
”
;

448 
	`d´štf
(1, "UNIX: cÚÃù: sock‘ 0x%x, s”vËn=%d\n", 
sock
, 
sockaddr_Ën
);

450 ià(
sockaddr_Ën
 <ğ
UN_PATH_OFFSET
 ||

451 
sockaddr_Ën
 > (
sockaddr_un
)) {

452 
	`d´štf
(1, "UNIX: cÚÃù: bad†’gth %d\n", 
sockaddr_Ën
);

453 (-
EINVAL
);

455 ià(
sock
->
¡©e
 =ğ
SS_CONNECTING
è(-
EINPROGRESS
);

456 ià(
sock
->
¡©e
 =ğ
SS_CONNECTED
è(-
EISCONN
);

458 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
u£rvaddr
, 
sockaddr_Ën
);

459 if(
”
)

460  
”
;

461 
	`memıy_äomfs
(&
sockun
, 
u£rvaddr
, 
sockaddr_Ën
);

462 
sockun
.
sun_·th
[
sockaddr_Ën
-
UN_PATH_OFFSET
] = '\0';

463 ià(
sockun
.
sun_çmy
 !ğ
AF_UNIX
) {

464 
	`d´štf
(1, "UNIX: connect: family is %d,‚ot AF_UNIX(%d)\n",

465 
sockun
.
sun_çmy
, 
AF_UNIX
);

466 (-
EINVAL
);

475 
	`memıy
(
âame
, 
sockun
.
sun_·th
, 
sockaddr_Ën
-
UN_PATH_OFFSET
);

476 
âame
[
sockaddr_Ën
-
UN_PATH_OFFSET
] = '\0';

477 
Şd_fs
 = 
	`g‘_fs
();

478 
	`£t_fs
(
	`g‘_ds
());

479 
i
 = 
	`İ’_Çmei
(
âame
, 0, 
S_IFSOCK
, &
šode
, 
NULL
);

480 
	`£t_fs
(
Şd_fs
);

481 ià(
i
 < 0) {

482 
	`d´štf
(1, "UNIX: cÚÃù: cª'ˆİ’ sock‘ %s\n", 
âame
);

483 (
i
);

485 
£rv_upd
 = 
	`unix_d©a_lookup
(&
sockun
, 
sockaddr_Ën
, 
šode
);

486 
	`ut
(
šode
);

487 ià(!
£rv_upd
) {

488 
	`d´štf
(1, "UNIX: connect: can't†ocate…eer %s‡t inode 0x%x\n",

489 
âame
, 
šode
);

490 (-
EINVAL
);

492 ià((
i
 = 
	`sock_awa™cÚn
(
sock
, 
£rv_upd
->
sock‘
)) < 0) {

493 
	`d´štf
(1, "UNIX: connect: can't‡wait connection\n");

494 (
i
);

496 ià(
sock
->
cÚn
) {

497 
	`unix_d©a_»f
(
	`UN_DATA
(
sock
->
cÚn
));

498 
	`UN_DATA
(
sock
)->
³”upd
 = UN_DATA(sock->
cÚn
);

501 
	}
}

511 
	$unix_´Ùo_sock‘·œ
(
sock‘
 *
sock1
, sock‘ *
sock2
)

513 
unix_´Ùo_d©a
 *
upd1
 = 
	`UN_DATA
(
sock1
), *
upd2
 = UN_DATA(
sock2
);

515 
	`unix_d©a_»f
(
upd1
);

516 
	`unix_d©a_»f
(
upd2
);

517 
upd1
->
³”upd
 = 
upd2
;

518 
upd2
->
³”upd
 = 
upd1
;

520 
	}
}

525 
	$unix_´Ùo_acû±
(
sock‘
 *
sock
, sock‘ *
Ãwsock
, 
æags
)

527 
sock‘
 *
ş›Ásock
;

529 
	`d´štf
(1, "UNIX:‡ccept: socket 0x%x‡ccepted via socket 0x%x\n",

530 
sock
, 
Ãwsock
);

536 !(
ş›Ásock
 = 
sock
->
icÚn
)) {

537 ià(
æags
 & 
O_NONBLOCK
è(-
EAGAIN
);

538 
	`š‹¼u±ibË_¦“p_Ú
(
sock
->
wa™
);

539 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

540 
	`d´štf
(1, "UNIX:‡ccept: sleep was interrupted\n");

541 (-
ERESTARTSYS
);

549 
sock
->
icÚn
 = 
ş›Ásock
->
Ãxt
;

550 
ş›Ásock
->
Ãxt
 = 
NULL
;

551 
Ãwsock
->
cÚn
 = 
ş›Ásock
;

552 
ş›Ásock
->
cÚn
 = 
Ãwsock
;

553 
ş›Ásock
->
¡©e
 = 
SS_CONNECTED
;

554 
Ãwsock
->
¡©e
 = 
SS_CONNECTED
;

555 
	`unix_d©a_»f
(
	`UN_DATA
(
ş›Ásock
));

556 
	`UN_DATA
(
Ãwsock
)->
³”upd
 = UN_DATA(
ş›Ásock
);

557 
	`UN_DATA
(
Ãwsock
)->
sockaddr_un
 = UN_DATA(
sock
)->sockaddr_un;

558 
	`UN_DATA
(
Ãwsock
)->
sockaddr_Ën
 = UN_DATA(
sock
)->sockaddr_len;

559 
	`wake_up_š‹¼u±ibË
(
ş›Ásock
->
wa™
);

561 
	}
}

566 
	$unix_´Ùo_g‘Çme
(
sock‘
 *
sock
, 
sockaddr
 *
usockaddr
,

567 *
usockaddr_Ën
, 
³”
)

569 
unix_´Ùo_d©a
 *
upd
;

570 
Ën
;

571 
”
;

573 
	`d´štf
(1, "UNIX: g‘Çme: sock‘ 0x%x fÜ %s\n", 
sock
, 
³”
?"peer":"self");

574 ià(
³”
) {

575 ià(
sock
->
¡©e
 !ğ
SS_CONNECTED
) {

576 
	`d´štf
(1, "UNIX: getname: socket‚ot connected\n");

577 (-
EINVAL
);

579 
upd
 = 
	`UN_DATA
(
sock
->
cÚn
);

581 
upd
 = 
	`UN_DATA
(
sock
);

583 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
usockaddr_Ën
, (*usockaddr_len));

584 if(
”
)

585  
”
;

586 ià((
Ën
 = 
	`g‘_fs_lÚg
(
usockaddr_Ën
)è<ğ0è(-
EINVAL
);

587 ià(
Ën
 > 
upd
->
sockaddr_Ën
)†en = upd->sockaddr_len;

588 ià(
Ën
) {

589 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
, 
usockaddr
, 
Ën
);

590 if(
”
)

591  
”
;

592 
	`memıy_tofs
(
usockaddr
, &
upd
->
sockaddr_un
, 
Ën
);

594 
	`put_fs_lÚg
(
Ën
, 
usockaddr_Ën
);

596 
	}
}

601 
	$unix_´Ùo_»ad
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
nÚblock
)

603 
unix_´Ùo_d©a
 *
upd
;

604 
todo
, 
ava
;

605 
”
;

607 ià((
todo
 = 
size
) <= 0) (0);

608 
upd
 = 
	`UN_DATA
(
sock
);

609 !(
ava
 = 
	`UN_BUF_AVAIL
(
upd
))) {

610 ià(
sock
->
¡©e
 !ğ
SS_CONNECTED
) {

611 
	`d´štf
(1, "UNIX:„ead: socket‚ot connected\n");

612 ((
sock
->
¡©e
 =ğ
SS_DISCONNECTING
è? 0 : -
EINVAL
);

614 
	`d´štf
(1, "UNIX:„ead:‚o data‡vailable...\n");

615 ià(
nÚblock
è(-
EAGAIN
);

616 
	`š‹¼u±ibË_¦“p_Ú
(
sock
->
wa™
);

617 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

618 
	`d´štf
(1, "UNIX:„ead: interrupted\n");

619 (-
ERESTARTSYS
);

628 
	`unix_lock
(
upd
);

630 
·¹
, 
ÿndo
;

632 ià(
ava
 <= 0) {

633 
	`´štk
("UNIX:„ead: AVAIL IS NEGATIVE!!!\n");

634 
	`£nd_sig
(
SIGKILL
, 
cu¼’t
, 1);

635 (-
EPIPE
);

638 ià((
ÿndo
 = 
todo
è> 
ava
) cando =‡vail;

639 ià(
ÿndo
 >(
·¹
 = 
BUF_SIZE
 - 
upd
->
bp_
)) cando =…art;

640 
	`d´štf
(1, "UNIX:„ead:‡vail=%d,odo=%d, cando=%d\n",

641 
ava
, 
todo
, 
ÿndo
);

642 if((
”
=
	`v”ify_¬—
(
VERIFY_WRITE
,
ubuf
,
ÿndo
))<0)

644 
	`unix_uÆock
(
upd
);

645  
”
;

647 
	`memıy_tofs
(
ubuf
, 
upd
->
buf
 + upd->
bp_
, 
ÿndo
);

648 
upd
->
bp_
 =(upd->bp_ + 
ÿndo
è&(
BUF_SIZE
-1);

649 
ubuf
 +ğ
ÿndo
;

650 
todo
 -ğ
ÿndo
;

651 ià(
sock
->
¡©e
 =ğ
SS_CONNECTED
)

652 
	`wake_up_š‹¼u±ibË
(
sock
->
cÚn
->
wa™
);

653 
ava
 = 
	`UN_BUF_AVAIL
(
upd
);

654 } 
todo
 && 
ava
);

655 
	`unix_uÆock
(
upd
);

656 (
size
 - 
todo
);

657 
	}
}

666 
	$unix_´Ùo_wr™e
(
sock‘
 *
sock
, *
ubuf
, 
size
, 
nÚblock
)

668 
unix_´Ùo_d©a
 *
pupd
;

669 
todo
, 
¥aû
;

670 
”
;

672 ià((
todo
 = 
size
) <= 0) (0);

673 ià(
sock
->
¡©e
 !ğ
SS_CONNECTED
) {

674 
	`d´štf
(1, "UNIX: write: socket‚ot connected\n");

675 ià(
sock
->
¡©e
 =ğ
SS_DISCONNECTING
) {

676 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

677 (-
EPIPE
);

679 (-
EINVAL
);

681 
pupd
 = 
	`UN_DATA
(
sock
)->
³”upd
;

683 !(
¥aû
 = 
	`UN_BUF_SPACE
(
pupd
))) {

684 
	`d´štf
(1, "UNIX: write:‚o space†eft...\n");

685 ià(
nÚblock
è(-
EAGAIN
);

686 
	`š‹¼u±ibË_¦“p_Ú
(
sock
->
wa™
);

687 ià(
cu¼’t
->
sigÇl
 & ~cu¼’t->
blocked
) {

688 
	`d´štf
(1, "UNIX: write: interrupted\n");

689 (-
ERESTARTSYS
);

691 ià(
sock
->
¡©e
 =ğ
SS_DISCONNECTING
) {

692 
	`d´štf
(1, "UNIX: write: disconnected(SIGPIPE)\n");

693 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

694 (-
EPIPE
);

703 
	`unix_lock
(
pupd
);

706 
·¹
, 
ÿndo
;

708 ià(
¥aû
 <= 0) {

709 
	`´štk
("UNIX: write: SPACE IS NEGATIVE!!!\n");

710 
	`£nd_sig
(
SIGKILL
, 
cu¼’t
, 1);

711 (-
EPIPE
);

718 ià(
sock
->
¡©e
 =ğ
SS_DISCONNECTING
) {

719 
	`£nd_sig
(
SIGPIPE
, 
cu¼’t
, 1);

720 
	`unix_uÆock
(
pupd
);

721 (-
EPIPE
);

723 ià((
ÿndo
 = 
todo
è> 
¥aû
) cando = space;

724 ià(
ÿndo
 >(
·¹
 = 
BUF_SIZE
 - 
pupd
->
bp_h—d
)) cando =…art;

725 
	`d´štf
(1, "UNIX: write: space=%d,odo=%d, cando=%d\n",

726 
¥aû
, 
todo
, 
ÿndo
);

727 
”
=
	`v”ify_¬—
(
VERIFY_READ
, 
ubuf
, 
ÿndo
);

728 if(
”
)

730 
	`unix_uÆock
(
pupd
);

731  
”
;

733 
	`memıy_äomfs
(
pupd
->
buf
 +…upd->
bp_h—d
, 
ubuf
, 
ÿndo
);

734 
pupd
->
bp_h—d
 =Õupd->bp_h—d + 
ÿndo
è&(
BUF_SIZE
-1);

735 
ubuf
 +ğ
ÿndo
;

736 
todo
 -ğ
ÿndo
;

737 ià(
sock
->
¡©e
 =ğ
SS_CONNECTED
)

738 
	`wake_up_š‹¼u±ibË
(
sock
->
cÚn
->
wa™
);

739 
¥aû
 = 
	`UN_BUF_SPACE
(
pupd
);

740 } 
todo
 && 
¥aû
);

741 
	`unix_uÆock
(
pupd
);

742 (
size
 - 
todo
);

743 
	}
}

747 
	$unix_´Ùo_£Ëù
(
sock‘
 *
sock
, 
£l_ty³
, 
£Ëù_bË
 * 
wa™
)

749 
unix_´Ùo_d©a
 *
upd
, *
³”upd
;

752 ià(
sock
->
æags
 & 
SO_ACCEPTCON
) {

753 ià(
£l_ty³
 =ğ
SEL_IN
) {

754 
	`d´štf
(1, "UNIX: select: %sconnections…ending\n",

755 
sock
->
icÚn
 ? "" : "no ");

756 ià(
sock
->
icÚn
) (1);

757 
	`£Ëù_wa™
(
sock
->
wa™
, wait);

758 (
sock
->
icÚn
 ? 1 : 0);

760 
	`d´štf
(1, "UNIX: select:‚othingƒlse for server socket\n");

761 
	`£Ëù_wa™
(
sock
->
wa™
, wait);

765 ià(
£l_ty³
 =ğ
SEL_IN
) {

766 
upd
 = 
	`UN_DATA
(
sock
);

767 
	`d´štf
(1, "UNIX: select:here is%s data‡vailable\n",

768 
	`UN_BUF_AVAIL
(
upd
) ? "" : "‚o");

769 ià(
	`UN_BUF_AVAIL
(
upd
))

771 ià(
sock
->
¡©e
 !ğ
SS_CONNECTED
) {

772 
	`d´štf
(1, "UNIX: select: socket‚ot connected(read EOF)\n");

775 
	`£Ëù_wa™
(
sock
->
wa™
,wait);

778 ià(
£l_ty³
 =ğ
SEL_OUT
) {

779 ià(
sock
->
¡©e
 !ğ
SS_CONNECTED
) {

780 
	`d´štf
(1, "UNIX: select: socket‚ot connected(write EOF)\n");

783 
³”upd
 = 
	`UN_DATA
(
sock
->
cÚn
);

784 
	`d´štf
(1, "UNIX: select:here is%s space‡vailable\n",

785 
	`UN_BUF_SPACE
(
³”upd
) ? "" : "‚o");

786 ià(
	`UN_BUF_SPACE
(
³”upd
) > 0) (1);

787 
	`£Ëù_wa™
(
sock
->
wa™
,wait);

792 
	`d´štf
(1, "UNIX: select:here‡re‚oƒxceptions here?!\n");

794 
	}
}

798 
	$unix_´Ùo_ioùl
(
sock‘
 *
sock
, 
cmd
, 
¬g
)

800 
unix_´Ùo_d©a
 *
upd
, *
³”upd
;

801 
”
;

803 
upd
 = 
	`UN_DATA
(
sock
);

804 
³”upd
 = (
sock
->
¡©e
 =ğ
SS_CONNECTED
è? 
	`UN_DATA
(sock->
cÚn
è: 
NULL
;

806 
cmd
) {

807 
TIOCINQ
:

808 ià(
sock
->
æags
 & 
SO_ACCEPTCON
è(-
EINVAL
);

809 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
, ());

810 if(
”
)

811  
”
;

812 ià(
	`UN_BUF_AVAIL
(
upd
è|| 
³”upd
)

813 
	`put_fs_lÚg
(
	`UN_BUF_AVAIL
(
upd
),(*)
¬g
);

815 
	`put_fs_lÚg
(0,(*)
¬g
);

817 
TIOCOUTQ
:

818 ià(
sock
->
æags
 & 
SO_ACCEPTCON
è(-
EINVAL
);

819 
”
=
	`v”ify_¬—
(
VERIFY_WRITE
,(*)
¬g
, ());

820 if(
”
)

821  
”
;

822 ià(
³”upd
è
	`put_fs_lÚg
(
	`UN_BUF_SPACE
(peerupd),

823 (*)
¬g
);

825 
	`put_fs_lÚg
(0,(*)
¬g
);

828 (-
EINVAL
);

831 
	}
}

835 
	$unix_İ’
(
šode
 * inode, 
fe
 * file)

837 
mšÜ
;

839 
	`d´štf
(1, "UNIX: open\n");

840 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

841 ià(
mšÜ
 !ğ0è(-
ENODEV
);

844 
	}
}

848 
	$unix_şo£
(
šode
 * inode, 
fe
 * file)

850 
	`d´štf
(1, "UNIX: close\n");

851 
	}
}

855 
	$unix_ioùl
(
šode
 *šode, 
fe
 *file,

856 
cmd
, 
¬g
)

858 
mšÜ
, 
»t
;

859 
”
;

861 
	`d´štf
(1, "UNIX: ioùl(0x%X, 0x%X)\n", 
cmd
, 
¬g
);

862 
mšÜ
 = 
	`MINOR
(
šode
->
i_rdev
);

863 ià(
mšÜ
 !ğ0è(-
ENODEV
);

865 
»t
 = -
EINVAL
;

866 
cmd
) {

867 
DDIOCSDBG
:

868 
”
=
	`v”ify_¬—
(
VERIFY_READ
,(*)
¬g
, ());

869 if(
”
)

870  
”
;

871 
unix_debug
 = 
	`g‘_fs_lÚg
((*)
¬g
);

872 ià(
unix_debug
 != 0 && unix_debug != 1) {

873 
unix_debug
 = 0;

874 (-
EINVAL
);

877 
SIOCSIFLINK
:

878 
	`´štk
("UNIX: cannot†ink streams!\n");

883 (
»t
);

884 
	}
}

889 
fe_İ”©iÚs
 
	gunix_fİs
 = {

890 
NULL
,

891 
NULL
,

892 
NULL
,

893 
NULL
,

894 
NULL
,

895 
unix_ioùl
,

896 
NULL
,

897 
unix_İ’
,

898 
unix_şo£


902 
´Ùo_İs
 
	gunix_´Ùo_İs
 = {

903 
AF_UNIX
,

904 
unix_´Ùo_ü—‹
,

905 
unix_´Ùo_dup
,

906 
unix_´Ùo_»Ëa£
,

907 
unix_´Ùo_bšd
,

908 
unix_´Ùo_cÚÃù
,

909 
unix_´Ùo_sock‘·œ
,

910 
unix_´Ùo_acû±
,

911 
unix_´Ùo_g‘Çme
,

912 
unix_´Ùo_»ad
,

913 
unix_´Ùo_wr™e
,

914 
unix_´Ùo_£Ëù
,

915 
unix_´Ùo_ioùl
,

916 
unix_´Ùo_li¡’
,

917 
unix_´Ùo_£nd
,

918 
unix_´Ùo_»cv
,

919 
unix_´Ùo_£ndto
,

920 
unix_´Ùo_»cväom
,

921 
unix_´Ùo_shutdown
,

922 
unix_´Ùo_£tsockİt
,

923 
unix_´Ùo_g‘sockİt
,

924 
NULL


929 
	$unix_´Ùo_š™
(
ddi_´Ùo
 *
´o
)

931 
unix_´Ùo_d©a
 *
upd
;

933 
	`d´štf
(1, "%s: in™: in™Ÿlizšg...\n", 
´o
->
Çme
);

934 ià(
	`»gi¡”_chrdev
(
AF_UNIX_MAJOR
, "af_unix", &
unix_fİs
) < 0) {

935 
	`´štk
("%s: cannot„egister major device %d!\n",

936 
´o
->
Çme
, 
AF_UNIX_MAJOR
);

941 (è
	`sock_»gi¡”
(
unix_´Ùo_İs
.
çmy
, &unix_proto_ops);

943 
upd
 = 
unix_d©as
; upd <ğ
Ï¡_unix_d©a
; ++upd) {

944 
upd
->
»fút
 = 0;

946 
	}
}

	@net/unix/unix.h

28 #ifdeà
_LINUX_UN_H


31 
	sunix_´Ùo_d©a
 {

32 
	m»fút
;

34 
sock‘
 *
	msock‘
;

35 
	m´ÙocŞ
;

36 
sockaddr_un
 
	msockaddr_un
;

37 
	msockaddr_Ën
;

38 *
	mbuf
;

39 
	mbp_h—d
, 
	mbp_
;

40 
šode
 *
	mšode
;

41 
unix_´Ùo_d©a
 *
	m³”upd
;

42 
wa™_queue
 *
	mwa™
;

43 
	mlock_æag
;

46 
unix_´Ùo_d©a
 
unix_d©as
[
NSOCKETS
];

49 
	#Ï¡_unix_d©a
 (
unix_d©as
 + 
NSOCKETS
 - 1)

	)

52 
	#UN_DATA
(
SOCK
è((
unix_´Ùo_d©a
 *)(SOCK)->
d©a
)

	)

53 
	#UN_PATH_OFFSET
 (()((
sockaddr_un
 *)0) \

54 ->
sun_·th
)

	)

61 
	#BUF_SIZE
 
PAGE_SIZE


	)

62 
	#UN_BUF_AVAIL
(
UPD
è(((UPD)->
bp_h—d
 - (UPD)->
bp_
) & \

63 (
BUF_SIZE
-1))

	)

64 
	#UN_BUF_SPACE
(
UPD
è((
BUF_SIZE
-1è- 
	`UN_BUF_AVAIL
(UPD))

	)

69 
unix_´Ùo_š™
(
ddi_´Ùo
 *
´o
);

	@tools/build.c

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<¡dlib.h
>

26 
	~<sys/ty³s.h
>

27 
	~<sys/¡©.h
>

28 
	~<sys/sysmaüos.h
>

29 
	~<uni¡d.h
>

30 
	~<fú.h
>

31 
	~<lšux/cÚfig.h
>

32 
	~<lšux/a.out.h
>

34 
	#MINIX_HEADER
 32

	)

35 
	#GCC_HEADER
 1024

	)

37 
	#SYS_SIZE
 
DEF_SYSSIZE


	)

39 
	#DEFAULT_MAJOR_ROOT
 0

	)

40 
	#DEFAULT_MINOR_ROOT
 0

	)

44 
	#SETUP_SECTS
 4

	)

46 
	#STRINGIFY
(
x
è#x

	)

49 
	ml
;

50 
	ms
[2];

51 
	mb
[4];

52 } 
	tcÚv
;

54 
	$š‹l_lÚg
(
l
)

56 
cÚv
 
t
;

58 
t
.
b
[0] = 
l
 & 0xff;† >>= 8;

59 
t
.
b
[1] = 
l
 & 0xff;† >>= 8;

60 
t
.
b
[2] = 
l
 & 0xff;† >>= 8;

61 
t
.
b
[3] = 
l
 & 0xff;† >>= 8;

62  
t
.
l
;

63 
	}
}

65 
	$š‹l_shÜt
(
l
)

67 
cÚv
 
t
;

69 
t
.
b
[0] = 
l
 & 0xff;† >>= 8;

70 
t
.
b
[1] = 
l
 & 0xff;† >>= 8;

71  
t
.
s
[0];

72 
	}
}

74 
	$d›
(* 
¡r
)

76 
	`årštf
(
¡d”r
,"%s\n",
¡r
);

77 
	`ex™
(1);

78 
	}
}

80 
	$u§ge
()

82 
	`d›
("Usage: build bootsect setup system [rootdev] [> image]");

83 
	}
}

85 
	$maš
(
¬gc
, ** 
¬gv
)

87 
i
,
c
,
id
, 
sz
;

88 
sys_size
;

89 
buf
[1024];

90 
exec
 *
ex
 = (exeø*)
buf
;

91 
majÜ_roÙ
, 
mšÜ_roÙ
;

92 
¡©
 
sb
;

94 ià((
¬gc
 < 4) || (argc > 5))

95 
	`u§ge
();

96 ià(
¬gc
 > 4) {

97 ià(!
	`¡rcmp
(
¬gv
[4], "CURRENT")) {

98 ià(
	`¡©
("/", &
sb
)) {

99 
	`³¼Ü
("/");

100 
	`d›
("Couldn't stat /");

102 
majÜ_roÙ
 = 
	`majÜ
(
sb
.
¡_dev
);

103 
mšÜ_roÙ
 = 
	`mšÜ
(
sb
.
¡_dev
);

104 } ià(
	`¡rcmp
(
¬gv
[4], "FLOPPY")) {

105 ià(
	`¡©
(
¬gv
[4], &
sb
)) {

106 
	`³¼Ü
(
¬gv
[4]);

107 
	`d›
("Couldn't stat„oot device.");

109 
majÜ_roÙ
 = 
	`majÜ
(
sb
.
¡_rdev
);

110 
mšÜ_roÙ
 = 
	`mšÜ
(
sb
.
¡_rdev
);

112 
majÜ_roÙ
 = 0;

113 
mšÜ_roÙ
 = 0;

116 
majÜ_roÙ
 = 
DEFAULT_MAJOR_ROOT
;

117 
mšÜ_roÙ
 = 
DEFAULT_MINOR_ROOT
;

119 
	`årštf
(
¡d”r
, "RoÙ deviû i (%d, %d)\n", 
majÜ_roÙ
, 
mšÜ_roÙ
);

120 
i
=0;i< 
buf
; i++) buf[i]=0;

121 ià((
id
=
	`İ’
(
¬gv
[1],
O_RDONLY
,0))<0)

122 
	`d›
("Unableo open 'boot'");

123 ià(
	`»ad
(
id
,
buf
,
MINIX_HEADER
) != MINIX_HEADER)

124 
	`d›
("Unableo„ead header of 'boot'");

125 ià(((*è
buf
)[0]!=
	`š‹l_lÚg
(0x04100301))

126 
	`d›
("Non-Minix header of 'boot'");

127 ià(((*è
buf
)[1]!=
	`š‹l_lÚg
(
MINIX_HEADER
))

128 
	`d›
("Non-Minix header of 'boot'");

129 ià(((*è
buf
)[3] != 0)

130 
	`d›
("Illegal data segment in 'boot'");

131 ià(((*è
buf
)[4] != 0)

132 
	`d›
("Illegal bss in 'boot'");

133 ià(((*è
buf
)[5] != 0)

134 
	`d›
("Non-Minix header of 'boot'");

135 ià(((*è
buf
)[7] != 0)

136 
	`d›
("Illegal symbolable in 'boot'");

137 
i
=
	`»ad
(
id
,
buf
, buf);

138 
	`årštf
(
¡d”r
,"BoÙ seùÜ %d by‹s.\n",
i
);

139 ià(
i
 != 512)

140 
	`d›
("Boot block must beƒxactly 512 bytes");

141 ià((*(*)(
buf
+510)è!ğ()
	`š‹l_shÜt
(0xAA55))

142 
	`d›
("Boot block hasn't got boot flag (0xAA55)");

143 
buf
[508] = (è
mšÜ_roÙ
;

144 
buf
[509] = (è
majÜ_roÙ
;

145 
i
=
	`wr™e
(1,
buf
,512);

146 ià(
i
!=512)

147 
	`d›
("Write call failed");

148 
	`şo£
 (
id
);

150 ià((
id
=
	`İ’
(
¬gv
[2],
O_RDONLY
,0))<0)

151 
	`d›
("Unableo open 'setup'");

152 ià(
	`»ad
(
id
,
buf
,
MINIX_HEADER
) != MINIX_HEADER)

153 
	`d›
("Unableo„ead header of 'setup'");

154 ià(((*è
buf
)[0]!=
	`š‹l_lÚg
(0x04100301))

155 
	`d›
("Non-Minix header of 'setup'");

156 ià(((*è
buf
)[1]!=
	`š‹l_lÚg
(
MINIX_HEADER
))

157 
	`d›
("Non-Minix header of 'setup'");

158 ià(((*è
buf
)[3] != 0)

159 
	`d›
("Illegal data segment in 'setup'");

160 ià(((*è
buf
)[4] != 0)

161 
	`d›
("Illegal bss in 'setup'");

162 ià(((*è
buf
)[5] != 0)

163 
	`d›
("Non-Minix header of 'setup'");

164 ià(((*è
buf
)[7] != 0)

165 
	`d›
("Illegal symbolable in 'setup'");

166 
i
=0 ; (
c
=
	`»ad
(
id
,
buf
, buf))>0 ; i+=c )

167 ià(
	`wr™e
(1,
buf
,
c
)!=c)

168 
	`d›
("Write call failed");

169 ià(
c
 != 0)

170 
	`d›
("read-error on 'setup'");

171 
	`şo£
 (
id
);

172 ià(
i
 > 
SETUP_SECTS
*512)

173 
	`d›
("S‘u°exûed " 
	`STRINGIFY
(
SETUP_SECTS
)

175 
	`årštf
(
¡d”r
,"S‘u°i %d by‹s.\n",
i
);

176 
c
=0 ; c<(
buf
) ; c++)

177 
buf
[
c
] = '\0';

178 
i
<
SETUP_SECTS
*512) {

179 
c
 = 
SETUP_SECTS
*512-
i
;

180 ià(
c
 > (
buf
))

181 
c
 = (
buf
);

182 ià(
	`wr™e
(1,
buf
,
c
) != c)

183 
	`d›
("Write call failed");

184 
i
 +ğ
c
;

187 ià((
id
=
	`İ’
(
¬gv
[3],
O_RDONLY
,0))<0)

188 
	`d›
("Unableo open 'system'");

189 ià(
	`»ad
(
id
,
buf
,
GCC_HEADER
) != GCC_HEADER)

190 
	`d›
("Unableo„ead header of 'system'");

191 ià(
	`N_MAGIC
(*
ex
è!ğ
ZMAGIC
)

192 
	`d›
("Non-GCC header of 'system'");

193 
	`årštf
(
¡d”r
,"System is %d kB (%d kB code, %d kB data‡nd %d kB bss)\n",

194 (
ex
->
a_‹xt
+ex->
a_d©a
+ex->
a_bss
)/1024,

195 
ex
->
a_‹xt
 /1024,

196 
ex
->
a_d©a
 /1024,

197 
ex
->
a_bss
 /1024);

198 
sz
 = 
	`N_SYMOFF
(*
ex
è- 
GCC_HEADER
 + 4;

199 
sys_size
 = (
sz
 + 15) / 16;

200 ià(
sys_size
 > 
SYS_SIZE
)

201 
	`d›
("System isoo big");

202 
sz
 > 0) {

203 
l
, 
n
;

205 
l
 = 
sz
;

206 ià(
l
 > (
buf
))

207 
l
 = (
buf
);

208 ià((
n
=
	`»ad
(
id
, 
buf
, 
l
)) !=†) {

209 ià(
n
 == -1)

210 
	`³¼Ü
(
¬gv
[1]);

212 
	`årštf
(
¡d”r
, "Unexpected EOF\n");

213 
	`d›
("Can't„ead 'system'");

215 ià(
	`wr™e
(1, 
buf
, 
l
) !=†)

216 
	`d›
("Write failed");

217 
sz
 -ğ
l
;

219 
	`şo£
(
id
);

220 ià(
	`l£ek
(1,500,0) == 500) {

221 
buf
[0] = (
sys_size
 & 0xff);

222 
buf
[1] = ((
sys_size
 >> 8) & 0xff);

223 ià(
	`wr™e
(1, 
buf
, 2) != 2)

224 
	`d›
("Write failed");

227 
	}
}

	@tools/version.c

9 
	~<lšux/cÚfig.h
>

10 
	~<lšux/ut¢ame.h
>

12 
	~"v”siÚ.h
"

14 
Ãw_ut¢ame
 
	gsy¡em_ut¢ame
 = {

15 
UTS_SYSNAME
, 
UTS_NODENAME
, 
UTS_RELEASE
, 
UTS_VERSION
,

16 
UTS_MACHINE
, 
UTS_DOMAINNAME


19 *
	glšux_bªÃr
 =

20 "Lšux v”siÚ " 
UTS_RELEASE
 " (" 
LINUX_COMPILE_BY
 "@"

21 
LINUX_COMPILE_HOST
 "è" 
UTS_VERSION
 "\n";

	@zBoot/crypt.h

5 #ifdeà
CRYPT


6 #undeà
CRYPT


9 
	#RAND_HEAD_LEN
 12

	)

11 
	#z’code


	)

12 
	#zdecode


	)

	@zBoot/gzip.h

7 #ià
defšed
(
__STDC__
è|| defšed(
PROTO
)

8 
	#OF
(
¬gs
è
	)
args

10 
	#OF
(
¬gs
è()

	)

13 #ifdeà
__STDC__


14 *
	tvoidp
;

16 *
	tvoidp
;

20 #ià
defšed
(
HAVE_STRING_H
è|| defšed(
STDC_HEADERS
)

21 
	~<¡ršg.h
>

22 
	#memz”o
(
s
, 
n
è
	`mem£t
 ((s), 0, (n))

	)

24 
	~<¡ršgs.h
>

25 
	#¡rchr
 
šdex


	)

26 
	#¡¼chr
 
ršdex


	)

27 
	#memıy
(
d
, 
s
, 
n
è
	`bcİy
((s), (d), (n))

	)

28 
	#memcmp
(
s1
, 
s2
, 
n
è
	`bcmp
((s1), (s2), (n))

	)

29 
	#memz”o
(
s
, 
n
è
	`bz”o
((s), (n))

	)

32 #ià!
defšed
(
STDC_HEADERS
è&& defšed(
HAVE_MEMORY_H
)

33 
	~<memÜy.h
>

36 #iâdeà
RETSIGTYPE


37 
	#RETSIGTYPE
 

	)

40 
	#loÿl
 

	)

42 
	tuch
;

43 
	tush
;

44 
	tulg
;

47 
	#OK
 0

	)

48 
	#ERROR
 1

	)

49 
	#WARNING
 2

	)

52 
	#STORED
 0

	)

53 
	#COMPRESSED
 1

	)

54 
	#PACKED
 2

	)

56 
	#DEFLATED
 8

	)

57 
m‘hod
;

69 #iâdef 
INBUFSIZ


70 
	#INBUFSIZ
 0x8000

	)

72 
	#INBUF_EXTRA
 64

	)

74 #iâdef 
OUTBUFSIZ


75 
	#OUTBUFSIZ
 16384

	)

77 
	#OUTBUF_EXTRA
 2048

	)

79 
	#DIST_BUFSIZE
 0x8000

	)

81 #ifdeà
DYN_ALLOC


82 
	#EXTERN
(
ty³
, 
¬¿y
èty³ * 
Ã¬
 
	)
array

83 
	#DECLARE
(
ty³
, 
¬¿y
, 
size
èty³ * 
Ã¬
 
	)
array

84 
	#ALLOC
(
ty³
, 
¬¿y
, 
size
) { \

85 
¬¿y
 = (
ty³
*)
	`fÿÎoc
(()(((
size
)+1L)/2), 2*(type)); \

86 ià(
¬¿y
 =ğ
NULL
è
	`”rÜ
("insufficient memory"); \

87 }

	)

88 
	#FREE
(
¬¿y
è{ià×¼ay !ğ
NULL
è
	`fcä“
×¼ay),‡¼ay=NULL;}

	)

90 
	#EXTERN
(
ty³
, 
¬¿y
èty³‡¼ay[]

	)

91 
	#DECLARE
(
ty³
, 
¬¿y
, 
size
èty³‡¼ay[size]

	)

92 
	#ALLOC
(
ty³
, 
¬¿y
, 
size
)

	)

93 
	#FREE
(
¬¿y
)

	)

96 
EXTERN
(
uch
, 
šbuf
);

97 
EXTERN
(
uch
, 
outbuf
);

98 
EXTERN
(
ush
, 
d_buf
);

99 
EXTERN
(
uch
, 
wšdow
);

100 
	#b_suffix
 
wšdow


	)

101 #iâdeà
MAXSEG_64K


102 
	#b_´efix
 
´ev


	)

103 
	#h—d
 (
´ev
+
WSIZE
è

	)

104 
EXTERN
(
ush
, 
b_´efix
);

106 
	#b_´efix0
 
´ev


	)

107 
	#h—d
 
b_´efix1


	)

108 
EXTERN
(
ush
, 
b_´efix0
);

109 
EXTERN
(
ush
, 
b_´efix1
);

112 
šsize
;

113 
š±r
;

114 
outút
;

116 
by‹s_š
;

117 
by‹s_out
;

118 
ov”h—d
;

120 
	#isize
 
by‹s_š


	)

123 
ifd
;

124 
ofd
;

125 
iâame
[];

126 
oâame
[];

128 
ulg
 
time_¡amp
;

129 
ife_size
;

131 
ex™_code
;

133 
	tfe_t
;

134 
	#NO_FILE
 (-1è

	)

137 
	#GZIP_MAGIC
 "\037\213"

	)

138 
	#OLD_GZIP_MAGIC
 "\037\236"

	)

139 
	#PKZIP_MAGIC
 "PK\003\004"

	)

140 
	#PACK_MAGIC
 "\037\036"

	)

143 
	#ASCII_FLAG
 0x01

	)

144 
	#CONTINUATION
 0x02

	)

145 
	#EXTRA_FIELD
 0x04

	)

146 
	#ORIG_NAME
 0x08

	)

147 
	#COMMENT
 0x10

	)

148 
	#ENCRYPTED
 0x20

	)

149 
	#RESERVED
 0xC0

	)

152 
	#UNKNOWN
 (-1)

	)

153 
	#BINARY
 0

	)

154 
	#ASCII
 1

	)

156 #iâdeà
WSIZE


157 
	#WSIZE
 0x8000

	)

160 
	#MIN_MATCH
 3

	)

161 
	#MAX_MATCH
 258

	)

164 
	#MIN_LOOKAHEAD
 (
MAX_MATCH
+
MIN_MATCH
+1)

	)

169 
	#MAX_DIST
 (
WSIZE
-
MIN_LOOKAHEAD
)

	)

174 
deüy±
;

175 
§ve_Üig_Çme
;

176 
v”bo£
;

177 
Ëv–
;

178 
‹¡
;

179 
to_¡dout
;

181 
	#g‘_by‹
(è(
š±r
 < 
šsize
 ? 
šbuf
[š±r++] : 
	`fl_šbuf
())

	)

188 
	#put_by‹
(
c
è{
outbuf
[
outút
++]=(
uch
)(c); ià(outút==
OUTBUFSIZ
)\

189 
	`æush_outbuf
();}

	)

190 
	#put_ch¬
(
c
è{
wšdow
[
outút
++]=(
uch
)(c); ià(outút==
WSIZE
)\

191 
	`æush_wšdow
();}

	)

194 
	#put_shÜt
(
w
) \

195 { ià(
outút
 < 
OUTBUFSIZ
-2) { \

196 
outbuf
[
outút
++] = (
uch
è((
w
) & 0xff); \

197 
outbuf
[
outút
++] = (
uch
è((
ush
)(
w
) >> 8); \

199 
	`put_by‹
((
uch
)((
w
) & 0xff)); \

200 
	`put_by‹
((
uch
)((
ush
)(
w
) >> 8)); \

202 }

	)

205 
	#put_lÚg
(
n
) { \

206 
	`put_shÜt
((
n
) & 0xffff); \

207 
	`put_shÜt
(((
ulg
)(
n
)) >> 16); \

208 }

	)

210 
	#£ekabË
(è0

	)

211 
	#Œª¦©e_eŞ
 0

	)

213 
	#tŞow
(
c
è(
	`isuµ”
(cè? (c)-'A'+'a' : (c)è

	)

216 
	#SH
(
p
è((
ush
)(
uch
)(Õ)[0]è| ((ush)(uch)(Õ)[1]è<< 8))

	)

217 
	#LG
(
p
è((
ulg
)(
	`SH
Õ)è| ((ulg)(SH(Õ)+2)è<< 16))

	)

220 #ifdeà
DEBUG


221 
	#As£¹
(
cÚd
,
msg
è{if(!(cÚd)è
	`”rÜ
(msg);}

	)

222 
	#T¿û
(
x
è
årštf
 
	)
x

223 
	#T¿ûv
(
x
è{ià(
v”bo£
è
årštf
 x ;}

	)

224 
	#T¿ûvv
(
x
è{ià(
v”bo£
>1è
årštf
 x ;}

	)

225 
	#T¿ûc
(
c
,
x
è{ià(
v”bo£
 && (c)è
årštf
 x ;}

	)

226 
	#T¿ûcv
(
c
,
x
è{ià(
v”bo£
>1 && (c)è
årštf
 x ;}

	)

228 
	#As£¹
(
cÚd
,
msg
)

	)

229 
	#T¿û
(
x
)

	)

230 
	#T¿ûv
(
x
)

	)

231 
	#T¿ûvv
(
x
)

	)

232 
	#T¿ûc
(
c
,
x
)

	)

233 
	#T¿ûcv
(
c
,
x
)

	)

237 
z
 
OF
((
š
, 
out
));

238 
fe_»ad
 
OF
((*
buf
, 
size
));

241 
unz
 
OF
((
š
, 
out
));

242 
check_zfe
 
OF
((
š
));

245 
uÅack
 
OF
((
š
, 
out
));

248 
RETSIGTYPE
 
abÜt_gz
 
OF
(());

251 
lm_š™
 
OF
((
·ck_Ëv–
, 
ush
 *
æags
));

252 
ulg
 
deæ©e
 
OF
(());

255 
ù_š™
 
OF
((
ush
 *
©Œ
, *
m‘hod
));

256 
ù_Îy
 
OF
((
di¡
, 
lc
));

257 
ulg
 
æush_block
 
OF
((*
buf
, ulg 
¡Üed_Ën
, 
eof
));

260 
bi_š™
 
OF
((
fe_t
 
zfe
));

261 
£nd_b™s
 
OF
((
v®ue
, 
Ëngth
));

262 
bi_»v”£
 
OF
((
v®ue
, 
Ëngth
));

263 
bi_wšdup
 
OF
(());

264 
cİy_block
 
OF
((*
buf
, 
Ën
, 
h—d”
));

265 (*
»ad_buf
è
	`OF
((*
buf
, 
size
));

268 
ulg
 
updüc
 
	`OF
((
uch
 *
s
, 
n
));

269 
ş—r_bufs
 
	`OF
(());

270 
fl_šbuf
 
	`OF
(());

271 
æush_outbuf
 
	`OF
(());

272 
æush_wšdow
 
	`OF
(());

273 *
¡¾wr
 
	`OF
((*
s
));

274 *
ba£Çme
 
	`OF
((*
âame
));

275 *
add_’vİt
 
	`OF
((*
¬gı
, ***
¬gvp
, *
’v
));

276 
”rÜ
 
	`OF
((*
m
));

277 
w¬n
 
	`OF
((*
a
, *
b
));

278 
»ad_”rÜ
 
	`OF
(());

279 
wr™e_”rÜ
 
	`OF
(());

280 
di¥Ïy_¿tio
 
	`OF
((
num
, 
d’
));

281 
voidp
 
xm®loc
 
	`OF
((
size
));

284 
šæ©e
 
	`OF
(());

	@zBoot/inflate.c

1 
	#DEBG
(
x
)

	)

2 
	#DEBG1
(
x
)

	)

11 #iâdeà
lšt


12 
	grcsid
[] = "$Id: inflate.c,v 0.10 1993/02/04 13:21:06 jloup Exp $";

15 
	~"gz.h
"

16 
	#¦ide
 
wšdow


	)

18 #ià
defšed
(
STDC_HEADERS
è|| defšed(
HAVE_STDLIB_H
)

19 
	~<sys/ty³s.h
>

20 
	~<¡dlib.h
>

23 
	shuá
 {

24 
uch
 
	me
;

25 
uch
 
	mb
;

27 
ush
 
	mn
;

28 
huá
 *
	mt
;

29 } 
	mv
;

34 
huá_bud
 
OF
((*, , , 
ush
 *, ush *,

35 
huá
 **, *));

36 
huá_ä“
 
OF
((
huá
 *));

37 
šæ©e_codes
 
OF
((
huá
 *, huft *, , ));

38 
šæ©e_¡Üed
 
OF
(());

39 
šæ©e_fixed
 
OF
(());

40 
šæ©e_dyÇmic
 
OF
(());

41 
šæ©e_block
 
OF
((*));

42 
šæ©e
 
OF
(());

45 
	#wp
 
outút


	)

46 
	#æush_ouut
(
w
è(
wp
=(w),
	`æush_wšdow
())

	)

49 
	gbÜd”
[] = {

51 
ush
 
	gıËns
[] = {

55 
ush
 
	gıËxt
[] = {

58 
ush
 
	gıdi¡
[] = {

62 
ush
 
	gıdext
[] = {

68 
ulg
 
	gbb
;

69 
	gbk
;

71 
ush
 
	gmask_b™s
[] = {

77 #ifdeà
CRYPT


78 
uch
 
	gcc
;

79 
	#NEXTBYTE
() \

80 (
deüy±
 ? (
cc
 = 
	`g‘_by‹
(), 
	`zdecode
(cc), ccè: g‘_by‹())

	)

82 
	#NEXTBYTE
(è(
uch
)
	`g‘_by‹
()

	)

84 
	#NEEDBITS
(
n
è{
k
<Ò)){
b
|=((
ulg
)
	`NEXTBYTE
())<<k;k+=8;}}

	)

85 
	#DUMPBITS
(
n
è{
b
>>=Ò);
k
-=Ò);}

	)

87 
	glb™s
 = 9;

88 
	gdb™s
 = 6;

92 
	#BMAX
 16

	)

93 
	#N_MAX
 288

	)

96 
	ghuás
;

99 
	$huá_bud
(
b
, 
n
, 
s
, 
d
, 
e
, 
t
, 
m
)

100 *
b
;

101 
n
;

102 
s
;

103 
ush
 *
d
;

104 
ush
 *
e
;

105 
huá
 **
t
;

106 *
m
;

113 
a
;

114 
c
[
BMAX
+1];

115 
f
;

116 
g
;

117 
h
;

118 
i
;

119 
j
;

120 
k
;

121 
l
;

122 *
p
;

123 
huá
 *
q
;

124 
huá
 
r
;

125 
huá
 *
u
[
BMAX
];

126 
v
[
N_MAX
];

127 
w
;

128 
x
[
BMAX
+1];

129 *
xp
;

130 
y
;

131 
z
;

133 
	`DEBG
("huft1 ");

136 
	`memz”o
(
c
, (c));

137 
p
 = 
b
; 
i
 = 
n
;

139 
c
[*
p
++]++;

140 } --
i
);

141 ià(
c
[0] =ğ
n
)

143 *
t
 = (
huá
 *)
NULL
;

144 *
m
 = 0;

148 
	`DEBG
("huft2 ");

151 
l
 = *
m
;

152 
j
 = 1; j <ğ
BMAX
; j++)

153 ià(
c
[
j
])

155 
k
 = 
j
;

156 ià(()
l
 < 
j
)

157 
l
 = 
j
;

158 
i
 = 
BMAX
; i; i--)

159 ià(
c
[
i
])

161 
g
 = 
i
;

162 ià(()
l
 > 
i
)

163 
l
 = 
i
;

164 *
m
 = 
l
;

166 
	`DEBG
("huft3 ");

169 
y
 = 1 << 
j
; j < 
i
; j++, y <<= 1)

170 ià((
y
 -ğ
c
[
j
]) < 0)

172 ià((
y
 -ğ
c
[
i
]) < 0)

174 
c
[
i
] +ğ
y
;

176 
	`DEBG
("huft4 ");

179 
x
[1] = 
j
 = 0;

180 
p
 = 
c
 + 1; 
xp
 = 
x
 + 2;

181 --
i
) {

182 *
xp
++ = (
j
 +ğ*
p
++);

185 
	`DEBG
("huft5 ");

188 
p
 = 
b
; 
i
 = 0;

190 ià((
j
 = *
p
++) != 0)

191 
v
[
x
[
j
]++] = 
i
;

192 } ++
i
 < 
n
);

194 
	`DEBG
("h6 ");

197 
x
[0] = 
i
 = 0;

198 
p
 = 
v
;

199 
h
 = -1;

200 
w
 = -
l
;

201 
u
[0] = (
huá
 *)
NULL
;

202 
q
 = (
huá
 *)
NULL
;

203 
z
 = 0;

204 
	`DEBG
("h6a ");

207 ; 
k
 <ğ
g
; k++)

209 
	`DEBG
("h6b ");

210 
a
 = 
c
[
k
];

211 
a
--)

213 
	`DEBG
("h6b1 ");

216 
k
 > 
w
 + 
l
)

218 
	`DEBG1
("1 ");

219 
h
++;

220 
w
 +ğ
l
;

223 
z
 = (z = 
g
 - 
w
è> ()
l
 ?† : z;

224 ià((
f
 = 1 << (
j
 = 
k
 - 
w
)è> 
a
 + 1)

226 
	`DEBG1
("2 ");

227 
f
 -ğ
a
 + 1;

228 
xp
 = 
c
 + 
k
;

229 ++
j
 < 
z
)

231 ià((
f
 <<ğ1è<ğ*++
xp
)

233 
f
 -ğ*
xp
;

236 
	`DEBG1
("3 ");

237 
z
 = 1 << 
j
;

240 ià((
q
 = (
huá
 *)
	`m®loc
((
z
 + 1)*(huft))) ==

241 (
huá
 *)
NULL
)

243 
	`DEBG1
("31 ");

244 
	`”rÜ
("malloc failed\n");

245 ià(
h
)

246 
	`huá_ä“
(
u
[0]);

249 
	`DEBG1
("4 ");

250 
huás
 +ğ
z
 + 1;

251 *
t
 = 
q
 + 1;

252 *(
t
 = &(
q
->
v
.t)èğ(
huá
 *)
NULL
;

253 
u
[
h
] = ++
q
;

255 
	`DEBG1
("5 ");

257 ià(
h
)

259 
x
[
h
] = 
i
;

260 
r
.
b
 = (
uch
)
l
;

261 
r
.
e
 = (
uch
)(16 + 
j
);

262 
r
.
v
.
t
 = 
q
;

263 
j
 = 
i
 >> (
w
 - 
l
);

264 
u
[
h
-1][
j
] = 
r
;

266 
	`DEBG1
("6 ");

268 
	`DEBG
("h6c ");

271 
r
.
b
 = (
uch
)(
k
 - 
w
);

272 ià(
p
 >ğ
v
 + 
n
)

273 
r
.
e
 = 99;

274 ià(*
p
 < 
s
)

276 
r
.
e
 = (
uch
)(*
p
 < 256 ? 16 : 15);

277 
r
.
v
.
n
 = *
p
++;

281 
r
.
e
 = (
uch
ë[*
p
 - 
s
];

282 
r
.
v
.
n
 = 
d
[*
p
++ - 
s
];

284 
	`DEBG
("h6d ");

287 
f
 = 1 << (
k
 - 
w
);

288 
j
 = 
i
 >> 
w
; j < 
z
; j +ğ
f
)

289 
q
[
j
] = 
r
;

292 
j
 = 1 << (
k
 - 1); 
i
 & j; j >>= 1)

293 
i
 ^ğ
j
;

294 
i
 ^ğ
j
;

297 (
i
 & ((1 << 
w
è- 1)è!ğ
x
[
h
])

299 
h
--;

300 
w
 -ğ
l
;

302 
	`DEBG
("h6e ");

304 
	`DEBG
("h6f ");

307 
	`DEBG
("huft7 ");

310  
y
 !ğ0 && 
g
 != 1;

311 
	}
}

315 
	$huá_ä“
(
t
)

316 
huá
 *
t
;

321 
huá
 *
p
, *
q
;

325 
p
 = 
t
;

326 
p
 !ğ(
huá
 *)
NULL
)

328 
q
 = (--
p
)->
v
.
t
;

329 
	`ä“
(
p
);

330 
p
 = 
q
;

333 
	}
}

336 
	$šæ©e_codes
(

, 
td
, 
bl
, 
bd
)

337 
huá
 *

, *
td
;

338 
bl
, 
bd
;

342 
e
;

343 
n
, 
d
;

344 
w
;

345 
huá
 *
t
;

346 
ml
, 
md
;

347 
ulg
 
b
;

348 
k
;

352 
b
 = 
bb
;

353 
k
 = 
bk
;

354 
w
 = 
wp
;

357 
ml
 = 
mask_b™s
[
bl
];

358 
md
 = 
mask_b™s
[
bd
];

361 
	`NEEDBITS
(()
bl
)

362 ià((
e
 = (
t
 = 

 + (()
b
 & 
ml
))->e) > 16)

364 ià(
e
 == 99)

366 
	`DUMPBITS
(
t
->
b
)

367 
e
 -= 16;

368 
	`NEEDBITS
(
e
)

369 } (
e
 = (
t
 =->
v
.ˆ+ (()
b
 & 
mask_b™s
[e]))->e) > 16);

370 
	`DUMPBITS
(
t
->
b
)

371 ià(
e
 == 16)

373 
¦ide
[
w
++] = (
uch
)
t
->
v
.
n
;

374 ià(
w
 =ğ
WSIZE
)

376 
	`æush_ouut
(
w
);

377 
w
 = 0;

383 ià(
e
 == 15)

387 
	`NEEDBITS
(
e
)

388 
n
 = 
t
->
v
.À+ (()
b
 & 
mask_b™s
[
e
]);

389 
	`DUMPBITS
(
e
);

392 
	`NEEDBITS
(()
bd
)

393 ià((
e
 = (
t
 = 
td
 + (()
b
 & 
md
))->e) > 16)

395 ià(
e
 == 99)

397 
	`DUMPBITS
(
t
->
b
)

398 
e
 -= 16;

399 
	`NEEDBITS
(
e
)

400 } (
e
 = (
t
 =->
v
.ˆ+ (()
b
 & 
mask_b™s
[e]))->e) > 16);

401 
	`DUMPBITS
(
t
->
b
)

402 
	`NEEDBITS
(
e
)

403 
d
 = 
w
 - 
t
->
v
.
n
 - (()
b
 & 
mask_b™s
[
e
]);

404 
	`DUMPBITS
(
e
)

408 
n
 -ğ(
e
 = (ğ
WSIZE
 - ((
d
 &ğWSIZE-1è> 
w
 ? d : w)) >‚ ?‚ :ƒ);

409 #ià!
	`defšed
(
NOMEMCPY
è&& !defšed(
DEBUG
)

410 ià(
w
 - 
d
 >ğ
e
)

412 
	`memıy
(
¦ide
 + 
w
, slid+ 
d
, 
e
);

413 
w
 +ğ
e
;

414 
d
 +ğ
e
;

419 
¦ide
[
w
++] = slide[
d
++];

420 } --
e
);

421 ià(
w
 =ğ
WSIZE
)

423 
	`æush_ouut
(
w
);

424 
w
 = 0;

426 } 
n
);

432 
wp
 = 
w
;

433 
bb
 = 
b
;

434 
bk
 = 
k
;

438 
	}
}

442 
	$šæ©e_¡Üed
()

445 
n
;

446 
w
;

447 
ulg
 
b
;

448 
k
;

450 
	`DEBG
("<stor");

453 
b
 = 
bb
;

454 
k
 = 
bk
;

455 
w
 = 
wp
;

459 
n
 = 
k
 & 7;

460 
	`DUMPBITS
(
n
);

464 
	`NEEDBITS
(16)

465 
n
 = (()
b
 & 0xffff);

466 
	`DUMPBITS
(16)

467 
	`NEEDBITS
(16)

468 ià(
n
 !ğ()((~
b
) & 0xffff))

470 
	`DUMPBITS
(16)

474 
n
--)

476 
	`NEEDBITS
(8)

477 
¦ide
[
w
++] = (
uch
)
b
;

478 ià(
w
 =ğ
WSIZE
)

480 
	`æush_ouut
(
w
);

481 
w
 = 0;

483 
	`DUMPBITS
(8)

488 
wp
 = 
w
;

489 
bb
 = 
b
;

490 
bk
 = 
k
;

492 
	`DEBG
(">");

494 
	}
}

498 
	$šæ©e_fixed
()

503 
i
;

504 
huá
 *

;

505 
huá
 *
td
;

506 
bl
;

507 
bd
;

508 
l
[288];

510 
	`DEBG
("<fix");

513 
i
 = 0; i < 144; i++)

514 
l
[
i
] = 8;

515 ; 
i
 < 256; i++)

516 
l
[
i
] = 9;

517 ; 
i
 < 280; i++)

518 
l
[
i
] = 7;

519 ; 
i
 < 288; i++)

520 
l
[
i
] = 8;

521 
bl
 = 7;

522 ià((
i
 = 
	`huá_bud
(
l
, 288, 257, 
ıËns
, 
ıËxt
, &

, &
bl
)) != 0)

523  
i
;

527 
i
 = 0; i < 30; i++)

528 
l
[
i
] = 5;

529 
bd
 = 5;

530 ià((
i
 = 
	`huá_bud
(
l
, 30, 0, 
ıdi¡
, 
ıdext
, &
td
, &
bd
)) > 1)

532 
	`huá_ä“
(

);

534 
	`DEBG
(">");

535  
i
;

540 ià(
	`šæ©e_codes
(

, 
td
, 
bl
, 
bd
))

545 
	`huá_ä“
(

);

546 
	`huá_ä“
(
td
);

548 
	}
}

552 
	$šæ©e_dyÇmic
()

555 
i
;

556 
j
;

557 
l
;

558 
m
;

559 
n
;

560 
huá
 *

;

561 
huá
 *
td
;

562 
bl
;

563 
bd
;

564 
nb
;

565 
Æ
;

566 
nd
;

567 #ifdeà
PKZIP_BUG_WORKAROUND


568 
Î
[288+32];

570 
Î
[286+30];

572 
ulg
 
b
;

573 
k
;

575 
	`DEBG
("<dyn");

578 
b
 = 
bb
;

579 
k
 = 
bk
;

583 
	`NEEDBITS
(5)

584 
Æ
 = 257 + (()
b
 & 0x1f);

585 
	`DUMPBITS
(5)

586 
	`NEEDBITS
(5)

587 
nd
 = 1 + (()
b
 & 0x1f);

588 
	`DUMPBITS
(5)

589 
	`NEEDBITS
(4)

590 
nb
 = 4 + (()
b
 & 0xf);

591 
	`DUMPBITS
(4)

592 #ifdeà
PKZIP_BUG_WORKAROUND


593 ià(
Æ
 > 288 || 
nd
 > 32)

595 ià(
Æ
 > 286 || 
nd
 > 30)

599 
	`DEBG
("dyn1 ");

602 
j
 = 0; j < 
nb
; j++)

604 
	`NEEDBITS
(3)

605 
Î
[
bÜd”
[
j
]] = ()
b
 & 7;

606 
	`DUMPBITS
(3)

608 ; 
j
 < 19; j++)

609 
Î
[
bÜd”
[
j
]] = 0;

611 
	`DEBG
("dyn2 ");

614 
bl
 = 7;

615 ià((
i
 = 
	`huá_bud
(
Î
, 19, 19, 
NULL
, NULL, &

, &
bl
)) != 0)

617 ià(
i
 == 1)

618 
	`huá_ä“
(

);

619  
i
;

622 
	`DEBG
("dyn3 ");

625 
n
 = 
Æ
 + 
nd
;

626 
m
 = 
mask_b™s
[
bl
];

627 
i
 = 
l
 = 0;

628 ()
i
 < 
n
)

630 
	`NEEDBITS
(()
bl
)

631 
j
 = (
td
 = 

 + (()
b
 & 
m
))->b;

632 
	`DUMPBITS
(
j
)

633 
j
 = 
td
->
v
.
n
;

634 ià(
j
 < 16)

635 
Î
[
i
++] = 
l
 = 
j
;

636 ià(
j
 == 16)

638 
	`NEEDBITS
(2)

639 
j
 = 3 + (()
b
 & 3);

640 
	`DUMPBITS
(2)

641 ià(()
i
 + 
j
 > 
n
)

643 
j
--)

644 
Î
[
i
++] = 
l
;

646 ià(
j
 == 17)

648 
	`NEEDBITS
(3)

649 
j
 = 3 + (()
b
 & 7);

650 
	`DUMPBITS
(3)

651 ià(()
i
 + 
j
 > 
n
)

653 
j
--)

654 
Î
[
i
++] = 0;

655 
l
 = 0;

659 
	`NEEDBITS
(7)

660 
j
 = 11 + (()
b
 & 0x7f);

661 
	`DUMPBITS
(7)

662 ià(()
i
 + 
j
 > 
n
)

664 
j
--)

665 
Î
[
i
++] = 0;

666 
l
 = 0;

670 
	`DEBG
("dyn4 ");

673 
	`huá_ä“
(

);

675 
	`DEBG
("dyn5 ");

678 
bb
 = 
b
;

679 
bk
 = 
k
;

681 
	`DEBG
("dyn5a ");

684 
bl
 = 
lb™s
;

685 ià((
i
 = 
	`huá_bud
(
Î
, 
Æ
, 257, 
ıËns
, 
ıËxt
, &

, &
bl
)) != 0)

687 
	`DEBG
("dyn5b ");

688 ià(
i
 == 1) {

689 
	`”rÜ
(" incomplete†iteralree\n");

690 
	`huá_ä“
(

);

692  
i
;

694 
	`DEBG
("dyn5c ");

695 
bd
 = 
db™s
;

696 ià((
i
 = 
	`huá_bud
(
Î
 + 
Æ
, 
nd
, 0, 
ıdi¡
, 
ıdext
, &
td
, &
bd
)) != 0)

698 
	`DEBG
("dyn5d ");

699 ià(
i
 == 1) {

700 
	`”rÜ
(" incomplete distanceree\n");

701 #ifdeà
PKZIP_BUG_WORKAROUND


702 
i
 = 0;

705 
	`huá_ä“
(
td
);

707 
	`huá_ä“
(

);

708  
i
;

712 
	`DEBG
("dyn6 ");

715 ià(
	`šæ©e_codes
(

, 
td
, 
bl
, 
bd
))

718 
	`DEBG
("dyn7 ");

721 
	`huá_ä“
(

);

722 
	`huá_ä“
(
td
);

724 
	`DEBG
(">");

726 
	}
}

730 
	$šæ©e_block
(
e
)

731 *
e
;

734 
t
;

735 
ulg
 
b
;

736 
k
;

738 
	`DEBG
("<blk");

741 
b
 = 
bb
;

742 
k
 = 
bk
;

746 
	`NEEDBITS
(1)

747 *
e
 = ()
b
 & 1;

748 
	`DUMPBITS
(1)

752 
	`NEEDBITS
(2)

753 
t
 = ()
b
 & 3;

754 
	`DUMPBITS
(2)

758 
bb
 = 
b
;

759 
bk
 = 
k
;

762 ià(
t
 == 2)

763  
	`šæ©e_dyÇmic
();

764 ià(
t
 == 0)

765  
	`šæ©e_¡Üed
();

766 ià(
t
 == 1)

767  
	`šæ©e_fixed
();

769 
	`DEBG
(">");

773 
	}
}

777 
	$šæ©e
()

780 
e
;

781 
r
;

782 
h
;

786 
wp
 = 0;

787 
bk
 = 0;

788 
bb
 = 0;

792 
h
 = 0;

794 
huás
 = 0;

795 ià((
r
 = 
	`šæ©e_block
(&
e
)) != 0)

796  
r
;

797 ià(
huás
 > 
h
)

798 
h
 = 
huás
;

799 } !
e
);

804 
bk
 >= 8) {

805 
bk
 -= 8;

806 
š±r
--;

810 
	`æush_ouut
(
wp
);

814 #ifdeà
DEBUG


815 
	`årštf
(
¡d”r
, "<%u> ", 
h
);

818 
	}
}

	@zBoot/lzw.h

7 #ià!
defšed
(
OF
è&& defšed(
lšt
)

8 
	~"gz.h
"

11 #iâdeà
BITS


12 
	#BITS
 16

	)

14 
	#INIT_BITS
 9

	)

16 
	#LZW_MAGIC
 "\037\235"

	)

18 
	#BIT_MASK
 0x1à

	)

28 
	#BLOCK_MODE
 0x80

	)

33 
	#LZW_RESERVED
 0x60

	)

35 
	#CLEAR
 256

	)

36 
	#FIRST
 (
CLEAR
+1è

	)

38 
maxb™s
;

39 
block_mode
;

41 
lzw
 
OF
((
š
, 
out
));

42 
uÆzw
 
OF
((
š
, 
out
));

	@zBoot/misc.c

11 
	~"gz.h
"

12 
	~"lzw.h
"

14 
	~<lšux/£gm’t.h
>

20 
	ssü“n_šfo
 {

21 
	mÜig_x
;

22 
	mÜig_y
;

23 
	munu£d1
[2];

24 
	mÜig_video_·ge
;

25 
	mÜig_video_mode
;

26 
	mÜig_video_cŞs
;

27 
	mÜig_video_ega_ax
;

28 
	mÜig_video_ega_bx
;

29 
	mÜig_video_ega_cx
;

30 
	mÜig_video_lšes
;

36 
	#EXT_MEM_K
 (*(*)0x90002)

	)

37 
	#DRIVE_INFO
 (*(
drive_šfo
 *)0x90080)

	)

38 
	#SCREEN_INFO
 (*(
sü“n_šfo
 *)0x90000)

	)

39 
	#RAMDISK_SIZE
 (*(*)0x901F8)

	)

40 
	#ORIG_ROOT_DEV
 (*(*)0x901FC)

	)

41 
	#AUX_DEVICE_INFO
 (*(*)0x901FF)

	)

43 
	#EOF
 -1

	)

45 
DECLARE
(
uch
, 
šbuf
, 
INBUFSIZ
);

46 
DECLARE
(
uch
, 
outbuf
, 
OUTBUFSIZ
+
OUTBUF_EXTRA
);

47 
DECLARE
(
uch
, 
wšdow
, 
WSIZE
);

49 
	goutút
;

50 
	gšsize
;

51 
	gš±r
;

53 
šput_d©a
[];

54 
šput_Ën
;

56 
	gšput_±r
;

58 
	gm‘hod
, 
	gex™_code
, 
	g·¹_nb
, 
	gÏ¡_memb”
;

59 
	g‹¡
 = 0;

60 
	gfÜû
 = 0;

61 
	gv”bo£
 = 1;

62 
	gby‹s_š
, 
	gby‹s_out
;

64 *
	gouut_d©a
;

65 
	gouut_±r
;

67 
’d
;

68 
	gä“_mem_±r
 = ()&
’d
;

70 
	gto_¡dout
 = 0;

71 
	gh¬d_m©h
 = 0;

73 (*
wÜk
)(
šf
, 
outf
);

74 
	`makeüc
();

76 
loÿl
 
	`g‘_m‘hod
();

78 *
vidmem
 = (*)0xb8000;

79 
lšes
, 
cŞs
;

81 *
	$m®loc
(
size
)

83 *
p
;

85 ià(
size
 <0è
	`”rÜ
("Mallocƒrror\n");

86 ià(
ä“_mem_±r
 <ğ0è
	`”rÜ
("Memoryƒrror\n");

88 
ä“_mem_±r
 = (free_mem_ptr + 3) & ~3;

90 
p
 = (*)
ä“_mem_±r
;

92 
ä“_mem_±r
 +ğ
size
;

94 ià(
ä“_mem_±r
 > 0x90000è
	`”rÜ
("\nOut of memory\n");

96 ià(
p
 =ğ
NULL
è
	`”rÜ
("malloc = NULL\n");

97  
p
;

98 
	}
}

100 
	$ä“
(*
wh”e
)

102 
	}
}

104 
	$süŞl
()

106 
i
;

108 
	`memıy
 ( 
vidmem
, vidmem + 
cŞs
 * 2, ( 
lšes
 - 1 ) * cols * 2 );

109  
i
 = ( 
lšes
 - 1 ) * 
cŞs
 * 2; i <†ines * cols * 2; i += 2 )

110 
vidmem
[
i
] = ' ';

111 
	}
}

113 
	$puts
(*
s
)

115 
x
,
y
;

116 
c
;

118 
x
 = 
SCREEN_INFO
.
Üig_x
;

119 
y
 = 
SCREEN_INFO
.
Üig_y
;

121  ( 
c
 = *
s
++ ) != '\0' ) {

122 iàĞ
c
 == '\n' ) {

123 
x
 = 0;

124 iàĞ++
y
 >ğ
lšes
 ) {

125 
	`süŞl
();

126 
y
--;

129 
vidmem
 [ ( 
x
 + 
cŞs
 * 
y
 ) * 2 ] = 
c
;

130 iàĞ++
x
 >ğ
cŞs
 ) {

131 
x
 = 0;

132 iàĞ++
y
 >ğ
lšes
 ) {

133 
	`süŞl
();

134 
y
--;

140 
SCREEN_INFO
.
Üig_x
 = 
x
;

141 
SCREEN_INFO
.
Üig_y
 = 
y
;

142 
	}
}

144 
__±r_t
 
	$mem£t
(
__±r_t
 
s
, 
c
, 
size_t
 
n
)

146 
i
;

147 *
ss
 = (*)
s
;

149 
i
=0;i<
n
;i++è
ss
[i] = 
c
;

150 
	}
}

152 
__±r_t
 
	$memıy
(
__±r_t
 
__de¡
, 
__cÚ¡
 __±r_ˆ
__¤c
,

153 
size_t
 
__n
)

155 
i
;

156 *
d
 = (*)
__de¡
, *
s
 = (*)
__¤c
;

158 
i
=0;i<
__n
;i++è
d
[i] = 
s
[i];

159 
	}
}

161 
ulg
 
üc_32_b
[];

168 
ulg
 
	$updüc
(
s
, 
n
)

169 
uch
 *
s
;

170 
n
;

172 
ulg
 
c
;

174 
ulg
 
üc
 = (ulg)0xffffffffL;

176 ià(
s
 =ğ
NULL
) {

177 
c
 = 0xffffffffL;

179 
c
 = 
üc
;

180 
n
--) {

181 
c
 = 
üc_32_b
[(()ø^ (*
s
++)) & 0xff] ^ (c >> 8);

184 
üc
 = 
c
;

185  
c
 ^ 0xffffffffL;

186 
	}
}

191 
	$ş—r_bufs
()

193 
outút
 = 0;

194 
šsize
 = 
š±r
 = 0;

195 
by‹s_š
 = 
by‹s_out
 = 0L;

196 
	}
}

202 
	$fl_šbuf
()

204 
Ën
, 
i
;

207 
šsize
 = 0;

209 
Ën
 = 
INBUFSIZ
-
šsize
;

210 ià(
Ën
 > (
šput_Ën
-
šput_±r
+1))†en=input_len-input_ptr+1;

211 ià(
Ën
 =ğ0 ||†’ =ğ
EOF
) ;

213 
i
=0;i<
Ën
;i++è
šbuf
[
šsize
+i] = 
šput_d©a
[
šput_±r
+i];

214 
šsize
 +ğ
Ën
;

215 
šput_±r
 +ğ
Ën
;

216 } 
šsize
 < 
INBUFSIZ
);

218 ià(
šsize
 == 0) {

219 
	`”rÜ
("unableo fill buffer\n");

221 
by‹s_š
 +ğ(
ulg
)
šsize
;

222 
š±r
 = 1;

223  
šbuf
[0];

224 
	}
}

230 
	$æush_wšdow
()

232 ià(
outút
 == 0) ;

233 
	`updüc
(
wšdow
, 
outút
);

235 
	`memıy
(&
ouut_d©a
[
ouut_±r
], (*)
wšdow
, 
outút
);

237 
by‹s_out
 +ğ(
ulg
)
outút
;

238 
ouut_±r
 +ğ(
ulg
)
outút
;

239 
outút
 = 0;

240 
	}
}

247 
ulg
 
	güc_32_b
[256];

250 
	$makeüc
()

254 
c
;

255 
e
;

256 
i
;

257 
k
;

260 
p
[] = {0,1,2,4,5,7,8,10,11,12,16,22,23,26};

263 
e
 = 0;

264 
i
 = 0; i < (
p
)/(); i++)

265 
e
 |ğ1L << (31 - 
p
[
i
]);

267 
üc_32_b
[0] = 0;

269 
i
 = 1; i < 256; i++)

271 
c
 = 0;

272 
k
 = 
i
 | 256; k != 1; k >>= 1)

274 
c
 = c & 1 ? (ø>> 1è^ 
e
 : c >> 1;

275 ià(
k
 & 1)

276 
c
 ^ğ
e
;

278 
üc_32_b
[
i
] = 
c
;

280 
	}
}

282 
	$”rÜ
(*
x
)

284 
	`puts
("\n\n");

285 
	`puts
(
x
);

286 
	`puts
("\n\n -- System halted");

289 
	}
}

291 
	#STACK_SIZE
 (4096)

	)

293 
	gu£r_¡ack
 [
STACK_SIZE
];

296 * 
	ma
;

297 
	mb
;

298 } 
	g¡ack_¡¬t
 = { & 
u£r_¡ack
 [
STACK_SIZE
] , 
KERNEL_DS
 };

300 
	$decom´ess_k”Ãl
()

302 ià(
SCREEN_INFO
.
Üig_video_mode
 == 7)

303 
vidmem
 = (*) 0xb0000;

305 
vidmem
 = (*) 0xb8000;

307 
lšes
 = 
SCREEN_INFO
.
Üig_video_lšes
;

308 
cŞs
 = 
SCREEN_INFO
.
Üig_video_cŞs
;

310 ià(
EXT_MEM_K
 < 1024è
	`”rÜ
("<2M of mem\n");

312 
ouut_d©a
 = (*)1048576;

313 
ouut_±r
 = 0;

315 
ex™_code
 = 0;

316 
‹¡
 = 0;

317 
šput_±r
 = 0;

318 
·¹_nb
 = 0;

320 
	`ş—r_bufs
();

321 
	`makeüc
();

323 
	`puts
("Uncompressing Linux...");

325 
m‘hod
 = 
	`g‘_m‘hod
(0);

327 
	`wÜk
(0, 0);

329 
	`puts
("done.\n");

331 
	`puts
("Now bootinghe kernel\n");

332 
	}
}

344 
loÿl
 
	$g‘_m‘hod
(
š
)

345 
š
;

347 
uch
 
æags
;

348 
magic
[2];

350 
magic
[0] = ()
	`g‘_by‹
();

351 
magic
[1] = ()
	`g‘_by‹
();

353 
m‘hod
 = -1;

354 
·¹_nb
++;

355 
Ï¡_memb”
 = 0;

358 ià(
	`memcmp
(
magic
, 
GZIP_MAGIC
, 2) == 0

359 || 
	`memcmp
(
magic
, 
OLD_GZIP_MAGIC
, 2) == 0) {

361 
wÜk
 = 
unz
;

362 
m‘hod
 = ()
	`g‘_by‹
();

363 
æags
 = (
uch
)
	`g‘_by‹
();

364 ià((
æags
 & 
ENCRYPTED
) != 0) {

365 
	`”rÜ
("Input isƒncrypted\n");

366 
ex™_code
 = 
ERROR
;

369 ià((
æags
 & 
CONTINUATION
) != 0) {

370 
	`”rÜ
("Multi…art input\n");

371 
ex™_code
 = 
ERROR
;

372 ià(
fÜû
 <= 1)  -1;

374 ià((
æags
 & 
RESERVED
) != 0) {

375 
	`”rÜ
("Input has invalid flags\n");

376 
ex™_code
 = 
ERROR
;

377 ià(
fÜû
 <= 1)  -1;

379 (
ulg
)
	`g‘_by‹
();

380 ((
ulg
)
	`g‘_by‹
()) << 8;

381 ((
ulg
)
	`g‘_by‹
()) << 16;

382 ((
ulg
)
	`g‘_by‹
()) << 24;

384 ()
	`g‘_by‹
();

385 ()
	`g‘_by‹
();

387 ià((
æags
 & 
CONTINUATION
) != 0) {

388 
·¹
 = ()
	`g‘_by‹
();

389 
·¹
 |ğ(()
	`g‘_by‹
())<<8;

390 ià(
v”bo£
) {

391 
	`”rÜ
("Input is‚ot…art‚umber 1\n");

394 ià((
æags
 & 
EXTRA_FIELD
) != 0) {

395 
Ën
 = ()
	`g‘_by‹
();

396 
Ën
 |ğ(()
	`g‘_by‹
())<<8;

397 
Ën
--è()
	`g‘_by‹
();

401 ià((
æags
 & 
ORIG_NAME
) != 0) {

402 ià(
to_¡dout
 || 
·¹_nb
 > 1) {

404 
	`g‘_by‹
() != 0) ;

410 ià((
æags
 & 
COMMENT
) != 0) {

411 
	`g‘_by‹
() != 0) ;

414 } ià(
	`memcmp
(
magic
, 
PKZIP_MAGIC
, 2è=ğ0 && 
š±r
 == 2

415 && 
	`memcmp
(
šbuf
, 
PKZIP_MAGIC
, 4) == 0) {

419 
š±r
 = 0;

420 
wÜk
 = 
unz
;

421 ià(
	`check_zfe
(
š
) == -1)  -1;

423 
Ï¡_memb”
 = 1;

425 } ià(
	`memcmp
(
magic
, 
PACK_MAGIC
, 2) == 0) {

426 
	`”rÜ
("packed input");

427 } ià(
	`memcmp
(
magic
, 
LZW_MAGIC
, 2) == 0) {

428 
	`”rÜ
("compressed input");

429 
Ï¡_memb”
 = 1;

431 ià(
m‘hod
 == -1) {

432 
	`”rÜ
("Corrupted input\n");

433 ià(
ex™_code
 !ğ
ERROR
èex™_codğ
·¹_nb
 =ğ1 ? ERROR : 
WARNING
;

434  
·¹_nb
 == 1 ? -1 : -2;

436  
m‘hod
;

437 
	}
}

	@zBoot/piggyback.c

12 
	~<¡dio.h
>

13 
	~<uni¡d.h
>

14 
	~<a.out.h
>

16 
	$maš
(
¬gc
, *
¬gv
[])

18 
c
, 
n
=0, 
Ën
=0;

19 
tmp_buf
[512*1024];

21 
exec
 
obj
 = {0x00640107};

22 
¡ršg_Çmes
[] = {"_input_data\0_input_len\0"};

24 
Æi¡
 
v¬_Çmes
[2] =

35 
Ën
 = 0;

36 (
n
 = 
	`»ad
(0, &
tmp_buf
[
Ën
], (tmp_buf)-len+1)) > 0)

37 
Ën
 +ğ
n
;

39 ià(
n
==-1)

41 
	`³¼Ü
("stdin");

42 
	`ex™
(-1);

45 ià(
Ën
 >ğ(
tmp_buf
))

47 
	`årštf
(
¡d”r
, "%s: IÅuˆtoØÏrge\n", 
¬gv
[0]);

48 
	`ex™
(-1);

51 
	`årštf
(
¡d”r
, "Com´es£d siz%d.\n", 
Ën
);

56 
obj
.
a_d©a
 = 
Ën
 + ();

57 
obj
.
a_syms
 = (
v¬_Çmes
);

58 
	`wr™e
(1, (*)&
obj
, (obj));

63 
	`wr™e
(1, 
tmp_buf
, 
Ën
);

64 
	`wr™e
(1, (*)&
Ën
, (len));

69 
v¬_Çmes
[1].
n_v®ue
 = 
Ën
;

70 
	`wr™e
(1, (*)&
v¬_Çmes
, (var_names));

75 
Ën
 = (
¡ršg_Çmes
) + (len);

76 
	`wr™e
(1, (*)&
Ën
, (len));

77 
	`wr™e
(1, 
¡ršg_Çmes
, (string_names));

79 
	`ex™
(0);

81 
	}
}

	@zBoot/unzip.c

19 #iâdeà
lšt


20 
	grcsid
[] = "$Id: unzip.c,v 0.9 1993/02/10 16:07:22 jloup Exp $";

23 
	~"gz.h
"

24 
	~"üy±.h
"

26 
	~<¡dio.h
>

29 
	#LOCSIG
 0x04034b50L

	)

30 
	#LOCFLG
 6

	)

31 
	#CRPFLG
 1

	)

32 
	#EXTFLG
 8

	)

33 
	#LOCHOW
 8

	)

34 
	#LOCTIM
 10

	)

35 
	#LOCCRC
 14

	)

36 
	#LOCSIZ
 18

	)

37 
	#LOCLEN
 22

	)

38 
	#LOCFIL
 26

	)

39 
	#LOCEXT
 28

	)

40 
	#LOCHDR
 30

	)

41 
	#EXTHDR
 16

	)

46 
	gdeüy±
;

47 *
	gkey
;

48 
	gpkz
 = 0;

49 
	gex‹nded
 = 0;

55 
	$check_zfe
(
š
)

56 
š
;

58 
uch
 *
h
 = 
šbuf
 + 
š±r
;

63 
š±r
 +ğ
LOCHDR
 + 
	`SH
(
h
 + 
LOCFIL
è+ SH(h + 
LOCEXT
);

65 ià(
š±r
 > 
šsize
 || 
	`LG
(
h
è!ğ
LOCSIG
) {

66 
	`”rÜ
("input‚ot‡ zip");

68 
m‘hod
 = 
h
[
LOCHOW
];

69 ià(
m‘hod
 !ğ
STORED
 && m‘hod !ğ
DEFLATED
) {

70 
	`”rÜ
("firstƒntry‚ot deflated or stored--can'tƒxtract");

74 ià((
deüy±
 = 
h
[
LOCFLG
] & 
CRPFLG
) != 0) {

75 
	`”rÜ
("encrypted file\n");

76 
ex™_code
 = 
ERROR
;

81 
ex‹nded
 = (
h
[
LOCFLG
] & 
EXTFLG
) != 0;

82 
pkz
 = 1;

86 
	}
}

95 
	$unz
(
š
, 
out
)

96 
š
, 
out
;

98 
ulg
 
Üig_üc
 = 0;

99 
ulg
 
Üig_Ën
 = 0;

100 
n
;

101 
uch
 
buf
[
EXTHDR
];

106 
	`updüc
(
NULL
, 0);

108 ià(
pkz
 && !
ex‹nded
) {

109 
Üig_üc
 = 
	`LG
(
šbuf
 + 
LOCCRC
);

110 
Üig_Ën
 = 
	`LG
(
šbuf
 + 
LOCLEN
);

114 ià(
m‘hod
 =ğ
DEFLATED
) {

116 
»s
 = 
	`šæ©e
();

118 ià(
»s
 == 3) {

119 
	`”rÜ
("out of memory");

120 } ià(
»s
 != 0) {

121 
	`”rÜ
("invalid compressed format");

124 } ià(
pkz
 && 
m‘hod
 =ğ
STORED
) {

126 
ulg
 
n
 = 
	`LG
(
šbuf
 + 
LOCLEN
);

128 ià(
n
 !ğ
	`LG
(
šbuf
 + 
LOCSIZ
è- (
deüy±
 ? 
RAND_HEAD_LEN
 : 0)) {

130 
	`”rÜ
("length mismatch");

132 
n
--) {

133 
uch
 
c
 = (uch)
	`g‘_by‹
();

134 #ifdeà
CRYPT


135 ià(
deüy±
è
	`zdecode
(
c
);

137 ià(!
‹¡
è
	`put_ch¬
(
c
);

140 
	`”rÜ
("internalƒrror, invalid method");

144 ià(!
pkz
) {

148 
n
 = 0;‚ < 8;‚++) {

149 
buf
[
n
] = (
uch
)
	`g‘_by‹
();

151 
Üig_üc
 = 
	`LG
(
buf
);

152 
Üig_Ën
 = 
	`LG
(
buf
+4);

154 } ià(
ex‹nded
) {

160 
n
 = 0;‚ < 
EXTHDR
;‚++) {

161 
buf
[
n
] = (
uch
)
	`g‘_by‹
();

163 
Üig_üc
 = 
	`LG
(
buf
+4);

164 
Üig_Ën
 = 
	`LG
(
buf
+12);

168 ià(
Üig_üc
 !ğ
	`updüc
(
outbuf
, 0)) {

169 
	`”rÜ
("crcƒrror");

171 ià(
Üig_Ën
 !ğ
by‹s_out
) {

172 
	`”rÜ
("lengthƒrror");

176 ià(
pkz
 && 
š±r
 + 4 < 
šsize
 && 
	`LG
(
šbuf
+š±rè=ğ
LOCSIG
) {

177 
	`”rÜ
("zip file has morehan oneƒntry");

179 
ex‹nded
 = 
pkz
 = 0;

180 
	}
}

	@zBoot/xtract.c

10 
	~<¡dio.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dlib.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~<sys/sysmaüos.h
>

16 
	~<uni¡d.h
>

17 
	~<fú.h
>

18 
	~<a.out.h
>

19 
	~<lšux/cÚfig.h
>

21 
	#GCC_HEADER
 1024

	)

23 
	#STRINGIFY
(
x
è#x

	)

25 
	$d›
(* 
¡r
)

27 
	`årštf
(
¡d”r
,"%s\n",
¡r
);

28 
	`ex™
(1);

29 
	}
}

31 
	$u§ge
()

33 
	`d›
("Usage: xtract system [ | gzip |…iggyback >…iggy.s]");

34 
	}
}

36 
	$maš
(
¬gc
, ** 
¬gv
)

38 
i
,
c
,
id
, 
sz
;

39 
buf
[1024];

40 
majÜ_roÙ
, 
mšÜ_roÙ
;

41 
¡©
 
sb
;

43 
exec
 *
ex
 = (exeø*)
buf
;

45 ià(
¬gc
 != 2)

46 
	`u§ge
();

48 ià((
id
=
	`İ’
(
¬gv
[1],
O_RDONLY
,0))<0)

49 
	`d›
("Unableo open 'system'");

50 ià(
	`»ad
(
id
,
buf
,
GCC_HEADER
) != GCC_HEADER)

51 
	`d›
("Unableo„ead header of 'system'");

52 ià(
	`N_MAGIC
(*
ex
è!ğ
ZMAGIC
)

53 
	`d›
("Non-GCC header of 'system'");

55 
sz
 = 
	`N_SYMOFF
(*
ex
è- 
GCC_HEADER
 + 4;

57 
	`årštf
(
¡d”r
, "Sy¡em sizi %d\n", 
sz
);

59 
sz
)

61 
l
, 
n
;

63 
l
 = 
sz
;

64 ià(
l
 > (
buf
))† = (buf);

66 ià((
n
=
	`»ad
(
id
, 
buf
, 
l
)) !=l)

68 ià(
n
 == -1)

69 
	`³¼Ü
(
¬gv
[1]);

71 
	`årštf
(
¡d”r
, "Unexpected EOF\n");

73 
	`d›
("Can't„ead system");

76 
	`wr™e
(1, 
buf
, 
l
);

77 
sz
 -ğ
l
;

80 
	`şo£
(
id
);

82 
	}
}

	@
1
.
0
487
9671
drivers/FPU-emu/control_w.h
drivers/FPU-emu/errors.c
drivers/FPU-emu/exception.h
drivers/FPU-emu/fpu_arith.c
drivers/FPU-emu/fpu_asm.h
drivers/FPU-emu/fpu_aux.c
drivers/FPU-emu/fpu_emu.h
drivers/FPU-emu/fpu_entry.c
drivers/FPU-emu/fpu_etc.c
drivers/FPU-emu/fpu_proto.h
drivers/FPU-emu/fpu_system.h
drivers/FPU-emu/fpu_trig.c
drivers/FPU-emu/get_address.c
drivers/FPU-emu/load_store.c
drivers/FPU-emu/poly_2xm1.c
drivers/FPU-emu/poly_atan.c
drivers/FPU-emu/poly_l2.c
drivers/FPU-emu/poly_sin.c
drivers/FPU-emu/poly_tan.c
drivers/FPU-emu/reg_add_sub.c
drivers/FPU-emu/reg_compare.c
drivers/FPU-emu/reg_constant.c
drivers/FPU-emu/reg_constant.h
drivers/FPU-emu/reg_ld_str.c
drivers/FPU-emu/reg_mul.c
drivers/FPU-emu/status_w.h
drivers/FPU-emu/version.h
drivers/block/blk.h
drivers/block/cdu31a.c
drivers/block/floppy.c
drivers/block/genhd.c
drivers/block/hd.c
drivers/block/ll_rw_blk.c
drivers/block/mcd.c
drivers/block/ramdisk.c
drivers/block/sbpcd.c
drivers/block/xd.c
drivers/char/atixlmouse.c
drivers/char/busmouse.c
drivers/char/console.c
drivers/char/defkeymap.c
drivers/char/diacr.h
drivers/char/kbd_kern.h
drivers/char/keyboard.c
drivers/char/lp.c
drivers/char/mem.c
drivers/char/mouse.c
drivers/char/msbusmouse.c
drivers/char/psaux.c
drivers/char/pty.c
drivers/char/serial.c
drivers/char/tpqic02.c
drivers/char/tty_io.c
drivers/char/tty_ioctl.c
drivers/char/vt.c
drivers/char/vt_kern.h
drivers/net/3c501.c
drivers/net/3c503.c
drivers/net/3c503.h
drivers/net/3c507.c
drivers/net/3c509.c
drivers/net/8390.c
drivers/net/8390.h
drivers/net/Space.c
drivers/net/at1700.c
drivers/net/atp.c
drivers/net/atp.h
drivers/net/auto_irq.c
drivers/net/d_link.c
drivers/net/depca.c
drivers/net/depca.h
drivers/net/eexpress.c
drivers/net/hp.c
drivers/net/iow.h
drivers/net/lance.c
drivers/net/ne.c
drivers/net/net_init.c
drivers/net/plip.c
drivers/net/skeleton.c
drivers/net/slhc.c
drivers/net/slhc.h
drivers/net/slip.c
drivers/net/slip.h
drivers/net/smc-ultra.c
drivers/net/wd.c
drivers/scsi/NCR5380.c
drivers/scsi/NCR5380.h
drivers/scsi/aha152x.c
drivers/scsi/aha152x.h
drivers/scsi/aha1542.c
drivers/scsi/aha1542.h
drivers/scsi/aha1740.c
drivers/scsi/aha1740.h
drivers/scsi/constants.c
drivers/scsi/constants.h
drivers/scsi/fdomain.c
drivers/scsi/fdomain.h
drivers/scsi/g_NCR5380.c
drivers/scsi/g_NCR5380.h
drivers/scsi/hosts.c
drivers/scsi/hosts.h
drivers/scsi/pas16.c
drivers/scsi/pas16.h
drivers/scsi/scsi.c
drivers/scsi/scsi.h
drivers/scsi/scsi_debug.c
drivers/scsi/scsi_debug.h
drivers/scsi/scsi_ioctl.c
drivers/scsi/scsi_ioctl.h
drivers/scsi/sd.c
drivers/scsi/sd.h
drivers/scsi/sd_ioctl.c
drivers/scsi/seagate.c
drivers/scsi/seagate.h
drivers/scsi/sg.c
drivers/scsi/sg.h
drivers/scsi/sr.c
drivers/scsi/sr.h
drivers/scsi/sr_ioctl.c
drivers/scsi/st.c
drivers/scsi/st.h
drivers/scsi/t128.c
drivers/scsi/t128.h
drivers/scsi/ultrastor.c
drivers/scsi/ultrastor.h
drivers/scsi/wd7000.c
drivers/scsi/wd7000.h
drivers/sound/adlib_card.c
drivers/sound/audio.c
drivers/sound/configure.c
drivers/sound/dev_table.c
drivers/sound/dev_table.h
drivers/sound/dma.h
drivers/sound/dmabuf.c
drivers/sound/finetune.h
drivers/sound/gus_card.c
drivers/sound/gus_hw.h
drivers/sound/gus_midi.c
drivers/sound/gus_vol.c
drivers/sound/gus_wave.c
drivers/sound/midibuf.c
drivers/sound/mpu401.c
drivers/sound/opl3.c
drivers/sound/opl3.h
drivers/sound/os.h
drivers/sound/pas.h
drivers/sound/pas2_card.c
drivers/sound/pas2_midi.c
drivers/sound/pas2_mixer.c
drivers/sound/pas2_pcm.c
drivers/sound/patmgr.c
drivers/sound/sb.h
drivers/sound/sb16_dsp.c
drivers/sound/sb16_midi.c
drivers/sound/sb_card.c
drivers/sound/sb_dsp.c
drivers/sound/sb_midi.c
drivers/sound/sb_mixer.c
drivers/sound/sb_mixer.h
drivers/sound/sequencer.c
drivers/sound/sound_calls.h
drivers/sound/sound_config.h
drivers/sound/sound_switch.c
drivers/sound/soundcard.c
drivers/sound/tuning.h
drivers/sound/ulaw.h
fs/binfmt_coff.c
fs/binfmt_elf.c
fs/block_dev.c
fs/buffer.c
fs/devices.c
fs/exec.c
fs/ext/dir.c
fs/ext/file.c
fs/ext/freelists.c
fs/ext/fsync.c
fs/ext/inode.c
fs/ext/namei.c
fs/ext/symlink.c
fs/ext/truncate.c
fs/ext2/acl.c
fs/ext2/balloc.c
fs/ext2/bitmap.c
fs/ext2/dcache.c
fs/ext2/dir.c
fs/ext2/file.c
fs/ext2/fsync.c
fs/ext2/ialloc.c
fs/ext2/inode.c
fs/ext2/ioctl.c
fs/ext2/namei.c
fs/ext2/super.c
fs/ext2/symlink.c
fs/ext2/truncate.c
fs/fcntl.c
fs/fifo.c
fs/file_table.c
fs/filesystems.c
fs/hpfs/hpfs.h
fs/hpfs/hpfs_fs.c
fs/inode.c
fs/ioctl.c
fs/isofs/dir.c
fs/isofs/file.c
fs/isofs/inode.c
fs/isofs/namei.c
fs/isofs/rock.c
fs/isofs/rock.h
fs/isofs/symlink.c
fs/isofs/util.c
fs/locks.c
fs/minix/bitmap.c
fs/minix/dir.c
fs/minix/file.c
fs/minix/fsync.c
fs/minix/inode.c
fs/minix/namei.c
fs/minix/symlink.c
fs/minix/truncate.c
fs/msdos/dir.c
fs/msdos/fat.c
fs/msdos/file.c
fs/msdos/inode.c
fs/msdos/misc.c
fs/msdos/namei.c
fs/namei.c
fs/nfs/dir.c
fs/nfs/file.c
fs/nfs/inode.c
fs/nfs/mmap.c
fs/nfs/proc.c
fs/nfs/sock.c
fs/nfs/symlink.c
fs/open.c
fs/pipe.c
fs/proc/array.c
fs/proc/base.c
fs/proc/fd.c
fs/proc/inode.c
fs/proc/kmsg.c
fs/proc/link.c
fs/proc/mem.c
fs/proc/net.c
fs/proc/root.c
fs/read_write.c
fs/select.c
fs/stat.c
fs/super.c
fs/sysv/balloc.c
fs/sysv/dir.c
fs/sysv/file.c
fs/sysv/fsync.c
fs/sysv/ialloc.c
fs/sysv/inode.c
fs/sysv/namei.c
fs/sysv/symlink.c
fs/sysv/truncate.c
fs/xiafs/bitmap.c
fs/xiafs/dir.c
fs/xiafs/file.c
fs/xiafs/fsync.c
fs/xiafs/inode.c
fs/xiafs/namei.c
fs/xiafs/symlink.c
fs/xiafs/truncate.c
fs/xiafs/xiafs_mac.h
ibcs/emulate.c
include/asm/bitops.h
include/asm/dma.h
include/asm/io.h
include/asm/irq.h
include/asm/segment.h
include/asm/system.h
include/linux/a.out.h
include/linux/binfmts.h
include/linux/busmouse.h
include/linux/cdrom.h
include/linux/cdu31a.h
include/linux/coff.h
include/linux/config.h
include/linux/ctype.h
include/linux/ddi.h
include/linux/debugreg.h
include/linux/delay.h
include/linux/dirent.h
include/linux/elf.h
include/linux/errno.h
include/linux/ext2_fs.h
include/linux/ext2_fs_i.h
include/linux/ext2_fs_sb.h
include/linux/ext_fs.h
include/linux/ext_fs_i.h
include/linux/ext_fs_sb.h
include/linux/fcntl.h
include/linux/fd.h
include/linux/fdreg.h
include/linux/fs.h
include/linux/genhd.h
include/linux/hdreg.h
include/linux/head.h
include/linux/hpfs_fs.h
include/linux/hpfs_fs_i.h
include/linux/hpfs_fs_sb.h
include/linux/icmp.h
include/linux/if.h
include/linux/if_arp.h
include/linux/if_ether.h
include/linux/in.h
include/linux/in_systm.h
include/linux/interrupt.h
include/linux/ioctl.h
include/linux/ioport.h
include/linux/ip.h
include/linux/ipc.h
include/linux/iso_fs.h
include/linux/iso_fs_i.h
include/linux/iso_fs_sb.h
include/linux/kd.h
include/linux/kernel.h
include/linux/kernel_stat.h
include/linux/keyboard.h
include/linux/ldt.h
include/linux/limits.h
include/linux/linkage.h
include/linux/locks.h
include/linux/lp.h
include/linux/major.h
include/linux/malloc.h
include/linux/math_emu.h
include/linux/mc146818rtc.h
include/linux/mcd.h
include/linux/minix_fs.h
include/linux/minix_fs_i.h
include/linux/minix_fs_sb.h
include/linux/mktime.h
include/linux/mm.h
include/linux/mman.h
include/linux/module.h
include/linux/mouse.h
include/linux/msdos_fs.h
include/linux/msdos_fs_i.h
include/linux/msdos_fs_sb.h
include/linux/msg.h
include/linux/mtio.h
include/linux/net.h
include/linux/nfs.h
include/linux/nfs_fs.h
include/linux/nfs_fs_i.h
include/linux/nfs_fs_sb.h
include/linux/nfs_mount.h
include/linux/page.h
include/linux/param.h
include/linux/pipe_fs_i.h
include/linux/proc_fs.h
include/linux/ptrace.h
include/linux/resource.h
include/linux/route.h
include/linux/sbpcd.h
include/linux/sched.h
include/linux/segment.h
include/linux/sem.h
include/linux/serial.h
include/linux/shm.h
include/linux/signal.h
include/linux/socket.h
include/linux/sockios.h
include/linux/soundcard.h
include/linux/stat.h
include/linux/stddef.h
include/linux/string.h
include/linux/sys.h
include/linux/sysv_fs.h
include/linux/sysv_fs_i.h
include/linux/sysv_fs_sb.h
include/linux/tasks.h
include/linux/tcp.h
include/linux/termios.h
include/linux/time.h
include/linux/timer.h
include/linux/times.h
include/linux/timex.h
include/linux/tpqic02.h
include/linux/tty.h
include/linux/types.h
include/linux/udp.h
include/linux/ultrasound.h
include/linux/un.h
include/linux/unistd.h
include/linux/user.h
include/linux/utime.h
include/linux/utsname.h
include/linux/vfs.h
include/linux/vm86.h
include/linux/vt.h
include/linux/wait.h
include/linux/xd.h
include/linux/xia_fs.h
include/linux/xia_fs_i.h
include/linux/xia_fs_sb.h
init/main.c
ipc/msg.c
ipc/sem.c
ipc/shm.c
ipc/util.c
kernel/dma.c
kernel/exit.c
kernel/fork.c
kernel/info.c
kernel/ioport.c
kernel/irq.c
kernel/itimer.c
kernel/ldt.c
kernel/mktime.c
kernel/module.c
kernel/panic.c
kernel/printk.c
kernel/ptrace.c
kernel/sched.c
kernel/signal.c
kernel/sys.c
kernel/time.c
kernel/traps.c
kernel/vsprintf.c
lib/_exit.c
lib/close.c
lib/ctype.c
lib/dup.c
lib/errno.c
lib/execve.c
lib/malloc.c
lib/open.c
lib/setsid.c
lib/string.c
lib/wait.c
lib/write.c
mm/kmalloc.c
mm/memory.c
mm/mmap.c
mm/swap.c
mm/vmalloc.c
net/Space.c
net/ddi.c
net/inet/arp.c
net/inet/arp.h
net/inet/datagram.c
net/inet/dev.c
net/inet/dev.h
net/inet/eth.c
net/inet/eth.h
net/inet/icmp.c
net/inet/icmp.h
net/inet/inet.h
net/inet/ip.c
net/inet/ip.h
net/inet/loopback.c
net/inet/packet.c
net/inet/proc.c
net/inet/protocol.c
net/inet/protocol.h
net/inet/raw.c
net/inet/raw.h
net/inet/route.c
net/inet/route.h
net/inet/skbuff.c
net/inet/skbuff.h
net/inet/sock.c
net/inet/sock.h
net/inet/tcp.c
net/inet/tcp.h
net/inet/timer.c
net/inet/udp.c
net/inet/udp.h
net/inet/utils.c
net/socket.c
net/unix/proc.c
net/unix/sock.c
net/unix/unix.h
tools/build.c
tools/version.c
zBoot/crypt.h
zBoot/gzip.h
zBoot/inflate.c
zBoot/lzw.h
zBoot/misc.c
zBoot/piggyback.c
zBoot/unzip.c
zBoot/xtract.c
